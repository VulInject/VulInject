read_mmdbr_stdout_worker(gpointer data _U_) {
    mmdb_response_t *response = g_new0(mmdb_response_t, 1);
    gchar *line_buf = g_new(gchar, MAX_MMDB_LINE_LEN);
    GString *country_iso = g_string_new("");
    GString *country = g_string_new("");
    GString *city = g_string_new("");
    GString *as_org = g_string_new("");
    char cur_addr[WS_INET6_ADDRSTRLEN] = { 0 };
    size_t bytes_in_buffer, search_offset;
    gboolean line_feed_found;
    ws_debug("starting read worker");
    bytes_in_buffer = search_offset = 0;
    line_feed_found = FALSE;
    for (;;) {
        if (line_feed_found) {
            bytes_in_buffer -= (search_offset + 1);
            memmove(line_buf, &line_buf[search_offset + 1], bytes_in_buffer);
            search_offset = 0;
            line_feed_found = FALSE;
        }
        while (search_offset < bytes_in_buffer) {
            if (line_buf[search_offset] == '\n') {
                line_buf[search_offset] = 0; 
                line_feed_found = TRUE;
                break;
            }
            search_offset++;
        }
        if (!line_feed_found) {
            int space_available = (int)(MAX_MMDB_LINE_LEN - bytes_in_buffer);
            if (space_available > 0) {
                gsize bytes_read;
                g_io_channel_read_chars(mmdbr_pipe.stdout_io, &line_buf[bytes_in_buffer],
                                        space_available, &bytes_read, NULL);
                if (bytes_read > 0) {
                    bytes_in_buffer += bytes_read;
                } else {
                    ws_debug("no pipe data. exiting thread.");
                    response->fatal_err = TRUE;
                    g_async_queue_push(mmdbr_response_q, response); 
                    response = NULL;
                    break;
                }
            } else {
                ws_debug("int line");
                bytes_in_buffer = g_strlcpy(line_buf, RES_INVALID_LINE, MAX_MMDB_LINE_LEN);
                search_offset = bytes_in_buffer;
            }
            continue;
        }
        char *line = g_strstrip(line_buf);
        size_t line_len = strlen(line);
        ws_noisy("read %zd bytes: %s", line_len, line);
        if (line_len < 1) continue;
        char *val_start = strchr(line, ':');
        if (val_start) {
            val_start = g_strstrip(val_start + 1);
        }
        if (line[0] == '[' && line_len > 2) {
            line[line_len - 1] = '\0';
            (void) g_strlcpy(cur_addr, line + 1, WS_INET6_ADDRSTRLEN);
            if (ws_inet_pton4(cur_addr, &response->ipv4_addr)) {
                response->is_ipv4 = TRUE;
            } else if (ws_inet_pton6(cur_addr, &response->ipv6_addr)) {
                response->is_ipv4 = FALSE;
            } else if (strcmp(cur_addr, "init") != 0) {
                ws_debug("Invalid address: %s", cur_addr);
                cur_addr[0] = '\0';
            }
            g_string_truncate(country_iso, 0);
            g_string_truncate(country, 0);
            g_string_truncate(city, 0);
            g_string_truncate(as_org, 0);
        } else if (strcmp(line, RES_STATUS_ERROR) == 0) {
            cur_addr[0] = '\0';
            init_lookup(&response->mmdb_val);
            break;
        } else if (val_start && g_str_has_prefix(line, RES_COUNTRY_ISO_CODE)) {
            response->mmdb_val.found = TRUE;
            g_string_assign(country_iso, val_start);
        } else if (val_start && g_str_has_prefix(line, RES_COUNTRY_NAMES_EN)) {
            response->mmdb_val.found = TRUE;
            g_string_assign(country, val_start);
        } else if (val_start && g_str_has_prefix(line, RES_CITY_NAMES_EN)) {
            response->mmdb_val.found = TRUE;
            g_string_assign(city, val_start);
        } else if (val_start && g_str_has_prefix(line, RES_ASN_ORG)) {
            response->mmdb_val.found = TRUE;
            g_string_assign(as_org, val_start);
        } else if (val_start && g_str_has_prefix(line, RES_ASN_NUMBER)) {
            if (ws_strtou32(val_start, NULL, &response->mmdb_val.as_number)) {
                response->mmdb_val.found = TRUE;
            } else {
                ws_debug("Invalid ASN: %s", val_start);
            }
        } else if (val_start && g_str_has_prefix(line, RES_LOCATION_LATITUDE)) {
            response->mmdb_val.found = TRUE;
            response->mmdb_val.latitude = g_ascii_strtod(val_start, NULL);
        } else if (val_start && g_str_has_prefix(line, RES_LOCATION_LONGITUDE)) {
            response->mmdb_val.found = TRUE;
            response->mmdb_val.longitude = g_ascii_strtod(val_start, NULL);
        } else if (val_start && g_str_has_prefix(line, RES_LOCATION_ACCURACY)) {
            if (ws_strtou16(val_start, NULL, &response->mmdb_val.accuracy)) {
                response->mmdb_val.found = TRUE;
            } else {
                ws_debug("Invalid accuracy radius: %s", val_start);
            }
        } else if (g_str_has_prefix(line, RES_END)) {
            if (response->mmdb_val.found && cur_addr[0]) {
                if (country_iso->len) {
                    response->mmdb_val.country_iso = g_strdup(country_iso->str);
                }
                if (country->len) {
                    response->mmdb_val.country = g_strdup(country->str);
                }
                if (city->len) {
                    response->mmdb_val.city = g_strdup(city->str);
                }
                if (as_org->len) {
                    response->mmdb_val.as_org = g_strdup(as_org->str);
                }
                ws_debug("queued %p %s %s: city %s country %s", response, response->is_ipv4 ? "v4" : "v6", cur_addr, response->mmdb_val.city, response->mmdb_val.country);
                g_async_queue_push(mmdbr_response_q, response); 
                response = g_new0(mmdb_response_t, 1);
            } else if (strcmp(cur_addr, "init") != 0) {
                if (resolve_synchronously) {
                    ws_debug("Pushing not-found result due to bad address");
                    g_async_queue_push(mmdbr_response_q, response); 
                    response = g_new0(mmdb_response_t, 1);
                }
                else {
                    ws_debug("Discarded previous values due to bad address");
                }
            }
            cur_addr[0] = '\0';
            init_lookup(&response->mmdb_val);
        }
    }
    g_string_free(country_iso, TRUE);
    g_string_free(country, TRUE);
    g_string_free(city, TRUE);
    g_string_free(as_org, TRUE);
    g_free(line_buf);
    g_free(response);
    return NULL;
}
