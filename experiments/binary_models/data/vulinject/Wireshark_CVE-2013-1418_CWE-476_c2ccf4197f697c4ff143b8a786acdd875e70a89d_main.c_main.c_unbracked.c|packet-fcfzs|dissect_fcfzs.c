dissect_fcfzs(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)
{
    proto_item        *ti;
    proto_tree        *fcfzs_tree    = NULL;
    int                offset        = 0;
    fc_ct_preamble     cthdr;
    int                opcode;
    int                failed_opcode = 0;
    conversation_t    *conversation;
    fcfzs_conv_data_t *cdata;
    fcfzs_conv_key_t   ckey, *req_key;
    gboolean           isreq         = TRUE;
    fc_hdr *fchdr;
    fchdr = (fc_hdr *)data;
    col_set_str(pinfo->cinfo, COL_PROTOCOL, "Zone Server");
    tvb_memcpy(tvb, (guint8 *)&cthdr, offset, FCCT_PRMBL_SIZE);
    cthdr.revision = tvb_get_guint8(tvb, offset+1);
    cthdr.in_id = tvb_get_ntoh24(tvb, offset);
    cthdr.opcode = g_ntohs(cthdr.opcode);
    opcode = cthdr.opcode;
    cthdr.maxres_size = g_ntohs(cthdr.maxres_size);
    if (tree) {
        ti = proto_tree_add_protocol_format(tree, proto_fcfzs, tvb, 0,
                                            tvb_captured_length(tvb),
                                            "Zone Server");
        fcfzs_tree = proto_item_add_subtree(ti, ett_fcfzs);
        proto_tree_add_item(fcfzs_tree, hf_fcfzs_opcode, tvb, offset+8, 2, ENC_BIG_ENDIAN);
        proto_tree_add_item(fcfzs_tree, hf_fcfzs_maxres_size, tvb, offset+10,
                            2, ENC_BIG_ENDIAN);
    }
    if ((opcode != FCCT_MSG_ACC) && (opcode != FCCT_MSG_RJT)) {
        conversation = find_conversation(pinfo->num, &pinfo->src, &pinfo->dst,
                                         conversation_pt_to_conversation_type(pinfo->ptype), fchdr->oxid,
                                         fchdr->rxid, NO_PORT_B);
        if (!conversation) {
            conversation = conversation_new(pinfo->num, &pinfo->src, &pinfo->dst,
                                            conversation_pt_to_conversation_type(pinfo->ptype), fchdr->oxid,
                                            fchdr->rxid, NO_PORT2);
        }
        ckey.conv_idx = conversation->conv_index;
        cdata = (fcfzs_conv_data_t *)wmem_map_lookup(fcfzs_req_hash,
                                                         &ckey);
        if (cdata) {
            cdata->opcode = opcode;
        }
        else {
            req_key = wmem_new(wmem_file_scope(), fcfzs_conv_key_t);
            req_key->conv_idx = conversation->conv_index;
            cdata = wmem_new(wmem_file_scope(), fcfzs_conv_data_t);
            cdata->opcode = opcode;
            wmem_map_insert(fcfzs_req_hash, req_key, cdata);
        }
        col_add_str(pinfo->cinfo, COL_INFO, val_to_str(opcode, fc_fzs_opcode_val,
                                                           "0x%x"));
    }
    else {
        conversation = find_conversation(pinfo->num, &pinfo->src, &pinfo->dst,
                                         conversation_pt_to_conversation_type(pinfo->ptype), fchdr->oxid,
                                         fchdr->rxid, NO_PORT_B);
        isreq = FALSE;
        if (!conversation) {
            if (opcode == FCCT_MSG_ACC) {
                col_add_str(pinfo->cinfo, COL_INFO,
                                val_to_str(opcode, fc_fzs_opcode_val,
                                           "0x%x"));
                proto_tree_add_expert_format(fcfzs_tree, pinfo, &ei_fcfzs_no_exchange, tvb, 0, -1,
                                    "No record of Exchg. Unable to decode MSG_ACC");
                return 0;
            }
        }
        else {
            ckey.conv_idx = conversation->conv_index;
            cdata = (fcfzs_conv_data_t *)wmem_map_lookup(fcfzs_req_hash, &ckey);
            if (cdata != NULL) {
                if (opcode == FCCT_MSG_ACC)
                    opcode = cdata->opcode;
                else
                    failed_opcode = cdata->opcode;
            }
            if (opcode != FCCT_MSG_RJT) {
                col_add_fstr(pinfo->cinfo, COL_INFO, "MSG_ACC (%s)",
                                val_to_str(opcode,
                                        fc_fzs_opcode_val, "0x%x"));
            }
            else {
                col_add_fstr(pinfo->cinfo, COL_INFO, "MSG_RJT (%s)",
                                val_to_str(failed_opcode,
                                        fc_fzs_opcode_val, "0x%x"));
            }
            if ((cdata == NULL) && (opcode != FCCT_MSG_RJT)) {
                proto_tree_add_expert_format(fcfzs_tree, pinfo, &ei_fcfzs_no_exchange, tvb, 0, -1,
                                    "No record of Exchg. Unable to decode MSG_ACC/RJT");
                return 0;
            }
        }
    }
    switch (opcode) {
    case FCCT_MSG_RJT:
        dissect_fcfzs_rjt(tvb, fcfzs_tree);
        break;
    case FC_FZS_GZC:
        dissect_fcfzs_gzc(tvb, 16, fcfzs_tree, isreq);
        break;
    case FC_FZS_GEST:
        dissect_fcfzs_gest(tvb, fcfzs_tree, isreq);
        break;
    case FC_FZS_GZSN:
        dissect_fcfzs_gzsn(tvb, fcfzs_tree, isreq);
        break;
    case FC_FZS_GZD:
        dissect_fcfzs_gzd(tvb, fcfzs_tree, isreq);
        break;
    case FC_FZS_GZM:
        dissect_fcfzs_gzm(tvb, pinfo, fcfzs_tree, isreq);
        break;
    case FC_FZS_GAZS:
        dissect_fcfzs_gazs(tvb, pinfo, fcfzs_tree, isreq);
        break;
    case FC_FZS_GZS:
        dissect_fcfzs_gzs(tvb, pinfo, fcfzs_tree, isreq);
        break;
    case FC_FZS_ADZS:
        dissect_fcfzs_adzs(tvb, pinfo, fcfzs_tree, isreq);
        break;
    case FC_FZS_AZSD:
        dissect_fcfzs_azsd(tvb, pinfo, fcfzs_tree, isreq);
        break;
    case FC_FZS_AZS:
        dissect_fcfzs_arzs(tvb, fcfzs_tree, isreq);
        break;
    case FC_FZS_DZS:
        dissect_fcfzs_dzs(tvb, fcfzs_tree, isreq);
        break;
    case FC_FZS_AZM:
        dissect_fcfzs_arzm(tvb, pinfo, fcfzs_tree, isreq);
        break;
    case FC_FZS_AZD:
        dissect_fcfzs_arzd(tvb, fcfzs_tree, isreq);
        break;
    case FC_FZS_RZM:
        dissect_fcfzs_arzm(tvb, pinfo, fcfzs_tree, isreq);
        break;
    case FC_FZS_RZD:
        dissect_fcfzs_arzd(tvb, fcfzs_tree, isreq);
        break;
    case FC_FZS_RZS:
        dissect_fcfzs_arzs(tvb, fcfzs_tree, isreq);
        break;
    default:
        call_data_dissector(tvb, pinfo, tree);
        break;
    }
    return tvb_captured_length(tvb);
}
