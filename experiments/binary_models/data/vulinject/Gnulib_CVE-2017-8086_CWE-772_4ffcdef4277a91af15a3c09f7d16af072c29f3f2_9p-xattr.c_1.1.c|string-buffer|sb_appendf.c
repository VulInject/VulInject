sb_appendf (struct string_buffer *buffer, const char *formatstring, ...)
{
  va_list args;
  size_t room = buffer->allocated - buffer->length;
  if (room < 64)
    {
      if (sb_ensure_more_bytes (buffer, 64) < 0)
        {
          buffer->error = true;
          return -1;
        }
      room = buffer->allocated - buffer->length;
    }
  va_start (args, formatstring);
  int ret = vsnprintf (buffer->data + buffer->length, room, formatstring, args);
  if (ret < 0)
    {
      buffer->error = true;
      ret = -1;
    }
  else
    {
      if ((size_t) ret <= room)
        {
          buffer->length += (size_t) ret;
          ret = 0;
        }
      else
        {
          if (sb_ensure_more_bytes (buffer, (size_t) ret) < 0)
            {
              buffer->error = true;
              ret = -1;
            }
          else
            {
              room = buffer->allocated - buffer->length;
              va_start (args, formatstring);
              ret = vsnprintf (buffer->data + buffer->length, room,
                               formatstring, args);
              if (ret < 0)
                {
                  buffer->error = true;
                  ret = -1;
                }
              else
                {
                  if ((size_t) ret <= room)
                    {
                      buffer->length += (size_t) ret;
                      ret = 0;
                    }
                  else
                    abort ();
                }
            }
        }
    }
  va_end (args);
  return ret;
}
