dissect_mtp2_tvb(tvbuff_t* tvb, mtp2_mtp2_flag_search_t back_mtp2_flag_search, guint8 back_data_buff, guint8 back_data_buff_offset,
    enum mtp2_bitstream_states back_state, guint8 back_last_flag_beginning_offset_for_align_check)
{
  guint8        mtp2_flag_search = 0x00,                        
                data_buff = 0x00,                               
                data_buff_offset = 0,                           
                available_bytes_in_rtp_payload = 0,             
                *found_data_buff_byte = NULL,                   
                offset = 0,                                     
                data_len = 0,                                   
                flag_beginning_offset_for_align_check = 0;      
#ifdef MTP2_BITSTREAM_DEBUG
  gboolean      zero_skip0 = 0,                                 
                zero_skip1 = 0,                                 
                flag = FALSE,                                   
                frame_reset = FALSE;                            
#endif
  enum mtp2_bitstream_states    state = OUT_OF_SYNC;            
  tvbuff_t                      *new_tvb = NULL;                
  mtp2_dissect_tvb_res_t        *result = NULL;                 
  result = wmem_new(wmem_packet_scope(), mtp2_dissect_tvb_res_t);
  result->mtp2_remain_data.before_first_flag = NULL;
  result->mtp2_remain_data.before_fh_frame_reset = FALSE;
  result->mtp2_remain_data.after_last_flag = NULL;
  result->found_packets = wmem_list_new(wmem_packet_scope());
  result->flag_found = FALSE;
  result->last_flag_beginning_offset_for_align_check = 0;
  if (back_mtp2_flag_search.set == TRUE) {
    mtp2_flag_search = back_mtp2_flag_search.mtp2_flag_search;
  }
  data_buff = back_data_buff;
  data_buff_offset = back_data_buff_offset;
  state = back_state;
  flag_beginning_offset_for_align_check = back_last_flag_beginning_offset_for_align_check;
  available_bytes_in_rtp_payload = tvb_reported_length_remaining(tvb, offset);
  while (offset < available_bytes_in_rtp_payload) {
    guint8 byte = tvb_get_guint8(tvb,offset);
    for (guint8 i=1; i <= 8; i++) {
      gboolean bit = get_bit(byte, i);
#ifdef MTP2_BITSTREAM_DEBUG
      debug("%u",(bit==FALSE?0:1));
#endif
      mtp2_flag_search = (mtp2_flag_search << 1) | bit;
      if (state != OUT_OF_SYNC) {
        if ( (mtp2_flag_search == 0xBE || mtp2_flag_search == 0x3E)) {
#ifdef MTP2_BITSTREAM_DEBUG
          if (zero_skip0 == 0)
            zero_skip0 = i;
          else
            zero_skip1 = i;
#endif
          flag_beginning_offset_for_align_check = (flag_beginning_offset_for_align_check + 1) % 8;
        } else {
          data_buff = data_buff | (bit << data_buff_offset);
          data_buff_offset++;
          if (data_buff_offset == 8) {
            if (data_buff != 0x7E) {
              state = DATA;
              new_byte(data_buff, &found_data_buff_byte, &data_len);
            }
            data_buff = 0x00;
            data_buff_offset = 0;
          }
        }
      }
      if (mtp2_flag_search == 0x7E &&
          !(offset == 0 && i < 8 && back_mtp2_flag_search.set == FALSE))
      {
        state = FLAGS;
        if (data_len != 0) {
          guint8 unaligned_packet_offset = 0; 
          if (flag_beginning_offset_for_align_check != 0 && flag_beginning_offset_for_align_check != i) {
            unaligned_packet_offset = i;
            data_buff = 0x00;
            data_buff_offset = 0;
          }
          guint8 *buff = (guint8 *) wmem_memdup(wmem_packet_scope(), found_data_buff_byte, data_len);
          new_tvb = tvb_new_child_real_data(tvb, buff, data_len, data_len);
          if (result->flag_found == FALSE) {
            result->mtp2_remain_data.before_first_flag = new_tvb;
            result->mtp2_remain_data.before_fh_unalignment_offset = unaligned_packet_offset;
          } else {
            wmem_list_append(result->found_packets, prepare_data_for_found_packet(new_tvb,unaligned_packet_offset));
          }
          data_len = 0;
          found_data_buff_byte = NULL;
        }
        flag_beginning_offset_for_align_check = i;
#ifdef MTP2_BITSTREAM_DEBUG
        flag = TRUE;
#endif
        result->flag_found = TRUE;
      } else if (mtp2_flag_search == 0x7F || mtp2_flag_search == 0xFE || mtp2_flag_search == 0xFF) {
        state = OUT_OF_SYNC;
        data_len = 0;
        found_data_buff_byte = NULL;
        data_buff = 0x00;
        data_buff_offset = 0;
#ifdef MTP2_BITSTREAM_DEBUG
        frame_reset = TRUE;
#endif
        if (result->flag_found == FALSE)
          result->mtp2_remain_data.before_fh_frame_reset = TRUE;
      }
    }
#ifdef MTP2_BITSTREAM_DEBUG
    if (flag) {
      debug("\tFLAG FOUND");
    }
    if (!zero_skip0 == 0) {
      debug("\tSKIPPED ZEROS: %u.",zero_skip0);
      if (!zero_skip1 == 0)
        debug(" %u",zero_skip1);
    }
    if (frame_reset) {
      debug("\tFRAME RESET");
    }
    debug("\n");
    zero_skip0 = 0;
    zero_skip1 = 0;
    flag = FALSE;
    frame_reset = FALSE;
#endif
    offset++;
  }
  if (data_len != 0) {
    guint8 * buff = (guint8 *) wmem_memdup(wmem_packet_scope(), found_data_buff_byte, data_len);
    new_tvb = tvb_new_child_real_data(tvb, buff, data_len, data_len);
    result->mtp2_remain_data.after_last_flag = new_tvb;
  }
  if (result->mtp2_remain_data.before_first_flag == NULL) {
    guint8 *buff = (guint8 *) wmem_memdup(wmem_packet_scope(), found_data_buff_byte, 0);
    new_tvb = tvb_new_child_real_data(tvb, buff, 0, 0);
    result->mtp2_remain_data.before_first_flag = new_tvb;
  }
  if (state != OUT_OF_SYNC) {
    result->mtp2_flag_search.set = TRUE;
    result->mtp2_flag_search.mtp2_flag_search = mtp2_flag_search;
    result->data_buff = data_buff;
    result->data_buff_offset = data_buff_offset;
  } else {
    result->mtp2_flag_search.set = FALSE;
    result->mtp2_flag_search.mtp2_flag_search = result->data_buff = result->data_buff_offset = 0x00;
  }
  result->state = state;
  result->last_flag_beginning_offset_for_align_check = flag_beginning_offset_for_align_check;
  return result;
}
