void __init alternative_instructions(void)
{
	int3_selftest();
	stop_nmi();
	paravirt_set_cap();
	__apply_fineibt(__retpoline_sites, __retpoline_sites_end,
			__cfi_sites, __cfi_sites_end, true);
	apply_returns(__return_sites, __return_sites_end);
	apply_alternatives(__alt_instructions, __alt_instructions_end);
	callthunks_patch_builtin_calls();
	apply_seal_endbr(__ibt_endbr_seal, __ibt_endbr_seal_end);
#ifdef CONFIG_SMP
	if (!noreplace_smp && (num_present_cpus() == 1 || setup_max_cpus <= 1)) {
		uniproc_patched = true;
		alternatives_smp_module_add(NULL, "core kernel",
					    __smp_locks, __smp_locks_end,
					    _text, _etext);
	}
	if (!uniproc_patched || num_possible_cpus() == 1) {
		free_init_pages("SMP alternatives",
				(unsigned int)__smp_locks,
				(unsigned int)__smp_locks_end);
	}
#endif
	restart_nmi();
	alternatives_patched = 1;
	alt_reloc_selftest();
}
