static int rcwt_write_packet(AVFormatContext *avf, AVPacket *pkt)
{
    RCWTContext *rcwt = avf->priv_data;
    int in_block = 0;
    int nb_block_bytes = 0;
    if (pkt->size == 0)
        return 0;
    /* new PTS, new cluster */
    if (pkt->pts != rcwt->cluster_pts) {
        rcwt->cluster_pts = pkt->pts;
    }
    if (pkt->pts == AV_NOPTS_VALUE) {
        av_log(avf, AV_LOG_WARNING, "Ignoring CC packet with no PTS\n");
        return 0;
    }
    for (int i = 0; i < pkt->size; i++) {
        uint8_t cc_valid;
        uint8_t cc_type;
        if (rcwt->cluster_nb_blocks == RCWT_CLUSTER_MAX_BLOCKS) {
            av_log(avf, AV_LOG_WARNING, "Starting new cluster due to size\n");
            rcwt_flush_cluster(avf);
        }
        cc_valid = (pkt->data[i] & 0x04) >> 2;
        cc_type = pkt->data[i] & 0x03;
        if (!in_block && !(cc_valid || cc_type == 3))
            continue;
        memcpy(&rcwt->cluster_buf[rcwt->cluster_pos], &pkt->data[i], 1);
        rcwt->cluster_pos++;
        if (!in_block) {
            in_block = 1;
            nb_block_bytes = 1;
            continue;
        }
        nb_block_bytes++;
        if (nb_block_bytes == RCWT_BLOCK_SIZE) {
            in_block = 0;
            nb_block_bytes = 0;
            rcwt->cluster_nb_blocks++;
        }
    }
    return 0;
}
