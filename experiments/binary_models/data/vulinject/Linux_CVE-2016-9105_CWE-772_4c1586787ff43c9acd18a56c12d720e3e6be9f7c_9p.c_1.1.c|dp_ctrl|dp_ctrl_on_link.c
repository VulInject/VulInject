int dp_ctrl_on_link(struct dp_ctrl *dp_ctrl)
{
	int rc = 0;
	struct dp_ctrl_private *ctrl;
	unsigned int rate;
	int link_train_max_retries = 5;
	unsigned int const phy_cts_pixel_clk_khz = 148500;
	unsigned char link_status[DP_LINK_STATUS_SIZE];
	unsigned int training_step;
	unsigned int pixel_rate;
	if (!dp_ctrl)
		return -EINVAL;
	ctrl = container_of(dp_ctrl, struct dp_ctrl_private, dp_ctrl);
	rate = ctrl->panel->link_info.rate;
	pixel_rate = ctrl->panel->dp_mode.drm_mode.clock;
	dp_ctrl_core_clk_enable(&ctrl->dp_ctrl);
	if (ctrl->link->sink_request & DP_TEST_LINK_PHY_TEST_PATTERN) {
		drm_dbg_dp(ctrl->drm_dev,
				"using phy test link parameters\n");
		if (!pixel_rate)
			pixel_rate = phy_cts_pixel_clk_khz;
	} else {
		ctrl->link->link_params.rate = rate;
		ctrl->link->link_params.num_lanes =
			ctrl->panel->link_info.num_lanes;
		if (ctrl->panel->dp_mode.out_fmt_is_yuv_420)
			pixel_rate >>= 1;
	}
	drm_dbg_dp(ctrl->drm_dev, "rate=%d, num_lanes=%d, pixel_rate=%lu\n",
		ctrl->link->link_params.rate, ctrl->link->link_params.num_lanes,
		pixel_rate);
	rc = dp_ctrl_enable_mainlink_clocks(ctrl);
	if (rc)
		return rc;
	while (--link_train_max_retries) {
		training_step = DP_TRAINING_NONE;
		rc = dp_ctrl_setup_main_link(ctrl, &training_step);
		if (rc == 0) {
			break;
		} else if (training_step == DP_TRAINING_1) {
			if (!dp_catalog_link_is_connected(ctrl->catalog))
				break;
			rc = dp_ctrl_link_rate_down_shift(ctrl);
			if (rc < 0) { 
				if (dp_ctrl_clock_recovery_any_ok(link_status,
					ctrl->link->link_params.num_lanes)) {
					rc = dp_ctrl_link_lane_down_shift(ctrl);
					if (rc < 0) { 
						break;
					}
				} else {
					break; 
				}
			}
		} else if (training_step == DP_TRAINING_2) {
			if (!dp_catalog_link_is_connected(ctrl->catalog))
				break;
			dp_ctrl_read_link_status(ctrl, link_status);
			if (!drm_dp_clock_recovery_ok(link_status,
					ctrl->link->link_params.num_lanes))
				rc = dp_ctrl_link_rate_down_shift(ctrl);
			else
				rc = dp_ctrl_link_lane_down_shift(ctrl);
			if (rc < 0) {
				break; 
			}
			dp_ctrl_clear_training_pattern(ctrl);
		}
		rc = dp_ctrl_reinitialize_mainlink(ctrl);
		if (rc) {
			DRM_ERROR("Failed to reinitialize mainlink. rc=%d\n", rc);
			break;
		}
	}
	if (ctrl->link->sink_request & DP_TEST_LINK_PHY_TEST_PATTERN)
		return rc;
	if (rc == 0) {  
	} else  {
		dp_ctrl_clear_training_pattern(ctrl);
		dp_ctrl_deinitialize_mainlink(ctrl);
		rc = -ECONNRESET;
	}
	return rc;
}
