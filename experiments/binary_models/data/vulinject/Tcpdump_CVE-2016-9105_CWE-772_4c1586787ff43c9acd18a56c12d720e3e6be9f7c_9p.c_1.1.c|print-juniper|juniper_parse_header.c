juniper_parse_header(netdissect_options *ndo,
                     const u_char *p, const struct pcap_pkthdr *h, struct juniper_l2info_t *l2info)
{
    const struct juniper_cookie_table_t *lp;
    u_int idx, extension_length, jnx_header_len = 0;
    unsigned char tlv_type,tlv_len;
#ifdef DLT_JUNIPER_ATM2
    unsigned int control_word;
#endif
    int tlv_value;
    const u_char *tptr;
    l2info->header_len = 0;
    l2info->cookie_len = 0;
    l2info->proto = 0;
    l2info->length = h->len;
    l2info->caplen = h->caplen;
    l2info->flags = GET_U_1(p + 3);
    l2info->direction = GET_U_1(p + 3) & JUNIPER_BPF_PKT_IN;
    if (GET_BE_U_3(p) != JUNIPER_MGC_NUMBER) { 
        ND_PRINT("no magic-number found!");
        return 0;
    }
    if (ndo->ndo_eflag) 
        ND_PRINT("%3s ", tok2str(juniper_direction_values, "---", l2info->direction));
    jnx_header_len = 4;
    if (ndo->ndo_vflag > 1)
        ND_PRINT("\n\tJuniper PCAP Flags [%s]",
               bittok2str(jnx_flag_values, "none", l2info->flags));
    if ((l2info->flags & JUNIPER_BPF_EXT ) == JUNIPER_BPF_EXT ) {
        tptr = p+jnx_header_len;
        extension_length = GET_BE_U_2(tptr);
        jnx_header_len += 2;
        tptr +=2;
        jnx_header_len += extension_length;
        if (ndo->ndo_vflag > 1)
            ND_PRINT(", PCAP Extension(s) total length %u", extension_length);
        while (extension_length > JUNIPER_EXT_TLV_OVERHEAD) {
            tlv_type = GET_U_1(tptr);
            tptr++;
            tlv_len = GET_U_1(tptr);
            tptr++;
            tlv_value = 0;
            if (tlv_type == 0 || tlv_len == 0)
                break;
            ND_ICHECK_U(extension_length, <,
                        tlv_len + JUNIPER_EXT_TLV_OVERHEAD);
            if (ndo->ndo_vflag > 1)
                ND_PRINT("\n\t  %s Extension TLV #%u, length %u, value ",
                       tok2str(jnx_ext_tlv_values,"Unknown",tlv_type),
                       tlv_type,
                       tlv_len);
            tlv_value = juniper_read_tlv_value(ndo, tptr, tlv_type, tlv_len);
            switch (tlv_type) {
            case JUNIPER_EXT_TLV_IFD_NAME:
                break;
            case JUNIPER_EXT_TLV_IFD_MEDIATYPE:
            case JUNIPER_EXT_TLV_TTP_IFD_MEDIATYPE:
                if (tlv_value != -1) {
                    if (ndo->ndo_vflag > 1)
                        ND_PRINT("%s (%u)",
                               tok2str(juniper_ifmt_values, "Unknown", tlv_value),
                               tlv_value);
                }
                break;
            case JUNIPER_EXT_TLV_IFL_ENCAPS:
            case JUNIPER_EXT_TLV_TTP_IFL_ENCAPS:
                if (tlv_value != -1) {
                    if (ndo->ndo_vflag > 1)
                        ND_PRINT("%s (%u)",
                               tok2str(juniper_ifle_values, "Unknown", tlv_value),
                               tlv_value);
                }
                break;
            case JUNIPER_EXT_TLV_IFL_IDX: 
            case JUNIPER_EXT_TLV_IFL_UNIT:
            case JUNIPER_EXT_TLV_IFD_IDX:
            default:
                if (tlv_value != -1) {
                    if (ndo->ndo_vflag > 1)
                        ND_PRINT("%u", tlv_value);
                }
                break;
            }
            tptr+=tlv_len;
            extension_length -= tlv_len+JUNIPER_EXT_TLV_OVERHEAD;
        }
        if (ndo->ndo_vflag > 1)
            ND_PRINT("\n\t-----original packet-----\n\t");
    }
    if ((l2info->flags & JUNIPER_BPF_NO_L2 ) == JUNIPER_BPF_NO_L2 ) {
        if (ndo->ndo_eflag)
            ND_PRINT("no-L2-hdr, ");
        ND_TCHECK_1(p + (jnx_header_len + 4));
        if (ip_heuristic_guess(ndo, p + jnx_header_len + 4,
                               l2info->length - (jnx_header_len + 4)) == 0)
            ND_PRINT("no IP-hdr found!");
        l2info->header_len=jnx_header_len+4;
        return 0; 
    }
    l2info->header_len = jnx_header_len;
    p+=l2info->header_len;
    l2info->length -= l2info->header_len;
    l2info->caplen -= l2info->header_len;
    lp = NULL;
    for (const struct juniper_cookie_table_t *table_lp = juniper_cookie_table;
         table_lp->s != NULL; table_lp++) {
        if (table_lp->pictype == l2info->pictype) {
            lp = table_lp;
            break;
        }
    }
    if (lp != NULL) {
        l2info->cookie_len += lp->cookie_len;
        switch (GET_U_1(p)) {
        case LS_COOKIE_ID:
            l2info->cookie_type = LS_COOKIE_ID;
            l2info->cookie_len += 2;
            break;
        case AS_COOKIE_ID:
            l2info->cookie_type = AS_COOKIE_ID;
            l2info->cookie_len = 8;
            break;
        default:
            l2info->bundle = l2info->cookie[0];
            break;
        }
#ifdef DLT_JUNIPER_MFR
        if (l2info->pictype == DLT_JUNIPER_MFR &&
            (GET_U_1(p) & MFR_BE_MASK) == MFR_BE_MASK) {
            l2info->cookie_len = 0;
        }
#endif
        l2info->header_len += l2info->cookie_len;
        l2info->length -= l2info->cookie_len;
        l2info->caplen -= l2info->cookie_len;
        if (ndo->ndo_eflag)
            ND_PRINT("%s-PIC, cookie-len %u",
                   lp->s,
                   l2info->cookie_len);
        if (l2info->cookie_len > 8) {
            nd_print_invalid(ndo);
            return 0;
        }
        if (l2info->cookie_len > 0) {
            ND_TCHECK_LEN(p, l2info->cookie_len);
            if (ndo->ndo_eflag)
                ND_PRINT(", cookie 0x");
            for (idx = 0; idx < l2info->cookie_len; idx++) {
                l2info->cookie[idx] = GET_U_1(p + idx); 
                if (ndo->ndo_eflag) ND_PRINT("%02x", GET_U_1(p + idx));
            }
        }
        if (ndo->ndo_eflag) ND_PRINT(": "); 
        l2info->proto = GET_BE_U_2(p + l2info->cookie_len);
    }
    p+=l2info->cookie_len;
    switch(l2info->pictype) {
#ifdef DLT_JUNIPER_MLPPP
    case DLT_JUNIPER_MLPPP:
        switch (l2info->cookie_type) {
        case LS_COOKIE_ID:
            l2info->bundle = l2info->cookie[1];
            break;
        case AS_COOKIE_ID:
            l2info->bundle = (EXTRACT_BE_U_2(&l2info->cookie[6])>>3)&0xfff;
            l2info->proto = (l2info->cookie[5])&JUNIPER_LSQ_L3_PROTO_MASK;
            break;
        default:
            l2info->bundle = l2info->cookie[0];
            break;
        }
        break;
#endif
#ifdef DLT_JUNIPER_MLFR
    case DLT_JUNIPER_MLFR:
        switch (l2info->cookie_type) {
        case LS_COOKIE_ID:
            l2info->bundle = l2info->cookie[1];
            l2info->proto = GET_BE_U_2(p);
            l2info->header_len += 2;
            l2info->length -= 2;
            l2info->caplen -= 2;
            break;
        case AS_COOKIE_ID:
            l2info->bundle = (EXTRACT_BE_U_2(&l2info->cookie[6])>>3)&0xfff;
            l2info->proto = (l2info->cookie[5])&JUNIPER_LSQ_L3_PROTO_MASK;
            break;
        default:
            l2info->bundle = l2info->cookie[0];
            l2info->header_len += 2;
            l2info->length -= 2;
            l2info->caplen -= 2;
            break;
        }
        break;
#endif
#ifdef DLT_JUNIPER_MFR
    case DLT_JUNIPER_MFR:
        switch (l2info->cookie_type) {
        case LS_COOKIE_ID:
            l2info->bundle = l2info->cookie[1];
            l2info->proto = GET_BE_U_2(p);
            l2info->header_len += 2;
            l2info->length -= 2;
            l2info->caplen -= 2;
            break;
        case AS_COOKIE_ID:
            l2info->bundle = (EXTRACT_BE_U_2(&l2info->cookie[6])>>3)&0xfff;
            l2info->proto = (l2info->cookie[5])&JUNIPER_LSQ_L3_PROTO_MASK;
            break;
        default:
            l2info->bundle = l2info->cookie[0];
            break;
        }
        break;
#endif
#ifdef DLT_JUNIPER_ATM2
    case DLT_JUNIPER_ATM2:
        ND_TCHECK_4(p);
        if (l2info->cookie[7] & ATM2_PKT_TYPE_MASK) {
            control_word = GET_BE_U_4(p);
            switch(control_word) {
            case 0: 
            case 0x08000000: 
            case 0x08380000: 
                l2info->header_len += 4;
                break;
            default:
                break;
            }
            if (ndo->ndo_eflag)
                ND_PRINT("control-word 0x%08x ", control_word);
        }
        break;
#endif
#ifdef DLT_JUNIPER_ES
    case DLT_JUNIPER_ES:
        break;
#endif
#ifdef DLT_JUNIPER_GGSN
    case DLT_JUNIPER_GGSN:
        break;
#endif
#ifdef DLT_JUNIPER_SERVICES
    case DLT_JUNIPER_SERVICES:
        break;
#endif
#ifdef DLT_JUNIPER_ATM1
    case DLT_JUNIPER_ATM1:
        break;
#endif
#ifdef DLT_JUNIPER_PPP
    case DLT_JUNIPER_PPP:
        break;
#endif
#ifdef DLT_JUNIPER_CHDLC
    case DLT_JUNIPER_CHDLC:
        break;
#endif
#ifdef DLT_JUNIPER_ETHER
    case DLT_JUNIPER_ETHER:
        break;
#endif
#ifdef DLT_JUNIPER_FRELAY
    case DLT_JUNIPER_FRELAY:
        break;
#endif
#ifdef DLT_JUNIPER_MONITOR
    case DLT_JUNIPER_MONITOR:
        break;
#endif
#ifdef DLT_JUNIPER_PPPOE
    case DLT_JUNIPER_PPPOE:
        break;
#endif
#ifdef DLT_JUNIPER_PPPOE_ATM
    case DLT_JUNIPER_PPPOE_ATM:
        break;
#endif
    default:
        ND_PRINT("Unknown Juniper DLT_ type %u: ", l2info->pictype);
        break;
    }
    if (ndo->ndo_eflag)
        ND_PRINT("hlen %u, proto 0x%04x, ", l2info->header_len, l2info->proto);
    return 1; 
invalid:
    nd_print_invalid(ndo);
    return 0;
}
