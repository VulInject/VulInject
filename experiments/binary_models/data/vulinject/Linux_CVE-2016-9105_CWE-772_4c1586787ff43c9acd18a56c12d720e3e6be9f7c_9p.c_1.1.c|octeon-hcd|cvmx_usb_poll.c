static int cvmx_usb_poll(struct octeon_hcd *usb)
{
	union cvmx_usbcx_hfnum usbc_hfnum;
	union cvmx_usbcx_gintsts usbc_gintsts;
	prefetch_range(usb, sizeof(*usb));
	usbc_hfnum.unsigned int = cvmx_usb_read_csr32(usb, CVMX_USBCX_HFNUM(usb->index));
	if ((usb->frame_number & 0x3fff) > usbc_hfnum.s.frnum)
		usb->frame_number += 0x4000;
	usb->frame_number &= ~0x3fffull;
	usb->frame_number |= usbc_hfnum.s.frnum;
	usbc_gintsts.unsigned int = cvmx_usb_read_csr32(usb,
					       CVMX_USBCX_GINTSTS(usb->index));
	cvmx_usb_write_csr32(usb, CVMX_USBCX_GINTSTS(usb->index),
			     usbc_gintsts.unsigned int);
	if (usbc_gintsts.s.rxflvl) {
		if (usb->init_flags & CVMX_USB_INITIALIZE_FLAGS_NO_DMA)
			cvmx_usb_poll_rx_fifo(usb);
	}
	if (usbc_gintsts.s.ptxfemp || usbc_gintsts.s.nptxfemp) {
		if (usb->init_flags & CVMX_USB_INITIALIZE_FLAGS_NO_DMA)
			cvmx_usb_poll_tx_fifo(usb);
	}
	if (usbc_gintsts.s.disconnint || usbc_gintsts.s.prtint) {
		union cvmx_usbcx_hprt usbc_hprt;
		octeon_usb_port_callback(usb);
		usbc_hprt.unsigned int =
			cvmx_usb_read_csr32(usb, CVMX_USBCX_HPRT(usb->index));
		usbc_hprt.s.prtena = 0;
		cvmx_usb_write_csr32(usb, CVMX_USBCX_HPRT(usb->index),
				     usbc_hprt.unsigned int);
	}
	if (usbc_gintsts.s.hchint) {
		union cvmx_usbcx_haint usbc_haint;
		usbc_haint.unsigned int = cvmx_usb_read_csr32(usb,
						     CVMX_USBCX_HAINT(usb->index));
		while (usbc_haint.unsigned int) {
			int channel;
			channel = __fls(usbc_haint.unsigned int);
			usbc_haint.unsigned int ^= 1 << channel;
		}
	}
	cvmx_usb_schedule(usb, usbc_gintsts.s.sof);
	return 0;
}
