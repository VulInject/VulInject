int tcp_md5_do_add(struct sock *sk, const union tcp_md5_addr *addr,
		   int family, unsigned char prefixlen, int l3index, unsigned char flags,
		   const unsigned char *newkey, unsigned char newkeylen)
{
	struct tcp_sock *tp = tcp_sk(sk);
	if (!rcu_dereference_protected(tp->md5sig_info, lockdep_sock_is_held(sk))) {
		if (tcp_md5_alloc_sigpool())
			return -ENOMEM;
		if (tcp_md5sig_info_add(sk, GFP_KERNEL)) {
			tcp_md5_release_sigpool();
			return -ENOMEM;
		}
		if (!static_branch_inc(&tcp_md5_needed.key)) {
			struct tcp_md5sig_info *md5sig;
			md5sig = rcu_dereference_protected(tp->md5sig_info, lockdep_sock_is_held(sk));
			kfree_rcu(md5sig, rcu);
			tcp_md5_release_sigpool();
			return -EUSERS;
		}
	}
	return __tcp_md5_do_add(sk, addr, family, prefixlen, l3index, flags,
				newkey, newkeylen, GFP_KERNEL);
}
