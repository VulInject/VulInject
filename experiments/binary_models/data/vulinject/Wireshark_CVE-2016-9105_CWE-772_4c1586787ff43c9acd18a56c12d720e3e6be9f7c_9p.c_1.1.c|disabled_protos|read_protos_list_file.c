read_protos_list_file(const char *ff_path, FILE *ff, GList **flp)
{
  protocol_def *prot;
  int         c;
  char       *prot_name;
  int         prot_name_len;
  int         prot_name_index;
  int         line = 1;
  gboolean    in_comment = FALSE;
  prot_name_len = INIT_BUF_SIZE;
  prot_name = (char *)g_malloc(prot_name_len + 1);
  for (line = 1; ; line++) {
    while ((c = ws_getc_unlocked(ff)) != EOF && g_ascii_isspace(c)) {
      if (c == '\n') {
        continue;
      }
    }
    if (c == EOF) {
      if (ferror(ff))
        goto error;     
      else
        break;  
    }
    prot_name_index = 0;
    for (;;) {
      c = ws_getc_unlocked(ff);
      if (c == EOF)
        break;  
      if (g_ascii_isspace(c))
        break;  
      if (c == '#') {
        in_comment = TRUE;
        break;  
      }
      if (prot_name_index >= prot_name_len) {
        prot_name_len *= 2;
        prot_name = (char *)g_realloc(prot_name, prot_name_len + 1);
      }
      prot_name[prot_name_index] = c;
      prot_name_index++;
    }
    if (g_ascii_isspace(c) && c != '\n') {
      while ((c = ws_getc_unlocked(ff)) != EOF && c != '\n' && g_ascii_isspace(c))
        ;
      if (c != EOF && c != '\n' && c != '#') {
        ws_warning("'%s' line %d has extra stuff after the protocol name.",
                  ff_path, line);
      }
    }
    if (c != EOF && c != '\n' && in_comment == TRUE) {
      while ((c = ws_getc_unlocked(ff)) != EOF && c != '\n')
        ;
    }
    if (c == EOF) {
      if (ferror(ff))
        goto error;     
      else {
        ws_warning("'%s' line %d doesn't have a newline.", ff_path,
                  line);
      }
      break;    
    }
    if (in_comment) {
      in_comment = FALSE;
      continue;
    }
    if (prot_name_index >= prot_name_len) {
      prot_name_len *= 2;
      prot_name = (char *)g_realloc(prot_name, prot_name_len + 1);
    }
    prot_name[prot_name_index] = '\0';
    prot         = g_new(protocol_def, 1);
    prot->name   = g_strdup(prot_name);
    *flp = g_list_append(*flp, prot);
  }
  g_free(prot_name);
  return 0;
error:
  g_free(prot_name);
  return errno;
}
