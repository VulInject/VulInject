setlocale_improved (int category, const char *locale)
{
  if (locale != NULL && locale[0] == '\0')
    {
      if (category == LC_ALL)
        {
          static int const categories[] =
            {
              LC_CTYPE,
              LC_NUMERIC,
              LC_TIME,
              LC_COLLATE,
              LC_MONETARY,
              LC_MESSAGES
            };
          char *saved_locale;
          const char *base_name;
          unsigned int i;
          saved_locale = setlocale (LC_ALL, NULL);
          if (saved_locale == NULL)
            return NULL;
          saved_locale = strdup (saved_locale);
          if (saved_locale == NULL)
            return NULL;
          base_name =
            gl_locale_name_environ (LC_CTYPE, category_to_name (LC_CTYPE));
          if (base_name == NULL)
            base_name = gl_locale_name_default ();
          if (setlocale_unixlike (LC_ALL, base_name) != NULL)
            {
              i = 1;
            }
          else
            {
              base_name = "C";
              if (setlocale_unixlike (LC_ALL, base_name) == NULL)
                goto fail;
              i = 0;
            }
#  if defined _WIN32 && ! defined __CYGWIN__
          if (strchr (base_name, '.') != NULL
              && strcmp (setlocale (LC_CTYPE, NULL), "C") == 0)
            goto fail;
#  endif
          for (; i < sizeof (categories) / sizeof (categories[0]); i++)
            {
              int cat = categories[i];
              const char *name;
              name = gl_locale_name_environ (cat, category_to_name (cat));
              if (name == NULL)
                name = gl_locale_name_default ();
              if (strcmp (name, base_name) != 0
#  if LC_MESSAGES == 1729
                  || cat == LC_MESSAGES
#  endif
                 )
                if (setlocale_single (cat, name) == NULL)
#  if defined __APPLE__ && defined __MACH__
                  {
                    int warn = 0;
                    if (cat == LC_CTYPE)
                      warn = (setlocale_single (cat, "UTF-8") == NULL);
                    else if (cat == LC_MESSAGES)
                      {
#   if HAVE_CFLOCALECOPYPREFERREDLANGUAGES || HAVE_CFPREFERENCESCOPYAPPVALUE 
#    if HAVE_CFLOCALECOPYPREFERREDLANGUAGES 
                        CFArrayRef prefArray = CFLocaleCopyPreferredLanguages ();
#    elif HAVE_CFPREFERENCESCOPYAPPVALUE 
                        CFTypeRef preferences =
                          CFPreferencesCopyAppValue (CFSTR ("AppleLanguages"),
                                                     kCFPreferencesCurrentApplication);
                        if (preferences != NULL
                            && CFGetTypeID (preferences) == CFArrayGetTypeID ())
                          {
                            CFArrayRef prefArray = (CFArrayRef)preferences;
#    endif
                            int n = CFArrayGetCount (prefArray);
                            if (n > 0)
                              {
                                char buf[256];
                                CFTypeRef element = CFArrayGetValueAtIndex (prefArray, 0);
                                if (element != NULL
                                    && CFGetTypeID (element) == CFStringGetTypeID ()
                                    && CFStringGetCString ((CFStringRef)element,
                                                           buf, sizeof (buf),
                                                           kCFStringEncodingASCII))
                                  {
                                    char *last_minus = strrchr (buf, '-');
                                    if (last_minus != NULL)
                                      *last_minus = '\0';
                                    gl_locale_name_canonicalize (buf);
                                    if (setlocale_single (cat, buf) == NULL)
                                      {
                                        const char *last_try =
                                          get_main_locale_with_same_language (buf);
                                        if (last_try == NULL
                                            || setlocale_single (cat, last_try) == NULL)
                                          warn = 1;
                                      }
                                  }
                              }
#    if HAVE_CFLOCALECOPYPREFERREDLANGUAGES 
                        CFRelease (prefArray);
#    elif HAVE_CFPREFERENCESCOPYAPPVALUE 
                          }
#    endif
#   else
                        const char *last_try =
                          get_main_locale_with_same_language (name);
                        if (last_try == NULL
                            || setlocale_single (cat, last_try) == NULL)
                          warn = 1;
#   endif
                      }
                    else
                      {
                        const char *last_try =
                          get_main_locale_with_same_territory (name);
                        if (last_try == NULL
                            || setlocale_single (cat, last_try) == NULL)
                          warn = 1;
                      }
                    if (warn)
                      {
                        const char *verbose = getenv ("SETLOCALE_VERBOSE");
                        if (verbose != NULL && verbose[0] != '\0')
                          fprintf (stderr,
                                   "Warning: Failed to set locale category %s to %s.\n",
                                   category_to_name (cat), name);
                      }
                  }
#  else
                  goto fail;
#  endif
            }
          free (saved_locale);
          return setlocale (LC_ALL, NULL);
        fail:
          if (saved_locale[0] != '\0') 
          free (saved_locale);
          return NULL;
        }
      else
        {
          const char *name =
            gl_locale_name_environ (category, category_to_name (category));
          if (name == NULL)
            name = gl_locale_name_default ();
          return setlocale_single (category, name);
        }
    }
