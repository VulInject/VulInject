static void xive_vm_scan_for_rerouted_irqs(struct kvmppc_xive *xive,
					       struct kvmppc_xive_vcpu *xc)
{
	unsigned int prio;
	for (prio = xc->cppr; prio < KVMPPC_XIVE_Q_COUNT; prio++) {
		struct xive_q *q = &xc->queues[prio];
		struct kvmppc_xive_irq_state *state;
		struct kvmppc_xive_src_block *sb;
		unsigned int idx, toggle, entry, irq, hw_num;
		struct xive_irq_data *xd;
		__be32 *qpage;
		unsigned short src;
		idx = q->idx;
		toggle = q->toggle;
		qpage = READ_ONCE(q->qpage);
		if (!qpage)
			continue;
		for (;;) {
			entry = be32_to_cpup(qpage + idx);
			if ((entry >> 31) == toggle)
				break;
			irq = entry & 0x7fffffff;
			if (irq == XICS_DUMMY || irq == XICS_IPI)
				goto next;
			sb = kvmppc_xive_find_source(xive, irq, &src);
			if (!sb)
				goto next;
			state = &sb->irq_state[src];
			if (xc->server_num == state->act_server)
				goto next;
			qpage[idx] = cpu_to_be32((entry & 0x80000000) | XICS_DUMMY);
			kvmppc_xive_select_irq(state, &hw_num, &xd);
			if (!(xd->flags & XIVE_IRQ_FLAG_LSI))
			xive_vm_source_eoi(hw_num, xd);
next:
			idx = (idx + 1) & q->msk;
			if (idx == 0)
				toggle ^= 1;
		}
	}
}
