int r4k_clockevent_init(void)
{
	unsigned int flags = IRQF_PERCPU | IRQF_TIMER | IRQF_SHARED;
	unsigned int cpu = smp_processor_id();
	struct clock_event_device *cd;
	int irq, min_delta;
	if (!cpu_has_counter || !mips_hpt_frequency)
		return -ENXIO;
	if (!c0_compare_int_usable())
		return -ENXIO;
	irq = get_c0_compare_int();
	cd = &per_cpu(mips_clockevent_device, cpu);
	cd->name		= "MIPS";
	cd->features		= CLOCK_EVT_FEAT_ONESHOT |
				  CLOCK_EVT_FEAT_C3STOP |
				  CLOCK_EVT_FEAT_PERCPU;
	min_delta		= calculate_min_delta();
	cd->rating		= 300;
	cd->irq			= irq;
	cd->cpumask		= cpumask_of(cpu);
	cd->set_next_event	= mips_next_event;
	cd->event_handler	= mips_event_handler;
	clockevents_config_and_register(cd, mips_hpt_frequency, min_delta, 0x7fffffff);
	if (cp0_timer_irq_installed)
		return 0;
	cp0_timer_irq_installed = 1;
	if (request_irq(irq, c0_compare_interrupt, flags, "timer",
			c0_compare_interrupt))
		pr_err("Failed to request irq %d (timer)\n", irq);
	return 0;
}
