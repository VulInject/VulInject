lpfc_sli4_post_dev_loss_tmo_handler(struct lpfc_hba *phba, int fcf_inuse,
				    unsigned int nlp_did)
{
	if (!fcf_inuse)
		return;
	if (test_bit(HBA_FIP_SUPPORT, &phba->hba_flag) &&
	    !lpfc_fcf_inuse(phba)) {
		if (phba->fcf.fcf_flag & FCF_DISCOVERY) {
			if (test_and_set_bit(HBA_DEVLOSS_TMO,
					     &phba->hba_flag)) {
				spin_unlock_irq(&phba->hbalock);
				return;
			}
			lpfc_printf_log(phba, KERN_INFO, LOG_FIP,
					"2847 Last remote node (x%x) using "
					"FCF devloss tmo\n", nlp_did);
		}
		if (phba->fcf.fcf_flag & FCF_REDISC_PROG) {
			spin_unlock_irq(&phba->hbalock);
			lpfc_printf_log(phba, KERN_INFO, LOG_FIP,
					"2868 Devloss tmo to FCF rediscovery "
					"in progress\n");
			return;
		}
		spin_unlock_irq(&phba->hbalock);
		if (!test_bit(FCF_TS_INPROG, &phba->hba_flag) &&
		    !test_bit(FCF_RR_INPROG, &phba->hba_flag)) {
			lpfc_printf_log(phba, KERN_INFO, LOG_FIP,
					"2869 Devloss tmo to idle FIP engine, "
					"unreg in-use FCF and rescan.\n");
			lpfc_unregister_fcf_rescan(phba);
			return;
		}
		if (test_bit(FCF_TS_INPROG, &phba->hba_flag))
			lpfc_printf_log(phba, KERN_INFO, LOG_FIP,
					"2870 FCF table scan in progress\n");
		if (test_bit(FCF_RR_INPROG, &phba->hba_flag))
			lpfc_printf_log(phba, KERN_INFO, LOG_FIP,
					"2871 FLOGI roundrobin FCF failover "
					"in progress\n");
	}
	lpfc_unregister_unused_fcf(phba);
}
