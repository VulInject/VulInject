mp2t_get_packet_length(tvbuff_t *tvb, guint offset, packet_info *pinfo,
            guint32 frag_id, enum pid_payload_type pload_type)
{
    mp2t_stream_key *stream;
    fragment_head *frag_head;
    fragment_item *frag = NULL;
    tvbuff_t      *len_tvb = NULL, *frag_tvb = NULL, *data_tvb = NULL;
    gint           pkt_len = 0;
    guint          remaining_len;
    stream = (mp2t_stream_key *)p_get_proto_data(pinfo->pool, pinfo, proto_mp2t, MP2T_PROTO_DATA_STREAM);
    if (pinfo->fd->visited) {
        frag_head = fragment_get_reassembled_id(&mp2t_reassembly_table, pinfo, frag_id);
        if (frag_head) {
            len_tvb = frag_head->tvb_data;
            offset = 0;
        } else {
            frag_head = fragment_get(&mp2t_reassembly_table, pinfo, frag_id, stream);
            if (!frag_head) {
                len_tvb = tvb;
            } else {
                return -1;
            }
        }
    } else {
        frag_head = fragment_get(&mp2t_reassembly_table, pinfo, frag_id, stream);
        if (frag_head) {
            frag = frag_head->next;
        }
        if (!frag) { 
            len_tvb = tvb;
        } else {
            frag_tvb = tvb_new_subset_remaining(frag->tvb_data, 0);
            len_tvb = tvb_new_composite();
            data_tvb = tvb_new_subset_remaining(tvb, offset);
            tvb_composite_append(len_tvb, data_tvb);
            tvb_composite_finalize(len_tvb);
            offset = frag->offset;
        }
    }
    remaining_len = tvb_reported_length_remaining(len_tvb, offset);
    switch (pload_type) {
        case pid_pload_docsis:
            if (remaining_len < 4)
                return -1;
            pkt_len = tvb_get_ntohs(len_tvb, offset + 2) + 6;
            break;
        case pid_pload_pes:
            if (remaining_len < 6)
                return -1;
            pkt_len = tvb_get_ntohs(len_tvb, offset + 4);
            if (pkt_len) 
                pkt_len += 6;
            break;
        case pid_pload_sect:
            if (remaining_len < 3)
                return -1;
            pkt_len = (tvb_get_ntohs(len_tvb, offset + 1) & 0xFFF) + 3;
            break;
        default:
            break;
    }
    return pkt_len;
}
