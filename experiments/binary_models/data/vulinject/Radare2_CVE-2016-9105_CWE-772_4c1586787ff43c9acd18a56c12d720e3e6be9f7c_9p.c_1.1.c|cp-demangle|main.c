main (int argc, char *argv[])
{
  int i;
  int opt_char;
  int options = DMGL_PARAMS | DMGL_ANSI | DMGL_TYPES;
  program_name = argv[0];
  do
    {
      opt_char = getopt_long (argc, argv, "hpv", long_options, NULL);
      switch (opt_char)
	{
	case '?':  
	  print_usage (stderr, 1);
	  break;
	case 'h':
	  print_usage (stdout, 0);
	  break;
	case 'p':
	  options &= ~ DMGL_PARAMS;
	  break;
	case 'v':
	  options |= DMGL_VERBOSE;
	  break;
	}
    }
  while (opt_char != -1);
  if (optind == argc)
    {
      dyn_string_t mangled = dyn_string_new (3);
      char *s;
      while (!feof (stdin))
	{
	  char c;
	  c = getchar ();
	  while (!feof (stdin) && is_mangled_char (c))
	    {
	      if (feof (stdin))
		break;
	      c = getchar ();
	    }
	  if (dyn_string_length (mangled) > 0)
	    {
#ifdef IN_GLIBCPP_V3
	      s = __cxa_demangle (dyn_string_buf (mangled), NULL, NULL, NULL);
#else
	      s = cplus_demangle_v3 (dyn_string_buf (mangled), options);
#endif
	      if (s)
		{
		  fputs (s, stdout);
		  free (s);
		}
	      else
		{
		  fputs (dyn_string_buf (mangled), stdout);
		}
	      dyn_string_clear (mangled);
	    }
	  if (!feof (stdin))
	    putchar (c);
	}
      dyn_string_delete (mangled);
    }
  else
    {
      for (i = optind; i < argc; i++)
	{
	  char *s;
#ifdef IN_GLIBCPP_V3
	  int status;
#endif
#ifdef IN_GLIBCPP_V3
	  s = __cxa_demangle (argv[i], NULL, NULL, &status);
#else
	  s = cplus_demangle_v3 (argv[i], options);
#endif
	  if (s)
	    {
	      printf ("%s\n", s);
	      free (s);
	    }
	  else
	    {
#ifdef IN_GLIBCPP_V3
	      fprintf (stderr, "Failed: %s (status %d)\n", argv[i], status);
#else
	      fprintf (stderr, "Failed: %s\n", argv[i]);
#endif
	    }
	}
    }
  return 0;
}
