static struct net_device *sky2_init_netdev(struct sky2_hw *hw, unsigned port,
					   int highmem, int wol)
{
	struct sky2_port *sky2;
	struct net_device *dev = alloc_etherdev(sizeof(*sky2));
	SET_NETDEV_DEV(dev, &hw->pdev->dev);
	dev->irq = hw->pdev->irq;
	dev->ethtool_ops = &sky2_ethtool_ops;
	dev->watchdog_timeo = TX_WATCHDOG;
	dev->netdev_ops = &sky2_netdev_ops[port];
	sky2 = netdev_priv(dev);
	sky2->netdev = dev;
	sky2->hw = hw;
	sky2->msg_enable = netif_msg_init(debug, default_msg);
	u64_stats_init(&sky2->tx_stats.syncp);
	u64_stats_init(&sky2->rx_stats.syncp);
	sky2->flags = SKY2_FLAG_AUTO_SPEED | SKY2_FLAG_AUTO_PAUSE;
	if (hw->chip_id != CHIP_ID_YUKON_XL)
		dev->hw_features |= NETIF_F_RXCSUM;
	sky2->flow_mode = FC_BOTH;
	sky2->duplex = -1;
	sky2->speed = -1;
	sky2->advertising = sky2_supported_modes(hw);
	sky2->wol = wol;
	spin_lock_init(&sky2->phy_lock);
	sky2->tx_pending = TX_DEF_PENDING;
	sky2->tx_ring_size = roundup_ring_size(TX_DEF_PENDING);
	sky2->rx_pending = RX_DEF_PENDING;
	hw->dev[port] = dev;
	sky2->port = port;
	dev->hw_features |= NETIF_F_IP_CSUM | NETIF_F_SG | NETIF_F_TSO;
	if (highmem)
		dev->features |= NETIF_F_HIGHDMA;
	if (!(hw->flags & SKY2_HW_RSS_BROKEN))
		dev->hw_features |= NETIF_F_RXHASH;
	if (!(hw->flags & SKY2_HW_VLAN_BROKEN)) {
		dev->hw_features |= NETIF_F_HW_VLAN_CTAG_TX |
				    NETIF_F_HW_VLAN_CTAG_RX;
		dev->vlan_features |= SKY2_VLAN_OFFLOADS;
	}
	dev->features |= dev->hw_features;
	dev->min_mtu = ETH_ZLEN;
	if (hw->chip_id == CHIP_ID_YUKON_FE ||
	    hw->chip_id == CHIP_ID_YUKON_FE_P)
		dev->max_mtu = ETH_DATA_LEN;
	else
		dev->max_mtu = ETH_JUMBO_MTU;
	ret = of_get_ethdev_address(hw->pdev->dev.of_node, dev);
	if (ret) {
		unsigned char addr[ETH_ALEN];
		memcpy_fromio(addr, hw->regs + B2_MAC_1 + port * 8, ETH_ALEN);
		eth_hw_addr_set(dev, addr);
	}
	if (!is_valid_ether_addr(dev->dev_addr)) {
		struct sockaddr sa = { AF_UNSPEC };
		dev_warn(&hw->pdev->dev, "Invalid MAC address, defaulting to random\n");
		eth_hw_addr_random(dev);
		memcpy(sa.sa_data, dev->dev_addr, ETH_ALEN);
		if (sky2_set_mac_address(dev, &sa))
			dev_warn(&hw->pdev->dev, "Failed to set MAC address.\n");
	}
	return dev;
}
