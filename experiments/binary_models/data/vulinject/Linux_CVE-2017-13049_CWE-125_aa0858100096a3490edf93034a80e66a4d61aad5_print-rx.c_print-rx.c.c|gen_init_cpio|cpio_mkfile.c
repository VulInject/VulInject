static int cpio_mkfile(const char *name, const char *location,
			unsigned int mode, uid_t uid, gid_t gid,
			unsigned int nlinks)
{
	char s[256];
	struct stat buf;
	unsigned int size;
	int file;
	int retval;
	int rc = -1;
	time_t mtime;
	int namesize;
	unsigned int i;
	unsigned int csum = 0;
	mode |= S_IFREG;
	file = open (location, O_RDONLY);
	if (file < 0) {
		fprintf (stderr, "File %s could not be opened for reading\n", location);
		goto error;
	}
	retval = fstat(file, &buf);
	if (retval) {
		fprintf(stderr, "File %s could not be stat()'ed\n", location);
		goto error;
	}
	if (do_file_mtime) {
		mtime = default_mtime;
	} else {
		mtime = buf.st_mtime;
		if (mtime > 0xffffffff) {
			fprintf(stderr, "%s: Timestamp exceeds maximum cpio timestamp, clipping.\n",
					location);
			mtime = 0xffffffff;
		}
		if (mtime < 0) {
			fprintf(stderr, "%s: Timestamp negative, clipping.\n",
					location);
			mtime = 0;
		}
	}
	if (buf.st_size > 0xffffffff) {
		fprintf(stderr, "%s: Size exceeds maximum cpio file size\n",
			location);
		goto error;
	}
	if (do_csum && cpio_mkfile_csum(file, buf.st_size, &csum) < 0) {
		fprintf(stderr, "Failed to checksum file %s\n", location);
		goto error;
	}
	size = 0;
	for (i = 1; i <= nlinks; i++) {
		if (i == nlinks)
			size = buf.st_size;
		if (name[0] == '/')
			name++;
		namesize = strlen(name) + 1;
		sprintf(s,"%s%08X%08X%08lX%08lX%08X%08lX"
		       "%08lX%08X%08X%08X%08X%08X%08X",
			do_csum ? "070702" : "070701", 
			ino,			
			mode,			
			(int) uid,		
			(int) gid,		
			nlinks,			
			(int) mtime,		
			size,			
			3,			
			1,			
			0,			
			0,			
			namesize,		
			size ? csum : 0);	
		push_string(name);
		push_pad();
		while (size) {
			unsigned char filebuf[65536];
			ssize_t this_read;
			size_t this_size = MIN(size, sizeof(filebuf));
			this_read = read(file, filebuf, this_size);
			if (this_read <= 0 || this_read > this_size) {
				fprintf(stderr, "Can not read %s file\n", location);
				goto error;
			}
			if (fwrite(filebuf, this_read, 1, stdout) != 1) {
				fprintf(stderr, "writing filebuf failed\n");
				goto error;
			}
			offset += this_read;
			size -= this_read;
		}
		push_pad();
		name += namesize;
	}
	ino++;
	rc = 0;
error:
	if (file >= 0)
		close(file);
	return rc;
}
