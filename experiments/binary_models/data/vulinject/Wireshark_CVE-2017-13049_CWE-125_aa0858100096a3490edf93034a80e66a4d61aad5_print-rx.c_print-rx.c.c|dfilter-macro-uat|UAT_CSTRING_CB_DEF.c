UAT_CSTRING_CB_DEF(macro,name,dfilter_macro_t)
UAT_CSTRING_CB_DEF(macro,text,dfilter_macro_t)
void convert_old_uat_file(void)
{
	uat_t *dfilter_macro_uat = NULL;
	char *err = NULL;
	char *new_path = get_persconffile_path(DMACROS_FILE_NAME, true);
	if (file_exists(new_path)) {
		return;
	}
	char *old_path = get_persconffile_path(DFILTER_MACRO_FILENAME, true);
	if (!file_exists(old_path)) {
		g_free(new_path);
		g_free(old_path);
		return;
	}
	static uat_field_t uat_fields[] =  {
		UAT_FLD_CSTRING_OTHER(macro,name,"Name",macro_name_chk,"The name of the macro."),
		UAT_FLD_CSTRING_ISPRINT(macro,text,"Text","The text this macro resolves to."),
		UAT_END_FIELDS
	};
	dfilter_macro_uat = uat_new("Display Filter Macros",
				    sizeof(dfilter_macro_t),
				    DFILTER_MACRO_FILENAME,
				    true,
				    &macros,
				    &num_macros,
				    UAT_AFFECTS_FIELDS,
				    "ChDisplayFilterMacrosSection",
				    macro_uat_copy,
				    NULL,
				    macro_uat_free,
				    macro_uat_post_update,
				    NULL,
				    uat_fields);
	if (uat_load(dfilter_macro_uat, old_path, &err)) {
		if (num_macros > 0) {
			filter_list_t *list = ws_filter_list_read(DMACROS_LIST);
			for (unsigned i = 0; i < num_macros; i++) {
				if (macros[i].usable) {
					if (ws_filter_list_find(list, macros[i].name) == NULL) {
						ws_filter_list_add(list,
							macros[i].name,
							macros[i].text);
					}
				}
			}
			ws_filter_list_write(list);
			ws_filter_list_free(list);
		}
	}
	else {
		ws_message("Error loading '%s' UAT: %s", DFILTER_MACRO_FILENAME, err);
		g_free(err);
	}
	uat_destroy(dfilter_macro_uat);
	g_free(new_path);
	g_free(old_path);
}
