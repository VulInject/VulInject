static void jr3_write_firmware(struct comedi_device *dev,
			       int subdev, const unsigned char *data, size_t size)
{
	struct jr3_block __iomem *block = dev->mmio;
	unsigned int __iomem *lo;
	unsigned int __iomem *hi;
	int more = 1;
	int pos = 0;
	while (more) {
		unsigned int count = 0;
		unsigned int addr = 0;
		more = more && read_idm_word(data, size, &pos, &count);
		if (more && count == 0xffff)
			return;
		more = more && read_idm_word(data, size, &pos, &addr);
		dev_dbg(dev->class_dev, "Loading#%d %4.4x bytes at %4.4x\n",
			subdev, count, addr);
		while (more && count > 0) {
			if (addr & 0x4000) {
				unsigned int data1 = 0;
				more = more &&
				       read_idm_word(data, size, &pos, &data1);
				count--;
			} else {
				unsigned int data1 = 0;
				unsigned int data2 = 0;
				lo = &block[subdev].program_lo[addr];
				hi = &block[subdev].program_hi[addr];
				more = more &&
				       read_idm_word(data, size, &pos, &data1);
				more = more &&
				       read_idm_word(data, size, &pos, &data2);
				count -= 2;
				if (more) {
					udelay(1);
					set_u16(hi, data2);
					udelay(1);
				}
			}
			addr++;
		}
	}
}
