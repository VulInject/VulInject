static void dbdma_end(DBDMA_io *io)
{
    DBDMA_channel *ch = io->channel;
    dbdma_cmd *current = &ch->current;
    DBDMA_DPRINTFCH(ch, "%s\n", __func__);
    if (conditional_wait(ch))
        goto wait;
    current->xfer_status = cpu_to_le16(ch->regs[DBDMA_STATUS]);
    current->res_count = cpu_to_le16(io->len);
    if (io->is_last)
        ch->regs[DBDMA_STATUS] &= ~FLUSH;
    conditional_interrupt(ch);
    conditional_branch(ch);
wait:
    /* Indicate that we're ready for a new DMA round */
    ch->io.processing = false;
    if ((ch->regs[DBDMA_STATUS] & RUN) &&
        (ch->regs[DBDMA_STATUS] & ACTIVE))
        channel_run(ch);
}
