static int encode_frame(AVCodecContext *avctx, AVPacket *avpkt,
                        const AVFrame *frame, int *got_packet_ptr)
{
    DCAEncContext *c = avctx->priv_data;
    const int32_t *samples;
    int ret, i;
    if ((ret = ff_get_encode_buffer(avctx, avpkt, c->frame_size, 0)) < 0)
        return ret;
    samples = (const int32_t *)frame->data[0];
    subband_transform(c, samples);
    if (c->lfe_channel)
        lfe_downsample(c, samples);
    calc_masking(c, samples);
    if (c->options.adpcm_mode)
        adpcm_analysis(c);
    find_peaks(c);
    assign_bits(c);
    calc_lfe_scales(c);
    shift_history(c, samples);
    init_put_bits(&c->pb, avpkt->data, avpkt->size);
    fill_in_adpcm_bufer(c);
    put_frame_header(c);
    put_primary_audio_header(c);
    for (i = 0; i < SUBFRAMES; i++)
        put_subframe(c, i);
    memset(put_bits_ptr(&c->pb), 0, put_bytes_left(&c->pb, 0));
    *got_packet_ptr = 1;
    return 0;
}
