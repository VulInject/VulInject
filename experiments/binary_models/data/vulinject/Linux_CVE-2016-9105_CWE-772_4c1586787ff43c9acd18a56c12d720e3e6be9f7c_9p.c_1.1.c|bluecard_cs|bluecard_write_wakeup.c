static void bluecard_write_wakeup(struct bluecard_info *info)
{
	if (!info) {
		BT_ERR("Unknown device");
		return;
	}
	if (!test_bit(XMIT_SENDING_READY, &(info->tx_state)))
		return;
	if (test_and_set_bit(XMIT_SENDING, &(info->tx_state))) {
		set_bit(XMIT_WAKEUP, &(info->tx_state));
		return;
	}
	do {
		unsigned int iobase = info->p_dev->resource[0]->start;
		unsigned int offset;
		unsigned char command;
		unsigned int ready_bit;
		register struct sk_buff *skb;
		int len;
		clear_bit(XMIT_WAKEUP, &(info->tx_state));
		if (!pcmcia_dev_present(info->p_dev))
			return;
		if (test_bit(XMIT_BUFFER_NUMBER, &(info->tx_state))) {
			if (!test_bit(XMIT_BUF_TWO_READY, &(info->tx_state)))
				break;
			offset = 0x10;
			command = REG_COMMAND_TX_BUF_TWO;
			ready_bit = XMIT_BUF_TWO_READY;
		} else {
			if (!test_bit(XMIT_BUF_ONE_READY, &(info->tx_state)))
				break;
			offset = 0x00;
			command = REG_COMMAND_TX_BUF_ONE;
			ready_bit = XMIT_BUF_ONE_READY;
		}
		skb = skb_dequeue(&(info->txq));
		if (!skb)
			break;
		if (hci_skb_pkt_type(skb) & 0x80) {
			info->ctrl_reg |= REG_CONTROL_RTS;
			outb(info->ctrl_reg, iobase + REG_CONTROL);
		}
		bluecard_enable_activity_led(info);
		len = bluecard_write(iobase, offset, skb->data, skb->len);
		outb_p(command, iobase + REG_COMMAND);
		clear_bit(ready_bit, &(info->tx_state));
		if (hci_skb_pkt_type(skb) & 0x80) {
			DECLARE_WAIT_QUEUE_HEAD_ONSTACK(wq);
			DEFINE_WAIT(wait);
			unsigned char baud_reg;
			switch (hci_skb_pkt_type(skb)) {
			case PKT_BAUD_RATE_460800:
				baud_reg = REG_CONTROL_BAUD_RATE_460800;
				break;
			case PKT_BAUD_RATE_230400:
				baud_reg = REG_CONTROL_BAUD_RATE_230400;
				break;
			case PKT_BAUD_RATE_115200:
				baud_reg = REG_CONTROL_BAUD_RATE_115200;
				break;
			case PKT_BAUD_RATE_57600:
			default:
				baud_reg = REG_CONTROL_BAUD_RATE_57600;
				break;
			}
			mdelay(100);
			info->ctrl_reg &= ~0x03;
			info->ctrl_reg |= baud_reg;
			outb(info->ctrl_reg, iobase + REG_CONTROL);
			info->ctrl_reg &= ~REG_CONTROL_RTS;
			outb(info->ctrl_reg, iobase + REG_CONTROL);
			mdelay(1000);
		}
		if (len == skb->len) {
			kfree_skb(skb);
		} else {
			skb_queue_head(&(info->txq), skb);
		}
		info->hdev->stat.byte_tx += len;
		change_bit(XMIT_BUFFER_NUMBER, &(info->tx_state));
	} while (test_bit(XMIT_WAKEUP, &(info->tx_state)));
	clear_bit(XMIT_SENDING, &(info->tx_state));
}
