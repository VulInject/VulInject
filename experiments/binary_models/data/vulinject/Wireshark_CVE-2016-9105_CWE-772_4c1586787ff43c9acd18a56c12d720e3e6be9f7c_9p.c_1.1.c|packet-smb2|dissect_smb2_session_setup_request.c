dissect_smb2_session_setup_request(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, smb2_info_t *si)
{
	offset_length_buffer_t  s_olb;
	const ntlmssp_header_t *ntlmssph;
	static int ntlmssp_tap_id = 0;
	smb2_saved_info_t *ssi = si->saved;
	proto_item *hash_item;
	int        idx;
	if (!ntlmssp_tap_id) {
		GString *error_string;
		error_string = register_tap_listener("ntlmssp", NULL, NULL,
		    TL_IS_DISSECTOR_HELPER, NULL, NULL, NULL, NULL);
		if (!error_string) {
			ntlmssp_tap_id = find_tap_id("ntlmssp");
		} else {
		}
	}
	if (!pinfo->fd->visited && ssi) {
		if (si->sesid == 0)
			memcpy(si->conv->preauth_hash_ses, si->conv->preauth_hash_con, SMB2_PREAUTH_HASH_SIZE);
		ssi->preauth_hash_req = (guint8*)wmem_alloc0(wmem_file_scope(), SMB2_PREAUTH_HASH_SIZE);
		update_preauth_hash(si->conv->preauth_hash_current, pinfo, tvb);
		memcpy(ssi->preauth_hash_req, si->conv->preauth_hash_current, SMB2_PREAUTH_HASH_SIZE);
	}
	if (ssi && ssi->preauth_hash_req) {
		hash_item = proto_tree_add_bytes_with_length(tree, hf_smb2_preauth_hash, tvb,
							     0, tvb_captured_length(tvb),
							     ssi->preauth_hash_req, SMB2_PREAUTH_HASH_SIZE);
		proto_item_set_generated(hash_item);
	}
	offset = dissect_smb2_buffercode(tree, tvb, offset, NULL);
	offset = dissect_smb2_ses_req_flags(tree, tvb, offset);
	offset = dissect_smb2_secmode(tree, tvb, offset);
	offset = dissect_smb2_capabilities(tree, tvb, offset);
	proto_tree_add_item(tree, hf_smb2_channel, tvb, offset, 4, ENC_LITTLE_ENDIAN);
	offset += 4;
	offset = dissect_smb2_olb_length_offset(tvb, offset, &s_olb, OLB_O_UINT16_S_UINT16, hf_smb2_security_blob);
	proto_tree_add_item(tree, hf_smb2_previous_sesid, tvb, offset, 8, ENC_LITTLE_ENDIAN);
	offset += 8;
	dissect_smb2_olb_buffer(pinfo, tree, tvb, &s_olb, si, dissect_smb2_secblob);
	offset = dissect_smb2_olb_tvb_max_offset(offset, &s_olb);
	if (!pinfo->fd->visited) {
		idx = 0;
		while ((ntlmssph = (const ntlmssp_header_t *)fetch_tapped_data(ntlmssp_tap_id, idx++)) != NULL) {
			if (ntlmssph && ntlmssph->type == NTLMSSP_AUTH) {
				si->session = smb2_get_session(si->conv, si->sesid, pinfo, si);
				si->session->acct_name = wmem_strdup(wmem_file_scope(), ntlmssph->acct_name);
				si->session->domain_name = wmem_strdup(wmem_file_scope(), ntlmssph->domain_name);
				si->session->host_name = wmem_strdup(wmem_file_scope(), ntlmssph->host_name);
				if (memcmp(si->session->session_key, zeros, SMB_SESSION_ID_SIZE) == 0) {
					memcpy(si->session->session_key, ntlmssph->session_key, NTLMSSP_KEY_LEN);
				}
				si->session->auth_frame = pinfo->num;
			}
		}
	}
	return offset;
}
