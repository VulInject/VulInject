R_API int r_str_scanf(const char *buffer, const char *format, ...) {
	R_RETURN_VAL_IF_FAIL (buffer && format, -1);
	int num_args_set = 0;
	const char *buf_ptr = buffer;
	const char *fmt_ptr = format;
	va_list args;
	int *long_ptr;
	int *int_ptr;
	short *short_ptr;
	ut64 *ut64_ptr;
	size_t *sizet_ptr;
	unsigned int *ulong_ptr;
	unsigned short *ushort_ptr;
	unsigned int *uint_ptr;
	double *double_ptr;
	float *float_ptr;
	char *char_ptr;
	wchar_t *wchar_ptr;
	char* end_ptr;
	int base;
	bool is_suppressed = false;
	size_t max_width = 0;
	char length_mod = '\0';
	va_start (args, format);
	while (*fmt_ptr) {
		R_LOG_DEBUG ("--> %c",*buf_ptr);
		if (isspace (*fmt_ptr)) {
			_BSCANF_CONSUME_WSPACE ();
			fmt_ptr++;
			R_LOG_DEBUG ("space consumed");
			continue;
		}
		if ('%' == *fmt_ptr) {
			fmt_ptr++;
			if (*fmt_ptr == 0) {
				R_LOG_ERROR ("End of format string, expected a character after %%");
				break;
			}
			R_LOG_DEBUG ("format consumed %c", *fmt_ptr);
			if ('*' == *fmt_ptr) {
				is_suppressed = true;
				fmt_ptr++;
				if (*fmt_ptr == 0) {
					R_LOG_ERROR ("End of format string, expected a character after %%");
					break;
				}
			} else {
				is_suppressed = false;
			}
			if (*fmt_ptr == '.') {
				max_width = va_arg (args, size_t) - 1;
				fmt_ptr++;
				if (*fmt_ptr == 0) {
					R_LOG_ERROR ("End of format string, expected a character after %%");
					break;
				}
			} else if (isdigit (*fmt_ptr)) {
				max_width = strtoul (fmt_ptr, &end_ptr, 0);
				_BSCANF_CHECK (fmt_ptr != end_ptr);
				_BSCANF_CHECK (max_width > 0);
				fmt_ptr = end_ptr;
			}
			if ('h' == *fmt_ptr || 'l' == *fmt_ptr || 'L' == *fmt_ptr) {
				length_mod = *fmt_ptr;
				fmt_ptr++;
				if (*fmt_ptr == 0) {
					R_LOG_ERROR ("End of format string, expected a character after %%");
					break;
				}
			} else {
				length_mod = '\0';
			}
			if ('n' == *fmt_ptr) {
				_BSCANF_CHECK (!is_suppressed);
				if ('l' == length_mod) {
					long_ptr = va_arg (args, int*);
					*long_ptr = (int) (buf_ptr - buffer);
				} else if ('h' == length_mod) {
					short_ptr = va_arg (args, short*);
					_BSCANF_CHECK_NULL (short_ptr);
					*short_ptr = (short) (buf_ptr - buffer);
				} else {
					int_ptr = va_arg (args, int*);
					_BSCANF_CHECK_NULL (int_ptr);
					*int_ptr = (int) (buf_ptr - buffer);
				}
				fmt_ptr++;
				num_args_set++;
				continue;
			}
			_BSCANF_CHECK_BUFFER ();
			if ('%' == *fmt_ptr) {
				_BSCANF_CONSUME_WSPACE ();
				_BSCANF_MATCH ();
				buf_ptr++;
			} else if ('c' == *fmt_ptr) {
				if (is_suppressed) {
					_BSCANF_CONSUME_WSPACE ();
					buf_ptr++;
					fmt_ptr++;
				} else if ('l' == length_mod) {
					wchar_ptr = va_arg (args, wchar_t*);
					wchar_t *wbuf_ptr = (wchar_t *) buf_ptr;
					*wchar_ptr = *wbuf_ptr;
					buf_ptr = (char *) (wbuf_ptr + 1);
					fmt_ptr++;
				} else {
					_BSCANF_CONSUME_WSPACE ();
					char_ptr = va_arg (args, char*);
					*char_ptr = *buf_ptr;
					buf_ptr++;
					fmt_ptr++;
				}
				if (*fmt_ptr == 0) {
					R_LOG_ERROR ("End of format string, expected a character after %%");
					break;
				}
				num_args_set++;
			} else if ('s' == *fmt_ptr) {
				if (is_suppressed) {
					while (true) {
						buf_ptr++;
						if (*buf_ptr == '\0') {
							break;
						}
						if ((isspace (*buf_ptr) && 's' == *fmt_ptr)) {
							buf_ptr++;
							break;
						}
					}
					fmt_ptr++;
					continue;
				} else if ('l' == length_mod) {
					wchar_ptr = va_arg (args, wchar_t*);
					wchar_t *wbuf_ptr = (wchar_t *) buf_ptr;
					_BSCANF_CHECK_NULL (wchar_ptr);
					*wchar_ptr = 0; 
					if (max_width < 1) {
						R_LOG_DEBUG ("Missing length specifier for string");
					} else {
						for (; max_width > 0; max_width--) {
							*wchar_ptr = *wbuf_ptr;
							if (*wbuf_ptr == '\0' || (isspace (*wbuf_ptr) && 's' == *fmt_ptr)) {
								break;
							}
							wchar_ptr++;
							wbuf_ptr++;
						}
						if ('s' == *fmt_ptr) {
							if (max_width == 0) {
								R_LOG_DEBUG ("Truncated string in scanf");
								while (*wbuf_ptr) {
									if (isspace (*wbuf_ptr)) {
										break;
									}
									wbuf_ptr++;
								}
							}
							*wchar_ptr = '\0';
						}
						buf_ptr = (char *)wbuf_ptr;
						num_args_set++;
					}
					max_width = 0;
				} else {
					char_ptr = va_arg (args, char*);
					_BSCANF_CHECK_NULL (char_ptr);
					*char_ptr = 0; 
					if (max_width < 1) {
						R_LOG_DEBUG ("Missing length specifier for string");
					} else {
						for (; max_width > 0; max_width--) {
							*char_ptr = *buf_ptr;
							if (*buf_ptr == '\0' || (isspace (*buf_ptr) && 's' == *fmt_ptr)) {
								break;
							}
							char_ptr++;
							buf_ptr++;
						}
						if ('s' == *fmt_ptr) {
							if (max_width == 0) {
								R_LOG_DEBUG ("Truncated string in scanf");
								while (*buf_ptr) {
									if (isspace (*buf_ptr)) {
										break;
									}
									buf_ptr++;
								}
							}
							*char_ptr = '\0';
						}
						num_args_set++;
					}
					max_width = 0;
				}
			} else if ('[' == *fmt_ptr) {
				char scanset[32] = {0};
				fmt_ptr = scanset_parse (fmt_ptr, scanset, sizeof (scanset));
				if (!fmt_ptr) {
					goto beach;
				}
				_BSCANF_CHECK_STRING ();
				char_ptr = va_arg (args, char*);
				_BSCANF_CHECK_NULL (char_ptr);
				*char_ptr = 0; 
				if (max_width < 1) {
					R_LOG_DEBUG ("Missing length specifier for string");
				} else {
					for (; *buf_ptr && max_width > 0; max_width--) {
						if (!scanset_check (scanset, *buf_ptr)) {
							break;
						}
						*char_ptr = *buf_ptr;
						char_ptr++;
						buf_ptr++;
					}
					if (max_width == 0) {
						R_LOG_DEBUG ("Truncated string in scanf");
					}
					*char_ptr = '\0';
					num_args_set++;
				}
				max_width = 0;
				if (*fmt_ptr == 0) {
					break;
				}
			} else if ('i' == *fmt_ptr || 'd' == *fmt_ptr) {
				_BSCANF_CONSUME_WSPACE ();
				base = ('d' == *fmt_ptr) * 10;
				if (is_suppressed) {
					strtol (buf_ptr, &end_ptr, base);
				} else if ('l' == length_mod) {
					long_ptr = va_arg (args, int*);
					_BSCANF_CHECK_NULL (long_ptr);
					int longnum = (int) strtol (buf_ptr, &end_ptr, base);
					memcpy (long_ptr, &longnum, sizeof (longnum));
				} else if ('L' == length_mod) {
					ut64_ptr = va_arg (args, ut64*);
					_BSCANF_CHECK_NULL (ut64_ptr);
					*ut64_ptr = (ut64) strtoll (buf_ptr, &end_ptr, base);
				} else if ('h' == length_mod) {
					short_ptr = va_arg (args, short*);
					_BSCANF_CHECK_NULL (short_ptr);
					*short_ptr = (short) (strtol (buf_ptr, &end_ptr, base));
				} else {
					int_ptr = va_arg (args, int*);
					_BSCANF_CHECK_NULL (int_ptr);
					*int_ptr = (int) (strtol (buf_ptr, &end_ptr, base));
				}
				_BSCANF_CHECK_STRTONUM ();
				buf_ptr = end_ptr;
				num_args_set++;
			} else if ('g' == *fmt_ptr || 'e' == *fmt_ptr || 'f' == *fmt_ptr ||
					'G' == *fmt_ptr || 'E' == *fmt_ptr || 'F' == *fmt_ptr) {
				_BSCANF_CONSUME_WSPACE ();
				if (is_suppressed) {
					strtod(buf_ptr, &end_ptr);
				} else if ('l' == length_mod) {
					double_ptr = va_arg (args, double*);
					_BSCANF_CHECK_NULL (double_ptr);
					*double_ptr = (double) (strtod(buf_ptr, &end_ptr));
				} else {
					float_ptr = va_arg (args, float*);
					_BSCANF_CHECK_NULL (float_ptr);
					*float_ptr = (float) (strtod(buf_ptr, &end_ptr));
				}
				_BSCANF_CHECK_STRTONUM ();
				buf_ptr = end_ptr;
				num_args_set++;
			} else if ('p' == *fmt_ptr) {
				_BSCANF_CONSUME_WSPACE ();
				base = 16;
				if (is_suppressed) {
					strtoul (buf_ptr, &end_ptr, base);
				} else {
					sizet_ptr = va_arg (args, size_t*);
					_BSCANF_CHECK_NULL (sizet_ptr);
					*sizet_ptr = (size_t) strtoull (buf_ptr, &end_ptr, base);
				}
				_BSCANF_CHECK_STRTONUM ();
				buf_ptr = end_ptr;
				num_args_set++;
			} else if ('u' == *fmt_ptr || 'o' == *fmt_ptr || 'x' == *fmt_ptr || 'X' == *fmt_ptr) {
				_BSCANF_CONSUME_WSPACE ();
				base = ('u' == *fmt_ptr) * 10 + ('o' == *fmt_ptr) * 8 +
					('x' == *fmt_ptr || 'X' == *fmt_ptr) * 16;
				if (is_suppressed) {
					strtoul (buf_ptr, &end_ptr, base);
				} else if ('l' == length_mod) {
					ulong_ptr = va_arg (args, unsigned int*);
					_BSCANF_CHECK_NULL (ulong_ptr);
					*ulong_ptr = (unsigned int) strtoul (buf_ptr, &end_ptr, base);
				} else if ('L' == length_mod) {
					ut64_ptr = va_arg (args, ut64*);
					_BSCANF_CHECK_NULL (ut64_ptr);
					*ut64_ptr = (ut64) strtoull (buf_ptr, &end_ptr, base);
				} else if ('h' == length_mod) {
					ushort_ptr = va_arg (args, unsigned short*);
					_BSCANF_CHECK_NULL (ushort_ptr);
					*ushort_ptr = (unsigned short) (strtoul (buf_ptr, &end_ptr, base));
				} else {
					uint_ptr = va_arg (args, unsigned int*);
					_BSCANF_CHECK_NULL (uint_ptr);
					*uint_ptr = (unsigned int) (strtoul (buf_ptr, &end_ptr, base));
				}
				_BSCANF_CHECK_STRTONUM ();
				buf_ptr = end_ptr;
				num_args_set++;
			} else {
				_BSCANF_CHECK (0);
			}
		} else {
			_BSCANF_MATCH ();
			buf_ptr++;
		}
		fmt_ptr++;
	}
beach:
	va_end (args);
	return num_args_set;
}
