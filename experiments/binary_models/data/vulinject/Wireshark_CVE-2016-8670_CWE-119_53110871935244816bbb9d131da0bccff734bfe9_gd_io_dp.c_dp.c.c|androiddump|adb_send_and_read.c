static char *adb_send_and_read(socket_handle_t sock, const char *adb_service, char *buffer,
        int buffer_length, ssize_t *data_length) {
    ssize_t   used_buffer_length;
    ssize_t   result;
    char      status[4];
    size_t    adb_service_length;
    adb_service_length = strlen(adb_service);
    snprintf(buffer, buffer_length, ADB_HEX4_FORMAT, adb_service_length);
    result = send(sock, buffer, ADB_HEX4_LEN, 0);
    if (result < ADB_HEX4_LEN) {
        ws_warning("Error while sending <%s> to ADB daemon", adb_service);
        return NULL;
    }
    result = send(sock, adb_service, (int) adb_service_length, 0);
    if (result != (ssize_t) adb_service_length) {
        ws_warning("Error while sending <%s> to ADB", adb_service);
        if (data_length)
            *data_length = 0;
        return NULL;
    }
    used_buffer_length = 0;
    while (used_buffer_length < 4) {
        result = recv(sock, buffer + used_buffer_length,  (int)(buffer_length - used_buffer_length), 0);
		if(result == 0) {
            ws_warning("Broken socket connection while fetching reply status for <%s>", adb_service);
            return NULL;
        }
        used_buffer_length += result;
    }
    memcpy(status, buffer, 4);
    while (result > 0) {
        result= recv(sock, buffer + used_buffer_length,  (int)(buffer_length - used_buffer_length), 0);
        if (result < 0) {
            ws_warning("Broken socket connection while reading reply for <%s>", adb_service);
            return NULL;
        } else if (result == 0) {
            break;
        }
        used_buffer_length += result;
    }
    if (data_length)
        *data_length = used_buffer_length - 4;
    if (memcmp(status, "OKAY", 4)) {
        ws_warning("Error while receiving by ADB for <%s>", adb_service);
        if (data_length)
            *data_length = 0;
        return NULL;
    }
    return buffer + 4;
}
