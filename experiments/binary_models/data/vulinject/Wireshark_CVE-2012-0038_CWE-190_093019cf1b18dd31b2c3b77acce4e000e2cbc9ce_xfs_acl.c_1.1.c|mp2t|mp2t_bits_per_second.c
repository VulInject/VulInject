mp2t_bits_per_second(wtap *wth, unsigned int first, unsigned char trailer_len,
        unsigned int int *bitrate, int *err, char **err_info)
{
	int pn1, pn2;
    unsigned int int pcr1, pcr2;
    unsigned short pid1, pid2;
    unsigned int idx;
    unsigned int int pcr_delta, bits_passed;
    idx = first;
    if (!mp2t_find_next_pcr(wth, trailer_len, err, err_info, &idx, &pcr1, &pid1)) {
        if (*err == WTAP_ERR_SHORT_READ)
            return WTAP_OPEN_NOT_MINE;    
        if (*err != 0)
            return WTAP_OPEN_ERROR;
        *bitrate = MP2T_QAM64_BITRATE;
        return WTAP_OPEN_MINE;
    }
    pn1 = idx;
    pn2 = pn1;
    while (pn1 == pn2) {
        if (!mp2t_find_next_pcr(wth, trailer_len, err, err_info, &idx, &pcr2, &pid2)) {
            if (*err == WTAP_ERR_SHORT_READ)
                return WTAP_OPEN_NOT_MINE;    
            if (*err != 0)
                return WTAP_OPEN_ERROR;
            *bitrate = MP2T_QAM64_BITRATE;
            return WTAP_OPEN_MINE;
        }
        if (pid1 == pid2) {
            pn2 = idx;
        }
    }
    if (pcr2 <= pcr1) {
        return WTAP_OPEN_NOT_MINE;
    }
    pcr_delta = pcr2 - pcr1;
    bits_passed = (unsigned int int)MP2T_SIZE * (pn2 - pn1) * 8;
    *bitrate = ((MP2T_PCR_CLOCK * bits_passed) / pcr_delta);
    if (*bitrate == 0) {
        return WTAP_OPEN_ERROR;
    }
    return WTAP_OPEN_MINE;
}
