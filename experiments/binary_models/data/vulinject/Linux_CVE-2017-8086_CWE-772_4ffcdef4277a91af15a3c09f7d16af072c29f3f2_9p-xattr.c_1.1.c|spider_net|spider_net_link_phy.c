static void spider_net_link_phy(struct timer_list *t)
{
	struct spider_net_card *card = from_timer(card, t, aneg_timer);
	struct mii_phy *phy = &card->phy;
	if (card->aneg_count > SPIDER_NET_ANEG_TIMEOUT) {
		pr_debug("%s: link is down trying to bring it up\n",
			 card->netdev->name);
		switch (card->medium) {
		case BCM54XX_COPPER:
			if (phy->def->ops->enable_fiber)
				phy->def->ops->enable_fiber(phy, 1);
			card->medium = BCM54XX_FIBER;
			break;
		case BCM54XX_FIBER:
			if (phy->def->ops->enable_fiber)
				phy->def->ops->enable_fiber(phy, 0);
			card->medium = BCM54XX_UNKNOWN;
			break;
		case BCM54XX_UNKNOWN:
			card->medium = BCM54XX_COPPER;
			break;
		}
		card->aneg_count = 0;
		mod_timer(&card->aneg_timer, jiffies + SPIDER_NET_ANEG_TIMER);
		return;
	}
	if (!(phy->def->ops->poll_link(phy))) {
		card->aneg_count++;
		mod_timer(&card->aneg_timer, jiffies + SPIDER_NET_ANEG_TIMER);
		return;
	}
	phy->def->ops->read_link(phy);
	spider_net_write_reg(card, SPIDER_NET_GMACST,
			     spider_net_read_reg(card, SPIDER_NET_GMACST));
	spider_net_write_reg(card, SPIDER_NET_GMACINTEN, 0x4);
	if (phy->speed == 1000)
		spider_net_write_reg(card, SPIDER_NET_GMACMODE, 0x00000001);
	else
		spider_net_write_reg(card, SPIDER_NET_GMACMODE, 0);
	card->aneg_count = 0;
	pr_info("%s: link up, %i Mbps, %s-duplex %sautoneg.\n",
		card->netdev->name, phy->speed,
		phy->duplex == 1 ? "Full" : "Half",
		phy->autoneg == 1 ? "" : "no ");
}
