int br_handle_egress_vlan_tunnel(struct sk_buff *skb,
				 struct net_bridge_vlan *vlan)
{
	IP_TUNNEL_DECLARE_FLAGS(flags) = { };
	struct metadata_dst *tunnel_dst;
	__be64 tunnel_id;
	tunnel_id = READ_ONCE(vlan->tinfo.tunnel_id);
	if (!tunnel_id || unlikely(!skb_vlan_tag_present(skb)))
		return 0;
	skb_dst_drop(skb);
	err = skb_vlan_pop(skb);
	if (err)
		return err;
	if (BR_INPUT_SKB_CB(skb)->backup_nhid) {
		__set_bit(IP_TUNNEL_KEY_BIT, flags);
		tunnel_dst = __ip_tun_set_dst(0, 0, 0, 0, 0, flags,
					      tunnel_id, 0);
		if (!tunnel_dst)
			return -ENOMEM;
		tunnel_dst->u.tun_info.mode |= IP_TUNNEL_INFO_TX |
					       IP_TUNNEL_INFO_BRIDGE;
		tunnel_dst->u.tun_info.key.nhid =
			BR_INPUT_SKB_CB(skb)->backup_nhid;
		skb_dst_set(skb, &tunnel_dst->dst);
		return 0;
	}
	tunnel_dst = rcu_dereference(vlan->tinfo.tunnel_dst);
	if (tunnel_dst && dst_hold_safe(&tunnel_dst->dst))
		skb_dst_set(skb, &tunnel_dst->dst);
	return 0;
}
