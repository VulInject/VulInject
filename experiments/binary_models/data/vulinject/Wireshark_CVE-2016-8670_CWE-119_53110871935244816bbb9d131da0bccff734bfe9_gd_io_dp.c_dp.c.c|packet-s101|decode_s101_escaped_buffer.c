decode_s101_escaped_buffer(tvbuff_t *tvb, packet_info *pinfo, int *offset, guint16 *crc) {
    tvbuff_t *next_tvb;
    int len;
    int i;
    guchar *decoded_buffer;
    guint8 b;
    len = tvb_captured_length(tvb);
		if(len == 0) {
        return tvb;
    }
    decoded_buffer = (guchar*)wmem_alloc(pinfo->pool, len);
    if (decoded_buffer == NULL) {
        return tvb;
    }
    for(i = 0; *offset < len; ) {
        b = tvb_get_guint8(tvb, *offset);
        *offset = *offset + 1;
        if (b == S101_CE) {
            b = tvb_get_guint8(tvb, *offset);
            *offset = *offset + 1;
            b = (b ^ S101_XOR);
            decoded_buffer[i++] = b;
        }
        else {
            decoded_buffer[i] = b;
            if (b == S101_EOF) { 
                if (i > 2) {
                    i -= 2;
                }
                break;
            }
            i++;
        }
        *crc = crc16_ccitt_seed(&b, 1, *crc) ^ 0xFFFF;
    }
    next_tvb = tvb_new_child_real_data(tvb, decoded_buffer, i, i);
    add_new_data_source(pinfo, next_tvb, "Decoded Data");
    return next_tvb;
}
