decode_command(tvbuff_t *tvb, packet_info* pinfo, int msglen, int offset, int dst, proto_tree *pt)
{
    guint32         cmd;
    guint32         context, ioctl_command;
    proto_tree      *ft;
    proto_item      *hi;
    gryphon_pkt_info_t *pkt_info;
    hi = proto_tree_add_item_ret_uint(pt, hf_gryphon_cmd, tvb, offset, 1, ENC_BIG_ENDIAN, &cmd);
    if (cmd > 0x3F)
        cmd += dst * 256;
    pkt_info = (gryphon_pkt_info_t*)p_get_proto_data(wmem_file_scope(), pinfo, proto_gryphon, (guint32)tvb_raw_offset(tvb));
    if (!pkt_info) {
        gryphon_conversation *conv_data = get_conversation_data(pinfo);
        pkt_info = wmem_new0(wmem_file_scope(), gryphon_pkt_info_t);
        pkt_info->cmd = cmd;
        pkt_info->req_frame_num = pinfo->num;
        pkt_info->req_time = pinfo->abs_ts;
        wmem_list_prepend(conv_data->request_frame_data, pkt_info);
        p_add_proto_data(wmem_file_scope(), pinfo, proto_gryphon, (guint32)tvb_raw_offset(tvb), pkt_info);
    }
    proto_tree_add_uint(pt, hf_gryphon_command, tvb, offset, 1, cmd);
    proto_tree_add_item_ret_uint(pt, hf_gryphon_cmd_context, tvb, offset + 1, 1, ENC_NA, &context);
    if (!pinfo->fd->visited) {
        pkt_info->cmd_context = context;
    }
    proto_tree_add_item(pt, hf_gryphon_reserved, tvb, offset + 2, 2, ENC_NA);
    if (pkt_info->rsp_frame_num > 0) {
        proto_item* it = proto_tree_add_uint(pt, hf_gryphon_response_in,
            tvb, 0, 0, pkt_info->rsp_frame_num);
        proto_item_set_generated(it);
    }
    offset += 4;
    msglen -= 4;
    if (msglen > 0)
    {
        ft = proto_tree_add_subtree_format(pt, tvb, offset, msglen, ett_gryphon_command_data, NULL,
            "Data: (%d byte%s)", msglen, plurality(msglen, "", "s"));
        increment_dissection_depth(pinfo);
        switch (cmd)
        {
        case CMD_INIT:
            offset = cmd_init(tvb, offset, ft);
            break;
        case CMD_EVENT_ENABLE:
        case CMD_EVENT_DISABLE:
            offset = eventnum(tvb, offset, ft);
            break;
        case CMD_SET_TIME:
            offset = resp_time(tvb, offset, ft);
            break;
        case CMD_CARD_SET_SPEED:
            offset = speed(tvb, offset, ft);
            break;
        case CMD_CARD_SET_FILTER:
            offset = cmd_setfilt(tvb, offset, ft);
            break;
        case CMD_CARD_GET_FILTER:
            offset = resp_addfilt(tvb, offset, ft);
            break;
        case CMD_CARD_TX:
            offset = decode_data(tvb, offset, ft);
            break;
        case CMD_CARD_ADD_FILTER:
            offset = cmd_addfilt(tvb, offset, ft);
            break;
        case CMD_CARD_MODIFY_FILTER:
            offset = cmd_modfilt(tvb, offset, ft);
            break;
        case CMD_CARD_SET_DEFAULT_FILTER:
            offset = dfiltmode(tvb, offset, ft);
            break;
        case CMD_CARD_SET_FILTER_MODE:
            offset = filtmode(tvb, offset, ft);
            break;
        case CMD_SERVER_REG:
            offset = cmd_register(tvb, offset, ft);
            break;
        case CMD_SERVER_SET_SORT:
            offset = cmd_sort(tvb, offset, ft);
            break;
        case CMD_SERVER_SET_OPT:
            offset = cmd_optimize(tvb, offset, ft);
            break;
        case CMD_BLM_SET_MODE:
            offset = blm_mode(tvb, offset, ft);
            break;
        case CMD_LDF_LIST:
            offset = cmd_ldf_list(tvb, offset, ft);
            break;
        case CMD_LDF_DELETE:
            offset = cmd_ldf_delete(tvb, offset, ft);
            break;
        case CMD_LDF_DESC:
            offset = cmd_ldf_desc(tvb, offset, ft);
            break;
        case CMD_LDF_UPLOAD:
            offset = cmd_ldf_upload(tvb, offset, ft);
            break;
        case CMD_LDF_PARSE:
            offset = cmd_ldf_parse(tvb, offset, ft);
            break;
        case CMD_GET_NODE_SIGNALS:
            offset = cmd_ldf_get_node_signals(tvb, offset, ft);
            break;
        case CMD_GET_FRAMES:
            offset = cmd_ldf_get_frames(tvb, offset, ft);
            break;
        case CMD_GET_FRAME_INFO:
            offset = cmd_ldf_get_frame_info(tvb, pinfo, offset, ft);
            break;
        case CMD_GET_SIGNAL_INFO:
            offset = cmd_ldf_get_signal_info(tvb, offset, ft);
            break;
        case CMD_GET_SIGNAL_DETAIL:
            offset = cmd_ldf_get_signal_detail(tvb, offset, ft);
            break;
        case CMD_GET_ENCODING_INFO:
            offset = cmd_ldf_get_encoding_info(tvb, offset, ft);
            break;
        case CMD_SAVE_SESSION:
            offset = cmd_ldf_save_session(tvb, offset, ft);
            break;
        case CMD_EMULATE_NODES:
            offset = cmd_ldf_emulate_nodes(tvb, pinfo, offset, ft);
            break;
        case CMD_START_SCHEDULE:
            offset = cmd_ldf_start_schedule(tvb, offset, ft);
            break;
        case CMD_RESTORE_SESSION:
            offset = cmd_restore_session(tvb, offset, ft);
            break;
        case CMD_CNVT_GET_VALUES:
            offset = cmd_cnvt_get_values(tvb, offset, ft);
            break;
        case CMD_CNVT_GET_UNITS:
            offset = cmd_cnvt_get_units(tvb, offset, ft);
            break;
        case CMD_CNVT_SET_VALUES:
            offset = cmd_cnvt_set_values(tvb, offset, ft);
            break;
        case CMD_CNVT_SAVE_SESSION:
            offset = cmd_ldf_save_session(tvb, offset, ft);
            break;
        case CMD_CNVT_RESTORE_SESSION:
            offset = cmd_restore_session(tvb, offset, ft);
            break;
        case CMD_CNVT_DESTROY_SESSION:
            offset = cmd_cnvt_destroy_session(tvb, offset, ft);
            break;
        case CMD_CNVT_GET_NODE_SIGNALS:
            offset = cmd_ldf_get_node_signals(tvb, offset, ft);
            break;
        case CMD_MSGRESP_ADD:
            offset = cmd_addresp(tvb, offset, pinfo, ft);
            break;
        case CMD_MSGRESP_GET:
            offset = resp_addresp(tvb, offset, ft);
            break;
        case CMD_MSGRESP_MODIFY:
            offset = cmd_modresp(tvb, offset, ft);
            break;
        case CMD_PGM_DESC:
            offset = cmd_desc(tvb, offset, ft);
            break;
        case CMD_PGM_UPLOAD:
            offset = cmd_upload(tvb, offset, ft);
            break;
        case CMD_PGM_DELETE:
            offset = cmd_delete(tvb, offset, ft);
            break;
        case CMD_PGM_LIST:
            offset = cmd_list(tvb, offset, ft);
            break;
        case CMD_PGM_START:
            offset = cmd_start(tvb, pinfo, offset, ft);
            break;
        case CMD_PGM_STOP:
            offset = resp_start(tvb, offset, ft);
            break;
        case CMD_PGM_STATUS:
            offset = cmd_delete(tvb, offset, ft);
            break;
        case CMD_PGM_OPTIONS:
            offset = cmd_options(tvb, offset, ft);
            break;
        case CMD_PGM_FILES:
            offset = cmd_files(tvb, offset, ft);
            break;
        case CMD_SCHED_TX:
            offset = cmd_sched(tvb, offset, ft);
            break;
        case CMD_SCHED_KILL_TX:
            offset = resp_sched(tvb, offset, ft);
            break;
        case CMD_SCHED_MSG_REPLACE:
            offset = cmd_sched_rep(tvb, offset, ft);
            break;
        case CMD_USDT_REGISTER:
            offset = cmd_usdt(tvb, offset, ft);
            break;
        case CMD_USDT_SET_FUNCTIONAL:
            offset = cmd_usdt(tvb, offset, ft);
            break;
        case CMD_USDT_SET_STMIN_MULT:
            offset = cmd_usdt_set_stmin_mul(tvb, offset, ft);
            break;
        case CMD_USDT_REGISTER_NON_LEGACY:
            offset = cmd_usdt_register_non_legacy(tvb, offset, ft);
            break;
        case CMD_USDT_SET_STMIN_FC:
            offset = cmd_usdt_stmin_fc(tvb, offset, ft);
            break;
        case CMD_USDT_SET_BSMAX_FC:
            offset = cmd_usdt_bsmax_fc(tvb, offset, ft);
            break;
        case CMD_USDT_SET_STMIN_OVERRIDE:
            offset = cmd_usdt_stmin_override(tvb, offset, ft);
            break;
        case CMD_USDT_ACTIVATE_STMIN_OVERRIDE:
            offset = cmd_usdt_stmin_override_activate(tvb, offset, ft);
            break;
        case CMD_IOPWR_CLRLATCH:
            offset = cmd_bits_in(tvb, offset, ft);
            break;
        case CMD_IOPWR_SETOUT:
        case CMD_IOPWR_SETBIT:
        case CMD_IOPWR_CLRBIT:
            offset = cmd_bits_out(tvb, offset, ft);
            break;
        case CMD_UTIL_SET_INIT_STRATEGY:
            offset = cmd_init_strat(tvb, offset, ft);
            break;
        case CMD_CARD_IOCTL:
            ioctl_command = tvb_get_ntohl(tvb, offset);
            if (!pinfo->fd->visited) {
                pkt_info->ioctl_command = ioctl_command;
            }
            offset = cmd_ioctl(tvb, pinfo, offset, ft, ioctl_command);
            break;
        default:
            proto_tree_add_item(ft, hf_gryphon_data, tvb, offset, msglen, ENC_NA);
            offset += msglen;
            break;
        }
        decrement_dissection_depth(pinfo);
    }
    return offset;
}
