static int drbd_disconnected(struct drbd_peer_device *peer_device)
{
	struct drbd_device *device = peer_device->device;
	unsigned int i;
	spin_lock_irq(&device->resource->req_lock);
	_drbd_wait_ee_list_empty(device, &device->active_ee);
	_drbd_wait_ee_list_empty(device, &device->sync_ee);
	_drbd_wait_ee_list_empty(device, &device->read_ee);
	spin_unlock_irq(&device->resource->req_lock);
	drbd_rs_cancel_all(device);
	device->rs_total = 0;
	device->rs_failed = 0;
	wake_up(&device->misc_wait);
	del_timer_sync(&device->resync_timer);
	resync_timer_fn(&device->resync_timer);
	drbd_flush_workqueue(&peer_device->connection->sender_work);
	drbd_finish_peer_reqs(device);
	drbd_flush_workqueue(&peer_device->connection->sender_work);
	drbd_rs_cancel_all(device);
	kfree(device->p_uuid);
	device->p_uuid = NULL;
	if (!drbd_suspended(device))
		tl_clear(peer_device->connection);
	drbd_md_sync(device);
	if (get_ldev(device)) {
		drbd_bitmap_io(device, &drbd_bm_write_copy_pages,
				"write from disconnected", BM_LOCKED_CHANGE_ALLOWED, NULL);
		put_ldev(device);
	}
	i = drbd_free_peer_reqs(device, &device->net_ee);
	if (i)
		drbd_info(device, "net_ee not empty, killed %u entries\n", i);
	i = atomic_read(&device->pp_in_use_by_net);
	if (i)
		drbd_info(device, "pp_in_use_by_net = %d, expected 0\n", i);
	i = atomic_read(&device->pp_in_use);
	if (i)
		drbd_info(device, "pp_in_use = %d, expected 0\n", i);
	D_ASSERT(device, list_empty(&device->read_ee));
	D_ASSERT(device, list_empty(&device->active_ee));
	D_ASSERT(device, list_empty(&device->sync_ee));
	D_ASSERT(device, list_empty(&device->done_ee));
	return 0;
}
