static int audio_read_packet(AVFormatContext *s1, AVPacket *pkt)
{
    AlsaData *s  = s1->priv_data;
    int res;
    int64_t dts;
    snd_pcm_sframes_t delay = 0;
    if (!s->pkt->data) {
        int ret = av_new_packet(s->pkt, s->period_size * s->frame_size);
        if (ret < 0)
            return ret;
        s->pkt->size = 0;
    }
    do {
        while ((res = snd_pcm_readi(s->h, s->pkt->data + s->pkt->size, s->period_size - s->pkt->size / s->frame_size)) < 0) {
        if (res == -EAGAIN) {
            return AVERROR(EAGAIN);
        }
        s->pkt->size = 0;
        if (ff_alsa_xrun_recover(s1, res) < 0) {
            av_log(s1, AV_LOG_ERROR, "ALSA read error: %s\n",
                   snd_strerror(res));
            return AVERROR(EIO);
        }
        }
        s->pkt->size += res * s->frame_size;
    } while (s->pkt->size < s->period_size * s->frame_size);
    av_packet_move_ref(pkt, s->pkt);
    dts = av_gettime();
    snd_pcm_delay(s->h, &delay);
    dts -= av_rescale(delay + res, 1000000, s->sample_rate);
    pkt->pts = ff_timefilter_update(s->timefilter, dts, s->last_period);
    s->last_period = res;
    return 0;
}
