static int uwire_txrx(struct spi_device *spi, struct spi_transfer *t)
{
	unsigned	len = t->len;
	unsigned	bits = t->bits_per_word;
	unsigned	bytes;
	unsigned short		val, w;
	int		status = 0;
	if (!t->tx_buf && !t->rx_buf)
		return 0;
	w = spi_get_chipselect(spi, 0) << 10;
	w |= CS_CMD;
	if (t->tx_buf) {
		const unsigned char	*buf = t->tx_buf;
		while (len >= 1) {
			val = *buf++;
			if (bits > 8) {
				bytes = 2;
				val |= *buf++ << 8;
			} else
				bytes = 1;
			val <<= 16 - bits;
#ifdef	VERBOSE
			pr_debug("%s: write-%d =%04x\n",
					dev_name(&spi->dev), bits, val);
#endif
			if (wait_uwire_csr_flag(CSRB, 0, 0))
				goto eio;
			val = START | w | (bits << 5);
			uwire_write_reg(UWIRE_CSR, val);
			len -= bytes;
			if (wait_uwire_csr_flag(CSRB, CSRB, 1))
				goto eio;
			status += bytes;
		}
		if (wait_uwire_csr_flag(CSRB, 0, 0))
			goto eio;
	} else if (t->rx_buf) {
		unsigned char		*buf = t->rx_buf;
		while (len) {
			if (bits > 8) {
				bytes = 2;
			} else
				bytes = 1;
			val = START | w | (bits << 0);
			uwire_write_reg(UWIRE_CSR, val);
			len -= bytes;
			(void) wait_uwire_csr_flag(CSRB, CSRB, 1);
			if (wait_uwire_csr_flag(RDRB | CSRB,
						RDRB, 0))
				goto eio;
			val = uwire_read_reg(UWIRE_RDR);
			val &= (1 << bits) - 1;
			*buf++ = (unsigned char) val;
			if (bytes == 2)
				*buf++ = val >> 8;
			status += bytes;
#ifdef	VERBOSE
			pr_debug("%s: read-%d =%04x\n",
					dev_name(&spi->dev), bits, val);
#endif
		}
	}
	return status;
eio:
	return -EIO;
}
