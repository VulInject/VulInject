static __always_inline unsigned int trylock_clean_tail(struct qspinlock *lock, unsigned int tail)
{
	unsigned int newval = queued_spin_encode_locked_val();
	int prev, tmp;
	asm volatile(
"1:	lwarx	%0,0,%2,%7	# trylock_clean_tail			\n"
"	andi.	%1,%0,%5						\n"
"	bne	3f							\n"
"	and	%1,%0,%6						\n"
"	cmpw	0,%1,%3							\n"
"	or	%1,%1,%4						\n"
"	bne	2f							\n"
"	andc	%1,%1,%6						\n"
"2:	stwcx.	%1,0,%2							\n"
"	bne-	1b							\n"
"\t"	PPC_ACQUIRE_BARRIER "						\n"
"3:									\n"
	: "=&r" (prev), "=&r" (tmp)
	: "r" (&lock->val), "r"(tail), "r" (newval),
	  "i" (_Q_LOCKED_VAL),
	  "r" (_Q_TAIL_CPU_MASK),
	  "i" (_Q_SPIN_EH_HINT)
	: "cr0", "memory");
	return prev;
}
