did_set_undofile(optset_T *args)
{
    if (!curbuf->b_p_udf && !p_udf)
	return NULL;
    char_u	hash[UNDO_HASH_SIZE];
    buf_T	*save_curbuf = curbuf;
    FOR_ALL_BUFFERS(curbuf)
    {
	if ((curbuf == save_curbuf
		    || (args->os_flags & OPT_GLOBAL)
		    || args->os_flags == 0)
		&& !curbufIsChanged() && curbuf->b_ml.ml_mfp != NULL)
	{
#ifdef FEAT_CRYPT
	    if (crypt_method_is_sodium(crypt_get_method_nr(curbuf)))
		continue;
#endif
	    u_read_undo(NULL, hash, curbuf->b_fname);
	}
    }
    curbuf = save_curbuf;
    return NULL;
}
