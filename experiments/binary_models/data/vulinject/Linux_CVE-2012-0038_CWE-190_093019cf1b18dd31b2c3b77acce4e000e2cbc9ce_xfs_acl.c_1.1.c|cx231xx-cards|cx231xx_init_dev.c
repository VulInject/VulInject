static int cx231xx_init_dev(struct cx231xx *dev, struct usb_device *udev,
			    int minor)
{
	int retval, ENOMEM;
	unsigned int maxh, maxw;
	dev->udev = udev;
	mutex_init(&dev->lock);
	mutex_init(&dev->ctrl_urb_lock);
	mutex_init(&dev->gpio_i2c_lock);
	mutex_init(&dev->i2c_lock);
	spin_lock_init(&dev->video_mode.slock);
	spin_lock_init(&dev->vbi_mode.slock);
	spin_lock_init(&dev->sliced_cc_mode.slock);
	init_waitqueue_head(&dev->open);
	init_waitqueue_head(&dev->wait_frame);
	init_waitqueue_head(&dev->wait_stream);
	dev->cx231xx_read_ctrl_reg = cx231xx_read_ctrl_reg;
	dev->cx231xx_write_ctrl_reg = cx231xx_write_ctrl_reg;
	dev->cx231xx_send_usb_command = cx231xx_send_usb_command;
	dev->cx231xx_gpio_i2c_read = cx231xx_gpio_i2c_read;
	dev->cx231xx_gpio_i2c_write = cx231xx_gpio_i2c_write;
	retval = initialize_cx231xx(dev);
	if (retval < 0) {
		dev_err(dev->dev, "Failed to read PCB config\n");
		return retval;
	}
	if (dev->model == CX231XX_BOARD_CNXT_VIDEO_GRABBER ||
	    dev->model == CX231XX_BOARD_HAUPPAUGE_USBLIVE2) {
		cx231xx_set_alt_setting(dev, INDEX_VIDEO, 3);
		cx231xx_set_alt_setting(dev, INDEX_VANC, 1);
	}
	cx231xx_pre_card_setup(dev);
	retval = cx231xx_config(dev);
	if (retval) {
		dev_err(dev->dev, "error configuring device\n");
		return -ENOMEM;
	}
	dev->norm = dev->board.norm;
	retval = cx231xx_dev_init(dev);
	if (retval) {
		dev_err(dev->dev,
			"%s: cx231xx_i2c_register - errCode [%d]!\n",
			__func__, retval);
		goto err_dev_init;
	}
	cx231xx_card_setup(dev);
	cx231xx_config_i2c(dev);
	maxw = norm_maxw(dev);
	maxh = norm_maxh(dev);
	dev->width = maxw;
	dev->height = maxh;
	dev->interlaced = 0;
	dev->video_input = 0;
	retval = cx231xx_config(dev);
	if (retval) {
		dev_err(dev->dev, "%s: cx231xx_config - errCode [%d]!\n",
			__func__, retval);
		goto err_dev_init;
	}
	INIT_LIST_HEAD(&dev->video_mode.vidq.active);
	INIT_LIST_HEAD(&dev->vbi_mode.vidq.active);
	cx231xx_add_into_devlist(dev);
	if (dev->board.has_417) {
		dev_info(dev->dev, "attach 417 %d\n", dev->model);
		if (cx231xx_417_register(dev) < 0) {
			dev_err(dev->dev,
				"%s() Failed to register 417 on VID_B\n",
				__func__);
		}
	}
	retval = cx231xx_register_analog_devices(dev);
	if (retval)
		goto err_analog;
	cx231xx_ir_init(dev);
	cx231xx_init_extension(dev);
	return 0;
err_analog:
	cx231xx_unregister_media_device(dev);
	cx231xx_release_analog_resources(dev);
	cx231xx_remove_from_devlist(dev);
err_dev_init:
	cx231xx_dev_uninit(dev);
	return retval;
}
