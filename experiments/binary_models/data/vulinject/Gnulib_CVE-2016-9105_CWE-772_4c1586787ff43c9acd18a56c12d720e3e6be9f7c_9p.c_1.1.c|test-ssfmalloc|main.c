main (int argc, char *argv[])
{
  if (argc > 1)
    srand (atoi (argv[1]));
  init_pagesize ();
  {
    unsigned int repeat;
    char *blocks[SIZEOF (block_sizes)];
    {
      size_t i;
      for (i = 0; i < SIZEOF (block_sizes); i++)
        blocks[i] = NULL;
    }
    for (repeat = 0; repeat < 100000; repeat++)
      {
        unsigned int operation = RANDOM (2);
        switch (operation)
          {
          case 0:
            { 
              size_t i = RANDOM (SIZEOF (block_sizes));
              size_t size = block_sizes[i];
              if (blocks[i] == NULL)
                {
                  uintptr_t block = allocate_block (size);
                  if (block == 0)
                    abort ();
                  blocks[i] = (char *) block;
                }
            }
            break;
          case 1:
            { 
              size_t i = RANDOM (SIZEOF (block_sizes));
              size_t size = block_sizes[i];
              if (blocks[i] != NULL)
                {
                  uintptr_t block = (uintptr_t) blocks[i];
                  verify_block (block, size);
                  free_block (block);
                  blocks[i] = NULL;
                }
            }
            break;
          }
      }
    {
      size_t i;
      for (i = 0; i < SIZEOF (block_sizes); i++)
        if (blocks[i] != NULL)
          {
            uintptr_t block = (uintptr_t) blocks[i];
            size_t size = block_sizes[i];
            verify_block (block, size);
            free_block (block);
          }
    }
  }
  return test_exit_status;
}
