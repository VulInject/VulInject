static void emu8k_pcm_timer_func(struct timer_list *t)
{
	struct snd_emu8k_pcm *rec = from_timer(rec, t, timer);
	int ptr, delta;
	spin_lock(&rec->timer_lock);
	ptr = emu8k_get_curpos(rec, 0);
	if (ptr < rec->last_ptr)
		delta = ptr + rec->buf_size - rec->last_ptr;
	else
		delta = ptr - rec->last_ptr;
	rec->period_pos += delta;
	rec->last_ptr = ptr;
	mod_timer(&rec->timer, jiffies + 1);
	if (rec->period_pos >= (int)rec->period_size) {
		rec->period_pos %= rec->period_size;
		snd_pcm_period_elapsed(rec->substream);
		return;
	}
	spin_unlock(&rec->timer_lock);
}
