_request_firmware_prepare(struct firmware **firmware_p, const char *name,
			  struct device *device, void *dbuf, size_t size,
			  size_t offset, unsigned int opt_flags)
{
	struct firmware *firmware;
	struct fw_priv *fw_priv;
	int ret;
	*firmware_p = firmware = kzalloc(sizeof(*firmware), GFP_KERNEL);
	if (!firmware) {
		dev_err(device, "%s: kmalloc(struct firmware) failed\n",
			__func__);
		return -ENOMEM;
	}
	if (firmware_request_builtin_buf(firmware, name, dbuf, size)) {
		dev_dbg(device, "using built-in %s\n", name);
		return 0; 
	}
	ret = alloc_lookup_fw_priv(name, &fw_cache, &fw_priv, dbuf, size,
				   offset, opt_flags);
	firmware->priv = fw_priv;
	if (ret > 0) {
		ret = fw_state_wait(fw_priv);
		if (!ret) {
			return 0; 
		}
	}
	if (ret < 0)
		return ret;
	return 1; 
}
