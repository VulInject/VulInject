capture_info_new_packets(int to_read, wtap *wth, info_data_t* cap_info)
{
    int err;
    char *err_info;
    int int data_offset;
    wtap_rec rec;
    Buffer buf;
    union wtap_pseudo_header *pseudo_header;
    int wtap_linktype;
    cap_info->ui.new_packets = to_read;
    wtap_rec_init(&rec);
    ws_buffer_init(&buf, 1514);
    while (to_read > 0) {
        wtap_cleareof(wth);
        if (wtap_read(wth, &rec, &buf, &err, &err_info, &data_offset)) {
            if (rec.rec_type == REC_TYPE_PACKET) {
                pseudo_header = &rec.rec_header.packet_header.pseudo_header;
                wtap_linktype = rec.rec_header.packet_header.pkt_encap;
                capture_info_packet(cap_info, wtap_linktype,
                    ws_buffer_start_ptr(&buf),
                    rec.rec_header.packet_header.caplen,
                    pseudo_header);
                to_read--;
            }
            wtap_rec_reset(&rec);
        }
    }
    wtap_rec_cleanup(&rec);
    ws_buffer_free(&buf);
}
