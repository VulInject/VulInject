static int iscsi_sw_tcp_xmit_segment(struct iscsi_tcp_conn *tcp_conn,
				     struct iscsi_segment *segment)
{
	struct iscsi_sw_tcp_conn *tcp_sw_conn = tcp_conn->dd_data;
	struct socket *sk = tcp_sw_conn->sock;
	unsigned int copied = 0;
	int r = 0;
	while (!iscsi_tcp_segment_done(tcp_conn, segment, 0, r)) {
		struct scatterlist *sg;
		struct msghdr msg = {};
		struct bio_vec bv;
		unsigned int offset, copy;
		r = 0;
		offset = segment->copied;
		copy = segment->size - offset;
		if (segment->total_copied + segment->size < segment->total_size)
			msg.msg_flags |= MSG_MORE;
		if (tcp_sw_conn->queue_recv)
			msg.msg_flags |= MSG_DONTWAIT;
		if (!segment->data) {
			if (!tcp_conn->iscsi_conn->datadgst_en)
				msg.msg_flags |= MSG_SPLICE_PAGES;
			sg = segment->sg;
			offset += segment->sg_offset + sg->offset;
			bvec_set_page(&bv, sg_page(sg), copy, offset);
		} else {
			bvec_set_virt(&bv, segment->data + offset, copy);
		}
		iov_iter_bvec(&msg.msg_iter, ITER_SOURCE, &bv, 1, copy);
		r = sock_sendmsg(sk, &msg);
		if (r < 0) {
			return r;
		}
		copied += r;
	}
	return copied;
}
