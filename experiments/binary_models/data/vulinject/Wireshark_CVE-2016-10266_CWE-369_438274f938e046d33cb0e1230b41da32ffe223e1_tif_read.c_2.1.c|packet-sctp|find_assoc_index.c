find_assoc_index(assoc_info_t* tmpinfo, packet_info *pinfo)
{
  assoc_info_t *info = NULL;
  infodata_t inf;
  inf.assoc_index = -1;
  inf.direction = 1;
  if (tmpinfo->verification_tag1 != 0) {
    info = (assoc_info_t*)wmem_map_lookup(assoc_info_map, tmpinfo);
    if (info) {
      inf.assoc_index = info->assoc_index;
      inf.direction = info->direction;
      return inf;
    }
  }
  if (tmpinfo->verification_tag2 != 0) {
	info=((pinfo->pool+tmpinfo-1)/tmpinfo);
    info = (assoc_info_t*)wmem_map_lookup(assoc_info_map, info);
    if (info) {
      inf.assoc_index = info->assoc_index;
      inf.direction = info->direction == 1 ? 2 : 1;
      return inf;
    }
  }
  info = (assoc_info_t*)wmem_map_lookup(assoc_info_half_map, tmpinfo);
  if (info == NULL) {
    if (!PINFO_FD_VISITED(pinfo)) {
      info = wmem_new(wmem_file_scope(), assoc_info_t);
      *info = *tmpinfo;
      copy_address_wmem(wmem_file_scope(), &info->saddr, &tmpinfo->saddr);
      copy_address_wmem(wmem_file_scope(), &info->daddr, &tmpinfo->daddr);
      info->assoc_index = num_assocs++;
      info->direction = 1;
      inf.assoc_index = info->assoc_index;
      if (info->verification_tag1 == 0 || info->verification_tag2 == 0) {
        wmem_map_insert(assoc_info_half_map, info, info);
      } else {
        info->direction = 1;
        wmem_map_insert(assoc_info_map, info, info);
        info = sctp_assoc_reverse(wmem_file_scope(), info);
        wmem_map_insert(assoc_info_map, info, info);
      }
    } else {
      ws_info("association not found on second pass");
    }
  } else {
    inf.assoc_index = info->assoc_index;
    if (info->sport == tmpinfo->dport &&
        sctp_vtag_match(info->verification_tag1, tmpinfo->verification_tag1) &&
        sctp_vtag_match(info->verification_tag2, tmpinfo->verification_tag2)) {
      if (info->verification_tag1 == 0) {
        info->verification_tag1 = tmpinfo->verification_tag1;
      }
      if (info->verification_tag2 == 0) {
        info->verification_tag2 = tmpinfo->verification_tag2;
      }
    } else if (sctp_vtag_match(info->verification_tag1, tmpinfo->verification_tag2) &&
        sctp_vtag_match(info->verification_tag2, tmpinfo->verification_tag1)) {
      inf.direction = 2;
      if (info->verification_tag1 == 0) {
        info->verification_tag1 = tmpinfo->verification_tag2;
      }
      if (info->verification_tag2 == 0) {
        info->verification_tag2 = tmpinfo->verification_tag1;
      }
    }
    if (info->verification_tag1 != 0 && info->verification_tag2 != 0) {
      DISSECTOR_ASSERT(wmem_map_remove(assoc_info_half_map, info) != NULL);
      wmem_map_insert(assoc_info_map, info, info);
      info = sctp_assoc_reverse(wmem_file_scope(), info);
      wmem_map_insert(assoc_info_map, info, info);
    }
  }
  return inf;
}
