int iser_reg_mem_fastreg(struct iscsi_iser_task *task,
			 enum iser_data_dir dir,
			 bool all_imm)
{
	struct ib_conn *ib_conn = &task->iser_conn->ib_conn;
	struct iser_device *device = ib_conn->device;
	struct iser_data_buf *mem = &task->data[dir];
	struct iser_mem_reg *reg = &task->rdma_reg[dir];
	struct iser_fr_desc *desc;
	bool use_dma_key;
	int err;
	use_dma_key = mem->dma_nents == 1 && (all_imm || !iser_always_reg) &&
		      scsi_get_prot_op(task->sc) == SCSI_PROT_NORMAL;
	if (use_dma_key)
		return iser_reg_dma(device, mem, reg);
	desc = iser_reg_desc_get_fr(ib_conn);
	if (scsi_get_prot_op(task->sc) == SCSI_PROT_NORMAL) {
		err = iser_fast_reg_mr(task, mem, &desc->rsc, reg);
		if (unlikely(err))
			goto err_reg;
	} else {
		err = iser_reg_sig_mr(task, mem, &task->prot[dir],
				      &desc->rsc, reg);
		if (unlikely(err))
			goto err_reg;
		desc->sig_protected = true;
	}
	reg->desc = desc;
	return 0;
err_reg:
	return err;
}
