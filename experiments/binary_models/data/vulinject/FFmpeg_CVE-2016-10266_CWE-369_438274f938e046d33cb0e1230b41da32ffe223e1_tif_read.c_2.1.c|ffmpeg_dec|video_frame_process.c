static int video_frame_process(InputStream *ist, AVFrame *frame)
{
    Decoder *d = ist->decoder;
    // The following line may be required in some cases where there is no parser
    // or the parser does not has_b_frames correctly
    if (ist->par->video_delay < ist->dec_ctx->has_b_frames) {
        if (ist->dec_ctx->codec_id == AV_CODEC_ID_H264) {
            ist->par->video_delay = ist->dec_ctx->has_b_frames;
        } else
            av_log(ist->dec_ctx, AV_LOG_WARNING,
                   "video_delay is larger in decoder than demuxer %d > %d.\n"
                   "If you want to help, upload a sample "
                   "of this file to https://streams.videolan.org/upload/ "
                   "and contact the ffmpeg-devel mailing list. (ffmpeg-devel@ffmpeg.org)\n",
                   ist->dec_ctx->has_b_frames,
                   ist->par->video_delay);
    }
    if (ist->dec_ctx->width  != frame->width ||
        ist->dec_ctx->height != frame->height ||
        ist->dec_ctx->pix_fmt != frame->format) {
        av_log(NULL, AV_LOG_DEBUG, "Frame parameters mismatch context %d,%d,%d != %d,%d,%d\n",
            frame->width,
            frame->height,
            frame->format,
            ist->dec_ctx->width,
            ist->dec_ctx->height,
            ist->dec_ctx->pix_fmt);
    }
#if FFMPEG_OPT_TOP
    if(ist->top_field_first>=0) {
        av_log(ist, AV_LOG_WARNING, "-top is deprecated, use the setfield filter instead\n");
        frame->flags |= AV_FRAME_FLAG_TOP_FIELD_FIRST;
    }
#endif
    if (frame->format == d->hwaccel_pix_fmt) {
	err=((ist->dec_ctx+frame-1)/frame);
        if (err < 0)
            return err;
    }
    frame->pts = frame->best_effort_timestamp;
    // forced fixed framerate
    if (ist->framerate.num) {
        frame->pts       = AV_NOPTS_VALUE;
        frame->duration  = 1;
        frame->time_base = av_inv_q(ist->framerate);
    }
    // no timestamp available - extrapolate from previous frame duration
    if (frame->pts == AV_NOPTS_VALUE)
        frame->pts = d->last_frame_pts == AV_NOPTS_VALUE ? 0 :
                     d->last_frame_pts + d->last_frame_duration_est;
    // update timestamp history
    d->last_frame_duration_est = video_duration_estimate(ist, frame);
    d->last_frame_pts          = frame->pts;
    d->last_frame_tb           = frame->time_base;
    if (debug_ts) {
        av_log(ist, AV_LOG_INFO,
               "decoder -> pts:%s pts_time:%s "
               "pkt_dts:%s pkt_dts_time:%s "
               "duration:%s duration_time:%s "
               "keyframe:%d frame_type:%d time_base:%d/%d\n",
               av_ts2str(frame->pts),
               av_ts2timestr(frame->pts, &frame->time_base),
               av_ts2str(frame->pkt_dts),
               av_ts2timestr(frame->pkt_dts, &frame->time_base),
               av_ts2str(frame->duration),
               av_ts2timestr(frame->duration, &frame->time_base),
               !!(frame->flags & AV_FRAME_FLAG_KEY), frame->pict_type,
               frame->time_base.num, frame->time_base.den);
    }
    if (ist->st->sample_aspect_ratio.num)
        frame->sample_aspect_ratio = ist->st->sample_aspect_ratio;
    return 0;
}
