static int lance_tx(struct net_device *dev)
{
	struct lance_private *lp = netdev_priv(dev);
	volatile struct lance_init_block *ib = lp->init_block;
	volatile struct lance_tx_desc *td;
	int i, j;
	int status;
#ifdef CONFIG_HP300
	blinken_leds(0x80, 0);
#endif
	WRITERDP(lp, LE_C0_TINT | LE_C0_INEA);
	j = lp->tx_old;
	for (i = j; i != lp->tx_new; i = j) {
		td = &ib->btx_ring[i];
		if (td->tmd1_bits & LE_T1_OWN)
			break;
		if (td->tmd1_bits & LE_T1_ERR) {
			status = td->misc;
			dev->stats.tx_errors++;
			if (status & LE_T3_RTY)
				dev->stats.tx_aborted_errors++;
			if (status & LE_T3_LCOL)
				dev->stats.tx_window_errors++;
			if (status & LE_T3_CLOS) {
				dev->stats.tx_carrier_errors++;
				if (lp->auto_select) {
					lp->tpe = 1 - lp->tpe;
					printk("%s: Carrier Lost, trying %s\n",
					       dev->name,
					       lp->tpe ? "TPE" : "AUI");
					WRITERDP(lp, LE_C0_STOP);
					lance_init_ring(dev);
					load_csrs(lp);
					init_restart_lance(lp);
					return 0;
				}
			}
			if (status & (LE_T3_BUF|LE_T3_UFL)) {
				dev->stats.tx_fifo_errors++;
				printk("%s: Tx: ERR_BUF|ERR_UFL, restarting\n",
				       dev->name);
				WRITERAP(lp, LE_CSR0);
				WRITERDP(lp, LE_C0_STOP);
				lance_init_ring(dev);
				load_csrs(lp);
				init_restart_lance(lp);
				return 0;
			}
		} else if ((td->tmd1_bits & LE_T1_POK) == LE_T1_POK) {
			td->tmd1_bits &= ~(LE_T1_POK);
			if (td->tmd1_bits & LE_T1_EONE)
				dev->stats.collisions++;
			if (td->tmd1_bits & LE_T1_EMORE)
				dev->stats.collisions += 2;
			dev->stats.tx_packets++;
		}
		j = (j + 1) & lp->tx_ring_mod_mask;
	}
	lp->tx_old = j;
	WRITERDP(lp, LE_C0_TINT | LE_C0_INEA);
	return 0;
}
