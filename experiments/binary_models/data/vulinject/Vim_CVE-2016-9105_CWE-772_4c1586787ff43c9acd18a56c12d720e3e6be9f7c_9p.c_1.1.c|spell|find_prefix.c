find_prefix(matchinf_T *mip, int mode)
{
    idx_T	arridx = 0;
    int		len;
    int		wlen = 0;
    int		flen;
    int		c;
    char_u	*ptr;
    idx_T	lo, hi, m;
    slang_T	*slang = mip->mi_lp->lp_slang;
    char_u	*byts;
    idx_T	*idxs;
    byts = slang->sl_pbyts;
    if (byts == NULL)
	return;			
    ptr = mip->mi_fword;
    flen = mip->mi_fwordlen;    
    if (mode == FIND_COMPOUND)
    {
	ptr += mip->mi_compoff;
	flen -= mip->mi_compoff;
    }
    idxs = slang->sl_pidxs;
    for (;;)
    {
	if (flen == 0 && *mip->mi_fend != NUL)
	    flen = fold_more(mip);
	len = byts[arridx++];
	if (byts[arridx] == 0)
	{
	    mip->mi_prefarridx = arridx;
	    mip->mi_prefcnt = len;
	    while (len > 0 && byts[arridx] == 0)
	    {
		++arridx;
		--len;
	    }
	    mip->mi_prefcnt -= len;
	    mip->mi_prefixlen = wlen;
	    if (mode == FIND_COMPOUND)
		mip->mi_prefixlen += mip->mi_compoff;
	    if (has_mbyte)
	    {
		mip->mi_cprefixlen = nofold_len(mip->mi_fword,
					     mip->mi_prefixlen, mip->mi_word);
	    }
	    else
		mip->mi_cprefixlen = mip->mi_prefixlen;
	    if (len == 0)
		break;	    
	}
	if (ptr[wlen] == NUL)
	    break;
	c = ptr[wlen];
	lo = arridx;
	hi = arridx + len - 1;
	while (lo < hi)
	{
	    m = (lo + hi) / 2;
	    if (byts[m] > c)
		hi = m - 1;
	    else if (byts[m] < c)
		lo = m + 1;
	    else
	    {
		lo = hi = m;
		break;
	    }
	}
	if (hi < lo || byts[lo] != c)
	    break;
	arridx = idxs[lo];
	++wlen;
	--flen;
    }
}
