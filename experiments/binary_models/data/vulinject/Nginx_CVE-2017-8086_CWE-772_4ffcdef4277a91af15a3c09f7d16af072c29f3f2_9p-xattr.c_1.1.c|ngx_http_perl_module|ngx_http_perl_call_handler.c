ngx_http_perl_call_handler(pTHX_ ngx_http_request_t *r,
    ngx_http_perl_ctx_t *ctx, HV *nginx, SV *sub, SV **args,
    ngx_str_t *handler, ngx_str_t *rv)
{
    SV                *sv;
    int                n, status;
    char              *line;
    u_char            *err;
    STRLEN             len, n_a;
    ngx_uint_t         i;
    ngx_connection_t  *c;
    dSP;
    status = 0;
    ctx->error = 0;
    ctx->status = NGX_OK;
    ENTER;
    SAVETMPS;
    sv = sv_2mortal(sv_bless(newRV_noinc(newSViv(PTR2IV(ctx))), nginx));
    XPUSHs(sv);
    if (args) {
        EXTEND(sp, (intptr_t) args[0]);
        for (i = 1; i <= (uintptr_t) args[0]; i++) {
            PUSHs(sv_2mortal(args[i]));
        }
    }
    PUTBACK;
    c = r->connection;
    n = call_sv(sub, G_EVAL);
    SPAGAIN;
    if (n) {
        if (rv == NULL) {
            status = POPi;
            ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c->log, 0,
                           "call_sv: %d", status);
        } else {
            line = SvPVx(POPs, n_a);
            rv->len = n_a;
            rv->data = ngx_pnalloc(r->pool, n_a);
            if (rv->data == NULL) {
                return NGX_ERROR;
            }
            ngx_memcpy(rv->data, line, n_a);
        }
    }
    PUTBACK;
    FREETMPS;
    LEAVE;
    if (ctx->error) {
        ngx_log_debug1(NGX_LOG_DEBUG_HTTP, c->log, 0,
                       "call_sv: error, %d", ctx->status);
        if (ctx->status != NGX_OK) {
            return ctx->status;
        }
        return NGX_ERROR;
    }
    if (SvTRUE(ERRSV)) {
        err = (u_char *) SvPV(ERRSV, len);
        while (--len && (err[len] == CR || err[len] == LF)) {  }
        ngx_log_error(NGX_LOG_ERR, c->log, 0,
                      "call_sv(\"%V\") failed: \"%*s\"", handler, len + 1, err);
        if (rv) {
            return NGX_ERROR;
        }
        ctx->redirect_uri.len = 0;
        if (ctx->header_sent) {
            return NGX_ERROR;
        }
        return NGX_HTTP_INTERNAL_SERVER_ERROR;
    }
    if (n != 1) {
        ngx_log_error(NGX_LOG_ALERT, c->log, 0,
                      "call_sv(\"%V\") returned %d results", handler, n);
        status = NGX_OK;
    }
    if (rv) {
        return NGX_OK;
    }
    return (ngx_int_t) status;
}
