guint address_to_bytes(const address *addr, guint8 *buf, guint buf_len)
{
    address_type_t *at;
    guint copy_len = 0;
    if (!buf || !buf_len)
        return 0;
    ADDR_TYPE_LOOKUP(addr->type, at);
    if (at->addr_to_byte == NULL)
    {
        copy_len = MIN(((guint)addr->len), buf_len);
        memcpy(buf, addr->data, copy_len);
    }
    else
    {
        copy_len = at->addr_to_byte(addr, buf, buf_len);
    }
    return copy_len;
}
