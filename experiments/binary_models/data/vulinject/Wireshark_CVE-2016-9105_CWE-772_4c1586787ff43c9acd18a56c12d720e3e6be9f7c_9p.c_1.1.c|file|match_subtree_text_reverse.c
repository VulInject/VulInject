match_subtree_text_reverse(proto_node *node, gpointer data)
{
    match_data   *mdata      = (match_data *) data;
    const gchar  *string     = mdata->string;
    size_t        string_len = mdata->string_len;
    capture_file *cf         = mdata->cf;
    field_info   *fi         = PNODE_FINFO(node);
    gchar         label_str[ITEM_LABEL_LENGTH];
    gchar        *label_ptr;
    size_t        label_len;
    guint32       i, i_restart;
    guint8        c_char;
    size_t        c_match    = 0;
    ws_assert(fi);
    if (mdata->halt) {
        return;
    }
    if (proto_item_is_hidden(node))
        return;
    if (mdata->prev_finfo && fi == mdata->prev_finfo) {
        mdata->halt = TRUE;
        return;
    }
    if (fi->rep) {
        label_ptr = fi->rep->representation;
    } else {
        label_ptr = label_str;
    }
    if (cf->regex) {
        if (ws_regex_matches(cf->regex, label_ptr)) {
            mdata->frame_matched = TRUE;
            mdata->finfo = fi;
        }
    } else if (cf->case_type) {
        label_len = strlen(label_ptr);
        i_restart = 0;
        for (i = 0; i < label_len; i++) {
            if (i_restart == 0 && c_match == 0 && (label_len - i < string_len))
                break;
            c_char = label_ptr[i];
            c_char = g_ascii_toupper(c_char);
            if (c_match > 0 && i_restart == 0 && c_char == string[0])
                i_restart = i;
            if (c_char == string[c_match]) {
                c_match++;
                if (c_match == string_len) {
                    mdata->frame_matched = TRUE;
                    mdata->finfo = fi;
                    break;
                }
            } else if (i_restart) {
                i = i_restart;
                c_match = 1;
                i_restart = 0;
            } else
                c_match = 0;
        }
    } else if (strstr(label_ptr, string) != NULL) {
        mdata->frame_matched = TRUE;
        mdata->finfo = fi;
    }
    if (node->first_child != NULL)
        proto_tree_children_foreach(node, match_subtree_text_reverse, mdata);
}
