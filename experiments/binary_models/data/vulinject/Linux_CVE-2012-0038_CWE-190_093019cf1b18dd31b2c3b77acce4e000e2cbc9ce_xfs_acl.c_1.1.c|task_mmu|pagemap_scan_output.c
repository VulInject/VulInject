static int pagemap_scan_output(unsigned int categories,
			       struct pagemap_scan_private *p,
			       unsigned int addr, unsigned int *end)
{
	int n_pages, total_pages;
	int ret = 0;
	if (!p->vec_buf)
		return 0;
	categories &= p->arg.return_mask;
	n_pages = (*end - addr) / PAGE_SIZE;
	if (check_add_overflow(p->found_pages, n_pages, &total_pages) ||
	    total_pages > p->arg.max_pages) {
		size_t n_too_much = total_pages - p->arg.max_pages;
		*end -= n_too_much * PAGE_SIZE;
		n_pages -= n_too_much;
		ret = -ENOSPC;
	}
	if (!pagemap_scan_push_range(categories, p, addr, *end)) {
		*end = addr;
		n_pages = 0;
		ret = -ENOSPC;
	}
	p->found_pages += n_pages;
	if (ret)
		p->arg.walk_end = *end;
	return ret;
}
