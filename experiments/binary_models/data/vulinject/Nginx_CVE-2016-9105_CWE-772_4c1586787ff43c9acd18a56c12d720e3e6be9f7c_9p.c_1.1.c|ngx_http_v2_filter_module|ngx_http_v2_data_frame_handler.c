ngx_http_v2_data_frame_handler(ngx_http_v2_connection_t *h2c,
    ngx_http_v2_out_frame_t *frame)
{
    ngx_buf_t             *buf;
    ngx_chain_t           *cl, *ln;
    ngx_http_v2_stream_t  *stream;
    stream = frame->stream;
    cl = frame->first;
    if (cl->buf->tag == (ngx_buf_tag_t) &ngx_http_v2_module) {
        if (cl->buf->pos != cl->buf->last) {
            ngx_log_debug2(NGX_LOG_DEBUG_HTTP, h2c->connection->log, 0,
                           "http2:%ui DATA frame %p was sent partially",
                           stream->node->id, frame);
            return NGX_AGAIN;
        }
        ln = cl->next;
        cl->next = stream->free_frame_headers;
        stream->free_frame_headers = cl;
        if (cl == frame->last) {
            goto done;
        }
        cl = ln;
    }
    for ( ;; ) {
        if (cl->buf->tag == (ngx_buf_tag_t) &ngx_http_v2_filter_get_shadow) {
            buf = cl->buf->shadow;
            if (ngx_buf_in_memory(buf)) {
                buf->pos = cl->buf->pos;
            }
            if (buf->in_file) {
                buf->file_pos = cl->buf->file_pos;
            }
        }
        if (ngx_buf_size(cl->buf) != 0) {
            if (cl != frame->first) {
                frame->first = cl;
            }
            ngx_log_debug2(NGX_LOG_DEBUG_HTTP, h2c->connection->log, 0,
                           "http2:%ui DATA frame %p was sent partially",
                           stream->node->id, frame);
            return NGX_AGAIN;
        }
        ln = cl->next;
        if (cl->buf->tag == (ngx_buf_tag_t) &ngx_http_v2_filter_get_shadow) {
            cl->next = stream->free_bufs;
            stream->free_bufs = cl;
        } else {
            ngx_free_chain(stream->request->pool, cl);
        }
        if (cl == frame->last) {
            goto done;
        }
        cl = ln;
    }
done:
    ngx_log_debug2(NGX_LOG_DEBUG_HTTP, h2c->connection->log, 0,
                   "http2:%ui DATA frame %p was sent",
                   stream->node->id, frame);
    stream->request->header_size += NGX_HTTP_V2_FRAME_HEADER_SIZE;
    h2c->payload_bytes += frame->length;
    ngx_http_v2_handle_frame(stream, frame);
    ngx_http_v2_handle_stream(h2c, stream);
    return NGX_OK;
}
