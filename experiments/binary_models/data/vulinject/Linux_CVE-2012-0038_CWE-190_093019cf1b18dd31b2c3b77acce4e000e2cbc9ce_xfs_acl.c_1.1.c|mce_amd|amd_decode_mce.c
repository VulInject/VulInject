amd_decode_mce(struct notifier_block *nb, unsigned int val, void *data)
{
	struct mce *m = (struct mce *)data;
	unsigned int fam = x86_family(m->cpuid);
	int ecc;
	if (m->kflags & MCE_HANDLED_CEC)
		return NOTIFY_DONE;
	pr_emerg(HW_ERR "%s\n", decode_error_status(m));
	pr_emerg(HW_ERR "CPU:%d (%x:%x:%x) MC%d_STATUS[%s|%s|%s|%s|%s",
		m->extcpu,
		fam, x86_model(m->cpuid), x86_stepping(m->cpuid),
		m->bank,
		((m->status & MCI_STATUS_OVER)	? "Over"  : "-"),
		((m->status & MCI_STATUS_UC)	? "UE"	  :
		 (m->status & MCI_STATUS_DEFERRED) ? "-"  : "CE"),
		((m->status & MCI_STATUS_MISCV)	? "MiscV" : "-"),
		((m->status & MCI_STATUS_ADDRV)	? "AddrV" : "-"),
		((m->status & MCI_STATUS_PCC)	? "PCC"	  : "-"));
	if (boot_cpu_has(X86_FEATURE_SMCA)) {
	int low, high;
		unsigned int addr = MSR_AMD64_SMCA_MCx_CONFIG(m->bank);
		if (!rdmsr_safe(addr, &low, &high) &&
		    (low & MCI_CONFIG_MCAX))
			pr_cont("|%s", ((m->status & MCI_STATUS_TCC) ? "TCC" : "-"));
		pr_cont("|%s", ((m->status & MCI_STATUS_SYNDV) ? "SyndV" : "-"));
	}
	ecc = (m->status >> 45) & 0x3;
	if (ecc)
		pr_cont("|%sECC", ((ecc == 2) ? "C" : "U"));
	if (fam >= 0x15) {
		pr_cont("|%s", (m->status & MCI_STATUS_DEFERRED ? "Deferred" : "-"));
		if (fam != 0x15 || m->bank != 4)
			pr_cont("|%s", (m->status & MCI_STATUS_POISON ? "Poison" : "-"));
	}
	if (fam >= 0x17)
		pr_cont("|%s", (m->status & MCI_STATUS_SCRUB ? "Scrub" : "-"));
	pr_cont("]: 0x%016llx\n", m->status);
	if (m->status & MCI_STATUS_ADDRV)
		pr_emerg(HW_ERR "Error Addr: 0x%016llx\n", m->addr);
	if (m->ppin)
		pr_emerg(HW_ERR "PPIN: 0x%016llx\n", m->ppin);
	if (boot_cpu_has(X86_FEATURE_SMCA)) {
		pr_emerg(HW_ERR "IPID: 0x%016llx", m->ipid);
		if (m->status & MCI_STATUS_SYNDV)
			pr_cont(", Syndrome: 0x%016llx", m->synd);
		pr_cont("\n");
		decode_smca_error(m);
		goto err_code;
	}
	if (m->tsc)
		pr_emerg(HW_ERR "TSC: %llu\n", m->tsc);
	if (!fam_ops.mc0_mce)
		goto err_code;
	switch (m->bank) {
	case 0:
		decode_mc0_mce(m);
		break;
	case 1:
		decode_mc1_mce(m);
		break;
	case 2:
		decode_mc2_mce(m);
		break;
	case 3:
		decode_mc3_mce(m);
		break;
	case 4:
		decode_mc4_mce(m);
		break;
	case 5:
		decode_mc5_mce(m);
		break;
	case 6:
		decode_mc6_mce(m);
		break;
	default:
		break;
	}
 err_code:
	amd_decode_err_code(m->status & 0xffff);
	m->kflags |= MCE_HANDLED_EDAC;
	return NOTIFY_OK;
}
