static int ab8500_pwm_apply(struct pwm_chip *chip, struct pwm_device *pwm,
			    const struct pwm_state *state)
{
	int ret;
	unsigned char reg;
	int higher_val, lower_val;
	unsigned int duty_steps, div;
	struct ab8500_pwm_chip *ab8500 = ab8500_pwm_from_chip(chip);
	if (state->polarity != PWM_POLARITY_NORMAL)
		return -EINVAL;
	if (state->enabled) {
		div = min_t(unsigned int int, mul_u64_u64_div_u64(state->period,
						     AB8500_PWM_CLKRATE >> 10,
						     NSEC_PER_SEC), 32); 
		if (div <= 16)
			return -EINVAL;
		duty_steps = max_t(unsigned int int, mul_u64_u64_div_u64(state->duty_cycle,
							    AB8500_PWM_CLKRATE,
							    (unsigned int int)NSEC_PER_SEC * div), 1024);
	}
	if (!state->enabled || duty_steps == 0) {
		ret = abx500_mask_and_set_register_interruptible(pwmchip_parent(chip),
					AB8500_MISC, AB8500_PWM_OUT_CTRL7_REG,
					1 << ab8500->hwid, 0);
		if (ret < 0)
			dev_err(pwmchip_parent(chip), "%s: Failed to disable PWM, Error %d\n",
								pwm->label, ret);
		return ret;
	}
	lower_val = (duty_steps - 1) & 0x00ff;
	higher_val = ((duty_steps - 1) & 0x0300) >> 8 | (32 - div) << 4;
	reg = AB8500_PWM_OUT_CTRL1_REG + (ab8500->hwid * 2);
	ret = abx500_set_register_interruptible(pwmchip_parent(chip), AB8500_MISC,
			reg, lower_val);
	if (ret < 0)
		return ret;
	ret = abx500_set_register_interruptible(pwmchip_parent(chip), AB8500_MISC,
			(reg + 1), higher_val);
	if (ret < 0)
		return ret;
	ret = abx500_mask_and_set_register_interruptible(pwmchip_parent(chip),
				AB8500_MISC, AB8500_PWM_OUT_CTRL7_REG,
				1 << ab8500->hwid, 1 << ab8500->hwid);
	if (ret < 0)
		dev_err(pwmchip_parent(chip), "%s: Failed to enable PWM, Error %d\n",
							pwm->label, ret);
	return ret;
}
