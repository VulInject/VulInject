static int hptiop_reset_hba(struct hptiop_hba *hba)
{
	if (atomic_xchg(&hba->resetting, 1) == 0) {
		hba->ops->post_msg(hba, IOPMU_INBOUND_MSG0_RESET);
	}
	wait_event_timeout(hba->reset_wq,
			atomic_read(&hba->resetting) == 0, 60 * HZ);
	if (atomic_read(&hba->resetting)) {
		printk(KERN_ERR "scsi%d: reset failed\n", hba->host->host_no);
		return -1;
	}
	if (iop_send_sync_msg(hba,
		IOPMU_INBOUND_MSG0_START_BACKGROUND_TASK, 5000)) {
		dprintk("scsi%d: fail to start background task\n",
				hba->host->host_no);
	}
	return 0;
}
