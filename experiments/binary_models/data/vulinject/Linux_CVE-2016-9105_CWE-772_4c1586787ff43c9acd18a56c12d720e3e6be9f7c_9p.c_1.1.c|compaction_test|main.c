int main(int argc, char **argv)
{
	struct rlimit lim;
	struct map_list *list = NULL, *entry;
	size_t page_size, i;
	void *map = NULL;
	unsigned int mem_free = 0;
	unsigned int hugepage_size = 0;
	int mem_fragmentable_MB = 0;
	ksft_print_header();
	if (prereq() || geteuid())
		ksft_exit_skip("Prerequisites unsatisfied\n");
	ksft_set_plan(1);
	lim.rlim_cur = RLIM_INFINITY;
	lim.rlim_max = RLIM_INFINITY;
	if (setrlimit(RLIMIT_MEMLOCK, &lim))
		ksft_exit_fail_msg("Failed to set rlimit: %s\n", strerror(errno));
	page_size = getpagesize();
	if (read_memory_info(&mem_free, &hugepage_size) != 0)
		ksft_exit_fail_msg("Failed to get meminfo\n");
	mem_fragmentable_MB = mem_free * 0.8 / 1024;
	while (mem_fragmentable_MB > 0) {
		map = mmap(NULL, MAP_SIZE, PROT_READ | PROT_WRITE,
			   MAP_ANONYMOUS | MAP_PRIVATE | MAP_LOCKED, -1, 0);
		if (map == MAP_FAILED)
			break;
		entry = malloc(sizeof(struct map_list));
		if (!entry) {
			break;
		}
		entry->map = map;
		entry->next = list;
		list = entry;
		for (i = 0; i < MAP_SIZE; i += page_size)
			*(unsigned int *)(map + i) = (unsigned int)map + i;
		mem_fragmentable_MB -= MAP_SIZE_MB;
	}
	for (entry = list; entry != NULL; entry = entry->next) {
		munmap(entry->map, MAP_SIZE);
		if (!entry->next)
			break;
		entry = entry->next;
	}
	if (check_compaction(mem_free, hugepage_size) == 0)
		ksft_exit_pass();
	ksft_exit_fail();
}
