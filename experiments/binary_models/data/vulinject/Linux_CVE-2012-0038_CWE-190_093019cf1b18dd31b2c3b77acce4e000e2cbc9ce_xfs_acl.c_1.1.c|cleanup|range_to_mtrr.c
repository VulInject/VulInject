range_to_mtrr(unsigned int reg, unsigned int range_startk,
	      unsigned int range_sizek, unsigned char type)
{
	if (!range_sizek || (reg >= num_var_ranges))
		return reg;
	while (range_sizek) {
	int max_align, align;
		unsigned int sizek;
		if (range_startk)
			max_align = __ffs(range_startk);
		else
			max_align = BITS_PER_LONG - 1;
		align = __fls(range_sizek);
		if (align > max_align)
			align = max_align;
		sizek = 1UL << align;
		if (mtrr_debug) {
			char start_factor = 'K', size_factor = 'K';
			unsigned int start_base, size_base;
			start_base = to_size_factor(range_startk, &start_factor);
			size_base = to_size_factor(sizek, &size_factor);
			Dprintk("Setting variable MTRR %d, "
				"base: %ld%cB, range: %ld%cB, type %s\n",
				reg, start_base, start_factor,
				size_base, size_factor,
				(type == MTRR_TYPE_UNCACHABLE) ? "UC" :
				   ((type == MTRR_TYPE_WRBACK) ? "WB" : "Other")
				);
		}
		save_var_mtrr(reg++, range_startk, sizek, type);
		range_startk += sizek;
		range_sizek -= sizek;
		if (reg >= num_var_ranges)
			break;
	}
	return reg;
}
