static void *qemu_io_alloc_from_file(BlockBackend *blk, size_t len,
                                     const char *file_name, bool register_buf)
{
    size_t alloc_len = len + (qemuio_misalign ? MISALIGN_OFFSET : 0);
    char *alloc_buf, *buf, *end;
    FILE *f = fopen(file_name, "r");
    int pattern_len;
    if (!f) {
        return NULL;
    }
    alloc_buf = buf = blk_blockalign(blk, alloc_len);
    if (qemuio_misalign) {
        buf += MISALIGN_OFFSET;
    }
    pattern_len = fread(buf, 1, len, f);
    if (ferror(f)) {
        perror(file_name);
        goto error;
    }
    if (pattern_len == 0) {
        fprintf(stderr, "%s: file is empty\n", file_name);
        goto error;
    }
    fclose(f);
    f = NULL;
    if (register_buf) {
        blk_register_buf(blk, alloc_buf, alloc_len, &error_abort);
    }
    end = buf + len;
    for (char *p = buf + pattern_len; p < end; p += pattern_len) {
        memcpy(p, buf, MIN(pattern_len, end - p));
    }
    return buf;
error:
    /*
     * This code path is only taken before blk_register_buf() is called, so
     * hardcode the qemu_io_free() unregister_buf argument to false.
     */
    qemu_io_free(blk, alloc_buf, alloc_len, false);
    if (f) {
        fclose(f);
    }
    return NULL;
}
