test_socket_pair (void)
{
  struct sockaddr_in ia;
  socklen_t addrlen = sizeof (ia);
  int s = open_server_socket ();
  int c1 = connect_to_socket (false);
  int c2 = accept (s, (struct sockaddr *) &ia, &addrlen);
  ASSERT (s >= 0);
  ASSERT (c1 >= 0);
  close (s);
  test_pair (c1, c2);
  close (c1);
  ASSERT (write (c2, "foo", 3) == 3);
  int revents = poll1_nowait (c2, POLLIN | POLLOUT);
#ifdef __linux__
  if ((revents & (POLLHUP | POLLERR)) == 0)
    failed ("expecting POLLHUP after shutdown");
#else
  (void) revents;
#endif
  close (c2);
}
