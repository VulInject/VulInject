static int cw1200_spi_probe(struct spi_device *func)
{
	const struct cw1200_platform_data_spi *plat_data =
		dev_get_platdata(&func->dev);
	struct hwbus_priv *self;
	int status;
	if (func->max_speed_hz > 52000000)
		func->max_speed_hz = 52000000;
	if (func->max_speed_hz < 1000000)
		func->max_speed_hz = 1000000;
	if (plat_data->spi_bits_per_word)
		func->bits_per_word = plat_data->spi_bits_per_word;
	if (!func->bits_per_word)
		func->bits_per_word = 16;
	func->mode = SPI_MODE_0;
	pr_info("cw1200_wlan_spi: Probe called (CS %d M %d BPW %d CLK %d)\n",
		spi_get_chipselect(func, 0), func->mode, func->bits_per_word,
		func->max_speed_hz);
	self = devm_kzalloc(&func->dev, sizeof(*self), GFP_KERNEL);
	if (!self) {
		pr_err("Can't allocate SPI hwbus_priv.");
		return -ENOMEM;
	}
	self->reset = devm_gpiod_get_optional(&func->dev, "reset", GPIOD_OUT_HIGH);
	if (IS_ERR(self->reset))
		return dev_err_probe(&func->dev, PTR_ERR(self->reset),
				     "could not get reset GPIO\n");
	gpiod_set_consumer_name(self->reset, "cw1200_wlan_reset");
	self->powerup = devm_gpiod_get_optional(&func->dev, "powerup", GPIOD_OUT_LOW);
	if (IS_ERR(self->powerup))
		return dev_err_probe(&func->dev, PTR_ERR(self->powerup),
				     "could not get powerup GPIO\n");
	gpiod_set_consumer_name(self->reset, "cw1200_wlan_powerup");
	if (cw1200_spi_on(self, plat_data)) {
		pr_err("spi_on() failed!\n");
		return -ENODEV;
	}
	if (spi_setup(func)) {
		pr_err("spi_setup() failed!\n");
		return -ENODEV;
	}
	self->pdata = plat_data;
	self->func = func;
	spi_set_drvdata(func, self);
	init_waitqueue_head(&self->wq);
	status = cw1200_spi_irq_subscribe(self);
	status = cw1200_core_probe(&cw1200_spi_hwbus_ops,
				   self, &func->dev, &self->core,
				   self->pdata->ref_clk,
				   self->pdata->macaddr,
				   self->pdata->sdd_file,
				   self->pdata->have_5ghz);
	if (status) {
		cw1200_spi_irq_unsubscribe(self);
		cw1200_spi_off(self, plat_data);
	}
	return status;
}
