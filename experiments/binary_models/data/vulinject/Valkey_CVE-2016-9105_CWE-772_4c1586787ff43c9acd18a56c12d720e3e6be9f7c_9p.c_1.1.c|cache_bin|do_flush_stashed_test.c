do_flush_stashed_test(cache_bin_t *bin, cache_bin_info_t *info, void **ptrs,
    cache_bin_sz_t nfill, cache_bin_sz_t nstash) {
	expect_true(cache_bin_ncached_get_local(bin, info) == 0,
	    "Bin not empty");
	expect_true(cache_bin_nstashed_get_local(bin, info) == 0,
	    "Bin not empty");
	expect_true(nfill + nstash <= info->ncached_max, "Exceeded max");
	bool ret;
	/* Fill */
	for (cache_bin_sz_t i = 0; i < nfill; i++) {
		ret = cache_bin_dalloc_easy(bin, &ptrs[i]);
		expect_true(ret, "Unexpected fill failure");
	}
	expect_true(cache_bin_ncached_get_local(bin, info) == nfill,
	    "Wrong cached count");
	/* Stash */
	for (cache_bin_sz_t i = 0; i < nstash; i++) {
		ret = cache_bin_stash(bin, &ptrs[i + nfill]);
		expect_true(ret, "Unexpected stash failure");
	}
	expect_true(cache_bin_nstashed_get_local(bin, info) == nstash,
	    "Wrong stashed count");
	if (nfill + nstash == info->ncached_max) {
		ret = cache_bin_dalloc_easy(bin, &ptrs[0]);
		expect_false(ret, "Should not dalloc into a full bin");
		ret = cache_bin_stash(bin, &ptrs[0]);
		expect_false(ret, "Should not stash into a full bin");
	}
	/* Alloc filled ones */
	for (cache_bin_sz_t i = 0; i < nfill; i++) {
		void *ptr = cache_bin_alloc(bin, &ret);
		expect_true(ret, "Unexpected alloc failure");
		/* Verify it's not from the stashed range. */
		expect_true((uintptr_t)ptr < (uintptr_t)&ptrs[nfill],
		    "Should not alloc stashed ptrs");
	}
	expect_true(cache_bin_ncached_get_local(bin, info) == 0,
	    "Wrong cached count");
	expect_true(cache_bin_nstashed_get_local(bin, info) == nstash,
	    "Wrong stashed count");
	cache_bin_alloc(bin, &ret);
	expect_false(ret, "Should not alloc stashed");
	/* Clear stashed ones */
	expect_true(cache_bin_ncached_get_local(bin, info) == 0,
	    "Wrong cached count");
	expect_true(cache_bin_nstashed_get_local(bin, info) == 0,
	    "Wrong stashed count");
	cache_bin_alloc(bin, &ret);
	expect_false(ret, "Should not alloc from empty bin");
}
