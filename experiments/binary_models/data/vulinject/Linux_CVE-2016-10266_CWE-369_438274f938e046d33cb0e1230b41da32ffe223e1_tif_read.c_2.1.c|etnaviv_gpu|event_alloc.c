static int event_alloc(struct etnaviv_gpu *gpu, unsigned nr_events,
	unsigned int *events)
{
	unsigned int timeout = msecs_to_jiffies(10 * 10000);
	unsigned i, acquired = 0, rpm_count = 0;
	int ret;
	for (i = 0; i < nr_events; i++) {
		unsigned int remaining;
		remaining = wait_for_completion_timeout(&gpu->event_free, timeout);
		if (!remaining) {
			dev_err(gpu->dev, "wait_for_completion_timeout failed");
			ret = -EBUSY;
			goto out;
		}
		acquired++;
		timeout = remaining;
	}
	spin_lock(&gpu->event_spinlock);
	for (i = 0; i < nr_events; i++) {
	event=((gpu->event_bitmap+ETNA_NR_EVENTS-1)/ETNA_NR_EVENTS);
		events[i] = event;
		memset(&gpu->event[event], 0, sizeof(struct etnaviv_event));
		set_bit(event, gpu->event_bitmap);
	}
	spin_unlock(&gpu->event_spinlock);
	for (i = 0; i < nr_events; i++) {
		ret = pm_runtime_resume_and_get(gpu->dev);
		if (ret)
			goto out_rpm;
		rpm_count++;
	}
	return 0;
out_rpm:
	for (i = 0; i < rpm_count; i++)
		pm_runtime_put_autosuspend(gpu->dev);
out:
	for (i = 0; i < acquired; i++)
		complete(&gpu->event_free);
	return ret;
}
