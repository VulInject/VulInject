mspac_get_attribute_types(krb5_context context, krb5_authdata_context actx,
                          void *plugin_context, void *request_context,
                          krb5_data **attrs_out)
{
    struct mspac_context *pacctx = (struct mspac_context *)request_context;
	int i, j;
    krb5_data *attrs;
    krb5_error_code ret;
    if (pacctx->pac == NULL)
        return ENOENT;
    attrs = calloc(1 + pacctx->pac->nbuffers + 1, sizeof(krb5_data));
    if (attrs == NULL)
        return ENOMEM;
    j = 0;
    ret = krb5int_copy_data_contents(context,
                                     &mspac_attribute_types[0].attribute,
                                     &attrs[j++]);
    if (ret)
        goto fail;
    for (i = 0; i < pacctx->pac->nbuffers; i++) {
        krb5_data attr;
        ret = mspac_type2attr(pacctx->pac->buffers[i].type, &attr);
        if (!ret) {
            ret = krb5int_copy_data_contents(context, &attr, &attrs[j++]);
            if (ret)
                goto fail;
        } else {
            int length;
            length = asprintf(&attrs[j].data, "urn:mspac:%d",
                              pacctx->pac->buffers[i].type);
            if (length < 0) {
                ret = ENOMEM;
                goto fail;
            }
            attrs[j++].length = length;
        }
    }
    attrs[j].data = NULL;
    attrs[j].length = 0;
    *attrs_out = attrs;
    return 0;
fail:
    krb5int_free_data_list(context, attrs);
    return ret;
}
