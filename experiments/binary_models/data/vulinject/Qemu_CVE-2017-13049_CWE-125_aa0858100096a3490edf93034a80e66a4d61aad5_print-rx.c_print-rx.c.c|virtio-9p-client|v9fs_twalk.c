TWalkRes v9fs_twalk(TWalkOpt opt)
{
    P9Req *req;
    int i;
    uint32_t body_size = 4 + 4 + 2;
    uint32_t err;
    char **wnames = NULL;
    g_assert(opt.client);
    /* expecting either high- or low-level path, both not both */
    g_assert(!opt.path || !(opt.nwname || opt.wnames));
    /* expecting either Rwalk or Rlerror, but obviously not both */
    g_assert(!opt.expectErr || !(opt.rwalk.nwqid || opt.rwalk.wqid));
    if (!opt.newfid) {
        opt.newfid = genfid();
    }
    if (opt.path) {
        opt.nwname = split(opt.path, "/", &wnames);
        opt.wnames = wnames;
    }
    for (i = 0; i < opt.nwname; i++) {
        uint16_t wname_size = v9fs_string_size(opt.wnames[i]);
        g_assert_cmpint(body_size, <=, UINT32_MAX - wname_size);
        body_size += wname_size;
    }
    req = v9fs_req_init(opt.client, body_size, P9_TWALK, opt.tag);
    v9fs_uint32_write(req, opt.fid);
    v9fs_uint32_write(req, opt.newfid);
    v9fs_uint16_write(req, opt.nwname);
    for (i = 0; i < opt.nwname; i++) {
        v9fs_string_write(req, opt.wnames[i]);
    }
    if (!opt.requestOnly) {
        v9fs_req_wait_for_reply(req, NULL);
        if (opt.expectErr) {
            v9fs_rlerror(req, &err);
            g_assert_cmpint(err, ==, opt.expectErr);
        } else {
            v9fs_rwalk(req, opt.rwalk.nwqid, opt.rwalk.wqid);
        }
        req = NULL; /* request was freed */
    }
    split_free(&wnames);
    return (TWalkRes) {
        .newfid = opt.newfid,
        .req = req,
    };
}
