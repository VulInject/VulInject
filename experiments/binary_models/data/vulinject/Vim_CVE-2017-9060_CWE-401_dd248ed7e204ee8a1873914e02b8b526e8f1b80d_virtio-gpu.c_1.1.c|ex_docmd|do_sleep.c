do_sleep(int msec, int hide_cursor)
{
    int	done = 0;
    int	wait_now;
# ifdef ELAPSED_FUNC
    elapsed_T	start_tv;
# endif
    if (hide_cursor)
	cursor_sleep();
    else
	cursor_on();
    out_flush_cursor(FALSE, FALSE);
    while (!got_int && done < msec)
    {
	wait_now = msec - done > 1000L ? 1000L : msec - done;
#ifdef FEAT_TIMERS
	{
	    int    due_time = check_due_timer();
	    if (due_time > 0 && due_time < wait_now)
		wait_now = due_time;
	}
#endif
#ifdef FEAT_JOB_CHANNEL
	if (has_any_channel() && wait_now > 20L)
	    wait_now = 20L;
#endif
#ifdef FEAT_SOUND
	if (has_any_sound_callback() && wait_now > 20L)
	    wait_now = 20L;
#endif
	ui_delay(wait_now, TRUE);
#ifdef FEAT_JOB_CHANNEL
	if (has_any_channel())
	    ui_breakcheck_force(TRUE);
	else
#endif
	    ui_breakcheck();
#ifdef MESSAGE_QUEUE
	parse_queued_messages();
#endif
# ifdef ELAPSED_FUNC
	done = ELAPSED_FUNC(start_tv);
# else
	done += wait_now;
# endif
    }
    if (got_int)
	(void)vpeekc();
    if (hide_cursor)
	cursor_unsleep();
}
