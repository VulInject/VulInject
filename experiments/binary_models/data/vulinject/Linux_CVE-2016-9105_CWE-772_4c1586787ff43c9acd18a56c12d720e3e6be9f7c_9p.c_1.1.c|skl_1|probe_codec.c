static int probe_codec(struct hdac_bus *bus, int addr)
{
	unsigned int cmd = (addr << 28) | (AC_NODE_ROOT << 20) |
		(AC_VERB_PARAMETERS << 8) | AC_PAR_VENDOR_ID;
	unsigned int res = -1;
#if IS_ENABLED(CONFIG_SND_SOC_INTEL_SKYLAKE_HDAUDIO_CODEC)
	struct skl_dev *skl = bus_to_skl(bus);
	struct hdac_hda_priv *hda_codec;
#endif
	struct hda_codec *codec;
	snd_hdac_bus_send_cmd(bus, cmd);
	snd_hdac_bus_get_response(bus, addr, &res);
	mutex_unlock(&bus->cmd_mutex);
	if (res == -1)
		return -EIO;
	dev_dbg(bus->dev, "codec #%d probed OK: %x\n", addr, res);
#if IS_ENABLED(CONFIG_SND_SOC_INTEL_SKYLAKE_HDAUDIO_CODEC)
	hda_codec = devm_kzalloc(&skl->pci->dev, sizeof(*hda_codec),
				 GFP_KERNEL);
	if (!hda_codec)
		return -ENOMEM;
	codec = skl_codec_device_init(bus, addr);
	if (IS_ERR(codec))
		return PTR_ERR(codec);
	hda_codec->codec = codec;
	hda_codec->dev_index = addr;
	dev_set_drvdata(&codec->core.dev, hda_codec);
	if ((res & 0xFFFF0000) != IDISP_INTEL_VENDOR_ID) {
		codec->core.type = HDA_DEV_LEGACY;
		load_codec_module(hda_codec->codec);
	}
	return 0;
#else
	codec = skl_codec_device_init(bus, addr);
	return PTR_ERR_OR_ZERO(codec);
#endif 
}
