file_read(void *buf, unsigned int len, FILE_T file)
{
    unsigned got, n;
    if (file->seek_pending) {
        file->seek_pending = false;
        if (gz_skip(file, file->skip) == -1)
            return -1;
    }
    got = 0;
    do {
        if (file->out.avail != 0) {
            n = file->out.avail > len ? len : file->out.avail;
            if (buf != NULL) {
                memcpy(buf, file->out.next, n);
                buf = (char *)buf + n;
            }
            file->out.next += n;
            file->out.avail -= n;
            len -= n;
            got += n;
            file->pos += n;
        } else if (file->err != 0) {
            return -1;
        } else if (file->eof && file->in.avail == 0) {
            break;
        } else {
            if (fill_out_buffer(file) == -1)
                return -1;
        }
    } while (len);
    return (int)got;
}
