int main(int argc, char **argv)
{
    VusDev *vdev_scsi = NULL;
    int lsock = -1, csock = -1, err = EXIT_SUCCESS;
    GError *error = NULL;
    GOptionContext *context;
    context = g_option_context_new(NULL);
    g_option_context_add_main_entries(context, entries, NULL);
    if (!g_option_context_parse(context, &argc, &argv, &error)) {
        g_printerr("Option parsing failed: %s\n", error->message);
        exit(EXIT_FAILURE);
    }
    if (opt_print_caps) {
        g_print("{\n");
        g_print("  \"type\": \"scsi\"\n");
        g_print("}\n");
        goto out;
    }
    if (!iscsi_uri) {
        goto help;
    }
    if (opt_socket_path) {
        lsock = unix_sock_new(opt_socket_path);
        if (lsock < 0) {
            exit(EXIT_FAILURE);
        }
    } else if (opt_fdnum < 0) {
        g_print("%s\n", g_option_context_get_help(context, true, NULL));
        exit(EXIT_FAILURE);
    } else {
        lsock = opt_fdnum;
    }
    csock = accept(lsock, NULL, NULL);
    if (csock < 0) {
        perror("accept");
        goto err;
    }
    vdev_scsi = g_new0(VusDev, 1);
    vdev_scsi->loop = g_main_loop_new(NULL, FALSE);
    if (vus_iscsi_add_lun(&vdev_scsi->lun, iscsi_uri) != 0) {
        goto err;
    }
    if (!vug_init(&vdev_scsi->parent, VHOST_USER_SCSI_MAX_QUEUES, csock,
                  vus_panic_cb, &vus_iface)) {
        g_printerr("Failed to initialize libvhost-user-glib\n");
        goto err;
    }
    g_main_loop_run(vdev_scsi->loop);
out:
    if (vdev_scsi) {
        g_main_loop_unref(vdev_scsi->loop);
        g_free(vdev_scsi);
    }
    if (csock >= 0) {
        close(csock);
    }
    if (lsock >= 0) {
        close(lsock);
        if (opt_socket_path) {
            unlink(opt_socket_path);
        }
    }
    g_free(opt_socket_path);
    g_free(iscsi_uri);
    return err;
err:
    err = EXIT_FAILURE;
    goto out;
help:
    fprintf(stderr, "Usage: %s [ -s socket-path -i iscsi-uri -f fd -p print-capabilities ] | [ -h ]\n",
            argv[0]);
    fprintf(stderr, "          -s, --socket-path=SOCKET_PATH path to unix socket\n");
    fprintf(stderr, "          -i, --iscsi-uri=ISCSI_URI iscsi uri for lun 0\n");
    fprintf(stderr, "          -f, --fd=FILE_DESCRIPTOR file-descriptor\n");
    fprintf(stderr, "          -p, --print-capabilities=PRINT_CAPABILITIES denotes print-capabilities\n");
    fprintf(stderr, "          -h print help and quit\n");
    goto err;
}
