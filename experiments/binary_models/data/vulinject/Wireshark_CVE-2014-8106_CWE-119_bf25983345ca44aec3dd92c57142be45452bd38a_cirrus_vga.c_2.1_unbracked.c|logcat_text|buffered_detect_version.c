static int buffered_detect_version(const unsigned char *pd)
{
    const struct logger_entry     *log_entry;
    const struct logger_entry_v2  *log_entry_v2;
    int                      version;
    const unsigned char           *msg_payload = NULL;
    unsigned char                 *msg_part;
    unsigned char                 *msg_end;
    unsigned short                 msg_len;
    log_entry    = (const struct logger_entry *)(const void *) pd;
    log_entry_v2 = (const struct logger_entry_v2 *)(const void *) pd;
    if (log_entry->len < 3)
        return -1;
    for (version = 1; version <= 2; ++version) {
        if (version == 1) {
            msg_payload = (const unsigned char *) (log_entry + 1);
        } else if (version == 2) {
            msg_payload = (const unsigned char *) (log_entry_v2 + 1);
            if (log_entry_v2->hdr_size != sizeof(*log_entry_v2))
                continue;
        }
        if (get_priority(msg_payload[0]) == '?')
            continue;
        msg_part = (unsigned char *) memchr(msg_payload, '\0', log_entry->len - 1);
        if (msg_part == NULL)
            continue;
        ++msg_part;
        msg_len = (unsigned short)(log_entry->len - (msg_part - msg_payload));
        msg_end = (unsigned char *) memchr(msg_part, '\0', msg_len);
        if (msg_end && (msg_payload + log_entry->len - 1 != msg_end))
            continue;
        return version;
    }
    return -1;
}
