ice_read_flat_nvm(struct ice_hw *hw, unsigned int offset, unsigned int *length, unsigned char *data,
		  bool read_shadow_ram)
{
	unsigned int inlen = *length;
	unsigned int bytes_read = 0;
	bool last_cmd;
	int status;
	*length = 0;
	if (read_shadow_ram && ((offset + inlen) > (hw->flash.sr_words * 2u))) {
		ice_debug(hw, ICE_DBG_NVM, "NVM error: requested offset is beyond Shadow RAM limit\n");
		return -EINVAL;
	}
	int read_size, sector_offset;
		sector_offset = offset % ICE_AQ_MAX_BUF_LEN;
		read_size = min_t(unsigned int, ICE_AQ_MAX_BUF_LEN - sector_offset,
				  inlen - bytes_read);
		last_cmd = !(bytes_read + read_size < inlen);
		status = ice_aq_read_nvm(hw, ICE_AQC_NVM_START_POINT,
					 offset, read_size,
					 data + bytes_read, last_cmd,
					 read_shadow_ram, NULL);
		if (status)
			break;
		bytes_read += read_size;
		offset += read_size;
	} while (!last_cmd);
