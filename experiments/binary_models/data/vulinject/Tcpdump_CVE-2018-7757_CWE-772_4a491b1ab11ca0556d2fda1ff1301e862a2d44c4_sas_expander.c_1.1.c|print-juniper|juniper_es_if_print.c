juniper_es_if_print(netdissect_options *ndo,
                    const struct pcap_pkthdr *h, const u_char *p)
{
        struct juniper_l2info_t l2info;
        struct juniper_ipsec_header {
            nd_uint16_t sa_index;
            nd_uint8_t  ttl;
            nd_uint8_t  type;
            nd_uint32_t spi;
            nd_ipv4     src_ip;
            nd_ipv4     dst_ip;
        };
        u_int rewrite_len,es_type_bundle;
        const struct juniper_ipsec_header *ih;
        ndo->ndo_protocol = "juniper_es";
        memset(&l2info, 0, sizeof(l2info));
        l2info.pictype = DLT_JUNIPER_ES;
        if (juniper_parse_header(ndo, p, h, &l2info) == 0) {
            ndo->ndo_ll_hdr_len += l2info.header_len;
            return;
        }
        p+=l2info.header_len;
        ih = (const struct juniper_ipsec_header *)p;
        switch (GET_U_1(ih->type)) {
        case JUNIPER_IPSEC_O_ESP_ENCRYPT_ESP_AUTHEN_TYPE:
        case JUNIPER_IPSEC_O_ESP_ENCRYPT_AH_AUTHEN_TYPE:
            rewrite_len = 0;
            es_type_bundle = 1;
            break;
        case JUNIPER_IPSEC_O_ESP_AUTHENTICATION_TYPE:
        case JUNIPER_IPSEC_O_AH_AUTHENTICATION_TYPE:
        case JUNIPER_IPSEC_O_ESP_ENCRYPTION_TYPE:
            rewrite_len = 16;
            es_type_bundle = 0;
            break;
        default:
            ND_PRINT("ES Invalid type %u, length %u",
                   GET_U_1(ih->type),
                   l2info.length);
            ndo->ndo_ll_hdr_len += l2info.header_len;
            return;
        }
        l2info.length-=rewrite_len;
        p+=rewrite_len;
        if (ndo->ndo_eflag) {
            if (!es_type_bundle) {
                ND_PRINT("ES SA, index %u, ttl %u type %s (%u), spi %u, Tunnel %s > %s, length %u\n",
                       GET_BE_U_2(ih->sa_index),
                       GET_U_1(ih->ttl),
                       tok2str(juniper_ipsec_type_values,"Unknown",GET_U_1(ih->type)),
                       GET_U_1(ih->type),
                       GET_BE_U_4(ih->spi),
                       GET_IPADDR_STRING(ih->src_ip),
                       GET_IPADDR_STRING(ih->dst_ip),
                       l2info.length);
            } else {
                ND_PRINT("ES SA, index %u, ttl %u type %s (%u), length %u\n",
                       GET_BE_U_2(ih->sa_index),
                       GET_U_1(ih->ttl),
                       tok2str(juniper_ipsec_type_values,"Unknown",GET_U_1(ih->type)),
                       GET_U_1(ih->type),
                       l2info.length);
            }
        }
        ip_print(ndo, p, l2info.length);
        ndo->ndo_ll_hdr_len += l2info.header_len;
}
