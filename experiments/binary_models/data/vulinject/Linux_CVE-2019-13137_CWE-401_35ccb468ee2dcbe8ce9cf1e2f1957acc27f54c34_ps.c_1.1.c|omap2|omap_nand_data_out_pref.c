static void omap_nand_data_out_pref(struct nand_chip *chip,
				    const void *buf, unsigned int len,
				    bool force_8bit)
{
	struct omap_nand_info *info = mtd_to_omap(nand_to_mtd(chip));
	unsigned int w_count = 0;
	int i = 0, ret = 0;
	unsigned short *p = (unsigned short *)buf;
	unsigned int tim, limit;
	unsigned int val;
	if (force_8bit) {
		omap_nand_data_out(chip, buf, len, force_8bit);
		return;
	}
	if (len % 2 != 0) {
		writeb(*(unsigned char *)buf, info->fifo);
		p = (unsigned short *)(buf + 1);
		len--;
	}
	ret = omap_prefetch_enable(info->gpmc_cs,
			PREFETCH_FIFOTHRESHOLD_MAX, 0x0, len, 0x1, info);
	if (ret) {
		omap_nand_data_out(chip, buf, len, false);
	} else {
		while (len) {
			w_count = readl(info->reg.gpmc_prefetch_status);
			w_count = w_count >> 1;
			for (i = 0; (i < w_count) && len; i++, len -= 2)
				iowrite16(*p++, info->fifo);
		}
		tim = 0;
		limit = (loops_per_jiffy *
					msecs_to_jiffies(OMAP_NAND_TIMEOUT_MS));
		do {
			cpu_relax();
			val = readl(info->reg.gpmc_prefetch_status);
			val = PREFETCH_STATUS_COUNT(val);
		} while (val && (tim++ < limit));
		omap_prefetch_reset(info->gpmc_cs, info);
	}
}
