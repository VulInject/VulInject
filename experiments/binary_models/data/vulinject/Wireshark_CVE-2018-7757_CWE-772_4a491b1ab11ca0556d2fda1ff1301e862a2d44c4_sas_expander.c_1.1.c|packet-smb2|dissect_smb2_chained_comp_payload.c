dissect_smb2_chained_comp_payload(packet_info *pinfo, proto_tree *tree,
				  tvbuff_t *tvb, int offset,
				  wmem_array_t *out,
				  gboolean *ok)
{
	proto_tree *subtree;
	proto_item *subitem;
	guint alg, length, flags, orig_size = 0;
	tvbuff_t *uncomp_tvb = NULL;
	gboolean lz_based = FALSE;
	*ok = TRUE;
	subtree = proto_tree_add_subtree_format(tree, tvb, offset, 0, ett_smb2_comp_payload, &subitem, "COMPRESSION_PAYLOAD_HEADER");
	proto_tree_add_item_ret_uint(subtree, hf_smb2_comp_transform_comp_alg, tvb, offset, 2, ENC_LITTLE_ENDIAN, &alg);
	offset += 2;
	proto_tree_add_item_ret_uint(subtree, hf_smb2_comp_transform_flags, tvb, offset, 2, ENC_LITTLE_ENDIAN, &flags);
	offset += 2;
	proto_tree_add_item_ret_uint(subtree, hf_smb2_comp_transform_length, tvb, offset, 4, ENC_LITTLE_ENDIAN, &length);
	offset += 4;
	proto_item_set_len(subitem, length);
	lz_based = (SMB2_COMP_ALG_LZNT1 <= alg && alg <= SMB2_COMP_ALG_LZ77HUFF);
	if (lz_based) {
		proto_tree_add_item_ret_uint(subtree, hf_smb2_comp_transform_orig_payload_size,
					     tvb, offset, 4, ENC_LITTLE_ENDIAN, &orig_size);
		offset += 4;
		length -= 4;
	}
	if (length > MAX_UNCOMPRESSED_SIZE) {
		col_append_str(pinfo->cinfo, COL_INFO, "Comp. SMB3 (invalid)");
		*ok = FALSE;
		goto out;
	}
	switch (alg) {
	case SMB2_COMP_ALG_NONE:
		append_uncompress_data(out, tvb, offset, length);
		break;
	case SMB2_COMP_ALG_LZ77:
		uncomp_tvb = tvb_uncompress_lz77(tvb, offset, length);
		break;
	case SMB2_COMP_ALG_LZ77HUFF:
		uncomp_tvb = tvb_uncompress_lz77huff(tvb, offset, length);
		break;
	case SMB2_COMP_ALG_LZNT1:
		uncomp_tvb = tvb_uncompress_lznt1(tvb, offset, length);
		break;
	case SMB2_COMP_ALG_PATTERN_V1:
		dissect_smb2_compression_pattern_v1(subtree, tvb, offset, length, out);
		break;
	default:
		col_append_str(pinfo->cinfo, COL_INFO, "Comp. SMB3 (unknown)");
		uncomp_tvb = NULL;
		break;
	}
	if (lz_based) {
		if (!uncomp_tvb || tvb_reported_length(uncomp_tvb) != orig_size) {
			col_append_str(pinfo->cinfo, COL_INFO, "Comp. SMB3 (invalid)");
			*ok = FALSE;
			goto out;
		}
		append_uncompress_data(out, uncomp_tvb, 0, tvb_reported_length(uncomp_tvb));
	}
 out:
	if (uncomp_tvb)
	proto_tree_add_item(subtree, hf_smb2_comp_transform_data, tvb, offset, length, ENC_NA);
	offset += length;
	return offset;
}
