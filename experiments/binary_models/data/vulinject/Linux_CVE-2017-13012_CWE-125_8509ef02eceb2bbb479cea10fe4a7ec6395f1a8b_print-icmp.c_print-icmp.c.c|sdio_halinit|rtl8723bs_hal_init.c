static unsigned int rtl8723bs_hal_init(struct adapter *padapter)
{
	int ret;
	struct hal_com_data *pHalData;
	struct pwrctrl_priv *pwrctrlpriv;
	unsigned int NavUpper = WiFiNavUpperUs;
	unsigned char u1bTmp;
	pHalData = GET_HAL_DATA(padapter);
	pwrctrlpriv = adapter_to_pwrctl(padapter);
	if (
		adapter_to_pwrctl(padapter)->bips_processing == true &&
		adapter_to_pwrctl(padapter)->pre_ips_type == 0
	) {
		unsigned int start_time;
		unsigned char cpwm_orig, cpwm_now;
		unsigned char val8, bMacPwrCtrlOn = true;
		cpwm_orig = 0;
		rtw_hal_get_hwreg(padapter, HW_VAR_CPWM, &cpwm_orig);
		val8 = rtw_read8(padapter, SDIO_LOCAL_BASE | SDIO_REG_HRPWM1);
		val8 &= 0x80;
		val8 += 0x80;
		val8 |= BIT(6);
		rtw_write8(padapter, SDIO_LOCAL_BASE | SDIO_REG_HRPWM1, val8);
		adapter_to_pwrctl(padapter)->tog = (val8 + 0x80) & 0x80;
		start_time = jiffies;
		do {
			mdelay(1);
			rtw_hal_get_hwreg(padapter, HW_VAR_CPWM, &cpwm_now);
			if ((cpwm_orig ^ cpwm_now) & 0x80)
				break;
			if (jiffies_to_msecs(jiffies - start_time) > 100)
				break;
		} while (1);
		rtl8723b_set_FwPwrModeInIPS_cmd(padapter, 0);
		rtw_hal_set_hwreg(padapter, HW_VAR_APFM_ON_MAC, &bMacPwrCtrlOn);
		hal_btcoex_InitHwConfig(padapter, false);
		return _SUCCESS;
	}
	ret = _InitPowerOn_8723BS(padapter);
	if (ret == _FAIL)
		return _FAIL;
	rtw_write8(padapter, REG_EARLY_MODE_CONTROL, 0);
	ret = rtl8723b_FirmwareDownload(padapter, false);
	if (ret != _SUCCESS) {
		padapter->bFWReady = false;
		pHalData->fw_ractrl = false;
		return ret;
	} else {
		padapter->bFWReady = true;
		pHalData->fw_ractrl = true;
	}
	rtl8723b_InitializeFirmwareVars(padapter);
	if (pwrctrlpriv->reg_rfoff)
		pwrctrlpriv->rf_pwrstate = rf_off;
	HalDetectPwrDownMode(padapter);
	_InitRFType(padapter);
	pHalData->CurrentChannel = 6;
	ret = PHY_MACConfig8723B(padapter);
	if (ret != _SUCCESS)
		return ret;
	ret = PHY_BBConfig8723B(padapter);
	if (ret != _SUCCESS)
		return ret;
	{
		ret = PHY_RFConfig8723B(padapter);
		if (ret != _SUCCESS)
			return ret;
	}
	pHalData->RfRegChnlVal[0] =
		PHY_QueryRFReg(padapter, (enum rf_path)0, RF_CHNLBW, bRFRegOffsetMask);
	pHalData->RfRegChnlVal[1] =
		PHY_QueryRFReg(padapter, (enum rf_path)1, RF_CHNLBW, bRFRegOffsetMask);
	_InitQueueReservedPage(padapter);
	_InitTxBufferBoundary(padapter);
	ret = rtl8723b_InitLLTTable(padapter);
	if (ret != _SUCCESS)
		return _FAIL;
	_InitQueuePriority(padapter);
	_InitPageBoundary(padapter);
	_InitTransferPageSize(padapter);
	_InitDriverInfoSize(padapter, DRVINFO_SZ);
	hal_init_macaddr(padapter);
	_InitNetworkType(padapter);
	_InitWMACSetting(padapter);
	_InitAdaptiveCtrl(padapter);
	_InitEDCA(padapter);
	_InitRetryFunction(padapter);
	_initSdioAggregationSetting(padapter);
	_InitOperationMode(padapter);
	rtl8723b_InitBeaconParameters(padapter);
	_InitInterrupt(padapter);
	_InitBurstPktLen_8723BS(padapter);
	rtw_write8(padapter, REG_SECONDARY_CCA_CTRL_8723B, 0x3);	
	rtw_write8(padapter, 0x976, 0);	
	rtw_write16(padapter, REG_PKT_VO_VI_LIFE_TIME, 0x0400);	
	rtw_write16(padapter, REG_PKT_BE_BK_LIFE_TIME, 0x0400);	
	invalidate_cam_all(padapter);
	rtw_hal_set_chnl_bw(padapter, padapter->registrypriv.channel,
		CHANNEL_WIDTH_20, HAL_PRIME_CHNL_OFFSET_DONT_CARE, HAL_PRIME_CHNL_OFFSET_DONT_CARE);
	rtl8723b_InitAntenna_Selection(padapter);
	rtw_write32(padapter, REG_BAR_MODE_CTRL, 0x0201ffff);
	rtw_write8(padapter, REG_HWSEQ_CTRL, 0xFF);
	rtw_write32(padapter, SDIO_LOCAL_BASE | SDIO_REG_TX_CTRL, 0);
	_RfPowerSave(padapter);
	rtl8723b_InitHalDm(padapter);
	HalQueryTxBufferStatus8723BSdio(padapter);
	HalQueryTxOQTBufferStatus8723BSdio(padapter);
	pHalData->SdioTxOQTMaxFreeSpace = pHalData->SdioTxOQTFreeSpace;
	u1bTmp = rtw_read8(padapter, REG_CR);
	u1bTmp |= (MACTXEN | MACRXEN);
	rtw_write8(padapter, REG_CR, u1bTmp);
	rtw_hal_set_hwreg(padapter, HW_VAR_NAV_UPPER, (unsigned char *)&NavUpper);
	rtw_write32(padapter, REG_FWHW_TXQ_CTRL, rtw_read32(padapter, REG_FWHW_TXQ_CTRL) | BIT(12));
	{
		pwrctrlpriv->rf_pwrstate = rf_on;
		if (pwrctrlpriv->rf_pwrstate == rf_on) {
			struct pwrctrl_priv *pwrpriv;
			unsigned int start_time;
			unsigned char restore_iqk_rst;
			unsigned char b2Ant;
			unsigned char h2cCmdBuf;
			pwrpriv = adapter_to_pwrctl(padapter);
			h2cCmdBuf = 1;
			FillH2CCmd8723B(padapter, H2C_8723B_BT_WLAN_CALIBRATION, 1, &h2cCmdBuf);
			start_time = jiffies;
			do {
				if (rtw_read8(padapter, 0x1e7) & 0x01)
					break;
				msleep(50);
			} while (jiffies_to_msecs(jiffies - start_time) <= 400);
			hal_btcoex_IQKNotify(padapter, true);
			restore_iqk_rst = pwrpriv->bips_processing;
			b2Ant = pHalData->EEPROMBluetoothAntNum == Ant_x2;
			PHY_IQCalibrate_8723B(padapter, false, restore_iqk_rst, b2Ant, pHalData->ant_path);
			pHalData->odmpriv.RFCalibrateInfo.bIQKInitialized = true;
			hal_btcoex_IQKNotify(padapter, false);
			h2cCmdBuf = 0;
			FillH2CCmd8723B(padapter, H2C_8723B_BT_WLAN_CALIBRATION, 1, &h2cCmdBuf);
			ODM_TXPowerTrackingCheck(&pHalData->odmpriv);
		}
	}
	hal_btcoex_InitHwConfig(padapter, false);
	return _SUCCESS;
}
