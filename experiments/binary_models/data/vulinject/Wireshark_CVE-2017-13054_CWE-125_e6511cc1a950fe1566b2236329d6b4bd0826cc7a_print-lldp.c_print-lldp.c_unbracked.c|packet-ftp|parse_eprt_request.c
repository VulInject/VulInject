parse_eprt_request(tvbuff_t *tvb, int offset, gint linelen, guint32 *eprt_af,
        guint32 *eprt_ip, guint16 *eprt_ipv6, guint16 *ftp_port,
        guint32 *eprt_ip_len, guint32 *ftp_port_len)
{
    gint      delimiters_seen = 0;
    gchar     delimiter;
    gint      fieldlen;
    gchar    *field;
    gint      n;
    gint      lastn;
    char     *args, *p;
    gboolean  ret = TRUE;
    args = wmem_alloc(wmem_packet_scope(), linelen + 1);
    tvb_get_raw_bytes_as_string(tvb, offset, args, linelen + 1);
    p = args;
    if ((gint)strlen(args) < linelen)
        linelen = (gint)strlen(args);
    if (!isvalid_rfc2428_delimiter(*p))
        return FALSE;  
    delimiter = *p;
    for (n = 0; n < linelen; n++) {
        if (*(p+n) == delimiter)
            delimiters_seen++;
    }
    if (delimiters_seen != 4)
        return FALSE; 
    delimiters_seen = 1;
    lastn = 0;
    for (n=1; n < linelen; n++) {
        if (*(p+n) != delimiter)
            continue;
        delimiters_seen++;
        fieldlen = n - lastn - 1;
        if (fieldlen<=0)
            return FALSE; 
        field =  p + lastn + 1;
        if (delimiters_seen == 2) {     
            gchar *af_str;
            af_str = wmem_strndup(wmem_packet_scope(), field, fieldlen);
            if (!ws_strtou32(af_str, NULL, eprt_af))
                return FALSE;
        }
        else if (delimiters_seen == 3) {
            gchar *ip_str;
            ip_str = wmem_strndup(wmem_packet_scope(), field, fieldlen);
            if (*eprt_af == EPRT_AF_IPv4) {
                if (str_to_ip(ip_str, eprt_ip))
                   ret = TRUE;
                else
                   ret = FALSE;
            }
            else if (*eprt_af == EPRT_AF_IPv6) {
                if (str_to_ip6(ip_str, eprt_ipv6))
                   ret = TRUE;
                else
                   ret = FALSE;
            }
            else
                return FALSE; 
            *eprt_ip_len = fieldlen;
        }
        else if (delimiters_seen == 4) {
            gchar *pt_str;
            pt_str = wmem_strndup(wmem_packet_scope(), field, fieldlen);
            if (!ws_strtou16(pt_str, NULL, ftp_port))
                return FALSE;
            *ftp_port_len = fieldlen;
        }
        lastn = n;
    }
    return ret;
}
