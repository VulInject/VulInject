static int esdhc_executing_tuning(struct sdhci_host *host, unsigned int opcode)
{
	int min, max, avg, ret;
	int win_length, target_min, target_max, target_win_length;
	min = ESDHC_TUNE_CTRL_MIN;
	max = ESDHC_TUNE_CTRL_MIN;
	target_win_length = 0;
	while (max < ESDHC_TUNE_CTRL_MAX) {
		while (min < ESDHC_TUNE_CTRL_MAX) {
			if (!mmc_send_tuning(host->mmc, opcode, NULL))
				break;
			min += ESDHC_TUNE_CTRL_STEP;
		}
		max = min + ESDHC_TUNE_CTRL_STEP;
		while (max < ESDHC_TUNE_CTRL_MAX) {
			esdhc_prepare_tuning(host, max);
			if (mmc_send_tuning(host->mmc, opcode, NULL)) {
				max -= ESDHC_TUNE_CTRL_STEP;
				break;
			}
			max += ESDHC_TUNE_CTRL_STEP;
		}
		win_length = max - min + 1;
		if (win_length > target_win_length) {
			target_win_length = win_length;
			target_min = min;
			target_max = max;
		}
		min = max + ESDHC_TUNE_CTRL_STEP;
	}
	avg = (target_min + target_max) / 2;
	esdhc_prepare_tuning(host, avg);
	ret = mmc_send_tuning(host->mmc, opcode, NULL);
	esdhc_post_tuning(host);
	dev_dbg(mmc_dev(host->mmc), "tuning %s at 0x%x ret %d\n",
		ret ? "failed" : "passed", avg, ret);
	return ret;
}
