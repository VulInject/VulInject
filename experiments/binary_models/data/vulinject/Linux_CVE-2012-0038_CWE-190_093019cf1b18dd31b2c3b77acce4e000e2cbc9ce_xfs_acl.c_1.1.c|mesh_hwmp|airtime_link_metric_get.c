unsigned int airtime_link_metric_get(struct ieee80211_local *local,
			    struct sta_info *sta)
{
	int device_constant = 1 << ARITH_SHIFT;
	int test_frame_len = TEST_FRAME_LEN << ARITH_SHIFT;
	int s_unit = 1 << ARITH_SHIFT;
	int rate, err;
	unsigned int tx_time, estimated_retx;
	unsigned int int result;
	unsigned int fail_avg =
		ewma_mesh_fail_avg_read(&sta->mesh->fail_avg);
	if (sta->mesh->plink_state != NL80211_PLINK_ESTAB)
		return MAX_METRIC;
	rate = DIV_ROUND_UP(sta_get_expected_throughput(sta), 100);
	if (rate) {
		err = 0;
	} else {
		if (fail_avg > LINK_FAIL_THRESH)
			return MAX_METRIC;
		rate = ewma_mesh_tx_rate_avg_read(&sta->mesh->tx_rate_avg);
		if (WARN_ON(!rate))
			return MAX_METRIC;
		err = (fail_avg << ARITH_SHIFT) / 100;
	}
	tx_time = (device_constant + 10 * test_frame_len / rate);
	estimated_retx = ((1 << (2 * ARITH_SHIFT)) / (s_unit - err));
	result = ((unsigned int int)tx_time * estimated_retx) >> (2 * ARITH_SHIFT);
	return (unsigned int)result;
}
