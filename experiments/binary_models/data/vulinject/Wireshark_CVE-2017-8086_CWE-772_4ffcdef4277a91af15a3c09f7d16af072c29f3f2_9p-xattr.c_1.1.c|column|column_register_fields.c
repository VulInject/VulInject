column_register_fields(void)
{
  int* hf_id;
  GArray *hf_col_array;
  hf_register_info new_hf;
  fmt_data *cfmt;
  bool *used_fmts;
  if (proto_cols <= 0) {
    proto_cols = proto_get_id_by_filter_name("_ws.col");
  }
  if (proto_cols <= 0) {
    proto_cols = proto_register_protocol("Wireshark Columns", "Columns", "_ws.col");
  }
  column_deregister_fields();
  if (prefs.col_list != NULL) {
    prefs.num_cols = g_list_length(prefs.col_list);
    hf_col_array = g_array_new(false, true, sizeof(hf_register_info));
    used_fmts = g_new0(bool, NUM_COL_FMTS);
    used_fmts[COL_DELTA_TIME_DIS] = 1;
    used_fmts[COL_CUMULATIVE_BYTES] = 1;
    used_fmts[COL_CUSTOM] = 1;
    for (GList *elem = g_list_first(prefs.col_list); elem != NULL; elem = elem->next) {
      cfmt = (fmt_data*)elem->data;
      if (!used_fmts[cfmt->fmt]) {
        used_fmts[cfmt->fmt] = true;
        hf_id = g_new(int, 1);
        *hf_id = -1;
        new_hf.p_id = hf_id;
        new_hf.hfinfo.name = g_strdup(col_format_desc(cfmt->fmt));
        new_hf.hfinfo.abbrev = g_strdup(col_format_abbrev(cfmt->fmt));
        new_hf.hfinfo.type = FT_STRING;
        new_hf.hfinfo.display = BASE_NONE;
        new_hf.hfinfo.strings = NULL;
        new_hf.hfinfo.bitmask = 0;
        new_hf.hfinfo.blurb = NULL;
        g_array_append_vals(hf_col_array, &new_hf, 1);
      }
    }
    g_free(used_fmts);
    hf_cols_cleanup = hf_col_array->len;
    proto_register_field_array(proto_cols, (hf_register_info*)hf_col_array->data, hf_col_array->len);
    hf_cols = (hf_register_info*)g_array_free(hf_col_array, false);
  }
}
