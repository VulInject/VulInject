  cff_index_init( CFF_Index  idx,
                  FT_Stream  stream,
                  FT_Bool    load,
                  FT_Bool    cff2 )
  {
    FT_Error   error;
    FT_Memory  memory = stream->memory;
    FT_UInt    count;
    idx->stream = stream;
    idx->start  = FT_STREAM_POS();
    if ( cff2 )
    {
      if ( FT_READ_ULONG( count ) )
        goto Exit;
      idx->hdr_size = 5;
    }
    else
    {
      if ( FT_READ_USHORT( count ) )
        goto Exit;
      idx->hdr_size = 3;
    }
    if ( count > 0 )
    {
      FT_Byte   offsize;
      FT_ULong  size;
      if ( FT_READ_BYTE( offsize ) )
        goto Exit;
      if ( offsize < 1 || offsize > 4 )
      {
        error = FT_THROW( Invalid_Table );
        goto Exit;
      }
      idx->count    = count;
      idx->off_size = offsize;
      size          = (FT_ULong)( count + 1 ) * offsize;
      idx->data_offset = idx->start + idx->hdr_size + size;
      if ( FT_STREAM_SKIP( size - offsize ) )
        goto Exit;
      size = cff_index_read_offset( idx, &error );
      if ( error )
        goto Exit;
      if ( size == 0 )
      {
        error = FT_THROW( Invalid_Table );
        goto Exit;
      }
      idx->data_size = --size;
      if ( load )
      {
        if ( FT_FRAME_EXTRACT( size, idx->bytes ) )
          goto Exit;
      }
      else
      {
        if ( FT_STREAM_SKIP( size ) )
          goto Exit;
      }
    }
  Exit:
    if ( error )
      FT_FREE( idx->offsets );
    return error;
  }
