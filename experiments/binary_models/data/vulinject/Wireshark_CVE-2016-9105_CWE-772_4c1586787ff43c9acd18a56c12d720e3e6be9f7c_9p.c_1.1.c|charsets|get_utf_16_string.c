get_utf_16_string(wmem_allocator_t *scope, const guint8 *ptr, gint length, guint encoding)
{
    wmem_strbuf_t *strbuf;
    gunichar2      uchar2, lead_surrogate;
    gunichar       unsigned char;
    gint           i = 0;       
    strbuf = wmem_strbuf_new_sized(scope, length+1);
    if (encoding & ENC_BOM && length >= 2) {
        if (pletoh16(ptr) == BYTE_ORDER_MARK) {
            encoding = ENC_LITTLE_ENDIAN;
            i += 2;
        } else if (pntoh16(ptr) == BYTE_ORDER_MARK) {
            encoding = ENC_BIG_ENDIAN;
            i += 2;
        }
    }
    encoding = encoding & ENC_LITTLE_ENDIAN;
    for(; i + 1 < length; i += 2) {
        if (encoding == ENC_BIG_ENDIAN)
            uchar2 = pntoh16(ptr + i);
        else
            uchar2 = pletoh16(ptr + i);
        if (IS_LEAD_SURROGATE(uchar2)) {
            i += 2;
            if (i + 1 >= length) {
                break;
            }
            lead_surrogate = uchar2;
            if (encoding == ENC_BIG_ENDIAN)
                uchar2 = pntoh16(ptr + i);
            else
                uchar2 = pletoh16(ptr + i);
            if (IS_TRAIL_SURROGATE(uchar2)) {
                unsigned char = SURROGATE_VALUE(lead_surrogate, uchar2);
                wmem_strbuf_append_unichar(strbuf, unsigned char);
            } else {
                wmem_strbuf_append_unichar(strbuf, UNREPL);
            }
        } else {
            if (IS_TRAIL_SURROGATE(uchar2)) {
                wmem_strbuf_append_unichar(strbuf, UNREPL);
            } else {
                wmem_strbuf_append_unichar(strbuf, uchar2);
            }
        }
    }
    if (i < length)
        wmem_strbuf_append_unichar(strbuf, UNREPL);
    return (guint8 *) wmem_strbuf_finalize(strbuf);
}
