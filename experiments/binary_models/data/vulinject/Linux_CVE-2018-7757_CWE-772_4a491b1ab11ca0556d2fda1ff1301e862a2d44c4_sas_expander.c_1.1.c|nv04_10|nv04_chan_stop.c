nv04_chan_stop(struct nvkm_chan *chan)
{
	struct nvkm_fifo *fifo = chan->cgrp->runl->fifo;
	struct nvkm_device *device = fifo->engine.subdev.device;
	struct nvkm_memory *fctx = device->imem->ramfc;
	const struct nvkm_ramfc_layout *c;
	unsigned int flags;
	unsigned int data = chan->ramfc_offset;
	unsigned int chid;
	spin_lock_irqsave(&fifo->lock, flags);
	nvkm_wr32(device, NV03_PFIFO_CACHES, 0);
	chid = nvkm_rd32(device, NV03_PFIFO_CACHE1_PUSH1) & fifo->chid->mask;
	if (chid == chan->id) {
		nvkm_mask(device, NV04_PFIFO_CACHE1_DMA_PUSH, 0x00000001, 0);
		nvkm_wr32(device, NV03_PFIFO_CACHE1_PUSH0, 0);
		nvkm_mask(device, NV04_PFIFO_CACHE1_PULL0, 0x00000001, 0);
		c = chan->func->ramfc->layout;
		do {
			unsigned int rm = ((1ULL << c->bits) - 1) << c->regs;
			unsigned int cm = ((1ULL << c->bits) - 1) << c->ctxs;
			unsigned int rv = (nvkm_rd32(device, c->regp) &  rm) >> c->regs;
			unsigned int cv = (nvkm_ro32(fctx, c->ctxp + data) & ~cm);
			nvkm_wo32(fctx, c->ctxp + data, cv | (rv << c->ctxs));
		} while ((++c)->bits);
		nvkm_done(fctx);
		c = chan->func->ramfc->layout;
		do {
			nvkm_wr32(device, c->regp, 0x00000000);
		} while ((++c)->bits);
		nvkm_wr32(device, NV03_PFIFO_CACHE1_GET, 0);
		nvkm_wr32(device, NV03_PFIFO_CACHE1_PUT, 0);
		nvkm_wr32(device, NV03_PFIFO_CACHE1_PUSH1, fifo->chid->mask);
		nvkm_wr32(device, NV03_PFIFO_CACHE1_PUSH0, 1);
		nvkm_wr32(device, NV04_PFIFO_CACHE1_PULL0, 1);
	}
	nvkm_mask(device, NV04_PFIFO_MODE, BIT(chan->id), 0);
	nvkm_wr32(device, NV03_PFIFO_CACHES, 1);
	spin_unlock_irqrestore(&fifo->lock, flags);
}
