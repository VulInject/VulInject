void ath6kl_disconnect_event(struct ath6kl_vif *vif, unsigned char reason, unsigned char *bssid,
			     unsigned char assoc_resp_len, unsigned char *assoc_info,
			     unsigned short prot_reason_status)
{
	struct ath6kl *ar = vif->ar;
	if (vif->nw_type == AP_NETWORK) {
		if (reason == BSS_DISCONNECTED &&
		    prot_reason_status == WMI_AP_REASON_STA_ROAM) {
			ar->want_ch_switch |= 1 << vif->fw_vif_idx;
			ar->last_ch = le16_to_cpu(vif->profile.ch);
		}
		if (prot_reason_status == WMI_AP_REASON_MAX_STA) {
			cfg80211_conn_failed(vif->ndev, bssid,
					     NL80211_CONN_FAIL_MAX_CLIENTS,
					     GFP_KERNEL);
		}
		if (prot_reason_status == WMI_AP_REASON_ACL) {
			cfg80211_conn_failed(vif->ndev, bssid,
					     NL80211_CONN_FAIL_BLOCKED_CLIENT,
					     GFP_KERNEL);
		}
		if (!ath6kl_remove_sta(ar, bssid, prot_reason_status))
			return;
		if (ar->sta_list_index == 0) {
			skb_queue_purge(&ar->mcastpsq);
			spin_unlock_bh(&ar->mcastpsq_lock);
			if (test_bit(WMI_READY, &ar->flag))
				ath6kl_wmi_set_pvb_cmd(ar->wmi, vif->fw_vif_idx,
						       MCAST_AID, 0);
		}
		if (!is_broadcast_ether_addr(bssid)) {
			cfg80211_del_sta(vif->ndev, bssid, GFP_KERNEL);
		}
		if (memcmp(vif->ndev->dev_addr, bssid, ETH_ALEN) == 0) {
			memset(vif->wep_key_list, 0, sizeof(vif->wep_key_list));
			clear_bit(CONNECTED, &vif->flags);
		}
		return;
	}
	ath6kl_cfg80211_disconnect_event(vif, reason, bssid,
					 assoc_resp_len, assoc_info,
					 prot_reason_status);
	aggr_reset_state(vif->aggr_cntxt->aggr_conn);
	del_timer(&vif->disconnect_timer);
	ath6kl_dbg(ATH6KL_DBG_WLAN_CFG, "disconnect reason is %d\n", reason);
	if (reason == DISCONNECT_CMD) {
		if (!ar->usr_bss_filter && test_bit(WMI_READY, &ar->flag))
			ath6kl_wmi_bssfilter_cmd(ar->wmi, vif->fw_vif_idx,
						 NONE_BSS_FILTER, 0);
	} else {
		set_bit(CONNECT_PEND, &vif->flags);
		if (((reason == ASSOC_FAILED) &&
		     (prot_reason_status == 0x11)) ||
		    ((reason == ASSOC_FAILED) && (prot_reason_status == 0x0) &&
		     (vif->reconnect_flag == 1))) {
			set_bit(CONNECTED, &vif->flags);
			return;
		}
	}
	ath6kl_check_ch_switch(ar, ar->last_ch);
	spin_lock_bh(&vif->if_lock);
	clear_bit(CONNECTED, &vif->flags);
	netif_carrier_off(vif->ndev);
	spin_unlock_bh(&vif->if_lock);
	if ((reason != CSERV_DISCONNECT) || (vif->reconnect_flag != 1))
		vif->reconnect_flag = 0;
	if (reason != CSERV_DISCONNECT)
		ar->user_key_ctrl = 0;
	netif_stop_queue(vif->ndev);
	memset(vif->bssid, 0, sizeof(vif->bssid));
	vif->bss_ch = 0;
	ath6kl_tx_data_cleanup(ar);
}
