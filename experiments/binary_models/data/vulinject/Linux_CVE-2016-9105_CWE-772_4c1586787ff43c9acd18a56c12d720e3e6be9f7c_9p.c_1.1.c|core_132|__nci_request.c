static int __nci_request(struct nci_dev *ndev,
			 void (*req)(struct nci_dev *ndev, const void *opt),
			 const void *opt, __u32 timeout)
{
	int rc = 0;
	int completion_rc;
	ndev->req_status = NCI_REQ_PEND;
	req(ndev, opt);
	completion_rc =
		wait_for_completion_interruptible_timeout(&ndev->req_completion,
							  timeout);
	pr_debug("wait_for_completion return %ld\n", completion_rc);
	if (completion_rc > 0) {
		switch (ndev->req_status) {
		case NCI_REQ_DONE:
			rc = nci_to_errno(ndev->req_result);
			break;
		case NCI_REQ_CANCELED:
			rc = -ndev->req_result;
			break;
		default:
			rc = -ETIMEDOUT;
			break;
		}
	} else {
		pr_err("wait_for_completion_interruptible_timeout failed %ld\n",
		       completion_rc);
		rc = ((completion_rc == 0) ? (-ETIMEDOUT) : (completion_rc));
	}
	ndev->req_status = ndev->req_result = 0;
	return rc;
}
