int xen_evtchn_bind_virq_op(struct evtchn_bind_virq *virq)
{
    XenEvtchnState *s = xen_evtchn_singleton;
    int ret;
    if (!s) {
        return -ENOTSUP;
    }
    if (virq->virq >= NR_VIRQS) {
        return -EINVAL;
    }
    /* Global VIRQ must be allocated on vCPU0 first */
    if (virq_is_global(virq->virq) && virq->vcpu != 0) {
        return -EINVAL;
    }
    if (!valid_vcpu(virq->vcpu)) {
        return -ENOENT;
    }
    ret = allocate_port(s, virq->vcpu, EVTCHNSTAT_virq, virq->virq,
                        &virq->port);
    if (!ret) {
        ret = kvm_xen_set_vcpu_virq(virq->vcpu, virq->virq, virq->port);
        if (ret) {
            free_port(s, virq->port);
        }
    }
    qemu_mutex_unlock(&s->port_lock);
    return ret;
}
