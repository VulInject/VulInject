static int dissect_edonkey_search_query(tvbuff_t *tvb, packet_info *pinfo,
                                        int offset, proto_tree *tree)
{
    proto_item *ti;
    proto_tree *search_tree;
    guint8 search_type, special_tagtype;
    guint16 tag_name_size, string_length;
    guint32 search_length;
    int string_offset, tag_name_offset;
    search_type = tvb_get_guint8(tvb, offset);
    search_length = 1;
    ti = proto_tree_add_uint(tree, hf_edonkey_search_type, tvb, offset, 1, search_type);
    switch (search_type)
    {
        case EDONKEY_SEARCH_BOOL:
            search_length += 1;
            proto_item_set_len(ti, search_length);
            search_tree = proto_item_add_subtree(ti, ett_edonkey_search);
            proto_tree_add_item(search_tree, hf_edonkey_search_ops, tvb, offset+1, 1, ENC_LITTLE_ENDIAN);
            offset+=2;
            offset = dissect_edonkey_search_query(tvb, pinfo, offset, search_tree);
            offset = dissect_edonkey_search_query(tvb, pinfo, offset, search_tree);
            break;
        case EDONKEY_SEARCH_NAME:
            string_offset = offset + search_length;
            string_length = tvb_get_letohs(tvb, string_offset);
            search_length += 2+string_length;
            proto_item_set_len(ti, search_length);
            search_tree = proto_item_add_subtree(ti, ett_edonkey_search);
            proto_tree_add_uint(search_tree, hf_edonkey_string_length, tvb, string_offset, 2, string_length);
            proto_tree_add_item(search_tree, hf_edonkey_string, tvb, string_offset+2, string_length, ENC_ASCII);
            offset += search_length;
            break;
        case EDONKEY_SEARCH_META:
            string_offset = offset + search_length;
            string_length = tvb_get_letohs(tvb, offset+1);
            search_length += 2+string_length;
            tag_name_offset = offset + search_length;
            tag_name_size = tvb_get_letohs(tvb, tag_name_offset);
            special_tagtype = tvb_get_guint8(tvb, tag_name_offset+2);
            search_length += 2 + tag_name_size;
            proto_item_set_len(ti, search_length);
            search_tree = proto_item_add_subtree(ti, ett_edonkey_search);
            proto_tree_add_uint(search_tree, hf_edonkey_string_length, tvb, string_offset, 2, string_length);
            proto_tree_add_item(search_tree, hf_edonkey_string, tvb, string_offset+2, string_length, ENC_ASCII);
            proto_tree_add_uint(search_tree, hf_edonkey_metatag_namesize, tvb, tag_name_offset, 2, tag_name_size);
            edonkey_tree_add_metatag_name(search_tree, tvb, tag_name_offset+2, tag_name_size, special_tagtype);
            offset += search_length;
            break;
        case EDONKEY_SEARCH_LIMIT:
            search_length += 5; 
            tag_name_offset = offset + search_length;
            tag_name_size = tvb_get_letohs(tvb, tag_name_offset);
            special_tagtype = tvb_get_guint8(tvb, tag_name_offset+2);
            search_length += 2 + tag_name_size;
            proto_item_set_len(ti, search_length);
            search_tree = proto_item_add_subtree(ti, ett_edonkey_search);
            proto_tree_add_item(search_tree, hf_edonkey_search_limit, tvb, offset+1, 4, ENC_LITTLE_ENDIAN);
            proto_tree_add_item(search_tree, hf_edonkey_search_limit_type, tvb, offset+5, 1, ENC_LITTLE_ENDIAN);
            proto_tree_add_uint(search_tree, hf_edonkey_metatag_namesize, tvb, tag_name_offset, 2, tag_name_size);
            edonkey_tree_add_metatag_name(search_tree, tvb, tag_name_offset+2, tag_name_size, special_tagtype);
            offset += search_length;
            break;
        default:
            proto_item_set_len(ti, search_length);
            offset += search_length;
            break;
    }
    decrement_dissection_depth(pinfo);
    return offset;
}
