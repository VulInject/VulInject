static int snd_hdac_bus_get_response_rirb(struct hdac_bus *bus,
					  unsigned int addr, unsigned int *res)
{
	unsigned int timeout;
	unsigned int loopcounter;
	wait_queue_entry_t wait;
	bool warned = false;
	init_wait_entry(&wait, 0);
	timeout = jiffies + msecs_to_jiffies(1000);
	for (loopcounter = 0;; loopcounter++) {
		spin_lock_irq(&bus->reg_lock);
		if (!bus->polling_mode)
			prepare_to_wait(&bus->rirb_wq, &wait,
					TASK_UNINTERRUPTIBLE);
		if (bus->polling_mode)
		if (!bus->rirb.cmds[addr]) {
			if (res)
				*res = bus->rirb.res[addr]; 
			if (!bus->polling_mode)
				finish_wait(&bus->rirb_wq, &wait);
			spin_unlock_irq(&bus->reg_lock);
			return 0;
		}
		spin_unlock_irq(&bus->reg_lock);
		if (time_after(jiffies, timeout))
			break;
#define LOOP_COUNT_MAX	3000
		if (!bus->polling_mode) {
			schedule_timeout(msecs_to_jiffies(2));
		} else if (bus->needs_damn_long_delay ||
			   loopcounter > LOOP_COUNT_MAX) {
			if (loopcounter > LOOP_COUNT_MAX && !warned) {
				dev_dbg_ratelimited(bus->dev,
						    "too slow response, last cmd=%#08x\n",
						    bus->last_cmd[addr]);
				warned = true;
			}
			msleep(2); 
		} else {
			udelay(10);
			cond_resched();
		}
	}
	if (!bus->polling_mode)
		finish_wait(&bus->rirb_wq, &wait);
	return -EIO;
}
