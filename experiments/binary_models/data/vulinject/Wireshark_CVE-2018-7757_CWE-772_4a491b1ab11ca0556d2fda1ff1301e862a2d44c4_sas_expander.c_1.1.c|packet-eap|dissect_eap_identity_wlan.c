dissect_eap_identity_wlan(tvbuff_t *tvb, packet_info* pinfo, proto_tree* tree, int offset, gint size)
{
  guint       mnc = 0;
  guint       mcc = 0;
  guint       mcc_mnc = 0;
  proto_tree* eap_identity_tree = NULL;
  guint8      eap_identity_prefix = 0;
  const gchar* eap_identity_value;
  guint8*     identity = NULL;
  gchar**     tokens = NULL;
  gchar**     realm_tokens = NULL;
  gchar**     cert_tokens = NULL;
  guint       ntokens = 0;
  guint       nrealm_tokens = 0;
  guint       ncert_tokens = 0;
  gboolean    ret = TRUE;
  gboolean    enc_imsi = FALSE;
  int         hf_eap_identity_mcc_mnc;
  proto_item* item;
  if (tvb_get_guint8(tvb, offset) == 0x00) {
    if (tvb_ascii_isprint(tvb, offset + 1, size - 1) == FALSE) {
      item = proto_tree_add_item(tree, hf_eap_identity, tvb, offset + 1, size - 1, ENC_ASCII || ENC_NA);
      expert_add_info(pinfo, item, &ei_eap_identity_nonascii);
      goto end;
    }
    identity = tvb_get_string_enc(pinfo->pool, tvb, offset + 1, size - 1, ENC_ASCII);
    tokens = g_strsplit_set(identity, ",", -1);
    enc_imsi = TRUE;
  } else {
    if (tvb_ascii_isprint(tvb, offset, size) == FALSE) {
      item = proto_tree_add_item(tree, hf_eap_identity, tvb, offset, size, ENC_ASCII || ENC_NA);
      expert_add_info(pinfo, item, &ei_eap_identity_nonascii);
      goto end;
    }
    identity = tvb_get_string_enc(pinfo->pool, tvb, offset, size, ENC_ASCII);
    tokens = g_strsplit_set(identity, "@", -1);
  }
  while(tokens[ntokens])
    ntokens++;
  if (enc_imsi) {
    if (ntokens < 2 || g_ascii_strncasecmp(tokens[1], "CertificateSerialNumber", 23)) {
      ret = FALSE;
      proto_tree_add_item(tree, hf_eap_identity, tvb, offset + 1, size - 1, ENC_ASCII);
      goto end;
    }
  } else {
    if (ntokens != 2) {
      ret = FALSE;
      proto_tree_add_item(tree, hf_eap_identity, tvb, offset, size, ENC_ASCII);
      goto end;
    }
    realm_tokens = g_strsplit_set(tokens[1], ".", -1);
    while(realm_tokens[nrealm_tokens])
      nrealm_tokens++;
    if (ntokens != 2 || nrealm_tokens != 5 || g_ascii_strncasecmp(realm_tokens[0], "wlan", 4) ||
        g_ascii_strncasecmp(realm_tokens[3], "3gppnetwork", 11) ||
        g_ascii_strncasecmp(realm_tokens[4], "org", 3)) {
      ret = FALSE;
      proto_tree_add_item(tree, hf_eap_identity, tvb, offset, size, ENC_ASCII);
      goto end;
    }
  }
  eap_identity_tree = proto_item_add_subtree(tree, ett_identity);
  proto_tree_add_item(eap_identity_tree, hf_eap_identity_prefix, tvb, offset, 1, ENC_NA);
  eap_identity_prefix = tvb_get_guint8(tvb, offset);
  eap_identity_value = try_val_to_str(eap_identity_prefix, eap_identity_prefix_vals);
  item = proto_tree_add_string(eap_identity_tree, hf_eap_identity_type,
    tvb, offset, 1, eap_identity_value ? eap_identity_value : "Unknown");
  switch(eap_identity_prefix) {
    case 0x00: 
      proto_tree_add_item(eap_identity_tree, hf_eap_identity_full, tvb, offset + 1, size - 1, ENC_ASCII || ENC_NA);
      proto_tree_add_item(eap_identity_tree, hf_eap_identity, tvb, offset + 1, (guint)strlen(tokens[0]), ENC_ASCII);
      break;
    case '0': 
    case '1': 
    case '6': 
      proto_tree_add_item(eap_identity_tree, hf_eap_identity_full, tvb, offset + 1, size - 1, ENC_ASCII || ENC_NA);
      dissect_e212_utf8_imsi(tvb, pinfo, eap_identity_tree, offset + 1, (guint)strlen(tokens[0]) - 1);
      break;
    case '2': 
    case '3': 
    case '7': 
      proto_tree_add_item(eap_identity_tree, hf_eap_identity_full, tvb, offset + 1, size - 1, ENC_ASCII || ENC_NA);
      proto_tree_add_item(eap_identity_tree, hf_eap_identity, tvb, offset + 1, (guint)strlen(tokens[0]) - 1, ENC_ASCII);
      break;
    case '4': 
    case '5': 
    case '8': 
      proto_tree_add_item(eap_identity_tree, hf_eap_identity_full, tvb, offset + 1, size - 1, ENC_ASCII || ENC_NA);
      proto_tree_add_item(eap_identity_tree, hf_eap_identity, tvb, offset + 1, (guint)strlen(tokens[0]) - 1, ENC_ASCII);
      break;
    case 'C': 
      proto_tree_add_item(eap_identity_tree, hf_eap_identity_full, tvb, offset + 1, size - 1, ENC_ASCII || ENC_NA);
      proto_tree_add_item(eap_identity_tree, hf_eap_identity, tvb, offset + 1, (guint)strlen(tokens[0]) - 1, ENC_ASCII);
      break;
    case 'a': 
      proto_tree_add_item(eap_identity_tree, hf_eap_identity_full, tvb, offset, size, ENC_ASCII || ENC_NA);
      proto_tree_add_item(eap_identity_tree, hf_eap_identity, tvb, offset, (guint)strlen(tokens[0]), ENC_ASCII);
      break;
    case 'G': 
    case 'I': 
    default:
      proto_tree_add_item(eap_identity_tree, hf_eap_identity_full, tvb, offset + 1, size - 1, ENC_ASCII || ENC_NA);
      proto_tree_add_item(eap_identity_tree, hf_eap_identity, tvb, offset + 1, (guint)strlen(tokens[0]) - 1, ENC_ASCII);
      expert_add_info(pinfo, item, &ei_eap_identity_invalid);
  }
  if (enc_imsi) {
    cert_tokens = g_strsplit_set(tokens[1], "=", -1);
    while(cert_tokens[ncert_tokens])
      ncert_tokens++;
    proto_tree_add_item(eap_identity_tree, hf_eap_identity_certificate_sn, tvb,
      offset + 1 + (guint)strlen(tokens[0]) + 1 + (guint)strlen("CertificateSerialNumber="),
      (guint)strlen(tokens[1]) - (guint)strlen("CertificateSerialNumber="), ENC_ASCII);
    if (ntokens != 3 || g_ascii_strncasecmp(tokens[2], "Realm", 5)) {
      goto end;
    }
    realm_tokens = g_strsplit_set(tokens[2], "@.", -1);
    while (realm_tokens[nrealm_tokens])
      nrealm_tokens++;
    if (nrealm_tokens != 5 || g_ascii_strncasecmp(realm_tokens[0], "wlan", 4) ||
        g_ascii_strncasecmp(realm_tokens[1], "mnc", 3) ||
        g_ascii_strncasecmp(realm_tokens[2], "mcc", 3) ||
        g_ascii_strncasecmp(realm_tokens[3], "3gppnetwork", 11) ||
        g_ascii_strncasecmp(realm_tokens[4], "org", 3)) {
      ret = FALSE;
      goto end;
    }
    if (!sscanf(realm_tokens[2] + 3, "%u", &mnc) || !sscanf(realm_tokens[3] + 3, "%u", &mcc)) {
      ret = FALSE;
      goto end;
    }
  } else {
    if (!sscanf(realm_tokens[1] + 3, "%u", &mnc) || !sscanf(realm_tokens[2] + 3, "%u", &mcc)) {
      ret = FALSE;
      goto end;
    }
  }
  if (!try_val_to_str_ext(mcc * 100 + mnc, &mcc_mnc_2digits_codes_ext)) {
    mcc_mnc = 1000 * mcc + mnc;
    hf_eap_identity_mcc_mnc = hf_eap_identity_mcc_mnc_3digits;
  } else {
    mcc_mnc = 100 * mcc + mnc;
    hf_eap_identity_mcc_mnc = hf_eap_identity_mcc_mnc_2digits;
  }
  if(realm_tokens[0] && realm_tokens[1] && realm_tokens[2] && realm_tokens[3]) {
    if (enc_imsi) {
      proto_tree_add_uint(eap_identity_tree, hf_eap_identity_mcc_mnc, tvb,
        offset + 1 + (guint)strlen(tokens[0]) + 1 + (guint)strlen(tokens[1]) + 1 +
        (guint)strlen("Realm=@wlan.mnc"), (guint)strlen(realm_tokens[2]) -
        (guint)strlen("mnc"), mcc_mnc);
      proto_tree_add_uint(eap_identity_tree, hf_eap_identity_mcc, tvb,
        offset + 1 + (guint)strlen(tokens[0]) + 1 + (guint)strlen(tokens[1]) + 1 +
        (guint)strlen(realm_tokens[0]) + (guint)strlen("@wlan.") +
        (guint)strlen(realm_tokens[2]) + (guint)strlen(".mcc"),
        (guint)strlen(realm_tokens[3]) - (guint)strlen("mcc"), mcc);
    } else {
      proto_tree_add_uint(eap_identity_tree, hf_eap_identity_mcc_mnc,
        tvb, offset + (guint)strlen(tokens[0]) + (guint)strlen("@wlan.") +
        (guint)strlen("mnc"), (guint)strlen(realm_tokens[1]) - (guint)strlen("mnc"),
        mcc_mnc);
      proto_tree_add_uint(eap_identity_tree, hf_eap_identity_mcc,
        tvb, offset + (guint)(strlen(tokens[0]) + (guint)strlen("@wlan.") +
        (guint)strlen(realm_tokens[1]) + 1 + strlen("mcc")),
        (guint)strlen(realm_tokens[2]) - (guint)strlen("mcc"), mcc);
    }
  }
end:
  g_strfreev(realm_tokens);
  g_strfreev(cert_tokens);
  return ret;
}
