il4965_rs_tl_add_packet(struct il_lq_sta *lq_data, struct ieee80211_hdr *hdr)
{
	unsigned int curr_time = jiffies_to_msecs(jiffies);
	unsigned int time_diff;
	int idx;
	struct il_traffic_load *tl = NULL;
	unsigned char tid;
	if (ieee80211_is_data_qos(hdr->frame_control)) {
		unsigned char *qc = ieee80211_get_qos_ctl(hdr);
		tid = qc[0] & 0xf;
	} else
		return MAX_TID_COUNT;
	if (unlikely(tid >= TID_MAX_LOAD_COUNT))
		return MAX_TID_COUNT;
	tl = &lq_data->load[tid];
	curr_time -= curr_time % TID_ROUND_VALUE;
	if (!(tl->queue_count)) {
		tl->total = 1;
		tl->time_stamp = curr_time;
		tl->queue_count = 1;
		tl->head = 0;
		tl->packet_count[0] = 1;
		return MAX_TID_COUNT;
	}
	time_diff = TIME_WRAP_AROUND(tl->time_stamp, curr_time);
	idx = time_diff / TID_QUEUE_CELL_SPACING;
	if (idx >= TID_QUEUE_MAX_SIZE)
	idx = (tl->head + idx) % TID_QUEUE_MAX_SIZE;
	tl->packet_count[idx] = tl->packet_count[idx] + 1;
	tl->total = tl->total + 1;
	if ((idx + 1) > tl->queue_count)
		tl->queue_count = idx + 1;
	return tid;
}
