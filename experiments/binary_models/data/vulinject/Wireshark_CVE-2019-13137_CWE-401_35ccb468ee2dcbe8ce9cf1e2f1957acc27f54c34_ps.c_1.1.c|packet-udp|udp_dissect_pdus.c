udp_dissect_pdus(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,
         guint fixed_len,  gboolean (*heuristic_check)(packet_info *, tvbuff_t *, int, void*),
         guint (*get_pdu_len)(packet_info *, tvbuff_t *, int, void*),
         dissector_t dissect_pdu, void* dissector_data)
{
    volatile int offset = 0;
    int offset_before;
    guint captured_length_remaining;
    volatile guint plen;
    guint length;
    tvbuff_t *next_tvb;
    proto_item *item=NULL;
    const char *saved_proto;
    guint8 curr_layer_num;
    wmem_list_frame_t *frame;
    while (tvb_reported_length_remaining(tvb, offset) > 0) {
        captured_length_remaining = tvb_ensure_captured_length_remaining(tvb, offset);
        if ((heuristic_check != NULL) &&
                ((*heuristic_check)(pinfo, tvb, offset, dissector_data) == FALSE)) {
            return offset;
         }
        plen = (*get_pdu_len)(pinfo, tvb, offset, dissector_data);
        if (plen == 0) {
            return offset;
         }
        if (plen < fixed_len) {
            show_reported_bounds_error(tvb, pinfo, tree);
            return offset;
        }
        curr_layer_num = pinfo->curr_layer_num-1;
        frame = wmem_list_frame_prev(wmem_list_tail(pinfo->layers));
        while (frame && (proto_udp != (gint) GPOINTER_TO_UINT(wmem_list_frame_data(frame)))) {
            curr_layer_num--;
        }
        item = proto_tree_add_uint((proto_tree *)p_get_proto_data(pinfo->pool, pinfo, proto_udp, curr_layer_num),
                                    hf_udp_pdu_size, tvb, offset, plen, plen);
        proto_item_set_generated(item);
        length = captured_length_remaining;
        if (length > plen)
            length = plen;
        next_tvb = tvb_new_subset_length_caplen(tvb, offset, length, plen);
        saved_proto = pinfo->current_proto;
        TRY {
            (*dissect_pdu)(next_tvb, pinfo, tree, dissector_data);
        }
        CATCH_NONFATAL_ERRORS {
            show_exception(tvb, pinfo, tree, EXCEPT_CODE, GET_MESSAGE);
            pinfo->current_proto = saved_proto;
        }
        ENDTRY;
        offset_before = offset;
        offset += plen;
        if (offset <= offset_before)
            break;
    }
    return offset;
}
