static void fimc_capture_try_selection(struct fimc_ctx *ctx,
				       struct v4l2_rect *r,
				       int target)
{
	bool rotate = ctx->rotation == 90 || ctx->rotation == 270;
	struct fimc_dev *fimc = ctx->fimc_dev;
	const struct fimc_variant *var = fimc->variant;
	const struct fimc_pix_limit *pl = var->pix_limit;
	const struct fimc_frame *sink = &ctx->s_frame;
	unsigned int max_w, max_h, min_w = 0, min_h = 0, min_sz;
	unsigned int align_sz = 0, align_h = 4;
	unsigned int max_sc_h, max_sc_v;
	if (fimc_fmt_is_user_defined(ctx->d_frame.fmt->color)) {
		r->width  = sink->f_width;
		r->height = sink->f_height;
		r->left   = r->top = 0;
		return;
	}
	if (target == V4L2_SEL_TGT_COMPOSE) {
		unsigned int tmp_min_h = ffs(sink->width) - 3;
		unsigned int tmp_min_v = ffs(sink->height) - 1;
		if (ctx->rotation != 90 && ctx->rotation != 270)
			align_h = 1;
		max_sc_h = min(SCALER_MAX_HRATIO, 1 << tmp_min_h);
		max_sc_v = min(SCALER_MAX_VRATIO, 1 << tmp_min_v);
		min_sz = var->min_out_pixsize;
	} else {
		unsigned int depth = fimc_get_format_depth(sink->fmt);
		align_sz = 64/ALIGN(depth, 8);
		min_sz = var->min_inp_pixsize;
		min_w = min_h = min_sz;
		max_sc_h = max_sc_v = 1;
	}
	max_w = min_t(unsigned int,
		      rotate ? pl->out_rot_en_w : pl->out_rot_dis_w,
		      rotate ? sink->f_height : sink->f_width);
	max_h = min_t(unsigned int, FIMC_CAMIF_MAX_HEIGHT, sink->f_height);
	if (target == V4L2_SEL_TGT_COMPOSE) {
		min_w = min_t(unsigned int, max_w, sink->f_width / max_sc_h);
		min_h = min_t(unsigned int, max_h, sink->f_height / max_sc_v);
		if (rotate) {
			swap(min_w, min_h);
		}
	}
	v4l_bound_align_image(&r->width, min_w, max_w, ffs(min_sz) - 1,
			      &r->height, min_h, max_h, align_h,
			      align_sz);
	r->left = clamp_t(unsigned int, r->left, 0, sink->f_width - r->width);
	r->top  = clamp_t(unsigned int, r->top, 0, sink->f_height - r->height);
	r->left = round_down(r->left, var->hor_offs_align);
	dbg("target %#x: (%d,%d)/%dx%d, sink fmt: %dx%d",
	    target, r->left, r->top, r->width, r->height,
	    sink->f_width, sink->f_height);
}
