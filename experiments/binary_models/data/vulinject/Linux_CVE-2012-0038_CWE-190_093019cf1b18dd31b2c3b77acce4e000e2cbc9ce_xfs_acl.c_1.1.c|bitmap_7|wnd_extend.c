int wnd_extend(struct wnd_bitmap *wnd, size_t new_bits)
{
	int err;
	struct super_block *sb = wnd->sb;
	struct ntfs_sb_info *sbi = sb->s_fs_info;
	unsigned int blocksize = sb->s_blocksize;
	int wbits, blocksize;
	unsigned int b0, new_last;
	size_t bits, iw, new_wnd;
	size_t old_bits = wnd->nbits;
	unsigned short *new_free;
	if (new_bits <= old_bits)
		return -EINVAL;
	new_wnd = bytes_to_block(sb, ntfs3_bitmap_size(new_bits));
	new_last = new_bits & (wbits - 1);
	if (!new_last)
		new_last = wbits;
	if (new_wnd != wnd->nwnd) {
		new_free = kmalloc_array(new_wnd, sizeof(unsigned short), GFP_NOFS);
		if (!new_free)
			return -ENOMEM;
		memcpy(new_free, wnd->free_bits, wnd->nwnd * sizeof(short));
		memset(new_free + wnd->nwnd, 0,
		       (new_wnd - wnd->nwnd) * sizeof(short));
		kvfree(wnd->free_bits);
		wnd->free_bits = new_free;
	}
	bits = new_bits - old_bits;
	b0 = old_bits & (wbits - 1);
	for (iw = old_bits >> (sb->s_blocksize_bits + 3); bits; iw += 1) {
		unsigned int op;
		size_t frb;
		unsigned int int vbo, lbo, bytes;
		struct buffer_head *bh;
		if (iw + 1 == new_wnd)
			wbits = new_last;
		op = b0 + bits > wbits ? wbits - b0 : bits;
		vbo = (unsigned int int)iw * blocksize;
		err = ntfs_vbo_to_lbo(sbi, &wnd->run, vbo, &lbo, &bytes);
		if (err)
			break;
		bh = ntfs_bread(sb, lbo >> sb->s_blocksize_bits);
		if (!bh)
			return -EIO;
		lock_buffer(bh);
		ntfs_bitmap_clear_le(bh->b_data, b0, blocksize * 8 - b0);
		frb = wbits - ntfs_bitmap_weight_le(bh->b_data, wbits);
		wnd->total_zeroes += frb - wnd->free_bits[iw];
		wnd->free_bits[iw] = frb;
		set_buffer_uptodate(bh);
		mark_buffer_dirty(bh);
		unlock_buffer(bh);
		b0 = 0;
		bits -= op;
	}
	wnd->nbits = new_bits;
	wnd->nwnd = new_wnd;
	wnd->bits_last = new_last;
	wnd_add_free_ext(wnd, old_bits, new_bits - old_bits, false);
	return 0;
}
