capture_loop_init_pcapng_output(capture_options *capture_opts, loop_data *ld,
                                int *err)
{
    if (ld->pcapng_passthrough && !ld->saved_shb) {
        ws_debug("%s: skipping dumpcap SHB and IDBs in favor of source", G_STRFUNC);
        g_rw_lock_reader_unlock (&ld->saved_shb_idb_lock);
        return TRUE;
    }
    gboolean successful = TRUE;
    GString *os_info_str = g_string_new("");
    *err = 0;
    get_os_version_info(os_info_str);
    if (ld->saved_shb) {
        pcapng_block_header_t bh;
        memcpy(&bh, ld->saved_shb, sizeof(pcapng_block_header_t));
        successful = pcapng_write_block(ld->pdh, ld->saved_shb, bh.block_total_length, &ld->bytes_written, err);
        ws_debug("%s: wrote saved passthrough SHB %d", G_STRFUNC, successful);
    } else {
        GString *cpu_info_str = g_string_new("");
        get_cpu_info(cpu_info_str);
        successful = pcapng_write_section_header_block(ld->pdh,
                                                       capture_comments,   
                                                       cpu_info_str->str,           
                                                       os_info_str->str,            
                                                       get_appname_and_version(),
                                                       -1,                          
                                                       &ld->bytes_written,
                                                       err);
        ws_debug("%s: wrote dumpcap SHB %d", G_STRFUNC, successful);
        g_string_free(cpu_info_str, TRUE);
    }
    for (unsigned i = 0; successful && (i < ld->saved_idbs->len); i++) {
        saved_idb_t idb_source = g_array_index(ld->saved_idbs, saved_idb_t, i);
        if (idb_source.deleted) {
            successful = pcapng_write_interface_description_block(global_ld.pdh,
                                                                  "Interface went out of scope",    
                                                                  "dummy",                          
                                                                  "Dumpcap dummy interface",        
                                                                  NULL,                             
                                                                  os_info_str->str,                 
                                                                  NULL,                             
                                                                  -1,
                                                                  0,
                                                                  &(global_ld.bytes_written),
                                                                  0,                                
                                                                  6,                                
                                                                  &global_ld.err);
            ws_debug("%s: skipping deleted pcapng IDB %u", G_STRFUNC, i);
        } else if (idb_source.idb && idb_source.idb_len) {
            successful = pcapng_write_block(global_ld.pdh, idb_source.idb, idb_source.idb_len, &ld->bytes_written, err);
            ws_debug("%s: wrote pcapng IDB %d", G_STRFUNC, successful);
        } else if (idb_source.interface_id < capture_opts->ifaces->len) {
            unsigned if_id = idb_source.interface_id;
            interface_options *interface_opts = &g_array_index(capture_opts->ifaces, interface_options, if_id);
            capture_src *pcap_src = g_array_index(ld->pcaps, capture_src *, if_id);
            if (pcap_src->from_cap_pipe) {
                pcap_src->snaplen = pcap_src->cap_pipe_info.pcap.hdr.snaplen;
            } else {
                pcap_src->snaplen = pcap_snapshot(pcap_src->pcap_h);
            }
            successful = pcapng_write_interface_description_block(global_ld.pdh,
                                                                   NULL,                       
                                                                  (interface_opts->ifname != NULL) ? interface_opts->ifname : interface_opts->name, 
                                                                  interface_opts->descr,      
                                                                  interface_opts->cfilter,    
                                                                  os_info_str->str,           
                                                                  interface_opts->hardware,   
                                                                  pcap_src->linktype,
                                                                  pcap_src->snaplen,
                                                                  &(global_ld.bytes_written),
                                                                  0,                          
                                                                  pcap_src->ts_nsec ? 9 : 6,  
                                                                  &global_ld.err);
            ws_debug("%s: wrote capture_opts IDB %d: %d", G_STRFUNC, if_id, successful);
        }
    }
    g_rw_lock_reader_unlock (&ld->saved_shb_idb_lock);
    g_string_free(os_info_str, TRUE);
    return successful;
}
