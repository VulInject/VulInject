static int ohci_omap_reset(struct usb_hcd *hcd)
{
	struct ohci_hcd		*ohci = hcd_to_ohci(hcd);
	struct omap_usb_config	*config = dev_get_platdata(hcd->self.controller);
	struct ohci_omap_priv	*priv = hcd_to_ohci_omap_priv(hcd);
	int			need_transceiver = (config->otg != 0);
	int			ret;
	dev_dbg(hcd->self.controller, "starting USB Controller\n");
	if (config->otg) {
		hcd->self.otg_port = config->otg;
		hcd->power_budget = 8;
	}
	if (config->ocpi_enable)
		config->ocpi_enable();
	if (IS_ENABLED(CONFIG_USB_OTG) && need_transceiver) {
		hcd->usb_phy = usb_get_phy(USB_PHY_TYPE_USB2);
		if (!IS_ERR_OR_NULL(hcd->usb_phy)) {
			int	status = otg_set_host(hcd->usb_phy->otg,
						&ohci_to_hcd(ohci)->self);
			dev_dbg(hcd->self.controller, "init %s phy, status %d\n",
					hcd->usb_phy->label, status);
			if (status) {
				return status;
			}
		} else {
			return -EPROBE_DEFER;
		}
		hcd->skip_phy_initialization = 1;
		ohci->start_hnp = start_hnp;
	}
	omap_ohci_clock_power(priv, 1);
	if (config->lb_reset)
		config->lb_reset();
	ret = ohci_setup(hcd);
	if (ret < 0)
		return ret;
	if (config->otg || config->rwc) {
		ohci->hc_control = OHCI_CTRL_RWC;
		writel(OHCI_CTRL_RWC, &ohci->regs->control);
	}
	if (machine_is_omap_osk()) {
		unsigned int	rh = roothub_a (ohci);
		rh &= ~RH_A_NPS;
		if (machine_is_omap_osk()) {
			ohci_to_hcd(ohci)->power_budget = 250;
			rh &= ~RH_A_NOCP;
			omap_cfg_reg(W8_1610_GPIO9);
			omap_cfg_reg(W4_USB_HIGHZ);
		}
		ohci_writel(ohci, rh, &ohci->regs->roothub.a);
		ohci->flags &= ~OHCI_QUIRK_HUB_POWER;
	} else if (machine_is_nokia770()) {
		ohci_to_hcd(ohci)->power_budget = 0;
	}
	if (config->transceiver_power)
		return config->transceiver_power(1);
	if (priv->power)
		gpiod_set_value_cansleep(priv->power, 0);
	return 0;
}
