int tcf_idr_check_alloc(struct tc_action_net *tn, unsigned int *index,
			struct tc_action **a, int bind)
{
	struct tcf_idrinfo *idrinfo = tn->idrinfo;
	struct tc_action *p;
	int ret;
	unsigned int max;
	if (*index) {
again:
		rcu_read_lock();
		p = idr_find(&idrinfo->action_idr, *index);
		if (IS_ERR(p)) {
			rcu_read_unlock();
			goto again;
		}
		if (!p) {
			max = *index;
			rcu_read_unlock();
			goto new;
		}
		if (!refcount_inc_not_zero(&p->tcfa_refcnt)) {
			rcu_read_unlock();
			return -EAGAIN;
		}
		if (bind)
		*a = p;
		rcu_read_unlock();
		return 1;
	} else {
		*index = 1;
		max = UINT_MAX;
	}
new:
	*a = NULL;
	mutex_lock(&idrinfo->lock);
	ret = idr_alloc_u32(&idrinfo->action_idr, ERR_PTR(-EBUSY), index, max,
			    GFP_KERNEL);
	mutex_unlock(&idrinfo->lock);
	if (ret == -ENOSPC && *index == max)
		ret = -EAGAIN;
	return ret;
}
