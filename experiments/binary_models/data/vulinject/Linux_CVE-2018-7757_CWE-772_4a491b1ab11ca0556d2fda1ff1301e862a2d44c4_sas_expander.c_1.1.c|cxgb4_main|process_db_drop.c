static void process_db_drop(struct work_struct *work)
{
	struct adapter *adap;
	adap = container_of(work, struct adapter, db_drop_task);
	if (is_t4(adap->params.chip)) {
		drain_db_fifo(adap, dbfifo_drain_delay);
		notify_rdma_uld(adap, CXGB4_CONTROL_DB_DROP);
		drain_db_fifo(adap, dbfifo_drain_delay);
		drain_db_fifo(adap, dbfifo_drain_delay);
		enable_dbs(adap);
		notify_rdma_uld(adap, CXGB4_CONTROL_DB_EMPTY);
	} else if (is_t5(adap->params.chip)) {
		unsigned int dropped_db = t4_read_reg(adap, 0x010ac);
		unsigned short qid = (dropped_db >> 15) & 0x1ffff;
		unsigned short pidx_inc = dropped_db & 0x1fff;
		unsigned int int bar2_qoffset;
		unsigned int bar2_qid;
		int ret;
		ret = t4_bar2_sge_qregs(adap, qid, T4_BAR2_QTYPE_EGRESS,
					0, &bar2_qoffset, &bar2_qid);
		if (ret)
			dev_err(adap->pdev_dev, "doorbell drop recovery: "
				"qid=%d, pidx_inc=%d\n", qid, pidx_inc);
		else
			writel(PIDX_T5_V(pidx_inc) | QID_V(bar2_qid),
			       adap->bar2 + bar2_qoffset + SGE_UDB_KDOORBELL);
		t4_set_reg_field(adap, 0x10b0, 1<<15, 1<<15);
	}
	if (CHELSIO_CHIP_VERSION(adap->params.chip) <= CHELSIO_T5)
		t4_set_reg_field(adap, SGE_DOORBELL_CONTROL_A, DROPPED_DB_F, 0);
}
