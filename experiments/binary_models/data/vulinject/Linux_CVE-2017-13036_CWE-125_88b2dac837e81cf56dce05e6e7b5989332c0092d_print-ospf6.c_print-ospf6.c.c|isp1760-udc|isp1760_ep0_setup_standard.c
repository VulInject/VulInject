static bool isp1760_ep0_setup_standard(struct isp1760_udc *udc,
				       struct usb_ctrlrequest *req)
{
	bool stall;
	switch (req->bRequest) {
	case USB_REQ_GET_STATUS:
		return isp1760_udc_get_status(udc, req);
	case USB_REQ_CLEAR_FEATURE:
		switch (req->bRequestType) {
		case USB_DIR_OUT | USB_RECIP_DEVICE: {
			return true;
		}
		case USB_DIR_OUT | USB_RECIP_ENDPOINT: {
			unsigned short index = le16_to_cpu(req->wIndex);
			struct isp1760_ep *ep;
			if (req->wLength != cpu_to_le16(0) ||
			    req->wValue != cpu_to_le16(USB_ENDPOINT_HALT))
				return true;
			ep = isp1760_udc_find_ep(udc, index);
			if (!ep)
				return true;
			if (!ep->wedged)
				stall = __isp1760_udc_set_halt(ep, false);
			else
				stall = false;
			if (!stall)
				isp1760_udc_ctrl_send_status(&udc->ep[0],
							     USB_DIR_OUT);
			spin_unlock(&udc->lock);
			return stall;
		}
		default:
			return true;
		}
		break;
	case USB_REQ_SET_FEATURE:
		switch (req->bRequestType) {
		case USB_DIR_OUT | USB_RECIP_DEVICE: {
			return true;
		}
		case USB_DIR_OUT | USB_RECIP_ENDPOINT: {
			unsigned short index = le16_to_cpu(req->wIndex);
			struct isp1760_ep *ep;
			if (req->wLength != cpu_to_le16(0) ||
			    req->wValue != cpu_to_le16(USB_ENDPOINT_HALT))
				return true;
			ep = isp1760_udc_find_ep(udc, index);
			if (!ep)
				return true;
			spin_lock(&udc->lock);
			stall = __isp1760_udc_set_halt(ep, true);
			if (!stall)
				isp1760_udc_ctrl_send_status(&udc->ep[0],
							     USB_DIR_OUT);
			spin_unlock(&udc->lock);
			return stall;
		}
		default:
			return true;
		}
		break;
	case USB_REQ_SET_ADDRESS:
		if (req->bRequestType != (USB_DIR_OUT | USB_RECIP_DEVICE))
			return true;
		return isp1760_udc_set_address(udc, le16_to_cpu(req->wValue));
	case USB_REQ_SET_CONFIGURATION:
		if (req->bRequestType != (USB_DIR_OUT | USB_RECIP_DEVICE))
			return true;
		if (udc->gadget.state != USB_STATE_ADDRESS &&
		    udc->gadget.state != USB_STATE_CONFIGURED)
			return true;
		stall = udc->driver->setup(&udc->gadget, req) < 0;
		if (stall)
			return true;
		usb_gadget_set_state(&udc->gadget, req->wValue ?
				     USB_STATE_CONFIGURED : USB_STATE_ADDRESS);
		return false;
	default:
		return udc->driver->setup(&udc->gadget, req) < 0;
	}
}
