static void aaci_fifo_irq(struct aaci *aaci, int channel, unsigned int mask)
{
	if (mask & ISR_ORINTR) {
		dev_warn(&aaci->dev->dev, "RX overrun on chan %d\n", channel);
		writel(ICLR_RXOEC1 << channel, aaci->base + AACI_INTCLR);
	}
	if (mask & ISR_RXTOINTR) {
		dev_warn(&aaci->dev->dev, "RX timeout on chan %d\n", channel);
		writel(ICLR_RXTOFEC1 << channel, aaci->base + AACI_INTCLR);
	}
	if (mask & ISR_RXINTR) {
		struct aaci_runtime *aacirun = &aaci->capture;
		bool period_elapsed = false;
		void *ptr;
		if (!aacirun->substream || !aacirun->start) {
			dev_warn(&aaci->dev->dev, "RX interrupt???\n");
			writel(0, aacirun->base + AACI_IE);
			return;
		}
		ptr = aacirun->ptr;
		do {
			unsigned int len = aacirun->fifo_bytes;
			unsigned int val;
			if (aacirun->bytes <= 0) {
				aacirun->bytes += aacirun->period;
				period_elapsed = true;
			}
			if (!(aacirun->cr & CR_EN))
				break;
			val = readl(aacirun->base + AACI_SR);
			if (!(val & SR_RXHF))
				break;
			if (!(val & SR_RXFF))
				len >>= 1;
			aacirun->bytes -= len;
			for( ; len > 0; len -= 16) {
				asm(
					"ldmia	%1, {r0, r1, r2, r3}\n\t"
					"stmia	%0!, {r0, r1, r2, r3}"
					: "+r" (ptr)
					: "r" (aacirun->fifo)
					: "r0", "r1", "r2", "r3", "cc");
				if (ptr >= aacirun->end)
					ptr = aacirun->start;
			}
		} while(1);
		aacirun->ptr = ptr;
		spin_unlock(&aacirun->lock);
		if (period_elapsed)
			snd_pcm_period_elapsed(aacirun->substream);
	}
	if (mask & ISR_URINTR) {
		dev_dbg(&aaci->dev->dev, "TX underrun on chan %d\n", channel);
		writel(ICLR_TXUEC1 << channel, aaci->base + AACI_INTCLR);
	}
	if (mask & ISR_TXINTR) {
		struct aaci_runtime *aacirun = &aaci->playback;
		bool period_elapsed = false;
		void *ptr;
		if (!aacirun->substream || !aacirun->start) {
			dev_warn(&aaci->dev->dev, "TX interrupt???\n");
			writel(0, aacirun->base + AACI_IE);
			return;
		}
		spin_lock(&aacirun->lock);
		ptr = aacirun->ptr;
		do {
			unsigned int len = aacirun->fifo_bytes;
			unsigned int val;
			if (aacirun->bytes <= 0) {
				aacirun->bytes += aacirun->period;
				period_elapsed = true;
			}
			if (!(aacirun->cr & CR_EN))
				break;
			val = readl(aacirun->base + AACI_SR);
			if (!(val & SR_TXHE))
				break;
			if (!(val & SR_TXFE))
				len >>= 1;
			aacirun->bytes -= len;
			for ( ; len > 0; len -= 16) {
				asm(
					"ldmia	%0!, {r0, r1, r2, r3}\n\t"
					"stmia	%1, {r0, r1, r2, r3}"
					: "+r" (ptr)
					: "r" (aacirun->fifo)
					: "r0", "r1", "r2", "r3", "cc");
				if (ptr >= aacirun->end)
					ptr = aacirun->start;
			}
		} while (1);
		aacirun->ptr = ptr;
		spin_unlock(&aacirun->lock);
		if (period_elapsed)
			snd_pcm_period_elapsed(aacirun->substream);
	}
}
