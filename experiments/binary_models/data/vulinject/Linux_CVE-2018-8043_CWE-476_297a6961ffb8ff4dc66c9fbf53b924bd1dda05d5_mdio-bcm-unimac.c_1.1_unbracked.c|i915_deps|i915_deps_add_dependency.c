int i915_deps_add_dependency(struct i915_deps *deps,
			     struct dma_fence *fence,
			     const struct ttm_operation_ctx *ctx)
{
	unsigned int i;
	if (dma_fence_is_signaled(fence)) {
		ret = fence->error;
		if (ret)
			i915_deps_fini(deps);
		return ret;
	}
	for (i = 0; i < deps->num_deps; ++i) {
		struct dma_fence *entry = deps->fences[i];
		if (!entry->context || entry->context != fence->context)
			continue;
		if (dma_fence_is_later(fence, entry)) {
			dma_fence_put(entry);
			deps->fences[i] = dma_fence_get(fence);
		}
		return 0;
	}
	return i915_deps_grow(deps, fence, ctx);
}
