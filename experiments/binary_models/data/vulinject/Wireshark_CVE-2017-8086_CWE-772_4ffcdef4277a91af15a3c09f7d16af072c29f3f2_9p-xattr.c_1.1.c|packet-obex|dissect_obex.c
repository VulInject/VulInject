dissect_obex(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)
{
    proto_item    *main_item;
    proto_tree    *main_tree;
    proto_item    *sub_item;
    fragment_head *frag_msg       = NULL;
    fragment_item *frag           = NULL;
    gboolean       save_fragmented;
    gboolean       complete;
    tvbuff_t*      new_tvb        = NULL;
    tvbuff_t*      next_tvb       = NULL;
    gint           offset         = 0;
    gint           profile        = PROFILE_UNKNOWN;
    const gchar   *path           = path_unknown;
    obex_profile_data_t      *obex_profile_data;
    wmem_tree_key_t           key[6];
    guint32                   frame_number;
    obex_last_opcode_data_t  *obex_last_opcode_data;
    obex_path_data_t         *obex_path_data;
    guint32                   length;
    guint8                   *profile_data;
    dissector_handle_t        current_handle;
    dissector_handle_t        default_handle;
    gint                      previous_proto;
    obex_proto_data_t         obex_proto_data;
    previous_proto = (GPOINTER_TO_INT(wmem_list_frame_data(wmem_list_frame_prev(wmem_list_tail(pinfo->layers)))));
    if (previous_proto == proto_btl2cap) {
        btl2cap_data_t  *l2cap_data;
        l2cap_data = (btl2cap_data_t *) data;
        obex_proto_data.interface_id = l2cap_data->interface_id;
        obex_proto_data.adapter_id   = l2cap_data->adapter_id;
        obex_proto_data.chandle      = l2cap_data->chandle;
        obex_proto_data.channel      = l2cap_data->cid;
    } else if (previous_proto == proto_btrfcomm) {
        btrfcomm_data_t  *rfcomm_data;
        rfcomm_data = (btrfcomm_data_t *) data;
        obex_proto_data.interface_id = rfcomm_data->interface_id;
        obex_proto_data.adapter_id   = rfcomm_data->adapter_id;
        obex_proto_data.chandle      = rfcomm_data->chandle;
        obex_proto_data.channel      = rfcomm_data->dlci >> 1;
    } else {
        obex_proto_data.interface_id = HCI_INTERFACE_DEFAULT;
        obex_proto_data.adapter_id   = HCI_ADAPTER_DEFAULT;
        obex_proto_data.chandle      = 0;
        obex_proto_data.channel      = 0;
    }
    col_set_str(pinfo->cinfo, COL_PROTOCOL, "OBEX");
    main_item = proto_tree_add_item(tree, proto_obex, tvb, 0, tvb_captured_length(tvb), ENC_NA);
    main_tree = proto_item_add_subtree(main_item, ett_obex);
    save_fragmented = pinfo->fragmented;
    frame_number = pinfo->num;
    key[0].length = 1;
    key[0].key = &obex_proto_data.interface_id;
    key[1].length = 1;
    key[1].key = &obex_proto_data.adapter_id;
    key[2].length = 1;
    key[2].key = &obex_proto_data.chandle;
    key[3].length = 1;
    key[3].key = &obex_proto_data.channel;
    key[4].length = 1;
    key[4].key = &frame_number;
    key[5].length = 0;
    key[5].key = NULL;
    profile_data = (guint8 *) p_get_proto_data(pinfo->pool, pinfo, proto_obex, PROTO_DATA_OBEX_PROFILE);
    if (profile_data == NULL) {
        obex_profile_data = (obex_profile_data_t *)wmem_tree_lookup32_array_le(obex_profile, key);
        if (obex_profile_data && obex_profile_data->interface_id == obex_proto_data.interface_id &&
                obex_profile_data->adapter_id == obex_proto_data.adapter_id &&
                obex_profile_data->chandle == obex_proto_data.chandle &&
                obex_profile_data->channel == obex_proto_data.channel) {
            profile = obex_profile_data->profile;
        }
        profile_data = wmem_new(wmem_file_scope(), guint8);
        *profile_data = profile;
        p_add_proto_data(pinfo->pool, pinfo, proto_obex, PROTO_DATA_OBEX_PROFILE, profile_data);
    }
    obex_path_data = (obex_path_data_t *)wmem_tree_lookup32_array_le(obex_path, key);
    if (obex_path_data && obex_path_data->interface_id == obex_proto_data.interface_id &&
            obex_path_data->adapter_id == obex_proto_data.adapter_id &&
            obex_path_data->chandle == obex_proto_data.chandle &&
            obex_path_data->channel == obex_proto_data.channel) {
        path = obex_path_data->path;
      }
    sub_item = proto_tree_add_uint(main_tree, hf_profile, tvb, 0, 0, profile);
    if (path) {
        sub_item = proto_tree_add_string(main_tree, hf_current_path, tvb, 0, 0, path);
        proto_item_set_generated(sub_item);
    }
    current_handle = dissector_get_uint_handle(obex_profile_table, profile);
    default_handle = dissector_get_default_uint_handle("obex.profile", profile);
    if (current_handle != default_handle) {
        expert_add_info_format(pinfo, main_item, &ei_decoded_as_profile, "Decoded As %s", dissector_handle_get_protocol_long_name(current_handle));
    }
    complete = FALSE;
    if (tvb_captured_length(tvb) == tvb_reported_length(tvb)) {
        frag_msg = fragment_get_reassembled_id(&obex_reassembly_table, pinfo, pinfo->p2p_dir);
        if (frag_msg && pinfo->num != frag_msg->reassembled_in) {
            new_tvb = process_reassembled_data(tvb, 0, pinfo,
                    "Reassembled Obex packet", frag_msg, &obex_frag_items, NULL, main_tree);
        } else if (frag_msg && pinfo->num == frag_msg->reassembled_in) {
            new_tvb = process_reassembled_data(tvb, 0, pinfo,
                    "Reassembled Obex packet", frag_msg, &obex_frag_items, NULL, main_tree);
        } else {
            frag_msg = fragment_get(&obex_reassembly_table, pinfo, pinfo->p2p_dir, NULL);
            if (frag_msg) {
                for (frag = frag_msg->next; frag->next; frag = frag->next) {}
                frag_msg = fragment_add_check(&obex_reassembly_table,
                        tvb, 0, pinfo, pinfo->p2p_dir, NULL,
                        frag->offset + frag->len, tvb_reported_length(tvb),
                                ((frag->offset + frag->len + tvb_reported_length(tvb)) <
                                    fragment_get_tot_len(&obex_reassembly_table, pinfo, pinfo->p2p_dir, NULL)) ? TRUE : FALSE);
                new_tvb = process_reassembled_data(tvb, 0, pinfo,
                        "Reassembled Obex packet", frag_msg, &obex_frag_items, NULL, main_tree);
                pinfo->fragmented = TRUE;
            } else {
                if (tvb_reported_length(tvb) < 3) {
                    col_add_fstr(pinfo->cinfo, COL_INFO, "%s OBEX packet too short",
                                (pinfo->p2p_dir==P2P_DIR_SENT) ? "Sent" : "Rcvd");
                    call_dissector(data_handle, tvb, pinfo, main_tree);
                    return tvb_reported_length(tvb);
                } else if (tvb_reported_length(tvb) >= 3 && tvb_reported_length(tvb) < tvb_get_ntohs(tvb, offset+1)) {
                    frag_msg = fragment_add_check(&obex_reassembly_table,
                                        tvb, 0, pinfo, pinfo->p2p_dir, NULL,
                                        0, tvb_reported_length(tvb), TRUE);
                    fragment_set_tot_len(&obex_reassembly_table,
                                        pinfo, pinfo->p2p_dir, NULL,
                                        tvb_get_ntohs(tvb, offset + 1));
                    new_tvb = process_reassembled_data(tvb, 0, pinfo,
                                "Reassembled Obex packet", frag_msg, &obex_frag_items, NULL, main_tree);
                    pinfo->fragmented = TRUE;
                } else if (tvb_reported_length(tvb) == tvb_get_ntohs(tvb, offset+1)) {
                    complete = TRUE;
                    pinfo->fragmented = FALSE;
                }
            }
        }
    }
    if (new_tvb) { 
        next_tvb = new_tvb;
        complete = TRUE;
    } else { 
        next_tvb = tvb_new_subset_remaining(tvb, offset);
    }
    if (complete) {
        guint8       code;
        guint8       final_flag;
        code = tvb_get_guint8(next_tvb, offset) & OBEX_CODE_VALS_MASK;
        final_flag = tvb_get_guint8(next_tvb, offset) & 0x80;
        switch (pinfo->p2p_dir) {
            case P2P_DIR_SENT:
                col_set_str(pinfo->cinfo, COL_INFO, "Sent ");
                break;
            case P2P_DIR_RECV:
                col_set_str(pinfo->cinfo, COL_INFO, "Rcvd ");
                break;
            default:
                col_set_str(pinfo->cinfo, COL_INFO, "UnknownDirection ");
                break;
        }
        col_append_str(pinfo->cinfo, COL_INFO,
                        val_to_str_ext_const(code, &code_vals_ext, "Unknown"));
        if (code < OBEX_CODE_VALS_CONTINUE || code == OBEX_CODE_VALS_ABORT) {
            proto_tree_add_item(main_tree, hf_opcode, next_tvb, offset, 1, ENC_BIG_ENDIAN);
            if (!pinfo->fd->visited &&
                    (pinfo->p2p_dir == P2P_DIR_SENT ||
                    pinfo->p2p_dir == P2P_DIR_RECV)) {
                frame_number = pinfo->num;
                key[0].length = 1;
                key[0].key = &obex_proto_data.interface_id;
                key[1].length = 1;
                key[1].key = &obex_proto_data.adapter_id;
                key[2].length = 1;
                key[2].key = &obex_proto_data.chandle;
                key[3].length = 1;
                key[3].key = &obex_proto_data.channel;
                key[4].length = 1;
                key[4].key = &frame_number;
                key[5].length = 0;
                key[5].key = NULL;
                obex_last_opcode_data = wmem_new0(wmem_file_scope(), obex_last_opcode_data_t);
                obex_last_opcode_data->interface_id      = obex_proto_data.interface_id;
                obex_last_opcode_data->adapter_id        = obex_proto_data.adapter_id;
                obex_last_opcode_data->chandle           = obex_proto_data.chandle;
                obex_last_opcode_data->channel           = obex_proto_data.channel;
                obex_last_opcode_data->code              = code;
                obex_last_opcode_data->final_flag        = final_flag;
                obex_last_opcode_data->request_in_frame  = frame_number;
                obex_last_opcode_data->response_in_frame = 0;
                wmem_tree_insert32_array(obex_last_opcode, key, obex_last_opcode_data);
            }
        } else {
            proto_tree_add_item(main_tree, hf_response_code, next_tvb, offset, 1, ENC_BIG_ENDIAN);
        }
        proto_tree_add_item(main_tree, hf_final_flag, next_tvb, offset, 1, ENC_BIG_ENDIAN);
        offset++;
        proto_tree_add_item(main_tree, hf_length, next_tvb, offset, 2, ENC_BIG_ENDIAN);
        length = tvb_get_ntohs(tvb, offset) - 3;
        offset += 2;
        frame_number = pinfo->num;
        key[0].length = 1;
        key[0].key = &obex_proto_data.interface_id;
        key[1].length = 1;
        key[1].key = &obex_proto_data.adapter_id;
        key[2].length = 1;
        key[2].key = &obex_proto_data.chandle;
        key[3].length = 1;
        key[3].key = &obex_proto_data.channel;
        key[4].length = 1;
        key[4].key = &frame_number;
        key[5].length = 0;
        key[5].key = NULL;
        obex_last_opcode_data = (obex_last_opcode_data_t *)wmem_tree_lookup32_array_le(obex_last_opcode, key);
        if (obex_last_opcode_data && obex_last_opcode_data->interface_id == obex_proto_data.interface_id &&
                obex_last_opcode_data->adapter_id == obex_proto_data.adapter_id &&
                obex_last_opcode_data->chandle == obex_proto_data.chandle &&
                obex_last_opcode_data->channel == obex_proto_data.channel) {
            if (obex_last_opcode_data->request_in_frame > 0 && obex_last_opcode_data->request_in_frame != pinfo->num) {
                sub_item = proto_tree_add_uint(main_tree, hf_request_in_frame, next_tvb, 0, 0, obex_last_opcode_data->request_in_frame);
                proto_item_set_generated(sub_item);
            }
            if (!pinfo->fd->visited && obex_last_opcode_data->response_in_frame == 0 && obex_last_opcode_data->request_in_frame < pinfo->num) {
                obex_last_opcode_data->response_in_frame = pinfo->num;
            }
            if (obex_last_opcode_data->response_in_frame > 0 && obex_last_opcode_data->response_in_frame != pinfo->num) {
                sub_item = proto_tree_add_uint(main_tree, hf_response_in_frame, next_tvb, 0, 0, obex_last_opcode_data->response_in_frame);
                proto_item_set_generated(sub_item);
            }
        }
        switch(code)
        {
        case OBEX_CODE_VALS_CONNECT:
            proto_tree_add_item(main_tree, hf_version, next_tvb, offset, 1, ENC_BIG_ENDIAN);
            offset++;
            proto_tree_add_item(main_tree, hf_flags, next_tvb, offset, 1, ENC_BIG_ENDIAN);
            offset++;
            proto_tree_add_item(main_tree, hf_max_pkt_len, next_tvb, offset, 2, ENC_BIG_ENDIAN);
            offset += 2;
            break;
        case OBEX_CODE_VALS_PUT:
        case OBEX_CODE_VALS_GET:
            col_append_fstr(pinfo->cinfo, COL_INFO, " %s",  (final_flag == 0x80) ? "final" : "continue");
            break;
        case OBEX_CODE_VALS_SET_PATH:
            proto_tree_add_item(main_tree, hf_flags, next_tvb, offset, 1, ENC_BIG_ENDIAN);
            proto_tree_add_item(main_tree, hf_set_path_flags_0, next_tvb, offset, 1, ENC_BIG_ENDIAN);
            proto_tree_add_item(main_tree, hf_set_path_flags_1, next_tvb, offset, 1, ENC_BIG_ENDIAN);
            if (!pinfo->fd->visited && obex_last_opcode_data) {
                obex_last_opcode_data->data.set_data.go_up = tvb_get_guint8(tvb, offset) & 0x01;
                obex_last_opcode_data->data.set_data.name = NULL;
            }
            offset++;
            proto_tree_add_item(main_tree, hf_constants, next_tvb, offset, 1, ENC_BIG_ENDIAN);
            offset++;
            break;
        case OBEX_CODE_VALS_DISCONNECT:
        case OBEX_CODE_VALS_ABORT:
            break;
        default:
            if (length == 0 && tvb_reported_length_remaining(tvb, offset) > 0) {
                proto_tree_add_expert(main_tree, pinfo, &ei_unexpected_data, tvb, offset, tvb_reported_length_remaining(tvb, offset));
                offset += tvb_reported_length_remaining(tvb, offset);
                break;
            } else if (length == 0) break;
            if (obex_last_opcode_data &&  obex_last_opcode_data->code == OBEX_CODE_VALS_CONNECT) {
                proto_tree_add_item(main_tree, hf_version, next_tvb, offset, 1, ENC_BIG_ENDIAN);
                offset++;
                proto_tree_add_item(main_tree, hf_flags, next_tvb, offset, 1, ENC_BIG_ENDIAN);
                offset++;
                proto_tree_add_item(main_tree, hf_max_pkt_len, next_tvb, offset, 2, ENC_BIG_ENDIAN);
                offset += 2;
                if (!pinfo->fd->visited)
                    save_path(pinfo, path, "", FALSE, &obex_proto_data);
            }
            break;
        }
        dissect_headers(main_tree, next_tvb, offset, pinfo, profile, obex_last_opcode_data, &obex_proto_data);
        if (!pinfo->fd->visited &&
                    obex_last_opcode_data &&
                    obex_last_opcode_data->data.set_data.name &&
                    obex_last_opcode_data->code == OBEX_CODE_VALS_SET_PATH &&
                    code == OBEX_CODE_VALS_SUCCESS) {
            save_path(pinfo, path, obex_last_opcode_data->data.set_data.name, obex_last_opcode_data->data.set_data.go_up, &obex_proto_data);
        }
    } else {
        col_add_fstr(pinfo->cinfo, COL_INFO, "%s OBEX fragment",
                     (pinfo->p2p_dir==P2P_DIR_SENT) ? "Sent" : "Rcvd");
        call_dissector(data_handle, next_tvb, pinfo, main_tree);
        offset = tvb_reported_length(tvb);
    }
    pinfo->fragmented = save_fragmented;
    return offset;
}
