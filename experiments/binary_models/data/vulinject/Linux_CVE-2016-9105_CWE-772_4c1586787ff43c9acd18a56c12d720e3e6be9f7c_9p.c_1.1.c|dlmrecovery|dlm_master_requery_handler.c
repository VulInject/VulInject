int dlm_master_requery_handler(struct o2net_msg *msg, unsigned int len, void *data,
			       void **ret_data)
{
	struct dlm_ctxt *dlm = data;
	struct dlm_master_requery *req = (struct dlm_master_requery *)msg->buf;
	struct dlm_lock_resource *res = NULL;
	unsigned int hash;
	int master = DLM_LOCK_RES_OWNER_UNKNOWN;
	unsigned int flags = DLM_ASSERT_MASTER_REQUERY;
	int dispatched = 0;
	if (!dlm_grab(dlm)) {
		return master;
	}
	hash = dlm_lockid_hash(req->name, req->namelen);
	spin_lock(&dlm->spinlock);
	res = __dlm_lookup_lockres(dlm, req->name, req->namelen, hash);
	if (res) {
		spin_lock(&res->spinlock);
		master = res->owner;
		if (master == dlm->node_num) {
			int ret = dlm_dispatch_assert_master(dlm, res,
							     0, 0, flags);
			if (ret < 0) {
				mlog_errno(ret);
				spin_unlock(&res->spinlock);
				dlm_lockres_put(res);
				spin_unlock(&dlm->spinlock);
				dlm_put(dlm);
				return ret;
			} else {
				dispatched = 1;
				spin_unlock(&res->spinlock);
			}
		} else {
			spin_unlock(&res->spinlock);
			dlm_lockres_put(res);
		}
	}
	spin_unlock(&dlm->spinlock);
	if (!dispatched)
		dlm_put(dlm);
	return master;
}
