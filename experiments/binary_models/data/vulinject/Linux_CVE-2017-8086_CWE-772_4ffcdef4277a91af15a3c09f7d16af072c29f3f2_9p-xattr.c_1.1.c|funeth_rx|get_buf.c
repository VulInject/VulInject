get_buf(struct funeth_rxq *q, struct funeth_rxbuf *buf, unsigned int len)
{
	if (q->buf_offset + len <= PAGE_SIZE || !q->buf_offset)
		return buf;            
	if ((page_ref_count(buf->page) == buf->pg_refs &&
	     buf->node == numa_mem_id()) || !q->spare_buf.page) {
		dma_sync_single_for_device(q->dma_dev, buf->dma_addr,
					   PAGE_SIZE, DMA_FROM_DEVICE);
	} else {
		cache_offer(q, buf);
		*buf = q->spare_buf;
		q->spare_buf.page = NULL;
		q->rqes[q->rq_cons & q->rq_mask] =
			FUN_EPRQ_RQBUF_INIT(buf->dma_addr);
	}
	q->buf_offset = 0;
	q->rq_cons++;
	return &q->bufs[q->rq_cons & q->rq_mask];
}
