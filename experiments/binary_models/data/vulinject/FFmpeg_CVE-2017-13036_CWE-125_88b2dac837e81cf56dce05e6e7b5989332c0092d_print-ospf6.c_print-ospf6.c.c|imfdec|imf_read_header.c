static int imf_read_header(AVFormatContext *s)
{
    IMFContext *c = s->priv_data;
    char *asset_map_path;
    char *tmp_str;
    AVDictionaryEntry* tcr;
    char tc_buf[AV_TIMECODE_STR_SIZE];
    int ret = 0;
    c->interrupt_callback = &s->interrupt_callback;
    tmp_str = av_strdup(s->url);
    if (!tmp_str)
        return AVERROR(ENOMEM);
    c->base_url = av_strdup(av_dirname(tmp_str));
    av_freep(&tmp_str);
    if (!c->base_url)
        return AVERROR(ENOMEM);
    if ((ret = ffio_copy_url_options(s->pb, &c->avio_opts)) < 0)
        return ret;
    av_log(s, AV_LOG_DEBUG, "start parsing IMF CPL: %s\n", s->url);
    if ((ret = ff_imf_parse_cpl(s, s->pb, &c->cpl)) < 0)
        return ret;
    tcr = av_dict_get(s->metadata, "timecode", NULL, 0);
    if (!tcr && c->cpl->tc) {
        ret = av_dict_set(&s->metadata, "timecode",
                          av_timecode_make_string(c->cpl->tc, tc_buf, 0), 0);
        if (ret)
            return ret;
        av_log(s, AV_LOG_INFO, "Setting timecode to IMF CPL timecode %s\n", tc_buf);
    }
    av_log(s,
           AV_LOG_DEBUG,
           "parsed IMF CPL: " AV_PRI_URN_UUID "\n",
           AV_UUID_ARG(c->cpl->id_uuid));
    if (!c->asset_map_paths) {
        c->asset_map_paths = av_append_path_component(c->base_url, "ASSETMAP.xml");
        if (!c->asset_map_paths) {
            ret = AVERROR(ENOMEM);
            return ret;
        }
        av_log(s, AV_LOG_DEBUG, "No asset maps provided, using the default ASSETMAP.xml\n");
    }
    /* Parse each asset map XML file */
    asset_map_path = av_strtok(c->asset_map_paths, ",", &tmp_str);
    while (asset_map_path != NULL) {
        av_log(s, AV_LOG_DEBUG, "start parsing IMF Asset Map: %s\n", asset_map_path);
        if ((ret = parse_assetmap(s, asset_map_path)))
            return ret;
        asset_map_path = av_strtok(NULL, ",", &tmp_str);
    }
    av_log(s, AV_LOG_DEBUG, "parsed IMF Asset Maps\n");
    if ((ret = open_cpl_tracks(s)))
        return ret;
    av_log(s, AV_LOG_DEBUG, "parsed IMF package\n");
    return 0;
}
