static int mcast_add_one(struct ib_device *device)
{
	struct mcast_device *dev;
	struct mcast_port *port;
	int i;
	int count = 0;
	dev = kmalloc(struct_size(dev, port, device->phys_port_cnt),
		      GFP_KERNEL);
	if (!dev)
		return -ENOMEM;
	dev->start_port = rdma_start_port(device);
	dev->end_port = rdma_end_port(device);
	for (i = 0; i <= dev->end_port - dev->start_port; i++) {
		if (!rdma_cap_ib_mcast(device, dev->start_port + i))
			continue;
		port = &dev->port[i];
		port->dev = dev;
		port->port_num = dev->start_port + i;
		port->table = RB_ROOT;
		init_completion(&port->comp);
		refcount_set(&port->refcount, 1);
		++count;
	}
	if (!count) {
		kfree(dev);
		return -EOPNOTSUPP;
	}
	dev->device = device;
	ib_set_client_data(device, &mcast_client, dev);
	INIT_IB_EVENT_HANDLER(&dev->event_handler, device, mcast_event_handler);
	ib_register_event_handler(&dev->event_handler);
	return 0;
}
