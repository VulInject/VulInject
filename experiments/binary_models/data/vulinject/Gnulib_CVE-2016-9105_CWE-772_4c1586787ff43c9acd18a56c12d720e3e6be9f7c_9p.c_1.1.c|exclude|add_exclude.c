add_exclude (struct exclude *ex, char const *pattern, int options)
{
  if ((options & (EXCLUDE_REGEX|EXCLUDE_WILDCARDS))
      && fnmatch_pattern_has_wildcards (pattern, options))
    {
      if (! (ex->head && ex->head->type == exclude_pattern
             && ((ex->head->options & EXCLUDE_INCLUDE)
                 == (options & EXCLUDE_INCLUDE))))
        new_exclude_segment (ex, exclude_pattern, options);
      struct exclude_pattern *pat = &ex->head->v.pat;
      if (pat->exclude_count == pat->exclude_alloc)
        pat->exclude = xpalloc (pat->exclude, &pat->exclude_alloc, 1, -1,
                                sizeof *pat->exclude);
      struct patopts *patopts = &pat->exclude[pat->exclude_count++];
      patopts->options = options;
      if (options & EXCLUDE_REGEX)
        {
          int rc;
          int cflags = (REG_NOSUB | REG_EXTENDED
                        | (options & FNM_CASEFOLD ? REG_ICASE : 0));
          if (! (options & FNM_LEADING_DIR))
            rc = regcomp (&patopts->v.re, pattern, cflags);
          else
            for (idx_t len = strlen (pattern); ; len--)
              {
                if (len == 0)
                  {
                    rc = 1;
                    break;
                  }
                if (!ISSLASH (pattern[len - 1]))
                  {
                    static char const patsuffix[] = "(/.*)?";
                    char *tmp = ximalloc (len + sizeof patsuffix);
                    memcpy (tmp, pattern, len);
                    strcpy (tmp + len, patsuffix);
                    rc = regcomp (&patopts->v.re, tmp, cflags);
                    free (tmp);
                    break;
                  }
              }
          if (rc)
            {
              pat->exclude_count--;
              return;
            }
        }
      else
        {
          if (options & EXCLUDE_ALLOC)
            {
              char *dup = xstrdup (pattern);
              pattern = dup;
            }
          patopts->v.pattern = pattern;
        }
    }
  else
    {
      int exclude_hash_flags = (EXCLUDE_INCLUDE | EXCLUDE_ANCHORED
                                | FNM_LEADING_DIR | FNM_CASEFOLD);
      if (! (ex->head && ex->head->type == exclude_hash
             && ((ex->head->options & exclude_hash_flags)
                 == (options & exclude_hash_flags))))
        new_exclude_segment (ex, exclude_hash, options);
      char *str = xstrdup (pattern);
      if ((options & (EXCLUDE_WILDCARDS | FNM_NOESCAPE)) == EXCLUDE_WILDCARDS)
        unescape_pattern (str);
      if (hash_insert (ex->head->v.table, str) != str)
        free (str);
    }
}
