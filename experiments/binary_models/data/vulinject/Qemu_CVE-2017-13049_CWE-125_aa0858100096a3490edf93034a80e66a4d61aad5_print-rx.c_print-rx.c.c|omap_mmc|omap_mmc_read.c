static uint64_t omap_mmc_read(void *opaque, hwaddr offset, unsigned size)
{
    uint16_t i;
    struct omap_mmc_s *s = opaque;
    if (size != 2) {
        return omap_badwidth_read16(opaque, offset);
    }
    switch (offset) {
    case 0x00:	/* MMC_CMD */
        return s->last_cmd;
    case 0x04:	/* MMC_ARGL */
        return s->arg & 0x0000ffff;
    case 0x08:	/* MMC_ARGH */
        return s->arg >> 16;
    case 0x0c:	/* MMC_CON */
        return (s->dw << 15) | (s->mode << 12) | (s->enable << 11) | 
                (s->be << 10) | s->clkdiv;
    case 0x10:	/* MMC_STAT */
        return s->status;
    case 0x14:	/* MMC_IE */
        return s->mask;
    case 0x18:	/* MMC_CTO */
        return s->cto;
    case 0x1c:	/* MMC_DTO */
        return s->dto;
    case 0x20:	/* MMC_DATA */
        /* TODO: support 8-bit access */
        i = s->fifo[s->fifo_start];
        if (s->fifo_len == 0) {
            printf("MMC: FIFO underrun\n");
            return i;
        }
        s->fifo_start ++;
        s->fifo_len --;
        s->fifo_start &= 31;
        omap_mmc_fifolevel_update(s);
        omap_mmc_interrupts_update(s);
        return i;
    case 0x24:	/* MMC_BLEN */
        return s->blen_counter;
    case 0x28:	/* MMC_NBLK */
        return s->nblk_counter;
    case 0x2c:	/* MMC_BUF */
        return (s->rx_dma << 15) | (s->af_level << 8) |
            (s->tx_dma << 7) | s->ae_level;
    case 0x30:	/* MMC_SPI */
        return 0x0000;
    case 0x34:	/* MMC_SDIO */
        return (s->cdet_wakeup << 2) | (s->cdet_enable) | s->sdio;
    case 0x38:	/* MMC_SYST */
        return 0x0000;
    case 0x3c:	/* MMC_REV */
        return s->rev;
    case 0x40:	/* MMC_RSP0 */
    case 0x44:	/* MMC_RSP1 */
    case 0x48:	/* MMC_RSP2 */
    case 0x4c:	/* MMC_RSP3 */
    case 0x50:	/* MMC_RSP4 */
    case 0x54:	/* MMC_RSP5 */
    case 0x58:	/* MMC_RSP6 */
    case 0x5c:	/* MMC_RSP7 */
        return s->rsp[(offset - 0x40) >> 2];
    /* OMAP2-specific */
    case 0x60:	/* MMC_IOSR */
    case 0x64:	/* MMC_SYSC */
        return 0;
    case 0x68:	/* MMC_SYSS */
        return 1;						/* RSTD */
    }
    OMAP_BAD_REG(offset);
    return 0;
}
