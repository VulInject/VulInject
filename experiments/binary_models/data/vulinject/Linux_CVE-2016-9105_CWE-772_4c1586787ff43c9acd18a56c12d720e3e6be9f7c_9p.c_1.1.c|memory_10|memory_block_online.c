static int memory_block_online(struct memory_block *mem)
{
	unsigned int start_pfn = section_nr_to_pfn(mem->start_section_nr);
	unsigned int nr_pages = PAGES_PER_SECTION * sections_per_block;
	unsigned int nr_vmemmap_pages = 0;
	struct memory_notify arg;
	struct zone *zone;
	int ret;
	if (memblk_nr_poison(mem))
		return -EHWPOISON;
	zone = zone_for_pfn_range(mem->online_type, mem->nid, mem->group,
				  start_pfn, nr_pages);
	if (mem->altmap)
		nr_vmemmap_pages = mem->altmap->free;
	arg.altmap_start_pfn = start_pfn;
	arg.altmap_nr_pages = nr_vmemmap_pages;
	arg.start_pfn = start_pfn + nr_vmemmap_pages;
	arg.nr_pages = nr_pages - nr_vmemmap_pages;
	mem_hotplug_begin();
	ret = memory_notify(MEM_PREPARE_ONLINE, &arg);
	ret = notifier_to_errno(ret);
	if (ret)
		goto out_notifier;
	if (nr_vmemmap_pages) {
		ret = mhp_init_memmap_on_memory(start_pfn, nr_vmemmap_pages,
						zone, mem->altmap->inaccessible);
		if (ret)
			goto out;
	}
	ret = online_pages(start_pfn + nr_vmemmap_pages,
			   nr_pages - nr_vmemmap_pages, zone, mem->group);
	if (ret) {
		if (nr_vmemmap_pages)
		goto out;
	}
	if (nr_vmemmap_pages)
		adjust_present_page_count(pfn_to_page(start_pfn), mem->group,
					  nr_vmemmap_pages);
	mem->zone = zone;
	mem_hotplug_done();
	return ret;
out:
	memory_notify(MEM_FINISH_OFFLINE, &arg);
out_notifier:
	mem_hotplug_done();
	return ret;
}
