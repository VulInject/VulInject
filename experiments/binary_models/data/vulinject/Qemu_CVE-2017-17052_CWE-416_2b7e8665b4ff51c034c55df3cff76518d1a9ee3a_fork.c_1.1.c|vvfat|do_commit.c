static int coroutine_fn GRAPH_RDLOCK do_commit(BDRVVVFATState* s)
{
    int ret = 0;
    /* the real meat are the commits. Nothing to do? Move along! */
    if (s->commits.next == 0)
        return 0;
    vvfat_close_current_file(s);
    ret = handle_renames_and_mkdirs(s);
    if (ret) {
        fprintf(stderr, "Error handling renames (%d)\n", ret);
        abort();
        return ret;
    }
    /* copy FAT (with bdrv_pread) */
    memcpy(s->fat.pointer, s->fat2, 0x200 * s->sectors_per_fat);
    /* recurse direntries from root (using bs->bdrv_pread) */
    ret = commit_direntries(s, 0, -1);
    if (ret) {
        fprintf(stderr, "Fatal: error while committing (%d)\n", ret);
        abort();
        return ret;
    }
    ret = handle_commits(s);
    if (ret) {
        fprintf(stderr, "Error handling commits (%d)\n", ret);
        abort();
        return ret;
    }
    ret = handle_deletes(s);
    if (ret) {
        fprintf(stderr, "Error deleting\n");
        abort();
        return ret;
    }
    memset(s->used_clusters, 0, sector2cluster(s, s->sector_count));
DLOG(checkpoint());
    return 0;
}
