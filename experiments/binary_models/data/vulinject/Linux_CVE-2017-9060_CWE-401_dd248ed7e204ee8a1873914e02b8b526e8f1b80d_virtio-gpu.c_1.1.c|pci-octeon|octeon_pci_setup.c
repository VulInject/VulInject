static int __init octeon_pci_setup(void)
{
	union cvmx_npi_mem_access_subidx mem_access;
	int index;
	if (octeon_has_feature(OCTEON_FEATURE_PCIE))
		return 0;
	if (!octeon_is_pci_host()) {
		pr_notice("Not in host mode, PCI Controller not initialized\n");
		return 0;
	}
	octeon_pcibios_map_irq = octeon_pci_pcibios_map_irq;
	if (OCTEON_IS_MODEL(OCTEON_CN31XX) ||
	    OCTEON_IS_MODEL(OCTEON_CN38XX_PASS2) ||
	    OCTEON_IS_MODEL(OCTEON_CN38XX_PASS1))
		octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_SMALL;
	else
		octeon_dma_bar_type = OCTEON_DMA_BAR_TYPE_BIG;
	ioport_resource.start = 0;
	ioport_resource.end = OCTEON_PCI_IOSPACE_SIZE - 1;
	pr_notice("%s Octeon big bar support\n",
		  (octeon_dma_bar_type ==
		  OCTEON_DMA_BAR_TYPE_BIG) ? "Enabling" : "Disabling");
	octeon_pci_initialize();
	mem_access.unsigned int int = 0;
	mem_access.s.esr = 1;	
	mem_access.s.esw = 1;	
	mem_access.s.nsr = 0;	
	mem_access.s.nsw = 0;	
	mem_access.s.ror = 0;	
	mem_access.s.row = 0;	
	mem_access.s.ba = 0;	
	cvmx_write_csr(CVMX_NPI_MEM_ACCESS_SUBID3, mem_access.unsigned int int);
	octeon_npi_write32(CVMX_NPI_PCI_CFG08,
			   (unsigned int)(OCTEON_BAR2_PCI_ADDRESS & 0xffffffffull));
	octeon_npi_write32(CVMX_NPI_PCI_CFG09,
			   (unsigned int)(OCTEON_BAR2_PCI_ADDRESS >> 32));
	if (octeon_dma_bar_type == OCTEON_DMA_BAR_TYPE_BIG) {
		octeon_npi_write32(CVMX_NPI_PCI_CFG04, 0);
		octeon_npi_write32(CVMX_NPI_PCI_CFG05, 0);
		octeon_npi_write32(CVMX_NPI_PCI_CFG06, 2ul << 30);
		octeon_npi_write32(CVMX_NPI_PCI_CFG07, 0);
		octeon_bar1_pci_phys = 0x80000000ull;
		for (index = 0; index < 32; index++) {
			union cvmx_pci_bar1_indexx bar1_index;
			bar1_index.unsigned int = 0;
			bar1_index.s.addr_idx =
				(octeon_bar1_pci_phys >> 22) + index;
			bar1_index.s.ca = 1;
			bar1_index.s.end_swp = 1;
			bar1_index.s.addr_v = 1;
			octeon_npi_write32(CVMX_NPI_PCI_BAR1_INDEXX(index),
					   bar1_index.unsigned int);
		}
		octeon_pci_mem_resource.start =
			OCTEON_PCI_MEMSPACE_OFFSET + (4ul << 30) -
			(OCTEON_PCI_BAR1_HOLE_SIZE << 20);
		octeon_pci_mem_resource.end =
			octeon_pci_mem_resource.start + (1ul << 30);
	} else {
		octeon_npi_write32(CVMX_NPI_PCI_CFG04, 128ul << 20);
		octeon_npi_write32(CVMX_NPI_PCI_CFG05, 0);
		octeon_npi_write32(CVMX_NPI_PCI_CFG06, 0);
		octeon_npi_write32(CVMX_NPI_PCI_CFG07, 0);
		octeon_bar1_pci_phys =
			default_swiotlb_base() & ~((1ull << 22) - 1);
		for (index = 0; index < 32; index++) {
			union cvmx_pci_bar1_indexx bar1_index;
			bar1_index.unsigned int = 0;
			bar1_index.s.addr_idx =
				(octeon_bar1_pci_phys >> 22) + index;
			bar1_index.s.ca = 1;
			bar1_index.s.end_swp = 1;
			bar1_index.s.addr_v = 1;
			octeon_npi_write32(CVMX_NPI_PCI_BAR1_INDEXX(index),
					   bar1_index.unsigned int);
		}
		octeon_pci_mem_resource.start =
			OCTEON_PCI_MEMSPACE_OFFSET + (128ul << 20) +
			(4ul << 10);
		octeon_pci_mem_resource.end =
			octeon_pci_mem_resource.start + (1ul << 30);
	}
	register_pci_controller(&octeon_pci_controller);
	cvmx_write_csr(CVMX_NPI_PCI_INT_SUM2, -1);
	if (IS_ERR(platform_device_register_simple("octeon_pci_edac",
						   -1, NULL, 0)))
		pr_err("Registration of co_pci_edac failed!\n");
	octeon_pci_dma_init();
	return 0;
}
