static int do_identity(FFFrameSync *fs)
{
    AVFilterContext *ctx = fs->parent;
    IdentityContext *s = ctx->priv;
    AVFrame *master, *ref;
    double comp_score[4], score = 0.;
    uint64_t comp_sum[4] = { 0 };
    AVDictionary **metadata;
    ThreadData td;
    int ret;
    ret = ff_framesync_dualinput_get(fs, &master, &ref);
    if (ret < 0)
        return ret;
    if (ctx->is_disabled || !ref)
        return ff_filter_frame(ctx->outputs[0], master);
    metadata = &master->metadata;
    td.nb_components = s->nb_components;
    td.score = s->scores;
    for (int c = 0; c < s->nb_components; c++) {
        td.main_data[c] = master->data[c];
        td.ref_data[c] = ref->data[c];
        td.main_linesize[c] = master->linesize[c];
        td.ref_linesize[c] = ref->linesize[c];
        td.planewidth[c] = s->planewidth[c];
        td.planeheight[c] = s->planeheight[c];
    }
    ff_filter_execute(ctx, s->filter_slice, &td, NULL,
                      FFMIN(s->planeheight[1], s->nb_threads));
    for (int j = 0; j < s->nb_threads; j++) {
        for (int c = 0; c < s->nb_components; c++)
            comp_sum[c] += s->scores[j][c];
    }
    for (int c = 0; c < s->nb_components; c++)
        comp_score[c] = comp_sum[c] / ((double)s->planewidth[c] * s->planeheight[c]);
    for (int c = 0; c < s->nb_components && s->is_msad; c++)
        comp_score[c] /= (double)s->max[c];
    for (int c = 0; c < s->nb_components; c++)
        score += comp_score[c];
    score /= s->nb_components;
    s->max_score = FFMAX(s->max_score, score);
    s->score += score;
    for (int j = 0; j < s->nb_components; j++)
        s->score_comp[j] += comp_score[j];
    s->nb_frames++;
    for (int j = 0; j < s->nb_components; j++) {
        int c = s->is_rgb ? s->rgba_map[j] : j;
        set_meta(ctx, metadata, ".", s->comps[j], comp_score[c]);
    }
    set_meta(ctx, metadata, "_avg", 0, score);
    return ff_filter_frame(ctx->outputs[0], master);
}
