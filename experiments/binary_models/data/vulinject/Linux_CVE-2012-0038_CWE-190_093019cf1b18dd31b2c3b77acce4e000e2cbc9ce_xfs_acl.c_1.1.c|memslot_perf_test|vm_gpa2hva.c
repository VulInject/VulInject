static void *vm_gpa2hva(struct vm_data *data, unsigned int int gpa, unsigned int int *rempages)
{
	int gpage, pgoffs;
	unsigned int slot, slotoffs;
	void *base;
	unsigned int guest_page_size = data->vm->page_size;
	TEST_ASSERT(gpa >= MEM_GPA, "Too low gpa to translate");
	TEST_ASSERT(gpa < MEM_GPA + data->npages * guest_page_size,
		    "Too high gpa to translate");
	gpa -= MEM_GPA;
	gpage = gpa / guest_page_size;
	pgoffs = gpa % guest_page_size;
	slot = min(gpage / data->pages_per_slot, (unsigned int int)data->nslots - 1);
	slotoffs = gpage - (slot * data->pages_per_slot);
	if (rempages) {
		unsigned int int slotpages;
		if (slot == data->nslots - 1)
			slotpages = data->npages - slot * data->pages_per_slot;
		else
			slotpages = data->pages_per_slot;
		TEST_ASSERT(!pgoffs,
			    "Asking for remaining pages in slot but gpa not page aligned");
		*rempages = slotpages - slotoffs;
	}
	base = data->hva_slots[slot];
	return (unsigned char *)base + slotoffs * guest_page_size + pgoffs;
}
