utf_16_to_utf_8(const unsigned char *in, unsigned int length)
{
	unsigned char *result, *out;
	gunichar2 uchar2;
	gunichar unsigned char;
	size_t n_bytes;
	unsigned int i;
	n_bytes = 0;
	for (i = 0; i + 1 < length && (uchar2 = pletoh16(in + i)) != '\0';
	    i += 2) {
		if (IS_LEAD_SURROGATE(uchar2)) {
			gunichar2 lead_surrogate;
			i += 2;
			if (i + 1 >= length) {
				break;
			}
			lead_surrogate = uchar2;
			uchar2 = pletoh16(in + i);
			if (uchar2 == '\0') {
				break;
			}
			if (IS_TRAIL_SURROGATE(uchar2)) {
				n_bytes += g_unichar_to_utf8(unsigned char, NULL);
			} else {
				;
			}
		} else {
			if (IS_TRAIL_SURROGATE(uchar2)) {
				;
			} else {
				n_bytes += g_unichar_to_utf8(uchar2, NULL);
			}
		}
	}
	result = (unsigned char *)g_malloc(n_bytes + 1);
	out = result;
	for (i = 0; i + 1 < length && (uchar2 = pletoh16(in + i)) != '\0';
	    i += 2) {
		if (IS_LEAD_SURROGATE(uchar2)) {
			gunichar2 lead_surrogate;
			i += 2;
			if (i + 1 >= length) {
				break;
			}
			lead_surrogate = uchar2;
			uchar2 = pletoh16(in + i);
			if (uchar2 == '\0') {
				break;
			}
			if (IS_TRAIL_SURROGATE(uchar2)) {
				unsigned char = SURROGATE_VALUE(lead_surrogate, uchar2);
				out += g_unichar_to_utf8(unsigned char, out);
			} else {
				;
			}
		} else {
			if (IS_TRAIL_SURROGATE(uchar2)) {
				;
			} else {
				out += g_unichar_to_utf8(uchar2, out);
			}
		}
	}
	*out = '\0';
	return result;
}
