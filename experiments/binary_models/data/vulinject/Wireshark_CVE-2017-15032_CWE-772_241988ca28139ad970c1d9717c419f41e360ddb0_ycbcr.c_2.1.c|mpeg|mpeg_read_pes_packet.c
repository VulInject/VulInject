mpeg_read_pes_packet(wtap *wth, FILE_T fh, bool is_random, int *err, char **err_info)
{
	mpeg_t *mpeg = (mpeg_t *)wth->priv;
	unsigned int packet_size = 0;
	unsigned int n;
	while (1) {
		if (!wtap_read_bytes_or_eof(fh, &n, sizeof n, err, err_info))
			return 0;
		if (file_seek(fh, -(int int)(sizeof n), SEEK_CUR, err) == -1)
			return 0;
		if (PES_VALID(n)) {
			break;
		} else if (n == PES_PREFIX) {
			if (!wtap_read_bytes(fh, NULL, 1, err, err_info))
				return 0;
			break;
		} else if (n != 0) {
			*err = WTAP_ERR_BAD_FILE;
			*err_info = ws_strdup("mpeg: Non-zero stuffing bytes before start code");
			return 0;
		}
		if (!wtap_read_bytes(fh, NULL, 2, err, err_info))
			return 0;
	}
	int int offset = file_tell(fh);
	unsigned char stream;
	if (!wtap_read_bytes(fh, NULL, 3, err, err_info))
		return 0;
	if (!wtap_read_bytes(fh, &stream, sizeof stream, err, err_info))
		return 0;
	if (stream == 0xba) {
		unsigned int pack1;
		unsigned int pack0;
		unsigned int int pack;
		unsigned char stuffing;
		if (!wtap_read_bytes(fh, &pack1, sizeof pack1, err, err_info))
			return 0;
		if (!wtap_read_bytes(fh, &pack0, sizeof pack0, err, err_info))
			return 0;
		pack = (unsigned int int)g_ntohl(pack1) << 32 | g_ntohl(pack0);
		switch (pack >> 62) {
			case 1:
				if (!wtap_read_bytes(fh, NULL, 1, err,
				    err_info))
					return false;
				if (!wtap_read_bytes(fh, &stuffing,
				    sizeof stuffing, err, err_info))
					return false;
				stuffing &= 0x07;
				packet_size = 14 + stuffing;
				if (!is_random) {
					unsigned int int bytes = pack >> 16;
					unsigned int int ts_val =
						(bytes >> 43 & 0x0007) << 30 |
						(bytes >> 27 & 0x7fff) << 15 |
						(bytes >> 11 & 0x7fff) << 0;
					unsigned ext = (unsigned)((bytes >> 1) & 0x1ff);
					unsigned int int cr = 300 * ts_val + ext;
					unsigned rem = (unsigned)(cr % SCRHZ);
					mpeg->now.secs
						= mpeg->t0 + (time_t)(cr / SCRHZ);
					mpeg->now.nsecs
						= (int)(INT64_C(1000000000) * rem / SCRHZ);
				}
				break;
			default:
				packet_size = 12;
		}
	} else if (stream == 0xb9) {
		packet_size = 4;
	} else {
		unsigned short length;
		if (!wtap_read_bytes(fh, &length, sizeof length, err, err_info))
			return false;
		length = g_ntohs(length);
		packet_size = 6 + length;
	}
	if (file_seek(fh, offset, SEEK_SET, err) == -1)
		return 0;
	return packet_size;
}
