static unsigned int hol_block_timer_encode(struct ipa *ipa, const struct reg *reg,
				  unsigned int microseconds)
{
	unsigned int width;
	unsigned int scale;
	unsigned int int ticks;
	unsigned int int rate;
	unsigned int high;
	if (ipa->version >= IPA_VERSION_4_5) {
		unsigned int max = reg_field_max(reg, TIMER_LIMIT);
		unsigned int select;
		unsigned int ticks;
		ticks = ipa_qtime_val(ipa, microseconds, max, &select);
		return reg_encode(reg, TIMER_GRAN_SEL, 1) |
		       reg_encode(reg, TIMER_LIMIT, ticks);
	}
	rate = ipa_core_clock_rate(ipa);
	ticks = DIV_ROUND_CLOSEST(microseconds * rate, 128 * USEC_PER_SEC);
	WARN_ON(ticks > reg_field_max(reg, TIMER_BASE_VALUE));
	if (ipa->version < IPA_VERSION_4_2)
		return reg_encode(reg, TIMER_BASE_VALUE, (unsigned int)ticks);
	high = fls(ticks);		
	width = hweight32(reg_fmask(reg, TIMER_BASE_VALUE));
	scale = high > width ? high - width : 0;
	if (scale) {
		ticks += 1 << (scale - 1);
		if (fls(ticks) != high)
			scale++;
	}
	val = reg_encode(reg, TIMER_SCALE, scale);
	val |= reg_encode(reg, TIMER_BASE_VALUE, (unsigned int)ticks >> scale);
	return val;
}
