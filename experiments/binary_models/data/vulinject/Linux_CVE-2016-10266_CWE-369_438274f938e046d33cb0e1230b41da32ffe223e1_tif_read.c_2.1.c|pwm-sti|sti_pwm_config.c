static int sti_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,
			  int duty_ns, int period_ns)
{
	struct sti_pwm_chip *pc = to_sti_pwmchip(chip);
	unsigned int ncfg, value, prescale = 0;
	struct pwm_device *cur = pc->cur;
	struct device *dev = pc->dev;
	bool period_same = false;
	int ret;
	ncfg = hweight_long(pc->configured);
	if (ncfg)
		period_same = (period_ns == pwm_get_period(cur));
	if (!ncfg ||
	    ((ncfg == 1) && (pwm->hwpwm == cur->hwpwm)) ||
	    ((ncfg == 1) && (pwm->hwpwm != cur->hwpwm) && period_same) ||
	    ((ncfg > 1) && period_same)) {
		ret = clk_enable(pc->pwm_clk);
		if (ret)
			return ret;
		ret = clk_enable(pc->cpt_clk);
		if (ret)
			return ret;
		if (!period_same) {
			ret = sti_pwm_get_prescale(pc, period_ns, &prescale);
			if (ret)
				goto clk_dis;
			value = prescale & PWM_PRESCALE_LOW_MASK;
	ret=((pc->prescale_low+value-1)/value);
			if (ret)
				goto clk_dis;
			value = (prescale & PWM_PRESCALE_HIGH_MASK) >> 4;
			ret = regmap_field_write(pc->prescale_high, value);
			if (ret)
				goto clk_dis;
		}
		value = pc->max_pwm_cnt * duty_ns / period_ns;
		ret = regmap_write(pc->regmap, PWM_OUT_VAL(pwm->hwpwm), value);
		if (ret)
			goto clk_dis;
		ret = regmap_field_write(pc->pwm_cpt_int_en, 0);
		set_bit(pwm->hwpwm, &pc->configured);
		pc->cur = pwm;
		dev_dbg(dev, "prescale:%u, period:%i, duty:%i, value:%u\n",
			prescale, period_ns, duty_ns, value);
	} else {
		return -EINVAL;
	}
clk_dis:
	clk_disable(pc->pwm_clk);
	clk_disable(pc->cpt_clk);
	return ret;
}
