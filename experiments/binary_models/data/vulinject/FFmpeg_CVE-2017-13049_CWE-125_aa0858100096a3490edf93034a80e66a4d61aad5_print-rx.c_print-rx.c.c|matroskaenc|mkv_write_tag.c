static int mkv_write_tag(MatroskaMuxContext *mkv, const AVDictionary *m,
                         AVIOContext **pb, unsigned reserved_size,
                         uint32_t elementid, uint64_t uid)
{
    const AVDictionaryEntry *t = NULL;
    AVIOContext *const tmp_bc = mkv->tmp_bc;
    uint8_t *buf;
    int ret = 0, size, tag_written = 0;
    mkv_write_tag_targets(mkv, tmp_bc, elementid, uid);
    while ((t = av_dict_iterate(m, t))) {
        if (mkv_check_tag_name(t->key, elementid)) {
            ret = mkv_write_simpletag(tmp_bc, t);
            if (ret < 0)
                goto end;
            tag_written = 1;
        }
    }
    if (reserved_size)
        put_ebml_void(tmp_bc, reserved_size);
    else if (!tag_written)
        goto end;
    size = avio_get_dyn_buf(tmp_bc, &buf);
    if (tmp_bc->error) {
        ret = tmp_bc->error;
        goto end;
    }
    if (!*pb) {
        ret = start_ebml_master_crc32(pb, mkv);
        if (ret < 0)
            goto end;
    }
    put_ebml_binary(*pb, MATROSKA_ID_TAG, buf, size);
end:
    return ret;
}
