static int dissect_pdcp_nr(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)
{
    const char           *mode;
    proto_tree           *pdcp_tree          = NULL;
    proto_item           *root_ti            = NULL;
    proto_item           *ti;
    gint                 offset              = 0;
    struct pdcp_nr_info  *p_pdcp_info;
    tvbuff_t             *rohc_tvb           = NULL;
    pdcp_nr_security_info_t *current_security = NULL;   
    pdcp_nr_security_info_t *pdu_security;              
    proto_tree *security_tree = NULL;
    proto_item *security_ti;
    tvbuff_t *payload_tvb;
    pdu_security_settings_t  pdu_security_settings;
    gboolean payload_deciphered = FALSE;
    memset(&pdu_security_settings, 0, sizeof(pdu_security_settings));
    col_set_str(pinfo->cinfo, COL_PROTOCOL, "PDCP-NR");
    p_pdcp_info = (struct pdcp_nr_info *)p_get_proto_data(wmem_file_scope(), pinfo, proto_pdcp_nr, 0);
    if (p_pdcp_info == NULL) {
        if (!data) {
            return 0;
        }
        p_pdcp_info = (struct pdcp_nr_info *)data;
    }
    if (p_pdcp_info->plane == NR_SIGNALING_PLANE && p_pdcp_info->bearerType == Bearer_DCCH) {
        p_pdcp_info->seqnum_length = PDCP_NR_SN_LENGTH_12_BITS;
    }
    else if (p_pdcp_info->plane == NR_USER_PLANE) {
        pdcp_bearer_parameters *params = get_rlc_nr_drb_pdcp_mapping(p_pdcp_info->ueid, p_pdcp_info->bearerId);
        if (params) {
            if (p_pdcp_info->direction == DIRECTION_UPLINK) {
                p_pdcp_info->seqnum_length = params->pdcp_sn_bits_ul;
                if (params->pdcp_sdap_ul) {
                    p_pdcp_info->sdap_header |= PDCP_NR_UL_SDAP_HEADER_PRESENT;
                }
            }
            else {
                p_pdcp_info->seqnum_length = params->pdcp_sn_bits_dl;
                if (params->pdcp_sdap_dl) {
                    p_pdcp_info->sdap_header |= PDCP_NR_DL_SDAP_HEADER_PRESENT;
                }
            }
            p_pdcp_info->maci_present = params->pdcp_integrity;
            p_pdcp_info->ciphering_disabled = params->pdcp_ciphering_disabled;
        }
    }
    if ((global_pdcp_nr_layer_to_show == ShowRLCLayer) &&
        (p_get_proto_data(wmem_file_scope(), pinfo, proto_rlc_nr, 0) != NULL)) {
        col_set_writable(pinfo->cinfo, COL_INFO, FALSE);
    }
    else {
        col_clear(pinfo->cinfo, COL_INFO);
        col_set_writable(pinfo->cinfo, COL_INFO, TRUE);
    }
    if ((p_pdcp_info->plane == NR_SIGNALING_PLANE) && (p_pdcp_info->bearerType == Bearer_DCCH)) {
        p_pdcp_info->maci_present = TRUE;
    }
    if (tree) {
        root_ti = proto_tree_add_item(tree, proto_pdcp_nr, tvb, offset, -1, ENC_NA);
        pdcp_tree = proto_item_add_subtree(root_ti, ett_pdcp);
    }
    mode = val_to_str_const(p_pdcp_info->rohc.mode, rohc_mode_vals, "Error");
    if (pdcp_tree) {
        show_pdcp_config(pinfo, tvb, pdcp_tree, p_pdcp_info);
    }
    if (p_pdcp_info->rohc.rohc_compression) {
        col_append_fstr(pinfo->cinfo, COL_INFO, " (mode=%c)", mode[0]);
    }
    if (!PINFO_FD_VISITED(pinfo)) {
        current_security = (pdcp_nr_security_info_t*)wmem_map_lookup(pdcp_security_hash,
                                                                     GUINT_TO_POINTER((guint)p_pdcp_info->ueid));
        if (current_security != NULL) {
            pdcp_nr_security_info_t *security_to_store = wmem_new(wmem_file_scope(), pdcp_nr_security_info_t);
            *security_to_store = *current_security;
            if (p_pdcp_info->ciphering_disabled) {
                security_to_store->ciphering = nea_disabled;
            }
            wmem_map_insert(pdcp_security_result_hash,
                            get_ueid_frame_hash_key(p_pdcp_info->ueid, pinfo->num, TRUE),
                            security_to_store);
        }
        else {
            if ((global_default_ciphering_algorithm != nea0) ||
                (global_default_integrity_algorithm != nia0)) {
                pdcp_nr_security_info_t *security_to_store = wmem_new0(wmem_file_scope(), pdcp_nr_security_info_t);
                security_to_store->ciphering = global_default_ciphering_algorithm;
                security_to_store->integrity = global_default_integrity_algorithm;
                security_to_store->seen_next_ul_pdu = FALSE;
                wmem_map_insert(pdcp_security_result_hash,
                                get_ueid_frame_hash_key(p_pdcp_info->ueid, pinfo->num, TRUE),
                                security_to_store);
            }
        }
    }
    pdu_security = (pdcp_nr_security_info_t*)wmem_map_lookup(pdcp_security_result_hash,
                                                             get_ueid_frame_hash_key(p_pdcp_info->ueid, pinfo->num, FALSE));
    if (pdu_security != NULL) {
        security_ti = proto_tree_add_string_format(pdcp_tree,
                                                   hf_pdcp_nr_security,
                                                   tvb, 0, 0,
                                                   "", "UE Security");
        security_tree = proto_item_add_subtree(security_ti, ett_pdcp_security);
        if (pdu_security->algorithm_configuration_frame &&
            pinfo->num > pdu_security->algorithm_configuration_frame) {
            ti = proto_tree_add_uint(security_tree, hf_pdcp_nr_security_setup_frame,
                                     tvb, 0, 0, pdu_security->algorithm_configuration_frame);
            proto_item_set_generated(ti);
        }
        ti = proto_tree_add_uint(security_tree, hf_pdcp_nr_security_ciphering_algorithm,
                                 tvb, 0, 0, pdu_security->ciphering);
        proto_item_set_generated(ti);
        ti = proto_tree_add_uint(security_tree, hf_pdcp_nr_security_integrity_algorithm,
                                 tvb, 0, 0, pdu_security->integrity);
        proto_item_set_generated(ti);
        proto_item_append_text(security_ti, " (ciphering=%s, integrity=%s)",
                               val_to_str_const(pdu_security->ciphering, ciphering_algorithm_vals, "Unknown"),
                               val_to_str_const(pdu_security->integrity, integrity_algorithm_vals, "Unknown"));
        pdu_security_settings.ciphering = pdu_security->ciphering;
        pdu_security_settings.integrity = pdu_security->integrity;
    }
    guint32  seqnum = 0;
    gboolean seqnum_set = FALSE;
    guint8  first_byte = tvb_get_guint8(tvb, offset);
    if (p_pdcp_info->plane == NR_SIGNALING_PLANE) {
        if (p_pdcp_info->seqnum_length != 0) {
            guint8 reserved = (first_byte & 0xf0) >> 4;
            ti = proto_tree_add_item(pdcp_tree, hf_pdcp_nr_control_plane_reserved,
                                     tvb, offset, 1, ENC_BIG_ENDIAN);
            if (reserved != 0) {
                expert_add_info_format(pinfo, ti, &ei_pdcp_nr_reserved_bits_not_zero,
                                       "PDCP signalling header reserved bits not zero");
            }
            proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_seq_num_12, tvb, offset, 2, ENC_BIG_ENDIAN, &seqnum);
            seqnum_set = TRUE;
            write_pdu_label_and_info(root_ti, pinfo, " (SN=%-4u)", seqnum);
            offset += 2;
            if (tvb_captured_length_remaining(tvb, offset) == 0) {
                return offset;
            }
        }
    }
    else if (p_pdcp_info->plane == NR_USER_PLANE) {
        bool is_user_plane;
        proto_tree_add_item_ret_boolean(pdcp_tree, hf_pdcp_nr_data_control, tvb, offset, 1, ENC_BIG_ENDIAN, &is_user_plane);
        if (is_user_plane) {
            guint32 reserved_value;
            switch (p_pdcp_info->seqnum_length) {
            case PDCP_NR_SN_LENGTH_12_BITS:
                ti = proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_reserved3, tvb, offset, 1, ENC_BIG_ENDIAN, &reserved_value);
                if (reserved_value != 0) {
                    expert_add_info_format(pinfo, ti, &ei_pdcp_nr_reserved_bits_not_zero,
                                           "Reserved bits have value 0x%x - should be 0x0",
                                           reserved_value);
                }
                proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_seq_num_12, tvb, offset, 2, ENC_BIG_ENDIAN, &seqnum);
                seqnum_set = TRUE;
                offset += 2;
                break;
            case PDCP_NR_SN_LENGTH_18_BITS:
                ti = proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_reserved5, tvb, offset, 1, ENC_BIG_ENDIAN, &reserved_value);
                if (reserved_value != 0) {
                    expert_add_info_format(pinfo, ti, &ei_pdcp_nr_reserved_bits_not_zero,
                                           "Reserved bits have value 0x%x - should be 0x0",
                                           reserved_value);
                }
                proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_seq_num_18, tvb, offset, 3, ENC_BIG_ENDIAN, &seqnum);
                seqnum_set = TRUE;
                offset += 3;
                break;
            default:
                return 1;
            }
            write_pdu_label_and_info(root_ti, pinfo, " (SN=%-6u)", seqnum);
        }
        else {
            guint32 control_pdu_type;
            proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_control_pdu_type, tvb, offset, 1, ENC_BIG_ENDIAN, &control_pdu_type);
            switch (control_pdu_type) {
            case 0:    
            {
                guint32 fmc;
                guint   not_received = 0;
                guint   i, j, l;
                guint32 len, bit_offset;
                proto_tree *bitmap_tree;
                proto_item *bitmap_ti = NULL;
                gchar  *buff = NULL;
#define BUFF_SIZE 89
                guint32 reserved_value;
                ti = proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_reserved4, tvb, offset, 1, ENC_BIG_ENDIAN, &reserved_value);
                if (reserved_value != 0) {
                    expert_add_info_format(pinfo, ti, &ei_pdcp_nr_reserved_bits_not_zero,
                                           "Reserved bits have value 0x%x - should be 0x0",
                                           reserved_value);
                }
                offset++;
                proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_fmc, tvb, offset, 4, ENC_BIG_ENDIAN, &fmc);
                offset += 4;
                if (tvb_reported_length_remaining(tvb, offset) > 0) {
                    bitmap_ti = proto_tree_add_item(pdcp_tree, hf_pdcp_nr_bitmap, tvb,
                                                    offset, -1, ENC_NA);
                    bitmap_tree = proto_item_add_subtree(bitmap_ti, ett_pdcp_report_bitmap);
                    buff = (gchar *)wmem_alloc(wmem_packet_scope(), BUFF_SIZE);
                    len = tvb_reported_length_remaining(tvb, offset);
                    bit_offset = offset<<3;
                    for (i=0; i<len; i++) {
                        guint8 bits = tvb_get_bits8(tvb, bit_offset, 8);
                        for (l=0, j=0; l<8; l++) {
                            if ((bits << l) & 0x80) {
                                if (bitmap_tree) {
                                    j += snprintf(&buff[j], BUFF_SIZE-j, "%10u,", (unsigned)(fmc+(8*i)+l+1));
                                }
                            } else {
                                if (bitmap_tree) {
                                    j += (guint)g_strlcpy(&buff[j], "          ,", BUFF_SIZE-j);
                                }
                                not_received++;
                            }
                        }
                        if (bitmap_tree) {
                            proto_tree_add_uint_format(bitmap_tree, hf_pdcp_nr_bitmap_byte, tvb, bit_offset/8, 1, bits, "%s", buff);
                        }
                        bit_offset += 8;
                    }
                }
                if (bitmap_ti != NULL) {
                    proto_item_append_text(bitmap_ti, " (%u SNs not received)", not_received);
                }
                write_pdu_label_and_info(root_ti, pinfo, " Status Report (fmc=%u) not-received=%u",
                                         fmc, not_received);
            }
                return 1;
            case 1:     
                offset++;
                break;  
            }
        }
    }
    else {
        write_pdu_label_and_info(root_ti, pinfo, " - INVALID PLANE (%u)",
                                 p_pdcp_info->plane);
        return 1;
    }
    gint header_length = offset;
    if (seqnum_set) {
        gboolean do_analysis = FALSE;
        switch (global_pdcp_check_sequence_numbers) {
        case FALSE:
            break;
        case SEQUENCE_ANALYSIS_RLC_ONLY:
            if ((p_get_proto_data(wmem_file_scope(), pinfo, proto_rlc_nr, 0) != NULL) &&
                    !p_pdcp_info->is_retx) {
                do_analysis = TRUE;
            }
            break;
        case SEQUENCE_ANALYSIS_PDCP_ONLY:
            if (p_get_proto_data(wmem_file_scope(), pinfo, proto_rlc_nr, 0) == NULL) {
                do_analysis = TRUE;
            }
            break;
        }
        if (do_analysis) {
            checkBearerSequenceInfo(pinfo, tvb, p_pdcp_info,
                                    seqnum, pdcp_tree, security_tree,
                                    &pdu_security_settings);
        }
    }
    guint sdap_length = 0;
    if (p_pdcp_info->plane == NR_USER_PLANE) {
        if ((p_pdcp_info->direction == PDCP_NR_DIRECTION_UPLINK   && (p_pdcp_info->sdap_header & PDCP_NR_UL_SDAP_HEADER_PRESENT)) ||
            (p_pdcp_info->direction == PDCP_NR_DIRECTION_DOWNLINK && (p_pdcp_info->sdap_header & PDCP_NR_DL_SDAP_HEADER_PRESENT))) {
            sdap_length = 1;
        }
    }
    gboolean should_decipher = FALSE;
    if (pdu_security && !p_pdcp_info->ciphering_disabled) {
        if (p_pdcp_info->plane == NR_USER_PLANE) {
            should_decipher = TRUE;
        }
        else {
            should_decipher = pdu_security->seen_next_ul_pdu && !pdu_security->dl_after_reest_request;
        }
    }
    gint pdcp_offset = offset;
    payload_tvb = decipher_payload(tvb, pinfo, &offset, &pdu_security_settings, p_pdcp_info, sdap_length,
                                   should_decipher,
                                   &payload_deciphered);
    if (payload_deciphered) {
        proto_tree_add_item(pdcp_tree, hf_pdcp_nr_security_deciphered_data,
                            payload_tvb, 0,  tvb_reported_length(payload_tvb), ENC_NA);
    }
    if ((p_pdcp_info->direction == PDCP_NR_DIRECTION_DOWNLINK) && current_security && (current_security->dl_after_reest_request)) {
        current_security->dl_after_reest_request = FALSE;
    }
    proto_item *mac_ti = NULL;
    guint32  calculated_digest = 0;
    gboolean digest_was_calculated = FALSE;
    if (global_pdcp_check_integrity && p_pdcp_info->maci_present) {
        calculated_digest = calculate_digest(&pdu_security_settings, security_tree,
                                             tvb_new_subset_length(tvb, 0, header_length),
                                             payload_tvb,
                                             offset, sdap_length, &digest_was_calculated);
    }
    if (p_pdcp_info->plane == NR_SIGNALING_PLANE) {
        guint32 data_length = tvb_reported_length_remaining(payload_tvb, offset);
        if (p_pdcp_info->maci_present) {
            data_length -= 4;
        }
        if ((global_pdcp_dissect_signalling_plane_as_rrc) &&
            ((pdu_security == NULL) || (pdu_security->ciphering == nea0) || payload_deciphered ||
             p_pdcp_info->ciphering_disabled || !pdu_security->seen_next_ul_pdu || pdu_security->dl_after_reest_request)) {
            dissector_handle_t rrc_handle = lookup_rrc_dissector_handle(p_pdcp_info, data_length);
            if (rrc_handle != NULL) {
                tvbuff_t *rrc_payload_tvb = tvb_new_subset_length(payload_tvb, offset, data_length);
                gboolean was_writable = col_get_writable(pinfo->cinfo, COL_INFO);
                col_set_writable(pinfo->cinfo, COL_INFO, TRUE);
                call_dissector_only(rrc_handle, rrc_payload_tvb, pinfo, pdcp_tree, NULL);
                col_set_writable(pinfo->cinfo, COL_INFO, was_writable);
            }
            else {
                 proto_tree_add_item(pdcp_tree, hf_pdcp_nr_signalling_data, payload_tvb, offset,
                                     data_length, ENC_NA);
            }
            if (!PINFO_FD_VISITED(pinfo) &&
                (current_security != NULL) && !current_security->seen_next_ul_pdu &&
                p_pdcp_info->direction == PDCP_NR_DIRECTION_UPLINK)
            {
                current_security->seen_next_ul_pdu = TRUE;
            }
        }
        else {
            proto_tree_add_item(pdcp_tree, hf_pdcp_nr_signalling_data, payload_tvb, offset,
                                data_length, ENC_NA);
        }
    }
    else if (tvb_captured_length_remaining(payload_tvb, offset)) {
        gint payload_length = tvb_reported_length_remaining(payload_tvb, offset) - ((p_pdcp_info->maci_present) ? 4 : 0);
        if (sdap_length) {
            proto_item *sdap_ti;
            proto_tree *sdap_tree;
            guint32 qfi;
            sdap_ti = proto_tree_add_item(pdcp_tree, proto_sdap, tvb, pdcp_offset, 1, ENC_NA);
            sdap_tree = proto_item_add_subtree(sdap_ti, ett_sdap);
            if (p_pdcp_info->direction == PDCP_NR_DIRECTION_UPLINK) {
                bool data_control;
                proto_tree_add_item_ret_boolean(sdap_tree, hf_sdap_data_control, tvb, pdcp_offset, 1, ENC_NA, &data_control);
                proto_tree_add_item(sdap_tree, hf_sdap_reserved, tvb, pdcp_offset, 1, ENC_NA);
                proto_item_append_text(sdap_ti, " (%s", tfs_get_string(data_control, &pdu_type_bit));
            } else {
                bool rdi, rqi;
                proto_tree_add_item_ret_boolean(sdap_tree, hf_sdap_rdi, tvb, pdcp_offset, 1, ENC_NA, &rdi);
                proto_tree_add_item_ret_boolean(sdap_tree, hf_sdap_rqi, tvb, pdcp_offset, 1, ENC_NA, &rqi);
                proto_item_append_text(sdap_ti, " (RDI=%s, RQI=%s",
                                       tfs_get_string(rdi, &sdap_rdi), tfs_get_string(rqi, &sdap_rqi));
            }
            proto_tree_add_item_ret_uint(sdap_tree, hf_sdap_qfi, tvb, pdcp_offset, 1, ENC_NA, &qfi);
            if (!payload_deciphered) {
                offset += sdap_length;
                payload_length -= sdap_length;
            }
            proto_item_append_text(sdap_ti, "  QFI=%u)", qfi);
        }
        if (payload_length > 0) {
            if (!p_pdcp_info->rohc.rohc_compression) {
                if (global_pdcp_dissect_user_plane_as_ip &&
                   ((pdu_security == NULL) || (pdu_security->ciphering == nea0) || payload_deciphered)) {
                    tvbuff_t *ip_payload_tvb = tvb_new_subset_length(payload_tvb, offset, payload_length);
                    if (global_pdcp_nr_layer_to_show != ShowTrafficLayer) {
                        col_set_writable(pinfo->cinfo, COL_INFO, FALSE);
                    }
                    switch (tvb_get_guint8(ip_payload_tvb, 0) & 0xf0) {
                        case 0x40:
                            call_dissector_only(ip_handle, ip_payload_tvb, pinfo, pdcp_tree, NULL);
                            break;
                        case 0x60:
                            call_dissector_only(ipv6_handle, ip_payload_tvb, pinfo, pdcp_tree, NULL);
                            break;
                        default:
                            call_data_dissector(ip_payload_tvb, pinfo, pdcp_tree);
                            break;
                    }
                    if (global_pdcp_nr_layer_to_show == ShowTrafficLayer) {
                        col_set_writable(pinfo->cinfo, COL_INFO, FALSE);
                    }
                }
                else {
                    proto_tree_add_item(pdcp_tree, hf_pdcp_nr_user_plane_data, payload_tvb, offset, payload_length, ENC_NA);
                }
            }
            else {
                if (!global_pdcp_dissect_rohc) {
                    col_append_fstr(pinfo->cinfo, COL_PROTOCOL, "|ROHC(%s)",
                                    val_to_str_const(p_pdcp_info->rohc.profile, rohc_profile_vals, "Unknown"));
                    proto_tree_add_item(pdcp_tree, hf_pdcp_nr_user_plane_data, payload_tvb, offset, payload_length, ENC_NA);
                }
                else {
                    rohc_tvb = tvb_new_subset_length(payload_tvb, offset, payload_length);
                    if (global_pdcp_nr_layer_to_show != ShowTrafficLayer) {
                        col_set_writable(pinfo->cinfo, COL_INFO, FALSE);
                    }
                    else {
                        col_clear(pinfo->cinfo, COL_INFO);
                    }
                    call_dissector_with_data(rohc_handle, rohc_tvb, pinfo, tree, &p_pdcp_info->rohc);
                }
            }
        }
    }
    if (p_pdcp_info->maci_present) {
        gint mac_offset = tvb_reported_length(payload_tvb)-4;
        guint32 mac;
        mac_ti = proto_tree_add_item_ret_uint(pdcp_tree, hf_pdcp_nr_mac, payload_tvb, mac_offset, 4, ENC_BIG_ENDIAN, &mac);
        offset += 4;
        if (digest_was_calculated) {
            if (mac != calculated_digest) {
                expert_add_info_format(pinfo, mac_ti, &ei_pdcp_nr_digest_wrong,
                                       "MAC-I Digest wrong - calculated %08x but found %08x",
                                       calculated_digest, mac);
                proto_item_append_text(mac_ti, " (but calculated 0x%08x !)", calculated_digest);
            }
            else {
                proto_item_append_text(mac_ti, " [Matches calculated result]");
            }
        }
        col_append_fstr(pinfo->cinfo, COL_INFO, " MAC=0x%08x", mac);
    }
    col_set_writable(pinfo->cinfo, COL_INFO, global_pdcp_nr_layer_to_show == ShowRLCLayer);
    return tvb_captured_length(tvb);
}
