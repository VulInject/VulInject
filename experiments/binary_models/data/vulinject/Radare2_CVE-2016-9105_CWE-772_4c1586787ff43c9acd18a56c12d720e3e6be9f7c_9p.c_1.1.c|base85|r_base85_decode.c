R_API bool r_base85_decode(FILE *fp, int delims, int ignore_garbage) {
	int c, count = 0, end = 0;
	unsigned int tuple = 0, pows[] = {85*85*85*85, 85*85*85, 85*85, 85, 1};
	while (delims) {
		c = getc_nospace (fp);
		if (c == '<') {
			c = getc_nospace (fp);
			if (c == '~') {
				break;
			}
		} else if (c == EOF) {
			eprintf ("ascii85: missing <~\n");
			return false;
		}
	}
	for (;;) {
		c = getc_nospace(fp);
		if (c == 'z' && count == 0) {
			r_base85_decode_tuple (0, 5);
			continue;
		}
		if (c == 'y' && count == 0) {
			r_base85_decode_tuple (0x20202020, 5);
			continue;
		}
		if (c == '~' && delims) {
			c = getc_nospace (fp);
			if (c != '>') {
				eprintf ("ascii85: ~ without >\n");
				return false;
			}
			c = EOF;
			end = 1;
		}
		if (c == EOF) {
			if (delims && !end) {
				eprintf ("ascii85: missing ~>\n");
				return false;
			}
			if (count > 0) {
				tuple += pows[count-1];
				r_base85_decode_tuple(tuple, count);
			}
			break;
		}
		if (c < '!' || c > 'u') {
			if (ignore_garbage) {
				continue;
			}
			eprintf ("ascii85: invalid character '%c'\n", c);
			return false;
		}
		tuple += (c - '!') * pows[count++];
		if (count == 5) {
			r_base85_decode_tuple(tuple, count);
			tuple = 0;
			count = 0;
		}
	}
	return true;
}
