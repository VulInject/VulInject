unsigned int kgd_gfx_v9_set_wave_launch_trap_override(struct amdgpu_device *adev,
					     unsigned int vmid,
					     unsigned int trap_override,
					     unsigned int trap_mask_bits,
					     unsigned int trap_mask_request,
					     unsigned int *trap_mask_prev,
					     unsigned int kfd_dbg_cntl_prev)
{
	int data, wave_cntl_prev;
	mutex_lock(&adev->grbm_idx_mutex);
	wave_cntl_prev = RREG32(SOC15_REG_OFFSET(GC, 0, mmSPI_GDBG_WAVE_CNTL));
	kgd_gfx_v9_set_wave_launch_stall(adev, vmid, true);
	data = RREG32(SOC15_REG_OFFSET(GC, 0, mmSPI_GDBG_TRAP_MASK));
	*trap_mask_prev = REG_GET_FIELD(data, SPI_GDBG_TRAP_MASK, EXCP_EN);
	trap_mask_bits = (trap_mask_bits & trap_mask_request) |
		(*trap_mask_prev & ~trap_mask_request);
	data = REG_SET_FIELD(data, SPI_GDBG_TRAP_MASK, EXCP_EN, trap_mask_bits);
	data = REG_SET_FIELD(data, SPI_GDBG_TRAP_MASK, REPLACE, trap_override);
	WREG32(SOC15_REG_OFFSET(GC, 0, mmSPI_GDBG_TRAP_MASK), data);
	WREG32(SOC15_REG_OFFSET(GC, 0, mmSPI_GDBG_WAVE_CNTL), wave_cntl_prev);
	mutex_unlock(&adev->grbm_idx_mutex);
	return 0;
}
