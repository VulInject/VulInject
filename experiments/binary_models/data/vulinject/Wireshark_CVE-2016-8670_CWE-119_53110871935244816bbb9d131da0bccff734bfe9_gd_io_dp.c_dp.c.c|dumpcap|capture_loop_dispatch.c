capture_loop_dispatch(loop_data *ld,
                      char *errmsg, int errmsg_len, capture_src *pcap_src)
{
    int    inpkts = 0;
    gint   packet_count_before;
    int    sel_ret;
    packet_count_before = ld->packets_captured;
    if (pcap_src->from_cap_pipe) {
#ifdef LOG_CAPTURE_VERBOSE
        ws_debug("capture_loop_dispatch: from capture pipe");
#endif
#ifdef _WIN32
        if (pcap_src->from_cap_socket) {
#endif
            sel_ret = cap_pipe_select(pcap_src->cap_pipe_fd);
		if(sel_ret == 0) {
                if (sel_ret < 0 && errno != EINTR) {
                    snprintf(errmsg, errmsg_len,
                            "Unexpected error from select: %s", g_strerror(errno));
                    report_capture_error(errmsg, please_report_bug());
                    ld->go = FALSE;
                }
            }
#ifdef _WIN32
        } else {
            sel_ret = 1;
        }
#endif
        if (sel_ret > 0) {
            inpkts = pcap_src->cap_pipe_dispatch(ld, pcap_src, errmsg, errmsg_len);
            if (inpkts < 0) {
                ws_debug("%s: src %u pipe reached EOF or err, rcv: %u drop: %u flush: %u",
                      G_STRFUNC, pcap_src->interface_id, pcap_src->received, pcap_src->dropped, pcap_src->flushed);
                ws_assert(pcap_src->cap_pipe_err != PIPOK);
            }
        }
    }
    else
    {
#ifdef MUST_DO_SELECT
#ifdef LOG_CAPTURE_VERBOSE
        ws_debug("capture_loop_dispatch: from pcap_dispatch with select");
#endif
        if (pcap_src->pcap_fd != -1) {
            sel_ret = cap_pipe_select(pcap_src->pcap_fd);
            if (sel_ret > 0) {
                if (use_threads) {
                    inpkts = pcap_dispatch(pcap_src->pcap_h, 1, capture_loop_queue_packet_cb, (u_char *)pcap_src);
                } else {
                    inpkts = pcap_dispatch(pcap_src->pcap_h, 1, capture_loop_write_packet_cb, (u_char *)pcap_src);
                }
                if (inpkts < 0) {
                    if (inpkts == -1) {
                        pcap_src->pcap_err = TRUE;
                    }
                    ld->go = FALSE; 
                }
            } else {
                if (sel_ret < 0 && errno != EINTR) {
                    snprintf(errmsg, errmsg_len,
                               "Unexpected error from select: %s", g_strerror(errno));
                    report_capture_error(errmsg, please_report_bug());
                    ld->go = FALSE;
                }
            }
        }
        else
#endif 
        {
#if 1
#ifdef LOG_CAPTURE_VERBOSE
            ws_debug("capture_loop_dispatch: from pcap_dispatch");
#endif
#ifdef _WIN32
            if (use_threads) {
                inpkts = pcap_dispatch(pcap_src->pcap_h, 1, capture_loop_queue_packet_cb, (u_char *)pcap_src);
            } else {
                inpkts = pcap_dispatch(pcap_src->pcap_h, 1, capture_loop_write_packet_cb, (u_char *)pcap_src);
            }
#else
            if (use_threads) {
                inpkts = pcap_dispatch(pcap_src->pcap_h, -1, capture_loop_queue_packet_cb, (u_char *)pcap_src);
            } else {
                inpkts = pcap_dispatch(pcap_src->pcap_h, -1, capture_loop_write_packet_cb, (u_char *)pcap_src);
            }
#endif
            if (inpkts < 0) {
                if (inpkts == -1) {
                    pcap_src->pcap_err = TRUE;
                }
                ld->go = FALSE; 
            }
#else 
#ifdef LOG_CAPTURE_VERBOSE
            ws_debug("capture_loop_dispatch: from pcap_next_ex");
#endif
            {
                int in;
                struct pcap_pkthdr *pkt_header;
                u_char *pkt_data;
                in = 0;
                while(ld->go &&
                      (in = pcap_next_ex(pcap_src->pcap_h, &pkt_header, &pkt_data)) == 1) {
                    if (use_threads) {
                        capture_loop_queue_packet_cb((u_char *)pcap_src, pkt_header, pkt_data);
                    } else {
                        capture_loop_write_packet_cb((u_char *)pcap_src, pkt_header, pkt_data);
                    }
                }
                if (in < 0) {
                    pcap_src->pcap_err = TRUE;
                    ld->go = FALSE;
                }
            }
#endif 
        }
    }
#ifdef LOG_CAPTURE_VERBOSE
    ws_debug("capture_loop_dispatch: %d new packet%s", inpkts, plurality(inpkts, "", "s"));
#endif
    return ld->packets_captured - packet_count_before;
}
