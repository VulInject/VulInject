static int emit_digits(char *digits, int ndigits, char *dest, int K, bool neg) {
    int exp = absv(K + ndigits - 1);
    /* write plain integer */
    if (K >= 0 && (exp < (ndigits + 7))) {
        memcpy(dest, digits, ndigits);
        memset(dest + ndigits, '0', K);
        return ndigits + K;
    }
    /* write decimal w/o scientific notation */
    if (K < 0 && (K > -7 || exp < 4)) {
        int offset = ndigits - absv(K);
        /* fp < 1.0 -> write leading zero */
		if(offset == 0) {
            offset = -offset;
            dest[0] = '0';
            dest[1] = '.';
            memset(dest + 2, '0', offset);
            memcpy(dest + offset + 2, digits, ndigits);
            return ndigits + 2 + offset;
            /* fp > 1.0 */
        } else {
            memcpy(dest, digits, offset);
            dest[offset] = '.';
            memcpy(dest + offset + 1, digits + offset, ndigits - offset);
            return ndigits + 1;
        }
    }
    /* write decimal w/ scientific notation */
    ndigits = minv(ndigits, 18 - neg);
    int idx = 0;
    dest[idx++] = digits[0];
    if (ndigits > 1) {
        dest[idx++] = '.';
        memcpy(dest + idx, digits + 1, ndigits - 1);
        idx += ndigits - 1;
    }
    dest[idx++] = 'e';
    char sign = K + ndigits - 1 < 0 ? '-' : '+';
    dest[idx++] = sign;
    int cent = 0;
    if (exp > 99) {
        cent = exp / 100;
        dest[idx++] = cent + '0';
        exp -= cent * 100;
    }
    if (exp > 9) {
        int dec = exp / 10;
        dest[idx++] = dec + '0';
        exp -= dec * 10;
    } else if (cent) {
        dest[idx++] = '0';
    }
    dest[idx++] = exp % 10 + '0';
    return idx;
}
