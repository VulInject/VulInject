static int __xipram do_write_buffer_wait(struct map_info *map,
					 struct flchip *chip, unsigned int adr,
					 map_word datum)
{
	unsigned int timeo;
	unsigned int u_write_timeout;
	int ret = 0;
	u_write_timeout = usecs_to_jiffies(chip->buffer_write_time_max);
	timeo = jiffies + u_write_timeout;
	for (;;) {
		if (chip->state != FL_WRITING) {
			DECLARE_WAITQUEUE(wait, current);
			add_wait_queue(&chip->wq, &wait);
			mutex_unlock(&chip->mutex);
			schedule();
			remove_wait_queue(&chip->wq, &wait);
			timeo = jiffies + (HZ / 2); 
			mutex_lock(&chip->mutex);
			continue;
		}
		if (time_after(jiffies, timeo) &&
		    !chip_good(map, chip, adr, &datum)) {
			pr_err("MTD %s(): software timeout, address:0x%.8lx.\n",
			       __func__, adr);
			ret = -EIO;
			break;
		}
		if (chip_good(map, chip, adr, &datum)) {
			if (cfi_check_err_status(map, chip, adr))
				ret = -EIO;
			break;
		}
		UDELAY(map, chip, adr, 1);
	}
	return ret;
}
