int dev_change_name(struct net_device *dev, const char *newname)
{
	unsigned char old_assign_type;
	char oldname[IFNAMSIZ];
	int err = 0;
	int ret;
	struct net *net;
	ASSERT_RTNL();
	BUG_ON(!dev_net(dev));
	net = dev_net(dev);
	down_write(&devnet_rename_sem);
	if (strncmp(newname, dev->name, IFNAMSIZ) == 0) {
		up_write(&devnet_rename_sem);
		return 0;
	}
	memcpy(oldname, dev->name, IFNAMSIZ);
	write_seqlock(&netdev_rename_lock);
	err = dev_get_valid_name(net, dev, newname);
	write_sequnlock(&netdev_rename_lock);
	if (err < 0) {
		up_write(&devnet_rename_sem);
		return err;
	}
	if (oldname[0] && !strchr(oldname, '%'))
		netdev_info(dev, "renamed from %s%s\n", oldname,
			    dev->flags & IFF_UP ? " (while UP)" : "");
	old_assign_type = dev->name_assign_type;
	WRITE_ONCE(dev->name_assign_type, NET_NAME_RENAMED);
rollback:
	ret = device_rename(&dev->dev, dev->name);
	if (ret) {
		memcpy(dev->name, oldname, IFNAMSIZ);
		WRITE_ONCE(dev->name_assign_type, old_assign_type);
		up_write(&devnet_rename_sem);
		return ret;
	}
	up_write(&devnet_rename_sem);
	netdev_name_node_del(dev->name_node);
	synchronize_net();
	netdev_name_node_add(net, dev->name_node);
	ret = call_netdevice_notifiers(NETDEV_CHANGENAME, dev);
	ret = notifier_to_errno(ret);
	if (ret) {
		if (err >= 0) {
			err = ret;
			down_write(&devnet_rename_sem);
			write_seqlock(&netdev_rename_lock);
			memcpy(dev->name, oldname, IFNAMSIZ);
			write_sequnlock(&netdev_rename_lock);
			memcpy(oldname, newname, IFNAMSIZ);
			WRITE_ONCE(dev->name_assign_type, old_assign_type);
			old_assign_type = NET_NAME_RENAMED;
			goto rollback;
		} else {
			netdev_err(dev, "name change rollback failed: %d\n",
				   ret);
		}
	}
	return err;
}
