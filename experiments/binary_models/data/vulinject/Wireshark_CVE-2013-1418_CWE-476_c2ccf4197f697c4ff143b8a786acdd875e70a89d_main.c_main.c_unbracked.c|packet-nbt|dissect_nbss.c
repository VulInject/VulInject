dissect_nbss(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)
{
    struct tcpinfo *tcpinfo;
    int             offset  = 0;
    guint           length_remaining;
    guint           plen;
    int             max_data;
    guint8          msg_type;
    guint8          flags;
    guint32         length;
    gboolean        is_cifs;
    tvbuff_t       *next_tvb;
    tcpinfo = (struct tcpinfo *)data;
    col_set_str(pinfo->cinfo, COL_PROTOCOL, "NBSS");
    col_clear(pinfo->cinfo, COL_INFO);
    max_data = tvb_captured_length(tvb);
    msg_type = tvb_get_guint8(tvb, offset);
    if (pinfo->match_uint == TCP_PORT_CIFS) {
        is_cifs = TRUE;
    } else {
        is_cifs = FALSE;
    }
    if (!tcpinfo->is_reassembled) {
        if (max_data < 4) {
            if (try_val_to_str(msg_type, message_types)) {
                if (nbss_desegment && pinfo->can_desegment) {
                    pinfo->desegment_offset = offset;
                    pinfo->desegment_len = DESEGMENT_ONE_MORE_SEGMENT;
                    return tvb_captured_length(tvb);
                }
            }
            return dissect_continuation_packet(tvb, pinfo, tree);
        }
        if (tvb_captured_length_remaining(tvb, offset) >= 8
            && tvb_get_guint8(tvb,offset+0) == SESSION_MESSAGE
            && tvb_get_guint8(tvb,offset+5) == 'S'
            && tvb_get_guint8(tvb,offset+6) == 'M'
            && tvb_get_guint8(tvb,offset+7) == 'B') {
            is_cifs = TRUE;
        } else {
            is_cifs = FALSE;
        }
        if (is_cifs) {
            flags = 0;
            length = tvb_get_ntoh24(tvb, offset + 1);
        } else {
            flags  = tvb_get_guint8(tvb, offset + 1);
            length = tvb_get_ntohs(tvb, offset + 2);
            if (flags & NBSS_FLAGS_E)
                length += 0x10000;
        }
        if ((flags & (~NBSS_FLAGS_E)) != 0) {
            return dissect_continuation_packet(tvb, pinfo, tree);
        }
        switch (msg_type) {
        case SESSION_MESSAGE:
            if (length == 0)
                return dissect_continuation_packet(tvb, pinfo, tree);
            break;
        case SESSION_REQUEST:
            if (length < 2 || length > 256)
                return dissect_continuation_packet(tvb, pinfo, tree);
            break;
        case POSITIVE_SESSION_RESPONSE:
            if (length != 0)
                return dissect_continuation_packet(tvb, pinfo, tree);
            break;
        case NEGATIVE_SESSION_RESPONSE:
            if (length != 1)
                return dissect_continuation_packet(tvb, pinfo, tree);
            break;
        case RETARGET_SESSION_RESPONSE:
            if (length != 6)
                return dissect_continuation_packet(tvb, pinfo, tree);
            break;
        case SESSION_KEEP_ALIVE:
            if (length != 0)
                return dissect_continuation_packet(tvb, pinfo, tree);
            break;
        default:
            return dissect_continuation_packet(tvb, pinfo, tree);
        }
    }
    col_add_str(pinfo->cinfo, COL_INFO,
                val_to_str(msg_type, message_types, "Unknown (%02x)"));
    while ((length_remaining = tvb_reported_length_remaining(tvb, offset)) > 0) {
        if (nbss_desegment && pinfo->can_desegment) {
            if (length_remaining < 4) {
                pinfo->desegment_offset = offset;
                pinfo->desegment_len = DESEGMENT_ONE_MORE_SEGMENT;
                return tvb_captured_length(tvb);
            }
        }
        if (is_cifs) {
            length = tvb_get_ntoh24(tvb, offset + 1);
        } else {
            flags  = tvb_get_guint8(tvb, offset + 1);
            length = tvb_get_ntohs(tvb, offset + 2);
            if (flags & NBSS_FLAGS_E)
                length += 65536;
        }
        plen = length + 4; 
        if(!pinfo->fd->visited){
            if( ((int)plen>tvb_reported_length_remaining(tvb, offset))
                &&(tvb_captured_length_remaining(tvb, offset) >= 8)
                &&(tvb_get_guint8(tvb,offset+5) == 'S')
                &&(tvb_get_guint8(tvb,offset+6) == 'M')
                &&(tvb_get_guint8(tvb,offset+7) == 'B') ){
                pinfo->want_pdu_tracking = 2;
                pinfo->bytes_until_next_pdu = (length+4)-tvb_reported_length_remaining(tvb, offset);
            }
        }
        if (nbss_desegment && pinfo->can_desegment) {
            if (length_remaining < plen) {
                pinfo->desegment_offset = offset;
                pinfo->desegment_len = plen - length_remaining;
                return tvb_captured_length(tvb);
            }
        }
        next_tvb = tvb_new_subset_length(tvb, offset, plen);
        dissect_nbss_packet(next_tvb, pinfo, tree, is_cifs);
        offset += plen;
    }
    return tvb_captured_length(tvb);
}
