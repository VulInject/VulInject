ws_find_media_type_parameter(wmem_allocator_t *scope, const char *parameters, const char *key)
{
    const char *p, *name, *value;
    char c;
    gsize keylen, namelen, valuelen;
    char *valuestr, *vp;
    if (parameters == NULL || key == NULL)
        return NULL;
    keylen = (gsize) strlen(key);
    if (keylen == 0) {
        return NULL;
    }
    p = parameters;
    if (*p == '\0') {
        return NULL;
    }
    do {
        name = ws_get_next_media_type_parameter(p, &namelen, &value,
                                                &valuelen, &p);
        if (namelen == keylen && g_ascii_strncasecmp(name, key, keylen) == 0) {
            break;
        }
    } while (*p);
    if (value == NULL) {
        return NULL;
    }
    valuestr = (char *)wmem_alloc(scope, valuelen + 1);
    vp = valuestr;
    p = value;
    if (*p == '"') {
        p++;
        for (;;) {
            c = *p;
            if (c == '\0') {
                *vp = '\0';
                return valuestr;
            }
            if (c == '"') {
                p++;
                break;
            }
            if (c == '\\') {
                p++;
                if (*p == '\0') {
                    break;
                }
            }
            *vp++ = *p++;
        }
    } else {
        while ((c = *p) != '\0' && g_ascii_isgraph(c) && c != '(' &&
                c != ')' && c != '<' && c != '>' && c != '@' &&
                c != ',' && c != ';' && c != ':' && c != '\\' &&
                c != '"' && c != '/' && c != '[' && c != ']' &&
                c != '?' && c != '=' && c != '{' && c != '}') {
            *vp++ = c;
            p++;
        }
    }
    *vp = '\0';
    return valuestr;
}
