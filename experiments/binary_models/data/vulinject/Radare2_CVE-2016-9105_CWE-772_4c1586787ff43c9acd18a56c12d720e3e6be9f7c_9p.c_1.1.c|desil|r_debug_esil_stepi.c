R_API bool r_debug_esil_stepi(RDebug *d) {
	r_return_val_if_fail (d, false);
	RAnalOp op;
	ut8 obuf[64];
	int ret = 1;
	dbg = d;
	if (!ESIL) {
		ESIL = r_esil_new (32, true, 64);
		if (!ESIL) {
			return false;
		}
	}
	r_debug_reg_sync (dbg, R_REG_TYPE_GPR, false);
	opc = r_debug_reg_get (dbg, dbg->reg->name[R_REG_NAME_PC]);
	dbg->iob.read_at (dbg->iob.io, opc, obuf, sizeof (obuf));
	ESIL->cb.hook_mem_read = &esilbreak_mem_read;
	ESIL->cb.hook_mem_write = &esilbreak_mem_write;
	ESIL->cb.hook_reg_read = &esilbreak_reg_read;
	ESIL->cb.hook_reg_write = &esilbreak_reg_write;
	if (prestep) {
		if (r_debug_step (dbg, 1)<1) {
			R_LOG_WARN ("Step failed");
			return false;
		}
		r_debug_reg_sync (dbg, R_REG_TYPE_GPR, false);
	}
	if (r_anal_op (dbg->anal, &op, opc, obuf, sizeof (obuf), R_ARCH_OP_MASK_ESIL)) {
		if (esilbreak_check_pc (dbg, opc)) {
			R_LOG_WARN ("STOP AT 0x%08"PFMT64x, opc);
			ret = 0;
		} else {
			eprintf ("0x%08"PFMT64x"  %s\n", opc, R_STRBUF_SAFEGET (&op.esil));
			(void)r_esil_parse (ESIL, R_STRBUF_SAFEGET (&op.esil));
			r_esil_stack_free (ESIL);
			ret = 1;
		}
	}
	if (!prestep) {
		if (ret && !has_match) {
			if (r_debug_step (dbg, 1) < 1) {
				R_LOG_WARN ("Step has failed");
				return 0;
			}
			r_debug_reg_sync (dbg, R_REG_TYPE_GPR, false);
		}
	}
	return ret;
}
