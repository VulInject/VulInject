static int ibmveth_set_channels(struct net_device *netdev,
				struct ethtool_channels *channels)
{
	struct ibmveth_adapter *adapter = netdev_priv(netdev);
	unsigned int old = netdev->real_num_tx_queues,
		     goal = channels->tx_count;
	int rc, i;
	if (!(netdev->flags & IFF_UP))
	netif_tx_stop_all_queues(netdev);
	for (i = old; i < goal; i++) {
		if (adapter->tx_ltb_ptr[i])
			continue;
		rc = ibmveth_allocate_tx_ltb(adapter, i);
		if (!rc)
			continue;
		netdev_err(netdev, "Failed to allocate more tx queues, returning to %d queues\n",
			   old);
		goal = old;
		old = i;
		break;
	}
	rc = netif_set_real_num_tx_queues(netdev, goal);
	if (rc) {
		netdev_err(netdev, "Failed to set real tx queues, returning to %d queues\n",
			   old);
		goal = old;
		old = i;
	}
	for (i = old; i > goal; i--) {
		if (adapter->tx_ltb_ptr[i - 1])
			ibmveth_free_tx_ltb(adapter, i - 1);
	}
	netif_tx_wake_all_queues(netdev);
	return rc;
}
