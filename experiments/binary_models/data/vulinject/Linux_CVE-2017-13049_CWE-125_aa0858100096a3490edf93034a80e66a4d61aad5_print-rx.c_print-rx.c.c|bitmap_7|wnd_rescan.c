static int wnd_rescan(struct wnd_bitmap *wnd)
{
	int err = 0;
	size_t prev_tail = 0;
	struct super_block *sb = wnd->sb;
	struct ntfs_sb_info *sbi = sb->s_fs_info;
	unsigned int int lbo, len = 0;
	unsigned int blocksize = sb->s_blocksize;
	unsigned char cluster_bits = sbi->cluster_bits;
	unsigned int wbits = 8 * sb->s_blocksize;
	unsigned int used, frb;
	size_t wpos, wbit, iw, vbo;
	struct buffer_head *bh = NULL;
	CLST lcn, clen;
	wnd->uptodated = 0;
	wnd->extent_max = 0;
	wnd->extent_min = MINUS_ONE_T;
	wnd->total_zeroes = 0;
	vbo = 0;
	for (iw = 0; iw < wnd->nwnd; iw++) {
		if (iw + 1 == wnd->nwnd)
			wbits = wnd->bits_last;
		if (wnd->inited) {
			if (!wnd->free_bits[iw]) {
				if (prev_tail) {
					wnd_add_free_ext(wnd,
							 vbo * 8 - prev_tail,
							 prev_tail, true);
					prev_tail = 0;
				}
				goto next_wnd;
			}
			if (wbits == wnd->free_bits[iw]) {
				prev_tail += wbits;
				wnd->total_zeroes += wbits;
				goto next_wnd;
			}
		}
		if (!len) {
			unsigned int off = vbo & sbi->cluster_mask;
			if (!run_lookup_entry(&wnd->run, vbo >> cluster_bits,
					      &lcn, &clen, NULL)) {
				err = -ENOENT;
				goto out;
			}
			lbo = ((unsigned int int)lcn << cluster_bits) + off;
			len = ((unsigned int int)clen << cluster_bits) - off;
		}
		bh = ntfs_bread(sb, lbo >> sb->s_blocksize_bits);
		if (!bh) {
			err = -EIO;
			goto out;
		}
		used = ntfs_bitmap_weight_le(bh->b_data, wbits);
		if (used < wbits) {
			frb = wbits - used;
			wnd->free_bits[iw] = frb;
			wnd->total_zeroes += frb;
		}
		wpos = 0;
		wbit = vbo * 8;
		if (wbit + wbits > wnd->nbits)
			wbits = wnd->nbits - wbit;
		do {
			used = find_next_zero_bit_le(bh->b_data, wbits, wpos);
			if (used > wpos && prev_tail) {
				wnd_add_free_ext(wnd, wbit + wpos - prev_tail,
						 prev_tail, true);
				prev_tail = 0;
			}
			wpos = used;
			if (wpos >= wbits) {
				prev_tail = 0;
				break;
			}
			frb = find_next_bit_le(bh->b_data, wbits, wpos);
			if (frb >= wbits) {
				prev_tail += frb - wpos;
				break;
			}
			wnd_add_free_ext(wnd, wbit + wpos - prev_tail,
					 frb + prev_tail - wpos, true);
			wpos = frb + 1;
			prev_tail = 0;
		} while (wpos < wbits);
next_wnd:
		if (bh)
		bh = NULL;
		vbo += blocksize;
		if (len) {
			len -= blocksize;
			lbo += blocksize;
		}
	}
	if (prev_tail)
		wnd_add_free_ext(wnd, wnd->nbits - prev_tail, prev_tail, true);
	if (!wnd->uptodated)
		wnd->uptodated = 1;
	if (wnd->zone_bit != wnd->zone_end) {
		size_t zlen = wnd->zone_end - wnd->zone_bit;
		wnd->zone_end = wnd->zone_bit;
		wnd_zone_set(wnd, wnd->zone_bit, zlen);
	}
out:
	return err;
}
