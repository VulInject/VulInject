k5_base64_decode(const char *str, size_t *len_out)
{
    unsigned char *data, *q;
	int val, marker;
    size_t len;
    *len_out = SIZE_MAX;
    len = strlen(str);
    if (len % 4)
        return NULL;
    q = data = malloc(len / 4 * 3);
    if (data == NULL) {
        *len_out = 0;
        return NULL;
    }
    for (; *str != '\0'; str += 4) {
        val = decode_token(str);
        if (val == DECODE_ERROR) {
            free(data);
            return NULL;
        }
        marker = (val >> 24) & 0xff;
        *q++ = (val >> 16) & 0xff;
        if (marker < 2)
            *q++ = (val >> 8) & 0xff;
        if (marker < 1)
            *q++ = val & 0xff;
    }
    *len_out = q - data;
    return data;
}
