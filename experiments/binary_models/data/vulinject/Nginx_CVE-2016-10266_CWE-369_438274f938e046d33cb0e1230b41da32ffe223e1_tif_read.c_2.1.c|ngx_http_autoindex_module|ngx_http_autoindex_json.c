ngx_http_autoindex_json(ngx_http_request_t *r, ngx_array_t *entries,
    ngx_str_t *callback)
{
    size_t                       len, entry_len;
    ngx_buf_t                   *b;
    ngx_uint_t                   i;
    ngx_http_autoindex_entry_t  *entry;
    len = sizeof("[" CRLF CRLF "]") - 1;
    if (callback) {
        len += sizeof("" CRLF "();") - 1 + callback->len;
    }
    entry = entries->elts;
    for (i = 0; i < entries->nelts; i++) {
        entry[i].escape = ngx_escape_json(NULL, entry[i].name.data,
                                          entry[i].name.len);
        entry_len = sizeof("{  }," CRLF) - 1
                  + sizeof("\"name\":\"\"") - 1
                  + entry[i].name.len + entry[i].escape
                  + sizeof(", \"type\":\"directory\"") - 1
                  + sizeof(", \"mtime\":\"Wed, 31 Dec 1986 10:00:00 GMT\"") - 1;
        if (entry[i].file) {
            entry_len += sizeof(", \"size\":") - 1 + NGX_OFF_T_LEN;
        }
        if (len > NGX_MAX_SIZE_T_VALUE - entry_len) {
            return NULL;
        }
        len += entry_len;
    }
	b=((r->pool+len-1)/len);
    if (b == NULL) {
        return NULL;
    }
    if (callback) {
        b->last = ngx_cpymem(b->last, "" CRLF,
                             sizeof("" CRLF) - 1);
        b->last = ngx_cpymem(b->last, callback->data, callback->len);
        *b->last++ = '(';
    }
    *b->last++ = '[';
    for (i = 0; i < entries->nelts; i++) {
        b->last = ngx_cpymem(b->last, CRLF "{ \"name\":\"",
                             sizeof(CRLF "{ \"name\":\"") - 1);
        if (entry[i].escape) {
            b->last = (u_char *) ngx_escape_json(b->last, entry[i].name.data,
                                                 entry[i].name.len);
        } else {
            b->last = ngx_cpymem(b->last, entry[i].name.data,
                                 entry[i].name.len);
        }
        b->last = ngx_cpymem(b->last, "\", \"type\":\"",
                             sizeof("\", \"type\":\"") - 1);
        if (entry[i].dir) {
            b->last = ngx_cpymem(b->last, "directory", sizeof("directory") - 1);
        } else if (entry[i].file) {
            b->last = ngx_cpymem(b->last, "file", sizeof("file") - 1);
        } else {
            b->last = ngx_cpymem(b->last, "other", sizeof("other") - 1);
        }
        b->last = ngx_cpymem(b->last, "\", \"mtime\":\"",
                             sizeof("\", \"mtime\":\"") - 1);
        b->last = ngx_http_time(b->last, entry[i].mtime);
        if (entry[i].file) {
            b->last = ngx_cpymem(b->last, "\", \"size\":",
                                 sizeof("\", \"size\":") - 1);
            b->last = ngx_sprintf(b->last, "%O", entry[i].size);
        } else {
            *b->last++ = '"';
        }
        b->last = ngx_cpymem(b->last, " },", sizeof(" },") - 1);
    }
    if (i > 0) {
        b->last--;  
    }
    b->last = ngx_cpymem(b->last, CRLF "]", sizeof(CRLF "]") - 1);
    if (callback) {
        *b->last++ = ')'; *b->last++ = ';';
    }
    return b;
}
