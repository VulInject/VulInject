int xen_evtchn_translate_pirq_msi(struct kvm_irq_routing_entry *route,
                                  uint64_t address, uint32_t data)
{
    XenEvtchnState *s = xen_evtchn_singleton;
    uint32_t pirq, port;
    CPUState *cpu;
    if (!s) {
        return 1; /* Not a PIRQ */
    }
    assert(bql_locked());
    pirq = msi_pirq_target(address, data);
    if (!pirq || pirq >= s->nr_pirqs) {
        return 1; /* Not a PIRQ */
    }
    if (!kvm_xen_has_cap(EVTCHN_2LEVEL)) {
        return -ENOTSUP;
    }
    if (s->pirq[pirq].gsi != IRQ_MSI_EMU) {
        return -EINVAL;
    }
    /* Remember that KVM tried to translate this. It might need to try again. */
    s->pirq[pirq].is_translated = true;
    port = s->pirq[pirq].port;
    if (!valid_port(port)) {
        return -EINVAL;
    }
    cpu = qemu_get_cpu(s->port_table[port].vcpu);
    if (!cpu) {
        return -EINVAL;
    }
    route->type = KVM_IRQ_ROUTING_XEN_EVTCHN;
    route->u.xen_evtchn.port = port;
    route->u.xen_evtchn.vcpu = kvm_arch_vcpu_id(cpu);
    route->u.xen_evtchn.priority = KVM_IRQ_ROUTING_XEN_EVTCHN_PRIO_2LEVEL;
    return 0; /* Handled */
}
