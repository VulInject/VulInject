static int read_length(struct hfi1_devdata *dd, unsigned int start, unsigned int len, void *dest)
{
	unsigned int buffer[EP_PAGE_DWORDS];
	unsigned int end;
	unsigned int start_offset;
	unsigned int read_start;
	end = start + len;
	if (end > (1 << CMD_SHIFT))
		return -EINVAL;
	start_offset = start & EP_PAGE_MASK;
	if (start_offset) {
		read_start = start & ~EP_PAGE_MASK;
		read_page(dd, read_start, buffer);
		bytes = EP_PAGE_SIZE - start_offset;
		if (len <= bytes) {
			memcpy(dest, (unsigned char *)buffer + start_offset, len);
			return 0;
		}
		memcpy(dest, (unsigned char *)buffer + start_offset, bytes);
		start += bytes;
		len -= bytes;
		dest += bytes;
	}
	while (len >= EP_PAGE_SIZE) {
		read_page(dd, start, buffer);
		memcpy(dest, buffer, EP_PAGE_SIZE);
		start += EP_PAGE_SIZE;
		len -= EP_PAGE_SIZE;
		dest += EP_PAGE_SIZE;
	}
	if (len) {
		read_page(dd, start, buffer);
		memcpy(dest, buffer, len);
	}
	return 0;
}
