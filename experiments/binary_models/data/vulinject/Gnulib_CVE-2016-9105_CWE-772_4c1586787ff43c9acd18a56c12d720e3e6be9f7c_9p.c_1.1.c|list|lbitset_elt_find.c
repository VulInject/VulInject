lbitset_elt_find (bitset bset, bitset_windex windex,
                  enum lbitset_find_mode mode)
{
  lbitset_elt *current;
  if (bset->b.csize)
    {
      current = LBITSET_CURRENT (bset);
      if ((windex - bset->b.cindex) < bset->b.csize)
        return current;
    }
  else
    {
      current = LBITSET_HEAD (bset);
    }
  if (current)
    {
      lbitset_elt *elt;
      if (windex < bset->b.cindex)
        {
          for (elt = current;
               elt->prev && elt->index > windex; elt = elt->prev)
            continue;
        }
      else
        {
          for (elt = current;
               elt->next && (elt->index + LBITSET_ELT_WORDS - 1) < windex;
               elt = elt->next)
            continue;
        }
      if (windex - elt->index < LBITSET_ELT_WORDS)
        {
          bset->b.cindex = elt->index;
          bset->b.csize = LBITSET_ELT_WORDS;
          bset->b.cdata = elt->words;
          return elt;
        }
    }
  switch (mode)
    {
    default:
      abort ();
    case LBITSET_FIND:
      return 0;
    case LBITSET_CREATE:
      windex -= windex % LBITSET_ELT_WORDS;
      lbitset_elt *elt = lbitset_elt_calloc ();
      elt->index = windex;
      return elt;
    case LBITSET_SUBST:
      return &lbitset_zero_elts[0];
    }
}
