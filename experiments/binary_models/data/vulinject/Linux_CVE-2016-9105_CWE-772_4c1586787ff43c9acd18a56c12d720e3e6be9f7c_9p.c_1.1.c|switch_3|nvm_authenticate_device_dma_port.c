static int nvm_authenticate_device_dma_port(struct tb_switch *sw)
{
	int ret, retries = 10;
	ret = dma_port_flash_update_auth(sw->dma_port);
	switch (ret) {
	case 0:
	case -ETIMEDOUT:
	case -EACCES:
	case -EINVAL:
		break;
	default:
		return ret;
	}
	do {
		unsigned int status;
		ret = dma_port_flash_update_auth_status(sw->dma_port, &status);
		if (ret < 0 && ret != -ETIMEDOUT)
			return ret;
		if (ret > 0) {
			if (status) {
				tb_sw_warn(sw, "failed to authenticate NVM\n");
			}
			tb_sw_info(sw, "power cycling the switch now\n");
			dma_port_power_cycle(sw->dma_port);
			return 0;
		}
		msleep(500);
	} while (--retries);
	return -ETIMEDOUT;
}
