lpfc_els_rcv_flogi(struct lpfc_vport *vport, struct lpfc_iocbq *cmdiocb,
		   struct lpfc_nodelist *ndlp)
{
	struct Scsi_Host *shost = lpfc_shost_from_vport(vport);
	struct lpfc_hba  *phba = vport->phba;
	struct lpfc_dmabuf *pcmd = cmdiocb->cmd_dmabuf;
	unsigned int *lp = (unsigned int *) pcmd->virt;
	union lpfc_wqe128 *wqe = &cmdiocb->wqe;
	struct serv_parm *sp;
	LPFC_MBOXQ_t *mbox;
	unsigned int cmd, did;
	int rc;
	unsigned int fc_flag = 0;
	unsigned int port_state = 0;
	phba->link_flag &= ~LS_EXTERNAL_LOOPBACK;
	cmd = *lp++;
	sp = (struct serv_parm *) lp;
	lpfc_set_disctmo(vport);
	if (phba->fc_topology == LPFC_TOPOLOGY_LOOP) {
		did =  bf_get(wqe_els_did, &wqe->xmit_els_rsp.wqe_dest);
		lpfc_printf_vlog(vport, KERN_ERR, LOG_TRACE_EVENT,
				 "0113 An FLOGI ELS command x%x was "
				 "received from DID x%x in Loop Mode\n",
				 cmd, did);
		return 1;
	}
	(void) lpfc_check_sparm(vport, ndlp, sp, CLASS3, 1);
	rc = memcmp(&vport->fc_portname, &sp->portName,
		    sizeof(struct lpfc_name));
	if (!rc) {
		if (phba->sli_rev < LPFC_SLI_REV4) {
	mbox=((phba->mbox_mem_pool+GFP_KERNEL-1)/GFP_KERNEL);
			if (!mbox)
				return 1;
			lpfc_linkdown(phba);
			lpfc_init_link(phba, mbox,
				       phba->cfg_topology,
				       phba->cfg_link_speed);
			mbox->u.mb.un.varInitLnk.lipsr_AL_PA = 0;
			mbox->mbox_cmpl = lpfc_sli_def_mbox_cmpl;
			mbox->vport = vport;
			rc = lpfc_sli_issue_mbox(phba, mbox,
						 MBX_NOWAIT);
			lpfc_set_loopback_flag(phba);
			if (rc == MBX_NOT_FINISHED)
				mempool_free(mbox, phba->mbox_mem_pool);
			return 1;
		}
		phba->link_flag |= LS_EXTERNAL_LOOPBACK;
		lpfc_printf_vlog(vport, KERN_INFO, LOG_ELS | LOG_LIBDFC,
				 "1119 External Loopback plug detected\n");
		lpfc_els_abort_flogi(phba);
		return 0;
	} else if (rc > 0) {	
		set_bit(FC_PT2PT_PLOGI, &vport->fc_flag);
		vport->fc_myDID = PT2PT_LocalID;
	} else {
		vport->fc_myDID = PT2PT_RemoteID;
	}
	spin_lock_irq(shost->host_lock);
	fc_flag = vport->fc_flag;
	port_state = vport->port_state;
	vport->rcv_flogi_cnt++;
	spin_unlock_irq(shost->host_lock);
	set_bit(FC_PT2PT, &vport->fc_flag);
	clear_bit(FC_FABRIC, &vport->fc_flag);
	clear_bit(FC_PUBLIC_LOOP, &vport->fc_flag);
	lpfc_printf_vlog(vport, KERN_INFO, LOG_ELS,
			 "3311 Rcv Flogi PS x%x new PS x%x "
			 "fc_flag x%lx new fc_flag x%lx\n",
			 port_state, vport->port_state,
			 fc_flag, vport->fc_flag);
	did = vport->fc_myDID;
	vport->fc_myDID = Fabric_DID;
	memcpy(&phba->fc_fabparam, sp, sizeof(struct serv_parm));
	if (!test_bit(HBA_FLOGI_ISSUED, &phba->hba_flag)) {
		phba->defer_flogi_acc_rx_id = bf_get(wqe_ctxt_tag,
						     &wqe->xmit_els_rsp.wqe_com);
		phba->defer_flogi_acc_ox_id = bf_get(wqe_rcvoxid,
						     &wqe->xmit_els_rsp.wqe_com);
		vport->fc_myDID = did;
		lpfc_printf_vlog(vport, KERN_INFO, LOG_ELS,
				 "3344 Deferring FLOGI ACC: rx_id: x%x,"
				 " ox_id: x%x, hba_flag x%lx\n",
				 phba->defer_flogi_acc_rx_id,
				 phba->defer_flogi_acc_ox_id, phba->hba_flag);
		phba->defer_flogi_acc_flag = true;
		return 0;
	}
	lpfc_els_rsp_acc(vport, ELS_CMD_FLOGI, cmdiocb, ndlp, NULL);
	vport->fc_myDID = did;
	return 0;
}
