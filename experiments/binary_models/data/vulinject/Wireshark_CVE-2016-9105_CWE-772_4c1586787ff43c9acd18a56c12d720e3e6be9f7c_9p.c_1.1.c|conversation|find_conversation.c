find_conversation(const guint32 frame_num, const address *addr_a, const address *addr_b, const conversation_type ctype,
        const guint32 port_a, const guint32 port_b, const guint options)
{
    conversation_t *conversation, *other_conv;
    if (!addr_a) {
        addr_a = &null_address_;
    }
    if (!addr_b) {
        addr_b = &null_address_;
    }
    DINSTR(gchar *addr_a_str = address_to_str(NULL, addr_a));
    DINSTR(gchar *addr_b_str = address_to_str(NULL, addr_b));
    DISSECTOR_ASSERT_HINT((options == 0) || (options & NO_MASK_B), "Use NO_ADDR_B and/or NO_PORT_B as option");
    if (!(options & (NO_ADDR_B|NO_PORT_B|NO_PORTS))) {
        DPRINT(("trying exact match: %s:%d -> %s:%d",
                    addr_a_str, port_a, addr_b_str, port_b));
        conversation = conversation_lookup_exact(frame_num, addr_a, port_a, addr_b, port_b, ctype);
        DPRINT(("trying exact match: %s:%d -> %s:%d",
                    addr_b_str, port_b, addr_a_str, port_a));
        other_conv = conversation_lookup_exact(frame_num, addr_b, port_b, addr_a, port_a, ctype);
        if (other_conv != NULL) {
            if (conversation != NULL) {
                if(other_conv->conv_index > conversation->conv_index) {
                    conversation = other_conv;
                }
            }
            else {
                conversation = other_conv;
            }
        }
        if ((conversation == NULL) && (addr_a->type == AT_FC)) {
            DPRINT(("trying exact match: %s:%d -> %s:%d",
                        addr_b_str, port_a, addr_a_str, port_b));
            conversation = conversation_lookup_exact(frame_num, addr_b, port_a, addr_a, port_b, ctype);
        }
        DPRINT(("exact match %sfound",conversation?"":"not "));
        if (conversation != NULL)
            goto end;
    }
    if (!(options & (NO_PORT_B|NO_PORTS))) {
        DPRINT(("trying wildcarded match: %s:%d -> *:%d",
                    addr_a_str, port_a, port_b));
        conversation = conversation_lookup_no_addr2(frame_num, addr_a, port_a, port_b, ctype);
        if ((conversation == NULL) && (addr_a->type == AT_FC)) {
            DPRINT(("trying wildcarded match: %s:%d -> *:%d",
                        addr_b_str, port_a, port_b));
            conversation = conversation_lookup_no_addr2(frame_num, addr_b, port_a, port_b, ctype);
        }
        if (conversation != NULL) {
            DPRINT(("wildcarded dest address match found"));
            if (!(conversation->options & NO_ADDR2) && ctype != CONVERSATION_UDP)
            {
                if (!(conversation->options & CONVERSATION_TEMPLATE))
                {
                }
                else
                {
                    conversation =
                        conversation_create_from_template(conversation, addr_b, 0);
                }
            }
            goto end;
        }
        if (!(options & NO_ADDR_B)) {
            DPRINT(("trying wildcarded match: %s:%d -> *:%d",
                        addr_b_str, port_b, port_a));
            conversation = conversation_lookup_no_addr2(frame_num, addr_b, port_b, port_a, ctype);
            if (conversation != NULL) {
                DPRINT(("match found"));
                if (ctype != CONVERSATION_UDP) {
                    if (!(conversation->options & CONVERSATION_TEMPLATE))
                    {
                        conversation_set_addr2(conversation, addr_a);
                    }
                    else
                    {
                        conversation =
                            conversation_create_from_template(conversation, addr_a, 0);
                    }
                }
                goto end;
            }
        }
    }
    if (!(options & (NO_ADDR_B|NO_PORTS))) {
        DPRINT(("trying wildcarded match: %s:%d -> %s:*",
                    addr_a_str, port_a, addr_b_str));
        conversation = conversation_lookup_no_port2(frame_num, addr_a, port_a, addr_b, ctype);
        if ((conversation == NULL) && (addr_a->type == AT_FC)) {
            DPRINT(("trying wildcarded match: %s:%d -> %s:*", addr_b_str, port_a, addr_a_str));
            conversation = conversation_lookup_no_port2(frame_num, addr_b, port_a, addr_a, ctype);
        }
        if (conversation != NULL) {
            DPRINT(("match found"));
            if (!(conversation->options & NO_PORT2) && ctype != CONVERSATION_UDP)
            {
                if (!(conversation->options & CONVERSATION_TEMPLATE))
                {
                    conversation_set_port2(conversation, port_b);
                }
                else
                {
                    conversation =
                        conversation_create_from_template(conversation, 0, port_b);
                }
            }
            goto end;
        }
        if (!(options & NO_PORT_B)) {
            DPRINT(("trying wildcarded match: %s:%d -> %s:*",
                        addr_b_str, port_b, addr_a_str));
            conversation = conversation_lookup_no_port2(frame_num, addr_b, port_b, addr_a, ctype);
            if (conversation != NULL) {
                DPRINT(("match found"));
                if (ctype != CONVERSATION_UDP)
                {
                    if (!(conversation->options & CONVERSATION_TEMPLATE))
                    {
                        conversation_set_port2(conversation, port_a);
                    }
                    else
                    {
                        conversation =
                            conversation_create_from_template(conversation, 0, port_a);
                    }
                }
                goto end;
            }
        }
    }
    DPRINT(("trying wildcarded match: %s:%d -> *:*", addr_a_str, port_a));
    conversation = conversation_lookup_no_addr2_or_port2(frame_num, addr_a, port_a, ctype);
    if (conversation != NULL) {
        DPRINT(("match found"));
        if (ctype != CONVERSATION_UDP)
        {
            if (!(conversation->options & CONVERSATION_TEMPLATE))
            {
                if (!(conversation->options & NO_ADDR2))
                    conversation_set_addr2(conversation, addr_b);
                if (!(conversation->options & NO_PORT2))
                    conversation_set_port2(conversation, port_b);
            }
            else
            {
                conversation =
                    conversation_create_from_template(conversation, addr_b, port_b);
            }
        }
        goto end;
    }
    if (ctype != CONVERSATION_IBQP)
    {
        if (addr_a->type == AT_FC) {
            DPRINT(("trying wildcarded match: %s:%d -> *:*",
                        addr_b_str, port_a));
            conversation = conversation_lookup_no_addr2_or_port2(frame_num, addr_b, port_a, ctype);
        } else {
            DPRINT(("trying wildcarded match: %s:%d -> *:*",
                        addr_b_str, port_b));
            conversation = conversation_lookup_no_addr2_or_port2(frame_num, addr_b, port_b, ctype);
        }
        if (conversation != NULL) {
            DPRINT(("match found"));
            if (ctype != CONVERSATION_UDP)
            {
                if (!(conversation->options & CONVERSATION_TEMPLATE))
                {
                    conversation_set_addr2(conversation, addr_a);
                    conversation_set_port2(conversation, port_a);
                }
                else
                {
                    conversation = conversation_create_from_template(conversation, addr_a, port_a);
                }
            }
            goto end;
        }
    }
    if (options & NO_PORT_X) {
        DPRINT(("trying exact match: %s -> %s",
                    addr_a_str, addr_b_str));
        conversation = conversation_lookup_no_ports(frame_num, addr_a, addr_b, ctype);
        if (conversation != NULL) {
            DPRINT(("match found"));
            goto end;
        }
        else {
            conversation = conversation_lookup_no_ports(frame_num, addr_b, addr_a, ctype);
            if (conversation != NULL) {
                DPRINT(("match found"));
                goto end;
            }
        }
    }
    DPRINT(("no matches found"));
    conversation = NULL;
end:
    DINSTR(wmem_free(NULL, addr_a_str));
    DINSTR(wmem_free(NULL, addr_b_str));
    return conversation;
}
