static void ccw_init(MachineState *machine)
{
    MachineClass *mc = MACHINE_GET_CLASS(machine);
    int ret;
    VirtualCssBus *css_bus;
    DeviceState *dev;
    s390_sclp_init();
    /* init memory + setup max page size. Required for the CPU model */
    s390_init_cpus(machine);
    /* Need CPU model to be determined before we can set up PV */
    s390_pv_init(machine->cgs, &error_fatal);
    s390_flic_init();
    /* init the SIGP facility */
    s390_init_sigp();
    /* create AP bridge and bus(es) */
    s390_init_ap();
    /* get a BUS */
    css_bus = virtual_css_bus_init();
    s390_init_ipl_dev(machine->kernel_filename, machine->kernel_cmdline,
                      machine->initrd_filename,
                      machine->firmware ?: "s390-ccw.img",
                      "s390-netboot.img", true);
    dev = qdev_new(TYPE_S390_PCI_HOST_BRIDGE);
    object_property_add_child(qdev_get_machine(), TYPE_S390_PCI_HOST_BRIDGE,
                              OBJECT(dev));
    sysbus_realize_and_unref(SYS_BUS_DEVICE(dev), &error_fatal);
    /* register hypercalls */
    virtio_ccw_register_hcalls();
    s390_enable_css_support(s390_cpu_addr2state(0));
    ret = css_create_css_image(VIRTUAL_CSSID, true);
    assert(ret == 0);
    if (css_migration_enabled()) {
        css_register_vmstate();
    }
    /* Create VirtIO network adapters */
    s390_create_virtio_net(BUS(css_bus), mc->default_nic);
    /* init consoles */
    if (serial_hd(0)) {
        s390_create_sclpconsole("sclpconsole", serial_hd(0));
    }
    if (serial_hd(1)) {
        s390_create_sclpconsole("sclplmconsole", serial_hd(1));
    }
    /* init the TOD clock */
    s390_init_tod();
}
