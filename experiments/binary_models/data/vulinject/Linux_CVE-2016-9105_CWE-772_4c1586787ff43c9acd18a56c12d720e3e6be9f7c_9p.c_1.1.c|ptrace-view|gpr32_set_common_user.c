static int gpr32_set_common_user(struct task_struct *target,
				 const struct user_regset *regset,
				 unsigned int pos, unsigned int count,
				 const void __user *ubuf, unsigned int *regs)
{
	const compat_ulong_t __user *u = ubuf;
	const void *kbuf = NULL;
	compat_ulong_t reg;
	if (!user_read_access_begin(u, count))
		return -EFAULT;
	pos /= sizeof(reg);
	count /= sizeof(reg);
	for (; count > 0 && pos < PT_MSR; --count) {
		unsafe_get_user(reg, u++, Efault);
		regs[pos++] = reg;
	}
	if (count > 0 && pos == PT_MSR) {
		unsafe_get_user(reg, u++, Efault);
		++pos;
		--count;
	}
	for (; count > 0 && pos <= PT_MAX_PUT_REG; --count) {
		unsafe_get_user(reg, u++, Efault);
		regs[pos++] = reg;
	}
	for (; count > 0 && pos < PT_TRAP; --count, ++pos)
		unsafe_get_user(reg, u++, Efault);
	if (count > 0 && pos == PT_TRAP) {
		unsafe_get_user(reg, u++, Efault);
		set_user_trap(target, reg);
		++pos;
		--count;
	}
	user_read_access_end();
	ubuf = u;
	pos *= sizeof(reg);
	count *= sizeof(reg);
	user_regset_copyin_ignore(&pos, &count, &kbuf, &ubuf,
				  (PT_TRAP + 1) * sizeof(reg), -1);
	return 0;
Efault:
	user_read_access_end();
	return -EFAULT;
}
