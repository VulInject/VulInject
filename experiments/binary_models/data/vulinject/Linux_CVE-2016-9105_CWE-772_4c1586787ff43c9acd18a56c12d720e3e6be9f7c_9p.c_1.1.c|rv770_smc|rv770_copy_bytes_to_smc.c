int rv770_copy_bytes_to_smc(struct radeon_device *rdev,
			    unsigned short smc_start_address, const unsigned char *src,
			    unsigned short byte_count, unsigned short limit)
{
	unsigned int flags;
	unsigned int data, original_data, extra_shift;
	unsigned short addr;
	int ret = 0;
	if (smc_start_address & 3)
		return -EINVAL;
	if ((smc_start_address + byte_count) > limit)
		return -EINVAL;
	addr = smc_start_address;
	spin_lock_irqsave(&rdev->smc_idx_lock, flags);
	while (byte_count >= 4) {
		data = (src[0] << 24) | (src[1] << 16) | (src[2] << 8) | src[3];
		ret = rv770_set_smc_sram_address(rdev, addr, limit);
		if (ret)
			goto done;
		src += 4;
		byte_count -= 4;
		addr += 4;
	}
	if (byte_count > 0) {
		data = 0;
		ret = rv770_set_smc_sram_address(rdev, addr, limit);
		if (ret)
			goto done;
		original_data = RREG32(SMC_SRAM_DATA);
		extra_shift = 8 * (4 - byte_count);
		while (byte_count > 0) {
			data = (data << 8) + *src++;
			byte_count--;
		}
		data <<= extra_shift;
		data |= (original_data & ~((~0UL) << extra_shift));
		ret = rv770_set_smc_sram_address(rdev, addr, limit);
		if (ret)
			goto done;
		WREG32(SMC_SRAM_DATA, data);
	}
done:
	spin_unlock_irqrestore(&rdev->smc_idx_lock, flags);
	return ret;
}
