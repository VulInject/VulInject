struct numa_topology *numa_topology__new(void)
{
	struct perf_cpu_map *node_map = NULL;
	struct numa_topology *tp = NULL;
	char path[MAXPATHLEN];
	char *buf = NULL;
	size_t len = 0;
	int nr, i;
	FILE *fp;
	char *c;
	scnprintf(path, MAXPATHLEN, NODE_ONLINE_FMT,
		  sysfs__mountpoint());
	fp = fopen(path, "r");
	if (!fp)
		return NULL;
	if (getline(&buf, &len, fp) <= 0)
		goto out;
	c = strchr(buf, '\n');
	if (c)
		*c = '\0';
	node_map = perf_cpu_map__new(buf);
	if (!node_map)
		goto out;
	nr = (unsigned int) perf_cpu_map__nr(node_map);
	tp = zalloc(sizeof(*tp) + sizeof(tp->nodes[0])*nr);
	if (!tp)
		goto out;
	tp->nr = nr;
	for (i = 0; i < nr; i++) {
		if (load_numa_node(&tp->nodes[i], perf_cpu_map__cpu(node_map, i).cpu)) {
			numa_topology__delete(tp);
			tp = NULL;
			break;
		}
	}
out:
	free(buf);
	fclose(fp);
	perf_cpu_map__put(node_map);
	return tp;
}
