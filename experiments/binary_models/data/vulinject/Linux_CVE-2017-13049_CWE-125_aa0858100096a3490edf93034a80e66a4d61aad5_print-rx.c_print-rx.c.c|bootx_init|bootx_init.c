void __init bootx_init(unsigned int r3, unsigned int r4)
{
	boot_infos_t *bi = (boot_infos_t *) r4;
	unsigned int hdr;
	unsigned int space;
	unsigned int ptr;
	char *model;
	reloc_got2(offset);
	bootx_info = bi;
	bootx_dt_strbase = bootx_dt_strend = 0;
	bootx_node_chosen = 0;
	bootx_disp_path[0] = 0;
	if (!BOOT_INFO_IS_V2_COMPATIBLE(bi))
		bi->logicalDisplayBase = bi->dispDeviceBase;
	if (bi->dispDeviceDepth == 16)
		bi->dispDeviceDepth = 15;
#ifdef CONFIG_BOOTX_TEXT
	ptr = (unsigned int)bi->logicalDisplayBase;
	ptr += bi->dispDeviceRect[1] * bi->dispDeviceRowBytes;
	ptr += bi->dispDeviceRect[0] * ((bi->dispDeviceDepth + 7) / 8);
	btext_setup_display(bi->dispDeviceRect[2] - bi->dispDeviceRect[0],
			    bi->dispDeviceRect[3] - bi->dispDeviceRect[1],
			    bi->dispDeviceDepth, bi->dispDeviceRowBytes,
			    (unsigned int)bi->logicalDisplayBase);
	btext_clearscreen();
	btext_flushscreen();
#endif 
	if (!BOOT_INFO_IS_COMPATIBLE(bi)) {
		bootx_printf(" !!! WARNING - Incompatible version"
			     " of BootX !!!\n\n\n");
		for (;;)
			;
	}
	if (bi->architecture != BOOT_ARCH_PCI) {
		bootx_printf(" !!! WARNING - Unsupported machine"
			     " architecture !\n");
		for (;;)
			;
	}
#ifdef CONFIG_BOOTX_TEXT
	btext_welcome(bi);
#endif
	if (bi->version < 4) {
		model = (char *) bootx_early_getprop(r4 + bi->deviceTreeOffset,
						     4, "model");
		if (model
		    && (strcmp(model, "iMac,1") == 0
			|| strcmp(model, "PowerMac1,1") == 0)) {
			bootx_printf("iMac,1 detected, shutting down USB\n");
			out_le32((unsigned __iomem *)0x80880008, 1);	
		}
	}
	if (bi->version < 5) {
		space = bi->deviceTreeOffset + bi->deviceTreeSize;
		if (bi->ramDisk >= space)
			space = bi->ramDisk + bi->ramDiskSize;
	} else
		space = bi->totalParamsSize;
	bootx_printf("Total space used by parameters & ramdisk: 0x%x\n", space);
	if (bi->version < 4) {
		unsigned int x __maybe_unused;
		bootx_printf("Touching pages...\n");
		for (ptr = ((unsigned int) &_stext) & PAGE_MASK;
		     ptr < (unsigned int)bi + space; ptr += PAGE_SIZE)
			x = *(volatile unsigned int *)ptr;
	}
	bootx_printf("Preparing boot params...\n");
	hdr = bootx_flatten_dt(space);
#ifdef CONFIG_BOOTX_TEXT
#ifdef SET_BOOT_BAT
	bootx_printf("Preparing BAT...\n");
	btext_prepare_BAT();
#else
	btext_unmap();
#endif
#endif
	reloc_got2(-offset);
	__start(hdr, KERNELBASE + offset, 0);
}
