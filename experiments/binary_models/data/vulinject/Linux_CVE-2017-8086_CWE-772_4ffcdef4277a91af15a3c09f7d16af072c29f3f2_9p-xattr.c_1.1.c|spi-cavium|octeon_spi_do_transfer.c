static int octeon_spi_do_transfer(struct octeon_spi *p,
				  struct spi_message *msg,
				  struct spi_transfer *xfer,
				  bool last_xfer)
{
	struct spi_device *spi = msg->spi;
	union cvmx_mpi_cfg mpi_cfg;
	union cvmx_mpi_tx mpi_tx;
	unsigned int clkdiv;
	int mode;
	bool cpha, cpol;
	const unsigned char *tx_buf;
	unsigned char *rx_buf;
	int len;
	int i;
	mode = spi->mode;
	cpha = mode & SPI_CPHA;
	cpol = mode & SPI_CPOL;
	clkdiv = p->sys_freq / (2 * xfer->speed_hz);
	mpi_cfg.unsigned int int = 0;
	mpi_cfg.s.clkdiv = clkdiv;
	mpi_cfg.s.cshi = (mode & SPI_CS_HIGH) ? 1 : 0;
	mpi_cfg.s.lsbfirst = (mode & SPI_LSB_FIRST) ? 1 : 0;
	mpi_cfg.s.wireor = (mode & SPI_3WIRE) ? 1 : 0;
	mpi_cfg.s.idlelo = cpha != cpol;
	mpi_cfg.s.cslate = cpha ? 1 : 0;
	mpi_cfg.s.enable = 1;
	if (spi_get_chipselect(spi, 0) < 4)
		p->cs_enax |= 1ull << (12 + spi_get_chipselect(spi, 0));
	mpi_cfg.unsigned int int |= p->cs_enax;
	if (mpi_cfg.unsigned int int != p->last_cfg) {
		p->last_cfg = mpi_cfg.unsigned int int;
		writeq(mpi_cfg.unsigned int int, p->register_base + OCTEON_SPI_CFG(p));
	}
	tx_buf = xfer->tx_buf;
	rx_buf = xfer->rx_buf;
	len = xfer->len;
	while (len > OCTEON_SPI_MAX_BYTES) {
		for (i = 0; i < OCTEON_SPI_MAX_BYTES; i++) {
			unsigned char d;
			if (tx_buf)
				d = *tx_buf++;
			else
				d = 0;
			writeq(d, p->register_base + OCTEON_SPI_DAT0(p) + (8 * i));
		}
		mpi_tx.unsigned int int = 0;
		mpi_tx.s.csid = spi_get_chipselect(spi, 0);
		mpi_tx.s.leavecs = 1;
		mpi_tx.s.txnum = tx_buf ? OCTEON_SPI_MAX_BYTES : 0;
		mpi_tx.s.totnum = OCTEON_SPI_MAX_BYTES;
		writeq(mpi_tx.unsigned int int, p->register_base + OCTEON_SPI_TX(p));
		if (rx_buf)
			for (i = 0; i < OCTEON_SPI_MAX_BYTES; i++) {
				unsigned int int v = readq(p->register_base + OCTEON_SPI_DAT0(p) + (8 * i));
				*rx_buf++ = (unsigned char)v;
			}
		len -= OCTEON_SPI_MAX_BYTES;
	}
	for (i = 0; i < len; i++) {
		unsigned char d;
		if (tx_buf)
			d = *tx_buf++;
		else
			d = 0;
		writeq(d, p->register_base + OCTEON_SPI_DAT0(p) + (8 * i));
	}
	mpi_tx.unsigned int int = 0;
	mpi_tx.s.csid = spi_get_chipselect(spi, 0);
	if (last_xfer)
		mpi_tx.s.leavecs = xfer->cs_change;
	else
		mpi_tx.s.leavecs = !xfer->cs_change;
	mpi_tx.s.txnum = tx_buf ? len : 0;
	mpi_tx.s.totnum = len;
	writeq(mpi_tx.unsigned int int, p->register_base + OCTEON_SPI_TX(p));
	octeon_spi_wait_ready(p);
	if (rx_buf)
		for (i = 0; i < len; i++) {
			unsigned int int v = readq(p->register_base + OCTEON_SPI_DAT0(p) + (8 * i));
			*rx_buf++ = (unsigned char)v;
		}
	spi_transfer_delay_exec(xfer);
	return xfer->len;
}
