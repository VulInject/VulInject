static void gfx_v11_0_ring_emit_ib_gfx(struct amdgpu_ring *ring,
				       struct amdgpu_job *job,
				       struct amdgpu_ib *ib,
				       unsigned int flags)
{
	unsigned vmid = AMDGPU_JOB_GET_VMID(job);
	unsigned int header, control = 0;
	BUG_ON(ib->flags & AMDGPU_IB_FLAG_CE);
	header = PACKET3(PACKET3_INDIRECT_BUFFER, 2);
	control |= ib->length_dw | (vmid << 24);
	if (ring->adev->gfx.mcbp && (ib->flags & AMDGPU_IB_FLAG_PREEMPT)) {
		control |= INDIRECT_BUFFER_PRE_ENB(1);
		if (flags & AMDGPU_IB_PREEMPTED)
			control |= INDIRECT_BUFFER_PRE_RESUME(1);
		if (vmid)
			gfx_v11_0_ring_emit_de_meta(ring,
				    (!amdgpu_sriov_vf(ring->adev) && flags & AMDGPU_IB_PREEMPTED) ? true : false);
	}
	if (ring->is_mes_queue)
		control |= 0x400000;
	BUG_ON(ib->gpu_addr & 0x3); 
	amdgpu_ring_write(ring,
#ifdef __BIG_ENDIAN
		(2 << 0) |
#endif
		lower_32_bits(ib->gpu_addr));
	amdgpu_ring_write(ring, upper_32_bits(ib->gpu_addr));
	amdgpu_ring_write(ring, control);
}
