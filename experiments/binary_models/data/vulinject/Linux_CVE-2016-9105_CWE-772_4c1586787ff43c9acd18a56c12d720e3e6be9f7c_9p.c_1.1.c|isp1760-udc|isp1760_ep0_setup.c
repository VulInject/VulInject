static void isp1760_ep0_setup(struct isp1760_udc *udc)
{
	union {
		struct usb_ctrlrequest r;
		unsigned int data[2];
	} req;
	unsigned int count;
	bool stall = false;
	isp1760_udc_set(udc, DC_EP0SETUP);
	count = isp1760_udc_read(udc, DC_BUFLEN);
	if (count != sizeof(req)) {
		spin_unlock(&udc->lock);
		dev_err(udc->isp->dev, "invalid length %u for setup packet\n",
			count);
		isp1760_udc_ctrl_send_stall(&udc->ep[0]);
		return;
	}
	req.data[0] = isp1760_udc_read_raw(udc, ISP176x_DC_DATAPORT);
	req.data[1] = isp1760_udc_read_raw(udc, ISP176x_DC_DATAPORT);
	if (udc->ep0_state != ISP1760_CTRL_SETUP) {
		spin_unlock(&udc->lock);
		dev_dbg(udc->isp->dev, "unexpected SETUP packet\n");
		return;
	}
	if (!req.r.wLength)
		udc->ep0_state = ISP1760_CTRL_STATUS;
	else if (req.r.bRequestType & USB_DIR_IN)
		udc->ep0_state = ISP1760_CTRL_DATA_IN;
	else
		udc->ep0_state = ISP1760_CTRL_DATA_OUT;
	udc->ep0_dir = req.r.bRequestType & USB_DIR_IN;
	udc->ep0_length = le16_to_cpu(req.r.wLength);
	spin_unlock(&udc->lock);
	dev_dbg(udc->isp->dev,
		"%s: bRequestType 0x%02x bRequest 0x%02x wValue 0x%04x wIndex 0x%04x wLength 0x%04x\n",
		__func__, req.r.bRequestType, req.r.bRequest,
		le16_to_cpu(req.r.wValue), le16_to_cpu(req.r.wIndex),
		le16_to_cpu(req.r.wLength));
	if ((req.r.bRequestType & USB_TYPE_MASK) == USB_TYPE_STANDARD)
		stall = isp1760_ep0_setup_standard(udc, &req.r);
	else
		stall = udc->driver->setup(&udc->gadget, &req.r) < 0;
	if (stall)
		isp1760_udc_ctrl_send_stall(&udc->ep[0]);
}
