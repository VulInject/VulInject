static int capture_android_bluetooth_hcidump(char *interface, char *fifo,
        const char *adb_server_ip, unsigned short *adb_server_tcp_port) {
    struct extcap_dumper           extcap_dumper;
    static char                    data[PACKET_LENGTH];
    static char                    packet[PACKET_LENGTH];
    ssize_t                        length;
    ssize_t                        used_buffer_length = 0;
    socket_handle_t                sock = INVALID_SOCKET;
    const char                    *adb_shell_hcidump = "shell:hcidump -R -t";
    const char                    *adb_shell_su_hcidump = "shell:su -c hcidump -R -t";
    int                            result;
    char                          *serial_number;
    time_t                         ts = 0;
    unsigned int                   captured_length;
    int int                        hex;
    char                          *hex_data;
    char                          *new_hex_data;
    own_pcap_bluetooth_h4_header  *h4_header;
    int int                        raw_length = 0;
    int int                        frame_length;
    int                            ms = 0;
    struct tm                      date;
    char                           direction_character;
    SET_DATA(h4_header, value_own_pcap_bluetooth_h4_header, packet);
    extcap_dumper = extcap_dumper_open(fifo, EXTCAP_ENCAP_BLUETOOTH_H4_WITH_PHDR);
    serial_number = get_serial_from_interface(interface);
    sock = adb_connect_transport(adb_server_ip, adb_server_tcp_port, serial_number);
    if (sock == INVALID_SOCKET)
        return EXIT_CODE_INVALID_SOCKET_3;
    result = adb_send(sock, adb_shell_hcidump);
    if (result) {
        ws_warning("Error while starting capture by sending command: %s", adb_shell_hcidump);
        closesocket(sock);
        return EXIT_CODE_GENERIC;
    }
    while (endless_loop) {
        char  *i_position;
        errno = 0;
        length = recv(sock, data + used_buffer_length, (int)(PACKET_LENGTH - used_buffer_length), 0);
        if (errno == EAGAIN
#if EWOULDBLOCK != EAGAIN
            || errno == EWOULDBLOCK
#endif
            ) {
            continue;
        }
        else if (errno != 0) {
            ws_warning("ERROR capture: %s", strerror(errno));
            closesocket(sock);
            return EXIT_CODE_GENERIC;
        }
		if(length == 0) {
            ws_warning("Broken socket connection.");
            closesocket(sock);
            return EXIT_CODE_GENERIC;
        }
        used_buffer_length += length;
        i_position =  (char *) memchr(data, '\n', used_buffer_length);
        if (i_position && i_position < data + used_buffer_length) {
            char *state_line_position = i_position + 1;
            if (!strncmp(data, "/system/bin/sh: hcidump: not found", 34)) {
                ws_warning("Command not found for <%s>", adb_shell_hcidump);
                closesocket(sock);
                return EXIT_CODE_GENERIC;
            }
            i_position =  (char *) memchr(i_position + 1, '\n', used_buffer_length);
            if (i_position) {
                i_position += 1;
                if (!strncmp(state_line_position, "Can't access device: Permission denied", 38)) {
                    ws_warning("No permission for command <%s>", adb_shell_hcidump);
                    used_buffer_length = 0;
                    closesocket(sock);
                    sock = INVALID_SOCKET;
                    break;
                }
                memmove(data, i_position, used_buffer_length - (i_position - data));
                used_buffer_length = used_buffer_length - (ssize_t)(i_position - data);
                break;
            }
        }
    }
    if (sock == INVALID_SOCKET) {
        sock = adb_connect_transport(adb_server_ip, adb_server_tcp_port, serial_number);
        if (sock == INVALID_SOCKET)
            return EXIT_CODE_INVALID_SOCKET_4;
        result = adb_send(sock, adb_shell_su_hcidump);
        if (result) {
            ws_warning("Error while starting capture by sending command: <%s>", adb_shell_su_hcidump);
            closesocket(sock);
            return EXIT_CODE_GENERIC;
        }
        used_buffer_length = 0;
        while (endless_loop) {
            char  *i_position;
            errno = 0;
            length = recv(sock, data + used_buffer_length, (int)(PACKET_LENGTH - used_buffer_length), 0);
            if (errno == EAGAIN
#if EWOULDBLOCK != EAGAIN
                || errno == EWOULDBLOCK
#endif
                ) {
                continue;
            }
            else if (errno != 0) {
                ws_warning("ERROR capture: %s", strerror(errno));
                closesocket(sock);
                return EXIT_CODE_GENERIC;
            }
            if (length <= 0) {
                ws_warning("Broken socket connection.");
                closesocket(sock);
                return EXIT_CODE_GENERIC;
            }
            used_buffer_length += length;
            i_position =  (char *) memchr(data, '\n', used_buffer_length);
            if (i_position && i_position < data + used_buffer_length) {
                if (!strncmp(data, "/system/bin/sh: su: not found", 29)) {
                    ws_warning("Command 'su' not found for <%s>", adb_shell_su_hcidump);
                    closesocket(sock);
                    return EXIT_CODE_GENERIC;
                }
                i_position =  (char *) memchr(i_position + 1, '\n', used_buffer_length);
                if (i_position) {
                    i_position += 1;
                    memmove(data, i_position, used_buffer_length - (i_position - data));
                    used_buffer_length = used_buffer_length - (ssize_t)(i_position - data);
                    break;
                }
            }
        }
    }
    while (endless_loop) {
        errno = 0;
        length = recv(sock, data + used_buffer_length,  (int)(PACKET_LENGTH - used_buffer_length), 0);
        if (errno == EAGAIN
#if EWOULDBLOCK != EAGAIN
            || errno == EWOULDBLOCK
#endif
            ) {
            continue;
        }
        else if (errno != 0) {
            ws_warning("ERROR capture: %s", strerror(errno));
            closesocket(sock);
            return EXIT_CODE_GENERIC;
        }
        if (length <= 0) {
            ws_warning("Broken socket connection.");
            closesocket(sock);
            return EXIT_CODE_GENERIC;
        }
        while (endless_loop) {
            if (used_buffer_length + length >= 1) {
                hex_data = data + 29;
                hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                if  ((hex == 0x01 && used_buffer_length + length >= 4) ||
                        (hex == 0x02 && used_buffer_length + length >= 5) ||
                        (hex == 0x04 && used_buffer_length + length >= 3)) {
                    if (hex == 0x01) {
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        if (hex < 0 || hex >= 256 || hex_data == new_hex_data) {
                            ws_warning("data format %s", strerror(errno));
                            closesocket(sock);
                            return EXIT_CODE_GENERIC;
                        }
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        if (hex < 0 || hex >= 256 || hex_data == new_hex_data) {
                            ws_warning("data format %s", strerror(errno));
                            closesocket(sock);
                            return EXIT_CODE_GENERIC;
                        }
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        raw_length = hex + 4;
                    } else if (hex == 0x04) {
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        if (hex < 0 || hex >= 256 || hex_data == new_hex_data) {
                            ws_warning("data format %s", strerror(errno));
                            closesocket(sock);
                            return EXIT_CODE_GENERIC;
                        }
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        raw_length = hex + 3;
                    } else if (hex == 0x02) {
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        if (hex < 0 || hex >= 256 || hex_data == new_hex_data) {
                            ws_warning("data format %s", strerror(errno));
                            closesocket(sock);
                            return EXIT_CODE_GENERIC;
                        }
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        if (hex < 0 || hex >= 256 || hex_data == new_hex_data) {
                            ws_warning("data format %s", strerror(errno));
                            closesocket(sock);
                            return EXIT_CODE_GENERIC;
                        }
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        raw_length = hex + 5;
                        hex_data = new_hex_data;
                        hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                        raw_length += hex << 8;
                    }
                } else {
                    ws_warning("bad raw stream");
                    closesocket(sock);
                    return EXIT_CODE_GENERIC;
                }
            } else {
                used_buffer_length += length;
                break;
            }
            frame_length = raw_length * 3 + (raw_length / 20) * 4 + ((raw_length % 20) ? 2 : -2) + 29;
            if ((used_buffer_length + length) < frame_length) {
                used_buffer_length += length;
                break;
            }
            if (8 == sscanf(data, "%04d-%02d-%02d %02d:%02d:%02d.%06d %c",
                    &date.tm_year, &date.tm_mon, &date.tm_mday, &date.tm_hour,
                    &date.tm_min, &date.tm_sec, &ms, &direction_character)) {
                ws_debug("time %04d-%02d-%02d %02d:%02d:%02d.%06d %c",
                            date.tm_year, date.tm_mon, date.tm_mday, date.tm_hour,
                            date.tm_min, date.tm_sec, ms, direction_character);
                date.tm_mon -= 1;
                date.tm_year -= 1900;
                date.tm_isdst = -1;
                ts = mktime(&date);
                new_hex_data = data + 29;
            }
            captured_length = 0;
            while ((int)(new_hex_data - data + sizeof(own_pcap_bluetooth_h4_header)) < frame_length) {
                hex_data = new_hex_data;
                hex = g_ascii_strtoll(hex_data, &new_hex_data, 16);
                packet[sizeof(own_pcap_bluetooth_h4_header) + captured_length] = (char) hex;
                captured_length += 1;
            }
            h4_header->direction = GINT32_TO_BE(direction_character == '>');
            endless_loop = extcap_dumper_dump(extcap_dumper, fifo, packet,
                    captured_length + sizeof(own_pcap_bluetooth_h4_header),
                    captured_length + sizeof(own_pcap_bluetooth_h4_header),
                    ts,
                    ms * 1000);
            memmove(data, data + frame_length, (size_t)(used_buffer_length + length - frame_length));
            used_buffer_length = (ssize_t)(used_buffer_length + length - frame_length);
            length = 0;
        }
    }
    closesocket(sock);
    return EXIT_CODE_SUCCESS;
}
