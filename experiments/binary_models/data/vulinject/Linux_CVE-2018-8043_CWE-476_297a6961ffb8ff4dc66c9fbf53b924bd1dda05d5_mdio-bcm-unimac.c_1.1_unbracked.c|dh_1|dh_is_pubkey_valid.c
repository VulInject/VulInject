static int dh_is_pubkey_valid(struct dh_ctx *ctx, MPI y)
{
	MPI val, q;
	if (unlikely(!ctx->p))
		return -EINVAL;
	if (mpi_cmp_ui(y, 1) < 1 || mpi_cmp(y, ctx->p) >= 0)
		return -EINVAL;
	val = mpi_alloc(0);
	if (!val)
		return -ENOMEM;
	q = mpi_alloc(mpi_get_nlimbs(ctx->p));
	if (!q) {
		mpi_free(val);
		return -ENOMEM;
	}
	mpi_rshift(q, ctx->p, 1);
	ret = mpi_powm(val, y, q, ctx->p);
	mpi_free(q);
	if (ret) {
		mpi_free(val);
		return ret;
	}
	ret = mpi_cmp_ui(val, 1);
	mpi_free(val);
	if (ret != 0)
		return -EINVAL;
	return 0;
}
