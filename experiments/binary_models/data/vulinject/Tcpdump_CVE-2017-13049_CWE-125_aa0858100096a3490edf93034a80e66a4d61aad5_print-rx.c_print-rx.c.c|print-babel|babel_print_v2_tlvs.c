babel_print_v2_tlvs(netdissect_options *ndo,
                    const u_char *cp, u_int tlvs_length,
                    u_int packet_length_remaining)
{
    u_int i;
    u_char v4_prefix[16] =
        {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0xFF, 0xFF, 0, 0, 0, 0 };
    u_char v6_prefix[16] = {0};
    i = 0;
    while(i < tlvs_length) {
        const u_char *message;
        unsigned char type;
        u_int len;
        message = cp + i;
        ICHECK(i, 1);
        if((type = GET_U_1(message)) == MESSAGE_PAD1) {
            ND_PRINT(ndo->ndo_vflag ? "\n\tPad 1" : " pad1");
            i += 1;
            continue;
        }
        ICHECK(i, 2);
        len = GET_U_1(message + 1);
        ICHECK(i, 2 + len);
        ND_TCHECK_LEN(message, 2 + len);
        switch(type) {
        case MESSAGE_PADN: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" padN");
            else
                ND_PRINT("\n\tPad %u", len + 2);
        }
            break;
        case MESSAGE_ACK_REQ: {
            u_short nonce, interval;
            if (!ndo->ndo_vflag)
                ND_PRINT(" ack-req");
            else {
                ND_PRINT("\n\tAcknowledgment Request ");
                if(len < 6) goto invalid;
                nonce = GET_BE_U_2(message + 4);
                interval = GET_BE_U_2(message + 6);
                ND_PRINT("%04x %s", nonce, format_interval(interval));
            }
        }
            break;
        case MESSAGE_ACK: {
            u_short nonce;
            if (!ndo->ndo_vflag)
                ND_PRINT(" ack");
            else {
                ND_PRINT("\n\tAcknowledgment ");
                if(len < 2) goto invalid;
                nonce = GET_BE_U_2(message + 2);
                ND_PRINT("%04x", nonce);
            }
        }
            break;
        case MESSAGE_HELLO:  {
            u_short seqno, interval, unicast;
            if (!ndo->ndo_vflag)
                ND_PRINT(" hello");
            else {
                ND_PRINT("\n\tHello ");
                if(len < 6) goto invalid;
                unicast = (GET_BE_U_2(message + 2) & UNICAST_MASK);
                seqno = GET_BE_U_2(message + 4);
                interval = GET_BE_U_2(message + 6);
                if(unicast)
                     ND_PRINT("(Unicast) ");
                ND_PRINT("seqno %u ", seqno);
                if(interval!=0)
                    ND_PRINT("interval %s", format_interval(interval));
                else
                    ND_PRINT("unscheduled");
                if(len > 6)
                    subtlvs_print(ndo, message + 8, message + 2 + len, type);
            }
        }
            break;
        case MESSAGE_IHU: {
            unsigned short rxcost, interval;
            if (!ndo->ndo_vflag)
                ND_PRINT(" ihu");
            else {
                u_char address[16];
                u_char ae;
                int rc;
                ND_PRINT("\n\tIHU ");
                if(len < 6) goto invalid;
                rxcost = GET_BE_U_2(message + 4);
                interval = GET_BE_U_2(message + 6);
                ae = GET_U_1(message + 2);
                rc = network_address(ae, message + 8,
                                     len - 6, address);
                if(rc < 0) { nd_print_trunc(ndo); break; }
                ND_PRINT("%s rxcost %u interval %s",
                       ae == 0 ? "any" : format_address(ndo, address),
                       rxcost, format_interval(interval));
                if((u_int)rc < len - 6)
                    subtlvs_print(ndo, message + 8 + rc, message + 2 + len,
                                  type);
            }
        }
            break;
        case MESSAGE_ROUTER_ID: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" router-id");
            else {
                ND_PRINT("\n\tRouter Id");
                if(len < 10) goto invalid;
                ND_PRINT(" %s", format_id(ndo, message + 4));
            }
        }
            break;
        case MESSAGE_NH: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" nh");
            else {
                int rc;
                u_char ae;
                u_char nh[16];
                ND_PRINT("\n\tNext Hop");
                if(len < 2) goto invalid;
                ae = GET_U_1(message + 2);
                rc = network_address(ae, message + 4,
                                     len - 2, nh);
                if(rc < 0) goto invalid;
                ND_PRINT(" %s", ae == 0 ? "invalid AE 0" : format_address(ndo, nh));
            }
        }
            break;
        case MESSAGE_UPDATE: {
            if (!ndo->ndo_vflag) {
                ND_PRINT(" update");
                if(len < 10)
                    goto invalid;
                else
                    ND_PRINT("%s%s%s",
                           (GET_U_1(message + 3) & 0x80) ? "/prefix": "",
                           (GET_U_1(message + 3) & 0x40) ? "/id" : "",
                           (GET_U_1(message + 3) & 0x3f) ? "/unknown" : "");
            } else {
                u_short interval, seqno, metric;
                u_char ae, plen;
                int rc;
                u_char prefix[16];
                ND_PRINT("\n\tUpdate");
                if(len < 10) goto invalid;
                ae = GET_U_1(message + 2);
                plen = GET_U_1(message + 4) + (GET_U_1(message + 2) == 1 ? 96 : 0);
                rc = network_prefix(ae,
                                    GET_U_1(message + 4),
                                    GET_U_1(message + 5),
                                    message + 12,
                                    GET_U_1(message + 2) == 1 ? v4_prefix : v6_prefix,
                                    len - 10, prefix);
                if(rc < 0) goto invalid;
                interval = GET_BE_U_2(message + 6);
                seqno = GET_BE_U_2(message + 8);
                metric = GET_BE_U_2(message + 10);
                ND_PRINT("%s%s%s %s metric %u seqno %u interval %s",
                       (GET_U_1(message + 3) & 0x80) ? "/prefix": "",
                       (GET_U_1(message + 3) & 0x40) ? "/id" : "",
                       (GET_U_1(message + 3) & 0x3f) ? "/unknown" : "",
                       ae == 0 ? "any" : format_prefix(ndo, prefix, plen),
                       metric, seqno, format_interval_update(interval));
                if(GET_U_1(message + 3) & 0x80) {
                    if(GET_U_1(message + 2) == 1)
                        memcpy(v4_prefix, prefix, 16);
                    else
                        memcpy(v6_prefix, prefix, 16);
                }
                if((u_int)rc < len - 10)
                    subtlvs_print(ndo, message + 12 + rc, message + 2 + len, type);
            }
        }
            break;
        case MESSAGE_ROUTE_REQUEST: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" route-request");
            else {
                int rc;
                u_char prefix[16], ae, plen;
                ND_PRINT("\n\tRoute Request ");
                if(len < 2) goto invalid;
                ae = GET_U_1(message + 2);
                plen = GET_U_1(message + 3) + (GET_U_1(message + 2) == 1 ? 96 : 0);
                rc = network_prefix(ae,
                                    GET_U_1(message + 3), 0,
                                    message + 4, NULL, len - 2, prefix);
                if(rc < 0) goto invalid;
                ND_PRINT("for %s",
                       ae == 0 ? "any" : format_prefix(ndo, prefix, plen));
            }
        }
            break;
        case MESSAGE_SEQNO_REQUEST : {
            if (!ndo->ndo_vflag)
                ND_PRINT(" seqno-request");
            else {
                int rc;
                u_short seqno;
                u_char prefix[16], ae, plen;
                ND_PRINT("\n\tSeqno Request ");
                if(len < 14) goto invalid;
                ae = GET_U_1(message + 2);
                seqno = GET_BE_U_2(message + 4);
                rc = network_prefix(ae,
                                    GET_U_1(message + 3), 0,
                                    message + 16, NULL, len - 14, prefix);
                if(rc < 0) goto invalid;
                plen = GET_U_1(message + 3) + (GET_U_1(message + 2) == 1 ? 96 : 0);
                ND_PRINT("(%u hops) for %s seqno %u id %s",
                       GET_U_1(message + 6),
                       ae == 0 ? "invalid AE 0" : format_prefix(ndo, prefix, plen),
                       seqno, format_id(ndo, message + 8));
            }
        }
            break;
        case MESSAGE_TSPC :
            if (!ndo->ndo_vflag)
                ND_PRINT(" tspc");
            else {
                ND_PRINT("\n\tTS/PC ");
                if(len < 6) goto invalid;
                ND_PRINT("timestamp %u packetcounter %u",
                          GET_BE_U_4(message + 4),
                          GET_BE_U_2(message + 2));
            }
            break;
        case MESSAGE_HMAC : {
            if (!ndo->ndo_vflag)
                ND_PRINT(" hmac");
            else {
                unsigned j;
                ND_PRINT("\n\tHMAC ");
                if(len < 18) goto invalid;
                ND_PRINT("key-id %u digest-%u ", GET_BE_U_2(message + 2),
                         len - 2);
                for (j = 0; j < len - 2; j++)
                    ND_PRINT("%02X", GET_U_1(message + j + 4));
            }
        }
            break;
        case MESSAGE_UPDATE_SRC_SPECIFIC : {
            if(!ndo->ndo_vflag) {
                ND_PRINT(" ss-update");
            } else {
                u_char prefix[16], src_prefix[16];
                u_short interval, seqno, metric;
                u_char ae, plen, src_plen, omitted;
                int rc;
                int parsed_len = 10;
                ND_PRINT("\n\tSS-Update");
                if(len < 10) goto invalid;
                ae = GET_U_1(message + 2);
                src_plen = GET_U_1(message + 3);
                plen = GET_U_1(message + 4);
                omitted = GET_U_1(message + 5);
                interval = GET_BE_U_2(message + 6);
                seqno = GET_BE_U_2(message + 8);
                metric = GET_BE_U_2(message + 10);
                rc = network_prefix(ae, plen, omitted, message + 2 + parsed_len,
                                    ae == 1 ? v4_prefix : v6_prefix,
                                    len - parsed_len, prefix);
                if(rc < 0) goto invalid;
                if(ae == 1)
                    plen += 96;
                parsed_len += rc;
                rc = network_prefix(ae, src_plen, 0, message + 2 + parsed_len,
                                    NULL, len - parsed_len, src_prefix);
                if(rc < 0) goto invalid;
                if(ae == 1)
                    src_plen += 96;
                parsed_len += rc;
                ND_PRINT(" %s from", format_prefix(ndo, prefix, plen));
                ND_PRINT(" %s metric %u seqno %u interval %s",
                          format_prefix(ndo, src_prefix, src_plen),
                          metric, seqno, format_interval_update(interval));
                if((u_int)parsed_len < len)
                    subtlvs_print(ndo, message + 2 + parsed_len,
                                  message + 2 + len, type);
            }
        }
            break;
        case MESSAGE_REQUEST_SRC_SPECIFIC : {
            if(!ndo->ndo_vflag)
                ND_PRINT(" ss-request");
            else {
                int rc, parsed_len = 3;
                u_char ae, plen, src_plen, prefix[16], src_prefix[16];
                ND_PRINT("\n\tSS-Request ");
                if(len < 3) goto invalid;
                ae = GET_U_1(message + 2);
                plen = GET_U_1(message + 3);
                src_plen = GET_U_1(message + 4);
                rc = network_prefix(ae, plen, 0, message + 2 + parsed_len,
                                    NULL, len - parsed_len, prefix);
                if(rc < 0) goto invalid;
                if(ae == 1)
                    plen += 96;
                parsed_len += rc;
                rc = network_prefix(ae, src_plen, 0, message + 2 + parsed_len,
                                    NULL, len - parsed_len, src_prefix);
                if(rc < 0) goto invalid;
                if(ae == 1)
                    src_plen += 96;
                parsed_len += rc;
                if(ae == 0) {
                    ND_PRINT("for any");
                } else {
                    ND_PRINT("for (%s, ", format_prefix(ndo, prefix, plen));
                    ND_PRINT("%s)", format_prefix(ndo, src_prefix, src_plen));
                }
            }
        }
            break;
        case MESSAGE_MH_REQUEST_SRC_SPECIFIC : {
            if(!ndo->ndo_vflag)
                ND_PRINT(" ss-mh-request");
            else {
                int rc, parsed_len = 14;
                u_short seqno;
                u_char ae, plen, src_plen, prefix[16], src_prefix[16], hopc;
                const u_char *router_id = NULL;
                ND_PRINT("\n\tSS-MH-Request ");
                if(len < 14) goto invalid;
                ae = GET_U_1(message + 2);
                plen = GET_U_1(message + 3);
                seqno = GET_BE_U_2(message + 4);
                hopc = GET_U_1(message + 6);
                src_plen = GET_U_1(message + 7);
                router_id = message + 8;
                rc = network_prefix(ae, plen, 0, message + 2 + parsed_len,
                                    NULL, len - parsed_len, prefix);
                if(rc < 0) goto invalid;
                if(ae == 1)
                    plen += 96;
                parsed_len += rc;
                rc = network_prefix(ae, src_plen, 0, message + 2 + parsed_len,
                                    NULL, len - parsed_len, src_prefix);
                if(rc < 0) goto invalid;
                if(ae == 1)
                    src_plen += 96;
                ND_PRINT("(%u hops) for (%s, ",
                          hopc, format_prefix(ndo, prefix, plen));
                ND_PRINT("%s) seqno %u id %s",
                          format_prefix(ndo, src_prefix, src_plen),
                          seqno, format_id(ndo, router_id));
            }
        }
            break;
        case MESSAGE_MAC: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" mac");
            else {
                ND_PRINT("\n\tMAC ");
                ND_PRINT("len %u", len);
            }
        }
            break;
        case MESSAGE_PC: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" pc");
            else {
                ND_PRINT("\n\tPC");
                if(len < 4) goto invalid;
                ND_PRINT(" value %u",
                    GET_BE_U_4(message + 2));
                ND_PRINT(" index len %u", len-4);
            }
        }
            break;
        case MESSAGE_CHALLENGE_REQUEST: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" challenge_request");
            else {
                ND_PRINT("\n\tChallenge Request");
                if(len > 192) goto invalid;
                ND_PRINT(" len %u", len);
            }
        }
            break;
        case MESSAGE_CHALLENGE_REPLY: {
            if (!ndo->ndo_vflag)
                ND_PRINT(" challenge_reply");
            else {
                ND_PRINT("\n\tChallenge Reply");
                if (len > 192) goto invalid;
                ND_PRINT(" len %u", len);
            }
        }
            break;
        default:
            if (!ndo->ndo_vflag)
                ND_PRINT(" unknown");
            else
                ND_PRINT("\n\tUnknown message type %u", type);
        }
        i += len + 2;
    }
    return 0; 
trunc:
    return -1; 
invalid:
    return -2; 
}
