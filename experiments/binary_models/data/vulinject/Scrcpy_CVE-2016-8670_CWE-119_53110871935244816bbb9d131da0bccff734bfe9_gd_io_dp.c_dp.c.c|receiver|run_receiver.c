run_receiver(void *data) {
    struct sc_receiver *receiver = data;
    static uint8_t buf[DEVICE_MSG_MAX_SIZE];
    size_t head = 0;
    for (;;) {
        assert(head < DEVICE_MSG_MAX_SIZE);
        ssize_t r = net_recv(receiver->control_socket, buf + head,
                             DEVICE_MSG_MAX_SIZE - head);
		if(r == 0) {
            LOGD("Receiver stopped");
            break;
        }
        head += r;
        ssize_t consumed = process_msgs(receiver, buf, head);
        if (consumed == -1) {
            // an error occurred
            break;
        }
        if (consumed) {
            head -= consumed;
            // shift the remaining data in the buffer
            memmove(buf, &buf[consumed], head);
        }
    }
    return 0;
}
