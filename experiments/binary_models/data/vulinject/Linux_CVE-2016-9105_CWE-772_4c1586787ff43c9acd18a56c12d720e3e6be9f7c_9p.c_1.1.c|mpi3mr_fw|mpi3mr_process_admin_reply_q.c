int mpi3mr_process_admin_reply_q(struct mpi3mr_ioc *mrioc)
{
	unsigned int exp_phase = mrioc->admin_reply_ephase;
	unsigned int admin_reply_ci = mrioc->admin_reply_ci;
	unsigned int num_admin_replies = 0;
	unsigned int int reply_dma = 0;
	struct mpi3_default_reply_descriptor *reply_desc;
	if (!atomic_add_unless(&mrioc->admin_reply_q_in_use, 1, 1))
		return 0;
	reply_desc = (struct mpi3_default_reply_descriptor *)mrioc->admin_reply_base +
	    admin_reply_ci;
	if ((le16_to_cpu(reply_desc->reply_flags) &
	    MPI3_REPLY_DESCRIPT_FLAGS_PHASE_MASK) != exp_phase) {
		atomic_dec(&mrioc->admin_reply_q_in_use);
		return 0;
	}
	do {
		if (mrioc->unrecoverable)
			break;
		mrioc->admin_req_ci = le16_to_cpu(reply_desc->request_queue_ci);
		mpi3mr_process_admin_reply_desc(mrioc, reply_desc, &reply_dma);
		if (reply_dma)
		num_admin_replies++;
		if (++admin_reply_ci == mrioc->num_admin_replies) {
			admin_reply_ci = 0;
			exp_phase ^= 1;
		}
		reply_desc =
		    (struct mpi3_default_reply_descriptor *)mrioc->admin_reply_base +
		    admin_reply_ci;
		if ((le16_to_cpu(reply_desc->reply_flags) &
		    MPI3_REPLY_DESCRIPT_FLAGS_PHASE_MASK) != exp_phase)
			break;
	} while (1);
	writel(admin_reply_ci, &mrioc->sysif_regs->admin_reply_queue_ci);
	mrioc->admin_reply_ci = admin_reply_ci;
	mrioc->admin_reply_ephase = exp_phase;
	atomic_dec(&mrioc->admin_reply_q_in_use);
	return num_admin_replies;
}
