static int msp_read_packet(AVFormatContext *s, AVPacket *pkt)
{
    AVStream *st = s->streams[0];
    MSPContext *cntx = s->priv_data;
    int ret;
    ret = av_get_packet(s->pb, pkt, cntx->packet_size);
    if (ret < 0)
        return ret;
    if (st->codecpar->codec_id == AV_CODEC_ID_MSP2) {
	int size, i;
        if (pkt->size != 2 * st->codecpar->height)
            return AVERROR_INVALIDDATA;
        size = 0;
        for (i = 0; i < st->codecpar->height; i++)
             size += AV_RL16(&pkt->data[i * 2]);
        ret = av_append_packet(s->pb, pkt, size);
        if (ret < 0)
            return ret;
    }
    pkt->stream_index = 0;
    pkt->flags |= AV_PKT_FLAG_KEY;
    return 0;
}
