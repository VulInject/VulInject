static unsigned int cpdma_chan_set_factors(struct cpdma_ctlr *ctlr,
				  struct cpdma_chan *ch)
{
	unsigned int delta = UINT_MAX, prev_delta = UINT_MAX, best_delta = UINT_MAX;
	unsigned int best_send_cnt = 0, best_idle_cnt = 0;
	unsigned int new_rate, best_rate = 0, rate_reg;
	int send_cnt, idle_cnt;
	unsigned int min_send_cnt, freq;
	unsigned int int divident, divisor;
	if (!ch->rate) {
		ch->rate_factor = 0;
		goto set_factor;
	}
	freq = ctlr->params.bus_freq_mhz * 1000 * 32;
	if (!freq) {
		dev_err(ctlr->dev, "The bus frequency is not set\n");
		return -EINVAL;
	}
	min_send_cnt = freq - ch->rate;
	send_cnt = DIV_ROUND_UP(min_send_cnt, ch->rate);
	while (send_cnt <= CPDMA_MAX_RLIM_CNT) {
		divident = ch->rate * send_cnt;
		divisor = min_send_cnt;
		idle_cnt = DIV_ROUND_CLOSEST_ULL(divident, divisor);
		divident = freq * idle_cnt;
		divisor = idle_cnt + send_cnt;
		new_rate = DIV_ROUND_CLOSEST_ULL(divident, divisor);
		delta = new_rate >= ch->rate ? new_rate - ch->rate : delta;
		if (delta < best_delta) {
			best_delta = delta;
			best_send_cnt = send_cnt;
			best_idle_cnt = idle_cnt;
			best_rate = new_rate;
			if (!delta)
				break;
		}
		if (prev_delta >= delta) {
			prev_delta = delta;
			send_cnt++;
			continue;
		}
		idle_cnt++;
		divident = freq * idle_cnt;
		send_cnt = DIV_ROUND_CLOSEST_ULL(divident, ch->rate);
		send_cnt -= idle_cnt;
		prev_delta = UINT_MAX;
	}
	ch->rate = best_rate;
	ch->rate_factor = best_send_cnt | (best_idle_cnt << 16);
set_factor:
	rate_reg = CPDMA_TX_PRI0_RATE + 4 * ch->chan_num;
	dma_reg_write(ctlr, rate_reg, ch->rate_factor);
	return 0;
}
