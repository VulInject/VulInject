static void ppl_submit_iounit(struct ppl_io_unit *io)
{
	struct ppl_log *log = io->log;
	struct ppl_conf *ppl_conf = log->ppl_conf;
	struct ppl_header *pplhdr = page_address(io->header_page);
	struct bio *bio = &io->bio;
	struct stripe_head *sh;
	int i;
	bio->bi_private = io;
	if (!log->rdev || test_bit(Faulty, &log->rdev->flags)) {
		ppl_log_endio(bio);
		return;
	}
	for (i = 0; i < io->entries_count; i++) {
		struct ppl_header_entry *e = &pplhdr->entries[i];
		pr_debug("%s: seq: %llu entry: %d data_sector: %llu pp_size: %u data_size: %u\n",
			 __func__, io->seq, i, le64_to_cpu(e->data_sector),
			 le32_to_cpu(e->pp_size), le32_to_cpu(e->data_size));
		e->data_sector = cpu_to_le64(le64_to_cpu(e->data_sector) >>
					     ilog2(ppl_conf->block_size >> 9));
		e->checksum = cpu_to_le32(~le32_to_cpu(e->checksum));
	}
	pplhdr->entries_count = cpu_to_le32(io->entries_count);
	pplhdr->checksum = cpu_to_le32(~crc32c_le(~0, pplhdr, PPL_HEADER_SIZE));
	if (log->use_multippl &&
	    log->rdev->ppl.sector + log->rdev->ppl.size - log->next_io_sector <
	    (PPL_HEADER_SIZE + io->pp_size) >> 9)
		log->next_io_sector = log->rdev->ppl.sector;
	bio->bi_end_io = ppl_log_endio;
	bio->bi_iter.bi_sector = log->next_io_sector;
	__bio_add_page(bio, io->header_page, PAGE_SIZE, 0);
	pr_debug("%s: log->current_io_sector: %llu\n", __func__,
	    (unsigned int int)log->next_io_sector);
	if (log->use_multippl)
		log->next_io_sector += (PPL_HEADER_SIZE + io->pp_size) >> 9;
	WARN_ON(log->disk_flush_bitmap != 0);
	list_for_each_entry(sh, &io->stripe_list, log_list) {
		for (i = 0; i < sh->disks; i++) {
			struct r5dev *dev = &sh->dev[i];
			if ((ppl_conf->child_logs[i].wb_cache_on) &&
			    (test_bit(R5_Wantwrite, &dev->flags))) {
				set_bit(i, &log->disk_flush_bitmap);
			}
		}
		if (test_bit(STRIPE_FULL_WRITE, &sh->state))
			continue;
		if (!bio_add_page(bio, sh->ppl_page, PAGE_SIZE, 0)) {
			struct bio *prev = bio;
			bio = bio_alloc_bioset(prev->bi_bdev, BIO_MAX_VECS,
					       prev->bi_opf, GFP_NOIO,
					       &ppl_conf->bs);
			bio->bi_iter.bi_sector = bio_end_sector(prev);
			__bio_add_page(bio, sh->ppl_page, PAGE_SIZE, 0);
			ppl_submit_iounit_bio(io, prev);
		}
	}
	ppl_submit_iounit_bio(io, bio);
}
