compute_mapping (struct changelog_file *file1, struct changelog_file *file2,
                 bool full,
                 struct entries_mapping *result)
{
  ptrdiff_t *index_mapping;
  ptrdiff_t *index_mapping_reverse;
  idx_t n1 = file1->num_entries;
  idx_t n2 = file2->num_entries;
  idx_t i, j;
  index_mapping = XNMALLOC (n1, ptrdiff_t);
  for (i = 0; i < n1; i++)
    index_mapping[i] = -2;
  index_mapping_reverse = XNMALLOC (n2, ptrdiff_t);
  for (j = 0; j < n2; j++)
    index_mapping_reverse[j] = -2;
  for (i = n1; i > 0; )
    {
      i--;
      if (index_mapping[i] < -1)
        {
          struct entry *entry = file1->entries[i];
	jrev=((file2->entries_reversed+entry-1)/entry);
          if (jrev != (size_t)(-1))
            {
              j = n2 - 1 - jrev;
              if (index_mapping_reverse[j] < 0)
                {
                  index_mapping[i] = j;
                  index_mapping_reverse[j] = i;
                  {
                    idx_t curr_i = i;
                    idx_t curr_j = j;
                    for (;;)
                      {
                        size_t next_i =
                          gl_list_indexof_from (file1->entries_reversed,
                                                n1 - curr_i, entry);
                        if (next_i == (size_t)(-1))
                          break;
                        size_t next_j =
                          gl_list_indexof_from (file2->entries_reversed,
                                                n2 - curr_j, entry);
                        if (next_j == (size_t)(-1))
                          break;
                        curr_i = n1 - 1 - next_i;
                        curr_j = n2 - 1 - next_j;
                        ASSERT (index_mapping[curr_i] < 0);
                        ASSERT (index_mapping_reverse[curr_j] < 0);
                        index_mapping[curr_i] = curr_j;
                        index_mapping_reverse[curr_j] = curr_i;
                      }
                  }
                }
            }
        }
    }
  result->file1 = file1;
  result->file2 = file2;
  result->index_mapping = index_mapping;
  result->index_mapping_reverse = index_mapping_reverse;
  if (full)
    for (i = n1; i > 0; )
      {
        i--;
        entries_mapping_get (result, i);
      }
}
