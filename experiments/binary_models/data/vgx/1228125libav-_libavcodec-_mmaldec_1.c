static int ffmal_copy_frame ( AVCodecContext * avctx , AVFrame * frame , MMAL_BUFFER_HEADER_T * buffer ) { MMALDecodeContext * ctx = avctx -> priv_data ; int ret ; if ( avctx -> pix_fmt == AV_PIX_FMT_MMAL ) { if ( ! ctx -> pool_out ) { return AVERROR_UNKNOWN ; } if ( ( ret = ff_decode_frame_props ( avctx , frame ) ) < 0 ) { done } if ( ( ret = ffmmal_set_ref ( frame , ctx -> pool_out , buffer ) ) < 0 ) { done } } else { int w = FFALIGN ( avctx -> width , 32 ) ; int h = FFALIGN ( avctx -> height , 16 ) ; uint8_t * src [ 4 ] ; int linesize [ 4 ] ; if ( ( ret = ff_get_buffer ( avctx , frame , 0 ) ) < 0 ) { done } av_image_fill_arrays ( src , linesize , buffer -> data + buffer -> type -> video . offset [ 0 ] , avctx -> pix_fmt , w , h , 1 ) ; av_image_copy ( frame -> data , frame -> linesize , src , linesize , avctx -> pix_fmt , avctx -> width , avctx -> height ) ; } frame -> pts = buffer -> pts == MMAL_TIME_UNKNOWN ?AV_NOPTS_VALUE : buffer -> pts ; FF_DISABLE_DEPRECATION_WARNINGS frame -> pkt_pts frame -> pts ; ; FF_ENABLE_DEPRECATION_WARNINGS frame -> pkt_dts AV_NOPTS_VALUE ; ; done return ret ; } 