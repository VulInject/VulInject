int vmw_dmabuf_pin_in_placement ( struct vmw_private * dev_priv , struct vmw_dma_buffer * buf , struct ttm_placement * placement , bool interruptible ) { struct ttm_buffer_object * bo = & buf -> base ; int ret ; uint32_t new_flags ; ret = ttm_write_lock ( & dev_priv -> reservation_sem , interruptible ) ; vmw_execbuf_release_pinned_bo ( dev_priv ) ; ret = ttm_bo_reserve ( bo , interruptible , false , NULL ) ; if ( unlikely ( ret != 0 ) ) { err } if ( buf -> pin_count > 0 ) { ret = ttm_bo_mem_compat ( placement , & bo -> mem , & new_flags ) == true ?0 : - EINVAL ; } else { ret = ttm_bo_validate ( bo , placement , interruptible , false ) ; } if ( ! ret ) { vmw_bo_pin_reserved ( buf , true ) ; } ttm_bo_unreserve ( bo ) ; err ttm_write_unlock ( & dev_priv -> reservation_sem ) ; return ret ; } 