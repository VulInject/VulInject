static int delete_unused_sa ( struct mnl_socket * mnl_socket , void * contacts ) { { struct nlmsghdr n ; } , req = { . n . nlmsg_len = NLMSG_HDRLEN . n . nlmsg_flags = NLM_F_DUMP | NLM_F_REQUEST . n . nlmsg_type = XFRM_MSG_GETSA . n . nlmsg_seq = time ( NULL ) } if ( mnl_socket_sendto ( mnl_socket , & req , req . n . nlmsg_len ) == - 1 ) { LM_ERR ( "Error sending get all SAs command via netlink socket: %s\n" , strerror ( errno ) ) ; return 1 ; } char buf [ NLMSG_DELETEALL_BUF_SIZE ] ; struct del_tunnels del_data ; del_data . contacts = contacts ; memset ( & del_data . delmsg_buf , 0 , sizeof ( del_data . delmsg_buf ) ) ; int ret = mnl_socket_recvfrom ( mnl_socket , buf , sizeof ( buf ) ) ; while ( ret > 0 ) { ret = mnl_cb_run ( buf , ret , req . n . nlmsg_seq , mnl_socket_get_portid ( mnl_socket ) , delete_unused_sa_cb , & del_data ) ; if ( ret <= MNL_CB_STOP ) { break ; } ret = mnl_socket_recvfrom ( mnl_socket , buf , sizeof ( buf ) ) ; } if ( mnl_socket_sendto ( mnl_socket , & del_data . delmsg_buf . buf , del_data . delmsg_buf . offset ) == - 1 ) { LM_ERR ( "Error sending delete unused SAs command via netlink socket: " "%s\n" , strerror ( errno ) ) ; return 1 ; } return 0 ; } 