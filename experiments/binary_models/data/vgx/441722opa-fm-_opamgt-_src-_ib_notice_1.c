int create_sa_qp ( struct omgt_port * port ) { int i ; int flags , rc ; int buf_cnt ; struct ibv_qp_init_attr init_attr = { 0 } ; struct ibv_qp_attr attr = { 0 } ; if ( port -> sa_qp ) { return 0 ; } port -> sa_qp_comp_channel = ibv_create_comp_channel ( port -> verbs_ctx ) ; if ( ! port -> sa_qp_comp_channel ) { OMGT_OUTPUT_ERROR ( port , "Notice: create comp_channel failed\n" ) ; return - EIO ; } flags = fcntl ( port -> sa_qp_comp_channel -> fd , F_GETFL ) ; rc = fcntl ( port -> sa_qp_comp_channel -> fd , F_SETFL , flags | O_NONBLOCK ) ; if ( rc < 0 ) { OMGT_OUTPUT_ERROR ( port , "Notice: create QP failed\n" ) ; cq_fail } port -> recv_bufs = calloc ( port -> num_userspace_recv_buf , sizeof port -> recv_bufs ) ; if ( ! port -> recv_bufs ) { OMGT_OUTPUT_ERROR ( port , "Notice: recv message buffer allocation failed\n" ) ; cq_fail } buf_cnt = port -> num_userspace_recv_buf + port -> num_userspace_send_buf + 10 ; port -> sa_qp_cq = ibv_create_cq ( port -> verbs_ctx , buf_cnt , ( void * ) port , port -> sa_qp_comp_channel , 0 ) ; if ( ! port -> sa_qp_cq ) { OMGT_OUTPUT_ERROR ( port , "Notice: create QP failed\n" ) ; buf_fail } if ( ibv_req_notify_cq ( port -> sa_qp_cq , 0 ) ) { OMGT_OUTPUT_ERROR ( port , "Notice: req_notify_cq: failed\n" ) ; pd_fail } port -> sa_qp_pd = ibv_alloc_pd ( port -> verbs_ctx ) ; if ( ! port -> sa_qp_pd ) { OMGT_OUTPUT_ERROR ( port , "Notice: Alloc PD failed\n" ) ; pd_fail } init_attr . qp_context = ( void * ) port ; init_attr . send_cq = port -> sa_qp_cq ; init_attr . recv_cq = port -> sa_qp_cq ; init_attr . cap . max_send_wr = port -> num_userspace_send_buf + 1 ; init_attr . cap . max_recv_wr = port -> num_userspace_recv_buf + 1 ; init_attr . cap . max_send_sge = 1 ; init_attr . cap . max_recv_sge = 1 ; init_attr . qp_type = IBV_QPT_UD ; init_attr . sq_sig_all = 1 ; port -> sa_qp = ibv_create_qp ( port -> sa_qp_pd , & init_attr ) ; if ( ! port -> sa_qp ) { OMGT_OUTPUT_ERROR ( port , "Notice: create QP failed\n" ) ; qp_fail } attr . qp_state = IBV_QPS_INIT ; attr . port_num = port -> hfi_port_num ; attr . qkey = UMAD_QKEY ; if ( 0xffff == ( attr . pkey_index = omgt_find_pkey ( port , 0xffff ) ) ) { attr . pkey_index = omgt_find_pkey ( port , 0x7fff ) ; } if ( ibv_modify_qp ( port -> sa_qp , & attr , IBV_QP_STATE | IBV_QP_PKEY_INDEX | IBV_QP_PORT | IBV_QP_QKEY ) ) { OMGT_OUTPUT_ERROR ( port , "Notice: failed to modify QP to init\n" ) ; destroy_qp } attr . qp_state = IBV_QPS_RTR ; if ( ibv_modify_qp ( port -> sa_qp , & attr , IBV_QP_STATE ) ) { OMGT_OUTPUT_ERROR ( port , "Notice: failed to modify QP to rtr\n" ) ; destroy_qp } attr . qp_state = IBV_QPS_RTS ; attr . sq_psn = 0 ; if ( ibv_modify_qp ( port -> sa_qp , & attr , IBV_QP_STATE | IBV_QP_SQ_PSN ) ) { OMGT_OUTPUT_ERROR ( port , "Notice: failed to modify QP to rts\n" ) ; destroy_qp } if ( omgt_post_notice_recvs ( port ) ) { OMGT_OUTPUT_ERROR ( port , "Notice: post recv buffers failed\n" ) ; destroy_qp } if ( start_ud_cq_monitor ( port ) ) { unreg_recv } return ( 0 ) ; unreg_recv OMGT_DBGPRINT ( port , "create_sa_qp: unreg_recv\n" ) ; for ( i = 0 ; i < port -> num_userspace_recv_buf ; i ++ ) { ibv_dereg_mr ( port -> recv_bufs [ i ] . mr ) ; } destroy_qp OMGT_DBGPRINT ( port , "create_sa_qp: destroy_qp\n" ) ; ibv_destroy_qp ( port -> sa_qp ) ; port -> sa_qp = NULL ; qp_fail OMGT_DBGPRINT ( port , "create_sa_qp: qp_fail\n" ) ; ibv_dealloc_pd ( port -> sa_qp_pd ) ; pd_fail OMGT_DBGPRINT ( port , "create_sa_qp: pd_fail\n" ) ; ibv_destroy_cq ( port -> sa_qp_cq ) ; buf_fail OMGT_DBGPRINT ( port , "create_sa_qp: buf_fail\n" ) ; free ( port -> recv_bufs ) ; cq_fail OMGT_DBGPRINT ( port , "create_sa_qp: cq_fail\n" ) ; ibv_destroy_comp_channel ( port -> sa_qp_comp_channel ) ; return ( - EIO ) ; } 