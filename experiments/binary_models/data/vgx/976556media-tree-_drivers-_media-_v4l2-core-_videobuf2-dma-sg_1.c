static int vb2_dma_sg_dmabuf_ops_attach ( struct dma_buf * dbuf , struct device * dev , struct dma_buf_attachment * dbuf_attach ) { struct vb2_dma_sg_attachment * attach ; unsigned int i ; struct scatterlist * rd , * wr ; struct sg_table * sgt ; struct vb2_dma_sg_buf * buf = dbuf -> priv ; int ret ; attach = kzalloc ( sizeof ( * attach ) , GFP_KERNEL ) ; if ( ! attach ) { return - ENOMEM ; } sgt = & attach -> sgt ; ret = sg_alloc_table ( sgt , buf -> dma_sgt -> orig_nents , GFP_KERNEL ) ; if ( ret ) { return - ENOMEM ; } rd = buf -> dma_sgt -> sgl ; wr = sgt -> sgl ; for ( i = 0 ; i < sgt -> orig_nents ; ++ i ) { sg_set_page ( wr , sg_page ( rd ) , rd -> length , rd -> offset ) ; rd = sg_next ( rd ) ; wr = sg_next ( wr ) ; } attach -> dma_dir = DMA_NONE ; dbuf_attach -> priv = attach ; return 0 ; } 