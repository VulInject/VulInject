static void eib_rsrc_init_wqe_pool ( eib_t * ss , eib_wqe_pool_t * * wpp , ib_memlen_t bufsz , int wp_type ) { eib_wqe_pool_t * wp ; uint_t wp_wqesz ; int i ; ASSERT ( wpp != NULL ) ; ASSERT ( * wpp == NULL ) ; wp = kmem_zalloc ( sizeof ( eib_wqe_pool_t ) , KM_SLEEP ) ; wp_wqesz = EIB_WQES_PER_POOL * sizeof ( eib_wqe_t ) ; wp -> wp_wqe = ( eib_wqe_t * ) kmem_zalloc ( wp_wqesz , KM_SLEEP ) ; wp -> wp_memsz = EIB_WQES_PER_POOL * bufsz ; wp -> wp_vaddr = ( ib_vaddr_t ) ( uintptr_t ) kmem_zalloc ( wp -> wp_memsz , KM_SLEEP ) ; wp -> wp_ss = ss ; wp -> wp_type = wp_type ; wp -> wp_nfree_lwm = ( wp_type == EIB_WP_TYPE_TX ) ?EIB_NFREE_SWQES_LWM : EIB_NFREE_RWQES_LWM ; mutex_init ( & wp -> wp_lock , MUTEX_DRIVER , NULL ) ; cv_init ( & wp -> wp_cv , NULL , CV_DEFAULT , NULL ) ; wp -> wp_nfree = EIB_WQES_PER_POOL ; wp -> wp_free_blks = ( EIB_BLKS_PER_POOL >= 64 ) ?( ~ 0 ) : ( ( ( uint64_t ) 1 << EIB_BLKS_PER_POOL ) - 1 ) ; for ( i = 0 ; i < EIB_BLKS_PER_POOL ; i ++ ) { wp -> wp_free_wqes [ i ] = ~ 0 ; } * wpp = wp ; } 