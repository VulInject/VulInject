static int _cluster_get_wckeys ( mysql_conn_t * mysql_conn , slurmdb_wckey_cond_t * wckey_cond , char * fields , char * extra , char * cluster_name , List sent_list ) { List wckey_list = NULL ; MYSQL_RES * result = NULL ; MYSQL_ROW row ; char * query = NULL ; bool with_usage = 0 ; if ( wckey_cond ) { with_usage = wckey_cond -> with_usage ; } xstrfmtcat ( query , "select distinct %s from \"%s_%s\" as t1%s " "order by wckey_name, user;" , fields , cluster_name , wckey_table , extra ) ; DB_DEBUG ( DB_WCKEY , mysql_conn -> conn , "query\n%s" , query ) ; if ( ! ( result = mysql_db_query_ret ( mysql_conn , query , 0 ) ) ) { if ( mysql_errno ( mysql_conn -> db_conn ) == ER_NO_SUCH_TABLE ) { return SLURM_SUCCESS ; } else { return SLURM_ERROR ; } } xfree ( query ) ; if ( ! mysql_num_rows ( result ) ) { mysql_free_result ( result ) ; return SLURM_SUCCESS ; } wckey_list = list_create ( slurmdb_destroy_wckey_rec ) ; while ( ( row = mysql_fetch_row ( result ) ) ) { slurmdb_wckey_rec_t * wckey = xmalloc ( sizeof ( slurmdb_wckey_rec_t ) ) ; list_append ( wckey_list , wckey ) ; wckey -> id = slurm_atoul ( row [ WCKEY_REQ_ID ] ) ; wckey -> is_def = slurm_atoul ( row [ WCKEY_REQ_DEFAULT ] ) ; wckey -> user = xstrdup ( row [ WCKEY_REQ_USER ] ) ; if ( slurm_atoul ( row [ WCKEY_REQ_DELETED ] ) ) { wckey -> flags |= SLURMDB_WCKEY_FLAG_DELETED ; } if ( row [ WCKEY_REQ_NAME ] ) { wckey -> name = xstrdup ( row [ WCKEY_REQ_NAME ] ) ; } else { wckey -> name = xstrdup ( "" ) ; } wckey -> cluster = xstrdup ( cluster_name ) ; } mysql_free_result ( result ) ; if ( with_usage && wckey_list && list_count ( wckey_list ) ) { get_usage_for_list ( mysql_conn , DBD_GET_WCKEY_USAGE , wckey_list , cluster_name , wckey_cond -> usage_start , wckey_cond -> usage_end ) ; } list_transfer ( sent_list , wckey_list ) ; FREE_NULL_LIST ( wckey_list ) ; return SLURM_SUCCESS ; } 