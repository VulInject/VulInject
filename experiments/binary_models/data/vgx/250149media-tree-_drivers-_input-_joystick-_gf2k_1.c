static int gf2k_read_packet ( struct gameport * gameport , int length , char * data ) { unsigned char u , v ; int i ; unsigned int t , p ; unsigned long flags ; t = gameport_time ( gameport , GF2K_START ) ; p = gameport_time ( gameport , GF2K_STROBE ) ; i = 0 ; local_irq_save ( flags ) ; gameport_trigger ( gameport ) ; v = gameport_read ( gameport , NULL ) ; while ( t > 0 && i < length ) { t -- ; u = v ; v = gameport_read ( gameport ) ; if ( v & ~ u & 0x10 ) { data [ i ++ ] = v >> 5 ; t = p ; } } local_irq_restore ( flags ) ; return i ; } 