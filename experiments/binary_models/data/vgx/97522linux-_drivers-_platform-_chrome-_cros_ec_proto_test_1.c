static void cros_ec_proto_test_query_all_normal ( struct kunit * test ) { struct cros_ec_proto_test_priv * priv = test -> priv ; struct cros_ec_device * ec_dev = & priv -> ec_dev ; struct ec_xfer_mock * mock ; int ret ; { struct ec_response_get_protocol_info * data ; mock = cros_kunit_ec_xfer_mock_add ( test , sizeof ( * data ) ) ; KUNIT_ASSERT_PTR_NE ( test , mock , NULL ) ; data = ( ec_response_get_protocol_info * ) mock -> o_data ; data -> protocol_versions = BIT ( 3 ) | BIT ( 2 ) ; data -> max_request_packet_size = 0xbe ; data -> max_response_packet_size = 0xef ; } { struct ec_response_get_protocol_info * data ; mock = cros_kunit_ec_xfer_mock_add ( test , sizeof ( * data ) ) ; KUNIT_ASSERT_PTR_NE ( test , mock , NULL ) ; data = ( ec_response_get_protocol_info * ) mock -> o_data ; data -> max_request_packet_size = 0xbf ; } { struct ec_response_get_cmd_versions * data ; mock = cros_kunit_ec_xfer_mock_add ( test , sizeof ( * data ) ) ; KUNIT_ASSERT_PTR_NE ( test , mock , NULL ) ; data = ( ec_response_get_cmd_versions * ) mock -> o_data ; data -> version_mask = BIT ( 6 ) | BIT ( 5 ) ; } { struct ec_response_get_cmd_versions * data ; mock = cros_kunit_ec_xfer_mock_add ( test , sizeof ( * data ) ) ; KUNIT_ASSERT_PTR_NE ( test , mock , NULL ) ; data = ( ec_response_get_cmd_versions * ) mock -> o_data ; data -> version_mask = BIT ( 1 ) ; } { struct ec_response_host_event_mask * data ; mock = cros_kunit_ec_xfer_mock_add ( test , sizeof ( * data ) ) ; KUNIT_ASSERT_PTR_NE ( test , mock , NULL ) ; data = ( ec_response_host_event_mask * ) mock -> o_data ; } cros_ec_proto_test_query_all_pretest ( test ) ; ret = cros_ec_query_all ( ec_dev ) ; KUNIT_EXPECT_EQ ( test , ret , 0 ) ; { mock = cros_kunit_ec_xfer_mock_next ( ) ; KUNIT_EXPECT_PTR_NE ( test , mock , NULL ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . version , 0 ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . command , EC_CMD_GET_PROTOCOL_INFO ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . insize , sizeof ( ec_response_get_protocol_info ) ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . outsize , 0 ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> max_request , 0xbe - sizeof ( ec_host_request ) ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> max_response , 0xef - sizeof ( ec_host_response ) ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> proto_version , 3 ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> din_size , 0xef + EC_MAX_RESPONSE_OVERHEAD ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> dout_size , 0xbe + EC_MAX_REQUEST_OVERHEAD ) ; } { mock = cros_kunit_ec_xfer_mock_next ( ) ; KUNIT_EXPECT_PTR_NE ( test , mock , NULL ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . version , 0 ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . command , EC_CMD_PASSTHRU_OFFSET ( CROS_EC_DEV_PD_INDEX ) | EC_CMD_GET_PROTOCOL_INFO ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . insize , sizeof ( ec_response_get_protocol_info ) ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . outsize , 0 ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> max_passthru , 0xbf - sizeof ( ec_host_request ) ) ; } { struct ec_params_get_cmd_versions * data ; mock = cros_kunit_ec_xfer_mock_next ( ) ; KUNIT_EXPECT_PTR_NE ( test , mock , NULL ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . version , 0 ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . command , EC_CMD_GET_CMD_VERSIONS ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . insize , sizeof ( ec_response_get_cmd_versions ) ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . outsize , sizeof ( * data ) ) ; data = ( ec_params_get_cmd_versions * ) mock -> i_data ; KUNIT_EXPECT_EQ ( test , data -> cmd , EC_CMD_GET_NEXT_EVENT ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> mkbp_event_supported , 7 ) ; } { struct ec_params_get_cmd_versions * data ; mock = cros_kunit_ec_xfer_mock_next ( ) ; KUNIT_EXPECT_PTR_NE ( test , mock , NULL ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . version , 0 ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . command , EC_CMD_GET_CMD_VERSIONS ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . insize , sizeof ( ec_response_get_cmd_versions ) ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . outsize , sizeof ( * data ) ) ; data = ( ec_params_get_cmd_versions * ) mock -> i_data ; KUNIT_EXPECT_EQ ( test , data -> cmd , EC_CMD_HOST_SLEEP_EVENT ) ; KUNIT_EXPECT_TRUE ( test , ec_dev -> host_sleep_v1 ) ; } { mock = cros_kunit_ec_xfer_mock_next ( ) ; KUNIT_EXPECT_PTR_NE ( test , mock , NULL ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . version , 0 ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . command , EC_CMD_HOST_EVENT_GET_WAKE_MASK ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . insize , sizeof ( ec_response_host_event_mask ) ) ; KUNIT_EXPECT_EQ ( test , mock -> msg . outsize , 0 ) ; KUNIT_EXPECT_EQ ( test , ec_dev -> host_event_wake_mask , 0xbeef ) ; } } 