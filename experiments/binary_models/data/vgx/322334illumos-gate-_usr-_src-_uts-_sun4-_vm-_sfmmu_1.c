static struct memlist * ndata_select_chunk ( struct memlist * ndata , size_t wanted , size_t alignment ) { struct memlist * fnd_below = NULL ; struct memlist * fnd_above = NULL ; struct memlist * fnd_unused = NULL ; struct memlist * frlist ; uintptr_t base ; uintptr_t end ; size_t below ; size_t above ; size_t unused ; size_t best_below = ULONG_MAX ; size_t best_above = ULONG_MAX ; size_t best_unused = ULONG_MAX ; ASSERT ( ndata != NULL ) ; for ( frlist = ndata ; frlist != NULL ; frlist = frlist -> ml_next ) { base = roundup ( frlist -> ml_address , alignment ) ; end = roundup ( base + wanted , ecache_alignsize ) ; below = ( base - frlist -> ml_address ) / ecache_alignsize ; above = ( frlist -> ml_address + frlist -> ml_size - end ) / ecache_alignsize ; unused = below + above ; if ( unused == 0 ) { return ( frlist ) ; } if ( frlist -> ml_next == NULL ) { break ; } if ( below < best_below ) { best_below = below ; fnd_below = frlist ; } if ( above < best_above ) { best_above = above ; fnd_above = frlist ; } if ( unused < best_unused ) { best_unused = unused ; fnd_unused = frlist ; } } if ( best_below == 0 ) { return ( fnd_below ) ; } if ( best_above == 0 ) { return ( fnd_above ) ; } if ( best_unused < ULONG_MAX ) { return ( fnd_unused ) ; } return ( frlist ) ; } 