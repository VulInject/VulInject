static int unwrap_merge ( void * arg ) { struct dma_fence * fence , * f1 , * f2 , * f3 ; struct dma_fence_unwrap iter ; int err = 0 ; f1 = mock_fence ( ) ; if ( ! f1 ) { return - ENOMEM ; } dma_fence_enable_sw_signaling ( f1 ) ; f2 = mock_fence ( ) ; if ( ! f2 ) { err = - ENOMEM ; error_put_f1 } dma_fence_enable_sw_signaling ( f2 ) ; f3 = dma_fence_unwrap_merge ( f1 , f2 ) ; if ( ! f3 ) { err = - ENOMEM ; error_put_f2 } dma_fence_unwrap_for_each ( , , ) { if ( fence == f1 ) { dma_fence_put ( f1 , NULL ) ; f1 = NULL ; } if ( fence == f2 ) { dma_fence_put ( f2 ) ; f2 = NULL ; } else { pr_err ( "Unexpected fence!\n" ) ; err = - EINVAL ; } } if ( f1 || f2 ) { pr_err ( "Not all fences seen!\n" ) ; err = - EINVAL ; } dma_fence_put ( f3 ) ; error_put_f2 dma_fence_put ( f2 ) ; error_put_f1 dma_fence_put ( f1 ) ; return err ; } 