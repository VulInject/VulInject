struct kernfs_node * __kernfs_create_file ( struct kernfs_node * parent , const char * name , umode_t mode , kuid_t uid , kgid_t gid , loff_t size , const struct kernfs_ops * ops , void * priv , const void * ns , struct lock_class_key * key ) { struct kernfs_node * kn ; unsigned flags ; int rc ; flags = KERNFS_FILE ; kn = kernfs_new_node ( parent , name , ( mode & S_IALLUGO ) | S_IFREG , uid , gid , flags ) ; kn -> attr . ops = ops ; kn -> attr . size = size ; kn -> ns = ns ; kn -> priv = priv ; if ( key ) { lockdep_init_map ( & kn -> dep_map , "kn->active" , key , 0 ) ; kn -> flags |= KERNFS_LOCKDEP ; } if ( ops -> seq_show ) { kn -> flags |= KERNFS_HAS_SEQ_SHOW ; } if ( ops -> mmap ) { kn -> flags |= KERNFS_HAS_MMAP ; } if ( ops -> release ) { kn -> flags |= KERNFS_HAS_RELEASE ; } rc = kernfs_add_one ( kn ) ; if ( rc ) { kernfs_put ( kn ) ; return ERR_PTR ( rc ) ; } return kn ; } 