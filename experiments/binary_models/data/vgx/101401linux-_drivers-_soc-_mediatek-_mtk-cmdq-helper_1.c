struct cmdq_pkt * cmdq_pkt_create ( struct cmdq_client * client , size_t size ) { struct cmdq_pkt * pkt ; struct device * dev ; dma_addr_t dma_addr ; pkt = kzalloc ( sizeof ( * pkt ) , GFP_KERNEL ) ; if ( ! pkt ) { return ERR_PTR ( - ENOMEM ) ; } pkt -> va_base = kzalloc ( size , GFP_KERNEL ) ; if ( ! pkt -> va_base ) { return ERR_PTR ( - ENOMEM ) ; } pkt -> buf_size = size ; pkt -> cl = ( void * ) client ; dev = client -> chan -> mbox -> dev ; dma_addr = dma_map_single ( dev , pkt -> va_base , pkt -> buf_size , DMA_TO_DEVICE ) ; if ( dma_mapping_error ( dev , dma_addr ) ) { dev_err ( dev , "dma map failed, size=%u\n" , ( u32 ) ( u64 ) size ) ; kfree ( pkt -> va_base ) ; kfree ( pkt ) ; return ERR_PTR ( - ENOMEM ) ; } pkt -> pa_base = dma_addr ; return pkt ; } 