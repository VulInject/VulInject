static long fs3270_ioctl ( struct file * filp , unsigned int cmd , unsigned long arg ) { char __user * argp ; struct fs3270 * fp ; struct raw3270_iocb iocb ; int rc ; fp = filp -> private_data ; if ( is_compat_task ( ) ) { argp = compat_ptr ( arg ) ; } else { argp = ( char __user * ) arg ; } rc = 0 ; mutex_lock ( & fs3270_mutex ) ; switch ( cmd ) { case TUBICMD : fp -> read_command = arg ; break ; case TUBOCMD : fp -> write_command = arg ; break ; case TUBGETI : rc = put_user ( fp -> read_command , argp ) ; break ; case TUBGETO : rc = put_user ( fp -> write_command , argp ) ; break ; case TUBGETMOD : iocb . model = fp -> view . model ; iocb . line_cnt = fp -> view . rows ; iocb . col_cnt = fp -> view . cols ; iocb . pf_cnt = 24 ; iocb . re_cnt = 20 ; iocb . map = 0 ; if ( copy_to_user ( argp , & iocb , sizeof ( raw3270_iocb ) ) ) { rc = - EFAULT ; } break ; } mutex_unlock ( & fs3270_mutex ) ; return rc ; } 