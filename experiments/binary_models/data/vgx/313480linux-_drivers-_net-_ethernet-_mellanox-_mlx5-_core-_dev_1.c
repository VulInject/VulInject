static struct mlx5_adev * add_adev ( struct mlx5_core_dev * dev , int idx ) { const char * suffix = mlx5_adev_devices [ idx ] . suffix ; struct auxiliary_device * adev ; struct mlx5_adev * madev ; int ret ; madev = kzalloc ( sizeof ( * madev ) , GFP_KERNEL ) ; if ( ! madev ) { return ERR_PTR ( - ENOMEM ) ; } adev = & madev -> adev ; adev -> id = dev -> priv . adev_idx ; adev -> name = suffix ; adev -> dev . parent = dev -> device ; adev -> dev . release = adev_release ; madev -> mdev = dev ; madev -> idx = idx ; ret = auxiliary_device_init ( adev ) ; if ( ret ) { return ERR_PTR ( ret ) ; } ret = auxiliary_device_add ( adev ) ; if ( ret ) { auxiliary_device_uninit ( adev ) ; return ERR_PTR ( ret ) ; } return madev ; } 