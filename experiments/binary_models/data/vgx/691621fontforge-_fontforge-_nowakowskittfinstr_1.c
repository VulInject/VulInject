static void optimize_strongpts_step2 ( InstrCt * ct ) { int pass , i , j , forward ; int next_closed , prev_closed ; int next_pt_max , next_pt_min , prev_pt_max , prev_pt_min ; int next_coord_max , next_coord_min , prev_coord_max , prev_coord_min ; int * others = ct -> edge . others ; int othercnt = ct -> edge . othercnt ; int touchflag = ( ct -> xdir ) ?tf_x : tf_y ; int * contourends = ct -> contourends ; uint8_t * touched = ct -> touched ; uint8_t * affected = ct -> affected ; uint8_t * toinstr , * tocull , * tocheck ; toinstr = ( uint8_t * ) calloc ( ct -> ptcnt , sizeof ( uint8_t ) ) ; tocull = ( uint8_t * ) calloc ( ct -> ptcnt , sizeof ( uint8_t ) ) ; tocheck = ( uint8_t * ) calloc ( ct -> ptcnt , sizeof ( uint8_t ) ) ; for ( i = 0 ; i < ct -> edge . othercnt ; i ++ ) { tocheck [ ct -> edge . others [ i ] ] = 1 ; } for ( pass = 0 ; pass < 2 ; pass ++ ) { for ( i = 0 ; i < ct -> edge . othercnt ; i ++ ) { int pt = others [ i ] ; double pt_coord = ( ct -> xdir ) ?ct -> bp [ pt ] . x : ct -> bp [ pt ] . y ; if ( ( pass == 0 ) && ( ct -> gd -> points [ pt ] . sp != NULL ) ) { continue ; } if ( tocull [ pt ] || toinstr [ pt ] ) { continue ; } for ( forward = 0 ; forward < 2 ; forward ++ ) { int closed = 0 ; int pt_max = pt , pt_min = pt ; double coord_max = pt_coord , coord_min = pt_coord ; int curr = forward ?NextOnContour ( contourends , pt ) : PrevOnContour ( contourends , pt ) ; while ( curr != pt ) { double coord = ( ct -> xdir ) ?ct -> bp [ curr ] . x : ct -> bp [ curr ] . y ; if ( fabs ( ct -> edge . base - coord ) > ct -> gic -> fudge ) { break ; } if ( ( touched [ curr ] | affected [ curr ] ) & touchflag || tocheck [ curr ] ) { if ( coord > coord_max ) { coord_max = coord ; pt_max = curr ; } if ( ( coord == coord_max ) && ( curr < pt_max ) ) { pt_max = curr ; } if ( coord < coord_min ) { coord_min = coord ; pt_min = curr ; } if ( ( coord == coord_min ) && ( curr < pt_min ) ) { pt_min = curr ; } closed = 1 ; } if ( ( touched [ curr ] | affected [ curr ] ) & touchflag || toinstr [ curr ] ) { break ; } curr = forward ?NextOnContour ( contourends , curr ) : PrevOnContour ( contourends , curr ) ; } if ( forward ) { next_closed = closed ; next_pt_max = pt_max ; next_pt_min = pt_min ; next_coord_max = coord_max ; next_coord_min = coord_min ; } else { prev_closed = closed ; prev_pt_max = pt_max ; prev_pt_min = pt_min ; prev_coord_max = coord_max ; prev_coord_min = coord_min ; } } if ( prev_closed && next_closed && ( ( prev_coord_max >= pt_coord && pt != prev_pt_max && next_coord_min <= pt_coord && pt != next_pt_min ) || ( prev_coord_min <= pt_coord && pt != prev_pt_min && next_coord_max >= pt_coord && pt != next_pt_max ) ) ) { tocull [ pt ] = 1 ; } else { toinstr [ pt ] = 1 ; } } } for ( i = 0 ; i < ct -> edge . othercnt ; i ++ ) { if ( tocull [ others [ i ] ] ) { ct -> edge . othercnt -- ; for ( j = i ; j < ct -> edge . othercnt ; j ++ ) { others [ j ] = others [ j + 1 ] ; } i -- ; } } free ( tocheck ) ; free ( toinstr ) ; free ( tocull ) ; } 