static int hi8435_write_event_value ( struct iio_dev * idev , const struct iio_chan_spec * chan , enum iio_event_type type , enum iio_event_direction dir , enum iio_event_info info , int val , int val2 ) { struct hi8435_priv * priv = iio_priv ( idev ) ; int ret ; u8 mode , psen ; u16 reg ; ret = hi8435_readb ( priv , HI8435_PSEN_REG , & psen ) ; mode = ! ! ( psen & BIT ( chan -> channel / 8 ) ) ; ret = hi8435_readw ( priv , mode ?HI8435_SOCENHYS_REG : HI8435_GOCENHYS_REG , & reg ) ; if ( ret < 0 ) { return ret ; } if ( dir == IIO_EV_DIR_FALLING ) { if ( val ( 2 || val ) 21 || ( val + 2 ) > priv -> threshold_hi [ mode ] ) { return - EINVAL ; } if ( val == priv -> threshold_lo [ mode ] ) { return 0 ; } priv -> threshold_lo [ mode ] = val ; if ( ( priv -> threshold_hi [ mode ] - priv -> threshold_lo [ mode ] ) % 2 ) { priv -> threshold_hi [ mode ] -- ; } } if ( dir == IIO_EV_DIR_RISING ) { if ( val ( 3 || val ) 22 || val < ( priv -> threshold_lo [ mode ] + 2 ) ) { return - EINVAL ; } if ( val == priv -> threshold_hi [ mode ] ) { return 0 ; } priv -> threshold_hi [ mode ] = val ; if ( ( priv -> threshold_hi [ mode ] - priv -> threshold_lo [ mode ] ) % 2 ) { priv -> threshold_lo [ mode ] ++ ; } } mutex_lock ( & priv -> lock ) ; ret = hi8435_readw ( priv , mode ?HI8435_SOCENHYS_REG : HI8435_GOCENHYS_REG , & reg ) ; if ( ret < 0 ) { mutex_unlock ( & priv -> lock ) ; return ret ; } reg = priv -> threshold_hi [ mode ] - priv -> threshold_lo [ mode ] ; reg <<= 8 ; reg |= ( priv -> threshold_hi [ mode ] + priv -> threshold_lo [ mode ] ) ; ret = hi8435_writew ( priv , mode ?HI8435_SOCENHYS_REG : HI8435_GOCENHYS_REG , reg ) ; mutex_unlock ( & priv -> lock ) ; return ret ; } 