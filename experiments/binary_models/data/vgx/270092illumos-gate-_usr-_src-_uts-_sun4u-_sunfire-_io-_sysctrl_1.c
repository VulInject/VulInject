static uint_t system_high_handler ( caddr_t arg ) { struct sysctrl_soft_state * softsp = ( sysctrl_soft_state * ) arg ; uchar_t csr ; uchar_t status2 ; uchar_t tmp_reg ; int serviced = 0 ; ASSERT ( softsp , NULL ) ; mutex_enter ( & softsp -> csr_mutex ) ; csr = * ( softsp -> csr ) ; status2 = * ( softsp -> status2 ) ; if ( csr & SYS_AC_PWR_FAIL_EN ) { if ( status2 & SYS_AC_FAIL ) { nvram_update_powerfail ( softsp ) ; csr &= ~ SYS_AC_PWR_FAIL_EN ; ddi_trigger_softintr ( softsp -> ac_fail_id ) ; serviced ++ ; } } if ( csr & SYS_PS_FAIL_EN ) { if ( ( * ( softsp -> ps_stat ) != 0xff ) || ( ( ~ status2 ) & ( SYS_PPS0_OK | SYS_CLK_33_OK | SYS_CLK_50_OK ) ) || ( ~ ( * ( softsp -> pppsr ) ) & SYS_PPPSR_BITS ) ) { csr &= ~ SYS_PS_FAIL_EN ; ddi_trigger_softintr ( softsp -> ps_fail_int_id ) ; serviced ++ ; } } if ( csr & SYS_PPS_FAN_FAIL_EN ) { if ( status2 & SYS_RACK_FANFAIL || ! ( status2 & SYS_AC_FAN_OK ) || ! ( status2 & SYS_KEYSW_FAN_OK ) ) { softsp -> pps_fan_saved = status2 ; csr &= ~ SYS_PPS_FAN_FAIL_EN ; ddi_trigger_softintr ( softsp -> pps_fan_id ) ; serviced ++ ; } } if ( csr & SYS_SBRD_PRES_EN ) { if ( ! ( * ( softsp -> status1 ) & SYS_NOT_BRD_PRES ) ) { csr &= ~ SYS_SBRD_PRES_EN ; ddi_trigger_softintr ( softsp -> sbrd_pres_id ) ; serviced ++ ; } } if ( ! serviced ) { softsp -> saved_en_state |= csr & ( SYS_AC_PWR_FAIL_EN | SYS_PS_FAIL_EN | SYS_PPS_FAN_FAIL_EN | SYS_SBRD_PRES_EN ) ; csr &= ~ ( SYS_AC_PWR_FAIL_EN | SYS_PS_FAIL_EN | SYS_PPS_FAN_FAIL_EN | SYS_SBRD_PRES_EN ) ; softsp -> spur_count ++ ; ddi_trigger_softintr ( softsp -> spur_id ) ; } * ( softsp -> csr ) = csr ; tmp_reg = * ( softsp -> csr ) ; tmp_reg = tmp_reg ; mutex_exit ( & softsp -> csr_mutex ) ; return ( DDI_INTR_CLAIMED ) ; } 