SML_TAG * smlDup ( SML_TAG * tag ) { SML_TAG * rtag = SML_TAG__NULL ; int i ; assert ( SML_TAG__ISVALID ( tag ) ) ; rtag = ( SML_TAG * ) calloc ( 1 , sizeof ( SML_TAG ) ) ; assert ( rtag != SML_TAG__NULL ) ; rtag -> name = ( tag -> name ?strdup ( tag -> name ) : ( char * ) NULL ) ; rtag -> params_num = tag -> params_num ; if ( tag -> params != ( SML_PARAM * ) NULL ) { rtag -> params = ( SML_PARAM * ) calloc ( 1 , sizeof ( SML_PARAM ) * rtag -> params_num ) ; bzero ( rtag -> params , sizeof ( SML_PARAM ) * rtag -> params_num ) ; for ( i = 0 ; i < rtag -> params_num ; i ++ ) { rtag -> params [ i ] . name = tag -> params [ i ] . name ?strdup ( tag -> params [ i ] . name ) : ( char * ) NULL ; rtag -> params [ i ] . value = tag -> params [ i ] . value ?strdup ( tag -> params [ i ] . value ) : ( char * ) NULL ; } } rtag -> tags_num = tag -> tags_num ; if ( tag -> tags != SML_TAG__NULL ) { rtag -> tags = ( SML_TAG * ) calloc ( 1 , sizeof ( SML_TAG ) * rtag -> tags_num ) ; bzero ( rtag -> tags , sizeof ( SML_TAG ) * rtag -> tags_num ) ; for ( i = 0 ; i < rtag -> tags_num ; i ++ ) { SML_TAG * stag ; stag = smlDup ( & tag -> tags [ i ] ) ; ( void ) memcpy ( & rtag -> tags [ i ] , stag , sizeof ( SML_TAG ) ) ; } } assert ( SML_TAG__ISVALID ( rtag ) ) ; return ( rtag ) ; } void smlSetFileStatInfo ( SML_TAG * * tag , struct stat * statbuf , char * path ) { SML_TAG * rtag ; assert ( SML_TAG__R_ISVALID ( tag ) ) ; assert ( SML_TAG__ISVALID ( * tag ) ) ; assert ( statbuf != ( stat * ) NULL ) ; ( void ) smlFindAndDelTag ( * tag , _sml_fileStatInfoTag ) ; assert ( smlGetTagByName ( * tag , 0 , _sml_fileStatInfoTag ) == SML_TAG__NULL ) ; rtag = smlNewTag ( _sml_fileStatInfoTag ) ; assert ( SML_TAG__ISVALID ( rtag ) ) ; ( void ) smlAddTag ( tag , 0 , rtag ) ; free ( rtag ) ; rtag = smlGetTagByName ( * tag , 0 , _sml_fileStatInfoTag ) ; assert ( SML_TAG__ISVALID ( rtag ) ) ; if ( path != ( char * ) NULL ) { smlSetParam ( rtag , "st_path" , path ) ; } smlSetParamF ( rtag , "st_ino" , "0x%llx" , ( unsigned long long ) statbuf -> st_ino ) ; smlSetParamF ( rtag , "st_mode" , "0x%llx" , ( unsigned long long ) statbuf -> st_mode ) ; smlSetParamF ( rtag , "st_mtime" , "0x%llx" , ( unsigned long long ) statbuf -> st_mtime ) ; smlSetParamF ( rtag , "st_ctime" , "0x%llx" , ( unsigned long long ) statbuf -> st_ctime ) ; smlSetParamF ( rtag , "st_size" , "0x%llx" , ( unsigned long long ) statbuf -> st_size ) ; } 