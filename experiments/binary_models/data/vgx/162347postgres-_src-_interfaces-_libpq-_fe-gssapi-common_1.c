int pg_GSS_load_servicename ( PGconn * conn ) { OM_uint32 maj_stat , min_stat ; int maxlen ; gss_buffer_desc temp_gbuf ; char * host ; if ( conn -> gtarg_nam != NULL ) { return STATUS_OK ; } host = PQhost ( conn ) ; if ( ! ( host && host [ 0 ] != '\0' ) ) { libpq_append_conn_error ( conn , "host name must be specified" ) ; return STATUS_ERROR ; } maxlen = strlen ( conn -> krbsrvname ) + strlen ( host ) + 2 ; temp_gbuf . value = ( char * ) malloc ( maxlen ) ; if ( ! temp_gbuf . value ) { libpq_append_conn_error ( conn , "out of memory" ) ; return STATUS_ERROR ; } snprintf ( temp_gbuf . value , maxlen , "%s@%s" , conn -> krbsrvname , host ) ; temp_gbuf . length = strlen ( temp_gbuf . value ) ; maj_stat = gss_import_name ( & min_stat , & temp_gbuf , GSS_C_NT_HOSTBASED_SERVICE , & conn -> gtarg_nam ) ; if ( maj_stat != GSS_S_COMPLETE ) { pg_GSS_error ( libpq_gettext ( "GSSAPI name import error" ) , conn , maj_stat , min_stat ) ; return STATUS_ERROR ; } return STATUS_OK ; } 