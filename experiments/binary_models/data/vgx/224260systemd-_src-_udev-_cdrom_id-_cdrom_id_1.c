static int dvd_ram_media_update_state ( Context * c ) { struct scsi_cmd sc ; unsigned char dvdstruct [ 8 ] ; unsigned char format [ 12 ] ; unsigned char len ; int r ; assert ( c ) ; if ( c -> media_feature != FEATURE_DVD_RAM ) { return 0 ; } scsi_cmd_init ( & sc ) ; scsi_cmd_set ( & sc , 0 , GPCMD_READ_DVD_STRUCTURE ) ; scsi_cmd_set ( & sc , 7 , 0xC0 ) ; scsi_cmd_set ( & sc , 9 , sizeof ( dvdstruct ) ) ; scsi_cmd_set ( & sc , 11 , 0 ) ; r = scsi_cmd_run_and_log ( & sc , c -> fd , dvdstruct , sizeof ( dvdstruct ) , "read DVD structure" ) ; if ( dvdstruct [ 4 ] & 0x02 ) { c -> media_state = MEDIA_STATE_COMPLETE ; log_debug ( "Write-protected DVD-RAM media inserted" ) ; return 1 ; } scsi_cmd_init ( & sc ) ; scsi_cmd_set ( & sc , 0 , GPCMD_READ_FORMAT_CAPACITIES ) ; scsi_cmd_set ( & sc , 8 , sizeof ( format ) ) ; scsi_cmd_set ( & sc , 9 , 0 ) ; r = scsi_cmd_run_and_log ( & sc , c -> fd , format , sizeof ( format ) , "read DVD format capacities" ) ; if ( r < 0 ) { return r ; } len = format [ 3 ] ; if ( len & 7 || len < 16 ) { return log_debug_errno ( SYNTHETIC_ERRNO ( EINVAL ) , "Invalid format capacities length." ) ; } switch ( format [ 8 ] & 3 ) { case 1 : log_debug ( "Unformatted DVD-RAM media inserted." ) ; return 1 ; case 2 : log_debug ( "Formatted DVD-RAM media inserted." ) ; return 0 ; case 3 : c -> has_media = false ; return log_debug_errno ( SYNTHETIC_ERRNO ( ENOMEDIUM ) , "Format capacities returned no media." ) ; } return 0 ; } 