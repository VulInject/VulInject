static int device_init_rd1_ring ( struct vnt_private * priv ) { int i ; dma_addr_t curr = priv -> rd1_pool_dma ; struct vnt_rx_desc * desc ; int ret ; for ( i = 0 ; i < priv -> opts . rx_descs1 ; i ++ , curr += sizeof ( vnt_rx_desc ) ) { desc = & priv -> aRD1Ring [ i ] ; desc -> rd_info = kmalloc ( sizeof ( * desc -> rd_info ) , GFP_KERNEL ) ; if ( ! desc -> rd_info ) { ret = - ENOMEM ; err_free_desc } if ( ! device_alloc_rx_buf ( priv , desc ) ) { dev_err ( & priv -> pcid -> dev , "can not alloc rx bufs\n" ) ; ret = - ENOMEM ; err_free_rd } desc -> next = & priv -> aRD1Ring [ ( i + 1 ) % priv -> opts . rx_descs1 ] ; desc -> next_desc = cpu_to_le32 ( curr + sizeof ( vnt_rx_desc ) ) ; } if ( i > 0 ) { priv -> aRD1Ring [ i - 1 ] . next_desc = cpu_to_le32 ( priv -> rd1_pool_dma ) ; } priv -> pCurrRD [ 1 ] = & priv -> aRD1Ring [ 0 ] ; return 0 ; err_free_rd kfree ( desc -> rd_info ) ; err_free_desc while ( i -- ) { desc = & priv -> aRD1Ring [ i ] ; device_free_rx_buf ( priv , desc ) ; kfree ( desc -> rd_info ) ; } return ret ; } 