BOOL CALLBACK LogCallback ( HWND hDlg , UINT message , WPARAM wParam , LPARAM lParam ) { HDC hDC ; HFONT hf ; LONG lfHeight ; LONG_PTR style ; DWORD log_size ; char * log_buffer = NULL , * filepath ; EXT_DECL ( log_ext , "rufus.log" , __VA_GROUP__ ( "*.log" ) , __VA_GROUP__ ( "Rufus log" ) ) ; switch ( message ) { case WM_INITDIALOG : apply_localization ( IDD_LOG , hDlg ) ; hLog = GetDlgItem ( hDlg , IDC_LOG_EDIT ) ; PostMessage ( hLog , EM_LIMITTEXT , MAX_LOG_SIZE , 0 ) ; hDC = GetDC ( NULL ) ; lfHeight = - MulDiv ( 9 , GetDeviceCaps ( hDC , LOGPIXELSY ) , 72 ) ; safe_release_dc ( hDC ) ; hf = CreateFontA ( lfHeight , 0 , 0 , 0 , FW_NORMAL , FALSE , FALSE , FALSE , DEFAULT_CHARSET , 0 , 0 , PROOF_QUALITY , 0 , "Consolas" ) ; SendDlgItemMessageA ( hDlg , IDC_LOG_EDIT , WM_SETFONT , ( WPARAM ) hf , TRUE ) ; SendMessage ( hDlg , WM_NEXTDLGCTL , ( WPARAM ) GetDlgItem ( hDlg , IDCANCEL ) , TRUE ) ; style = GetWindowLongPtr ( hLog , GWL_EXSTYLE ) ; style &= ~ ( WS_EX_RTLREADING | WS_EX_RIGHT | WS_EX_LEFTSCROLLBAR ) ; SetWindowLongPtr ( hLog , GWL_EXSTYLE , style ) ; style = GetWindowLongPtr ( hLog , GWL_STYLE ) ; style &= ~ ( ES_RIGHT ) ; SetWindowLongPtr ( hLog , GWL_STYLE , style ) ; break ; case WM_COMMAND : switch ( LOWORD ( wParam ) ) { case IDCANCEL : ShowWindow ( hDlg , SW_HIDE ) ; log_displayed = FALSE ; SendMessage ( hMainDialog , WM_NEXTDLGCTL , ( WPARAM ) GetDlgItem ( hMainDialog , IDCANCEL ) , TRUE ) ; return TRUE ; case IDC_LOG_CLEAR : SetWindowTextA ( hLog , "" ) ; return TRUE ; case IDC_LOG_SAVE : log_size = GetWindowTextLengthU ( hLog ) ; if ( log_size <= 0 ) { break ; } log_buffer = ( char * ) malloc ( log_size ) ; if ( log_buffer != NULL ) { log_size = GetDlgItemTextU ( hDlg , IDC_LOG_EDIT , log_buffer , log_size ) ; if ( log_size != 0 ) { log_size -- ; filepath = FileDialog ( TRUE , user_dir , & log_ext , 0 ) ; if ( filepath != NULL ) { FileIO ( FILE_IO_WRITE , filepath , & log_buffer , & log_size ) ; } safe_free ( filepath ) ; } safe_free ( log_buffer ) ; } break ; } break ; case WM_CLOSE : ShowWindow ( hDlg , SW_HIDE ) ; reset_localization ( IDD_LOG ) ; log_displayed = FALSE ; SendMessage ( hMainDialog , WM_NEXTDLGCTL , ( WPARAM ) GetDlgItem ( hMainDialog , IDCANCEL ) , TRUE ) ; return TRUE ; case UM_RESIZE_BUTTONS : ResizeButtonHeight ( hDlg , IDCANCEL ) ; ResizeButtonHeight ( hDlg , IDC_LOG_SAVE ) ; ResizeButtonHeight ( hDlg , IDC_LOG_CLEAR ) ; return TRUE ; } return FALSE ; } 