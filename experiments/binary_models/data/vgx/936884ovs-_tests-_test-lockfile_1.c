static void run_lock_symlink_to_dir ( void ) { struct lockfile * a , * dummy ; struct stat s ; CHECK ( mkdir ( "dir" , 0700 ) , 0 ) ; CHECK ( symlink ( "dir/b" , "a" ) , 0 ) ; CHECK ( lstat ( "a" , & s ) , 0 ) ; CHECK ( S_ISLNK ( s . st_mode ) != 0 , 1 ) ; CHECK ( lockfile_lock ( "a" , & a ) , 0 ) ; CHECK ( lstat ( "dir/.b.~lock~" , & s ) , 0 ) ; CHECK ( S_ISREG ( s . st_mode ) != 0 , 1 ) ; CHECK ( lstat ( ".a.~lock~" , & s ) , - 1 ) ; CHECK ( errno , ENOENT ) ; CHECK ( lockfile_lock ( "dir/b" , & dummy ) , EDEADLK ) ; lockfile_unlock ( a , NULL ) ; } 