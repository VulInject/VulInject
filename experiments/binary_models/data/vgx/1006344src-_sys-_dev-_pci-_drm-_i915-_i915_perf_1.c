static int gen7_append_oa_reports ( struct i915_perf_stream * stream , char __user * buf , size_t count , size_t * offset ) { struct intel_uncore * uncore = stream -> uncore ; int report_size = stream -> oa_buffer . format_size ; u8 * oa_buf_base = stream -> oa_buffer . vaddr ; u32 gtt_offset = i915_ggtt_offset ( stream -> oa_buffer . vma ) ; u32 mask = ( OA_BUFFER_SIZE - 1 ) ; size_t start_offset = * offset ; unsigned long flags ; u32 head , tail ; u32 taken ; int ret = 0 ; if ( drm_WARN_ON ( & uncore -> i915 -> drm , ! stream -> enabled ) ) { return - EIO ; } spin_lock_irqsave ( & stream -> oa_buffer . ptr_lock , flags ) ; head = stream -> oa_buffer . head ; tail = stream -> oa_buffer . tail ; spin_unlock_irqrestore ( & stream -> oa_buffer . ptr_lock , flags ) ; head -= gtt_offset ; tail -= gtt_offset ; if ( drm_WARN_ONCE ( & uncore -> i915 -> drm , head > OA_BUFFER_SIZE || head % report_size || tail > OA_BUFFER_SIZE || tail % report_size , "Inconsistent OA buffer pointers: head = %u, tail = %u\n" , head , tail ) ) { return - EIO ; } for ( ; ( taken = OA_TAKEN ( tail , head ) ) ; head = ( head + report_size ) & mask ) { u8 * report = oa_buf_base + head ; u32 * report32 = ( void * ) report ; if ( drm_WARN_ON ( & uncore -> i915 -> drm , ( OA_BUFFER_SIZE - head ) < report_size ) ) { drm_err ( & uncore -> i915 -> drm , "Spurious OA head ptr: non-integral report offset\n" ) ; break ; } if ( report32 [ 0 ] == 0 ) { if ( __ratelimit ( & stream -> perf -> spurious_report_rs ) ) { DRM_NOTE ( "Skipping spurious, invalid OA report\n" ) ; } continue ; } ret = append_oa_sample ( stream , buf , count , offset , report ) ; report32 [ 0 ] = 0 ; report32 [ 1 ] = 0 ; } if ( start_offset != * offset ) { spin_lock_irqsave ( & stream -> oa_buffer . ptr_lock , flags ) ; head += gtt_offset ; intel_uncore_write ( uncore , GEN7_OASTATUS2 , ( head & GEN7_OASTATUS2_HEAD_MASK ) | GEN7_OASTATUS2_MEM_SELECT_GGTT ) ; stream -> oa_buffer . head = head ; spin_unlock_irqrestore ( & stream -> oa_buffer . ptr_lock , flags ) ; } return ret ; } 