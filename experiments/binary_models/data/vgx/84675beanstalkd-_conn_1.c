void connclose ( Conn * c ) { sockwant ( & c -> sock , 0 ) ; close ( c -> sock . fd ) ; if ( verbose ) { printf ( "close %d\n" , c -> sock . fd ) ; } job_free ( c -> in_job ) ; if ( c -> out_job && c -> out_job -> r . state == Copy ) { job_free ( c -> out_job ) ; } c -> in_job = c -> out_job = NULL ; c -> in_job_read = 0 ; if ( c -> type & CONN_TYPE_PRODUCER ) { cur_producer_ct -- ; } if ( c -> type & CONN_TYPE_WORKER ) { cur_worker_ct -- ; } cur_conn_ct -- ; remove_waiting_conn ( c ) ; if ( has_reserved_job ( c ) ) { enqueue_reserved_jobs ( c ) ; } ms_clear ( & c -> watch ) ; c -> use -> using_ct -- ; TUBE_ASSIGN ( c -> use ) ; if ( c -> in_conns ) { heapremove ( & c -> srv -> conns , c -> tickpos ) ; c -> in_conns = 0 ; } free ( c ) ; } 