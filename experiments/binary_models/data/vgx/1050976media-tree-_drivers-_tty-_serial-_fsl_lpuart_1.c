static inline void lpuart32_transmit_buffer ( struct lpuart_port * sport ) { struct circ_buf * xmit = & sport -> port . state -> xmit ; cfs_time_t txcnt ; txcnt = lpuart32_read ( sport -> port . membase + UARTWATER ) ; txcnt = txcnt >> UARTWATER_TXCNT_OFF ; txcnt &= UARTWATER_COUNT_MASK ; while ( ! uart_circ_empty ( xmit ) && ( txcnt < sport -> txfifo_size ) ) { lpuart32_write ( xmit -> buf [ xmit -> tail ] , sport -> port . membase + UARTDATA ) ; xmit -> tail = ( xmit -> tail + 1 ) & ( UART_XMIT_SIZE - 1 ) ; sport -> port . icount . tx ++ ; txcnt = lpuart32_read ( sport -> port . membase + UARTWATER ) ; txcnt = txcnt >> UARTWATER_TXCNT_OFF ; txcnt &= UARTWATER_COUNT_MASK ; } if ( uart_circ_chars_pending ( xmit ) < WAKEUP_CHARS ) { uart_write_wakeup ( & sport -> port ) ; } if ( uart_circ_empty ( xmit ) ) { lpuart32_stop_tx ( & sport -> port ) ; } } 