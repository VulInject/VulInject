struct zip_extra_field * _zip_ef_parse ( const zip_uint8_t * data , zip_uint16_t len , zip_flags_t flags , struct zip_error * error ) { struct zip_extra_field * ef , * ef2 , * ef_head ; const zip_uint8_t * p ; zip_uint16_t fid , flen ; ef_head = NULL ; for ( p = data ; p < data + len ; p += flen ) { if ( p + 4 > data + len ) { _zip_error_set ( error , ZIP_ER_INCONS , 0 ) ; return NULL ; } fid = _zip_read2 ( & p ) ; flen = _zip_read2 ( & p ) ; if ( p + flen > data + len ) { _zip_error_set ( error , ZIP_ER_INCONS , 0 ) ; _zip_ef_free ( ef_head ) ; return NULL ; } if ( ( ef2 = _zip_ef_new ( fid , flen , p , flags ) ) == NULL ) { _zip_error_set ( error , ZIP_ER_MEMORY , 0 ) ; _zip_ef_free ( ef_head ) ; return NULL ; } if ( ef_head ) { ef -> next = ef2 ; ef = ef2 ; } else { ef_head = ef = ef2 ; } } return ef_head ; } 