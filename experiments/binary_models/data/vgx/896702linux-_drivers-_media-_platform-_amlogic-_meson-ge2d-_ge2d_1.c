static int ge2d_open ( struct file * file ) { struct meson_ge2d * ge2d = video_drvdata ( file ) ; struct ge2d_ctx * ctx = NULL ; int ret = 0 ; ctx = kmalloc ( sizeof ( * ctx ) , GFP_KERNEL ) ; if ( ! ctx ) { return - ENOMEM ; } ctx -> ge2d = ge2d ; ctx -> in = def_frame ; ctx -> out = def_frame ; if ( mutex_lock_interruptible ( & ge2d -> mutex ) ) { kfree ( ctx ) ; return - ERESTARTSYS ; } ctx -> fh . m2m_ctx = v4l2_m2m_ctx_init ( ge2d -> m2m_dev , ctx , & queue_init ) ; if ( IS_ERR ( ctx -> fh . m2m_ctx ) ) { ret = PTR_ERR ( ctx -> fh . m2m_ctx ) ; mutex_unlock ( & ge2d -> mutex ) ; kfree ( ctx ) ; return ret ; } v4l2_fh_init ( & ctx -> fh , video_devdata ( file ) ) ; file -> private_data = & ctx -> fh ; v4l2_fh_add ( & ctx -> fh ) ; ge2d_setup_ctrls ( ctx ) ; v4l2_ctrl_handler_setup ( & ctx -> ctrl_handler ) ; ctx -> fh . ctrl_handler = & ctx -> ctrl_handler ; mutex_unlock ( & ge2d -> mutex ) ; return 0 ; } 