static int sun4i_mdio_probe ( struct platform_device * pdev ) { struct device_node * np = pdev -> dev . of_node ; struct mii_bus * bus ; struct sun4i_mdio_data * data ; int ret ; bus = mdiobus_alloc_size ( sizeof ( * data ) ) ; if ( ! bus ) { return - ENOMEM ; } bus -> name = "sun4i_mii_bus" ; bus -> read = & sun4i_mdio_read ; bus -> write = & sun4i_mdio_write ; snprintf ( bus -> id , MII_BUS_ID_SIZE , "%s-mii" , dev_name ( & pdev -> dev ) ) ; bus -> parent = & pdev -> dev ; data = bus -> priv ; data -> membase = devm_platform_ioremap_resource ( pdev , 0 ) ; if ( IS_ERR ( data -> membase ) ) { ret = PTR_ERR ( data -> membase ) ; err_out_free_mdiobus } data -> regulator = devm_regulator_get ( & pdev -> dev , "phy" ) ; if ( IS_ERR ( data -> regulator ) ) { if ( PTR_ERR ( data -> regulator ) == - EPROBE_DEFER ) { ret = - EPROBE_DEFER ; err_out_free_mdiobus } dev_info ( & pdev -> dev , "no regulator found\n" ) ; } else { ret = regulator_enable ( data -> regulator ) ; if ( ret ) { err_out_free_mdiobus } } ret = of_mdiobus_register ( bus , np ) ; if ( ret < 0 ) { err_out_disable_regulator } platform_set_drvdata ( pdev , bus ) ; return 0 ; err_out_disable_regulator if ( data -> regulator ) { regulator_disable ( data -> regulator ) ; } err_out_free_mdiobus mdiobus_free ( bus ) ; return ret ; } 