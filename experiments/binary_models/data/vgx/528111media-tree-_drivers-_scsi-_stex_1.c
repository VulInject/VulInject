static int stex_handshake ( struct st_hba * hba ) { int err ; unsigned long flags ; unsigned int mu_status ; if ( hba -> cardtype == st_yel || hba -> cardtype == st_P3 ) { err = stex_ss_handshake ( hba ) ; } else { err = stex_common_handshake ( hba ) ; } spin_lock_irqsave ( hba -> host -> host_lock , flags ) ; mu_status = hba -> mu_status ; if ( err == 0 ) { hba -> req_head = 0 ; hba -> status_head = 0 ; hba -> status_tail = 0 ; hba -> out_req_cnt = 0 ; hba -> mu_status = MU_STATE_STARTED ; } else { hba -> mu_status = MU_STATE_FAILED ; } if ( mu_status == MU_STATE_RESETTING ) { wake_up_all ( & hba -> reset_waitq ) ; } spin_unlock_irqrestore ( hba -> host -> host_lock , flags ) ; return err ; } 