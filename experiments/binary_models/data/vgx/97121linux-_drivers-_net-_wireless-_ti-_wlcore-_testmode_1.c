static int wl1271_tm_cmd_interrogate ( struct wl1271 * wl , struct nlattr * tb [ ] ) { int ret ; struct wl1271_command * cmd ; struct sk_buff * skb ; u8 ie_id ; wl1271_debug ( DEBUG_TESTMODE , "testmode cmd interrogate" ) ; if ( ! tb [ WL1271_TM_ATTR_IE_ID ] ) { return - EINVAL ; } ie_id = nla_get_u8 ( tb [ WL1271_TM_ATTR_IE_ID ] ) ; mutex_lock ( & wl -> mutex ) ; if ( unlikely ( wl -> state != WLCORE_STATE_ON ) ) { ret = - EINVAL ; out } ret = pm_runtime_resume_and_get ( wl -> dev ) ; if ( ret < 0 ) { out } cmd = kzalloc ( sizeof ( * cmd ) , GFP_KERNEL ) ; if ( ! cmd ) { ret = - ENOMEM ; out_sleep } ret = wl1271_cmd_interrogate ( wl , ie_id , cmd , sizeof ( acx_header ) , sizeof ( * cmd ) ) ; if ( ret < 0 ) { wl1271_warning ( "testmode cmd interrogate failed: %d" , ret ) ; out_free } skb = cfg80211_testmode_alloc_reply_skb ( wl -> hw -> wiphy , sizeof ( * cmd ) ) ; if ( ! skb ) { ret = - ENOMEM ; out_free } if ( nla_put ( skb , WL1271_TM_ATTR_DATA , sizeof ( * cmd ) , cmd ) ) { ret = - EMSGSIZE ; out_free } ret = cfg80211_testmode_reply ( skb ) ; if ( ret < 0 ) { out_free } out_free kfree ( cmd ) ; out_sleep pm_runtime_mark_last_busy ( wl -> dev ) ; pm_runtime_put_autosuspend ( wl -> dev ) ; out mutex_unlock ( & wl -> mutex ) ; return ret ; } 