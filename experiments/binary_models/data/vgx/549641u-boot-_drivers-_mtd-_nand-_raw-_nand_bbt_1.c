static int nand_update_bbt ( struct mtd_info * mtd , loff_t offs ) { struct nand_chip * this = mtd_to_nand ( mtd ) ; int len , res = 0 ; int chip , chipsel ; uint8_t * buf ; struct nand_bbt_descr * td = this -> bbt_td ; struct nand_bbt_descr * md = this -> bbt_md ; if ( ! this -> bbt || ! td ) { return - EINVAL ; } len = ( 1 << this -> bbt_erase_shift ) ; len += ( len >> this -> page_shift ) * mtd -> oobsize ; buf = kmalloc ( len , GFP_KERNEL ) ; if ( ! buf ) { return - ENOMEM ; } if ( td -> options & NAND_BBT_PERCHIP ) { chip = ( int ) ( offs >> this -> chip_shift ) ; chipsel = chip ; } else { chip = 0 ; chipsel = - 1 ; } td -> version [ chip ] ++ ; if ( md ) { md -> version [ chip ] ++ ; } if ( td -> options & NAND_BBT_WRITE ) { res = write_bbt ( mtd , buf , td , md , chipsel ) ; if ( res < 0 ) { out } } if ( md && ( md -> options & NAND_BBT_WRITE ) ) { res = write_bbt ( mtd , buf , md , td , chipsel ) ; } out return res ; } static uint8_t scan_ff_pattern [ ] { 0xff 0xff } ; ; static uint8_t bbt_pattern [ ] { 'B' 'b' 't' '0' } ; ; static uint8_t mirror_pattern [ ] { '1' 't' 'b' 'B' } ; ; static struct nand_bbt_descr bbt_main_descr = { . options = NAND_BBT_LASTBLOCK | NAND_BBT_CREATE | NAND_BBT_WRITE | NAND_BBT_2BIT | NAND_BBT_VERSION | NAND_BBT_PERCHIP . offs = 8 . len = 4 . veroffs = 12 . maxblocks = NAND_BBT_SCAN_MAXBLOCKS . pattern = bbt_pattern } ; 