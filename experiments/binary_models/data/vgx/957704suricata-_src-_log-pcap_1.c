static PcapLogData * PcapLogDataCopy ( const PcapLogData * pl ) { BUG_ON ( pl -> mode != LOGMODE_MULTI ) ; PcapLogData * copy = SCCalloc ( 1 , sizeof ( * copy ) ) ; if ( unlikely ( copy == NULL ) ) { return in ; } copy -> h = SCCalloc ( 1 , sizeof ( * copy -> h ) ) ; if ( unlikely ( copy -> h == NULL ) ) { SCFree ( copy ) ; return NULL ; } copy -> prefix = SCStrdup ( pl -> prefix ) ; if ( unlikely ( copy -> prefix == NULL ) ) { SCFree ( copy -> h ) ; SCFree ( copy ) ; return NULL ; } copy -> suffix = pl -> suffix ; copy -> is_private = TRUE ; copy -> mode = pl -> mode ; copy -> max_files = pl -> max_files ; copy -> use_ringbuffer = pl -> use_ringbuffer ; copy -> timestamp_format = pl -> timestamp_format ; copy -> use_stream_depth = pl -> use_stream_depth ; copy -> size_limit = pl -> size_limit ; copy -> conditional = pl -> conditional ; const PcapLogCompressionData * comp = & pl -> compression ; PcapLogCompressionData * copy_comp = & copy -> compression ; copy_comp -> format = comp -> format ; if ( comp -> format == PCAP_LOG_COMPRESSION_FORMAT_LZ4 ) { copy_comp -> buffer_size = comp -> buffer_size ; copy_comp -> pcap_buf_size = comp -> pcap_buf_size ; copy_comp -> lz4f_prefs = comp -> lz4f_prefs ; copy_comp -> buffer = SCMalloc ( copy_comp -> buffer_size ) ; if ( copy_comp -> buffer == NULL ) { SCLogError ( "SCMalloc failed: %s" , strerror ( errno ) ) ; SCFree ( copy -> h ) ; SCFree ( copy ) ; return NULL ; } copy_comp -> pcap_buf = SCMalloc ( copy_comp -> pcap_buf_size ) ; if ( copy_comp -> pcap_buf == NULL ) { SCLogError ( "SCMalloc failed: %s" , strerror ( errno ) ) ; SCFree ( copy_comp -> buffer ) ; SCFree ( copy -> h ) ; SCFree ( copy ) ; return NULL ; } copy_comp -> pcap_buf_wrapper = SCFmemopen ( copy_comp -> pcap_buf , copy_comp -> pcap_buf_size , "w" ) ; if ( copy_comp -> pcap_buf_wrapper == NULL ) { SCLogError ( "SCFmemopen failed: %s" , strerror ( errno ) ) ; SCFree ( copy_comp -> buffer ) ; SCFree ( copy_comp -> pcap_buf ) ; SCFree ( copy -> h ) ; SCFree ( copy ) ; return NULL ; } LZ4F_errorCode_t errcode = LZ4F_createCompressionContext ( & copy_comp -> lz4f_context , 1 ) ; if ( LZ4F_isError ( errcode ) ) { SCLogError ( "LZ4F_createCompressionContext failed: %s" , LZ4F_getErrorName ( errcode ) ) ; fclose ( copy_comp -> pcap_buf_wrapper ) ; SCFree ( copy_comp -> buffer ) ; SCFree ( copy_comp -> pcap_buf ) ; SCFree ( copy -> h ) ; SCFree ( copy ) ; return NULL ; } copy_comp -> file = NULL ; copy_comp -> bytes_in_block = 0 ; } TAILQ_INIT ( & copy -> pcap_file_list ) ; SCMutexInit ( & copy -> plog_lock , NULL ) ; strlcpy ( copy -> dir , pl -> dir , sizeof ( copy -> dir ) ) ; int i ; for ( i = 0 ; i < pl -> filename_part_cnt && i < MAX_TOKS ; i ++ ) { copy -> filename_parts [ i ] = pl -> filename_parts [ i ] ; } copy -> filename_part_cnt = pl -> filename_part_cnt ; copy -> thread_number = SC_ATOMIC_ADD ( thread_cnt , 1 ) ; SCLogDebug ( "copied, returning %p" , copy ) ; return copy ; } 