struct fd * fd_accept ( int socket , const struct where * where , struct logger * logger ) { struct sockaddr_un addr ; socklen_t addrlen = sizeof ( addr ) ; int fd = accept ( socket , ( sockaddr * ) & addr , & addrlen ) ; if ( fd < 0 ) { llog_error ( logger , errno , "accept() failed in " PRI_WHERE "" , pri_where ( where ) ) ; return NULL ; } if ( fcntl ( fd , F_SETFD , FD_CLOEXEC ) < 0 ) { llog_error ( logger , errno , "failed to set CLOEXEC in " PRI_WHERE "" , pri_where ( where ) ) ; close ( fd , NULL ) ; return NULL ; } struct fd * fdt = refcnt_alloc ( fd , free_fd , where ) ; fdt -> fd = fd ; fdt -> magic = FD_MAGIC ; dbg ( "%s: new " PRI_FD " " PRI_WHERE "" , __func__ , pri_fd ( fdt ) , pri_where ( where ) ) ; return fdt ; } 