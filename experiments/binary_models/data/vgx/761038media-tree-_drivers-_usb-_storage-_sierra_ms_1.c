static DEVICE_ATTR ( truinst , S_IRUGO , show_truinst , NULL ) ; int sierra_ms_init ( struct us_data * us ) { int result , retries ; struct swoc_info * swocInfo ; struct usb_device * udev ; struct Scsi_Host * sh ; retries = 3 ; result = 0 ; udev = us -> pusb_dev ; sh = us_to_host ( us ) ; scsi_get_host_dev ( sh ) ; if ( swi_tru_install == TRU_FORCE_MODEM ) { usb_stor_dbg ( us , "SWIMS: Forcing Modem Mode\n" ) ; result = sierra_set_ms_mode ( udev , SWIMS_SET_MODE_Modem ) ; if ( result < 0 ) { usb_stor_dbg ( us , "SWIMS: Failed to switch to modem mode\n" ) ; } return - EIO ; } if ( swi_tru_install == TRU_FORCE_MS ) { usb_stor_dbg ( us , "SWIMS: Forcing Mass Storage Mode\n" ) ; complete } else { usb_stor_dbg ( us , "SWIMS: Normal SWoC Logic\n" ) ; swocInfo = kmalloc ( sizeof ( swoc_info ) , GFP_KERNEL ) ; if ( ! swocInfo ) { return - ENOMEM ; } retries = 3 ; { retries -- ; result = sierra_get_swoc_info ( udev , swocInfo ) ; if ( result < 0 ) { usb_stor_dbg ( us , "SWIMS: Failed SWoC query\n" ) ; schedule_timeout_uninterruptible ( 2 * HZ ) ; } } retries && result < 0 ; if ( result < 0 ) { usb_stor_dbg ( us , "SWIMS: Completely failed SWoC query\n" ) ; return - EIO ; } debug_swoc ( & us -> pusb_dev -> dev , swocInfo ) ; if ( ! containsFullLinuxPackage ( swocInfo ) ) { usb_stor_dbg ( us , "SWIMS: Switching to Modem Mode\n" ) ; result = sierra_set_ms_mode ( udev , SWIMS_SET_MODE_Modem ) ; if ( result < 0 ) { usb_stor_dbg ( us , "SWIMS: Failed to switch modem\n" ) ; } kfree ( swocInfo ) ; return - EIO ; } kfree ( swocInfo ) ; } complete result = device_create_file ( & us -> pusb_intf -> dev , & dev_attr_truinst ) ; return 0 ; } 