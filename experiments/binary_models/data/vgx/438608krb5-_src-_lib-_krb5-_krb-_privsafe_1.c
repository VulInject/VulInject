krb5_error_code k5_privsafe_check_addrs ( krb5_context context , krb5_auth_context ac , krb5_address * msg_s_addr , krb5_address * msg_r_addr ) { krb5_error_code ret = 0 ; krb5_address * * our_addrs = NULL ; const krb5_address * local_addr , * remote_addr ; krb5_address local_fulladdr , remote_fulladdr ; local_fulladdr . contents = remote_fulladdr . contents = NULL ; if ( ac -> remote_addr != NULL ) { if ( ac -> remote_port != NULL ) { ret = krb5_make_fulladdr ( context , ac -> remote_addr , ac -> remote_port , & remote_fulladdr ) ; if ( ret ) { cleanup } remote_addr = & remote_fulladdr ; } else { remote_addr = ac -> remote_addr ; } } else { remote_addr = NULL ; } if ( ac -> local_addr != NULL ) { if ( ac -> local_port != NULL ) { ret = krb5_make_fulladdr ( context , ac -> local_addr , ac -> local_port , & local_fulladdr ) ; if ( ret ) { cleanup } local_addr = & local_fulladdr ; } else { local_addr = ac -> local_addr ; } } else { local_addr = NULL ; } if ( remote_addr != NULL && ! krb5_address_compare ( context , remote_addr , msg_s_addr ) ) { ret = KRB5KRB_AP_ERR_BADADDR ; cleanup } if ( msg_r_addr == NULL ) { cleanup } if ( local_addr != NULL ) { if ( ! krb5_address_compare ( context , local_addr , msg_r_addr ) ) { ret = KRB5KRB_AP_ERR_BADADDR ; cleanup } } else { ret = krb5_os_localaddr ( context , & our_addrs ) ; if ( ret ) { cleanup } if ( ! krb5_address_search ( context , msg_r_addr , our_addrs ) ) { ret = KRB5KRB_AP_ERR_BADADDR ; cleanup } } cleanup free ( local_fulladdr . contents ) ; krb5_free_addresses ( context , our_addrs ) ; return ret ; } 