int radeon_fbdev_init ( struct radeon_device * rdev ) { struct radeon_fbdev * rfbdev ; int bpp_sel = 32 ; int ret ; if ( list_empty ( & rdev -> ddev -> mode_config . connector_list ) ) { return 0 ; } if ( rdev -> mc . real_vram_size <= ( 8 * 1024 * 1024 ) ) { bpp_sel = 8 ; } if ( ASIC_IS_RN50 ( rdev ) || rdev -> mc . real_vram_size <= ( 32 * 1024 * 1024 ) ) { bpp_sel = 16 ; } rfbdev = kzalloc ( sizeof ( radeon_fbdev ) , GFP_KERNEL ) ; if ( ! rfbdev ) { return - ENOMEM ; } rfbdev -> rdev = rdev ; rdev -> mode_info . rfbdev = rfbdev ; drm_fb_helper_prepare ( rdev -> ddev , & rfbdev -> helper , bpp_sel , & radeon_fb_helper_funcs ) ; ret = drm_fb_helper_init ( rdev -> ddev , & rfbdev -> helper ) ; if ( ret ) { free } drm_helper_disable_unused_functions ( rdev -> ddev ) ; ret = drm_fb_helper_initial_config ( & rfbdev -> helper ) ; if ( ret ) { fini } return 0 ; fini drm_fb_helper_fini ( & rfbdev -> helper ) ; free drm_fb_helper_unprepare ( & rfbdev -> helper ) ; return ret ; } 