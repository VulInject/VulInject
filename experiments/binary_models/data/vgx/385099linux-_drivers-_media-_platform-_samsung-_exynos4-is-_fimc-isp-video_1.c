static int isp_video_capture_buffer_prepare ( struct vb2_buffer * vb ) { struct fimc_isp * isp = vb2_get_drv_priv ( vb -> vb2_queue ) ; struct fimc_is_video * video = & isp -> video_capture ; int i ; for ( i = 0 ; i < video -> format -> memplanes ; i ++ ) { unsigned long size = video -> pixfmt . plane_fmt [ i ] . sizeimage ; if ( vb2_plane_size ( vb , i ) < size ) { v4l2_err ( & video -> ve . vdev , "User buffer too small (%ld<%ld)\n" , vb2_plane_size ( vb , i ) , size ) ; return - EINVAL ; } vb2_set_plane_payload ( vb , i , size ) ; } if ( test_bit ( ST_ISP_VID_CAP_BUF_PREP , & isp -> state ) ) { dma_addr_t dma_addr = vb2_dma_contig_plane_dma_addr ( vb , 0 ) ; int i ; for ( i = 0 ; i < video -> buf_count ; i ++ ) { if ( video -> buffers [ i ] -> dma_addr [ 0 ] == dma_addr ) { return 0 ; } } return - ENXIO ; } return 0 ; } 