string_short_rdwr_test ( , ) { SNDFILE * file ; SF_INFO sfinfo ; sf_count_t frames = BUFFER_LEN ; const char * str ; get_unique_test_name ( & filename , STR_TEST_PREFIX ) ; print_test_name ( __func__ , filename ) ; sfinfo . format = typemajor | SF_FORMAT_PCM_16 ; sfinfo . samplerate = 44100 ; sfinfo . channels = 1 ; sfinfo . frames = 0 ; file = test_open_file_or_die ( filename , SFM_WRITE , & sfinfo , SF_FALSE , __LINE__ ) ; test_write_short_or_die ( file , 0 , data_out , BUFFER_LEN , __LINE__ ) ; sf_set_string ( file , SF_STR_TITLE , long_title ) ; sf_set_string ( file , SF_STR_ARTIST , long_artist ) ; sf_close ( file ) ; file = test_open_file_or_die ( filename , SFM_RDWR , & sfinfo , SF_FALSE , __LINE__ ) ; exit_if_true ( frames != sfinfo . frames , "\n\nLine %d : Frame count %" PRId64 " should be %" PRId64 ".\n" , __LINE__ , sfinfo . frames , frames ) ; str = sf_get_string ( file , SF_STR_TITLE ) ; exit_if_true ( str == NULL , "\n\nLine %d : SF_STR_TITLE string is NULL.\n" , __LINE__ ) ; exit_if_true ( strcmp ( str , long_title ) != 0 , "\n\nLine %d : SF_STR_TITLE doesn't match what was written.\n" , __LINE__ ) ; str = sf_get_string ( file , SF_STR_ARTIST ) ; exit_if_true ( str == NULL , "\n\nLine %d : SF_STR_TITLE string is NULL.\n" , __LINE__ ) ; exit_if_true ( strcmp ( str , long_artist ) != 0 , "\n\nLine %d : SF_STR_ARTIST doesn't match what was written.\n" , __LINE__ ) ; sf_set_string ( file , SF_STR_TITLE , title ) ; sf_set_string ( file , SF_STR_ARTIST , artist ) ; sf_close ( file ) ; file = test_open_file_or_die ( filename , SFM_READ , & sfinfo , SF_FALSE , __LINE__ ) ; check_log_buffer_or_die ( file , __LINE__ ) ; str = sf_get_string ( file , SF_STR_TITLE ) ; exit_if_true ( str == NULL , "\n\nLine %d : SF_STR_TITLE string is NULL.\n" , __LINE__ ) ; exit_if_true ( strcmp ( str , title ) != 0 , "\n\nLine %d : SF_STR_TITLE doesn't match what was written.\n" , __LINE__ ) ; str = sf_get_string ( file , SF_STR_ARTIST ) ; exit_if_true ( str == NULL , "\n\nLine %d : SF_STR_ARTIST string is NULL.\n" , __LINE__ ) ; exit_if_true ( strcmp ( str , artist ) != 0 , "\n\nLine %d : SF_STR_ARTIST doesn't match what was written.\n" , __LINE__ ) ; sf_close ( file ) ; unlink ( filename ) ; puts ( "ok" ) ; } 