static int tcmu_vma_fault ( struct vm_fault * vmf ) { struct tcmu_dev * udev = vmf -> vma -> vm_private_data ; struct uio_info * info = & udev -> uio_info ; struct page * page ; unsigned long offset ; void * addr ; int mi = tcmu_find_mem_index ( vmf -> vma ) ; if ( mi < 0 ) { return VM_FAULT_SIGBUS ; } offset = ( vmf -> pgoff - mi ) << PAGE_SHIFT ; if ( offset < udev -> data_off ) { addr = ( void * ) ( unsigned long ) info -> mem [ mi ] . addr + offset ; page = vmalloc_to_page ( addr ) ; } else { uint32_t dbi ; dbi = ( offset - udev -> data_off ) / DATA_BLOCK_SIZE ; page = tcmu_try_get_block_page ( udev , dbi ) ; } get_page ( page ) ; vmf -> page = page ; return 0 ; } 