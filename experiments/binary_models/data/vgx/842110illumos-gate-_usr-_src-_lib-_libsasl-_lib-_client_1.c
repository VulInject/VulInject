int _sasl_client_listmech ( sasl_conn_t * conn , const char * prefix , const char * sep , const char * suffix , const char * * result , unsigned * plen , int * pcount ) { cmechanism_t * m = NULL ; sasl_ssf_t minssf = 0 ; int ret ; int resultlen ; int flag ; const char * mysep ; _sasl_global_context_t * gctx = conn == NULL ?_sasl_gbl_ctx ( ) : conn -> gctx ; cmech_list_t * cmechlist ; if ( gctx -> sasl_client_active == 0 ) { return SASL_NOTINIT ; } cmechlist = gctx -> cmechlist ; if ( _sasl_client_active == 0 ) { return SASL_NOTINIT ; } if ( ! conn ) { return SASL_BADPARAM ; } if ( conn -> type != SASL_CONN_CLIENT ) { PARAMERROR ( conn ) ; } if ( ! result ) { PARAMERROR ( conn ) ; } ( void ) _load_client_plugins ( gctx ) ; if ( plen != NULL ) { * plen = 0 ; } if ( pcount != NULL ) { * pcount = 0 ; } if ( sep ) { mysep = sep ; } else { mysep = " " ; } if ( conn -> props . min_ssf < conn -> external . ssf ) { minssf = 0 ; } else { minssf = conn -> props . min_ssf - conn -> external . ssf ; } if ( ! cmechlist || cmechlist -> mech_length <= 0 ) { INTERROR ( conn , SASL_NOMECH ) ; } resultlen = ( prefix ?strlen ( prefix ) : 0 ) + ( strlen ( mysep ) * ( cmechlist -> mech_length - 1 ) ) + mech_names_len ( gctx ) + mech_names_len ( ) + ( suffix ?strlen ( suffix ) : 0 ) + 1 ; ret = _buf_alloc ( & conn -> mechlist_buf , & conn -> mechlist_buf_len , resultlen ) ; if ( ret != SASL_OK ) { MEMERROR ( conn ) ; } if ( prefix ) { strcpy ( conn -> mechlist_buf , prefix ) ; } else { * ( conn -> mechlist_buf ) = '\0' ; } flag = 0 ; for ( m = cmechlist -> mech_list ; m != NULL ; m = m -> next ) { if ( ! have_prompts ( conn , m -> plug ) ) { continue ; } if ( minssf > m -> plug -> max_ssf ) { continue ; } if ( minssf > 0 && ! m -> sun_reg ) { continue ; } if ( ( ( conn -> props . security_flags ^ m -> plug -> security_flags ) & conn -> props . security_flags ) != 0 ) { continue ; } if ( ( m -> plug -> features & SASL_FEAT_NEEDSERVERFQDN ) && ! conn -> serverFQDN ) { continue ; } if ( ( conn -> flags & SASL_NEED_PROXY ) && ! ( m -> plug -> features & SASL_FEAT_ALLOWS_PROXY ) ) { break ; } if ( pcount != NULL ) { ( * pcount ) ++ ; } if ( flag ) { strcat ( conn -> mechlist_buf , mysep ) ; } else { flag = 1 ; } strcat ( conn -> mechlist_buf , m -> plug -> mech_name ) ; } if ( suffix ) { strcat ( conn -> mechlist_buf , suffix ) ; } if ( plen != NULL ) { * plen = strlen ( conn -> mechlist_buf ) ; } * result = conn -> mechlist_buf ; return SASL_OK ; } 