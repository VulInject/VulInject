static int detect_share ( int wp_cnt , int bp_cnt ) { struct perf_event_attr attr ; int i , * fd = NULL , ret = - 1 ; fd = malloc ( sizeof ( int ) * ( wp_cnt + bp_cnt ) ) ; if ( ! fd ) { return - 1 ; } for ( i = 0 ; i < wp_cnt ; i ++ ) { fd [ i ] = wp_event ( ( void * ) & the_var , & attr ) ; if ( fd [ i ] == - 1 ) { pr_err ( "failed to create wp\n" ) ; out } } for ( ; i < ( bp_cnt + wp_cnt ) ; i ++ ) { fd [ i ] = bp_event ( ( void * ) test_function , & attr ) ; if ( fd [ i ] == - 1 ) { break ; } } ret = i != ( bp_cnt + wp_cnt ) ; out while ( i -- ) { close ( fd [ i ] ) ; } free ( fd ) ; return ret ; } 