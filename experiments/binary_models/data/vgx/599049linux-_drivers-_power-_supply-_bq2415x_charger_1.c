static void bq2415x_timer_work ( struct work_struct * work ) { struct bq2415x_device * bq = container_of ( work , bq2415x_device , work . work ) ; int ret ; int error ; int boost ; if ( bq -> automode > 0 && ( bq -> reported_mode != bq -> mode ) ) { sysfs_notify ( & bq -> charger -> dev . kobj , NULL , "reported_mode" ) ; bq2415x_set_mode ( bq , bq -> reported_mode ) ; } if ( ! bq -> autotimer ) { return ; } ret = bq2415x_exec_command ( bq , BQ2415X_TIMER_RESET ) ; if ( ret < 0 ) { bq2415x_timer_error ( bq , "Resetting timer failed" ) ; return ; } boost = bq2415x_exec_command ( bq , BQ2415X_BOOST_MODE_STATUS ) ; if ( boost < 0 ) { bq2415x_timer_error ( bq , "Unknown error" ) ; return ; } error = bq2415x_exec_command ( bq , BQ2415X_FAULT_STATUS ) ; if ( error < 0 ) { bq2415x_timer_error ( bq , "Unknown error" ) ; return ; } if ( boost ) { switch ( error ) { case 0 : break ; case 6 : dev_err ( bq -> dev , "Timer expired\n" ) ; break ; case 3 : dev_err ( bq -> dev , "Battery voltage to low\n" ) ; break ; case 1 : bq2415x_timer_error ( bq , "Overvoltage protection (chip fried)" ) ; return ; case 2 : bq2415x_timer_error ( bq , "Overload" ) ; return ; case 4 : bq2415x_timer_error ( bq , "Battery overvoltage protection" ) ; return ; case 5 : bq2415x_timer_error ( bq , "Thermal shutdown (too hot)" ) ; return ; case 7 : bq2415x_timer_error ( bq , "Unknown error" ) ; return ; } } else { switch ( error ) { case 0 : break ; case 2 : dev_err ( bq -> dev , "Sleep mode\n" ) ; break ; case 3 : dev_err ( bq -> dev , "Poor input source\n" ) ; break ; case 6 : dev_err ( bq -> dev , "Timer expired\n" ) ; break ; case 7 : dev_err ( bq -> dev , "No battery\n" ) ; break ; case 1 : bq2415x_timer_error ( bq , "Overvoltage protection (chip fried)" ) ; return ; case 4 : bq2415x_timer_error ( bq , "Battery overvoltage protection" ) ; return ; case 5 : bq2415x_timer_error ( bq , "Thermal shutdown (too hot)" ) ; return ; } } schedule_delayed_work ( & bq -> work , BQ2415X_TIMER_TIMEOUT * HZ ) ; } 