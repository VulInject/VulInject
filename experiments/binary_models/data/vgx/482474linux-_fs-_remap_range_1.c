int __generic_remap_file_range_prep ( struct file * file_in , loff_t pos_in , struct file * file_out , loff_t pos_out , loff_t * len , unsigned int remap_flags , const struct iomap_ops * dax_read_ops ) { struct inode * inode_in = file_inode ( file_in ) ; struct inode * inode_out = file_inode ( file_out ) ; bool same_inode = ( inode_in == inode_out ) ; int ret ; if ( IS_IMMUTABLE ( inode_out ) ) { return - EPERM ; } if ( IS_SWAPFILE ( inode_in ) || IS_SWAPFILE ( inode_out ) ) { return - ETXTBSY ; } if ( S_ISDIR ( inode_in -> i_mode ) || S_ISDIR ( inode_out -> i_mode ) ) { return - EISDIR ; } if ( ! S_ISREG ( inode_in -> i_mode ) || ! S_ISREG ( inode_out -> i_mode ) ) { return - EINVAL ; } if ( * len == 0 ) { loff_t isize = i_size_read ( inode_in ) ; if ( ( remap_flags & REMAP_FILE_DEDUP ) || pos_in == isize ) { return 0 ; } * len = isize - pos_in ; if ( * len == 0 ) { return 0 ; } } ret = generic_remap_checks ( file_in , pos_in , file_out , pos_out , len , remap_flags ) ; if ( ret || * len == 0 ) { return ret ; } inode_dio_wait ( inode_in ) ; if ( ! same_inode ) { inode_dio_wait ( inode_out ) ; } ret = filemap_write_and_wait_range ( inode_in -> i_mapping , pos_in , pos_in + * len - 1 ) ; if ( ret ) { return ret ; } ret = filemap_write_and_wait_range ( inode_out -> i_mapping , pos_out , pos_out + * len - 1 ) ; if ( ret ) { return ret ; } if ( remap_flags & REMAP_FILE_DEDUP ) { bool is_same = false ; if ( ! IS_DAX ( inode_in ) ) { ret = vfs_dedupe_file_range_compare ( file_in , pos_in , file_out , pos_out , * len , & is_same ) ; } if ( dax_read_ops ) { ret = dax_dedupe_file_range_compare ( inode_in , pos_in , inode_out , pos_out , * len , & is_same , dax_read_ops ) ; } else { return - EINVAL ; } if ( ret ) { return ret ; } if ( ! is_same ) { return - EBADE ; } } ret = generic_remap_check_len ( inode_in , inode_out , pos_out , len , remap_flags ) ; if ( ret || * len == 0 ) { return ret ; } if ( ! ( remap_flags & REMAP_FILE_DEDUP ) ) { ret = file_modified ( file_out ) ; } return ret ; } 