static int rndis_set_rss_param_msg ( struct rndis_device * rdev , const u8 * rss_key , u16 flag ) { struct net_device * ndev = rdev -> ndev ; struct net_device_context * ndc = netdev_priv ( ndev ) ; struct rndis_request * request ; struct rndis_set_request * set ; struct rndis_set_complete * set_complete ; u32 extlen = sizeof ( ndis_recv_scale_param ) + 4 * ITAB_NUM + NETVSC_HASH_KEYLEN ; struct ndis_recv_scale_param * rssp ; u32 * itab ; u8 * keyp ; int i , ret ; request = get_rndis_request ( rdev , RNDIS_MSG_SET , RNDIS_MESSAGE_SIZE ( rndis_set_request ) + extlen ) ; set = & request -> request_msg . msg . set_req ; set -> oid = OID_GEN_RECEIVE_SCALE_PARAMETERS ; set -> info_buflen = extlen ; set -> info_buf_offset = sizeof ( rndis_set_request ) ; set -> dev_vc_handle = 0 ; rssp = ( ndis_recv_scale_param * ) ( set + 1 ) ; rssp -> hdr . type = NDIS_OBJECT_TYPE_RSS_PARAMETERS ; rssp -> hdr . rev = NDIS_RECEIVE_SCALE_PARAMETERS_REVISION_2 ; rssp -> hdr . size = sizeof ( ndis_recv_scale_param ) ; rssp -> flag = flag ; rssp -> hashinfo = NDIS_HASH_FUNC_TOEPLITZ | NDIS_HASH_IPV4 | NDIS_HASH_TCP_IPV4 | NDIS_HASH_IPV6 | NDIS_HASH_TCP_IPV6 ; rssp -> indirect_tabsize = 4 * ITAB_NUM ; rssp -> indirect_taboffset = sizeof ( ndis_recv_scale_param ) ; rssp -> hashkey_size = NETVSC_HASH_KEYLEN ; rssp -> hashkey_offset = rssp -> indirect_taboffset + rssp -> indirect_tabsize ; itab = ( u32 * ) ( rssp + 1 ) ; for ( i = 0 ; i < ITAB_NUM ; i ++ ) { itab [ i ] = ndc -> rx_table [ i ] ; } keyp = ( u8 * ) ( ( unsigned long ) rssp + rssp -> hashkey_offset ) ; memcpy ( keyp , rss_key , NETVSC_HASH_KEYLEN ) ; ret = rndis_filter_send_request ( rdev , request ) ; if ( ret != 0 ) { cleanup } wait_for_completion ( & request -> wait_event ) ; set_complete = & request -> response_msg . msg . set_complete ; if ( set_complete -> status == RNDIS_STATUS_SUCCESS ) { if ( ! ( flag & NDIS_RSS_PARAM_FLAG_DISABLE_RSS ) && ! ( flag & NDIS_RSS_PARAM_FLAG_HASH_KEY_UNCHANGED ) ) { memcpy ( rdev -> rss_key , rss_key , NETVSC_HASH_KEYLEN ) ; } } else { netdev_err ( ndev , "Fail to set RSS parameters:0x%x\n" , set_complete -> status ) ; ret = - EINVAL ; } cleanup put_rndis_request ( rdev , request ) ; return ret ; } 