static int str_packsize ( lua_State * L ) { Header h ; const char * fmt = luaL_checkstring ( L , 1 ) ; int totalsize = 0 ; initheader ( L , & h ) ; while ( * fmt != '\0' ) { int size , ntoalign ; KOption opt = getdetails ( & h , totalsize , & fmt , & size , & ntoalign ) ; size += ntoalign ; luaL_argcheck ( L , totalsize <= MAXSIZE - size , 1 , "format result too large" ) ; totalsize += size ; switch ( opt ) { case Kstring : case Kzstr : luaL_argerror ( L , 1 , "variable-length format" ) ; /* FALLTHROUGH */ default : break ; } } lua_pushinteger ( L , ( lua_Integer ) totalsize ) ; return 1 ; } 