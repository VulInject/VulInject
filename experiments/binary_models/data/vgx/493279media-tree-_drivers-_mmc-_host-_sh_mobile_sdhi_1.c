static int sh_mobile_sdhi_select_tuning ( struct tmio_mmc_host * host ) { struct sh_mobile_sdhi * priv = host_to_priv ( host ) ; unsigned long tap_cnt ; cfs_time_t tap_set ; unsigned long tap_start ; unsigned long tap_end ; unsigned long ntap ; unsigned long i ; sd_scc_write32 ( host , priv , SH_MOBILE_SDHI_SCC_RVSREQ , 0 ) ; tap_cnt = 0 ; ntap = 0 ; tap_start = 0 ; tap_end = 0 ; for ( i = 0 ; i < host -> tap_num * 2 ; i ++ ) { if ( test_bit ( i , host -> taps ) ) { ntap ++ ; } else { if ( ntap > tap_cnt ) { tap_start = i - ntap ; tap_end = i - 1 ; tap_cnt = ntap ; } ntap = 0 ; } } if ( ntap > tap_cnt ) { tap_start = i - ntap ; tap_end = i - 1 ; tap_cnt = ntap ; } if ( tap_cnt >= SH_MOBILE_SDHI_MAX_TAP ) { tap_set = ( tap_start + tap_end ) / 2 % host -> tap_num ; } else { return - EIO ; } sd_scc_write32 ( host , priv , SH_MOBILE_SDHI_SCC_TAPSET , tap_set ) ; sd_scc_write32 ( host , priv , SH_MOBILE_SDHI_SCC_RVSCNTL , SH_MOBILE_SDHI_SCC_RVSCNTL_RVSEN | sd_scc_read32 ( host , priv , SH_MOBILE_SDHI_SCC_RVSCNTL ) ) ; return 0 ; } 