static int create_workqueues ( struct hfi1_devdata * dd ) { int pidx ; struct hfi1_pportdata * ppd ; for ( pidx = 0 ; pidx < dd -> num_pports ; ++ pidx ) { ppd = dd -> pport + pidx ; if ( ! ppd -> hfi1_wq ) { ppd -> hfi1_wq = alloc_workqueue ( "hfi%d_%d" , WQ_SYSFS | WQ_HIGHPRI | WQ_CPU_INTENSIVE , HFI1_MAX_ACTIVE_WORKQUEUE_ENTRIES , dd -> unit , pidx ) ; if ( ! ppd -> hfi1_wq ) { wq_error } } } return 0 ; wq_error pr_err ( "alloc_workqueue failed for port %d\n" , pidx + 1 ) ; for ( pidx = 0 ; pidx < dd -> num_pports ; ++ pidx ) { ppd = dd -> pport + pidx ; if ( ppd -> hfi1_wq ) { destroy_workqueue ( ppd -> hfi1_wq ) ; } } return - ENOMEM ; } 