static int signal_handler ( sd_event_source * s , const struct signalfd_siginfo * si , void * userdata ) { sd_event_source * p = NULL ; pid_t pid ; siginfo_t plain_si ; assert_se ( s ) ; assert_se ( si ) ; log_info ( "got signal on %c" , PTR_TO_INT ( userdata ) ) ; assert_se ( userdata == INT_TO_PTR ( 'e' ) ) ; assert_se ( sigprocmask_many ( SIG_BLOCK , NULL , SIGCHLD , SIGUSR2 , - 1 ) >= 0 ) ; pid = fork ( ) ; assert_se ( pid >= 0 ) ; if ( pid == 0 ) { sigset_t ss ; assert_se ( sigemptyset ( & ss ) >= 0 ) ; assert_se ( sigaddset ( & ss , SIGUSR2 ) >= 0 ) ; zero ( plain_si ) ; assert_se ( sigwaitinfo ( & ss , & plain_si ) >= 0 ) ; assert_se ( plain_si . si_signo == SIGUSR2 ) ; assert_se ( plain_si . si_value . sival_int == 4711 ) ; _exit ( 78 ) ; } assert_se ( sd_event_add_child ( sd_event_source_get_event ( s ) , & p , pid , WEXITED , child_handler , INT_TO_PTR ( 'f' ) ) >= 0 ) ; assert_se ( sd_event_source_set_enabled ( p , SD_EVENT_ONESHOT ) >= 0 ) ; assert_se ( sd_event_source_set_child_process_own ( p , true ) >= 0 ) ; zero ( plain_si ) ; plain_si . si_signo = SIGUSR2 ; plain_si . si_code = SI_QUEUE ; plain_si . si_pid = getpid ( ) ; plain_si . si_uid = getuid ( ) ; plain_si . si_value . sival_int = 4711 ; assert_se ( sd_event_source_send_child_signal ( p , SIGUSR2 , & plain_si , 0 ) >= 0 ) ; return 1 ; } 