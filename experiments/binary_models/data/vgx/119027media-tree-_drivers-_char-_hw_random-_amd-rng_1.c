static int amd_rng_read ( struct hwrng * rng , void * buf , size_t max , bool wait ) { u32 * data = buf ; struct amd768_priv * priv = ( amd768_priv * ) rng -> priv ; int read = 0 ; int timeout = max / 4 + 1 ; while ( read < max ) { if ( ioread32 ( priv -> iobase + RNGDONE ) == 0 ) { if ( wait ) { usleep_range ( 128 , 196 ) ; if ( timeout -- == 0 ) { return read ; } } else { return 0 ; } } else { * data = ioread32 ( priv -> iobase + RNGDATA ) ; data ++ ; read += 4 ; } } return read ; } 