static int adf_probe ( struct pci_dev * pdev , const struct pci_device_id * ent ) { struct adf_accel_dev * accel_dev ; struct adf_accel_pci * accel_pci_dev ; struct adf_hw_device_data * hw_data ; char name [ ADF_DEVICE_NAME_LENGTH ] ; unsigned int i , bar_nr ; unsigned long bar_mask ; int ret ; switch ( ent -> device ) { case PCI_DEVICE_ID_INTEL_QAT_C62X : break ; default : dev_err ( & pdev -> dev , "Invalid device 0x%x.\n" , ent -> device ) ; return - ENODEV ; } if ( num_possible_nodes ( ) > 1 && dev_to_node ( & pdev -> dev ) < 0 ) { dev_err ( & pdev -> dev , "Invalid NUMA configuration.\n" ) ; return - EINVAL ; } accel_dev = kzalloc_node ( sizeof ( * accel_dev ) , GFP_KERNEL , dev_to_node ( & pdev -> dev ) ) ; if ( ! accel_dev ) { return - ENOMEM ; } INIT_LIST_HEAD ( & accel_dev -> crypto_list ) ; accel_pci_dev = & accel_dev -> accel_pci_dev ; accel_pci_dev -> pci_dev = pdev ; if ( adf_devmgr_add_dev ( accel_dev , NULL ) ) { dev_err ( & pdev -> dev , "Failed to add new accelerator device.\n" ) ; return - EFAULT ; } accel_dev -> owner = THIS_MODULE ; hw_data = kzalloc_node ( sizeof ( * hw_data ) , GFP_KERNEL , dev_to_node ( & pdev -> dev ) ) ; if ( ! hw_data ) { ret = - ENOMEM ; out_err } accel_dev -> hw_device = hw_data ; adf_init_hw_data_c62x ( accel_dev -> hw_device ) ; pci_read_config_byte ( pdev , PCI_REVISION_ID , & accel_pci_dev -> revid ) ; pci_read_config_dword ( pdev , ADF_DEVICE_FUSECTL_OFFSET , & hw_data -> fuses ) ; pci_read_config_dword ( pdev , ADF_C62X_SOFTSTRAP_CSR_OFFSET , & hw_data -> straps ) ; hw_data -> accel_mask = hw_data -> get_accel_mask ( hw_data ) ; hw_data -> ae_mask = hw_data -> get_ae_mask ( hw_data ) ; accel_pci_dev -> sku = hw_data -> get_sku ( hw_data ) ; if ( ! hw_data -> accel_mask || ! hw_data -> ae_mask || ( ( ~ hw_data -> ae_mask ) & 0x01 ) ) { dev_err ( & pdev -> dev , "No acceleration units found" ) ; ret = - EFAULT ; out_err } snprintf ( name , sizeof ( name ) , "%s%s_%s" , ADF_DEVICE_NAME_PREFIX , hw_data -> dev_class -> name , pci_name ( pdev ) ) ; accel_dev -> debugfs_dir = debugfs_create_dir ( name , NULL ) ; ret = adf_cfg_dev_add ( accel_dev ) ; if ( ret ) { out_err } if ( pci_enable_device ( pdev ) ) { ret = - EFAULT ; out_err } ret = dma_set_mask_and_coherent ( & pdev -> dev , DMA_BIT_MASK ( 48 ) ) ; if ( ret ) { dev_err ( & pdev -> dev , "No usable DMA configuration\n" ) ; out_err_disable } if ( pci_request_regions ( pdev , ADF_C62X_DEVICE_NAME ) ) { ret = - EFAULT ; out_err_disable } hw_data -> accel_capabilities_mask = hw_data -> get_accel_cap ( accel_dev ) ; i = ( hw_data -> fuses & ADF_DEVICE_FUSECTL_MASK ) ?1 : 0 ; bar_mask = pci_select_bars ( pdev , IORESOURCE_MEM ) ; for_each_set_bit ( , , 2 ) { struct adf_bar * bar = & accel_pci_dev -> pci_bars [ i ++ ] ; bar -> base_addr = pci_resource_start ( pdev , bar_nr ) ; if ( ! bar -> base_addr ) { break ; } bar -> size = pci_resource_len ( pdev , bar_nr ) ; bar -> virt_addr = pci_iomap ( accel_pci_dev -> pci_dev , bar_nr , 0 ) ; if ( ! bar -> virt_addr ) { dev_err ( & pdev -> dev , "Failed to map BAR %d\n" , bar_nr ) ; ret = - EFAULT ; out_err_free_reg } } pci_set_master ( pdev ) ; adf_enable_aer ( accel_dev ) ; if ( pci_save_state ( pdev ) ) { dev_err ( & pdev -> dev , "Failed to save pci state\n" ) ; ret = - ENOMEM ; out_err_disable_aer } ret = hw_data -> dev_config ( accel_dev ) ; if ( ret ) { out_err_disable_aer } ret = adf_dev_init ( accel_dev ) ; if ( ret ) { out_err_dev_shutdown } ret = adf_dev_start ( accel_dev ) ; if ( ret ) { out_err_dev_stop } return ret ; out_err_dev_stop adf_dev_stop ( accel_dev ) ; out_err_dev_shutdown adf_dev_shutdown ( accel_dev ) ; out_err_disable_aer adf_disable_aer ( accel_dev ) ; out_err_free_reg pci_release_regions ( accel_pci_dev -> pci_dev ) ; out_err_disable pci_disable_device ( accel_pci_dev -> pci_dev ) ; out_err adf_cleanup_accel ( accel_dev ) ; kfree ( accel_dev ) ; return ret ; } 