apr_status_t cache_strqtok ( char * str , char * * token , char * * arg , char * * last ) { apr_status_t rv = APR_SUCCESS ; { IN_TOKEN , IN_BETWEEN , IN_ARGUMENT , IN_QUOTES } , state = IN_TOKEN char * wpos ; if ( ! str ) { str = * last ; } while ( * str && TEST_CHAR ( * str , T_HTTP_TOKEN_STOP ) ) { if ( ! ap_strchr_c ( CACHE_TOKEN_SEPS , * str ) ) { return APR_EINVAL ; } ++ str ; } if ( ! * str ) { return APR_EOF ; } * token = str ; if ( arg ) { * arg = NULL ; } for ( wpos = str ; * str ; ++ str ) { switch ( state ) { case IN_TOKEN : if ( * str == '=' ) { state = IN_BETWEEN ; * wpos ++ = '\0' ; if ( arg ) { * arg = wpos ; } continue ; } break ; case IN_BETWEEN : if ( * str == '"' ) { state = IN_QUOTES ; continue ; } state = IN_ARGUMENT ; case IN_ARGUMENT : if ( TEST_CHAR ( * str , T_HTTP_TOKEN_STOP ) ) { end } break ; default : AP_DEBUG_ASSERT ( state == IN_QUOTES ) ; if ( * str == '"' ) { ++ str ; end } if ( * str == '\\' && * ( str + 1 ) ) { ++ str ; } break ; } * wpos ++ = * str ; } end for ( ; * str ; ++ str ) { if ( * str == ',' ) { ++ str ; break ; } if ( * str != '\t' && * str != ' ' ) { rv = APR_EINVAL ; break ; } } * wpos = '\0' ; * last = str ; return rv ; } 