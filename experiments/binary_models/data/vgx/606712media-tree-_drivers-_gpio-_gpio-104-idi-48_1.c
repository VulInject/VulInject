static int idi_48_probe ( struct device * dev , unsigned int id ) { struct idi_48_gpio * idi48gpio ; const char * const name = dev_name ( dev ) ; int err ; idi48gpio = devm_kzalloc ( dev , sizeof ( * idi48gpio ) , GFP_KERNEL ) ; if ( ! devm_request_region ( dev , base [ id ] , IDI_48_EXTENT , name ) ) { dev_err ( dev , "Unable to lock port addresses (0x%X-0x%X)\n" , base [ id ] , base [ id ] + IDI_48_EXTENT ) ; return - EBUSY ; } idi48gpio -> chip . label = name ; idi48gpio -> chip . parent = dev ; idi48gpio -> chip . owner = THIS_MODULE ; idi48gpio -> chip . base = - 1 ; idi48gpio -> chip . ngpio = IDI48_NGPIO ; idi48gpio -> chip . names = idi48_names ; idi48gpio -> chip . get_direction = idi_48_gpio_get_direction ; idi48gpio -> chip . direction_input = idi_48_gpio_direction_input ; idi48gpio -> chip . get = idi_48_gpio_get ; idi48gpio -> base = base [ id ] ; raw_spin_lock_init ( & idi48gpio -> lock ) ; spin_lock_init ( & idi48gpio -> ack_lock ) ; err = devm_gpiochip_add_data ( dev , & idi48gpio -> chip , idi48gpio ) ; if ( err ) { dev_err ( dev , "GPIO registering failed (%d)\n" , err ) ; return err ; } outb ( 0 , base [ id ] + 7 ) ; inb ( base [ id ] + 7 ) ; err = gpiochip_irqchip_add ( & idi48gpio -> chip , & idi_48_irqchip , 0 , handle_edge_irq , IRQ_TYPE_NONE ) ; if ( err ) { dev_err ( dev , "Could not add irqchip (%d)\n" , err ) ; return err ; } err = devm_request_irq ( dev , irq [ id ] , idi_48_irq_handler , IRQF_SHARED , name , idi48gpio ) ; if ( err ) { dev_err ( dev , "IRQ handler registering failed (%d)\n" , err ) ; return err ; } return 0 ; } 