int BPF_PROG ( socket_bind , struct socket * sock , struct sockaddr * address , int addrlen ) { __u32 pid = bpf_get_current_pid_tgid ( ) >> 32 ; struct local_storage * storage ; int err ; storage = bpf_sk_storage_get ( & sk_storage_map , sock -> sk , 0 , BPF_LOCAL_STORAGE_GET_F_CREATE ) ; if ( ! storage ) { return 0 ; } if ( storage -> value != DUMMY_STORAGE_VALUE ) { sk_storage_result = - 1 ; } storage = bpf_sk_storage_get ( & sk_storage_map2 , sock -> sk , 0 , BPF_LOCAL_STORAGE_GET_F_CREATE ) ; if ( ! storage ) { return 0 ; } err = bpf_sk_storage_delete ( & sk_storage_map , sock -> sk ) ; if ( err ) { return 0 ; } err = bpf_sk_storage_delete ( & sk_storage_map2 , sock -> sk ) ; if ( ! err ) { sk_storage_result = err ; } return 0 ; } 