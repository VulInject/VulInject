int smb_get_bb_fmri ( smbios_hdl_t * shp , nvlist_t * fmri , uint_t parent , smbs_cnt_t * bbstypes ) { int rc = 0 ; int i , j , n , cnt ; int id , index ; nvlist_t * pairs [ MAX_PAIRS ] ; smbios_bboard_t bb ; uint16_t chassis_inst , mch_inst ; char name [ 40 ] ; char idstr [ 11 ] ; bbindex_t bb_idx ; uint16_t bbid ; int chcnt = 0 ; for ( n = 0 ; n < MAX_PAIRS ; n ++ ) { bb_idx . index [ n ] = 0 ; pairs [ n ] = NULL ; } bb_idx . count = 0 ; get_bboard_index ( bbstypes , parent , & bb_idx ) ; index = bb_idx . index [ 0 ] ; bbid = bbstypes -> ids [ index ] -> id ; rc = get_chassis_inst ( shp , & chassis_inst , bbid , & chcnt ) ; if ( ( bb_idx . count + chcnt ) > MAX_PAIRS ) { return ( - 1 ) ; } i = 0 ; if ( chcnt > 1 ) { pairs [ i ] = fm_nvlist_create ( NULL ) ; if ( pairs [ i ] == NULL ) { return ( - 1 ) ; } mch_inst = 0 ; ( void ) snprintf ( idstr , sizeof ( idstr ) , "%u" , mch_inst ) ; if ( ( nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_NAME , "chassis" ) != 0 ) || ( nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_ID , idstr ) ) != 0 ) { fm_nvlist_destroy ( pairs [ i ] , FM_NVA_FREE ) ; return ( - 1 ) ; } i ++ ; } pairs [ i ] = fm_nvlist_create ( NULL ) ; if ( pairs [ i ] == NULL ) { for ( n = 0 ; n < MAX_PAIRS ; n ++ ) { if ( pairs [ n ] != NULL ) { fm_nvlist_destroy ( pairs [ n ] , FM_NVA_FREE ) ; } } return ( - 1 ) ; } ( void ) snprintf ( idstr , sizeof ( idstr ) , "%u" , chassis_inst ) ; if ( ( nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_NAME , "chassis" ) != 0 ) || ( nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_ID , idstr ) != 0 ) ) { for ( n = 0 ; n < MAX_PAIRS ; n ++ ) { if ( pairs [ n ] != NULL ) { fm_nvlist_destroy ( pairs [ n ] , FM_NVA_FREE ) ; } } return ( - 1 ) ; } for ( j = 0 , i = chcnt , cnt = chcnt ; j < bb_idx . count ; j ++ ) { index = bb_idx . index [ j ] ; bbid = bbstypes -> ids [ index ] -> id ; rc = smbios_info_bboard ( shp , bbid , & bb ) ; if ( rc != 0 ) { rc = - 1 ; break ; } pairs [ i ] = fm_nvlist_create ( NULL ) ; if ( pairs [ i ] == NULL ) { rc = - 1 ; break ; } id = bbstypes -> ids [ index ] -> inst ; ( void ) snprintf ( idstr , sizeof ( idstr ) , "%u" , id ) ; ( void ) strncpy ( name , bbd_type [ bb . smbb_type ] . name , sizeof ( name ) ) ; cnt ++ ; if ( nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_NAME , name ) != 0 || nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_ID , idstr ) != 0 ) { rc = - 1 ; break ; } i ++ ; } if ( rc != - 1 ) { if ( nvlist_add_nvlist_array ( fmri , FM_FMRI_HC_LIST , pairs , cnt ) != 0 ) { rc = - 1 ; } } for ( n = 0 ; n < cnt ; n ++ ) { if ( pairs [ n ] != NULL ) { fm_nvlist_destroy ( pairs [ n ] , FM_NVA_FREE ) ; } } return ( rc ) ; } 