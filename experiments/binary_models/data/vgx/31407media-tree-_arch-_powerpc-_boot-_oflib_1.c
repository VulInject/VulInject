static int string_match ( const char * s1 , const char * s2 ) { for ( ; * s2 ; ++ s2 ) { if ( * s1 ++ != * s2 ) { return 0 ; } } return 1 ; } static int need_map = - 1 ; static ihandle chosen_mmu ; static ihandle memory ; static int check_of_version ( void ) { phandle oprom , chosen ; char version [ 64 ] ; oprom = of_finddevice ( "/openprom" ) ; if ( of_getprop ( oprom , "model" , version , sizeof ( version ) ) <= 0 ) { return 0 ; } version [ sizeof ( version ) - 1 ] = 0 ; printf ( "OF version = '%s'\r\n" , version ) ; if ( ! string_match ( version , "Open Firmware, 1." ) && ! string_match ( version , "FirmWorks,3." ) ) { return 0 ; } chosen = of_finddevice ( "/chosen" ) ; if ( chosen == ( phandle ) - 1 ) { chosen = of_finddevice ( "/chosen@0" ) ; if ( chosen == ( phandle ) - 1 ) { printf ( "no chosen\n" ) ; return 0 ; } } if ( of_getprop ( chosen , "mmu" , & chosen_mmu , sizeof ( chosen_mmu ) ) <= 0 ) { printf ( "no mmu\n" ) ; return 0 ; } memory = of_call_prom ( "open" , 1 , 1 , "/memory" ) ; if ( memory == PROM_ERROR ) { memory = of_call_prom ( "open" , 1 , 1 , "/memory@0" ) ; if ( memory == PROM_ERROR ) { printf ( "no memory node\n" ) ; return 0 ; } } printf ( "old OF detected\r\n" ) ; return 1 ; } 