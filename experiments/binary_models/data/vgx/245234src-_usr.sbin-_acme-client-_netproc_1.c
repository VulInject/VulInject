static int doneworder ( struct conn * c , const char * const * alts , size_t altsz , struct order * order , const struct capaths * p ) { struct jsmnn * j = NULL ; int rc = 0 ; char * req ; int lc ; if ( ( req = json_fmt_neworder ( alts , altsz ) ) == NULL ) { warnx ( "json_fmt_neworder" ) ; } if ( ( lc = sreq ( c , p -> neworder , 1 , req , & order -> uri ) ) < 0 ) { warnx ( "%s: bad comm" , p -> neworder ) ; } if ( lc != 201 ) { warnx ( "%s: bad HTTP: %ld" , p -> neworder , lc ) ; } if ( ( j = json_parse ( c -> buf . buf , c -> buf . sz ) ) == NULL ) { warnx ( "%s: bad JSON object" , p -> neworder ) ; } if ( ! json_parse_order ( j , order ) ) { warnx ( "%s: bad order" , p -> neworder ) ; } if ( order -> status == ORDER_INVALID ) { warnx ( "%s: order invalid" , p -> neworder ) ; } else { rc = 1 ; } if ( rc == 0 || verbose > 1 ) { buf_dump ( & c -> buf ) ; } free ( req ) ; json_free ( j ) ; return rc ; } 