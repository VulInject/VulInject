test_counters_clients ( ) { mongoc_client_pool_t * client_pool ; mongoc_client_t * client ; mongoc_uri_t * uri ; uri = test_framework_get_uri ( ) ; mongoc_uri_set_option_as_int32 ( uri , MONGOC_URI_HEARTBEATFREQUENCYMS , 99999 ) ; mongoc_uri_set_option_as_int32 ( uri , MONGOC_URI_SOCKETCHECKINTERVALMS , 99999 ) ; reset_all_counters ( ) ; client = test_framework_client_new_from_uri ( uri , NULL ) ; BSON_ASSERT ( client , NULL ) ; DIFF_AND_RESET ( clients_active , == , 1 ) ; DIFF_AND_RESET ( clients_disposed , == , 0 ) ; DIFF_AND_RESET ( client_pools_active , == , 0 ) ; DIFF_AND_RESET ( client_pools_disposed , == , 0 ) ; mongoc_client_destroy ( client ) ; DIFF_AND_RESET ( clients_active , == , - 1 ) ; DIFF_AND_RESET ( clients_disposed , == , 1 ) ; DIFF_AND_RESET ( client_pools_active , == , 0 ) ; DIFF_AND_RESET ( client_pools_disposed , == , 0 ) ; client_pool = test_framework_client_pool_new_from_uri ( uri , NULL ) ; BSON_ASSERT ( client_pool ) ; DIFF_AND_RESET ( clients_active , == , 0 ) ; DIFF_AND_RESET ( clients_disposed , == , 0 ) ; DIFF_AND_RESET ( client_pools_active , == , 1 ) ; DIFF_AND_RESET ( client_pools_disposed , == , 0 ) ; client = mongoc_client_pool_pop ( client_pool ) ; DIFF_AND_RESET ( clients_active , == , 1 ) ; DIFF_AND_RESET ( clients_disposed , == , 0 ) ; DIFF_AND_RESET ( client_pools_active , == , 0 ) ; DIFF_AND_RESET ( client_pools_disposed , == , 0 ) ; mongoc_client_destroy ( client ) ; DIFF_AND_RESET ( clients_active , == , - 1 ) ; DIFF_AND_RESET ( clients_disposed , == , 1 ) ; DIFF_AND_RESET ( client_pools_active , == , 0 ) ; DIFF_AND_RESET ( client_pools_disposed , == , 0 ) ; mongoc_client_pool_destroy ( client_pool ) ; DIFF_AND_RESET ( clients_active , == , 0 ) ; DIFF_AND_RESET ( clients_disposed , == , 0 ) ; DIFF_AND_RESET ( client_pools_active , == , - 1 ) ; DIFF_AND_RESET ( client_pools_disposed , == , 1 ) ; mongoc_uri_destroy ( uri ) ; } 