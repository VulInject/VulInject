int update_route_data ( rpc_opt_t * opts ) { struct route_data_t * rd ; int i , j ; int domain_id ; str tmp_domain ; str tmp_prefix ; str tmp_host ; str tmp_rewrite_prefix ; str tmp_rewrite_suffix ; str tmp_comment = str_init ( "" ) ; if ( ( rd = shm_malloc ( sizeof ( route_data_t ) ) ) == NULL ) { SHM_MEM_ERROR ; return - 1 ; } if ( load_config ( rd ) < 0 ) { LM_ERR ( "could not load config" ) ; FIFO_ERR ( E_LOADCONF ) ; return - 1 ; } if ( rule_fixup ( rd ) < 0 ) { LM_ERR ( "could not fixup rules" ) ; FIFO_ERR ( E_RULEFIXUP ) ; return - 1 ; } updated = 0 ; if ( opts -> cmd == OPT_ADD ) { tmp_domain = opts -> domain ; tmp_prefix = opts -> prefix ; tmp_host = opts -> host ; tmp_rewrite_prefix = opts -> rewrite_prefix ; tmp_rewrite_suffix = opts -> rewrite_suffix ; if ( tmp_domain . s == NULL ) { tmp_domain . s = "" ; tmp_domain . len = 0 ; } if ( tmp_prefix . s == NULL ) { tmp_prefix . s = "" ; tmp_prefix . len = 0 ; } if ( tmp_host . s == NULL ) { tmp_host . s = "" ; tmp_host . len = 0 ; } if ( tmp_rewrite_prefix . s == NULL ) { tmp_rewrite_prefix . s = "" ; tmp_rewrite_prefix . len = 0 ; } if ( tmp_rewrite_suffix . s == NULL ) { tmp_rewrite_suffix . s = "" ; tmp_rewrite_suffix . len = 0 ; } domain_id = map_name2id ( rd -> domain_map , rd -> domain_num , & tmp_domain ) ; if ( domain_id < 0 ) { LM_ERR ( "cannot find id for domain '%.*s'" , tmp_domain . len , tmp_domain . s ) ; errout } if ( add_route ( rd , 1 , domain_id , & tmp_prefix , 0 , 0 , 0 , opts -> prob , & tmp_host , opts -> strip , & tmp_rewrite_prefix , & tmp_rewrite_suffix , opts -> status , opts -> hash_index , - 1 , NULL , & tmp_comment ) < 0 ) { errout } updated = 1 ; if ( rule_fixup ( rd ) < 0 ) { LM_ERR ( "could not fixup rules after route appending" ) ; FIFO_ERR ( E_RULEFIXUP ) ; errout } } else { for ( i = 0 ; i < rd -> carrier_num ; i ++ ) { if ( rd -> carriers [ i ] ) { for ( j = 0 ; j < rd -> carriers [ i ] -> domain_num ; j ++ ) { if ( rd -> carriers [ i ] -> domains [ j ] && rd -> carriers [ i ] -> domains [ j ] -> tree ) { if ( update_route_data_recursor ( rd -> carriers [ i ] -> domains [ j ] -> tree , rd -> carriers [ i ] -> domains [ j ] -> name , opts ) < 0 ) { errout } } } } } } if ( ! updated ) { LM_ERR ( "no match for update found" ) ; FIFO_ERR ( E_NOUPDATE ) ; errout } if ( save_config ( rd ) < 0 ) { LM_ERR ( "could not save config" ) ; FIFO_ERR ( E_SAVECONF ) ; errout } if ( reload_route_data ( ) == - 1 ) { LM_ERR ( "could not reload route data" ) ; FIFO_ERR ( E_LOADCONF ) ; errout } clear_route_data ( rd ) ; return 0 ; errout clear_route_data ( rd ) ; return - 1 ; } 