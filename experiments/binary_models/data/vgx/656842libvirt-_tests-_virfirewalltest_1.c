static int testFirewallIgnoreFailGroup ( const void * opaque G_GNUC_UNUSED ) { g_auto ( ) cmdbuf = VIR_BUFFER_INITIALIZER ; g_autoptr ( ) fw = virFirewallNew ( ) ; const char * actual = NULL ; const char * expected = IPTABLES " -w -A INPUT --source 192.168.122.1 --jump ACCEPT\n" IPTABLES " -w -A INPUT --source 192.168.122.255 --jump REJECT\n" IPTABLES " -w -A OUTPUT --source 192.168.122.1 --jump ACCEPT\n" IPTABLES " -w -A OUTPUT --jump DROP\n" ; g_autoptr ( ) dryRunToken = virCommandDryRunTokenNew ( ) ; virCommandSetDryRun ( dryRunToken , & cmdbuf , false , false , testFirewallRollbackHook ) ; virFirewallStartTransaction ( fw , VIR_FIREWALL_TRANSACTION_IGNORE_ERRORS ) ; virFirewallAddRule ( fw , VIR_FIREWALL_LAYER_IPV4 , "-A" , "INPUT" , "--source" , "192.168.122.1" , "--jump" , "ACCEPT" , NULL ) ; virFirewallAddRule ( fw , VIR_FIREWALL_LAYER_IPV4 , "-A" , "INPUT" , "--source" , "192.168.122.255" , "--jump" , "REJECT" , NULL ) ; virFirewallStartTransaction ( fw , 0 ) ; virFirewallAddRule ( fw , VIR_FIREWALL_LAYER_IPV4 , "-A" , "OUTPUT" , "--source" , "192.168.122.1" , "--jump" , "ACCEPT" , NULL ) ; virFirewallAddRule ( fw , VIR_FIREWALL_LAYER_IPV4 , "-A" , "OUTPUT" , "--jump" , "DROP" , NULL ) ; if ( virFirewallApply ( fw ) < 0 ) { return - 1 ; } actual = virBufferCurrentContent ( & cmdbuf ) ; if ( virTestCompareToString ( expected , actual ) < 0 ) { fprintf ( stderr , "Unexpected command execution\n" ) ; return - 1 ; } return 0 ; } 