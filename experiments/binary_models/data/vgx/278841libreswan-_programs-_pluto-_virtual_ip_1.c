diag_t create_virtual ( const char * leftright , const char * string , struct virtual_ip * * vip ) { passert ( string != NULL && string [ 0 ] != '\0' ) ; unsigned short flags = 0 ; const char * str = string ; if ( eat ( str , "vhost:" ) ) { flags |= F_VIRTUAL_HOST ; } if ( eat ( str , "vnet:" ) ) { } else { return diag ( "virtual %ssubnet=%s invalid, missing \"vhost:\" or \"vnet:\"" , leftright , string ) ; } int n_net = 0 ; const char * first_net = NULL ; while ( * str != '\0' ) { const char * next = strchr ( str , ',' ) ; if ( next == NULL ) { next = str + strlen ( str ) ; } ptrdiff_t len = next - str ; ip_subnet sub ; if ( eat ( str , "%no" ) ) { flags |= F_VIRTUAL_NO ; } if ( eat ( str , "%priv" ) ) { flags |= F_VIRTUAL_PRIVATE ; } if ( eat ( str , "%all" ) ) { flags |= F_VIRTUAL_ALL ; } else { err_t e = read_subnet ( shunk2 ( str , len ) , & sub , NULL ) ; if ( e != NULL ) { return diag ( "virtual %ssubnet=%s invalid, %s" , leftright , string , e ) ; } n_net ++ ; if ( first_net == NULL ) { first_net = str ; } str += len ; } if ( str != next ) { return diag ( "virtual %ssubnet=%s invalid, contains trailing garbage '%s'" , leftright , string , str ) ; } if ( * next == '\0' ) { break ; } str = next + 1 ; } struct virtual_ip * v = refcnt_overalloc ( virtual_ip , ( n_net * sizeof ( ip_subnet ) ) , virtual_ip_free , HERE ) ; v -> flags = flags ; v -> n_net = n_net ; if ( n_net > 0 ) { passert ( first_net != NULL ) ; unsigned i = 0 ; for ( const char * str = first_net ; str != NULL && * str != '\0' ; ) { const char * next = strchr ( str , ',' ) ; if ( next == NULL ) { next = str + strlen ( str ) ; } ip_subnet sub ; if ( read_subnet ( shunk2 ( str , next - str ) , & sub , NULL ) == NULL ) { passert ( i < n_net ) ; v -> net [ i ++ ] = sub ; } if ( * next == '\0' ) { break ; } str = next + 1 ; } passert ( i == n_net ) ; } * vip = v ; return NULL ; } 