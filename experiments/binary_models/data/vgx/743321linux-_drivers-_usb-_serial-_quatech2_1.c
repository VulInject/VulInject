static int qt2_open ( struct tty_struct * tty , struct usb_serial_port * port ) { struct usb_serial * serial ; struct qt2_port_private * port_priv ; u8 * data ; u16 device_port ; int status ; unsigned long flags ; device_port = port -> port_number ; serial = port -> serial ; port_priv = usb_get_serial_port_data ( port ) ; status = qt2_control_msg ( serial -> dev , QT2_GET_SET_QMCR , QT2_QMCR_RS232 , device_port ) ; if ( status < 0 ) { dev_err ( & port -> dev , "%s failed to set RS232 mode for port %i error %i\n" , __func__ , device_port , status ) ; return status ; } data = kzalloc ( 2 , GFP_KERNEL ) ; if ( ! data ) { return - ENOMEM ; } status = usb_control_msg ( serial -> dev , usb_rcvctrlpipe ( serial -> dev , 0 ) , QT_OPEN_CLOSE_CHANNEL , 0xc0 , 0 , device_port , data , 2 , QT2_USB_TIMEOUT ) ; if ( status < 2 ) { dev_err ( & port -> dev , "%s - open port failed %i\n" , __func__ , status ) ; if ( status >= 0 ) { status = - EIO ; } return status ; } spin_lock_irqsave ( & port_priv -> lock , flags ) ; port_priv -> shadowLSR = data [ 0 ] ; port_priv -> shadowMSR = data [ 1 ] ; spin_unlock_irqrestore ( & port_priv -> lock , flags ) ; kfree ( data ) ; status = qt2_set_port_config ( serial -> dev , device_port , DEFAULT_BAUD_RATE , UART_LCR_WLEN8 ) ; if ( status < 0 ) { dev_err ( & port -> dev , "%s - initial setup failed (%i)\n" , __func__ , device_port ) ; return status ; } port_priv -> device_port = ( u8 ) device_port ; if ( tty ) { qt2_set_termios ( tty , port , & tty -> termios ) ; } return 0 ; } 