int aac_send_shutdown ( struct aac_dev * dev ) { struct fib * fibctx ; struct aac_close * cmd ; int status = 0 ; if ( aac_adapter_check_health ( dev ) ) { return status ; } if ( ! dev -> adapter_shutdown ) { mutex_lock ( & dev -> ioctl_mutex ) ; dev -> adapter_shutdown = 1 ; mutex_unlock ( & dev -> ioctl_mutex ) ; } aac_wait_for_io_completion ( dev ) ; fibctx = aac_fib_alloc ( dev ) ; aac_fib_init ( fibctx ) ; cmd = ( aac_close * ) fib_data ( fibctx ) ; cmd -> command = cpu_to_le32 ( VM_CloseAll ) ; cmd -> cid = cpu_to_le32 ( 0xfffffffe ) ; status = aac_fib_send ( ContainerCommand , fibctx , sizeof ( aac_close ) , FsaNormal , - 2 , 1 , NULL , NULL ) ; if ( status >= 0 ) { aac_fib_complete ( fibctx ) ; } if ( status != - ERESTARTSYS ) { aac_fib_free ( fibctx ) ; } if ( aac_is_src ( dev ) && dev -> msi_enabled ) { aac_set_intx_mode ( dev ) ; } return status ; } 