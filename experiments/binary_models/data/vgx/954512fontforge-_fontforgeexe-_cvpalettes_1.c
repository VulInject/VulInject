static void LayersExpose ( CharView * cv , GWindow pixmap , GEvent * event ) { int i , ll , y ; const char * str ; GRect r ; struct _GImage base ; GImage gi ; int ww ; int yt = .7 * layer_height ; int column_width ; int quadcol , fgcol , editcol ; if ( event -> u . expose . rect . y + event -> u . expose . rect . height < layer_header_height ) { return ; } int offsetAtRightOfViewLayer = Layers_getOffsetAtRightOfViewLayer ( cv ) ; column_width = layerinfo . column_width ; GDrawSetDither ( NULL , false ) ; ww = layerinfo . sb_start ; memset ( & base , 0 , sizeof ( base ) ) ; gi . u . image = & base ; base . image_type = it_index ; base . clut = layer2 . clut ; base . trans = - 1 ; GDrawSetFont ( pixmap , layerinfo . font ) ; quadcol = fgcol = offsetAtRightOfViewLayer ; if ( layerscols & LSHOW_CUBIC ) { quadcol = offsetAtRightOfViewLayer ; fgcol = offsetAtRightOfViewLayer + column_width ; } if ( layerscols & LSHOW_FG ) { fgcol = quadcol + column_width ; } editcol = fgcol + column_width ; int bottomOfLast = 0 ; for ( i = ( event -> u . expose . rect . y - layer_header_height ) / layer_height ; i < ( event -> u . expose . rect . y + event -> u . expose . rect . height + layer_height - layer_header_height ) / layer_height ; ++ i ) { ll = i - 1 + layerinfo . offtop ; if ( ll >= cv -> b . sc -> layer_cnt || ll < - 1 ) { continue ; } y = layer_header_height + i * layer_height ; bottomOfLast = y + layer_height ; if ( y < layer_header_height ) { continue ; } if ( layerscols & LSHOW_CUBIC ) { if ( layerinfo . mo_layer == ll && layerinfo . mo_col == CID_QBase ) { r . x = quadcol ; r . width = column_width ; r . y = y ; r . height = layer_height ; GDrawFillRect ( pixmap , & r , cvpaletteactborcol ) ; } str = ( ll >= 0 && ll < cv -> b . sc -> layer_cnt ?( cv -> b . sc -> layers [ ll ] . order2 ?"Q" : "C" ) else " " ) ; GDrawDrawText8 ( pixmap , quadcol , y + yt , ( char * ) str , - 1 , cvpalettefgcol ) ; } if ( layerscols & LSHOW_FG ) { if ( layerinfo . mo_layer == ll && layerinfo . mo_col == CID_FBase ) { r . x = fgcol ; r . width = column_width ; r . y = y ; r . height = layer_height ; GDrawFillRect ( pixmap , & r , cvpaletteactborcol ) ; } str = ( ll >= 0 && ll < cv -> b . sc -> layer_cnt ?( cv -> b . sc -> layers [ ll ] . background ?"B" : "F" ) else "#" ) ; GDrawDrawText8 ( pixmap , fgcol , y + yt , ( char * ) str , - 1 , cvpalettefgcol ) ; } if ( ll == layerinfo . active ) { r . x = editcol ; r . width = ww - r . x ; r . y = y ; r . height = layer_height ; GDrawFillRect ( pixmap , & r , cvpalettefgcol ) ; } if ( layerinfo . mo_layer == ll && layerinfo . mo_col == CID_EBase ) { r . x = editcol ; r . width = ww - r . x ; r . y = y ; r . height = layer_height ; GDrawFillRect ( pixmap , & r , cvpaletteactborcol ) ; } r . x = editcol ; if ( ll == - 1 || ll == 0 || ll == 1 ) { str = ll == - 1 ?_ ( "Guide" ) : ( ll == 0 ?_ ( "Back" ) : _ ( "Fore" ) ) ; GDrawDrawText8 ( pixmap , r . x + 2 , y + yt , ( char * ) str , - 1 , ll == layerinfo . active ?cvpalettebgcol : cvpalettefgcol ) ; } if ( ll >= layerinfo . current_layers ) { break ; } if ( ll >= 0 && layerinfo . layers [ ll ] != NULL ) { BDFChar * bdfc = layerinfo . layers [ ll ] ; base . data = bdfc -> bitmap ; base . bytes_per_line = bdfc -> bytes_per_line ; base . width = bdfc -> xmax - bdfc -> xmin + 1 ; base . height = bdfc -> ymax - bdfc -> ymin + 1 ; str = cv -> b . sc -> parent -> layers [ ll ] . name ; if ( ! str || ! * str ) { str = "-" ; } GDrawDrawText8 ( pixmap , r . x + 2 , y + yt , ( char * ) str , - 1 , ll == layerinfo . active ?cvpalettebgcol : cvpalettefgcol ) ; } } if ( bottomOfLast ) { GGadgetSetY ( GWidgetGetControl ( cvlayers , CID_AddLayer ) , bottomOfLast + 2 ) ; GGadgetSetY ( GWidgetGetControl ( cvlayers , CID_RemoveLayer ) , bottomOfLast + 2 ) ; GGadgetSetY ( GWidgetGetControl ( cvlayers , CID_LayersMenu ) , bottomOfLast + 2 ) ; } } 