int btm_read ( struct cgpu_info * const cgpu , void * const buf , const size_t bufsize ) { int err = 0 ; if ( unlikely ( cgpu -> device_fd == BITMAIN_USING_CURL ) ) { struct bitmain_info * const info = cgpu -> device_data ; uint8_t headbuf [ 5 ] ; pk_u32be ( headbuf , 1 , bufsize ) ; if ( ! bitmain_curl_all ( false , info -> curl_sock , info -> device_curl , headbuf , sizeof ( headbuf ) ) ) { return - 1 ; } if ( ! bitmain_curl_all ( true , info -> curl_sock , info -> device_curl , headbuf , 4 ) ) { return - 1 ; } if ( headbuf [ 0 ] == 0xff && headbuf [ 1 ] == 0xff && headbuf [ 2 ] == 0xff && headbuf [ 3 ] == 0xff ) { return - 1 ; } size_t sz = upk_u32be ( headbuf , 0 ) ; if ( ! bitmain_curl_all ( true , info -> curl_sock , info -> device_curl , buf , sz ) ) { return - 1 ; } return sz ; } err = read ( cgpu -> device_fd , buf , bufsize ) ; return err ; } 