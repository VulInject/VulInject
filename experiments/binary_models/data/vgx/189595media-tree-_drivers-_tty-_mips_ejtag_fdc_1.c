static unsigned int mips_ejtag_fdc_put_chan ( struct mips_ejtag_fdc_tty * priv , unsigned int chan ) { struct mips_ejtag_fdc_tty_port * dport ; struct tty_struct * tty ; const char * ptrs [ 2 ] ; unsigned int sizes [ 2 ] { 0 } ; ; struct fdc_word word = { . bytes = 0 } ; cfs_time_t flags ; dport = & priv -> ports [ chan ] ; spin_lock ( & dport -> xmit_lock ) ; if ( dport -> xmit_cnt ) { ptrs [ 0 ] = dport -> port . xmit_buf + dport -> xmit_tail ; sizes [ 0 ] = min_t ( , , ) ; ptrs [ 1 ] = dport -> port . xmit_buf ; sizes [ 1 ] = dport -> xmit_cnt - sizes [ 0 ] ; word = mips_ejtag_fdc_encode ( ptrs , sizes , 1 + ! ! sizes [ 1 ] ) ; dev_dbg ( priv -> dev , "%s%u: out %08x: \"%*pE%*pE\"\n" , priv -> driver_name , chan , word . word , min_t ( int , word . bytes , sizes [ 0 ] ) , ptrs [ 0 ] , max_t ( int , 0 , word . bytes - sizes [ 0 ] ) , ptrs [ 1 ] ) ; local_irq_save ( flags ) ; if ( mips_ejtag_fdc_read ( priv , REG_FDSTAT ) & REG_FDSTAT_TXF ) { word . bytes = 0 ; } else { mips_ejtag_fdc_write ( priv , REG_FDTX ( chan ) , word . word ) ; } local_irq_restore ( flags ) ; dport -> xmit_cnt -= word . bytes ; if ( ! dport -> xmit_cnt ) { dport -> xmit_head = 0 ; dport -> xmit_tail = 0 ; complete ( & dport -> xmit_empty ) ; } else { dport -> xmit_tail += word . bytes ; if ( dport -> xmit_tail >= priv -> xmit_size ) { dport -> xmit_tail -= priv -> xmit_size ; } } atomic_sub ( word . bytes , & priv -> xmit_total ) ; } spin_unlock ( & dport -> xmit_lock ) ; if ( sizes [ 0 ] && word . bytes ) { tty = tty_port_tty_get ( & dport -> port ) ; if ( tty ) { tty_wakeup ( tty ) ; tty_kref_put ( tty ) ; } } return word . bytes ; } 