static void M_io_bwshaping_timer_cb ( M_event_t * event , M_event_type_t type , M_io_t * io_bogus , void * arg ) { M_io_layer_t * layer = arg ; M_io_handle_t * handle = M_io_layer_get_handle ( layer ) ; M_uint64 to_ms ; int num_wait = 0 ; ( void ) event ; ( void ) type ; ( void ) io_bogus ; if ( handle -> in_waiting ) { num_wait ++ ; } if ( handle -> out_waiting ) { num_wait ++ ; } to_ms = M_io_bwshaping_timeout_direction ( handle , M_IO_BWSHAPING_DIRECTION_IN ) ; if ( to_ms == 0 ) { M_io_layer_softevent_add ( layer , M_TRUE , M_EVENT_TYPE_READ , M_IO_ERROR_SUCCESS ) ; num_wait -- ; } to_ms = M_io_bwshaping_timeout_direction ( handle , M_IO_BWSHAPING_DIRECTION_OUT ) ; if ( to_ms == 0 && ! handle -> is_disconnecting ) { M_io_layer_softevent_add ( layer , M_TRUE , M_EVENT_TYPE_WRITE , M_IO_ERROR_SUCCESS ) ; num_wait -- ; } if ( num_wait > 0 ) { M_io_bwshaping_set_timeout ( handle ) ; } } 