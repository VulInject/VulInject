scfga_ret_t path_apid_state_change ( apid_t * apidp , scfga_cmd_t cmd , cfga_flags_t flags , char * * errstring , int * l_errnop , msgid_t errid ) { di_node_t root , walk_root , client_node ; di_path_t pi_node = DI_PATH_NIL ; char * root_path , * cp , * client_path , devpath [ MAXPATHLEN ] ; int len , found = 0 ; scfga_ret_t ret ; char * dev_list [ 2 ] { NULL } ; ; * l_errnop = 0 ; if ( ( apidp -> dyntype != PATH_APID ) || ( apidp -> dyncomp == NULL ) ) { return ( SCFGA_LIB_ERR ) ; } if ( ( cmd != SCFGA_DEV_CONFIGURE ) && ( cmd != SCFGA_DEV_UNCONFIGURE ) ) { return ( SCFGA_LIB_ERR ) ; } if ( ( root_path = strdup ( apidp -> hba_phys ) ) == NULL ) { * l_errnop = errno ; return ( SCFGA_LIB_ERR ) ; } len = strlen ( DEVICES_DIR ) ; if ( strncmp ( , , ) == 0 ) { cp = root_path + len ; ( void ) memmove ( root_path , cp , strlen ( cp ) + 1 ) ; } if ( * root_path != '/' ) { * l_errnop = 0 ; S_FREE ( root_path , NULL ) ; return ( SCFGA_ERR ) ; } if ( ( cp = GET_DYN ( root_path ) ) != NULL ) { * cp = '\0' ; } if ( ( cp = strrchr ( root_path , ':' ) ) != NULL ) { * cp = '\0' ; } if ( ( root = di_init ( "/" , DINFOCACHE ) ) == DI_NODE_NIL ) { * l_errnop = errno ; S_FREE ( root_path ) ; return ( SCFGA_ERR ) ; } walk_root = di_lookup_node ( root , root_path ) ; if ( walk_root == DI_NODE_NIL ) { * l_errnop = errno ; di_fini ( root ) ; S_FREE ( root_path ) ; return ( SCFGA_LIB_ERR ) ; } if ( ( pi_node = di_path_next_client ( walk_root , pi_node ) ) == DI_PATH_NIL ) { di_fini ( root ) ; S_FREE ( root_path ) ; return ( SCFGA_APID_NOEXIST ) ; } { if ( strlen ( di_path_bus_addr ( pi_node ) ) != strlen ( apidp -> dyncomp ) ) { continue ; } if ( strcmp ( di_path_bus_addr ( pi_node ) , apidp -> dyncomp ) == 0 ) { found = 1 ; break ; } pi_node = di_path_next_client ( root , pi_node ) ; } pi_node != DI_PATH_NIL ; if ( ! found ) { di_fini ( root ) ; S_FREE ( root_path ) ; return ( SCFGA_APID_NOEXIST ) ; } client_node = di_path_client_node ( pi_node ) ; if ( client_node == DI_NODE_NIL ) { di_fini ( root ) ; S_FREE ( root_path ) ; return ( SCFGA_ERR ) ; } else { client_path = di_devfs_path ( client_node ) ; if ( client_path == NULL ) { di_fini ( root ) ; S_FREE ( root_path ) ; return ( SCFGA_ERR ) ; } if ( ( apidp -> flags & FLAG_DISABLE_RCM ) == 0 ) { if ( cmd == SCFGA_DEV_UNCONFIGURE ) { if ( check_available_path ( client_node , pi_node ) != 0 ) { ( void ) snprintf ( devpath , strlen ( DEVICES_DIR ) + strlen ( client_path ) + 1 , "%s%s" , DEVICES_DIR , client_path ) ; dev_list [ 0 ] = devpath ; flags |= FLAG_CLIENT_DEV ; ret = scsi_rcm_offline ( dev_list , errstring , flags ) ; if ( ret != SCFGA_OK ) { di_fini ( root ) ; di_devfs_path_free ( client_path ) ; S_FREE ( root_path ) ; return ( ret ) ; } } } } } ret = devctl_cmd ( apidp -> path , cmd , NULL , l_errnop ) ; if ( ret != SCFGA_OK ) { cfga_err ( errstring , * l_errnop , errid , 0 ) ; if ( ( apidp -> flags & FLAG_DISABLE_RCM ) == 0 ) { if ( cmd == SCFGA_DEV_UNCONFIGURE ) { ( void ) scsi_rcm_online ( dev_list , errstring , flags ) ; } } } di_devfs_path_free ( client_path ) ; di_fini ( root ) ; S_FREE ( root_path ) ; return ( ret ) ; } 