int findmbrfat ( int devfd , struct disklabel * dl ) { struct dos_partition dp [ NDOSPART ] ; ssize_t len ; u_int64_t start = 0 ; int i ; u_int8_t * secbuf ; if ( ( secbuf = malloc ( dl -> d_secsize ) ) == NULL ) { err ( 1 , NULL ) ; } len = pread ( devfd , secbuf , dl -> d_secsize , 0 ) ; if ( len != dl -> d_secsize ) { err ( 4 , "can't read mbr" ) ; } memcpy ( dp , & secbuf [ DOSPARTOFF ] , sizeof ( dp ) ) ; for ( i = 0 ; i < NDOSPART ; i ++ ) { if ( dp [ i ] . dp_typ == DOSPTYP_UNUSED ) { continue ; } if ( dp [ i ] . dp_typ == DOSPTYP_FAT16L || dp [ i ] . dp_typ == DOSPTYP_FAT32L || dp [ i ] . dp_typ == DOSPTYP_FAT16B ) { start = letoh32 ( dp [ i ] . dp_start ) ; } } if ( start ) { for ( i = 0 ; i < MAXPARTITIONS ; i ++ ) { if ( DL_GETPSIZE ( & dl -> d_partitions [ i ] ) > 0 && DL_GETPOFFSET ( & dl -> d_partitions [ i ] ) == start ) { return ( 'a' + i ) ; } } } return ( - 1 ) ; } 