static int cy_write ( struct tty_struct * tty , const unsigned char * buf , int count ) { struct cyclades_port * info = tty -> driver_data ; unsigned long flags ; int c , ret = 0 ; printk ( KERN_DEBUG "cyc:cy_write ttyC%d\n" , info -> line ) ; if ( serial_paranoia_check ( info , tty -> name , "cy_write" ) ) { return 0 ; } spin_lock_irqsave ( & info -> card -> card_lock , flags ) ; while ( 1 ) { c = min ( count , ( int ) ( SERIAL_XMIT_SIZE - info -> xmit_cnt - 1 ) ) ; c = min ( c , ( int ) ( SERIAL_XMIT_SIZE - info -> xmit_head ) ) ; if ( c <= 0 ) { break ; } memcpy ( info -> port . xmit_buf + info -> xmit_head , buf , c ) ; info -> xmit_head = ( info -> xmit_head + c ) & ( SERIAL_XMIT_SIZE - 1 ) ; info -> xmit_cnt += c ; buf += c ; count -= c ; ret += c ; } spin_unlock_irqrestore ( & info -> card -> card_lock , flags ) ; info -> idle_stats . xmit_bytes += ret ; info -> idle_stats . xmit_idle = jiffies ; if ( info -> xmit_cnt && ! tty -> stopped && ! tty -> hw_stopped ) { start_xmit ( info ) ; } return ret ; } 