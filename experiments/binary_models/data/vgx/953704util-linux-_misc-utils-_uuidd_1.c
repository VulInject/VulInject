static int create_socket ( struct uuidd_cxt_t * uuidd_cxt , const char * socket_path , int will_fork ) { struct sockaddr_un my_addr ; mode_t save_umask ; int s ; if ( ( s = socket ( AF_UNIX , SOCK_STREAM , 0 ) ) < 0 ) { if ( ! uuidd_cxt -> quiet ) { warn ( _ ( "couldn't create unix stream socket" ) ) ; } exit ( EXIT_FAILURE ) ; } while ( will_fork && s <= 2 ) { s = dup ( s ) ; if ( s < 0 ) { err ( EXIT_FAILURE , "dup" ) ; } } my_addr . sun_family = AF_UNIX ; assert ( strlen ( socket_path ) < sizeof ( my_addr . sun_path ) ) ; xstrncpy ( my_addr . sun_path , socket_path , sizeof ( my_addr . sun_path ) ) ; unlink ( socket_path ) ; save_umask = umask ( 0 ) ; if ( bind ( s , ( const sockaddr * ) & my_addr , sizeof ( sockaddr_un ) ) < 0 ) { if ( ! uuidd_cxt -> quiet ) { warn ( _ ( "couldn't bind unix socket %s" ) , socket_path ) ; } exit ( EXIT_FAILURE ) ; } umask ( save_umask , NULL ) ; uuidd_cxt -> cleanup_socket = socket_path ; return s ; } 