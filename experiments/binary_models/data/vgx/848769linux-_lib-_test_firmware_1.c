static ssize_t upload_register_store ( struct device * dev , struct device_attribute * attr , const char * buf , size_t count ) { struct test_firmware_upload * tst ; struct fw_upload * fwl ; char * name ; int ret ; name = kstrndup ( buf , count , GFP_KERNEL ) ; if ( ! name ) { return - ENOMEM ; } mutex_lock ( & test_fw_mutex ) ; tst = upload_lookup_name ( name ) ; if ( tst ) { ret = - EEXIST ; free_name } tst = kzalloc ( sizeof ( * tst ) , GFP_KERNEL ) ; if ( ! tst ) { ret = - ENOMEM ; free_name } tst -> name = name ; tst -> buf = kzalloc ( TEST_UPLOAD_MAX_SIZE , GFP_KERNEL ) ; if ( ! tst -> buf ) { ret = - ENOMEM ; free_tst } fwl = firmware_upload_register ( THIS_MODULE , dev , tst -> name , & upload_test_ops , tst ) ; if ( IS_ERR ( fwl ) ) { ret = PTR_ERR ( fwl ) ; free_buf } tst -> fwl = fwl ; list_add_tail ( & tst -> node , & test_upload_list ) ; mutex_unlock ( & test_fw_mutex ) ; return count ; free_buf free_tst kfree ( tst ) ; free_name mutex_unlock ( & test_fw_mutex ) ; kfree ( name ) ; return ret ; } 