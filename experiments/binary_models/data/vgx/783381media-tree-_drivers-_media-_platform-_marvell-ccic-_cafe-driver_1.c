static int cafe_pci_probe ( struct pci_dev * pdev , const struct pci_device_id * id ) { int ret ; struct cafe_camera * cam ; struct mcam_camera * mcam ; ret = - ENOMEM ; cam = kzalloc ( sizeof ( cafe_camera ) , GFP_KERNEL ) ; if ( cam == NULL ) { out } cam -> pdev = pdev ; mcam = & cam -> mcam ; mcam -> chip_id = MCAM_CAFE ; spin_lock_init ( & mcam -> dev_lock ) ; init_waitqueue_head ( & cam -> smbus_wait ) ; mcam -> plat_power_up = cafe_ctlr_power_up ; mcam -> plat_power_down = cafe_ctlr_power_down ; mcam -> dev = & pdev -> dev ; snprintf ( mcam -> bus_info , sizeof ( mcam -> bus_info ) , "PCI:%s" , pci_name ( pdev ) ) ; mcam -> clock_speed = 45 ; mcam -> use_smbus = 1 ; mcam -> buffer_mode = B_vmalloc ; ret = pci_enable_device ( pdev ) ; if ( ret ) { out_free } pci_set_master ( pdev ) ; ret = - EIO ; mcam -> regs = pci_iomap ( pdev , 0 , 0 ) ; if ( ! mcam -> regs ) { printk ( KERN_ERR "Unable to ioremap cafe-ccic regs\n" ) ; out_disable } mcam -> regs_size = pci_resource_len ( pdev , 0 ) ; ret = request_irq ( pdev -> irq , cafe_irq , IRQF_SHARED , "cafe-ccic" , cam ) ; if ( ret ) { out_iounmap } cafe_ctlr_init ( mcam ) ; cafe_ctlr_power_up ( mcam ) ; ret = cafe_smbus_setup ( cam ) ; if ( ret ) { out_pdown } ret = mccic_register ( mcam ) ; if ( ret == 0 ) { return 0 ; } cafe_smbus_shutdown ( cam ) ; out_pdown cafe_ctlr_power_down ( mcam ) ; free_irq ( pdev -> irq , cam ) ; out_iounmap pci_iounmap ( pdev , mcam -> regs ) ; out_disable pci_disable_device ( pdev ) ; out_free kfree ( cam ) ; out return ret ; } 