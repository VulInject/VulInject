static int ki_ds_select_routes_limit ( sip_msg_t * msg , str * srules , str * smode , int rlimit ) { int i ; int vret ; int gret ; sr_xval_t nxval ; ds_select_state_t vstate ; vstate . limit = ( uint32_t ) rlimit ; if ( vstate . limit == 0 ) { LM_DBG ( "Limit set to 0 - forcing to unlimited\n" ) ; vstate . limit = 0xffffffff ; } vret = - 1 ; gret = - 1 ; i = 0 ; while ( i < srules -> len ) { vstate . setid = 0 ; for ( ; i < srules -> len ; i ++ ) { if ( srules -> s [ i ] < '0' || srules -> s [ i ] > '9' ) { if ( srules -> s [ i ] == '=' ) { i ++ ; break ; } else { LM_ERR ( "invalid character in [%.*s] at [%d]\n" , srules -> len , srules -> s , i ) ; return - 1 ; } } vstate . setid = ( vstate . setid * 10 ) + ( srules -> s [ i ] - '0' ) ; } vstate . alg = 0 ; for ( ; i < srules -> len ; i ++ ) { if ( srules -> s [ i ] < '0' || srules -> s [ i ] > '9' ) { if ( srules -> s [ i ] == ';' ) { i ++ ; break ; } else { LM_ERR ( "invalid character in [%.*s] at [%d]\n" , srules -> len , srules -> s , i ) ; return - 1 ; } } vstate . alg = ( vstate . alg * 10 ) + ( srules -> s [ i ] - '0' ) ; } LM_DBG ( "routing with setid=%d alg=%d cnt=%d limit=0x%x (%u)\n" , vstate . setid , vstate . alg , vstate . cnt , vstate . limit , vstate . limit ) ; vstate . umode = DS_SETOP_XAVP ; if ( vstate . emode == 0 ) { switch ( smode -> s [ 0 ] ) { case '0' : case 'd' : case 'D' : vstate . umode = DS_SETOP_DSTURI ; break ; case '1' : case 'r' : case 'R' : vstate . umode = DS_SETOP_RURI ; break ; case '2' : case 'x' : case 'X' : break ; default : LM_ERR ( "invalid routing mode parameter: %.*s\n" , smode -> len , smode -> s ) ; return - 1 ; } } vret = ds_manage_routes ( msg , & vstate ) ; if ( vret < 0 ) { LM_DBG ( "failed to select target destinations from %d=%d [%.*s]\n" , vstate . setid , vstate . alg , srules -> len , srules -> s ) ; } else { if ( vret > 0 ) { gret = vret ; } } } if ( gret < 0 ) { LM_DBG ( "failed to select any target destinations from [%.*s]\n" , srules -> len , srules -> s ) ; return vret ; } if ( ( ( ds_xavp_ctx_mode & DS_XAVP_CTX_SKIP_CNT ) == 0 ) && ( ds_xavp_ctx . len >= 0 ) ) { memset ( & nxval , 0 , sizeof ( sr_xval_t ) ) ; nxval . type = SR_XTYPE_LONG ; nxval . v . l = vstate . cnt ; if ( xavp_add_xavp_value ( & ds_xavp_ctx , & ds_xavp_ctx_cnt , & nxval , NULL ) == NULL ) { LM_ERR ( "failed to add cnt value to xavp\n" ) ; return - 1 ; } } LM_DBG ( "selected target destinations: %d\n" , vstate . cnt ) ; return gret ; } 