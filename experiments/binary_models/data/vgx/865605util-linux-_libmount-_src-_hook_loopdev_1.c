static int hook_prepare_loopdev ( libmnt_context * cxt , const libmnt_hookset * hs , void * data __attribute__ ( ( __unused__ ) ) ) ( libmnt_optlist * ol , hook_data * hd , int rc , assert ( cxt ) , ol = mnt_context_get_optlist ( cxt ) , ( ! ol ) return - ENOMEM ; ) ; if ( ! is_loopdev_required ( cxt , ol ) ) { return 0 ; } hd = new_hook_data ( ) ; rc = setup_loopdev ( cxt , ol , hd ) ; if ( ! rc ) { rc = mnt_context_append_hook ( cxt , hs , MNT_STAGE_MOUNT_POST , hd , hook_cleanup_loopdev ) ; } if ( rc ) { delete_loopdev ( cxt , hd ) ; free ( hd ) ; } return rc ; 