static struct RProc * mrb_proc_read_irep_file ( mrb_state * mrb , FILE * fp ) { struct RProc * proc = NULL ; uint8_t * buf ; const size_t header_size = sizeof ( rite_binary_header ) ; int buf_size = 0 ; uint8_t flags = 0 ; int result ; if ( ( mrb == NULL ) || ( fp == NULL ) ) { return NULL ; } buf = ( uint8_t * ) mrb_malloc ( mrb , header_size ) ; if ( fread ( buf , header_size , 1 , fp ) == 0 ) { irep_exit } result = read_binary_header ( buf , ( size_t ) - 1 , & buf_size , & flags ) ; if ( result != MRB_DUMP_OK || buf_size <= header_size ) { irep_exit } buf = ( uint8_t * ) mrb_realloc ( mrb , buf , buf_size ) ; if ( fread ( buf + header_size , buf_size - header_size , 1 , fp ) == 0 ) { irep_exit } proc = read_irep ( mrb , buf , ( size_t ) - 1 , FLAG_SRC_MALLOC ) ; irep_exit mrb_free ( mrb , buf ) ; return proc ; } 