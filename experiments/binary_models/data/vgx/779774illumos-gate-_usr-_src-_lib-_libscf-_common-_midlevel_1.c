static int set_inst_enabled ( const scf_instance_t * inst , uint8_t desired , const char * pgname , uint32_t pgflags , const char * comment ) { scf_transaction_t * tx = NULL ; scf_transaction_entry_t * ent1 = NULL ; scf_transaction_entry_t * ent2 = NULL ; scf_propertygroup_t * gpg = NULL ; scf_property_t * eprop = NULL ; scf_value_t * v1 ; scf_value_t * v2 = NULL ; scf_handle_t * h = NULL ; int ret = - 1 ; int committed ; uint8_t b ; if ( ( h = scf_instance_handle ( inst ) ) == NULL ) { return ( - 1 ) ; } if ( ( gpg = scf_pg_create ( h ) ) == NULL || ( eprop = scf_property_create ( h ) ) == NULL || ( v1 = scf_value_create ( h ) ) == NULL || ( v2 = scf_value_create ( h ) ) == NULL || ( tx = scf_transaction_create ( h ) ) == NULL || ( ent1 = scf_entry_create ( h ) ) == NULL || ( ent2 = scf_entry_create ( h ) ) == NULL ) { out } general_pg_get if ( scf_instance_get_pg ( inst , SCF_PG_GENERAL , gpg ) == - 1 ) { if ( scf_error ( ) != SCF_ERROR_NOT_FOUND ) { out } if ( scf_instance_add_pg ( inst , SCF_PG_GENERAL , SCF_GROUP_FRAMEWORK , SCF_PG_GENERAL_FLAGS , gpg ) == - 1 ) { if ( scf_error ( ) != SCF_ERROR_EXISTS ) { out } general_pg_get } } if ( strcmp ( pgname , SCF_PG_GENERAL ) != 0 ) { get if ( scf_instance_get_pg ( inst , pgname , gpg ) == - 1 ) { if ( scf_error ( ) != SCF_ERROR_NOT_FOUND ) { out } if ( scf_instance_add_pg ( inst , pgname , SCF_GROUP_FRAMEWORK , pgflags , gpg ) == - 1 ) { if ( scf_error ( ) != SCF_ERROR_EXISTS ) { out } get } } } if ( scf_pg_get_property ( gpg , SCF_PROPERTY_ENABLED , eprop ) == - 1 ) { if ( scf_error ( ) != SCF_ERROR_NOT_FOUND ) { out } else { set } } if ( scf_property_get_value ( eprop , v1 ) == - 1 ) { switch ( scf_error ( ) ) { case SCF_ERROR_CONSTRAINT_VIOLATED : case SCF_ERROR_NOT_FOUND : set default : out } } if ( scf_value_get_boolean ( v1 , & b ) == - 1 ) { if ( scf_error ( ) != SCF_ERROR_TYPE_MISMATCH ) { out } set } if ( b == desired ) { ret = 0 ; out } set { if ( scf_transaction_start ( tx , gpg ) == - 1 ) { out } if ( transaction_property_set ( tx , ent1 , SCF_PROPERTY_ENABLED , SCF_TYPE_BOOLEAN ) != 0 ) { switch ( scf_error ( ) ) { case SCF_ERROR_CONNECTION_BROKEN : case SCF_ERROR_DELETED : default : out case SCF_ERROR_HANDLE_MISMATCH : case SCF_ERROR_INVALID_ARGUMENT : case SCF_ERROR_NOT_BOUND : case SCF_ERROR_NOT_SET : bad_error ( "transaction_property_set" , scf_error ( ) ) ; } } scf_value_set_boolean ( v1 , desired ) ; if ( scf_entry_add_value ( ent1 , v1 ) == - 1 ) { out } if ( transaction_property_set ( tx , ent2 , SCF_PROPERTY_COMMENT , SCF_TYPE_ASTRING ) != 0 ) { switch ( scf_error ( ) ) { case SCF_ERROR_CONNECTION_BROKEN : case SCF_ERROR_DELETED : default : out case SCF_ERROR_HANDLE_MISMATCH : case SCF_ERROR_INVALID_ARGUMENT : case SCF_ERROR_NOT_BOUND : case SCF_ERROR_NOT_SET : bad_error ( "transaction_property_set" , scf_error ( ) ) ; } } if ( scf_value_set_astring ( v2 , comment ) == - 1 ) { out } if ( scf_entry_add_value ( ent2 , v2 ) == - 1 ) { out } committed = scf_transaction_commit ( tx ) ; if ( committed == - 1 ) { out } scf_transaction_reset ( tx ) ; if ( committed == 0 ) { if ( scf_pg_update ( gpg ) == - 1 ) { out } } } committed == 0 ; ret = 0 ; out scf_value_destroy ( v1 ) ; scf_value_destroy ( v2 ) ; scf_entry_destroy ( ent1 ) ; scf_entry_destroy ( ent2 ) ; scf_transaction_destroy ( tx ) ; scf_property_destroy ( eprop ) ; scf_pg_destroy ( gpg ) ; return ( ret ) ; } 