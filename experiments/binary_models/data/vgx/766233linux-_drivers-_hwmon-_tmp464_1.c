static int tmp464_probe ( struct i2c_client * client ) { struct device * dev = & client -> dev ; struct device * hwmon_dev ; struct tmp464_data * data ; int i , err ; if ( ! i2c_check_functionality ( client -> adapter , I2C_FUNC_SMBUS_WORD_DATA ) ) { dev_err ( & client -> dev , "i2c functionality check failed\n" ) ; return - ENODEV ; } data = devm_kzalloc ( dev , sizeof ( tmp464_data ) , GFP_KERNEL ) ; mutex_init ( & data -> update_lock ) ; if ( dev -> of_node ) { data -> channels = ( int ) ( unsigned long ) of_device_get_match_data ( & client -> dev ) ; } else { data -> channels = i2c_match_id ( tmp464_id , client ) -> driver_data ; } data -> regmap = devm_regmap_init_i2c ( client , & tmp464_regmap_config ) ; if ( IS_ERR ( data -> regmap ) ) { return PTR_ERR ( data -> regmap ) ; } for ( i = 0 ; i < data -> channels ; i ++ ) { data -> channel [ i ] . enabled = true ; } err = tmp464_init_client ( dev , data ) ; if ( err ) { return err ; } if ( dev -> of_node ) { err = tmp464_probe_from_dt ( dev , data ) ; if ( err ) { return err ; } } hwmon_dev = devm_hwmon_device_register_with_info ( dev , client -> name , data , & tmp464_chip_info , NULL ) ; return PTR_ERR_OR_ZERO ( hwmon_dev ) ; } 