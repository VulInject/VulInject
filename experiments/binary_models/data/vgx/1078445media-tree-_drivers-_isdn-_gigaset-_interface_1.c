static int if_lock ( struct cardstate * cs , int * arg ) { int cmd = * arg ; gig_dbg ( DEBUG_IF , "%u: if_lock (%d)" , cs -> minor_index , cmd ) ; if ( cmd < 0 ) { * arg = cs -> mstate == MS_LOCKED ; return 0 ; } if ( ! cmd && cs -> mstate == MS_LOCKED && cs -> connected ) { cs -> ops -> set_modem_ctrl ( cs , 0 , TIOCM_DTR | TIOCM_RTS ) ; cs -> ops -> baud_rate ( cs , B115200 ) ; cs -> ops -> set_line_ctrl ( cs , CS8 ) ; cs -> control_state = TIOCM_DTR | TIOCM_RTS ; } cs -> waiting = 1 ; if ( ! gigaset_add_event ( cs , & cs -> at_state , EV_IF_LOCK , NULL , cmd , NULL ) ) { cs -> waiting = 0 ; return - ENOMEM ; } gigaset_schedule_event ( cs ) ; wait_event ( cs -> waitqueue , ! cs -> waiting ) ; if ( cs -> cmd_result >= 0 ) { * arg = cs -> cmd_result ; return 0 ; } return cs -> cmd_result ; } 