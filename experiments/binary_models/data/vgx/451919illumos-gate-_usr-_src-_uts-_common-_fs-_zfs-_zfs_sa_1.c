void zfs_sa_upgrade ( sa_handle_t * hdl , dmu_tx_t * tx ) { dmu_buf_t * db = sa_get_db ( hdl ) ; znode_t * zp = sa_get_userdata ( hdl ) ; zfsvfs_t * zfsvfs = zp -> z_zfsvfs ; sa_bulk_attr_t bulk [ 22 ] ; int count = 0 ; sa_bulk_attr_t sa_attrs [ 20 ] { 0 } ; ; zfs_acl_locator_cb_t locate = { 0 } ; uint64_t uid , gid , mode , rdev , xattr , parent ; uint64_t crtime [ 2 ] , mtime [ 2 ] , ctime [ 2 ] ; zfs_acl_phys_t znode_acl ; char scanstamp [ AV_SCANSTAMP_SZ ] ; boolean_t drop_lock = B_FALSE ; if ( zp -> z_acl_cached == NULL || ZTOV ( zp ) -> v_type == VLNK ) { return ; } if ( mutex_owner ( & zp -> z_lock ) != curthread ) { if ( mutex_tryenter ( & zp -> z_lock ) == 0 ) { return ; } else { drop_lock = B_TRUE ; } } SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_MTIME ( zfsvfs ) , NULL , & mtime , 16 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_CTIME ( zfsvfs ) , NULL , & ctime , 16 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_CRTIME ( zfsvfs ) , NULL , & crtime , 16 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_MODE ( zfsvfs ) , & mode , 8 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_PARENT ( zfsvfs ) , NULL , & parent , 8 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_XATTR ( zfsvfs ) , NULL , & xattr , 8 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_RDEV ( zfsvfs ) , NULL , & rdev , 8 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_UID ( zfsvfs ) , NULL , & uid , 8 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_GID ( zfsvfs ) , NULL , & gid , 8 ) ; SA_ADD_BULK_ATTR ( bulk , count , SA_ZPL_ZNODE_ACL ( zfsvfs ) , NULL , & znode_acl , 88 ) ; if ( sa_bulk_lookup_locked ( hdl , bulk , count ) != 0 ) { done } if ( dmu_objset_projectquota_enabled ( hdl -> sa_os ) && ! ( zp -> z_pflags & ZFS_PROJID ) ) { zp -> z_pflags |= ZFS_PROJID ; zp -> z_projid = ZFS_DEFAULT_PROJID ; } count = 0 ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_MODE ( zfsvfs ) , NULL , & mode , 8 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_SIZE ( zfsvfs ) , NULL , & zp -> z_size , 8 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_GEN ( zfsvfs ) , NULL , & zp -> z_gen , 8 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_UID ( zfsvfs ) , NULL , & uid , 8 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_GID ( zfsvfs ) , NULL , & gid , 8 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_PARENT ( zfsvfs ) , NULL , & parent , 8 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_FLAGS ( zfsvfs ) , NULL , & zp -> z_pflags , 8 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_ATIME ( zfsvfs ) , NULL , zp -> z_atime , 16 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_MTIME ( zfsvfs ) , NULL , & mtime , 16 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_CTIME ( zfsvfs ) , NULL , & ctime , 16 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_CRTIME ( zfsvfs ) , NULL , & crtime , 16 ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_LINKS ( zfsvfs ) , NULL , & zp -> z_links , 8 ) ; if ( dmu_objset_projectquota_enabled ( hdl -> sa_os ) ) { SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_PROJID ( zfsvfs ) , NULL , & zp -> z_projid , 8 ) ; } if ( zp -> z_vnode -> v_type == VBLK || zp -> z_vnode -> v_type == VCHR ) { SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_RDEV ( zfsvfs ) , NULL , & rdev , 8 ) ; } SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_DACL_COUNT ( zfsvfs ) , NULL , & zp -> z_acl_cached -> z_acl_count , 8 ) ; if ( zp -> z_acl_cached -> z_version < ZFS_ACL_VERSION_FUID ) { zfs_acl_xform ( zp , zp -> z_acl_cached , CRED ( ) ) ; } locate . cb_aclp = zp -> z_acl_cached ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_DACL_ACES ( zfsvfs ) , zfs_acl_data_locator , & locate , zp -> z_acl_cached -> z_acl_bytes ) ; if ( xattr ) { SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_XATTR ( zfsvfs ) , NULL , & xattr , 8 ) ; } if ( zp -> z_pflags & ZFS_BONUS_SCANSTAMP ) { bcopy ( ( caddr_t ) db -> db_data + ZFS_OLD_ZNODE_PHYS_SIZE , scanstamp , AV_SCANSTAMP_SZ ) ; SA_ADD_BULK_ATTR ( sa_attrs , count , SA_ZPL_SCANSTAMP ( zfsvfs ) , NULL , scanstamp , AV_SCANSTAMP_SZ ) ; zp -> z_pflags &= ~ ZFS_BONUS_SCANSTAMP ; } VERIFY ( dmu_set_bonustype ( db , DMU_OT_SA , tx ) == 0 ) ; VERIFY ( sa_replace_all_by_template_locked ( hdl , sa_attrs , count , tx ) == 0 ) ; if ( znode_acl . z_acl_extern_obj ) { VERIFY ( 0 == dmu_object_free ( zfsvfs -> z_os , znode_acl . z_acl_extern_obj , tx ) ) ; } zp -> z_is_sa = B_TRUE ; done if ( drop_lock ) { mutex_exit ( & zp -> z_lock ) ; } } 