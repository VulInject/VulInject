static int omap2_select_table_rate ( struct clk_hw * hw , unsigned long rate , unsigned long parent_rate ) { u32 cur_rate , done_rate , bypass = 0 ; const struct prcm_config * prcm ; unsigned long found_speed = 0 ; unsigned long flags ; for ( prcm = rate_table ; prcm -> mpu_speed ; prcm ++ ) { if ( prcm -> xtal_speed != sys_ck_rate ) { continue ; } if ( prcm -> mpu_speed <= rate ) { found_speed = prcm -> mpu_speed ; break ; } } if ( ! found_speed ) { printk ( KERN_INFO "Could not set MPU rate to %luMHz\n" , rate / 1000000 ) ; return - EINVAL ; } curr_prcm_set = prcm ; cur_rate = omap2xxx_clk_get_core_rate ( ) ; if ( prcm -> dpll_speed == cur_rate / 2 ) { omap2xxx_sdrc_reprogram ( CORE_CLK_SRC_DPLL , 1 ) ; } if ( prcm -> dpll_speed == cur_rate * 2 ) { omap2xxx_sdrc_reprogram ( CORE_CLK_SRC_DPLL_X2 , 1 ) ; } if ( prcm -> dpll_speed != cur_rate ) { local_irq_save ( flags ) ; if ( prcm -> dpll_speed == prcm -> xtal_speed ) { bypass = 1 ; } if ( ( prcm -> cm_clksel2_pll & OMAP24XX_CORE_CLK_SRC_MASK ) == CORE_CLK_SRC_DPLL_X2 ) { done_rate = CORE_CLK_SRC_DPLL_X2 ; } else { done_rate = CORE_CLK_SRC_DPLL ; } omap2xxx_cm_set_mod_dividers ( prcm -> cm_clksel_mpu , prcm -> cm_clksel_dsp , prcm -> cm_clksel_gfx , prcm -> cm_clksel1_core , prcm -> cm_clksel_mdm ) ; omap2xxx_sdrc_reprogram ( CORE_CLK_SRC_DPLL_X2 , 1 ) ; omap2_set_prcm ( prcm -> cm_clksel1_pll , prcm -> base_sdrc_rfr , bypass ) ; omap2xxx_sdrc_init_params ( omap2xxx_sdrc_dll_is_unlocked ( ) ) ; omap2xxx_sdrc_reprogram ( done_rate , 0 ) ; local_irq_restore ( flags ) ; } return 0 ; } static void omap2xxx_clkt_vps_check_bootloader_rates ( void ) { const struct prcm_config * prcm = NULL ; unsigned long rate ; rate = omap2xxx_clk_get_core_rate ( ) ; for ( prcm = rate_table ; prcm -> mpu_speed ; prcm ++ ) { if ( ! ( prcm -> flags & cpu_mask ) ) { continue ; } if ( prcm -> xtal_speed != sys_ck_rate ) { continue ; } if ( prcm -> dpll_speed <= rate ) { break ; } } curr_prcm_set = prcm ; } 