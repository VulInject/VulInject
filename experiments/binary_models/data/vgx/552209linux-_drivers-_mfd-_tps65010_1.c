static void tps65010_interrupt ( struct tps65010 * tps ) { u8 tmp = 0 , mask , poll ; poll = 0 ; if ( tps -> nmask2 ) { tmp = i2c_smbus_read_byte_data ( tps -> client , TPS_REGSTATUS ) ; mask = tmp ^ tps -> regstatus ; tps -> regstatus = tmp ; mask &= tps -> nmask2 ; } else { mask = 0 ; } if ( mask ) { tps -> regstatus = tmp ; if ( tmp & TPS_REG_ONOFF ) { pr_info ( "%s: power off button\n" , DRIVER_NAME ) ; hibernate ( ) ; poll = 1 ; } } if ( tps -> nmask1 ) { tmp = i2c_smbus_read_byte_data ( tps -> client , TPS_CHGSTATUS ) ; mask = tmp ^ tps -> chgstatus ; tps -> chgstatus = tmp ; mask &= tps -> nmask1 ; } else { mask = 0 ; } if ( mask ) { int charging = 0 ; show_chgstatus ( "chg/irq" , tmp ) ; if ( tmp & ( TPS_CHG_USB | TPS_CHG_AC ) ) { show_chgconfig ( tps -> por , "conf" , tps -> chgconf ) ; } if ( ! ( tps -> chgstatus & ~ ( TPS_CHG_USB | TPS_CHG_AC ) ) && ( tps -> chgstatus & ( TPS_CHG_USB | TPS_CHG_AC ) ) && ( tps -> chgconf & TPS_CHARGE_ENABLE ) ) { if ( tps -> chgstatus & TPS_CHG_USB ) { if ( mask & TPS_CHG_USB ) { set_bit ( FLAG_VBUS_CHANGED , & tps -> flags ) ; } charging = 1 ; } if ( tps -> chgstatus & TPS_CHG_AC ) { charging = 1 ; } } if ( charging != tps -> charging ) { tps -> charging = charging ; pr_info ( "%s: battery %scharging\n" , DRIVER_NAME , charging ?"" : ( ( tps -> chgstatus & ( TPS_CHG_USB | TPS_CHG_AC ) ) ?"NOT " : "dis" ) ) ; } } if ( ( tps -> model != TPS65013 || ! tps -> charging ) && ( tps -> chgstatus & ( TPS_CHG_USB | TPS_CHG_AC ) ) ) { poll = 1 ; } if ( poll ) { queue_delayed_work ( system_power_efficient_wq , & tps -> work , POWER_POLL_DELAY ) ; } } 