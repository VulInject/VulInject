static int lnet_accept ( struct socket * sock , __u32 magic ) { struct lnet_acceptor_connreq cr ; __u32 peer_ip ; int peer_port ; int rc ; int flip ; struct lnet_ni * ni ; char * str ; LASSERT ( sizeof ( cr ) <= 16 ) ; rc = lnet_sock_getaddr ( sock , 1 , & peer_ip , & peer_port ) ; LASSERT ( ! rc ) ; if ( ! lnet_accept_magic ( magic , LNET_PROTO_ACCEPTOR_MAGIC ) ) { if ( lnet_accept_magic ( magic , LNET_PROTO_MAGIC ) ) { cr . acr_magic = LNET_PROTO_ACCEPTOR_MAGIC ; cr . acr_version = LNET_PROTO_ACCEPTOR_VERSION ; rc = lnet_sock_write ( sock , & cr , sizeof ( cr ) , accept_timeout ) ; if ( rc ) { CERROR ( "Error sending magic+version in response to LNET magic from %pI4h: %d\n" , & peer_ip , rc ) ; } return - EPROTO ; } if ( magic == le32_to_cpu ( LNET_PROTO_TCP_MAGIC ) ) { str = "'old' socknal/tcpnal" ; } else { str = "unrecognised" ; } LCONSOLE_ERROR_MSG ( 0x11f , "Refusing connection from %pI4h magic %08x: %s acceptor protocol\n" , & peer_ip , magic , str ) ; return - EPROTO ; } flip = ( magic != LNET_PROTO_ACCEPTOR_MAGIC ) ; rc = lnet_sock_read ( sock , & cr . acr_version , sizeof ( cr . acr_version ) , accept_timeout ) ; if ( rc ) { CERROR ( "Error %d reading connection request version from %pI4h\n" , rc , & peer_ip ) ; return - EIO ; } if ( flip ) { __swab32s ( & cr . acr_version ) ; } if ( cr . acr_version != LNET_PROTO_ACCEPTOR_VERSION ) { int peer_version = cr . acr_version ; memset ( & cr , 0 , sizeof ( cr ) ) ; cr . acr_magic = LNET_PROTO_ACCEPTOR_MAGIC ; cr . acr_version = LNET_PROTO_ACCEPTOR_VERSION ; rc = lnet_sock_write ( sock , & cr , sizeof ( cr ) , accept_timeout ) ; if ( rc ) { CERROR ( "Error sending magic+version in response to version %d from %pI4h: %d\n" , peer_version , & peer_ip , rc ) ; } return - EPROTO ; } rc = lnet_sock_read ( sock , & cr . acr_nid , sizeof ( cr ) - offsetof ( lnet_acceptor_connreq , acr_nid ) , accept_timeout ) ; if ( rc ) { CERROR ( "Error %d reading connection request from %pI4h\n" , rc , & peer_ip ) ; return - EIO ; } if ( flip ) { __swab64s ( & cr . acr_nid ) ; } ni = lnet_net2ni ( LNET_NIDNET ( cr . acr_nid ) ) ; if ( ! ni || ni -> ni_nid != cr . acr_nid ) { if ( ni ) { lnet_ni_decref ( ni ) ; } LCONSOLE_ERROR_MSG ( 0x120 , "Refusing connection from %pI4h for %s: No matching NI\n" , & peer_ip , libcfs_nid2str ( cr . acr_nid ) ) ; return - EPERM ; } if ( ! ni -> ni_lnd -> lnd_accept ) { lnet_ni_decref ( ni ) ; LCONSOLE_ERROR_MSG ( 0x121 , "Refusing connection from %pI4h for %s: NI doesn not accept IP connections\n" , & peer_ip , libcfs_nid2str ( cr . acr_nid ) ) ; return - EPERM ; } CDEBUG ( D_NET , "Accept %s from %pI4h\n" , libcfs_nid2str ( cr . acr_nid ) , & peer_ip ) ; rc = ni -> ni_lnd -> lnd_accept ( ni , sock ) ; lnet_ni_decref ( ni ) ; return rc ; } 