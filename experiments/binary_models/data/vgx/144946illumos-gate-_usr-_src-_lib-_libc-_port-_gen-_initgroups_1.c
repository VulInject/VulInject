int initgroups ( const char * uname , gid_t agroup ) { gid_t * groups ; long ngroups_max ; int ngroups ; int errsave , retsave ; if ( ( ngroups_max = sysconf ( _SC_NGROUPS_MAX ) ) < 0 ) { return ( - 1 ) ; } if ( ngroups_max == 0 ) { return ( 0 ) ; } if ( ( groups = ( gid_t * ) calloc ( ngroups_max , sizeof ( gid_t ) ) ) == 0 ) { errno = ENOMEM ; return ( - 1 ) ; } groups [ 0 ] = agroup ; ngroups = _getgroupsbymember ( uname , groups , ( int ) ngroups_max , ( agroup <= MAXUID ) ?1 : 0 ) ; if ( ngroups < 0 ) { return ( - 1 ) ; } retsave = setgroups ( ngroups , groups ) ; errsave = errno ; free ( groups ) ; errno = errsave ; return ( retsave ) ; } 