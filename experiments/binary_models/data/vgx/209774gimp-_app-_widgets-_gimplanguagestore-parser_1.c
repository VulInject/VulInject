gimp_language_store_parser_init ( ) { GHashTable * base_lang_list ; gchar * current_env ; GDir * locales_dir ; GError * error = NULL ; GHashTableIter lang_iter ; gpointer key ; if ( l10n_lang_list != NULL ) { g_warning ( "gimp_language_store_parser_init() must be run only once." ) ; return ; } current_env = g_strdup ( g_getenv ( "LANGUAGE" ) ) ; l10n_lang_list = g_hash_table_new_full ( g_str_hash , g_str_equal , ( GDestroyNotify ) g_free , ( GDestroyNotify ) g_free ) ; all_lang_list = g_hash_table_new_full ( g_str_hash , g_str_equal , ( GDestroyNotify ) g_free , ( GDestroyNotify ) g_free ) ; base_lang_list = g_hash_table_new_full ( g_str_hash , g_str_equal , ( GDestroyNotify ) g_free , ( GDestroyNotify ) g_free ) ; locales_dir = g_dir_open ( gimp_locale_directory ( ) , 0 , NULL ) ; if ( locales_dir ) { const gchar * locale ; while ( ( locale = g_dir_read_name ( locales_dir ) ) != NULL ) { gchar * filename = g_build_filename ( gimp_locale_directory ( ) , locale , "LC_MESSAGES" , GETTEXT_PACKAGE ".mo" , NULL ) ; if ( g_file_test ( filename , G_FILE_TEST_EXISTS ) ) { gchar * delimiter = NULL ; gchar * base_code = NULL ; delimiter = strchr ( locale , '_' ) ; if ( delimiter ) { base_code = g_strndup ( locale , delimiter - locale ) ; } else { base_code = g_strdup ( locale ) ; } delimiter = strchr ( base_code , '@' ) ; if ( delimiter ) { gchar * temp = base_code ; base_code = g_strndup ( base_code , delimiter - base_code ) ; g_free ( temp ) ; } g_hash_table_insert ( l10n_lang_list , g_strdup ( locale ) , NULL ) ; g_hash_table_insert ( base_lang_list , base_code , NULL ) ; } } g_dir_close ( locales_dir ) ; } parse_iso_codes ( base_lang_list , & error ) ; g_hash_table_iter_init ( & lang_iter , l10n_lang_list ) ; while ( g_hash_table_iter_next ( & lang_iter , & key , NULL ) ) { gchar * code = ( gchar * ) key ; gchar * localized_name = NULL ; gchar * english_name = NULL ; gchar * delimiter = NULL ; gchar * base_code = NULL ; delimiter = strchr ( code , '_' ) ; if ( delimiter ) { base_code = g_strndup ( code , delimiter - code ) ; } else { base_code = g_strdup ( code ) ; } delimiter = strchr ( base_code , '@' ) ; if ( delimiter ) { gchar * temp = base_code ; base_code = g_strndup ( base_code , delimiter - base_code ) ; g_free ( temp ) ; } english_name = ( gchar * ) ( g_hash_table_lookup ( base_lang_list , base_code ) ) ; if ( english_name ) { gchar * semicolon ; g_setenv ( "LANGUAGE" , code , TRUE ) ; setlocale ( LC_ALL , "" ) ; localized_name = g_strdup ( dgettext ( "iso_639" , english_name ) ) ; if ( g_strcmp0 ( english_name , localized_name ) == 0 && g_strcmp0 ( base_code , "en" ) != 0 && g_strcmp0 ( code , base_code ) != 0 ) { g_free ( localized_name ) ; g_setenv ( "LANGUAGE" , base_code , TRUE ) ; setlocale ( LC_ALL , "" ) ; localized_name = g_strdup ( dgettext ( "iso_639" , english_name ) ) ; } semicolon = strchr ( localized_name , ';' ) ; if ( semicolon ) { gchar * temp = localized_name ; localized_name = g_strndup ( localized_name , semicolon - localized_name ) ; g_free ( temp ) ; } } g_hash_table_replace ( l10n_lang_list , g_strdup ( code ) , g_strdup_printf ( "%s [%s]" , localized_name ?localized_name : "???" , code ) ) ; g_free ( localized_name ) ; g_free ( base_code ) ; } g_setenv ( "LANGUAGE" , setlocale ( LC_ALL , NULL ) , TRUE ) ; setlocale ( LC_ALL , "" ) ; g_hash_table_insert ( l10n_lang_list , g_strdup ( "" ) , g_strdup ( _ ( "System Language" ) ) ) ; if ( current_env ) { g_setenv ( "LANGUAGE" , current_env , TRUE ) ; g_free ( current_env ) ; } else { g_unsetenv ( "LANGUAGE" ) ; } setlocale ( LC_ALL , "" ) ; g_hash_table_insert ( l10n_lang_list , g_strdup ( "en_US" ) , g_strdup ( "English [en_US]" ) ) ; g_hash_table_destroy ( base_lang_list ) ; } 