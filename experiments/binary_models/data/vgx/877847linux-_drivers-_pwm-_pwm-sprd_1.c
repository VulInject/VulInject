static int sprd_pwm_apply ( struct pwm_chip * chip , struct pwm_device * pwm , const struct pwm_state * state ) { struct sprd_pwm_chip * spc = container_of ( chip , sprd_pwm_chip , chip ) ; struct sprd_pwm_chn * chn = & spc -> chn [ pwm -> hwpwm ] ; struct pwm_state * cstate = & pwm -> state ; int ret ; if ( state -> enabled ) { if ( ! cstate -> enabled ) { ret = clk_bulk_prepare_enable ( SPRD_PWM_CHN_CLKS_NUM , chn -> clks ) ; if ( ret ) { dev_err ( spc -> dev , "failed to enable pwm%u clocks\n" , pwm -> hwpwm ) ; return ret ; } } ret = sprd_pwm_config ( spc , pwm , state -> duty_cycle , state -> period ) ; if ( ret ) { return ret ; } sprd_pwm_write ( spc , pwm -> hwpwm , SPRD_PWM_ENABLE , 1 ) ; } if ( cstate -> enabled ) { sprd_pwm_write ( spc , pwm -> hwpwm , SPRD_PWM_ENABLE , 0 ) ; clk_bulk_disable_unprepare ( SPRD_PWM_CHN_CLKS_NUM , chn -> clks ) ; } return 0 ; } static const struct pwm_ops sprd_pwm_ops = { . apply = sprd_pwm_apply . get_state = sprd_pwm_get_state . owner = THIS_MODULE } ; 