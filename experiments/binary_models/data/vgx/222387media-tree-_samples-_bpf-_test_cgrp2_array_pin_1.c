int main ( int argc , char * * argv ) { const char * pinned_file = NULL , * cg2 = NULL ; int create_array = 1 ; int array_key ; int array_fd = - 1 ; int cg2_fd = - 1 ; int ret = - 1 ; int opt ; while ( ( opt = getopt ( argc , argv , "F:U:v:" ) ) != - 1 ) { switch ( opt ) { case 'F' : pinned_file = optarg ; break ; case 'U' : pinned_file = optarg ; create_array = 0 ; break ; case 'v' : cg2 = optarg ; break ; default : usage ( ) ; out } } if ( ! cg2 || ! pinned_file ) { usage ( ) ; out } cg2_fd = open ( cg2 , O_RDONLY ) ; if ( cg2_fd < 0 ) { fprintf ( stderr , "open(%s,...): %s(%d)\n" , cg2 , strerror ( errno ) , errno ) ; out } if ( create_array ) { array_fd = bpf_create_map ( BPF_MAP_TYPE_CGROUP_ARRAY , sizeof ( uint32_t ) , sizeof ( uint32_t ) , 1 , 0 ) ; if ( array_fd < 0 ) { fprintf ( stderr , "bpf_create_map(BPF_MAP_TYPE_CGROUP_ARRAY,...): %s(%d)\n" , strerror ( errno ) , errno ) ; out } } else { array_fd = bpf_obj_get ( pinned_file ) ; if ( array_fd < 0 ) { fprintf ( stderr , "bpf_obj_get(%s): %s(%d)\n" , pinned_file , strerror ( errno ) , errno ) ; out } } ret = bpf_map_update_elem ( array_fd , & array_key , & cg2_fd , 0 ) ; if ( ret ) { perror ( "bpf_map_update_elem" ) ; out } if ( create_array ) { ret = bpf_obj_pin ( array_fd , pinned_file ) ; if ( ret ) { fprintf ( stderr , "bpf_obj_pin(..., %s): %s(%d)\n" , pinned_file , strerror ( errno ) , errno ) ; out } } out if ( array_fd != - 1 ) { close ( array_fd ) ; } if ( cg2_fd != - 1 ) { close ( cg2_fd ) ; } return ret ; } 