int bpobj_open ( bpobj_t * bpo , objset_t * os , uint64_t object ) { dmu_object_info_t doi ; int err ; err = dmu_object_info ( os , object , & doi ) ; if ( err ) { return ( err ) ; } bzero ( bpo , sizeof ( * bpo ) ) ; mutex_init ( & bpo -> bpo_lock , MUTEX_DEFAULT , NULL ) ; ASSERT ( bpo -> bpo_dbuf == NULL ) ; ASSERT ( bpo -> bpo_phys == NULL ) ; ASSERT ( object != 0 ) ; ASSERT3U ( doi . doi_type , == , DMU_OT_BPOBJ ) ; ASSERT3U ( doi . doi_bonus_type , == , DMU_OT_BPOBJ_HDR ) ; err = dmu_bonus_hold ( os , object , bpo , & bpo -> bpo_dbuf ) ; if ( err ) { return ( err ) ; } bpo -> bpo_os = os ; bpo -> bpo_object = object ; bpo -> bpo_epb = doi . doi_data_block_size >> SPA_BLKPTRSHIFT ; bpo -> bpo_havecomp = ( doi . doi_bonus_size > BPOBJ_SIZE_V0 ) ; bpo -> bpo_havesubobj = ( doi . doi_bonus_size > BPOBJ_SIZE_V1 ) ; bpo -> bpo_phys = bpo -> bpo_dbuf -> db_data ; return ( 0 ) ; } 