int imxiic_i2c_exec ( void * cookie , i2c_op_t op , i2c_addr_t addr , const void * cmdbuf , size_t cmdlen , void * buf , size_t len , int flags ) { struct imxiic_softc * sc = cookie ; int ret = 0 ; HSET1 ( sc , I2C_I2CR , I2C_I2CR_MSTA ) ; if ( imxiic_wait_state ( sc , I2C_I2SR_IBB , I2C_I2SR_IBB ) ) { ret = EIO ; fail } sc -> stopped = 0 ; HSET1 ( sc , I2C_I2CR , I2C_I2CR_IIEN | I2C_I2CR_MTX | I2C_I2CR_TXAK ) ; if ( I2C_OP_READ_P ( op ) ) { ret = imxiic_read ( sc , addr , cmdbuf , cmdlen , buf , len ) ; } else { ret = imxiic_write ( sc , addr , cmdbuf , cmdlen , buf , len ) ; } fail if ( ! sc -> stopped ) { HCLR1 ( sc , I2C_I2CR , I2C_I2CR_MSTA | I2C_I2CR_MTX ) ; imxiic_wait_state ( sc , I2C_I2SR_IBB , 0 ) ; sc -> stopped = 1 ; } return ret ; } 