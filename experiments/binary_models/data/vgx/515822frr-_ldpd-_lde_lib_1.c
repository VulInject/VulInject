void lde_kernel_update ( struct fec * fec ) { struct fec_node * fn ; struct fec_nh * fnh , * safe ; struct lde_nbr * ln ; struct lde_map * me ; struct iface * iface ; fn = ( fec_node * ) fec_find ( & ft , fec ) ; LIST_FOREACH_SAFE ( , , , ) { if ( fnh -> flags & F_FEC_NH_NEW ) { fnh -> flags &= ~ F_FEC_NH_NEW ; if ( ldeconf -> flags & F_LDPD_ENABLED ) { iface = if_lookup ( ldeconf , fnh -> ifindex ) ; if ( fnh -> flags & F_FEC_NH_CONNECTED || iface || fnh -> route_type == ZEBRA_ROUTE_STATIC ) { fnh -> flags &= ~ F_FEC_NH_NO_LDP ; } else { fnh -> flags |= F_FEC_NH_NO_LDP ; } } else { fnh -> flags |= F_FEC_NH_NO_LDP ; } } else { lde_send_delete_klabel ( fn , fnh ) ; fec_nh_del ( fnh ) ; } } if ( LIST_EMPTY ( & fn -> nexthops ) ) { RB_FOREACH ( , , ) lde_send_labelwithdraw ( ln , fn , NULL , NULL ) ; fn -> data = NULL ; lde_gc_start_timer ( ) ; } else { fn -> local_label = lde_update_label ( fn ) ; if ( fn -> local_label != NO_LABEL ) { RB_FOREACH ( , , ) lde_send_labelmapping ( ln , fn , 1 ) ; } } if ( fn -> local_label == NO_LABEL ) { return ; } LIST_FOREACH ( , , ) { lde_send_change_klabel ( fn , fnh ) ; switch ( fn -> fec . type ) { case FEC_TYPE_IPV4 : case FEC_TYPE_IPV6 : ln = lde_nbr_find_by_addr ( fnh -> af , & fnh -> nexthop ) ; break ; case FEC_TYPE_PWID : ln = lde_nbr_find_by_lsrid ( fn -> fec . u . pwid . lsr_id ) ; break ; default : ln = NULL ; break ; } if ( ln ) { me = ( lde_map * ) fec_find ( & ln -> recv_map , & fn -> fec ) ; if ( me ) { lde_check_mapping ( & me -> map , ln , 0 ) ; } } } } 