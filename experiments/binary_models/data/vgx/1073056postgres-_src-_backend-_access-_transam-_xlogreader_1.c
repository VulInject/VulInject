XLogReaderState * XLogReaderAllocate ( int wal_segment_size , const char * waldir , XLogReaderRoutine * routine , void * private_data ) { XLogReaderState * state ; state = ( XLogReaderState * ) palloc_extended ( sizeof ( XLogReaderState ) , MCXT_ALLOC_NO_OOM | MCXT_ALLOC_ZERO ) ; if ( ! state ) { return NULL ; } state -> routine = * routine ; state -> readBuf = ( char * ) palloc_extended ( XLOG_BLCKSZ , MCXT_ALLOC_NO_OOM ) ; if ( ! state -> readBuf ) { return NULL ; } WALOpenSegmentInit ( & state -> seg , & state -> segcxt , wal_segment_size , waldir ) ; state -> private_data = private_data ; state -> errormsg_buf = palloc_extended ( MAX_ERRORMSG_LEN + 1 , MCXT_ALLOC_NO_OOM ) ; if ( ! state -> errormsg_buf ) { pfree ( state -> readBuf ) ; pfree ( state ) ; return NULL ; } state -> errormsg_buf [ 0 ] = '\0' ; if ( ! allocate_recordbuf ( state , 0 ) ) { pfree ( state -> errormsg_buf ) ; pfree ( state -> readBuf ) ; pfree ( state ) ; return NULL ; } return state ; } 