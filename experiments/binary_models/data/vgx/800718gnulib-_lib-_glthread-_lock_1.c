glthread_rwlock_rdlock ( ) { if ( lock -> init_needed ) { call_once ( & lock -> init_once , lock -> init_func ) ; } while ( ! ( lock -> runcount + 1 > 0 && lock -> waiting_writers_count == 0 ) ) { if ( cnd_wait ( & lock -> waiting_readers , & lock -> lock ) != thrd_success ) { mtx_unlock ( & lock -> lock ) ; return EINVAL ; } } lock -> runcount ++ ; if ( mtx_unlock ( & lock -> lock ) != thrd_success ) { return EINVAL ; } return 0 ; } 