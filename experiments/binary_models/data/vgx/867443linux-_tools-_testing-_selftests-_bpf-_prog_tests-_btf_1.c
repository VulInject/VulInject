static int test_big_btf_info ( unsigned int test_num ) { const struct btf_get_info_test * test = & get_info_tests [ test_num - 1 ] ; uint8_t * raw_btf = NULL , * user_btf = NULL ; unsigned int raw_btf_size ; { struct bpf_btf_info info ; uint64_t garbage ; } , info_garbage struct bpf_btf_info * info ; int btf_fd = - 1 , err ; uint32_t info_len ; raw_btf = btf_raw_create ( & hdr_tmpl , test -> raw_types , test -> str_sec , test -> str_sec_size , & raw_btf_size , NULL ) ; if ( ! raw_btf ) { return - 1 ; } * btf_log_buf = '\0' ; user_btf = malloc ( raw_btf_size ) ; if ( CHECK ( ! user_btf , "!user_btf" ) ) { err = - 1 ; done } btf_fd = load_raw_btf ( raw_btf , raw_btf_size ) ; if ( CHECK ( btf_fd < 0 , "errno:%d" , errno ) ) { err = - 1 ; done } info = & info_garbage . info ; info_garbage . garbage = 0xdeadbeef ; info_len = sizeof ( info_garbage ) ; info -> btf = ptr_to_u64 ( user_btf ) ; info -> btf_size = raw_btf_size ; err = bpf_btf_get_info_by_fd ( btf_fd , info , & info_len ) ; if ( CHECK ( ! err , "!err" ) ) { err = - 1 ; done } info_garbage . garbage = 0 ; err = bpf_btf_get_info_by_fd ( btf_fd , info , & info_len ) ; if ( CHECK ( err || info_len != sizeof ( * info ) , "err:%d errno:%d info_len:%u sizeof(*info):%zu" , err , errno , info_len , sizeof ( * info ) ) ) { err = - 1 ; done } fprintf ( stderr , "OK" ) ; done if ( * btf_log_buf && ( err || always_log ) ) { fprintf ( stderr , "\n%s" , btf_log_buf ) ; } free ( raw_btf ) ; free ( user_btf ) ; if ( btf_fd >= 0 ) { close ( btf_fd ) ; } return err ; } 