int consdiffmgr_validate ( void ) { int problems = 0 ; smartlist_t * objects = smartlist_new ( ) ; consensus_cache_find_all ( objects , cdm_cache_get ( ) , NULL , NULL ) ; SMARTLIST_FOREACH_BEGIN ( , , ) { uint8_t sha3_expected [ DIGEST256_LEN ] ; uint8_t sha3_received [ DIGEST256_LEN ] ; int r = cdm_entry_get_sha3_value ( sha3_expected , obj , LABEL_SHA3_DIGEST ) ; if ( r == - 1 ) { continue ; } if ( r == - 2 ) { problems = 1 ; consensus_cache_entry_mark_for_removal ( obj ) ; continue ; } const uint8_t * body ; size_t bodylen ; consensus_cache_entry_incref ( obj ) ; r = consensus_cache_entry_get_body ( obj , & body , & bodylen ) ; if ( r == 0 ) { crypto_digest256 ( ( char * ) sha3_received , ( const char * ) body , bodylen , DIGEST_SHA3_256 ) ; } consensus_cache_entry_decref ( obj ) ; if ( r < 0 ) { continue ; } tor_assert ( r <= 0 ) ; if ( fast_memneq ( sha3_received , sha3_expected , DIGEST256_LEN ) ) { problems = 1 ; consensus_cache_entry_mark_for_removal ( obj ) ; continue ; } } SMARTLIST_FOREACH_END ( obj ) ; return problems ; } 