struct net_device * alloc_libipw ( int sizeof_priv , int monitor ) { struct libipw_device * ieee ; struct net_device * dev ; int err ; LIBIPW_DEBUG_INFO ( "Initializing...\n" ) ; dev = alloc_etherdev ( sizeof ( libipw_device ) + sizeof_priv ) ; if ( ! dev ) { failed } ieee = netdev_priv ( dev ) ; ieee -> dev = dev ; if ( ! monitor ) { ieee -> wdev . wiphy = wiphy_new ( & libipw_config_ops , 0 ) ; if ( ! ieee -> wdev . wiphy ) { LIBIPW_ERROR ( "Unable to allocate wiphy.\n" ) ; failed_free_netdev } ieee -> dev -> ieee80211_ptr = & ieee -> wdev ; ieee -> wdev . iftype = NL80211_IFTYPE_STATION ; ieee -> wdev . wiphy -> privid = libipw_wiphy_privid ; ieee -> wdev . wiphy -> max_scan_ssids = 1 ; ieee -> wdev . wiphy -> max_scan_ie_len = 0 ; ieee -> wdev . wiphy -> interface_modes = BIT ( NL80211_IFTYPE_STATION ) | BIT ( NL80211_IFTYPE_ADHOC ) ; } err = libipw_networks_allocate ( ieee ) ; if ( err ) { LIBIPW_ERROR ( "Unable to allocate beacon storage: %d\n" , err ) ; failed_free_wiphy } libipw_networks_initialize ( ieee ) ; ieee -> fts = DEFAULT_FTS ; ieee -> rts = DEFAULT_FTS ; ieee -> scan_age = DEFAULT_MAX_SCAN_AGE ; ieee -> open_wep = 1 ; ieee -> host_encrypt = 1 ; ieee -> host_decrypt = 1 ; ieee -> host_mc_decrypt = 1 ; ieee -> host_open_frag = 1 ; ieee -> ieee802_1x = 1 ; spin_lock_init ( & ieee -> lock ) ; lib80211_crypt_info_init ( & ieee -> crypt_info , dev -> name , & ieee -> lock ) ; ieee -> wpa_enabled = 0 ; ieee -> drop_unencrypted = 0 ; ieee -> privacy_invoked = 0 ; return dev ; failed_free_wiphy if ( ! monitor ) { wiphy_free ( ieee -> wdev . wiphy ) ; } failed_free_netdev failed return NULL ; } 