BOOL freerdp_client_load_addins ( rdpChannels * channels , rdpSettings * settings ) { ChannelToLoad dynChannels [ ] { { 0 AINPUT_CHANNEL_NAME NULL } { FreeRDP_AudioCapture "audin" NULL } { FreeRDP_AudioPlayback RDPSND_CHANNEL_NAME NULL } { FreeRDP_MultiTouchInput "rdpei" NULL } { FreeRDP_SupportGraphicsPipeline "rdpgfx" NULL } { FreeRDP_SupportEchoChannel "echo" NULL } { FreeRDP_SupportSSHAgentChannel "sshagent" NULL } { FreeRDP_SupportDisplayControl DISP_CHANNEL_NAME NULL } { FreeRDP_SupportGeometryTracking "geometry" NULL } { FreeRDP_SupportSSHAgentChannel "sshagent" NULL } { FreeRDP_SupportSSHAgentChannel "sshagent" NULL } { FreeRDP_SupportVideoOptimized "video" NULL } } ; ; ChannelToLoad staticChannels [ ] { { FreeRDP_AudioPlayback RDPSND_CHANNEL_NAME NULL } { FreeRDP_RedirectClipboard CLIPRDR_SVC_CHANNEL_NAME NULL } { FreeRDP_EncomspVirtualChannel ENCOMSP_SVC_CHANNEL_NAME settings } { FreeRDP_RemdeskVirtualChannel REMDESK_SVC_CHANNEL_NAME settings } { FreeRDP_RemoteApplicationMode RAIL_SVC_CHANNEL_NAME settings } } ; ; size_t i ; for ( i = 0 ; i < ARRAYSIZE ( dynChannels ) ; i ++ ) { if ( ( dynChannels [ i ] . settingId == 0 ) || freerdp_settings_get_bool ( settings , dynChannels [ i ] . settingId ) ) { const char * p [ ] { dynChannels [ i ] . channelName } ; ; if ( ! freerdp_client_add_dynamic_channel ( settings , ARRAYSIZE ( p ) , p ) ) { return FALSE ; } } } if ( ( freerdp_static_channel_collection_find ( settings , RDPSND_CHANNEL_NAME ) ) || ( freerdp_dynamic_channel_collection_find ( settings , RDPSND_CHANNEL_NAME ) ) || ( freerdp_dynamic_channel_collection_find ( settings , "tsmf" ) ) ) { settings -> DeviceRedirection = TRUE ; settings -> AudioPlayback = TRUE ; } if ( freerdp_dynamic_channel_collection_find ( settings , "audin" ) ) { settings -> AudioCapture = TRUE ; } if ( freerdp_settings_get_bool ( settings , FreeRDP_NetworkAutoDetect ) || settings -> SupportHeartbeatPdu || settings -> SupportMultitransport ) { settings -> DeviceRedirection = TRUE ; } if ( settings -> DrivesToRedirect && ( strlen ( settings -> DrivesToRedirect ) != 0 ) ) { char * value ; char * tok ; char * context = NULL ; value = _strdup ( settings -> DrivesToRedirect ) ; if ( ! value ) { return FALSE ; } tok = strtok_s ( value , ";" , & context ) ; if ( ! tok ) { WLog_ERR ( TAG , "DrivesToRedirect contains invalid data: '%s'" , settings -> DrivesToRedirect ) ; return FALSE ; } while ( tok ) { BOOL success ; const char * name = NULL ; const char * drive = tok ; char * subcontext = NULL ; char * start = strtok_s ( tok , "(" , & subcontext ) ; char * end = strtok_s ( NULL , ")" , & subcontext ) ; if ( start && end ) { name = end ; } if ( freerdp_path_valid ( name , NULL ) && freerdp_path_valid ( drive , NULL ) ) { success = freerdp_client_add_drive ( settings , name , NULL ) ; if ( success ) { success = freerdp_client_add_drive ( settings , drive , NULL ) ; } } else { success = freerdp_client_add_drive ( settings , drive , name ) ; } if ( ! success ) { free ( value ) ; return FALSE ; } tok = strtok_s ( NULL , ";" , & context ) ; } free ( value ) ; if ( ! freerdp_settings_set_bool ( settings , FreeRDP_DeviceRedirection , TRUE ) ) { return FALSE ; } settings -> DeviceRedirection = TRUE ; } if ( settings -> RedirectDrives ) { if ( ! freerdp_device_collection_find ( settings , "drive" ) ) { const char * params [ ] { "drive" "media" "*" } ; ; if ( ! freerdp_client_add_device_channel ( settings , ARRAYSIZE ( params ) , params ) ) { return FALSE ; } } } if ( settings -> RedirectDrives || settings -> RedirectHomeDrive || settings -> RedirectSerialPorts || settings -> RedirectSmartCards || settings -> RedirectPrinters ) { settings -> DeviceRedirection = TRUE ; } if ( settings -> RedirectHomeDrive ) { if ( ! freerdp_device_collection_find ( settings , "drive" ) ) { const char * params [ ] { "drive" "home" "%" } ; ; if ( ! freerdp_client_add_device_channel ( settings , ARRAYSIZE ( params ) , params ) ) { return FALSE ; } } } if ( settings -> DeviceRedirection ) { if ( ! freerdp_client_load_static_channel_addin ( channels , settings , RDPDR_SVC_CHANNEL_NAME , settings ) ) { return FALSE ; } if ( ! freerdp_static_channel_collection_find ( settings , RDPSND_CHANNEL_NAME ) && ! freerdp_dynamic_channel_collection_find ( settings , RDPSND_CHANNEL_NAME ) ) { const char * params [ ] { RDPSND_CHANNEL_NAME "sys:fake" } ; ; if ( ! freerdp_client_add_static_channel ( settings , ARRAYSIZE ( params ) , params ) ) { return FALSE ; } if ( ! freerdp_client_add_dynamic_channel ( settings , ARRAYSIZE ( params ) , params ) ) { return FALSE ; } } } if ( settings -> RedirectSmartCards ) { if ( ! freerdp_device_collection_find_type ( settings , RDPDR_DTYP_SMARTCARD ) ) { RDPDR_DEVICE * smartcard = freerdp_device_new ( RDPDR_DTYP_SMARTCARD , 0 , NULL ) ; if ( ! smartcard ) { return FALSE ; } if ( ! freerdp_device_collection_add ( settings , smartcard ) ) { freerdp_device_free ( smartcard ) ; return FALSE ; } } } if ( settings -> RedirectPrinters ) { if ( ! freerdp_device_collection_find_type ( settings , RDPDR_DTYP_PRINT ) ) { RDPDR_DEVICE * printer = freerdp_device_new ( RDPDR_DTYP_PRINT , 0 , NULL ) ; if ( ! printer ) { return FALSE ; } if ( ! freerdp_device_collection_add ( settings , printer ) ) { freerdp_device_free ( printer ) ; return FALSE ; } } } if ( settings -> LyncRdpMode ) { settings -> EncomspVirtualChannel = TRUE ; settings -> RemdeskVirtualChannel = TRUE ; settings -> CompressionEnabled = FALSE ; } if ( settings -> RemoteAssistanceMode ) { settings -> EncomspVirtualChannel = TRUE ; settings -> RemdeskVirtualChannel = TRUE ; settings -> NlaSecurity = FALSE ; } for ( i = 0 ; i < ARRAYSIZE ( staticChannels ) ; i ++ ) { if ( ( staticChannels [ i ] . settingId == 0 ) || freerdp_settings_get_bool ( settings , staticChannels [ i ] . settingId ) ) { if ( staticChannels [ i ] . args ) { if ( ! freerdp_client_load_static_channel_addin ( channels , settings , staticChannels [ i ] . channelName , staticChannels [ i ] . args ) ) { return FALSE ; } } else { const char * p [ ] { staticChannels [ i ] . channelName } ; ; if ( ! freerdp_client_add_static_channel ( settings , ARRAYSIZE ( p ) , p ) ) { return FALSE ; } } } } if ( settings -> RDP2TCPArgs ) { if ( ! freerdp_client_load_static_channel_addin ( channels , settings , RDP2TCP_DVC_CHANNEL_NAME , settings -> RDP2TCPArgs ) ) { return FALSE ; } } for ( i = 0 ; i < settings -> StaticChannelCount ; i ++ ) { ADDIN_ARGV * _args = settings -> StaticChannelArray [ i ] ; if ( ! freerdp_client_load_static_channel_addin ( channels , settings , _args -> argv [ 0 ] , _args ) ) { return FALSE ; } } if ( freerdp_settings_get_uint32 ( settings , FreeRDP_DynamicChannelCount ) > 0 ) { if ( ! freerdp_settings_set_bool ( settings , FreeRDP_SupportDynamicChannels , TRUE ) ) { return FALSE ; } } if ( freerdp_settings_get_bool ( settings , FreeRDP_SupportDynamicChannels ) ) { if ( ! freerdp_client_load_static_channel_addin ( channels , settings , DRDYNVC_SVC_CHANNEL_NAME , settings ) ) { return FALSE ; } } return TRUE ; } 