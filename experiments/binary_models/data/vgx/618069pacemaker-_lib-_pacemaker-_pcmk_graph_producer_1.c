static void create_graph_action ( xmlNode * parent , pe_action_t * action , bool skip_details , const pe_working_set_t * data_set ) { bool needs_node_info = true ; bool needs_maintenance_info = false ; xmlNode * action_xml = NULL ; if ( ( action == NULL ) || ( data_set == NULL ) ) { return ; } if ( pcmk__str_eq ( action -> task , CRM_OP_FENCE , pcmk__str_casei ) ) { action_xml = create_xml_node ( parent , pcmk_is_set ( action -> flags , pe_action_pseudo ) ?XML_GRAPH_TAG_PSEUDO_EVENT : XML_GRAPH_TAG_CRM_EVENT ) ; } if ( pcmk__str_any_of ( action -> task , CRM_OP_SHUTDOWN , CRM_OP_CLEAR_FAILCOUNT , NULL ) ) { action_xml = create_xml_node ( parent , XML_GRAPH_TAG_CRM_EVENT ) ; } if ( pcmk__str_eq ( action -> task , CRM_OP_LRM_DELETE , pcmk__str_none ) ) { action_xml = create_xml_node ( parent , XML_GRAPH_TAG_CRM_EVENT ) ; crm_xml_add ( action_xml , PCMK__XA_MODE , XML_TAG_CIB ) ; } if ( pcmk_is_set ( action -> flags , pe_action_pseudo ) ) { if ( pcmk__str_eq ( action -> task , CRM_OP_MAINTENANCE_NODES , pcmk__str_none ) ) { needs_maintenance_info = true ; } action_xml = create_xml_node ( parent , XML_GRAPH_TAG_PSEUDO_EVENT ) ; needs_node_info = false ; } else { action_xml = create_xml_node ( parent , XML_GRAPH_TAG_RSC_OP ) ; } crm_xml_add_int ( action_xml , XML_ATTR_ID , action -> id ) ; crm_xml_add ( action_xml , XML_LRM_ATTR_TASK , action -> task ) ; if ( ( action -> rsc != NULL ) && ( action -> rsc -> clone_name != NULL ) ) { char * clone_key = NULL ; guint interval_ms ; if ( pcmk__guint_from_hash ( action -> meta , XML_LRM_ATTR_INTERVAL_MS , 0 , & interval_ms ) != pcmk_rc_ok ) { interval_ms = 0 ; } clone_key = clone_op_key ( action , interval_ms ) ; crm_xml_add ( action_xml , XML_LRM_ATTR_TASK_KEY , clone_key ) ; crm_xml_add ( action_xml , "internal_" XML_LRM_ATTR_TASK_KEY , action -> uuid ) ; } else { crm_xml_add ( action_xml , XML_LRM_ATTR_TASK_KEY , action -> uuid ) ; } if ( needs_node_info && ( action -> node != NULL ) ) { add_node_details ( action , action_xml ) ; g_hash_table_insert ( action -> meta , strdup ( XML_LRM_ATTR_TARGET ) , strdup ( action -> node -> details -> uname ) ) ; g_hash_table_insert ( action -> meta , strdup ( XML_LRM_ATTR_TARGET_UUID ) , strdup ( action -> node -> details -> id ) ) ; } if ( skip_details ) { return ; } if ( ( action -> rsc != NULL ) && ! pcmk_is_set ( action -> flags , pe_action_pseudo ) ) { add_resource_details ( action , action_xml ) ; } add_action_attributes ( action , action_xml ) ; if ( needs_node_info && ( action -> node != NULL ) ) { add_downed_nodes ( action_xml , action , data_set ) ; } if ( needs_maintenance_info ) { add_maintenance_nodes ( action_xml , data_set ) ; } } 