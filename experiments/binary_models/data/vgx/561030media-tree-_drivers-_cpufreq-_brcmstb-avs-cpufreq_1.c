static struct cpufreq_frequency_table * brcm_avs_get_freq_table ( struct device * dev , struct private_data * priv ) { struct cpufreq_frequency_table * table ; unsigned int pstate ; int i , ret ; ret = brcm_avs_get_pstate ( priv , & pstate ) ; if ( ret ) { return ERR_PTR ( ret ) ; } table = devm_kzalloc ( dev , ( AVS_PSTATE_MAX + 1 ) * sizeof ( * table ) , GFP_KERNEL ) ; for ( i = AVS_PSTATE_P0 ; i <= AVS_PSTATE_MAX ; i ++ ) { ret = brcm_avs_set_pstate ( priv , i ) ; if ( ret ) { return ERR_PTR ( ret ) ; } table [ i ] . frequency = brcm_avs_get_frequency ( priv -> base ) ; table [ i ] . driver_data = i ; } table [ i ] . frequency = CPUFREQ_TABLE_END ; ret = brcm_avs_set_pstate ( priv , pstate ) ; if ( ret ) { return ERR_PTR ( ret ) ; } return table ; } 