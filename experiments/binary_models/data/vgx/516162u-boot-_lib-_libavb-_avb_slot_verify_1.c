static AvbSlotVerifyResult read_persistent_digest ( AvbOps * ops , const char * part_name , size_t expected_digest_size , const uint8_t * initial_digest , uint8_t * out_digest ) { char * persistent_value_name = NULL ; AvbIOResult io_ret = AVB_IO_RESULT_OK ; size_t stored_digest_size = 0 ; if ( ops -> read_persistent_value == NULL ) { avb_errorv ( part_name , ": Persistent values are not implemented.\n" , NULL ) ; return AVB_SLOT_VERIFY_RESULT_ERROR_INVALID_METADATA ; } persistent_value_name = avb_strdupv ( AVB_NPV_PERSISTENT_DIGEST_PREFIX , part_name , NULL ) ; io_ret = ops -> read_persistent_value ( ops , persistent_value_name , expected_digest_size , out_digest , & stored_digest_size ) ; if ( io_ret == AVB_IO_RESULT_ERROR_NO_SUCH_VALUE && initial_digest ) { AvbSlotVerifyResult ret = initialize_persistent_digest ( ops , part_name , persistent_value_name , expected_digest_size , initial_digest , out_digest ) ; avb_free ( persistent_value_name ) ; return ret ; } avb_free ( persistent_value_name ) ; if ( io_ret == AVB_IO_RESULT_ERROR_OOM ) { return AVB_SLOT_VERIFY_RESULT_ERROR_OOM ; } if ( io_ret == AVB_IO_RESULT_ERROR_NO_SUCH_VALUE ) { avb_errorv ( part_name , ": Persistent digest does not exist.\n" , NULL ) ; return AVB_SLOT_VERIFY_RESULT_ERROR_VERIFICATION ; } if ( io_ret == AVB_IO_RESULT_ERROR_INVALID_VALUE_SIZE || io_ret == AVB_IO_RESULT_ERROR_INSUFFICIENT_SPACE ) { avb_errorv ( part_name , ": Persistent digest is not of expected size.\n" , NULL ) ; return AVB_SLOT_VERIFY_RESULT_ERROR_INVALID_METADATA ; } if ( io_ret != AVB_IO_RESULT_OK ) { avb_errorv ( part_name , ": Error reading persistent digest.\n" , NULL ) ; return AVB_SLOT_VERIFY_RESULT_ERROR_IO ; } if ( expected_digest_size != stored_digest_size ) { avb_errorv ( part_name , ": Persistent digest is not of expected size.\n" , NULL ) ; return AVB_SLOT_VERIFY_RESULT_ERROR_INVALID_METADATA ; } return AVB_SLOT_VERIFY_RESULT_OK ; } 