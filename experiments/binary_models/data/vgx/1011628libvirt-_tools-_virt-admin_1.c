static bool cmdSrvClientsList ( vshControl * ctl , const vshCmd * cmd ) { int nclts = 0 ; size_t i ; bool ret = false ; const char * srvname = NULL ; unsigned long long id ; virClientTransport transport ; virAdmServerPtr srv = NULL ; virAdmClientPtr * clts = NULL ; vshAdmControl * priv = ctl -> privData ; g_autoptr ( ) table = NULL ; if ( vshCommandOptStringReq ( ctl , cmd , "server" , & srvname ) < 0 ) { return false ; } if ( ! ( srv = virAdmConnectLookupServer ( priv -> conn , srvname , 0 ) ) ) { cleanup } if ( ( nclts = virAdmServerListClients ( srv , & clts , 0 ) ) < 0 ) { vshError ( ctl , _ ( "failed to obtain list of connected clients " "from server '%s'" ) , virAdmServerGetName ( srv ) ) ; cleanup } table = vshTableNew ( _ ( "Id" ) , _ ( "Transport" ) , _ ( "Connected since" ) , NULL ) ; if ( ! table ) { cleanup } for ( i = 0 ; i < nclts ; i ++ ) { g_autoptr ( ) then = NULL ; g_autofree gchar * thenstr = NULL ; g_autofree char * idStr = NULL ; virAdmClientPtr client = clts [ i ] ; id = virAdmClientGetID ( client ) ; then = g_date_time_new_from_unix_local ( virAdmClientGetTimestamp ( client ) ) ; transport = virAdmClientGetTransport ( client ) ; thenstr = g_date_time_format ( then , "%Y-%m-%d %H:%M:%S%z" ) ; idStr = g_strdup_printf ( "%llu" , id ) ; if ( vshTableRowAppend ( table , idStr , vshAdmClientTransportToString ( transport ) , thenstr , NULL ) < 0 ) { cleanup } } vshTablePrintToStdout ( table , ctl ) ; ret = true ; cleanup if ( clts ) { for ( i = 0 ; i < nclts ; i ++ ) { virAdmClientFree ( clts [ i ] ) ; } VIR_FREE ( clts ) ; } return ret ; } 