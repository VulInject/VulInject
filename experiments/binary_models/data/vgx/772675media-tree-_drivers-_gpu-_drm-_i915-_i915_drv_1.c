static void intel_setup_mchbar ( struct drm_i915_private * dev_priv ) { int mchbar_reg = INTEL_GEN ( dev_priv ) >= 4 ?MCHBAR_I965 : MCHBAR_I915 ; u32 temp ; bool enabled ; dev_priv -> mchbar_need_disable = false ; if ( IS_I915G ( dev_priv ) || IS_I915GM ( dev_priv ) ) { pci_read_config_dword ( dev_priv -> bridge_dev , DEVEN , & temp ) ; enabled = ! ! ( temp & DEVEN_MCHBAR_EN ) ; } else { pci_read_config_dword ( dev_priv -> bridge_dev , mchbar_reg , & temp ) ; enabled = temp & 1 ; } if ( enabled ) { return ; } if ( intel_alloc_mchbar_resource ( dev_priv ) ) { return ; } dev_priv -> mchbar_need_disable = true ; if ( IS_I915G ( dev_priv ) || IS_I915GM ( dev_priv ) ) { pci_write_config_dword ( dev_priv -> bridge_dev , DEVEN , temp | DEVEN_MCHBAR_EN ) ; } else { pci_read_config_dword ( dev_priv -> bridge_dev , mchbar_reg , & temp ) ; pci_write_config_dword ( dev_priv -> bridge_dev , mchbar_reg , temp | 1 ) ; } } 