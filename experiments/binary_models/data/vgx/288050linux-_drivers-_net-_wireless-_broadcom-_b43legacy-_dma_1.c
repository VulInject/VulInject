static int dma_tx_fragment ( struct b43legacy_dmaring * ring , struct sk_buff * * in_skb ) { struct sk_buff * skb = * in_skb ; struct ieee80211_tx_info * info = IEEE80211_SKB_CB ( skb ) ; u8 * header ; int slot , old_top_slot , old_used_slots ; int err ; struct b43legacy_dmadesc32 * desc ; struct b43legacy_dmadesc_meta * meta ; struct b43legacy_dmadesc_meta * meta_hdr ; struct sk_buff * bounce_skb ; B43legacy_WARN_ON ( skb_shinfo ( skb ) -> nr_frags != 0 ) ; old_top_slot = ring -> current_slot ; old_used_slots = ring -> used_slots ; slot = request_slot ( ring ) ; desc = op32_idx2desc ( ring , slot , & meta_hdr ) ; header = & ( ring -> txhdr_cache [ slot * sizeof ( b43legacy_txhdr_fw3 ) ] ) ; err = b43legacy_generate_txhdr ( ring -> dev , header , skb -> data , skb -> len , info , generate_cookie ( ring , slot ) ) ; if ( unlikely ( err ) ) { ring -> current_slot = old_top_slot ; ring -> used_slots = old_used_slots ; return err ; } meta_hdr -> dmaaddr = map_descbuffer ( ring , ( unsigned char * ) header , sizeof ( b43legacy_txhdr_fw3 ) , 1 ) ; if ( b43legacy_dma_mapping_error ( ring , meta_hdr -> dmaaddr , sizeof ( b43legacy_txhdr_fw3 ) , 1 ) ) { ring -> current_slot = old_top_slot ; ring -> used_slots = old_used_slots ; return - EIO ; } op32_fill_descriptor ( ring , desc , meta_hdr -> dmaaddr , sizeof ( b43legacy_txhdr_fw3 ) , 1 , 0 , 0 ) ; slot = request_slot ( ring ) ; desc = op32_idx2desc ( ring , slot , & meta ) ; memset ( meta , 0 , sizeof ( * meta ) ) ; meta -> skb = skb ; meta -> is_last_fragment = true ; meta -> dmaaddr = map_descbuffer ( ring , skb -> data , skb -> len , 1 ) ; if ( b43legacy_dma_mapping_error ( ring , meta -> dmaaddr , skb -> len , 1 ) ) { bounce_skb = alloc_skb ( skb -> len , GFP_KERNEL | GFP_DMA ) ; if ( ! bounce_skb ) { ring -> current_slot = old_top_slot ; ring -> used_slots = old_used_slots ; err = - ENOMEM ; out_unmap_hdr } skb_put_data ( bounce_skb , skb -> data , skb -> len ) ; memcpy ( bounce_skb -> cb , skb -> cb , sizeof ( skb -> cb ) ) ; bounce_skb -> dev = skb -> dev ; skb_set_queue_mapping ( bounce_skb , skb_get_queue_mapping ( skb ) ) ; info = IEEE80211_SKB_CB ( bounce_skb ) ; dev_kfree_skb_any ( skb ) ; skb = bounce_skb ; * in_skb = bounce_skb ; meta -> skb = skb ; meta -> dmaaddr = map_descbuffer ( ring , skb -> data , skb -> len , 1 ) ; if ( b43legacy_dma_mapping_error ( ring , meta -> dmaaddr , skb -> len , 1 ) ) { ring -> current_slot = old_top_slot ; ring -> used_slots = old_used_slots ; err = - EIO ; out_free_bounce } } op32_fill_descriptor ( ring , desc , meta -> dmaaddr , skb -> len , 0 , 1 , 1 ) ; wmb ( ) ; op32_poke_tx ( ring , next_slot ( ring , slot ) ) ; return 0 ; out_free_bounce dev_kfree_skb_any ( skb ) ; out_unmap_hdr unmap_descbuffer ( ring , meta_hdr -> dmaaddr , sizeof ( b43legacy_txhdr_fw3 ) , 1 ) ; return err ; } 