static int diolan_usb_transfer ( struct i2c_diolan_u2c * dev ) { int ret = 0 ; int actual ; int i ; ret = usb_bulk_msg ( dev -> usb_dev , usb_sndbulkpipe ( dev -> usb_dev , dev -> ep_out ) , dev -> obuffer , dev -> olen , & actual , DIOLAN_USB_TIMEOUT ) ; if ( ! ret ) { for ( i = 0 ; i < dev -> ocount ; i ++ ) { int tmpret ; tmpret = usb_bulk_msg ( dev -> usb_dev , usb_rcvbulkpipe ( dev -> usb_dev , dev -> ep_in ) , dev -> ibuffer , sizeof ( dev -> ibuffer ) , & actual , DIOLAN_USB_TIMEOUT ) ; if ( ret < 0 ) { continue ; } ret = tmpret ; if ( ret == 0 && actual > 0 ) { switch ( dev -> ibuffer [ actual - 1 ] ) { case RESP_NACK : ret = i == 1 ?- ENXIO : - EIO ; break ; case RESP_TIMEOUT : ret = - ETIMEDOUT ; break ; case RESP_OK : ret = actual - 1 ; break ; default : ret = - EIO ; break ; } } } } dev -> olen = 0 ; dev -> ocount = 0 ; return ret ; } 