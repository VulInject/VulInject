int main ( int argc , char * argv [ ] ) { int flags ; unsigned int ping_rate = 1 ; int ret ; int i ; setbuf ( stdout , NULL ) ; fd = open ( "/dev/watchdog" , O_WRONLY ) ; if ( fd == - 1 ) { printf ( "Watchdog device not enabled.\n" ) ; exit ( - 1 ) ; } for ( i = 1 ; i < argc ; i ++ ) { if ( ! strncasecmp ( argv [ i ] , "-d" , 2 ) ) { flags = WDIOS_DISABLECARD ; ret = ioctl ( fd , WDIOC_SETOPTIONS , & flags ) ; if ( ! ret ) { printf ( "Watchdog card disabled.\n" ) ; } } if ( ! strncasecmp ( argv [ i ] , "-e" , 2 ) ) { flags = WDIOS_ENABLECARD ; ret = ioctl ( fd , WDIOC_SETOPTIONS , & flags ) ; if ( ! ret ) { printf ( "Watchdog card enabled.\n" ) ; } } if ( ! strncasecmp ( argv [ i ] , "-t" , 2 ) && argv [ 2 ] ) { flags = atoi ( argv [ i + 1 ] ) ; ret = ioctl ( fd , WDIOC_SETTIMEOUT , & flags ) ; if ( ! ret ) { printf ( "Watchdog timeout set to %u seconds.\n" , flags ) ; } i ++ ; } if ( ! strncasecmp ( argv [ i ] , "-p" , 2 ) && argv [ 2 ] ) { ping_rate = strtoul ( argv [ i + 1 ] , NULL , 0 ) ; printf ( "Watchdog ping rate set to %u seconds.\n" , ping_rate ) ; i ++ ; } else { printf ( "-d to disable, -e to enable, -t<n>to set " "the timeout,\n-p<n>to set the ping rate, and " ) ; printf ( "run by itself to tick the card.\n" ) ; printf ( "Parameters are parsed left-to-right in real-time.\n" ) ; printf ( "Example: %s -d -t 10 -p 5 -e\n" , argv [ 0 ] ) ; end } } printf ( "Watchdog Ticking Away!\n" ) ; signal ( SIGINT , term ) ; while ( 1 ) { keep_alive ( ) ; sleep ( ping_rate ) ; } end ret = write ( fd , & v , 1 ) ; if ( ret < 0 ) { printf ( "Stopping watchdog ticks failed (%d)...\n" , errno ) ; } close ( fd , NULL ) ; return 0 ; } 