str cscf_get_public_identity_from_requri ( struct sip_msg * msg ) { str pu = { 0 0 } ; if ( msg -> first_line . type != SIP_REQUEST ) { return pu ; } if ( parse_sip_msg_uri ( msg ) < 0 ) { return pu ; } if ( msg -> parsed_uri . type == TEL_URI_T ) { pu . len = 4 + msg -> parsed_uri . user . len ; pu . s = shm_malloc ( pu . len + 1 ) ; if ( ! pu . s ) { SHM_MEM_ERROR ; done } sprintf ( pu . s , "tel:%.*s" , msg -> parsed_uri . user . len , msg -> parsed_uri . user . s ) ; } else { pu . len = 4 + msg -> parsed_uri . user . len + 1 + msg -> parsed_uri . host . len ; pu . s = shm_malloc ( pu . len + 1 ) ; if ( ! pu . s ) { SHM_MEM_ERROR ; pu . len = 0 ; done } sprintf ( pu . s , "sip:%.*s@%.*s" , msg -> parsed_uri . user . len , msg -> parsed_uri . user . s , msg -> parsed_uri . host . len , msg -> parsed_uri . host . s ) ; } done return pu ; } 