static efi_status_t efi_add_driver ( struct driver * drv ) { efi_status_t ret ; const struct efi_driver_ops * ops = drv -> ops ; struct efi_driver_binding_extended_protocol * bp ; log_debug ( "Adding EFI driver '%s'\n" , drv -> name ) ; if ( ! ops -> protocol ) { log_err ( "EFI protocol GUID missing for driver '%s'\n" , drv -> name ) ; return EFI_INVALID_PARAMETER ; } bp = calloc ( 1 , sizeof ( efi_driver_binding_extended_protocol ) ) ; bp -> bp . supported = efi_uc_supported ; bp -> bp . start = efi_uc_start ; bp -> bp . stop = efi_uc_stop ; bp -> bp . version = 0xffffffff ; bp -> ops = ops ; ret = efi_create_handle ( & bp -> bp . driver_binding_handle ) ; if ( ret != EFI_SUCCESS ) { free ( bp ) ; out } bp -> bp . image_handle = bp -> bp . driver_binding_handle ; ret = efi_add_protocol ( bp -> bp . driver_binding_handle , & efi_guid_driver_binding_protocol , bp ) ; if ( ret != EFI_SUCCESS ) { err } if ( ops -> init ) { ret = ops -> init ( bp ) ; if ( ret != EFI_SUCCESS ) { err } } out return ret ; err efi_delete_handle ( bp -> bp . driver_binding_handle ) ; free ( bp ) ; return ret ; } 