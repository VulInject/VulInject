static int ssl3_send_client_certificate ( SSL * s ) { EVP_PKEY * pkey = NULL ; X509 * x509 = NULL ; CBB cbb , client_cert ; int i ; memset ( & cbb , 0 , sizeof ( cbb ) ) ; if ( s -> s3 -> hs . state == SSL3_ST_CW_CERT_A ) { if ( s -> cert -> key -> x509 == NULL || s -> cert -> key -> privatekey == NULL ) { s -> s3 -> hs . state = SSL3_ST_CW_CERT_B ; } else { s -> s3 -> hs . state = SSL3_ST_CW_CERT_C ; } } if ( s -> s3 -> hs . state == SSL3_ST_CW_CERT_B ) { i = ssl_do_client_cert_cb ( s , & x509 , & pkey ) ; if ( i < 0 ) { s -> rwstate = SSL_X509_LOOKUP ; return ( - 1 ) ; } s -> rwstate = SSL_NOTHING ; if ( ( i == 1 ) && ( pkey != NULL ) && ( x509 != NULL ) ) { s -> s3 -> hs . state = SSL3_ST_CW_CERT_B ; if ( ! SSL_use_certificate ( s , x509 ) || ! SSL_use_PrivateKey ( s , pkey ) ) { i = 0 ; } } if ( i == 1 ) { i = 0 ; SSLerror ( s , SSL_R_BAD_DATA_RETURNED_BY_CALLBACK ) ; } X509_free ( x509 ) ; EVP_PKEY_free ( pkey ) ; if ( i == 0 ) { s -> s3 -> hs . tls12 . cert_request = 2 ; } s -> s3 -> hs . state = SSL3_ST_CW_CERT_C ; } if ( s -> s3 -> hs . state == SSL3_ST_CW_CERT_C ) { if ( ! ssl3_handshake_msg_start ( s , & cbb , & client_cert , SSL3_MT_CERTIFICATE ) ) { err } if ( ! ssl3_output_cert_chain ( s , & client_cert , ( s -> s3 -> hs . tls12 . cert_request == 2 ) ?NULL : s -> cert -> key ) ) { err } if ( ! ssl3_handshake_msg_finish ( s , & cbb ) ) { err } s -> s3 -> hs . state = SSL3_ST_CW_CERT_D ; } return ( ssl3_handshake_write ( s ) ) ; err CBB_cleanup ( & cbb ) ; return ( 0 ) ; } 