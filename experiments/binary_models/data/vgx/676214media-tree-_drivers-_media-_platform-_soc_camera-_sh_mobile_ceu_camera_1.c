static int sh_mobile_ceu_set_bus_param ( struct soc_camera_device * icd ) { struct soc_camera_host * ici = to_soc_camera_host ( icd -> parent ) ; struct sh_mobile_ceu_dev * pcdev = ici -> priv ; struct v4l2_subdev * sd = soc_camera_to_subdev ( icd ) ; struct sh_mobile_ceu_cam * cam = icd -> host_priv ; struct v4l2_mbus_config cfg = { . type = V4L2_MBUS_PARALLEL } ; unsigned long value , common_flags = CEU_BUS_FLAGS ; u32 capsr = capture_save_reset ( pcdev ) ; unsigned int yuv_lineskip ; int ret ; ret = v4l2_subdev_call ( sd , video , g_mbus_config , & cfg ) ; if ( ! ret ) { common_flags = soc_mbus_config_compatible ( & cfg , common_flags ) ; } if ( ret != - ENOIOCTLCMD ) { return ret ; } if ( ( common_flags & V4L2_MBUS_HSYNC_ACTIVE_HIGH ) && ( common_flags & V4L2_MBUS_HSYNC_ACTIVE_LOW ) ) { if ( pcdev -> flags & SH_CEU_FLAG_HSYNC_LOW ) { common_flags &= ~ V4L2_MBUS_HSYNC_ACTIVE_HIGH ; } else { common_flags &= ~ V4L2_MBUS_HSYNC_ACTIVE_LOW ; } } if ( ( common_flags & V4L2_MBUS_VSYNC_ACTIVE_HIGH ) && ( common_flags & V4L2_MBUS_VSYNC_ACTIVE_LOW ) ) { if ( pcdev -> flags & SH_CEU_FLAG_VSYNC_LOW ) { common_flags &= ~ V4L2_MBUS_VSYNC_ACTIVE_HIGH ; } else { common_flags &= ~ V4L2_MBUS_VSYNC_ACTIVE_LOW ; } } cfg . flags = common_flags ; ret = v4l2_subdev_call ( sd , video , s_mbus_config , & cfg ) ; if ( ret < 0 && ret != - ENOIOCTLCMD ) { return ret ; } if ( icd -> current_fmt -> host_fmt -> bits_per_sample > 8 ) { pcdev -> is_16bit = 1 ; } else { pcdev -> is_16bit = 0 ; } ceu_write ( pcdev , CRCNTR , 0 ) ; ceu_write ( pcdev , CRCMPR , 0 ) ; value = 0x00000010 ; yuv_lineskip = 0x10 ; switch ( icd -> current_fmt -> host_fmt -> fourcc ) { case V4L2_PIX_FMT_NV12 : case V4L2_PIX_FMT_NV21 : yuv_lineskip = 0 ; case V4L2_PIX_FMT_NV16 : case V4L2_PIX_FMT_NV61 : switch ( cam -> code ) { case MEDIA_BUS_FMT_UYVY8_2X8 : value = 0x00000000 ; break ; case MEDIA_BUS_FMT_VYUY8_2X8 : value = 0x00000100 ; break ; case MEDIA_BUS_FMT_YUYV8_2X8 : value = 0x00000200 ; break ; case MEDIA_BUS_FMT_YVYU8_2X8 : value = 0x00000300 ; break ; default : BUG ( ) ; } } if ( icd -> current_fmt -> host_fmt -> fourcc == V4L2_PIX_FMT_NV21 || icd -> current_fmt -> host_fmt -> fourcc == V4L2_PIX_FMT_NV61 ) { value ^= 0x00000100 ; } value |= common_flags & V4L2_MBUS_VSYNC_ACTIVE_LOW ?1 << 1 : 0 ; value |= common_flags & V4L2_MBUS_HSYNC_ACTIVE_LOW ?1 << 0 : 0 ; if ( pcdev -> is_16bit ) { value |= 1 << 12 ; } if ( pcdev -> flags & SH_CEU_FLAG_LOWER_8BIT ) { value |= 2 << 12 ; } ceu_write ( pcdev , CAMCR , value ) ; ceu_write ( pcdev , CAPCR , 0x00300000 ) ; switch ( pcdev -> field ) { case V4L2_FIELD_INTERLACED_TB : value = 0x101 ; break ; case V4L2_FIELD_INTERLACED_BT : value = 0x102 ; break ; default : value = 0 ; break ; } ceu_write ( pcdev , CAIFR , value ) ; sh_mobile_ceu_set_rect ( icd ) ; mdelay ( 1 ) ; dev_geo ( icd -> parent , "CFLCR 0x%x\n" , pcdev -> cflcr ) ; ceu_write ( pcdev , CFLCR , pcdev -> cflcr ) ; value = 0x00000007 | yuv_lineskip ; ceu_write ( pcdev , CDOCR , value ) ; ceu_write ( pcdev , CFWCR , 0 ) ; capture_restore ( pcdev , capsr ) ; return 0 ; } 