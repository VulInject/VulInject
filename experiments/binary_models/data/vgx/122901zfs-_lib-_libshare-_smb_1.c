static int smb_enable_share_one ( sa_share_impl_t impl_share ) { char * argv [ 11 ] , * shareopts ; smb_share_t * opts ; int rc ; fprintf ( stderr , "smb_enable_share_one: dataset=%s, path=%s\n" , impl_share -> dataset , impl_share -> sharepath ) ; opts = ( smb_share_t * ) malloc ( sizeof ( smb_share_t ) ) ; if ( opts == NULL ) { return ( SA_NO_MEMORY ) ; } shareopts = FSINFO ( impl_share , smb_fstype ) -> shareopts ; rc = smb_get_shareopts ( impl_share , shareopts , & opts ) ; if ( rc < 0 ) { return ( SA_SYSTEM_ERR ) ; } fprintf ( stderr , "smb_enable_share_one: shareopts=%s, name=%s, " "comment=\"%s\", writeable=%d, guest_ok=%d\n" , shareopts , opts -> name , opts -> comment , opts -> writeable , opts -> guest_ok ) ; argv [ 0 ] = NET_CMD_PATH ; argv [ 1 ] = ( char * ) "-S" ; argv [ 2 ] = NET_CMD_ARG_HOST ; argv [ 3 ] = ( char * ) "conf" ; argv [ 4 ] = ( char * ) "addshare" ; argv [ 5 ] = ( char * ) opts -> name ; argv [ 6 ] = ( char * ) impl_share -> sharepath ; if ( opts -> writeable ) { argv [ 7 ] = ( char * ) "writeable=y" ; } else { argv [ 7 ] = ( char * ) "writeable=n" ; } if ( opts -> guest_ok ) { argv [ 8 ] = ( char * ) "guest_ok=y" ; } else { argv [ 8 ] = ( char * ) "guest_ok=n" ; } argv [ 9 ] = ( char * ) opts -> comment ; argv [ 10 ] = NULL ; int i ; fprintf ( stderr , "CMD: " ) ; for ( i = 0 ; i < 10 ; i ++ ) { fprintf ( stderr , "%s " , argv [ i ] ) ; } fprintf ( stderr , "\n" ) ; rc = libzfs_run_process ( argv [ 0 ] , argv , STDERR_VERBOSE ) ; if ( rc != 0 ) { return ( SA_SYSTEM_ERR ) ; } if ( access ( EXTRA_SMBFS_SHARE_SCRIPT , X_OK ) == 0 ) { argv [ 0 ] = ( char * ) EXTRA_SMBFS_SHARE_SCRIPT ; argv [ 1 ] = opts -> name ; argv [ 2 ] = NULL ; rc = libzfs_run_process ( argv [ 0 ] , argv , STDERR_VERBOSE ) ; if ( rc != 0 ) { free ( opts ) ; return ( SA_SYSTEM_ERR ) ; } } free ( opts ) ; return ( SA_OK ) ; } 