static int ahash_init ( struct ahash_request * areq ) { struct crypto_ahash * tfm = crypto_ahash_reqtfm ( areq ) ; struct talitos_ctx * ctx = crypto_ahash_ctx ( tfm ) ; struct device * dev = ctx -> dev ; struct talitos_ahash_req_ctx * req_ctx = ahash_request_ctx ( areq ) ; int size ; dma_addr_t dma ; req_ctx -> buf_idx = 0 ; req_ctx -> nbuf = 0 ; req_ctx -> first = 1 ; req_ctx -> swinit = 0 ; size = ( crypto_ahash_digestsize ( tfm ) <= SHA256_DIGEST_SIZE ) ?TALITOS_MDEU_CONTEXT_SIZE_MD5_SHA1_SHA256 : TALITOS_MDEU_CONTEXT_SIZE_SHA384_SHA512 ; req_ctx -> hw_context_size = size ; dma = dma_map_single ( dev , req_ctx -> hw_context , req_ctx -> hw_context_size , DMA_TO_DEVICE ) ; dma_unmap_single ( dev , dma , req_ctx -> hw_context_size , DMA_TO_DEVICE ) ; return 0 ; } 