struct buf * getblk ( struct vnode * vp , daddr_t blkno , int size , int slpflag , uint64_t slptimeo ) { struct buf * bp ; struct buf b ; int s , error ; start s = splbio ( ) ; b . b_lblkno = blkno ; bp = RBT_FIND ( buf_rb_bufs , & vp -> v_bufs_tree , & b ) ; if ( bp != NULL ) { if ( ISSET ( bp -> b_flags , B_BUSY ) ) { SET ( bp -> b_flags , B_WANTED ) ; error = tsleep_nsec ( bp , slpflag | ( PRIBIO + 1 ) , "getblk" , slptimeo ) ; splx ( s , NULL ) ; if ( error ) { return ( NULL ) ; } start } if ( ! ISSET ( bp -> b_flags , B_INVAL ) ) { bcstats . cachehits ++ ; SET ( bp -> b_flags , B_CACHE ) ; bufcache_take ( bp ) ; buf_acquire ( bp ) ; splx ( s ) ; return ( bp ) ; } } splx ( s ) ; if ( ( bp = buf_get ( vp , blkno , size ) ) == NULL ) { start } return ( bp ) ; } 