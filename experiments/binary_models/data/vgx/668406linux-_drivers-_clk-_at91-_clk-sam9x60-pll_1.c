static long sam9x60_frac_pll_compute_mul_frac ( struct sam9x60_pll_core * core , unsigned long rate , unsigned long parent_rate , bool update ) { struct sam9x60_frac * frac = to_sam9x60_frac ( core ) ; unsigned long tmprate , remainder ; unsigned long nmul = 0 ; unsigned long nfrac = 0 ; nmul = mult_frac ( rate , 1 , parent_rate ) ; tmprate = mult_frac ( parent_rate , nmul , 1 ) ; remainder = rate - tmprate ; if ( remainder ) { nfrac = DIV_ROUND_CLOSEST_ULL ( ( u64 ) remainder * ( 1 << 22 ) , parent_rate ) ; tmprate += DIV_ROUND_CLOSEST_ULL ( ( u64 ) nfrac * parent_rate , ( 1 << 22 ) ) ; } if ( tmprate ( FCORE_MIN || tmprate ) FCORE_MAX ) { return - ERANGE ; } if ( update ) { frac -> mul = nmul - 1 ; frac -> frac = nfrac ; } return tmprate ; } 