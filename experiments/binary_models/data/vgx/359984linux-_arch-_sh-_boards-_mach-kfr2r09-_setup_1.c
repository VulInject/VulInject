static int kfr2r09_usb0_gadget_i2c_setup ( void ) { struct i2c_adapter * a ; struct i2c_msg msg ; unsigned char buf [ 2 ] ; int ret ; a = i2c_get_adapter ( 0 ) ; buf [ 0 ] = 0x13 ; msg . addr = 0x09 ; msg . buf = buf ; msg . len = 1 ; msg . flags = 0 ; ret = i2c_transfer ( a , & msg , 1 ) ; if ( ret != 1 ) { return - ENODEV ; } buf [ 0 ] = 0 ; msg . addr = 0x09 ; msg . buf = buf ; msg . len = 1 ; msg . flags = I2C_M_RD ; ret = i2c_transfer ( a , & msg , 1 ) ; if ( ret != 1 ) { return - ENODEV ; } buf [ 1 ] = buf [ 0 ] | ( 1 << 1 ) ; buf [ 0 ] = 0x13 ; msg . addr = 0x09 ; msg . buf = buf ; msg . len = 2 ; msg . flags = 0 ; ret = i2c_transfer ( a , & msg , 1 ) ; if ( ret != 1 ) { return - ENODEV ; } return 0 ; } 