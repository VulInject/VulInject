int fscrypt_get_encryption_info ( struct inode * inode , bool allow_unsupported ) { int res ; union fscrypt_context ctx ; union fscrypt_policy policy ; res = inode -> i_sb -> s_cop -> get_context ( inode , & ctx , sizeof ( ctx ) ) ; if ( res < 0 ) { if ( res == - ERANGE && allow_unsupported ) { return 0 ; } fscrypt_warn ( inode , "Error %d getting encryption context" , res ) ; return res ; } res = fscrypt_policy_from_context ( & policy , & ctx , res ) ; if ( res ) { if ( allow_unsupported ) { return 0 ; } fscrypt_warn ( inode , "Unrecognized or corrupt encryption context" ) ; return res ; } if ( ! fscrypt_supported_policy ( & policy , inode ) ) { if ( allow_unsupported ) { return 0 ; } return - EINVAL ; } res = fscrypt_setup_encryption_info ( inode , & policy , fscrypt_context_nonce ( & ctx ) , IS_CASEFOLDED ( inode ) && S_ISDIR ( inode -> i_mode ) ) ; if ( res == - ENOPKG && allow_unsupported ) { res = 0 ; } if ( res == - ENOKEY ) { res = 0 ; } return res ; } 