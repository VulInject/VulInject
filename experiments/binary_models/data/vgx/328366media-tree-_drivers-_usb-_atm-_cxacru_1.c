static ssize_t cxacru_sysfs_store_adsl_state ( struct device * dev , struct device_attribute * attr , const char * buf , size_t count ) { struct cxacru_data * instance = to_usbatm_driver_data ( to_usb_interface ( dev ) ) ; int ret ; int poll = - 1 ; char str_cmd [ 8 ] ; int len = strlen ( buf ) ; ret = sscanf ( buf , "%7s" , str_cmd ) ; if ( ret != 1 ) { return - EINVAL ; } ret = 0 ; if ( instance == NULL ) { return - ENODEV ; } if ( mutex_lock_interruptible ( & instance -> adsl_state_serialize ) ) { return - ERESTARTSYS ; } if ( ! strcmp ( str_cmd , "stop" ) || ! strcmp ( str_cmd , "restart" ) ) { ret = cxacru_cm ( instance , CM_REQUEST_CHIP_ADSL_LINE_STOP , NULL , 0 , NULL , 0 ) ; if ( ret < 0 ) { atm_err ( instance -> usbatm , "change adsl state:" " CHIP_ADSL_LINE_STOP returned %d\n" , ret ) ; ret = - EIO ; } else { ret = len ; poll = CXPOLL_STOPPED ; } } if ( ! strcmp ( str_cmd , "restart" ) ) { msleep ( 1500 ) ; } if ( ! strcmp ( str_cmd , "start" ) || ! strcmp ( str_cmd , "restart" ) ) { ret = cxacru_cm ( instance , CM_REQUEST_CHIP_ADSL_LINE_START , NULL , 0 , NULL , 0 ) ; if ( ret < 0 ) { atm_err ( instance -> usbatm , "change adsl state:" " CHIP_ADSL_LINE_START returned %d\n" , ret ) ; ret = - EIO ; } else { ret = len ; poll = CXPOLL_POLLING ; } } if ( ! strcmp ( str_cmd , "poll" ) ) { ret = len ; poll = CXPOLL_POLLING ; } if ( ret == 0 ) { ret = - EINVAL ; poll = - 1 ; } if ( poll == CXPOLL_POLLING ) { mutex_lock ( & instance -> poll_state_serialize ) ; switch ( instance -> poll_state ) { case CXPOLL_STOPPED : instance -> poll_state = CXPOLL_POLLING ; break ; case CXPOLL_STOPPING : instance -> poll_state = CXPOLL_POLLING ; case CXPOLL_POLLING : case CXPOLL_SHUTDOWN : poll = - 1 ; } mutex_unlock ( & instance -> poll_state_serialize ) ; } if ( poll == CXPOLL_STOPPED ) { mutex_lock ( & instance -> poll_state_serialize ) ; if ( instance -> poll_state == CXPOLL_POLLING ) { instance -> poll_state = CXPOLL_STOPPING ; } mutex_unlock ( & instance -> poll_state_serialize ) ; } mutex_unlock ( & instance -> adsl_state_serialize ) ; if ( poll == CXPOLL_POLLING ) { cxacru_poll_status ( & instance -> poll_work . work ) ; } return ret ; } 