static int dissect_zbee_zcl ( tvbuff_t * tvb , packet_info * pinfo , proto_tree * tree , void * data ) { tvbuff_t * payload_tvb ; dissector_handle_t cluster_handle ; proto_tree * zcl_tree ; proto_tree * sub_tree = NULL ; proto_item * proto_root ; zbee_nwk_packet * nwk ; zbee_zcl_packet packet ; zbee_zcl_cluster_desc * desc ; guint16 cluster_id ; guint8 fcf ; guint offset = 0 ; if ( data == NULL ) { return 0 ; } nwk = ( zbee_nwk_packet * ) data ; cluster_id = zcl_cluster_id = nwk -> cluster_id ; proto_root = proto_tree_add_protocol_format ( tree , proto_zbee_zcl , tvb , offset , - 1 , "ZigBee Cluster Library Frame" ) ; zcl_tree = proto_item_add_subtree ( proto_root , ett_zbee_zcl ) ; col_clear ( pinfo -> cinfo , COL_INFO ) ; fcf = tvb_get_guint8 ( tvb , offset ) ; packet . frame_type = zbee_get_bit_field ( fcf , ZBEE_ZCL_FCF_FRAME_TYPE ) ; packet . mfr_spec = zbee_get_bit_field ( fcf , ZBEE_ZCL_FCF_MFR_SPEC ) ; packet . direction = zbee_get_bit_field ( fcf , ZBEE_ZCL_FCF_DIRECTION ) ; packet . disable_default_resp = zbee_get_bit_field ( fcf , ZBEE_ZCL_FCF_DISABLE_DEFAULT_RESP ) ; if ( tree ) { sub_tree = proto_tree_add_subtree_format ( zcl_tree , tvb , offset , 1 , ett_zbee_zcl_fcf , NULL , "Frame Control Field: %s (0x%02x)" , val_to_str_const ( packet . frame_type , zbee_zcl_frame_types , "Unknown" ) , fcf ) ; proto_tree_add_item ( sub_tree , hf_zbee_zcl_fcf_frame_type , tvb , offset , 1 , ENC_NA ) ; proto_tree_add_item ( sub_tree , hf_zbee_zcl_fcf_mfr_spec , tvb , offset , 1 , ENC_NA ) ; proto_tree_add_item ( sub_tree , hf_zbee_zcl_fcf_dir , tvb , offset , 1 , ENC_NA ) ; proto_tree_add_item ( sub_tree , hf_zbee_zcl_fcf_disable_default_resp , tvb , offset , 1 , ENC_NA ) ; } offset += 1 ; if ( packet . mfr_spec ) { packet . mfr_code = tvb_get_letohs ( tvb , offset ) ; if ( tree ) { proto_tree_add_uint ( zcl_tree , hf_zbee_zcl_mfr_code , tvb , offset , 2 , packet . mfr_code ) ; proto_item_append_text ( proto_root , ", Mfr: %s (0x%04x)" , val_to_str_ext_const ( packet . mfr_code , & zbee_mfr_code_names_ext , "Unknown" ) , packet . mfr_code ) ; } offset += 2 ; } zcl_mfr_code = packet . mfr_code ; packet . tran_seqno = tvb_get_guint8 ( tvb , offset ) ; proto_tree_add_uint ( zcl_tree , hf_zbee_zcl_tran_seqno , tvb , offset , 1 , packet . tran_seqno ) ; offset += 1 ; packet . cmd_id = tvb_get_guint8 ( tvb , offset ) ; cluster_handle = dissector_get_uint_handle ( zbee_zcl_dissector_table , ZCL_CLUSTER_MFR_KEY ( cluster_id , packet . mfr_code ) ) ; desc = zbee_zcl_get_cluster_desc ( cluster_id , packet . mfr_code ) ; if ( desc != NULL ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "%s: " , desc -> name ) ; } if ( packet . frame_type == ZBEE_ZCL_FCF_PROFILE_WIDE ) { if ( tree ) { proto_item_append_text ( proto_root , ", Command: %s, Seq: %u" , val_to_str_ext_const ( packet . cmd_id , & zbee_zcl_cmd_names_ext , "Unknown Command" ) , packet . tran_seqno ) ; } col_set_str ( pinfo -> cinfo , COL_INFO , "ZCL: " ) ; col_append_fstr ( pinfo -> cinfo , COL_INFO , "%s, Seq: %u" , val_to_str_ext_const ( packet . cmd_id , & zbee_zcl_cmd_names_ext , "Unknown Command" ) , packet . tran_seqno ) ; proto_tree_add_uint ( zcl_tree , hf_zbee_zcl_cmd_id , tvb , offset , 1 , packet . cmd_id ) ; offset += 1 ; } else { payload_tvb = tvb_new_subset_remaining ( tvb , offset ) ; if ( cluster_handle != NULL ) { call_dissector_with_data ( cluster_handle , payload_tvb , pinfo , zcl_tree , & packet ) ; return tvb_captured_length ( tvb ) ; } else { col_append_fstr ( pinfo -> cinfo , COL_INFO , "Unknown Command: 0x%02x, Seq: %u" , packet . cmd_id , packet . tran_seqno ) ; proto_tree_add_uint ( zcl_tree , hf_zbee_zcl_cs_cmd_id , tvb , offset , 1 , packet . cmd_id ) ; offset += 1 ; } zcl_dump_data ( tvb , offset , pinfo , zcl_tree ) ; return tvb_captured_length ( tvb ) ; } if ( zcl_tree ) { switch ( packet . cmd_id ) { case ZBEE_ZCL_CMD_READ_ATTR : dissect_zcl_read_attr ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_READ_ATTR_RESP : dissect_zcl_read_attr_resp ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_WRITE_ATTR : case ZBEE_ZCL_CMD_WRITE_ATTR_UNDIVIDED : case ZBEE_ZCL_CMD_WRITE_ATTR_NO_RESP : dissect_zcl_write_attr ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_REPORT_ATTR : dissect_zcl_report_attr ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_WRITE_ATTR_RESP : dissect_zcl_write_attr_resp ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_CONFIG_REPORT : dissect_zcl_config_report ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_CONFIG_REPORT_RESP : dissect_zcl_config_report_resp ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_READ_REPORT_CONFIG : dissect_zcl_read_report_config ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_READ_REPORT_CONFIG_RESP : dissect_zcl_read_report_config_resp ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_DEFAULT_RESP : dissect_zcl_default_resp ( tvb , pinfo , zcl_tree , & offset ) ; break ; case ZBEE_ZCL_CMD_DISCOVER_ATTR : case ZBEE_ZCL_CMD_DISCOVER_ATTR_EXTENDED : dissect_zcl_discover_attr ( tvb , pinfo , zcl_tree , & offset ) ; break ; case ZBEE_ZCL_CMD_DISCOVER_ATTR_RESP : dissect_zcl_discover_attr_resp ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_READ_ATTR_STRUCT : dissect_zcl_read_attr_struct ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_WRITE_ATTR_STRUCT : dissect_zcl_write_attr_struct ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_WRITE_ATTR_STRUCT_RESP : dissect_zcl_write_attr_struct_resp ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; case ZBEE_ZCL_CMD_DISCOVER_CMDS_REC : case ZBEE_ZCL_CMD_DISCOVER_CMDS_GEN : dissect_zcl_discover_cmd_rec ( tvb , pinfo , zcl_tree , & offset ) ; break ; case ZBEE_ZCL_CMD_DISCOVER_CMDS_REC_RESP : case ZBEE_ZCL_CMD_DISCOVER_CMDS_GEN_RESP : dissect_zcl_discover_cmd_rec_resp ( tvb , pinfo , zcl_tree , & offset ) ; break ; case ZBEE_ZCL_CMD_DISCOVER_ATTR_EXTENDED_RESP : dissect_zcl_discover_cmd_attr_extended_resp ( tvb , pinfo , zcl_tree , & offset , cluster_id , packet . mfr_code , packet . direction ) ; break ; } } zcl_dump_data ( tvb , offset , pinfo , zcl_tree ) ; return tvb_captured_length ( tvb ) ; } 