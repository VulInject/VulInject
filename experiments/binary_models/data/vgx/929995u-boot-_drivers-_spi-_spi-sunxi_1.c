static void sun4i_spi_set_speed_mode ( struct udevice * dev ) { struct sun4i_spi_priv * priv = dev_get_priv ( dev ) ; int div ; u32 reg ; div = DIV_ROUND_UP ( SUNXI_INPUT_CLOCK , priv -> freq ) ; reg = readl ( SPI_REG ( priv , SPI_CCR ) ) ; if ( ( div / 2 ) <= ( SUN4I_CLK_CTL_CDR2_MASK + 1 ) ) { div /= 2 ; if ( div > 0 ) { div -- ; } reg &= ~ ( SUN4I_CLK_CTL_CDR2_MASK | SUN4I_CLK_CTL_DRS ) ; reg |= SUN4I_CLK_CTL_CDR2 ( div ) | SUN4I_CLK_CTL_DRS ; } else { div = fls ( div - 1 ) ; if ( IS_ENABLED ( CONFIG_MACH_SUNIV ) ) { div -- ; } reg &= ~ ( ( SUN4I_CLK_CTL_CDR1_MASK << 8 ) | SUN4I_CLK_CTL_DRS ) ; reg |= SUN4I_CLK_CTL_CDR1 ( div ) ; } writel ( reg , SPI_REG ( priv , SPI_CCR ) ) ; reg = readl ( SPI_REG ( priv , SPI_TCR ) ) ; reg &= ~ ( SPI_BIT ( priv , SPI_TCR_CPOL ) | SPI_BIT ( priv , SPI_TCR_CPHA ) ) ; if ( priv -> mode & SPI_CPOL ) { reg |= SPI_BIT ( priv , SPI_TCR_CPOL ) ; } if ( priv -> mode & SPI_CPHA ) { reg |= SPI_BIT ( priv , SPI_TCR_CPHA ) ; } writel ( reg , SPI_REG ( priv , SPI_TCR ) ) ; } 