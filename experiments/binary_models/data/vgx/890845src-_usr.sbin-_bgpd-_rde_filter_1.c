static int rde_filter_match ( struct filter_rule * f , struct rde_peer * peer , struct rde_peer * from , struct filterstate * state , struct bgpd_addr * prefix , uint8_t plen ) { struct rde_aspath * asp = & state -> aspath ; int i ; if ( f -> peer . ibgp && peer -> conf . ebgp ) { return ( 0 ) ; } if ( f -> match . ovs . is_set ) { if ( ( state -> vstate & ROA_MASK ) != f -> match . ovs . validity ) { return ( 0 ) ; } } if ( f -> match . avs . is_set ) { if ( ( ( state -> vstate >> 4 ) & ASPA_MASK ) != f -> match . avs . validity ) { return ( 0 ) ; } } if ( asp != NULL && f -> match . as . type != AS_UNDEF ) { if ( aspath_match ( asp -> aspath , & f -> match . as , peer -> conf . remote_as ) == 0 ) { return ( 0 ) ; } } if ( asp != NULL && f -> match . aslen . type != ASLEN_NONE ) { if ( aspath_lenmatch ( asp -> aspath , f -> match . aslen . type , f -> match . aslen . aslen ) == 0 ) { return ( 0 ) ; } } for ( i = 0 ; i < MAX_COMM_MATCH ; i ++ ) { if ( f -> match . community [ i ] . flags == 0 ) { break ; } if ( community_match ( & state -> communities , & f -> match . community [ i ] , peer ) == 0 ) { return ( 0 ) ; } } if ( f -> match . maxcomm != 0 ) { if ( f -> match . maxcomm > community_count ( & state -> communities , COMMUNITY_TYPE_BASIC ) ) { return ( 0 ) ; } } if ( f -> match . maxextcomm != 0 ) { if ( f -> match . maxextcomm > community_count ( & state -> communities , COMMUNITY_TYPE_EXT ) ) { return ( 0 ) ; } } if ( f -> match . maxlargecomm != 0 ) { if ( f -> match . maxlargecomm > community_count ( & state -> communities , COMMUNITY_TYPE_LARGE ) ) { return ( 0 ) ; } } if ( f -> match . nexthop . flags != 0 ) { struct bgpd_addr * nexthop , * cmpaddr ; if ( state -> nexthop == NULL ) { return ( 0 ) ; } nexthop = & state -> nexthop -> exit_nexthop ; if ( f -> match . nexthop . flags == FILTER_NEXTHOP_ADDR ) { cmpaddr = & f -> match . nexthop . addr ; } else { cmpaddr = & from -> remote_addr ; } if ( cmpaddr -> aid != nexthop -> aid ) { return ( 0 ) ; } switch ( cmpaddr -> aid ) { case AID_INET : if ( cmpaddr -> v4 . s_addr != nexthop -> v4 . s_addr ) { return ( 0 ) ; } break ; case AID_INET6 : if ( memcmp ( & cmpaddr -> v6 , & nexthop -> v6 , sizeof ( in6_addr ) ) ) { return ( 0 ) ; } break ; default : fatalx ( "King Bula lost in address space" ) ; } } if ( asp != NULL && f -> match . originset . ps != NULL ) { if ( trie_roa_check ( & f -> match . originset . ps -> th , prefix , plen , aspath_origin ( asp -> aspath ) ) != ROA_VALID ) { return ( 0 ) ; } } if ( f -> match . prefixset . flags != 0 ) { if ( f -> match . prefixset . ps == NULL || ! trie_match ( & f -> match . prefixset . ps -> th , prefix , plen , ( f -> match . prefixset . flags & PREFIXSET_FLAG_LONGER ) ) ) { return ( 0 ) ; } } if ( f -> match . prefix . addr . aid != 0 ) { return ( rde_prefix_match ( & f -> match . prefix , prefix , plen ) ) ; } return ( 1 ) ; } 