R_API bool commit_rvc ( Rvc * rvc , const char * message , const char * author , const RList * files ) { rvc_warn ( ) ; if ( ! rvc_repo_exists ( rvc -> path ) ) { R_LOG_ERROR ( "No valid repo in %s" , rvc -> path ) ; return false ; } if ( R_STR_ISEMPTY ( message ) ) { char * path = NULL ; ( void ) r_file_mkstemp ( "rvc" , & path ) ; if ( path ) { free ( r_cons_editor ( path , NULL ) ) ; message = r_file_slurp ( path , NULL ) ; if ( ! message ) { free ( path ) ; return false ; } } else { return false ; } } if ( message && r_str_len_utf8 ( message ) > MAX_MESSAGE_LEN ) { R_LOG_ERROR ( "Commit message is too long" ) ; return false ; } const char * m ; for ( m = message ; m && * m ; m ++ ) { if ( * m < ' ' && * m != '\n' ) { R_LOG_ERROR ( "commit messages must contain only printable characters '%c'" , * m ) ; return false ; } } RList * blobs = blobs_add ( rvc , files ) ; if ( ! blobs ) { return false ; } if ( r_list_empty ( blobs ) ) { R_LOG_ERROR ( "Nothing to commit" ) ; return false ; } char * commit_hash = NULL ; if ( R_STR_ISEMPTY ( author ) ) { char * au = r_sys_whoami ( ) ; commit_hash = write_commit ( rvc , message , au , blobs ) ; free ( au ) ; } else { commit_hash = write_commit ( rvc , message , author , blobs ) ; } if ( ! commit_hash ) { free_blobs ( blobs ) ; return false ; } { const char * current_branch = sdb_const_get ( rvc -> db , CURRENTB , 0 ) ; if ( sdb_set ( rvc -> db , commit_hash , sdb_const_get ( rvc -> db , current_branch , 0 ) , 0 ) < 0 ) { free_blobs ( blobs ) ; free ( commit_hash ) ; return false ; } if ( sdb_set ( rvc -> db , current_branch , commit_hash , 0 ) < 0 ) { free_blobs ( blobs ) ; free ( commit_hash ) ; return false ; } } free ( commit_hash ) ; free_blobs ( blobs ) ; return save_rvc ( rvc ) ; } 