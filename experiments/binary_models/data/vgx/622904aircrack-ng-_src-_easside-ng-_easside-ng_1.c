static void send_whohas ( struct east_state * es , struct timeval * tv ) { REQUIRE ( es != NULL ) ; unsigned char buf [ sizeof ( ieee80211_frame ) * 16 ] ; struct ieee80211_frame * wh = ( ieee80211_frame * ) buf ; unsigned char * data = ( unsigned char * ) ( wh + 1 ) ; int dlen ; struct arphdr * ah ; unsigned char * datas ; if ( too_early ( tv , es -> es_txto_whohas , & es -> es_txlast ) ) { return ; } es -> es_txseq ++ ; fill_basic ( es , wh ) ; wh -> i_fc [ 0 ] |= IEEE80211_FC0_TYPE_DATA | IEEE80211_FC0_SUBTYPE_DATA ; wh -> i_fc [ 1 ] |= IEEE80211_FC1_DIR_TODS | IEEE80211_FC1_WEP ; memset ( wh -> i_addr3 , 0xff , 6 ) ; memcpy ( data , es -> es_iv , 3 ) ; data += 4 ; datas = data ; memcpy ( data , S_LLC_SNAP_ARP , 8 ) ; data += 8 ; ah = ( arphdr * ) data ; ah -> ar_hrd = htons ( ARPHRD_ETHER ) ; ah -> ar_pro = htons ( ETHERTYPE_IP ) ; ah -> ar_hln = 6 ; ah -> ar_pln = 4 ; ah -> ar_op = htons ( ARPOP_REQUEST ) ; data = ( unsigned char * ) ( ah + 1 ) ; memcpy ( data , es -> es_mymac , 6 ) ; data += 6 ; memcpy ( data , & es -> es_myip , 4 ) ; data += 4 ; data += 6 ; memcpy ( data , & es -> es_rtrip , 4 ) ; data += 4 ; dlen = data - datas ; add_crc32 ( datas , dlen ) ; assert ( es -> es_prgalen >= dlen + 4 ) ; xor ( datas , datas , es -> es_prga , dlen + 4 ) ; char const * const netip = inet_ntoa ( es -> es_rtrip ) ; printf ( "Sending who has %s" , netip ?netip : "<unknown>" ) ; char const * const myip = inet_ntoa ( es -> es_myip ) ; printf ( " tell %s\n" , myip ?myip : "<unknown>" ) ; send_frame ( es , wh , data - buf + 4 ) ; } 