gmon_out_write ( ) { FILE * ofp ; struct gmon_hdr ghdr ; ofp = fopen ( filename , FOPEN_WB ) ; if ( ! ofp ) { perror ( filename ) ; done ( 1 ) ; } if ( file_format == FF_AUTO || file_format == FF_MAGIC ) { memcpy ( & ghdr . cookie [ 0 ] , GMON_MAGIC , 4 ) ; bfd_put_32 ( core_bfd , ( bfd_vma ) GMON_VERSION , ( bfd_byte * ) ghdr . version ) ; if ( fwrite ( & ghdr , sizeof ( ghdr ) , 1 , ofp ) != 1 ) { perror ( filename ) ; done ( 1 ) ; } if ( gmon_input & INPUT_HISTOGRAM ) { hist_write_hist ( ofp , filename ) ; } if ( gmon_input & INPUT_CALL_GRAPH ) { cg_write_arcs ( ofp , filename ) ; } if ( gmon_input & INPUT_BB_COUNTS ) { bb_write_blocks ( ofp , filename ) ; } } if ( file_format == FF_BSD || file_format == FF_BSD44 ) { UNIT raw_bin_count ; unsigned int i , hdrsize ; unsigned padsize ; char pad [ 3 * 4 ] ; Arc * arc ; Sym * sym ; hdrsize = 0 ; if ( file_format == FF_BSD44 || hz != hertz ( ) ) { padsize = 3 * 4 ; switch ( gmon_get_ptr_size ( ) ) { case ptr_32bit : hdrsize = GMON_HDRSIZE_BSD44_32 ; break ; case ptr_64bit : hdrsize = GMON_HDRSIZE_BSD44_64 ; break ; } } else { padsize = 0 ; switch ( gmon_get_ptr_size ( ) ) { case ptr_32bit : hdrsize = GMON_HDRSIZE_OLDBSD_32 ; break ; case ptr_64bit : hdrsize = GMON_HDRSIZE_OLDBSD_64 ; padsize = 4 ; break ; } } if ( gmon_io_write_vma ( ofp , s_lowpc ) || gmon_io_write_vma ( ofp , s_highpc ) || gmon_io_write_32 ( ofp , hist_num_bins * sizeof ( UNIT ) + hdrsize ) ) { perror ( filename ) ; done ( 1 ) ; } if ( file_format == FF_BSD44 || hz != hertz ( ) ) { if ( gmon_io_write_32 ( ofp , GMONVERSION ) || gmon_io_write_32 ( ofp , ( unsigned int ) hz ) ) { perror ( filename ) ; done ( 1 ) ; } } if ( padsize != 0 && fwrite ( pad , 1 , padsize , ofp ) != padsize ) { perror ( filename ) ; done ( 1 ) ; } for ( i = 0 ; i < hist_num_bins ; ++ i ) { bfd_put_16 ( core_bfd , ( bfd_vma ) hist_sample [ i ] , ( bfd_byte * ) & raw_bin_count [ 0 ] ) ; if ( fwrite ( & raw_bin_count [ 0 ] , sizeof ( raw_bin_count ) , 1 , ofp ) != 1 ) { perror ( filename ) ; done ( 1 ) ; } } for ( sym = symtab . base ; sym < symtab . limit ; ++ sym ) { for ( arc = sym -> cg . children ; arc ; arc = arc -> next_child ) { if ( gmon_write_raw_arc ( ofp , arc -> parent -> addr , arc -> child -> addr , arc -> count ) ) { perror ( filename ) ; done ( 1 ) ; } DBG ( SAMPLEDEBUG , printf ( "[dumpsum] frompc 0x%lx selfpc 0x%lx count %lu\n" , ( unsigned long ) arc -> parent -> addr , ( unsigned long ) arc -> child -> addr , arc -> count ) ) ; } } fclose ( ofp ) ; } else { fprintf ( stderr , _ ( "%s: don't know how to deal with file format %d\n" ) , whoami , file_format ) ; done ( 1 ) ; } } 