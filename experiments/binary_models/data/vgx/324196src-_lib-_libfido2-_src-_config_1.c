static int config_prepare_hmac ( uint8_t subcmd , const cbor_item_t * item , fido_blob_t * hmac ) { uint8_t prefix [ 32 + 2 * sizeof ( uint8_t ) ] , cbor [ 128 ] ; size_t cbor_len ; prefix [ sizeof ( prefix ) - 2 ] = CTAP_CBOR_CONFIG ; prefix [ sizeof ( prefix ) - 1 ] = subcmd ; if ( ( cbor_len = cbor_serialize ( item , cbor , sizeof ( cbor ) ) ) == 0 ) { fido_log_debug ( "%s: cbor_serialize" , __func__ ) ; return - 1 ; } if ( ( hmac -> ptr = malloc ( cbor_len + sizeof ( prefix ) ) ) == NULL ) { fido_log_debug ( "%s: malloc" , __func__ ) ; return - 1 ; } memcpy ( hmac -> ptr , prefix , sizeof ( prefix ) ) ; memcpy ( hmac -> ptr + sizeof ( prefix ) , cbor , cbor_len ) ; hmac -> len = cbor_len + sizeof ( prefix ) ; return 0 ; } 