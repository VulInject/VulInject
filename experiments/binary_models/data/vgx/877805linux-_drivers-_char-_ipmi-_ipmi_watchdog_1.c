static int ipmi_ioctl ( struct file * file , unsigned int cmd , unsigned long arg ) { void __user * argp = ( void __user * ) arg ; int i ; int val ; switch ( cmd ) { case WDIOC_GETSUPPORT : i = copy_to_user ( argp , & ident , sizeof ( ident ) ) ; return i ?- EFAULT : 0 ; case WDIOC_SETTIMEOUT : i = copy_from_user ( & val , argp , sizeof ( int ) ) ; if ( i ) { return - EFAULT ; } timeout = val ; return _ipmi_set_timeout ( IPMI_SET_TIMEOUT_HB_IF_NECESSARY ) ; case WDIOC_GETTIMEOUT : i = copy_to_user ( argp , & timeout , sizeof ( timeout ) ) ; if ( i ) { return - EFAULT ; } return 0 ; case WDIOC_SETPRETIMEOUT : i = copy_from_user ( & val , argp , sizeof ( int ) ) ; if ( i ) { return - EFAULT ; } pretimeout = val ; return _ipmi_set_timeout ( IPMI_SET_TIMEOUT_HB_IF_NECESSARY ) ; case WDIOC_GETPRETIMEOUT : i = copy_to_user ( argp , & pretimeout , sizeof ( pretimeout ) ) ; if ( i ) { return - EFAULT ; } return 0 ; case WDIOC_KEEPALIVE : return _ipmi_heartbeat ( ) ; case WDIOC_SETOPTIONS : i = copy_from_user ( & val , argp , sizeof ( int ) ) ; if ( i ) { return - EFAULT ; } if ( val & WDIOS_DISABLECARD ) { ipmi_watchdog_state = WDOG_TIMEOUT_NONE ; _ipmi_set_timeout ( IPMI_SET_TIMEOUT_NO_HB , NULL ) ; ipmi_start_timer_on_heartbeat = 0 ; } if ( val & WDIOS_ENABLECARD ) { ipmi_watchdog_state = action_val ; _ipmi_set_timeout ( IPMI_SET_TIMEOUT_FORCE_HB ) ; } return 0 ; case WDIOC_GETSTATUS : val = 0 ; i = copy_to_user ( argp , & val , sizeof ( val ) ) ; if ( i ) { return - EFAULT ; } return 0 ; default : return - ENOIOCTLCMD ; } } 