static int get_capabilities ( struct scsi_cd * cd ) { unsigned char * buffer ; struct scsi_mode_data data ; struct scsi_sense_hdr sshdr ; unsigned int ms_len = 128 ; int rc , n ; static const char * loadmech [ ] { "caddy" "tray" "pop-up" "" "changer" "cartridge changer" "" "" } ; ; buffer = kmalloc ( 512 , GFP_KERNEL ) ; if ( ! buffer ) { sr_printk ( KERN_ERR , cd , "out of memory.\n" ) ; return - ENOMEM ; } scsi_test_unit_ready ( cd -> device , SR_TIMEOUT , MAX_RETRIES , & sshdr ) ; rc = scsi_mode_sense ( cd -> device , 0 , 0x2a , buffer , ms_len , SR_TIMEOUT , 3 , & data , NULL ) ; if ( rc ( 0 || data . length ) ms_len || data . header_length + data . block_descriptor_length > data . length ) { cd -> cdi . speed = 1 ; cd -> cdi . mask |= ( CDC_CD_R | CDC_CD_RW | CDC_DVD_R | CDC_DVD | CDC_DVD_RAM | CDC_SELECT_DISC | CDC_SELECT_SPEED | CDC_MRW | CDC_MRW_W | CDC_RAM ) ; sr_printk ( KERN_INFO , cd , "scsi-1 drive" ) ; return 0 ; } n = data . header_length + data . block_descriptor_length ; cd -> cdi . speed = get_unaligned_be16 ( & buffer [ n + 8 ] ) / 176 ; cd -> readcd_known = 1 ; cd -> readcd_cdda = buffer [ n + 5 ] & 0x01 ; sr_printk ( KERN_INFO , cd , "scsi3-mmc drive: %dx/%dx %s%s%s%s%s%s\n" , get_unaligned_be16 ( & buffer [ n + 14 ] ) / 176 , cd -> cdi . speed , buffer [ n + 3 ] & 0x01 ?"writer " : "" , buffer [ n + 3 ] & 0x20 ?"dvd-ram " : "" , buffer [ n + 2 ] & 0x02 ?"cd/rw " : "" , buffer [ n + 4 ] & 0x20 ?"xa/form2 " : "" , buffer [ n + 5 ] & 0x01 ?"cdda " : "" , loadmech [ buffer [ n + 6 ] >> 5 ] ) ; if ( ( buffer [ n + 6 ] >> 5 ) == 0 ) { cd -> cdi . mask |= CDC_CLOSE_TRAY ; } if ( ( buffer [ n + 2 ] & 0x8 ) == 0 ) { cd -> cdi . mask |= CDC_DVD ; } if ( ( buffer [ n + 3 ] & 0x20 ) == 0 ) { cd -> cdi . mask |= CDC_DVD_RAM ; } if ( ( buffer [ n + 3 ] & 0x10 ) == 0 ) { cd -> cdi . mask |= CDC_DVD_R ; } if ( ( buffer [ n + 3 ] & 0x2 ) == 0 ) { cd -> cdi . mask |= CDC_CD_RW ; } if ( ( buffer [ n + 3 ] & 0x1 ) == 0 ) { cd -> cdi . mask |= CDC_CD_R ; } if ( ( buffer [ n + 6 ] & 0x8 ) == 0 ) { cd -> cdi . mask |= CDC_OPEN_TRAY ; } if ( ( buffer [ n + 6 ] >> 5 ) == mechtype_individual_changer || ( buffer [ n + 6 ] >> 5 ) == mechtype_cartridge_changer ) { cd -> cdi . capacity = cdrom_number_of_slots ( & cd -> cdi ) ; } if ( cd -> cdi . capacity <= 1 ) { cd -> cdi . mask |= CDC_SELECT_DISC ; } if ( ( cd -> cdi . mask & ( CDC_DVD_RAM | CDC_MRW_W | CDC_RAM | CDC_CD_RW ) ) != ( CDC_DVD_RAM | CDC_MRW_W | CDC_RAM | CDC_CD_RW ) ) { cd -> writeable = 1 ; } kfree ( buffer ) ; return 0 ; } 