str td_col_r_uri = str_init ( "r_uri" ) ; str td_col_a_srcaddr = str_init ( "a_srcaddr" ) ; str td_col_b_srcaddr = str_init ( "b_srcaddr" ) ; str td_col_s_method = str_init ( "s_method" ) ; str td_col_s_cseq = str_init ( "s_cseq" ) ; str td_col_x_context = str_init ( "x_context" ) ; str tt_table_name = str_init ( "topos_t" ) ; str tt_col_rectime = str_init ( "rectime" ) ; str tt_col_a_callid = str_init ( "a_callid" ) ; str tt_col_a_uuid = str_init ( "a_uuid" ) ; str tt_col_b_uuid = str_init ( "b_uuid" ) ; str tt_col_direction = str_init ( "direction" ) ; str tt_col_x_via = str_init ( "x_via" ) ; str tt_col_x_vbranch = str_init ( "x_vbranch" ) ; str tt_col_x_rr = str_init ( "x_rr" ) ; str tt_col_y_rr = str_init ( "y_rr" ) ; str tt_col_s_rr = str_init ( "s_rr" ) ; str tt_col_x_uri = str_init ( "x_uri" ) ; str tt_col_a_contact = str_init ( "a_contact" ) ; str tt_col_b_contact = str_init ( "b_contact" ) ; str tt_col_as_contact = str_init ( "as_contact" ) ; str tt_col_bs_contact = str_init ( "bs_contact" ) ; str tt_col_x_tag = str_init ( "x_tag" ) ; str tt_col_a_tag = str_init ( "a_tag" ) ; str tt_col_b_tag = str_init ( "b_tag" ) ; str tt_col_s_method = str_init ( "s_method" ) ; str tt_col_s_cseq = str_init ( "s_cseq" ) ; str tt_col_x_context = str_init ( "x_context" ) ; str _tps_empty = str_init ( "" ) ; int tps_db_insert_dialog ( tps_data_t * td ) { db_key_t db_keys [ TPS_NR_KEYS ] ; db_val_t db_vals [ TPS_NR_KEYS ] ; int nr_keys ; if ( _tps_db_handle == NULL ) { LM_ERR ( "No database handle - misconfiguration?\n" ) ; error } memset ( db_vals , 0 , TPS_NR_KEYS * sizeof ( db_val_t ) ) ; nr_keys = 0 ; db_keys [ nr_keys ] = & td_col_rectime ; db_vals [ nr_keys ] . type = DB1_DATETIME ; db_vals [ nr_keys ] . val . time_val = time ( NULL ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_a_callid ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> a_callid ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_a_uuid ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> a_uuid ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_b_uuid ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> b_uuid ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_a_contact ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> a_contact ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_b_contact ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> b_contact ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_as_contact ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> as_contact ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_bs_contact ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> bs_contact ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_a_tag ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> a_tag ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_b_tag ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> b_tag ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_a_rr ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> a_rr ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_b_rr ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> b_rr ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_s_rr ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> s_rr ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_iflags ; db_vals [ nr_keys ] . type = DB1_INT ; db_vals [ nr_keys ] . val . int_val = td -> iflags ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_a_uri ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> a_uri ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_b_uri ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> b_uri ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_r_uri ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> r_uri ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_a_srcaddr ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> a_srcaddr ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_b_srcaddr ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> b_srcaddr ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_s_method ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> s_method ) ; nr_keys ++ ; db_keys [ nr_keys ] = & td_col_s_cseq ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> s_cseq ) ; nr_keys ++ ; if ( td -> x_context . len > 0 ) { db_keys [ nr_keys ] = & td_col_x_context ; db_vals [ nr_keys ] . type = DB1_STR ; db_vals [ nr_keys ] . val . str_val = TPS_STRZ ( td -> x_context ) ; nr_keys ++ ; } if ( _tpsdbf . use_table ( _tps_db_handle , & td_table_name ) < 0 ) { LM_ERR ( "failed to perform use table\n" ) ; return - 1 ; } if ( _tpsdbf . insert ( _tps_db_handle , db_keys , db_vals , nr_keys ) < 0 ) { LM_ERR ( "failed to store message\n" ) ; error } return 0 ; error return - 1 ; } 