M_bool M_tls_ctx_load_os_trust ( SSL_CTX * ctx ) { CFArrayRef anchors ; int ret ; int i ; size_t count = 0 ; X509_STORE * store ; ret = SecTrustCopyAnchorCertificates ( & anchors ) ; if ( ret != 0 ) { return M_FALSE ; } store = SSL_CTX_get_cert_store ( ctx ) ; for ( i = 0 ; i < CFArrayGetCount ( anchors ) ; i ++ ) { const void * ptr = CFArrayGetValueAtIndex ( anchors , i ) ; SecCertificateRef cr = M_CAST_OFF_CONST ( SecCertificateRef , ptr ) ; CFDataRef dref ; X509 * x509 ; const unsigned char * data ; dref = SecCertificateCopyData ( cr ) ; if ( dref == NULL ) { continue ; } data = CFDataGetBytePtr ( dref ) ; x509 = d2i_X509 ( NULL , & data , CFDataGetLength ( dref ) ) ; CFRelease ( dref ) ; if ( x509 == NULL ) { continue ; } if ( X509_STORE_add_cert ( store , x509 ) ) { count ++ ; } X509_free ( x509 ) ; } CFRelease ( anchors ) ; if ( ! count ) { return M_FALSE ; } return M_TRUE ; } 