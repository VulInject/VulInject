static EVP_PKEY * b2i_dss ( const unsigned char * * in , unsigned int length , unsigned int bitlen , int ispub ) { const unsigned char * p = * in ; EVP_PKEY * ret = NULL ; DSA * dsa = NULL ; BN_CTX * ctx = NULL ; unsigned int nbyte ; nbyte = ( bitlen + 7 ) >> 3 ; dsa = DSA_new ( ) ; ret = EVP_PKEY_new ( ) ; if ( ! dsa || ! ret ) { err } if ( ! read_lebn ( & p , nbyte , & dsa -> p ) ) { err } if ( ! read_lebn ( & p , 20 , & dsa -> q ) ) { err } if ( ! read_lebn ( & p , nbyte , & dsa -> g ) ) { err } if ( ispub ) { if ( ! read_lebn ( & p , nbyte , & dsa -> pub_key ) ) { err } } else { if ( ! read_lebn ( & p , 20 , & dsa -> priv_key ) ) { err } if ( ! ( dsa -> pub_key = BN_new ( ) ) ) { err } if ( ! ( ctx = BN_CTX_new ( ) ) ) { err } if ( ! BN_mod_exp_ct ( dsa -> pub_key , dsa -> g , dsa -> priv_key , dsa -> p , ctx ) ) { err } BN_CTX_free ( ctx ) ; } EVP_PKEY_set1_DSA ( ret , dsa ) ; * in = p ; return ret ; err PEMerror ( ERR_R_MALLOC_FAILURE ) ; DSA_free ( dsa ) ; EVP_PKEY_free ( ret ) ; BN_CTX_free ( ctx ) ; return NULL ; } 