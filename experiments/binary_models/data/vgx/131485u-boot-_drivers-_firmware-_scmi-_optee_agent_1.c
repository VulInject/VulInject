static int open_channel ( struct udevice * dev , struct scmi_optee_channel * chan , struct channel_session * sess ) { const struct tee_optee_ta_uuid uuid = TA_SCMI_UUID ; struct tee_open_session_arg sess_arg = { } ; struct tee_invoke_arg cmd_arg = { } ; struct tee_param param [ 1 ] { } ; ; int ret ; memset ( sess , 0 , sizeof ( sess ) ) ; sess -> tee = tee_find_device ( NULL , NULL , NULL , NULL ) ; sess_arg . clnt_login = TEE_LOGIN_REE_KERNEL ; tee_optee_ta_uuid_to_octets ( sess_arg . uuid , & uuid ) ; ret = tee_open_session ( sess -> tee , & sess_arg , 0 , NULL ) ; if ( ret ) { dev_err ( dev , "can't open session: %d\n" , ret ) ; return ret ; } cmd_arg . func = PTA_SCMI_CMD_GET_CHANNEL ; cmd_arg . session = sess_arg . session ; param [ 0 ] . attr = TEE_PARAM_ATTR_TYPE_VALUE_INOUT ; param [ 0 ] . u . value . a = chan -> channel_id ; if ( chan -> dyn_shm ) { param [ 0 ] . u . value . b = PTA_SCMI_CAPS_MSG_HEADER ; } else { param [ 0 ] . u . value . b = PTA_SCMI_CAPS_SMT_HEADER ; } ret = tee_invoke_func ( sess -> tee , & cmd_arg , ARRAY_SIZE ( param ) , param ) ; if ( ret || cmd_arg . ret ) { dev_err ( dev , "Invoke failed: %d, 0x%x\n" , ret , cmd_arg . ret ) ; if ( ! ret ) { ret = - EPROTO ; } tee_close_session ( sess -> tee , sess_arg . session ) ; return ret ; } sess -> tee_session = sess_arg . session ; sess -> channel_hdl = param [ 0 ] . u . value . a ; return 0 ; } 