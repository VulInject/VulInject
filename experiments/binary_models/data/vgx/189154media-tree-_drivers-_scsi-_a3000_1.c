static void dma_stop ( struct Scsi_Host * instance , struct scsi_cmnd * SCpnt , int status ) { struct a3000_hostdata * hdata = shost_priv ( instance ) ; struct WD33C93_hostdata * wh = & hdata -> wh ; struct a3000_scsiregs * regs = hdata -> regs ; unsigned short cntr = CNTR_PDMD ; if ( ! wh -> dma_dir ) { cntr |= CNTR_DDIR ; } regs -> CNTR = cntr ; mb ( ) ; if ( wh -> dma_dir ) { regs -> FLUSH = 1 ; mb ( ) ; while ( ! ( regs -> ISTR & ISTR_FE_FLG ) ) { barrier ( ) ; } mb ( ) ; } regs -> SP_DMA = 1 ; mb ( ) ; regs -> CNTR = CNTR_PDMD | CNTR_INTEN ; mb ( ) ; if ( status && wh -> dma_bounce_buffer ) { if ( SCpnt ) { if ( wh -> dma_dir && SCpnt ) { memcpy ( SCpnt -> SCp . ptr , wh -> dma_bounce_buffer , SCpnt -> SCp . this_residual ) ; } kfree ( wh -> dma_bounce_buffer ) ; wh -> dma_bounce_buffer = NULL ; wh -> dma_bounce_len = 0 ; } else { kfree ( wh -> dma_bounce_buffer ) ; wh -> dma_bounce_buffer = NULL ; wh -> dma_bounce_len = 0 ; } } } 