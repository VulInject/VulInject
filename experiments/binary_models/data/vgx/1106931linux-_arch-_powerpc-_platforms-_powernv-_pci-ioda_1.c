static int __pnv_pci_ioda_msi_setup ( struct pnv_phb * phb , struct pci_dev * dev , unsigned int xive_num , unsigned int is_64 , struct msi_msg * msg ) { struct pnv_ioda_pe * pe = pnv_ioda_get_pe ( dev ) ; __be32 data ; int rc ; dev_dbg ( & dev -> dev , "%s: setup %s-bit MSI for vector #%d\n" , __func__ , is_64 ?"64" : "32" , xive_num ) ; if ( pe == NULL ) { return - ENXIO ; } if ( dev -> no_64bit_msi ) { is_64 = 0 ; } rc = opal_pci_set_xive_pe ( phb -> opal_id , pe -> pe_number , xive_num ) ; if ( rc ) { pr_warn ( "%s: OPAL error %d setting XIVE %d PE\n" , pci_name ( dev ) , rc , xive_num ) ; return - EIO ; } if ( is_64 ) { __be64 addr64 ; rc = opal_get_msi_64 ( phb -> opal_id , pe -> mve_number , xive_num , 1 , & addr64 , & data ) ; if ( rc ) { pr_warn ( "%s: OPAL error %d getting 64-bit MSI data\n" , pci_name ( dev ) , rc ) ; return - EIO ; } msg -> address_hi = be64_to_cpu ( addr64 ) >> 32 ; msg -> address_lo = be64_to_cpu ( addr64 ) & 0xfffffffful ; } else { __be32 addr32 ; rc = opal_get_msi_32 ( phb -> opal_id , pe -> mve_number , xive_num , 1 , & addr32 , & data ) ; if ( rc ) { pr_warn ( "%s: OPAL error %d getting 32-bit MSI data\n" , pci_name ( dev ) , rc ) ; return - EIO ; } msg -> address_hi = 0 ; msg -> address_lo = be32_to_cpu ( addr32 ) ; } msg -> data = be32_to_cpu ( data ) ; return 0 ; } 