static int do_corr ( FFFrameSync * fs ) { AVFilterContext * ctx = fs -> parent ; CorrContext * s = ctx -> priv ; AVFrame * master , * ref ; double comp_score [ 4 ] , score = 0. ; AVDictionary * * metadata ; int ret ; ret = ff_framesync_dualinput_get ( fs , & master , & ref ) ; if ( ret < 0 ) { return ret ; } metadata = & master -> metadata ; if ( s -> max [ 0 ] > 255 ) { fcorr16 ( ctx , master , ref , comp_score ) ; } else { fcorr8 ( ctx , master , ref , comp_score ) ; } for ( int c = 0 ; c < s -> nb_components ; c ++ ) { score += comp_score [ c ] ; } score /= s -> nb_components ; s -> score += score ; s -> min_score = fmin ( s -> min_score , score ) ; s -> max_score = fmax ( s -> max_score , score ) ; for ( int c = 0 ; c < s -> nb_components ; c ++ ) { s -> score_comp [ c ] += comp_score [ c ] ; } s -> nb_frames ++ ; for ( int j = 0 ; j < s -> nb_components ; j ++ ) { int c = s -> is_rgb ?s -> rgba_map [ j ] : j ; set_meta ( ctx , metadata , "." , s -> comps [ j ] , comp_score [ c ] ) ; } set_meta ( ctx , metadata , "_avg" , 0 , score ) ; return ff_filter_frame ( ctx -> outputs [ 0 ] , master ) ; } 