static int FlashPoint_AbortCCB ( void * pCurrCard , struct sccb * p_Sccb ) { u32 ioport ; unsigned char thisCard ; CALL_BK_FN callback ; struct sccb * pSaveSCCB ; struct sccb_mgr_tar_info * currTar_Info ; ioport = ( ( sccb_card * ) pCurrCard ) -> ioPort ; thisCard = ( ( sccb_card * ) pCurrCard ) -> cardIndex ; if ( ! ( RD_HARPOON ( ioport + hp_page_ctrl ) & G_INT_DISABLE ) ) { if ( FPT_queueFindSccb ( p_Sccb , thisCard ) ) { ( ( sccb_card * ) pCurrCard ) -> cmdCounter -- ; if ( ! ( ( sccb_card * ) pCurrCard ) -> cmdCounter ) { WR_HARPOON ( ioport + hp_semaphore , ( RD_HARPOON ( ioport + hp_semaphore ) & ( unsigned char ) ( ~ ( SCCB_MGR_ACTIVE | TICKLE_ME ) ) ) ) ; } p_Sccb -> SccbStatus = SCCB_ABORT ; callback = p_Sccb -> SccbCallback ; callback ( p_Sccb ) ; return 0 ; } else { if ( ( ( sccb_card * ) pCurrCard ) -> currentSCCB == p_Sccb ) { p_Sccb -> SccbStatus = SCCB_ABORT ; return 0 ; } else { if ( p_Sccb -> Sccb_tag ) { MDISABLE_INT ( ioport ) ; if ( ( ( sccb_card * ) pCurrCard ) -> discQ_Tbl [ p_Sccb -> Sccb_tag ] == p_Sccb ) { p_Sccb -> SccbStatus = SCCB_ABORT ; p_Sccb -> Sccb_scsistat = ABORT_ST ; p_Sccb -> Sccb_scsimsg = ABORT_TASK ; if ( ( ( sccb_card * ) pCurrCard ) -> currentSCCB == NULL ) { ( ( sccb_card * ) pCurrCard ) -> currentSCCB = p_Sccb ; FPT_ssel ( ioport , thisCard ) ; } else { pSaveSCCB = ( ( sccb_card * ) pCurrCard ) -> currentSCCB ; ( ( sccb_card * ) pCurrCard ) -> currentSCCB = p_Sccb ; FPT_queueSelectFail ( ( sccb_card * ) pCurrCard , thisCard ) ; ( ( sccb_card * ) pCurrCard ) -> currentSCCB = pSaveSCCB ; } } MENABLE_INT ( ioport , NULL ) ; return 0 ; } else { currTar_Info = & FPT_sccbMgrTbl [ thisCard ] [ p_Sccb -> TargID ] ; if ( FPT_BL_Card [ thisCard ] . discQ_Tbl [ currTar_Info -> LunDiscQ_Idx [ p_Sccb -> Lun ] ] == p_Sccb ) { p_Sccb -> SccbStatus = SCCB_ABORT ; return 0 ; } } } } } return - 1 ; } 