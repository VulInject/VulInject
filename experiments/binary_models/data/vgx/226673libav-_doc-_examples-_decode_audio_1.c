int main ( int argc , char * * argv ) { const char * outfilename , * filename ; const AVCodec * codec ; AVCodecContext * c = NULL ; AVCodecParserContext * parser = NULL ; int len , ret ; FILE * f , * outfile ; uint8_t inbuf [ AUDIO_INBUF_SIZE + AV_INPUT_BUFFER_PADDING_SIZE ] ; uint8_t * data ; size_t data_size ; AVPacket * pkt ; AVFrame * decoded_frame = NULL ; if ( argc <= 2 ) { fprintf ( stderr , "Usage: %s<input file><output file>\n" , argv [ 0 ] ) ; exit ( 0 ) ; } filename = argv [ 1 ] ; outfilename = argv [ 2 ] ; avcodec_register_all ( ) ; pkt = av_packet_alloc ( ) ; codec = avcodec_find_decoder ( AV_CODEC_ID_MP2 ) ; if ( ! codec ) { fprintf ( stderr , "codec not found\n" ) ; exit ( 1 ) ; } parser = av_parser_init ( codec -> id ) ; if ( ! parser ) { fprintf ( stderr , "parser not found\n" ) ; exit ( 1 ) ; } c = avcodec_alloc_context3 ( codec ) ; if ( avcodec_open2 ( c , codec , NULL ) < 0 ) { fprintf ( stderr , "could not open codec\n" ) ; exit ( 1 ) ; } f = fopen ( filename , "rb" ) ; if ( ! f ) { fprintf ( stderr , "could not open %s\n" , filename ) ; exit ( 1 ) ; } outfile = fopen ( outfilename , "wb" ) ; if ( ! outfile ) { exit ( 1 ) ; } data = inbuf ; data_size = fread ( inbuf , 1 , AUDIO_INBUF_SIZE , f ) ; while ( data_size > 0 ) { if ( ! decoded_frame ) { if ( ! ( decoded_frame = av_frame_alloc ( ) ) ) { fprintf ( stderr , "out of memory\n" ) ; exit ( 1 ) ; } } ret = av_parser_parse2 ( parser , c , & pkt -> data , & pkt -> size , data , data_size , AV_NOPTS_VALUE , AV_NOPTS_VALUE , 0 ) ; if ( ret < 0 ) { fprintf ( stderr , "Error while parsing\n" ) ; exit ( 1 ) ; } data += ret ; data_size -= ret ; if ( pkt -> size ) { decode ( c , pkt , decoded_frame , outfile ) ; } if ( data_size < AUDIO_REFILL_THRESH ) { memmove ( inbuf , data , data_size ) ; data = inbuf ; len = fread ( data + data_size , 1 , AUDIO_INBUF_SIZE - data_size , f ) ; if ( len > 0 ) { data_size += len ; } } } pkt -> data = NULL ; pkt -> size = 0 ; decode ( c , pkt , decoded_frame , outfile ) ; fclose ( outfile ) ; fclose ( f ) ; avcodec_free_context ( & c ) ; av_parser_close ( parser ) ; av_frame_free ( & decoded_frame ) ; av_packet_free ( & pkt ) ; return 0 ; } 