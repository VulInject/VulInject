int umb_add_inet6_config ( struct umb_softc * sc , struct in6_addr * ip , u_int prefixlen , struct in6_addr * gw ) { struct ifnet * ifp = GET_IFP ( sc ) ; struct in6_aliasreq ifra ; struct sockaddr_in6 * sin6 , default_sin6 ; struct rt_addrinfo info ; struct rtentry * rt ; int rv ; memset ( & ifra , 0 , sizeof ( ifra ) ) ; sin6 = & ifra . ifra_addr ; sin6 -> sin6_family = AF_INET6 ; sin6 -> sin6_len = sizeof ( * sin6 ) ; memcpy ( & sin6 -> sin6_addr , ip , sizeof ( sin6 -> sin6_addr ) ) ; sin6 = & ifra . ifra_dstaddr ; sin6 -> sin6_family = AF_INET6 ; sin6 -> sin6_len = sizeof ( * sin6 ) ; memcpy ( & sin6 -> sin6_addr , gw , sizeof ( sin6 -> sin6_addr ) ) ; prefixlen = 128 ; sin6 = & ifra . ifra_prefixmask ; sin6 -> sin6_family = AF_INET6 ; sin6 -> sin6_len = sizeof ( * sin6 ) ; in6_prefixlen2mask ( & sin6 -> sin6_addr , prefixlen ) ; ifra . ifra_lifetime . ia6t_vltime = ND6_INFINITE_LIFETIME ; ifra . ifra_lifetime . ia6t_pltime = ND6_INFINITE_LIFETIME ; rv = in6_ioctl ( SIOCAIFADDR_IN6 , ( caddr_t ) & ifra , ifp , 1 ) ; if ( rv != 0 ) { printf ( "%s: unable to set IPv6 address, error %d\n" , DEVNAM ( ifp -> if_softc ) , rv ) ; return rv ; } memset ( & default_sin6 , 0 , sizeof ( default_sin6 ) ) ; default_sin6 . sin6_family = AF_INET6 ; default_sin6 . sin6_len = sizeof ( default_sin6 ) ; info . rti_flags = RTF_GATEWAY ; info . rti_ifa = ifa_ifwithaddr ( sin6tosa ( & ifra . ifra_addr ) , ifp -> if_rdomain ) ; info . rti_info [ RTAX_DST ] = sin6tosa ( & default_sin6 ) ; info . rti_info [ RTAX_NETMASK ] = sin6tosa ( & default_sin6 ) ; info . rti_info [ RTAX_GATEWAY ] = sin6tosa ( & ifra . ifra_dstaddr ) ; NET_LOCK ( ) ; rv = rtrequest ( RTM_ADD , & info , 0 , & rt , ifp -> if_rdomain ) ; NET_UNLOCK ( ) ; if ( rv ) { printf ( "%s: unable to set IPv6 default route, " "error %d\n" , DEVNAM ( ifp -> if_softc ) , rv ) ; rtm_miss ( RTM_MISS , & info , 0 , RTP_NONE , 0 , rv , ifp -> if_rdomain ) ; } else { rtm_send ( rt , RTM_ADD , rv , ifp -> if_rdomain ) ; rtfree ( rt ) ; } if ( ifp -> if_flags & IFF_DEBUG ) { char str [ 3 ] [ INET6_ADDRSTRLEN ] ; log ( LOG_INFO , "%s: IPv6 addr %s, mask %s, gateway %s\n" , DEVNAM ( ifp -> if_softc ) , sockaddr_ntop ( sin6tosa ( & ifra . ifra_addr ) , str [ 0 ] , sizeof ( str [ 0 ] ) ) , sockaddr_ntop ( sin6tosa ( & ifra . ifra_prefixmask ) , str [ 1 ] , sizeof ( str [ 1 ] ) ) , sockaddr_ntop ( sin6tosa ( & ifra . ifra_dstaddr ) , str [ 2 ] , sizeof ( str [ 2 ] ) ) ) ; } return 0 ; } 