static CK_RV token_wrap_key_object ( TSS_HCONTEXT hContext , CK_OBJECT_HANDLE ckObject , TSS_HKEY hParentKey , TSS_HKEY * phKey ) { CK_RV rc = CKR_OK ; CK_ATTRIBUTE * attr = NULL , * new_attr , * prime_attr ; CK_ULONG class key_type ; OBJECT * obj ; TSS_RESULT result ; TSS_FLAG initFlags = 0 ; BYTE * rgbBlob ; UINT32 ulBlobLen ; if ( ( rc = object_mgr_find_in_map1 ( hContext , ckObject , & obj ) ) ) { return ( rc ) ; } if ( template_attribute_find ( , , ) == FALSE ) { return ( CKR_TEMPLATE_INCOMPLETE ) ; } key_type = * ( ( CK_ULONG * ) attr -> pValue ) ; if ( template_attribute_find ( , , ) == FALSE ) { return ( CKR_TEMPLATE_INCOMPLETE ) ; } class = * ( ( CK_ULONG * ) attr -> pValue ) ; if ( class == CKO_PRIVATE_KEY ) { if ( template_attribute_find ( , , ) == FALSE ) { if ( template_attribute_find ( , , ) == FALSE ) { return ( CKR_TEMPLATE_INCOMPLETE ) ; } } if ( ( rc = util_check_public_exponent ( ) ) ) { return ( CKR_TEMPLATE_INCONSISTENT ) ; } if ( template_attribute_find ( , , ) == FALSE ) { return ( CKR_TEMPLATE_INCOMPLETE ) ; } initFlags = util_get_keysize_flag ( attr -> ulValueLen * 8 ) ; if ( initFlags == 0 ) { return ( CKR_TEMPLATE_INCONSISTENT ) ; } if ( ( rc = token_wrap_sw_key ( hContext , ( int ) attr -> ulValueLen , attr -> pValue , ( int ) prime_attr -> ulValueLen , prime_attr -> pValue , hParentKey , TSS_KEY_TYPE_LEGACY | TSS_KEY_NO_AUTHORIZATION , phKey ) ) ) { return ( rc ) ; } } if ( class == CKO_PUBLIC_KEY ) { if ( ( util_check_public_exponent ( ) ) ) { return ( CKR_TEMPLATE_INCONSISTENT ) ; } if ( template_attribute_find ( , , ) == FALSE ) { return ( CKR_TEMPLATE_INCONSISTENT ) ; } initFlags = util_get_keysize_flag ( attr -> ulValueLen * 8 ) ; if ( initFlags == 0 ) { return ( CKR_TEMPLATE_INCONSISTENT ) ; } initFlags |= TSS_KEY_MIGRATABLE | TSS_KEY_NO_AUTHORIZATION | TSS_KEY_TYPE_LEGACY ; if ( ( result = Tspi_Context_CreateObject ( hContext , TSS_OBJECT_TYPE_RSAKEY , initFlags , phKey ) ) ) { stlogit ( "Tspi_Context_CreateObject: 0x%0x - %s" , result , Trspi_Error_String ( result ) ) ; return ( result ) ; } if ( ( result = set_public_modulus ( hContext , * phKey , attr -> ulValueLen , attr -> pValue ) ) ) { Tspi_Context_CloseObject ( hContext , * phKey ) ; * phKey = NULL_HKEY ; return ( CKR_FUNCTION_FAILED ) ; } result = tss_assign_secret_key_policy ( hContext , TSS_POLICY_MIGRATION , * phKey , NULL ) ; if ( result ) { Tspi_Context_CloseObject ( hContext , * phKey ) ; * phKey = NULL_HKEY ; return ( CKR_FUNCTION_FAILED ) ; } result = set_legacy_key_params ( * phKey ) ; if ( result ) { Tspi_Context_CloseObject ( hContext , * phKey ) ; * phKey = NULL_HKEY ; return ( CKR_FUNCTION_FAILED ) ; } } else { return ( CKR_FUNCTION_FAILED ) ; } if ( ( result = Tspi_GetAttribData ( * phKey , TSS_TSPATTRIB_KEY_BLOB , TSS_TSPATTRIB_KEYBLOB_BLOB , & ulBlobLen , & rgbBlob ) ) ) { stlogit ( "Tspi_GetAttribData: 0x%0x - %s" , result , Trspi_Error_String ( result ) ) ; return ( CKR_FUNCTION_FAILED ) ; } if ( ( rc = build_attribute ( CKA_IBM_OPAQUE , rgbBlob , ulBlobLen , & new_attr ) ) ) { Tspi_Context_FreeMemory ( hContext , rgbBlob ) ; return ( rc ) ; } ( void ) template_update_attribute ( , ) ; Tspi_Context_FreeMemory ( hContext , rgbBlob ) ; if ( ! object_is_session_object ( obj ) ) { rc = save_token_object ( hContext , obj ) ; } return ( rc ) ; } 