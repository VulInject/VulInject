static int msdc_start_command ( struct msdc_host * host , struct mmc_cmd * cmd , struct mmc_data * data ) { u32 rawcmd ; u32 status ; u32 blocks = 0 ; int ret ; if ( ! msdc_cmd_is_ready ( host ) ) { return - EIO ; } if ( ( readl ( & host -> base -> msdc_fifocs ) & MSDC_FIFOCS_TXCNT_M ) >> MSDC_FIFOCS_TXCNT_S || ( readl ( & host -> base -> msdc_fifocs ) & MSDC_FIFOCS_RXCNT_M ) >> MSDC_FIFOCS_RXCNT_S ) { pr_err ( "TX/RX FIFO non-empty before start of IO. Reset\n" ) ; msdc_reset_hw ( host , NULL ) ; } msdc_fifo_clr ( host ) ; host -> last_resp_type = cmd -> resp_type ; host -> last_data_write = 0 ; rawcmd = msdc_cmd_prepare_raw_cmd ( host , cmd , data ) ; if ( data ) { blocks = data -> blocks ; } writel ( CMD_INTS_MASK , & host -> base -> msdc_int ) ; writel ( DATA_INTS_MASK , & host -> base -> msdc_int ) ; writel ( blocks , & host -> base -> sdc_blk_num ) ; writel ( cmd -> cmdarg , & host -> base -> sdc_arg ) ; writel ( rawcmd , & host -> base -> sdc_cmd ) ; ret = readl_poll_timeout ( & host -> base -> msdc_int , status , status & CMD_INTS_MASK , 1000000 ) ; if ( ret ) { status = MSDC_INT_CMDTMO ; } return msdc_cmd_done ( host , status , cmd ) ; } 