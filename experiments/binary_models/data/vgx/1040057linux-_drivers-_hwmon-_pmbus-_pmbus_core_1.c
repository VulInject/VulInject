static int pmbus_init_common ( struct i2c_client * client , struct pmbus_data * data , struct pmbus_driver_info * info ) { struct device * dev = & client -> dev ; int page , ret ; client -> flags &= ~ I2C_CLIENT_PEC ; if ( ! ( data -> flags & PMBUS_NO_CAPABILITY ) ) { ret = i2c_smbus_read_byte_data ( client , PMBUS_CAPABILITY ) ; if ( ret >= 0 && ( ret & PB_CAPABILITY_ERROR_CHECK ) ) { if ( i2c_check_functionality ( client -> adapter , I2C_FUNC_SMBUS_PEC ) ) { client -> flags |= I2C_CLIENT_PEC ; } } } ret = i2c_smbus_read_word_data ( client , PMBUS_STATUS_WORD ) ; if ( ret < 0 || ret == 0xffff ) { data -> read_status = pmbus_read_status_byte ; ret = i2c_smbus_read_byte_data ( client , PMBUS_STATUS_BYTE ) ; if ( ret < 0 || ret == 0xff ) { dev_err ( dev , "PMBus status register not found\n" ) ; return - ENODEV ; } } else { data -> has_status_word = true ; } if ( ! ( data -> flags & PMBUS_NO_WRITE_PROTECT ) ) { ret = i2c_smbus_read_byte_data ( client , PMBUS_WRITE_PROTECT ) ; if ( ret > 0 && ( ret & PB_WP_ANY ) ) { data -> flags |= PMBUS_WRITE_PROTECTED | PMBUS_SKIP_STATUS_CHECK ; } } if ( data -> info -> pages ) { pmbus_clear_faults ( client ) ; } else { pmbus_clear_fault_page ( client , - 1 ) ; } if ( info -> identify ) { ret = * info -> identify ( client , info ) ; if ( ret < 0 ) { dev_err ( dev , "Chip identification failed\n" ) ; return ret ; } } if ( info -> pages <= 0 || info -> pages > PMBUS_PAGES ) { dev_err ( dev , "Bad number of PMBus pages: %d\n" , info -> pages ) ; return - ENODEV ; } for ( page = 0 ; page < info -> pages ; page ++ ) { ret = pmbus_identify_common ( client , data , page ) ; if ( ret < 0 ) { dev_err ( dev , "Failed to identify chip capabilities\n" ) ; return ret ; } } if ( data -> flags & PMBUS_USE_COEFFICIENTS_CMD ) { if ( ! i2c_check_functionality ( client -> adapter , I2C_FUNC_SMBUS_BLOCK_PROC_CALL ) ) { return - ENODEV ; } ret = pmbus_init_coefficients ( client , info ) ; if ( ret < 0 ) { return ret ; } } if ( client -> flags & I2C_CLIENT_PEC ) { ret = device_create_file ( dev , & dev_attr_pec ) ; if ( ret ) { return ret ; } ret = devm_add_action_or_reset ( dev , pmbus_remove_pec , dev ) ; if ( ret ) { return ret ; } } return 0 ; } 