static int hclge_get_64_bit_regs ( struct hclge_dev * hdev , u32 regs_num , void * data ) { struct hclge_desc * desc ; u64 * reg_val = data ; __le64 * desc_data ; int nodata_len ; int cmd_num ; int i , k , n ; int ret ; if ( regs_num == 0 ) { return 0 ; } nodata_len = HCLGE_64_BIT_DESC_NODATA_LEN ; cmd_num = DIV_ROUND_UP ( regs_num + nodata_len , HCLGE_64_BIT_REG_RTN_DATANUM ) ; desc = kcalloc ( cmd_num , sizeof ( hclge_desc ) , GFP_KERNEL ) ; if ( ! desc ) { return - ENOMEM ; } hclge_cmd_setup_basic_desc ( & desc [ 0 ] , HCLGE_OPC_QUERY_64_BIT_REG , true ) ; ret = hclge_cmd_send ( & hdev -> hw , desc , cmd_num ) ; if ( ret ) { dev_err ( & hdev -> pdev -> dev , "Query 64 bit register cmd failed, ret = %d.\n" , ret ) ; return ret ; } for ( i = 0 ; i < cmd_num ; i ++ ) { if ( i == 0 ) { desc_data = ( __le64 * ) ( & desc [ i ] . data [ 0 ] ) ; n = HCLGE_64_BIT_REG_RTN_DATANUM - nodata_len ; } else { desc_data = ( __le64 * ) ( & desc [ i ] ) ; n = HCLGE_64_BIT_REG_RTN_DATANUM ; } for ( k = 0 ; k < n ; k ++ ) { * reg_val ++ = le64_to_cpu ( * desc_data ++ ) ; regs_num -- ; if ( ! regs_num ) { break ; } } } kfree ( desc ) ; return 0 ; } 