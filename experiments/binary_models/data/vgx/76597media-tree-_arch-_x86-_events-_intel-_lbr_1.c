static void intel_pmu_lbr_filter ( struct cpu_hw_events * cpuc ) { u64 from , to ; int br_sel = cpuc -> br_sel ; int i , j , type ; bool compress = false ; if ( ( br_sel & X86_BR_ALL ) == X86_BR_ALL ) { return ; } for ( i = 0 ; i < cpuc -> lbr_stack . nr ; i ++ ) { from = cpuc -> lbr_entries [ i ] . from ; to = cpuc -> lbr_entries [ i ] . to ; type = branch_type ( from , to , cpuc -> lbr_entries [ i ] . abort ) ; if ( type != X86_BR_NONE && ( br_sel & X86_BR_ANYTX ) ) { if ( cpuc -> lbr_entries [ i ] . in_tx ) { type |= X86_BR_IN_TX ; } else { type |= X86_BR_NO_TX ; } } if ( type == X86_BR_NONE || ( br_sel & type ) != type ) { cpuc -> lbr_entries [ i ] . from = 0 ; compress = true ; } } for ( i = 0 ; i < cpuc -> lbr_stack . nr ; ) { if ( ! cpuc -> lbr_entries [ i ] . from ) { j = i ; while ( ++ j < cpuc -> lbr_stack . nr ) { cpuc -> lbr_entries [ j - 1 ] = cpuc -> lbr_entries [ j ] ; } cpuc -> lbr_stack . nr -- ; if ( ! cpuc -> lbr_entries [ i ] . from ) { continue ; } } i ++ ; } } 