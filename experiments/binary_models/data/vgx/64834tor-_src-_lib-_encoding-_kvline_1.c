config_line_t * kvline_parse ( const char * line , unsigned flags ) { tor_assert ( ( flags & ( KV_OMIT_KEYS | KV_OMIT_VALS ) ) != ( KV_OMIT_KEYS | KV_OMIT_VALS ) ) ; tor_assert ( ! ( flags & KV_RAW ) ) ; const char * cp = line , * cplast = NULL ; const bool omit_keys = ( flags & KV_OMIT_KEYS ) != 0 ; const bool omit_vals = ( flags & KV_OMIT_VALS ) != 0 ; const bool quoted = ( flags & ( KV_QUOTED | KV_QUOTED_QSTRING ) ) != 0 ; const bool c_quoted = ( flags & ( KV_QUOTED ) ) != 0 ; config_line_t * result = NULL ; config_line_t * * next_line = & result ; char * key = NULL ; char * val = NULL ; while ( * cp ) { key = val = NULL ; { size_t idx = strspn ( cp , " \t\r\v\n" ) ; cp += idx ; } if ( BUG ( cp == cplast ) ) { err } cplast = cp ; if ( ! * cp ) { break ; } if ( * cp != '\"' ) { size_t idx = strcspn ( cp , " \t\r\v\n=" ) ; if ( cp [ idx ] == '=' ) { key = tor_memdup_nulterm ( cp , idx ) ; cp += idx + 1 ; } if ( omit_vals ) { key = tor_memdup_nulterm ( cp , idx ) ; cp += idx ; commit } else { if ( ! omit_keys ) { err } } } if ( * cp == '\"' ) { if ( ! quoted ) { err } size_t len = 0 ; if ( c_quoted ) { cp = unescape_string ( cp , & val , & len ) ; } else { cp = decode_qstring ( cp , strlen ( cp ) , & val , & len ) ; } } else { size_t idx = strcspn ( cp , " \t\r\v\n" ) ; val = tor_memdup_nulterm ( cp , idx ) ; cp += idx ; } commit if ( key && strlen ( key ) == 0 ) { err } * next_line = tor_malloc_zero ( sizeof ( config_line_t ) ) ; ( * next_line ) -> key = key ?key : tor_strdup ( "" ) ; ( * next_line ) -> value = val ?val : tor_strdup ( "" ) ; next_line = & ( * next_line ) -> next ; key = val = NULL ; } if ( ! ( flags & KV_QUOTED_QSTRING ) ) { if ( ! kvline_can_encode_lines ( result , flags ) ) { err } } return result ; err tor_free ( key ) ; tor_free ( val ) ; config_free_lines ( result ) ; return NULL ; } 