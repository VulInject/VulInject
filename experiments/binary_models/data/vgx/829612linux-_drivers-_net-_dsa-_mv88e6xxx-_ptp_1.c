static int mv88e6352_ptp_enable_extts ( struct mv88e6xxx_chip * chip , struct ptp_clock_request * rq , int on ) { int rising = ( rq -> extts . flags & PTP_RISING_EDGE ) ; int func ; int pin ; int err ; if ( ( rq -> extts . flags & PTP_STRICT_FLAGS ) && ( rq -> extts . flags & PTP_ENABLE_FEATURE ) && ( rq -> extts . flags & PTP_EXTTS_EDGES ) == PTP_EXTTS_EDGES ) { return - EOPNOTSUPP ; } pin = ptp_find_pin ( chip -> ptp_clock , PTP_PF_EXTTS , rq -> extts . index ) ; if ( pin < 0 ) { return - EBUSY ; } mv88e6xxx_reg_lock ( chip ) ; if ( on ) { func = MV88E6352_G2_SCRATCH_GPIO_PCTL_EVREQ ; err = mv88e6352_set_gpio_func ( chip , pin , func , true ) ; if ( err ) { out } schedule_delayed_work ( & chip -> tai_event_work , TAI_EVENT_WORK_INTERVAL ) ; err = mv88e6352_config_eventcap ( chip , PTP_CLOCK_EXTTS , rising ) ; } else { func = MV88E6352_G2_SCRATCH_GPIO_PCTL_GPIO ; err = mv88e6352_set_gpio_func ( chip , pin , func , true ) ; cancel_delayed_work_sync ( & chip -> tai_event_work ) ; } out mv88e6xxx_reg_unlock ( chip ) ; return err ; } 