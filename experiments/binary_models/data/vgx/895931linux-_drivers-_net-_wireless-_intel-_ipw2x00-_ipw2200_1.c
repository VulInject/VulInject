static int ipw_associate ( void * data ) { struct ipw_priv * priv = data ; struct libipw_network * network = NULL ; struct ipw_network_match match = { . network = NULL } ; struct ipw_supported_rates * rates ; struct list_head * element ; cfs_time_t flags ; if ( priv -> ieee -> iw_mode == IW_MODE_MONITOR ) { IPW_DEBUG_ASSOC ( "Not attempting association (monitor mode)\n" ) ; return 0 ; } if ( priv -> status & ( STATUS_ASSOCIATED | STATUS_ASSOCIATING ) ) { IPW_DEBUG_ASSOC ( "Not attempting association (already in " "progress)\n" ) ; return 0 ; } if ( priv -> status & STATUS_DISASSOCIATING ) { IPW_DEBUG_ASSOC ( "Not attempting association (in disassociating)\n" ) ; schedule_work ( & priv -> associate ) ; return 0 ; } if ( ! ipw_is_init ( priv ) || ( priv -> status & STATUS_SCANNING ) ) { IPW_DEBUG_ASSOC ( "Not attempting association (scanning or not " "initialized)\n" ) ; return 0 ; } if ( ! ( priv -> config & CFG_ASSOCIATE ) && ! ( priv -> config & ( CFG_STATIC_ESSID | CFG_STATIC_BSSID ) ) ) { IPW_DEBUG_ASSOC ( "Not attempting association (associate=0)\n" ) ; return 0 ; } spin_lock_irqsave ( & priv -> ieee -> lock , flags ) ; list_for_each_entry ( , , ) ipw_best_network ( priv , & match , network , 0 ) ; network = match . network ; rates = & match . rates ; if ( network == NULL && priv -> ieee -> iw_mode == IW_MODE_ADHOC && priv -> config & CFG_ADHOC_CREATE && priv -> config & CFG_STATIC_ESSID && priv -> config & CFG_STATIC_CHANNEL ) { if ( list_empty ( & priv -> ieee -> network_free_list ) ) { struct libipw_network * oldest = NULL ; struct libipw_network * target ; list_for_each_entry ( , , ) { if ( ( oldest == NULL ) || ( target -> last_scanned < oldest -> last_scanned ) ) { oldest = target ; } } list_del ( & oldest -> list ) ; target = oldest ; IPW_DEBUG_ASSOC ( "Expired '%*pE' (%pM) from network list.\n" , target -> ssid_len , target -> ssid , target -> bssid ) ; list_add_tail ( & target -> list , & priv -> ieee -> network_free_list ) ; } element = priv -> ieee -> network_free_list . next ; network = list_entry ( element , libipw_network , list ) ; ipw_adhoc_create ( priv , network ) ; rates = & priv -> rates ; list_del ( element ) ; list_add_tail ( & network -> list , & priv -> ieee -> network_list ) ; } spin_unlock_irqrestore ( & priv -> ieee -> lock , flags ) ; if ( ! network ) { ipw_debug_config ( priv ) ; if ( ! ( priv -> status & STATUS_SCANNING ) ) { if ( ! ( priv -> config & CFG_SPEED_SCAN ) ) { schedule_delayed_work ( & priv -> request_scan , SCAN_INTERVAL ) ; } else { schedule_delayed_work ( & priv -> request_scan , 0 ) ; } } return 0 ; } ipw_associate_network ( priv , network , rates , 0 ) ; return 1 ; } 