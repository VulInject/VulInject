static int zynq_nand_init_nand_flash ( struct mtd_info * mtd , int option ) { struct nand_chip * nand_chip = mtd_to_nand ( mtd ) ; struct nand_drv * smc = nand_get_controller_data ( nand_chip ) ; u32 status ; writel ( ZYNQ_NAND_CLR_CONFIG , & smc -> reg -> cfr ) ; writel ( ZYNQ_NAND_SET_CYCLES , & smc -> reg -> scr ) ; if ( option & NAND_BUSWIDTH_16 ) { writel ( ZYNQ_NAND_SET_OPMODE_16BIT , & smc -> reg -> sor ) ; } else { writel ( ZYNQ_NAND_SET_OPMODE_8BIT , & smc -> reg -> sor ) ; } writel ( ZYNQ_NAND_DIRECT_CMD , & smc -> reg -> dcr ) ; status = zynq_nand_waitfor_ecc_completion ( mtd , NULL ) ; if ( status < 0 ) { printf ( "%s: Timeout\n" , __func__ ) ; return status ; } writel ( ZYNQ_NAND_ECC_CMD1 , & smc -> reg -> emcmd1r ) ; writel ( ZYNQ_NAND_ECC_CMD2 , & smc -> reg -> emcmd2r ) ; return 0 ; } 