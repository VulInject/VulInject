int perf_uprobe_init ( struct perf_event * p_event , unsigned long ref_ctr_offset , bool is_retprobe ) { int ret ; char * path = NULL ; struct trace_event_call * tp_event ; if ( ! p_event -> attr . uprobe_path ) { return - EINVAL ; } path = strndup_user ( u64_to_user_ptr ( p_event -> attr . uprobe_path ) , PATH_MAX ) ; if ( IS_ERR ( path ) ) { ret = PTR_ERR ( path ) ; return ( ret == - EINVAL ) ?- E2BIG : ret ; } if ( path [ 0 ] == '\0' ) { ret = - EINVAL ; out } tp_event = create_local_trace_uprobe ( path , p_event -> attr . probe_offset , ref_ctr_offset , is_retprobe ) ; if ( IS_ERR ( tp_event ) ) { ret = PTR_ERR ( tp_event ) ; out } mutex_lock ( & event_mutex ) ; ret = perf_trace_event_init ( tp_event , p_event ) ; if ( ret ) { destroy_local_trace_uprobe ( tp_event ) ; } mutex_unlock ( & event_mutex ) ; out return ret ; } 