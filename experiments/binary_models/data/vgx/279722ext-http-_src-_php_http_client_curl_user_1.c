static int php_http_client_curl_user_socket ( CURL * easy , curl_socket_t sock , int action , void * socket_data , void * assign_data ) { php_http_client_curl_user_context_t * ctx = socket_data ; php_http_client_curl_t * curl = ctx -> client -> ctx ; php_http_client_curl_user_ev_t * ev = assign_data ; zval args [ 2 ] , * zaction = & args [ 1 ] , * zsocket = & args [ 0 ] ; fprintf ( stderr , "S" ) ; if ( ! ev ) { ev = ecalloc ( 1 , sizeof ( * ev ) ) ; ev -> context = ctx ; ev -> socket = php_stream_sock_open_from_socket ( sock , NULL ) ; curl_multi_assign ( curl -> handle -> multi , sock , ev ) ; } switch ( action ) { case CURL_POLL_IN : case CURL_POLL_OUT : case CURL_POLL_INOUT : case CURL_POLL_REMOVE : case CURL_POLL_NONE : php_stream_to_zval ( ev -> socket , zsocket ) ; Z_TRY_ADDREF_P ( zsocket ) ; ZVAL_LONG ( zaction , action ) ; php_http_object_method_call ( & ctx -> socket , & ctx -> user , NULL , 2 , args ) ; zval_ptr_dtor ( zsocket ) ; zval_ptr_dtor ( zaction ) ; break ; default : php_error_docref ( NULL , E_WARNING , "Unknown socket action %d" , action ) ; return - 1 ; } if ( action == CURL_POLL_REMOVE ) { php_stream_close ( ev -> socket ) ; curl_multi_assign ( curl -> handle -> multi , sock , NULL ) ; } return 0 ; } 