static int __init __reserved_mem_alloc_size ( unsigned long node , const char * uname , phys_addr_t * res_base , phys_addr_t * res_size ) { int t_len = ( dt_root_addr_cells + dt_root_size_cells ) * sizeof ( __be32 ) ; phys_addr_t start = 0 , end = 0 ; phys_addr_t base = 0 , align = 0 , size ; int len ; const __be32 * prop ; bool nomap ; int ret ; prop = of_get_flat_dt_prop ( node , "size" , & len ) ; if ( len != dt_root_size_cells * sizeof ( __be32 ) ) { pr_err ( "invalid size property in '%s' node.\n" , uname ) ; return - EINVAL ; } size = dt_mem_next_cell ( dt_root_size_cells , & prop ) ; prop = of_get_flat_dt_prop ( node , "alignment" , & len ) ; if ( prop ) { if ( len != dt_root_addr_cells * sizeof ( __be32 ) ) { pr_err ( "invalid alignment property in '%s' node.\n" , uname ) ; return - EINVAL ; } align = dt_mem_next_cell ( dt_root_addr_cells , & prop ) ; } nomap = of_get_flat_dt_prop ( node , "no-map" , NULL ) != NULL ; if ( IS_ENABLED ( CONFIG_CMA ) && of_flat_dt_is_compatible ( node , "shared-dma-pool" ) && of_get_flat_dt_prop ( node , "reusable" , NULL ) && ! nomap ) { align = max_t ( phys_addr_t , align , CMA_MIN_ALIGNMENT_BYTES ) ; } prop = of_get_flat_dt_prop ( node , "alloc-ranges" , & len ) ; if ( prop ) { if ( len % t_len != 0 ) { pr_err ( "invalid alloc-ranges property in '%s', skipping node.\n" , uname ) ; return - EINVAL ; } base = 0 ; while ( len > 0 ) { start = dt_mem_next_cell ( dt_root_addr_cells , & prop ) ; end = start + dt_mem_next_cell ( dt_root_size_cells , & prop ) ; ret = early_init_dt_alloc_reserved_memory_arch ( size , align , start , end , nomap , & base ) ; if ( ret == 0 ) { pr_debug ( "allocated memory for '%s' node: base %pa, size %lu MiB\n" , uname , & base , ( unsigned long ) ( size / SZ_1M ) ) ; break ; } len -= t_len ; } } else { ret = early_init_dt_alloc_reserved_memory_arch ( size , align , 0 , 0 , nomap , & base ) ; if ( ret == 0 ) { pr_debug ( "allocated memory for '%s' node: base %pa, size %lu MiB\n" , uname , & base , ( unsigned long ) ( size / SZ_1M ) ) ; } } if ( base == 0 ) { pr_err ( "failed to allocate memory for node '%s': size %lu MiB\n" , uname , ( unsigned long ) ( size / SZ_1M ) ) ; return - ENOMEM ; } * res_base = base ; * res_size = size ; return 0 ; } 