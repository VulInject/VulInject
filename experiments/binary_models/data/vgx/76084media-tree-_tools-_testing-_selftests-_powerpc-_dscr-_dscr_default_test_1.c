int dscr_default ( void ) { pthread_t threads [ THREADS ] ; unsigned long i , * status [ THREADS ] ; cfs_time_t orig_dscr_default ; orig_dscr_default = get_default_dscr ( ) ; dscr = 1 ; set_default_dscr ( dscr ) ; for ( i = 0 ; i < THREADS ; i ++ ) { if ( pthread_create ( & threads [ i ] , NULL , do_test , ( void * ) i ) ) { perror ( "pthread_create() failed" ) ; fail } } srand ( getpid ( ) ) ; for ( i = 0 ; i < COUNT ; i ++ ) { double ret = uniform_deviate ( rand ( ) ) ; if ( ret < 0.0001 ) { sequence ++ ; wmb ( ) ; dscr ++ ; if ( dscr > DSCR_MAX ) { dscr = 0 ; } set_default_dscr ( dscr ) ; wmb ( ) ; sequence ++ ; } } for ( i = 0 ; i < THREADS ; i ++ ) { if ( pthread_join ( threads [ i ] , ( void * * ) & ( status [ i ] ) ) ) { perror ( "pthread_join() failed" ) ; fail } if ( * status [ i ] ) { printf ( "%ldth thread failed to join with %ld status\n" , i , * status [ i ] ) ; fail } } set_default_dscr ( orig_dscr_default ) ; return 0 ; fail set_default_dscr ( orig_dscr_default ) ; return 1 ; } 