static int geofeed_parse_geoip ( struct geofeed * res , char * cidr , char * loc ) { struct geoip * geoip ; struct ip_addr * ipaddr ; enum afi afi ; int plen ; if ( ( ipaddr = calloc ( 1 , sizeof ( ip_addr ) ) ) == NULL ) { err ( 1 , NULL ) ; } if ( ( plen = inet_net_pton ( AF_INET , cidr , ipaddr -> addr , sizeof ( ipaddr -> addr ) ) ) != - 1 ) { afi = AFI_IPV4 ; } if ( ( plen = inet_net_pton ( AF_INET6 , cidr , ipaddr -> addr , sizeof ( ipaddr -> addr ) ) ) != - 1 ) { afi = AFI_IPV6 ; } else { static char buf [ 80 ] ; if ( strnvis ( buf , cidr , sizeof ( buf ) , VIS_SAFE ) >= ( int ) sizeof ( buf ) ) { memcpy ( buf + sizeof ( buf ) - 4 , "..." , 4 ) ; } warnx ( "invalid address: %s" , buf ) ; return 0 ; } ipaddr -> prefixlen = plen ; res -> geoips = recallocarray ( res -> geoips , res -> geoipsz , res -> geoipsz + 1 , sizeof ( geoip ) ) ; if ( res -> geoips == NULL ) { err ( 1 , NULL ) ; } geoip = & res -> geoips [ res -> geoipsz ++ ] ; if ( ( geoip -> ip = calloc ( 1 , sizeof ( cert_ip ) ) ) == NULL ) { err ( 1 , NULL ) ; } geoip -> ip -> type = CERT_IP_ADDR ; geoip -> ip -> ip = * ipaddr ; geoip -> ip -> afi = afi ; if ( ( geoip -> loc = strdup ( loc ) ) == NULL ) { err ( 1 , NULL ) ; } if ( ! ip_cert_compose_ranges ( geoip -> ip ) ) { return 0 ; } return 1 ; } 