static int hdsp_9652_get_peak ( struct hdsp * hdsp , struct hdsp_peak_rms __user * peak_rms ) { int doublespeed = 0 ; int i , j , channels , ofs ; if ( hdsp_read ( hdsp , HDSP_statusRegister ) & HDSP_DoubleSpeedStatus ) { doublespeed = 1 ; } channels = doublespeed ?14 : 26 ; for ( i = 0 , j = 0 ; i < 26 ; ++ i ) { if ( doublespeed && ( i & 4 ) ) { continue ; } ofs = HDSP_9652_peakBase - j * 4 ; ofs -= channels * 4 ; if ( copy_u32_le ( & peak_rms -> playback_peaks [ i ] , hdsp -> iobase + ofs ) ) { return - EFAULT ; } ofs -= channels * 4 ; if ( copy_u32_le ( & peak_rms -> output_peaks [ i ] , hdsp -> iobase + ofs ) ) { return - EFAULT ; } ofs = HDSP_9652_rmsBase + j * 8 ; if ( copy_u48_le ( & peak_rms -> input_rms [ i ] , hdsp -> iobase + ofs , hdsp -> iobase + ofs + 4 ) ) { return - EFAULT ; } ofs += channels * 8 ; if ( copy_u48_le ( & peak_rms -> playback_rms [ i ] , hdsp -> iobase + ofs , hdsp -> iobase + ofs + 4 ) ) { return - EFAULT ; } ofs += channels * 8 ; if ( copy_u48_le ( & peak_rms -> output_rms [ i ] , hdsp -> iobase + ofs , hdsp -> iobase + ofs + 4 ) ) { return - EFAULT ; } j ++ ; } return 0 ; } 