static ssize_t crc_control_write ( struct file * file , const char __user * ubuf , size_t len , loff_t * offp ) { struct seq_file * m = file -> private_data ; struct drm_crtc * crtc = m -> private ; struct drm_crtc_crc * crc = & crtc -> crc ; char * source ; if ( len == 0 ) { return 0 ; } if ( len > PAGE_SIZE - 1 ) { DRM_DEBUG_KMS ( "Expected<%lu bytes into crtc crc control\n" , PAGE_SIZE ) ; return - E2BIG ; } source = memdup_user_nul ( ubuf , len ) ; if ( IS_ERR ( source ) ) { return PTR_ERR ( source ) ; } if ( source [ len ] == '\n' ) { source [ len ] = '\0' ; } spin_lock_irq ( & crc -> lock ) ; if ( crc -> opened ) { spin_unlock_irq ( & crc -> lock ) ; return - EBUSY ; } kfree ( crc -> source ) ; crc -> source = source ; spin_unlock_irq ( & crc -> lock ) ; * offp += len ; return len ; } 