errcode_t ext2fs_file_open2 ( ext2_filsys fs , ext2_ino_t ino , struct ext2_inode * inode , int flags , ext2_file_t * ret ) { ext2_file_t file ; errcode_t retval ; if ( ( flags & ( EXT2_FILE_WRITE | EXT2_FILE_CREATE ) ) && ! ( fs -> flags & EXT2_FLAG_RW ) ) { return EXT2_ET_RO_FILSYS ; } retval = ext2fs_get_mem ( sizeof ( ext2_file ) , & file ) ; if ( retval ) { return retval ; } file -> magic = EXT2_ET_MAGIC_EXT2_FILE ; file -> fs = fs ; file -> ino = ino ; file -> flags = flags & EXT2_FILE_MASK ; if ( inode ) { memcpy ( & file -> inode , inode , sizeof ( ext2_inode ) ) ; } else { retval = ext2fs_read_inode ( fs , ino , & file -> inode ) ; if ( retval ) { fail } } retval = ext2fs_get_array ( 3 , fs -> blocksize , & file -> buf ) ; if ( retval ) { fail } * ret = file ; return 0 ; fail if ( file -> buf ) { ext2fs_free_mem ( & file -> buf ) ; } ext2fs_free_mem ( & file ) ; return retval ; } 