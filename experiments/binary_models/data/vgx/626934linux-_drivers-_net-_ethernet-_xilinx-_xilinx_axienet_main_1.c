static int axienet_rx_poll ( struct napi_struct * napi , int budget ) { u32 length ; u32 csumstatus ; u32 size = 0 ; int packets = 0 ; dma_addr_t tail_p = 0 ; struct axidma_bd * cur_p ; struct sk_buff * skb , * new_skb ; struct axienet_local * lp = container_of ( napi , axienet_local , napi_rx ) ; cur_p = & lp -> rx_bd_v [ lp -> rx_bd_ci ] ; while ( packets < budget && ( cur_p -> status & XAXIDMA_BD_STS_COMPLETE_MASK ) ) { dma_addr_t phys ; dma_rmb ( ) ; skb = cur_p -> skb ; cur_p -> skb = NULL ; if ( likely ( skb ) ) { length = cur_p -> app4 & 0x0000FFFF ; phys = desc_get_phys_addr ( lp , cur_p ) ; dma_unmap_single ( lp -> dev , phys , lp -> max_frm_size , DMA_FROM_DEVICE ) ; skb_put ( skb , length ) ; skb -> protocol = eth_type_trans ( skb , lp -> ndev ) ; skb -> ip_summed = CHECKSUM_NONE ; if ( lp -> features & XAE_FEATURE_FULL_RX_CSUM ) { csumstatus = ( cur_p -> app2 & XAE_FULL_CSUM_STATUS_MASK ) >> 3 ; if ( csumstatus == XAE_IP_TCP_CSUM_VALIDATED || csumstatus == XAE_IP_UDP_CSUM_VALIDATED ) { skb -> ip_summed = CHECKSUM_UNNECESSARY ; } } if ( ( lp -> features & XAE_FEATURE_PARTIAL_RX_CSUM ) != 0 && skb -> protocol == htons ( ETH_P_IP ) && skb -> len > 64 ) { skb -> csum = be32_to_cpu ( cur_p -> app3 & 0xFFFF ) ; skb -> ip_summed = CHECKSUM_COMPLETE ; } napi_gro_receive ( napi , skb ) ; size += length ; packets ++ ; } new_skb = napi_alloc_skb ( napi , lp -> max_frm_size ) ; phys = dma_map_single ( lp -> dev , new_skb -> data , lp -> max_frm_size , DMA_FROM_DEVICE ) ; if ( unlikely ( dma_mapping_error ( lp -> dev , phys ) ) ) { if ( net_ratelimit ( ) ) { netdev_err ( lp -> ndev , "RX DMA mapping error\n" ) ; } dev_kfree_skb ( new_skb ) ; break ; } desc_set_phys_addr ( lp , phys , cur_p ) ; cur_p -> cntrl = lp -> max_frm_size ; cur_p -> status = 0 ; cur_p -> skb = new_skb ; tail_p = lp -> rx_bd_p + sizeof ( * lp -> rx_bd_v ) * lp -> rx_bd_ci ; if ( ++ lp -> rx_bd_ci >= lp -> rx_bd_num ) { lp -> rx_bd_ci = 0 ; } cur_p = & lp -> rx_bd_v [ lp -> rx_bd_ci ] ; } u64_stats_update_begin ( & lp -> rx_stat_sync ) ; u64_stats_add ( & lp -> rx_packets , packets ) ; u64_stats_add ( & lp -> rx_bytes , size ) ; u64_stats_update_end ( & lp -> rx_stat_sync ) ; if ( tail_p ) { axienet_dma_out_addr ( lp , XAXIDMA_RX_TDESC_OFFSET , tail_p ) ; } if ( packets < budget && napi_complete_done ( napi , packets ) ) { axienet_dma_out32 ( lp , XAXIDMA_RX_CR_OFFSET , lp -> rx_dma_cr ) ; } return packets ; } 