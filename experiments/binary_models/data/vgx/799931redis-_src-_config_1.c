void configSetCommand ( client * c ) { const char * errstr = NULL ; const char * invalid_arg_name = NULL ; const char * err_arg_name = NULL ; standardConfig * * set_configs ; list * module_configs_apply ; const char * * config_names ; sds * new_values ; sds * old_values = NULL ; apply_fn * apply_fns ; int config_count , i , j ; int invalid_args = 0 , deny_loading_error = 0 ; int * config_map_fns ; if ( c -> argc & 1 ) { addReplyErrorObject ( c , shared . syntaxerr ) ; return ; } config_count = ( c -> argc - 2 ) / 2 ; module_configs_apply = listCreate ( ) ; set_configs = zcalloc ( sizeof ( standardConfig * ) * config_count ) ; config_names = zcalloc ( sizeof ( char * ) * config_count ) ; new_values = zmalloc ( sizeof ( sds * ) * config_count ) ; old_values = zcalloc ( sizeof ( sds * ) * config_count ) ; apply_fns = zcalloc ( sizeof ( apply_fn ) * config_count ) ; config_map_fns = zmalloc ( sizeof ( int ) * config_count ) ; for ( i = 0 ; i < config_count ; i ++ ) { standardConfig * config = lookupConfig ( c -> argv [ 2 + i * 2 ] -> ptr ) ; if ( ! config ) { if ( ! invalid_args ) { invalid_arg_name = c -> argv [ 2 + i * 2 ] -> ptr ; invalid_args = 1 ; } continue ; } if ( config -> flags & SENSITIVE_CONFIG ) { redactClientCommandArgument ( c , 2 + i * 2 + 1 ) ; } if ( invalid_args ) { continue ; } if ( config -> flags & IMMUTABLE_CONFIG || ( config -> flags & PROTECTED_CONFIG && ! allowProtectedAction ( server . enable_protected_configs , c ) ) ) { errstr = ( config -> flags & IMMUTABLE_CONFIG ) ?"can't set immutable config" : "can't set protected config" ; err_arg_name = c -> argv [ 2 + i * 2 ] -> ptr ; invalid_args = 1 ; continue ; } if ( server . loading && config -> flags & DENY_LOADING_CONFIG ) { deny_loading_error = 1 ; invalid_args = 1 ; continue ; } for ( j = 0 ; j < i ; j ++ ) { if ( set_configs [ j ] == config ) { errstr = "duplicate parameter" ; err_arg_name = c -> argv [ 2 + i * 2 ] -> ptr ; invalid_args = 1 ; break ; } } set_configs [ i ] = config ; config_names [ i ] = config -> name ; new_values [ i ] = c -> argv [ 2 + i * 2 + 1 ] -> ptr ; } if ( invalid_args ) { err } for ( i = 0 ; i < config_count ; i ++ ) { old_values [ i ] = set_configs [ i ] -> interface . get ( set_configs [ i ] ) ; } for ( i = 0 ; i < config_count ; i ++ ) { int res = performInterfaceSet ( set_configs [ i ] , new_values [ i ] , & errstr ) ; if ( ! res ) { restoreBackupConfig ( set_configs , old_values , i + 1 , NULL , NULL ) ; err_arg_name = set_configs [ i ] -> name ; err } if ( res == 1 ) { if ( set_configs [ i ] -> flags & MODULE_CONFIG ) { addModuleConfigApply ( module_configs_apply , set_configs [ i ] -> privdata ) ; } if ( set_configs [ i ] -> interface . apply ) { int exists = 0 ; for ( j = 0 ; apply_fns [ j ] != NULL && j <= i ; j ++ ) { if ( apply_fns [ j ] == set_configs [ i ] -> interface . apply ) { exists = 1 ; break ; } } if ( ! exists ) { apply_fns [ j ] = set_configs [ i ] -> interface . apply ; config_map_fns [ j ] = i ; } } } } for ( i = 0 ; i < config_count && apply_fns [ i ] != NULL ; i ++ ) { if ( ! apply_fns [ i ] ( & errstr ) ) { serverLog ( LL_WARNING , "Failed applying new configuration. Possibly related to new %s setting. Restoring previous settings." , set_configs [ config_map_fns [ i ] ] -> name ) ; restoreBackupConfig ( set_configs , old_values , config_count , apply_fns , NULL ) ; err_arg_name = set_configs [ config_map_fns [ i ] ] -> name ; err } } if ( ! moduleConfigApplyConfig ( module_configs_apply , & errstr , & err_arg_name ) ) { serverLogRaw ( LL_WARNING , "Failed applying new module configuration. Restoring previous settings." ) ; restoreBackupConfig ( set_configs , old_values , config_count , apply_fns , module_configs_apply ) ; err } RedisModuleConfigChangeV1 cc = { . num_changes = config_count . config_names = config_names } ; moduleFireServerEvent ( REDISMODULE_EVENT_CONFIG , REDISMODULE_SUBEVENT_CONFIG_CHANGE , & cc ) ; addReply ( c , shared . ok ) ; end err if ( deny_loading_error ) { addReplyErrorObject ( c , shared . loadingerr ) ; } if ( invalid_arg_name ) { addReplyErrorFormat ( c , "Unknown option or number of arguments for CONFIG SET - '%s'" , invalid_arg_name ) ; } if ( errstr ) { addReplyErrorFormat ( c , "CONFIG SET failed (possibly related to argument '%s') - %s" , err_arg_name , errstr ) ; } else { addReplyErrorFormat ( c , "CONFIG SET failed (possibly related to argument '%s')" , err_arg_name ) ; } end zfree ( set_configs ) ; zfree ( config_names ) ; zfree ( new_values ) ; for ( i = 0 ; i < config_count ; i ++ ) { sdsfree ( old_values [ i ] ) ; } zfree ( apply_fns ) ; zfree ( config_map_fns ) ; listRelease ( module_configs_apply ) ; } 