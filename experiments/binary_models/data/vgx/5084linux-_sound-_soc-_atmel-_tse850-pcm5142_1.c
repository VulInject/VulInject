static int tse850_probe ( struct platform_device * pdev ) { struct snd_soc_card * card = & tse850_card ; struct device * dev = card -> dev = & pdev -> dev ; struct tse850_priv * tse850 ; int ret ; tse850 = devm_kzalloc ( dev , sizeof ( * tse850 ) , GFP_KERNEL ) ; if ( ! tse850 ) { return - ENOMEM ; } snd_soc_card_set_drvdata ( card , tse850 ) ; ret = tse850_dt_init ( pdev ) ; if ( ret ) { dev_err ( dev , "failed to init dt info\n" ) ; return ret ; } tse850 -> add = devm_gpiod_get ( dev , "axentia,add" , GPIOD_OUT_HIGH ) ; if ( IS_ERR ( tse850 -> add ) ) { return dev_err_probe ( dev , PTR_ERR ( tse850 -> add ) , "failed to get 'add' gpio\n" ) ; } tse850 -> loop1 = devm_gpiod_get ( dev , "axentia,loop1" , GPIOD_OUT_HIGH ) ; if ( IS_ERR ( tse850 -> loop1 ) ) { return dev_err_probe ( dev , PTR_ERR ( tse850 -> loop1 ) , "failed to get 'loop1' gpio\n" ) ; } tse850 -> loop1_cache = 1 ; tse850 -> loop2 = devm_gpiod_get ( dev , "axentia,loop2" , GPIOD_OUT_HIGH ) ; if ( IS_ERR ( tse850 -> loop2 ) ) { return dev_err_probe ( dev , PTR_ERR ( tse850 -> loop2 ) , "failed to get 'loop2' gpio\n" ) ; } tse850 -> loop2_cache = 1 ; tse850 -> ana = devm_regulator_get ( dev , "axentia,ana" ) ; if ( IS_ERR ( tse850 -> ana ) ) { return dev_err_probe ( dev , PTR_ERR ( tse850 -> ana ) , "failed to get 'ana' regulator\n" ) ; } ret = regulator_enable ( tse850 -> ana ) ; if ( ret < 0 ) { dev_err ( dev , "failed to enable the 'ana' regulator\n" ) ; return ret ; } ret = snd_soc_register_card ( card ) ; if ( ret ) { dev_err ( dev , "snd_soc_register_card failed\n" ) ; err_disable_ana } return 0 ; err_disable_ana regulator_disable ( tse850 -> ana ) ; return ret ; } 