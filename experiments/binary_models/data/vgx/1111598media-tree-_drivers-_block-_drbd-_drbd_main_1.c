void drbd_destroy_device ( struct kref * kref ) { struct drbd_device * device = container_of ( kref , drbd_device , kref ) ; struct drbd_resource * resource = device -> resource ; struct drbd_peer_device * peer_device , * tmp_peer_device ; del_timer_sync ( & device -> request_timer ) ; D_ASSERT ( device , device -> open_cnt == 0 ) ; if ( device -> this_bdev ) { bdput ( device -> this_bdev ) ; } drbd_backing_dev_free ( device , device -> ldev ) ; device -> ldev = NULL ; drbd_release_all_peer_reqs ( device ) ; lc_destroy ( device -> act_log ) ; lc_destroy ( device -> resync ) ; kfree ( device -> p_uuid ) ; if ( device -> bitmap ) { drbd_bm_cleanup ( device ) ; } __free_page ( device -> md_io . page ) ; put_disk ( device -> vdisk ) ; blk_cleanup_queue ( device -> rq_queue ) ; kfree ( device -> rs_plan_s ) ; for_each_peer_device_safe ( , , ) { kref_put ( & peer_device -> connection -> kref , drbd_destroy_connection ) ; kfree ( peer_device ) ; } memset ( device , 0xfd , sizeof ( * device ) ) ; kref_put ( & resource -> kref , drbd_destroy_resource ) ; } 