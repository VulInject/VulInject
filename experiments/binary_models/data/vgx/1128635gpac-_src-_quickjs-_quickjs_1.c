static JSValue js_array_from ( JSContext * ctx , JSValueConst this_val , int argc , JSValueConst * argv ) { JSValueConst items = argv [ 0 ] , mapfn , this_arg ; JSValueConst args [ 2 ] ; JSValue stack [ 2 ] ; JSValue iter , r , v , v2 , arrayLike ; int64_t k , len ; int done , mapping ; mapfn = JS_UNDEFINED ; this_arg = JS_UNDEFINED ; r = JS_UNDEFINED ; arrayLike = JS_UNDEFINED ; stack [ 0 ] = JS_UNDEFINED ; stack [ 1 ] = JS_UNDEFINED ; if ( argc > 1 ) { mapfn = argv [ 1 ] ; if ( ! JS_IsUndefined ( mapfn ) ) { if ( check_function ( ctx , mapfn ) ) { exception } mapping = 1 ; if ( argc > 2 ) { this_arg = argv [ 2 ] ; } } } iter = JS_GetProperty ( ctx , items , JS_ATOM_Symbol_iterator ) ; if ( JS_IsException ( iter ) ) { exception } if ( ! JS_IsUndefined ( iter ) ) { JS_FreeValue ( ctx , iter ) ; if ( JS_IsConstructor ( ctx , this_val ) ) { r = JS_CallConstructor ( ctx , this_val , 0 , NULL ) ; } else { r = JS_NewArray ( ctx ) ; } if ( JS_IsException ( r ) ) { exception } stack [ 0 ] = JS_DupValue ( ctx , items ) ; if ( js_for_of_start ( ctx , & stack [ 1 ] , FALSE ) ) { exception } for ( k = 0 ; ; k ++ ) { v = JS_IteratorNext ( ctx , stack [ 0 ] , stack [ 1 ] , 0 , NULL , & done ) ; if ( JS_IsException ( v ) ) { exception_close } if ( done ) { break ; } if ( mapping ) { args [ 0 ] = v ; args [ 1 ] = JS_NewInt32 ( ctx , k ) ; v2 = JS_Call ( ctx , mapfn , this_arg , 2 , args ) ; JS_FreeValue ( ctx , v ) ; v = v2 ; if ( JS_IsException ( v ) ) { exception_close } } if ( JS_DefinePropertyValueInt64 ( ctx , r , k , v , JS_PROP_C_W_E | JS_PROP_THROW ) < 0 ) { exception_close } } } else { arrayLike = JS_ToObject ( ctx , items ) ; if ( JS_IsException ( arrayLike ) ) { exception } if ( js_get_length64 ( ctx , & len , arrayLike ) < 0 ) { exception } v = JS_NewInt64 ( ctx , len ) ; args [ 0 ] = v ; if ( JS_IsConstructor ( ctx , this_val ) ) { r = JS_CallConstructor ( ctx , this_val , 1 , args ) ; } else { r = js_array_constructor ( ctx , JS_UNDEFINED , 1 , args ) ; } JS_FreeValue ( ctx , v ) ; if ( JS_IsException ( r ) ) { exception } for ( k = 0 ; k < len ; k ++ ) { v = JS_GetPropertyInt64 ( ctx , arrayLike , k ) ; if ( JS_IsException ( v ) ) { exception } if ( mapping ) { args [ 0 ] = v ; args [ 1 ] = JS_NewInt32 ( ctx , k ) ; v2 = JS_Call ( ctx , mapfn , this_arg , 2 , args ) ; JS_FreeValue ( ctx , v ) ; v = v2 ; if ( JS_IsException ( v ) ) { exception } } if ( JS_DefinePropertyValueInt64 ( ctx , r , k , v , JS_PROP_C_W_E | JS_PROP_THROW ) < 0 ) { exception } } } if ( JS_SetProperty ( ctx , r , JS_ATOM_length , JS_NewUint32 ( ctx , k ) ) < 0 ) { exception } done exception_close if ( ! JS_IsUndefined ( stack [ 0 ] ) ) { JS_IteratorClose ( ctx , stack [ 0 ] , TRUE ) ; } exception JS_FreeValue ( ctx , r ) ; r = JS_EXCEPTION ; done JS_FreeValue ( ctx , arrayLike ) ; JS_FreeValue ( ctx , stack [ 0 ] ) ; JS_FreeValue ( ctx , stack [ 1 ] ) ; return r ; } 