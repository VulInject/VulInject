if ( ! c -> set_config_item ( c , "lxc.console.buffer.size" , "4096" ) ) { lxc_error ( "%s\n" , "Failed to set config item \"lxc.console.buffer.size\"" ) ; on_error_put } if ( ! c -> set_config_item ( c , "lxc.console.logfile" , "/tmp/console-log.log" ) ) { lxc_error ( "%s\n" , "Failed to set config item \"lxc.console.logfile\"" ) ; on_error_put } if ( ! c -> createl ( c , "busybox" , NULL , NULL , 0 , NULL ) ) { lxc_error ( "%s\n" , "Failed to create busybox container \"console-log\"" ) ; on_error_put } if ( ! c -> is_defined ( c ) ) { lxc_error ( "%s\n" , "Container \"console-log\" is not defined" ) ; on_error_put } c -> clear_config ( c ) ; if ( ! c -> load_config ( c , NULL ) ) { lxc_error ( "%s\n" , "Failed to load config for container \"console-log\"" ) ; on_error_stop } if ( ! c -> want_daemonize ( c , true ) ) { lxc_error ( "%s\n" , "Failed to mark container \"console-log\" daemonized" ) ; on_error_stop } if ( ! c -> startl ( c , 0 , NULL ) ) { lxc_error ( "%s\n" , "Failed to start container \"console-log\" daemonized" ) ; on_error_stop } sleep ( 2 ) ; log . clear = false ; log . read_max = & ( uint64_t ) { 0 } ; log . read = true ; ret = c -> console_log ( c , & log ) ; if ( ret < 0 ) { lxc_error ( "%s - Failed to retrieve console log \n" , strerror ( - ret ) ) ; on_error_stop } else { lxc_debug ( "Retrieved %" PRIu64 " bytes from console log. Contents are \"%s\"\n" , * log . read_max , log . data ) ; } sleep ( 2 ) ; log . read_max = & ( uint64_t ) { 0 } ; log . read = false ; log . clear = true ; ret = c -> console_log ( c , & log ) ; if ( ret < 0 ) { if ( ret != - ENODATA ) { lxc_error ( "%s - Failed to retrieve console log\n" , strerror ( - ret ) ) ; on_error_stop } } if ( ! c -> stop ( c ) ) { lxc_error ( "%s\n" , "Failed to stop container \"console-log\"" ) ; on_error_stop } c -> clear_config ( c ) ; if ( ! c -> load_config ( c , NULL ) ) { lxc_error ( "%s\n" , "Failed to load config for container \"console-log\"" ) ; on_error_stop } if ( ! c -> startl ( c , 0 , NULL ) ) { lxc_error ( "%s\n" , "Failed to start container \"console-log\" daemonized" ) ; on_error_destroy } sleep ( 2 ) ; ret = stat ( "/tmp/console-log.log" , & st_log_file ) ; if ( ret < 0 ) { lxc_error ( "%s - Failed to stat on-disk logfile\n" , strerror ( errno ) ) ; on_error_stop } if ( ! c -> set_config_item ( c , "lxc.console.rotate" , "1" ) ) { lxc_error ( "%s\n" , "Failed to set config item \"lxc.console.rotate\"" ) ; on_error_put } if ( ! c -> stop ( c ) ) { lxc_error ( "%s\n" , "Failed to stop container \"console-log\"" ) ; on_error_stop } if ( ! c -> startl ( c , 0 , NULL ) ) { lxc_error ( "%s\n" , "Failed to start container \"console-log\" daemonized" ) ; on_error_destroy } sleep ( 2 ) ; fret = 0 ; on_error_stop if ( c -> is_running ( c ) && ! c -> stop ( c ) ) { lxc_error ( "%s\n" , "Failed to stop container \"console-log\"" ) ; } on_error_destroy if ( ! c -> destroy ( c ) ) { lxc_error ( "%s\n" , "Failed to destroy container \"console-log\"" ) ; } on_error_put lxc_container_put ( c ) ; if ( do_unlink ) { ret = unlink ( "/tmp/console-log.log" ) ; if ( ret < 0 ) { lxc_error ( "%s - Failed to remove container log file\n" , strerror ( errno ) ) ; } ret = unlink ( "/tmp/console-log.log.1" ) ; if ( ret < 0 ) { lxc_error ( "%s - Failed to remove container log file\n" , strerror ( errno ) ) ; } } exit ( fret ) ; 