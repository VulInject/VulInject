static int qed_iwarp_send_fpdu ( struct qed_hwfn * p_hwfn , struct qed_iwarp_fpdu * fpdu , struct unaligned_opaque_data * curr_pkt , struct qed_iwarp_ll2_buff * buf , u16 tcp_payload_size , enum qed_iwarp_mpa_pkt_type pkt_type ) { struct qed_ll2_tx_pkt_info tx_pkt ; u16 first_mpa_offset ; u8 ll2_handle ; int rc ; tx_pkt . num_of_bds = ( pkt_type == QED_IWARP_MPA_PKT_UNALIGNED ) ?3 : 2 ; tx_pkt . tx_dest = QED_LL2_TX_DEST_LB ; tx_pkt . l4_hdr_offset_w = fpdu -> pkt_hdr_size >> 2 ; if ( pkt_type == QED_IWARP_MPA_PKT_UNALIGNED || tcp_payload_size <= fpdu -> fpdu_length ) { tx_pkt . cookie = fpdu -> mpa_buf ; } tx_pkt . first_frag = fpdu -> pkt_hdr ; tx_pkt . first_frag_len = fpdu -> pkt_hdr_size ; tx_pkt . enable_ip_cksum = true ; tx_pkt . enable_l4_cksum = true ; tx_pkt . calc_ip_len = true ; tx_pkt . vlan = IWARP_LL2_ALIGNED_TX_QUEUE ; if ( tcp_payload_size == fpdu -> incomplete_bytes ) { fpdu -> mpa_buf -> piggy_buf = buf ; } ll2_handle = p_hwfn -> p_rdma_info -> iwarp . ll2_mpa_handle ; rc = qed_ll2_prepare_tx_packet ( p_hwfn , ll2_handle , & tx_pkt , true ) ; if ( rc ) { out } rc = qed_ll2_set_fragment_of_tx_packet ( p_hwfn , ll2_handle , fpdu -> mpa_frag , fpdu -> mpa_frag_len ) ; if ( rc ) { out } if ( ! fpdu -> incomplete_bytes ) { out } first_mpa_offset = le16_to_cpu ( curr_pkt -> first_mpa_offset ) ; rc = qed_ll2_set_fragment_of_tx_packet ( p_hwfn , ll2_handle , buf -> data_phys_addr + first_mpa_offset , fpdu -> incomplete_bytes ) ; out DP_VERBOSE ( p_hwfn , QED_MSG_RDMA , "MPA_ALIGN: Sent FPDU num_bds=%d first_frag_len=%x, mpa_frag_len=0x%x, incomplete_bytes:0x%x rc=%d\n" , tx_pkt . num_of_bds , tx_pkt . first_frag_len , fpdu -> mpa_frag_len , fpdu -> incomplete_bytes , rc ) ; return rc ; } 