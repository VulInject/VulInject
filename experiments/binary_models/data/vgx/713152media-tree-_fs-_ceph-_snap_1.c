static void flush_snaps ( struct ceph_mds_client * mdsc ) { struct ceph_inode_info * ci ; struct inode * inode ; struct ceph_mds_session * session = NULL ; dout ( "flush_snaps\n" ) ; spin_lock ( & mdsc -> snap_flush_lock ) ; while ( ! list_empty ( & mdsc -> snap_flush_list ) ) { ci = list_first_entry ( & mdsc -> snap_flush_list , ceph_inode_info , i_snap_flush_item ) ; inode = & ci -> vfs_inode ; ihold ( inode , NULL ) ; spin_unlock ( & mdsc -> snap_flush_lock ) ; ceph_flush_snaps ( ci , & session ) ; iput ( inode ) ; spin_lock ( & mdsc -> snap_flush_lock ) ; } spin_unlock ( & mdsc -> snap_flush_lock ) ; if ( session ) { mutex_unlock ( & session -> s_mutex ) ; ceph_put_mds_session ( session ) ; } dout ( "flush_snaps done\n" ) ; } 