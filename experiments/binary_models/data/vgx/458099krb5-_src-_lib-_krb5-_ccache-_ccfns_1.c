krb5_error_code k5_build_conf_principals ( krb5_context context , krb5_ccache id , krb5_const_principal principal , const char * name , krb5_creds * cred ) { krb5_principal client ; krb5_error_code ret ; char * pname = NULL ; ret = krb5_cc_get_principal ( context , id , & client ) ; if ( ret ) { return ret ; } if ( principal ) { ret = krb5_unparse_name ( context , principal , & pname ) ; if ( ret ) { return ret ; } } ret = krb5_build_principal ( context , & cred -> server , sizeof ( conf_realm ) - 1 , conf_realm , conf_name , name , pname , ( char * ) NULL ) ; krb5_free_unparsed_name ( context , pname ) ; if ( ret ) { krb5_free_principal ( context , client ) ; return ret ; } ret = krb5_copy_principal ( context , client , & cred -> client ) ; krb5_free_principal ( context , client ) ; return ret ; } 