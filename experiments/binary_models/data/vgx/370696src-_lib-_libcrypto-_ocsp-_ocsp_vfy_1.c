int OCSP_request_verify ( OCSP_REQUEST * req , STACK_OF ( X509 ) * certs , X509_STORE * store , unsigned long flags ) ( X509 * signer , X509_NAME * nm , GENERAL_NAME * gen , int ret , X509_STORE_CTX ctx , ( ! req -> optionalSignature ) { OCSPerror ( OCSP_R_REQUEST_NOT_SIGNED ) return 0 ; } gen = req -> tbsRequest -> requestorName , ( ! gen || gen -> type != GEN_DIRNAME ) { OCSPerror ( OCSP_R_UNSUPPORTED_REQUESTORNAME_TYPE ) return 0 ; } nm = gen -> d . directoryName , ret = ocsp_req_find_signer ( & signer , req , nm , certs , store , flags ) , ( ret <= 0 ) { OCSPerror ( OCSP_R_SIGNER_CERTIFICATE_NOT_FOUND ) return 0 ; } if ( ( ret == 2 ) && ( flags & OCSP_TRUSTOTHER ) ) { flags |= OCSP_NOVERIFY ; } ) ; if ( ! ( flags & OCSP_NOSIGS ) ) { EVP_PKEY * skey ; if ( ( skey = X509_get0_pubkey ( signer ) ) == NULL ) { return 0 ; } ret = OCSP_REQUEST_verify ( req , skey ) ; if ( ret <= 0 ) { OCSPerror ( OCSP_R_SIGNATURE_FAILURE ) ; return 0 ; } } if ( ! ( flags & OCSP_NOVERIFY ) ) { int init_res ; if ( flags & OCSP_NOCHAIN ) { init_res = X509_STORE_CTX_init ( & ctx , store , signer , NULL ) ; } else { init_res = X509_STORE_CTX_init ( & ctx , store , signer , req -> optionalSignature -> certs ) ; } if ( ! init_res ) { OCSPerror ( ERR_R_X509_LIB ) ; return 0 ; } if ( X509_STORE_CTX_set_purpose ( & ctx , X509_PURPOSE_OCSP_HELPER ) == 0 || X509_STORE_CTX_set_trust ( & ctx , X509_TRUST_OCSP_REQUEST ) == 0 ) { X509_STORE_CTX_cleanup ( & ctx ) ; return 0 ; } ret = X509_verify_cert ( & ctx ) ; X509_STORE_CTX_cleanup ( & ctx ) ; if ( ret <= 0 ) { ret = X509_STORE_CTX_get_error ( & ctx ) ; OCSPerror ( OCSP_R_CERTIFICATE_VERIFY_ERROR , NULL ) ; ERR_asprintf_error_data ( "Verify error:%s" , X509_verify_cert_error_string ( ret ) ) ; return 0 ; } } return 1 ; 