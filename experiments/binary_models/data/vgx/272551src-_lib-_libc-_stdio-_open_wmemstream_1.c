FILE * open_wmemstream ( wchar_t * * pbuf , size_t * psize ) { struct state * st ; FILE * fp ; if ( pbuf == NULL || psize == NULL ) { errno = EINVAL ; return ( NULL ) ; } if ( ( st = malloc ( sizeof ( * st ) ) ) == NULL ) { return ( NULL ) ; } if ( ( fp = __sfp ( ) ) == NULL ) { return ( NULL ) ; } st -> size = BUFSIZ * sizeof ( wchar_t ) ; if ( ( st -> string = calloc ( 1 , st -> size ) ) == NULL ) { free ( st ) ; fp -> _flags = 0 ; return ( NULL ) ; } * st -> string = L '\0' ; st -> pos = 0 ; st -> len = 0 ; st -> pbuf = pbuf ; st -> psize = psize ; bzero ( & st -> mbs , sizeof ( st -> mbs ) ) ; * pbuf = st -> string ; * psize = st -> len ; fp -> _flags = __SWR ; fp -> _file = - 1 ; fp -> _cookie = st ; fp -> _read = NULL ; fp -> _write = wmemstream_write ; fp -> _seek = wmemstream_seek ; fp -> _close = wmemstream_close ; _SET_ORIENTATION ( fp , 1 ) ; return ( fp ) ; } 