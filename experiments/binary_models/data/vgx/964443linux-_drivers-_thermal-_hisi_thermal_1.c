static int hisi_thermal_probe ( struct platform_device * pdev ) { struct hisi_thermal_data * data ; struct device * dev = & pdev -> dev ; struct resource * res ; int i , ret ; data = devm_kzalloc ( dev , sizeof ( * data ) , GFP_KERNEL ) ; if ( ! data ) { return - ENOMEM ; } data -> pdev = pdev ; platform_set_drvdata ( pdev , data ) ; data -> ops = of_device_get_match_data ( dev ) ; res = platform_get_resource ( pdev , IORESOURCE_MEM , 0 ) ; data -> regs = devm_ioremap_resource ( dev , res ) ; if ( IS_ERR ( data -> regs ) ) { return PTR_ERR ( data -> regs ) ; } ret = data -> ops -> probe ( data , NULL ) ; if ( ret ) { return ret ; } for ( i = 0 ; i < data -> nr_sensors ; i ++ ) { struct hisi_thermal_sensor * sensor = & data -> sensor [ i ] ; ret = hisi_thermal_register_sensor ( pdev , sensor ) ; if ( ret ) { dev_err ( dev , "failed to register thermal sensor: %d\n" , ret ) ; return ret ; } ret = platform_get_irq ( pdev , 0 ) ; if ( ret < 0 ) { return ret ; } ret = devm_request_threaded_irq ( dev , ret , NULL , hisi_thermal_alarm_irq_thread , IRQF_ONESHOT , sensor -> irq_name , sensor ) ; if ( ret < 0 ) { dev_err ( dev , "Failed to request alarm irq: %d\n" , ret ) ; return ret ; } ret = data -> ops -> enable_sensor ( sensor ) ; if ( ret ) { dev_err ( dev , "Failed to setup the sensor: %d\n" , ret ) ; return ret ; } hisi_thermal_toggle_sensor ( sensor , true ) ; } return 0 ; } 