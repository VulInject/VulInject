static int anx7411_detect_power_mode ( struct anx7411_data * ctx ) { int ret ; int mode ; ret = anx7411_reg_read ( ctx -> spi_client , REQUEST_CURRENT ) ; ctx -> typec . request_current = ret * CURRENT_UNIT ; ret = anx7411_reg_read ( ctx -> spi_client , REQUEST_VOLTAGE ) ; if ( ret < 0 ) { return ret ; } ctx -> typec . request_voltage = ret * VOLTAGE_UNIT ; if ( ctx -> psy_online == ANX7411_PSY_OFFLINE ) { ctx -> psy_online = ANX7411_PSY_FIXED_ONLINE ; ctx -> usb_type = POWER_SUPPLY_USB_TYPE_PD ; power_supply_changed ( ctx -> psy ) ; } if ( ! ctx -> typec . cc_orientation_valid ) { return 0 ; } if ( ctx -> typec . cc_connect == CC1_CONNECTED ) { mode = CC1_RP ( ctx -> typec . cc_status ) ; } else { mode = CC2_RP ( ctx -> typec . cc_status ) ; } if ( mode ) { typec_set_pwr_opmode ( ctx -> typec . port , mode - 1 ) ; return 0 ; } typec_set_pwr_opmode ( ctx -> typec . port , TYPEC_PWR_MODE_PD ) ; return 0 ; } 