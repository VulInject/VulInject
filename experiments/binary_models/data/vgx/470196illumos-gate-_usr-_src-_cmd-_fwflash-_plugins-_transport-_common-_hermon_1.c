static int cnx_get_image_info ( ib_cnx_encap_ident_t * handle ) { uint32_t ii_ptr_addr ; uint32_t ii_size ; int * buf ; int i , type ; hermon_flash_ioctl_t ioctl_info ; logmsg ( MSG_INFO , "cnx_get_image_info: state %x\n" , handle -> state ) ; type = handle -> state & ( FWFLASH_IB_STATE_IMAGE_PRI | FWFLASH_IB_STATE_IMAGE_SEC ) ; ioctl_info . af_addr = cnx_cont2phys ( handle -> log2_chunk_sz , CNX_IMG_INF_PTR_OFFSET , type ) ; ioctl_info . af_type = HERMON_FLASH_READ_QUADLET ; if ( cnx_read_ioctl ( handle , & ioctl_info ) != FWFLASH_SUCCESS ) { logmsg ( MSG_WARN , gettext ( "hermon: Failed to read image info " "Address\n" ) ) ; return ( FWFLASH_FAILURE ) ; } ii_ptr_addr = ioctl_info . af_quadlet & 0xffffff ; ioctl_info . af_addr = cnx_cont2phys ( handle -> log2_chunk_sz , ii_ptr_addr + CNX_IMG_INF_SZ_OFFSET , type ) ; ioctl_info . af_type = HERMON_FLASH_READ_QUADLET ; if ( cnx_read_ioctl ( handle , & ioctl_info ) != FWFLASH_SUCCESS ) { logmsg ( MSG_WARN , gettext ( "hermon: Failed to read image info " "size\n" ) ) ; return ( FWFLASH_FAILURE ) ; } logmsg ( MSG_INFO , "hermon: ImageInfo Sz: 0x%x\n" , ioctl_info . af_quadlet ) ; ii_size = ioctl_info . af_quadlet ; ii_size *= 4 ; logmsg ( MSG_INFO , "hermon: ii_ptr_addr: 0x%x ii_size: 0x%x\n" , ii_ptr_addr , ii_size ) ; buf = ( int * ) calloc ( 1 , ii_size ) ; ioctl_info . af_addr = cnx_cont2phys ( handle -> log2_chunk_sz , ii_ptr_addr , type ) ; ioctl_info . af_type = HERMON_FLASH_READ_QUADLET ; for ( i = 0 ; i < ii_size / 4 ; i ++ ) { if ( cnx_read_ioctl ( handle , & ioctl_info ) != FWFLASH_SUCCESS ) { logmsg ( MSG_WARN , gettext ( "hermon: Failed to read " "image info (0x%x)\n" ) , i ) ; return ( FWFLASH_FAILURE ) ; } buf [ i ] = ioctl_info . af_quadlet ; ioctl_info . af_addr += 4 ; } if ( cnx_parse_img_info ( buf , ii_size , & handle -> hwfw_img_info , CNX_HW_IMG ) != FWFLASH_SUCCESS ) { logmsg ( MSG_WARN , gettext ( "hermon: Failed to parse Image Info " "section\n" ) ) ; free ( buf ) ; return ( FWFLASH_FAILURE ) ; } free ( buf ) ; return ( FWFLASH_SUCCESS ) ; } 