int tcp_init_children ( int * woneinit ) { int r , i ; int reader_fd_1 ; pid_t pid ; char si_desc [ MAX_PT_DESC ] ; struct socket_info * si ; for ( r = 0 , si = tcp_listen ; si ; si = si -> next , r ++ ) { } if ( ! tls_disable ) { for ( si = tls_listen ; si ; si = si -> next , r ++ ) { } } register_fds ( r + tcp_max_connections + get_max_procs ( ) - 1 ) ; tcp_max_fd_no = get_max_procs ( ) * 2 + r - 1 + 3 ; tcp_max_fd_no += tcp_max_connections + get_max_procs ( ) - 1 ; tcp_children = pkg_malloc ( sizeof ( tcp_child ) * tcp_children_no ) ; if ( tcp_children == 0 ) { PKG_MEM_ERROR ; error } memset ( tcp_children , 0 , sizeof ( tcp_child ) * tcp_children_no ) ; i = tcp_children_no - 1 ; for ( si = tcp_listen ; si ; si = si -> next ) { if ( si -> workers > 0 ) { si -> workers_tcpidx = i - si -> workers + 1 ; for ( r = 0 ; r < si -> workers ; r ++ ) { tcp_children [ i ] . mysocket = si ; i -- ; } } } for ( si = tls_listen ; si ; si = si -> next ) { if ( si -> workers > 0 ) { si -> workers_tcpidx = i - si -> workers + 1 ; for ( r = 0 ; r < si -> workers ; r ++ ) { tcp_children [ i ] . mysocket = si ; i -- ; } } } tcp_sockets_gworkers = ( i != tcp_children_no - 1 ) ?( 1 + i + 1 ) : 0 ; for ( r = 0 ; r < tcp_children_no ; r ++ ) { child_rank ++ ; snprintf ( si_desc , MAX_PT_DESC , "tcp receiver (%s)" , ( tcp_children [ r ] . mysocket != NULL ) ?tcp_children [ r ] . mysocket -> sock_str . s : "generic" ) ; pid = fork_tcp_process ( child_rank , si_desc , r , & reader_fd_1 ) ; if ( pid < 0 ) { LM_ERR ( "fork failed: %s\n" , strerror ( errno ) ) ; error } if ( pid > 0 ) { if ( * woneinit == 0 && ksr_wait_worker1_mode != 0 ) { int wcount = 0 ; while ( * ksr_wait_worker1_done == 0 ) { sleep_us ( ksr_wait_worker1_usleep , NULL ) ; wcount ++ ; if ( ksr_wait_worker1_time <= wcount * ksr_wait_worker1_usleep ) { LM_ERR ( "waiting for child one too long - wait time: %d\n" , ksr_wait_worker1_time ) ; error } } LM_DBG ( "child one initialized after %d wait steps\n" , wcount ) ; } * woneinit = 1 ; } else { bind_address = 0 ; if ( * woneinit == 0 ) { if ( run_child_one_init_route ( ) < 0 ) { error } } if ( ksr_wait_worker1_mode != 0 ) { * ksr_wait_worker1_done = 1 ; LM_DBG ( "child one finished initialization\n" ) ; } tcp_receive_loop ( reader_fd_1 ) ; } } return 0 ; error return - 1 ; } 