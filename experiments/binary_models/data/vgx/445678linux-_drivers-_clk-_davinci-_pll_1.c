static struct clk * davinci_pll_div_register ( struct device * dev , const char * name , const char * parent_name , void __iomem * reg , bool fixed , u32 flags ) { const char * const * parent_names = parent_name ?& parent_name : NULL ; int num_parents = parent_name ?1 : 0 ; const struct clk_ops * divider_ops = & clk_divider_ops ; struct clk_gate * gate ; struct clk_divider * divider ; struct clk * clk ; int ret ; gate = kzalloc ( sizeof ( * gate ) , GFP_KERNEL ) ; if ( ! gate ) { return ERR_PTR ( - ENOMEM ) ; } gate -> reg = reg ; gate -> bit_idx = DIV_ENABLE_SHIFT ; divider = kzalloc ( sizeof ( * divider ) , GFP_KERNEL ) ; if ( ! divider ) { ret = - ENOMEM ; err_free_gate } divider -> reg = reg ; divider -> shift = DIV_RATIO_SHIFT ; divider -> width = DIV_RATIO_WIDTH ; if ( fixed ) { divider -> flags |= CLK_DIVIDER_READ_ONLY ; divider_ops = & clk_divider_ro_ops ; } clk = clk_register_composite ( dev , name , parent_names , num_parents , NULL , NULL , & divider -> hw , divider_ops , & gate -> hw , & clk_gate_ops , flags ) ; if ( IS_ERR ( clk ) ) { ret = PTR_ERR ( clk ) ; err_free_divider } return clk ; err_free_divider kfree ( divider ) ; err_free_gate return ERR_PTR ( ret ) ; } 