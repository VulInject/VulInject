static void process_80211d ( struct adapter * padapter , struct wlan_bssid_ex * bssid ) { struct registry_priv * pregistrypriv ; struct mlme_ext_priv * pmlmeext ; struct rt_channel_info * chplan_new ; u8 channel ; u8 i ; pregistrypriv = & padapter -> registrypriv ; pmlmeext = & padapter -> mlmeextpriv ; if ( pregistrypriv -> enable80211d && ( ! pmlmeext -> update_channel_plan_by_ap_done ) ) { u8 * ie , * p ; u32 len ; struct rt_channel_plan chplan_ap ; struct rt_channel_info chplan_sta [ MAX_CHANNEL_NUM ] ; u8 country [ 4 ] ; u8 fcn ; u8 noc ; u8 j , k ; ie = rtw_get_ie ( bssid -> IEs + _FIXED_IE_LENGTH_ , _COUNTRY_IE_ , & len , bssid -> IELength - _FIXED_IE_LENGTH_ ) ; if ( ! ie ) { return ; } if ( len < 6 ) { return ; } ie += 2 ; p = ie ; ie += len ; memset ( country , 0 , 4 ) ; memcpy ( country , p , 3 ) ; p += 3 ; i = 0 ; while ( ( ie - p ) >= 3 ) { fcn = * ( p ++ ) ; noc = * ( p ++ ) ; p ++ ; for ( j = 0 ; j < noc ; j ++ ) { channel = fcn + j ; chplan_ap . Channel [ i ++ ] = channel ; } } chplan_ap . Len = i ; memcpy ( chplan_sta , pmlmeext -> channel_set , sizeof ( chplan_sta ) ) ; chplan_new = pmlmeext -> channel_set ; i = 0 ; j = 0 ; k = 0 ; if ( pregistrypriv -> wireless_mode & WIRELESS_11G ) { { if ( ( i == MAX_CHANNEL_NUM ) || ( chplan_sta [ i ] . ChannelNum == 0 ) ) { break ; } if ( j == chplan_ap . Len ) { break ; } if ( chplan_sta [ i ] . ChannelNum == chplan_ap . Channel [ j ] ) { chplan_new [ k ] . ChannelNum = chplan_ap . Channel [ j ] ; chplan_new [ k ] . ScanType = SCAN_ACTIVE ; i ++ ; j ++ ; k ++ ; } if ( chplan_sta [ i ] . ChannelNum < chplan_ap . Channel [ j ] ) { chplan_new [ k ] . ChannelNum = chplan_sta [ i ] . ChannelNum ; chplan_new [ k ] . ScanType = SCAN_PASSIVE ; i ++ ; k ++ ; } if ( chplan_sta [ i ] . ChannelNum > chplan_ap . Channel [ j ] ) { chplan_new [ k ] . ChannelNum = chplan_ap . Channel [ j ] ; chplan_new [ k ] . ScanType = SCAN_ACTIVE ; j ++ ; k ++ ; } } 1 ; while ( ( i < MAX_CHANNEL_NUM ) && ( chplan_sta [ i ] . ChannelNum != 0 ) && ( chplan_sta [ i ] . ChannelNum <= 14 ) ) { chplan_new [ k ] . ChannelNum = chplan_sta [ i ] . ChannelNum ; chplan_new [ k ] . ScanType = SCAN_PASSIVE ; i ++ ; k ++ ; } while ( ( j < chplan_ap . Len ) && ( chplan_ap . Channel [ j ] <= 14 ) ) { chplan_new [ k ] . ChannelNum = chplan_ap . Channel [ j ] ; chplan_new [ k ] . ScanType = SCAN_ACTIVE ; j ++ ; k ++ ; } } else { while ( ( i < MAX_CHANNEL_NUM ) && ( chplan_sta [ i ] . ChannelNum != 0 ) && ( chplan_sta [ i ] . ChannelNum <= 14 ) ) { chplan_new [ k ] . ChannelNum = chplan_sta [ i ] . ChannelNum ; chplan_new [ k ] . ScanType = chplan_sta [ i ] . ScanType ; i ++ ; k ++ ; } while ( ( j < chplan_ap . Len ) && ( chplan_ap . Channel [ j ] <= 14 ) ) { j ++ ; } } while ( ( i < MAX_CHANNEL_NUM ) && ( chplan_sta [ i ] . ChannelNum != 0 ) ) { chplan_new [ k ] . ChannelNum = chplan_sta [ i ] . ChannelNum ; chplan_new [ k ] . ScanType = chplan_sta [ i ] . ScanType ; i ++ ; k ++ ; } pmlmeext -> update_channel_plan_by_ap_done = 1 ; } channel = bssid -> Configuration . DSConfig ; chplan_new = pmlmeext -> channel_set ; i = 0 ; while ( ( i < MAX_CHANNEL_NUM ) && ( chplan_new [ i ] . ChannelNum != 0 ) ) { if ( chplan_new [ i ] . ChannelNum == channel ) { if ( chplan_new [ i ] . ScanType == SCAN_PASSIVE ) { chplan_new [ i ] . ScanType = SCAN_ACTIVE ; } break ; } i ++ ; } } 