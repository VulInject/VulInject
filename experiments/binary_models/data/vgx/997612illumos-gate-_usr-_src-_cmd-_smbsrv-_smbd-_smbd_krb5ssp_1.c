void smbd_krb5ssp_fini ( authsvc_context_t * ctx ) { krb5ssp_backend_t * be = ctx -> ctx_backend ; uint32_t minor ; if ( be == NULL ) { return ; } if ( be -> be_kctx != NULL ) { krb5_free_data_contents ( be -> be_kctx , & be -> be_pac ) ; if ( be -> be_kpac != NULL ) { krb5_pac_free ( be -> be_kctx , be -> be_kpac ) ; } krb5_free_context ( be -> be_kctx ) ; } ( void ) gss_release_buffer ( NULL , & be -> be_authz_pac ) ; free ( be -> be_username ) ; if ( be -> be_gssctx != GSS_C_NO_CONTEXT ) { ( void ) gss_delete_sec_context ( & minor , & be -> be_gssctx , GSS_C_NO_BUFFER ) ; } free ( be ) ; } static char * krb5ssp_def_username = "Unknown-Kerberos-User" ; static char * krb5ssp_def_domain = "Unknown-Domain" ; int smbd_krb5ssp_work ( authsvc_context_t * ctx ) { gss_buffer_desc intok , outtok ; gss_buffer_desc namebuf ; krb5ssp_backend_t * be = ctx -> ctx_backend ; gss_name_t gname = NULL ; OM_uint32 major , minor , ret_flags ; gss_OID name_type = GSS_C_NULL_OID ; gss_OID mech_type = GSS_C_NULL_OID ; krb5_error_code kerr ; uint32_t status ; smb_token_t * token = NULL ; intok . length = ctx -> ctx_ibodylen ; intok . value = ctx -> ctx_ibodybuf ; bzero ( & outtok , sizeof ( gss_buffer_desc ) ) ; bzero ( & namebuf , sizeof ( gss_buffer_desc ) ) ; assert ( be -> be_username == NULL ) ; kerr = krb5_init_context ( & be -> be_kctx ) ; if ( kerr != 0 ) { smbd_report ( "krb5ssp, krb5_init_ctx: %s" , krb5_get_error_message ( be -> be_kctx , kerr ) ) ; return ( NT_STATUS_INTERNAL_ERROR ) ; } major = gss_accept_sec_context ( & minor , & be -> be_gssctx , GSS_C_NO_CREDENTIAL , & intok , GSS_C_NO_CHANNEL_BINDINGS , & gname , & mech_type , & outtok , & ret_flags , NULL , NULL ) ; if ( outtok . length == 0 ) { ctx -> ctx_obodylen = 0 ; } if ( outtok . length <= ctx -> ctx_obodylen ) { ctx -> ctx_obodylen = outtok . length ; ( void ) memcpy ( ctx -> ctx_obodybuf , outtok . value , outtok . length ) ; free ( outtok . value ) ; outtok . value = NULL ; } else { ctx -> ctx_obodybuf = outtok . value ; ctx -> ctx_obodylen = outtok . length ; outtok . value = NULL ; } if ( GSS_ERROR ( major ) ) { smbd_report ( "krb5ssp: gss_accept_sec_context, " "mech=0x%x, major=0x%x, minor=0x%x" , ( int ) mech_type , major , minor ) ; smbd_report ( " krb5: %s" , krb5_get_error_message ( be -> be_kctx , minor ) ) ; status = NT_STATUS_WRONG_PASSWORD ; out } switch ( major ) { case GSS_S_COMPLETE : break ; case GSS_S_CONTINUE_NEEDED : if ( outtok . length > 0 ) { ctx -> ctx_orawtype = LSA_MTYPE_ES_CONT ; return ( 0 ) ; } status = NT_STATUS_WRONG_PASSWORD ; out default : status = NT_STATUS_WRONG_PASSWORD ; out } if ( gname != NULL && GSS_S_COMPLETE == gss_display_name ( & minor , gname , & namebuf , & name_type ) ) { be -> be_username = strdup ( namebuf . value ) ; ( void ) gss_release_buffer ( & minor , & namebuf ) ; ( void ) gss_release_name ( & minor , & gname ) ; if ( be -> be_username == NULL ) { return ( NT_STATUS_NO_MEMORY ) ; } } status = get_authz_data_pac ( be -> be_gssctx , & be -> be_authz_pac ) ; if ( status ) { out } kerr = krb5_pac_parse ( be -> be_kctx , be -> be_authz_pac . value , be -> be_authz_pac . length , & be -> be_kpac ) ; if ( kerr ) { smbd_report ( "krb5ssp, krb5_pac_parse: %s" , krb5_get_error_message ( be -> be_kctx , kerr ) ) ; status = NT_STATUS_UNSUCCESSFUL ; out } kerr = krb5_pac_get_buffer ( be -> be_kctx , be -> be_kpac , PAC_LOGON_INFO , & be -> be_pac ) ; if ( kerr ) { smbd_report ( "krb5ssp, krb5_pac_get_buffer: %s" , krb5_get_error_message ( be -> be_kctx , kerr ) ) ; status = NT_STATUS_UNSUCCESSFUL ; out } ctx -> ctx_token = calloc ( 1 , sizeof ( smb_token_t ) ) ; if ( ctx -> ctx_token == NULL ) { status = NT_STATUS_NO_MEMORY ; out } status = smb_decode_krb5_pac ( ctx -> ctx_token , be -> be_pac . data , be -> be_pac . length ) ; if ( status ) { out } status = get_ssnkey ( ctx ) ; if ( status ) { out } if ( ! smb_token_setup_common ( ctx -> ctx_token ) ) { status = NT_STATUS_UNSUCCESSFUL ; out } ctx -> ctx_orawtype = LSA_MTYPE_ES_DONE ; status = 0 ; token = ctx -> ctx_token ; out status = smbd_logon_final ( token , & ctx -> ctx_clinfo . lci_clnt_ipaddr , ( be -> be_username != NULL ) ?be -> be_username : krb5ssp_def_username , krb5ssp_def_domain , status ) ; return ( status ) ; } 