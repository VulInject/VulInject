static int ieee80211_link_use_reserved_reassign ( struct ieee80211_link_data * link ) { struct ieee80211_sub_if_data * sdata = link -> sdata ; struct ieee80211_bss_conf * link_conf = link -> conf ; struct ieee80211_local * local = sdata -> local ; struct ieee80211_vif_chanctx_switch vif_chsw [ 1 ] { } ; ; struct ieee80211_chanctx * old_ctx , * new_ctx ; const struct cfg80211_chan_def * chandef ; u32 changed = 0 ; int err ; lockdep_assert_held ( & local -> mtx ) ; lockdep_assert_held ( & local -> chanctx_mtx ) ; new_ctx = link -> reserved_chanctx ; old_ctx = ieee80211_link_get_chanctx ( link ) ; if ( WARN_ON ( ! link -> reserved_ready ) ) { return - EBUSY ; } if ( WARN_ON ( ! old_ctx ) ) { return - EINVAL ; } if ( WARN_ON ( new_ctx -> replace_state == IEEE80211_CHANCTX_REPLACES_OTHER ) ) { return - EINVAL ; } chandef = ieee80211_chanctx_non_reserved_chandef ( local , new_ctx , & link -> reserved_chandef ) ; if ( WARN_ON ( ! chandef ) ) { return - EINVAL ; } if ( link_conf -> chandef . width != link -> reserved_chandef . width ) { changed = BSS_CHANGED_BANDWIDTH ; } ieee80211_link_update_chandef ( link , & link -> reserved_chandef ) ; ieee80211_change_chanctx ( local , new_ctx , old_ctx , chandef ) ; vif_chsw [ 0 ] . vif = & sdata -> vif ; vif_chsw [ 0 ] . old_ctx = & old_ctx -> conf ; vif_chsw [ 0 ] . new_ctx = & new_ctx -> conf ; vif_chsw [ 0 ] . link_conf = link -> conf ; list_del ( & link -> reserved_chanctx_list ) ; link -> reserved_chanctx = NULL ; err = drv_switch_vif_chanctx ( local , vif_chsw , 1 , CHANCTX_SWMODE_REASSIGN_VIF ) ; if ( err ) { if ( ieee80211_chanctx_refcount ( local , new_ctx ) == 0 ) { ieee80211_free_chanctx ( local , new_ctx ) ; } out } list_move ( & link -> assigned_chanctx_list , & new_ctx -> assigned_links ) ; rcu_assign_pointer ( link_conf -> chanctx_conf , & new_ctx -> conf ) ; if ( sdata -> vif . type == NL80211_IFTYPE_AP ) { __ieee80211_link_copy_chanctx_to_vlans ( link , false ) ; } ieee80211_check_fast_xmit_iface ( sdata ) ; if ( ieee80211_chanctx_refcount ( local , old_ctx ) == 0 ) { ieee80211_free_chanctx ( local , old_ctx ) ; } ieee80211_recalc_chanctx_min_def ( local , new_ctx ) ; ieee80211_recalc_smps_chanctx ( local , new_ctx ) ; ieee80211_recalc_radar_chanctx ( local , new_ctx ) ; if ( changed ) { ieee80211_link_info_change_notify ( sdata , link , changed ) ; } out ieee80211_link_chanctx_reservation_complete ( link ) ; return err ; } 