void synchronise_count_master ( int cpu ) { int i ; cfs_time_t flags ; pr_info ( "Synchronize counters for CPU %u: " , cpu ) ; local_irq_save ( flags ) ; for ( i = 0 ; i < NR_LOOPS ; i ++ ) { while ( atomic_read ( & count_count_start ) != 1 ) { mb ( ) ; } atomic_set ( & count_count_stop , 0 ) ; smp_wmb ( ) ; atomic_inc ( & count_count_start ) ; if ( i == 1 ) { initcount = read_c0_count ( ) ; } if ( i == NR_LOOPS - 1 ) { write_c0_count ( initcount ) ; } while ( atomic_read ( & count_count_stop ) != 1 ) { mb ( ) ; } atomic_set ( & count_count_start , 0 ) ; smp_wmb ( ) ; atomic_inc ( & count_count_stop ) ; } write_c0_compare ( read_c0_count ( ) + COUNTON ) ; local_irq_restore ( flags ) ; pr_cont ( "done.\n" ) ; } 