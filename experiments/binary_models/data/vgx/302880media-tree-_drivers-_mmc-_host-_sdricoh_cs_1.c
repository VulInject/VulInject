static int sdricoh_blockio ( struct sdricoh_host * host , int read , u8 * buf , int len ) { int size ; u32 data = 0 ; if ( read ) { if ( sdricoh_query_status ( host , STATUS_READY_TO_READ , TRANSFER_TIMEOUT ) ) { return - ETIMEDOUT ; } sdricoh_writel ( host , R21C_STATUS , 0x18 ) ; while ( len ) { data = sdricoh_readl ( host , R230_DATA ) ; size = min ( len , 4 ) ; len -= size ; while ( size ) { * buf = data & 0xFF ; buf ++ ; data >>= 8 ; size -- ; } } } else { if ( sdricoh_query_status ( host , STATUS_READY_TO_WRITE , TRANSFER_TIMEOUT ) ) { return - ETIMEDOUT ; } sdricoh_writel ( host , R21C_STATUS , 0x18 ) ; while ( len ) { size = min ( len , 4 ) ; len -= size ; while ( size ) { data >>= 8 ; data |= ( u32 ) * buf << 24 ; buf ++ ; size -- ; } sdricoh_writel ( host , R230_DATA , data ) ; } } return 0 ; } 