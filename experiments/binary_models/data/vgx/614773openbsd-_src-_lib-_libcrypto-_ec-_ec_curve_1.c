static EC_GROUP * ec_group_new_from_data ( const ec_list_element curve ) { EC_GROUP * group = NULL ; EC_POINT * P = NULL ; BN_CTX * ctx = NULL ; BIGNUM * p = NULL , * a = NULL , * b = NULL , * x = NULL , * y = NULL , * order = NULL ; int ok = 0 ; int seed_len , param_len ; const EC_METHOD * meth ; const EC_CURVE_DATA * data ; const unsigned char * params ; if ( ( ctx = BN_CTX_new ( ) ) == NULL ) { ECerror ( ERR_R_MALLOC_FAILURE ) ; err } data = curve . data ; seed_len = data -> seed_len ; param_len = data -> param_len ; params = ( const unsigned char * ) ( data + 1 ) ; params += seed_len ; if ( ! ( p = BN_bin2bn ( params + 0 * param_len , param_len , NULL ) ) || ! ( a = BN_bin2bn ( params + 1 * param_len , param_len , NULL ) ) || ! ( b = BN_bin2bn ( params + 2 * param_len , param_len , NULL ) ) ) { ECerror ( ERR_R_BN_LIB , NULL ) ; err } if ( curve . meth != 0 ) { meth = curve . meth ( ) ; if ( ( ( group = EC_GROUP_new ( meth ) ) == NULL ) || ( ! ( group -> meth -> group_set_curve ( group , p , a , b , ctx ) ) ) ) { ECerror ( ERR_R_EC_LIB ) ; err } } if ( data -> field_type == NID_X9_62_prime_field ) { if ( ( group = EC_GROUP_new_curve_GFp ( p , a , b , ctx ) ) == NULL ) { ECerror ( ERR_R_EC_LIB ) ; err } } else { if ( ( group = EC_GROUP_new_curve_GF2m ( p , a , b , ctx ) ) == NULL ) { ECerror ( ERR_R_EC_LIB ) ; err } } if ( ( P = EC_POINT_new ( group ) ) == NULL ) { ECerror ( ERR_R_EC_LIB ) ; err } if ( ! ( x = BN_bin2bn ( params + 3 * param_len , param_len , NULL ) ) || ! ( y = BN_bin2bn ( params + 4 * param_len , param_len , NULL ) ) ) { ECerror ( ERR_R_BN_LIB ) ; err } if ( ! EC_POINT_set_affine_coordinates ( group , P , x , y , ctx ) ) { ECerror ( ERR_R_EC_LIB ) ; err } if ( ! ( order = BN_bin2bn ( params + 5 * param_len , param_len , NULL ) ) || ! BN_set_word ( x , ( BN_ULONG ) data -> cofactor ) ) { ECerror ( ERR_R_BN_LIB ) ; err } if ( ! EC_GROUP_set_generator ( group , P , order , x ) ) { ECerror ( ERR_R_EC_LIB ) ; err } if ( seed_len ) { if ( ! EC_GROUP_set_seed ( group , params - seed_len , seed_len ) ) { ECerror ( ERR_R_EC_LIB ) ; err } } ok = 1 ; err if ( ! ok ) { EC_GROUP_free ( group ) ; group = NULL ; } EC_POINT_free ( P ) ; BN_CTX_free ( ctx ) ; BN_free ( p ) ; BN_free ( a ) ; BN_free ( b ) ; BN_free ( order ) ; BN_free ( x ) ; BN_free ( y ) ; return group ; } 