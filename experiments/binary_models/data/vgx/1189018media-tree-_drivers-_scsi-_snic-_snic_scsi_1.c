static void snic_icmnd_cmpl_handler ( struct snic * snic , struct snic_fw_req * fwreq ) { u8 typ , hdr_stat ; u32 cmnd_id , hid ; ulong ctx ; struct scsi_cmnd * sc = NULL ; struct snic_icmnd_cmpl * icmnd_cmpl = NULL ; struct snic_host_req * req = NULL ; struct snic_req_info * rqi = NULL ; unsigned long flags , start_time ; spinlock_t * io_lock ; u8 sc_stat = 0 ; snic_io_hdr_dec ( & fwreq -> hdr , & typ , & hdr_stat , & cmnd_id , & hid , & ctx ) ; icmnd_cmpl = & fwreq -> u . icmnd_cmpl ; sc_stat = icmnd_cmpl -> scsi_status ; SNIC_SCSI_DBG ( snic -> shost , "Icmnd_cmpl: type = %x, hdr_stat = %x, cmnd_id = %x, hid = %x,i ctx = %lx\n" , typ , hdr_stat , cmnd_id , hid , ctx ) ; if ( cmnd_id >= snic -> max_tag_id ) { SNIC_HOST_ERR ( snic -> shost , "Icmnd_cmpl:Tag Error:Out of Range Tag %d, hdr status = %s\n" , cmnd_id , snic_io_status_to_str ( hdr_stat ) ) ; return ; } sc = scsi_host_find_tag ( snic -> shost , cmnd_id ) ; WARN_ON_ONCE ( ! sc ) ; if ( ! sc ) { atomic64_inc ( & snic -> s_stats . io . sc_null ) ; SNIC_HOST_ERR ( snic -> shost , "Icmnd_cmpl: Scsi Cmnd Not found, sc = NULL Hdr Status = %s tag = 0x%x fwreq = 0x%p\n" , snic_io_status_to_str ( hdr_stat ) , cmnd_id , fwreq ) ; SNIC_TRC ( snic -> shost -> host_no , cmnd_id , 0 , ( ( u64 ) hdr_stat << 16 | ( u64 ) sc_stat << 8 | ( u64 ) icmnd_cmpl -> flags ) , ( ulong ) fwreq , le32_to_cpu ( icmnd_cmpl -> resid ) , ctx ) ; return ; } io_lock = snic_io_lock_hash ( snic , sc ) ; spin_lock_irqsave ( io_lock , flags ) ; rqi = ( snic_req_info * ) CMD_SP ( sc ) ; SNIC_SCSI_DBG ( snic -> shost , "Icmnd_cmpl:lun %lld sc %p cmd %xtag %d flags 0x%llx rqi %p\n" , sc -> device -> lun , sc , sc -> cmnd [ 0 ] , snic_cmd_tag ( sc ) , CMD_FLAGS ( sc ) , rqi ) ; if ( CMD_FLAGS ( sc ) & SNIC_HOST_RESET_CMD_TERM ) { spin_unlock_irqrestore ( io_lock , flags ) ; return ; } SNIC_BUG_ON ( rqi != ( snic_req_info * ) ctx ) ; WARN_ON_ONCE ( req ) ; if ( ! rqi ) { atomic64_inc ( & snic -> s_stats . io . req_null ) ; CMD_FLAGS ( sc ) |= SNIC_IO_REQ_NULL ; spin_unlock_irqrestore ( io_lock , flags ) ; SNIC_HOST_ERR ( snic -> shost , "Icmnd_cmpl:Host Req Not Found(null), Hdr Status %s, Tag 0x%x, sc 0x%p flags 0x%llx\n" , snic_io_status_to_str ( hdr_stat ) , cmnd_id , sc , CMD_FLAGS ( sc ) ) ; return ; } rqi = ( snic_req_info * ) ctx ; start_time = rqi -> start_time ; if ( unlikely ( snic_tmreq_pending ( sc ) ) ) { snic_proc_tmreq_pending_state ( snic , sc , hdr_stat ) ; spin_unlock_irqrestore ( io_lock , flags ) ; snic_stats_update_io_cmpl ( & snic -> s_stats ) ; if ( likely ( hdr_stat == SNIC_STAT_ABORTED ) ) { return ; } SNIC_SCSI_DBG ( snic -> shost , "icmnd_cmpl:TM Req Pending(%s), Hdr Status %s sc 0x%p scsi status %x resid %d flags 0x%llx\n" , snic_ioreq_state_to_str ( CMD_STATE ( sc ) ) , snic_io_status_to_str ( hdr_stat ) , sc , sc_stat , le32_to_cpu ( icmnd_cmpl -> resid ) , CMD_FLAGS ( sc ) ) ; SNIC_TRC ( snic -> shost -> host_no , cmnd_id , ( ulong ) sc , jiffies_to_msecs ( jiffies - start_time ) , ( ulong ) fwreq , SNIC_TRC_CMD ( sc ) , SNIC_TRC_CMD_STATE_FLAGS ( sc ) ) ; return ; } if ( snic_process_icmnd_cmpl_status ( snic , icmnd_cmpl , hdr_stat , sc ) ) { scsi_print_command ( sc ) ; SNIC_HOST_ERR ( snic -> shost , "icmnd_cmpl:IO Failed, sc 0x%p Tag %d Cmd %x Hdr Status %s flags 0x%llx\n" , sc , sc -> cmnd [ 0 ] , cmnd_id , snic_io_status_to_str ( hdr_stat ) , CMD_FLAGS ( sc ) ) ; } CMD_SP ( sc ) = NULL ; CMD_FLAGS ( sc ) |= SNIC_IO_DONE ; spin_unlock_irqrestore ( io_lock , flags ) ; snic_calc_io_process_time ( snic , rqi ) ; snic_release_req_buf ( snic , rqi , sc ) ; SNIC_TRC ( snic -> shost -> host_no , cmnd_id , ( ulong ) sc , jiffies_to_msecs ( jiffies - start_time ) , ( ulong ) fwreq , SNIC_TRC_CMD ( sc ) , SNIC_TRC_CMD_STATE_FLAGS ( sc ) ) ; if ( sc -> scsi_done ) { sc -> scsi_done ( sc ) ; } snic_stats_update_io_cmpl ( & snic -> s_stats ) ; } 