static int wil_vring_alloc_skb ( struct wil6210_priv * wil , struct vring * vring , u32 i , int headroom ) { struct device * dev = wil_to_dev ( wil ) ; unsigned int sz = wil -> rx_buf_len + ETH_HLEN + wil_rx_snaplen ( ) ; struct vring_rx_desc dd , * d = & dd ; volatile struct vring_rx_desc * _d = & vring -> va [ i ] . rx ; dma_addr_t pa ; struct sk_buff * skb = dev_alloc_skb ( sz + headroom ) ; if ( unlikely ( ! skb ) ) { return - ENOMEM ; } skb_reserve ( skb , headroom ) ; skb_put ( skb , sz ) ; pa = dma_map_single ( dev , skb -> data , skb -> len , DMA_FROM_DEVICE ) ; if ( unlikely ( dma_mapping_error ( dev , pa ) ) ) { return - ENOMEM ; } d -> dma . d0 = RX_DMA_D0_CMD_DMA_RT | RX_DMA_D0_CMD_DMA_IT ; wil_desc_addr_set ( & d -> dma . addr , pa ) ; d -> dma . status = 0 ; d -> dma . length = cpu_to_le16 ( sz ) ; * _d = * d ; vring -> ctx [ i ] . skb = skb ; return 0 ; } 