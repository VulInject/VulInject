static int qeth_snmp_command ( struct qeth_card * card , char __user * udata ) { struct qeth_snmp_ureq __user * ureq ; struct qeth_cmd_buffer * iob ; unsigned int req_len ; struct qeth_arp_query_info qinfo = { 0 } ; int rc = 0 ; QETH_CARD_TEXT ( card , 3 , "snmpcmd" ) ; if ( IS_VM_NIC ( card ) ) { return - EOPNOTSUPP ; } if ( ( ! qeth_adp_supported ( card , IPA_SETADP_SET_SNMP_CONTROL ) ) && IS_LAYER3 ( card ) ) { return - EOPNOTSUPP ; } ureq = ( qeth_snmp_ureq __user * ) udata ; if ( get_user ( qinfo . udata_len , & ureq -> hdr . data_len ) || get_user ( req_len , & ureq -> hdr . req_len ) ) { return - EFAULT ; } if ( req_len > QETH_BUFSIZE ) { return - EINVAL ; } iob = qeth_get_adapter_cmd ( card , IPA_SETADP_SET_SNMP_CONTROL , req_len ) ; if ( ! iob ) { return - ENOMEM ; } if ( copy_from_user ( & __ipa_cmd ( iob ) -> data . setadapterparms . data . snmp , & ureq -> cmd , req_len ) ) { qeth_put_cmd ( iob ) ; return - EFAULT ; } qinfo . udata = kzalloc ( qinfo . udata_len , GFP_KERNEL ) ; if ( ! qinfo . udata ) { qeth_put_cmd ( iob ) ; return - ENOMEM ; } qinfo . udata_offset = sizeof ( qeth_snmp_ureq_hdr ) ; rc = qeth_send_ipa_cmd ( card , iob , qeth_snmp_command_cb , & qinfo ) ; if ( rc ) { QETH_DBF_MESSAGE ( 2 , "SNMP command failed on device %x: (%#x)\n" , CARD_DEVID ( card ) , rc ) ; } else { if ( copy_to_user ( udata , qinfo . udata , qinfo . udata_len ) ) { rc = - EFAULT ; } } return rc ; } 