STATIC int xlog_find_zeroed ( struct xlog * log , xfs_daddr_t * blk_no ) { xfs_buf_t * bp ; char * offset ; uint first_cycle , last_cycle ; xfs_daddr_t new_blk , last_blk , start_blk ; xfs_daddr_t num_scan_bblks ; int error , log_bbnum = log -> l_logBBsize ; * blk_no = 0 ; bp = xlog_get_bp ( log , 1 ) ; error = xlog_bread ( log , 0 , 1 , bp , & offset ) ; if ( error ) { bp_err } first_cycle = xlog_get_cycle ( offset ) ; if ( first_cycle == 0 ) { * blk_no = 0 ; xlog_put_bp ( bp ) ; return 1 ; } error = xlog_bread ( log , log_bbnum - 1 , 1 , bp , & offset ) ; if ( error ) { bp_err } last_cycle = xlog_get_cycle ( offset ) ; if ( last_cycle != 0 ) { xlog_put_bp ( bp ) ; return 0 ; } if ( first_cycle != 1 ) { xfs_warn ( log -> l_mp , "Log inconsistent or not a log (last==0, first!=1)" ) ; error = - EINVAL ; bp_err } last_blk = log_bbnum - 1 ; if ( ( error = xlog_find_cycle_start ( log , bp , 0 , & last_blk , 0 ) ) ) { bp_err } num_scan_bblks = XLOG_TOTAL_REC_SHIFT ( log ) ; ASSERT ( num_scan_bblks <= INT_MAX ) ; if ( last_blk < num_scan_bblks ) { num_scan_bblks = last_blk ; } start_blk = last_blk - num_scan_bblks ; if ( ( error = xlog_find_verify_cycle ( log , start_blk , ( int ) num_scan_bblks , 0 , & new_blk ) ) ) { bp_err } if ( new_blk != - 1 ) { last_blk = new_blk ; } error = xlog_find_verify_log_record ( log , start_blk , & last_blk , 0 ) ; if ( error == 1 ) { error = - EIO ; } if ( error ) { bp_err } * blk_no = last_blk ; bp_err xlog_put_bp ( bp ) ; if ( error ) { return error ; } return 1 ; } 