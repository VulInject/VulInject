static int opentap ( const char * devname ) { int ifindex ; char buf [ 256 ] ; int fd ; struct ifreq ifr ; ifindex = if_nametoindex ( devname ) ; if ( ifindex == 0 ) { fprintf ( stderr , "%s: ifindex %s\n" , __func__ , strerror ( errno ) ) ; return - errno ; } sprintf ( buf , "/dev/tap%d" , ifindex ) ; fd = open ( buf , O_RDWR | O_NONBLOCK ) ; if ( fd < 0 ) { fprintf ( stderr , "%s: open %s\n" , __func__ , strerror ( errno ) ) ; return - errno ; } strcpy ( ifr . ifr_name , devname ) ; ifr . ifr_flags = IFF_TAP | IFF_NO_PI | IFF_VNET_HDR | IFF_MULTI_QUEUE ; if ( ioctl ( fd , TUNSETIFF , & ifr , sizeof ( ifr ) ) < 0 ) { return - errno ; } return fd ; } 