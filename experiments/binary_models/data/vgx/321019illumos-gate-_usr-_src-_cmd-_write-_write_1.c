static int readcsi ( d , buf , nbytereq ) int d ; char * buf ; int nbytereq ; { static char delta_pool [ MB_LEN_MAX * 2 ] ; static char delta_size ; char * cp , * nextp , * lastp ; int n ; int r_size ; if ( delta_size ) { memcpy ( buf , delta_pool , delta_size ) ; cp = buf + delta_size ; r_size = nbytereq - delta_size ; } else { cp = buf ; r_size = nbytereq ; } if ( ( r_size = read ( d , cp , r_size ) ) < 0 ) { r_size = 0 ; } nextp = buf ; lastp = buf + n ; while ( nextp < lastp ) { if ( ( n = ( lastp - nextp ) ) > ( unsigned int ) MB_CUR_MAX ) { n = ( unsigned int ) MB_CUR_MAX ; } if ( ( n = mbtowc ( ( wchar_t * ) 0 , nextp , n ) ) <= 0 ) { if ( ( lastp - nextp ) < ( unsigned int ) MB_CUR_MAX ) { break ; } n = 1 ; } nextp += n ; } delta_size = lastp - nextp ; if ( delta_size > 0 ) { if ( nextp [ delta_size - 1 ] != '\n' ) { memcpy ( delta_pool , nextp , delta_size ) ; } else { nextp = lastp ; } } * nextp = '\0' ; return ( nextp - buf ) ; } 