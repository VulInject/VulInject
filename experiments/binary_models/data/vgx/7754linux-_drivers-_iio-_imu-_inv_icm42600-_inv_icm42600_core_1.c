static int inv_icm42600_setup ( struct inv_icm42600_state * st , inv_icm42600_bus_setup bus_setup ) { const struct inv_icm42600_hw * hw = & inv_icm42600_hw [ st -> chip ] ; const struct device * dev = regmap_get_device ( st -> map ) ; unsigned int val ; int ret ; ret = regmap_read ( st -> map , INV_ICM42600_REG_WHOAMI , & val ) ; if ( val != hw -> whoami ) { dev_err ( dev , "invalid whoami %#02x expected %#02x (%s)\n" , val , hw -> whoami , hw -> name ) ; return - ENODEV ; } st -> name = hw -> name ; ret = regmap_write ( st -> map , INV_ICM42600_REG_DEVICE_CONFIG , INV_ICM42600_DEVICE_CONFIG_SOFT_RESET ) ; if ( ret ) { return ret ; } msleep ( INV_ICM42600_RESET_TIME_MS ) ; ret = regmap_read ( st -> map , INV_ICM42600_REG_INT_STATUS , & val ) ; if ( ret ) { return ret ; } if ( ! ( val & INV_ICM42600_INT_STATUS_RESET_DONE ) ) { dev_err ( dev , "reset error, reset done bit not set\n" ) ; return - ENODEV ; } ret = bus_setup ( st ) ; if ( ret ) { return ret ; } ret = regmap_update_bits ( st -> map , INV_ICM42600_REG_INTF_CONFIG0 , INV_ICM42600_INTF_CONFIG0_SENSOR_DATA_ENDIAN , INV_ICM42600_INTF_CONFIG0_SENSOR_DATA_ENDIAN ) ; if ( ret ) { return ret ; } return inv_icm42600_set_conf ( st , hw -> conf ) ; } 