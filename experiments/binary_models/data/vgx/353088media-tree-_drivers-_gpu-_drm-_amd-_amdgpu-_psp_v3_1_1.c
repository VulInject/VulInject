int psp_v3_1_cmd_submit ( struct psp_context * psp , struct amdgpu_firmware_info * ucode , uint64_t cmd_buf_mc_addr , uint64_t fence_mc_addr , int index ) { unsigned int psp_write_ptr_reg = 0 ; struct psp_gfx_rb_frame * write_frame = psp -> km_ring . ring_mem ; struct psp_ring * ring = & psp -> km_ring ; struct amdgpu_device * adev = psp -> adev ; uint32_t ring_size_dw = ring -> ring_size / 4 ; uint32_t rb_frame_size_dw = sizeof ( psp_gfx_rb_frame ) / 4 ; psp_write_ptr_reg = RREG32 ( SOC15_REG_OFFSET ( MP0 , 0 , mmMP0_SMN_C2PMSG_67 ) ) ; if ( ( psp_write_ptr_reg % ring_size_dw ) == 0 ) { write_frame = ring -> ring_mem ; } else { write_frame = ring -> ring_mem + ( psp_write_ptr_reg / rb_frame_size_dw ) ; } write_frame -> cmd_buf_addr_hi = ( unsigned int ) ( cmd_buf_mc_addr >> 32 ) ; write_frame -> cmd_buf_addr_lo = ( unsigned int ) ( cmd_buf_mc_addr ) ; write_frame -> fence_addr_hi = ( unsigned int ) ( fence_mc_addr >> 32 ) ; write_frame -> fence_addr_lo = ( unsigned int ) ( fence_mc_addr ) ; write_frame -> fence_value = index ; psp_write_ptr_reg = ( psp_write_ptr_reg + rb_frame_size_dw ) % ring_size_dw ; WREG32 ( SOC15_REG_OFFSET ( MP0 , 0 , mmMP0_SMN_C2PMSG_67 ) , psp_write_ptr_reg ) ; return 0 ; } 