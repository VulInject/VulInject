static int stm32_fmc2_ebi_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct stm32_fmc2_ebi * ebi ; struct reset_control * rstc ; int ret ; ebi = devm_kzalloc ( & pdev -> dev , sizeof ( * ebi ) , GFP_KERNEL ) ; ebi -> dev = dev ; ebi -> regmap = device_node_to_regmap ( dev -> of_node ) ; if ( IS_ERR ( ebi -> regmap ) ) { return PTR_ERR ( ebi -> regmap ) ; } ebi -> clk = devm_clk_get ( dev , NULL ) ; if ( IS_ERR ( ebi -> clk ) ) { return PTR_ERR ( ebi -> clk ) ; } rstc = devm_reset_control_get ( dev , NULL ) ; if ( PTR_ERR ( rstc ) == - EPROBE_DEFER ) { return - EPROBE_DEFER ; } ret = clk_prepare_enable ( ebi -> clk ) ; if ( ret ) { return ret ; } if ( ! IS_ERR ( rstc ) ) { reset_control_assert ( rstc ) ; reset_control_deassert ( rstc ) ; } ret = stm32_fmc2_ebi_parse_dt ( ebi ) ; if ( ret ) { err_release } stm32_fmc2_ebi_save_setup ( ebi ) ; platform_set_drvdata ( pdev , ebi ) ; return 0 ; err_release stm32_fmc2_ebi_disable_banks ( ebi ) ; stm32_fmc2_ebi_disable ( ebi ) ; clk_disable_unprepare ( ebi -> clk ) ; return ret ; } 