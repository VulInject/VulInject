int cgetstr ( char * buf , const char * cap , char * * str ) { u_int m_room ; char * bp , * mp ; int len ; char * mem ; bp = cgetcap ( buf , cap , '=' ) ; if ( bp == NULL ) { return ( - 1 ) ; } if ( ( mem = malloc ( SFRAG ) ) == NULL ) { return ( - 2 ) ; } m_room = SFRAG ; mp = mem ; while ( * bp != ':' && * bp != '\0' ) { if ( * bp == '^' ) { bp ++ ; if ( * bp == ':' || * bp == '\0' ) { break ; } * mp ++ = * bp ++ & 037 ; } if ( * bp == '\\' ) { bp ++ ; if ( * bp == ':' || * bp == '\0' ) { break ; } if ( '0' <= * bp && * bp <= '7' ) { int n , i ; n = 0 ; i = 3 ; { n = n * 8 + ( * bp ++ - '0' ) ; } -- i && '0' <= * bp && * bp <= '7' ; * mp ++ = n ; } else { switch ( * bp ++ ) { case 'b' : case 'B' : * mp ++ = '\b' ; break ; case 't' : case 'T' : * mp ++ = '\t' ; break ; case 'n' : case 'N' : * mp ++ = '\n' ; break ; case 'f' : case 'F' : * mp ++ = '\f' ; break ; case 'r' : case 'R' : * mp ++ = '\r' ; break ; case 'e' : case 'E' : * mp ++ = ESC ; break ; case 'c' : case 'C' : * mp ++ = ':' ; break ; default : * mp ++ = * ( bp - 1 ) ; break ; } } } else { * mp ++ = * bp ++ ; } m_room -- ; if ( m_room == 0 ) { size_t size = mp - mem ; char * nmem ; if ( ( nmem = realloc ( mem , size + SFRAG ) ) == NULL ) { return ( - 2 ) ; } mem = nmem ; m_room = SFRAG ; mp = mem + size ; } } * mp ++ = '\0' ; m_room -- ; len = mp - mem - 1 ; if ( m_room != 0 ) { char * nmem ; if ( ( nmem = realloc ( mem , mp - mem ) ) == NULL ) { free ( mem ) ; return ( - 2 ) ; } mem = nmem ; } * str = mem ; return ( len ) ; } 