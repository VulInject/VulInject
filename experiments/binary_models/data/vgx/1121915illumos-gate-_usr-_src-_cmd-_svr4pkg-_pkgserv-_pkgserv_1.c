static void pkgdump ( void ) { FILE * cnts ; int err = 0 ; pkgentry_t * p ; if ( sync_needed ) { return ; } cnts = fopen ( TCONTENTS , "w" ) ; if ( cnts == NULL ) { exit ( 99 ) ; } for ( p = avl_first ( list ) ; p != NULL ; p = AVL_NEXT ( list , p ) ) { if ( fprintf ( cnts , "%s\n" , p -> line ) < 0 ) { err ++ ; } } if ( ccmnt [ 0 ] != NULL ) { ( void ) fprintf ( cnts , "%s\n" , ccmnt [ 0 ] ) ; } if ( ccmnt [ 1 ] != NULL ) { ( void ) fprintf ( cnts , "%s\n" , ccmnt [ 1 ] ) ; } if ( err != 0 || fflush ( cnts ) == EOF || fsync ( fileno ( cnts ) ) != 0 || fclose ( cnts ) == EOF || rename ( TCONTENTS , CONTENTS ) != 0 ) { err ++ ; } if ( err != 0 ) { progerr ( "cannot rewrite the contents file" ) ; exit ( 2 ) ; } ( void ) fclose ( log ) ; ( void ) unlink ( PKGLOG ) ; log = NULL ; ndumps ++ ; logcount = 0 ; } 