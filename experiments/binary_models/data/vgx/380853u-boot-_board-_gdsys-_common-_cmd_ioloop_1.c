int do_ioloop ( struct cmd_tbl * cmdtp , int flag , int argc , char * const argv [ ] ) { uint fpga ; uint size ; uint rate = 0 ; fpga = dectoul ( argv [ 1 ] , NULL ) ; size = dectoul ( argv [ 2 ] , NULL ) ; if ( argc > 3 ) { rate = dectoul ( argv [ 3 ] , NULL ) ; } FPGA_SET_REG ( fpga , ep . rx_tx_control , CTRL_PROC_RECEIVE_ENABLE ) ; FPGA_SET_REG ( fpga , ep . device_address , 1 ) ; rx_ctr = 0 ; tx_ctr = 0 ; err_ctr = 0 ; while ( 1 ) { u16 top_int ; u16 rx_tx_status ; FPGA_GET_REG ( fpga , top_interrupt , & top_int ) ; FPGA_GET_REG ( fpga , ep . rx_tx_status , & rx_tx_status ) ; io_check_status ( fpga , rx_tx_status , STATUS_LOUD ) ; if ( top_int & IRQ_CPU_TRANSMITBUFFER_FREE_STATUS ) { io_send ( fpga , size ) ; } if ( top_int & IRQ_CPU_RECEIVE_DATA_AVAILABLE_STATUS ) { io_receive ( fpga ) ; } if ( rate ) { if ( ctrlc ( ) ) { break ; } udelay ( 1000000 / rate ) ; if ( ! ( tx_ctr % rate ) ) { printf ( "d %llu, tx %llu, rx %llu, err %llu\n" , tx_ctr - rx_ctr , tx_ctr , rx_ctr , err_ctr ) ; } } } return 0 ; } 