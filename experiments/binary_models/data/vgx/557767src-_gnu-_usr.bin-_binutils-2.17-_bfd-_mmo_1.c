mmo_write_symbols_and_terminator ( ) { int count = bfd_get_symcount ( abfd ) ; asymbol * maintable [ 2 ] ; asymbol * * table ; asymbol * * orig_table = bfd_get_outsymbols ( abfd ) ; int serno ; struct mmo_symbol_trie root ; int trie_len ; int i ; bfd_byte buf [ 4 ] ; asymbol * fakemain = bfd_make_empty_symbol ( abfd ) ; fakemain -> flags = BSF_GLOBAL ; fakemain -> value = bfd_get_start_address ( abfd ) ; fakemain -> name = MMIX_START_SYMBOL_NAME ; fakemain -> section = bfd_abs_section_ptr ; maintable [ 0 ] = fakemain ; maintable [ 1 ] = NULL ; root . symchar = 0xff ; table = bfd_alloc ( abfd , ( count + 1 ) * sizeof ( asymbol * ) ) ; if ( table == NULL ) { return FALSE ; } memcpy ( table , orig_table , count * sizeof ( asymbol * ) ) ; for ( i = 0 ; i < count ; i ++ ) { if ( table [ i ] != NULL && strcmp ( table [ i ] -> name , MMIX_START_SYMBOL_NAME ) == 0 && ( table [ i ] -> flags & ( BSF_DEBUGGING | BSF_GLOBAL ) ) == BSF_GLOBAL ) { asymbol * mainsym = table [ i ] ; memcpy ( table + 1 , orig_table , i * sizeof ( asymbol * ) ) ; table [ 0 ] = mainsym ; if ( ( mainsym -> value + mainsym -> section -> output_section -> vma + mainsym -> section -> output_offset ) != bfd_get_start_address ( abfd ) ) { char vmas_main [ 40 ] ; char vmas_start [ 40 ] ; bfd_vma vma_start = bfd_get_start_address ( abfd ) ; sprintf_vma ( vmas_main , mainsym -> value ) ; sprintf_vma ( vmas_start , vma_start ) ; * _bfd_error_handler ( _ ( "%s: Bad symbol definition: `Main' set to %s rather" " than the start address %s\n" ) , bfd_get_filename ( abfd ) , vmas_main , vmas_start ) ; bfd_set_error ( bfd_error_bad_value ) ; return FALSE ; } break ; } } if ( i == count && count != 0 ) { memcpy ( table + 1 , orig_table , count * sizeof ( asymbol * ) ) ; table [ 0 ] = fakemain ; count ++ ; } for ( i = 0 , serno = 1 ; i < count && table [ i ] != NULL ; i ++ ) { asymbol * s = table [ i ] ; if ( ( s -> flags & ( BSF_DEBUGGING | BSF_GLOBAL ) ) == BSF_GLOBAL && strspn ( s -> name , valid_mmo_symbol_character_set ) == strlen ( s -> name ) ) { struct mmo_symbol sym ; memset ( & sym , 0 , sizeof ( sym ) ) ; sym . name = ( char * ) s -> name ; sym . value = s -> value + s -> section -> output_section -> vma + s -> section -> output_offset ; if ( bfd_is_und_section ( s -> section ) ) { sym . sym_type = mmo_undef_sym ; } if ( strcmp ( s -> section -> name , MMO_DATA_SECTION_NAME ) == 0 && ( sym . value >> 48 ) == 0x2000 ) { sym . sym_type = mmo_data_sym ; } if ( strcmp ( s -> section -> name , MMIX_REG_SECTION_NAME ) == 0 ) { sym . sym_type = mmo_reg_sym ; } if ( strcmp ( s -> section -> name , MMIX_REG_CONTENTS_SECTION_NAME ) == 0 ) { sym . sym_type = mmo_reg_sym ; sym . value /= 8 ; } else { sym . sym_type = mmo_abs_sym ; } sym . serno = serno ++ ; if ( ! mmo_internal_add_3_sym ( abfd , & root , & sym ) ) { return FALSE ; } } } root . symchar = ':' ; root . middle = root . left ; root . right = NULL ; root . left = NULL ; trie_len = ( mmo_internal_3_length ( abfd , & root ) + 3 ) / 4 ; if ( trie_len > 0xffff ) { struct mmo_symbol sym ; * _bfd_error_handler ( _ ( "%s: warning: symbol table too large for mmo, larger than 65535" " 32-bit words: %d.  Only `Main' will be emitted.\n" ) , bfd_get_filename ( abfd ) , trie_len ) ; memset ( & sym , 0 , sizeof ( sym ) ) ; sym . sym_type = mmo_abs_sym ; sym . name = MMIX_START_SYMBOL_NAME ; sym . serno = 1 ; sym . value = bfd_get_start_address ( abfd ) ; memset ( & root , 0 , sizeof ( root ) ) ; root . left = root . middle ; root . symchar = 0xff ; root . middle = NULL ; root . right = NULL ; if ( ! mmo_internal_add_3_sym ( abfd , & root , & sym ) ) { return FALSE ; } root . symchar = ':' ; root . middle = root . left ; root . right = NULL ; root . left = NULL ; trie_len = ( mmo_internal_3_length ( abfd , & root ) + 3 ) / 4 ; } abfd -> tdata . mmo_data -> byte_no = 0 ; bfd_put_32 ( abfd , ( LOP << 24 ) | ( LOP_STAB << 16 ) , buf ) ; if ( bfd_bwrite ( buf , 4 , abfd ) != 4 ) { return FALSE ; } mmo_internal_3_dump ( abfd , & root ) ; if ( trie_len != ( abfd -> tdata . mmo_data -> byte_no + 3 ) / 4 ) { * _bfd_error_handler ( _ ( "%s: internal error, symbol table changed size from %d to %d" " words\n" ) , bfd_get_filename ( abfd ) , trie_len , ( abfd -> tdata . mmo_data -> byte_no + 3 ) / 4 ) ; bfd_set_error ( bfd_error_bad_value ) ; return FALSE ; } if ( ( abfd -> tdata . mmo_data -> byte_no % 4 ) != 0 || abfd -> tdata . mmo_data -> have_error ) { memset ( abfd -> tdata . mmo_data -> buf + ( abfd -> tdata . mmo_data -> byte_no % 4 ) , 0 , 4 - ( abfd -> tdata . mmo_data -> byte_no % 4 ) ) ; if ( abfd -> tdata . mmo_data -> have_error || bfd_bwrite ( abfd -> tdata . mmo_data -> buf , 4 , abfd ) != 4 ) { return FALSE ; } } bfd_put_32 ( abfd , ( LOP << 24 ) | ( LOP_END << 16 ) | trie_len , buf ) ; return bfd_bwrite ( buf , 4 , abfd ) == 4 ; } 