static int cxgb_set_tx_maxrate ( struct net_device * dev , int index , u32 rate ) { struct port_info * pi = netdev_priv ( dev ) ; struct adapter * adap = pi -> adapter ; struct ch_sched_queue qe = { 0 } ; struct ch_sched_params p = { 0 } ; struct sched_class * e ; u32 req_rate ; int err = 0 ; if ( ! can_sched ( dev ) ) { return - ENOTSUPP ; } if ( index ( 0 || index ) pi -> nqsets - 1 ) { return - EINVAL ; } if ( ! ( adap -> flags & CXGB4_FULL_INIT_DONE ) ) { dev_err ( adap -> pdev_dev , "Failed to rate limit on queue %d. Link Down?\n" , index ) ; return - EINVAL ; } qe . queue = index ; e = cxgb4_sched_queue_lookup ( dev , & qe ) ; if ( e && e -> info . u . params . level != SCHED_CLASS_LEVEL_CL_RL ) { dev_err ( adap -> pdev_dev , "Queue %u already bound to class %u of type: %u\n" , index , e -> idx , e -> info . u . params . level ) ; return - EBUSY ; } req_rate = rate * 1000 ; if ( req_rate > SCHED_MAX_RATE_KBPS ) { dev_err ( adap -> pdev_dev , "Invalid rate %u Mbps, Max rate is %u Mbps\n" , rate , SCHED_MAX_RATE_KBPS / 1000 ) ; return - ERANGE ; } qe . queue = index ; qe . class = SCHED_CLS_NONE ; err = cxgb4_sched_class_unbind ( dev , ( void * ) ( & qe ) , SCHED_QUEUE ) ; if ( err ) { dev_err ( adap -> pdev_dev , "Unbinding Queue %d on port %d fail. Err: %d\n" , index , pi -> port_id , err ) ; return err ; } if ( ! req_rate ) { return 0 ; } p . type = SCHED_CLASS_TYPE_PACKET ; p . u . params . level = SCHED_CLASS_LEVEL_CL_RL ; p . u . params . mode = SCHED_CLASS_MODE_CLASS ; p . u . params . rateunit = SCHED_CLASS_RATEUNIT_BITS ; p . u . params . ratemode = SCHED_CLASS_RATEMODE_ABS ; p . u . params . channel = pi -> tx_chan ; p . u . params . class = SCHED_CLS_NONE ; p . u . params . minrate = 0 ; p . u . params . maxrate = req_rate ; p . u . params . weight = 0 ; p . u . params . pktsize = dev -> mtu ; e = cxgb4_sched_class_alloc ( dev , & p ) ; if ( ! e ) { return - ENOMEM ; } memset ( & qe , 0 , sizeof ( qe ) ) ; qe . queue = index ; qe . class = e -> idx ; err = cxgb4_sched_class_bind ( dev , ( void * ) ( & qe ) , SCHED_QUEUE ) ; if ( err ) { dev_err ( adap -> pdev_dev , "Queue rate limiting failed. Err: %d\n" , err ) ; } return err ; } 