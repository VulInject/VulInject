static int mv_chan_memcpy_self_test ( struct mv_xor_chan * mv_chan ) { int i , ret ; void * src , * dest ; dma_addr_t src_dma , dest_dma ; struct dma_chan * dma_chan ; dma_cookie_t cookie ; struct dma_async_tx_descriptor * tx ; struct dmaengine_unmap_data * unmap ; int err = 0 ; src = kmalloc ( sizeof ( u8 ) * PAGE_SIZE , GFP_KERNEL ) ; if ( ! src ) { return - ENOMEM ; } dest = kzalloc ( sizeof ( u8 ) * PAGE_SIZE , GFP_KERNEL ) ; if ( ! dest ) { return - ENOMEM ; } for ( i = 0 ; i < PAGE_SIZE ; i ++ ) { ( ( u8 * ) src ) [ i ] = ( u8 ) i ; } dma_chan = & mv_chan -> dmachan ; if ( mv_xor_alloc_chan_resources ( dma_chan ) < 1 ) { err = - ENODEV ; out } unmap = dmaengine_get_unmap_data ( dma_chan -> device -> dev , 2 , GFP_KERNEL ) ; if ( ! unmap ) { err = - ENOMEM ; free_resources } src_dma = dma_map_page ( dma_chan -> device -> dev , virt_to_page ( src ) , offset_in_page ( src ) , PAGE_SIZE , DMA_TO_DEVICE ) ; unmap -> addr [ 0 ] = src_dma ; ret = dma_mapping_error ( dma_chan -> device -> dev , src_dma ) ; if ( ret ) { err = - ENOMEM ; free_resources } unmap -> to_cnt = 1 ; dest_dma = dma_map_page ( dma_chan -> device -> dev , virt_to_page ( dest ) , offset_in_page ( dest ) , PAGE_SIZE , DMA_FROM_DEVICE ) ; unmap -> addr [ 1 ] = dest_dma ; ret = dma_mapping_error ( dma_chan -> device -> dev , dest_dma ) ; if ( ret ) { err = - ENOMEM ; free_resources } unmap -> from_cnt = 1 ; unmap -> len = PAGE_SIZE ; tx = mv_xor_prep_dma_memcpy ( dma_chan , dest_dma , src_dma , PAGE_SIZE , 0 ) ; if ( ! tx ) { dev_err ( dma_chan -> device -> dev , "Self-test cannot prepare operation, disabling\n" ) ; err = - ENODEV ; free_resources } cookie = mv_xor_tx_submit ( tx ) ; if ( dma_submit_error ( cookie ) ) { dev_err ( dma_chan -> device -> dev , "Self-test submit error, disabling\n" ) ; err = - ENODEV ; free_resources } mv_xor_issue_pending ( dma_chan ) ; async_tx_ack ( tx ) ; msleep ( 1 ) ; if ( mv_xor_status ( dma_chan , cookie , NULL ) != DMA_COMPLETE ) { dev_err ( dma_chan -> device -> dev , "Self-test copy timed out, disabling\n" ) ; err = - ENODEV ; free_resources } dma_sync_single_for_cpu ( dma_chan -> device -> dev , dest_dma , PAGE_SIZE , DMA_FROM_DEVICE ) ; if ( memcmp ( src , dest , PAGE_SIZE ) ) { dev_err ( dma_chan -> device -> dev , "Self-test copy failed compare, disabling\n" ) ; err = - ENODEV ; free_resources } free_resources dmaengine_unmap_put ( unmap ) ; mv_xor_free_chan_resources ( dma_chan ) ; out kfree ( src ) ; kfree ( dest ) ; return err ; } 