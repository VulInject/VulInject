int vega10_fan_ctrl_get_fan_speed_rpm ( struct pp_hwmgr * hwmgr , uint32_t * speed ) { struct amdgpu_device * adev = hwmgr -> adev ; struct vega10_hwmgr * data = hwmgr -> backend ; uint32_t tach_period ; uint32_t crystal_clock_freq ; int result = 0 ; if ( hwmgr -> thermal_controller . fanInfo . bNoFan ) { return - 1 ; } if ( data -> smu_features [ GNLD_FAN_CONTROL ] . supported ) { result = vega10_get_current_rpm ( hwmgr , speed ) ; } else { tach_period = REG_GET_FIELD ( RREG32_SOC15 ( THM , 0 , mmCG_TACH_STATUS ) , CG_TACH_STATUS , TACH_PERIOD ) ; crystal_clock_freq = amdgpu_asic_get_xclk ( ( amdgpu_device * ) hwmgr -> adev ) ; * speed = 60 * crystal_clock_freq * 10000 / tach_period ; } return result ; } 