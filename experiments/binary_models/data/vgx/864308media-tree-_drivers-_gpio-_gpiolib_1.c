static long linehandle_ioctl ( struct file * filep , unsigned int cmd , unsigned long arg ) { struct linehandle_state * lh = filep -> private_data ; void __user * ip = ( void __user * ) arg ; struct gpiohandle_data ghd ; int i ; if ( cmd == GPIOHANDLE_GET_LINE_VALUES_IOCTL ) { int val ; for ( i = 0 ; i < lh -> numdescs ; i ++ ) { val = gpiod_get_value_cansleep ( lh -> descs [ i ] ) ; if ( val < 0 ) { return val ; } ghd . values [ i ] = val ; } if ( copy_to_user ( ip , & ghd , sizeof ( ghd ) ) ) { return - EFAULT ; } return 0 ; } if ( cmd == GPIOHANDLE_SET_LINE_VALUES_IOCTL ) { int vals [ GPIOHANDLES_MAX ] ; if ( copy_from_user ( & ghd , ip , sizeof ( ghd ) ) ) { return - EFAULT ; } for ( i = 0 ; i < lh -> numdescs ; i ++ ) { vals [ i ] = ! ! ghd . values [ i ] ; } gpiod_set_array_value_complex ( false , true , lh -> numdescs , lh -> descs , vals ) ; return 0 ; } return - EINVAL ; } 