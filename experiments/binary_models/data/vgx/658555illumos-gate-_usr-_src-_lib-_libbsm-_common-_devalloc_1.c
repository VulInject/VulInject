int da_check_logindevperm ( char * devname ) { int ret = 0 ; int fd = - 1 ; int nlen , plen , slen , lineno , fsize ; char line [ MAX_CANON ] ; char * field_delims = " \t\n" ; char * fbuf = NULL ; char * ptr , * device ; char * lasts = NULL ; FILE * fp ; struct stat f_stat ; if ( ( fd = open ( LOGINDEVPERM , O_RDONLY ) ) == - 1 ) { return ( 0 ) ; } if ( fstat ( fd , & f_stat ) != 0 ) { ( void ) close ( fd ) ; return ( 0 ) ; } fsize = f_stat . st_size ; if ( ( fbuf = ( char * ) malloc ( fsize ) ) == NULL ) { ( void ) close ( fd ) ; return ( 0 ) ; } if ( ( fp = fdopen ( fd , "rF" ) ) == NULL ) { ( void ) close ( fd ) ; return ( 0 ) ; } plen = nlen = lineno = 0 ; while ( fgets ( line , MAX_CANON , fp ) != NULL ) { lineno ++ ; if ( ( ptr = strchr ( line , '#' ) ) != NULL ) { * ptr = '\0' ; } if ( strtok_r ( line , field_delims , & lasts ) == NULL ) { continue ; } if ( strtok_r ( NULL , field_delims , & lasts ) == NULL ) { continue ; } if ( ( ptr = strtok_r ( NULL , field_delims , & lasts ) ) == NULL ) { continue ; } nlen = strlen ( ptr ) + 1 ; nlen += ( plen + 1 ) ; if ( plen == 0 ) { slen = snprintf ( fbuf , nlen , "%s" , ptr ) ; } else { slen = snprintf ( fbuf + plen , nlen - plen , ":%s" , ptr ) ; } if ( slen >= fsize ) { fbuf [ 0 ] = '\0' ; ( void ) fclose ( fp ) ; return ( slen ) ; } plen += slen ; } ( void ) fclose ( fp ) ; device = strtok_r ( fbuf , ":" , & lasts ) ; while ( device != NULL ) { if ( strcmp ( device , devname ) == 0 ) { free ( fbuf ) ; return ( 1 ) ; } if ( ( ptr = strrchr ( device , KV_WILDCHAR ) ) != NULL ) { * ptr = '\0' ; if ( strncmp ( device , devname , strlen ( device ) ) == 0 ) { free ( fbuf ) ; return ( 1 ) ; } } device = strtok_r ( NULL , ":" , & lasts ) ; } return ( ret ) ; } 