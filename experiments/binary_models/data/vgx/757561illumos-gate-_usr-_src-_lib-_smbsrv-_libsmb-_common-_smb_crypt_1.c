int smb_auth_RC4 ( uchar_t * Result , int ResultLen , uchar_t * Key , int KeyLen , uchar_t * Data , int DataLen ) { CK_RV rv ; CK_MECHANISM mechanism ; CK_OBJECT_HANDLE hKey ; CK_SESSION_HANDLE hSession ; CK_ULONG ciphertext_len ; int error = SMBAUTH_FAILURE ; mechanism . mechanism = CKM_RC4 ; mechanism . pParameter = NULL ; mechanism . ulParameterLen = 0 ; rv = SUNW_C_GetMechSession ( mechanism . mechanism , & hSession ) ; rv = SUNW_C_KeyToObject ( hSession , mechanism . mechanism , Key , KeyLen , & hKey ) ; if ( rv != CKR_OK ) { exit_session } rv = C_EncryptInit ( hSession , & mechanism , hKey ) ; if ( rv != CKR_OK ) { exit_encrypt } ciphertext_len = ResultLen ; rv = C_EncryptUpdate ( hSession , ( CK_BYTE_PTR ) Data , DataLen , ( CK_BYTE_PTR ) Result , & ciphertext_len ) ; if ( rv == CKR_OK ) { error = 0 ; } exit_encrypt ( void ) C_DestroyObject ( hSession , hKey ) ; exit_session ( void ) C_CloseSession ( hSession ) ; return ( error ) ; } 