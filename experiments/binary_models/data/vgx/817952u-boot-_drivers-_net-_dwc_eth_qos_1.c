static int eqos_probe_resources_core ( struct udevice * dev ) { struct eqos_priv * eqos = dev_get_priv ( dev ) ; unsigned int desc_step ; int ret ; debug ( "%s(dev=%p):\n" , __func__ , dev ) ; desc_step = sizeof ( eqos_desc ) + EQOS_DMA_CH0_CONTROL_DSL_MASK * eqos -> config -> axi_bus_width ; if ( desc_step < ARCH_DMA_MINALIGN ) { eqos -> desc_size = BIT ( fls ( desc_step ) - 1 ) ; } else { eqos -> desc_size = ALIGN ( sizeof ( eqos_desc ) , ( unsigned int ) ARCH_DMA_MINALIGN ) ; } eqos -> desc_per_cacheline = ARCH_DMA_MINALIGN / eqos -> desc_size ; eqos -> tx_descs = eqos_alloc_descs ( eqos , EQOS_DESCRIPTORS_TX ) ; if ( ! eqos -> tx_descs ) { debug ( "%s: eqos_alloc_descs(tx) failed\n" , __func__ ) ; ret = - ENOMEM ; err } eqos -> rx_descs = eqos_alloc_descs ( eqos , EQOS_DESCRIPTORS_RX ) ; if ( ! eqos -> rx_descs ) { debug ( "%s: eqos_alloc_descs(rx) failed\n" , __func__ ) ; ret = - ENOMEM ; err_free_tx_descs } eqos -> tx_dma_buf = memalign ( EQOS_BUFFER_ALIGN , EQOS_MAX_PACKET_SIZE ) ; if ( ! eqos -> tx_dma_buf ) { debug ( "%s: memalign(tx_dma_buf) failed\n" , __func__ ) ; ret = - ENOMEM ; err_free_descs } debug ( "%s: tx_dma_buf=%p\n" , __func__ , eqos -> tx_dma_buf ) ; eqos -> rx_dma_buf = memalign ( EQOS_BUFFER_ALIGN , EQOS_RX_BUFFER_SIZE ) ; if ( ! eqos -> rx_dma_buf ) { debug ( "%s: memalign(rx_dma_buf) failed\n" , __func__ ) ; ret = - ENOMEM ; err_free_tx_dma_buf } debug ( "%s: rx_dma_buf=%p\n" , __func__ , eqos -> rx_dma_buf ) ; eqos -> rx_pkt = malloc ( EQOS_MAX_PACKET_SIZE ) ; if ( ! eqos -> rx_pkt ) { debug ( "%s: malloc(rx_pkt) failed\n" , __func__ ) ; ret = - ENOMEM ; err_free_rx_dma_buf } debug ( "%s: rx_pkt=%p\n" , __func__ , eqos -> rx_pkt ) ; eqos -> config -> ops -> eqos_inval_buffer ( eqos -> rx_dma_buf , EQOS_MAX_PACKET_SIZE * EQOS_DESCRIPTORS_RX ) ; debug ( "%s: OK\n" , __func__ ) ; return 0 ; err_free_rx_dma_buf err_free_tx_dma_buf free ( eqos -> tx_dma_buf ) ; err_free_descs eqos_free_descs ( eqos -> rx_descs ) ; err_free_tx_descs eqos_free_descs ( eqos -> tx_descs ) ; err debug ( "%s: returns %d\n" , __func__ , ret ) ; return ret ; } 