static int ttusb_probe ( struct usb_interface * intf , const struct usb_device_id * id ) { struct usb_device * udev ; struct ttusb * ttusb ; int result ; dprintk ( "%s: TTUSB DVB connected\n" , __func__ ) ; udev = interface_to_usbdev ( intf ) ; if ( intf -> altsetting -> desc . bInterfaceNumber != 1 ) { return - ENODEV ; } if ( ! ( ttusb = kzalloc ( sizeof ( ttusb ) , GFP_KERNEL ) ) ) { return - ENOMEM ; } ttusb -> dev = udev ; ttusb -> c = 0 ; ttusb -> mux_state = 0 ; mutex_init ( & ttusb -> semi2c ) ; mutex_lock ( & ttusb -> semi2c ) ; mutex_init ( & ttusb -> semusb ) ; ttusb_setup_interfaces ( ttusb ) ; result = ttusb_alloc_iso_urbs ( ttusb ) ; if ( result < 0 ) { dprintk ( "%s: ttusb_alloc_iso_urbs - failed\n" , __func__ ) ; mutex_unlock ( & ttusb -> semi2c ) ; return result ; } if ( ttusb_init_controller ( ttusb ) ) { printk ( "ttusb_init_controller: error\n" ) ; } mutex_unlock ( & ttusb -> semi2c ) ; result = dvb_register_adapter ( & ttusb -> adapter , "Technotrend/Hauppauge Nova-USB" , THIS_MODULE , & udev -> dev , adapter_nr ) ; if ( result < 0 ) { ttusb_free_iso_urbs ( ttusb ) ; kfree ( ttusb ) ; return result ; } ttusb -> adapter . priv = ttusb ; memset ( & ttusb -> i2c_adap , 0 , sizeof ( i2c_adapter ) ) ; strcpy ( ttusb -> i2c_adap . name , "TTUSB DEC" ) ; i2c_set_adapdata ( & ttusb -> i2c_adap , ttusb ) ; ttusb -> i2c_adap . algo = & ttusb_dec_algo ; ttusb -> i2c_adap . algo_data = NULL ; ttusb -> i2c_adap . dev . parent = & udev -> dev ; result = i2c_add_adapter ( & ttusb -> i2c_adap ) ; if ( result ) { err_unregister_adapter } memset ( & ttusb -> dvb_demux , 0 , sizeof ( ttusb -> dvb_demux ) ) ; ttusb -> dvb_demux . dmx . capabilities = DMX_TS_FILTERING | DMX_SECTION_FILTERING ; ttusb -> dvb_demux . priv = NULL ; ttusb -> dvb_demux . filternum = TTUSB_MAXFILTER ; ttusb -> dvb_demux . filternum = 32 ; ttusb -> dvb_demux . feednum = TTUSB_MAXCHANNEL ; ttusb -> dvb_demux . start_feed = ttusb_start_feed ; ttusb -> dvb_demux . stop_feed = ttusb_stop_feed ; ttusb -> dvb_demux . write_to_decoder = NULL ; result = dvb_dmx_init ( & ttusb -> dvb_demux ) ; if ( result < 0 ) { printk ( "ttusb_dvb: dvb_dmx_init failed (errno = %d)\n" , result ) ; result = - ENODEV ; err_i2c_del_adapter } ttusb -> dmxdev . filternum = ttusb -> dvb_demux . filternum ; ttusb -> dmxdev . demux = & ttusb -> dvb_demux . dmx ; ttusb -> dmxdev . capabilities = 0 ; result = dvb_dmxdev_init ( & ttusb -> dmxdev , & ttusb -> adapter ) ; if ( result < 0 ) { printk ( "ttusb_dvb: dvb_dmxdev_init failed (errno = %d)\n" , result ) ; result = - ENODEV ; err_release_dmx } if ( dvb_net_init ( & ttusb -> adapter , & ttusb -> dvbnet , & ttusb -> dvb_demux . dmx ) ) { printk ( "ttusb_dvb: dvb_net_init failed!\n" ) ; result = - ENODEV ; err_release_dmxdev } usb_set_intfdata ( intf , ( void * ) ttusb ) ; frontend_init ( ttusb ) ; return 0 ; err_release_dmxdev dvb_dmxdev_release ( & ttusb -> dmxdev ) ; err_release_dmx dvb_dmx_release ( & ttusb -> dvb_demux ) ; err_i2c_del_adapter i2c_del_adapter ( & ttusb -> i2c_adap ) ; err_unregister_adapter dvb_unregister_adapter ( & ttusb -> adapter ) ; ttusb_free_iso_urbs ( ttusb ) ; kfree ( ttusb ) ; return result ; } 