SVCXPRT * svcudp_bufcreate ( int sock , u_int sendsz , u_int recvsz ) { bool_t madesock = FALSE ; SVCXPRT * xprt ; struct svcudp_data * su ; struct sockaddr_storage ss ; struct sockaddr * sa = ( sockaddr * ) & ss ; socklen_t len ; if ( sock == RPC_ANYSOCK ) { if ( ( sock = socket ( AF_INET , SOCK_DGRAM , IPPROTO_UDP ) ) < 0 ) { perror ( "svcudp_create: socket creation problem" ) ; return ( ( SVCXPRT * ) NULL ) ; } set_cloexec_fd ( sock ) ; madesock = TRUE ; memset ( & ss , 0 , sizeof ( ss ) ) ; sa -> sa_family = AF_INET ; } else { len = sizeof ( sockaddr_storage ) ; if ( getsockname ( sock , sa , & len ) < 0 ) { perror ( "svcudp_create - cannot getsockname" ) ; return ( ( SVCXPRT * ) NULL ) ; } } if ( bindresvport_sa ( sock , sa ) ) { sa_setport ( sa , 0 ) ; ( void ) bind ( sock , sa , sa_socklen ( sa ) ) ; } len = sizeof ( sockaddr_storage ) ; if ( getsockname ( sock , sa , & len ) != 0 ) { perror ( "svcudp_create - cannot getsockname" ) ; if ( madesock ) { ( void ) close ( sock ) ; } return ( ( SVCXPRT * ) NULL ) ; } xprt = ( SVCXPRT * ) mem_alloc ( sizeof ( SVCXPRT ) ) ; if ( xprt == NULL ) { ( void ) fprintf ( stderr , "svcudp_create: out of memory\n" ) ; return ( NULL ) ; } su = ( svcudp_data * ) mem_alloc ( sizeof ( * su ) ) ; if ( su == NULL ) { ( void ) fprintf ( stderr , "svcudp_create: out of memory\n" ) ; return ( NULL ) ; } su -> su_iosz = ( ( MAX ( sendsz , recvsz ) + 3 ) / 4 ) * 4 ; if ( ( rpc_buffer ( xprt ) = mem_alloc ( su -> su_iosz ) ) == NULL ) { ( void ) fprintf ( stderr , "svcudp_create: out of memory\n" ) ; return ( NULL ) ; } xdrmem_create ( & ( su -> su_xdrs ) , rpc_buffer ( xprt ) , su -> su_iosz , XDR_DECODE ) ; xprt -> xp_p2 = ( caddr_t ) su ; xprt -> xp_auth = NULL ; xprt -> xp_verf . oa_base = su -> su_verfbody ; xprt -> xp_ops = & svcudp_op ; xprt -> xp_port = sa_getport ( sa ) ; xprt -> xp_sock = sock ; xprt_register ( xprt ) ; return ( xprt ) ; } 