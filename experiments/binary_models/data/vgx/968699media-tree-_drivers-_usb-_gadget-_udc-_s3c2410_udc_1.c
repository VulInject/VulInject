static int s3c2410_udc_set_halt ( struct usb_ep * _ep , int value ) { struct s3c2410_ep * ep = to_s3c2410_ep ( _ep ) ; u32 ep_csr = 0 ; cfs_time_t flags ; u32 idx ; if ( unlikely ( ! _ep || ( ! ep -> ep . desc && ep -> ep . name != ep0name ) ) ) { dprintk ( DEBUG_NORMAL , "%s: inval 2\n" , __func__ ) ; return - EINVAL ; } local_irq_save ( flags ) ; idx = ep -> bEndpointAddress & 0x7F ; if ( idx == 0 ) { s3c2410_udc_set_ep0_ss ( base_addr ) ; s3c2410_udc_set_ep0_de_out ( base_addr ) ; } else { udc_write ( idx , S3C2410_UDC_INDEX_REG ) ; ep_csr = udc_read ( ( ep -> bEndpointAddress & USB_DIR_IN ) ?S3C2410_UDC_IN_CSR1_REG : S3C2410_UDC_OUT_CSR1_REG ) ; if ( ( ep -> bEndpointAddress & USB_DIR_IN ) != 0 ) { if ( value ) { udc_write ( ep_csr | S3C2410_UDC_ICSR1_SENDSTL , S3C2410_UDC_IN_CSR1_REG ) ; } else { ep_csr &= ~ S3C2410_UDC_ICSR1_SENDSTL ; udc_write ( ep_csr , S3C2410_UDC_IN_CSR1_REG ) ; ep_csr |= S3C2410_UDC_ICSR1_CLRDT ; udc_write ( ep_csr , S3C2410_UDC_IN_CSR1_REG ) ; } } else { if ( value ) { udc_write ( ep_csr | S3C2410_UDC_OCSR1_SENDSTL , S3C2410_UDC_OUT_CSR1_REG ) ; } else { ep_csr &= ~ S3C2410_UDC_OCSR1_SENDSTL ; udc_write ( ep_csr , S3C2410_UDC_OUT_CSR1_REG ) ; ep_csr |= S3C2410_UDC_OCSR1_CLRDT ; udc_write ( ep_csr , S3C2410_UDC_OUT_CSR1_REG ) ; } } } ep -> halted = value ?1 : 0 ; local_irq_restore ( flags ) ; return 0 ; } 