int usb_wwan_write ( struct tty_struct * tty , struct usb_serial_port * port , const unsigned char * buf , int count ) { struct usb_wwan_port_private * portdata ; struct usb_wwan_intf_private * intfdata ; int i ; int left , todo ; struct urb * this_urb = NULL ; int err ; unsigned long flags ; portdata = usb_get_serial_port_data ( port ) ; intfdata = usb_get_serial_data ( port -> serial , NULL ) ; dev_dbg ( & port -> dev , "%s: write (%d chars)\n" , __func__ , count ) ; left = count ; for ( i = 0 ; left > 0 && i < N_OUT_URB ; i ++ ) { todo = left ; if ( todo > OUT_BUFLEN ) { todo = OUT_BUFLEN ; } this_urb = portdata -> out_urbs [ i ] ; if ( test_and_set_bit ( i , & portdata -> out_busy ) ) { if ( time_before ( jiffies , portdata -> tx_start_time [ i ] + 10 * HZ ) ) { continue ; } usb_unlink_urb ( this_urb ) ; continue ; } dev_dbg ( & port -> dev , "%s: endpoint %d buf %d\n" , __func__ , usb_pipeendpoint ( this_urb -> pipe ) , i ) ; err = usb_autopm_get_interface_async ( port -> serial -> interface ) ; if ( err < 0 ) { clear_bit ( i , & portdata -> out_busy ) ; break ; } memcpy ( this_urb -> transfer_buffer , buf , todo ) ; this_urb -> transfer_buffer_length = todo ; spin_lock_irqsave ( & intfdata -> susp_lock , flags ) ; if ( intfdata -> suspended ) { usb_anchor_urb ( this_urb , & portdata -> delayed ) ; spin_unlock_irqrestore ( & intfdata -> susp_lock , flags ) ; } else { intfdata -> in_flight ++ ; spin_unlock_irqrestore ( & intfdata -> susp_lock , flags ) ; err = usb_submit_urb ( this_urb , GFP_ATOMIC ) ; if ( err ) { dev_err ( & port -> dev , "%s: submit urb %d failed: %d\n" , __func__ , i , err ) ; clear_bit ( i , & portdata -> out_busy ) ; spin_lock_irqsave ( & intfdata -> susp_lock , flags ) ; intfdata -> in_flight -- ; spin_unlock_irqrestore ( & intfdata -> susp_lock , flags ) ; usb_autopm_put_interface_async ( port -> serial -> interface ) ; break ; } } portdata -> tx_start_time [ i ] = jiffies ; buf += todo ; left -= todo ; } count -= left ; dev_dbg ( & port -> dev , "%s: wrote (did %d)\n" , __func__ , count ) ; return count ; } 