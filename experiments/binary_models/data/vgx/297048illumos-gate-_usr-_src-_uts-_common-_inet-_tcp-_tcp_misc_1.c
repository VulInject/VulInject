static int tcp_ioctl_abort ( tcp_ioc_abort_conn_t * acp , tcp_stack_t * tcps ) { sa_family_t af ; uint32_t ports ; uint16_t * pports ; int err = 0 , count = 0 ; boolean_t exact = B_FALSE ; int index = - 1 ; ushort_t logflags ; ip_stack_t * ipst = tcps -> tcps_netstack -> netstack_ip ; af = acp -> ac_local . ss_family ; if ( af == AF_INET ) { if ( TCP_AC_V4REMOTE ( acp ) != INADDR_ANY && TCP_AC_V4LPORT ( acp ) != 0 && TCP_AC_V4RPORT ( acp ) != 0 ) { pports = ( uint16_t * ) & ports ; pports [ 1 ] = TCP_AC_V4LPORT ( acp , NULL ) ; pports [ 0 ] = TCP_AC_V4RPORT ( acp ) ; exact = ( TCP_AC_V4LOCAL ( acp ) != INADDR_ANY ) ; } } else { if ( ! IN6_IS_ADDR_UNSPECIFIED ( & TCP_AC_V6REMOTE ( acp ) ) && TCP_AC_V6LPORT ( acp ) != 0 && TCP_AC_V6RPORT ( acp ) != 0 ) { pports = ( uint16_t * ) & ports ; pports [ 1 ] = TCP_AC_V6LPORT ( acp ) ; pports [ 0 ] = TCP_AC_V6RPORT ( acp ) ; exact = ! IN6_IS_ADDR_UNSPECIFIED ( & TCP_AC_V6LOCAL ( acp ) ) ; } } if ( index != - 1 ) { err = tcp_ioctl_abort_bucket ( acp , index , & count , exact , tcps ) ; } else { for ( index = 0 ; index < ipst -> ips_ipcl_conn_fanout_size ; index ++ ) { err = tcp_ioctl_abort_bucket ( acp , index , & count , exact , tcps ) ; if ( err != 0 ) { break ; } } } logflags = SL_TRACE | SL_NOTE ; if ( acp -> ac_zoneid == GLOBAL_ZONEID || acp -> ac_zoneid == ALL_ZONES ) { logflags |= SL_CONSOLE ; } ( void ) strlog ( TCP_MOD_ID , 0 , 1 , logflags , "TCP_IOC_ABORT_CONN: " "aborted %d connection%c\n" , count , ( ( count > 1 ) ?'s' : ' ' ) ) ; if ( err == 0 && count == 0 ) { err = ENOENT ; } return ( err ) ; } 