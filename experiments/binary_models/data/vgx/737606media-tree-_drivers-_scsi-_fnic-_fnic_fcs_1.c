void fnic_handle_frame ( struct work_struct * work ) { struct fnic * fnic = container_of ( work , fnic , frame_work ) ; struct fc_lport * lp = fnic -> lport ; unsigned long flags ; struct sk_buff * skb ; struct fc_frame * fp ; while ( ( skb = skb_dequeue ( & fnic -> frame_queue ) ) ) { spin_lock_irqsave ( & fnic -> fnic_lock , flags ) ; if ( fnic -> stop_rx_link_events ) { spin_unlock_irqrestore ( & fnic -> fnic_lock , flags ) ; return ; } fp = ( fc_frame * ) skb ; if ( fnic -> state != FNIC_IN_FC_MODE && fnic -> state != FNIC_IN_ETH_MODE ) { skb_queue_head ( & fnic -> frame_queue , skb ) ; spin_unlock_irqrestore ( & fnic -> fnic_lock , flags ) ; return ; } spin_unlock_irqrestore ( & fnic -> fnic_lock , flags ) ; fc_exch_recv ( lp , fp ) ; } } 