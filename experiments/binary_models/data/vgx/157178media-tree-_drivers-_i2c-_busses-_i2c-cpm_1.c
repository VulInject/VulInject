static int cpm_i2c_probe ( struct platform_device * ofdev ) { int result , len ; struct cpm_i2c * cpm ; const u32 * data ; cpm = kzalloc ( sizeof ( cpm_i2c ) , GFP_KERNEL ) ; if ( ! cpm ) { return - ENOMEM ; } cpm -> ofdev = ofdev ; platform_set_drvdata ( ofdev , cpm ) ; cpm -> adap = cpm_ops ; i2c_set_adapdata ( & cpm -> adap , cpm ) ; cpm -> adap . dev . parent = & ofdev -> dev ; cpm -> adap . dev . of_node = of_node_get ( ofdev -> dev . of_node ) ; result = cpm_i2c_setup ( cpm ) ; if ( result ) { dev_err ( & ofdev -> dev , "Unable to init hardware\n" ) ; out_free } data = of_get_property ( ofdev -> dev . of_node , "linux,i2c-index" , & len ) ; cpm -> adap . nr = ( data && len == 4 ) ?be32_to_cpup ( data ) : - 1 ; result = i2c_add_numbered_adapter ( & cpm -> adap ) ; if ( result < 0 ) { out_shut } dev_dbg ( & ofdev -> dev , "hw routines for %s registered.\n" , cpm -> adap . name ) ; return 0 ; out_shut cpm_i2c_shutdown ( cpm ) ; out_free return result ; } 