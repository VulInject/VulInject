R_API bool try_walkthrough_casetbl ( RAnal * anal , RAnalFunction * fcn , RAnalBlock * block , int depth , ut64 ip , st64 start_casenum_shift , ut64 jmptbl_loc , ut64 casetbl_loc , ut64 jmptbl_off , ut64 sz , ut64 jmptbl_size , ut64 default_case , bool ret0 ) { bool ret = ret0 ; if ( jmptbl_size == 0 ) { jmptbl_size = JMPTBL_MAXSZ ; } if ( jmptbl_loc == UT64_MAX ) { R_LOG_DEBUG ( "Invalid JumpTable location 0x%08" PFMT64x , jmptbl_loc ) ; return false ; } if ( casetbl_loc == UT64_MAX ) { R_LOG_DEBUG ( "Invalid CaseTable location 0x%08" PFMT64x , jmptbl_loc ) ; return false ; } if ( jmptbl_size ( 1 || jmptbl_size ) ST32_MAX ) { R_LOG_DEBUG ( "Invalid JumpTable size at 0x%08" PFMT64x , ip ) ; return false ; } ut64 jmpptr , case_idx , jmpptr_idx ; ut8 * jmptbl = calloc ( jmptbl_size , sz ) ; if ( ! jmptbl || ! anal -> iob . read_at ( anal -> iob . io , jmptbl_loc , jmptbl , jmptbl_size * sz ) ) { return false ; } ut8 * casetbl = calloc ( jmptbl_size , sizeof ( ut8 ) ) ; if ( ! casetbl || ! anal -> iob . read_at ( anal -> iob . io , casetbl_loc , casetbl , jmptbl_size ) ) { free ( jmptbl ) ; free ( casetbl ) ; return false ; } for ( case_idx = 0 ; case_idx < jmptbl_size ; case_idx ++ ) { jmpptr_idx = casetbl [ case_idx ] ; if ( jmpptr_idx >= jmptbl_size ) { ret = false ; break ; } switch ( sz ) { case 1 : jmpptr = r_read_le8 ( jmptbl + jmpptr_idx ) ; break ; case 2 : jmpptr = r_read_le16 ( jmptbl + jmpptr_idx * 2 ) ; break ; case 4 : jmpptr = r_read_le32 ( jmptbl + jmpptr_idx * 4 ) ; break ; default : jmpptr = r_read_le64 ( jmptbl + jmpptr_idx * 8 ) ; break ; } if ( jmpptr == 0 || jmpptr == UT32_MAX || jmpptr == UT64_MAX ) { break ; } if ( ! anal -> iob . is_valid_offset ( anal -> iob . io , jmpptr , 0 ) ) { st32 jmpdelta = ( st32 ) jmpptr ; jmpptr = jmptbl_off + jmpdelta ; if ( ! anal -> iob . is_valid_offset ( anal -> iob . io , jmpptr , 0 ) ) { break ; } } if ( anal -> limit ) { if ( jmpptr ( anal -> limit -> from || jmpptr ) anal -> limit -> to ) { break ; } } const ut64 jmpptr_idx_off = casetbl_loc + case_idx ; r_meta_set_data_at ( anal , jmpptr_idx_off , 1 ) ; r_anal_hint_set_immbase ( anal , jmpptr_idx_off , 10 ) ; int casenum = case_idx + start_casenum_shift ; apply_case ( anal , block , ip , sz , jmpptr , casenum , jmptbl_loc + jmpptr_idx * sz ) ; analyze_new_case ( anal , fcn , block , ip , jmpptr , depth ) ; } if ( case_idx > 0 ) { if ( default_case == 0 ) { default_case = UT64_MAX ; } apply_switch ( anal , ip , jmptbl_loc , case_idx , default_case ) ; } free ( jmptbl ) ; free ( casetbl ) ; return ret ; } 