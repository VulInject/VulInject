void vmw_du_cursor_plane_cleanup_fb ( struct drm_plane * plane , struct drm_plane_state * old_state ) { struct vmw_cursor_plane * vcp = vmw_plane_to_vcp ( plane ) ; struct vmw_plane_state * vps = vmw_plane_state_to_vps ( old_state ) ; bool dummy ; if ( vps -> surf_mapped ) { vmw_bo_unmap ( vps -> surf -> res . backup ) ; vps -> surf_mapped = false ; } if ( vps -> bo && ttm_kmap_obj_virtual ( & vps -> bo -> map , & dummy ) ) { const int ret = ttm_bo_reserve ( & vps -> bo -> base , true , false , NULL ) ; if ( likely ( ret == 0 ) ) { if ( atomic_read ( & vps -> bo -> base_mapped_count ) == 0 ) { ttm_bo_kunmap ( & vps -> bo -> map ) ; } ttm_bo_unreserve ( & vps -> bo -> base ) ; } } vmw_du_cursor_plane_unmap_cm ( vps ) ; vmw_du_put_cursor_mob ( vcp , vps ) ; vmw_du_plane_unpin_surf ( vps , false ) ; if ( vps -> surf ) { vmw_surface_unreference ( & vps -> surf ) ; vps -> surf = NULL ; } if ( vps -> bo ) { vmw_bo_unreference ( & vps -> bo ) ; } } 