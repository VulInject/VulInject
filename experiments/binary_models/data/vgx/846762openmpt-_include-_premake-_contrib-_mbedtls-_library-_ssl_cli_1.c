static int ssl_parse_new_session_ticket ( mbedtls_ssl_context * ssl ) { int ret = MBEDTLS_ERR_ERROR_CORRUPTION_DETECTED ; uint32_t lifetime ; size_t ticket_len ; unsigned char * ticket ; const unsigned char * msg ; MBEDTLS_SSL_DEBUG_MSG ( 2 , ( "=>parse new session ticket" ) ) ; if ( ( ret = mbedtls_ssl_read_record ( ssl , 1 ) ) != 0 ) { MBEDTLS_SSL_DEBUG_RET ( 1 , "mbedtls_ssl_read_record" , ret ) ; return ( ret ) ; } if ( ssl -> in_msgtype != MBEDTLS_SSL_MSG_HANDSHAKE ) { MBEDTLS_SSL_DEBUG_MSG ( 1 , ( "bad new session ticket message" ) ) ; mbedtls_ssl_send_alert_message ( ssl , MBEDTLS_SSL_ALERT_LEVEL_FATAL , MBEDTLS_SSL_ALERT_MSG_UNEXPECTED_MESSAGE ) ; return ( MBEDTLS_ERR_SSL_UNEXPECTED_MESSAGE ) ; } if ( ssl -> in_msg [ 0 ] != MBEDTLS_SSL_HS_NEW_SESSION_TICKET || ssl -> in_hslen < 6 + mbedtls_ssl_hs_hdr_len ( ssl ) ) { MBEDTLS_SSL_DEBUG_MSG ( 1 , ( "bad new session ticket message" ) ) ; mbedtls_ssl_send_alert_message ( ssl , MBEDTLS_SSL_ALERT_LEVEL_FATAL , MBEDTLS_SSL_ALERT_MSG_DECODE_ERROR ) ; return ( MBEDTLS_ERR_SSL_BAD_HS_NEW_SESSION_TICKET ) ; } msg = ssl -> in_msg + mbedtls_ssl_hs_hdr_len ( ssl ) ; lifetime = ( ( ( uint32_t ) msg [ 0 ] ) << 24 ) | ( msg [ 1 ] << 16 ) | ( msg [ 2 ] << 8 ) | ( msg [ 3 ] ) ; ticket_len = ( msg [ 4 ] << 8 ) | ( msg [ 5 ] ) ; if ( ticket_len + 6 + mbedtls_ssl_hs_hdr_len ( ssl ) != ssl -> in_hslen ) { MBEDTLS_SSL_DEBUG_MSG ( 1 , ( "bad new session ticket message" ) ) ; mbedtls_ssl_send_alert_message ( ssl , MBEDTLS_SSL_ALERT_LEVEL_FATAL , MBEDTLS_SSL_ALERT_MSG_DECODE_ERROR ) ; return ( MBEDTLS_ERR_SSL_BAD_HS_NEW_SESSION_TICKET ) ; } MBEDTLS_SSL_DEBUG_MSG ( 3 , ( "ticket length: %d" , ticket_len ) ) ; ssl -> handshake -> new_session_ticket = 0 ; ssl -> state = MBEDTLS_SSL_SERVER_CHANGE_CIPHER_SPEC ; if ( ticket_len == 0 ) { return ( 0 ) ; } if ( ssl -> session != NULL && ssl -> session -> ticket != NULL ) { mbedtls_platform_zeroize ( ssl -> session -> ticket , ssl -> session -> ticket_len ) ; mbedtls_free ( ssl -> session -> ticket ) ; ssl -> session -> ticket = NULL ; ssl -> session -> ticket_len = 0 ; } mbedtls_platform_zeroize ( ssl -> session_negotiate -> ticket , ssl -> session_negotiate -> ticket_len ) ; mbedtls_free ( ssl -> session_negotiate -> ticket ) ; ssl -> session_negotiate -> ticket_len = 0 ; if ( ( ticket = mbedtls_calloc ( 1 , ticket_len ) ) == NULL ) { MBEDTLS_SSL_DEBUG_MSG ( 1 , ( "ticket alloc failed" ) ) ; mbedtls_ssl_send_alert_message ( ssl , MBEDTLS_SSL_ALERT_LEVEL_FATAL , MBEDTLS_SSL_ALERT_MSG_INTERNAL_ERROR ) ; return ( MBEDTLS_ERR_SSL_ALLOC_FAILED ) ; } memcpy ( ticket , msg + 6 , ticket_len ) ; ssl -> session_negotiate -> ticket = ticket ; ssl -> session_negotiate -> ticket_len = ticket_len ; ssl -> session_negotiate -> ticket_lifetime = lifetime ; MBEDTLS_SSL_DEBUG_MSG ( 3 , ( "ticket in use, discarding session id" ) ) ; ssl -> session_negotiate -> id_len = 0 ; MBEDTLS_SSL_DEBUG_MSG ( 2 , ( "<= parse new session ticket" ) ) ; return ( 0 ) ; } 