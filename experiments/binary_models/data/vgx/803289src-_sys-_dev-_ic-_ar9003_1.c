int ar9003_calib_tx_iq ( struct athn_softc * sc ) { uint32_t reg ; int32_t res [ 6 ] , coeff [ 2 ] ; int i , j , ntries ; reg = AR_READ ( sc , AR_PHY_TX_IQCAL_CONTROL_1 ) ; reg = RW ( reg , AR_PHY_TX_IQCAQL_CONTROL_1_IQCORR_I_Q_COFF_DELPT , DELPT ) ; AR_WRITE ( sc , AR_PHY_TX_IQCAL_CONTROL_1 , reg ) ; AR_SETBITS ( sc , AR_PHY_TX_IQCAL_START , AR_PHY_TX_IQCAL_START_DO_CAL ) ; for ( ntries = 0 ; ntries < 10000 ; ntries ++ ) { reg = AR_READ ( sc , AR_PHY_TX_IQCAL_START ) ; if ( ! ( reg & AR_PHY_TX_IQCAL_START_DO_CAL ) ) { break ; } DELAY ( 10 ) ; } if ( ntries == 10000 ) { return ( ETIMEDOUT ) ; } for ( i = 0 ; i < sc -> ntxchains ; i ++ ) { reg = AR_READ ( sc , AR_PHY_TX_IQCAL_STATUS_B ( i ) ) ; if ( reg & AR_PHY_TX_IQCAL_STATUS_FAILED ) { return ( EIO ) ; } for ( j = 0 ; j < 3 ; j ++ ) { AR_CLRBITS ( sc , AR_PHY_CHAN_INFO_MEMORY , AR_PHY_CHAN_INFO_TAB_S2_READ ) ; reg = AR_READ ( sc , AR_PHY_CHAN_INFO_TAB ( i , j ) ) ; res [ j * 2 + 0 ] = reg ; AR_SETBITS ( sc , AR_PHY_CHAN_INFO_MEMORY , AR_PHY_CHAN_INFO_TAB_S2_READ ) ; reg = AR_READ ( sc , AR_PHY_CHAN_INFO_TAB ( i , j ) ) ; res [ j * 2 + 1 ] = reg & 0xffff ; } if ( ar9003_get_iq_corr ( sc , res , coeff ) != 0 ) { return ( EIO ) ; } reg = AR_READ ( sc , AR_PHY_TX_IQCAL_CORR_COEFF_01_B ( i ) ) ; reg = RW ( reg , AR_PHY_TX_IQCAL_CORR_COEFF_01_COEFF_TABLE , coeff [ 0 ] ) ; AR_WRITE ( sc , AR_PHY_TX_IQCAL_CORR_COEFF_01_B ( i ) , reg ) ; reg = AR_READ ( sc , AR_PHY_RX_IQCAL_CORR_B ( i ) ) ; reg = RW ( reg , AR_PHY_RX_IQCAL_CORR_LOOPBACK_IQCORR_Q_Q_COFF , coeff [ 1 ] >> 7 ) ; reg = RW ( reg , AR_PHY_RX_IQCAL_CORR_LOOPBACK_IQCORR_Q_I_COFF , coeff [ 1 ] ) ; AR_WRITE ( sc , AR_PHY_RX_IQCAL_CORR_B ( i ) , reg ) ; AR_WRITE_BARRIER ( sc , NULL ) ; } AR_SETBITS ( sc , AR_PHY_TX_IQCAL_CONTROL_3 , AR_PHY_TX_IQCAL_CONTROL_3_IQCORR_EN ) ; AR_SETBITS ( sc , AR_PHY_RX_IQCAL_CORR_B ( 0 ) , AR_PHY_RX_IQCAL_CORR_B0_LOOPBACK_IQCORR_EN ) ; AR_WRITE_BARRIER ( sc ) ; return ( 0 ) ; } 