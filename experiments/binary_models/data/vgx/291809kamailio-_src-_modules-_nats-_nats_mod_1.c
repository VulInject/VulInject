static int mod_init ( void ) { int i = 0 ; int total_procs = _nats_proc_count + nats_pub_workers_num ; if ( faked_msg_init ( ) < 0 ) { LM_ERR ( "failed to init faked sip message\n" ) ; return - 1 ; } register_procs ( total_procs ) ; nats_pub_worker_pipes_fds = ( int * ) shm_malloc ( sizeof ( int ) * ( nats_pub_workers_num ) * 2 ) ; nats_pub_worker_pipes = ( int * ) shm_malloc ( sizeof ( int ) * nats_pub_workers_num ) ; for ( i = 0 ; i < nats_pub_workers_num ; i ++ ) { nats_pub_worker_pipes_fds [ i * 2 ] = nats_pub_worker_pipes_fds [ i * 2 + 1 ] = - 1 ; if ( pipe ( & nats_pub_worker_pipes_fds [ i * 2 ] ) < 0 ) { LM_ERR ( "worker pipe(%d) failed\n" , i ) ; return - 1 ; } } for ( i = 0 ; i < nats_pub_workers_num ; i ++ ) { nats_pub_worker_pipes [ i ] = nats_pub_worker_pipes_fds [ i * 2 + 1 ] ; } nats_workers = shm_malloc ( _nats_proc_count * sizeof ( nats_consumer_worker_t ) ) ; if ( nats_workers == NULL ) { LM_ERR ( "error in shm_malloc\n" ) ; return - 1 ; } nats_pub_workers = shm_malloc ( nats_pub_workers_num * sizeof ( nats_pub_worker_t ) ) ; if ( nats_pub_workers == NULL ) { LM_ERR ( "error in shm_malloc\n" ) ; return - 1 ; } memset ( nats_pub_workers , 0 , nats_pub_workers_num * sizeof ( nats_pub_worker_t ) ) ; return 0 ; } 