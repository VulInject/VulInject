static int rzg2l_pinctrl_probe ( struct platform_device * pdev ) { struct rzg2l_pinctrl * pctrl ; int ret ; BUILD_BUG_ON ( ARRAY_SIZE ( rzg2l_gpio_configs ) * RZG2L_PINS_PER_PORT > ARRAY_SIZE ( rzg2l_gpio_names ) ) ; BUILD_BUG_ON ( ARRAY_SIZE ( r9a07g043_gpio_configs ) * RZG2L_PINS_PER_PORT > ARRAY_SIZE ( rzg2l_gpio_names ) ) ; pctrl = devm_kzalloc ( & pdev -> dev , sizeof ( * pctrl ) , GFP_KERNEL ) ; pctrl -> dev = & pdev -> dev ; pctrl -> data = of_device_get_match_data ( & pdev -> dev ) ; if ( ! pctrl -> data ) { return - EINVAL ; } pctrl -> base = devm_platform_ioremap_resource ( pdev , 0 ) ; if ( IS_ERR ( pctrl -> base ) ) { return PTR_ERR ( pctrl -> base ) ; } pctrl -> clk = devm_clk_get ( pctrl -> dev , NULL ) ; if ( IS_ERR ( pctrl -> clk ) ) { ret = PTR_ERR ( pctrl -> clk ) ; dev_err ( pctrl -> dev , "failed to get GPIO clk : %i\n" , ret ) ; return ret ; } spin_lock_init ( & pctrl -> lock ) ; spin_lock_init ( & pctrl -> bitmap_lock ) ; platform_set_drvdata ( pdev , pctrl ) ; ret = clk_prepare_enable ( pctrl -> clk ) ; if ( ret ) { dev_err ( pctrl -> dev , "failed to enable GPIO clk: %i\n" , ret ) ; return ret ; } ret = devm_add_action_or_reset ( & pdev -> dev , rzg2l_pinctrl_clk_disable , pctrl -> clk ) ; if ( ret ) { dev_err ( pctrl -> dev , "failed to register GPIO clk disable action, %i\n" , ret ) ; return ret ; } ret = rzg2l_pinctrl_register ( pctrl ) ; if ( ret ) { return ret ; } dev_info ( pctrl -> dev , "%s support registered\n" , DRV_NAME ) ; return 0 ; } 