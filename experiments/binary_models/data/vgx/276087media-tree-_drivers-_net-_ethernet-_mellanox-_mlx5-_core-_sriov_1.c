static void mlx5_device_disable_sriov ( struct mlx5_core_dev * dev ) { struct mlx5_core_sriov * sriov = & dev -> priv . sriov ; int err ; int vf ; for ( vf = 0 ; vf < sriov -> num_vfs ; vf ++ ) { if ( ! sriov -> vfs_ctx [ vf ] . enabled ) { continue ; } err = mlx5_core_disable_hca ( dev , vf + 1 ) ; if ( err ) { mlx5_core_warn ( dev , "failed to disable VF %d\n" , vf ) ; continue ; } sriov -> vfs_ctx [ vf ] . enabled = 0 ; sriov -> enabled_vfs -- ; } mlx5_eswitch_disable_sriov ( dev -> priv . eswitch ) ; if ( mlx5_wait_for_vf_pages ( dev ) ) { mlx5_core_warn ( dev , "timeout reclaiming VFs pages\n" ) ; } } 