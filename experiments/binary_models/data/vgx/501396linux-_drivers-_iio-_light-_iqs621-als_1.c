static int iqs621_als_probe ( struct platform_device * pdev ) { struct iqs62x_core * iqs62x = dev_get_drvdata ( pdev -> dev . parent ) ; struct iqs621_als_private * iqs621_als ; struct iio_dev * indio_dev ; unsigned int val ; int ret ; indio_dev = devm_iio_device_alloc ( & pdev -> dev , sizeof ( * iqs621_als ) ) ; iqs621_als = iio_priv ( indio_dev ) ; iqs621_als -> iqs62x = iqs62x ; iqs621_als -> indio_dev = indio_dev ; if ( iqs62x -> dev_desc -> prod_num == IQS622_PROD_NUM ) { ret = regmap_read ( iqs62x -> regmap , IQS622_IR_THRESH_TOUCH , & val ) ; if ( ret ) { return ret ; } iqs621_als -> thresh_prox = val ; iqs621_als -> ir_flags_mask = IQS622_IR_FLAGS_TOUCH ; indio_dev -> channels = iqs622_als_channels ; indio_dev -> num_channels = ARRAY_SIZE ( iqs622_als_channels ) ; } else { ret = regmap_read ( iqs62x -> regmap , IQS621_ALS_THRESH_LIGHT , & val ) ; if ( ret ) { return ret ; } iqs621_als -> thresh_light = val ; ret = regmap_read ( iqs62x -> regmap , IQS621_ALS_THRESH_DARK , & val ) ; if ( ret ) { return ret ; } iqs621_als -> thresh_dark = val ; indio_dev -> channels = iqs621_als_channels ; indio_dev -> num_channels = ARRAY_SIZE ( iqs621_als_channels ) ; } indio_dev -> modes = INDIO_DIRECT_MODE ; indio_dev -> name = iqs62x -> dev_desc -> dev_name ; indio_dev -> info = & iqs621_als_info ; mutex_init ( & iqs621_als -> lock ) ; iqs621_als -> notifier . notifier_call = iqs621_als_notifier ; ret = blocking_notifier_chain_register ( & iqs621_als -> iqs62x -> nh , & iqs621_als -> notifier ) ; if ( ret ) { dev_err ( & pdev -> dev , "Failed to register notifier: %d\n" , ret ) ; return ret ; } ret = devm_add_action_or_reset ( & pdev -> dev , iqs621_als_notifier_unregister , iqs621_als ) ; if ( ret ) { return ret ; } return devm_iio_device_register ( & pdev -> dev , indio_dev ) ; } 