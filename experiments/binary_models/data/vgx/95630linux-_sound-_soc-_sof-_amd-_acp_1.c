int amd_sof_acp_probe ( struct snd_sof_dev * sdev ) { struct pci_dev * pci = to_pci_dev ( sdev -> dev ) ; struct acp_dev_data * adata ; const struct sof_amd_acp_desc * chip ; unsigned int addr ; int ret ; adata = devm_kzalloc ( sdev -> dev , sizeof ( acp_dev_data ) , GFP_KERNEL ) ; adata -> dev = sdev ; addr = pci_resource_start ( pci , ACP_DSP_BAR ) ; sdev -> bar [ ACP_DSP_BAR ] = devm_ioremap ( sdev -> dev , addr , pci_resource_len ( pci , ACP_DSP_BAR ) ) ; if ( ! sdev -> bar [ ACP_DSP_BAR ] ) { dev_err ( sdev -> dev , "ioremap error\n" ) ; return - ENXIO ; } pci_set_master ( pci ) ; sdev -> pdata -> hw_pdata = adata ; chip = get_chip_info ( sdev -> pdata ) ; if ( ! chip ) { dev_err ( sdev -> dev , "no such device supported, chip id:%x\n" , pci -> device ) ; return - EIO ; } adata -> smn_dev = pci_get_device ( PCI_VENDOR_ID_AMD , chip -> host_bridge_id , NULL ) ; if ( ! adata -> smn_dev ) { dev_err ( sdev -> dev , "Failed to get host bridge device\n" ) ; return - ENODEV ; } sdev -> ipc_irq = pci -> irq ; ret = request_threaded_irq ( sdev -> ipc_irq , acp_irq_handler , acp_irq_thread , IRQF_SHARED , "AudioDSP" , sdev ) ; if ( ret < 0 ) { dev_err ( sdev -> dev , "failed to register IRQ %d\n" , sdev -> ipc_irq ) ; pci_dev_put ( adata -> smn_dev ) ; return ret ; } ret = acp_init ( sdev ) ; if ( ret < 0 ) { free_irq ( sdev -> ipc_irq , sdev ) ; pci_dev_put ( adata -> smn_dev ) ; return ret ; } sdev -> dsp_box . offset = 0 ; sdev -> dsp_box . size = BOX_SIZE_512 ; sdev -> host_box . offset = sdev -> dsp_box . offset + sdev -> dsp_box . size ; sdev -> host_box . size = BOX_SIZE_512 ; sdev -> debug_box . offset = sdev -> host_box . offset + sdev -> host_box . size ; sdev -> debug_box . size = BOX_SIZE_1024 ; acp_memory_init ( sdev ) ; acp_dsp_stream_init ( sdev ) ; return 0 ; } 