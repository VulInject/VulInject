static void __init prom_initialize_tce_table ( void ) { phandle node ; ihandle phb_node ; char compatible [ 64 ] , type [ 64 ] , model [ 64 ] ; char * path = prom_scratch ; u64 base , align ; u32 minalign , minsize ; u64 tce_entry , * tce_entryp ; u64 local_alloc_top , local_alloc_bottom ; u64 i ; if ( prom_iommu_off ) { return ; } prom_debug ( "starting prom_initialize_tce_table\n" ) ; local_alloc_top = alloc_top_high ; local_alloc_bottom = local_alloc_top ; for ( node = 0 ; prom_next_node ( & node ) ; ) { compatible [ 0 ] = 0 ; type [ 0 ] = 0 ; model [ 0 ] = 0 ; prom_getprop ( node , "compatible" , compatible , sizeof ( compatible ) ) ; prom_getprop ( node , "device_type" , type , sizeof ( type ) ) ; prom_getprop ( node , "model" , model , sizeof ( model ) ) ; if ( ( type [ 0 ] == 0 ) || ( strstr ( type , "pci" ) == NULL ) ) { continue ; } if ( compatible [ 0 ] != 0 ) { if ( ( strstr ( compatible , "python" ) == NULL ) && ( strstr ( compatible , "Speedwagon" ) == NULL ) && ( strstr ( compatible , "Winnipeg" ) == NULL ) ) { continue ; } } if ( model [ 0 ] != 0 ) { if ( ( strstr ( model , "ython" ) == NULL ) && ( strstr ( model , "peedwagon" ) == NULL ) && ( strstr ( model , "innipeg" ) == NULL ) ) { continue ; } } if ( prom_getprop ( node , "tce-table-minalign" , & minalign , sizeof ( minalign ) ) == PROM_ERROR ) { minalign = 0 ; } if ( prom_getprop ( node , "tce-table-minsize" , & minsize , sizeof ( minsize ) ) == PROM_ERROR ) { minsize = 4UL << 20 ; } if ( pvr_version_is ( PVR_POWER4 ) || pvr_version_is ( PVR_POWER4p ) ) { minsize = 8UL << 20 ; } else { minsize = 4UL << 20 ; } align = max ( minalign , minsize ) ; base = alloc_down ( minsize , align , 1 ) ; if ( base == 0 ) { prom_panic ( "ERROR, cannot find space for TCE table.\n" ) ; } if ( base < local_alloc_bottom ) { local_alloc_bottom = base ; } if ( call_prom ( "package-to-path" , 3 , 1 , node , path , PROM_SCRATCH_SIZE - 1 ) == PROM_ERROR ) { prom_printf ( "package-to-path failed\n" ) ; } prom_setprop ( node , path , "linux,tce-base" , & base , sizeof ( base ) ) ; prom_setprop ( node , path , "linux,tce-size" , & minsize , sizeof ( minsize ) ) ; prom_debug ( "TCE table: %s\n" , path ) ; prom_debug ( "\tnode = 0x%x\n" , node ) ; prom_debug ( "\tbase = 0x%x\n" , base ) ; prom_debug ( "\tsize = 0x%x\n" , minsize ) ; tce_entryp = ( u64 * ) base ; for ( i = 0 ; i < ( minsize >> 3 ) ; tce_entryp ++ , i ++ ) { tce_entry = ( i << PAGE_SHIFT ) ; tce_entry |= 0x3 ; * tce_entryp = tce_entry ; } prom_printf ( "opening PHB %s" , path ) ; phb_node = call_prom ( "open" , 1 , 1 , path ) ; if ( phb_node == 0 ) { prom_printf ( "... failed\n" ) ; } else { prom_printf ( "... done\n" ) ; } call_prom ( "call-method" , 6 , 0 , ADDR ( "set-64-bit-addressing" ) , phb_node , - 1 , minsize , ( u32 ) base , ( u32 ) ( base >> 32 ) ) ; call_prom ( "close" , 1 , 0 , phb_node ) ; } reserve_mem ( local_alloc_bottom , local_alloc_top - local_alloc_bottom ) ; prom_tce_alloc_start = local_alloc_bottom ; prom_tce_alloc_end = local_alloc_top ; prom_debug ( "ending prom_initialize_tce_table\n" ) ; } 