static int fzap_lookup ( const spa_t * spa , const dnode_phys_t * dnode , zap_phys_t * zh , const char * name , uint64_t integer_size , uint64_t num_integers , void * value ) { int bsize = dnode -> dn_datablkszsec << SPA_MINBLOCKSHIFT ; fat_zap_t z ; zap_leaf_t * zl ; uint64_t hash ; int rc ; if ( zh -> zap_magic != ZAP_MAGIC ) { return ( EIO ) ; } if ( ( rc = fzap_check_size ( integer_size , num_integers ) ) != 0 ) { return ( rc ) ; } z . zap_block_shift = ilog2 ( bsize ) ; z . zap_phys = zh ; z . zap_spa = spa ; z . zap_dnode = dnode ; hash = zap_hash ( zh -> zap_salt , name ) ; rc = zap_deref_leaf ( & z , hash , & zl ) ; rc = zap_leaf_lookup ( zl , hash , name , integer_size , num_integers , value ) ; zap_leaf_free ( zl ) ; return ( rc ) ; } 