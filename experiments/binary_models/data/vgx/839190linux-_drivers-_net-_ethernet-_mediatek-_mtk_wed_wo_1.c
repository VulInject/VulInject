static void * mtk_wed_wo_dequeue ( struct mtk_wed_wo * wo , struct mtk_wed_wo_queue * q , u32 * len , bool flush ) { int buf_len = SKB_WITH_OVERHEAD ( q -> buf_size ) ; int index = ( q -> tail + 1 ) % q -> n_desc ; struct mtk_wed_wo_queue_entry * entry ; struct mtk_wed_wo_queue_desc * desc ; void * buf ; if ( ! q -> queued ) { return in ; } if ( flush ) { q -> desc [ index ] . ctrl |= cpu_to_le32 ( MTK_WED_WO_CTL_DMA_DONE ) ; } if ( ! ( q -> desc [ index ] . ctrl & cpu_to_le32 ( MTK_WED_WO_CTL_DMA_DONE ) ) ) { return NULL ; } q -> tail = index ; q -> queued -- ; desc = & q -> desc [ index ] ; entry = & q -> entry [ index ] ; buf = entry -> buf ; if ( len ) { * len = FIELD_GET ( MTK_WED_WO_CTL_SD_LEN0 , le32_to_cpu ( READ_ONCE ( desc -> ctrl ) ) ) ; } if ( buf ) { dma_unmap_single ( wo -> hw -> dev , entry -> addr , buf_len , DMA_FROM_DEVICE ) ; } entry -> buf = NULL ; return buf ; } 