static int sd_nfnl_message_new_masq_rule ( sd_netlink * nfnl , sd_netlink_message * * ret , int family , const char * chain ) { _cleanup_ ( ) sd_netlink_message * m = NULL ; int r ; assert ( nfnl ) ; assert ( ret ) ; assert ( IN_SET ( family , AF_INET , AF_INET6 ) ) ; assert ( chain ) ; r = sd_nfnl_nft_message_new_rule ( nfnl , & m , family , NFT_SYSTEMD_TABLE_NAME , chain ) ; r = sd_netlink_message_open_container ( m , NFTA_RULE_EXPRESSIONS ) ; if ( r < 0 ) { return r ; } if ( family == AF_INET ) { r = nfnl_add_expr_payload ( m , NFT_PAYLOAD_NETWORK_HEADER , offsetof ( iphdr , saddr ) , sizeof ( uint32_t ) , NFT_REG32_01 ) ; } else { r = nfnl_add_expr_payload ( m , NFT_PAYLOAD_NETWORK_HEADER , offsetof ( ip6_hdr , ip6_src . s6_addr ) , sizeof ( in6_addr ) , NFT_REG32_01 ) ; } if ( r < 0 ) { return r ; } r = nfnl_add_expr_lookup ( m , NFT_SYSTEMD_MASQ_SET_NAME , NFT_REG32_01 , 0 ) ; if ( r < 0 ) { return r ; } r = nfnl_add_expr_masq ( m ) ; if ( r < 0 ) { return r ; } r = sd_netlink_message_close_container ( m ) ; if ( r < 0 ) { return r ; } * ret = TAKE_PTR ( m ) ; return 0 ; } 