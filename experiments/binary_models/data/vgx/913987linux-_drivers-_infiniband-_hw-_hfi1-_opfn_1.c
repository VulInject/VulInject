void opfn_conn_error ( struct rvt_qp * qp ) { struct hfi1_qp_priv * priv = qp -> priv ; struct hfi1_opfn_type * extd = NULL ; cfs_time_t flags ; u16 capcode ; trace_hfi1_opfn_state_conn_error ( qp ) ; trace_hfi1_msg_opfn_conn_error ( qp , "error. qp state " , ( u64 ) qp -> state ) ; spin_lock_irqsave ( & priv -> opfn . lock , flags ) ; while ( priv -> opfn . completed ) { capcode = priv -> opfn . completed & ~ ( priv -> opfn . completed - 1 ) ; extd = & hfi1_opfn_handlers [ ilog2 ( capcode ) + 1 ] ; if ( extd -> error ) { extd -> error ( qp ) ; } priv -> opfn . completed &= ~ OPFN_CODE ( capcode ) ; } priv -> opfn . extended = 0 ; priv -> opfn . requested = 0 ; priv -> opfn . curr = STL_VERBS_EXTD_NONE ; spin_unlock_irqrestore ( & priv -> opfn . lock , flags ) ; } 