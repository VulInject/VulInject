static int diolan_init ( struct i2c_diolan_u2c * dev ) { int speed , ret ; if ( frequency >= 200000 ) { speed = U2C_I2C_SPEED_FAST ; frequency = U2C_I2C_FREQ_FAST ; } if ( frequency >= 100000 || frequency == 0 ) { speed = U2C_I2C_SPEED_STD ; frequency = U2C_I2C_FREQ_STD ; } else { speed = U2C_I2C_SPEED ( frequency ) ; if ( speed > U2C_I2C_SPEED_2KHZ ) { speed = U2C_I2C_SPEED_2KHZ ; } frequency = U2C_I2C_FREQ ( speed ) ; } dev_info ( & dev -> interface -> dev , "Diolan U2C at USB bus %03d address %03d speed %d Hz\n" , dev -> usb_dev -> bus -> busnum , dev -> usb_dev -> devnum , frequency ) ; diolan_flush_input ( dev ) ; diolan_fw_version ( dev ) ; diolan_get_serial ( dev ) ; ret = diolan_set_speed ( dev , speed ) ; ret = diolan_set_clock_synch ( dev , speed != U2C_I2C_SPEED_FAST ) ; if ( ret < 0 ) { return ret ; } if ( speed != U2C_I2C_SPEED_FAST ) { ret = diolan_set_clock_synch_timeout ( dev , DIOLAN_SYNC_TIMEOUT ) ; } return ret ; } 