static int m10v_clk_divider_set_rate ( struct clk_hw * hw , unsigned long rate , unsigned long parent_rate ) { struct m10v_clk_divider * divider = to_m10v_div ( hw ) ; int value ; unsigned long flags = 0 ; u32 val ; u32 write_en = BIT ( divider -> width - 1 ) ; value = divider_get_val ( rate , parent_rate , divider -> table , divider -> width , divider -> flags ) ; if ( divider -> lock ) { spin_lock_irqsave ( divider -> lock , flags ) ; } else { __acquire ( divider -> lock ) ; } val = readl ( divider -> reg ) ; val &= ~ ( clk_div_mask ( divider -> width ) << divider -> shift ) ; val |= ( ( u32 ) value | write_en ) << divider -> shift ; writel ( val , divider -> reg ) ; if ( divider -> write_valid_reg ) { writel ( M10V_DCHREQ , divider -> write_valid_reg ) ; if ( readl_poll_timeout ( divider -> write_valid_reg , val , ! val , M10V_UPOLL_RATE , M10V_UTIMEOUT ) ) { pr_err ( "%s:%s couldn't stabilize\n" , __func__ , clk_hw_get_name ( hw ) ) ; } } if ( divider -> lock ) { spin_unlock_irqrestore ( divider -> lock , flags ) ; } else { __release ( divider -> lock ) ; } return 0 ; } 