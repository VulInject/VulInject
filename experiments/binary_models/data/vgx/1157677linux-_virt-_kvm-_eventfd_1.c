static int kvm_irqfd_deassign ( struct kvm * kvm , struct kvm_irqfd * args ) { struct kvm_kernel_irqfd * irqfd , * tmp ; struct eventfd_ctx * eventfd ; eventfd = eventfd_ctx_fdget ( args -> fd ) ; if ( IS_ERR ( eventfd ) ) { return PTR_ERR ( eventfd ) ; } spin_lock_irq ( & kvm -> irqfds . lock ) ; list_for_each_entry_safe ( , , , ) { if ( irqfd -> eventfd == eventfd && irqfd -> gsi == args -> gsi ) { write_seqcount_begin ( & irqfd -> irq_entry_sc ) ; irqfd -> irq_entry . type = 0 ; write_seqcount_end ( & irqfd -> irq_entry_sc ) ; irqfd_deactivate ( irqfd ) ; } } spin_unlock_irq ( & kvm -> irqfds . lock ) ; eventfd_ctx_put ( eventfd ) ; flush_workqueue ( irqfd_cleanup_wq , NULL ) ; return 0 ; } 