int lvm_clonepaths ( lxc_storage * orig , lxc_storage * new , const char * oldname , const char * cname , const char * oldpath , const char * lxcpath , int snap , uint64_t newsize , lxc_conf * conf ) ( int len , ret , const char * vg , ( ! orig -> src || ! orig -> dest ) return - 1 ; ) ; if ( strcmp ( orig -> type , "lvm" ) && snap ) { ERROR ( "LVM snapshot from \"%s\" storage driver is not supported" , orig -> type ) ; return - 1 ; } if ( strcmp ( orig -> type , "lvm" ) ) { vg = lxc_global_config_value ( "lxc.bdev.lvm.vg" ) ; new -> src = lxc_string_join ( "/" , ( const char * [ ] ) { "lvm:" "dev" vg cname NULL } , false ) ; } else { const char * src ; char * dup , * slider ; src = lxc_storage_get_path ( orig -> src , orig -> type ) ; dup = strdup ( src ) ; if ( ! dup ) { ERROR ( "Failed to duplicate string \"%s\"" , src ) ; return - 1 ; } slider = strrchr ( dup , '/' ) ; if ( ! slider ) { ERROR ( "Failed to detect \"/\" in string \"%s\"" , dup ) ; return - 1 ; } * slider = '\0' ; slider = dup ; new -> src = lxc_string_join ( "/" , ( const char * [ ] ) { "lvm:" * slider == '/' ?++ slider : slider cname NULL } , false ) ; free ( dup ) ; } if ( ! new -> src ) { ERROR ( "Failed to create string" ) ; return - 1 ; } if ( orig -> mntopts ) { new -> mntopts = strdup ( orig -> mntopts ) ; if ( ! new -> mntopts ) { ERROR ( "Failed to duplicate string \"%s\"" , orig -> mntopts ) ; return - 1 ; } } len = strlen ( lxcpath ) + strlen ( cname ) + strlen ( "rootfs" ) + 3 ; new -> dest = malloc ( len ) ; if ( ! new -> dest ) { ERROR ( "Failed to allocate memory" ) ; return - 1 ; } ret = snprintf ( new -> dest , len , "%s/%s/rootfs" , lxcpath , cname ) ; if ( ret < 0 || ret >= len ) { ERROR ( "Failed to create string" ) ; return - 1 ; } ret = mkdir_p ( new -> dest , 0755 ) ; if ( ret < 0 ) { SYSERROR ( "Failed to create directory \"%s\"" , new -> dest ) ; return - 1 ; } return 0 ; 