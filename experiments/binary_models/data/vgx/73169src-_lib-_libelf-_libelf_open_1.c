static void * _libelf_read_special_file ( int fd , size_t * fsz ) { ssize_t readsz ; size_t bufsz , datasz ; unsigned char * buf , * t ; datasz = 0 ; readsz = 0 ; bufsz = _LIBELF_INITSIZE ; if ( ( buf = malloc ( bufsz ) ) == NULL ) { resourceerror } { if ( datasz == bufsz ) { bufsz *= 2 ; if ( ( t = realloc ( buf , bufsz ) ) == NULL ) { resourceerror } buf = t ; } { assert ( bufsz - datasz > 0 ) ; t = buf + datasz ; if ( ( readsz = read ( fd , t , bufsz - datasz ) ) <= 0 ) { break ; } datasz += ( size_t ) readsz ; } datasz < bufsz ; } readsz > 0 ; if ( readsz < 0 ) { LIBELF_SET_ERROR ( IO , errno ) ; error } assert ( readsz == 0 ) ; if ( bufsz > datasz ) { if ( datasz > 0 ) { if ( ( t = realloc ( buf , datasz ) ) == NULL ) { resourceerror } buf = t ; } else { LIBELF_SET_ERROR ( ARGUMENT , 0 ) ; buf = NULL ; } } * fsz = datasz ; return ( buf ) ; resourceerror LIBELF_SET_ERROR ( RESOURCE , 0 ) ; error if ( buf != NULL ) { free ( buf ) ; } return ( NULL ) ; } 