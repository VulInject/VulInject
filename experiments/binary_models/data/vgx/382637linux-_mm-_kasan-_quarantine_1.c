bool kasan_quarantine_put ( struct kmem_cache * cache , void * object ) { unsigned long flags ; struct qlist_head * q ; struct qlist_head temp = QLIST_INIT ; struct kasan_free_meta * meta = kasan_get_free_meta ( cache , object ) ; local_irq_save ( flags ) ; q = this_cpu_ptr ( & cpu_quarantine ) ; if ( q -> offline ) { local_irq_restore ( flags ) ; return false ; } qlist_put ( q , & meta -> quarantine_link , cache -> size ) ; if ( unlikely ( q -> bytes > QUARANTINE_PERCPU_SIZE ) ) { qlist_move_all ( q , & temp ) ; raw_spin_lock ( & quarantine_lock ) ; WRITE_ONCE ( quarantine_size , quarantine_size + temp . bytes ) ; qlist_move_all ( & temp , & global_quarantine [ quarantine_tail ] ) ; if ( global_quarantine [ quarantine_tail ] . bytes >= READ_ONCE ( quarantine_batch_size ) ) { int new_tail ; new_tail = quarantine_tail + 1 ; if ( new_tail == QUARANTINE_BATCHES ) { new_tail = 0 ; } if ( new_tail != quarantine_head ) { quarantine_tail = new_tail ; } } raw_spin_unlock ( & quarantine_lock ) ; } local_irq_restore ( flags ) ; return true ; } 