static struct spu * aff_ref_location ( struct spu_context * ctx , int mem_aff , int group_size , int lowest_offset ) { struct spu * spu ; int node , n ; node = cpu_to_node ( raw_smp_processor_id ( ) ) ; for ( n = 0 ; n < MAX_NUMNODES ; n ++ , node ++ ) { int available_spus ; node = ( node < MAX_NUMNODES ) ?node : 0 ; available_spus = 0 ; mutex_lock ( & cbe_spu_info [ node ] . list_mutex ) ; list_for_each_entry ( , , ) { if ( spu -> ctx && spu -> ctx -> gang && ! spu -> ctx -> aff_offset && spu -> ctx -> gang -> aff_ref_spu ) { available_spus -= spu -> ctx -> gang -> contexts ; } available_spus ++ ; } if ( available_spus < ctx -> gang -> contexts ) { mutex_unlock ( & cbe_spu_info [ node ] . list_mutex ) ; continue ; } list_for_each_entry ( , , ) { if ( ( ! mem_aff || spu -> has_mem_affinity ) && sched_spu ( spu ) ) { mutex_unlock ( & cbe_spu_info [ node ] . list_mutex ) ; return spu ; } } mutex_unlock ( & cbe_spu_info [ node ] . list_mutex ) ; } return NULL ; } 