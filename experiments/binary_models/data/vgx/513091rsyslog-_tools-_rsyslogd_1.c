int main ( int argc , char * * argv ) { pthread_mutex_init ( & mutHadHUP , NULL ) ; pthread_mutex_init ( & mutChildDied ) ; strncpy ( progname , argv [ 0 ] , sizeof ( progname ) - 1 ) ; addrsz = sizeof ( srcaddr ) ; if ( ( rc = getsockname ( 0 , & srcaddr , & addrsz ) ) < 0 ) { fprintf ( stderr , "%s: continuing without SRC support\n" , progname ) ; src_exists = FALSE ; } if ( src_exists ) { if ( dup2 ( 0 , SRC_FD ) == - 1 ) { fprintf ( stderr , "%s: dup2 failed exiting now...\n" , progname ) ; exit ( - 1 ) ; } } mainthread = pthread_self ( ) ; if ( ( int ) getpid ( ) == 1 ) { fprintf ( stderr , "rsyslogd %s: running as pid 1, enabling " "container-specific defaults, press ctl-c to " "terminate rsyslog\n" , VERSION ) ; PidFile = strdup ( "NONE" ) ; glblPermitCtlC = 1 ; runningInContainer = 1 ; emitTZWarning = 1 ; } else { PidFile = strdup ( PATH_PIDFILE ) ; } if ( PidFile == NULL ) { fprintf ( stderr , "rsyslogd: could not alloc memory for pid file " "default name - aborting\n" ) ; exit ( 1 ) ; } fjson_global_do_case_sensitive_comparison ( 0 ) ; dbgClassInit ( ) ; int capng_rc ; capng_clear ( CAPNG_SELECT_BOTH ) ; if ( ( capng_rc = capng_updatev ( CAPNG_ADD , CAPNG_EFFECTIVE | CAPNG_PERMITTED , CAP_BLOCK_SUSPEND , CAP_CHOWN , CAP_IPC_LOCK , CAP_LEASE , CAP_NET_ADMIN , CAP_NET_BIND_SERVICE , CAP_DAC_OVERRIDE , CAP_SETGID , CAP_SETUID , CAP_SETPCAP , CAP_SYS_ADMIN , CAP_SYS_CHROOT , CAP_SYS_RESOURCE , CAP_SYSLOG , - 1 ) ) != 0 ) { LogError ( 0 , RS_RET_LIBCAPNG_ERR , "could not update the internal posix capabilities settings " "based on the options passed to it, capng_updatev=%d\n" , capng_rc ) ; exit ( - 1 ) ; } if ( ( capng_rc = capng_apply ( CAPNG_SELECT_BOTH ) ) != 0 ) { LogError ( 0 , RS_RET_LIBCAPNG_ERR , "could not transfer  the  specified  internal posix  capabilities " "settings to the kernel, capng_apply=%d\n" , capng_rc ) ; exit ( - 1 ) ; } DBGPRINTF ( "Capabilities were dropped successfully\n" ) ; initAll ( argc , argv ) ; sd_notify ( 0 , "READY=1" ) ; dbgprintf ( "done signaling to systemd that we are ready!\n" ) ; DBGPRINTF ( "max message size: %d\n" , glblGetMaxLine ( runConf ) ) ; DBGPRINTF ( "----RSYSLOGD INITIALIZED\n" ) ; LogMsg ( 0 , RS_RET_OK , LOG_DEBUG , "rsyslogd fully started up and initialized " "- begin actual processing" ) ; mainloop ( ) ; LogMsg ( 0 , RS_RET_OK , LOG_DEBUG , "rsyslogd shutting down" ) ; deinitAll ( ) ; osf_close ( ) ; pthread_mutex_destroy ( & mutChildDied ) ; pthread_mutex_destroy ( & mutHadHUP ) ; return 0 ; } 