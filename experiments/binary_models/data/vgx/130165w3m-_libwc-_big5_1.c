Str wc_conv_from_big5 ( Str is , wc_ces ces ) { Str os ; wc_uchar * sp = ( wc_uchar * ) is -> ptr ; wc_uchar * ep = sp + is -> length ; wc_uchar * p ; int state = WC_BIG5_NOSTATE ; for ( p = sp ; p < ep && * p < 0x80 ; p ++ ) { } os = Strnew_size ( is -> length ) ; if ( p > sp ) { Strcat_charp_n ( os , ( char * ) is -> ptr , ( int ) ( p - sp ) ) ; } for ( ; p < ep ; p ++ ) { switch ( state ) { case WC_BIG5_NOSTATE : switch ( WC_BIG5_MAP [ * p ] ) { case UB : state = WC_BIG5_MBYTE1 ; break ; case C1 : wtf_push_unknown ( os , p , 1 ) ; break ; default : Strcat_char ( os , ( char ) * p ) ; break ; } break ; case WC_BIG5_MBYTE1 : if ( WC_BIG5_MAP [ * p ] & LB ) { wtf_push ( os , WC_CCS_BIG5 , ( ( wc_uint32 ) * ( p - 1 ) << 8 ) | * p ) ; } else { wtf_push_unknown ( os , p - 1 , 2 ) ; } state = WC_BIG5_NOSTATE ; break ; } } switch ( state ) { case WC_BIG5_MBYTE1 : wtf_push_unknown ( os , p - 1 , 1 ) ; break ; } return os ; } 