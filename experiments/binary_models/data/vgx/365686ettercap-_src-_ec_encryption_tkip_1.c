int wpa_tkip_decrypt ( u_char * mac , u_char * data , size_t len , struct wpa_sa sa ) { u_int32 TSC32 ; u_int16 TSC16 ; u_int16 TTAK [ TKIP_TTAK_LEN ] ; u_int8 wep_seed [ TKIP_WEP_128_KEY_LEN ] ; u_char decbuf [ len ] ; get_TSC ( & TSC32 , & TSC16 , data ) ; memset ( TTAK , 0 , sizeof ( TTAK ) ) ; tkip_mixing_phase1 ( TTAK , sa . decryption_key , mac + TKIP_TA_OFFSET , TSC32 ) ; tkip_mixing_phase2 ( wep_seed , sa . decryption_key , TTAK , TSC16 ) ; memcpy ( decbuf , data + sizeof ( wpa_header ) , len ) ; if ( tkip_decrypt ( decbuf , len - WEP_CRC_LEN , wep_seed ) != 0 ) { return - E_NOTHANDLED ; } memcpy ( data , decbuf , len ) ; memset ( data + len - WEP_CRC_LEN , 0 , WEP_CRC_LEN ) ; return E_SUCCESS ; } 