static int snd_cs46xx_resume ( struct device * dev ) { struct snd_card * card = dev_get_drvdata ( dev ) ; struct snd_cs46xx * chip = card -> private_data ; int amp_saved ; int i ; unsigned int tmp ; amp_saved = chip -> amplifier ; chip -> amplifier = 0 ; chip -> active_ctrl ( chip , 1 ) ; snd_cs46xx_chip_init ( chip ) ; snd_cs46xx_reset ( chip ) ; cs46xx_dsp_resume ( chip ) ; for ( i = 0 ; i < ARRAY_SIZE ( saved_regs ) ; i ++ ) { snd_cs46xx_pokeBA0 ( chip , saved_regs [ i ] , chip -> saved_regs [ i ] ) ; } snd_cs46xx_download_image ( chip ) ; snd_cs46xx_codec_write ( chip , BA0_AC97_GENERAL_PURPOSE , chip -> ac97_general_purpose ) ; snd_cs46xx_codec_write ( chip , AC97_POWER_CONTROL , chip -> ac97_powerdown ) ; mdelay ( 10 ) ; snd_cs46xx_codec_write ( chip , BA0_AC97_POWERDOWN , chip -> ac97_powerdown ) ; mdelay ( 5 ) ; snd_ac97_resume ( chip -> ac97 [ CS46XX_PRIMARY_CODEC_INDEX ] , NULL ) ; snd_ac97_resume ( chip -> ac97 [ CS46XX_SECONDARY_CODEC_INDEX ] ) ; tmp = snd_cs46xx_peek ( chip , BA1_CCTL ) ; chip -> capt . ctl = tmp & 0x0000ffff ; snd_cs46xx_poke ( chip , BA1_CCTL , tmp & 0xffff0000 ) ; mdelay ( 5 ) ; snd_cs46xx_set_play_sample_rate ( chip , 8000 ) ; snd_cs46xx_set_capture_sample_rate ( chip , 8000 ) ; snd_cs46xx_proc_start ( chip ) ; cs46xx_enable_stream_irqs ( chip ) ; if ( amp_saved ) { chip -> amplifier_ctrl ( chip , 1 ) ; } else { chip -> active_ctrl ( chip , - 1 ) ; } chip -> amplifier = amp_saved ; chip -> in_suspend = 0 ; snd_power_change_state ( card , SNDRV_CTL_POWER_D0 ) ; return 0 ; } 