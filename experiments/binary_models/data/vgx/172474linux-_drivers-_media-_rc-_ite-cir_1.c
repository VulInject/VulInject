static int ite_tx_ir ( struct rc_dev * rcdev , unsigned * txbuf , unsigned n ) { unsigned long flags ; struct ite_dev * dev = rcdev -> priv ; bool is_pulse = false ; int remaining_us , fifo_avail , fifo_remaining , last_idx = 0 ; int max_rle_us , next_rle_us ; int ret = n ; u8 last_sent [ ITE_TX_FIFO_LEN ] ; u8 val ; spin_lock_irqsave ( & dev -> lock , flags ) ; dev -> transmitting = true ; ite_set_carrier_params ( dev ) ; max_rle_us = ( ITE_BAUDRATE_DIVISOR * sample_period * ITE_TX_MAX_RLE ) / 1000 ; dev -> params -> disable_rx ( dev ) ; fifo_avail = ITE_TX_FIFO_LEN - dev -> params -> get_tx_used_slots ( dev ) ; while ( n > 0 ) { is_pulse = ! is_pulse ; remaining_us = * ( txbuf ++ ) ; n -- ; dev_dbg ( & dev -> rdev -> dev , "%s: %d\n" , is_pulse ?"pulse" : "space" , remaining_us ) ; while ( remaining_us > 0 ) { if ( remaining_us > max_rle_us ) { next_rle_us = max_rle_us ; } else { next_rle_us = remaining_us ; } remaining_us -= next_rle_us ; val = ( ITE_TX_MAX_RLE * next_rle_us ) / max_rle_us ; last_sent [ last_idx ++ ] = val ; last_idx &= ( ITE_TX_FIFO_LEN ) ; val = ( val - 1 ) & ITE_TX_RLE_MASK ; if ( is_pulse ) { val |= ITE_TX_PULSE ; } else { val |= ITE_TX_SPACE ; } if ( fifo_avail <= 0 ) { fifo_avail = ITE_TX_FIFO_LEN - dev -> params -> get_tx_used_slots ( dev ) ; } if ( fifo_avail <= 0 ) { dev -> params -> enable_tx_interrupt ( dev ) ; spin_unlock_irqrestore ( & dev -> lock , flags ) ; wait_event_interruptible ( dev -> tx_queue , ( fifo_avail = ITE_TX_FIFO_LEN - dev -> params -> get_tx_used_slots ( dev ) ) >= 8 ) ; spin_lock_irqsave ( & dev -> lock , flags ) ; dev -> params -> disable_tx_interrupt ( dev ) ; } dev -> params -> put_tx_byte ( dev , val ) ; fifo_avail -- ; } } fifo_remaining = dev -> params -> get_tx_used_slots ( dev ) ; remaining_us = 0 ; while ( fifo_remaining > 0 ) { fifo_remaining -- ; last_idx -- ; last_idx &= ( ITE_TX_FIFO_LEN - 1 ) ; remaining_us += last_sent [ last_idx ] ; } remaining_us = ( remaining_us * max_rle_us ) / ( ITE_TX_MAX_RLE ) ; spin_unlock_irqrestore ( & dev -> lock , flags ) ; mdelay ( DIV_ROUND_UP ( remaining_us , 1000 ) ) ; spin_lock_irqsave ( & dev -> lock , flags ) ; dev -> transmitting = false ; ite_set_carrier_params ( dev ) ; dev -> params -> enable_rx ( dev ) ; wake_up_interruptible ( & dev -> tx_ended ) ; spin_unlock_irqrestore ( & dev -> lock , flags ) ; return ret ; } 