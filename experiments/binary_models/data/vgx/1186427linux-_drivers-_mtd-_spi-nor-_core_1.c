static int spi_nor_write_16bit_sr_and_check ( struct spi_nor * nor , u8 sr1 ) { int ret ; u8 * sr_cr = nor -> bouncebuf ; u8 cr_written ; if ( ! ( nor -> flags & SNOR_F_NO_READ_CR ) ) { ret = spi_nor_read_cr ( nor , & sr_cr [ 1 ] ) ; } if ( nor -> params -> quad_enable ) { sr_cr [ 1 ] = SR2_QUAD_EN_BIT1 ; } else { sr_cr [ 1 ] = 0 ; } sr_cr [ 0 ] = sr1 ; ret = spi_nor_write_sr ( nor , sr_cr , 2 ) ; if ( ret ) { return ret ; } ret = spi_nor_read_sr ( nor , sr_cr ) ; if ( ret ) { return ret ; } if ( sr1 != sr_cr [ 0 ] ) { dev_dbg ( nor -> dev , "SR: Read back test failed\n" ) ; return - EIO ; } if ( nor -> flags & SNOR_F_NO_READ_CR ) { return 0 ; } cr_written = sr_cr [ 1 ] ; ret = spi_nor_read_cr ( nor , & sr_cr [ 1 ] ) ; if ( ret ) { return ret ; } if ( cr_written != sr_cr [ 1 ] ) { dev_dbg ( nor -> dev , "CR: read back test failed\n" ) ; return - EIO ; } return 0 ; } 