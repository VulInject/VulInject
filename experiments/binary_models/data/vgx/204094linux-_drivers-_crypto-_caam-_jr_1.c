struct device * caam_jr_alloc ( void ) { struct caam_drv_private_jr * jrpriv , * min_jrpriv = NULL ; struct device * dev = ERR_PTR ( - ENODEV ) ; int min_tfm_cnt = INT_MAX ; int tfm_cnt ; spin_lock ( & driver_data . jr_alloc_lock ) ; if ( list_empty ( & driver_data . jr_list ) ) { spin_unlock ( & driver_data . jr_alloc_lock ) ; return ERR_PTR ( - ENODEV ) ; } list_for_each_entry ( , , ) { tfm_cnt = atomic_read ( & jrpriv -> tfm_count ) ; if ( tfm_cnt < min_tfm_cnt ) { min_tfm_cnt = tfm_cnt ; min_jrpriv = jrpriv ; } } if ( min_jrpriv ) { atomic_inc ( & min_jrpriv -> tfm_count ) ; dev = min_jrpriv -> dev ; } spin_unlock ( & driver_data . jr_alloc_lock ) ; return dev ; } 