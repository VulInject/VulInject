boolean_t ena_dma_alloc ( ena_t * ena , ena_dma_buf_t * edb , ena_dma_conf_t * conf , size_t size ) { int ret ; size_t size_allocated ; ddi_dma_attr_t attr ; ddi_device_acc_attr_t acc ; uint_t flags = conf -> edc_stream ?DDI_DMA_STREAMING : DDI_DMA_CONSISTENT ; ena_dma_attr ( ena , & attr , conf ) ; acc . devacc_attr_version = DDI_DEVICE_ATTR_V1 ; acc . devacc_attr_endian_flags = conf -> edc_endian ; acc . devacc_attr_dataorder = DDI_STRICTORDER_ACC ; ret = ddi_dma_alloc_handle ( ena -> ena_dip , & attr , DDI_DMA_DONTWAIT , NULL , & edb -> edb_dma_hdl ) ; if ( ret != DDI_SUCCESS ) { ena_err ( ena , "!failed to allocate DMA handle: %d" , ret ) ; return ( B_FALSE ) ; } ret = ddi_dma_mem_alloc ( edb -> edb_dma_hdl , size , & acc , flags , DDI_DMA_DONTWAIT , NULL , & edb -> edb_va , & size_allocated , & edb -> edb_acc_hdl ) ; if ( ret != DDI_SUCCESS ) { ena_err ( ena , "!failed to allocate %lu bytes of DMA " "memory: %d" , size , ret ) ; return ( B_FALSE ) ; } bzero ( edb -> edb_va , size_allocated ) ; ret = ddi_dma_addr_bind_handle ( edb -> edb_dma_hdl , NULL , edb -> edb_va , size_allocated , DDI_DMA_RDWR | flags , DDI_DMA_DONTWAIT , NULL , NULL , NULL ) ; if ( ret != DDI_SUCCESS ) { ena_err ( ena , "!failed to bind %lu bytes of DMA " "memory: %d" , size_allocated , ret ) ; ena_dma_free ( edb ) ; return ( B_FALSE ) ; } edb -> edb_len = size ; edb -> edb_real_len = size_allocated ; edb -> edb_cookie = ddi_dma_cookie_one ( edb -> edb_dma_hdl ) ; return ( B_TRUE ) ; } 