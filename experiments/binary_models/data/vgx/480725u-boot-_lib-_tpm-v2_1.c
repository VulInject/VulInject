u32 tpm2_pcr_read ( struct udevice * dev , u32 idx , unsigned int idx_min_sz , u16 algorithm , void * data , u32 digest_len , unsigned int * updates ) { u8 idx_array_sz = max ( idx_min_sz , DIV_ROUND_UP ( idx , 8 ) ) ; u8 command_v2 [ COMMAND_BUFFER_SIZE ] { tpm_u16 ( TPM2_ST_NO_SESSIONS ) tpm_u32 ( 17 + idx_array_sz ) tpm_u32 ( TPM2_CC_PCR_READ ) tpm_u32 ( 1 ) tpm_u16 ( algorithm ) idx_array_sz } ; ; size_t response_len = COMMAND_BUFFER_SIZE ; u8 response [ COMMAND_BUFFER_SIZE ] ; unsigned int pcr_sel_idx = idx / 8 ; u8 pcr_sel_bit = BIT ( idx % 8 ) ; unsigned int counter = 0 ; int ret ; if ( pack_byte_string ( command_v2 , COMMAND_BUFFER_SIZE , "b" , 17 + pcr_sel_idx , pcr_sel_bit ) ) { return TPM_LIB_ERROR ; } ret = tpm_sendrecv_command ( dev , command_v2 , response , & response_len ) ; if ( ret ) { return ret ; } if ( unpack_byte_string ( response , response_len , "ds" , 10 , & counter , response_len - digest_len , data , digest_len ) ) { return TPM_LIB_ERROR ; } if ( updates ) { * updates = counter ; } return 0 ; } 