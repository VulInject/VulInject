int pvrdma_dereg_mr ( struct ib_mr * ibmr ) { struct pvrdma_user_mr * mr = to_vmr ( ibmr ) ; struct pvrdma_dev * dev = to_vdev ( ibmr -> device ) ; union pvrdma_cmd_req req ; struct pvrdma_cmd_destroy_mr * cmd = & req . destroy_mr ; int ret ; memset ( cmd , 0 , sizeof ( * cmd ) ) ; cmd -> hdr . cmd = PVRDMA_CMD_DESTROY_MR ; cmd -> mr_handle = mr -> mmr . mr_handle ; ret = pvrdma_cmd_post ( dev , & req , NULL , 0 ) ; if ( ret < 0 ) { dev_warn ( & dev -> pdev -> dev , "could not deregister mem region, error: %d\n" , ret ) ; } pvrdma_page_dir_cleanup ( dev , & mr -> pdir ) ; if ( mr -> umem ) { ib_umem_release ( mr -> umem ) ; } kfree ( mr -> pages ) ; return 0 ; } 