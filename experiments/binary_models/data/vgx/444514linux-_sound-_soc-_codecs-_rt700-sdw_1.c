static int rt700_sdw_read ( void * context , unsigned int reg , unsigned int * val ) { struct device * dev = context ; struct rt700_priv * rt700 = dev_get_drvdata ( dev ) ; unsigned int sdw_data_3 , sdw_data_2 , sdw_data_1 , sdw_data_0 ; unsigned int reg2 = 0 , reg3 = 0 , reg4 = 0 , mask , nid , val2 ; unsigned int is_hda_reg = 1 , is_index_reg = 0 ; int ret ; if ( reg > 0xffff ) { is_index_reg = 1 ; } mask = reg & 0xf000 ; if ( is_index_reg ) { val2 = reg & 0xff ; reg = reg >> 8 ; nid = reg & 0xff ; ret = regmap_write ( rt700 -> sdw_regmap , reg , 0 ) ; reg2 = reg + 0x1000 ; reg2 |= 0x80 ; ret = regmap_write ( rt700 -> sdw_regmap , reg2 , val2 ) ; if ( ret < 0 ) { return ret ; } reg3 = RT700_PRIV_DATA_R_H | nid ; ret = regmap_write ( rt700 -> sdw_regmap , reg3 , ( ( * val >> 8 ) & 0xff ) ) ; if ( ret < 0 ) { return ret ; } reg4 = reg3 + 0x1000 ; reg4 |= 0x80 ; ret = regmap_write ( rt700 -> sdw_regmap , reg4 , ( * val & 0xff ) ) ; if ( ret < 0 ) { return ret ; } } if ( mask == 0x3000 ) { reg += 0x8000 ; ret = regmap_write ( rt700 -> sdw_regmap , reg , * val ) ; if ( ret < 0 ) { return ret ; } } if ( mask == 0x7000 ) { reg += 0x2000 ; reg |= 0x800 ; ret = regmap_write ( rt700 -> sdw_regmap , reg , ( ( * val >> 8 ) & 0xff ) ) ; if ( ret < 0 ) { return ret ; } reg2 = reg + 0x1000 ; reg2 |= 0x80 ; ret = regmap_write ( rt700 -> sdw_regmap , reg2 , ( * val & 0xff ) ) ; if ( ret < 0 ) { return ret ; } } if ( ( reg & 0xff00 ) == 0x8300 ) { reg2 = reg - 0x1000 ; reg2 &= ~ 0x80 ; ret = regmap_write ( rt700 -> sdw_regmap , reg2 , ( ( * val >> 8 ) & 0xff ) ) ; if ( ret < 0 ) { return ret ; } ret = regmap_write ( rt700 -> sdw_regmap , reg , ( * val & 0xff ) ) ; if ( ret < 0 ) { return ret ; } } if ( mask == 0x9000 ) { ret = regmap_write ( rt700 -> sdw_regmap , reg , ( ( * val >> 8 ) & 0xff ) ) ; if ( ret < 0 ) { return ret ; } reg2 = reg + 0x1000 ; reg2 |= 0x80 ; ret = regmap_write ( rt700 -> sdw_regmap , reg2 , ( * val & 0xff ) ) ; if ( ret < 0 ) { return ret ; } } if ( mask == 0xb000 ) { ret = regmap_write ( rt700 -> sdw_regmap , reg , * val ) ; if ( ret < 0 ) { return ret ; } } else { ret = regmap_read ( rt700 -> sdw_regmap , reg , val ) ; if ( ret < 0 ) { return ret ; } is_hda_reg = 0 ; } if ( is_hda_reg || is_index_reg ) { sdw_data_3 = 0 ; sdw_data_2 = 0 ; sdw_data_1 = 0 ; sdw_data_0 = 0 ; ret = regmap_read ( rt700 -> sdw_regmap , RT700_READ_HDA_3 , & sdw_data_3 ) ; if ( ret < 0 ) { return ret ; } ret = regmap_read ( rt700 -> sdw_regmap , RT700_READ_HDA_2 , & sdw_data_2 ) ; if ( ret < 0 ) { return ret ; } ret = regmap_read ( rt700 -> sdw_regmap , RT700_READ_HDA_1 , & sdw_data_1 ) ; if ( ret < 0 ) { return ret ; } ret = regmap_read ( rt700 -> sdw_regmap , RT700_READ_HDA_0 , & sdw_data_0 ) ; if ( ret < 0 ) { return ret ; } * val = ( ( sdw_data_3 & 0xff ) << 24 ) | ( ( sdw_data_2 & 0xff ) << 16 ) | ( ( sdw_data_1 & 0xff ) << 8 ) | ( sdw_data_0 & 0xff ) ; } if ( is_hda_reg == 0 ) { dev_dbg ( dev , "[%s] %04x =>%08x\n" , __func__ , reg , * val ) ; } if ( is_index_reg ) { dev_dbg ( dev , "[%s] %04x %04x %04x %04x =>%08x\n" , __func__ , reg , reg2 , reg3 , reg4 , * val ) ; } else { dev_dbg ( dev , "[%s] %04x %04x =>%08x\n" , __func__ , reg , reg2 , * val ) ; } return 0 ; } 