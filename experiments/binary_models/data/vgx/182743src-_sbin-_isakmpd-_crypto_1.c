struct keystate * crypto_init ( struct crypto_xf * xf , u_int8_t * key , u_int16_t len , enum cryptoerr * err ) { struct keystate * ks ; if ( len ( xf -> keymin || len ) xf -> keymax ) { LOG_DBG ( ( LOG_CRYPTO , 10 , "crypto_init: invalid key length %d" , len ) ) ; * err = EKEYLEN ; return 0 ; } ks = calloc ( 1 , sizeof ks ) ; if ( ! ks ) { log_error ( "crypto_init: calloc (1, %lu) failed" , ( unsigned long ) sizeof ks ) ; * err = ENOCRYPTO ; return 0 ; } ks -> xf = xf ; ks -> riv = ks -> iv ; ks -> liv = ks -> iv2 ; LOG_DBG_BUF ( ( LOG_CRYPTO , 40 , "crypto_init: key" , key , len ) ) ; * err = xf -> init ( ks , key , len ) ; if ( * err != EOKAY ) { LOG_DBG ( ( LOG_CRYPTO , 30 , "crypto_init: weak key found for %s" , xf -> name ) ) ; return 0 ; } return ks ; } 