static int ionic_fw_status_long_wait ( struct ionic * ionic , const char * label , unsigned long timeout , u8 fw_cmd , struct netlink_ext_ack * extack ) { union ionic_dev_cmd cmd = { . fw_control . opcode = IONIC_CMD_FW_CONTROL . fw_control . oper = fw_cmd } ; cfs_time_t start_time ; unsigned long end_time ; int err ; start_time = jiffies ; end_time = start_time + ( timeout * HZ ) ; { mutex_lock ( & ionic -> dev_cmd_lock ) ; ionic_dev_cmd_go ( & ionic -> idev , & cmd ) ; err = ionic_dev_cmd_wait ( ionic , DEVCMD_TIMEOUT ) ; mutex_unlock ( & ionic -> dev_cmd_lock ) ; msleep ( 20 ) ; } time_before ( jiffies , end_time ) && ( err == - EAGAIN || err == - ETIMEDOUT ) ; if ( err == - EAGAIN || err == - ETIMEDOUT ) { NL_SET_ERR_MSG_MOD ( extack , "Firmware wait timed out" ) ; dev_err ( ionic -> dev , "DEV_CMD firmware wait %s timed out\n" , label ) ; } if ( err ) { NL_SET_ERR_MSG_MOD ( extack , "Firmware wait failed" ) ; } return err ; } 