static int read_basic_state ( struct rebase_options * opts ) { struct strbuf head_name = STRBUF_INIT ; struct strbuf buf = STRBUF_INIT ; struct object_id oid ; if ( ! read_oneliner ( & head_name , state_dir_path ( "head-name" , opts ) , READ_ONELINER_WARN_MISSING ) || ! read_oneliner ( & buf , state_dir_path ( "onto" , opts ) , READ_ONELINER_WARN_MISSING ) ) { return - 1 ; } opts -> head_name = starts_with ( head_name . buf , "refs/" ) ?xstrdup ( head_name . buf ) : NULL ; strbuf_release ( & head_name ) ; if ( get_oid_hex ( buf . buf , & oid ) || ! ( opts -> onto = lookup_commit_object ( the_repository , & oid ) ) ) { return error ( _ ( "invalid onto: '%s'" ) , buf . buf ) ; } strbuf_reset ( & buf ) ; if ( file_exists ( state_dir_path ( "orig-head" , opts ) ) ) { if ( ! read_oneliner ( & buf , state_dir_path ( "orig-head" , opts ) , READ_ONELINER_WARN_MISSING ) ) { return - 1 ; } } if ( ! read_oneliner ( & buf , state_dir_path ( "head" , opts ) , READ_ONELINER_WARN_MISSING ) ) { return - 1 ; } if ( get_oid_hex ( buf . buf , & oid ) || ! ( opts -> orig_head = lookup_commit_object ( the_repository , & oid ) ) ) { return error ( _ ( "invalid orig-head: '%s'" ) , buf . buf ) ; } if ( file_exists ( state_dir_path ( "quiet" , opts ) ) ) { opts -> flags &= ~ REBASE_NO_QUIET ; } else { opts -> flags |= REBASE_NO_QUIET ; } if ( file_exists ( state_dir_path ( "verbose" , opts ) ) ) { opts -> flags |= REBASE_VERBOSE ; } if ( file_exists ( state_dir_path ( "signoff" , opts ) ) ) { opts -> signoff = 1 ; opts -> flags |= REBASE_FORCE ; } if ( file_exists ( state_dir_path ( "allow_rerere_autoupdate" , opts ) ) ) { strbuf_reset ( & buf ) ; if ( ! read_oneliner ( & buf , state_dir_path ( "allow_rerere_autoupdate" , opts ) , READ_ONELINER_WARN_MISSING ) ) { return - 1 ; } if ( ! strcmp ( buf . buf , "--rerere-autoupdate" ) ) { opts -> allow_rerere_autoupdate = RERERE_AUTOUPDATE ; } if ( ! strcmp ( buf . buf , "--no-rerere-autoupdate" ) ) { opts -> allow_rerere_autoupdate = RERERE_NOAUTOUPDATE ; } else { warning ( _ ( "ignoring invalid allow_rerere_autoupdate: " "'%s'" ) , buf . buf ) ; } } if ( file_exists ( state_dir_path ( "gpg_sign_opt" , opts ) ) ) { strbuf_reset ( & buf ) ; if ( ! read_oneliner ( & buf , state_dir_path ( "gpg_sign_opt" , opts ) , READ_ONELINER_WARN_MISSING ) ) { return - 1 ; } opts -> gpg_sign_opt = xstrdup ( buf . buf ) ; } if ( file_exists ( state_dir_path ( "strategy" , opts ) ) ) { strbuf_reset ( & buf ) ; if ( ! read_oneliner ( & buf , state_dir_path ( "strategy" , opts ) , READ_ONELINER_WARN_MISSING ) ) { return - 1 ; } free ( opts -> strategy ) ; opts -> strategy = xstrdup ( buf . buf ) ; } if ( file_exists ( state_dir_path ( "strategy_opts" , opts ) ) ) { strbuf_reset ( & buf ) ; if ( ! read_oneliner ( & buf , state_dir_path ( "strategy_opts" , opts ) , READ_ONELINER_WARN_MISSING ) ) { return - 1 ; } free ( opts -> strategy_opts ) ; opts -> strategy_opts = xstrdup ( buf . buf ) ; } strbuf_release ( & buf ) ; return 0 ; } 