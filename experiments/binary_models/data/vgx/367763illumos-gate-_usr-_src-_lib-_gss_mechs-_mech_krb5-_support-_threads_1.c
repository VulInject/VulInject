int k5_key_register ( k5_key_t keynum , void * destructor ( void * ) ) { int err ; err = CALL_INIT_FUNCTION ( krb5int_thread_support_init ) ; assert ( keynum >= 0 && keynum < K5_KEY_MAX ) ; assert ( destructors_set [ keynum ] == 0 ) ; destructors [ keynum ] = destructor ; destructors_set [ keynum ] = 1 ; err = 0 ; EnterCriticalSection ( & key_lock ) ; assert ( destructors_set [ keynum ] == 0 ) ; destructors_set [ keynum ] = 1 ; destructors [ keynum ] = destructor ; LeaveCriticalSection ( & key_lock ) ; err = 0 ; err = k5_mutex_lock ( & key_lock ) ; if ( err == 0 ) { assert ( destructors_set [ keynum ] == 0 ) ; destructors_set [ keynum ] = 1 ; destructors [ keynum ] = destructor ; err = k5_mutex_unlock ( & key_lock ) ; } return 0 ; } 