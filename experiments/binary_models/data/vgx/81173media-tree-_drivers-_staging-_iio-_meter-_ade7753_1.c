static ssize_t ade7753_write_frequency ( struct device * dev , struct device_attribute * attr , const char * buf , size_t len ) { struct iio_dev * indio_dev = dev_to_iio_dev ( dev ) ; struct ade7753_state * st = iio_priv ( indio_dev ) ; u16 val ; int ret ; u16 reg , t ; ret = kstrtou16 ( buf , 10 , & val ) ; if ( ret ) { return ret ; } mutex_lock ( & indio_dev -> mlock ) ; t = 27900 / val ; if ( t > 0 ) { t -- ; } if ( t > 1 ) { st -> us -> max_speed_hz = ADE7753_SPI_SLOW ; } else { st -> us -> max_speed_hz = ADE7753_SPI_FAST ; } ret = ade7753_spi_read_reg_16 ( dev , ADE7753_MODE , & reg ) ; if ( ret ) { out } reg &= ~ ( 3 << 11 ) ; reg |= t << 11 ; ret = ade7753_spi_write_reg_16 ( dev , ADE7753_MODE , reg ) ; out mutex_unlock ( & indio_dev -> mlock ) ; return ret ?ret : len ; } 