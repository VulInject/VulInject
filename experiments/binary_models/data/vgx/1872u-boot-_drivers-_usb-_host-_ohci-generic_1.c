static int ohci_usb_probe ( struct udevice * dev ) { struct ohci_regs * regs = dev_read_addr_ptr ( dev ) ; struct generic_ohci * priv = dev_get_priv ( dev ) ; int i , err , ret , clock_nb , reset_nb ; err = 0 ; priv -> clock_count = 0 ; clock_nb = dev_count_phandle_with_args ( dev , "clocks" , "#clock-cells" , 0 ) ; if ( clock_nb > 0 ) { priv -> clocks = devm_kcalloc ( dev , clock_nb , sizeof ( clk ) , GFP_KERNEL ) ; if ( ! priv -> clocks ) { return - ENOMEM ; } for ( i = 0 ; i < clock_nb ; i ++ ) { err = clk_get_by_index ( dev , i , & priv -> clocks [ i ] ) ; if ( err < 0 ) { break ; } err = clk_enable ( & priv -> clocks [ i ] ) ; if ( err && err != - ENOSYS ) { dev_err ( dev , "failed to enable clock %d\n" , i ) ; clk_free ( & priv -> clocks [ i ] ) ; clk_err } priv -> clock_count ++ ; } } if ( clock_nb != - ENOENT ) { dev_err ( dev , "failed to get clock phandle(%d)\n" , clock_nb ) ; return clock_nb ; } priv -> reset_count = 0 ; reset_nb = dev_count_phandle_with_args ( dev , "resets" , "#reset-cells" , 0 ) ; if ( reset_nb > 0 ) { priv -> resets = devm_kcalloc ( dev , reset_nb , sizeof ( reset_ctl ) , GFP_KERNEL ) ; for ( i = 0 ; i < reset_nb ; i ++ ) { err = reset_get_by_index ( dev , i , & priv -> resets [ i ] ) ; if ( err < 0 ) { break ; } err = reset_deassert ( & priv -> resets [ i ] ) ; if ( err ) { dev_err ( dev , "failed to deassert reset %d\n" , i ) ; reset_free ( & priv -> resets [ i ] ) ; reset_err } priv -> reset_count ++ ; } } if ( reset_nb != - ENOENT ) { dev_err ( dev , "failed to get reset phandle(%d)\n" , reset_nb ) ; clk_err } err = generic_setup_phy ( dev , & priv -> phy , 0 ) ; if ( err ) { reset_err } err = ohci_register ( dev , regs ) ; if ( err ) { phy_err } return 0 ; phy_err ret = generic_shutdown_phy ( & priv -> phy ) ; if ( ret ) { dev_err ( dev , "failed to shutdown usb phy\n" ) ; } reset_err ret = reset_release_all ( priv -> resets , priv -> reset_count ) ; if ( ret ) { dev_err ( dev , "failed to assert all resets\n" ) ; } clk_err ret = clk_release_all ( priv -> clocks , priv -> clock_count ) ; if ( ret ) { dev_err ( dev , "failed to disable all clocks\n" ) ; } return err ; } 