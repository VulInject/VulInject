static OCSP_RESPONSE * ocsp_get_response ( pool * p , SSL * ssl ) { X509 * cert ; const char * fingerprint = NULL ; OCSP_RESPONSE * resp = NULL , * cached_resp = NULL ; int stale_cache = FALSE , use_fake_trylater = FALSE ; cert = SSL_get_certificate ( ssl ) ; if ( cert != NULL ) { fingerprint = tls_get_fingerprint ( p , cert ) ; if ( fingerprint != NULL ) { pr_trace_msg ( trace_channel , 3 , "using fingerprint '%s' for server cert" , fingerprint ) ; if ( tls_ocsp_cache != NULL ) { cached_resp = ocsp_get_cached_response ( p , fingerprint , cert , ssl , & stale_cache ) ; if ( cached_resp != NULL ) { if ( tls_opts & TLS_OPT_ENABLE_DIAGS ) { BIO * diags_bio ; diags_bio = BIO_new ( BIO_s_mem ( ) ) ; if ( diags_bio != NULL ) { if ( OCSP_RESPONSE_print ( diags_bio , cached_resp , 0 ) == 1 ) { char * data = NULL ; long datalen = 0 ; datalen = BIO_get_mem_data ( diags_bio , & data ) ; if ( data != NULL ) { data [ datalen ] = '\0' ; tls_log ( "cached OCSP response (%ld bytes):\n%s" , datalen , data ) ; } } } BIO_free ( diags_bio ) ; } resp = cached_resp ; } else { int xerrno = errno ; pr_trace_msg ( trace_channel , 17 , "no cached OCSP response found in '%s' cache for " "fingerprint '%s': %s" , tls_ocsp_cache -> cache_name , fingerprint , strerror ( errno ) ) ; errno = xerrno ; } } else { pr_trace_msg ( trace_channel , 17 , "no cached OCSP response found (TLSStaplingCache not configured)" ) ; errno = ENOENT ; } if ( cached_resp == NULL || stale_cache == TRUE ) { int xerrno = errno ; OCSP_RESPONSE * fresh_resp = NULL ; if ( xerrno == ENOENT || stale_cache == TRUE ) { const char * ocsp_url ; if ( tls_stapling_responder == NULL ) { ocsp_url = ocsp_get_responder_url ( p , cert ) ; if ( ocsp_url != NULL ) { pr_trace_msg ( trace_channel , 8 , "found OCSP responder URL '%s' in certificate " "(fingerprint '%s')" , ocsp_url , fingerprint ) ; } else { pr_trace_msg ( trace_channel , 8 , "no OCSP responder URL found in certificate " "(fingerprint '%s')" , fingerprint ) ; } } else { ocsp_url = tls_stapling_responder ; pr_trace_msg ( trace_channel , 8 , "using configured OCSP responder URL '%s'" , ocsp_url ) ; } if ( ocsp_url != NULL ) { fresh_resp = ocsp_request_response ( p , cert , ssl , ocsp_url , tls_stapling_timeout ) ; if ( fresh_resp != NULL ) { resp = fresh_resp ; if ( stale_cache == TRUE ) { int res ; res = ( tls_ocsp_cache -> delete ) ( tls_ocsp_cache , fingerprint ) ; if ( res < 0 ) { pr_trace_msg ( trace_channel , 3 , "error deleting OCSP response from '%s' cache for " "fingerprint '%s': %s" , tls_ocsp_cache -> cache_name , fingerprint , strerror ( errno ) ) ; } cached_resp = NULL ; } } } else { pr_trace_msg ( trace_channel , 5 , "no OCSP responder URL found in certificate (fingerprint '%s')" , fingerprint ) ; } } else { pr_trace_msg ( trace_channel , 5 , "no cached OCSP response found: %s" , strerror ( xerrno ) ) ; } } } } else { pr_trace_msg ( trace_channel , 8 , "%s" , "no server certificate found for TLS session" ) ; } if ( resp == NULL ) { use_fake_trylater = TRUE ; if ( tls_stapling_opts & TLS_STAPLING_OPT_NO_FAKE_TRY_LATER ) { use_fake_trylater = FALSE ; } if ( cert != NULL ) { int must_staple , is_v2 = FALSE ; must_staple = tls_cert_must_staple ( cert , & is_v2 ) ; if ( must_staple == TRUE ) { pr_trace_msg ( trace_channel , 8 , "found status_request%s 'must staple' TLS feature in certificate " "(fingerprint '%s')" , is_v2 ?"_v2" : "" , fingerprint ) ; use_fake_trylater = TRUE ; } } } if ( use_fake_trylater ) { pr_trace_msg ( trace_channel , 5 , "returning fake tryLater OCSP response" ) ; resp = OCSP_response_create ( OCSP_RESPONSE_STATUS_TRYLATER , NULL ) ; if ( resp == NULL ) { pr_trace_msg ( trace_channel , 1 , "error allocating fake 'tryLater' OCSP response: %s" , tls_get_errors ( ) ) ; return NULL ; } } if ( resp != cached_resp ) { if ( ocsp_add_cached_response ( p , fingerprint , resp ) < 0 ) { if ( errno != ENOSYS ) { pr_trace_msg ( trace_channel , 3 , "error caching OCSP response: %s" , strerror ( errno ) ) ; } } } return resp ; } 