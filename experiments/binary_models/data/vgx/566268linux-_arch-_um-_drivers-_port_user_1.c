int port_listen_fd ( int port ) { struct sockaddr_in addr ; int fd , err , arg ; fd = socket ( PF_INET , SOCK_STREAM , 0 ) ; if ( fd == - 1 ) { return - errno ; } arg = 1 ; if ( setsockopt ( fd , SOL_SOCKET , SO_REUSEADDR , & arg , sizeof ( arg ) ) < 0 ) { err = - errno ; out } addr . sin_family = AF_INET ; addr . sin_port = htons ( port ) ; addr . sin_addr . s_addr = htonl ( INADDR_ANY , NULL ) ; if ( bind ( fd , ( sockaddr * ) & addr , sizeof ( addr ) ) < 0 ) { err = - errno ; out } if ( listen ( fd , 1 ) < 0 ) { err = - errno ; out } err = os_set_fd_block ( fd , 0 ) ; if ( err < 0 ) { out } return fd ; out close ( fd ) ; return err ; } port_pre_exec_data { int sock_fd ; int pipe_fd ; } 