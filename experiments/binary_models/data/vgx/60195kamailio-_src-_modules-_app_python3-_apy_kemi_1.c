PyObject * sr_apy_kemi_exec_func_ex ( sr_kemi_t * ket , PyObject * self , PyObject * args , int idx ) { str fname ; int i ; int ret ; sr_kemi_xval_t vps [ SR_KEMI_PARAMS_MAX ] ; sr_apy_env_t * env_P ; sip_msg_t * lmsg = NULL ; sr_kemi_xval_t * xret ; Py_ssize_t slen ; Py_ssize_t alen ; PyObject * pobj ; env_P = sr_apy_env_get ( ) ; if ( env_P == NULL ) { LM_ERR ( "invalid Python environment attributes\n" ) ; return sr_kemi_apy_return_false ( ) ; } if ( env_P -> msg == NULL ) { lmsg = faked_msg_next ( ) ; } else { lmsg = env_P -> msg ; } if ( ket -> mname . len > 0 ) { LM_DBG ( "execution of method: %.*s\n" , ket -> fname . len , ket -> fname . s ) ; } else { LM_DBG ( "execution of method: %.*s.%.*s\n" , ket -> mname . len , ket -> mname . s , ket -> fname . len , ket -> fname . s ) ; } fname = ket -> fname ; if ( ket -> ptypes [ 0 ] == SR_KEMIP_NONE ) { if ( ket -> rtype == SR_KEMIP_XVAL ) { xret = ( ( sr_kemi_xfm_f ) ( ket -> func ) ) ( lmsg ) ; return sr_kemi_apy_return_xval ( ket , xret ) ; } else { ret = ( ( sr_kemi_fm_f ) ( ket -> func ) ) ( lmsg ) ; return sr_kemi_apy_return_int ( ket , ret ) ; } } if ( ! PyTuple_Check ( args ) ) { LM_ERR ( "invalid arguments from Python\n" ) ; return sr_kemi_apy_return_false ( ) ; } alen = PyTuple_Size ( args ) ; LM_DBG ( "number of arguments: %d\n" , ( int ) alen ) ; for ( i = 0 ; i < SR_KEMI_PARAMS_MAX ; i ++ ) { if ( ket -> ptypes [ i ] == SR_KEMIP_NONE ) { break ; } if ( i >= alen ) { LM_ERR ( "invalid number of parameters - idx: %d argc: %d\n" , i , ( int ) alen ) ; return sr_kemi_apy_return_false ( ) ; } pobj = PyTuple_GetItem ( args , i ) ; if ( pobj == NULL ) { LM_ERR ( "null parameter - func: %.*s idx: %d argc: %d\n" , fname . len , fname . s , i , ( int ) alen ) ; return sr_kemi_apy_return_false ( ) ; } if ( ket -> ptypes [ i ] == SR_KEMIP_STR ) { if ( ! PyUnicode_Check ( pobj ) ) { LM_ERR ( "non-string parameter - func: %.*s idx: %d argc: %d\n" , fname . len , fname . s , i , ( int ) alen ) ; return sr_kemi_apy_return_false ( ) ; } vps [ i ] . v . s . s = ( char * ) PyUnicode_AsUTF8AndSize ( pobj , & slen ) ; if ( vps [ i ] . v . s . s == NULL ) { LM_ERR ( "null-string parameter - func: %.*s idx: %d argc: %d\n" , fname . len , fname . s , i , ( int ) alen ) ; return sr_kemi_apy_return_false ( ) ; } vps [ i ] . v . s . len = ( int ) slen ; vps [ i ] . vtype = SR_KEMIP_STR ; } if ( ( ket -> ptypes [ i ] == SR_KEMIP_INT ) || ( ket -> ptypes [ i ] == SR_KEMIP_LONG ) ) { if ( PyLong_Check ( pobj ) ) { vps [ i ] . v . l = PyLong_AsLong ( pobj ) ; } if ( pobj == Py_True ) { vps [ i ] . v . l = 1 ; } if ( pobj == Py_False ) { vps [ i ] . v . l = 0 ; } else { LM_ERR ( "non-number parameter - func: %.*s idx: %d argc: %d\n" , fname . len , fname . s , i , ( int ) alen ) ; return sr_kemi_apy_return_false ( ) ; } if ( ket -> ptypes [ i ] == SR_KEMIP_INT ) { vps [ i ] . vtype = SR_KEMIP_INT ; ret = ( int ) vps [ i ] . v . l ; vps [ i ] . v . n = ret ; } else { vps [ i ] . vtype = SR_KEMIP_LONG ; } } else { LM_ERR ( "invalid parameter type - func: %.*s idx: %d argc: %d\n" , fname . len , fname . s , i , ( int ) alen ) ; return sr_kemi_apy_return_false ( ) ; } } xret = sr_kemi_exec_func ( ket , lmsg , i , vps ) ; return sr_kemi_apy_return_xval ( ket , xret ) ; } 