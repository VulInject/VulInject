pgtable_t pte_alloc_one ( struct mm_struct * mm ) { pte_t * ptep ; struct page * page ; if ( ! ( ptep = pte_alloc_one_kernel ( mm ) ) ) { return NULL ; } page = pfn_to_page ( __nocache_pa ( ( unsigned long ) ptep ) >> PAGE_SHIFT ) ; spin_lock ( & mm -> page_table_lock ) ; if ( page_ref_inc_return ( page ) == 2 && ! pgtable_pte_page_ctor ( page ) ) { ptep = NULL ; } spin_unlock ( & mm -> page_table_lock ) ; return ptep ; } 