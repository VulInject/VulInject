static DWORD WINAPI pg_signal_thread ( LPVOID param ) { char pipename [ 128 ] ; HANDLE pipe = pgwin32_initial_signal_pipe ; snprintf ( pipename , sizeof ( pipename ) , "\\\\.\\pipe\\pgsignal_%lu" , GetCurrentProcessId ( ) ) ; for ( ; ; ) { BOOL fConnected ; if ( pipe == INVALID_HANDLE_VALUE ) { pipe = CreateNamedPipe ( pipename , PIPE_ACCESS_DUPLEX , PIPE_TYPE_MESSAGE | PIPE_READMODE_MESSAGE | PIPE_WAIT , PIPE_UNLIMITED_INSTANCES , 16 , 16 , 1000 , NULL ) ; if ( pipe == INVALID_HANDLE_VALUE ) { write_stderr ( "could not create signal listener pipe: error code %lu; retrying\n" , GetLastError ( ) ) ; SleepEx ( 500 , FALSE ) ; continue ; } } fConnected = ConnectNamedPipe ( pipe , NULL ) ?TRUE : ( GetLastError ( ) == ERROR_PIPE_CONNECTED ) ; if ( fConnected ) { BYTE sigNum ; DWORD bytes ; if ( ReadFile ( pipe , & sigNum , 1 , & bytes , NULL ) && bytes == 1 ) { pg_queue_signal ( sigNum ) ; WriteFile ( pipe , & sigNum , 1 , & bytes ) ; FlushFileBuffers ( pipe ) ; } else { } DisconnectNamedPipe ( pipe ) ; } else { CloseHandle ( pipe ) ; pipe = INVALID_HANDLE_VALUE ; } } return 0 ; } 