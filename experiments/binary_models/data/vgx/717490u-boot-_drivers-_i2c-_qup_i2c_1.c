static int qup_i2c_blsp_write ( struct qup_i2c_priv * qup , unsigned int addr , bool first , bool last , const u8 * buffer , unsigned int bytes ) { unsigned int i ; u32 word = 0 ; int ret = 0 ; qup_i2c_enable_io_config ( qup , bytes + QUP_MAX_TAGS_LEN , 0 ) ; if ( first ) { ret = qup_i2c_change_state ( qup , QUP_RUN_STATE ) ; if ( ret ) { return ret ; } writel ( qup -> clk_ctl , qup -> base + QUP_I2C_CLK_CTL ) ; ret = qup_i2c_change_state ( qup , QUP_PAUSE_STATE ) ; if ( ret ) { return ret ; } } if ( last ) { qup_i2c_write_word ( qup , QUP_TAG_V2_START | addr << 8 | QUP_TAG_V2_DATAWR_STOP << 16 | bytes << 24 ) ; } else { qup_i2c_write_word ( qup , QUP_TAG_V2_START | addr << 8 | QUP_TAG_V2_DATAWR << 16 | bytes << 24 ) ; } for ( i = 0 ; i < bytes ; i ++ ) { word |= * buffer << ( ( i % 4 ) * 8 ) ; if ( ( i % 4 ) == 3 ) { qup_i2c_write_word ( qup , word ) ; word = 0 ; } buffer ++ ; } if ( ( i % 4 ) != 0 ) { qup_i2c_write_word ( qup , word ) ; } ret = qup_i2c_change_state ( qup , QUP_RUN_STATE ) ; if ( ret ) { return ret ; } ret = qup_i2c_check_fifo_status ( qup , QUP_OPERATIONAL , QUP_OUT_SVC_FLAG ) ; if ( ret ) { return ret ; } writel ( QUP_OUT_SVC_FLAG , qup -> base + QUP_OPERATIONAL ) ; ret = qup_i2c_change_state ( qup , QUP_PAUSE_STATE ) ; return ret ; } 