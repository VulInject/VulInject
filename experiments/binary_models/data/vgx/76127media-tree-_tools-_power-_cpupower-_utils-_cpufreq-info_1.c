static unsigned int count_cpus ( void ) { FILE * fp ; char value [ LINE_LEN ] ; int ret = 0 ; unsigned int cpunr = 0 ; fp = fopen ( "/proc/stat" , "r" ) ; if ( ! fp ) { printf ( _ ( "Couldn't count the number of CPUs (%s: %s), assuming 1\n" ) , "/proc/stat" , strerror ( errno ) ) ; return 1 ; } while ( ! feof ( fp ) ) { if ( ! fgets ( value , LINE_LEN , fp ) ) { continue ; } value [ LINE_LEN - 1 ] = '\0' ; if ( strlen ( value ) < ( LINE_LEN - 2 ) ) { continue ; } if ( strstr ( value , "cpu " ) ) { continue ; } if ( sscanf ( value , "cpu%d " , & cpunr ) != 1 ) { continue ; } if ( cpunr > ret ) { ret = cpunr ; } } fclose ( fp ) ; return ret + 1 ; } 