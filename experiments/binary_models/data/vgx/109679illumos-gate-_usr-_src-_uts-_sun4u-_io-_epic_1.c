static int epic_attach ( dev_info_t * dip , ddi_attach_cmd_t cmd ) { int inst ; struct epic_softc * softc = NULL ; int minor ; char name [ MAXNAMELEN ] ; ddi_device_acc_attr_t dev_attr ; int res ; switch ( cmd ) { case DDI_ATTACH : inst = ddi_get_instance ( dip ) ; ( void ) sprintf ( name , "env-monitor%d" , inst ) ; minor = inst ; if ( ddi_create_minor_node ( dip , name , S_IFCHR , minor , DDI_PSEUDO , 0 ) == DDI_FAILURE ) { cmn_err ( CE_WARN , "ddi_create_minor_node() failed for inst %d\n" , inst ) ; return ( DDI_FAILURE ) ; } if ( ddi_soft_state_zalloc ( statep , inst ) != DDI_SUCCESS ) { cmn_err ( CE_WARN , " ddi_soft_state_zalloc() failed " "for inst %d\n" , inst ) ; break ; } if ( ( softc = getsoftc ( inst ) ) == NULL ) { break ; } softc -> dip = dip ; mutex_init ( & softc -> mutex , MUTEX_DRIVER , NULL ) ; dev_attr . devacc_attr_version = DDI_DEVICE_ATTR_V0 ; dev_attr . devacc_attr_endian_flags = DDI_STRUCTURE_LE_ACC ; dev_attr . devacc_attr_dataorder = DDI_STRICTORDER_ACC ; res = ddi_regs_map_setup ( dip , 0 , ( caddr_t * ) & softc -> cmd_reg , EPIC_REGS_OFFSET , EPIC_REGS_LEN , & dev_attr , & softc -> cmd_handle ) ; if ( res != DDI_SUCCESS ) { cmn_err ( CE_WARN , "ddi_regs_map_setup() failed\n" ) ; break ; } ddi_report_dev ( dip ) ; return ( DDI_SUCCESS ) ; case DDI_RESUME : return ( DDI_SUCCESS ) ; default : return ( DDI_FAILURE ) ; } if ( softc ) { ddi_soft_state_free ( statep , inst ) ; } ddi_remove_minor_node ( dip , NULL ) ; return ( DDI_FAILURE ) ; } 