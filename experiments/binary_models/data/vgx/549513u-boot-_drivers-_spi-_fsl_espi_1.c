void espi_setup_slave ( struct fsl_spi_slave * fsl ) { unsigned int max_hz ; sys_info_t sysinfo ; unsigned long spibrg = 0 ; cfs_time_t spi_freq = 0 ; unsigned char pm = 0 ; max_hz = fsl -> speed_hz ; get_sys_info ( & sysinfo ) ; spibrg = sysinfo . freq_systembus / 2 ; fsl -> div16 = 0 ; if ( ( spibrg / max_hz ) > 32 ) { fsl -> div16 = ESPI_CSMODE_DIV16 ; pm = spibrg / ( max_hz * 16 * 2 ) ; if ( pm > 16 ) { pm = 16 ; debug ( "max_hz is too low: %d Hz, %ld Hz is used.\n" , max_hz , spibrg / ( 32 * 16 ) ) ; } } else { pm = spibrg / ( max_hz * 2 ) ; } if ( pm ) { pm -- ; } fsl -> pm = pm ; if ( fsl -> div16 ) { spi_freq = spibrg / ( ( pm + 1 ) * 2 * 16 ) ; } else { spi_freq = spibrg / ( ( pm + 1 ) * 2 ) ; } fsl -> tx_timeout = DIV_ROUND_UP ( ( US_PER_SECOND * ESPI_FIFO_WIDTH_BIT * 10 ) , spi_freq ) ; } 