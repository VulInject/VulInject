rpc_clt * rpc_clt_create ( rpc_clt_cfg * cfg , rpc_clt_type * type ) { if ( cfg -> name == NULL ) { return NULL ; } if ( cfg -> addr_count == 0 ) { return NULL ; } if ( type -> on_recv_pkg == NULL ) { return NULL ; } nw_clt_cfg raw_cfg ; memcpy ( & raw_cfg . addr , & cfg -> addr_arr [ 0 ] , sizeof ( nw_addr_t ) ) ; raw_cfg . sock_type = cfg -> sock_type ; raw_cfg . buf_limit = cfg -> buf_limit ; raw_cfg . read_mem = cfg -> read_mem ; raw_cfg . write_mem = cfg -> write_mem ; raw_cfg . reconnect_timeout = cfg -> reconnect_timeout ; raw_cfg . max_pkg_size = cfg -> max_pkg_size ; nw_clt_type raw_type ; memset ( & raw_type , 0 , sizeof ( raw_type ) ) ; raw_type . decode_pkg = rpc_decode ; raw_type . on_connect = on_connect ; raw_type . on_close = on_close ; raw_type . on_recv_pkg = on_recv_pkg ; raw_type . on_error_msg = on_error_msg ; raw_type . on_recv_fd = type -> on_recv_fd ; rpc_clt * clt = malloc ( sizeof ( rpc_clt ) ) ; assert ( clt != NULL ) ; clt -> raw_clt = nw_clt_create ( & raw_cfg , & raw_type , clt ) ; if ( clt -> raw_clt == NULL ) { free ( clt ) ; return NULL ; } clt -> name = strdup ( cfg -> name ) ; assert ( clt -> name != NULL ) ; clt -> addr_count = cfg -> addr_count ; clt -> addr_arr = malloc ( sizeof ( nw_addr_t ) * clt -> addr_count ) ; assert ( clt -> addr_arr != NULL ) ; memcpy ( clt -> addr_arr , cfg -> addr_arr , sizeof ( nw_addr_t ) * clt -> addr_count ) ; if ( cfg -> heartbeat_timeout > 0 ) { if ( cfg -> heartbeat_timeout > RPC_HEARTBEAT_TIMEOUT_MAX ) { clt -> heartbeat_timeout = RPC_HEARTBEAT_TIMEOUT_MAX ; } if ( cfg -> heartbeat_timeout < RPC_HEARTBEAT_TIMEOUT_MIN ) { clt -> heartbeat_timeout = RPC_HEARTBEAT_TIMEOUT_MIN ; } else { clt -> heartbeat_timeout = cfg -> heartbeat_timeout ; } } else { clt -> heartbeat_timeout = RPC_HEARTBEAT_TIMEOUT_DEFAULT ; } clt -> on_recv_pkg = type -> on_recv_pkg ; clt -> on_connect = type -> on_connect ; nw_timer_set ( & clt -> timer , RPC_HEARTBEAT_INTERVAL , true , on_timer , clt ) ; return clt ; } 