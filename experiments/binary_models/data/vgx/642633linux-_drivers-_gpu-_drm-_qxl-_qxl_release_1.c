static int qxl_release_alloc ( struct qxl_device * qdev , int type , struct qxl_release * * ret ) { struct qxl_release * release ; int handle ; size_t size = sizeof ( * release ) ; release = kmalloc ( size , GFP_KERNEL ) ; if ( ! release ) { DRM_ERROR ( "Out of memory\n" ) ; return - ENOMEM ; } release -> base . ops = NULL ; release -> type = type ; release -> release_offset = 0 ; INIT_LIST_HEAD ( & release -> bos ) ; idr_preload ( GFP_KERNEL ) ; spin_lock ( & qdev -> release_idr_lock ) ; handle = idr_alloc ( & qdev -> release_idr , release , 1 , 0 , GFP_NOWAIT ) ; release -> base . seqno = ++ qdev -> release_seqno ; spin_unlock ( & qdev -> release_idr_lock ) ; idr_preload_end ( ) ; if ( handle < 0 ) { kfree ( release ) ; * ret = NULL ; return handle ; } * ret = release ; DRM_DEBUG_DRIVER ( "allocated release %d\n" , handle ) ; release -> id = handle ; return handle ; } 