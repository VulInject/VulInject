static int populate_DiskVirtualDeviceBean ( JNIEnv * env , zpool_handle_t * zhp , nvlist_t * vdev , uint64_t * p_vdev_id , DiskVirtualDeviceBean_t * bean ) { char * path ; int result = populate_LeafVirtualDeviceBean ( env , zhp , vdev , p_vdev_id , ( LeafVirtualDeviceBean_t * ) bean ) ; if ( result ) { return ( - 1 ) ; } result = nvlist_lookup_string ( vdev , ZPOOL_CONFIG_PATH , & path ) ; if ( result != 0 ) { zjni_throw_exception ( env , "could not retrieve path from disk virtual device " "(pool %s)" , zpool_get_name ( zhp ) ) ; } else { regex_t re ; regmatch_t matches [ 2 ] ; jstring pathUTF = NULL ; if ( regcomp ( & re , "^(/dev/dsk/.*)s[0-9]+$" , REG_EXTENDED ) == 0 ) { if ( regexec ( & re , path , 2 , matches , 0 ) == 0 ) { regmatch_t * match = matches + 1 ; if ( match -> rm_so != - 1 && match -> rm_eo != - 1 ) { char * tmp = strdup ( path ) ; if ( tmp != NULL ) { char * end = tmp + match -> rm_eo ; * end = '\0' ; pathUTF = ( * env ) -> NewStringUTF ( env , tmp ) ; } } } regfree ( & re ) ; } if ( regcomp ( & re , "^(/dev/dsk/.*)s[0-9]+/old$" , REG_EXTENDED ) == 0 ) { if ( regexec ( & re , path , 2 , matches , 0 ) == 0 ) { regmatch_t * match = matches + 1 ; if ( match -> rm_so != - 1 && match -> rm_eo != - 1 ) { char * tmp = strdup ( path ) ; if ( tmp != NULL ) { ( void ) strcpy ( tmp + match -> rm_eo , "/old" ) ; pathUTF = ( * env ) -> NewStringUTF ( env , tmp ) ; free ( tmp ) ; } } } regfree ( & re ) ; } if ( pathUTF == NULL ) { pathUTF = ( * env ) -> NewStringUTF ( env , path ) ; } ( * env ) -> CallVoidMethod ( env , ( ( zjni_Object_t * ) bean ) -> object , ( ( LeafVirtualDeviceBean_t * ) bean ) -> method_setName , pathUTF ) ; } return ( result != 0 ) ; } 