static int adc_jack_probe ( struct platform_device * pdev ) { struct adc_jack_data * data ; struct adc_jack_pdata * pdata = dev_get_platdata ( & pdev -> dev ) ; int i , err ; data = devm_kzalloc ( & pdev -> dev , sizeof ( * data ) , GFP_KERNEL ) ; if ( ! data ) { return - ENOMEM ; } if ( ! pdata -> cable_names ) { dev_err ( & pdev -> dev , "error: cable_names not defined.\n" ) ; return - EINVAL ; } data -> dev = & pdev -> dev ; data -> edev = devm_extcon_dev_allocate ( & pdev -> dev , pdata -> cable_names ) ; if ( IS_ERR ( data -> edev ) ) { dev_err ( & pdev -> dev , "failed to allocate extcon device\n" ) ; return - ENOMEM ; } if ( ! pdata -> adc_conditions ) { dev_err ( & pdev -> dev , "error: adc_conditions not defined.\n" ) ; return - EINVAL ; } data -> adc_conditions = pdata -> adc_conditions ; for ( i = 0 ; data -> adc_conditions [ i ] . id != EXTCON_NONE ; i ++ ) { } data -> num_conditions = i ; data -> chan = devm_iio_channel_get ( & pdev -> dev , pdata -> consumer_channel ) ; if ( IS_ERR ( data -> chan ) ) { return PTR_ERR ( data -> chan ) ; } data -> handling_delay = msecs_to_jiffies ( pdata -> handling_delay_ms ) ; data -> wakeup_source = pdata -> wakeup_source ; INIT_DEFERRABLE_WORK ( & data -> handler , adc_jack_handler ) ; platform_set_drvdata ( pdev , data ) ; err = devm_extcon_dev_register ( & pdev -> dev , data -> edev ) ; if ( err ) { return err ; } data -> irq = platform_get_irq ( pdev , 0 ) ; if ( data -> irq < 0 ) { return - ENODEV ; } err = request_any_context_irq ( data -> irq , adc_jack_irq_thread , pdata -> irq_flags , pdata -> name , data ) ; if ( err < 0 ) { dev_err ( & pdev -> dev , "error: irq %d\n" , data -> irq ) ; return err ; } if ( data -> wakeup_source ) { device_init_wakeup ( & pdev -> dev , 1 ) ; } adc_jack_handler ( & data -> handler . work ) ; return 0 ; } 