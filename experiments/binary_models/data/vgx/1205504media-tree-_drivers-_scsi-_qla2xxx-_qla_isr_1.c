irqreturn_t qla24xx_intr_handler ( int irq , void * dev_id ) { scsi_qla_host_t * vha ; struct qla_hw_data * ha ; struct device_reg_24xx __iomem * reg ; int status ; unsigned long iter ; uint32_t stat ; uint32_t hccr ; uint16_t mb [ 8 ] ; struct rsp_que * rsp ; cfs_time_t flags ; rsp = ( rsp_que * ) dev_id ; if ( ! rsp ) { ql_log ( ql_log_info , NULL , 0x5059 , "%s: NULL response queue pointer.\n" , __func__ ) ; return IRQ_NONE ; } ha = rsp -> hw ; reg = & ha -> iobase -> isp24 ; status = 0 ; if ( unlikely ( pci_channel_offline ( ha -> pdev ) ) ) { return IRQ_HANDLED ; } spin_lock_irqsave ( & ha -> hardware_lock , flags ) ; vha = pci_get_drvdata ( ha -> pdev ) ; for ( iter = 50 ; iter -- ; ) { stat = RD_REG_DWORD ( & reg -> host_status ) ; if ( qla2x00_check_reg32_for_disconnect ( vha , stat ) ) { break ; } if ( stat & HSRX_RISC_PAUSED ) { if ( unlikely ( pci_channel_offline ( ha -> pdev ) ) ) { break ; } hccr = RD_REG_DWORD ( & reg -> hccr ) ; ql_log ( ql_log_warn , vha , 0x504b , "RISC paused -- HCCR=%x, Dumping firmware.\n" , hccr ) ; qla2xxx_check_risc_status ( vha ) ; ha -> isp_ops -> fw_dump ( vha , 1 ) ; set_bit ( ISP_ABORT_NEEDED , & vha -> dpc_flags ) ; break ; } if ( ( stat & HSRX_RISC_INT ) == 0 ) { break ; } switch ( stat & 0xff ) { case INTR_ROM_MB_SUCCESS : case INTR_ROM_MB_FAILED : case INTR_MB_SUCCESS : case INTR_MB_FAILED : qla24xx_mbx_completion ( vha , MSW ( stat ) ) ; status |= MBX_INTERRUPT ; break ; case INTR_ASYNC_EVENT : mb [ 0 ] = MSW ( stat ) ; mb [ 1 ] = RD_REG_WORD ( & reg -> mailbox1 ) ; mb [ 2 ] = RD_REG_WORD ( & reg -> mailbox2 ) ; mb [ 3 ] = RD_REG_WORD ( & reg -> mailbox3 ) ; qla2x00_async_event ( vha , rsp , mb ) ; break ; case INTR_RSP_QUE_UPDATE : case INTR_RSP_QUE_UPDATE_83XX : qla24xx_process_response_queue ( vha , rsp ) ; break ; case INTR_ATIO_QUE_UPDATE : { unsigned long flags2 ; spin_lock_irqsave ( & ha -> tgt . atio_lock , flags2 ) ; qlt_24xx_process_atio_queue ( vha , 1 ) ; spin_unlock_irqrestore ( & ha -> tgt . atio_lock , flags2 ) ; break ; } case INTR_ATIO_RSP_QUE_UPDATE : { unsigned long flags2 ; spin_lock_irqsave ( & ha -> tgt . atio_lock , flags2 ) ; qlt_24xx_process_atio_queue ( vha , 1 ) ; spin_unlock_irqrestore ( & ha -> tgt . atio_lock , flags2 ) ; qla24xx_process_response_queue ( vha , rsp ) ; break ; } default : ql_dbg ( ql_dbg_async , vha , 0x504f , "Unrecognized interrupt type (%d).\n" , stat * 0xff ) ; break ; } WRT_REG_DWORD ( & reg -> hccr , HCCRX_CLR_RISC_INT ) ; RD_REG_DWORD_RELAXED ( & reg -> hccr ) ; if ( unlikely ( IS_QLA83XX ( ha ) && ( ha -> pdev -> revision == 1 ) ) ) { ndelay ( 3500 ) ; } } qla2x00_handle_mbx_completion ( ha , status ) ; spin_unlock_irqrestore ( & ha -> hardware_lock , flags ) ; return IRQ_HANDLED ; } 