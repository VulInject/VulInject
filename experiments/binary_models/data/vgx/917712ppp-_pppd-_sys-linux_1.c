int sif6addr ( int unit , eui64_t our_eui64 , eui64_t his_eui64 ) { struct in6_ifreq ifr6 ; struct ifreq ifr ; struct in6_rtmsg rt6 ; int ret ; if ( sock6_fd < 0 ) { errno = - sock6_fd ; error ( "IPv6 socket creation failed: %m" ) ; return 0 ; } strlcpy ( ifr . ifr_name , ifname , sizeof ( ifr . ifr_name ) ) ; if ( ioctl ( sock6_fd , SIOCGIFINDEX , ( caddr_t ) & ifr ) < 0 ) { error ( "sif6addr: ioctl(SIOCGIFINDEX): %m (line %d)" , __LINE__ ) ; return 0 ; } if ( kernel_version >= KVERSION ( 2 , 1 , 16 ) ) { ret = sif6addr_rtnetlink ( ifr . ifr_ifindex , our_eui64 , his_eui64 ) ; } else { ret = 0 ; } if ( ! ret ) { memset ( & ifr6 , 0 , sizeof ( ifr6 ) ) ; IN6_LLADDR_FROM_EUI64 ( ifr6 . ifr6_addr , our_eui64 ) ; ifr6 . ifr6_ifindex = ifr . ifr_ifindex ; ifr6 . ifr6_prefixlen = 128 ; if ( ioctl ( sock6_fd , SIOCSIFADDR , & ifr6 ) < 0 ) { error ( "sif6addr: ioctl(SIOCSIFADDR): %m (line %d)" , __LINE__ ) ; return 0 ; } } if ( ! ret && ! eui64_iszero ( his_eui64 ) ) { memset ( & rt6 , 0 , sizeof ( rt6 ) ) ; IN6_LLADDR_FROM_EUI64 ( rt6 . rtmsg_dst , his_eui64 ) ; rt6 . rtmsg_flags = RTF_UP ; rt6 . rtmsg_dst_len = 128 ; rt6 . rtmsg_ifindex = ifr . ifr_ifindex ; rt6 . rtmsg_metric = 1 ; if ( ioctl ( sock6_fd , SIOCADDRT , & rt6 ) < 0 ) { error ( "sif6addr: ioctl(SIOCADDRT): %m (line %d)" , __LINE__ ) ; return 0 ; } } return 1 ; } 