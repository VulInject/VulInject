elf_locate_base ( ) { struct bfd_section * dyninfo_sect ; int dyninfo_sect_size ; CORE_ADDR dyninfo_addr , relocated_dyninfo_addr , entry_addr ; char * buf ; char * bufend ; int arch_size ; if ( target_auxv_search ( & current_target , AT_ENTRY , & entry_addr ) != 1 ) { entry_addr = bfd_get_start_address ( exec_bfd ) ; } dyninfo_sect = bfd_get_section_by_name ( exec_bfd , ".dynamic" ) ; dyninfo_addr = bfd_section_vma ( exec_bfd , dyninfo_sect ) ; relocated_dyninfo_addr = dyninfo_addr + entry_addr - bfd_get_start_address ( exec_bfd ) ; dyninfo_sect_size = bfd_section_size ( exec_bfd , dyninfo_sect ) ; buf = alloca ( dyninfo_sect_size ) ; if ( target_read_memory ( relocated_dyninfo_addr , buf , dyninfo_sect_size ) ) { return 0 ; } arch_size = bfd_get_arch_size ( exec_bfd ) ; if ( arch_size == - 1 ) { return 0 ; } if ( arch_size == 32 ) { for ( bufend = buf + dyninfo_sect_size ; buf < bufend ; buf += sizeof ( Elf32_External_Dyn ) ) { Elf32_External_Dyn * x_dynp = ( Elf32_External_Dyn * ) buf ; long dyn_tag ; CORE_ADDR dyn_ptr ; dyn_tag = bfd_h_get_32 ( exec_bfd , ( bfd_byte * ) x_dynp -> d_tag ) ; if ( dyn_tag == DT_NULL ) { break ; } if ( dyn_tag == DT_DEBUG ) { dyn_ptr = bfd_h_get_32 ( exec_bfd , ( bfd_byte * ) x_dynp -> d_un . d_ptr ) ; return dyn_ptr ; } if ( dyn_tag == DT_MIPS_RLD_MAP ) { char * pbuf ; int pbuf_size = TARGET_PTR_BIT / HOST_CHAR_BIT ; pbuf = alloca ( pbuf_size ) ; dyn_ptr = bfd_h_get_32 ( exec_bfd , ( bfd_byte * ) x_dynp -> d_un . d_ptr ) ; if ( target_read_memory ( dyn_ptr , pbuf , pbuf_size ) ) { return 0 ; } return extract_unsigned_integer ( pbuf , pbuf_size ) ; } } } else { char * bufstart = buf ; for ( bufend = buf + dyninfo_sect_size ; buf < bufend ; buf += sizeof ( Elf64_External_Dyn ) ) { Elf64_External_Dyn * x_dynp = ( Elf64_External_Dyn * ) buf ; long dyn_tag ; CORE_ADDR dyn_ptr ; dyn_tag = bfd_h_get_64 ( exec_bfd , ( bfd_byte * ) x_dynp -> d_tag ) ; if ( dyn_tag == DT_NULL ) { break ; } if ( dyn_tag == DT_DEBUG ) { dyn_ptr = bfd_h_get_64 ( exec_bfd , ( bfd_byte * ) x_dynp -> d_un . d_ptr ) ; return dyn_ptr ; } if ( dyn_tag == DT_MIPS_RLD_MAP || dyn_tag == DT_MIPS_RLD_MAP_REL ) { char * pbuf ; int pbuf_size = TARGET_PTR_BIT / HOST_CHAR_BIT ; pbuf = alloca ( pbuf_size ) ; dyn_ptr = bfd_h_get_64 ( exec_bfd , ( bfd_byte * ) x_dynp -> d_un . d_ptr ) ; if ( dyn_tag == DT_MIPS_RLD_MAP_REL ) { dyn_ptr += ( relocated_dyninfo_addr + ( buf - bufstart ) ) ; } if ( target_read_memory ( dyn_ptr , pbuf , pbuf_size ) ) { return 0 ; } return extract_unsigned_integer ( pbuf , pbuf_size ) ; } } } return 0 ; } 