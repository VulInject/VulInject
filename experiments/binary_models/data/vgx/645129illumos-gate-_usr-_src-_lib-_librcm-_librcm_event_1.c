int create_event_service ( char * door_name , void * func ( void * * data , size_t * datalen ) ) { int service_door , fd ; door_cookie_t * cookie ; fd = open ( door_name , O_EXCL | O_CREAT , S_IREAD | S_IWRITE ) ; if ( ( fd == - 1 ) && ( errno != EEXIST ) ) { return ( - 1 ) ; } ( void ) close ( fd ) ; if ( ( cookie = calloc ( 1 , sizeof ( * cookie ) ) ) == NULL ) { return ( - 1 ) ; } cookie -> door_func = func ; if ( ( service_door = door_create ( door_service , ( void * ) cookie , DOOR_REFUSE_DESC | DOOR_NO_CANCEL ) ) == - 1 ) { dprint ( "door create failed: %s\n" , strerror ( errno ) ) ; return ( - 1 ) ; } retry ( void ) fdetach ( door_name ) ; if ( fattach ( service_door , door_name ) != 0 ) { if ( errno == EBUSY ) { retry } dprint ( "door attaching failed: %s\n" , strerror ( errno ) ) ; free ( cookie ) ; ( void ) close ( service_door ) ; return ( - 1 ) ; } return ( service_door ) ; } 