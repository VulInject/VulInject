static int wait_for_bit_change ( void __iomem * reg , int bitnum , int value ) { cfs_time_t timeout ; ktime_t wait ; int t ; t = 100 ; while ( t -- > 0 ) { if ( FLD_GET ( readl_relaxed ( reg ) , bitnum , bitnum ) == value ) { return value ; } } timeout = jiffies + msecs_to_jiffies ( 500 ) ; while ( time_before ( jiffies , timeout ) ) { if ( FLD_GET ( readl_relaxed ( reg ) , bitnum , bitnum ) == value ) { return value ; } wait = ns_to_ktime ( 1000 * 1000 ) ; set_current_state ( TASK_UNINTERRUPTIBLE ) ; schedule_hrtimeout ( & wait , HRTIMER_MODE_REL ) ; } return ! value ; } 