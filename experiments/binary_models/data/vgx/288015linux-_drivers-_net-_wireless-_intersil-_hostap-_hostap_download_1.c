static int prism2_download ( local_info_t * local , struct prism2_download_param * param ) { int ret = 0 ; int i ; u32 total_len = 0 ; struct prism2_download_data * dl = NULL ; printk ( KERN_DEBUG "prism2_download: dl_cmd=%d start_addr=0x%08x " "num_areas=%d\n" , param -> dl_cmd , param -> start_addr , param -> num_areas ) ; if ( param -> num_areas > 100 ) { ret = - EINVAL ; out } dl = kzalloc ( sizeof ( * dl ) + param -> num_areas * sizeof ( prism2_download_data_area ) , GFP_KERNEL ) ; if ( dl == NULL ) { ret = - ENOMEM ; out } dl -> dl_cmd = param -> dl_cmd ; dl -> start_addr = param -> start_addr ; dl -> num_areas = param -> num_areas ; for ( i = 0 ; i < param -> num_areas ; i ++ ) { PDEBUG ( DEBUG_EXTRA2 , "  area %d: addr=0x%08x len=%d ptr=0x%p\n" , i , param -> data [ i ] . addr , param -> data [ i ] . len , param -> data [ i ] . ptr ) ; dl -> data [ i ] . addr = param -> data [ i ] . addr ; dl -> data [ i ] . len = param -> data [ i ] . len ; total_len += param -> data [ i ] . len ; if ( param -> data [ i ] . len > PRISM2_MAX_DOWNLOAD_AREA_LEN || total_len > PRISM2_MAX_DOWNLOAD_LEN ) { ret = - E2BIG ; out } dl -> data [ i ] . data = kmalloc ( dl -> data [ i ] . len , GFP_KERNEL ) ; if ( dl -> data [ i ] . data == NULL ) { ret = - ENOMEM ; out } if ( copy_from_user ( dl -> data [ i ] . data , param -> data [ i ] . ptr , param -> data [ i ] . len ) ) { ret = - EFAULT ; out } } switch ( param -> dl_cmd ) { case PRISM2_DOWNLOAD_VOLATILE : case PRISM2_DOWNLOAD_VOLATILE_PERSISTENT : ret = prism2_download_volatile ( local , dl ) ; break ; case PRISM2_DOWNLOAD_VOLATILE_GENESIS : case PRISM2_DOWNLOAD_VOLATILE_GENESIS_PERSISTENT : ret = prism2_download_genesis ( local , dl ) ; break ; case PRISM2_DOWNLOAD_NON_VOLATILE : ret = prism2_download_nonvolatile ( local , dl ) ; printk ( KERN_INFO "%s: non-volatile downloading not enabled\n" , local -> dev -> name ) ; ret = - EOPNOTSUPP ; break ; default : printk ( KERN_DEBUG "%s: unsupported download command %d\n" , local -> dev -> name , param -> dl_cmd ) ; ret = - EINVAL ; break ; } out if ( ret == 0 && dl && param -> dl_cmd == PRISM2_DOWNLOAD_VOLATILE_GENESIS_PERSISTENT ) { local -> dl_pri = dl ; } if ( ret == 0 && dl && param -> dl_cmd == PRISM2_DOWNLOAD_VOLATILE_PERSISTENT ) { prism2_download_free_data ( local -> dl_sec ) ; local -> dl_sec = dl ; } else { prism2_download_free_data ( dl ) ; } return ret ; } 