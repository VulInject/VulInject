static int create_fill_widget_route_map ( struct snd_soc_dapm_context * dapm ) { struct snd_soc_dapm_widget * widgets ; struct snd_soc_dapm_route * route ; struct hdac_ext_device * edev = to_hda_ext_device ( dapm -> dev ) ; struct hdac_hdmi_priv * hdmi = edev -> private_data ; struct snd_soc_dai_driver * dai_drv = dapm -> component -> dai_drv ; char widget_name [ NAME_SIZE ] ; struct hdac_hdmi_cvt * cvt ; struct hdac_hdmi_pin * pin ; int ret , i = 0 , num_routes = 0 , j ; if ( list_empty ( & hdmi -> cvt_list ) || list_empty ( & hdmi -> pin_list ) ) { return - EINVAL ; } widgets = devm_kzalloc ( dapm -> dev , ( sizeof ( * widgets ) * ( ( 2 * hdmi -> num_ports ) + hdmi -> num_cvt ) ) , GFP_KERNEL ) ; list_for_each_entry ( , , ) { sprintf ( widget_name , "Converter %d" , cvt -> nid ) ; ret = hdac_hdmi_fill_widget_info ( dapm -> dev , & widgets [ i ] , snd_soc_dapm_aif_in , cvt , widget_name , dai_drv [ i ] . playback . stream_name , NULL , 0 , hdac_hdmi_cvt_output_widget_event , SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD ) ; if ( ret < 0 ) { return ret ; } i ++ ; } list_for_each_entry ( , , ) { for ( j = 0 ; j < pin -> num_ports ; j ++ ) { sprintf ( widget_name , "hif%d-%d Output" , pin -> nid , pin -> ports [ j ] . id ) ; ret = hdac_hdmi_fill_widget_info ( dapm -> dev , & widgets [ i ] , snd_soc_dapm_output , & pin -> ports [ j ] , widget_name , NULL , NULL , 0 , hdac_hdmi_pin_output_widget_event , SND_SOC_DAPM_PRE_PMU | SND_SOC_DAPM_POST_PMD ) ; if ( ret < 0 ) { return ret ; } pin -> ports [ j ] . output_pin = widgets [ i ] . name ; i ++ ; } } list_for_each_entry ( , , ) { for ( j = 0 ; j < pin -> num_ports ; j ++ ) { sprintf ( widget_name , "Pin%d-Port%d Mux" , pin -> nid , pin -> ports [ j ] . id ) ; ret = hdac_hdmi_create_pin_port_muxs ( edev , & pin -> ports [ j ] , & widgets [ i ] , widget_name ) ; if ( ret < 0 ) { return ret ; } i ++ ; num_routes += hdmi -> num_cvt ; num_routes ++ ; } } route = devm_kzalloc ( dapm -> dev , ( sizeof ( * route ) * num_routes ) , GFP_KERNEL ) ; if ( ! route ) { return - ENOMEM ; } i = 0 ; list_for_each_entry ( , , ) { for ( j = 0 ; j < pin -> num_ports ; j ++ ) { int sink_index = i + hdmi -> num_cvt ; int src_index = sink_index + pin -> num_ports * hdmi -> num_pin ; hdac_hdmi_fill_route ( & route [ i ] , widgets [ sink_index ] . name , NULL , widgets [ src_index ] . name , NULL ) ; i ++ ; } } hdac_hdmi_add_pinmux_cvt_route ( edev , widgets , route , i ) ; snd_soc_dapm_new_controls ( dapm , widgets , ( ( 2 * hdmi -> num_ports ) + hdmi -> num_cvt ) ) ; snd_soc_dapm_add_routes ( dapm , route , num_routes ) ; snd_soc_dapm_new_widgets ( dapm -> card ) ; return 0 ; } 