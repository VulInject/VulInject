void mpfiic_i2c_scan ( struct device * self , struct i2cbus_attach_args * iba , void * arg ) { struct i2c_attach_args ia ; char status [ 32 ] ; char * compat ; uint32_t reg [ 1 ] ; int iba_node = * ( int * ) arg ; int len , node ; for ( node = OF_child ( iba_node ) ; node != 0 ; node = OF_peer ( node ) ) { memset ( status , 0 , sizeof ( status ) ) ; if ( OF_getprop ( node , "status" , status , sizeof ( status ) ) > 0 && strcmp ( status , "disabled" ) == 0 ) { continue ; } memset ( reg , 0 , sizeof ( reg ) ) ; if ( OF_getprop ( node , "reg" , & reg , sizeof ( reg ) ) != sizeof ( reg ) ) { continue ; } len = OF_getproplen ( node , "compatible" ) ; if ( len <= 0 ) { continue ; } compat = malloc ( len , M_TEMP , M_WAITOK ) ; OF_getprop ( node , "compatible" , compat , len ) ; ia . ia_tag = iba -> iba_tag ; ia . ia_addr = bemtoh32 ( & reg [ 0 ] ) ; ia . ia_name = compat ; ia . ia_namelen = len ; ia . ia_cookie = & node ; config_found ( self , & ia , iic_print ) ; free ( compat , M_TEMP , len ) ; } } 