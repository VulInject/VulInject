static void xilinx_cdma_start_transfer ( struct xilinx_dma_chan * chan ) { struct xilinx_dma_tx_descriptor * head_desc , * tail_desc ; struct xilinx_cdma_tx_segment * tail_segment ; u32 ctrl_reg = dma_read ( chan , XILINX_DMA_REG_DMACR ) ; if ( chan -> err ) { return ; } if ( list_empty ( & chan -> pending_list ) ) { return ; } head_desc = list_first_entry ( & chan -> pending_list , xilinx_dma_tx_descriptor , node ) ; tail_desc = list_last_entry ( & chan -> pending_list , xilinx_dma_tx_descriptor , node ) ; tail_segment = list_last_entry ( & tail_desc -> segments , xilinx_cdma_tx_segment , node ) ; if ( chan -> desc_pendingcount <= XILINX_DMA_COALESCE_MAX ) { ctrl_reg &= ~ XILINX_DMA_CR_COALESCE_MAX ; ctrl_reg |= chan -> desc_pendingcount << XILINX_DMA_CR_COALESCE_SHIFT ; dma_ctrl_write ( chan , XILINX_DMA_REG_DMACR , ctrl_reg ) ; } if ( chan -> has_sg ) { dma_ctrl_clr ( chan , XILINX_DMA_REG_DMACR , XILINX_CDMA_CR_SGMODE ) ; dma_ctrl_set ( chan , XILINX_DMA_REG_DMACR , XILINX_CDMA_CR_SGMODE ) ; xilinx_write ( chan , XILINX_DMA_REG_CURDESC , head_desc -> async_tx . phys ) ; xilinx_write ( chan , XILINX_DMA_REG_TAILDESC , tail_segment -> phys ) ; } else { struct xilinx_cdma_tx_segment * segment ; struct xilinx_cdma_desc_hw * hw ; segment = list_first_entry ( & head_desc -> segments , xilinx_cdma_tx_segment , node ) ; hw = & segment -> hw ; xilinx_write ( chan , XILINX_CDMA_REG_SRCADDR , xilinx_prep_dma_addr_t ( hw -> src_addr ) ) ; xilinx_write ( chan , XILINX_CDMA_REG_DSTADDR , xilinx_prep_dma_addr_t ( hw -> dest_addr ) ) ; dma_ctrl_write ( chan , XILINX_DMA_REG_BTT , hw -> control & chan -> xdev -> max_buffer_len ) ; } list_splice_tail_init ( & chan -> pending_list , & chan -> active_list ) ; chan -> desc_pendingcount = 0 ; chan -> idle = false ; } 