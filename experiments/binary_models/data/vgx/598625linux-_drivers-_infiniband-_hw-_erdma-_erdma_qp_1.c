static int fill_inline_data ( struct erdma_qp * qp , const struct ib_send_wr * send_wr , u16 wqe_idx , u32 sgl_offset , __le32 * length_field ) { u32 remain_size , copy_size , data_off , bytes = 0 ; char * data ; int i = 0 ; wqe_idx += ( sgl_offset >> SQEBB_SHIFT ) ; sgl_offset &= ( SQEBB_SIZE - 1 ) ; data = get_queue_entry ( qp -> kern_qp . sq_buf , wqe_idx , qp -> attrs . sq_size , SQEBB_SHIFT ) ; while ( i < send_wr -> num_sge ) { bytes += send_wr -> sg_list [ i ] . length ; remain_size = send_wr -> sg_list [ i ] . length ; data_off = 0 ; while ( 1 ) { copy_size = min ( remain_size , SQEBB_SIZE - sgl_offset ) ; memcpy ( data + sgl_offset , ( void * ) ( uintptr_t ) send_wr -> sg_list [ i ] . addr + data_off , copy_size ) ; remain_size -= copy_size ; data_off += copy_size ; sgl_offset += copy_size ; wqe_idx += ( sgl_offset >> SQEBB_SHIFT ) ; sgl_offset &= ( SQEBB_SIZE - 1 ) ; data = get_queue_entry ( qp -> kern_qp . sq_buf , wqe_idx , qp -> attrs . sq_size , SQEBB_SHIFT ) ; if ( ! remain_size ) { break ; } } i ++ ; } * length_field = cpu_to_le32 ( bytes ) ; return bytes ; } 