static void doall ( void ) static void doit ( char * ) static void * do_one ( void * ) static void usage ( void ) static mutex_t tty = DEFAULTMUTEX ; static char who [ 9 ] "???" ; ; static char * path ; static mutex_t thr_mtx = DEFAULTMUTEX ; static int thread_count = 8 ; static int qflag = 0 ; int main ( int argc , char * argv [ ] ) { int msize ; char buf [ BUFSIZ + 1 ] ; int i ; char hostname [ 256 ] ; int hflag ; struct rlimit rl ; if ( argc < 2 ) { usage ( ) ; } if ( getrlimit ( RLIMIT_NOFILE , & rl ) == 0 ) { rl . rlim_cur = ( rl . rlim_max < MAX_THREADS ?rl . rlim_max : MAX_THREADS ) ; ( void ) setrlimit ( RLIMIT_NOFILE , & rl ) ; ( void ) enable_extended_FILE_stdio ( - 1 , - 1 ) ; } ( void ) gethostname ( hostname , sizeof ( hostname ) ) ; init_who ( ) ; msize = snprintf ( buf , sizeof ( buf ) , "From %s@%s:  " , who , hostname ) ; while ( ( i = getchar ( ) ) != EOF ) { if ( msize >= ( sizeof ( buf ) - 1 ) ) { ( void ) fprintf ( stderr , "Message too long\n" ) ; exit ( 1 ) ; } buf [ msize ++ ] = i ; } buf [ msize ] = '\0' ; path = buf ; hflag = 1 ; while ( argc > 1 ) { if ( argv [ 1 ] [ 0 ] == '-' ) { switch ( argv [ 1 ] [ 1 ] ) { case 'h' : hflag = 1 ; break ; case 'n' : hflag = 0 ; break ; case 'q' : qflag = 1 ; break ; default : usage ( ) ; break ; } argc -- ; argv ++ ; continue ; } if ( hflag ) { doit ( argv [ 1 ] ) ; } else { char * machine , * user , * domain ; ( void ) setnetgrent ( argv [ 1 ] ) ; while ( getnetgrent ( & machine , & user , & domain ) ) { if ( machine ) { doit ( machine ) ; } else { doall ( ) ; } } ( void ) endnetgrent ( ) ; } argc -- ; argv ++ ; } thr_exit ( NULL , NULL ) ; return ( 0 ) ; } 