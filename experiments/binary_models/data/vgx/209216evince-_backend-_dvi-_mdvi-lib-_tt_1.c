static int tt_really_load_font ( DviParams * params , DviFont * font , FTInfo * info ) { DviFontChar * ch ; TFMChar * ptr ; Int32 z , alpha , beta ; int i ; FTInfo * old ; TT_Error status ; double point_size ; static int warned = 0 ; TT_CharMap cmap ; TT_Face_Properties props ; int map_found ; DEBUG ( ( DBG_TT , "(tt) really_load_font(%s)\n" , info -> fontname ) ) ; point_size = ( double ) font -> scale / ( params -> tfm_conv * 0x100000 ) ; point_size = 72.0 * point_size / 72.27 ; if ( info -> loaded ) { TT_Set_Instance_Resolutions ( info -> instance , params -> dpi , params -> vdpi ) ; TT_Set_Instance_CharSize ( info -> instance , FROUND ( point_size * 64 ) ) ; return 0 ; } DEBUG ( ( DBG_TT , "(tt) loading new face `%s'\n" , info -> fontname ) ) ; status = TT_Open_Face ( tt_handle , font -> filename , & info -> face ) ; if ( status ) { mdvi_warning ( _ ( "(tt) %s: could not load face: %s\n" ) , info -> fontname , TT_ErrToString18 ( status ) ) ; return - 1 ; } status = TT_New_Instance ( info -> face , & info -> instance ) ; if ( status ) { mdvi_warning ( _ ( "(tt) %s: could not create face: %s\n" ) , info -> fontname , TT_ErrToString18 ( status ) ) ; TT_Close_Face ( info -> face ) ; return - 1 ; } status = TT_New_Glyph ( info -> face , & info -> glyph ) ; if ( status ) { mdvi_warning ( _ ( "(tt) %s: could not create glyph: %s\n" ) , info -> fontname , TT_ErrToString18 ( status ) ) ; tt_error } TT_Get_Face_Properties ( info -> face , & props ) ; map_found = - 1 ; for ( i = 0 ; map_found < 0 && i < props . num_CharMaps ; i ++ ) { TT_UShort pid , eid ; TT_Get_CharMap_ID ( info -> face , i , & pid , & eid ) ; switch ( pid ) { case TT_PLATFORM_APPLE_UNICODE : map_found = i ; break ; case TT_PLATFORM_ISO : if ( eid == TT_ISO_ID_7BIT_ASCII || eid == TT_ISO_ID_8859_1 ) { map_found = 1 ; } break ; case TT_PLATFORM_MICROSOFT : if ( eid == TT_MS_ID_UNICODE_CS ) { map_found = 1 ; } break ; } } if ( map_found < 0 ) { mdvi_warning ( _ ( "(tt) %s: no acceptable map found, using #0\n" ) , info -> fontname ) ; map_found = 0 ; } DEBUG ( ( DBG_TT , "(tt) %s: using charmap #%d\n" , info -> fontname , map_found ) ) ; TT_Get_CharMap ( info -> face , map_found , & cmap ) ; DEBUG ( ( DBG_TT , "(tt) %s: Set_Char_Size(%.2f, %d, %d)\n" , font -> fontname , point_size , font -> hdpi , font -> vdpi ) ) ; status = TT_Set_Instance_Resolutions ( info -> instance , params -> dpi , params -> vdpi ) ; if ( status ) { error ( _ ( "(tt) %s: could not set resolution: %s\n" ) , info -> fontname , TT_ErrToString18 ( status ) ) ; tt_error } status = TT_Set_Instance_CharSize ( info -> instance , FROUND ( point_size * 64 ) ) ; if ( status ) { error ( _ ( "(tt) %s: could not set point size: %s\n" ) , info -> fontname , TT_ErrToString18 ( status ) ) ; tt_error } status = mdvi_query_fontmap ( & info -> mapinfo , info -> fontname ) ; if ( ! status && info -> mapinfo . encoding ) { info -> encoding = mdvi_request_encoding ( info -> mapinfo . encoding ) ; } else { info -> encoding = NULL ; } if ( info -> encoding != NULL ) { TT_Post post ; status = TT_Load_PS_Names ( info -> face , & post ) ; if ( status ) { mdvi_warning ( _ ( "(tt) %s: could not load PS name table\n" ) , info -> fontname ) ; mdvi_release_encoding ( info -> encoding , 0 ) ; info -> encoding = NULL ; } } info -> tfminfo = get_font_metrics ( info -> fontname , info -> fmftype , info -> fmfname ) ; if ( info -> tfminfo == NULL ) { mdvi_warning ( "(tt) %s: no metrics data, font ignored\n" , info -> fontname ) ; tt_error } font -> design = info -> tfminfo -> design ; get_tfm_chars ( params , font , info -> tfminfo , 0 ) ; if ( info -> encoding ) { tt_encode_font ( font , info ) ; } else { mdvi_warning ( _ ( "%s: no encoding vector found, expect bad output\n" ) , info -> fontname ) ; for ( i = font -> loc ; i <= font -> hic ; i ++ ) { font -> chars [ i - font -> loc ] . code = TT_Char_Index ( cmap , i ) ; } } info -> loaded = 1 ; info -> hasmetrics = 1 ; return 0 ; tt_error tt_font_remove ( info ) ; mdvi_free ( font -> chars ) ; font -> chars = NULL ; font -> loc = font -> hic = 0 ; return - 1 ; } 