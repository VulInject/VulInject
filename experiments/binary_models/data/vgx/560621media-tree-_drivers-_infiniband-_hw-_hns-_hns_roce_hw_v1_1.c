static int hns_roce_raq_init ( struct hns_roce_dev * hr_dev ) { int ret ; int raq_shift = 0 ; dma_addr_t addr ; u32 val ; struct hns_roce_v1_priv * priv ; struct hns_roce_raq_table * raq ; struct device * dev = & hr_dev -> pdev -> dev ; priv = ( hns_roce_v1_priv * ) hr_dev -> hw -> priv ; raq = & priv -> raq_table ; raq -> e_raq_buf = kmalloc ( sizeof ( * ( raq -> e_raq_buf ) ) , GFP_KERNEL ) ; if ( ! raq -> e_raq_buf ) { return - ENOMEM ; } raq -> e_raq_buf -> buf = dma_alloc_coherent ( dev , HNS_ROCE_V1_RAQ_SIZE , & addr , GFP_KERNEL ) ; if ( ! raq -> e_raq_buf -> buf ) { ret = - ENOMEM ; err_dma_alloc_raq } raq -> e_raq_buf -> map = addr ; roce_write ( hr_dev , ROCEE_EXT_RAQ_REG , raq -> e_raq_buf -> map >> 12 ) ; raq_shift = ilog2 ( HNS_ROCE_V1_RAQ_SIZE / HNS_ROCE_V1_RAQ_ENTRY ) ; val = roce_read ( hr_dev , ROCEE_EXT_RAQ_H_REG ) ; roce_set_field ( val , ROCEE_EXT_RAQ_H_EXT_RAQ_SHIFT_M , ROCEE_EXT_RAQ_H_EXT_RAQ_SHIFT_S , raq_shift ) ; roce_set_field ( val , ROCEE_EXT_RAQ_H_EXT_RAQ_BA_H_M , ROCEE_EXT_RAQ_H_EXT_RAQ_BA_H_S , raq -> e_raq_buf -> map >> 44 ) ; roce_write ( hr_dev , ROCEE_EXT_RAQ_H_REG , val ) ; dev_dbg ( dev , "Configure raq_shift 0x%x.\n" , val ) ; val = roce_read ( hr_dev , ROCEE_RAQ_WL_REG ) ; roce_set_field ( val , ROCEE_RAQ_WL_ROCEE_RAQ_WL_M , ROCEE_RAQ_WL_ROCEE_RAQ_WL_S , HNS_ROCE_V1_EXT_RAQ_WF ) ; roce_write ( hr_dev , ROCEE_RAQ_WL_REG , val ) ; dev_dbg ( dev , "Configure raq_wl 0x%x.\n" , val ) ; val = roce_read ( hr_dev , ROCEE_WRMS_POL_TIME_INTERVAL_REG ) ; roce_set_field ( val , ROCEE_WRMS_POL_TIME_INTERVAL_WRMS_POL_TIME_INTERVAL_M , ROCEE_WRMS_POL_TIME_INTERVAL_WRMS_POL_TIME_INTERVAL_S , POL_TIME_INTERVAL_VAL ) ; roce_set_bit ( val , ROCEE_WRMS_POL_TIME_INTERVAL_WRMS_EXT_RAQ_MODE , 1 ) ; roce_set_field ( val , ROCEE_WRMS_POL_TIME_INTERVAL_WRMS_RAQ_TIMEOUT_CHK_CFG_M , ROCEE_WRMS_POL_TIME_INTERVAL_WRMS_RAQ_TIMEOUT_CHK_CFG_S , 2 ) ; roce_set_bit ( val , ROCEE_WRMS_POL_TIME_INTERVAL_WRMS_RAQ_TIMEOUT_CHK_EN_S , 1 ) ; roce_write ( hr_dev , ROCEE_WRMS_POL_TIME_INTERVAL_REG , val ) ; dev_dbg ( dev , "Configure WrmsPolTimeInterval 0x%x.\n" , val ) ; val = roce_read ( hr_dev , ROCEE_GLB_CFG_REG ) ; roce_set_bit ( val , ROCEE_GLB_CFG_TRP_RAQ_DROP_EN_S , 1 ) ; roce_write ( hr_dev , ROCEE_GLB_CFG_REG , val ) ; dev_dbg ( dev , "Configure GlbCfg = 0x%x.\n" , val ) ; return 0 ; err_dma_alloc_raq kfree ( raq -> e_raq_buf ) ; return ret ; } 