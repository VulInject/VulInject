int sock_copy_user_timeval ( struct __kernel_sock_timeval * tv , sockptr_t optval , int optlen , bool old_timeval ) { if ( old_timeval && in_compat_syscall ( ) && ! COMPAT_USE_64BIT_TIME ) { struct old_timeval32 tv32 ; if ( optlen < sizeof ( tv32 ) ) { return - EINVAL ; } tv -> tv_sec = tv32 . tv_sec ; tv -> tv_usec = tv32 . tv_usec ; } if ( old_timeval ) { struct __kernel_old_timeval old_tv ; if ( optlen < sizeof ( old_tv ) ) { return - EINVAL ; } if ( copy_from_sockptr ( & old_tv , optval , sizeof ( old_tv ) ) ) { return - EFAULT ; } tv -> tv_sec = old_tv . tv_sec ; tv -> tv_usec = old_tv . tv_usec ; } else { if ( optlen < sizeof ( * tv ) ) { return - EINVAL ; } if ( copy_from_sockptr ( tv , optval , sizeof ( * tv ) ) ) { return - EFAULT ; } } return 0 ; } 