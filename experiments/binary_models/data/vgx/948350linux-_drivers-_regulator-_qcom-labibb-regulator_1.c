static int qcom_labibb_set_ocp ( struct regulator_dev * rdev , int lim , int severity , bool enable ) { struct labibb_regulator * vreg = rdev_get_drvdata ( rdev ) ; char * ocp_irq_name ; u32 irq_flags = IRQF_ONESHOT ; int irq_trig_low , ret ; if ( lim || severity != REGULATOR_SEVERITY_PROT || ! enable ) { return - EINVAL ; } if ( vreg -> ocp_irq <= 0 ) { return - EINVAL ; } ocp_irq_name = devm_kasprintf ( vreg -> dev , GFP_KERNEL , "%s-over-current" , vreg -> desc . name ) ; switch ( vreg -> type ) { case QCOM_LAB_TYPE : irq_flags |= IRQF_TRIGGER_LOW ; irq_trig_low = 1 ; break ; case QCOM_IBB_TYPE : irq_flags |= IRQF_TRIGGER_HIGH ; irq_trig_low = 0 ; break ; default : return - EINVAL ; } ret = regmap_update_bits ( rdev -> regmap , vreg -> base + REG_LABIBB_INT_SET_TYPE , LABIBB_INT_VREG_OK , LABIBB_INT_VREG_TYPE_LEVEL ) ; if ( ret ) { return ret ; } ret = regmap_update_bits ( rdev -> regmap , vreg -> base + REG_LABIBB_INT_POLARITY_HIGH , LABIBB_INT_VREG_OK , ! irq_trig_low ) ; if ( ret ) { return ret ; } ret = regmap_update_bits ( rdev -> regmap , vreg -> base + REG_LABIBB_INT_POLARITY_LOW , LABIBB_INT_VREG_OK , irq_trig_low ) ; if ( ret ) { return ret ; } ret = qcom_labibb_ocp_hw_enable ( rdev ) ; if ( ret ) { return ret ; } return devm_request_threaded_irq ( vreg -> dev , vreg -> ocp_irq , NULL , qcom_labibb_ocp_isr , irq_flags , ocp_irq_name , vreg ) ; } 