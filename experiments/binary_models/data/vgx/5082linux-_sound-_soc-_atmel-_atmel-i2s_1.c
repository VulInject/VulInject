static int atmel_i2s_trigger ( struct snd_pcm_substream * substream , int cmd , struct snd_soc_dai * dai ) { struct atmel_i2s_dev * dev = snd_soc_dai_get_drvdata ( dai ) ; bool is_playback = ( substream -> stream == SNDRV_PCM_STREAM_PLAYBACK ) ; bool is_master , mck_enabled ; unsigned int cr , mr ; int err ; switch ( cmd ) { case SNDRV_PCM_TRIGGER_START : case SNDRV_PCM_TRIGGER_RESUME : case SNDRV_PCM_TRIGGER_PAUSE_RELEASE : cr = is_playback ?ATMEL_I2SC_CR_TXEN : ATMEL_I2SC_CR_RXEN ; mck_enabled = true ; break ; case SNDRV_PCM_TRIGGER_STOP : case SNDRV_PCM_TRIGGER_SUSPEND : case SNDRV_PCM_TRIGGER_PAUSE_PUSH : cr = is_playback ?ATMEL_I2SC_CR_TXDIS : ATMEL_I2SC_CR_RXDIS ; mck_enabled = false ; break ; default : return - EINVAL ; } err = regmap_read ( dev -> regmap , ATMEL_I2SC_MR , & mr ) ; is_master = ( mr & ATMEL_I2SC_MR_MODE_MASK ) == ATMEL_I2SC_MR_MODE_MASTER ; if ( is_master && mck_enabled ) { if ( ! dev -> clk_use_no ) { err = atmel_i2s_switch_mck_generator ( dev , true ) ; if ( err ) { return err ; } } dev -> clk_use_no ++ ; } err = regmap_write ( dev -> regmap , ATMEL_I2SC_CR , cr ) ; if ( err ) { return err ; } if ( is_master && ! mck_enabled ) { if ( dev -> clk_use_no == 1 ) { err = atmel_i2s_switch_mck_generator ( dev , false ) ; if ( err ) { return err ; } } dev -> clk_use_no -- ; } return err ; } 