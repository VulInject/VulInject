static char * _rl_compat_sub ( const char * str , const char * what , const char * with , int globally ) { const char * s ; char * r , * result ; size_t len , with_len , what_len ; len = strlen ( str , NULL ) ; with_len = strlen ( with ) ; what_len = strlen ( what ) ; s = str ; while ( * s ) { if ( * s == * what && ! strncmp ( s , what , what_len ) ) { len += with_len - what_len ; if ( ! globally ) { break ; } s += what_len ; } else { s ++ ; } } r = result = malloc ( len + 1 ) ; if ( result == NULL ) { return NULL ; } s = str ; while ( * s ) { if ( * s == * what && ! strncmp ( s , what , what_len ) ) { ( void ) strncpy ( r , with , with_len ) ; r += with_len ; s += what_len ; if ( ! globally ) { ( void ) strlcpy ( r , s , len ) ; return result ; } } else { * r ++ = * s ++ ; } } * r = '\0' ; return result ; } 