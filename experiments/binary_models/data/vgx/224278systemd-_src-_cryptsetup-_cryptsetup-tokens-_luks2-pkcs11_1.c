int parse_luks2_pkcs11_data ( struct crypt_device * cd , const char * json , char * * ret_uri , void * * ret_encrypted_key , size_t * ret_encrypted_key_size ) { int r ; size_t key_size ; _cleanup_free_ char * uri = NULL ; _cleanup_free_ void * key = NULL ; _cleanup_ ( ) JsonVariant * v = NULL ; JsonVariant * w ; assert ( json ) ; assert ( ret_uri ) ; assert ( ret_encrypted_key ) ; assert ( ret_encrypted_key_size ) ; r = json_parse ( json , 0 , & v , NULL , NULL ) ; if ( r < 0 ) { return r ; } w = json_variant_by_key ( v , "pkcs11-uri" ) ; uri = strdup ( json_variant_string ( w ) ) ; if ( ! uri ) { return - ENOMEM ; } w = json_variant_by_key ( v , "pkcs11-key" ) ; if ( ! w ) { return - EINVAL ; } r = unbase64mem ( json_variant_string ( w ) , SIZE_MAX , & key , & key_size ) ; if ( r < 0 ) { return crypt_log_debug_errno ( cd , r , "Failed to decode base64 encoded key: %m." ) ; } * ret_uri = TAKE_PTR ( uri ) ; * ret_encrypted_key = TAKE_PTR ( key ) ; * ret_encrypted_key_size = key_size ; return 0 ; } 