static int pmic_arb_read_cmd_unlocked ( struct spmi_controller * ctrl , u32 cmd , u32 offset , u8 sid , u16 addr , u8 * buf , size_t len ) { struct spmi_pmic_arb * pmic_arb = spmi_controller_get_drvdata ( ctrl ) ; u8 bc = len - 1 ; int rc ; pmic_arb_set_rd_cmd ( pmic_arb , offset + PMIC_ARB_CMD , cmd ) ; rc = pmic_arb_wait_for_done ( ctrl , pmic_arb -> rd_base , sid , addr , PMIC_ARB_CHANNEL_OBS ) ; pmic_arb_read_data ( pmic_arb , buf , offset + PMIC_ARB_RDATA0 , min_t ( u8 , bc , 3 ) ) ; if ( bc > 3 ) { pmic_arb_read_data ( pmic_arb , buf + 4 , offset + PMIC_ARB_RDATA1 , bc - 4 ) ; } return 0 ; } 