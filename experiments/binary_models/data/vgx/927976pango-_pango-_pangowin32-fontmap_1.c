get_family_nameA ( ) { HFONT hfont ; HFONT oldhfont ; struct name_header header ; struct name_record record ; gint unicode_ix = - 1 , mac_ix = - 1 , microsoft_ix = - 1 ; gint name_ix ; gchar * codeset ; gchar * string ; gchar * name ; gint i , l ; gsize nbytes ; l = strlen ( lfp -> lfFaceName ) ; for ( i = 0 ; i < l ; i ++ ) { if ( lfp -> lfFaceName [ i ] < ' ' || lfp -> lfFaceName [ i ] > '~' ) { break ; } } if ( i == l ) { return g_strdup ( lfp -> lfFaceName ) ; } if ( ( hfont = CreateFontIndirect ( lfp ) ) == NULL ) { fail0 } if ( ( oldhfont = SelectObject ( _pango_win32_hdc , hfont ) ) == NULL ) { fail1 } if ( ! _pango_win32_get_name_header ( _pango_win32_hdc , & header ) ) { fail2 } PING ( ( "%d name records" , header . num_records ) ) ; for ( i = 0 ; i < header . num_records ; i ++ ) { if ( ! _pango_win32_get_name_record ( _pango_win32_hdc , i , & record ) ) { fail2 } if ( ( record . name_id != 1 && record . name_id != 16 ) || record . string_length <= 0 ) { continue ; } PING ( ( "platform:%d encoding:%d language:%04x name_id:%d" , record . platform_id , record . encoding_id , record . language_id , record . name_id ) ) ; if ( record . platform_id == APPLE_UNICODE_PLATFORM_ID || record . platform_id == ISO_PLATFORM_ID ) { unicode_ix = i ; } if ( record . platform_id == MACINTOSH_PLATFORM_ID && record . encoding_id == 0 && record . language_id == 0 ) { mac_ix = i ; } if ( record . platform_id == MICROSOFT_PLATFORM_ID ) { if ( ( microsoft_ix == - 1 || PRIMARYLANGID ( record . language_id ) == LANG_ENGLISH ) && ( record . encoding_id == SYMBOL_ENCODING_ID || record . encoding_id == UNICODE_ENCODING_ID || record . encoding_id == UCS4_ENCODING_ID ) ) { microsoft_ix = i ; } } } if ( microsoft_ix >= 0 ) { name_ix = microsoft_ix ; } if ( mac_ix >= 0 ) { name_ix = mac_ix ; } if ( unicode_ix >= 0 ) { name_ix = unicode_ix ; } else { fail2 } if ( ! _pango_win32_get_name_record ( _pango_win32_hdc , name_ix , & record ) ) { fail2 } string = g_malloc ( record . string_length + 1 ) ; if ( GetFontData ( _pango_win32_hdc , NAME , header . string_storage_offset + record . string_offset , string , record . string_length ) != record . string_length ) { fail2 } string [ record . string_length ] = '\0' ; if ( name_ix == microsoft_ix ) { if ( record . encoding_id == SYMBOL_ENCODING_ID || record . encoding_id == UNICODE_ENCODING_ID || record . encoding_id == UCS4_ENCODING_ID ) { codeset = "UTF-16BE" ; } else { codeset = "UCS-4BE" ; } } if ( name_ix == mac_ix ) { codeset = "MacRoman" ; } else { codeset = "UCS-4BE" ; } name = g_convert ( string , record . string_length , "UTF-8" , codeset , NULL , & nbytes , NULL ) ; if ( name == NULL ) { fail2 } g_free ( string ) ; PING ( ( "%s" , name ) ) ; SelectObject ( _pango_win32_hdc , oldhfont ) ; DeleteObject ( hfont ) ; return name ; fail2 g_free ( string ) ; SelectObject ( _pango_win32_hdc , oldhfont ) ; fail1 DeleteObject ( hfont ) ; fail0 return g_locale_to_utf8 ( lfp -> lfFaceName , - 1 , NULL , NULL , NULL ) ; } 