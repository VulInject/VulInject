void ip_vs_nat_icmp_v6 ( struct sk_buff * skb , struct ip_vs_protocol * pp , struct ip_vs_conn * cp , int inout ) { struct ipv6hdr * iph = ipv6_hdr ( skb ) ; int icmp_offset = 0 ; unsigned int offs = 0 ; int protocol ; struct icmp6hdr * icmph ; struct ipv6hdr * ciph ; unsigned short fragoffs ; ipv6_find_hdr ( skb , & icmp_offset , IPPROTO_ICMPV6 , & fragoffs , NULL ) ; icmph = ( icmp6hdr * ) ( skb_network_header ( skb ) + icmp_offset ) ; offs = icmp_offset + sizeof ( icmp6hdr ) ; ciph = ( ipv6hdr * ) ( skb_network_header ( skb ) + offs ) ; protocol = ipv6_find_hdr ( skb , & offs , - 1 , & fragoffs , NULL ) ; if ( inout ) { iph -> saddr = cp -> vaddr . in6 ; ciph -> daddr = cp -> vaddr . in6 ; } else { iph -> daddr = cp -> daddr . in6 ; ciph -> saddr = cp -> daddr . in6 ; } if ( ! fragoffs && ( IPPROTO_TCP == protocol || IPPROTO_UDP == protocol || IPPROTO_SCTP == protocol ) ) { __be16 * ports = ( void * ) ( skb_network_header ( skb ) + offs ) ; IP_VS_DBG ( 11 , "%s() changed port %d to %d\n" , __func__ , ntohs ( inout ?ports [ 1 ] : ports [ 0 ] ) , ntohs ( inout ?cp -> vport : cp -> dport ) ) ; if ( inout ) { ports [ 1 ] = cp -> vport ; } else { ports [ 0 ] = cp -> dport ; } } icmph -> icmp6_cksum = ~ csum_ipv6_magic ( & iph -> saddr , & iph -> daddr , skb -> len - icmp_offset , IPPROTO_ICMPV6 , 0 ) ; skb -> csum_start = skb_network_header ( skb ) - skb -> head + icmp_offset ; skb -> csum_offset = offsetof ( icmp6hdr , icmp6_cksum ) ; skb -> ip_summed = CHECKSUM_PARTIAL ; if ( inout ) { IP_VS_DBG_PKT ( 11 , AF_INET6 , pp , skb , ( void * ) ciph - ( void * ) iph , "Forwarding altered outgoing ICMPv6" ) ; } else { IP_VS_DBG_PKT ( 11 , AF_INET6 , pp , skb , ( void * ) ciph - ( void * ) iph , "Forwarding altered incoming ICMPv6" ) ; } } 