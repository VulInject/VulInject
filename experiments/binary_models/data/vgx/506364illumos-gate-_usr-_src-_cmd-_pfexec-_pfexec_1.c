int main ( int argc , char * * argv ) { char * cmd ; char * pset ; char pathbuf [ MAXPATHLEN ] ; int c ; priv_set_t * wanted ; int oflag ; oflag = getpflags ( PRIV_PFEXEC ) ; if ( setpflags ( PRIV_PFEXEC , 1 ) != 0 ) { ( void ) fprintf ( stderr , gettext ( "pfexec: unable to set PFEXEC flag: %s\n" ) , strerror ( errno ) ) ; exit ( 1 ) ; } if ( * argv [ 0 ] == '-' ) { cmd = argv [ 0 ] + 1 ; } else { cmd = argv [ 0 ] ; } if ( strncmp ( cmd , "pf" , 2 ) == 0 ) { argv [ 0 ] += 2 ; if ( argv [ 0 ] [ - 2 ] == '-' ) { * argv [ 0 ] = '-' ; } } if ( shellname ( getexecname ( ) , pathbuf ) == RES_OK ) { ( void ) execv ( pathbuf , argv ) ; } switch ( shellname ( cmd , pathbuf ) ) { case RES_OK : ( void ) execv ( pathbuf , argv ) ; ( void ) fprintf ( stderr , gettext ( "pfexec: unable to execute %s: %s\n" ) , pathbuf , strerror ( errno ) ) ; return ( 1 ) ; case RES_PFEXEC : case RES_FAILURE : while ( ( c = getopt ( argc , argv , "P:" ) ) != EOF ) { switch ( c ) { case 'P' : if ( pset == NULL ) { pset = optarg ; break ; } default : usage ( ) ; } } argc -= optind ; argv += optind ; if ( argc < 1 ) { usage ( ) ; } if ( pset != NULL ) { if ( ( wanted = priv_str_to_set ( pset , "," , NULL ) ) == NULL ) { ( void ) fprintf ( stderr , gettext ( "pfexec: error parsing " "privileges: %s\n" ) , strerror ( errno ) ) ; exit ( EXIT_FAILURE ) ; } if ( setppriv ( PRIV_ON , PRIV_INHERITABLE , wanted ) != 0 ) { ( void ) fprintf ( stderr , gettext ( "pfexec: error setting " "privileges: %s\n" ) , strerror ( errno ) ) ; exit ( EXIT_FAILURE ) ; } ( void ) setpflags ( PRIV_PFEXEC , oflag ) ; } ( void ) execvp ( argv [ 0 ] , argv ) ; ( void ) fprintf ( stderr , gettext ( "pfexec: unable to execute %s: %s\n" ) , argv [ 0 ] , strerror ( errno ) ) ; return ( 1 ) ; } return ( 1 ) ; } 