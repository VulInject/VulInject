int dsa_port_devlink_setup ( struct dsa_port * dp ) { struct devlink_port * dlp = & dp -> devlink_port ; struct dsa_switch_tree * dst = dp -> ds -> dst ; struct devlink_port_attrs attrs = { } ; struct devlink * dl = dp -> ds -> devlink ; struct dsa_switch * ds = dp -> ds ; const unsigned char * id ; unsigned char len ; int err ; memset ( dlp , 0 , sizeof ( * dlp ) ) ; devlink_port_init ( dl , dlp ) ; if ( ds -> ops -> port_setup ) { err = ds -> ops -> port_setup ( ds , dp -> index ) ; } id = ( const unsigned char * ) & dst -> index ; len = sizeof ( dst -> index ) ; attrs . phys . port_number = dp -> index ; memcpy ( attrs . switch_id . id , id , len ) ; attrs . switch_id . id_len = len ; switch ( dp -> type ) { case DSA_PORT_TYPE_UNUSED : attrs . flavour = DEVLINK_PORT_FLAVOUR_UNUSED ; break ; case DSA_PORT_TYPE_CPU : attrs . flavour = DEVLINK_PORT_FLAVOUR_CPU ; break ; case DSA_PORT_TYPE_DSA : attrs . flavour = DEVLINK_PORT_FLAVOUR_DSA ; break ; case DSA_PORT_TYPE_USER : attrs . flavour = DEVLINK_PORT_FLAVOUR_PHYSICAL ; break ; } devlink_port_attrs_set ( dlp , & attrs ) ; err = devlink_port_register ( dl , dlp , dp -> index ) ; if ( err ) { if ( ds -> ops -> port_teardown ) { ds -> ops -> port_teardown ( ds , dp -> index ) ; } return err ; } return 0 ; } 