int queue_message_fd_r ( uint32_t msgid ) { int fdin = - 1 , fdout = - 1 , fd = - 1 ; FILE * ifp = NULL ; FILE * ofp = NULL ; profile_enter ( "queue_message_fd_r" ) ; fdin = handler_message_fd_r ( msgid ) ; profile_leave ( ) ; log_trace ( TRACE_QUEUE , "queue-backend: queue_message_fd_r(%08" PRIx32 ") ->%d" , msgid , fdin ) ; if ( fdin == - 1 ) { return ( - 1 ) ; } if ( env -> sc_queue_flags & QUEUE_ENCRYPTION ) { if ( ( fdout = mktmpfile ( ) ) == - 1 ) { err } if ( ( fd = dup ( fdout ) ) == - 1 ) { err } if ( ( ifp = fdopen ( fdin , "r" ) ) == NULL ) { err } fdin = fd ; fd = - 1 ; if ( ( ofp = fdopen ( fdout , "w+" ) ) == NULL ) { err } if ( ! crypto_decrypt_file ( ifp , ofp ) ) { err } fclose ( ifp ) ; fclose ( ofp ) ; ofp = NULL ; lseek ( fdin , SEEK_SET , 0 ) ; } if ( env -> sc_queue_flags & QUEUE_COMPRESSION ) { if ( ( fdout = mktmpfile ( ) ) == - 1 ) { err } if ( ( fd = dup ( fdout ) ) == - 1 ) { err } if ( ( ifp = fdopen ( fdin , "r" ) ) == NULL ) { err } fdin = fd ; fd = - 1 ; if ( ( ofp = fdopen ( fdout , "w+" ) ) == NULL ) { err } if ( ! uncompress_file ( ifp , ofp ) ) { err } fclose ( ifp ) ; ifp = NULL ; fclose ( ofp ) ; ofp = NULL ; lseek ( fdin , SEEK_SET , 0 ) ; } return ( fdin ) ; err if ( fd != - 1 ) { close ( fd ) ; } if ( fdin != - 1 ) { close ( fdin ) ; } if ( fdout != - 1 ) { close ( fdout ) ; } if ( ifp ) { fclose ( ifp ) ; } if ( ofp ) { fclose ( ofp ) ; } return - 1 ; } 