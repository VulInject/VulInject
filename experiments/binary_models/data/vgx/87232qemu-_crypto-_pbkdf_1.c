uint64_t qcrypto_pbkdf2_count_iters ( QCryptoHashAlgorithm hash , const uint8_t * key , size_t nkey , const uint8_t * salt , size_t nsalt , size_t nout , Error * * errp ) { uint64_t ret = - 1 ; g_autofree uint8_t * out = g_new ( uint8_t , nout ) ; uint64_t iterations = ( 1 << 15 ) ; unsigned long long delta_ms , start_ms , end_ms ; while ( 1 ) { if ( qcrypto_pbkdf2_get_thread_cpu ( & start_ms , errp ) < 0 ) { cleanup } if ( qcrypto_pbkdf2 ( hash , key , nkey , salt , nsalt , iterations , out , nout , errp ) < 0 ) { cleanup } if ( qcrypto_pbkdf2_get_thread_cpu ( & end_ms , errp ) < 0 ) { cleanup } delta_ms = end_ms - start_ms ; if ( delta_ms > 500 ) { break ; } if ( delta_ms < 100 ) { iterations = iterations * 10 ; } else { iterations = ( iterations * 1000 / delta_ms ) ; } } iterations = iterations * 1000 / delta_ms ; ret = iterations ; cleanup return ret ; } 