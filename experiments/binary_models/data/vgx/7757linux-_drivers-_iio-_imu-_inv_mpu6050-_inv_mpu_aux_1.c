int inv_mpu_aux_read ( const struct inv_mpu6050_state * st , uint8_t addr , uint8_t reg , uint8_t * val , size_t size ) { int status ; int ret ; if ( size > 0x0F ) { return - EINVAL ; } ret = regmap_write ( st -> map , INV_MPU6050_REG_I2C_SLV_ADDR ( 0 ) , INV_MPU6050_BIT_I2C_SLV_RNW | addr ) ; if ( ret ) { return ret ; } ret = regmap_write ( st -> map , INV_MPU6050_REG_I2C_SLV_REG ( 0 ) , reg ) ; if ( ret ) { return ret ; } ret = regmap_write ( st -> map , INV_MPU6050_REG_I2C_SLV_CTRL ( 0 ) , INV_MPU6050_BIT_SLV_EN | size ) ; if ( ret ) { return ret ; } ret = inv_mpu_i2c_master_xfer ( st ) ; if ( ret ) { error_disable_i2c } ret = regmap_write ( st -> map , INV_MPU6050_REG_I2C_SLV_CTRL ( 0 ) , 0 ) ; if ( ret ) { error_disable_i2c } ret = regmap_read ( st -> map , INV_MPU6050_REG_I2C_MST_STATUS , & status ) ; if ( ret ) { return ret ; } if ( status & INV_MPU6050_BIT_I2C_SLV0_NACK ) { return - EIO ; } return regmap_bulk_read ( st -> map , INV_MPU6050_REG_EXT_SENS_DATA , val , size ) ; error_disable_i2c regmap_write ( st -> map , INV_MPU6050_REG_I2C_SLV_CTRL ( 0 ) , 0 ) ; return ret ; } 