int mlx5e_health_rsc_fmsg_dump ( struct mlx5e_priv * priv , struct mlx5_rsc_key * key , struct devlink_fmsg * fmsg ) { struct mlx5_core_dev * mdev = priv -> mdev ; struct mlx5_rsc_dump_cmd * cmd ; struct page * page ; int cmd_err , err ; int end_err ; int size ; if ( IS_ERR_OR_NULL ( mdev -> rsc_dump ) ) { return - EOPNOTSUPP ; } page = alloc_page ( GFP_KERNEL ) ; if ( ! page ) { return - ENOMEM ; } err = devlink_fmsg_binary_pair_nest_start ( fmsg , "data" ) ; if ( err ) { free_page } cmd = mlx5_rsc_dump_cmd_create ( mdev , key ) ; if ( IS_ERR ( cmd ) ) { err = PTR_ERR ( cmd ) ; free_page } { cmd_err = mlx5_rsc_dump_next ( mdev , cmd , page , & size ) ; if ( cmd_err < 0 ) { err = cmd_err ; destroy_cmd } err = mlx5e_health_rsc_fmsg_binary ( fmsg , page_address ( page ) , size ) ; if ( err ) { destroy_cmd } } cmd_err > 0 ; destroy_cmd mlx5_rsc_dump_cmd_destroy ( cmd ) ; end_err = devlink_fmsg_binary_pair_nest_end ( fmsg ) ; if ( end_err ) { err = end_err ; } free_page return err ; } 