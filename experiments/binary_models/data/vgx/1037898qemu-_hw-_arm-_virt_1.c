static bool virt_firmware_init ( VirtMachineState * vms , MemoryRegion * sysmem , MemoryRegion * secure_sysmem ) { int i ; const char * bios_name ; BlockBackend * pflash_blk0 ; for ( i = 0 ; i < ARRAY_SIZE ( vms -> flash ) ; i ++ ) { pflash_cfi01_legacy_drive ( vms -> flash [ i ] , drive_get ( IF_PFLASH , 0 , i ) ) ; } virt_flash_map ( vms , sysmem , secure_sysmem ) ; pflash_blk0 = pflash_cfi01_get_blk ( vms -> flash [ 0 ] ) ; bios_name = MACHINE ( vms ) -> firmware ; if ( bios_name ) { char * fname ; MemoryRegion * mr ; int image_size ; if ( pflash_blk0 ) { error_report ( "The contents of the first flash device may be " "specified with -bios or with -drive if=pflash... " "but you cannot use both options at once" ) ; exit ( 1 ) ; } fname = qemu_find_file ( QEMU_FILE_TYPE_BIOS , bios_name ) ; if ( ! fname ) { error_report ( "Could not find ROM image '%s'" , bios_name ) ; exit ( 1 ) ; } mr = sysbus_mmio_get_region ( SYS_BUS_DEVICE ( vms -> flash [ 0 ] ) , 0 ) ; image_size = load_image_mr ( fname , mr ) ; if ( image_size < 0 ) { error_report ( "Could not load ROM image '%s'" , bios_name ) ; exit ( 1 ) ; } } return pflash_blk0 || bios_name ; } 