void ure_rtl8153_init ( struct ure_softc * sc ) { uint16_t reg ; uint8_t u1u2 [ 8 ] ; int i ; ure_write_mem ( sc , URE_USB_TOLERANCE , URE_BYTE_EN_SIX_BYTES , u1u2 , sizeof ( u1u2 ) ) ; for ( i = 0 ; i < 500 ; i ++ ) { if ( ure_read_2 ( sc , URE_PLA_BOOT_CTRL , URE_MCU_TYPE_PLA ) & URE_AUTOLOAD_DONE ) { break ; } usbd_delay_ms ( sc -> ure_udev , 20 ) ; } if ( i == 500 ) { printf ( "%s: timeout waiting for chip autoload\n" , sc -> ure_dev . dv_xname ) ; } ure_rtl8153_phy_status ( sc , 0 ) ; if ( sc -> ure_chip & ( URE_CHIP_VER_5C00 | URE_CHIP_VER_5C10 | URE_CHIP_VER_5C20 ) ) { ure_ocp_reg_write ( sc , URE_OCP_ADC_CFG , URE_CKADSEL_L | URE_ADC_EN | URE_EN_EMI_L ) ; } ure_rtl8153_phy_status ( sc , URE_PHY_STAT_LAN_ON ) ; URE_CLRBIT_2 ( sc , URE_USB_U2P3_CTRL , URE_MCU_TYPE_USB , URE_U2P3_ENABLE ) ; if ( sc -> ure_chip & URE_CHIP_VER_5C10 ) { reg = ure_read_2 ( sc , URE_USB_SSPHYLINK2 , URE_MCU_TYPE_USB ) ; reg &= ~ URE_PWD_DN_SCALE_MASK ; reg |= URE_PWD_DN_SCALE ( 96 ) ; ure_write_2 ( sc , URE_USB_SSPHYLINK2 , URE_MCU_TYPE_USB , reg ) ; URE_SETBIT_1 ( sc , URE_USB_USB2PHY , URE_MCU_TYPE_USB , URE_USB2PHY_L1 | URE_USB2PHY_SUSPEND ) ; } if ( sc -> ure_chip & URE_CHIP_VER_5C20 ) { URE_CLRBIT_1 ( sc , URE_PLA_DMY_REG0 , URE_MCU_TYPE_PLA , URE_ECM_ALDPS ) ; } if ( sc -> ure_chip & ( URE_CHIP_VER_5C20 | URE_CHIP_VER_5C30 ) ) { if ( ure_read_2 ( sc , URE_USB_BURST_SIZE , URE_MCU_TYPE_USB ) ) { URE_SETBIT_1 ( sc , URE_USB_CSR_DUMMY1 , URE_MCU_TYPE_USB , URE_DYNAMIC_BURST ) ; } else { URE_CLRBIT_1 ( sc , URE_USB_CSR_DUMMY1 , URE_MCU_TYPE_USB , URE_DYNAMIC_BURST ) ; } } URE_SETBIT_1 ( sc , URE_USB_CSR_DUMMY2 , URE_MCU_TYPE_USB , URE_EP4_FULL_FC ) ; URE_CLRBIT_2 ( sc , URE_USB_WDT11_CTRL , URE_MCU_TYPE_USB , URE_TIMER11_EN ) ; URE_CLRBIT_2 ( sc , URE_PLA_LED_FEATURE , URE_MCU_TYPE_PLA , URE_LED_MODE_MASK ) ; if ( ( sc -> ure_chip & URE_CHIP_VER_5C10 ) && sc -> ure_udev -> speed != USB_SPEED_SUPER ) { reg = URE_LPM_TIMER_500MS ; } else { reg = URE_LPM_TIMER_500US ; } ure_write_1 ( sc , URE_USB_LPM_CTRL , URE_MCU_TYPE_USB , URE_FIFO_EMPTY_1FB | URE_ROK_EXIT_LPM | reg ) ; reg = ure_read_2 ( sc , URE_USB_AFE_CTRL2 , URE_MCU_TYPE_USB ) ; reg &= ~ URE_SEN_VAL_MASK ; reg |= URE_SEN_VAL_NORMAL | URE_SEL_RXIDLE ; ure_write_2 ( sc , URE_USB_AFE_CTRL2 , URE_MCU_TYPE_USB , reg ) ; ure_write_2 ( sc , URE_USB_CONNECT_TIMER , URE_MCU_TYPE_USB , 0x0001 ) ; URE_CLRBIT_2 ( sc , URE_USB_POWER_CUT , URE_MCU_TYPE_USB , URE_PWR_EN | URE_PHASE2_EN ) ; URE_CLRBIT_2 ( sc , URE_USB_MISC_0 , URE_MCU_TYPE_USB , URE_PCUT_STATUS ) ; memset ( u1u2 , 0xff , sizeof ( u1u2 ) ) ; ure_write_mem ( sc , URE_USB_TOLERANCE , URE_BYTE_EN_SIX_BYTES , u1u2 , sizeof ( u1u2 ) ) ; ure_write_2 ( sc , URE_PLA_MAC_PWR_CTRL , URE_MCU_TYPE_PLA , 0 ) ; ure_write_2 ( sc , URE_PLA_MAC_PWR_CTRL2 , URE_MCU_TYPE_PLA , 0 ) ; ure_write_2 ( sc , URE_PLA_MAC_PWR_CTRL3 , URE_MCU_TYPE_PLA , 0 ) ; ure_write_2 ( sc , URE_PLA_MAC_PWR_CTRL4 , URE_MCU_TYPE_PLA , 0 ) ; URE_CLRBIT_2 ( sc , URE_USB_USB_CTRL , URE_MCU_TYPE_USB , URE_RX_AGG_DISABLE | URE_RX_ZERO_EN ) ; URE_SETBIT_2 ( sc , URE_PLA_RSTTALLY , URE_MCU_TYPE_PLA , URE_TALLY_RESET ) ; } 