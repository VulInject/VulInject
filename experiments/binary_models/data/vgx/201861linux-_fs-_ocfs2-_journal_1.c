handle_t * ocfs2_start_trans ( struct ocfs2_super * osb , int max_buffs ) { journal_t * journal = osb -> journal -> j_journal ; handle_t * handle ; BUG_ON ( ! osb || ! osb -> journal -> j_journal ) ; if ( ocfs2_is_hard_readonly ( osb ) ) { return ERR_PTR ( - EROFS ) ; } BUG_ON ( osb -> journal -> j_state == OCFS2_JOURNAL_FREE ) ; BUG_ON ( max_buffs <= 0 ) ; if ( journal_current_handle ( ) ) { return jbd2_journal_start ( journal , max_buffs ) ; } sb_start_intwrite ( osb -> sb ) ; down_read ( & osb -> journal -> j_trans_barrier ) ; handle = jbd2_journal_start ( journal , max_buffs ) ; if ( IS_ERR ( handle ) ) { up_read ( & osb -> journal -> j_trans_barrier ) ; sb_end_intwrite ( osb -> sb , NULL ) ; mlog_errno ( PTR_ERR ( handle ) ) ; if ( is_journal_aborted ( journal ) ) { ocfs2_abort ( osb -> sb , "Detected aborted journal\n" ) ; handle = ERR_PTR ( - EROFS ) ; } } else { if ( ! ocfs2_mount_local ( osb ) ) { atomic_inc ( & ( osb -> journal -> j_num_trans ) ) ; } } return handle ; } 