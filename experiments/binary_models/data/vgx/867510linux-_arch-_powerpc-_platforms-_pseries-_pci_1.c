int pseries_root_bridge_prepare ( struct pci_host_bridge * bridge ) { struct device_node * dn , * pdn ; struct pci_bus * bus ; u32 pcie_link_speed_stats [ 2 ] ; int rc ; bus = bridge -> bus ; pci_set_host_bridge_release ( bridge , pcibios_free_controller_deferred , ( void * ) pci_bus_to_host ( bus ) ) ; dn = pcibios_get_phb_of_node ( bus ) ; if ( ! dn ) { return 0 ; } for ( pdn = dn ; pdn != NULL ; pdn = of_get_next_parent ( pdn ) ) { rc = of_property_read_u32_array ( pdn , "ibm,pcie-link-speed-stats" , & pcie_link_speed_stats [ 0 ] , 2 ) ; if ( ! rc ) { break ; } } of_node_put ( pdn ) ; if ( rc ) { pr_debug ( "no ibm,pcie-link-speed-stats property\n" ) ; return 0 ; } bus -> max_bus_speed = prop_to_pci_speed ( pcie_link_speed_stats [ 0 ] , NULL ) ; bus -> cur_bus_speed = prop_to_pci_speed ( pcie_link_speed_stats [ 1 ] ) ; return 0 ; } 