static int bcm53xxspi_bcma_probe ( struct bcma_device * core ) { struct device * dev = & core -> dev ; struct bcm53xxspi * b53spi ; struct spi_master * master ; int err ; if ( core -> bus -> drv_cc . core -> id . rev != 42 ) { pr_err ( "SPI on SoC with unsupported ChipCommon rev\n" ) ; return - ENOTSUPP ; } master = spi_alloc_master ( dev , sizeof ( * b53spi ) ) ; b53spi = spi_master_get_devdata ( master ) ; b53spi -> master = master ; b53spi -> core = core ; if ( core -> addr_s [ 0 ] ) { b53spi -> mmio_base = devm_ioremap ( dev , core -> addr_s [ 0 ] , BCM53XXSPI_FLASH_WINDOW ) ; } b53spi -> bspi = true ; bcm53xxspi_disable_bspi ( b53spi ) ; master -> dev . of_node = dev -> of_node ; master -> transfer_one = bcm53xxspi_transfer_one ; if ( b53spi -> mmio_base ) { master -> spi_flash_read = bcm53xxspi_flash_read ; } bcma_set_drvdata ( core , b53spi ) ; err = devm_spi_register_master ( dev , master ) ; if ( err ) { spi_master_put ( master ) ; bcma_set_drvdata ( core , NULL ) ; return err ; } return 0 ; } 