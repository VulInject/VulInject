static int dma_sb_unmap_area ( struct ps3_dma_region * r , dma_addr_t bus_addr , unsigned long len ) { unsigned long flags ; struct dma_chunk * c ; spin_lock_irqsave ( & r -> chunk_list . lock , flags ) ; c = dma_find_chunk ( r , bus_addr , len ) ; if ( ! c ) { cfs_time_t aligned_bus = _ALIGN_DOWN ( bus_addr , 1 << r -> page_size ) ; unsigned long aligned_len = _ALIGN_UP ( len + bus_addr - aligned_bus , 1 << r -> page_size ) ; DBG ( "%s:%d: not found: bus_addr %llxh\n" , __func__ , __LINE__ , bus_addr ) ; DBG ( "%s:%d: not found: len %lxh\n" , __func__ , __LINE__ , len ) ; DBG ( "%s:%d: not found: aligned_bus %lxh\n" , __func__ , __LINE__ , aligned_bus ) ; DBG ( "%s:%d: not found: aligned_len %lxh\n" , __func__ , __LINE__ , aligned_len ) ; BUG ( ) ; } c -> usage_count -- ; if ( ! c -> usage_count ) { list_del ( & c -> link ) ; dma_sb_free_chunk ( c ) ; } spin_unlock_irqrestore ( & r -> chunk_list . lock , flags ) ; return 0 ; } 