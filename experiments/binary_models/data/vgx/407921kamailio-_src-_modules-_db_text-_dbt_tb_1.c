int dbt_row_set_val ( dbt_row_p _drp , dbt_val_p _vp , int _t , int _idx ) { _drp -> fields [ _idx ] . nul = _vp -> nul ; _drp -> fields [ _idx ] . type = _t ; if ( ! _vp -> nul ) { switch ( _t ) { case DB1_STR : case DB1_BLOB : _drp -> fields [ _idx ] . type = _t ; _drp -> fields [ _idx ] . val . str_val . s = ( char * ) shm_malloc ( ( _vp -> val . str_val . len + 1 ) * sizeof ( char ) ) ; if ( ! _drp -> fields [ _idx ] . val . str_val . s ) { _drp -> fields [ _idx ] . nul = 1 ; return - 1 ; } memcpy ( _drp -> fields [ _idx ] . val . str_val . s , _vp -> val . str_val . s , _vp -> val . str_val . len ) ; _drp -> fields [ _idx ] . val . str_val . s [ _vp -> val . str_val . len ] = '\0' ; _drp -> fields [ _idx ] . val . str_val . len = _vp -> val . str_val . len ; break ; case DB1_STRING : _drp -> fields [ _idx ] . type = _t ; _drp -> fields [ _idx ] . val . str_val . len = _vp -> val . str_val . len ; _drp -> fields [ _idx ] . val . str_val . s = ( char * ) shm_malloc ( ( _drp -> fields [ _idx ] . val . str_val . len + 1 ) * sizeof ( char ) ) ; if ( ! _drp -> fields [ _idx ] . val . str_val . s ) { _drp -> fields [ _idx ] . nul = 1 ; return - 1 ; } memcpy ( _drp -> fields [ _idx ] . val . str_val . s , _vp -> val . string_val , _drp -> fields [ _idx ] . val . str_val . len ) ; _drp -> fields [ _idx ] . val . str_val . s [ _drp -> fields [ _idx ] . val . str_val . len ] = '\0' ; break ; case DB1_DOUBLE : _drp -> fields [ _idx ] . type = DB1_DOUBLE ; _drp -> fields [ _idx ] . val . double_val = _vp -> val . double_val ; break ; case DB1_INT : _drp -> fields [ _idx ] . type = DB1_INT ; _drp -> fields [ _idx ] . val . int_val = _vp -> val . int_val ; break ; case DB1_DATETIME : _drp -> fields [ _idx ] . type = _t ; _drp -> fields [ _idx ] . val . int_val = ( int ) _vp -> val . time_val ; break ; case DB1_BITMAP : _drp -> fields [ _idx ] . type = DB1_INT ; _drp -> fields [ _idx ] . val . int_val = ( int ) _vp -> val . bitmap_val ; break ; default : _drp -> fields [ _idx ] . nul = 1 ; return - 1 ; } } return 0 ; } 