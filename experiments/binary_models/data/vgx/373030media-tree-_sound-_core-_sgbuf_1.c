int snd_free_sgbuf_pages ( struct snd_dma_buffer * dmab ) { struct snd_sg_buf * sgbuf = dmab -> private_data ; struct snd_dma_buffer tmpb ; int i ; vunmap ( dmab -> area ) ; dmab -> area = NULL ; tmpb . dev . type = SNDRV_DMA_TYPE_DEV ; tmpb . dev . dev = sgbuf -> dev ; for ( i = 0 ; i < sgbuf -> pages ; i ++ ) { if ( ! ( sgbuf -> table [ i ] . addr & ~ PAGE_MASK ) ) { continue ; } tmpb . area = sgbuf -> table [ i ] . buf ; tmpb . addr = sgbuf -> table [ i ] . addr & PAGE_MASK ; tmpb . bytes = ( sgbuf -> table [ i ] . addr & ~ PAGE_MASK ) << PAGE_SHIFT ; snd_dma_free_pages ( & tmpb ) ; } kfree ( sgbuf -> table ) ; kfree ( sgbuf -> page_table ) ; kfree ( sgbuf ) ; dmab -> private_data = NULL ; return 0 ; } 