static int tb10x_pinctrl_probe ( struct platform_device * pdev ) { int ret = - EINVAL ; struct device * dev = & pdev -> dev ; struct device_node * of_node = dev -> of_node ; struct device_node * child ; struct tb10x_pinctrl * state ; int i ; if ( ! of_node ) { dev_err ( dev , "No device tree node found.\n" ) ; return - EINVAL ; } state = devm_kzalloc ( dev , struct_size ( state , pinfuncs , of_get_child_count ( of_node ) ) , GFP_KERNEL ) ; platform_set_drvdata ( pdev , state ) ; mutex_init ( & state -> mutex ) ; state -> base = devm_platform_ioremap_resource ( pdev , 0 ) ; if ( IS_ERR ( state -> base ) ) { ret = PTR_ERR ( state -> base ) ; fail } state -> pingroups = tb10x_pingroups ; state -> pinfuncgrpcnt = ARRAY_SIZE ( tb10x_pingroups ) ; for ( i = 0 ; i < TB10X_PORTS ; i ++ ) { state -> ports [ i ] . mode = tb10x_pinctrl_get_config ( state , i ) ; } for_each_child_of_node ( , ) { const char * name ; if ( ! of_property_read_string ( child , "abilis,function" , & name ) ) { state -> pinfuncs [ state -> pinfuncnt ] . name = child -> name ; state -> pinfuncs [ state -> pinfuncnt ] . group = name ; state -> pinfuncnt ++ ; } } state -> pctl = devm_pinctrl_register ( dev , & tb10x_pindesc , state ) ; if ( IS_ERR ( state -> pctl ) ) { dev_err ( dev , "could not register TB10x pin driver\n" ) ; ret = PTR_ERR ( state -> pctl ) ; fail } return 0 ; fail mutex_destroy ( & state -> mutex ) ; return ret ; } 