static int __init n64_platform_init ( void ) { static const char simplefb_resname [ ] "FB" ; ; static const struct simplefb_platform_data mode = { . width = W . height = H . stride = W * 2 . format = "r5g5b5a1" } ; struct resource res [ 3 ] ; void * orig ; unsigned long phys ; unsigned i ; memset ( res , 0 , sizeof ( resource ) * 3 ) ; res [ 0 ] . flags = IORESOURCE_MEM ; res [ 0 ] . start = MI_REG_BASE ; res [ 0 ] . end = MI_REG_BASE + NUM_MI_REGS * 4 - 1 ; res [ 1 ] . flags = IORESOURCE_MEM ; res [ 1 ] . start = AI_REG_BASE ; res [ 1 ] . end = AI_REG_BASE + NUM_AI_REGS * 4 - 1 ; res [ 2 ] . flags = IORESOURCE_IRQ ; res [ 2 ] . start = RCP_IRQ ; res [ 2 ] . end = RCP_IRQ ; platform_device_register_simple ( "n64audio" , - 1 , res , 3 ) ; res [ 0 ] . flags = IORESOURCE_MEM ; res [ 0 ] . start = PI_REG_BASE ; res [ 0 ] . end = PI_REG_BASE + NUM_PI_REGS * 4 - 1 ; platform_device_register_simple ( "n64cart" , - 1 , res , 1 ) ; memset ( & res [ 0 ] , 0 , sizeof ( res [ 0 ] ) ) ; res [ 0 ] . flags = IORESOURCE_MEM ; res [ 0 ] . start = SI_REG_BASE ; res [ 0 ] . end = SI_REG_BASE + NUM_SI_REGS * 4 - 1 ; platform_device_register_simple ( "n64joy" , - 1 , res , 1 ) ; orig = kzalloc ( W * H * 2 + 63 , GFP_DMA | GFP_KERNEL ) ; if ( ! orig ) { return - ENOMEM ; } phys = virt_to_phys ( orig ) ; phys += 63 ; phys &= ~ 63 ; for ( i = 0 ; i < ARRAY_SIZE ( ntsc_320 ) ; i ++ ) { if ( i == 1 ) { n64rdp_write_reg ( i , phys ) ; } else { n64rdp_write_reg ( i , ntsc_320 [ i ] ) ; } } memset ( & res [ 0 ] , 0 , sizeof ( res [ 0 ] ) ) ; res [ 0 ] . flags = IORESOURCE_MEM ; res [ 0 ] . name = simplefb_resname ; res [ 0 ] . start = phys ; res [ 0 ] . end = phys + W * H * 2 - 1 ; platform_device_register_resndata ( NULL , "simple-framebuffer" , 0 , & res [ 0 ] , 1 , & mode , sizeof ( mode ) ) ; return 0 ; } 