static void handle_msgin ( struct mesh_state * ms ) { int i , code ; struct scsi_cmnd * cmd = ms -> current_req ; struct mesh_target * tp = & ms -> tgts [ ms -> conn_tgt ] ; if ( ms -> n_msgin == 0 ) { return ; } code = ms -> msgin [ 0 ] ; if ( ALLOW_DEBUG ( ms -> conn_tgt ) ) { printk ( KERN_DEBUG "got %d message bytes:" , ms -> n_msgin ) ; for ( i = 0 ; i < ms -> n_msgin ; ++ i ) { printk ( " %x" , ms -> msgin [ i ] ) ; } printk ( "\n" ) ; } dlog ( ms , "msgin msg=%.8x" , MKWORD ( ms -> n_msgin , code , ms -> msgin [ 1 ] , ms -> msgin [ 2 ] ) ) ; ms -> expect_reply = 0 ; ms -> n_msgout = 0 ; if ( ms -> n_msgin < msgin_length ( ms ) ) { reject } if ( cmd ) { cmd -> SCp . Message = code ; } switch ( code ) { case COMMAND_COMPLETE : break ; case EXTENDED_MESSAGE : switch ( ms -> msgin [ 2 ] ) { case EXTENDED_MODIFY_DATA_POINTER : ms -> data_ptr += ( ms -> msgin [ 3 ] << 24 ) + ms -> msgin [ 6 ] + ( ms -> msgin [ 4 ] << 16 ) + ( ms -> msgin [ 5 ] << 8 ) ; break ; case EXTENDED_SDTR : if ( tp -> sdtr_state != sdtr_sent ) { add_sdtr_msg ( ms , NULL ) ; if ( ms -> msgout [ 3 ] < ms -> msgin [ 3 ] ) { ms -> msgout [ 3 ] = ms -> msgin [ 3 ] ; } if ( ms -> msgout [ 4 ] > ms -> msgin [ 4 ] ) { ms -> msgout [ 4 ] = ms -> msgin [ 4 ] ; } set_sdtr ( ms , ms -> msgout [ 3 ] , ms -> msgout [ 4 ] ) ; ms -> msgphase = msg_out ; } else { set_sdtr ( ms , ms -> msgin [ 3 ] , ms -> msgin [ 4 ] ) ; } break ; default : reject } break ; case SAVE_POINTERS : tp -> saved_ptr = ms -> data_ptr ; break ; case RESTORE_POINTERS : ms -> data_ptr = tp -> saved_ptr ; break ; case DISCONNECT : ms -> phase = disconnecting ; break ; case ABORT : break ; case MESSAGE_REJECT : if ( tp -> sdtr_state == sdtr_sent ) { set_sdtr ( ms , 0 , 0 ) ; } break ; case NOP : break ; default : if ( IDENTIFY_BASE <= code && code <= IDENTIFY_BASE + 7 ) { if ( cmd == NULL ) { do_abort ( ms ) ; ms -> msgphase = msg_out ; } if ( code != cmd -> device -> lun + IDENTIFY_BASE ) { printk ( KERN_WARNING "mesh: lun mismatch " "(%d != %llu) on reselection from " "target %d\n" , code - IDENTIFY_BASE , cmd -> device -> lun , ms -> conn_tgt ) ; } break ; } reject } return ; reject printk ( KERN_WARNING "mesh: rejecting message from target %d:" , ms -> conn_tgt ) ; for ( i = 0 ; i < ms -> n_msgin ; ++ i ) { printk ( " %x" , ms -> msgin [ i ] ) ; } printk ( "\n" ) ; ms -> msgout [ 0 ] = MESSAGE_REJECT ; ms -> n_msgout = 1 ; ms -> msgphase = msg_out ; } 