void GenerationFree ( void * pointer ) { MemoryChunk * chunk = PointerGetMemoryChunk ( pointer ) ; GenerationBlock * block ; GenerationContext * set ; || defined ( ) Size chunksize ; if ( MemoryChunkIsExternal ( chunk ) ) { block = ExternalChunkGetBlock ( chunk , NULL ) ; if ( ! GenerationBlockIsValid ( block ) ) { elog ( ERROR , "could not find block containing chunk %p" , chunk ) ; } || defined ( ) chunksize = block -> endptr - ( char * ) pointer ; } else { block = MemoryChunkGetBlock ( chunk ) ; Assert ( GenerationBlockIsValid ( block ) ) ; || defined ( ) chunksize = MemoryChunkGetValue ( chunk ) ; } VALGRIND_MAKE_MEM_DEFINED ( chunk , GENERATIONCHUNK_PRIVATE_LEN ) ; Assert ( chunk -> requested_size < chunksize ) ; if ( ! sentinel_ok ( pointer , chunk -> requested_size ) ) { elog ( WARNING , "detected write past chunk end in %s %p" , ( ( MemoryContext ) block -> context ) -> name , chunk ) ; } wipe_mem ( pointer , chunksize ) ; chunk -> requested_size = InvalidAllocSize ; block -> nfree += 1 ; Assert ( block -> nchunks > 0 ) ; Assert ( block -> nfree <= block -> nchunks ) ; if ( block -> nfree < block -> nchunks ) { return ; } set = block -> context ; if ( block == set -> keeper ) { GenerationBlockMarkEmpty ( block ) ; return ; } if ( set -> freeblock == NULL || set -> freeblock == block ) { set -> freeblock = block ; GenerationBlockMarkEmpty ( block ) ; return ; } if ( set -> block == block ) { set -> block = NULL ; } dlist_delete ( & block -> node ) ; set -> header . mem_allocated -= block -> blksize ; free ( block ) ; } 