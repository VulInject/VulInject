struct vfio_info_cap_header * vfio_info_cap_add ( struct vfio_info_cap * caps , size_t size , u16 id , u16 version ) { void * buf ; struct vfio_info_cap_header * header , * tmp ; buf = krealloc ( caps -> buf , caps -> size + size , GFP_KERNEL ) ; if ( ! buf ) { kfree ( caps -> buf ) ; caps -> buf = NULL ; caps -> size = 0 ; return ERR_PTR ( - ENOMEM ) ; } caps -> buf = buf ; header = buf + caps -> size ; header -> id = id ; header -> version = version ; for ( tmp = buf ; tmp -> next ; tmp = buf + tmp -> next ) { } tmp -> next = caps -> size ; caps -> size += size ; return header ; } 