static int do_lp_test ( struct hinic_dev * nic_dev , u32 flags , u32 test_time , enum diag_test_index * test_index ) { struct net_device * netdev = nic_dev -> netdev ; u8 * lb_test_rx_buf = NULL ; int err = 0 ; if ( ! ( flags & ETH_TEST_FL_EXTERNAL_LB ) ) { * test_index = INTERNAL_LP_TEST ; if ( hinic_set_loopback_mode ( nic_dev -> hwdev , HINIC_INTERNAL_LP_MODE , true ) ) { netif_err ( nic_dev , drv , netdev , "Failed to set port loopback mode before loopback test\n" ) ; return - EIO ; } } else { * test_index = EXTERNAL_LP_TEST ; } lb_test_rx_buf = vmalloc ( LP_PKT_CNT * LP_PKT_LEN ) ; if ( ! lb_test_rx_buf ) { err = - ENOMEM ; } else { nic_dev -> lb_test_rx_buf = lb_test_rx_buf ; nic_dev -> lb_pkt_len = LP_PKT_LEN ; nic_dev -> flags |= HINIC_LP_TEST ; err = hinic_run_lp_test ( nic_dev , test_time ) ; nic_dev -> flags &= ~ HINIC_LP_TEST ; msleep ( 100 ) ; vfree ( lb_test_rx_buf ) ; } if ( ! ( flags & ETH_TEST_FL_EXTERNAL_LB ) ) { if ( hinic_set_loopback_mode ( nic_dev -> hwdev , HINIC_INTERNAL_LP_MODE , false ) ) { netif_err ( nic_dev , drv , netdev , "Failed to cancel port loopback mode after loopback test\n" ) ; err = - EIO ; } } return err ; } 