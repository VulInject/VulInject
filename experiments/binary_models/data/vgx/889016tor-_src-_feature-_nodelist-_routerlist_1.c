was_router_added_t router_add_to_routerlist ( routerinfo_t * router , const char * * msg , int from_cache , int from_fetch ) { const char * id_digest ; const or_options_t * options = get_options ( ) ; int authdir = authdir_mode_handles_descs ( options , router -> purpose ) ; int authdir_believes_valid = 0 ; routerinfo_t * old_router ; networkstatus_t * consensus = networkstatus_get_latest_consensus_by_flavor ( FLAV_NS ) ; int in_consensus = 0 ; tor_assert ( msg ) ; if ( ! routerlist ) { router_get_routerlist ( ) ; } id_digest = router -> cache_info . identity_digest ; old_router = router_get_mutable_by_digest ( id_digest ) ; if ( router -> cert_expiration_time < approx_time ( ) ) { * msg = "Some certs on this router are expired." ; return ROUTER_CERTS_EXPIRED ; } if ( sdmap_get ( routerlist -> desc_digest_map , router -> cache_info . signed_descriptor_digest ) ) { const int was_bridge = old_router && old_router -> purpose == ROUTER_PURPOSE_BRIDGE ; if ( routerinfo_is_a_configured_bridge ( router ) && router -> purpose == ROUTER_PURPOSE_BRIDGE && ! was_bridge ) { log_info ( LD_DIR , "Replacing non-bridge descriptor with bridge " "descriptor for router %s" , router_describe ( router ) ) ; } else { if ( router -> purpose == ROUTER_PURPOSE_BRIDGE ) { learned_bridge_descriptor ( router , from_cache , 0 ) ; } log_info ( LD_DIR , "Dropping descriptor that we already have for router %s" , router_describe ( router ) ) ; * msg = "Router descriptor was not new." ; routerinfo_free ( router ) ; return ROUTER_IS_ALREADY_KNOWN ; } } if ( authdir ) { if ( authdir_wants_to_reject_router ( router , msg , ! from_cache && ! from_fetch , & authdir_believes_valid ) ) { tor_assert ( * msg ) ; routerinfo_free ( router ) ; return ROUTER_AUTHDIR_REJECTS ; } } if ( from_fetch ) { if ( ! signed_desc_digest_is_recognized ( & router -> cache_info ) && ! routerinfo_is_a_configured_bridge ( router ) ) { log_info ( LD_DIR , "Received a no-longer-recognized descriptor for router %s" , router_describe ( router ) ) ; * msg = "Router descriptor is not referenced by any network-status." ; if ( ! from_cache && should_cache_old_descriptors ( ) ) { signed_desc_append_to_journal ( & router -> cache_info , & routerlist -> desc_store ) ; } routerlist_insert_old ( routerlist , router ) ; return ROUTER_NOT_IN_CONSENSUS_OR_NETWORKSTATUS ; } } if ( consensus ) { routerstatus_t * rs = networkstatus_vote_find_mutable_entry ( consensus , id_digest ) ; if ( rs && tor_memeq ( rs -> descriptor_digest , router -> cache_info . signed_descriptor_digest , DIGEST_LEN ) ) { in_consensus = 1 ; } } if ( router -> purpose == ROUTER_PURPOSE_GENERAL && consensus && ! in_consensus && ! authdir ) { if ( ! from_cache && should_cache_old_descriptors ( ) ) { signed_desc_append_to_journal ( & router -> cache_info , & routerlist -> desc_store ) ; } routerlist_insert_old ( routerlist , router ) ; * msg = "Skipping router descriptor: not in consensus." ; return ROUTER_NOT_IN_CONSENSUS ; } if ( router -> purpose == ROUTER_PURPOSE_BRIDGE && from_cache && ! authdir_mode_bridge ( options ) && ! routerinfo_is_a_configured_bridge ( router ) ) { log_info ( LD_DIR , "Dropping bridge descriptor for %s because we have " "no bridge configured at that address." , safe_str_client ( router_describe ( router ) ) ) ; * msg = "Router descriptor was not a configured bridge." ; routerinfo_free ( router ) ; return ROUTER_WAS_NOT_WANTED ; } if ( old_router ) { if ( ! in_consensus && ( router -> cache_info . published_on <= old_router -> cache_info . published_on ) ) { log_debug ( LD_DIR , "Not-new descriptor for router %s" , router_describe ( router ) ) ; if ( ! from_cache && should_cache_old_descriptors ( ) ) { signed_desc_append_to_journal ( & router -> cache_info , & routerlist -> desc_store ) ; } routerlist_insert_old ( routerlist , router ) ; * msg = "Router descriptor was not new." ; return ROUTER_IS_ALREADY_KNOWN ; } else { log_debug ( LD_DIR , "Replacing entry for router %s" , router_describe ( router ) ) ; routerlist_replace ( routerlist , old_router , router ) ; if ( ! from_cache ) { signed_desc_append_to_journal ( & router -> cache_info , & routerlist -> desc_store ) ; } * msg = authdir_believes_valid ?"Valid server updated" : ( "Invalid server updated. (This dirserver is marking your " "server as unapproved.)" ) ; return ROUTER_ADDED_SUCCESSFULLY ; } } if ( ! in_consensus && from_cache && router_descriptor_is_older_than ( router , OLD_ROUTER_DESC_MAX_AGE ) ) { * msg = "Router descriptor was really old." ; routerinfo_free ( router ) ; return ROUTER_WAS_TOO_OLD ; } routerlist_insert ( routerlist , router ) ; if ( ! from_cache ) { signed_desc_append_to_journal ( & router -> cache_info , & routerlist -> desc_store ) ; } return ROUTER_ADDED_SUCCESSFULLY ; } 