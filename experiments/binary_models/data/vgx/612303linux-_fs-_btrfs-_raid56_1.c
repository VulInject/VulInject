static struct btrfs_raid_bio * alloc_rbio ( struct btrfs_fs_info * fs_info , struct btrfs_io_context * bioc ) { const unsigned int real_stripes = bioc -> num_stripes - bioc -> num_tgtdevs ; const unsigned int stripe_npages = BTRFS_STRIPE_LEN >> PAGE_SHIFT ; const unsigned int num_pages = stripe_npages * real_stripes ; const unsigned int stripe_nsectors = BTRFS_STRIPE_LEN >> fs_info -> sectorsize_bits ; const unsigned int num_sectors = stripe_nsectors * real_stripes ; struct btrfs_raid_bio * rbio ; ASSERT ( IS_ALIGNED ( PAGE_SIZE , fs_info -> sectorsize ) ) ; ASSERT ( stripe_nsectors <= BITS_PER_LONG ) ; rbio = kzalloc ( sizeof ( * rbio ) , GFP_NOFS ) ; rbio -> stripe_pages = kcalloc ( num_pages , sizeof ( page * ) , GFP_NOFS ) ; rbio -> bio_sectors = kcalloc ( num_sectors , sizeof ( sector_ptr ) , GFP_NOFS ) ; rbio -> stripe_sectors = kcalloc ( num_sectors , sizeof ( sector_ptr ) , GFP_NOFS ) ; rbio -> finish_pointers = kcalloc ( real_stripes , sizeof ( void * ) , GFP_NOFS ) ; rbio -> error_bitmap = bitmap_zalloc ( num_sectors , GFP_NOFS ) ; if ( ! rbio -> stripe_pages || ! rbio -> bio_sectors || ! rbio -> stripe_sectors || ! rbio -> finish_pointers || ! rbio -> error_bitmap ) { free_raid_bio_pointers ( rbio ) ; kfree ( rbio ) ; return ERR_PTR ( - ENOMEM ) ; } bio_list_init ( & rbio -> bio_list ) ; init_waitqueue_head ( & rbio -> io_wait ) ; INIT_LIST_HEAD ( & rbio -> plug_list ) ; spin_lock_init ( & rbio -> bio_list_lock ) ; INIT_LIST_HEAD ( & rbio -> stripe_cache ) ; INIT_LIST_HEAD ( & rbio -> hash_list ) ; btrfs_get_bioc ( bioc ) ; rbio -> bioc = bioc ; rbio -> nr_pages = num_pages ; rbio -> nr_sectors = num_sectors ; rbio -> real_stripes = real_stripes ; rbio -> stripe_npages = stripe_npages ; rbio -> stripe_nsectors = stripe_nsectors ; refcount_set ( & rbio -> refs , 1 ) ; atomic_set ( & rbio -> stripes_pending , 0 ) ; ASSERT ( btrfs_nr_parity_stripes ( bioc -> map_type ) ) ; rbio -> nr_data = real_stripes - btrfs_nr_parity_stripes ( bioc -> map_type ) ; return rbio ; } 