static int tcm_usbg_make_nexus ( struct usbg_tpg * tpg , char * name ) { struct tcm_usbg_nexus * tv_nexus ; int ret = 0 ; mutex_lock ( & tpg -> tpg_mutex ) ; if ( tpg -> tpg_nexus ) { ret = - EEXIST ; pr_debug ( "tpg->tpg_nexus already exists\n" ) ; out_unlock } tv_nexus = kzalloc ( sizeof ( * tv_nexus ) , GFP_KERNEL ) ; if ( ! tv_nexus ) { ret = - ENOMEM ; out_unlock } tv_nexus -> tvn_se_sess = target_setup_session ( & tpg -> se_tpg , USB_G_DEFAULT_SESSION_TAGS , sizeof ( usbg_cmd ) , TARGET_PROT_NORMAL , name , tv_nexus , usbg_alloc_sess_cb ) ; if ( IS_ERR ( tv_nexus -> tvn_se_sess ) ) { pr_debug ( MAKE_NEXUS_MSG , name ) ; ret = PTR_ERR ( tv_nexus -> tvn_se_sess ) ; } out_unlock mutex_unlock ( & tpg -> tpg_mutex ) ; return ret ; } 