static int lru_crawler_poll ( crawler_client_t * c ) { unsigned char * data ; unsigned int data_size = 0 ; struct pollfd to_poll [ 1 ] ; to_poll [ 0 ] . fd = c -> sfd ; to_poll [ 0 ] . events = POLLOUT ; int ret = poll ( to_poll , 1 , 1000 ) ; if ( ret < 0 ) { return - 1 ; } if ( ret == 0 ) { return 0 ; } if ( to_poll [ 0 ] . revents & POLLIN ) { char buf [ 1 ] ; int res = ( ( conn * ) c -> c ) -> read ( c -> c , buf , 1 ) ; if ( res == 0 || ( res == - 1 && ( errno != EAGAIN && errno != EWOULDBLOCK ) ) ) { lru_crawler_close_client ( c , NULL ) ; return - 1 ; } } if ( ( data = bipbuf_peek_all ( c -> buf , & data_size ) ) != NULL ) { if ( to_poll [ 0 ] . revents & ( POLLHUP | POLLERR ) ) { lru_crawler_close_client ( c ) ; return - 1 ; } if ( to_poll [ 0 ] . revents & POLLOUT ) { int total = ( ( conn * ) c -> c ) -> write ( c -> c , data , data_size ) ; if ( total == - 1 ) { if ( errno != EAGAIN && errno != EWOULDBLOCK ) { lru_crawler_close_client ( c ) ; return - 1 ; } } if ( total == 0 ) { lru_crawler_close_client ( c ) ; return - 1 ; } else { bipbuf_poll ( c -> buf , total ) ; } } } return 0 ; } 