static int atc_get_llis_residue ( struct at_dma_chan * atchan , struct at_desc * desc , u32 * residue ) { u32 len , ctrla , dscr ; int i ; len = desc -> total_len ; dscr = channel_readl ( atchan , DSCR ) ; rmb ( ) ; ctrla = channel_readl ( atchan , CTRLA ) ; for ( i = 0 ; i < ATC_MAX_DSCR_TRIALS ; ++ i ) { u32 new_dscr ; rmb ( ) ; new_dscr = channel_readl ( atchan , DSCR ) ; if ( likely ( new_dscr == dscr ) ) { break ; } dscr = new_dscr ; rmb ( ) ; ctrla = channel_readl ( atchan , CTRLA ) ; } if ( unlikely ( i == ATC_MAX_DSCR_TRIALS ) ) { return - ETIMEDOUT ; } if ( desc -> sg [ 0 ] . lli -> dscr == dscr ) { * residue = atc_calc_bytes_left ( len , ctrla ) ; return 0 ; } len -= desc -> sg [ 0 ] . len ; for ( i = 1 ; i < desc -> sglen ; i ++ ) { if ( desc -> sg [ i ] . lli && desc -> sg [ i ] . lli -> dscr == dscr ) { break ; } len -= desc -> sg [ i ] . len ; } * residue = atc_calc_bytes_left ( len , ctrla ) ; return 0 ; } 