int spi_bitbang_init ( struct spi_bitbang * bitbang ) { struct spi_master * master = bitbang -> master ; bool custom_cs ; if ( ! master ) { return - EINVAL ; } custom_cs = ( ! master -> use_gpio_descriptors || ( master -> flags & SPI_MASTER_GPIO_SS ) ) ; if ( custom_cs && ! bitbang -> chipselect ) { return - EINVAL ; } mutex_init ( & bitbang -> lock ) ; if ( ! master -> mode_bits ) { master -> mode_bits = SPI_CPOL | SPI_CPHA | bitbang -> flags ; } master -> prepare_transfer_hardware = spi_bitbang_prepare_hardware ; master -> unprepare_transfer_hardware = spi_bitbang_unprepare_hardware ; master -> transfer_one = spi_bitbang_transfer_one ; if ( custom_cs ) { master -> set_cs = spi_bitbang_set_cs ; } if ( ! bitbang -> txrx_bufs ) { bitbang -> use_dma = 0 ; bitbang -> txrx_bufs = spi_bitbang_bufs ; if ( ! master -> setup ) { if ( ! bitbang -> setup_transfer ) { bitbang -> setup_transfer = spi_bitbang_setup_transfer ; } master -> setup = spi_bitbang_setup ; master -> cleanup = spi_bitbang_cleanup ; } } return 0 ; } 