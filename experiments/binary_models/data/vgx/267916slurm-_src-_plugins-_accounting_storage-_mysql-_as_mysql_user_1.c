extern int as_mysql_add_users ( mysql_conn_t * mysql_conn , uint32_t uid , List user_list ) { ListIterator itr = NULL ; int rc = SLURM_SUCCESS ; slurmdb_user_rec_t * object = NULL ; char * cols = NULL , * vals = NULL , * query = NULL , * txn_query = NULL ; time_t now = time ( NULL ) ; char * user_name = NULL ; char * extra = NULL , * tmp_extra = NULL ; int affect_rows = 0 ; List assoc_list ; List wckey_list ; if ( check_connection ( mysql_conn ) != SLURM_SUCCESS ) { return ESLURM_DB_CONNECTION ; } if ( ! is_user_min_admin_level ( mysql_conn , uid , SLURMDB_ADMIN_OPERATOR ) ) { slurmdb_user_rec_t user ; memset ( & user , 0 , sizeof ( slurmdb_user_rec_t ) ) ; user . uid = uid ; if ( ! is_user_any_coord ( mysql_conn , & user ) ) { error ( "Only admins/operators/coordinators " "can add accounts" ) ; return ESLURM_ACCESS_DENIED ; } } assoc_list = list_create ( slurmdb_destroy_assoc_rec ) ; wckey_list = list_create ( slurmdb_destroy_wckey_rec ) ; user_name = uid_to_string ( ( uid_t ) uid ) ; itr = list_iterator_create ( user_list ) ; while ( ( object = list_next ( itr ) ) ) { if ( ! object -> name || ! object -> name [ 0 ] ) { error ( "We need a user name and " "default acct to add." ) ; rc = SLURM_ERROR ; continue ; } if ( object -> coord_accts ) { debug ( "Adding coordinators with users is not supported, ignored, use as_mysql_add_coord() separately instead." ) ; } xstrcat ( cols , "creation_time, mod_time, name" ) ; xstrfmtcat ( vals , "%ld, %ld, '%s'" , ( long ) now , ( long ) now , object -> name ) ; if ( object -> admin_level != SLURMDB_ADMIN_NOTSET ) { xstrcat ( cols , ", admin_level" ) ; xstrfmtcat ( vals , ", %u" , object -> admin_level ) ; xstrfmtcat ( extra , ", admin_level=%u" , object -> admin_level ) ; } else { xstrfmtcat ( extra , ", admin_level=%u" , SLURMDB_ADMIN_NONE ) ; } query = xstrdup_printf ( "insert into %s (%s) values (%s) " "on duplicate key update name=VALUES(name), deleted=0, mod_time=%ld %s;" , user_table , cols , vals , ( long ) now , extra ) ; xfree ( cols ) ; xfree ( vals ) ; rc = mysql_db_query ( mysql_conn , query ) ; xfree ( query ) ; if ( rc != SLURM_SUCCESS ) { error ( "Couldn't add user %s" , object -> name ) ; continue ; } affect_rows = last_affected_rows ( mysql_conn ) ; if ( ! affect_rows ) { debug ( "nothing changed" ) ; xfree ( extra ) ; continue ; } if ( addto_update_list ( mysql_conn -> update_list , SLURMDB_ADD_USER , object ) == SLURM_SUCCESS ) { list_remove ( itr ) ; } tmp_extra = slurm_add_slash_to_quotes ( extra + 2 ) ; if ( txn_query ) { xstrfmtcat ( txn_query , ", (%ld, %u, '%s', '%s', '%s')" , ( long ) now , DBD_ADD_USERS , object -> name , user_name , tmp_extra ) ; } else { xstrfmtcat ( txn_query , "insert into %s " "(timestamp, action, name, actor, info) " "values (%ld, %u, '%s', '%s', '%s')" , txn_table , ( long ) now , DBD_ADD_USERS , object -> name , user_name , tmp_extra ) ; } xfree ( tmp_extra ) ; xfree ( extra ) ; if ( object -> assoc_list ) { slurmdb_assoc_rec_t * assoc = NULL ; ListIterator assoc_itr = list_iterator_create ( object -> assoc_list ) ; while ( ( assoc = list_next ( assoc_itr ) ) ) { if ( ! xstrcmp ( assoc -> acct , object -> default_acct ) ) { assoc -> is_def = 1 ; } } list_iterator_destroy ( assoc_itr ) ; list_transfer ( assoc_list , object -> assoc_list ) ; } if ( object -> wckey_list ) { if ( object -> default_wckey ) { slurmdb_wckey_rec_t * wckey = NULL ; ListIterator wckey_itr = list_iterator_create ( object -> wckey_list ) ; while ( ( wckey = list_next ( wckey_itr ) ) ) { if ( ! xstrcmp ( wckey -> name , object -> default_wckey ) ) { wckey -> is_def = 1 ; } } list_iterator_destroy ( wckey_itr ) ; } list_transfer ( wckey_list , object -> wckey_list ) ; } } list_iterator_destroy ( itr ) ; xfree ( user_name ) ; if ( rc != SLURM_ERROR ) { if ( txn_query ) { xstrcat ( txn_query , ";" ) ; rc = mysql_db_query ( mysql_conn , txn_query ) ; xfree ( txn_query ) ; if ( rc != SLURM_SUCCESS ) { error ( "Couldn't add txn" ) ; rc = SLURM_SUCCESS ; } } } else { xfree ( txn_query ) ; } if ( list_count ( assoc_list ) ) { if ( ( rc = as_mysql_add_assocs ( mysql_conn , uid , assoc_list ) ) != SLURM_SUCCESS ) { error ( "Problem adding user associations" ) ; } } FREE_NULL_LIST ( assoc_list ) ; if ( rc == SLURM_SUCCESS && list_count ( wckey_list ) ) { if ( ( rc = as_mysql_add_wckeys ( mysql_conn , uid , wckey_list ) ) != SLURM_SUCCESS ) { error ( "Problem adding user wckeys" ) ; } } FREE_NULL_LIST ( wckey_list ) ; return rc ; } 