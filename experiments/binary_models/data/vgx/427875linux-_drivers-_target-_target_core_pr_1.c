static sense_reason_t core_scsi3_update_and_write_aptpl ( struct se_device * dev , bool aptpl ) { unsigned char * buf ; int rc , len = PR_APTPL_BUF_LEN ; if ( ! aptpl ) { char * null_buf = "No Registrations or Reservations\n" ; rc = __core_scsi3_write_aptpl_to_file ( dev , null_buf ) ; dev -> t10_pr . pr_aptpl_active = 0 ; pr_debug ( "SPC-3 PR: Set APTPL Bit Deactivated\n" ) ; if ( rc ) { return TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE ; } return 0 ; } retry buf = vzalloc ( len ) ; if ( ! buf ) { return TCM_OUT_OF_RESOURCES ; } rc = core_scsi3_update_aptpl_buf ( dev , buf , len ) ; if ( rc < 0 ) { len *= 2 ; retry } rc = __core_scsi3_write_aptpl_to_file ( dev , buf ) ; if ( rc != 0 ) { pr_err ( "SPC-3 PR: Could not update APTPL\n" ) ; vfree ( buf ) ; return TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE ; } dev -> t10_pr . pr_aptpl_active = 1 ; vfree ( buf ) ; pr_debug ( "SPC-3 PR: Set APTPL Bit Activated\n" ) ; return 0 ; } 