static u32 remove_board ( struct pci_func * func , u32 replace_flag , struct controller * ctrl ) { int index ; u8 skip = 0 ; u8 device ; u8 hp_slot ; u8 temp_byte ; struct resource_lists res_lists ; struct pci_func * temp_func ; if ( cpqhp_unconfigure_device ( func ) ) { return 1 ; } device = func -> device ; hp_slot = func -> device - ctrl -> slot_device_offset ; dbg ( "In %s, hp_slot = %d\n" , __func__ , hp_slot ) ; if ( replace_flag || ! ctrl -> add_support ) { cpqhp_save_base_addr_length ( ctrl , func ) ; } if ( ! func -> bus_head && ! func -> mem_head && ! func -> p_mem_head && ! func -> io_head ) { index = 0 ; temp_func = cpqhp_slot_find ( func -> bus , func -> device , index ++ ) ; while ( temp_func ) { if ( temp_func -> bus_head || temp_func -> mem_head || temp_func -> p_mem_head || temp_func -> io_head ) { skip = 1 ; break ; } temp_func = cpqhp_slot_find ( temp_func -> bus , temp_func -> device , index ++ ) ; } if ( ! skip ) { cpqhp_save_used_resources ( ctrl , func ) ; } } if ( func -> is_a_board ) { func -> status = 0x01 ; } func -> configured = 0 ; mutex_lock ( & ctrl -> crit_sect ) ; green_LED_off ( ctrl , hp_slot ) ; slot_disable ( ctrl , hp_slot ) ; set_SOGO ( ctrl ) ; temp_byte = readb ( ctrl -> hpc_reg + SLOT_SERR ) ; temp_byte &= ~ ( 0x01 << hp_slot ) ; writeb ( temp_byte , ctrl -> hpc_reg + SLOT_SERR ) ; wait_for_ctrl_irq ( ctrl ) ; mutex_unlock ( & ctrl -> crit_sect ) ; if ( ! replace_flag && ctrl -> add_support ) { while ( func ) { res_lists . io_head = ctrl -> io_head ; res_lists . mem_head = ctrl -> mem_head ; res_lists . p_mem_head = ctrl -> p_mem_head ; res_lists . bus_head = ctrl -> bus_head ; cpqhp_return_board_resources ( func , & res_lists ) ; ctrl -> io_head = res_lists . io_head ; ctrl -> mem_head = res_lists . mem_head ; ctrl -> p_mem_head = res_lists . p_mem_head ; ctrl -> bus_head = res_lists . bus_head ; cpqhp_resource_sort_and_combine ( & ( ctrl -> mem_head ) ) ; cpqhp_resource_sort_and_combine ( & ( ctrl -> p_mem_head ) ) ; cpqhp_resource_sort_and_combine ( & ( ctrl -> io_head ) ) ; cpqhp_resource_sort_and_combine ( & ( ctrl -> bus_head ) ) ; if ( is_bridge ( func ) ) { bridge_slot_remove ( func ) ; } else { slot_remove ( func ) ; } func = cpqhp_slot_find ( ctrl -> bus , device , 0 ) ; } func = cpqhp_slot_create ( ctrl -> bus ) ; if ( func == NULL ) { return 1 ; } func -> bus = ctrl -> bus ; func -> device = device ; func -> function = 0 ; func -> configured = 0 ; func -> switch_save = 0x10 ; func -> is_a_board = 0 ; } return 0 ; } 