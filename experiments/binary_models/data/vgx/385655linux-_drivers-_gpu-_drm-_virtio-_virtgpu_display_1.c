static struct drm_framebuffer * virtio_gpu_user_framebuffer_create ( struct drm_device * dev , struct drm_file * file_priv , const struct drm_mode_fb_cmd2 * mode_cmd ) { struct drm_gem_object * obj = NULL ; struct virtio_gpu_framebuffer * virtio_gpu_fb ; int ret ; if ( mode_cmd -> pixel_format != DRM_FORMAT_HOST_XRGB8888 && mode_cmd -> pixel_format != DRM_FORMAT_HOST_ARGB8888 ) { return ERR_PTR ( - ENOENT ) ; } obj = drm_gem_object_lookup ( file_priv , mode_cmd -> handles [ 0 ] ) ; if ( ! obj ) { return ERR_PTR ( - EINVAL ) ; } virtio_gpu_fb = kzalloc ( sizeof ( * virtio_gpu_fb ) , GFP_KERNEL ) ; if ( virtio_gpu_fb == NULL ) { drm_gem_object_put ( obj ) ; return ERR_PTR ( - ENOMEM ) ; } ret = virtio_gpu_framebuffer_init ( dev , virtio_gpu_fb , mode_cmd , obj ) ; if ( ret ) { drm_gem_object_put ( obj ) ; return NULL ; } return & virtio_gpu_fb -> base ; } 