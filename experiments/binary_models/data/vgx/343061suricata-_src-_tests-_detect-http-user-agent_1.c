static int DetectHttpUATest06 ( void ) { TcpSession ssn ; ThreadVars th_v ; DetectEngineThreadCtx * det_ctx = NULL ; Flow f ; uint8_t http_buf [ ] "GET /index.html HTTP/1.0\r\n" "Host: www.openinfosecfoundation.org\r\n" "User-Agent: This is dummy message body\r\n" "Content-Type: text/html\r\n" "\r\n" ; ; uint32_t http_len = sizeof ( http_buf ) - 1 ; AppLayerParserThreadCtx * alp_tctx = AppLayerParserThreadCtxAlloc ( ) ; memset ( & f , 0 , sizeof ( f ) ) ; memset ( & ssn , 0 , sizeof ( ssn ) ) ; Packet * p = UTHBuildPacket ( NULL , 0 , IPPROTO_TCP ) ; FAIL_IF_NULL ( p ) ; FLOW_INITIALIZE ( & f ) ; f . protoctx = ( void * ) & ssn ; f . proto = IPPROTO_TCP ; f . flags |= FLOW_IPV4 ; p -> flow = & f ; p -> flowflags |= FLOW_PKT_TOSERVER ; p -> flowflags |= FLOW_PKT_ESTABLISHED ; p -> flags |= PKT_HAS_FLOW | PKT_STREAM_EST ; f . alproto = ALPROTO_HTTP1 ; StreamTcpInitConfig ( true ) ; DetectEngineCtx * de_ctx = DetectEngineCtxInit ( ) ; FAIL_IF_NULL ( de_ctx ) ; de_ctx -> flags |= DE_QUIET ; Signature * s = DetectEngineAppendSig ( de_ctx , "alert http any any ->any any " "(msg:\"http user agent test\"; " "content:\"message\"; http_user_agent; " "sid:1;)" ) ; FAIL_IF_NULL ( s ) ; SigGroupBuild ( de_ctx ) ; DetectEngineThreadCtxInit ( & th_v , ( void * ) de_ctx , ( void * ) & det_ctx ) ; int r = AppLayerParserParse ( NULL , alp_tctx , & f , ALPROTO_HTTP1 , STREAM_TOSERVER , http_buf , http_len ) ; FAIL_IF_NOT ( r == 0 ) ; FAIL_IF_NULL ( f . alstate ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; FAIL_IF_NOT ( PacketAlertCheck ( p , 1 ) ) ; AppLayerParserThreadCtxFree ( alp_tctx ) ; DetectEngineCtxFree ( de_ctx ) ; StreamTcpFreeConfig ( true ) ; FLOW_DESTROY ( & f ) ; UTHFreePackets ( & p , 1 ) ; PASS ; } 