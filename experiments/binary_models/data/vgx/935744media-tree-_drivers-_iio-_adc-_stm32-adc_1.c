static int stm32_adc_set_trig ( struct iio_dev * indio_dev , struct iio_trigger * trig ) { struct stm32_adc * adc = iio_priv ( indio_dev ) ; u32 val , extsel = 0 , exten = STM32_EXTEN_SWTRIG ; unsigned long flags ; int ret ; if ( trig ) { ret = stm32_adc_get_trig_extsel ( trig ) ; extsel = ret ; exten = adc -> trigger_polarity + STM32_EXTEN_HWTRIG_RISING_EDGE ; } spin_lock_irqsave ( & adc -> lock , flags ) ; val = stm32_adc_readl ( adc , STM32F4_ADC_CR2 ) ; val &= ~ ( STM32F4_EXTEN_MASK | STM32F4_EXTSEL_MASK ) ; val |= exten << STM32F4_EXTEN_SHIFT ; val |= extsel << STM32F4_EXTSEL_SHIFT ; stm32_adc_writel ( adc , STM32F4_ADC_CR2 , val ) ; spin_unlock_irqrestore ( & adc -> lock , flags ) ; return 0 ; } 