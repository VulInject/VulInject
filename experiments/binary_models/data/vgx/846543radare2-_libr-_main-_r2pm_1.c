R_API int r_main_r2pm ( int argc , const char * * argv ) { bool havetoflush = false ; if ( ! r_cons_is_initialized ( ) ) { havetoflush = true ; r_cons_new ( ) ; } int level = r_sys_getenv_asint ( "R2_LOG_LEVEL" ) ; if ( level > 0 ) { r_log_set_level ( level ) ; } else { level = 2 ; } char * levelstr = r_str_newf ( "%d" , level ) ; r_sys_setenv ( "R2_LOG_LEVEL" , levelstr ) ; if ( argc == 2 && ! strcmp ( argv [ 1 ] , "-H" ) ) { r2pm_varprint ( NULL ) ; return 0 ; } R2Pm r2pm = { 0 } ; RGetopt opt ; r_getopt_init ( & opt , argc , argv , "aqecdiIhH:flgrpsuUv" ) ; if ( opt . ind < argc ) { r2pm_actionword ( & r2pm , argv [ opt . ind ] ) ; } int i , c ; r2pm_setenv ( ) ; while ( ( c = r_getopt_next ( & opt ) ) != - 1 ) { switch ( c ) { case 'a' : r2pm . add = true ; break ; case 'q' : r2pm . quiet = true ; break ; case 'c' : r2pm . clean = true ; break ; case 'i' : r2pm . install = true ; break ; case 'd' : r2pm . doc = true ; break ; case 'p' : r2pm . plugdir = true ; break ; case 'I' : r2pm . info = true ; break ; case 'u' : r2pm . uninstall = true ; break ; case 'e' : r2pm . edit = true ; break ; case 'f' : r2pm . force = true ; break ; case 'U' : r2pm . init = true ; break ; case 'l' : r2pm . list = true ; break ; case 's' : r2pm . search = true ; break ; case 'r' : r2pm . run = true ; break ; case 'g' : r2pm . global = true ; break ; case 'H' : if ( ! strcmp ( opt . arg , "H" ) ) { r2pm_envhelp ( true ) ; } else { r2pm_varprint ( opt . arg ) ; } return 0 ; case 'h' : if ( r2pm . help ) { r2pm . envhelp = true ; } else { r2pm . help = true ; } break ; case 'v' : r2pm . version = true ; break ; } } if ( r2pm . plugdir ) { if ( r2pm . clean ) { char * plugdir = r_xdg_datadir ( "plugins" ) ; if ( R_STR_ISNOTEMPTY ( plugdir ) ) { r_file_rm_rf ( plugdir ) ; free ( plugdir ) ; } } else { R_LOG_ERROR ( "-p requires -c" ) ; return 1 ; } } if ( r2pm . init ) { r2pm_upgrade ( r2pm . force ) ; } if ( r2pm . version ) { if ( r2pm . quiet ) { printf ( "%s\n" , R2_VERSION ) ; return 0 ; } return r_main_version_print ( "r2pm" ) ; } if ( r2pm . help || argc == 1 ) { printf ( "%s" , helpmsg ) ; if ( r2pm . envhelp ) { r2pm_envhelp ( true ) ; } return 0 ; } if ( r2pm . init ) { r2pm_update ( r2pm . force ) ; } if ( r2pm . run ) { int i ; RStrBuf * sb = r_strbuf_new ( "" ) ; for ( i = opt . ind ; i < argc ; i ++ ) { r_strbuf_appendf ( sb , " %s" , argv [ i ] ) ; } char * cmd = r_strbuf_drain ( sb ) ; int res = r_sandbox_system ( cmd , 1 ) ; free ( cmd ) ; return res ; } if ( r2pm . add ) { if ( opt . ind == argc ) { printf ( " ) } } } 