static int rpcif_hb_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct rpcif_hyperbus * hyperbus ; int error ; hyperbus = devm_kzalloc ( dev , sizeof ( * hyperbus ) , GFP_KERNEL ) ; if ( ! hyperbus ) { return - ENOMEM ; } error = rpcif_sw_init ( & hyperbus -> rpc , pdev -> dev . parent ) ; platform_set_drvdata ( pdev , hyperbus ) ; rpcif_enable_rpm ( & hyperbus -> rpc ) ; error = rpcif_hw_init ( & hyperbus -> rpc , true ) ; if ( error ) { out_disable_rpm } hyperbus -> hbdev . map . size = hyperbus -> rpc . size ; hyperbus -> hbdev . map . virt = hyperbus -> rpc . dirmap ; hyperbus -> ctlr . dev = dev ; hyperbus -> ctlr . ops = & rpcif_hb_ops ; hyperbus -> hbdev . ctlr = & hyperbus -> ctlr ; hyperbus -> hbdev . np = of_get_next_child ( pdev -> dev . parent -> of_node , NULL ) ; error = hyperbus_register_device ( & hyperbus -> hbdev ) ; if ( error ) { out_disable_rpm } return 0 ; out_disable_rpm rpcif_disable_rpm ( & hyperbus -> rpc ) ; return error ; } 