static int rtl8150_probe ( struct usb_interface * intf , const struct usb_device_id * id ) { struct usb_device * udev = interface_to_usbdev ( intf ) ; rtl8150_t * dev ; struct net_device * netdev ; netdev = alloc_etherdev ( sizeof ( rtl8150_t ) ) ; if ( ! netdev ) { return - ENOMEM ; } dev = netdev_priv ( netdev ) ; dev -> intr_buff = kmalloc ( INTBUFSIZE , GFP_KERNEL ) ; if ( ! dev -> intr_buff ) { return - ENOMEM ; } tasklet_setup ( & dev -> tl , rx_fixup ) ; spin_lock_init ( & dev -> rx_pool_lock ) ; dev -> udev = udev ; dev -> netdev = netdev ; netdev -> netdev_ops = & rtl8150_netdev_ops ; netdev -> watchdog_timeo = RTL8150_TX_TIMEOUT ; netdev -> ethtool_ops = & ops ; dev -> intr_interval = 100 ; if ( ! alloc_all_urbs ( dev ) ) { dev_err ( & intf -> dev , "out of memory\n" ) ; out } if ( ! rtl8150_reset ( dev ) ) { dev_err ( & intf -> dev , "couldn't reset the device\n" ) ; out1 } fill_skb_pool ( dev ) ; set_ethernet_addr ( dev ) ; usb_set_intfdata ( intf , dev ) ; SET_NETDEV_DEV ( netdev , & intf -> dev ) ; if ( register_netdev ( netdev ) != 0 ) { dev_err ( & intf -> dev , "couldn't register the device\n" ) ; out2 } dev_info ( & intf -> dev , "%s: rtl8150 is detected\n" , netdev -> name ) ; return 0 ; out2 usb_set_intfdata ( intf , NULL ) ; free_skb_pool ( dev ) ; out1 free_all_urbs ( dev ) ; out kfree ( dev -> intr_buff ) ; free_netdev ( netdev ) ; return - EIO ; } 