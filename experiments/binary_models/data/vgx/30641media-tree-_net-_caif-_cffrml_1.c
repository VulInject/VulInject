static int cffrml_receive ( struct cflayer * layr , struct cfpkt * pkt ) { u16 tmp ; u16 len ; u16 hdrchks ; int pktchks ; struct cffrml * this ; this = container_obj ( layr ) ; cfpkt_extr_head ( pkt , & tmp , 2 ) ; len = le16_to_cpu ( tmp ) ; if ( ! this -> dofcs ) { len -= 2 ; } if ( cfpkt_setlen ( pkt , len ) < 0 ) { ++ cffrml_rcv_error ; pr_err ( "Framing length error (%d)\n" , len ) ; return - EPROTO ; } if ( this -> dofcs ) { cfpkt_extr_trail ( pkt , & tmp , 2 ) ; hdrchks = le16_to_cpu ( tmp ) ; pktchks = cfpkt_iterate ( pkt , cffrml_checksum , 0xffff ) ; if ( pktchks != hdrchks ) { cfpkt_add_trail ( pkt , & tmp , 2 ) ; ++ cffrml_rcv_error ; ++ cffrml_rcv_checsum_error ; pr_info ( "Frame checksum error (0x%x != 0x%x)\n" , hdrchks , pktchks ) ; return - EILSEQ ; } } if ( cfpkt_erroneous ( pkt ) ) { ++ cffrml_rcv_error ; pr_err ( "Packet is erroneous!\n" ) ; cfpkt_destroy ( pkt ) ; return - EPROTO ; } if ( layr -> up == NULL ) { pr_err ( "Layr up is missing!\n" ) ; cfpkt_destroy ( pkt ) ; return - EINVAL ; } return layr -> up -> receive ( layr -> up , pkt ) ; } 