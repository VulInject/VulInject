int apic_probe_common ( char * modname ) { uint32_t mpct_addr , ebda_start = 0 , base_mem_end ; caddr_t biosdatap ; caddr_t mpct = NULL ; caddr_t fptr = NULL ; int i , mpct_size = 0 , mapsize , retval = PSM_FAILURE ; ushort_t ebda_seg , base_mem_size ; struct apic_mpfps_hdr * fpsp ; struct apic_mp_cnf_hdr * hdrp ; int bypass_cpu_and_ioapics_in_mptables ; int acpi_user_options ; PRM_POINT ( "apic_probe_common()" ) ; if ( apic_forceload < 0 ) { return ( retval ) ; } psm_name = modname ; acpi_user_options = ddi_prop_get_int ( DDI_DEV_T_ANY , ddi_root_node ( ) , 0 , "acpi-user-options" , 0 ) ; apic_use_acpi_madt_only = ( ( acpi_user_options & ACPI_OUSER_MADT ) != 0 ) ; if ( ! apic_use_acpi ) { apic_use_acpi_madt_only = 0 ; } PRM_POINT ( "acpi_probe()" ) ; retval = acpi_probe ( modname ) ; PRM_DEBUG ( retval ) ; if ( ddi_prop_exists ( DDI_DEV_T_ANY , ddi_root_node ( ) , 0 , "efi-systab" ) ) { PRM_POINT ( "UEFI system!" ) ; apic_ret } PRM_POINT ( "psm_map_phys()" ) ; biosdatap = psm_map_phys ( 0x400 , 0x20 , PROT_READ ) ; PRM_DEBUG ( biosdatap ) ; if ( ! biosdatap ) { apic_ret } fpsp = ( apic_mpfps_hdr * ) NULL ; mapsize = MPFPS_RAM_WIN_LEN ; ebda_seg = * ( ( ushort_t * ) ( biosdatap + 0xe ) ) ; PRM_DEBUG ( ebda_seg ) ; if ( ebda_seg ) { ebda_start = ( ( uint32_t ) ebda_seg ) << 4 ; fptr = psm_map_phys ( ebda_start , MPFPS_RAM_WIN_LEN , PROT_READ ) ; PRM_DEBUG ( fptr ) ; if ( fptr ) { if ( ! ( fpsp = apic_find_fps_sig ( fptr , MPFPS_RAM_WIN_LEN ) ) ) { psm_unmap_phys ( fptr , MPFPS_RAM_WIN_LEN ) ; } } } PRM_DEBUG ( fpsp , NULL ) ; if ( ! fpsp ) { base_mem_size = * ( ( ushort_t * ) ( biosdatap + 0x13 ) ) ; if ( base_mem_size > 512 ) { base_mem_end = 639 * 1024 ; } else { base_mem_end = 511 * 1024 ; } if ( base_mem_end != ebda_start ) { fptr = psm_map_phys ( base_mem_end , MPFPS_RAM_WIN_LEN , PROT_READ ) ; PRM_DEBUG ( fptr ) ; if ( fptr ) { if ( ! ( fpsp = apic_find_fps_sig ( fptr , MPFPS_RAM_WIN_LEN ) ) ) { psm_unmap_phys ( fptr , MPFPS_RAM_WIN_LEN ) ; } } } } PRM_POINT ( "psm_unmap_phys()" ) ; psm_unmap_phys ( biosdatap , 0x20 ) ; PRM_DEBUG ( fpsp ) ; if ( ! fpsp ) { mapsize = MPFPS_ROM_WIN_LEN ; fptr = psm_map_phys ( MPFPS_ROM_WIN_START , MPFPS_ROM_WIN_LEN , PROT_READ ) ; PRM_DEBUG ( fptr ) ; if ( fptr ) { if ( ! ( fpsp = apic_find_fps_sig ( fptr , MPFPS_ROM_WIN_LEN ) ) ) { psm_unmap_phys ( fptr , MPFPS_ROM_WIN_LEN ) ; apic_ret } } } PRM_DEBUG ( fptr ) ; PRM_DEBUG ( fpsp ) ; PRM_POINT ( "apic_checksum()" ) ; if ( apic_checksum ( ( caddr_t ) fpsp , fpsp -> mpfps_length * 16 ) != 0 ) { PRM_POINT ( "psm_unmap_phys()" ) ; psm_unmap_phys ( fptr , MPFPS_ROM_WIN_LEN ) ; apic_ret } apic_spec_rev = fpsp -> mpfps_spec_rev ; if ( ( apic_spec_rev != 04 ) && ( apic_spec_rev != 01 ) ) { PRM_POINT ( "psm_unmap_phys()" ) ; psm_unmap_phys ( fptr , MPFPS_ROM_WIN_LEN ) ; apic_ret } apic_imcrp = fpsp -> mpfps_featinfo2 & MPFPS_FEATINFO2_IMCRP ; if ( ( apic_defconf = fpsp -> mpfps_featinfo1 ) != 0 ) { PRM_POINT ( "psm_unmap_phys()" ) ; psm_unmap_phys ( fptr , mapsize ) ; PRM_POINT ( "apic_handle_defconf()" ) ; if ( ( retval = apic_handle_defconf ( ) ) != PSM_SUCCESS ) { return ( retval ) ; } apic_ret } mpct_addr = ( uint32_t ) ( fpsp -> mpfps_mpct_paddr ) ; PRM_DEBUG ( mpct_addr ) ; psm_unmap_phys ( fptr , mapsize ) ; hdrp = ( apic_mp_cnf_hdr * ) psm_map_phys ( mpct_addr , sizeof ( apic_mp_cnf_hdr ) , PROT_READ ) ; if ( ! hdrp ) { apic_ret } if ( hdrp -> mpcnf_sig != 0x504d4350 ) { psm_unmap_phys ( ( caddr_t ) hdrp , sizeof ( apic_mp_cnf_hdr ) ) ; apic_ret } mpct_size = ( int ) hdrp -> mpcnf_tbl_length ; PRM_POINT ( "apic_set_pwroff_method_from_mpcnfhdr()" ) ; apic_set_pwroff_method_from_mpcnfhdr ( hdrp ) ; psm_unmap_phys ( ( caddr_t ) hdrp , sizeof ( apic_mp_cnf_hdr ) ) ; if ( ( retval == PSM_SUCCESS ) && ! apic_use_acpi_madt_only ) { apic_ret } mpct = psm_map_phys ( mpct_addr , mpct_size , PROT_READ ) ; if ( ! mpct ) { apic_ret } if ( apic_checksum ( mpct , mpct_size ) != 0 ) { apic_fail1 } hdrp = ( apic_mp_cnf_hdr * ) mpct ; apicadr = ( uint32_t * ) mapin_apic ( ( uint32_t ) hdrp -> mpcnf_local_apic , APIC_LOCAL_MEMLEN , PROT_READ | PROT_WRITE ) ; PRM_DEBUG ( hdrp ) ; PRM_DEBUG ( apicadr ) ; if ( ! apicadr ) { apic_fail1 } bypass_cpu_and_ioapics_in_mptables = ( retval == PSM_SUCCESS ) ; if ( apic_parse_mpct ( mpct , bypass_cpu_and_ioapics_in_mptables ) == PSM_SUCCESS ) { retval = PSM_SUCCESS ; apic_ret } apic_fail1 PRM_POINT ( "apic_fail1:" ) ; psm_unmap_phys ( mpct , mpct_size ) ; mpct = NULL ; apic_ret PRM_POINT ( "apic_ret:" ) ; if ( retval == PSM_SUCCESS ) { extern int apic_ioapic_method_probe ( ) ; PRM_POINT ( "apic_ioapic_method_probe()" ) ; if ( ( retval = apic_ioapic_method_probe ( ) ) == PSM_SUCCESS ) { PRM_POINT ( "SUCCESS" ) ; return ( PSM_SUCCESS ) ; } } for ( i = 0 ; i < apic_io_max ; i ++ ) { mapout_ioapic ( ( caddr_t ) apicioadr [ i ] , APIC_IO_MEMLEN ) ; } if ( apic_cpus ) { kmem_free ( apic_cpus , apic_cpus_size ) ; apic_cpus = NULL ; } if ( apicadr ) { mapout_apic ( ( caddr_t ) apicadr , APIC_LOCAL_MEMLEN ) ; apicadr = NULL ; } if ( mpct ) { psm_unmap_phys ( mpct , mpct_size ) ; } PRM_DEBUG ( retval ) ; return ( retval ) ; } 