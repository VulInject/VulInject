static int stm32_set_enable_mode ( struct iio_dev * indio_dev , const struct iio_chan_spec * chan , unsigned int mode ) { struct stm32_timer_trigger * priv = iio_priv ( indio_dev ) ; int sms = stm32_enable_mode2sms ( mode ) ; mutex_lock ( & priv -> lock ) ; if ( sms == 6 && ! priv -> enabled ) { clk_enable ( priv -> clk ) ; priv -> enabled = true ; } mutex_unlock ( & priv -> lock ) ; regmap_update_bits ( priv -> regmap , TIM_SMCR , TIM_SMCR_SMS , sms ) ; return 0 ; } 