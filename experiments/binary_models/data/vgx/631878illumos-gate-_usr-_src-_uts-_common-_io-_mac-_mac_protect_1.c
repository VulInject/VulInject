static int get_dhcpv4_info ( ipha_t * ipha , uchar_t * end , struct dhcp * * dh4 ) { uint16_t offset_and_flags , client , server ; boolean_t first_frag = B_FALSE ; struct udphdr * udph ; uchar_t * dh ; if ( ipha -> ipha_protocol != IPPROTO_UDP ) { return ( EINVAL ) ; } offset_and_flags = ntohs ( ipha -> ipha_fragment_offset_and_flags ) ; if ( ( offset_and_flags & ( IPH_MF | IPH_OFFSET ) ) != 0 ) { if ( ( ( offset_and_flags << 3 ) & 0xffff ) != 0 ) { return ( EINVAL ) ; } first_frag = B_TRUE ; } udph = ( udphdr * ) ( ( uchar_t * ) ipha + IPH_HDR_LENGTH ( ipha ) ) ; if ( ( uchar_t * ) & udph [ 1 ] > end ) { return ( ENOSPC ) ; } client = htons ( IPPORT_BOOTPC ) ; server = htons ( IPPORT_BOOTPS ) ; if ( udph -> uh_sport != client && udph -> uh_sport != server && udph -> uh_dport != client && udph -> uh_dport != server ) { return ( EINVAL ) ; } if ( first_frag ) { return ( ENOSPC ) ; } dh = ( uchar_t * ) & udph [ 1 ] ; * dh4 = ( dhcp * ) dh ; return ( 0 ) ; } 