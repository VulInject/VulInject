static int vhost_user_read ( struct vhost_dev * dev , VhostUserMsg * msg ) { struct vhost_user * u = dev -> opaque ; CharBackend * chr = u -> user -> chr ; GMainContext * prev_ctxt = chr -> chr -> gcontext ; GMainContext * ctxt = g_main_context_new ( ) ; GMainLoop * loop = g_main_loop_new ( ctxt , FALSE ) ; struct vhost_user_read_cb_data data = { . dev = dev . loop = loop . msg = msg . ret = 0 } ; slave_update_read_handler ( dev , ctxt ) ; qemu_chr_be_update_read_handlers ( chr -> chr , ctxt ) ; qemu_chr_fe_add_watch ( chr , G_IO_IN | G_IO_HUP , vhost_user_read_cb , & data ) ; g_main_loop_run ( loop ) ; qemu_chr_be_update_read_handlers ( chr -> chr , prev_ctxt ) ; slave_update_read_handler ( dev , NULL ) ; g_main_loop_unref ( loop ) ; return data . ret ; } 