static int cr50_spi_flow_control ( struct tpm_tis_spi_phy * phy , struct spi_transfer * spi_xfer ) { struct device * dev = & phy -> spi_device -> dev ; cfs_time_t timeout = jiffies + CR50_FLOW_CONTROL ; struct spi_message m ; int ret ; spi_xfer -> len = 1 ; { spi_message_init ( & m ) ; spi_message_add_tail ( spi_xfer , & m ) ; ret = spi_sync_locked ( phy -> spi_device , & m ) ; if ( ret < 0 ) { return ret ; } if ( time_after ( jiffies , timeout ) ) { dev_warn ( dev , "Timeout during flow control\n" ) ; return - EBUSY ; } } ! ( phy -> iobuf [ 0 ] & 0x01 ) ; return 0 ; } 