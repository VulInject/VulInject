int ucc_fast_init ( struct ucc_fast_inf * uf_info , struct ucc_fast_priv * * uccf_ret ) { struct ucc_fast_priv * uccf ; ucc_fast_t * uf_regs ; if ( ! uf_info ) { return - EINVAL ; } if ( uf_info -> ucc_num < 0 || ( uf_info -> ucc_num > UCC_MAX_NUM - 1 ) ) { printf ( "%s: Illagal UCC number!\n" , __func__ ) ; return - EINVAL ; } uccf = ( ucc_fast_priv * ) malloc ( sizeof ( ucc_fast_priv ) ) ; if ( ! uccf ) { printf ( "%s: No memory for UCC fast data structure!\n" , __func__ ) ; return - ENOMEM ; } uccf -> uf_info = uf_info ; uccf -> uf_regs = ( ucc_fast_t * ) ucc_get_reg_baseaddr ( uf_info -> ucc_num ) ; if ( ! uccf -> uf_regs ) { printf ( "%s: No memory map for UCC fast controller!\n" , __func__ ) ; return - ENOMEM ; } uccf -> enabled_tx = 0 ; uccf -> enabled_rx = 0 ; uf_regs = uccf -> uf_regs ; uccf -> p_ucce = ( u32 * ) & uf_regs -> ucce ; uccf -> p_uccm = ( u32 * ) & uf_regs -> uccm ; out_8 ( & uf_regs -> guemr , UCC_GUEMR_SET_RESERVED3 | UCC_GUEMR_MODE_FAST_RX | UCC_GUEMR_MODE_FAST_TX ) ; out_be32 ( & uf_regs -> gumr , UCC_FAST_GUMR_ETH ) ; if ( uf_info -> eth_type == GIGA_ETH ) { uccf -> ucc_fast_tx_virtual_fifo_base_offset = qe_muram_alloc ( UCC_GETH_UTFS_GIGA_INIT , UCC_FAST_VIRT_FIFO_REGS_ALIGNMENT ) ; uccf -> ucc_fast_rx_virtual_fifo_base_offset = qe_muram_alloc ( UCC_GETH_URFS_GIGA_INIT + UCC_FAST_RX_VIRTUAL_FIFO_SIZE_PAD , UCC_FAST_VIRT_FIFO_REGS_ALIGNMENT ) ; out_be32 ( & uf_regs -> utfb , uccf -> ucc_fast_tx_virtual_fifo_base_offset ) ; out_be32 ( & uf_regs -> urfb , uccf -> ucc_fast_rx_virtual_fifo_base_offset ) ; out_be16 ( & uf_regs -> urfs , UCC_GETH_URFS_GIGA_INIT ) ; out_be16 ( & uf_regs -> urfet , UCC_GETH_URFET_GIGA_INIT ) ; out_be16 ( & uf_regs -> urfset , UCC_GETH_URFSET_GIGA_INIT ) ; out_be16 ( & uf_regs -> utfs , UCC_GETH_UTFS_GIGA_INIT ) ; out_be16 ( & uf_regs -> utfet , UCC_GETH_UTFET_GIGA_INIT ) ; out_be16 ( & uf_regs -> utftt , UCC_GETH_UTFTT_GIGA_INIT ) ; } if ( uf_info -> eth_type == FAST_ETH ) { uccf -> ucc_fast_tx_virtual_fifo_base_offset = qe_muram_alloc ( UCC_GETH_UTFS_INIT , UCC_FAST_VIRT_FIFO_REGS_ALIGNMENT ) ; uccf -> ucc_fast_rx_virtual_fifo_base_offset = qe_muram_alloc ( UCC_GETH_URFS_INIT + UCC_FAST_RX_VIRTUAL_FIFO_SIZE_PAD , UCC_FAST_VIRT_FIFO_REGS_ALIGNMENT ) ; out_be32 ( & uf_regs -> utfb , uccf -> ucc_fast_tx_virtual_fifo_base_offset ) ; out_be32 ( & uf_regs -> urfb , uccf -> ucc_fast_rx_virtual_fifo_base_offset ) ; out_be16 ( & uf_regs -> urfs , UCC_GETH_URFS_INIT ) ; out_be16 ( & uf_regs -> urfet , UCC_GETH_URFET_INIT ) ; out_be16 ( & uf_regs -> urfset , UCC_GETH_URFSET_INIT ) ; out_be16 ( & uf_regs -> utfs , UCC_GETH_UTFS_INIT ) ; out_be16 ( & uf_regs -> utfet , UCC_GETH_UTFET_INIT ) ; out_be16 ( & uf_regs -> utftt , UCC_GETH_UTFTT_INIT ) ; } if ( uf_info -> rx_clock != QE_CLK_NONE ) { if ( ucc_set_clk_src ( uf_info -> ucc_num , uf_info -> rx_clock , COMM_DIR_RX ) ) { printf ( "%s: Illegal value for parameter 'RxClock'.\n" , __func__ ) ; return - EINVAL ; } } if ( uf_info -> tx_clock != QE_CLK_NONE ) { if ( ucc_set_clk_src ( uf_info -> ucc_num , uf_info -> tx_clock , COMM_DIR_TX ) ) { printf ( "%s: Illegal value for parameter 'TxClock'.\n" , __func__ ) ; return - EINVAL ; } } out_be32 ( & uf_regs -> uccm , 0x0 ) ; out_be32 ( & uf_regs -> ucce , 0xffffffff ) ; * uccf_ret = uccf ; return 0 ; } 