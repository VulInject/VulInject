GF_Err nalumx_configure_pid ( GF_Filter * filter , GF_FilterPid * pid , Bool is_remove ) { GF_Err e ; u32 crc , crc_enh , codecid ; const GF_PropertyValue * p , * dcd , * dcd_enh ; GF_NALUMxCtx * ctx = gf_filter_get_udta ( filter ) ; if ( is_remove ) { ctx -> ipid = NULL ; if ( ctx -> opid ) { gf_filter_pid_remove ( ctx -> opid ) ; ctx -> opid = NULL ; } return GF_OK ; } if ( ! gf_filter_pid_check_caps ( pid ) ) { return GF_NOT_SUPPORTED ; } p = gf_filter_pid_get_property ( pid , GF_PROP_PID_CODECID ) ; if ( ! p ) { return GF_NOT_SUPPORTED ; } codecid = p -> value . uint ; dcd = gf_filter_pid_get_property ( pid , GF_PROP_PID_DECODER_CONFIG ) ; if ( ! dcd ) { crc = - 1 ; } else { crc = gf_crc_32 ( dcd -> value . data . ptr , dcd -> value . data . size ) ; } dcd_enh = gf_filter_pid_get_property ( pid , GF_PROP_PID_DECODER_CONFIG_ENHANCEMENT ) ; crc_enh = dcd_enh ?gf_crc_32 ( dcd_enh -> value . data . ptr , dcd_enh -> value . data . size ) : 0 ; if ( ( ctx -> crc == crc ) && ( ctx -> crc_enh == crc_enh ) ) { if ( ctx -> opid ) { gf_filter_pid_copy_properties ( ctx -> opid , pid ) ; gf_filter_pid_set_property ( ctx -> opid , GF_PROP_PID_UNFRAMED , & PROP_BOOL ( GF_TRUE ) ) ; gf_filter_pid_set_property ( ctx -> opid , GF_PROP_PID_FORCE_UNFRAME ) ; } return GF_OK ; } ctx -> crc = crc ; ctx -> crc_enh = crc_enh ; if ( ( codecid == GF_CODECID_HEVC ) || ( codecid == GF_CODECID_LHVC ) ) { ctx -> vtype = UFNAL_HEVC ; } if ( codecid == GF_CODECID_VVC ) { ctx -> vtype = UFNAL_VVC ; } else { ctx -> vtype = UFNAL_AVC ; } ctx -> width = ctx -> height = 0 ; p = gf_filter_pid_get_property ( pid , GF_PROP_PID_WIDTH ) ; if ( p ) { ctx -> width = p -> value . uint ; } p = gf_filter_pid_get_property ( pid , GF_PROP_PID_HEIGHT ) ; if ( p ) { ctx -> height = p -> value . uint ; } if ( ! ctx -> opid ) { ctx -> opid = gf_filter_pid_new ( filter ) ; } gf_filter_pid_copy_properties ( ctx -> opid , pid ) ; gf_filter_pid_set_property ( ctx -> opid , GF_PROP_PID_UNFRAMED , & PROP_BOOL ( GF_TRUE ) ) ; gf_filter_pid_set_property ( ctx -> opid , GF_PROP_PID_FORCE_UNFRAME , NULL ) ; ctx -> ipid = pid ; gf_filter_pid_set_framing_mode ( ctx -> ipid , GF_TRUE ) ; if ( ! dcd && ! dcd_enh ) { return GF_OK ; } e = nalumx_make_inband_header ( ctx , dcd ?dcd -> value . data . ptr : NULL , dcd ?dcd -> value . data . size : 0 , dcd_enh ?dcd_enh -> value . data . ptr : NULL , dcd_enh ?dcd_enh -> value . data . size : 0 , GF_FALSE ) ; if ( e ) { return e ; } if ( ! ctx -> pps_inband || ! ctx -> rcfg ) { return GF_OK ; } return nalumx_make_inband_header ( ctx , dcd ?dcd -> value . data . ptr : NULL , dcd ?dcd -> value . data . size : 0 , dcd_enh ?dcd_enh -> value . data . ptr : NULL , dcd_enh ?dcd_enh -> value . data . size : 0 , GF_TRUE ) ; } 