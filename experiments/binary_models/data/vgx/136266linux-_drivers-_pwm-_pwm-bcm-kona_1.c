static int kona_pwmc_apply ( struct pwm_chip * chip , struct pwm_device * pwm , const struct pwm_state * state ) { int err ; struct kona_pwmc * kp = to_kona_pwmc ( chip ) ; bool enabled = pwm -> state . enabled ; if ( state -> polarity != pwm -> state . polarity ) { if ( enabled ) { kona_pwmc_disable ( chip , pwm ) ; enabled = false ; } err = kona_pwmc_set_polarity ( chip , pwm , state -> polarity ) ; pwm -> state . polarity = state -> polarity ; } if ( ! state -> enabled ) { if ( enabled ) { kona_pwmc_disable ( chip , pwm ) ; } return 0 ; } if ( ! enabled ) { err = kona_pwmc_enable ( chip , pwm ) ; if ( err ) { return err ; } } err = kona_pwmc_config ( pwm -> chip , pwm , state -> duty_cycle , state -> period ) ; if ( err && ! pwm -> state . enabled ) { clk_disable_unprepare ( kp -> clk ) ; } return err ; } 