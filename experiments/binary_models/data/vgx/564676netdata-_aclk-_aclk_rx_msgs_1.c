int create_node_instance_result ( const char * msg , size_t msg_len ) { node_instance_creation_result_t res = parse_create_node_instance_result ( msg , msg_len ) ; if ( ! res . machine_guid || ! res . node_id ) { error_report ( "Error parsing CreateNodeInstanceResult" ) ; freez ( res . machine_guid ) ; return 1 ; } debug ( D_ACLK , "CreateNodeInstanceResult: guid:%s nodeid:%s" , res . machine_guid , res . node_id ) ; uuid_t host_id , node_id ; if ( uuid_parse ( res . machine_guid , host_id ) ) { error ( "Error parsing machine_guid provided by CreateNodeInstanceResult" ) ; freez ( res . machine_guid ) ; freez ( res . node_id ) ; return 1 ; } if ( uuid_parse ( res . node_id , node_id ) ) { error ( "Error parsing node_id provided by CreateNodeInstanceResult" ) ; freez ( res . machine_guid ) ; freez ( res . node_id ) ; return 1 ; } update_node_id ( & host_id , & node_id ) ; aclk_query_t query = aclk_query_new ( NODE_STATE_UPDATE ) ; node_instance_connection_t node_state_update = { . hops = 1 . live = 0 . queryable = 1 . session_id = aclk_session_newarch . node_id = res . node_id . capabilities = NULL } ; RRDHOST * host = rrdhost_find_by_guid ( res . machine_guid ) ; if ( likely ( host ) ) { if ( host == localhost ) { node_state_update . live = 1 ; node_state_update . hops = 0 ; } else { node_state_update . live = ( ! rrdhost_flag_check ( host , RRDHOST_FLAG_ORPHAN ) ) ; node_state_update . hops = host -> system_info -> hops ; } node_state_update . capabilities = aclk_get_node_instance_capas ( host ) ; } rrdhost_aclk_state_lock ( localhost ) ; node_state_update . claim_id = localhost -> aclk_state . claimed_id ; query -> data . bin_payload . payload = generate_node_instance_connection ( & query -> data . bin_payload . size , & node_state_update ) ; rrdhost_aclk_state_unlock ( localhost ) ; freez ( ( void * ) node_state_update . capabilities ) ; query -> data . bin_payload . msg_name = "UpdateNodeInstanceConnection" ; query -> data . bin_payload . topic = ACLK_TOPICID_NODE_CONN ; aclk_queue_query ( query ) ; freez ( res . node_id ) ; freez ( res . machine_guid ) ; return 0 ; } 