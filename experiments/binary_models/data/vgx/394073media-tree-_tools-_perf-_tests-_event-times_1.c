static int test_times ( int attach ( struct perf_evlist * ) , int detach ( struct perf_evlist * ) ) { struct perf_counts_values count ; struct perf_evlist * evlist = NULL ; struct perf_evsel * evsel ; int err = - 1 , i ; evlist = perf_evlist__new ( ) ; if ( ! evlist ) { pr_debug ( "failed to create event list\n" ) ; out_err } err = parse_events ( evlist , "cpu-clock:u" , NULL ) ; if ( err ) { pr_debug ( "failed to parse event cpu-clock:u\n" ) ; out_err } evsel = perf_evlist__last ( evlist ) ; evsel -> attr . read_format |= PERF_FORMAT_TOTAL_TIME_ENABLED | PERF_FORMAT_TOTAL_TIME_RUNNING ; err = attach ( evlist ) ; if ( err == TEST_SKIP ) { pr_debug ( "  SKIP  : not enough rights\n" ) ; return err ; } TEST_ASSERT_VAL ( "failed to attach" , ! err ) ; for ( i = 0 ; i < 100000000 ; i ++ ) { } TEST_ASSERT_VAL ( "failed to detach" , ! detach ( evlist ) ) ; perf_evsel__read ( evsel , 0 , 0 , & count ) ; err = ! ( count . ena == count . run ) ; pr_debug ( "  %s: ena %" PRIu64 ", run %" PRIu64 "\n" , ! err ?"OK    " : "FAILED" , count . ena , count . run ) ; out_err perf_evlist__delete ( evlist , NULL ) ; return ! err ?TEST_OK : TEST_FAIL ; } 