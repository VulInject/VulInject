BN_MONT_CTX * BN_MONT_CTX_set_locked ( BN_MONT_CTX * * pmctx , int lock , const BIGNUM * mod , BN_CTX * ctx ) { BN_MONT_CTX * mctx = NULL ; CRYPTO_r_lock ( lock ) ; mctx = * pmctx ; CRYPTO_r_unlock ( lock ) ; if ( mctx != NULL ) { done } if ( ( mctx = BN_MONT_CTX_new ( ) ) == NULL ) { err } if ( ! BN_MONT_CTX_set ( mctx , mod , ctx ) ) { err } CRYPTO_w_lock ( lock ) ; if ( * pmctx != NULL ) { mctx = * pmctx ; } else { * pmctx = mctx ; } CRYPTO_w_unlock ( lock ) ; done err BN_MONT_CTX_free ( mctx ) ; mctx = NULL ; done return mctx ; } 