static int geni_spi_set_clock_and_bw ( struct spi_geni_master * mas , unsigned long clk_hz ) { u32 clk_sel , m_clk_cfg , idx , div ; struct geni_se * se = & mas -> se ; int ret ; ret = get_spi_clk_cfg ( clk_hz , mas , & idx , & div ) ; if ( ret ) { dev_err ( mas -> dev , "Err setting clk to %lu: %d\n" , clk_hz , ret ) ; return ret ; } mas -> cur_speed_hz = clk_hz ; clk_sel = idx & CLK_SEL_MSK ; m_clk_cfg = ( div << CLK_DIV_SHFT ) | SER_CLK_EN ; writel ( clk_sel , se -> base + SE_GENI_CLK_SEL ) ; writel ( m_clk_cfg , se -> base + GENI_SER_M_CLK_CFG ) ; se -> icc_paths [ CPU_TO_GENI ] . avg_bw = Bps_to_icc ( mas -> cur_speed_hz ) ; ret = geni_icc_set_bw ( se ) ; if ( ret ) { return ret ; } return 0 ; } 