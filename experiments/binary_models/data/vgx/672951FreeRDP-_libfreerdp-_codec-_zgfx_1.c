int zgfx_decompress ( ZGFX_CONTEXT * zgfx , const BYTE * pSrcData , UINT32 SrcSize , BYTE * * ppDstData , UINT32 * pDstSize , UINT32 flags ) { int status = - 1 ; BYTE descriptor ; wStream sbuffer = { 0 } ; wStream * stream = Stream_StaticConstInit ( & sbuffer , pSrcData , SrcSize ) ; if ( ! Stream_CheckAndLogRequiredLength ( TAG , stream , 1 ) ) { fail } Stream_Read_UINT8 ( stream , descriptor ) ; if ( descriptor == ZGFX_SEGMENTED_SINGLE ) { if ( ! zgfx_decompress_segment ( zgfx , stream , Stream_GetRemainingLength ( stream ) ) ) { fail } * ppDstData = NULL ; if ( zgfx -> OutputCount > 0 ) { * ppDstData = aligned_zgfx_malloc ( zgfx -> OutputCount ) ; } if ( ! * ppDstData ) { fail } * pDstSize = zgfx -> OutputCount ; CopyMemory ( * ppDstData , zgfx -> OutputBuffer , zgfx -> OutputCount ) ; } if ( descriptor == ZGFX_SEGMENTED_MULTIPART ) { UINT32 segmentSize ; UINT16 segmentNumber ; UINT16 segmentCount ; UINT32 uncompressedSize ; BYTE * pConcatenated ; size_t used = 0 ; if ( ! Stream_CheckAndLogRequiredLength ( TAG , stream , 6 ) ) { fail } Stream_Read_UINT16 ( stream , segmentCount ) ; Stream_Read_UINT32 ( stream , uncompressedSize ) ; if ( ! Stream_CheckAndLogRequiredLengthOfSize ( TAG , stream , segmentCount , sizeof ( UINT32 ) ) ) { fail } pConcatenated = aligned_zgfx_malloc ( uncompressedSize ) ; if ( ! pConcatenated ) { fail } * ppDstData = pConcatenated ; * pDstSize = uncompressedSize ; for ( segmentNumber = 0 ; segmentNumber < segmentCount ; segmentNumber ++ ) { if ( ! Stream_CheckAndLogRequiredLength ( TAG , stream , sizeof ( UINT32 ) ) ) { fail } Stream_Read_UINT32 ( stream , segmentSize ) ; if ( ! zgfx_decompress_segment ( zgfx , stream , segmentSize ) ) { fail } if ( zgfx -> OutputCount > UINT32_MAX - used ) { fail } if ( used + zgfx -> OutputCount > uncompressedSize ) { fail } CopyMemory ( pConcatenated , zgfx -> OutputBuffer , zgfx -> OutputCount ) ; pConcatenated += zgfx -> OutputCount ; used += zgfx -> OutputCount ; } } else { fail } status = 1 ; fail return status ; } 