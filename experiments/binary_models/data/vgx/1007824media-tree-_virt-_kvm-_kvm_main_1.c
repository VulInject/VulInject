bool kvm_make_all_cpus_request ( struct kvm * kvm , unsigned int req ) { int i , cpu , me ; cpumask_var_t cpus ; bool called = true ; bool wait = req & KVM_REQUEST_WAIT ; struct kvm_vcpu * vcpu ; zalloc_cpumask_var ( & cpus , GFP_ATOMIC ) ; me = get_cpu ( ) ; kvm_for_each_vcpu ( , , ) { kvm_make_request ( req , vcpu ) ; cpu = vcpu -> cpu ; if ( ! ( req & KVM_REQUEST_NO_WAKEUP ) && kvm_vcpu_wake_up ( vcpu ) ) { continue ; } if ( cpus != NULL && cpu != - 1 && cpu != me && kvm_request_needs_ipi ( vcpu , req ) ) { cpumask_set_cpu ( cpu , cpus ) ; } } if ( unlikely ( cpus == NULL ) ) { smp_call_function_many ( cpu_online_mask , ack_flush , NULL , wait ) ; } if ( ! cpumask_empty ( cpus ) ) { smp_call_function_many ( cpus , ack_flush , NULL , wait ) ; } else { called = false ; } put_cpu ( ) ; return called ; } 