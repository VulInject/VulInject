static enum i40iw_status_code i40iw_add_mqh_4 ( struct i40iw_device * iwdev , struct i40iw_cm_info * cm_info , struct i40iw_cm_listener * cm_parent_listen_node ) { struct net_device * dev ; struct in_device * idev ; struct i40iw_cm_listener * child_listen_node ; enum i40iw_status_code ret = 0 ; unsigned long flags ; rtnl_lock ( ) ; for_each_netdev ( , ) { if ( ( ( ( rdma_vlan_dev_vlan_id ( dev ) < I40IW_NO_VLAN ) && ( rdma_vlan_dev_real_dev ( dev ) == iwdev -> netdev ) ) || ( dev == iwdev -> netdev ) ) && ( dev -> flags & IFF_UP ) ) { idev = in_dev_get ( dev ) ; for_ifa ( ) { i40iw_debug ( & iwdev -> sc_dev , I40IW_DEBUG_CM , "Allocating child CM Listener forIP=%pI4, vlan_id=%d, MAC=%pM\n" , & ifa -> ifa_address , rdma_vlan_dev_vlan_id ( dev ) , dev -> dev_addr ) ; child_listen_node = kzalloc ( sizeof ( * child_listen_node ) , GFP_ATOMIC ) ; cm_parent_listen_node -> cm_core -> stats_listen_nodes_created ++ ; i40iw_debug ( & iwdev -> sc_dev , I40IW_DEBUG_CM , "Allocating child listener %p\n" , child_listen_node ) ; if ( ! child_listen_node ) { in_dev_put ( idev ) ; ret = I40IW_ERR_NO_MEMORY ; exit } cm_info -> vlan_id = rdma_vlan_dev_vlan_id ( dev ) ; cm_parent_listen_node -> vlan_id = cm_info -> vlan_id ; memcpy ( child_listen_node , cm_parent_listen_node , sizeof ( * child_listen_node ) ) ; child_listen_node -> loc_addr [ 0 ] = ntohl ( ifa -> ifa_address ) ; memcpy ( cm_info -> loc_addr , child_listen_node -> loc_addr , sizeof ( cm_info -> loc_addr ) ) ; ret = i40iw_manage_qhash ( iwdev , cm_info , I40IW_QHASH_TYPE_TCP_SYN , I40IW_QHASH_MANAGE_TYPE_ADD , NULL , true ) ; if ( ! ret ) { child_listen_node -> qhash_set = true ; spin_lock_irqsave ( & iwdev -> cm_core . listen_list_lock , flags ) ; list_add ( & child_listen_node -> child_listen_list , & cm_parent_listen_node -> child_listen_list ) ; spin_unlock_irqrestore ( & iwdev -> cm_core . listen_list_lock , flags ) ; } else { cm_parent_listen_node -> cm_core -> stats_listen_nodes_created -- ; } } endfor_ifa ( idev ) ; in_dev_put ( idev ) ; } } exit rtnl_unlock ( ) ; return ret ; } 