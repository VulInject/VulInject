static int ntb_netdev_change_mtu ( struct net_device * ndev , int new_mtu ) { struct ntb_netdev * dev = netdev_priv ( ndev ) ; struct sk_buff * skb ; int len , rc ; if ( ! netif_running ( ndev ) ) { ndev -> mtu = new_mtu ; return 0 ; } ntb_transport_link_down ( dev -> qp ) ; if ( ndev -> mtu < new_mtu ) { int i ; for ( i = 0 ; ( skb = ntb_transport_rx_remove ( dev -> qp , & len ) ) ; i ++ ) { dev_kfree_skb ( skb ) ; } for ( ; i ; i -- ) { skb = netdev_alloc_skb ( ndev , new_mtu + ETH_HLEN ) ; if ( ! skb ) { rc = - ENOMEM ; err } rc = ntb_transport_rx_enqueue ( dev -> qp , skb , skb -> data , new_mtu + ETH_HLEN ) ; if ( rc ) { dev_kfree_skb ( skb ) ; err } } } ndev -> mtu = new_mtu ; ntb_transport_link_up ( dev -> qp ) ; return 0 ; err ntb_transport_link_down ( dev -> qp ) ; while ( ( skb = ntb_transport_rx_remove ( dev -> qp , & len ) ) ) { dev_kfree_skb ( skb ) ; } netdev_err ( ndev , "Error changing MTU, device inoperable\n" ) ; return rc ; } 