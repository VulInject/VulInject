static void scsifront_do_lun_hotplug ( struct vscsifrnt_info * info , int op ) { struct xenbus_device * dev = info -> dev ; int i , err = 0 ; char str [ 64 ] ; char * * dir ; unsigned int dir_n = 0 ; unsigned int device_state ; unsigned int hst , chn , tgt , lun ; struct scsi_device * sdev ; dir = xenbus_directory ( XBT_NIL , dev -> otherend , "vscsi-devs" , & dir_n ) ; if ( IS_ERR ( dir ) ) { return ; } BUG_ON ( info -> curr ) ; info -> curr = current ; for ( i = 0 ; i < dir_n ; i ++ ) { sprintf ( str , "vscsi-devs/%s/state" , dir [ i ] ) ; err = xenbus_scanf ( XBT_NIL , dev -> otherend , str , "%u" , & device_state ) ; if ( XENBUS_EXIST_ERR ( err ) ) { continue ; } snprintf ( str , sizeof ( str ) , "vscsi-devs/%s/v-dev" , dir [ i ] ) ; err = xenbus_scanf ( XBT_NIL , dev -> otherend , str , "%u:%u:%u:%u" , & hst , & chn , & tgt , & lun ) ; if ( XENBUS_EXIST_ERR ( err ) ) { continue ; } snprintf ( info -> dev_state_path , sizeof ( info -> dev_state_path ) , "vscsi-devs/%s/state" , dir [ i ] ) ; switch ( op ) { case VSCSIFRONT_OP_ADD_LUN : if ( device_state != XenbusStateInitialised ) { break ; } if ( scsi_add_device ( info -> host , chn , tgt , lun ) ) { dev_err ( & dev -> dev , "scsi_add_device\n" ) ; xenbus_printf ( XBT_NIL , dev -> nodename , info -> dev_state_path , "%d" , XenbusStateClosed ) ; } break ; case VSCSIFRONT_OP_DEL_LUN : if ( device_state != XenbusStateClosing ) { break ; } sdev = scsi_device_lookup ( info -> host , chn , tgt , lun ) ; if ( sdev ) { scsi_remove_device ( sdev ) ; scsi_device_put ( sdev ) ; } break ; case VSCSIFRONT_OP_READD_LUN : if ( device_state == XenbusStateConnected ) { xenbus_printf ( XBT_NIL , dev -> nodename , info -> dev_state_path , "%d" , XenbusStateConnected ) ; } break ; default : break ; } } info -> curr = NULL ; kfree ( dir ) ; } 