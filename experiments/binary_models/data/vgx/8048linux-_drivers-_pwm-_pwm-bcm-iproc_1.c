static int iproc_pwmc_apply ( struct pwm_chip * chip , struct pwm_device * pwm , const struct pwm_state * state ) { unsigned long prescale = IPROC_PWM_PRESCALE_MIN ; struct iproc_pwmc * ip = to_iproc_pwmc ( chip ) ; u32 value , period , duty ; u64 rate ; rate = clk_get_rate ( ip -> clk ) ; while ( 1 ) { u64 value , div ; div = NSEC_PER_SEC * ( prescale + 1 ) ; value = rate * state -> period ; period = div64_u64 ( value , div ) ; value = rate * state -> duty_cycle ; duty = div64_u64 ( value , div ) ; if ( period <= IPROC_PWM_PERIOD_MAX && duty <= IPROC_PWM_DUTY_CYCLE_MAX ) { break ; } if ( ++ prescale > IPROC_PWM_PRESCALE_MAX ) { return - EINVAL ; } } iproc_pwmc_disable ( ip , pwm -> hwpwm ) ; value = readl ( ip -> base + IPROC_PWM_PRESCALE_OFFSET ) ; value &= ~ IPROC_PWM_PRESCALE_MASK ( pwm -> hwpwm ) ; value |= prescale << IPROC_PWM_PRESCALE_SHIFT ( pwm -> hwpwm ) ; writel ( value , ip -> base + IPROC_PWM_PRESCALE_OFFSET ) ; writel ( period , ip -> base + IPROC_PWM_PERIOD_OFFSET ( pwm -> hwpwm ) ) ; writel ( duty , ip -> base + IPROC_PWM_DUTY_CYCLE_OFFSET ( pwm -> hwpwm ) ) ; value = readl ( ip -> base + IPROC_PWM_CTRL_OFFSET ) ; if ( state -> polarity == PWM_POLARITY_NORMAL ) { value |= 1 << IPROC_PWM_CTRL_POLARITY_SHIFT ( pwm -> hwpwm ) ; } else { value &= ~ ( 1 << IPROC_PWM_CTRL_POLARITY_SHIFT ( pwm -> hwpwm ) ) ; } writel ( value , ip -> base + IPROC_PWM_CTRL_OFFSET ) ; if ( state -> enabled ) { iproc_pwmc_enable ( ip , pwm -> hwpwm ) ; } return 0 ; } 