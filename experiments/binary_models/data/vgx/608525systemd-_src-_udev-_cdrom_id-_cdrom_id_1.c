static int dvd_media_update_state ( Context * c ) { struct scsi_cmd sc ; unsigned char buffer [ 32 * 2048 ] ; int r ; r = dvd_ram_media_update_state ( c ) ; scsi_cmd_init ( & sc ) ; scsi_cmd_set ( & sc , 0 , GPCMD_READ_10 ) ; scsi_cmd_set ( & sc , 5 , 0 ) ; scsi_cmd_set ( & sc , 8 , sizeof ( buffer ) / 2048 ) ; scsi_cmd_set ( & sc , 9 , 0 ) ; r = scsi_cmd_run_and_log ( & sc , c -> fd , buffer , sizeof ( buffer ) , "read first 32 blocks" ) ; if ( r < 0 ) { c -> has_media = false ; return r ; } for ( size_t offset = 32768 ; offset < 32768 + 2048 ; offset ++ ) { if ( buffer [ offset ] != 0 ) { log_debug ( "Data in block 16, assuming complete." ) ; return 0 ; } } for ( size_t offset = 0 ; offset < 2048 ; offset ++ ) { if ( buffer [ offset ] != 0 ) { log_debug ( "Data in block 0, assuming complete." ) ; return 0 ; } } log_debug ( "No data in blocks 0 or 16, assuming blank." ) ; c -> media_state = MEDIA_STATE_BLANK ; return 0 ; } 