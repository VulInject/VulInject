static int ivtv_g_fbuf ( struct file * file , void * fh , struct v4l2_framebuffer * fb ) { struct ivtv * itv = fh2id ( fh ) -> itv ; struct ivtv_stream * s = & itv -> streams [ fh2id ( fh ) -> type ] ; u32 data [ CX2341X_MBOX_MAX_DATA ] ; struct yuv_playback_info * yi = & itv -> yuv_info ; int pixfmt ; static u32 pixel_format [ 16 ] { V4L2_PIX_FMT_PAL8 V4L2_PIX_FMT_RGB565 V4L2_PIX_FMT_RGB555 V4L2_PIX_FMT_RGB444 V4L2_PIX_FMT_RGB32 0 0 0 V4L2_PIX_FMT_PAL8 V4L2_PIX_FMT_YUV565 V4L2_PIX_FMT_YUV555 V4L2_PIX_FMT_YUV444 V4L2_PIX_FMT_YUV32 0 0 0 } ; ; if ( ! ( s -> vdev . device_caps & V4L2_CAP_VIDEO_OUTPUT_OVERLAY ) ) { return - ENOTTY ; } fb -> capability = V4L2_FBUF_CAP_EXTERNOVERLAY | V4L2_FBUF_CAP_CHROMAKEY | V4L2_FBUF_CAP_GLOBAL_ALPHA ; ivtv_vapi_result ( itv , data , CX2341X_OSD_GET_STATE , 0 ) ; data [ 0 ] |= ( read_reg ( 0x2a00 ) >> 7 ) & 0x40 ; pixfmt = ( data [ 0 ] >> 3 ) & 0xf ; fb -> fmt . pixelformat = pixel_format [ pixfmt ] ; fb -> fmt . width = itv -> osd_rect . width ; fb -> fmt . height = itv -> osd_rect . height ; fb -> fmt . field = V4L2_FIELD_INTERLACED ; fb -> fmt . bytesperline = fb -> fmt . width ; fb -> fmt . colorspace = V4L2_COLORSPACE_SMPTE170M ; fb -> fmt . field = V4L2_FIELD_INTERLACED ; if ( fb -> fmt . pixelformat != V4L2_PIX_FMT_PAL8 ) { fb -> fmt . bytesperline *= 2 ; } if ( fb -> fmt . pixelformat == V4L2_PIX_FMT_RGB32 || fb -> fmt . pixelformat == V4L2_PIX_FMT_YUV32 ) { fb -> fmt . bytesperline *= 2 ; } fb -> fmt . sizeimage = fb -> fmt . bytesperline * fb -> fmt . height ; fb -> base = ( void * ) itv -> osd_video_pbase ; fb -> flags = 0 ; if ( itv -> osd_chroma_key_state ) { fb -> flags |= V4L2_FBUF_FLAG_CHROMAKEY ; } if ( itv -> osd_global_alpha_state ) { fb -> flags |= V4L2_FBUF_FLAG_GLOBAL_ALPHA ; } if ( yi -> track_osd ) { fb -> flags |= V4L2_FBUF_FLAG_OVERLAY ; } pixfmt &= 7 ; if ( pixfmt == 1 || pixfmt > 4 ) { return 0 ; } if ( pixfmt == 2 || pixfmt == 3 ) { fb -> capability |= V4L2_FBUF_CAP_LOCAL_INV_ALPHA ; } else { fb -> capability |= V4L2_FBUF_CAP_LOCAL_ALPHA ; } if ( itv -> osd_local_alpha_state ) { if ( pixfmt == 2 || pixfmt == 3 ) { fb -> flags |= V4L2_FBUF_FLAG_LOCAL_INV_ALPHA ; } else { fb -> flags |= V4L2_FBUF_FLAG_LOCAL_ALPHA ; } } return 0 ; } 