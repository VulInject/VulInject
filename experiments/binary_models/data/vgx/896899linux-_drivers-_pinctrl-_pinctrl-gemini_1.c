static int gemini_pmx_set_mux ( struct pinctrl_dev * pctldev , unsigned int selector , unsigned int group ) { struct gemini_pmx * pmx ; const struct gemini_pmx_func * func ; const struct gemini_pin_group * grp ; u32 before , after , expected ; unsigned long tmp ; int i ; pmx = pinctrl_dev_get_drvdata ( pctldev , NULL ) ; func = & gemini_pmx_functions [ selector ] ; if ( pmx -> is_3512 ) { grp = & gemini_3512_pin_groups [ group ] ; } if ( pmx -> is_3516 ) { grp = & gemini_3516_pin_groups [ group ] ; } else { dev_err ( pmx -> dev , "invalid SoC type\n" ) ; return - ENODEV ; } dev_dbg ( pmx -> dev , "ACTIVATE function \"%s\" with group \"%s\"\n" , func -> name , grp -> name ) ; regmap_read ( pmx -> map , GLOBAL_MISC_CTRL , & before ) ; regmap_update_bits ( pmx -> map , GLOBAL_MISC_CTRL , grp -> mask | grp -> value , grp -> value ) ; regmap_read ( pmx -> map , GLOBAL_MISC_CTRL , & after ) ; before &= PADS_MASK ; after &= PADS_MASK ; expected = before &= ~ grp -> mask ; expected |= grp -> value ; expected &= PADS_MASK ; tmp = grp -> mask ; for_each_set_bit ( , , ) { bool enabled = ! ( i > 3 ) ; if ( after & BIT ( i ) ) { dev_err ( pmx -> dev , "pin group %s could not be %s: " "probably a hardware limitation\n" , gemini_padgroups [ i ] , enabled ?"enabled" : "disabled" ) ; dev_err ( pmx -> dev , "GLOBAL MISC CTRL before: %08x, after %08x, expected %08x\n" , before , after , expected ) ; } else { dev_dbg ( pmx -> dev , "padgroup %s %s\n" , gemini_padgroups [ i ] , enabled ?"enabled" : "disabled" ) ; } } tmp = grp -> value ; for_each_set_bit ( , , ) { bool enabled = ( i > 3 ) ; if ( ! ( after & BIT ( i ) ) ) { dev_err ( pmx -> dev , "pin group %s could not be %s: " "probably a hardware limitation\n" , gemini_padgroups [ i ] , enabled ?"enabled" : "disabled" ) ; dev_err ( pmx -> dev , "GLOBAL MISC CTRL before: %08x, after %08x, expected %08x\n" , before , after , expected ) ; } else { dev_dbg ( pmx -> dev , "padgroup %s %s\n" , gemini_padgroups [ i ] , enabled ?"enabled" : "disabled" ) ; } } return 0 ; } 