static void vips_spcor_correlation ( VipsCorrelation * correlation , VipsRegion * in , VipsRegion * out ) { VipsSpcor * spcor = ( VipsSpcor * ) correlation ; VipsRect * r = & out -> valid ; VipsImage * ref = correlation -> ref_ready ; int bands = vips_band_format_iscomplex ( ref -> BandFmt ) ?ref -> Bands * 2 : ref -> Bands ; int sz = ref -> Xsize * bands ; int lsk = VIPS_REGION_LSKIP ( in ) ; int x , y , b , j , i ; double imean ; int sum1 ; double sum2 , sum3 ; double c2 , cc ; for ( y = 0 ; y < r -> height ; y ++ ) { float * q = ( float * ) VIPS_REGION_ADDR ( out , r -> left , r -> top + y ) ; for ( x = 0 ; x < r -> width ; x ++ ) { VipsPel * p = VIPS_REGION_ADDR ( in , r -> left + x , r -> top + y ) ; for ( b = 0 ; b < bands ; b ++ ) { switch ( vips_image_get_format ( ref ) ) { case VIPS_FORMAT_UCHAR : LOOP ( ) break ; case VIPS_FORMAT_CHAR : LOOP ( ) break ; case VIPS_FORMAT_USHORT : LOOP ( ) break ; case VIPS_FORMAT_SHORT : LOOP ( ) break ; case VIPS_FORMAT_UINT : LOOP ( ) break ; case VIPS_FORMAT_INT : LOOP ( ) break ; case VIPS_FORMAT_FLOAT : case VIPS_FORMAT_COMPLEX : LOOP ( float ) ; break ; case VIPS_FORMAT_DOUBLE : case VIPS_FORMAT_DPCOMPLEX : LOOP ( double ) ; break ; default : g_assert_not_reached ( ) ; sum2 = 0 ; sum3 = 0 ; } c2 = spcor -> c1 [ b ] * sqrt ( sum2 ) ; if ( c2 == 0.0 ) { cc = 0.0 ; } else { cc = sum3 / c2 ; } * q ++ = cc ; } } } } 