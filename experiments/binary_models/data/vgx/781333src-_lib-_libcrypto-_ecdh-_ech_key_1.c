static int ecdh_compute_key ( void * out , size_t len , const EC_POINT * pub_key , EC_KEY * ecdh , void * * KDF ( const void * in , size_t inlen , void * out , size_t * outlen ) ) static int ecdh_compute_key ( void * out , size_t outlen , const EC_POINT * pub_key , EC_KEY * ecdh , void * * KDF ( const void * in , size_t inlen , void * out , size_t * outlen ) ) { BN_CTX * ctx ; EC_POINT * tmp = NULL ; BIGNUM * x = NULL , * y = NULL ; const BIGNUM * priv_key ; const EC_GROUP * group ; int ret = - 1 ; size_t buflen , len ; unsigned char * buf = NULL ; if ( outlen > INT_MAX ) { ECDHerror ( ERR_R_MALLOC_FAILURE , NULL ) ; return - 1 ; } if ( ( ctx = BN_CTX_new ( ) ) == NULL ) { err } BN_CTX_start ( ctx ) ; if ( ( x = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ( y = BN_CTX_get ( ctx ) ) == NULL ) { err } priv_key = EC_KEY_get0_private_key ( ecdh ) ; if ( priv_key == NULL ) { ECDHerror ( ECDH_R_NO_PRIVATE_VALUE ) ; err } group = EC_KEY_get0_group ( ecdh ) ; if ( ! EC_POINT_is_on_curve ( group , pub_key , ctx ) ) { err } if ( ( tmp = EC_POINT_new ( group ) ) == NULL ) { ECDHerror ( ERR_R_MALLOC_FAILURE ) ; err } if ( ! EC_POINT_mul ( group , tmp , NULL , pub_key , priv_key , ctx ) ) { ECDHerror ( ECDH_R_POINT_ARITHMETIC_FAILURE ) ; err } if ( ! EC_POINT_get_affine_coordinates ( group , tmp , x , y , ctx ) ) { ECDHerror ( ECDH_R_POINT_ARITHMETIC_FAILURE ) ; err } buflen = ECDH_size ( ecdh ) ; len = BN_num_bytes ( x ) ; if ( len > buflen ) { ECDHerror ( ERR_R_INTERNAL_ERROR ) ; err } if ( KDF == NULL && outlen < buflen ) { ECDHerror ( ECDH_R_KEY_TRUNCATION ) ; err } if ( ( buf = malloc ( buflen ) ) == NULL ) { ECDHerror ( ERR_R_MALLOC_FAILURE ) ; err } memset ( buf , 0 , buflen - len ) ; if ( len != ( size_t ) BN_bn2bin ( x , buf + buflen - len ) ) { ECDHerror ( ERR_R_BN_LIB ) ; err } if ( KDF != NULL ) { if ( KDF ( buf , buflen , out , & outlen ) == NULL ) { ECDHerror ( ECDH_R_KDF_FAILED ) ; err } ret = outlen ; } else { if ( outlen > buflen ) { memset ( ( void * ) ( ( uintptr_t ) out + buflen ) , 0 , outlen - buflen ) ; outlen = buflen ; } memcpy ( out , buf , outlen ) ; ret = outlen ; } err EC_POINT_free ( tmp ) ; if ( ctx ) { BN_CTX_end ( ctx ) ; } BN_CTX_free ( ctx ) ; free ( buf ) ; return ( ret ) ; } 