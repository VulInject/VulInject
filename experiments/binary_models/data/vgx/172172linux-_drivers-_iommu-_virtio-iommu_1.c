static size_t viommu_del_mappings ( struct viommu_domain * vdomain , u64 iova , u64 end ) { size_t unmapped = 0 ; unsigned long flags ; struct viommu_mapping * mapping = NULL ; struct interval_tree_node * node , * next ; spin_lock_irqsave ( & vdomain -> mappings_lock , flags ) ; next = interval_tree_iter_first ( & vdomain -> mappings , iova , end ) ; while ( next ) { node = next ; mapping = container_of ( node , viommu_mapping , iova ) ; next = interval_tree_iter_next ( node , iova , end ) ; if ( mapping -> iova . start < iova ) { break ; } unmapped += mapping -> iova . last - mapping -> iova . start + 1 ; interval_tree_remove ( node , & vdomain -> mappings ) ; } spin_unlock_irqrestore ( & vdomain -> mappings_lock , flags ) ; return unmapped ; } 