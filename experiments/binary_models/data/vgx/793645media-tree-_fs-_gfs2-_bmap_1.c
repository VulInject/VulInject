int gfs2_write_alloc_required ( struct gfs2_inode * ip , u64 offset , unsigned int len ) { struct gfs2_sbd * sdp = GFS2_SB ( & ip -> i_inode ) ; struct buffer_head bh ; unsigned int shift ; u64 lblock , lblock_stop , size ; u64 end_of_file ; if ( gfs2_is_stuffed ( ip ) ) { if ( offset + len > sdp -> sd_sb . sb_bsize - sizeof ( gfs2_dinode ) ) { return 1 ; } return 0 ; } shift = sdp -> sd_sb . sb_bsize_shift ; BUG_ON ( gfs2_is_dir ( ip ) ) ; end_of_file = ( i_size_read ( & ip -> i_inode ) + sdp -> sd_sb . sb_bsize - 1 ) >> shift ; lblock = offset >> shift ; lblock_stop = ( offset + len + sdp -> sd_sb . sb_bsize - 1 ) >> shift ; if ( lblock_stop > end_of_file ) { return 1 ; } size = ( lblock_stop - lblock ) << shift ; { bh . b_state = 0 ; bh . b_size = size ; gfs2_block_map ( & ip -> i_inode , lblock , & bh , 0 ) ; if ( ! buffer_mapped ( & bh ) ) { return 1 ; } size -= bh . b_size ; lblock += ( bh . b_size >> ip -> i_inode . i_blkbits ) ; } size > 0 ; return 0 ; } 