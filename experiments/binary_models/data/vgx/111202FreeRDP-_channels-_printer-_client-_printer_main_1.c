UINT printer_DeviceServiceEntry ( PDEVICE_SERVICE_ENTRY_POINTS pEntryPoints ) { int i ; char * name ; char * driver_name ; BOOL default_backend = TRUE ; RDPDR_PRINTER * device = NULL ; rdpPrinterDriver * driver = NULL ; UINT error = CHANNEL_RC_OK ; if ( ! pEntryPoints || ! pEntryPoints -> device ) { return ERROR_INVALID_PARAMETER ; } device = ( RDPDR_PRINTER * ) pEntryPoints -> device ; name = device -> device . Name ; driver_name = _strdup ( device -> DriverName ) ; if ( driver_name ) { char * sep = strstr ( driver_name , ":" ) ; if ( sep ) { const char * backend = sep + 1 ; * sep = '\0' ; driver = printer_load_backend ( backend ) ; default_backend = FALSE ; } } if ( ! driver && default_backend ) { const char * backend = "cups" "win" "" ; driver = printer_load_backend ( backend ) ; } if ( ! driver ) { WLog_ERR ( TAG , "Could not get a printer driver!" ) ; error = CHANNEL_RC_INITIALIZATION_ERROR ; fail } if ( name && name [ 0 ] ) { WINPR_ASSERT ( driver -> GetPrinter ) ; rdpPrinter * printer = driver -> GetPrinter ( driver , name , driver_name , device -> IsDefault ) ; if ( ! printer ) { WLog_ERR ( TAG , "Could not get printer %s!" , name ) ; error = CHANNEL_RC_INITIALIZATION_ERROR ; fail } WINPR_ASSERT ( printer -> ReleaseRef ) ; if ( ! printer_save_default_config ( pEntryPoints -> rdpcontext -> settings , printer ) ) { error = CHANNEL_RC_INITIALIZATION_ERROR ; printer -> ReleaseRef ( printer ) ; fail } error = printer_register ( pEntryPoints , printer ) ; printer -> ReleaseRef ( printer ) ; if ( error ) { WLog_ERR ( TAG , "printer_register failed with error %" PRIu32 "!" , error ) ; fail } } else { WINPR_ASSERT ( driver -> EnumPrinters ) ; rdpPrinter * * printers = driver -> EnumPrinters ( driver ) ; rdpPrinter * * current = printers ; for ( i = 0 ; current [ i ] ; i ++ ) { rdpPrinter * printer = current [ i ] ; if ( ( error = printer_register ( pEntryPoints , printer ) ) ) { WLog_ERR ( TAG , "printer_register failed with error %" PRIu32 "!" , error ) ; break ; } } WINPR_ASSERT ( driver -> ReleaseEnumPrinters ) ; driver -> ReleaseEnumPrinters ( printers ) ; } fail if ( driver ) { WINPR_ASSERT ( driver -> ReleaseRef ) ; driver -> ReleaseRef ( driver ) ; } return error ; } 