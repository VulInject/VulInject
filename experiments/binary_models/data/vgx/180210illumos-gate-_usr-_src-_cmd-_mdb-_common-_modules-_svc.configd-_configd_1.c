static int request_log ( uintptr_t addr , uint_t flags , int argc , const mdb_arg_t * argv ) { request_log_entry_t cur ; hrtime_t dur ; hrtime_t dursec ; hrtime_t durnsec ; char durstr [ 20 ] ; char stampstr [ 20 ] ; char requstr [ 30 ] ; char respstr [ 30 ] ; char typestr [ 30 ] ; uintptr_t node = 0 ; int client = 0 ; uint64_t clientid = 0 ; int idx ; int opt_v = FALSE ; if ( ! ( flags & DCMD_ADDRSPEC ) ) { if ( mdb_walk_dcmd ( "configd_log" , "configd_log" , argc , argv ) == - 1 ) { mdb_warn ( "can't walk 'configd_log'" ) ; return ( DCMD_ERR ) ; } return ( DCMD_OK ) ; } if ( mdb_getopts ( argc , argv , 'c' , MDB_OPT_UINTPTR , & client , 'i' , MDB_OPT_UINT64 , & clientid , 'n' , MDB_OPT_UINTPTR , & node , 'v' , MDB_OPT_SETBITS , TRUE , & opt_v , NULL ) != argc ) { return ( DCMD_USAGE ) ; } if ( DCMD_HDRSPEC ( flags ) ) { mdb_printf ( "%<u>%-?s %-4s %-14s %9s %-22s %-17s\n%</u>" , "ADDR" , "THRD" , "START" , "DURATION" , "REQUEST" , "RESPONSE" ) ; } if ( mdb_vread ( & cur , sizeof ( cur ) , addr ) == - 1 ) { mdb_warn ( "couldn't read log entry at %p" , addr ) ; return ( DCMD_ERR ) ; } if ( clientid != 0 && clientid != cur . rl_clientid ) { return ( DCMD_OK ) ; } if ( client != 0 && client != ( uintptr_t ) cur . rl_client ) { return ( DCMD_OK ) ; } if ( node != 0 ) { for ( idx = 0 ; idx < MIN ( MAX_PTRS , cur . rl_num_ptrs ) ; idx ++ ) { if ( ( uintptr_t ) cur . rl_ptrs [ idx ] . rlp_data == node ) { node = 0 ; break ; } } if ( node != 0 ) { return ( DCMD_OK ) ; } } enum_lookup ( requstr , sizeof ( requstr ) , request_enum , cur . rl_request , "REP_PROTOCOL_" , "" ) ; if ( cur . rl_end != 0 ) { enum_lookup ( respstr , sizeof ( respstr ) , response_enum , cur . rl_response , "REP_PROTOCOL_" , "FAIL_" ) ; dur = cur . rl_end - cur . rl_start ; dursec = dur / NANOSEC ; durnsec = dur % NANOSEC ; if ( dursec <= 9 ) { mdb_snprintf ( durstr , sizeof ( durstr ) , "%lld.%06lld" , dursec , durnsec / ( NANOSEC / MICROSEC ) ) ; } if ( dursec <= 9999 ) { mdb_snprintf ( durstr , sizeof ( durstr ) , "%lld.%03lld" , dursec , NSEC2MSEC ( durnsec ) ) ; } else { mdb_snprintf ( durstr , sizeof ( durstr ) , "%lld" , dursec ) ; } } else { ( void ) strcpy ( durstr , "-" ) ; ( void ) strcpy ( respstr , "-" ) ; } if ( max_time_seen != 0 && max_time_seen >= cur . rl_start ) { dur = max_time_seen - cur . rl_start ; dursec = dur / NANOSEC ; durnsec = dur % NANOSEC ; if ( dursec <= 99ULL ) { mdb_snprintf ( stampstr , sizeof ( stampstr ) , "-%lld.%09lld" , dursec , durnsec ) ; } if ( dursec <= 99999ULL ) { mdb_snprintf ( stampstr , sizeof ( stampstr ) , "-%lld.%06lld" , dursec , durnsec / ( NANOSEC / MICROSEC ) ) ; } if ( dursec <= 99999999ULL ) { mdb_snprintf ( stampstr , sizeof ( stampstr ) , "-%lld.%03lld" , dursec , NSEC2MSEC ( durnsec ) ) ; } else { mdb_snprintf ( stampstr , sizeof ( stampstr ) , "-%lld" , dursec ) ; } } else { ( void ) strcpy ( stampstr , "-" ) ; } mdb_printf ( "%0?x %4d T%13s %9s %-22s %-17s\n" , addr , cur . rl_tid , stampstr , durstr , requstr , respstr ) ; if ( opt_v ) { mdb_printf ( "\tclient: %?p (%d)\tptrs: %d\tstamp: %llx\n" , cur . rl_client , cur . rl_clientid , cur . rl_num_ptrs , cur . rl_start ) ; for ( idx = 0 ; idx < MIN ( MAX_PTRS , cur . rl_num_ptrs ) ; idx ++ ) { enum_lookup ( typestr , sizeof ( typestr ) , ptr_type_enum , cur . rl_ptrs [ idx ] . rlp_type , "RC_PTR_TYPE_" , "" ) ; mdb_printf ( "\t\t%-7s %5d %?p %?p\n" , typestr , cur . rl_ptrs [ idx ] . rlp_id , cur . rl_ptrs [ idx ] . rlp_ptr , cur . rl_ptrs [ idx ] . rlp_data ) ; } mdb_printf ( "\n" ) ; } return ( DCMD_OK ) ; } 