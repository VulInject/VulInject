int radeon_gpu_reset ( struct radeon_device * rdev ) { unsigned ring_sizes [ RADEON_NUM_RINGS ] ; uint32_t * ring_data [ RADEON_NUM_RINGS ] ; bool saved = false ; int i , r ; int resched ; down_write ( & rdev -> exclusive_lock ) ; if ( ! rdev -> needs_reset ) { up_write ( & rdev -> exclusive_lock ) ; return 0 ; } atomic_inc ( & rdev -> gpu_reset_counter ) ; radeon_save_bios_scratch_regs ( rdev ) ; resched = ttm_bo_lock_delayed_workqueue ( & rdev -> mman . bdev ) ; radeon_suspend ( rdev ) ; radeon_hpd_fini ( rdev ) ; for ( i = 0 ; i < RADEON_NUM_RINGS ; ++ i ) { ring_sizes [ i ] = radeon_ring_backup ( rdev , & rdev -> ring [ i ] , & ring_data [ i ] ) ; if ( ring_sizes [ i ] ) { saved = true ; dev_info ( rdev -> dev , "Saved %d dwords of commands " "on ring %d.\n" , ring_sizes [ i ] , i ) ; } } r = radeon_asic_reset ( rdev ) ; if ( ! r ) { dev_info ( rdev -> dev , "GPU reset succeeded, trying to resume\n" ) ; radeon_resume ( rdev ) ; } radeon_restore_bios_scratch_regs ( rdev ) ; for ( i = 0 ; i < RADEON_NUM_RINGS ; ++ i ) { if ( ! r && ring_data [ i ] ) { radeon_ring_restore ( rdev , & rdev -> ring [ i ] , ring_sizes [ i ] , ring_data [ i ] ) ; } else { radeon_fence_driver_force_completion ( rdev , i ) ; } } if ( ( rdev -> pm . pm_method == PM_METHOD_DPM ) && rdev -> pm . dpm_enabled ) { r = radeon_pm_late_init ( rdev ) ; if ( r ) { rdev -> pm . dpm_enabled = false ; DRM_ERROR ( "radeon_pm_late_init failed, disabling dpm\n" ) ; } } else { radeon_pm_resume ( rdev ) ; } if ( rdev -> is_atom_bios ) { radeon_atom_encoder_init ( rdev ) ; radeon_atom_disp_eng_pll_init ( rdev ) ; if ( rdev -> mode_info . bl_encoder ) { u8 bl_level = radeon_get_backlight_level ( rdev , rdev -> mode_info . bl_encoder ) ; radeon_set_backlight_level ( rdev , rdev -> mode_info . bl_encoder , bl_level ) ; } } radeon_hpd_init ( rdev ) ; ttm_bo_unlock_delayed_workqueue ( & rdev -> mman . bdev , resched ) ; rdev -> in_reset = true ; rdev -> needs_reset = false ; downgrade_write ( & rdev -> exclusive_lock ) ; drm_helper_resume_force_mode ( rdev -> ddev ) ; if ( ( rdev -> pm . pm_method == PM_METHOD_DPM ) && rdev -> pm . dpm_enabled ) { radeon_pm_compute_clocks ( rdev ) ; } if ( ! r ) { r = radeon_ib_ring_tests ( rdev ) ; if ( r && saved ) { r = - EAGAIN ; } } else { dev_info ( rdev -> dev , "GPU reset failed\n" ) ; } rdev -> needs_reset = r == - EAGAIN ; rdev -> in_reset = false ; up_read ( & rdev -> exclusive_lock ) ; return r ; } 