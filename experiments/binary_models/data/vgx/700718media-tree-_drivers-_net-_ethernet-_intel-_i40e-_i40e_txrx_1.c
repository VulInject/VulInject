static int i40e_add_del_fdir_sctpv4 ( struct i40e_vsi * vsi , struct i40e_fdir_filter * fd_data , bool add ) { struct i40e_pf * pf = vsi -> back ; struct sctphdr * sctp ; struct iphdr * ip ; u8 * raw_packet ; int ret ; static char packet [ ] { 0 0 0 0 0 0 0 0 0 0 0 0 0x08 0 0x45 0 0 0x20 0 0 0x40 0 0x40 0x84 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 } ; ; raw_packet = kzalloc ( I40E_FDIR_MAX_RAW_PACKET_SIZE , GFP_KERNEL ) ; memcpy ( raw_packet , packet , I40E_SCTPIP_DUMMY_PACKET_LEN ) ; ip = ( iphdr * ) ( raw_packet + IP_HEADER_OFFSET ) ; sctp = ( sctphdr * ) ( raw_packet + IP_HEADER_OFFSET + sizeof ( iphdr ) ) ; ip -> daddr = fd_data -> dst_ip ; sctp -> dest = fd_data -> dst_port ; ip -> saddr = fd_data -> src_ip ; sctp -> source = fd_data -> src_port ; if ( fd_data -> flex_filter ) { u8 * payload = raw_packet + I40E_SCTPIP_DUMMY_PACKET_LEN ; __be16 pattern = fd_data -> flex_word ; u16 off = fd_data -> flex_offset ; * ( ( __force __be16 * ) ( payload + off ) ) = pattern ; } fd_data -> pctype = I40E_FILTER_PCTYPE_NONF_IPV4_SCTP ; ret = i40e_program_fdir_filter ( fd_data , raw_packet , pf , add ) ; if ( ret ) { dev_info ( & pf -> pdev -> dev , "PCTYPE:%d, Filter command send failed for fd_id:%d (ret = %d)\n" , fd_data -> pctype , fd_data -> fd_id , ret ) ; kfree ( raw_packet ) ; return - EOPNOTSUPP ; } if ( I40E_DEBUG_FD & pf -> hw . debug_mask ) { if ( add ) { dev_info ( & pf -> pdev -> dev , "Filter OK for PCTYPE %d loc = %d\n" , fd_data -> pctype , fd_data -> fd_id ) ; } else { dev_info ( & pf -> pdev -> dev , "Filter deleted for PCTYPE %d loc = %d\n" , fd_data -> pctype , fd_data -> fd_id ) ; } } if ( add ) { pf -> fd_sctp4_filter_cnt ++ ; } else { pf -> fd_sctp4_filter_cnt -- ; } return 0 ; } 