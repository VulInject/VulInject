int tomoyo_open_control ( const u8 type , struct file * file ) { struct tomoyo_io_buffer * head = kzalloc ( sizeof ( * head ) , GFP_NOFS ) ; mutex_init ( & head -> io_sem ) ; head -> type = type ; switch ( type ) { case TOMOYO_DOMAINPOLICY : head -> write = tomoyo_write_domain ; head -> read = tomoyo_read_domain ; break ; case TOMOYO_EXCEPTIONPOLICY : head -> write = tomoyo_write_exception ; head -> read = tomoyo_read_exception ; break ; case TOMOYO_AUDIT : head -> poll = tomoyo_poll_log ; head -> read = tomoyo_read_log ; break ; case TOMOYO_PROCESS_STATUS : head -> write = tomoyo_write_pid ; head -> read = tomoyo_read_pid ; break ; case TOMOYO_VERSION : head -> read = tomoyo_read_version ; head -> readbuf_size = 128 ; break ; case TOMOYO_STAT : head -> write = tomoyo_write_stat ; head -> read = tomoyo_read_stat ; head -> readbuf_size = 1024 ; break ; case TOMOYO_PROFILE : head -> write = tomoyo_write_profile ; head -> read = tomoyo_read_profile ; break ; case TOMOYO_QUERY : head -> poll = tomoyo_poll_query ; head -> write = tomoyo_write_answer ; head -> read = tomoyo_read_query ; break ; case TOMOYO_MANAGER : head -> write = tomoyo_write_manager ; head -> read = tomoyo_read_manager ; break ; } if ( ! ( file -> f_mode & FMODE_READ ) ) { head -> read = NULL ; head -> poll = NULL ; } if ( ! head -> poll ) { if ( ! head -> readbuf_size ) { head -> readbuf_size = 4096 * 2 ; } head -> read_buf = kzalloc ( head -> readbuf_size , GFP_NOFS ) ; if ( ! head -> read_buf ) { kfree ( head ) ; return - ENOMEM ; } } if ( ! ( file -> f_mode & FMODE_WRITE ) ) { head -> write = NULL ; } if ( head -> write ) { head -> writebuf_size = 4096 * 2 ; head -> write_buf = kzalloc ( head -> writebuf_size , GFP_NOFS ) ; if ( ! head -> write_buf ) { kfree ( head -> read_buf ) ; kfree ( head ) ; return - ENOMEM ; } } if ( type == TOMOYO_QUERY ) { atomic_inc ( & tomoyo_query_observers ) ; } file -> private_data = head ; tomoyo_notify_gc ( head , true ) ; return 0 ; } 