void build_font_module ( void ) { bitmap_data_t * bd ; struct font * fd ; struct preloaded_file * fp ; size_t size ; uint32_t checksum ; int i ; char * name = "console-font" ; vm_offset_t laddr ; struct font_info fi ; struct fontlist * fl ; if ( STAILQ_EMPTY ( & fonts ) ) { return ; } if ( file_findfile ( NULL , NULL ) == NULL ) { printf ( "Can not load font module: %s\n" , "the kernel is not loaded" ) ; return ; } if ( file_findfile ( name , name ) != NULL ) { printf ( "warning: '%s' is already loaded\n" , name ) ; return ; } bd = NULL ; STAILQ_FOREACH ( , , ) { if ( tems . ts_font . vf_width == fl -> font_data -> width && tems . ts_font . vf_height == fl -> font_data -> height ) { if ( fl -> font_flags == FONT_BUILTIN ) { return ; } bd = fl -> font_data ; break ; } } if ( bd == NULL ) { return ; } fd = bd -> font ; fi . fi_width = fd -> vf_width ; checksum = fi . fi_width ; fi . fi_height = fd -> vf_height ; checksum += fi . fi_height ; fi . fi_bitmap_size = bd -> uncompressed_size ; checksum += fi . fi_bitmap_size ; size = roundup2 ( sizeof ( font_info ) , 8 ) ; for ( i = 0 ; i < VFNT_MAPS ; i ++ ) { fi . fi_map_count [ i ] = fd -> vf_map_count [ i ] ; checksum += fi . fi_map_count [ i ] ; size += fd -> vf_map_count [ i ] * sizeof ( font_map ) ; size += roundup2 ( size , 8 ) ; } size += bd -> uncompressed_size ; fi . fi_checksum = - checksum ; fp = file_alloc ( ) ; if ( fp != NULL ) { fp -> f_name = strdup ( name ) ; fp -> f_type = strdup ( name ) ; } if ( fp == NULL || fp -> f_name == NULL || fp -> f_type == NULL ) { printf ( "Can not load font module: %s\n" , "out of memory" ) ; file_discard ( fp , NULL ) ; return ; } if ( archsw . arch_loadaddr != NULL ) { loadaddr = archsw . arch_loadaddr ( LOAD_MEM , & size , loadaddr ) ; } if ( loadaddr == 0 ) { printf ( "Can not load font module: %s\n" , "out of memory" ) ; file_discard ( fp ) ; return ; } laddr = loadaddr ; laddr += archsw . arch_copyin ( & fi , laddr , sizeof ( font_info ) ) ; laddr = roundup2 ( laddr , 8 ) ; for ( i = 0 ; i < VFNT_MAPS ; i ++ ) { if ( fd -> vf_map_count [ i ] != 0 ) { laddr += archsw . arch_copyin ( fd -> vf_map [ i ] , laddr , fd -> vf_map_count [ i ] * sizeof ( font_map ) ) ; laddr = roundup2 ( laddr , 8 ) ; } } laddr += archsw . arch_copyin ( fd -> vf_bytes , laddr , fi . fi_bitmap_size ) ; module_hash ( fp , PTOV ( loadaddr ) , laddr - loadaddr ) ; fp -> f_loader = - 1 ; fp -> f_addr = loadaddr ; fp -> f_size = laddr - loadaddr ; loadaddr = laddr ; file_insert_tail ( fp ) ; } 