static int set_variable ( struct scsi_cmnd * srb , struct rtsx_chip * chip ) { unsigned int lun = SCSI_LUN ( srb ) ; if ( srb -> cmnd [ 3 ] == 1 ) { struct xd_info * xd_card = & chip -> xd_card ; struct sd_info * sd_card = & chip -> sd_card ; struct ms_info * ms_card = & chip -> ms_card ; switch ( srb -> cmnd [ 4 ] ) { case XD_CARD : xd_card -> xd_clock = srb -> cmnd [ 5 ] ; break ; case SD_CARD : sd_card -> sd_clock = srb -> cmnd [ 5 ] ; break ; case MS_CARD : ms_card -> ms_clock = srb -> cmnd [ 5 ] ; break ; default : set_sense_type ( chip , lun , SENSE_TYPE_MEDIA_INVALID_CMD_FIELD ) ; rtsx_trace ( chip , NULL ) ; return TRANSPORT_FAILED ; } } if ( srb -> cmnd [ 3 ] == 2 ) { if ( srb -> cmnd [ 4 ] ) { chip -> blink_led = 1 ; } else { int retval ; chip -> blink_led = 0 ; rtsx_disable_aspm ( chip ) ; if ( chip -> ss_en && ( rtsx_get_stat ( chip ) == RTSX_STAT_SS ) ) { rtsx_exit_ss ( chip ) ; wait_timeout ( 100 ) ; } rtsx_set_stat ( chip , RTSX_STAT_RUN ) ; retval = rtsx_force_power_on ( chip , SSC_PDCTL ) ; if ( retval != STATUS_SUCCESS ) { set_sense_type ( chip , SCSI_LUN ( srb ) , SENSE_TYPE_MEDIA_WRITE_ERR ) ; rtsx_trace ( chip ) ; return TRANSPORT_FAILED ; } turn_off_led ( chip , LED_GPIO ) ; } } else { set_sense_type ( chip , lun , SENSE_TYPE_MEDIA_INVALID_CMD_FIELD ) ; rtsx_trace ( chip ) ; return TRANSPORT_FAILED ; } return TRANSPORT_GOOD ; } 