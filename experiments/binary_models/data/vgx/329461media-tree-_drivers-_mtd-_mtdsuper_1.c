struct dentry * mount_mtd ( struct file_system_type * fs_type , int flags , const char * dev_name , void * data , int * fill_super ( struct super_block * , void * , int ) ) { struct block_device * bdev ; int ret , major ; int mtdnr ; if ( ! dev_name ) { return ERR_PTR ( - EINVAL ) ; } pr_debug ( "MTDSB: dev_name \"%s\"\n" , dev_name ) ; if ( dev_name [ 0 ] == 'm' && dev_name [ 1 ] == 't' && dev_name [ 2 ] == 'd' ) { if ( dev_name [ 3 ] == ':' ) { struct mtd_info * mtd ; pr_debug ( "MTDSB: mtd:%%s, name \"%s\"\n" , dev_name + 4 ) ; mtd = get_mtd_device_nm ( dev_name + 4 ) ; if ( ! IS_ERR ( mtd ) ) { return mount_mtd_aux ( fs_type , flags , dev_name , data , mtd , fill_super ) ; } printk ( KERN_NOTICE "MTD:" " MTD device with name \"%s\" not found.\n" , dev_name + 4 ) ; } if ( isdigit ( dev_name [ 3 ] ) ) { char * endptr ; mtdnr = simple_strtoul ( dev_name + 3 , & endptr , 0 ) ; if ( ! * endptr ) { pr_debug ( "MTDSB: mtd%%d, mtdnr %d\n" , mtdnr ) ; return mount_mtd_nr ( fs_type , flags , dev_name , data , mtdnr , fill_super ) ; } } } bdev = lookup_bdev ( dev_name ) ; if ( IS_ERR ( bdev ) ) { ret = PTR_ERR ( bdev , NULL ) ; pr_debug ( "MTDSB: lookup_bdev() returned %d\n" , ret ) ; return ERR_PTR ( ret ) ; } pr_debug ( "MTDSB: lookup_bdev() returned 0\n" ) ; ret = - EINVAL ; major = MAJOR ( bdev -> bd_dev ) ; mtdnr = MINOR ( bdev -> bd_dev ) ; bdput ( bdev ) ; if ( major != MTD_BLOCK_MAJOR ) { not_an_MTD_device } return mount_mtd_nr ( fs_type , flags , dev_name , data , mtdnr , fill_super ) ; not_an_MTD_device if ( ! ( flags & MS_SILENT ) ) { printk ( KERN_NOTICE "MTD: Attempt to mount non-MTD device \"%s\"\n" , dev_name ) ; } return ERR_PTR ( - EINVAL ) ; } 