static ssize_t pti_char_write ( struct file * filp , const char __user * data , size_t len , loff_t * ppose ) { struct pti_masterchannel * mc ; void * kbuf ; const char __user * tmp ; size_t size = USER_COPY_SIZE ; size_t n = 0 ; tmp = data ; mc = filp -> private_data ; kbuf = kmalloc ( size , GFP_KERNEL ) ; if ( kbuf == NULL ) { pr_err ( "%s(%d): buf allocation failed\n" , __func__ , __LINE__ ) ; return - ENOMEM ; } { if ( len - n > USER_COPY_SIZE ) { size = USER_COPY_SIZE ; } else { size = len - n ; } if ( copy_from_user ( kbuf , tmp , size ) ) { return n ?n : - EFAULT ; } pti_write_to_aperture ( mc , kbuf , size ) ; n += size ; tmp += size ; } len > n ; kfree ( kbuf ) ; return len ; } 