u32 i915_get_vblank_counter ( struct drm_crtc * crtc ) { struct drm_i915_private * dev_priv = to_i915 ( crtc -> dev ) ; struct drm_vblank_crtc * vblank = & dev_priv -> drm . vblank [ drm_crtc_index ( crtc ) ] ; const struct drm_display_mode * mode = & vblank -> hwmode ; enum pipe pipe = to_intel_crtc ( crtc ) -> pipe ; u32 pixel , vbl_start , hsync_start , htotal ; u64 frame ; htotal = mode -> crtc_htotal ; hsync_start = mode -> crtc_hsync_start ; vbl_start = mode -> crtc_vblank_start ; if ( mode -> flags & DRM_MODE_FLAG_INTERLACE ) { vbl_start = DIV_ROUND_UP ( vbl_start , 2 ) ; } vbl_start *= htotal ; vbl_start -= htotal - hsync_start ; frame = intel_de_read64_2x32 ( dev_priv , PIPEFRAMEPIXEL ( pipe ) , PIPEFRAME ( pipe ) ) ; pixel = frame & PIPE_PIXEL_MASK ; frame = ( frame >> PIPE_FRAME_LOW_SHIFT ) & 0xffffff ; return ( frame + ( pixel >= vbl_start ) ) & 0xffffff ; } 