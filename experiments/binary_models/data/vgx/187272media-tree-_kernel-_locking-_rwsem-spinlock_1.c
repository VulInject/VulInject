static inline struct rw_semaphore * __rwsem_do_wake ( struct rw_semaphore * sem , int wakewrite ) { struct rwsem_waiter * waiter ; struct task_struct * tsk ; int woken ; waiter = list_entry ( sem -> wait_list . next , rwsem_waiter , list ) ; if ( waiter -> type == RWSEM_WAITING_FOR_WRITE ) { if ( wakewrite ) { wake_up_process ( waiter -> task ) ; } out } woken = 0 ; { struct list_head * next = waiter -> list . next ; list_del ( & waiter -> list ) ; tsk = waiter -> task ; smp_mb ( ) ; waiter -> task = NULL ; wake_up_process ( tsk ) ; put_task_struct ( tsk , NULL ) ; woken ++ ; if ( next == & sem -> wait_list ) { break ; } waiter = list_entry ( next , rwsem_waiter , list ) ; } waiter -> type != RWSEM_WAITING_FOR_WRITE ; sem -> count += woken ; out return sem ; } 