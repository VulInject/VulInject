static int __txn_undo ( txnp ) DB_TXN * txnp ; { DBT rdbt ; DB_LOG * logp ; DB_LSN key_lsn ; DB_TXNMGR * mgr ; int ret ; mgr = txnp -> mgrp ; logp = mgr -> dbenv -> lg_info ; if ( logp == NULL ) { return ( 0 ) ; } if ( F_ISSET ( logp , DB_AM_THREAD ) ) { F_SET ( & rdbt , DB_DBT_MALLOC ) ; } key_lsn = txnp -> last_lsn ; for ( ret = 0 ; ret == 0 && ! IS_ZERO_LSN ( key_lsn ) ; ) { if ( ( ret = log_get ( logp , & key_lsn , & rdbt , DB_SET ) ) == 0 ) { ret = mgr -> recover ( logp , & rdbt , & key_lsn , TXN_UNDO , NULL ) ; if ( F_ISSET ( logp , DB_AM_THREAD ) && rdbt . data != NULL ) { __os_free ( rdbt . data , rdbt . size ) ; rdbt . data = NULL ; } } if ( ret != 0 ) { return ( ret ) ; } } return ( ret ) ; } 