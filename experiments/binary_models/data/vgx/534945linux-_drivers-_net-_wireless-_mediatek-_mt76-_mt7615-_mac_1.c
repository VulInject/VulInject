static void mt7615_mac_update_rate_desc ( struct mt7615_phy * phy , struct mt7615_sta * sta , struct ieee80211_tx_rate * probe_rate , struct ieee80211_tx_rate * rates , struct mt7615_rate_desc * rd ) { struct mt7615_dev * dev = phy -> dev ; struct mt76_phy * mphy = phy -> mt76 ; struct ieee80211_tx_rate * ref ; bool rateset , stbc = false ; int n_rates = sta -> n_rates ; u8 bw , bw_prev ; int i , j ; for ( i = n_rates ; i < 4 ; i ++ ) { rates [ i ] = rates [ n_rates - 1 ] ; } rateset = ! ( sta -> rate_set_tsf & BIT ( 0 ) ) ; memcpy ( sta -> rateset [ rateset ] . rates , rates , sizeof ( sta -> rateset [ rateset ] . rates ) ) ; if ( probe_rate ) { sta -> rateset [ rateset ] . probe_rate = * probe_rate ; ref = & sta -> rateset [ rateset ] . probe_rate ; } else { sta -> rateset [ rateset ] . probe_rate . idx = - 1 ; ref = & sta -> rateset [ rateset ] . rates [ 0 ] ; } rates = sta -> rateset [ rateset ] . rates ; for ( i = 0 ; i < ARRAY_SIZE ( sta -> rateset [ rateset ] . rates ) ; i ++ ) { if ( ( ref -> flags ^ rates [ i ] . flags ) & IEEE80211_TX_RC_SHORT_GI ) { rates [ i ] . flags ^= IEEE80211_TX_RC_SHORT_GI ; } for ( j = 0 ; j < i ; j ++ ) { if ( rates [ i ] . idx != rates [ j ] . idx ) { continue ; } if ( ( rates [ i ] . flags ^ rates [ j ] . flags ) & ( IEEE80211_TX_RC_40_MHZ_WIDTH | IEEE80211_TX_RC_80_MHZ_WIDTH | IEEE80211_TX_RC_160_MHZ_WIDTH ) ) { continue ; } rates [ i ] . idx -- ; } } rd -> val [ 0 ] = mt7615_mac_tx_rate_val ( dev , mphy , & rates [ 0 ] , stbc , & bw ) ; bw_prev = bw ; if ( probe_rate ) { rd -> probe_val = mt7615_mac_tx_rate_val ( dev , mphy , probe_rate , stbc , & bw ) ; if ( bw ) { rd -> bw_idx = 1 ; } else { bw_prev = 0 ; } } else { rd -> probe_val = rd -> val [ 0 ] ; } rd -> val [ 1 ] = mt7615_mac_tx_rate_val ( dev , mphy , & rates [ 1 ] , stbc , & bw ) ; if ( bw_prev ) { rd -> bw_idx = 3 ; bw_prev = bw ; } rd -> val [ 2 ] = mt7615_mac_tx_rate_val ( dev , mphy , & rates [ 2 ] , stbc , & bw ) ; if ( bw_prev ) { rd -> bw_idx = 5 ; bw_prev = bw ; } rd -> val [ 3 ] = mt7615_mac_tx_rate_val ( dev , mphy , & rates [ 3 ] , stbc , & bw ) ; if ( bw_prev ) { rd -> bw_idx = 7 ; } rd -> rateset = rateset ; rd -> bw = bw ; } 