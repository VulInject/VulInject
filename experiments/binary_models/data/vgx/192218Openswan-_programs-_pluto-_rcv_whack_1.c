void whack_handle ( int whackctlfd ) { struct whack_message msg , msg_saved ; struct sockaddr_un whackaddr ; socklen_t whackaddrlen = sizeof ( whackaddr ) ; int whackfd = accept ( whackctlfd , ( sockaddr * ) & whackaddr , & whackaddrlen ) ; ssize_t n ; if ( whackfd < 0 ) { log_errno ( ( e , "accept() failed in whack_handle()" ) ) ; return ; } if ( fcntl ( whackfd , F_SETFD , FD_CLOEXEC ) < 0 ) { log_errno ( ( e , "failed to set CLOEXEC in whack_handle()" ) ) ; close ( whackfd ) ; return ; } n = read ( whackfd , & msg , sizeof ( msg ) ) ; if ( n <= 0 ) { log_errno ( ( e , "read() failed in whack_handle()" ) ) ; close ( whackfd ) ; return ; } whack_log_fd = whackfd ; msg_saved = msg ; { err_t ugh = NULL ; struct whackpacker wp ; wp . msg = & msg ; wp . n = n ; wp . cnt = 0 ; wp . str_next = msg . string ; wp . str_roof = ( unsigned char * ) & msg + n ; if ( ( size_t ) n < offsetof ( whack_message , whack_shutdown ) + sizeof ( msg . whack_shutdown ) ) { ugh = builddiag ( "ignoring runt message from whack: got %d bytes" , ( int ) n ) ; } if ( msg . magic != WHACK_MAGIC ) { if ( msg . magic == WHACK_BASIC_MAGIC ) { if ( msg . whack_status ) { show_status ( ) ; } if ( msg . whack_shutdown ) { openswan_log ( "shutting down" ) ; exit_pluto ( 0 ) ; } ugh = "" ; } else { ugh = builddiag ( "ignoring message from whack with bad magic %08x; should be %08x; Mismatched versions of userland tools and PLUTO code." , msg . magic , WHACK_MAGIC ) ; } } if ( ( ugh = unpack_whack_msg ( & wp ) ) != NULL ) { } else { msg . keyval . ptr = wp . str_next ; } if ( ugh != NULL ) { if ( * ugh != '\0' ) { loglog ( RC_BADWHACKMESSAGE , "%s" , ugh ) ; } whack_log_fd = NULL_FD ; close ( whackfd ) ; return ; } } writewhackrecord ( ( char * ) & msg_saved , n ) ; whack_process ( whackfd , msg ) ; } 