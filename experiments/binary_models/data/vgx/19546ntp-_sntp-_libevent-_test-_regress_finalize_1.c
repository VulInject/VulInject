static void test_fin_cb_invoked ( void * arg ) { struct basic_test_data * data = arg ; struct event_base * base = data -> base ; struct event * ev ; struct event ev2 ; struct event_callback evcb ; int cb_called = 0 ; int ev_called = 0 ; const struct timeval ten_sec = { 10 0 } ; event_deferred_cb_init_ ( & evcb , 0 , simple_callback , & cb_called ) ; ev = evtimer_new ( base , timer_callback , & ev_called ) ; event_free_finalize ( 0 , ev , event_finalize_callback_1 ) ; event_callback_finalize_ ( base , 0 , & evcb , callback_finalize_callback_1 ) ; event_base_dispatch ( base ) ; tt_int_op ( cb_called , == , 100 ) ; tt_int_op ( ev_called , == , 100 ) ; ev_called = cb_called = 0 ; ev = evtimer_new ( base , timer_callback , & ev_called ) ; event_deferred_cb_init_ ( & evcb , 0 , simple_callback , & cb_called ) ; event_active ( ev , EV_TIMEOUT , 1 ) ; event_callback_activate_ ( base , & evcb ) ; event_base_dispatch ( base ) ; tt_int_op ( cb_called , == , 1 ) ; tt_int_op ( ev_called , == , 1 ) ; ev_called = cb_called = 0 ; event_base_assert_ok_ ( base ) ; event_active ( ev , EV_TIMEOUT , 1 ) ; event_callback_activate_ ( base , & evcb ) ; event_free_finalize ( 0 , ev , event_finalize_callback_1 ) ; event_callback_finalize_ ( base , 0 , & evcb , callback_finalize_callback_1 ) ; event_base_dispatch ( base ) ; tt_int_op ( cb_called , == , 100 ) ; tt_int_op ( ev_called , == , 100 ) ; ev_called = 0 ; event_base_assert_ok_ ( base ) ; ev = evtimer_new ( base , timer_callback , & ev_called ) ; event_add ( ev , & ten_sec ) ; event_free_finalize ( 0 , ev , event_finalize_callback_1 ) ; event_base_dispatch ( base ) ; tt_int_op ( ev_called , == , 100 ) ; ev_called = 0 ; event_base_assert_ok_ ( base ) ; ev = evtimer_new ( base , timer_callback , & ev_called ) ; evtimer_assign ( & ev2 , base , timer_callback , & ev_called ) ; event_add ( ev , & ten_sec ) ; event_free_finalize ( 0 , ev , event_finalize_callback_1 ) ; event_finalize ( 0 , & ev2 , event_finalize_callback_1 ) ; event_add ( & ev2 , & ten_sec ) ; event_del ( ev ) ; event_active ( & ev2 , EV_TIMEOUT , 1 ) ; event_base_dispatch ( base ) ; tt_int_op ( ev_called , == , 200 ) ; event_base_assert_ok_ ( base ) ; end } 