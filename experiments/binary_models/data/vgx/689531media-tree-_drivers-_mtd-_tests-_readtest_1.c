static int read_eraseblock_by_page ( int ebnum ) { int i , ret , err = 0 ; loff_t addr = ( loff_t ) ebnum * mtd -> erasesize ; void * buf = iobuf ; void * oobbuf = iobuf1 ; for ( i = 0 ; i < pgcnt ; i ++ ) { ret = mtdtest_read ( mtd , addr , pgsize , buf ) ; if ( ret ) { if ( ! err ) { err = ret ; } } if ( mtd -> oobsize ) { struct mtd_oob_ops ops ; ops . mode = MTD_OPS_PLACE_OOB ; ops . len = 0 ; ops . retlen = 0 ; ops . ooblen = mtd -> oobsize ; ops . oobretlen = 0 ; ops . ooboffs = 0 ; ops . datbuf = NULL ; ops . oobbuf = oobbuf ; ret = mtd_read_oob ( mtd , addr , & ops ) ; if ( ( ret && ! mtd_is_bitflip ( ret ) ) || ops . oobretlen != mtd -> oobsize ) { pr_err ( "error: read oob failed at " "%#llx\n" , ( long long ) addr ) ; if ( ! err ) { err = ret ; } if ( ! err ) { err = - EINVAL ; } } oobbuf += mtd -> oobsize ; } addr += pgsize ; buf += pgsize ; } return err ; } 