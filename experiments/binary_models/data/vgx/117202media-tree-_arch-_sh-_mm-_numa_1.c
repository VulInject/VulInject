void __init setup_bootmem_node ( int nid , unsigned long start , unsigned long end ) { unsigned long bootmap_pages ; unsigned long start_pfn , end_pfn ; unsigned long bootmem_paddr ; BUG_ON ( nid >= MAX_NUMNODES || nid <= 0 ) ; start_pfn = PFN_DOWN ( start ) ; end_pfn = PFN_DOWN ( end ) ; pmb_bolt_mapping ( ( unsigned long ) __va ( start ) , start , end - start , PAGE_KERNEL ) ; memblock_add ( start , end - start ) ; __add_active_range ( nid , start_pfn , end_pfn ) ; NODE_DATA ( nid ) = __va ( memblock_alloc_base ( sizeof ( pglist_data ) , SMP_CACHE_BYTES , end ) ) ; NODE_DATA ( nid ) -> bdata = & bootmem_node_data [ nid ] ; NODE_DATA ( nid ) -> node_start_pfn = start_pfn ; NODE_DATA ( nid ) -> node_spanned_pages = end_pfn - start_pfn ; bootmap_pages = bootmem_bootmap_pages ( end_pfn - start_pfn ) ; bootmem_paddr = memblock_alloc_base ( bootmap_pages << PAGE_SHIFT , PAGE_SIZE , end ) ; init_bootmem_node ( NODE_DATA ( nid ) , bootmem_paddr >> PAGE_SHIFT , start_pfn , end_pfn ) ; free_bootmem_with_active_regions ( nid , end_pfn ) ; reserve_bootmem_node ( NODE_DATA ( nid ) , start_pfn << PAGE_SHIFT , sizeof ( pglist_data ) , BOOTMEM_DEFAULT ) ; reserve_bootmem_node ( NODE_DATA ( nid ) , bootmem_paddr , bootmap_pages << PAGE_SHIFT , BOOTMEM_DEFAULT ) ; node_set_online ( nid ) ; sparse_memory_present_with_active_regions ( nid ) ; } 