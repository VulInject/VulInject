static int json_print ( const struct mosquitto_message * message , const mosquitto_property * properties , const struct tm * ti , int ns , bool escaped , bool pretty ) { char buf [ 100 ] ; cJSON * root ; cJSON * tmp ; char * json_str ; const char * return_parse_end ; root = cJSON_CreateObject ( ) ; if ( root == NULL ) { return MOSQ_ERR_NOMEM ; } format_time_8601 ( ti , ns , buf , sizeof ( buf ) ) ; tmp = cJSON_CreateStringReference ( buf ) ; if ( tmp == NULL ) { cJSON_Delete ( root , NULL ) ; return MOSQ_ERR_NOMEM ; } cJSON_AddItemToObject ( root , "tst" , tmp ) ; tmp = cJSON_CreateString ( message -> topic ) ; if ( tmp == NULL ) { cJSON_Delete ( root ) ; return MOSQ_ERR_NOMEM ; } cJSON_AddItemToObject ( root , "topic" , tmp ) ; tmp = cJSON_CreateNumber ( message -> qos ) ; if ( tmp == NULL ) { cJSON_Delete ( root ) ; return MOSQ_ERR_NOMEM ; } cJSON_AddItemToObject ( root , "qos" , tmp ) ; tmp = cJSON_CreateNumber ( message -> retain ) ; if ( tmp == NULL ) { cJSON_Delete ( root ) ; return MOSQ_ERR_NOMEM ; } cJSON_AddItemToObject ( root , "retain" , tmp ) ; tmp = cJSON_CreateNumber ( message -> payloadlen ) ; if ( tmp == NULL ) { cJSON_Delete ( root ) ; return MOSQ_ERR_NOMEM ; } cJSON_AddItemToObject ( root , "payloadlen" , tmp ) ; if ( message -> qos > 0 ) { tmp = cJSON_CreateNumber ( message -> mid ) ; if ( tmp == NULL ) { cJSON_Delete ( root ) ; return MOSQ_ERR_NOMEM ; } cJSON_AddItemToObject ( root , "mid" , tmp ) ; } if ( properties ) { if ( json_print_properties ( root , properties ) ) { cJSON_Delete ( root ) ; return MOSQ_ERR_NOMEM ; } } if ( escaped ) { if ( message -> payload ) { tmp = cJSON_CreateString ( message -> payload ) ; } else { tmp = cJSON_CreateNull ( ) ; } if ( tmp == NULL ) { cJSON_Delete ( root ) ; return MOSQ_ERR_NOMEM ; } cJSON_AddItemToObject ( root , "payload" , tmp ) ; } else { return_parse_end = NULL ; if ( message -> payload ) { tmp = cJSON_ParseWithOpts ( message -> payload , & return_parse_end , true ) ; if ( tmp == NULL || return_parse_end != ( char * ) message -> payload + message -> payloadlen ) { cJSON_Delete ( root ) ; return MOSQ_ERR_INVAL ; } } else { tmp = cJSON_CreateNull ( ) ; if ( tmp == NULL ) { cJSON_Delete ( root ) ; return MOSQ_ERR_INVAL ; } } cJSON_AddItemToObject ( root , "payload" , tmp ) ; } if ( pretty ) { json_str = cJSON_Print ( root ) ; } else { json_str = cJSON_PrintUnformatted ( root ) ; } cJSON_Delete ( root ) ; if ( json_str == NULL ) { return MOSQ_ERR_NOMEM ; } fputs ( json_str , stdout ) ; free ( json_str ) ; return MOSQ_ERR_SUCCESS ; UNUSED ( properties ) ; UNUSED ( pretty ) ; format_time_8601 ( ti , ns , buf , sizeof ( buf ) ) ; printf ( "{\"tst\":\"%s\",\"topic\":\"%s\",\"qos\":%d,\"retain\":%d,\"payloadlen\":%d," , buf , message -> topic , message -> qos , message -> retain , message -> payloadlen ) ; if ( message -> qos > 0 ) { printf ( "\"mid\":%d," , message -> mid ) ; } if ( escaped ) { fputs ( "\"payload\":\"" , stdout ) ; write_json_payload ( message -> payload , message -> payloadlen ) ; fputs ( "\"}" , stdout ) ; } else { fputs ( "\"payload\":" , stdout ) ; write_payload ( message -> payload , message -> payloadlen , 0 , 0 , 0 , 0 , 0 ) ; fputs ( "}" , stdout ) ; } return MOSQ_ERR_SUCCESS ; } 