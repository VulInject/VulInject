static int ds1305_get_time ( struct device * dev , struct rtc_time * time ) { struct ds1305 * ds1305 = dev_get_drvdata ( dev ) ; u8 addr = DS1305_SEC ; u8 buf [ DS1305_RTC_LEN ] ; int status ; status = spi_write_then_read ( ds1305 -> spi , & addr , sizeof ( addr ) , buf , sizeof ( buf ) ) ; if ( status < 0 ) { return status ; } dev_vdbg ( dev , "%s: %3ph, %4ph\n" , "read" , & buf [ 0 ] , & buf [ 3 ] ) ; time -> tm_sec = bcd2bin ( buf [ DS1305_SEC ] ) ; time -> tm_min = bcd2bin ( buf [ DS1305_MIN ] ) ; time -> tm_hour = bcd2hour ( buf [ DS1305_HOUR ] , NULL ) ; time -> tm_wday = buf [ DS1305_WDAY ] - 1 ; time -> tm_mday = bcd2bin ( buf [ DS1305_MDAY ] ) ; time -> tm_mon = bcd2bin ( buf [ DS1305_MON ] ) - 1 ; time -> tm_year = bcd2bin ( buf [ DS1305_YEAR ] ) + 100 ; dev_vdbg ( dev , "%s secs=%d, mins=%d, " "hours=%d, mday=%d, mon=%d, year=%d, wday=%d\n" , "read" , time -> tm_sec , time -> tm_min , time -> tm_hour , time -> tm_mday , time -> tm_mon , time -> tm_year , time -> tm_wday ) ; return rtc_valid_tm ( time ) ; } 