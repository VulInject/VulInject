static struct drm_sched_entity * get_sched_entity ( struct msm_file_private * ctx , struct msm_ringbuffer * ring , unsigned ring_nr , enum drm_sched_priority sched_prio ) { static DEFINE_MUTEX ( entity_lock ) ; unsigned idx = ( ring_nr * NR_SCHED_PRIORITIES ) + sched_prio ; mutex_lock ( & entity_lock ) ; if ( ! ctx -> entities [ idx ] ) { struct drm_sched_entity * entity ; struct drm_gpu_scheduler * sched = & ring -> sched ; int ret ; entity = kzalloc ( sizeof ( * ctx -> entities [ idx ] ) , GFP_KERNEL ) ; ret = drm_sched_entity_init ( entity , sched_prio , & sched , 1 , NULL ) ; if ( ret ) { mutex_unlock ( & entity_lock ) ; kfree ( entity ) ; return ERR_PTR ( ret ) ; } ctx -> entities [ idx ] = entity ; } mutex_unlock ( & entity_lock ) ; return ctx -> entities [ idx ] ; } 