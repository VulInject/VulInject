hma_fpu_xsave_result_t hma_fpu_set_xsave_state ( hma_fpu_t * fpu , void * buf , size_t len ) { ASSERT ( ! fpu -> hf_inguest ) ; if ( len < MIN_XSAVE_SIZE ) { return ( HFXR_NO_SPACE ) ; } if ( ( ( uintptr_t ) buf & 63 ) != 0 ) { return ( HFXR_BAD_ALIGN ) ; } struct xsave_header * hdr = buf + sizeof ( fxsave_state ) ; if ( hdr -> xsh_xcomp_bv != 0 ) { return ( HFXR_UNSUP_FMT ) ; } uint64_t allowed_bits ; size_t save_area_size ; switch ( fp_save_mech ) { case FP_FXSAVE : allowed_bits = XFEATURE_LEGACY_FP | XFEATURE_SSE ; save_area_size = sizeof ( fxsave_state ) ; break ; case FP_XSAVE : allowed_bits = get_xcr ( XFEATURE_ENABLED_MASK ) ; save_area_size = cpuid_get_xsave_size ( ) ; break ; default : panic ( "Invalid fp_save_mech" ) ; } if ( ( hdr -> xsh_xstate_bv & ~ ( allowed_bits ) ) != 0 ) { return ( HFXR_UNSUP_FEAT ) ; } fpu_ctx_t temp_ctx = { . fpu_xsave_mask = XFEATURE_FP_ALL } ; temp_ctx . fpu_regs . kfpu_u . kfpu_generic = kmem_cache_alloc ( fpsave_cachep , KM_SLEEP ) ; bzero ( temp_ctx . fpu_regs . kfpu_u . kfpu_generic , save_area_size ) ; ulong_t iflag ; iflag = intr_clear ( ) ; bool disable_when_done = ( getcr0 ( ) & CR0_TS ) != 0 ; do_fp_save ( & temp_ctx ) ; on_trap_data_t otd ; volatile hma_fpu_xsave_result_t res = HFXR_OK ; if ( on_trap ( & otd , OT_DATA_EC ) != 0 ) { res = HFXR_INVALID_DATA ; done } switch ( fp_save_mech ) { case FP_FXSAVE : if ( hdr -> xsh_xstate_bv == 0 ) { bcopy ( & sse_initial , fpu -> hf_guest_fpu . fpu_regs . kfpu_u . kfpu_fx , sizeof ( sse_initial ) ) ; } else { fpxrestore ( buf ) ; fpxsave ( fpu -> hf_guest_fpu . fpu_regs . kfpu_u . kfpu_fx ) ; } break ; case FP_XSAVE : xrestore ( buf , XFEATURE_FP_ALL ) ; xsavep ( fpu -> hf_guest_fpu . fpu_regs . kfpu_u . kfpu_xs , fpu -> hf_guest_fpu . fpu_xsave_mask ) ; break ; default : panic ( "Invalid fp_save_mech" ) ; } done no_trap ( ) ; fp_restore ( & temp_ctx ) ; if ( disable_when_done ) { fpdisable ( ) ; } intr_restore ( iflag , NULL ) ; kmem_cache_free ( fpsave_cachep , temp_ctx . fpu_regs . kfpu_u . kfpu_generic ) ; return ( res ) ; } 