bool shdma_reset ( struct shdma_dev * sdev ) { const struct shdma_ops * ops = sdev -> ops ; struct shdma_chan * schan ; int handled = 0 ; int i ; shdma_for_each_chan ( , , ) { struct shdma_desc * sdesc ; LIST_HEAD ( dl ) ; if ( ! schan ) { continue ; } spin_lock ( & schan -> chan_lock ) ; ops -> halt_channel ( schan ) ; list_splice_init ( & schan -> ld_queue , & dl ) ; if ( ! list_empty ( & dl ) ) { dev_dbg ( schan -> dev , "Bring down channel %d\n" , schan -> id ) ; pm_runtime_put ( schan -> dev ) ; } schan -> pm_state = SHDMA_PM_ESTABLISHED ; spin_unlock ( & schan -> chan_lock ) ; list_for_each_entry ( , , ) { struct dma_async_tx_descriptor * tx = & sdesc -> async_tx ; sdesc -> mark = DESC_IDLE ; dmaengine_desc_get_callback_invoke ( tx , NULL ) ; } spin_lock ( & schan -> chan_lock ) ; list_splice ( & dl , & schan -> ld_free ) ; spin_unlock ( & schan -> chan_lock ) ; handled ++ ; } return ! ! handled ; } 