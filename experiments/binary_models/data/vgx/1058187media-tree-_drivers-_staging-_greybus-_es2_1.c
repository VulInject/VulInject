static void message_cancel ( struct gb_message * message ) { struct gb_host_device * hd = message -> operation -> connection -> hd ; struct es2_ap_dev * es2 = hd_to_es2 ( hd ) ; struct urb * urb ; int i ; might_sleep ( ) ; spin_lock_irq ( & es2 -> cport_out_urb_lock ) ; urb = message -> hcpriv ; usb_get_urb ( urb ) ; for ( i = 0 ; i < NUM_CPORT_OUT_URB ; ++ i ) { if ( urb == es2 -> cport_out_urb [ i ] ) { es2 -> cport_out_urb_cancelled [ i ] = true ; break ; } } spin_unlock_irq ( & es2 -> cport_out_urb_lock ) ; usb_kill_urb ( urb ) ; if ( i < NUM_CPORT_OUT_URB ) { spin_lock_irq ( & es2 -> cport_out_urb_lock ) ; es2 -> cport_out_urb_cancelled [ i ] = false ; spin_unlock_irq ( & es2 -> cport_out_urb_lock ) ; } } 