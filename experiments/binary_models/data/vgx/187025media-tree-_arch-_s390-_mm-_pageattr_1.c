static int split_pmd_page ( pmd_t * pmdp , unsigned long addr ) { unsigned long pte_addr , prot ; pte_t * pt_dir , * ptep ; pmd_t new ; int i , ro , nx ; pt_dir = vmem_pte_alloc ( ) ; pte_addr = pmd_pfn ( * pmdp ) << PAGE_SHIFT ; ro = ! ! ( pmd_val ( * pmdp ) & _SEGMENT_ENTRY_PROTECT ) ; nx = ! ! ( pmd_val ( * pmdp ) & _SEGMENT_ENTRY_NOEXEC ) ; prot = pgprot_val ( ro ?PAGE_KERNEL_RO : PAGE_KERNEL ) ; if ( ! nx ) { prot &= ~ _PAGE_NOEXEC ; } ptep = pt_dir ; for ( i = 0 ; i < PTRS_PER_PTE ; i ++ ) { pte_val ( * ptep ) = pte_addr | prot ; pte_addr += PAGE_SIZE ; ptep ++ ; } pmd_val ( new ) = __pa ( pt_dir ) | _SEGMENT_ENTRY ; pgt_set ( ( unsigned long * ) pmdp , pmd_val ( new ) , addr , CRDTE_DTT_SEGMENT ) ; update_page_count ( PG_DIRECT_MAP_4K , PTRS_PER_PTE ) ; update_page_count ( PG_DIRECT_MAP_1M , - 1 ) ; return 0 ; } 