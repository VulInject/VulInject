static int zynq_load ( xilinx_desc * desc , const void * buf , size_t bsize , bitstream_type bstype , int flags ) { unsigned long ts ; u32 isr_status , swap ; buf = zynq_align_dma_buffer ( ( u32 * ) buf , bsize , swap ) ; debug ( "%s: Source = 0x%08X\n" , __func__ , ( u32 ) buf ) ; debug ( "%s: Size = %zu\n" , __func__ , bsize ) ; flush_dcache_range ( ( u32 ) buf , ( u32 ) buf + roundup ( bsize , ARCH_DMA_MINALIGN ) ) ; if ( zynq_dma_transfer ( ( u32 ) buf | 1 , bsize >> 2 , 0xffffffff , 0 ) ) { return FPGA_FAIL ; } isr_status = readl ( & devcfg_base -> int_sts ) ; ts = get_timer ( 0 ) ; while ( ! ( isr_status & DEVCFG_ISR_PCFG_DONE ) ) { if ( get_timer ( ts ) > CFG_SYS_FPGA_WAIT ) { printf ( "%s: Timeout wait for FPGA to config\n" , __func__ ) ; return FPGA_FAIL ; } isr_status = readl ( & devcfg_base -> int_sts ) ; } debug ( "%s: FPGA config done\n" , __func__ ) ; if ( bstype != BIT_PARTIAL ) { zynq_slcr_devcfg_enable ( ) ; } if ( ! IS_ENABLED ( CONFIG_SPL_BUILD ) ) { puts ( "INFO:post config was not run, please run manually if needed\n" ) ; } return FPGA_SUCCESS ; } 