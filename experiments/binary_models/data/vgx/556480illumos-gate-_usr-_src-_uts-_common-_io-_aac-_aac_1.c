static int aac_config_tgt ( struct aac_softstate * softs , int tgt ) { struct scsi_address ap ; struct buf * bp = NULL ; int buf_len = AAC_SCSI_RPTLUNS_HEAD_SIZE + AAC_SCSI_RPTLUNS_ADDR_SIZE ; int list_len = 0 ; int lun_total = 0 ; dev_info_t * ldip ; int i ; ap . a_hba_tran = softs -> hba_tran ; ap . a_target = ( uint16_t ) tgt ; ap . a_lun = 0 ; for ( i = 0 ; i < 2 ; i ++ ) { struct scsi_pkt * pkt ; uchar_t * cdb ; uchar_t * p ; uint32_t data ; if ( bp == NULL ) { if ( ( bp = scsi_alloc_consistent_buf ( & ap , NULL , buf_len , B_READ , NULL_FUNC , NULL ) ) == NULL ) { return ( AACERR ) ; } } if ( ( pkt = scsi_init_pkt ( & ap , NULL , bp , CDB_GROUP5 , sizeof ( scsi_arq_status ) , 0 , PKT_CONSISTENT , NULL , NULL ) ) == NULL ) { scsi_free_consistent_buf ( bp ) ; return ( AACERR ) ; } cdb = pkt -> pkt_cdbp ; bzero ( cdb , CDB_GROUP5 ) ; cdb [ 0 ] = SCMD_REPORT_LUNS ; data = buf_len ; for ( p = & cdb [ 9 ] ; p > & cdb [ 5 ] ; p -- ) { * p = data & 0xff ; data >>= 8 ; } if ( scsi_poll ( pkt ) < 0 || ( ( scsi_status * ) pkt -> pkt_scbp ) -> sts_chk ) { break ; } for ( p = ( uchar_t * ) bp -> b_un . b_addr ; p < ( uchar_t * ) bp -> b_un . b_addr + 4 ; p ++ ) { data <<= 8 ; data |= * p ; } list_len = data ; if ( buf_len < list_len + AAC_SCSI_RPTLUNS_HEAD_SIZE ) { scsi_free_consistent_buf ( bp ) ; bp = NULL ; buf_len = list_len + AAC_SCSI_RPTLUNS_HEAD_SIZE ; } scsi_destroy_pkt ( pkt ) ; } if ( i >= 2 ) { uint8_t * buf = ( uint8_t * ) ( bp -> b_un . b_addr + AAC_SCSI_RPTLUNS_HEAD_SIZE ) ; for ( i = 0 ; i < ( list_len / AAC_SCSI_RPTLUNS_ADDR_SIZE ) ; i ++ ) { uint16_t lun ; switch ( buf [ 0 ] & AAC_SCSI_RPTLUNS_ADDR_MASK ) { case AAC_SCSI_RPTLUNS_ADDR_PERIPHERAL : case AAC_SCSI_RPTLUNS_ADDR_LOGICAL_UNIT : case AAC_SCSI_RPTLUNS_ADDR_FLAT_SPACE : lun = ( ( buf [ 0 ] & 0x3f ) << 8 ) | buf [ 1 ] ; if ( lun > UINT8_MAX ) { AACDB_PRINT ( softs , CE_WARN , "abnormal lun number: %d" , lun ) ; break ; } if ( aac_config_lun ( softs , tgt , lun , & ldip ) == NDI_SUCCESS ) { lun_total ++ ; } break ; } buf += AAC_SCSI_RPTLUNS_ADDR_SIZE ; } } else { if ( aac_config_lun ( softs , tgt , 0 , & ldip ) == NDI_SUCCESS ) { lun_total ++ ; } } scsi_free_consistent_buf ( bp ) ; return ( lun_total ) ; } 