static int atiixp_build_dma_packets ( struct atiixp * chip , struct atiixp_dma * dma , struct snd_pcm_substream * substream , unsigned int periods , unsigned int period_bytes ) { unsigned int i ; u32 addr , desc_addr ; unsigned long flags ; if ( dma -> desc_buf . area == NULL ) { if ( snd_dma_alloc_pages ( SNDRV_DMA_TYPE_DEV , & chip -> pci -> dev , ATI_DESC_LIST_SIZE , & dma -> desc_buf ) < 0 ) { return - ENOMEM ; } dma -> period_bytes = dma -> periods = 0 ; } if ( dma -> periods == periods && dma -> period_bytes == period_bytes ) { return 0 ; } spin_lock_irqsave ( & chip -> reg_lock , flags ) ; writel ( 0 , chip -> remap_addr + dma -> ops -> llp_offset ) ; dma -> ops -> enable_dma ( chip , 0 ) ; dma -> ops -> enable_dma ( chip , 1 ) ; spin_unlock_irqrestore ( & chip -> reg_lock , flags ) ; addr = ( u32 ) substream -> runtime -> dma_addr ; desc_addr = ( u32 ) dma -> desc_buf . addr ; for ( i = 0 ; i < periods ; i ++ ) { struct atiixp_dma_desc * desc ; desc = & ( ( atiixp_dma_desc * ) dma -> desc_buf . area ) [ i ] ; desc -> addr = cpu_to_le32 ( addr ) ; desc -> status = 0 ; desc -> size = period_bytes >> 2 ; desc_addr += sizeof ( atiixp_dma_desc ) ; if ( i == periods - 1 ) { desc -> next = cpu_to_le32 ( ( u32 ) dma -> desc_buf . addr ) ; } else { desc -> next = cpu_to_le32 ( desc_addr ) ; } addr += period_bytes ; } writel ( ( u32 ) dma -> desc_buf . addr | ATI_REG_LINKPTR_EN , chip -> remap_addr + dma -> ops -> llp_offset ) ; dma -> period_bytes = period_bytes ; dma -> periods = periods ; return 0 ; } 