void iwl_pcie_tx_start ( struct iwl_trans * trans , u32 scd_base_addr ) { struct iwl_trans_pcie * trans_pcie = IWL_TRANS_GET_PCIE_TRANS ( trans ) ; int nq = trans -> trans_cfg -> base_params -> num_of_queues ; int chan ; u32 reg_val ; int clear_dwords = ( SCD_TRANS_TBL_OFFSET_QUEUE ( nq ) - SCD_CONTEXT_MEM_LOWER_BOUND ) / sizeof ( u32 ) ; memset ( trans -> txqs . queue_used , 0 , sizeof ( trans -> txqs . queue_used ) ) ; trans_pcie -> scd_base_addr = iwl_read_prph ( trans , SCD_SRAM_BASE_ADDR ) ; WARN_ON ( scd_base_addr != 0 && scd_base_addr != trans_pcie -> scd_base_addr ) ; iwl_trans_write_mem ( trans , trans_pcie -> scd_base_addr + SCD_CONTEXT_MEM_LOWER_BOUND , NULL , clear_dwords ) ; iwl_write_prph ( trans , SCD_DRAM_BASE_ADDR , trans -> txqs . scd_bc_tbls . dma >> 10 ) ; if ( trans -> trans_cfg -> base_params -> scd_chain_ext_wa ) { iwl_write_prph ( trans , SCD_CHAINEXT_EN , 0 ) ; } iwl_trans_ac_txq_enable ( trans , trans -> txqs . cmd . q_id , trans -> txqs . cmd . fifo , trans -> txqs . cmd . wdg_timeout ) ; iwl_scd_activate_fifos ( trans ) ; for ( chan = 0 ; chan < FH_TCSR_CHNL_NUM ; chan ++ ) { iwl_write_direct32 ( trans , FH_TCSR_CHNL_TX_CONFIG_REG ( chan ) , FH_TCSR_TX_CONFIG_REG_VAL_DMA_CHNL_ENABLE | FH_TCSR_TX_CONFIG_REG_VAL_DMA_CREDIT_ENABLE ) ; } reg_val = iwl_read_direct32 ( trans , FH_TX_CHICKEN_BITS_REG ) ; iwl_write_direct32 ( trans , FH_TX_CHICKEN_BITS_REG , reg_val | FH_TX_CHICKEN_BITS_SCD_AUTO_RETRY_EN ) ; if ( trans -> trans_cfg -> device_family < IWL_DEVICE_FAMILY_8000 ) { iwl_clear_bits_prph ( trans , APMG_PCIDEV_STT_REG , APMG_PCIDEV_STT_VAL_L1_ACT_DIS ) ; } } 