int fnic_get_trace_data ( fnic_dbgfs_t * fnic_dbgfs_prt ) { int rd_idx ; int wr_idx ; int len = 0 ; unsigned long flags ; char str [ KSYM_SYMBOL_LEN ] ; struct timespec val ; fnic_trace_data_t * tbp ; spin_lock_irqsave ( & fnic_trace_lock , flags ) ; rd_idx = fnic_trace_entries . rd_idx ; wr_idx = fnic_trace_entries . wr_idx ; if ( wr_idx < rd_idx ) { while ( 1 ) { tbp = ( fnic_trace_data_t * ) fnic_trace_entries . page_offset [ rd_idx ] ; if ( ! tbp ) { return 0 ; } if ( ( unsigned long ) < 8 ) { sprint_symbol ( str , tbp -> fnaddr . low ) ; jiffies_to_timespec ( tbp -> timestamp . low , & val ) ; } else { sprint_symbol ( str , tbp -> fnaddr . val ) ; jiffies_to_timespec ( tbp -> timestamp . val , & val ) ; } len += snprintf ( fnic_dbgfs_prt -> buffer + len , ( trace_max_pages * PAGE_SIZE * 3 ) - len , "%16lu.%16lu %-50s %8x %8x %16llx %16llx " "%16llx %16llx %16llx\n" , val . tv_sec , val . tv_nsec , str , tbp -> host_no , tbp -> tag , tbp -> data [ 0 ] , tbp -> data [ 1 ] , tbp -> data [ 2 ] , tbp -> data [ 3 ] , tbp -> data [ 4 ] ) ; rd_idx ++ ; if ( rd_idx > ( fnic_max_trace_entries - 1 ) ) { rd_idx = 0 ; } if ( rd_idx == wr_idx ) { break ; } } } if ( wr_idx > rd_idx ) { while ( 1 ) { tbp = ( fnic_trace_data_t * ) fnic_trace_entries . page_offset [ rd_idx ] ; if ( ! tbp ) { spin_unlock_irqrestore ( & fnic_trace_lock , flags ) ; return 0 ; } if ( ( unsigned long ) < 8 ) { sprint_symbol ( str , tbp -> fnaddr . low ) ; jiffies_to_timespec ( tbp -> timestamp . low , & val ) ; } else { sprint_symbol ( str , tbp -> fnaddr . val ) ; jiffies_to_timespec ( tbp -> timestamp . val , & val ) ; } len += snprintf ( fnic_dbgfs_prt -> buffer + len , ( trace_max_pages * PAGE_SIZE * 3 ) - len , "%16lu.%16lu %-50s %8x %8x %16llx %16llx " "%16llx %16llx %16llx\n" , val . tv_sec , val . tv_nsec , str , tbp -> host_no , tbp -> tag , tbp -> data [ 0 ] , tbp -> data [ 1 ] , tbp -> data [ 2 ] , tbp -> data [ 3 ] , tbp -> data [ 4 ] ) ; rd_idx ++ ; if ( rd_idx == wr_idx ) { break ; } } } spin_unlock_irqrestore ( & fnic_trace_lock , flags ) ; return len ; } 