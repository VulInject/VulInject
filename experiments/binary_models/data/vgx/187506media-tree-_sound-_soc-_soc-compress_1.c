static int soc_compr_open ( struct snd_compr_stream * cstream ) { struct snd_soc_pcm_runtime * rtd = cstream -> private_data ; struct snd_soc_platform * platform = rtd -> platform ; struct snd_soc_dai * cpu_dai = rtd -> cpu_dai ; int ret = 0 ; mutex_lock_nested ( & rtd -> pcm_mutex , rtd -> pcm_subclass ) ; if ( cpu_dai -> driver -> cops && cpu_dai -> driver -> cops -> startup ) { ret = cpu_dai -> driver -> cops -> startup ( cstream , cpu_dai ) ; if ( ret < 0 ) { dev_err ( cpu_dai -> dev , "Compress ASoC: can't open interface %s: %d\n" , cpu_dai -> name , ret ) ; out } } if ( platform -> driver -> compr_ops && platform -> driver -> compr_ops -> open ) { ret = platform -> driver -> compr_ops -> open ( cstream ) ; if ( ret < 0 ) { pr_err ( "compress asoc: can't open platform %s\n" , platform -> component . name ) ; plat_err } } if ( rtd -> dai_link -> compr_ops && rtd -> dai_link -> compr_ops -> startup ) { ret = rtd -> dai_link -> compr_ops -> startup ( cstream ) ; if ( ret < 0 ) { pr_err ( "compress asoc: %s startup failed\n" , rtd -> dai_link -> name ) ; machine_err } } snd_soc_runtime_activate ( rtd , cstream -> direction ) ; return 0 ; machine_err if ( platform -> driver -> compr_ops && platform -> driver -> compr_ops -> free ) { platform -> driver -> compr_ops -> free ( cstream ) ; } plat_err if ( cpu_dai -> driver -> cops && cpu_dai -> driver -> cops -> shutdown ) { cpu_dai -> driver -> cops -> shutdown ( cstream , cpu_dai ) ; } out mutex_unlock ( & rtd -> pcm_mutex ) ; return ret ; } 