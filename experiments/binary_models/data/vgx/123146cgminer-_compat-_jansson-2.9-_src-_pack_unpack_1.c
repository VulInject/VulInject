static int unpack ( scanner_t * s , json_t * root , va_list * ap ) { switch ( token ( s ) ) { case '{' : return unpack_object ( s , root , ap ) ; case '[' : return unpack_array ( s , root , ap ) ; case 's' : if ( root && ! json_is_string ( root ) ) { set_error ( s , "<validation>" , "Expected string, got %s" , type_name ( root ) ) ; return - 1 ; } if ( ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { const char * * str_target ; size_t * len_target ; str_target = va_arg ( * ap , const char * * ) ; if ( ! str_target ) { set_error ( s , "<args>" , "NULL string argument" ) ; return - 1 ; } next_token ( s ) ; if ( token ( s ) == '%' ) { len_target = va_arg ( * ap , size_t * ) ; if ( ! len_target ) { set_error ( s , "<args>" , "NULL string length argument" ) ; return - 1 ; } } else { prev_token ( s ) ; } if ( root ) { * str_target = json_string_value ( root ) ; if ( len_target ) { * len_target = json_string_length ( root ) ; } } } return 0 ; case 'i' : if ( root && ! json_is_integer ( root ) ) { set_error ( s , "<validation>" , "Expected integer, got %s" , type_name ( root ) ) ; return - 1 ; } if ( ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { int * target = va_arg ( * ap , int * ) ; if ( root ) { * target = ( int ) json_integer_value ( root ) ; } } return 0 ; case 'I' : if ( root && ! json_is_integer ( root ) ) { set_error ( s , "<validation>" , "Expected integer, got %s" , type_name ( root ) ) ; return - 1 ; } if ( ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { json_int_t * target = va_arg ( * ap , json_int_t * ) ; if ( root ) { * target = json_integer_value ( root ) ; } } return 0 ; case 'b' : if ( root && ! json_is_boolean ( root ) ) { set_error ( s , "<validation>" , "Expected true or false, got %s" , type_name ( root ) ) ; return - 1 ; } if ( ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { int * target = va_arg ( * ap , int * ) ; if ( root ) { * target = json_is_true ( root ) ; } } return 0 ; case 'f' : if ( root && ! json_is_real ( root ) ) { set_error ( s , "<validation>" , "Expected real, got %s" , type_name ( root ) ) ; return - 1 ; } if ( ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { double * target = va_arg ( * ap , double * ) ; if ( root ) { * target = json_real_value ( root ) ; } } return 0 ; case 'F' : if ( root && ! json_is_number ( root ) ) { set_error ( s , "<validation>" , "Expected real or integer, got %s" , type_name ( root ) ) ; return - 1 ; } if ( ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { double * target = va_arg ( * ap , double * ) ; if ( root ) { * target = json_number_value ( root ) ; } } return 0 ; case 'O' : if ( root && ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { json_incref ( root ) ; } case 'o' : if ( ! ( s -> flags & JSON_VALIDATE_ONLY ) ) { json_t * * target = va_arg ( * ap , json_t * * ) ; if ( root ) { * target = root ; } } return 0 ; case 'n' : if ( root && ! json_is_null ( root ) ) { set_error ( s , "<validation>" , "Expected null, got %s" , type_name ( root ) ) ; return - 1 ; } return 0 ; default : set_error ( s , "<format>" , "Unexpected format character '%c'" , token ( s ) ) ; return - 1 ; } } 