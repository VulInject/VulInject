static int h_preview ( int argc , unsigned char * * argv ) { preview = atoi ( argv [ 1 ] ) ; return 0 ; } static struct commands file_commandhandlers [ ] { { file_commandhandlers + 1 "file_cachedir" h_cachedir 2 2 } { NULL "file_preview" h_preview 2 2 } } ; ; static int file_loaded = 0 ; PLUGINAPI int PLUGINCALL file_plugin ( struct pluginlink * pluginlink , int argc , char * * argv ) { if ( ! file_loaded ) { pthread_mutex_init ( & file_mutex ) ; file_loaded = 1 ; pl = pluginlink ; memcpy ( & sso , pl -> so , sizeof ( sockfuncs ) ) ; pl -> so -> _poll = fp_poll ; pl -> so -> _send = fp_send ; pl -> so -> _sendto = fp_sendto ; pl -> so -> _recv = fp_recv ; pl -> so -> _recvfrom = fp_recvfrom ; pl -> so -> _shutdown = fp_shutdown ; pl -> so -> _closesocket = fp_closesocket ; fp_filter . next = pl -> conf -> filters ; pl -> conf -> filters = & fp_filter ; fp_symbols [ 1 ] . next = pl -> symbols . next ; pl -> symbols . next = fp_symbols ; file_commandhandlers [ 1 ] . next = pl -> commandhandlers -> next ; pl -> commandhandlers -> next = file_commandhandlers ; } h_cachedir ( 0 , NULL ) ; preview = 32768 ; return 0 ; } 