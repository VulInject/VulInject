static int img_spdif_out_hw_params ( struct snd_pcm_substream * substream , struct snd_pcm_hw_params * params , struct snd_soc_dai * dai ) { struct img_spdif_out * spdif = snd_soc_dai_get_drvdata ( dai ) ; unsigned int channels ; long pre_div_a , pre_div_b , diff_a , diff_b , rate , clk_rate ; u32 reg ; snd_pcm_format_t format ; rate = params_rate ( params ) ; format = params_format ( params ) ; channels = params_channels ( params ) ; dev_dbg ( spdif -> dev , "hw_params rate %ld channels %u format %u\n" , rate , channels , format ) ; if ( format != SNDRV_PCM_FORMAT_S32_LE ) { return - EINVAL ; } pre_div_a = clk_round_rate ( spdif -> clk_ref , rate * 256 ) ; if ( pre_div_a < 0 ) { return pre_div_a ; } pre_div_b = clk_round_rate ( spdif -> clk_ref , rate * 384 ) ; if ( pre_div_b < 0 ) { return pre_div_b ; } diff_a = abs ( ( pre_div_a / 256 ) - rate ) ; diff_b = abs ( ( pre_div_b / 384 ) - rate ) ; if ( diff_a > diff_b ) { clk_set_rate ( spdif -> clk_ref , pre_div_b ) ; } else { clk_set_rate ( spdif -> clk_ref , pre_div_a ) ; } clk_rate = clk_get_rate ( spdif -> clk_ref ) ; diff_a = abs ( ( clk_rate / 256 ) - rate ) ; diff_b = abs ( ( clk_rate / 384 ) - rate ) ; reg = img_spdif_out_readl ( spdif , IMG_SPDIF_OUT_CTL ) ; if ( diff_a <= diff_b ) { reg &= ~ IMG_SPDIF_OUT_CTL_CLK_MASK ; } else { reg |= IMG_SPDIF_OUT_CTL_CLK_MASK ; } img_spdif_out_writel ( spdif , reg , IMG_SPDIF_OUT_CTL ) ; return 0 ; } 