static int StreamTcpTest14 ( void ) { Packet * p = PacketGetFromAlloc ( ) ; FAIL_IF_NULL ( p ) ; Flow f ; ThreadVars tv ; StreamTcpThread stt ; TCPHdr tcph ; uint8_t payload [ 4 ] ; struct in_addr addr ; IPV4Hdr ipv4h ; char os_policy_name [ 10 ] "windows" ; ; const char * ip_addr ; PacketQueueNoLock pq ; memset ( & f , 0 , sizeof ( Flow ) ) ; memset ( & tv , 0 , sizeof ( ThreadVars ) ) ; memset ( & stt , 0 , sizeof ( StreamTcpThread ) ) ; memset ( & tcph , 0 , sizeof ( TCPHdr ) ) ; memset ( & addr , 0 , sizeof ( addr ) ) ; memset ( & ipv4h , 0 , sizeof ( ipv4h ) ) ; FLOW_INITIALIZE ( & f ) ; p -> flow = & f ; int ret = 0 ; StreamTcpUTInit ( & stt . ra_ctx ) ; ConfCreateContextBackup ( ) ; ConfInit ( ) ; ConfYamlLoadString ( dummy_conf_string , strlen ( dummy_conf_string ) ) ; ip_addr = StreamTcpParseOSPolicy ( os_policy_name ) ; SCHInfoAddHostOSInfo ( os_policy_name , ip_addr , - 1 ) ; strlcpy ( os_policy_name , "linux\0" , sizeof ( os_policy_name ) ) ; ip_addr = StreamTcpParseOSPolicy ( os_policy_name ) ; SCHInfoAddHostOSInfo ( os_policy_name , ip_addr , - 1 ) ; addr . s_addr = inet_addr ( "192.168.0.1" ) ; tcph . th_win = htons ( 5480 ) ; tcph . th_seq = htonl ( 10 ) ; tcph . th_ack = htonl ( 20 ) ; tcph . th_flags = TH_ACK | TH_PUSH ; p -> tcph = & tcph ; p -> dst . family = AF_INET ; p -> dst . address . address_un_data32 [ 0 ] = addr . s_addr ; p -> ip4h = & ipv4h ; StreamTcpCreateTestPacket ( payload , 0x41 , 3 , sizeof ( payload ) ) ; p -> payload = payload ; p -> payload_len = 3 ; if ( StreamTcpPacket ( & tv , p , & stt , & pq ) == - 1 ) { end } p -> tcph -> th_seq = htonl ( 20 ) ; p -> tcph -> th_ack = htonl ( 13 ) ; p -> tcph -> th_flags = TH_ACK | TH_PUSH ; p -> flowflags = FLOW_PKT_TOCLIENT ; StreamTcpCreateTestPacket ( payload , 0x42 , 3 , sizeof ( payload ) ) ; p -> payload = payload ; p -> payload_len = 3 ; if ( StreamTcpPacket ( & tv , p , & stt , & pq ) == - 1 ) { end } p -> tcph -> th_seq = htonl ( 15 ) ; p -> tcph -> th_ack = htonl ( 23 ) ; p -> tcph -> th_flags = TH_ACK | TH_PUSH ; p -> flowflags = FLOW_PKT_TOSERVER ; StreamTcpCreateTestPacket ( payload , 0x43 , 3 , sizeof ( payload ) ) ; p -> payload = payload ; p -> payload_len = 3 ; if ( StreamTcpPacket ( & tv , p , & stt , & pq ) == - 1 ) { end } p -> tcph -> th_seq = htonl ( 14 ) ; p -> tcph -> th_ack = htonl ( 23 ) ; p -> tcph -> th_flags = TH_ACK | TH_PUSH ; p -> flowflags = FLOW_PKT_TOSERVER ; StreamTcpCreateTestPacket ( payload , 0x43 , 3 , sizeof ( payload ) ) ; p -> payload = payload ; p -> payload_len = 3 ; if ( StreamTcpPacket ( & tv , p , & stt , & pq ) == - 1 ) { end } addr . s_addr = inet_addr ( "192.168.0.2" ) ; p -> tcph -> th_seq = htonl ( 25 ) ; p -> tcph -> th_ack = htonl ( 13 ) ; p -> tcph -> th_flags = TH_ACK | TH_PUSH ; p -> flowflags = FLOW_PKT_TOCLIENT ; p -> dst . address . address_un_data32 [ 0 ] = addr . s_addr ; StreamTcpCreateTestPacket ( payload , 0x44 , 3 , sizeof ( payload ) ) ; p -> payload = payload ; p -> payload_len = 3 ; if ( StreamTcpPacket ( & tv , p , & stt , & pq ) == - 1 ) { end } p -> tcph -> th_seq = htonl ( 24 ) ; p -> tcph -> th_ack = htonl ( 13 ) ; p -> tcph -> th_flags = TH_ACK | TH_PUSH ; p -> flowflags = FLOW_PKT_TOCLIENT ; StreamTcpCreateTestPacket ( payload , 0x44 , 3 , sizeof ( payload ) ) ; p -> payload = payload ; p -> payload_len = 3 ; if ( StreamTcpPacket ( & tv , p , & stt , & pq ) == - 1 ) { end } if ( ! stream_config . midstream ) { ret = 1 ; end } if ( ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> state != TCP_ESTABLISHED ) { end } if ( ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> client . next_seq != 13 && ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> server . next_seq != 23 ) { printf ( "failed in next_seq match client.next_seq %" PRIu32 "" " server.next_seq %" PRIu32 "\n" , ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> client . next_seq , ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> server . next_seq ) ; end } if ( ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> client . os_policy != OS_POLICY_WINDOWS && ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> server . os_policy != OS_POLICY_LINUX ) { printf ( "failed in setting up OS policy, client.os_policy: %" PRIu8 "" " should be %" PRIu8 " and server.os_policy: %" PRIu8 "" " should be %" PRIu8 "\n" , ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> client . os_policy , ( uint8_t ) OS_POLICY_WINDOWS , ( ( TcpSession * ) ( p -> flow -> protoctx ) ) -> server . os_policy , ( uint8_t ) OS_POLICY_LINUX ) ; end } StreamTcpSessionClear ( p -> flow -> protoctx ) ; ret = 1 ; end ConfDeInit ( ) ; ConfRestoreContextBackup ( ) ; SCFree ( p ) ; FLOW_DESTROY ( & f ) ; StreamTcpUTDeinit ( stt . ra_ctx ) ; return ret ; } 