static void ath9k_mgd_prepare_tx ( struct ieee80211_hw * hw , struct ieee80211_vif * vif , struct ieee80211_prep_tx_info * info ) { struct ath_softc * sc = hw -> priv ; struct ath_common * common = ath9k_hw_common ( sc -> sc_ah ) ; struct ath_vif * avp = ( ath_vif * ) vif -> drv_priv ; struct ath_beacon_config * cur_conf ; struct ath_chanctx * go_ctx ; unsigned long timeout ; bool changed = false ; u32 beacon_int ; if ( ! test_bit ( ATH_OP_MULTI_CHANNEL , & common -> op_flags ) ) { return ; } if ( ! avp -> chanctx ) { return ; } spin_lock_bh ( & sc -> chan_lock ) ; if ( sc -> next_chan || ( sc -> cur_chan != avp -> chanctx ) ) { changed = true ; } spin_unlock_bh ( & sc -> chan_lock ) ; if ( ! changed ) { out } ath9k_cancel_pending_offchannel ( sc ) ; go_ctx = ath_is_go_chanctx_present ( sc ) ; if ( go_ctx ) { spin_lock_bh ( & sc -> chan_lock ) ; sc -> sched . mgd_prepare_tx = true ; cur_conf = & go_ctx -> beacon ; beacon_int = TU_TO_USEC ( cur_conf -> beacon_interval ) ; spin_unlock_bh ( & sc -> chan_lock ) ; timeout = usecs_to_jiffies ( beacon_int * 2 ) ; init_completion ( & sc -> go_beacon ) ; mutex_unlock ( & sc -> mutex ) ; if ( wait_for_completion_timeout ( & sc -> go_beacon , timeout ) == 0 ) { ath_dbg ( common , CHAN_CTX , "Failed to send new NoA\n" ) ; spin_lock_bh ( & sc -> chan_lock ) ; sc -> sched . mgd_prepare_tx = false ; spin_unlock_bh ( & sc -> chan_lock ) ; } mutex_lock ( & sc -> mutex ) ; } ath_dbg ( common , CHAN_CTX , "%s: Set chanctx state to FORCE_ACTIVE for vif: %pM\n" , __func__ , vif -> addr ) ; spin_lock_bh ( & sc -> chan_lock ) ; sc -> next_chan = avp -> chanctx ; sc -> sched . state = ATH_CHANCTX_STATE_FORCE_ACTIVE ; spin_unlock_bh ( & sc -> chan_lock ) ; ath_chanctx_set_next ( sc , true ) ; out mutex_unlock ( & sc -> mutex ) ; } 