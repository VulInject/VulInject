int usm_checkuser ( struct usmuser * up , const char * * errp ) { char * auth = NULL , * priv = NULL ; if ( up -> uu_auth != AUTH_NONE && up -> uu_authkey == NULL ) { * errp = "missing auth passphrase" ; fail } if ( up -> uu_auth == AUTH_NONE && up -> uu_authkey != NULL ) { up -> uu_auth = AUTH_DEFAULT ; } if ( up -> uu_priv != PRIV_NONE && up -> uu_privkey == NULL ) { * errp = "missing priv passphrase" ; fail } if ( up -> uu_priv == PRIV_NONE && up -> uu_privkey != NULL ) { up -> uu_priv = PRIV_DEFAULT ; } if ( up -> uu_auth == AUTH_NONE && up -> uu_priv != PRIV_NONE ) { * errp = "auth is mandatory with enc" ; fail } switch ( up -> uu_auth ) { case AUTH_NONE : auth = "none" ; break ; case AUTH_MD5 : up -> uu_seclevel |= SNMP_MSGFLAG_AUTH ; auth = "HMAC-MD5-96" ; break ; case AUTH_SHA1 : up -> uu_seclevel |= SNMP_MSGFLAG_AUTH ; auth = "HMAC-SHA1-96" ; break ; case AUTH_SHA224 : up -> uu_seclevel |= SNMP_MSGFLAG_AUTH ; auth = "usmHMAC128SHA224AuthProtocol" ; case AUTH_SHA256 : up -> uu_seclevel |= SNMP_MSGFLAG_AUTH ; auth = "usmHMAC192SHA256AuthProtocol" ; case AUTH_SHA384 : up -> uu_seclevel |= SNMP_MSGFLAG_AUTH ; auth = "usmHMAC256SHA384AuthProtocol" ; case AUTH_SHA512 : up -> uu_seclevel |= SNMP_MSGFLAG_AUTH ; auth = "usmHMAC384SHA512AuthProtocol" ; } switch ( up -> uu_priv ) { case PRIV_NONE : priv = "none" ; break ; case PRIV_DES : up -> uu_seclevel |= SNMP_MSGFLAG_PRIV ; priv = "CBC-DES" ; break ; case PRIV_AES : up -> uu_seclevel |= SNMP_MSGFLAG_PRIV ; priv = "CFB128-AES-128" ; break ; } log_debug ( "user \"%s\" auth %s enc %s" , up -> uu_name , auth , priv ) ; return 0 ; fail free ( up -> uu_name ) ; free ( up -> uu_authkey ) ; SLIST_REMOVE ( & usmuserlist , up , usmuser , uu_next ) ; free ( up ) ; return - 1 ; } 