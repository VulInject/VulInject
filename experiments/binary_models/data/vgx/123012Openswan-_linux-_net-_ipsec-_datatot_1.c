size_t datatot ( src , srclen , format , dst , dstlen ) unsigned char * src ; size_t srclen ; int format ; char * dst ; size_t dstlen ; { size_t inblocksize ; size_t outblocksize ; size_t breakevery ; size_t sincebreak ; char breakchar ; unsigned char inblock [ 10 ] ; char outblock [ 10 ] ; char fake [ 1 ] ; size_t needed ; char * stop ; size_t ntodo ; size_t nreal ; char * out ; char * prefix ; breakevery = 0 ; breakchar = '_' ; switch ( format ) { case 0 : case 'h' : format = 'x' ; breakevery = 8 ; case 'x' : inblocksize = 1 ; outblocksize = 2 ; prefix = "0x" ; break ; case 'G' : inblocksize = 1 ; outblocksize = 2 ; prefix = "" ; breakevery = 4 ; breakchar = ' ' ; format = 'X' ; break ; case ':' : format = 'x' ; breakevery = 2 ; breakchar = ':' ; case 16 : inblocksize = 1 ; outblocksize = 2 ; prefix = "" ; format = 'x' ; break ; case 's' : inblocksize = 3 ; outblocksize = 4 ; prefix = "0s" ; break ; case 64 : inblocksize = 3 ; outblocksize = 4 ; prefix = "" ; format = 's' ; break ; default : return 0 ; break ; } user_assert ( inblocksize < sizeof ( inblock ) ) ; user_assert ( outblocksize < sizeof ( outblock ) ) ; user_assert ( breakevery % outblocksize == 0 ) ; if ( srclen == 0 ) { return 0 ; } ntodo = srclen ; if ( dstlen == 0 ) { dst = fake ; dstlen = 1 ; } stop = dst + dstlen - 1 ; nreal = strlen ( prefix ) ; needed = nreal ; if ( dstlen <= nreal ) { strncpy ( dst , prefix , dstlen - 1 ) ; dst += dstlen - 1 ; } else { strcpy ( dst , prefix ) ; dst += nreal ; } user_assert ( dst <= stop ) ; sincebreak = 0 ; while ( ntodo > 0 ) { if ( ntodo < inblocksize ) { memcpy ( inblock , src , ntodo ) ; src = inblock ; nreal = ntodo ; ntodo = inblocksize ; } else { nreal = inblocksize ; } out = ( outblocksize > stop - dst ) ?outblock : dst ; convert ( ( const char * ) src , nreal , format , out ) ; needed += outblocksize ; sincebreak += outblocksize ; if ( dst < stop ) { if ( out != dst ) { user_assert ( outblocksize > stop - dst ) ; memcpy ( dst , out , stop - dst ) ; dst = stop ; } else { dst += outblocksize ; } } src += inblocksize ; ntodo -= inblocksize ; if ( breakevery != 0 && sincebreak >= breakevery && ntodo > 0 ) { if ( dst < stop ) { * dst ++ = breakchar ; } needed ++ ; sincebreak = 0 ; } } user_assert ( dst <= stop ) ; * dst ++ = '\0' ; needed ++ ; return needed ; } 