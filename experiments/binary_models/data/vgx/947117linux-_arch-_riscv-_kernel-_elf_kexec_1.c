static int elf_find_pbase ( struct kimage * image , unsigned long kernel_len , struct elfhdr * ehdr , struct kexec_elf_info * elf_info , unsigned long * old_pbase , unsigned long * new_pbase ) { int i ; int ret ; struct kexec_buf kbuf ; const struct elf_phdr * phdr ; unsigned long lowest_paddr = ULONG_MAX ; unsigned long lowest_vaddr = ULONG_MAX ; for ( i = 0 ; i < ehdr -> e_phnum ; i ++ ) { phdr = & elf_info -> proghdrs [ i ] ; if ( lowest_paddr > phdr -> p_paddr ) { lowest_paddr = phdr -> p_paddr ; } if ( lowest_vaddr > phdr -> p_vaddr ) { lowest_vaddr = phdr -> p_vaddr ; } } kbuf . image = image ; kbuf . buf_min = lowest_paddr ; kbuf . buf_max = ULONG_MAX ; kbuf . buf_align = PAGE_SIZE ; kbuf . mem = KEXEC_BUF_MEM_UNKNOWN ; kbuf . memsz = ALIGN ( kernel_len , PAGE_SIZE ) ; kbuf . top_down = false ; ret = arch_kexec_locate_mem_hole ( & kbuf ) ; if ( ! ret ) { * old_pbase = lowest_paddr ; * new_pbase = kbuf . mem ; image -> start = ehdr -> e_entry - lowest_vaddr + kbuf . mem ; } return ret ; } 