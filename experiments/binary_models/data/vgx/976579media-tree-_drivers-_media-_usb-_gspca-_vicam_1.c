static void vicam_dostream ( struct work_struct * work ) { struct sd * sd = container_of ( work , sd , work_struct ) ; struct gspca_dev * gspca_dev = & sd -> gspca_dev ; int ret , frame_sz ; u8 * buffer ; frame_sz = gspca_dev -> cam . cam_mode [ gspca_dev -> curr_mode ] . sizeimage + HEADER_SIZE ; buffer = kmalloc ( frame_sz , GFP_KERNEL | GFP_DMA ) ; if ( ! buffer ) { pr_err ( "Couldn't allocate USB buffer\n" ) ; exit } while ( gspca_dev -> present && gspca_dev -> streaming ) { if ( gspca_dev -> frozen ) { break ; } ret = vicam_read_frame ( gspca_dev , buffer , frame_sz ) ; if ( ret < 0 ) { break ; } gspca_frame_add ( gspca_dev , FIRST_PACKET , buffer + HEADER_SIZE , frame_sz - HEADER_SIZE ) ; gspca_frame_add ( gspca_dev , LAST_PACKET , NULL , 0 ) ; } exit } 