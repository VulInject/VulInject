static int instantiate_rng ( struct device * ctrldev , int state_handle_mask , int gen_sk ) { struct caam_drv_private * ctrlpriv = dev_get_drvdata ( ctrldev ) ; struct caam_ctrl __iomem * ctrl ; u32 * desc , status = 0 , rdsta_val ; int ret = 0 , sh_idx ; ctrl = ( caam_ctrl __iomem * ) ctrlpriv -> ctrl ; desc = kmalloc ( CAAM_CMD_SZ * 7 , GFP_KERNEL ) ; if ( ! desc ) { return - ENOMEM ; } for ( sh_idx = 0 ; sh_idx < RNG4_MAX_HANDLES ; sh_idx ++ ) { if ( ( 1 << sh_idx ) & state_handle_mask ) { continue ; } build_instantiation_desc ( desc , sh_idx , gen_sk ) ; ret = run_descriptor_deco0 ( ctrldev , desc , & status ) ; rdsta_val = rd_reg32 ( & ctrl -> r4tst [ 0 ] . rdsta ) & RDSTA_IFMASK ; if ( ( status && status != JRSTA_SSRC_JUMP_HALT_CC ) || ! ( rdsta_val & ( 1 << sh_idx ) ) ) { ret = - EAGAIN ; } if ( ret ) { break ; } dev_info ( ctrldev , "Instantiated RNG4 SH%d\n" , sh_idx ) ; } kfree ( desc ) ; return ret ; } 