void fm_fmri_hc_create ( nvlist_t * fmri , int version , const nvlist_t * auth , nvlist_t * snvl , nvlist_t * bboard , int npairs , ... ) { nv_alloc_t * nva = nvlist_lookup_nv_alloc ( fmri ) ; nvlist_t * pairs [ HC_MAXPAIRS ] ; nvlist_t * * hcl ; uint_t n ; int i , j ; va_list ap ; char * hcname , * hcid ; if ( nvlist_lookup_nvlist_array ( bboard , FM_FMRI_HC_LIST , & hcl , & n ) != 0 ) { atomic_inc_64 ( & erpt_kstat_data . fmri_set_failed . value . ui64 ) ; return ; } for ( i = 0 ; i < n ; i ++ ) { if ( nvlist_lookup_string ( hcl [ i ] , FM_FMRI_HC_NAME , & hcname ) != 0 ) { atomic_inc_64 ( & erpt_kstat_data . fmri_set_failed . value . ui64 ) ; return ; } if ( nvlist_lookup_string ( hcl [ i ] , FM_FMRI_HC_ID , & hcid ) != 0 ) { atomic_inc_64 ( & erpt_kstat_data . fmri_set_failed . value . ui64 ) ; return ; } pairs [ i ] = fm_nvlist_create ( nva ) ; if ( nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_NAME , hcname ) != 0 || nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_ID , hcid ) != 0 ) { for ( j = 0 ; j <= i ; j ++ ) { if ( pairs [ j ] != NULL ) { fm_nvlist_destroy ( pairs [ j ] , FM_NVA_RETAIN ) ; } } atomic_inc_64 ( & erpt_kstat_data . fmri_set_failed . value . ui64 ) ; return ; } } npairs = MIN ( npairs , HC_MAXPAIRS ) ; va_start ( ap , npairs ) ; for ( i = n ; i < npairs + n ; i ++ ) { const char * name = va_arg ( ap , const char * ) ; uint32_t id = va_arg ( ap , uint32_t ) ; char idstr [ 11 ] ; ( void ) snprintf ( idstr , sizeof ( idstr ) , "%u" , id ) ; pairs [ i ] = fm_nvlist_create ( nva ) ; if ( nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_NAME , name ) != 0 || nvlist_add_string ( pairs [ i ] , FM_FMRI_HC_ID , idstr ) != 0 ) { for ( j = 0 ; j <= i ; j ++ ) { if ( pairs [ j ] != NULL ) { fm_nvlist_destroy ( pairs [ j ] , FM_NVA_RETAIN ) ; } } atomic_inc_64 ( & erpt_kstat_data . fmri_set_failed . value . ui64 ) ; return ; } } va_end ( ap ) ; if ( nvlist_add_nvlist_array ( fmri , FM_FMRI_HC_LIST , pairs , npairs + n ) != 0 ) { atomic_inc_64 ( & erpt_kstat_data . fmri_set_failed . value . ui64 ) ; return ; } for ( i = 0 ; i < npairs + n ; i ++ ) { fm_nvlist_destroy ( pairs [ i ] , FM_NVA_RETAIN ) ; } if ( snvl != NULL ) { if ( nvlist_add_nvlist ( fmri , FM_FMRI_HC_SPECIFIC , snvl ) != 0 ) { atomic_inc_64 ( & erpt_kstat_data . fmri_set_failed . value . ui64 ) ; return ; } } } 