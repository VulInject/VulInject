STATIC int xfs_rtallocate_extent_block ( xfs_mount_t * mp , xfs_trans_t * tp , xfs_rtblock_t bbno , xfs_extlen_t minlen , xfs_extlen_t maxlen , xfs_extlen_t * len , xfs_rtblock_t * nextp , xfs_buf_t * * rbpp , xfs_fsblock_t * rsb , xfs_extlen_t prod , xfs_rtblock_t * rtblock ) { xfs_rtblock_t besti ; xfs_rtblock_t bestlen ; xfs_rtblock_t end ; int error ; xfs_rtblock_t i ; xfs_rtblock_t next ; int stat ; for ( i = XFS_BLOCKTOBIT ( mp , bbno ) , besti = - 1 , bestlen = 0 , end = XFS_BLOCKTOBIT ( mp , bbno + 1 ) - 1 ; i <= end ; i ++ ) { error = xfs_rtcheck_range ( mp , tp , i , maxlen , 1 , & next , & stat ) ; if ( stat ) { error = xfs_rtallocate_range ( mp , tp , i , maxlen , rbpp , rsb ) ; if ( error ) { return error ; } * len = maxlen ; * rtblock = i ; return 0 ; } if ( minlen < maxlen ) { xfs_rtblock_t thislen ; thislen = next - i ; if ( thislen >= minlen && thislen > bestlen ) { besti = i ; bestlen = thislen ; } } if ( next < end ) { error = xfs_rtfind_forw ( mp , tp , next , end , & i ) ; if ( error ) { return error ; } } else { break ; } } if ( minlen < maxlen && besti != - 1 ) { xfs_extlen_t p ; if ( prod > 1 && ( p = do_mod ( bestlen , prod ) ) ) { bestlen -= p ; } error = xfs_rtallocate_range ( mp , tp , besti , bestlen , rbpp , rsb ) ; if ( error ) { return error ; } * len = bestlen ; * rtblock = besti ; return 0 ; } * nextp = next ; * rtblock = NULLRTBLOCK ; return 0 ; } 