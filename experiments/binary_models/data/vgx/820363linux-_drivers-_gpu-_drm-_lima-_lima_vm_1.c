static int lima_vm_map_page ( struct lima_vm * vm , dma_addr_t pa , u32 va ) { u32 pbe = LIMA_PBE ( va ) ; u32 bte = LIMA_BTE ( va ) ; if ( ! vm -> bts [ pbe ] . cpu ) { int pts ; u32 * pd ; int j ; vm -> bts [ pbe ] . cpu = dma_alloc_wc ( vm -> dev -> dev , LIMA_PAGE_SIZE << LIMA_VM_NUM_PT_PER_BT_SHIFT , & vm -> bts [ pbe ] . dma , GFP_KERNEL | __GFP_NOWARN | __GFP_ZERO ) ; if ( ! vm -> bts [ pbe ] . cpu ) { return - ENOMEM ; } pts = vm -> bts [ pbe ] . dma ; pd = vm -> pd . cpu + ( pbe << LIMA_VM_NUM_PT_PER_BT_SHIFT ) ; for ( j = 0 ; j < LIMA_VM_NUM_PT_PER_BT ; j ++ ) { pd [ j ] = pts | LIMA_VM_FLAG_PRESENT ; pts += LIMA_PAGE_SIZE ; } } vm -> bts [ pbe ] . cpu [ bte ] = pa | LIMA_VM_FLAGS_CACHE ; return 0 ; } 