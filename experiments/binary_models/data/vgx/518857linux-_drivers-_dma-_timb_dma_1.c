static struct timb_dma_desc * td_alloc_init_desc ( struct timb_dma_chan * td_chan ) { struct dma_chan * chan = & td_chan -> chan ; struct timb_dma_desc * td_desc ; int err ; td_desc = kzalloc ( sizeof ( timb_dma_desc ) , GFP_KERNEL ) ; if ( ! td_desc ) { out } td_desc -> desc_list_len = td_chan -> desc_elems * TIMB_DMA_DESC_SIZE ; td_desc -> desc_list = kzalloc ( td_desc -> desc_list_len , GFP_KERNEL ) ; if ( ! td_desc -> desc_list ) { err } dma_async_tx_descriptor_init ( & td_desc -> txd , chan ) ; td_desc -> txd . tx_submit = td_tx_submit ; td_desc -> txd . flags = DMA_CTRL_ACK ; td_desc -> txd . phys = dma_map_single ( chan2dmadev ( chan ) , td_desc -> desc_list , td_desc -> desc_list_len , DMA_TO_DEVICE ) ; err = dma_mapping_error ( chan2dmadev ( chan ) , td_desc -> txd . phys ) ; if ( err ) { dev_err ( chan2dev ( chan ) , "DMA mapping error: %d\n" , err ) ; err } return td_desc ; err kfree ( td_desc ) ; out return NULL ; } 