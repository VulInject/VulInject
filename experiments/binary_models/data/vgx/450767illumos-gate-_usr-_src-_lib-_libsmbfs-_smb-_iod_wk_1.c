int smb_iod_work ( smb_ctx_t * ctx ) { smbioc_ssn_work_t * work = & ctx -> ct_work ; int err = 0 ; DPRINT ( "server: %s" , ctx -> ct_srvname ) ; for ( ; ; ) { DPRINT ( "state: %s" , smb_iod_state_name ( work -> wk_out_state ) ) ; switch ( work -> wk_out_state ) { case SMBIOD_ST_IDLE : DPRINT ( "Call _ioc_idle..." ) ; if ( nsmb_ioctl ( ctx -> ct_dev_fd , SMBIOC_IOD_IDLE , work ) == - 1 ) { err = errno ; DPRINT ( "ioc_idle: err %d" , err ) ; out } DPRINT ( "Ret. from _ioc_idle" ) ; continue ; case SMBIOD_ST_RECONNECT : DPRINT ( "Call _iod_connect..." ) ; err = smb_iod_connect ( ctx ) ; DPRINT ( "iod_connect: err %d" , err ) ; if ( err == EAUTH ) { DPRINT ( "iod_connect: EAUTH (give up)" ) ; out } DPRINT ( "Call _iod_rcfail..." ) ; if ( nsmb_ioctl ( ctx -> ct_dev_fd , SMBIOC_IOD_RCFAIL , work ) == - 1 ) { err = errno ; DPRINT ( "iod_rcfail: err %d" , err ) ; out } continue ; case SMBIOD_ST_AUTHOK : DPRINT ( "Call _iod_work..." ) ; if ( nsmb_ioctl ( ctx -> ct_dev_fd , SMBIOC_IOD_WORK , work ) == - 1 ) { err = errno ; DPRINT ( "iod_work: err %d" , err ) ; out } DPRINT ( "Ret. from _ioc_work" ) ; continue ; case SMBIOD_ST_DEAD : DPRINT ( "got state=DEAD" ) ; err = 0 ; out default : DPRINT ( "Unexpected state: %d (%s)" , work -> wk_out_state , smb_iod_state_name ( work -> wk_out_state ) ) ; err = EFAULT ; out } } out if ( ctx -> ct_dev_fd != - 1 ) { nsmb_close ( ctx -> ct_dev_fd ) ; ctx -> ct_dev_fd = - 1 ; } return ( err ) ; } 