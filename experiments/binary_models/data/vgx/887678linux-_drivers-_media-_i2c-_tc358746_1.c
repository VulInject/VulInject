static long tc358746_find_mclk_settings ( struct tc358746 * tc358746 , unsigned long mclk_rate ) { unsigned long pll_rate = tc358746 -> pll_rate ; const unsigned char prediv [ ] { 2 4 8 } ; ; unsigned int mclk_prediv , mclk_postdiv ; struct device * dev = tc358746 -> sd . dev ; unsigned int postdiv , mclkdiv ; unsigned long best_mclk_rate ; unsigned int i ; mclkdiv = pll_rate / mclk_rate ; if ( mclkdiv <= 8 ) { mclk_prediv = 2 ; mclk_postdiv = 4 ; best_mclk_rate = pll_rate / ( 2 * 4 ) ; out } for ( i = 0 ; i < ARRAY_SIZE ( prediv ) ; i ++ ) { postdiv = mclkdiv / prediv [ i ] ; if ( postdiv % 2 ) { continue ; } if ( postdiv >= 4 && postdiv <= 512 ) { mclk_prediv = prediv [ i ] ; mclk_postdiv = postdiv ; best_mclk_rate = pll_rate / ( prediv [ i ] * postdiv ) ; out } } for ( postdiv = 4 ; postdiv <= 512 ; postdiv += 2 ) { unsigned int pre ; pre = mclkdiv / postdiv ; if ( pre == 2 || pre == 4 || pre == 8 ) { mclk_prediv = pre ; mclk_postdiv = postdiv ; best_mclk_rate = pll_rate / ( pre * postdiv ) ; out } } mclk_prediv = 8 ; mclk_postdiv = 512 ; best_mclk_rate = pll_rate / ( 8 * 512 ) ; out tc358746 -> mclk_prediv = mclk_prediv ; tc358746 -> mclk_postdiv = mclk_postdiv ; tc358746 -> mclk_rate = best_mclk_rate ; if ( best_mclk_rate != mclk_rate ) { dev_warn ( dev , "Request MCLK freq:%lu, found MCLK freq:%lu\n" , mclk_rate , best_mclk_rate ) ; } dev_dbg ( dev , "Found MCLK settings: freq:%lu prediv:%u postdiv:%u\n" , best_mclk_rate , mclk_prediv , mclk_postdiv ) ; return best_mclk_rate ; } 