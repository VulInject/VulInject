BOOL override_proxy ( const char * addr ) { const char * no_proxy = getenv ( "no_proxy" ) ; char * p = NULL ; char * at = NULL ; char * host = NULL ; char * Host = NULL ; char * acc_method ; int port = 0 ; int h_len = 0 ; if ( no_proxy ) { if ( ! strcmp ( no_proxy , "*" ) ) { return YES ; } } if ( ! addr ) { return NO ; } if ( ! ( host = HTParse ( addr , "" , PARSE_HOST ) ) ) { return NO ; } if ( ! * host ) { FREE ( host ) ; return NO ; } Host = ( ( ( at = StrChr ( host , '@' ) ) != NULL ) ?( at + 1 ) : host ) ; if ( ( acc_method = HTParse ( addr , "" , PARSE_ACCESS ) ) ) { if ( ! strcmp ( "file" , acc_method ) && ( LYSameHostname ( Host , "localhost" ) || LYSameHostname ( Host , HTHostName ( ) ) ) ) { FREE ( host ) ; FREE ( acc_method ) ; return YES ; } FREE ( acc_method ) ; } if ( ! no_proxy ) { FREE ( host ) ; return NO ; } if ( NULL != ( p = HTParsePort ( Host , & port ) ) ) { * p = 0 ; } else { acc_method = HTParse ( addr , "" , PARSE_ACCESS ) ; if ( acc_method != NULL ) { if ( ! strcmp ( acc_method , "http" ) ) { port = 80 ; } if ( ! strcmp ( acc_method , "https" ) ) { port = 443 ; } if ( ! strcmp ( acc_method , "ftp" ) ) { port = 21 ; } if ( ! strcmp ( acc_method , "gopher" ) ) { port = 70 ; } if ( ! strcmp ( acc_method , "cso" ) ) { port = 105 ; } if ( ! strcmp ( acc_method , "news" ) ) { port = 119 ; } if ( ! strcmp ( acc_method , "nntp" ) ) { port = 119 ; } if ( ! strcmp ( acc_method , "newspost" ) ) { port = 119 ; } if ( ! strcmp ( acc_method , "newsreply" ) ) { port = 119 ; } if ( ! strcmp ( acc_method , "snews" ) ) { port = 563 ; } if ( ! strcmp ( acc_method , "snewspost" ) ) { port = 563 ; } if ( ! strcmp ( acc_method , "snewsreply" ) ) { port = 563 ; } if ( ! strcmp ( acc_method , "wais" ) ) { port = 210 ; } if ( ! strcmp ( acc_method , "finger" ) ) { port = 79 ; } if ( ! strcmp ( acc_method , "telnet" ) ) { port = 23 ; } if ( ! strcmp ( acc_method , "tn3270" ) ) { port = 23 ; } if ( ! strcmp ( acc_method , "rlogin" ) ) { port = 513 ; } FREE ( acc_method ) ; } } if ( ! port ) { port = 80 ; } h_len = ( int ) strlen ( Host ) ; while ( * no_proxy ) { const char * end ; const char * colon = NULL ; int templ_port = 0 ; int t_len ; int brackets = 0 ; while ( * no_proxy && ( WHITE ( * no_proxy ) || * no_proxy == ',' ) ) { no_proxy ++ ; } end = no_proxy ; while ( * end && ! WHITE ( * end ) && * end != ',' ) { if ( ! brackets && ( * end == ':' ) ) { colon = end ; } if ( * end == '[' ) { ++ brackets ; } if ( * end == ']' ) { -- brackets ; } end ++ ; } if ( colon ) { templ_port = atoi ( colon + 1 ) ; t_len = ( int ) ( colon - no_proxy ) ; } else { t_len = ( int ) ( end - no_proxy ) ; } if ( ( ! templ_port || templ_port == port ) && ( t_len > 0 && t_len <= h_len && ! strncasecomp ( Host + h_len - t_len , no_proxy , t_len ) ) ) { FREE ( host ) ; return YES ; } if ( ( ! templ_port || templ_port == port ) && ( t_len > 0 && t_len <= h_len && isdigit ( UCH ( * no_proxy ) ) && ! StrNCmp ( host , no_proxy , t_len ) ) ) { FREE ( host ) ; return YES ; } if ( * end ) { no_proxy = ( end + 1 ) ; } else { break ; } } FREE ( host ) ; return NO ; } 