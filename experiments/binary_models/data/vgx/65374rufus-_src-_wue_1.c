BOOL PopulateWindowsVersion ( void ) { char * mounted_iso , mounted_image_path [ 128 ] ; char xml_file [ MAX_PATH ] "" ; ; if ( ( nWindowsVersion < WINDOWS_8 ) || ( ( WimExtractCheck ( TRUE ) & 4 ) == 0 ) ) { return FALSE ; } if ( ! img_report . is_windows_img ) { mounted_iso = MountISO ( image_path ) ; if ( mounted_iso == NULL ) { uprintf ( "Could not mount Windows ISO for build number detection" ) ; return FALSE ; } static_sprintf ( mounted_image_path , "%s%s" , mounted_iso , & img_report . wininst_path [ 0 ] [ 2 ] ) ; } if ( ( GetTempFileNameU ( temp_dir , APPLICATION_NAME , 0 , xml_file ) == 0 ) || ( xml_file [ 0 ] == 0 ) ) { static_strcpy ( xml_file , ".\\RufVXml.tmp" ) ; } DeleteFileU ( xml_file ) ; if ( ! WimExtractFile_API ( img_report . is_windows_img ?image_path : mounted_image_path , 0 , "[1].xml" , xml_file , TRUE ) ) { uprintf ( "Could not acquire WIM index" ) ; out } PopulateWindowsVersionFromXml ( xml_file , 1 ) ; out DeleteFileU ( xml_file ) ; if ( ! img_report . is_windows_img ) { UnMountISO ( ) ; } return ( ( img_report . win_version . major != 0 ) && ( img_report . win_version . build != 0 ) ) ; } 