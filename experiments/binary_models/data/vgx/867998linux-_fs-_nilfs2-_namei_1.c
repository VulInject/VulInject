static int nilfs_symlink ( struct mnt_idmap * idmap , struct inode * dir , struct dentry * dentry , const char * symname ) { struct nilfs_transaction_info ti ; struct super_block * sb = dir -> i_sb ; unsigned int l = strlen ( symname ) + 1 ; struct inode * inode ; int err ; err = nilfs_transaction_begin ( dir -> i_sb , & ti , 1 ) ; if ( err ) { return err ; } inode = nilfs_new_inode ( dir , S_IFLNK | 0777 ) ; err = PTR_ERR ( inode ) ; if ( IS_ERR ( inode ) ) { out } inode -> i_op = & nilfs_symlink_inode_operations ; inode_nohighmem ( inode ) ; inode -> i_mapping -> a_ops = & nilfs_aops ; err = page_symlink ( inode , symname , l ) ; if ( err ) { out_fail } err = nilfs_add_nondir ( dentry , inode ) ; out if ( ! err ) { err = nilfs_transaction_commit ( dir -> i_sb ) ; } else { nilfs_transaction_abort ( dir -> i_sb ) ; } return err ; out_fail drop_nlink ( inode ) ; nilfs_mark_inode_dirty ( inode ) ; unlock_new_inode ( inode ) ; iput ( inode ) ; out } 