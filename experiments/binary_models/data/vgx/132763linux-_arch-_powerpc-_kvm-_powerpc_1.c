int kvm_arch_init_vm ( struct kvm * kvm , unsigned long type ) { struct kvmppc_ops * kvm_ops = NULL ; int r ; if ( type == 0 ) { if ( kvmppc_hv_ops ) { kvm_ops = kvmppc_hv_ops ; } else { kvm_ops = kvmppc_pr_ops ; } if ( ! kvm_ops ) { err_out } } if ( type == KVM_VM_PPC_HV ) { if ( ! kvmppc_hv_ops ) { err_out } kvm_ops = kvmppc_hv_ops ; } if ( type == KVM_VM_PPC_PR ) { if ( ! kvmppc_pr_ops ) { err_out } kvm_ops = kvmppc_pr_ops ; } else { err_out } if ( ! try_module_get ( kvm_ops -> owner ) ) { return - ENOENT ; } kvm -> arch . kvm_ops = kvm_ops ; r = kvmppc_core_init_vm ( kvm , NULL ) ; if ( r ) { module_put ( kvm_ops -> owner ) ; } return r ; err_out return - EINVAL ; } 