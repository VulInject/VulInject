int mailmh_folder_add_subfolder ( struct mailmh_folder * parent , const char * name ) { char * foldername ; int r ; struct mailmh_folder * folder ; unsigned int array_index ; chashdatum key ; chashdatum data ; foldername = malloc ( strlen ( parent -> fl_filename ) + strlen ( name ) + 2 ) ; if ( foldername == NULL ) { return MAILMH_ERROR_MEMORY ; } strcpy ( foldername , parent -> fl_filename ) ; strcat ( foldername , MAIL_DIR_SEPARATOR_S ) ; strcat ( foldername , name ) ; r = mkdir ( foldername ) ; r = mkdir ( foldername , 0700 ) ; free ( foldername ) ; if ( r < 0 ) { return MAILMH_ERROR_FOLDER ; } folder = mailmh_folder_new ( parent , name ) ; if ( folder == NULL ) { return MAILMH_ERROR_MEMORY ; } r = carray_add ( parent -> fl_subfolders_tab , folder , & array_index ) ; if ( r < 0 ) { return MAILMH_ERROR_MEMORY ; } folder -> fl_array_index = array_index ; key . data = folder -> fl_filename ; key . len = ( unsigned int ) strlen ( folder -> fl_filename ) ; data . data = folder ; data . len = 0 ; r = chash_set ( parent -> fl_subfolders_hash , & key , & data , NULL ) ; if ( r < 0 ) { carray_delete_fast ( folder -> fl_subfolders_tab , folder -> fl_array_index ) ; mailmh_folder_free ( folder ) ; return MAILMH_ERROR_MEMORY ; } return MAILMH_NO_ERROR ; } 