void kvmppc_xive_native_cleanup_vcpu ( struct kvm_vcpu * vcpu ) { struct kvmppc_xive_vcpu * xc = vcpu -> arch . xive_vcpu ; int i ; if ( ! xc ) { return ; } pr_devel ( "native_cleanup_vcpu(cpu=%d)\n" , xc -> server_num ) ; xc -> valid = false ; kvmppc_xive_disable_vcpu_interrupts ( vcpu ) ; for ( i = 0 ; i < KVMPPC_XIVE_Q_COUNT ; i ++ ) { if ( xc -> esc_virq [ i ] ) { if ( kvmppc_xive_has_single_escalation ( xc -> xive ) ) { xive_cleanup_single_escalation ( vcpu , xc -> esc_virq [ i ] ) ; } free_irq ( xc -> esc_virq [ i ] , vcpu ) ; irq_dispose_mapping ( xc -> esc_virq [ i ] ) ; kfree ( xc -> esc_virq_names [ i ] ) ; xc -> esc_virq [ i ] = 0 ; } } xive_native_disable_vp ( xc -> vp_id ) ; vcpu -> arch . xive_cam_word = 0 ; for ( i = 0 ; i < KVMPPC_XIVE_Q_COUNT ; i ++ ) { kvmppc_xive_native_cleanup_queue ( vcpu , i ) ; } kfree ( xc ) ; vcpu -> arch . irq_type = KVMPPC_IRQ_DEFAULT ; vcpu -> arch . xive_vcpu = NULL ; } 