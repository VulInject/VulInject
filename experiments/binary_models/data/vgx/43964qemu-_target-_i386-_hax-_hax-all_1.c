struct hax_vm * hax_vm_create ( struct hax_state * hax , int max_cpus ) { struct hax_vm * vm ; int vm_id = 0 , ret , i ; if ( hax_invalid_fd ( hax -> fd ) ) { return NULL ; } if ( hax -> vm ) { return hax -> vm ; } if ( max_cpus > HAX_MAX_VCPU ) { fprintf ( stderr , "Maximum VCPU number QEMU supported is %d\n" , HAX_MAX_VCPU ) ; return NULL ; } vm = g_new0 ( hax_vm , 1 ) ; ret = hax_host_create_vm ( hax , & vm_id ) ; if ( ret ) { fprintf ( stderr , "Failed to create vm %x\n" , ret ) ; error } vm -> id = vm_id ; vm -> fd = hax_host_open_vm ( hax , vm_id ) ; if ( hax_invalid_fd ( vm -> fd ) ) { fprintf ( stderr , "Failed to open vm %d\n" , vm_id ) ; error } vm -> numvcpus = max_cpus ; vm -> vcpus = g_new0 ( hax_vcpu_state * , vm -> numvcpus ) ; for ( i = 0 ; i < vm -> numvcpus ; i ++ ) { vm -> vcpus [ i ] = NULL ; } hax -> vm = vm ; return vm ; error hax -> vm = NULL ; return NULL ; } 