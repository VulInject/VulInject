static void id3v2_read_internal ( AVIOContext * pb , AVDictionary * * metadata , AVFormatContext * s , const char * magic , ID3v2ExtraMeta * * extra_metap , int64_t max_search_size ) { int len , ret ; uint8_t buf [ ID3v2_HEADER_SIZE ] ; ExtraMetaList extra_meta = { NULL } ; int found_header ; int64_t start , off ; if ( extra_metap ) { * extra_metap = NULL ; } start = avio_tell ( pb ) ; { off = avio_tell ( pb ) ; if ( max_search_size && off - start >= max_search_size - ID3v2_HEADER_SIZE ) { avio_seek ( pb , off , SEEK_SET ) ; break ; } ret = ffio_ensure_seekback ( pb , ID3v2_HEADER_SIZE ) ; if ( ret >= 0 ) { ret = avio_read ( pb , buf , ID3v2_HEADER_SIZE ) ; } if ( ret != ID3v2_HEADER_SIZE ) { avio_seek ( pb , off , SEEK_SET ) ; break ; } found_header = ff_id3v2_match ( buf , magic ) ; if ( found_header ) { len = ( ( buf [ 6 ] & 0x7f ) << 21 ) | ( ( buf [ 7 ] & 0x7f ) << 14 ) | ( ( buf [ 8 ] & 0x7f ) << 7 ) | ( buf [ 9 ] & 0x7f ) ; id3v2_parse ( pb , metadata , s , len , buf [ 3 ] , buf [ 5 ] , extra_metap ?& extra_meta : NULL ) ; } else { avio_seek ( pb , off , SEEK_SET ) ; } } found_header ; ff_metadata_conv ( metadata , NULL , ff_id3v2_34_metadata_conv ) ; ff_metadata_conv ( metadata , NULL , id3v2_2_metadata_conv ) ; ff_metadata_conv ( metadata , NULL , ff_id3v2_4_metadata_conv ) ; merge_date ( metadata ) ; if ( extra_metap ) { * extra_metap = extra_meta . head ; } } 