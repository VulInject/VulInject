static int alloc_proxy_bufs ( struct ib_device * dev , struct mlx4_ib_qp * qp ) { int i ; qp -> sqp_proxy_rcv = kmalloc_array ( qp -> rq . wqe_cnt , sizeof ( mlx4_ib_buf ) , GFP_KERNEL ) ; for ( i = 0 ; i < qp -> rq . wqe_cnt ; i ++ ) { qp -> sqp_proxy_rcv [ i ] . addr = kmalloc ( sizeof ( mlx4_ib_proxy_sqp_hdr ) , GFP_KERNEL ) ; if ( ! qp -> sqp_proxy_rcv [ i ] . addr ) { err } qp -> sqp_proxy_rcv [ i ] . map = ib_dma_map_single ( dev , qp -> sqp_proxy_rcv [ i ] . addr , sizeof ( mlx4_ib_proxy_sqp_hdr ) , DMA_FROM_DEVICE ) ; if ( ib_dma_mapping_error ( dev , qp -> sqp_proxy_rcv [ i ] . map ) ) { kfree ( qp -> sqp_proxy_rcv [ i ] . addr ) ; err } } return 0 ; err while ( i > 0 ) { -- i ; ib_dma_unmap_single ( dev , qp -> sqp_proxy_rcv [ i ] . map , sizeof ( mlx4_ib_proxy_sqp_hdr ) , DMA_FROM_DEVICE ) ; kfree ( qp -> sqp_proxy_rcv [ i ] . addr ) ; } kfree ( qp -> sqp_proxy_rcv ) ; qp -> sqp_proxy_rcv = NULL ; return - ENOMEM ; } 