int bnxt_media_change ( struct ifnet * ifp ) { struct bnxt_softc * sc = ( bnxt_softc * ) ifp -> if_softc ; struct hwrm_port_phy_cfg_input req = { 0 } ; uint64_t link_speed ; if ( IFM_TYPE ( sc -> sc_media . ifm_media ) != IFM_ETHER ) { return EINVAL ; } bnxt_hwrm_cmd_hdr_init ( sc , & req , HWRM_PORT_PHY_CFG ) ; switch ( IFM_SUBTYPE ( sc -> sc_media . ifm_media ) ) { case IFM_100G_CR4 : case IFM_100G_SR4 : case IFM_100G_KR4 : case IFM_100G_LR4 : case IFM_100G_AOC : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_100GB ; break ; case IFM_50G_CR2 : case IFM_50G_KR2 : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_50GB ; break ; case IFM_40G_CR4 : case IFM_40G_SR4 : case IFM_40G_LR4 : case IFM_40G_KR4 : case IFM_40G_AOC : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_40GB ; break ; case IFM_25G_CR : case IFM_25G_KR : case IFM_25G_SR : case IFM_25G_LR : case IFM_25G_ER : case IFM_25G_AOC : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_25GB ; break ; case IFM_10G_LR : case IFM_10G_SR : case IFM_10G_CX4 : case IFM_10G_T : case IFM_10G_SFP_CU : case IFM_10G_LRM : case IFM_10G_KX4 : case IFM_10G_KR : case IFM_10G_CR1 : case IFM_10G_ER : case IFM_10G_AOC : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_10GB ; break ; case IFM_2500_SX : case IFM_2500_KX : case IFM_2500_T : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_2_5GB ; break ; case IFM_1000_T : case IFM_1000_LX : case IFM_1000_SX : case IFM_1000_CX : case IFM_1000_KX : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_1GB ; break ; case IFM_100_TX : link_speed = HWRM_PORT_PHY_QCFG_OUTPUT_FORCE_LINK_SPEED_100MB ; break ; default : link_speed = 0 ; } req . enables |= htole32 ( HWRM_PORT_PHY_CFG_INPUT_ENABLES_AUTO_DUPLEX ) ; req . auto_duplex = HWRM_PORT_PHY_CFG_INPUT_AUTO_DUPLEX_BOTH ; if ( link_speed == 0 ) { req . auto_mode |= HWRM_PORT_PHY_CFG_INPUT_AUTO_MODE_ALL_SPEEDS ; req . flags |= htole32 ( HWRM_PORT_PHY_CFG_INPUT_FLAGS_RESTART_AUTONEG ) ; req . enables |= htole32 ( HWRM_PORT_PHY_CFG_INPUT_ENABLES_AUTO_MODE ) ; } else { req . force_link_speed = htole16 ( link_speed ) ; req . flags |= htole32 ( HWRM_PORT_PHY_CFG_INPUT_FLAGS_FORCE ) ; } req . flags |= htole32 ( HWRM_PORT_PHY_CFG_INPUT_FLAGS_RESET_PHY ) ; return hwrm_send_message ( sc , & req , sizeof ( req ) ) ; } 