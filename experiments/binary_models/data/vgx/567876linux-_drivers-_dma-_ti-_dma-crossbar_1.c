static void * ti_am335x_xbar_route_allocate ( struct of_phandle_args * dma_spec , struct of_dma * ofdma ) { struct platform_device * pdev = of_find_device_by_node ( ofdma -> of_node ) ; struct ti_am335x_xbar_data * xbar = platform_get_drvdata ( pdev ) ; struct ti_am335x_xbar_map * map ; if ( dma_spec -> args_count != 3 ) { return ERR_PTR ( - EINVAL ) ; } if ( dma_spec -> args [ 2 ] >= xbar -> xbar_events ) { dev_err ( & pdev -> dev , "Invalid XBAR event number: %d\n" , dma_spec -> args [ 2 ] ) ; return ERR_PTR ( - EINVAL ) ; } if ( dma_spec -> args [ 0 ] >= xbar -> dma_requests ) { dev_err ( & pdev -> dev , "Invalid DMA request line number: %d\n" , dma_spec -> args [ 0 ] ) ; return ERR_PTR ( - EINVAL ) ; } dma_spec -> np = of_parse_phandle ( ofdma -> of_node , "dma-masters" , 0 ) ; if ( ! dma_spec -> np ) { dev_err ( & pdev -> dev , "Can't get DMA master\n" ) ; return ERR_PTR ( - EINVAL ) ; } map = kmalloc ( sizeof ( * map ) , GFP_KERNEL ) ; if ( ! map ) { of_node_put ( dma_spec -> np ) ; return ERR_PTR ( - ENOMEM ) ; } map -> dma_line = ( u16 ) dma_spec -> args [ 0 ] ; map -> mux_val = ( u8 ) dma_spec -> args [ 2 ] ; dma_spec -> args [ 2 ] = 0 ; dma_spec -> args_count = 2 ; dev_dbg ( & pdev -> dev , "Mapping XBAR event%u to DMA%u\n" , map -> mux_val , map -> dma_line ) ; ti_am335x_xbar_write ( xbar -> iomem , map -> dma_line , map -> mux_val ) ; return map ; } static const struct of_device_id ti_am335x_master_match [ ] __maybe_unused = { { . compatible = "ti,edma3-tpcc" } { } } ; 