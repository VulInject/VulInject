int pf_change_icmp_af ( struct mbuf * m , int ipoff2 , struct pf_pdesc * pd , struct pf_pdesc * pd2 , struct pf_addr * src , struct pf_addr * dst , sa_family_t af , sa_family_t naf ) { struct mbuf * n = NULL ; struct ip * ip4 ; struct ip6_hdr * ip6 ; u_int hlen , ohlen , dlen ; int d ; if ( af == naf || ( af != AF_INET && af != AF_INET6 ) || ( naf != AF_INET && naf != AF_INET6 ) ) { return ( - 1 ) ; } if ( ( n = m_split ( m , ipoff2 , M_DONTWAIT ) ) == NULL ) { return ( - 1 ) ; } hlen = naf == AF_INET ?sizeof ( * ip4 ) : sizeof ( * ip6 ) ; ohlen = pd2 -> off - ipoff2 ; pf_cksum_uncover ( pd -> pcksum , in_cksum ( n , ohlen ) , pd -> proto ) ; m_adj ( n , ohlen ) ; if ( ( M_PREPEND ( n , hlen , M_DONTWAIT ) ) == NULL ) { return ( - 1 ) ; } switch ( naf ) { case AF_INET : ip4 = mtod ( n , ip * ) ; ip4 -> ip_v = IPVERSION ; ip4 -> ip_hl = sizeof ( * ip4 ) >> 2 ; ip4 -> ip_len = htons ( sizeof ( * ip4 ) + pd2 -> tot_len - ohlen ) ; ip4 -> ip_id = htons ( ip_randomid ( ) ) ; ip4 -> ip_off = htons ( IP_DF ) ; ip4 -> ip_ttl = pd2 -> ttl ; if ( pd2 -> proto == IPPROTO_ICMPV6 ) { ip4 -> ip_p = IPPROTO_ICMP ; } else { ip4 -> ip_p = pd2 -> proto ; } ip4 -> ip_src = src -> v4 ; ip4 -> ip_dst = dst -> v4 ; ip4 -> ip_sum = in_cksum ( n , ip4 -> ip_hl << 2 ) ; break ; case AF_INET6 : ip6 = mtod ( n , ip6_hdr * ) ; memset ( ip6 , 0 , sizeof ( * ip6 ) ) ; ip6 -> ip6_vfc = IPV6_VERSION ; ip6 -> ip6_plen = htons ( pd2 -> tot_len - ohlen ) ; if ( pd2 -> proto == IPPROTO_ICMP ) { ip6 -> ip6_nxt = IPPROTO_ICMPV6 ; } else { ip6 -> ip6_nxt = pd2 -> proto ; } if ( ! pd2 -> ttl || pd2 -> ttl > IPV6_DEFHLIM ) { ip6 -> ip6_hlim = IPV6_DEFHLIM ; } else { ip6 -> ip6_hlim = pd2 -> ttl ; } ip6 -> ip6_src = src -> v6 ; ip6 -> ip6_dst = dst -> v6 ; break ; } if ( naf != AF_INET ) { pf_cksum_cover ( pd -> pcksum , in_cksum ( n , hlen ) , pd -> proto ) ; } { int nlen = n -> m_pkthdr . len ; m_cat ( m , n ) ; m -> m_pkthdr . len += nlen ; } d = hlen - ohlen ; if ( pd -> proto == IPPROTO_ICMPV6 ) { dlen = pd -> tot_len - pd -> off ; pf_cksum_fixup ( pd -> pcksum , htons ( dlen ) , htons ( dlen + d ) , pd -> proto ) ; } pd -> tot_len += d ; pd2 -> tot_len += d ; pd2 -> off += d ; return ( 0 ) ; } 