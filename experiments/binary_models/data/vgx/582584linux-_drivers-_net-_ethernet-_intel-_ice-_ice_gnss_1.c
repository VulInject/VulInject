static int ice_gnss_write ( struct gnss_device * gdev , const unsigned char * buf , size_t count ) { struct ice_pf * pf = gnss_get_drvdata ( gdev ) ; struct gnss_write_buf * write_buf ; struct gnss_serial * gnss ; unsigned char * cmd_buf ; int err = count ; if ( ! pf ) { return - EFAULT ; } if ( ! test_bit ( ICE_FLAG_GNSS , pf -> flags ) ) { return - EFAULT ; } gnss = pf -> gnss_serial ; if ( ! gnss ) { return - ENODEV ; } cmd_buf = kcalloc ( count , sizeof ( * buf ) , GFP_KERNEL ) ; if ( ! cmd_buf ) { return - ENOMEM ; } memcpy ( cmd_buf , buf , count ) ; write_buf = kzalloc ( sizeof ( * write_buf ) , GFP_KERNEL ) ; if ( ! write_buf ) { kfree ( cmd_buf ) ; return - ENOMEM ; } write_buf -> buf = cmd_buf ; write_buf -> size = count ; INIT_LIST_HEAD ( & write_buf -> queue ) ; list_add_tail ( & write_buf -> queue , & gnss -> queue ) ; kthread_queue_work ( gnss -> kworker , & gnss -> write_work ) ; return err ; } 