( scsi_bios_ptable ) ; bool scsi_partsize ( struct block_device * bdev , sector_t capacity , int geom [ 3 ] ) { int cyl , ext_cyl , end_head , end_cyl , end_sector ; unsigned int logical_end , physical_end , ext_physical_end ; struct msdos_partition * p , * largest = NULL ; void * buf ; int ret = false ; buf = scsi_bios_ptable ( bdev ) ; if ( ! buf ) { return false ; } if ( * ( unsigned short * ) ( buf + 64 ) == 0xAA55 ) { int largest_cyl = - 1 , i ; for ( i = 0 , p = buf ; i < 4 ; i ++ , p ++ ) { if ( ! p -> sys_ind ) { continue ; } printk ( "scsicam_bios_param : partition %d has system \n" , i ) ; cyl = p -> cyl + ( ( p -> sector & 0xc0 ) << 2 ) ; if ( cyl > largest_cyl ) { largest_cyl = cyl ; largest = p ; } } } if ( largest ) { end_cyl = largest -> end_cyl + ( ( largest -> end_sector & 0xc0 ) << 2 ) ; end_head = largest -> end_head ; end_sector = largest -> end_sector & 0x3f ; if ( end_head + 1 == 0 || end_sector == 0 ) { out_free_buf } printk ( "scsicam_bios_param : end at h = %d, c = %d, s = %d\n" , end_head , end_cyl , end_sector ) ; physical_end = end_cyl * ( end_head + 1 ) * end_sector + end_head * end_sector + end_sector ; logical_end = get_unaligned_le32 ( & largest -> start_sect ) + get_unaligned_le32 ( & largest -> nr_sects ) ; ext_cyl = ( logical_end - ( end_head * end_sector + end_sector ) ) / ( end_head + 1 ) / end_sector ; ext_physical_end = ext_cyl * ( end_head + 1 ) * end_sector + end_head * end_sector + end_sector ; printk ( "scsicam_bios_param : logical_end=%d physical_end=%d ext_physical_end=%d ext_cyl=%d\n" , logical_end , physical_end , ext_physical_end , ext_cyl ) ; if ( logical_end == physical_end || ( end_cyl == 1023 && ext_physical_end == logical_end ) ) { geom [ 0 ] = end_head + 1 ; geom [ 1 ] = end_sector ; geom [ 2 ] = ( unsigned long ) capacity / ( ( end_head + 1 ) * end_sector ) ; ret = true ; out_free_buf } printk ( "scsicam_bios_param : logical (%u) != physical (%u)\n" , logical_end , physical_end ) ; } out_free_buf return ret ; } 