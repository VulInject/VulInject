static int file_cbfs_fill_cache ( struct cbfs_priv * priv , int size , int align ) { struct cbfs_cachenode * cache_node ; struct cbfs_cachenode * node ; struct cbfs_cachenode * * cache_tail = & priv -> file_cache ; void * start ; cache_node = priv -> file_cache ; while ( cache_node ) { struct cbfs_cachenode * old_node = cache_node ; cache_node = cache_node -> next ; free ( old_node ) ; } priv -> file_cache = NULL ; start = priv -> start ; while ( size >= align ) { int used ; int ret ; node = malloc ( sizeof ( cbfs_cachenode ) ) ; if ( ! node ) { return - ENOMEM ; } ret = file_cbfs_next_file ( priv , start , size , align , node , & used ) ; if ( ret < 0 ) { if ( ret == - ENOENT ) { break ; } return ret ; } * cache_tail = node ; cache_tail = & node -> next ; size -= used ; start += used ; } priv -> result = CBFS_SUCCESS ; return 0 ; } 