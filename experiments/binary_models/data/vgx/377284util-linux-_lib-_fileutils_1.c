int xmkstemp ( char * * tmpname , const char * dir , const char * prefix ) { char * localtmp ; const char * tmpenv ; mode_t old_mode ; int fd , rc ; tmpenv = dir ?dir : getenv ( "TMPDIR" ) ; if ( ! tmpenv ) { tmpenv = _PATH_TMP ; } rc = asprintf ( & localtmp , "%s/%s.XXXXXX" , tmpenv , prefix ) ; if ( rc < 0 ) { return - 1 ; } old_mode = umask ( 077 ) ; fd = mkstemp_cloexec ( localtmp ) ; umask ( old_mode , NULL ) ; if ( fd == - 1 ) { free ( localtmp ) ; localtmp = NULL ; } * tmpname = localtmp ; return fd ; } 