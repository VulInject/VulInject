static ssize_t zfcp_sysfs_port_remove_store ( struct device * dev , struct device_attribute * attr , const char * buf , size_t count ) { struct ccw_device * cdev = to_ccwdev ( dev ) ; struct zfcp_adapter * adapter = zfcp_ccw_adapter_by_cdev ( cdev ) ; struct zfcp_port * port ; u64 wwpn ; int retval = - EINVAL ; if ( kstrtoull ( buf , 0 , ( unsigned long long * ) & wwpn ) ) { out } port = zfcp_get_port_by_wwpn ( adapter , wwpn ) ; if ( ! port ) { out } else { retval = 0 ; } mutex_lock ( & zfcp_sysfs_port_units_mutex ) ; if ( atomic_read ( & port -> units ) > 0 ) { retval = - EBUSY ; mutex_unlock ( & zfcp_sysfs_port_units_mutex ) ; out } atomic_set ( & port -> units , - 1 ) ; mutex_unlock ( & zfcp_sysfs_port_units_mutex ) ; write_lock_irq ( & adapter -> port_list_lock ) ; list_del ( & port -> list ) ; write_unlock_irq ( & adapter -> port_list_lock ) ; put_device ( & port -> dev ) ; zfcp_erp_port_shutdown ( port , 0 , "syprs_1" ) ; device_unregister ( & port -> dev ) ; out zfcp_ccw_adapter_put ( adapter ) ; return retval ?retval : ( ssize_t ) count ; } 