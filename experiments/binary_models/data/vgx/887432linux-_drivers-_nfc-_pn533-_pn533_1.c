static int pn533_poll_dep ( struct nfc_dev * nfc_dev ) { struct pn533 * dev = nfc_get_drvdata ( nfc_dev ) ; struct sk_buff * skb ; int rc , skb_len ; u8 * next , nfcid3 [ NFC_NFCID3_MAXSIZE ] ; u8 passive_data [ PASSIVE_DATA_LEN ] { 0x00 0xff 0xff 0x00 0x3 } ; ; if ( ! dev -> gb ) { dev -> gb = nfc_get_local_general_bytes ( nfc_dev , & dev -> gb_len ) ; if ( ! dev -> gb || ! dev -> gb_len ) { dev -> poll_dep = 0 ; queue_work ( dev -> wq , & dev -> rf_work ) ; } } skb_len = 3 + dev -> gb_len ; skb_len += PASSIVE_DATA_LEN ; skb_len += NFC_NFCID3_MAXSIZE ; nfcid3 [ 0 ] = 0x1 ; nfcid3 [ 1 ] = 0xfe ; get_random_bytes ( nfcid3 + 2 , 6 ) ; skb = pn533_alloc_skb ( dev , skb_len ) ; skb_put_u8 ( skb , 0x01 ) ; skb_put_u8 ( skb , 0x02 ) ; next = skb_put ( skb , 1 ) ; * next = 0 ; skb_put_data ( skb , passive_data , PASSIVE_DATA_LEN ) ; * next |= 1 ; skb_put_data ( skb , nfcid3 , NFC_NFCID3_MAXSIZE ) ; * next |= 2 ; skb_put_data ( skb , dev -> gb , dev -> gb_len ) ; * next |= 4 ; rc = pn533_send_cmd_async ( dev , PN533_CMD_IN_JUMP_FOR_DEP , skb , pn533_poll_dep_complete , NULL ) ; if ( rc < 0 ) { dev_kfree_skb ( skb ) ; } return rc ; } 