int uwsgi_apply_final_transformations ( struct wsgi_request * wsgi_req ) { struct uwsgi_transformation * ut = wsgi_req -> transformations ; wsgi_req -> transformed_chunk_len = 0 ; char * t_buf = NULL ; size_t t_len = 0 ; uint8_t flushed = 0 ; int found_nostream = 0 ; while ( ut ) { if ( ! found_nostream ) { if ( ! ut -> can_stream ) { found_nostream = 1 ; } else { if ( ! ut -> chunk ) { return 0 ; } t_buf = ut -> chunk -> buf ; t_len = ut -> chunk -> pos ; next } } if ( ! ut -> chunk ) { if ( t_len > 0 ) { ut -> chunk = uwsgi_buffer_new ( t_len ) ; } else { ut -> chunk = uwsgi_buffer_new ( uwsgi . page_size ) ; } } if ( t_len > 0 ) { if ( uwsgi_buffer_append ( ut -> chunk , t_buf , t_len ) ) { return - 1 ; } } ut -> round ++ ; if ( ut -> func ( wsgi_req , ut ) ) { return - 1 ; } if ( ut -> flushed ) { flushed = 1 ; } t_buf = ut -> chunk -> buf ; t_len = ut -> chunk -> pos ; next ut = ut -> next ; } if ( ! flushed ) { wsgi_req -> transformed_chunk = t_buf ; wsgi_req -> transformed_chunk_len = t_len ; } return 0 ; } 