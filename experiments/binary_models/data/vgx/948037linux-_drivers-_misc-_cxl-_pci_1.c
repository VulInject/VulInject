int cxl_calc_capp_routing ( struct pci_dev * dev , u64 * chipid , u32 * phb_index , u64 * capp_unit_id ) { int rc ; struct device_node * np ; const __be32 * prop ; if ( ! ( np = pnv_pci_get_phb_node ( dev ) ) ) { return - ENODEV ; } while ( np && ! ( prop = of_get_property ( np , "ibm,chip-id" , NULL ) ) ) { np = of_get_next_parent ( np ) ; } if ( ! np ) { return - ENODEV ; } * chipid = be32_to_cpup ( prop ) ; rc = get_phb_index ( np , phb_index ) ; if ( rc ) { pr_err ( "cxl: invalid phb index\n" ) ; of_node_put ( np , NULL ) ; return rc ; } * capp_unit_id = get_capp_unit_id ( np , * phb_index ) ; of_node_put ( np ) ; if ( ! * capp_unit_id ) { pr_err ( "cxl: No capp unit found for PHB[%lld,%d]. Make sure the adapter is on a capi-compatible slot\n" , * chipid , * phb_index ) ; return - ENODEV ; } return 0 ; } 