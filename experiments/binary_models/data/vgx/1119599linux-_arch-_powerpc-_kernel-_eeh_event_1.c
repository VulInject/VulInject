static DEFINE_SPINLOCK ( eeh_eventlist_lock ) ; static DECLARE_COMPLETION ( eeh_eventlist_event ) ; static LIST_HEAD ( eeh_eventlist ) ; static int eeh_event_handler ( void * dummy ) { cfs_time_t flags ; struct eeh_event * event ; while ( ! kthread_should_stop ( ) ) { if ( wait_for_completion_interruptible ( & eeh_eventlist_event ) ) { break ; } spin_lock_irqsave ( & eeh_eventlist_lock , flags ) ; event = NULL ; if ( ! list_empty ( & eeh_eventlist ) ) { event = list_entry ( eeh_eventlist . next , eeh_event , list ) ; list_del ( & event -> list ) ; } spin_unlock_irqrestore ( & eeh_eventlist_lock , flags ) ; if ( ! event ) { continue ; } if ( event -> pe ) { eeh_handle_normal_event ( event -> pe ) ; } else { eeh_handle_special_event ( ) ; } kfree ( event ) ; } return 0 ; } 