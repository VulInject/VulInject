static int ftrace_modify_code ( unsigned long ip , unsigned char * old_code , unsigned char * new_code ) { unsigned char replaced [ MCOUNT_INSN_SIZE ] ; if ( probe_kernel_read ( replaced , ( void * ) ip , MCOUNT_INSN_SIZE ) ) { return - EFAULT ; } if ( memcmp ( replaced , old_code , MCOUNT_INSN_SIZE ) != 0 ) { return - EINVAL ; } flush_icache_range ( ip , ip + MCOUNT_INSN_SIZE ) ; return 0 ; } 