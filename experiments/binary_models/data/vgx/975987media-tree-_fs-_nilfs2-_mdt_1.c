int nilfs_mdt_freeze_buffer ( struct inode * inode , struct buffer_head * bh ) { struct nilfs_shadow_map * shadow = NILFS_MDT ( inode ) -> mi_shadow ; struct buffer_head * bh_frozen ; struct page * page ; int blkbits = inode -> i_blkbits ; page = grab_cache_page ( & shadow -> frozen_data , bh -> b_page -> index ) ; if ( ! page_has_buffers ( page ) ) { create_empty_buffers ( page , 1 << blkbits , 0 ) ; } bh_frozen = nilfs_page_get_nth_block ( page , bh_offset ( bh ) >> blkbits ) ; if ( ! buffer_uptodate ( bh_frozen ) ) { nilfs_copy_buffer ( bh_frozen , bh ) ; } if ( list_empty ( & bh_frozen -> b_assoc_buffers ) ) { list_add_tail ( & bh_frozen -> b_assoc_buffers , & shadow -> frozen_buffers ) ; set_buffer_nilfs_redirected ( bh ) ; } else { brelse ( bh_frozen ) ; } unlock_page ( page ) ; put_page ( page ) ; return 0 ; } 