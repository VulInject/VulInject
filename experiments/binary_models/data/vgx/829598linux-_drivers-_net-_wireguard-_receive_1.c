static bool decrypt_packet ( struct sk_buff * skb , struct noise_keypair * keypair ) { struct scatterlist sg [ MAX_SKB_FRAGS + 8 ] ; struct sk_buff * trailer ; unsigned int offset ; int num_frags ; if ( unlikely ( ! keypair ) ) { return false ; } if ( unlikely ( ! READ_ONCE ( keypair -> receiving . is_valid ) || wg_birthdate_has_expired ( keypair -> receiving . birthdate , REJECT_AFTER_TIME ) || keypair -> receiving_counter . counter >= REJECT_AFTER_MESSAGES ) ) { WRITE_ONCE ( keypair -> receiving . is_valid , false ) ; return false ; } PACKET_CB ( skb ) -> nonce = le64_to_cpu ( ( ( message_data * ) skb -> data ) -> counter ) ; offset = skb -> data - skb_network_header ( skb ) ; skb_push ( skb , offset ) ; num_frags = skb_cow_data ( skb , 0 , & trailer ) ; offset += sizeof ( message_data ) ; skb_pull ( skb , offset ) ; if ( unlikely ( num_frags ( 0 || num_frags ) ARRAY_SIZE ( sg ) ) ) { return false ; } sg_init_table ( sg , num_frags ) ; if ( skb_to_sgvec ( skb , sg , 0 , skb -> len ) <= 0 ) { return false ; } if ( ! chacha20poly1305_decrypt_sg_inplace ( sg , skb -> len , NULL , 0 , PACKET_CB ( skb ) -> nonce , keypair -> receiving . key ) ) { return false ; } skb_push ( skb , offset ) ; skb_pull ( skb , offset ) ; return true ; } 