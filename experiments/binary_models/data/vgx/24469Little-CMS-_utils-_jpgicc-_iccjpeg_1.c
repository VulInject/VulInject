read_icc_profile ( , , ) { jpeg_saved_marker_ptr marker ; int num_markers = 0 ; int seq_no ; JOCTET * icc_data ; int total_length ; char marker_present [ MAX_SEQ_NO + 1 ] ; unsigned int data_length [ MAX_SEQ_NO + 1 ] ; unsigned int data_offset [ MAX_SEQ_NO + 1 ] ; * icc_data_ptr = NULL ; * icc_data_len = 0 ; for ( seq_no = 1 ; seq_no <= MAX_SEQ_NO ; seq_no ++ ) { marker_present [ seq_no ] = 0 ; } for ( marker = cinfo -> marker_list ; marker != NULL ; marker = marker -> next ) { if ( marker_is_icc ( marker ) ) { if ( num_markers == 0 ) { num_markers = GETJOCTET ( marker -> data [ 13 ] ) ; } if ( num_markers != GETJOCTET ( marker -> data [ 13 ] ) ) { return FALSE ; } seq_no = GETJOCTET ( marker -> data [ 12 ] ) ; if ( seq_no <= 0 || seq_no > num_markers ) { return FALSE ; } if ( marker_present [ seq_no ] ) { return FALSE ; } marker_present [ seq_no ] = 1 ; data_length [ seq_no ] = marker -> data_length - ICC_OVERHEAD_LEN ; } } if ( num_markers == 0 ) { return FALSE ; } total_length = 0 ; for ( seq_no = 1 ; seq_no <= num_markers ; seq_no ++ ) { if ( marker_present [ seq_no ] == 0 ) { return FALSE ; } data_offset [ seq_no ] = total_length ; total_length += data_length [ seq_no ] ; } if ( total_length == 0 ) { return FALSE ; } icc_data = ( JOCTET * ) malloc ( total_length * sizeof ( JOCTET ) ) ; if ( icc_data == NULL ) { return FALSE ; } for ( marker = cinfo -> marker_list ; marker != NULL ; marker = marker -> next ) { if ( marker_is_icc ( marker ) ) { JOCTET FAR * src_ptr ; JOCTET * dst_ptr ; unsigned int length ; seq_no = GETJOCTET ( marker -> data [ 12 ] ) ; dst_ptr = icc_data + data_offset [ seq_no ] ; src_ptr = marker -> data + ICC_OVERHEAD_LEN ; length = data_length [ seq_no ] ; while ( length -- ) { * dst_ptr ++ = * src_ptr ++ ; } } } * icc_data_ptr = icc_data ; * icc_data_len = total_length ; return TRUE ; } 