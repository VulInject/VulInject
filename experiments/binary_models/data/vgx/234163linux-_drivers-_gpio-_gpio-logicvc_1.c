static int logicvc_gpio_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct device_node * of_node = dev -> of_node ; struct logicvc_gpio * logicvc ; int ret ; logicvc = devm_kzalloc ( dev , sizeof ( * logicvc ) , GFP_KERNEL ) ; logicvc -> regmap = syscon_node_to_regmap ( of_node -> parent ) ; if ( IS_ERR ( logicvc -> regmap ) ) { struct resource res ; void __iomem * base ; ret = of_address_to_resource ( of_node , 0 , & res ) ; if ( ret ) { dev_err ( dev , "Failed to get resource from address\n" ) ; return ret ; } base = devm_ioremap_resource ( dev , & res ) ; if ( IS_ERR ( base ) ) { return PTR_ERR ( base ) ; } logicvc_gpio_regmap_config . max_register = resource_size ( & res ) - logicvc_gpio_regmap_config . reg_stride ; logicvc -> regmap = devm_regmap_init_mmio ( dev , base , & logicvc_gpio_regmap_config ) ; if ( IS_ERR ( logicvc -> regmap ) ) { dev_err ( dev , "Failed to create regmap for I/O\n" ) ; return PTR_ERR ( logicvc -> regmap ) ; } } logicvc -> chip . parent = dev ; logicvc -> chip . owner = THIS_MODULE ; logicvc -> chip . label = dev_name ( dev ) ; logicvc -> chip . base = - 1 ; logicvc -> chip . ngpio = LOGICVC_CTRL_GPIO_BITS + LOGICVC_POWER_CTRL_GPIO_BITS ; logicvc -> chip . get = logicvc_gpio_get ; logicvc -> chip . set = logicvc_gpio_set ; logicvc -> chip . direction_output = logicvc_gpio_direction_output ; platform_set_drvdata ( pdev , logicvc ) ; return devm_gpiochip_add_data ( dev , & logicvc -> chip , logicvc ) ; } 