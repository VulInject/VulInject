static int enable_signals ( struct r3964_info * pInfo , struct pid * pid , int arg ) { struct r3964_client_info * pClient ; struct r3964_client_info * * ppClient ; struct r3964_message * pMsg ; if ( ( arg & R3964_SIG_ALL ) == 0 ) { for ( ppClient = & pInfo -> firstClient ; * ppClient ; ppClient = & ( * ppClient ) -> next ) { pClient = * ppClient ; if ( pClient -> pid == pid ) { TRACE_PS ( "removing client %d from client list" , pid_nr ( pid ) ) ; * ppClient = pClient -> next ; while ( pClient -> msg_count ) { pMsg = remove_msg ( pInfo , pClient ) ; if ( pMsg ) { TRACE_M ( "enable_signals - msg " "kfree %p" , pMsg ) ; } } put_pid ( pClient -> pid ) ; kfree ( pClient ) ; TRACE_M ( "enable_signals - kfree %p" , pClient ) ; return 0 ; } } return - EINVAL ; } else { pClient = findClient ( pInfo , pid ) ; if ( pClient ) { pClient -> sig_flags = arg ; } else { pClient = kmalloc ( sizeof ( r3964_client_info ) , GFP_KERNEL ) ; TRACE_M ( "enable_signals - kmalloc %p" , pClient ) ; if ( pClient == NULL ) { return - ENOMEM ; } TRACE_PS ( "add client %d to client list" , pid_nr ( pid ) ) ; spin_lock_init ( & pClient -> lock ) ; pClient -> sig_flags = arg ; pClient -> pid = get_pid ( pid ) ; pClient -> next = pInfo -> firstClient ; pClient -> first_msg = NULL ; pClient -> last_msg = NULL ; pClient -> next_block_to_read = NULL ; pClient -> msg_count = 0 ; pInfo -> firstClient = pClient ; } } return 0 ; } 