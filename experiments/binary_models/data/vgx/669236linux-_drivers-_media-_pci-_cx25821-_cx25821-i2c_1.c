static int i2c_readbytes ( struct i2c_adapter * i2c_adap , const struct i2c_msg * msg , int joined ) { struct cx25821_i2c * bus = i2c_adap -> algo_data ; struct cx25821_dev * dev = bus -> dev ; u32 ctrl , cnt ; int retval ; if ( i2c_debug && ! joined ) { dprintk ( 1 , "6-%s(msg->len=%d)\n" , __func__ , msg -> len ) ; } if ( msg -> len == 0 ) { cx_write ( bus -> reg_addr , msg -> addr << 25 ) ; cx_write ( bus -> reg_ctrl , bus -> i2c_period | ( 1 << 2 ) | 1 ) ; if ( ! i2c_wait_done ( i2c_adap ) ) { return - EIO ; } dprintk ( 1 , "%s(): returns 0\n" , __func__ ) ; return 0 ; } if ( i2c_debug ) { if ( joined ) { dprintk ( 1 , " R" ) ; } else { dprintk ( 1 , "<R %02x" , ( msg -> addr << 1 ) + 1 ) ; } } for ( cnt = 0 ; cnt < msg -> len ; cnt ++ ) { ctrl = bus -> i2c_period | ( 1 << 12 ) | ( 1 << 2 ) | 1 ; if ( cnt < msg -> len - 1 ) { ctrl |= I2C_NOSTOP | I2C_EXTEND ; } cx_write ( bus -> reg_addr , msg -> addr << 25 ) ; cx_write ( bus -> reg_ctrl , ctrl ) ; retval = i2c_wait_done ( i2c_adap ) ; if ( retval < 0 ) { err } if ( retval == 0 ) { eio } msg -> buf [ cnt ] = cx_read ( bus -> reg_rdata ) & 0xff ; if ( i2c_debug ) { dprintk ( 1 , " %02x" , msg -> buf [ cnt ] ) ; if ( ! ( ctrl & I2C_NOSTOP ) ) { dprintk ( 1 , ">\n" ) ; } } } return msg -> len ; eio retval = - EIO ; err if ( i2c_debug ) { pr_err ( " ERR: %d\n" , retval ) ; } return retval ; } 