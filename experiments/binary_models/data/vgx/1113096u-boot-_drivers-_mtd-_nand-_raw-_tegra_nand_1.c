static int tegra_probe ( struct udevice * dev ) { struct tegra_nand_info * tegra = dev_get_priv ( dev ) ; struct nand_chip * nand = & tegra -> nand_chip ; struct nand_drv * info = & tegra -> nand_ctrl ; struct fdt_nand * config = & info -> config ; struct mtd_info * our_mtd ; int ret ; if ( fdt_decode_nand ( dev , config ) ) { printf ( "Could not decode nand-flash in device tree\n" ) ; return - 1 ; } if ( ! config -> enabled ) { return - 1 ; } info -> reg = config -> reg ; nand -> ecc . mode = NAND_ECC_HW ; nand -> ecc . layout = & eccoob ; nand -> options = LP_OPTIONS ; nand -> cmdfunc = nand_command ; nand -> read_byte = read_byte ; nand -> read_buf = read_buf ; nand -> ecc . read_page = nand_read_page_hwecc ; nand -> ecc . write_page = nand_write_page_hwecc ; nand -> ecc . read_page_raw = nand_read_page_raw ; nand -> ecc . write_page_raw = nand_write_page_raw ; nand -> ecc . read_oob = nand_read_oob ; nand -> ecc . write_oob = nand_write_oob ; nand -> ecc . strength = 1 ; nand -> select_chip = nand_select_chip ; nand -> dev_ready = nand_dev_ready ; nand_set_controller_data ( nand , & tegra -> nand_ctrl ) ; nand -> options |= NAND_NO_SUBPAGE_WRITE ; clock_start_periph_pll ( PERIPH_ID_NDFLASH , CLOCK_ID_PERIPH , 52000000 ) ; setup_timing ( config -> timing , info -> reg ) ; dm_gpio_set_value ( & config -> wp_gpio , 1 ) ; our_mtd = nand_to_mtd ( nand ) ; ret = nand_scan_ident ( our_mtd , CONFIG_SYS_NAND_MAX_CHIPS , NULL ) ; nand -> ecc . size = our_mtd -> writesize ; nand -> ecc . bytes = our_mtd -> oobsize ; ret = nand_scan_tail ( our_mtd ) ; if ( ret ) { return ret ; } ret = nand_register ( 0 , our_mtd ) ; if ( ret ) { dev_err ( dev , "Failed to register MTD: %d\n" , ret ) ; return ret ; } return 0 ; } 