static int seek_frame_generic ( AVFormatContext * s , int stream_index , int64_t timestamp , int flags ) { FFFormatContext * const si = ffformatcontext ( s ) ; AVStream * const st = s -> streams [ stream_index ] ; FFStream * const sti = ffstream ( st ) ; const AVIndexEntry * ie ; int index ; int ret ; index = av_index_search_timestamp ( st , timestamp , flags ) ; if ( index < 0 && sti -> nb_index_entries && timestamp < sti -> index_entries [ 0 ] . timestamp ) { return - 1 ; } if ( index < 0 || index == sti -> nb_index_entries - 1 ) { AVPacket * const pkt = si -> pkt ; int nonkey = 0 ; if ( sti -> nb_index_entries ) { av_assert0 ( sti -> index_entries ) ; ie = & sti -> index_entries [ sti -> nb_index_entries - 1 ] ; if ( ( ret = avio_seek ( s -> pb , ie -> pos , SEEK_SET ) ) < 0 ) { return ret ; } s -> io_repositioned = 1 ; avpriv_update_cur_dts ( s , st , ie -> timestamp ) ; } else { if ( ( ret = avio_seek ( s -> pb , si -> data_offset , SEEK_SET ) ) < 0 ) { return ret ; } s -> io_repositioned = 1 ; } av_packet_unref ( pkt ) ; for ( ; ; ) { int read_status ; { read_status = av_read_frame ( s , pkt ) ; } read_status == AVERROR ( EAGAIN ) ; if ( read_status < 0 ) { break ; } if ( stream_index == pkt -> stream_index && pkt -> dts > timestamp ) { if ( pkt -> flags & AV_PKT_FLAG_KEY ) { av_packet_unref ( pkt ) ; break ; } if ( nonkey ++ > 1000 && st -> codecpar -> codec_id != AV_CODEC_ID_CDGRAPHICS ) { av_log ( s , AV_LOG_ERROR , "seek_frame_generic failed as this stream seems to contain no keyframes after the target timestamp, %d non keyframes found\n" , nonkey ) ; av_packet_unref ( pkt ) ; break ; } } av_packet_unref ( pkt ) ; } index = av_index_search_timestamp ( st , timestamp , flags ) ; } if ( index < 0 ) { return - 1 ; } ff_read_frame_flush ( s ) ; if ( s -> iformat -> read_seek ) { if ( s -> iformat -> read_seek ( s , stream_index , timestamp , flags ) >= 0 ) { return 0 ; } } ie = & sti -> index_entries [ index ] ; if ( ( ret = avio_seek ( s -> pb , ie -> pos , SEEK_SET ) ) < 0 ) { return ret ; } s -> io_repositioned = 1 ; avpriv_update_cur_dts ( s , st , ie -> timestamp ) ; return 0 ; } 