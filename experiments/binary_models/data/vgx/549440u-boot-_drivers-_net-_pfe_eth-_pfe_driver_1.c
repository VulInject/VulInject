static int hif_tx_desc_init ( struct pfe_ddr_address * pfe_addr ) { struct buf_desc * bd_va ; struct buf_desc * bd_pa ; int i ; struct tx_desc_s * tx_desc ; u32 tx_buf_pa ; if ( g_tx_desc ) { printf ( "%s: HIF Tx desc re-init request\n" , __func__ ) ; return 0 ; } tx_desc = ( tx_desc_s * ) malloc ( sizeof ( tx_desc_s ) ) ; if ( ! tx_desc ) { printf ( "%s:%d:Memory allocation failure\n" , __func__ , __LINE__ ) ; return - ENOMEM ; } tx_desc -> tx_ring_size = HIF_TX_DESC_NT ; bd_va = ( buf_desc * ) ( pfe_addr -> ddr_pfe_baseaddr + TX_BD_BASEADDR ) ; bd_pa = ( buf_desc * ) ( pfe_addr -> ddr_pfe_phys_baseaddr + TX_BD_BASEADDR ) ; tx_desc -> tx_base_pa = ( unsigned long ) bd_pa ; tx_desc -> tx_base = bd_va ; debug ( "%s: Tx desc_base: %p, base_pa: %08x, desc_count: %d\n" , __func__ , tx_desc -> tx_base , tx_desc -> tx_base_pa , tx_desc -> tx_ring_size ) ; memset ( bd_va , 0 , sizeof ( buf_desc ) * tx_desc -> tx_ring_size ) ; tx_buf_pa = pfe_addr -> ddr_pfe_phys_baseaddr + HIF_TX_PKT_DDR_BASEADDR ; for ( i = 0 ; i < tx_desc -> tx_ring_size ; i ++ ) { writel ( ( unsigned long ) ( bd_pa + 1 ) , & bd_va -> next ) ; writel ( tx_buf_pa + ( i * MAX_FRAME_SIZE ) , & bd_va -> data ) ; bd_va ++ ; bd_pa ++ ; } -- bd_va ; writel ( ( u32 ) tx_desc -> tx_base_pa , & bd_va -> next ) ; writel ( tx_desc -> tx_base_pa , HIF_TX_BDP_ADDR ) ; g_tx_desc = tx_desc ; return 0 ; } 