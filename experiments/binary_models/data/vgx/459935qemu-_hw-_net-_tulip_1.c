static void tulip_mii ( TULIPState * s ) { uint32_t changed = s -> old_csr9 ^ s -> csr [ 9 ] ; uint16_t data ; int op , phy , reg ; if ( ! ( s -> csr [ 9 ] & CSR9_MDC ) ) { return ; } s -> mii_bitcnt ++ ; s -> mii_word <<= 1 ; if ( s -> csr [ 9 ] & CSR9_MDO && ( s -> mii_bitcnt < 16 || ! ( s -> csr [ 9 ] & CSR9_MII ) ) ) { s -> mii_word |= 1 ; } if ( s -> mii_bitcnt >= 16 && ( s -> csr [ 9 ] & CSR9_MII ) ) { if ( s -> mii_word & 0x8000 ) { s -> csr [ 9 ] |= CSR9_MDI ; } else { s -> csr [ 9 ] &= ~ CSR9_MDI ; } } if ( s -> mii_word == 0xffffffff ) { s -> mii_bitcnt = 0 ; } if ( s -> mii_bitcnt == 16 ) { op = ( s -> mii_word >> 12 ) & 0x0f ; phy = ( s -> mii_word >> 7 ) & 0x1f ; reg = ( s -> mii_word >> 2 ) & 0x1f ; if ( op == 6 ) { s -> mii_word = tulip_mii_read ( s , phy , reg ) ; } } if ( s -> mii_bitcnt == 32 ) { op = ( s -> mii_word >> 28 ) & 0x0f ; phy = ( s -> mii_word >> 23 ) & 0x1f ; reg = ( s -> mii_word >> 18 ) & 0x1f ; data = s -> mii_word & 0xffff ; if ( op == 5 ) { tulip_mii_write ( s , phy , reg , data ) ; } } } 