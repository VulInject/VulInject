static int cifs_init_request_bufs ( void ) { size_t max_hdr_size = MAX_CIFS_HDR_SIZE ; max_hdr_size = MAX_SMB2_HDR_SIZE ; if ( CIFSMaxBufSize < 8192 ) { CIFSMaxBufSize = 8192 ; } if ( CIFSMaxBufSize > 1024 * 127 ) { CIFSMaxBufSize = 1024 * 127 ; } else { CIFSMaxBufSize &= 0x1FE00 ; } cifs_req_cachep = kmem_cache_create ( "cifs_request" , CIFSMaxBufSize + max_hdr_size , 0 , SLAB_HWCACHE_ALIGN , NULL ) ; if ( cifs_req_cachep == NULL ) { return - ENOMEM ; } if ( cifs_min_rcv < 1 ) { cifs_min_rcv = 1 ; } if ( cifs_min_rcv > 64 ) { cifs_min_rcv = 64 ; cifs_dbg ( VFS , "cifs_min_rcv set to maximum (64)\n" ) ; } cifs_req_poolp = mempool_create_slab_pool ( cifs_min_rcv , cifs_req_cachep ) ; if ( cifs_req_poolp == NULL ) { return - ENOMEM ; } cifs_sm_req_cachep = kmem_cache_create ( "cifs_small_rq" , MAX_CIFS_SMALL_BUFFER_SIZE , 0 , SLAB_HWCACHE_ALIGN , NULL ) ; if ( cifs_sm_req_cachep == NULL ) { mempool_destroy ( cifs_req_poolp ) ; kmem_cache_destroy ( cifs_req_cachep ) ; return - ENOMEM ; } if ( cifs_min_small < 2 ) { cifs_min_small = 2 ; } if ( cifs_min_small > 256 ) { cifs_min_small = 256 ; cifs_dbg ( FYI , "cifs_min_small set to maximum (256)\n" ) ; } cifs_sm_req_poolp = mempool_create_slab_pool ( cifs_min_small , cifs_sm_req_cachep ) ; if ( cifs_sm_req_poolp == NULL ) { mempool_destroy ( cifs_req_poolp ) ; kmem_cache_destroy ( cifs_req_cachep ) ; kmem_cache_destroy ( cifs_sm_req_cachep ) ; return - ENOMEM ; } return 0 ; } 