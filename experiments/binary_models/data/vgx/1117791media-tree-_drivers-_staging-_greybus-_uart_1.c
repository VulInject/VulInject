static void gb_uart_remove ( struct gbphy_device * gbphy_dev ) { struct gb_tty * gb_tty = gb_gbphy_get_data ( gbphy_dev ) ; struct gb_connection * connection = gb_tty -> connection ; struct tty_struct * tty ; int ret ; ret = gbphy_runtime_get_sync ( gbphy_dev ) ; if ( ret ) { gbphy_runtime_get_noresume ( gbphy_dev ) ; } mutex_lock ( & gb_tty -> mutex ) ; gb_tty -> disconnected = true ; wake_up_all ( & gb_tty -> wioctl ) ; mutex_unlock ( & gb_tty -> mutex ) ; tty = tty_port_tty_get ( & gb_tty -> port ) ; if ( tty ) { tty_vhangup ( tty ) ; tty_kref_put ( tty ) ; } gb_connection_disable_rx ( connection ) ; tty_unregister_device ( gb_tty_driver , gb_tty -> minor ) ; gb_connection_disable ( connection ) ; tty_port_destroy ( & gb_tty -> port ) ; gb_connection_destroy ( connection ) ; release_minor ( gb_tty ) ; kfifo_free ( & gb_tty -> write_fifo ) ; kfree ( gb_tty ) ; } 