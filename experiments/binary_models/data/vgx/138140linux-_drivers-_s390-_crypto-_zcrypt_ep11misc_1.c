int ep11_findcard2 ( u32 * * apqns , u32 * nr_apqns , u16 cardnr , u16 domain , int minhwtype , int minapi , const u8 * wkvp ) { struct zcrypt_device_status_ext * device_status ; u32 * _apqns = NULL , _nr_apqns = 0 ; int i , card , dom , rc = - ENOMEM ; struct ep11_domain_info edi ; struct ep11_card_info eci ; device_status = kvmalloc_array ( MAX_ZDEV_ENTRIES_EXT , sizeof ( zcrypt_device_status_ext ) , GFP_KERNEL ) ; if ( ! device_status ) { return - ENOMEM ; } zcrypt_device_status_mask_ext ( device_status ) ; _apqns = kmalloc_array ( 256 , sizeof ( u32 ) , GFP_KERNEL ) ; if ( ! _apqns ) { kvfree ( device_status ) ; return - ENOMEM ; } for ( i = 0 ; i < MAX_ZDEV_ENTRIES_EXT ; i ++ ) { card = AP_QID_CARD ( device_status [ i ] . qid ) ; dom = AP_QID_QUEUE ( device_status [ i ] . qid ) ; if ( ! device_status [ i ] . online ) { continue ; } if ( ! ( device_status [ i ] . functions & 0x01 ) ) { continue ; } if ( cardnr != 0xFFFF && card != cardnr ) { continue ; } if ( domain != 0xFFFF && dom != domain ) { continue ; } if ( minhwtype && device_status [ i ] . hwtype < minhwtype ) { continue ; } if ( minapi > 0 ) { if ( ep11_get_card_info ( card , & eci , 0 ) ) { continue ; } if ( minapi > eci . API_ord_nr ) { continue ; } } if ( wkvp ) { if ( ep11_get_domain_info ( card , dom , & edi ) ) { continue ; } if ( edi . cur_wk_state != '1' ) { continue ; } if ( memcmp ( wkvp , edi . cur_wkvp , 16 ) ) { continue ; } } if ( _nr_apqns < 256 ) { _apqns [ _nr_apqns ++ ] = ( ( ( u16 ) card ) << 16 ) | ( ( u16 ) dom ) ; } } if ( ! _nr_apqns ) { rc = - ENODEV ; } else { * apqns = _apqns ; * nr_apqns = _nr_apqns ; rc = 0 ; } kvfree ( device_status ) ; return rc ; } 