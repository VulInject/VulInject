static int ar9300_eeprom_restore_internal ( struct ath_hw * ah , u8 * mptr , int mdata_size ) { int cptr ; u8 * word ; int code ; int reference , length , major , minor ; int osize ; int it ; u16 checksum , mchecksum ; struct ath_common * common = ath9k_hw_common ( ah ) ; struct ar9300_eeprom * eep ; eeprom_read_op read ; if ( ath9k_hw_use_flash ( ah ) ) { u8 txrx ; if ( ar9300_eeprom_restore_flash ( ah , mptr , mdata_size ) ) { return - EIO ; } eep = ( ar9300_eeprom * ) mptr ; txrx = eep -> baseEepHeader . txrxMask ; if ( txrx != 0 && txrx != 0xff ) { return 0 ; } } word = kzalloc ( 2048 , GFP_KERNEL ) ; memcpy ( mptr , & ar9300_default , mdata_size ) ; read = ar9300_read_eeprom ; if ( AR_SREV_9485 ( ah ) ) { cptr = AR9300_BASE_ADDR_4K ; } if ( AR_SREV_9330 ( ah ) ) { cptr = AR9300_BASE_ADDR_512 ; } else { cptr = AR9300_BASE_ADDR ; } ath_dbg ( common , EEPROM , "Trying EEPROM access at Address 0x%04x\n" , cptr ) ; if ( ar9300_check_eeprom_header ( ah , read , cptr ) ) { found } cptr = AR9300_BASE_ADDR_4K ; ath_dbg ( common , EEPROM , "Trying EEPROM access at Address 0x%04x\n" , cptr ) ; if ( ar9300_check_eeprom_header ( ah , read , cptr ) ) { found } cptr = AR9300_BASE_ADDR_512 ; ath_dbg ( common , EEPROM , "Trying EEPROM access at Address 0x%04x\n" , cptr ) ; if ( ar9300_check_eeprom_header ( ah , read , cptr ) ) { found } read = ar9300_read_otp ; cptr = AR9300_BASE_ADDR ; ath_dbg ( common , EEPROM , "Trying OTP access at Address 0x%04x\n" , cptr ) ; if ( ar9300_check_eeprom_header ( ah , read , cptr ) ) { found } cptr = AR9300_BASE_ADDR_512 ; ath_dbg ( common , EEPROM , "Trying OTP access at Address 0x%04x\n" , cptr ) ; if ( ar9300_check_eeprom_header ( ah , read , cptr ) ) { found } fail found ath_dbg ( common , EEPROM , "Found valid EEPROM data\n" ) ; for ( it = 0 ; it < MSTATE ; it ++ ) { if ( ! read ( ah , cptr , word , COMP_HDR_LEN ) ) { fail } if ( ! ar9300_check_header ( word ) ) { break ; } ar9300_comp_hdr_unpack ( word , & code , & reference , & length , & major , & minor ) ; ath_dbg ( common , EEPROM , "Found block at %x: code=%d ref=%d length=%d major=%d minor=%d\n" , cptr , code , reference , length , major , minor ) ; if ( ( ! AR_SREV_9485 ( ah ) && length >= 1024 ) || ( AR_SREV_9485 ( ah ) && length > EEPROM_DATA_LEN_9485 ) || ( length > cptr ) ) { ath_dbg ( common , EEPROM , "Skipping bad header\n" ) ; cptr -= COMP_HDR_LEN ; continue ; } osize = length ; read ( ah , cptr , word , COMP_HDR_LEN + osize + COMP_CKSUM_LEN ) ; checksum = ar9300_comp_cksum ( & word [ COMP_HDR_LEN ] , length ) ; mchecksum = get_unaligned_le16 ( & word [ COMP_HDR_LEN + osize ] ) ; ath_dbg ( common , EEPROM , "checksum %x %x\n" , checksum , mchecksum ) ; if ( checksum == mchecksum ) { ar9300_compress_decision ( ah , it , code , reference , mptr , word , length , mdata_size ) ; } else { ath_dbg ( common , EEPROM , "skipping block with bad checksum\n" ) ; } cptr -= ( COMP_HDR_LEN + osize + COMP_CKSUM_LEN ) ; } kfree ( word ) ; return cptr ; fail kfree ( word ) ; return - 1 ; } 