int ref_transaction_prepare ( struct ref_transaction * transaction , struct strbuf * err ) { struct ref_store * refs = transaction -> ref_store ; int ret ; switch ( transaction -> state ) { case REF_TRANSACTION_OPEN : break ; case REF_TRANSACTION_PREPARED : BUG ( "prepare called twice on reference transaction" ) ; break ; case REF_TRANSACTION_CLOSED : BUG ( "prepare called on a closed reference transaction" ) ; break ; default : BUG ( "unexpected reference transaction state" ) ; break ; } if ( refs -> repo -> objects -> odb -> disable_ref_updates ) { strbuf_addstr ( err , _ ( "ref updates forbidden inside quarantine environment" ) ) ; return - 1 ; } ret = refs -> be -> transaction_prepare ( refs , transaction , err ) ; ret = run_transaction_hook ( transaction , "prepared" ) ; if ( ret ) { ref_transaction_abort ( transaction , err ) ; die ( _ ( "ref updates aborted by hook" ) ) ; } return 0 ; } 