static int enic_rq_alloc_buf ( struct vnic_rq * rq ) { struct enic * enic = vnic_dev_priv ( rq -> vdev ) ; struct net_device * netdev = enic -> netdev ; struct sk_buff * skb ; unsigned int len = netdev -> mtu + VLAN_ETH_HLEN ; unsigned int os_buf_index = 0 ; dma_addr_t dma_addr ; struct vnic_rq_buf * buf = rq -> to_use ; if ( buf -> os_buf ) { enic_queue_rq_desc ( rq , buf -> os_buf , os_buf_index , buf -> dma_addr , buf -> len ) ; return 0 ; } skb = netdev_alloc_skb_ip_align ( netdev , len ) ; if ( ! skb ) { return - ENOMEM ; } dma_addr = dma_map_single ( & enic -> pdev -> dev , skb -> data , len , DMA_FROM_DEVICE ) ; if ( unlikely ( enic_dma_map_check ( enic , dma_addr ) ) ) { return - ENOMEM ; } enic_queue_rq_desc ( rq , skb , os_buf_index , dma_addr , len ) ; return 0 ; } 