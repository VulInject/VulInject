int nfs_lock ( struct file * filp , int cmd , struct file_lock * fl ) { struct inode * inode = filp -> f_mapping -> host ; int ret = - ENOLCK ; int is_local = 0 ; dprintk ( "NFS: lock(%pD2, t=%x, fl=%x, r=%lld:%lld)\n" , filp , fl -> fl_type , fl -> fl_flags , ( long long ) fl -> fl_start , ( long long ) fl -> fl_end ) ; if ( fl -> fl_flags & FL_RECLAIM ) { return - ENOGRACE ; } if ( NFS_SERVER ( inode ) -> flags & NFS_MOUNT_LOCAL_FCNTL ) { is_local = 1 ; } if ( NFS_PROTO ( inode ) -> lock_check_bounds != NULL ) { ret = NFS_PROTO ( inode ) -> lock_check_bounds ( fl ) ; if ( ret < 0 ) { out_err } } if ( IS_GETLK ( cmd ) ) { ret = do_getlk ( filp , cmd , fl , is_local ) ; } if ( fl -> fl_type == F_UNLCK ) { ret = do_unlk ( filp , cmd , fl , is_local ) ; } else { ret = do_setlk ( filp , cmd , fl , is_local ) ; } out_err return ret ; } 