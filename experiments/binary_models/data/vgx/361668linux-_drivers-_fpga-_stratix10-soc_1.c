static int s10_send_buf ( struct fpga_manager * mgr , const char * buf , size_t count ) { struct s10_priv * priv = mgr -> priv ; struct device * dev = priv -> client . dev ; void * svc_buf ; int xfer_sz ; int ret ; uint i ; for ( i = 0 ; i < NUM_SVC_BUFS ; i ++ ) { if ( ! test_and_set_bit_lock ( SVC_BUF_LOCK , & priv -> svc_bufs [ i ] . lock ) ) { break ; } } if ( i == NUM_SVC_BUFS ) { return - ENOBUFS ; } xfer_sz = count < SVC_BUF_SIZE ?count : SVC_BUF_SIZE ; svc_buf = priv -> svc_bufs [ i ] . buf ; memcpy ( svc_buf , buf , xfer_sz ) ; ret = s10_svc_send_msg ( priv , COMMAND_RECONFIG_DATA_SUBMIT , svc_buf , xfer_sz ) ; if ( ret < 0 ) { dev_err ( dev , "Error while sending data to service layer (%d)" , ret ) ; clear_bit_unlock ( SVC_BUF_LOCK , & priv -> svc_bufs [ i ] . lock ) ; return ret ; } return xfer_sz ; } 