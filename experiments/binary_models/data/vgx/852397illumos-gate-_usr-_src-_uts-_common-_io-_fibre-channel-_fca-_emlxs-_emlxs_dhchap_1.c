BIG_ERR_CODE emlxs_interm_hash ( emlxs_port_t * port , emlxs_port_dhc_t * port_dhc , NODELIST * ndlp , void * hash_val , uint32_t tran_id , union challenge_val un_cval , uint8_t * dhval , uint32_t * dhvallen ) { emlxs_node_dhc_t * node_dhc = & ndlp -> node_dhc ; uint32_t dhgp_id ; uint32_t hash_id ; MD5_CTX mdctx ; SHA1_CTX sha1ctx ; uint8_t sha1_digest [ 20 ] ; uint8_t md5_digest [ 16 ] ; uint32_t hash_size ; BIG_ERR_CODE err = BIG_OK ; if ( ndlp -> nlp_DID == FABRIC_DID ) { hash_id = node_dhc -> hash_id ; dhgp_id = node_dhc -> dhgp_id ; } else { hash_id = node_dhc -> nlp_auth_hashid ; dhgp_id = node_dhc -> nlp_auth_dhgpid ; } if ( hash_id == AUTH_MD5 ) { bzero ( & mdctx , sizeof ( MD5_CTX ) ) ; hash_size = MD5_LEN ; MD5Init ( & mdctx ) ; MD5Update ( & mdctx , ( unsigned char * ) & ( un_cval . md5 . val [ 0 ] ) , MD5_LEN ) ; err = emlxs_BIGNUM_get_pubkey ( port , port_dhc , ndlp , dhval , dhvallen , hash_size , dhgp_id ) ; if ( ndlp -> nlp_DID == FABRIC_DID ) { MD5Update ( & mdctx , ( unsigned char * ) & node_dhc -> ses_key [ 0 ] , node_dhc -> seskey_len ) ; } else { MD5Update ( & mdctx , ( unsigned char * ) & node_dhc -> nlp_auth_misc . ses_key [ 0 ] , node_dhc -> nlp_auth_misc . seskey_len ) ; } MD5Final ( ( uint8_t * ) md5_digest , & mdctx ) ; bcopy ( ( void * ) & md5_digest , ( void * ) hash_val , MD5_LEN ) ; } if ( hash_id == AUTH_SHA1 ) { bzero ( & sha1ctx , sizeof ( SHA1_CTX ) ) ; hash_size = SHA1_LEN ; SHA1Init ( & sha1ctx ) ; SHA1Update ( & sha1ctx , ( void * ) & ( un_cval . sha1 . val [ 0 ] ) , SHA1_LEN ) ; err = emlxs_BIGNUM_get_pubkey ( port , port_dhc , ndlp , dhval , dhvallen , hash_size , dhgp_id ) ; if ( err != BIG_OK ) { return ( err ) ; } if ( ndlp -> nlp_DID == FABRIC_DID ) { SHA1Update ( & sha1ctx , ( void * ) & node_dhc -> ses_key [ 0 ] , node_dhc -> seskey_len ) ; } else { SHA1Update ( & sha1ctx , ( void * ) & node_dhc -> nlp_auth_misc . ses_key [ 0 ] , node_dhc -> nlp_auth_misc . seskey_len ) ; } SHA1Final ( ( void * ) sha1_digest , & sha1ctx ) ; bcopy ( ( void * ) & sha1_digest , ( void * ) hash_val , SHA1_LEN ) ; } return ( err ) ; } 