static int matroxfb_get_vblank ( struct matrox_fb_info * minfo , struct fb_vblank * vblank ) { unsigned int sts1 ; matroxfb_enable_irq ( minfo , 0 ) ; vblank -> flags = FB_VBLANK_HAVE_VCOUNT | FB_VBLANK_HAVE_VSYNC | FB_VBLANK_HAVE_VBLANK | FB_VBLANK_HAVE_HBLANK ; sts1 = mga_inb ( M_INSTS1 ) ; vblank -> vcount = mga_inl ( M_VCOUNT ) ; if ( sts1 & 1 ) { vblank -> flags |= FB_VBLANK_HBLANKING ; } if ( sts1 & 8 ) { vblank -> flags |= FB_VBLANK_VSYNCING ; } if ( vblank -> vcount >= minfo -> fbcon . var . yres ) { vblank -> flags |= FB_VBLANK_VBLANKING ; } if ( test_bit ( 0 , & minfo -> irq_flags ) ) { vblank -> flags |= FB_VBLANK_HAVE_COUNT ; vblank -> count = minfo -> crtc1 . vsync . cnt ; } return 0 ; } 