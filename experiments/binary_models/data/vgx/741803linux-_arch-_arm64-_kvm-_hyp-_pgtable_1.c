static int hyp_unmap_walker ( const struct kvm_pgtable_visit_ctx * ctx , enum kvm_pgtable_walk_flags visit ) { kvm_pte_t * childp = NULL ; u64 granule = kvm_granule_size ( ctx -> level ) ; u64 * unmapped = ctx -> arg ; struct kvm_pgtable_mm_ops * mm_ops = ctx -> mm_ops ; if ( ! kvm_pte_valid ( ctx -> old ) ) { return - EINVAL ; } if ( kvm_pte_table ( ctx -> old , ctx -> level ) ) { childp = kvm_pte_follow ( ctx -> old , mm_ops ) ; if ( mm_ops -> page_count ( childp ) != 1 ) { return 0 ; } kvm_clear_pte ( ctx -> ptep ) ; dsb ( ishst ) ; __tlbi_level ( vae2is , __TLBI_VADDR ( ctx -> addr , 0 ) , ctx -> level ) ; } else { kvm_clear_pte ( ctx -> ptep ) ; dsb ( ishst ) ; __tlbi_level ( vale2is , __TLBI_VADDR ( ctx -> addr , 0 ) , ctx -> level ) ; * unmapped += granule ; } dsb ( ish ) ; isb ( ) ; mm_ops -> put_page ( ctx -> ptep ) ; if ( childp ) { mm_ops -> put_page ( childp ) ; } return 0 ; } 