static l_mem atomic ( lua_State * L ) { global_State * g = G ( L ) ; l_mem work = - cast ( l_mem , g -> GCmemtrav ) ; GCObject * origweak , * origall ; lua_assert ( ! iswhite ( obj2gco ( g -> mainthread ) ) ) ; markobject ( g , L ) ; markvalue ( g , & g -> l_registry ) ; markmt ( g ) ; remarkupvals ( g ) ; propagateall ( g , NULL ) ; work += g -> GCmemtrav ; retraversegrays ( g ) ; work -= g -> GCmemtrav ; convergeephemerons ( g ) ; clearvalues ( g , g -> weak , NULL ) ; clearvalues ( g , g -> allweak , NULL ) ; origweak = g -> weak ; origall = g -> allweak ; work += g -> GCmemtrav ; separatetobefnz ( L , 0 ) ; markbeingfnz ( g ) ; propagateall ( g ) ; work -= g -> GCmemtrav ; convergeephemerons ( g ) ; clearkeys ( g , g -> ephemeron , NULL ) ; clearkeys ( g , g -> allweak , NULL ) ; clearvalues ( g , g -> weak , origweak ) ; clearvalues ( g , g -> allweak , origall ) ; g -> currentwhite = cast_byte ( otherwhite ( g ) ) ; work += g -> GCmemtrav ; return work ; } 