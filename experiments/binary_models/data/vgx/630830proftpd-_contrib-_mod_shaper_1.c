static int shaper_table_lock ( int op ) { static int have_lock = FALSE ; int flag ; struct flock lock ; if ( ! have_lock && ( op & LOCK_UN ) ) { return 0 ; } pr_trace_msg ( "lock" , 9 , "attempting to %s ShaperTable fd %d via flock(2)" , op == LOCK_UN ?"unlock" : "lock" , shaper_tabfd ) ; while ( flock ( shaper_tabfd , op ) < 0 ) { int xerrno = errno ; if ( xerrno == EINTR ) { pr_signals_handle ( ) ; continue ; } pr_trace_msg ( "lock" , 9 , "%s of ShaperTable fd %d failed: %s" , op == LOCK_UN ?"unlock" : "lock" , shaper_tabfd , strerror ( xerrno ) ) ; errno = xerrno ; return - 1 ; } pr_trace_msg ( "lock" , 9 , "%s of ShaperTable fd %d successful" , op == LOCK_UN ?"unlock" : "lock" , shaper_tabfd ) ; if ( ( op & LOCK_SH ) || ( op & LOCK_EX ) ) { have_lock = TRUE ; } if ( op & LOCK_UN ) { have_lock = FALSE ; } return 0 ; flag = F_SETLKW ; lock . l_whence = 0 ; lock . l_start = lock . l_len = 0 ; if ( op & LOCK_SH ) { lock . l_type = F_RDLCK ; } if ( op & LOCK_EX ) { lock . l_type = F_WRLCK ; } if ( op & LOCK_UN ) { lock . l_type = F_UNLCK ; } else { errno = EINVAL ; return - 1 ; } if ( op & LOCK_NB ) { flag = F_SETLK ; } pr_trace_msg ( "lock" , 9 , "attempting to %s ShaperTable fd %d via fcntl(2)" , op == LOCK_UN ?"unlock" : "lock" , shaper_tabfd ) ; while ( fcntl ( shaper_tabfd , flag , & lock ) < 0 ) { int xerrno = errno ; if ( xerrno == EINTR ) { pr_signals_handle ( ) ; continue ; } pr_trace_msg ( "lock" , 9 , "%s of ShaperTable fd %d failed: %s" , op == LOCK_UN ?"unlock" : "lock" , shaper_tabfd , strerror ( xerrno ) ) ; if ( xerrno == EACCES ) { if ( fcntl ( shaper_tabfd , F_GETLK , & lock ) == 0 ) { pr_trace_msg ( "lock" , 3 , "process ID %lu has blocking %s lock on " "ShaperTable fd %d" , ( unsigned long ) lock . l_pid , get_lock_type ( & lock ) , shaper_tabfd ) ; } } errno = xerrno ; return - 1 ; } pr_trace_msg ( "lock" , 9 , "%s of ShaperTable fd %d successful" , op == LOCK_UN ?"unlock" : "lock" , shaper_tabfd ) ; if ( ( op & LOCK_SH ) || ( op & LOCK_EX ) ) { have_lock = TRUE ; } if ( op & LOCK_UN ) { have_lock = FALSE ; } return 0 ; } 