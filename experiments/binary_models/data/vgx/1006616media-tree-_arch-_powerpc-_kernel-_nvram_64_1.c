static void oops_to_nvram ( struct kmsg_dumper * dumper , enum kmsg_dump_reason reason ) { struct oops_log_info * oops_hdr = ( oops_log_info * ) oops_buf ; static unsigned int oops_count = 0 ; static bool panicking = false ; static DEFINE_SPINLOCK ( lock ) ; unsigned long flags ; size_t text_len ; unsigned int err_type = ERR_TYPE_KERNEL_PANIC_GZ ; int rc = - 1 ; switch ( reason ) { case KMSG_DUMP_RESTART : case KMSG_DUMP_HALT : case KMSG_DUMP_POWEROFF : return ; case KMSG_DUMP_OOPS : break ; case KMSG_DUMP_PANIC : panicking = true ; break ; case KMSG_DUMP_EMERG : if ( panicking ) { return ; } break ; default : pr_err ( "%s: ignoring unrecognized KMSG_DUMP_* reason %d\n" , __func__ , ( int ) reason ) ; return ; } if ( clobbering_unread_rtas_event ( ) ) { return ; } if ( ! spin_trylock_irqsave ( & lock , flags ) ) { return ; } if ( big_oops_buf ) { kmsg_dump_get_buffer ( dumper , false , big_oops_buf , big_oops_buf_sz , & text_len ) ; rc = zip_oops ( text_len ) ; } if ( rc != 0 ) { kmsg_dump_rewind ( dumper ) ; kmsg_dump_get_buffer ( dumper , false , oops_data , oops_data_sz , & text_len ) ; err_type = ERR_TYPE_KERNEL_PANIC ; oops_hdr -> version = cpu_to_be16 ( OOPS_HDR_VERSION ) ; oops_hdr -> report_length = cpu_to_be16 ( text_len , NULL ) ; oops_hdr -> timestamp = cpu_to_be64 ( ktime_get_real_seconds ( ) ) ; } ( void ) nvram_write_os_partition ( & oops_log_partition , oops_buf , ( int ) ( sizeof ( * oops_hdr ) + text_len ) , err_type , ++ oops_count ) ; spin_unlock_irqrestore ( & lock , flags ) ; } 