static int gameport_queue_event ( void * object , struct module * owner , enum gameport_event_type event_type ) { unsigned long flags ; struct gameport_event * event ; int retval = 0 ; spin_lock_irqsave ( & gameport_event_lock , flags ) ; list_for_each_entry_reverse ( , , ) { if ( event -> object == object ) { if ( event -> type == event_type ) { out } break ; } } event = kmalloc ( sizeof ( gameport_event ) , GFP_ATOMIC ) ; if ( ! event ) { pr_err ( "Not enough memory to queue event %d\n" , event_type ) ; retval = - ENOMEM ; out } if ( ! try_module_get ( owner ) ) { pr_warn ( "Can't get module reference, dropping event %d\n" , event_type ) ; retval = - EINVAL ; out } event -> type = event_type ; event -> object = object ; event -> owner = owner ; list_add_tail ( & event -> node , & gameport_event_list ) ; queue_work ( system_long_wq , & gameport_event_work ) ; out spin_unlock_irqrestore ( & gameport_event_lock , flags ) ; return retval ; } 