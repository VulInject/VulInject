static ssize_t tls13_key_update_recv ( struct tls13_ctx * ctx , CBS * cbs ) { struct tls13_handshake_msg * hs_msg = NULL ; CBB cbb_hs ; CBS cbs_hs ; uint8_t alert = TLS13_ALERT_INTERNAL_ERROR ; uint8_t key_update_request ; ssize_t ret ; if ( ! CBS_get_u8 ( cbs , & key_update_request ) ) { alert = TLS13_ALERT_DECODE_ERROR ; err } if ( CBS_len ( cbs ) != 0 ) { alert = TLS13_ALERT_DECODE_ERROR ; err } if ( key_update_request > 1 ) { alert = TLS13_ALERT_ILLEGAL_PARAMETER ; err } if ( ! tls13_phh_update_read_traffic_secret ( ctx ) ) { err } if ( key_update_request == 0 ) { return TLS13_IO_SUCCESS ; } if ( ( hs_msg = tls13_handshake_msg_new ( ) ) == NULL ) { err } if ( ! tls13_handshake_msg_start ( hs_msg , & cbb_hs , TLS13_MT_KEY_UPDATE ) ) { err } if ( ! CBB_add_u8 ( & cbb_hs , 0 ) ) { err } if ( ! tls13_handshake_msg_finish ( hs_msg ) ) { err } ctx -> key_update_request = 1 ; tls13_handshake_msg_data ( hs_msg , & cbs_hs ) ; ret = tls13_record_layer_phh ( ctx -> rl , & cbs_hs ) ; hs_msg = NULL ; return ret ; err tls13_handshake_msg_free ( hs_msg ) ; return tls13_send_alert ( ctx -> rl , alert ) ; } 