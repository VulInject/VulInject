static int slice_get_derivative ( AVFilterContext * ctx , void * arg , int jobnr , int nb_jobs ) { ColorConstancyContext * s = ctx -> priv ; ThreadData * td = arg ; AVFrame * in = td -> in ; const int ord = td -> meta_data [ INDEX_ORD ] ; const int dir = td -> meta_data [ INDEX_DIR ] ; const int src_index = td -> meta_data [ INDEX_SRC ] ; const int dst_index = td -> meta_data [ INDEX_DST ] ; const int filtersize = s -> filtersize ; const double * gauss = s -> gauss [ ord ] ; int plane ; for ( plane = 0 ; plane < NUM_PLANES ; ++ plane ) { const int height = s -> planeheight [ plane ] ; const int width = s -> planewidth [ plane ] ; const int in_linesize = in -> linesize [ plane ] ; double * dst = td -> data [ dst_index ] [ plane ] ; int slice_start , slice_end ; int r , c , g ; if ( dir == DIR_X ) { const uint8_t * src = in -> data [ plane ] ; slice_start = ( height * jobnr ) / nb_jobs ; slice_end = ( height * ( jobnr + 1 ) ) / nb_jobs ; for ( r = slice_start ; r < slice_end ; ++ r ) { for ( c = 0 ; c < width ; ++ c ) { for ( g = 0 ; g < filtersize ; ++ g ) { dst [ INDX2D ( r , c , width ) ] += GAUSS ( src , r , c + GINDX ( filtersize , g ) , in_linesize , height , width , gauss [ g ] ) ; } } } } else { const double * src = td -> data [ src_index ] [ plane ] ; slice_start = ( width * jobnr ) / nb_jobs ; slice_end = ( width * ( jobnr + 1 ) ) / nb_jobs ; for ( c = slice_start ; c < slice_end ; ++ c ) { for ( r = 0 ; r < height ; ++ r ) { dst [ INDX2D ( r , c , width ) ] = 0 ; for ( g = 0 ; g < filtersize ; ++ g ) { dst [ INDX2D ( r , c , width ) ] += GAUSS ( src , r + GINDX ( filtersize , g ) , c , width , height , width , gauss [ g ] ) ; } } } } } return 0 ; } 