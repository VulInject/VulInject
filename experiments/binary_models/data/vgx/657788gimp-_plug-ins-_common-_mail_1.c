send_image ( , , , , ) { GimpPDBStatusType status = GIMP_PDB_SUCCESS ; gchar * ext ; GFile * tmpfile ; gchar * tmpname ; gchar * mailcmd [ 9 ] ; gchar * filepath = NULL ; GFile * tmp_dir = NULL ; GFileEnumerator * enumerator ; gint i ; gchar * mailcmd [ 3 ] ; GPid mailpid ; FILE * mailpipe = NULL ; GError * error = NULL ; ext = find_extension ( filename ) ; if ( ext == NULL ) { return GIMP_PDB_CALLING_ERROR ; } tmpfile = gimp_temp_file ( ext + 1 ) ; tmpname = g_file_get_path ( tmpfile ) ; if ( ! ( gimp_file_save ( run_mode , image , n_drawables , ( const GimpItem * * ) drawables , tmpfile ) && valid_file ( tmpfile ) ) ) { error } tmp_dir = gimp_directory_file ( "tmp" , PLUG_IN_PROC , NULL ) ; if ( g_mkdir_with_parents ( gimp_file_get_utf8_name ( tmp_dir ) , S_IRUSR | S_IWUSR | S_IXUSR ) == - 1 ) { g_message ( "Temporary directory %s could not be created." , gimp_file_get_utf8_name ( tmp_dir ) ) ; g_error_free ( error ) ; error } enumerator = g_file_enumerate_children ( tmp_dir , G_FILE_ATTRIBUTE_STANDARD_TYPE , G_FILE_QUERY_INFO_NOFOLLOW_SYMLINKS , NULL , NULL ) ; if ( enumerator ) { GFileInfo * info ; while ( ( info = g_file_enumerator_next_file ( enumerator , NULL , NULL ) ) ) { if ( g_file_info_get_file_type ( info ) == G_FILE_TYPE_REGULAR ) { GFile * file = g_file_enumerator_get_child ( enumerator , info ) ; g_file_delete ( file , NULL , NULL ) ; g_object_unref ( file ) ; } } g_object_unref ( enumerator ) ; } filepath = g_build_filename ( gimp_file_get_utf8_name ( tmp_dir ) , mail_info . filename , NULL ) ; if ( g_rename ( tmpname , filepath ) == - 1 ) { GFile * source = tmpfile ; GFile * target = g_file_new_for_path ( filepath ) ; if ( ! g_file_move ( source , target , G_FILE_COPY_NONE , NULL , NULL , NULL , & error ) ) { g_message ( "%s" , error -> message ) ; g_clear_error ( & error ) ; g_object_unref ( target ) ; error } g_object_unref ( target ) ; } mailcmd [ 0 ] = g_strdup ( "xdg-email" ) ; mailcmd [ 1 ] = "--attach" ; mailcmd [ 2 ] = filepath ; i = 3 ; if ( strlen ( mail_info . subject ) > 0 ) { mailcmd [ i ++ ] = "--subject" ; mailcmd [ i ++ ] = mail_info . subject ; } if ( strlen ( mail_info . comment ) > 0 ) { mailcmd [ i ++ ] = "--body" ; mailcmd [ i ++ ] = mail_info . comment ; } if ( strlen ( mail_info . receipt ) > 0 ) { mailcmd [ i ++ ] = mail_info . receipt ; } mailcmd [ i ] = NULL ; if ( ! g_spawn_async ( NULL , mailcmd , NULL , G_SPAWN_SEARCH_PATH , NULL , NULL , NULL , & error ) ) { g_message ( "%s" , error -> message ) ; g_error_free ( error ) ; error } if ( strlen ( SENDMAIL ) == 0 ) { mailcmd [ 0 ] = g_strdup ( "sendmail" ) ; } else { mailcmd [ 0 ] = g_build_filename ( SENDMAIL , "sendmail" , NULL ) ; } mailcmd [ 1 ] = mail_info . receipt ; mailcmd [ 2 ] = NULL ; mailpipe = sendmail_pipe ( mailcmd , & mailpid ) ; if ( mailpipe == NULL ) { return GIMP_PDB_EXECUTION_ERROR ; } sendmail_create_headers ( mailpipe ) ; fflush ( mailpipe ) ; if ( ! sendmail_to64 ( tmpname , mailpipe , & error ) ) { g_message ( "%s" , error -> message ) ; g_error_free ( error ) ; error } fprintf ( mailpipe , "\n--GUMP-MIME-boundary--\n" ) ; cleanup error kill ( mailpid , SIGINT ) ; status = GIMP_PDB_EXECUTION_ERROR ; cleanup if ( mailpipe ) { fclose ( mailpipe ) ; waitpid ( mailpid , NULL , 0 ) ; g_spawn_close_pid ( mailpid ) ; } g_unlink ( tmpname ) ; if ( tmp_dir ) { g_object_unref ( tmp_dir ) ; } if ( filepath ) { g_free ( filepath ) ; } g_free ( mailcmd [ 0 ] ) ; g_free ( tmpname ) ; g_object_unref ( tmpfile ) ; return status ; } 