static int eject_scsi ( const struct eject_control * ctl ) { int status , k ; sg_io_hdr_t io_hdr ; unsigned char allowRmBlk [ 6 ] { ALLOW_MEDIUM_REMOVAL 0 0 0 0 0 } ; ; unsigned char startStop1Blk [ 6 ] { START_STOP 0 0 0 1 0 } ; ; unsigned char startStop2Blk [ 6 ] { START_STOP 0 0 0 2 0 } ; ; unsigned char inqBuff [ 2 ] ; unsigned char sense_buffer [ 32 ] ; if ( ( ioctl ( ctl -> fd , SG_GET_VERSION_NUM , & k ) < 0 ) || ( k < 30000 ) ) { verbose ( ctl , _ ( "not an sg device, or old sg driver" ) ) ; return 0 ; } io_hdr . interface_id = 'S' ; io_hdr . cmd_len = 6 ; io_hdr . mx_sb_len = sizeof ( sense_buffer ) ; io_hdr . dxfer_direction = SG_DXFER_NONE ; io_hdr . dxfer_len = 0 ; io_hdr . dxferp = inqBuff ; io_hdr . sbp = sense_buffer ; io_hdr . timeout = 10000 ; io_hdr . cmdp = allowRmBlk ; status = ioctl ( ctl -> fd , SG_IO , ( void * ) & io_hdr ) ; if ( status < 0 || io_hdr . host_status || io_hdr . driver_status ) { return 0 ; } io_hdr . cmdp = startStop1Blk ; status = ioctl ( ctl -> fd , SG_IO , ( void * ) & io_hdr ) ; if ( status < 0 || io_hdr . host_status ) { return 0 ; } if ( io_hdr . driver_status != 0 && ! ( io_hdr . driver_status == DRIVER_SENSE && io_hdr . sbp && io_hdr . sbp [ 12 ] == 0x3a ) ) { return 0 ; } io_hdr . cmdp = startStop2Blk ; status = ioctl ( ctl -> fd , SG_IO , ( void * ) & io_hdr ) ; if ( status < 0 || io_hdr . host_status || io_hdr . driver_status ) { return 0 ; } ioctl ( ctl -> fd , BLKRRPART ) ; return 1 ; } 