int fasync_remove_entry ( struct file * filp , struct fasync_struct * * fapp ) { struct fasync_struct * fa , * * fp ; int result = 0 ; spin_lock ( & filp -> f_lock ) ; spin_lock ( & fasync_lock ) ; for ( fp = fapp ; ( fa = * fp ) != NULL ; fp = & fa -> fa_next ) { write_lock_irq ( & fa -> fa_lock ) ; fa -> fa_file = NULL ; write_unlock_irq ( & fa -> fa_lock ) ; * fp = fa -> fa_next ; call_rcu ( & fa -> fa_rcu , fasync_free_rcu ) ; filp -> f_flags &= ~ FASYNC ; result = 1 ; break ; } spin_unlock ( & fasync_lock ) ; spin_unlock ( & filp -> f_lock ) ; return result ; } 