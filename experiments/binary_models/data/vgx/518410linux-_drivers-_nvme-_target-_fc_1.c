static void nvmet_fc_ls_create_connection ( struct nvmet_fc_tgtport * tgtport , struct nvmet_fc_ls_iod * iod ) { struct fcnvme_ls_cr_conn_rqst * rqst = & iod -> rqstbuf -> rq_cr_conn ; struct fcnvme_ls_cr_conn_acc * acc = & iod -> rspbuf -> rsp_cr_conn ; struct nvmet_fc_tgt_queue * queue ; int ret = 0 ; memset ( acc , 0 , sizeof ( * acc ) ) ; if ( iod -> rqstdatalen < sizeof ( fcnvme_ls_cr_conn_rqst ) ) { ret = VERR_CR_CONN_LEN ; } if ( rqst -> desc_list_len != fcnvme_lsdesc_len ( sizeof ( fcnvme_ls_cr_conn_rqst ) ) ) { ret = VERR_CR_CONN_RQST_LEN ; } if ( rqst -> associd . desc_tag != cpu_to_be32 ( FCNVME_LSDESC_ASSOC_ID ) ) { ret = VERR_ASSOC_ID ; } if ( rqst -> associd . desc_len != fcnvme_lsdesc_len ( sizeof ( fcnvme_lsdesc_assoc_id ) ) ) { ret = VERR_ASSOC_ID_LEN ; } if ( rqst -> connect_cmd . desc_tag != cpu_to_be32 ( FCNVME_LSDESC_CREATE_CONN_CMD ) ) { ret = VERR_CR_CONN_CMD ; } if ( rqst -> connect_cmd . desc_len != fcnvme_lsdesc_len ( sizeof ( fcnvme_lsdesc_cr_conn_cmd ) ) ) { ret = VERR_CR_CONN_CMD_LEN ; } if ( ! rqst -> connect_cmd . ersp_ratio || ( be16_to_cpu ( rqst -> connect_cmd . ersp_ratio ) >= be16_to_cpu ( rqst -> connect_cmd . sqsize ) ) ) { ret = VERR_ERSP_RATIO ; } else { iod -> assoc = nvmet_fc_find_target_assoc ( tgtport , be64_to_cpu ( rqst -> associd . association_id ) ) ; if ( ! iod -> assoc ) { ret = VERR_NO_ASSOC ; } else { queue = nvmet_fc_alloc_target_queue ( iod -> assoc , be16_to_cpu ( rqst -> connect_cmd . qid ) , be16_to_cpu ( rqst -> connect_cmd . sqsize ) ) ; if ( ! queue ) { ret = VERR_QUEUE_ALLOC_FAIL ; } nvmet_fc_tgt_a_put ( iod -> assoc ) ; } } if ( ret ) { dev_err ( tgtport -> dev , "Create Connection LS failed: %s\n" , validation_errors [ ret ] ) ; iod -> lsrsp -> rsplen = nvme_fc_format_rjt ( acc , sizeof ( * acc ) , rqst -> w0 . ls_cmd , ( ret == VERR_NO_ASSOC ) ?FCNVME_RJT_RC_INV_ASSOC : FCNVME_RJT_RC_LOGIC , FCNVME_RJT_EXP_NONE , 0 ) ; return ; } queue -> ersp_ratio = be16_to_cpu ( rqst -> connect_cmd . ersp_ratio ) ; atomic_set ( & queue -> connected , 1 ) ; queue -> sqhd = 0 ; iod -> lsrsp -> rsplen = sizeof ( * acc ) ; nvme_fc_format_rsp_hdr ( acc , FCNVME_LS_ACC , fcnvme_lsdesc_len ( sizeof ( fcnvme_ls_cr_conn_acc ) ) , FCNVME_LS_CREATE_CONNECTION ) ; acc -> connectid . desc_tag = cpu_to_be32 ( FCNVME_LSDESC_CONN_ID , NULL ) ; acc -> connectid . desc_len = fcnvme_lsdesc_len ( sizeof ( fcnvme_lsdesc_conn_id ) ) ; acc -> connectid . connection_id = cpu_to_be64 ( nvmet_fc_makeconnid ( iod -> assoc , be16_to_cpu ( rqst -> connect_cmd . qid ) ) ) ; } 