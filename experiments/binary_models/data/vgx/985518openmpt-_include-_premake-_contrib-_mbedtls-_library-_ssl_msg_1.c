static int ssl_get_remaining_payload_in_datagram ( mbedtls_ssl_context const * ssl ) { int ret = MBEDTLS_ERR_ERROR_CORRUPTION_DETECTED ; size_t remaining , expansion ; size_t max_len = MBEDTLS_SSL_OUT_CONTENT_LEN ; const size_t mfl = mbedtls_ssl_get_output_max_frag_len ( ssl ) ; if ( max_len > mfl ) { max_len = mfl ; } if ( max_len <= ssl -> out_left ) { return ( 0 ) ; } max_len -= ssl -> out_left ; ret = ssl_get_remaining_space_in_datagram ( ssl ) ; remaining = ( size_t ) ret ; ret = mbedtls_ssl_get_record_expansion ( ssl ) ; if ( ret < 0 ) { return ( ret ) ; } expansion = ( size_t ) ret ; if ( remaining <= expansion ) { return ( 0 ) ; } remaining -= expansion ; if ( remaining >= max_len ) { remaining = max_len ; } return ( ( int ) remaining ) ; } 