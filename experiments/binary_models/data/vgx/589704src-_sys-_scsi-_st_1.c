void st_buf_done ( struct scsi_xfer * xs ) { struct buf * bp = xs -> cookie ; int error , s ; switch ( xs -> error ) { case XS_NOERROR : bp -> b_error = 0 ; CLR ( bp -> b_flags , B_ERROR ) ; bp -> b_resid = xs -> resid ; break ; case XS_SENSE : case XS_SHORTSENSE : SC_DEBUG_SENSE ( xs ) ; error = st_interpret_sense ( xs ) ; if ( error == 0 ) { bp -> b_error = 0 ; CLR ( bp -> b_flags , B_ERROR ) ; bp -> b_resid = xs -> resid ; break ; } if ( error != ERESTART ) { xs -> retries = 0 ; } retry case XS_BUSY : if ( xs -> retries ) { if ( scsi_delay ( xs , 1 ) != ERESTART ) { xs -> retries = 0 ; } } retry case XS_TIMEOUT : retry if ( xs -> retries -- ) { scsi_xs_exec ( xs , NULL ) ; return ; } default : bp -> b_error = EIO ; SET ( bp -> b_flags , B_ERROR ) ; bp -> b_resid = bp -> b_bcount ; break ; } s = splbio ( ) ; biodone ( bp ) ; splx ( s ) ; scsi_xs_put ( xs ) ; } 