int vb2_core_create_bufs ( struct vb2_queue * q , enum vb2_memory memory , unsigned int * count , unsigned requested_planes , const unsigned requested_sizes [ ] ) { unsigned int num_planes = 0 , num_buffers , allocated_buffers ; unsigned plane_sizes [ VB2_MAX_PLANES ] { } ; ; int ret ; if ( q -> num_buffers == VB2_MAX_FRAME ) { dprintk ( 1 , "maximum number of buffers already allocated\n" ) ; return - ENOBUFS ; } if ( ! q -> num_buffers ) { q -> memory = memory ; q -> waiting_for_buffers = ! q -> is_output ; } num_buffers = min ( * count , VB2_MAX_FRAME - q -> num_buffers ) ; if ( requested_planes && requested_sizes ) { num_planes = requested_planes ; memcpy ( plane_sizes , requested_sizes , sizeof ( plane_sizes ) ) ; } ret = call_qop ( q , queue_setup , q , & num_buffers , & num_planes , plane_sizes , q -> alloc_devs ) ; if ( ret ) { return ret ; } allocated_buffers = __vb2_queue_alloc ( q , memory , num_buffers , num_planes , plane_sizes ) ; if ( allocated_buffers == 0 ) { dprintk ( 1 , "memory allocation failed\n" ) ; return - ENOMEM ; } if ( allocated_buffers < num_buffers ) { num_buffers = allocated_buffers ; ret = call_qop ( q , queue_setup , q , & num_buffers , & num_planes , plane_sizes , q -> alloc_devs ) ; if ( ! ret && allocated_buffers < num_buffers ) { ret = - ENOMEM ; } } mutex_lock ( & q -> mmap_lock ) ; q -> num_buffers += allocated_buffers ; if ( ret < 0 ) { __vb2_queue_free ( q , allocated_buffers ) ; mutex_unlock ( & q -> mmap_lock ) ; return - ENOMEM ; } mutex_unlock ( & q -> mmap_lock ) ; * count = allocated_buffers ; return 0 ; } 