static int match_ctxt ( struct hfi1_filedata * fd , const struct hfi1_user_info * uinfo , struct hfi1_ctxtdata * uctxt ) { struct hfi1_devdata * dd = fd -> dd ; unsigned long flags ; u16 subctxt ; if ( uctxt -> sc && ( uctxt -> sc -> type == SC_KERNEL ) ) { return 0 ; } if ( memcmp ( uctxt -> uuid , uinfo -> uuid , sizeof ( uctxt -> uuid ) ) || uctxt -> jkey != generate_jkey ( current_uid ( ) ) || uctxt -> subctxt_id != uinfo -> subctxt_id || uctxt -> subctxt_cnt != uinfo -> subctxt_cnt ) { return 0 ; } if ( uctxt -> userversion != uinfo -> userversion ) { return - EINVAL ; } spin_lock_irqsave ( & dd -> uctxt_lock , flags ) ; if ( bitmap_empty ( uctxt -> in_use_ctxts , HFI1_MAX_SHARED_CTXTS ) ) { spin_unlock_irqrestore ( & dd -> uctxt_lock , flags ) ; return 0 ; } subctxt = find_first_zero_bit ( uctxt -> in_use_ctxts , HFI1_MAX_SHARED_CTXTS ) ; if ( subctxt >= uctxt -> subctxt_cnt ) { spin_unlock_irqrestore ( & dd -> uctxt_lock , flags ) ; return - EBUSY ; } fd -> subctxt = subctxt ; __set_bit ( fd -> subctxt , uctxt -> in_use_ctxts ) ; spin_unlock_irqrestore ( & dd -> uctxt_lock , flags ) ; fd -> uctxt = uctxt ; hfi1_rcd_get ( uctxt , NULL ) ; return 1 ; } 