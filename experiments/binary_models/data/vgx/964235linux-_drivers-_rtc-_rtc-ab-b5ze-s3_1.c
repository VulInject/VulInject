static int _abb5zes3_rtc_read_timer ( struct device * dev , struct rtc_wkalrm * alarm ) { struct abb5zes3_rtc_data * data = dev_get_drvdata ( dev ) ; struct rtc_time rtc_tm , * alarm_tm = & alarm -> time ; u8 regs [ ABB5ZES3_TIMA_SEC_LEN + 1 ] ; unsigned long rtc_secs ; unsigned int reg ; u8 timer_secs ; int ret ; ret = regmap_bulk_read ( data -> regmap , ABB5ZES3_REG_TIM_CLK , regs , ABB5ZES3_TIMA_SEC_LEN + 1 ) ; if ( ret ) { dev_err ( dev , "%s: reading Timer A section failed (%d)\n" , __func__ , ret ) ; return ret ; } ret = _abb5zes3_rtc_read_time ( dev , & rtc_tm ) ; rtc_secs = rtc_tm_to_time64 ( & rtc_tm ) ; ret = sec_from_timer_a ( & timer_secs , regs [ 1 ] , regs [ 2 ] ) ; if ( ret ) { return ret ; } rtc_time64_to_tm ( rtc_secs + timer_secs , alarm_tm ) ; ret = regmap_read ( data -> regmap , ABB5ZES3_REG_CTRL2 , & reg ) ; if ( ret ) { dev_err ( dev , "%s: reading ctrl reg failed (%d)\n" , __func__ , ret ) ; return ret ; } alarm -> enabled = ! ! ( reg & ABB5ZES3_REG_CTRL2_WTAIE ) ; return 0 ; } 