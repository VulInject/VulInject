bool cpu_wait_death ( unsigned int cpu , int seconds ) { int jf_left = seconds * HZ ; int oldstate ; bool ret = true ; int sleep_jf = 1 ; might_sleep ( ) ; if ( atomic_read ( & per_cpu ( cpu_hotplug_state , cpu ) ) == CPU_DEAD ) { update_state_early } udelay ( 5 ) ; while ( atomic_read ( & per_cpu ( cpu_hotplug_state , cpu ) ) != CPU_DEAD ) { schedule_timeout_uninterruptible ( sleep_jf ) ; jf_left -= sleep_jf ; sleep_jf = DIV_ROUND_UP ( sleep_jf * 11 , 10 ) ; } update_state_early oldstate = atomic_read ( & per_cpu ( cpu_hotplug_state , cpu ) ) ; update_state if ( oldstate == CPU_DEAD ) { smp_mb ( ) ; atomic_set ( & per_cpu ( cpu_hotplug_state , cpu ) , CPU_POST_DEAD ) ; } else { if ( ! atomic_try_cmpxchg ( & per_cpu ( cpu_hotplug_state , cpu ) , & oldstate , CPU_BROKEN ) ) { update_state } ret = false ; } return ret ; } 