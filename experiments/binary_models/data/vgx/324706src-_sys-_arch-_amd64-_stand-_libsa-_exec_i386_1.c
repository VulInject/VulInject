void ucode_load ( void ) extern struct cmd_state cmd ; char * bootmac = NULL ; extern char end [ ] , _start [ ] ; caddr_t pt_base_addr ; void run_loadfile ( uint64_t * marks , int howto ) { uint64_t entry ; dev_t bootdev = bootdev_dip -> bootdev ; size_t ac = BOOTARG_LEN ; caddr_t av = ( caddr_t ) BOOTARG_OFF ; bios_consdev_t cd ; extern int com_speed ; extern int com_addr ; bios_ddb_t ddb ; extern int db_console ; bios_bootduid_t bootduid ; caddr_t pml4 , stack , new_av ; bios_bootsr_t bootsr ; struct sr_boot_volume * bv ; if ( sa_cleanup != NULL ) { * sa_cleanup ( ) ; } cd . consdev = cn_tab -> cn_dev ; cd . conspeed = com_speed ; cd . consaddr = com_addr ; addbootarg ( BOOTARG_CONSDEV , sizeof ( cd ) , & cd ) ; if ( bootmac != NULL ) { addbootarg ( BOOTARG_BOOTMAC , sizeof ( bios_bootmac_t ) , bootmac ) ; } if ( db_console != - 1 ) { ddb . db_console = db_console ; addbootarg ( BOOTARG_DDB , sizeof ( ddb ) , & ddb ) ; } bcopy ( bootdev_dip -> disklabel . d_uid , & bootduid . duid , sizeof ( bootduid ) ) ; addbootarg ( BOOTARG_BOOTDUID , sizeof ( bootduid ) , & bootduid ) ; ucode_load ( ) ; if ( bootdev_dip -> sr_vol != NULL ) { bv = bootdev_dip -> sr_vol ; bzero ( & bootsr , sizeof ( bootsr ) ) ; bcopy ( & bv -> sbv_uuid , & bootsr . uuid , sizeof ( bootsr . uuid ) ) ; if ( bv -> sbv_maskkey != NULL ) { bcopy ( bv -> sbv_maskkey , & bootsr . maskkey , sizeof ( bootsr . maskkey ) ) ; } addbootarg ( BOOTARG_BOOTSR , sizeof ( bios_bootsr_t ) , & bootsr ) ; explicit_bzero ( & bootsr , sizeof ( bootsr ) ) ; } sr_clear_keys ( ) ; entry = marks [ MARK_ENTRY ] ; printf ( "entry point at 0x%llx\n" , entry ) ; pt_base_addr = ( caddr_t ) LONG_KERN_PML4_ADDR1 ; mem_pass ( ) ; makebootargs ( av , & ac ) ; if ( entry == LEGACY_KERNEL_ENTRY_POINT ) { entry &= 0xFFFFFFF ; ( * ( startfuncp ) entry ) ( howto , bootdev , BOOTARG_APIVER , marks [ MARK_END ] & 0xfffffff , extmem , cnvmem , ac , ( int ) av ) ; } new_av = boot_alloc ( ) ; memcpy ( ( void * ) new_av , av , ac ) ; stack = boot_alloc ( ) ; stack = boot_alloc ( ) ; pml4 = make_kernel_page_tables ( entry ) ; launch_amd64_kernel_long ( ( void * ) launch_amd64_kernel_long , pml4 , stack , entry , howto , bootdev , BOOTARG_APIVER , marks [ MARK_END ] , extmem , cnvmem , ac , ( uint64_t ) new_av ) ; } 