static rpmRC runImmedTriggers ( rpmpsm psm , rpmsenseFlags sense ) { const rpmts ts = psm -> ts ; unsigned char * triggersRun ; struct rpmtd_s tnames , tindexes ; Header h = rpmteHeader ( psm -> te ) ; int nerrors = 0 ; if ( ! ( headerGet ( h , RPMTAG_TRIGGERNAME , & tnames , HEADERGET_MINMEM ) && headerGet ( h , RPMTAG_TRIGGERINDEX , & tindexes , HEADERGET_MINMEM ) ) ) { exit } triggersRun = xcalloc ( rpmtdCount ( & tindexes ) , sizeof ( * triggersRun ) ) ; { Header sourceH = NULL ; const char * trigName ; rpm_count_t * triggerIndices = tindexes . data ; while ( ( trigName = rpmtdNextString ( & tnames ) ) ) { rpmdbMatchIterator mi ; int i = rpmtdGetIndex ( & tnames ) ; if ( triggersRun [ triggerIndices [ i ] ] != 0 ) { continue ; } mi = rpmtsInitIterator ( ts , RPMDBI_NAME , trigName , 0 ) ; while ( ( sourceH = rpmdbNextIterator ( mi ) ) != NULL ) { nerrors += handleOneTrigger ( psm -> ts , psm -> te , sense , sourceH , h , psm -> countCorrection , rpmdbGetIteratorCount ( mi ) , triggersRun ) ; } rpmdbFreeIterator ( mi ) ; } } rpmtdFreeData ( & tnames ) ; rpmtdFreeData ( & tindexes ) ; exit headerFree ( h ) ; return ( nerrors == 0 ) ?RPMRC_OK : RPMRC_FAIL ; } 