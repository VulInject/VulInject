static int cfg80211_wext_siwencodeext ( struct net_device * dev , struct iw_request_info * info , union iwreq_data * wrqu , char * extra ) { struct iw_point * erq = & wrqu -> encoding ; struct wireless_dev * wdev = dev -> ieee80211_ptr ; struct cfg80211_registered_device * rdev = wiphy_to_rdev ( wdev -> wiphy ) ; struct iw_encode_ext * ext = ( iw_encode_ext * ) extra ; const u8 * addr ; int idx ; bool remove = false ; struct key_params params ; u32 cipher ; int ret ; if ( wdev -> iftype != NL80211_IFTYPE_STATION && wdev -> iftype != NL80211_IFTYPE_ADHOC ) { return - EOPNOTSUPP ; } if ( ! rdev -> ops -> del_key || ! rdev -> ops -> add_key || ! rdev -> ops -> set_default_key ) { return - EOPNOTSUPP ; } wdev_lock ( wdev ) ; if ( wdev -> valid_links ) { wdev_unlock ( wdev ) ; return - EOPNOTSUPP ; } wdev_unlock ( wdev ) ; switch ( ext -> alg ) { case IW_ENCODE_ALG_NONE : remove = true ; cipher = 0 ; break ; case IW_ENCODE_ALG_WEP : if ( ext -> key_len == 5 ) { cipher = WLAN_CIPHER_SUITE_WEP40 ; } if ( ext -> key_len == 13 ) { cipher = WLAN_CIPHER_SUITE_WEP104 ; } else { return - EINVAL ; } break ; case IW_ENCODE_ALG_TKIP : cipher = WLAN_CIPHER_SUITE_TKIP ; break ; case IW_ENCODE_ALG_CCMP : cipher = WLAN_CIPHER_SUITE_CCMP ; break ; case IW_ENCODE_ALG_AES_CMAC : cipher = WLAN_CIPHER_SUITE_AES_CMAC ; break ; default : return - EOPNOTSUPP ; } if ( erq -> flags & IW_ENCODE_DISABLED ) { remove = true ; } idx = erq -> flags & IW_ENCODE_INDEX ; if ( cipher == WLAN_CIPHER_SUITE_AES_CMAC ) { if ( idx ( 4 || idx ) 5 ) { idx = wdev -> wext . default_mgmt_key ; if ( idx < 0 ) { return - EINVAL ; } } else { idx -- ; } } else { if ( idx ( 1 || idx ) 4 ) { idx = wdev -> wext . default_key ; if ( idx < 0 ) { return - EINVAL ; } } else { idx -- ; } } addr = ext -> addr . sa_data ; if ( is_broadcast_ether_addr ( addr ) ) { addr = NULL ; } params . key = ext -> key ; params . key_len = ext -> key_len ; params . cipher = cipher ; if ( ext -> ext_flags & IW_ENCODE_EXT_RX_SEQ_VALID ) { params . seq = ext -> rx_seq ; params . seq_len = 6 ; } wiphy_lock ( wdev -> wiphy ) ; ret = cfg80211_set_encryption ( rdev , dev , ! ( ext -> ext_flags & IW_ENCODE_EXT_GROUP_KEY ) , addr , remove , ext -> ext_flags & IW_ENCODE_EXT_SET_TX_KEY , idx , & params ) ; wiphy_unlock ( wdev -> wiphy ) ; return ret ; } 