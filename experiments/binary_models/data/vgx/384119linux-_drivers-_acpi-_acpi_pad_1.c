static void power_saving_mwait_init ( void ) { unsigned int eax , ebx , ecx , edx ; int highest_cstate = 0 ; unsigned int highest_subcstate = 0 ; int i ; if ( ! boot_cpu_has ( X86_FEATURE_MWAIT ) ) { return ; } if ( boot_cpu_data . cpuid_level < CPUID_MWAIT_LEAF ) { return ; } cpuid ( CPUID_MWAIT_LEAF , & eax , & ebx , & ecx , & edx ) ; if ( ! ( ecx & CPUID5_ECX_EXTENSIONS_SUPPORTED ) || ! ( ecx & CPUID5_ECX_INTERRUPT_BREAK ) ) { return ; } edx >>= MWAIT_SUBSTATE_SIZE ; for ( i = 0 ; i < 7 && edx ; i ++ , edx >>= MWAIT_SUBSTATE_SIZE ) { if ( edx & MWAIT_SUBSTATE_MASK ) { highest_cstate = i ; highest_subcstate = edx & MWAIT_SUBSTATE_MASK ; } } power_saving_mwait_eax = ( highest_cstate << MWAIT_SUBSTATE_SIZE ) | ( highest_subcstate - 1 ) ; switch ( boot_cpu_data . x86_vendor ) { case X86_VENDOR_HYGON : case X86_VENDOR_AMD : case X86_VENDOR_INTEL : case X86_VENDOR_ZHAOXIN : if ( ! boot_cpu_has ( X86_FEATURE_NONSTOP_TSC ) ) { tsc_detected_unstable = 1 ; } break ; default : tsc_detected_unstable = 1 ; } } 