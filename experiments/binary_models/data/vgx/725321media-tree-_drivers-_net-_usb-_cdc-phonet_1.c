static int usbpn_probe ( struct usb_interface * intf , const struct usb_device_id * id ) { static const char ifname [ ] "usbpn%d" ; ; const struct usb_cdc_union_desc * union_header = NULL ; const struct usb_host_interface * data_desc ; struct usb_interface * data_intf ; struct usb_device * usbdev = interface_to_usbdev ( intf ) ; struct net_device * dev ; struct usbpn_dev * pnd ; u8 * data ; int phonet = 0 ; int len , err ; struct usb_cdc_parsed_header hdr ; data = intf -> altsetting -> extra ; len = intf -> altsetting -> extralen ; cdc_parse_cdc_header ( & hdr , intf , data , len ) ; union_header = hdr . usb_cdc_union_desc ; phonet = hdr . phonet_magic_present ; data_intf = usb_ifnum_to_if ( usbdev , union_header -> bSlaveInterface0 ) ; if ( data_intf == NULL ) { return - ENODEV ; } if ( data_intf -> num_altsetting != 2 ) { return - EINVAL ; } if ( data_intf -> altsetting [ 0 ] . desc . bNumEndpoints == 0 && data_intf -> altsetting [ 1 ] . desc . bNumEndpoints == 2 ) { data_desc = data_intf -> altsetting + 1 ; } if ( data_intf -> altsetting [ 0 ] . desc . bNumEndpoints == 2 && data_intf -> altsetting [ 1 ] . desc . bNumEndpoints == 0 ) { data_desc = data_intf -> altsetting ; } else { return - EINVAL ; } dev = alloc_netdev ( sizeof ( * pnd ) + sizeof ( pnd -> urbs [ 0 ] ) * rxq_size , ifname , NET_NAME_UNKNOWN , usbpn_setup ) ; if ( ! dev ) { return - ENOMEM ; } pnd = netdev_priv ( dev ) ; SET_NETDEV_DEV ( dev , & intf -> dev ) ; pnd -> dev = dev ; pnd -> usb = usbdev ; pnd -> intf = intf ; pnd -> data_intf = data_intf ; spin_lock_init ( & pnd -> tx_lock ) ; spin_lock_init ( & pnd -> rx_lock ) ; if ( usb_pipein ( data_desc -> endpoint [ 0 ] . desc . bEndpointAddress ) ) { pnd -> rx_pipe = usb_rcvbulkpipe ( usbdev , data_desc -> endpoint [ 0 ] . desc . bEndpointAddress ) ; pnd -> tx_pipe = usb_sndbulkpipe ( usbdev , data_desc -> endpoint [ 1 ] . desc . bEndpointAddress ) ; } else { pnd -> rx_pipe = usb_rcvbulkpipe ( usbdev , data_desc -> endpoint [ 1 ] . desc . bEndpointAddress ) ; pnd -> tx_pipe = usb_sndbulkpipe ( usbdev , data_desc -> endpoint [ 0 ] . desc . bEndpointAddress ) ; } pnd -> active_setting = data_desc - data_intf -> altsetting ; err = usb_driver_claim_interface ( & usbpn_driver , data_intf , pnd ) ; if ( err ) { out } usb_set_interface ( usbdev , union_header -> bSlaveInterface0 , ! pnd -> active_setting ) ; usb_set_intfdata ( intf , pnd ) ; err = register_netdev ( dev ) ; if ( err ) { usb_driver_release_interface ( & usbpn_driver , data_intf ) ; out } dev_dbg ( & dev -> dev , "USB CDC Phonet device found\n" ) ; return 0 ; out usb_set_intfdata ( intf , NULL ) ; free_netdev ( dev ) ; return err ; } 