static void stm32_dma_stop ( struct stm32_dma_chan * chan ) { struct stm32_dma_device * dmadev = stm32_dma_get_dev ( chan ) ; u32 dma_scr , dma_sfcr , status ; int ret ; dma_scr = stm32_dma_read ( dmadev , STM32_DMA_SCR ( chan -> id ) ) ; dma_scr &= ~ STM32_DMA_SCR_IRQ_MASK ; stm32_dma_write ( dmadev , STM32_DMA_SCR ( chan -> id ) , dma_scr ) ; dma_sfcr = stm32_dma_read ( dmadev , STM32_DMA_SFCR ( chan -> id ) ) ; dma_sfcr &= ~ STM32_DMA_SFCR_FEIE ; stm32_dma_write ( dmadev , STM32_DMA_SFCR ( chan -> id ) , dma_sfcr ) ; ret = stm32_dma_disable_chan ( chan ) ; status = stm32_dma_irq_status ( chan ) ; if ( status ) { dev_dbg ( chan2dev ( chan ) , "%s(): clearing interrupt: 0x%08x\n" , __func__ , status ) ; stm32_dma_irq_clear ( chan , status ) ; } chan -> busy = false ; chan -> status = DMA_COMPLETE ; } 