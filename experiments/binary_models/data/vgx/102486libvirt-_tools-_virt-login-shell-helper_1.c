static int virLoginShellAllowedUser ( virConf * conf , const char * name , gid_t * groups , size_t ngroups ) { int ret = - 1 ; size_t i ; char * gname = NULL ; g_auto ( ) users = NULL ; char * * entries ; if ( virConfGetValueStringList ( conf , "allowed_users" , false , & users ) < 0 ) { cleanup } for ( entries = users ; entries && * entries ; entries ++ ) { char * entry = * entries ; if ( entry [ 0 ] == '%' ) { entry ++ ; for ( i = 0 ; i < ngroups ; i ++ ) { if ( ! ( gname = virGetGroupName ( groups [ i ] ) ) ) { continue ; } if ( g_pattern_match_simple ( entry , gname ) ) { ret = 0 ; cleanup } VIR_FREE ( gname ) ; } } else { if ( g_pattern_match_simple ( entry , name ) ) { ret = 0 ; cleanup } } } virReportSystemError ( EPERM , _ ( "%s not matched against 'allowed_users' in %s" ) , name , conf_file ) ; cleanup VIR_FREE ( gname ) ; return ret ; } 