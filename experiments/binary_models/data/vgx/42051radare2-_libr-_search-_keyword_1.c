R_API RSearchKeyword * r_search_keyword_new_wide ( const char * kwbuf , const char * bmstr , const char * data , bool ignore_case ) { RSearchKeyword * kw ; int len ; const char * p2 ; char * p , * str ; ut8 * bmbuf = NULL ; int bmlen ; if ( bmstr ) { bmbuf = malloc ( strlen ( bmstr ) + 1 ) ; if ( ! bmbuf ) { return NULL ; } bmlen = r_hex_str2bin ( bmstr , bmbuf ) ; if ( bmlen < 1 ) { R_FREE ( bmbuf ) ; } } len = strlen ( kwbuf ) ; str = malloc ( ( len + 1 ) * 2 ) ; for ( p2 = kwbuf , p = str ; * p2 ; ) { RRune ch ; int num_utf8_bytes = r_utf8_decode ( ( const ut8 * ) p2 , kwbuf + len - p2 , & ch ) ; if ( num_utf8_bytes < 1 ) { R_LOG_WARN ( "Malformed UTF8 at pos %d" , ( int ) ( p2 - kwbuf ) ) ; p [ 0 ] = * p2 ; p [ 1 ] = 0 ; p2 ++ ; p += 2 ; continue ; } if ( ignore_case && ch <= 0xff ) { ch = tolower ( ch ) ; } int num_wide_bytes = r_utf16le_encode ( ( ut8 * ) p , ch ) ; r_warn_if_fail ( num_wide_bytes != 0 ) ; p2 += num_utf8_bytes ; p += num_wide_bytes ; } kw = r_search_keyword_new ( ( ut8 * ) str , p - str , bmbuf , bmlen , data ) ; free ( str ) ; if ( kw ) { kw -> icase = ignore_case ; } free ( bmbuf ) ; return kw ; } 