static int qedi_process_nopin_mesg ( struct qedi_ctx * qedi , union iscsi_cqe * cqe , struct iscsi_task * task , struct qedi_conn * qedi_conn , u16 que_idx ) { struct iscsi_conn * conn = qedi_conn -> cls_conn -> dd_data ; struct iscsi_session * session = conn -> session ; struct iscsi_nop_in_hdr * cqe_nop_in ; struct iscsi_nopin * hdr ; struct qedi_cmd * cmd ; int tgt_async_nop = 0 ; u32 lun [ 2 ] ; u32 pdu_len , num_bdqs ; char bdq_data [ QEDI_BDQ_BUF_SIZE ] ; unsigned long flags ; spin_lock_bh ( & session -> back_lock ) ; cqe_nop_in = & cqe -> cqe_common . iscsi_hdr . nop_in ; pdu_len = cqe_nop_in -> hdr_second_dword & ISCSI_NOP_IN_HDR_DATA_SEG_LEN_MASK ; num_bdqs = pdu_len / QEDI_BDQ_BUF_SIZE ; hdr = ( iscsi_nopin * ) & qedi_conn -> gen_pdu . resp_hdr ; hdr -> opcode = cqe_nop_in -> opcode ; hdr -> max_cmdsn = cpu_to_be32 ( cqe_nop_in -> max_cmd_sn ) ; hdr -> exp_cmdsn = cpu_to_be32 ( cqe_nop_in -> exp_cmd_sn ) ; hdr -> statsn = cpu_to_be32 ( cqe_nop_in -> stat_sn ) ; hdr -> ttt = cpu_to_be32 ( cqe_nop_in -> ttt ) ; if ( cqe -> cqe_common . cqe_type == ISCSI_CQE_TYPE_UNSOLICITED ) { spin_lock_irqsave ( & qedi -> hba_lock , flags ) ; qedi_unsol_pdu_adjust_bdq ( qedi , & cqe -> cqe_unsolicited , pdu_len , num_bdqs , bdq_data ) ; hdr -> itt = RESERVED_ITT ; tgt_async_nop = 1 ; spin_unlock_irqrestore ( & qedi -> hba_lock , flags ) ; done } if ( task ) { cmd = task -> dd_data ; hdr -> flags = ISCSI_FLAG_CMD_FINAL ; hdr -> itt = build_itt ( cqe -> cqe_solicited . itid , conn -> session -> age ) ; lun [ 0 ] = 0xffffffff ; lun [ 1 ] = 0xffffffff ; memcpy ( & hdr -> lun , lun , sizeof ( scsi_lun ) ) ; QEDI_INFO ( & qedi -> dbg_ctx , QEDI_LOG_TID , "Freeing tid=0x%x for cid=0x%x\n" , cmd -> task_id , qedi_conn -> iscsi_conn_id ) ; cmd -> state = RESPONSE_RECEIVED ; spin_lock ( & qedi_conn -> list_lock ) ; if ( likely ( cmd -> io_cmd_in_list ) ) { cmd -> io_cmd_in_list = false ; list_del_init ( & cmd -> io_cmd ) ; qedi_conn -> active_cmd_count -- ; } spin_unlock ( & qedi_conn -> list_lock ) ; qedi_clear_task_idx ( qedi , cmd -> task_id ) ; } done __iscsi_complete_pdu ( conn , ( iscsi_hdr * ) hdr , bdq_data , pdu_len ) ; spin_unlock_bh ( & session -> back_lock ) ; return tgt_async_nop ; } 