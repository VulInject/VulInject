static int netdev_vti_fill_message_create ( NetDev * netdev , Link * link , sd_netlink_message * m ) { union in_addr_union local ; uint32_t ikey , okey ; Tunnel * t ; int r ; assert ( netdev ) ; assert ( m ) ; if ( netdev -> kind == NETDEV_KIND_VTI ) { t = VTI ( netdev ) ; } else { t = VTI6 ( netdev ) ; } assert ( t ) ; if ( link || t -> assign_to_loopback ) { r = sd_netlink_message_append_u32 ( m , IFLA_VTI_LINK , link ?link -> ifindex : LOOPBACK_IFINDEX ) ; } if ( t -> key != 0 ) { ikey = okey = htobe32 ( t -> key ) ; } else { ikey = htobe32 ( t -> ikey ) ; okey = htobe32 ( t -> okey ) ; } r = sd_netlink_message_append_u32 ( m , IFLA_VTI_IKEY , ikey ) ; if ( r < 0 ) { return r ; } r = sd_netlink_message_append_u32 ( m , IFLA_VTI_OKEY , okey ) ; if ( r < 0 ) { return r ; } r = tunnel_get_local_address ( t , link , & local ) ; if ( r < 0 ) { return log_netdev_error_errno ( netdev , r , "Could not find local address: %m" ) ; } r = netlink_message_append_in_addr_union ( m , IFLA_VTI_LOCAL , t -> family , & local ) ; if ( r < 0 ) { return r ; } r = netlink_message_append_in_addr_union ( m , IFLA_VTI_REMOTE , t -> family , & t -> remote ) ; if ( r < 0 ) { return r ; } return 0 ; } 