static int create_of_modalias ( struct acpi_device * acpi_dev , char * modalias , int size ) { struct acpi_buffer buf = { ACPI_ALLOCATE_BUFFER } ; const union acpi_object * of_compatible , * obj ; int len , count ; int i , nval ; char * c ; acpi_get_name ( acpi_dev -> handle , ACPI_SINGLE_NAME , & buf ) ; for ( c = buf . pointer ; * c != '\0' ; c ++ ) { * c = tolower ( * c ) ; } len = snprintf ( modalias , size , "of:N%sT" , ( char * ) buf . pointer ) ; ACPI_FREE ( buf . pointer ) ; of_compatible = acpi_dev -> data . of_compatible ; if ( of_compatible -> type == ACPI_TYPE_PACKAGE ) { nval = of_compatible -> package . count ; obj = of_compatible -> package . elements ; } else { nval = 1 ; obj = of_compatible ; } for ( i = 0 ; i < nval ; i ++ , obj ++ ) { count = snprintf ( & modalias [ len ] , size , "C%s" , obj -> string . pointer ) ; if ( count < 0 ) { return - EINVAL ; } if ( count >= size ) { return - ENOMEM ; } len += count ; size -= count ; } modalias [ len ] = '\0' ; return len ; } 