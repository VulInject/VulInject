static int _read_ofed_values ( void ) { static uint64_t last_update_xmtdata = 0 ; static uint64_t last_update_rcvdata = 0 ; static uint64_t last_update_xmtpkts = 0 ; static uint64_t last_update_rcvpkts = 0 ; static bool first = true ; int rc = SLURM_SUCCESS ; uint16_t cap_mask ; uint64_t send_val , recv_val , send_pkts , recv_pkts ; ofed_sens . last_update_time = ofed_sens . update_time ; ofed_sens . update_time = time ( NULL ) ; if ( first ) { int mgmt_classes [ 4 ] { IB_SMI_CLASS IB_SMI_DIRECT_CLASS IB_SA_CLASS IB_PERFORMANCE_CLASS } ; ; srcport = mad_rpc_open_port ( NULL , ofed_conf . port , mgmt_classes , 4 ) ; if ( ! srcport ) { debug ( "%s: Failed to open port '%d'" , __func__ , ofed_conf . port ) ; debug ( "OFED: failed" ) ; return SLURM_ERROR ; } if ( ib_resolve_self_via ( & portid , & port , 0 , srcport ) < 0 ) { error ( "can't resolve self port %d" , port ) ; } if ( ! _slurm_pma_query_via ( pc , & portid , port , ibd_timeout , CLASS_PORT_INFO , srcport ) ) { error ( "classportinfo query: %m" ) ; } memcpy ( & cap_mask , pc + 2 , sizeof ( cap_mask ) ) ; if ( ! _slurm_pma_query_via ( pc , & portid , port , ibd_timeout , IB_GSI_PORT_COUNTERS_EXT , srcport ) ) { error ( "ofed: %m" ) ; return SLURM_ERROR ; } mad_decode_field ( pc , IB_PC_EXT_XMT_BYTES_F , & last_update_xmtdata ) ; mad_decode_field ( pc , IB_PC_EXT_RCV_BYTES_F , & last_update_rcvdata ) ; mad_decode_field ( pc , IB_PC_EXT_XMT_PKTS_F , & last_update_xmtpkts ) ; mad_decode_field ( pc , IB_PC_EXT_RCV_PKTS_F , & last_update_rcvpkts ) ; log_flag ( INTERCONNECT , "%s ofed init" , plugin_name ) ; first = 0 ; return SLURM_SUCCESS ; } memset ( pc , 0 , sizeof ( pc ) ) ; memcpy ( & cap_mask , pc + 2 , sizeof ( cap_mask ) ) ; if ( ! _slurm_pma_query_via ( pc , & portid , port , ibd_timeout , IB_GSI_PORT_COUNTERS_EXT , srcport ) ) { error ( "ofed: %m" ) ; return SLURM_ERROR ; } mad_decode_field ( pc , IB_PC_EXT_XMT_BYTES_F , & send_val ) ; mad_decode_field ( pc , IB_PC_EXT_RCV_BYTES_F , & recv_val ) ; mad_decode_field ( pc , IB_PC_EXT_XMT_PKTS_F , & send_pkts ) ; mad_decode_field ( pc , IB_PC_EXT_RCV_PKTS_F , & recv_pkts ) ; ofed_sens . xmtdata = ( send_val - last_update_xmtdata ) * 4 ; ofed_sens . total_xmtdata += ofed_sens . xmtdata ; ofed_sens . rcvdata = ( recv_val - last_update_rcvdata ) * 4 ; ofed_sens . total_rcvdata += ofed_sens . rcvdata ; ofed_sens . xmtpkts = send_pkts - last_update_xmtpkts ; ofed_sens . total_xmtpkts += ofed_sens . xmtpkts ; ofed_sens . rcvpkts = recv_pkts - last_update_rcvpkts ; ofed_sens . total_rcvpkts += ofed_sens . rcvpkts ; last_update_xmtdata = send_val ; last_update_rcvdata = recv_val ; last_update_xmtpkts = send_pkts ; last_update_rcvpkts = recv_pkts ; return rc ; } 