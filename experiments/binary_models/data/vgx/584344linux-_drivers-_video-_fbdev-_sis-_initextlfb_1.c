int sisfb_mode_rate_to_ddata ( struct SiS_Private * SiS_Pr , unsigned char modeno , unsigned char rateindex , struct fb_var_screeninfo * var ) { unsigned short ModeNo = modeno ; unsigned short ModeIdIndex = 0 , index = 0 , RRTI = 0 ; int j ; if ( rateindex > 0 ) { rateindex -- ; } switch ( ModeNo ) { case 0x5a : ModeNo = 0x50 ; break ; case 0x5b : ModeNo = 0x56 ; } if ( ! ( SiS_SearchModeID ( SiS_Pr , & ModeNo , & ModeIdIndex ) ) ) { return 0 ; } RRTI = SiS_Pr -> SiS_EModeIDTable [ ModeIdIndex ] . REFindex ; if ( SiS_Pr -> SiS_RefIndex [ RRTI ] . Ext_InfoFlag & HaveWideTiming ) { if ( SiS_Pr -> SiS_UseWide == 1 ) { index = SiS_Pr -> SiS_RefIndex [ RRTI ] . Ext_CRT1CRTC_WIDE ; } else { RRTI += rateindex ; index = SiS_Pr -> SiS_RefIndex [ RRTI ] . Ext_CRT1CRTC_NORM ; } } else { RRTI += rateindex ; index = SiS_Pr -> SiS_RefIndex [ RRTI ] . Ext_CRT1CRTC ; } SiS_Generic_ConvertCRData ( SiS_Pr , ( unsigned char * ) & SiS_Pr -> SiS_CRT1Table [ index ] . CR [ 0 ] , SiS_Pr -> SiS_RefIndex [ RRTI ] . XRes , SiS_Pr -> SiS_RefIndex [ RRTI ] . YRes , var , false ) ; if ( SiS_Pr -> SiS_RefIndex [ RRTI ] . Ext_InfoFlag & 0x8000 ) { var -> sync &= ~ FB_SYNC_VERT_HIGH_ACT ; } else { var -> sync |= FB_SYNC_VERT_HIGH_ACT ; } if ( SiS_Pr -> SiS_RefIndex [ RRTI ] . Ext_InfoFlag & 0x4000 ) { var -> sync &= ~ FB_SYNC_HOR_HIGH_ACT ; } else { var -> sync |= FB_SYNC_HOR_HIGH_ACT ; } var -> vmode = FB_VMODE_NONINTERLACED ; if ( SiS_Pr -> SiS_RefIndex [ RRTI ] . Ext_InfoFlag & 0x0080 ) { var -> vmode = FB_VMODE_INTERLACED ; } else { j = 0 ; while ( SiS_Pr -> SiS_EModeIDTable [ j ] . Ext_ModeID != 0xff ) { if ( SiS_Pr -> SiS_EModeIDTable [ j ] . Ext_ModeID == SiS_Pr -> SiS_RefIndex [ RRTI ] . ModeID ) { if ( SiS_Pr -> SiS_EModeIDTable [ j ] . Ext_ModeFlag & DoubleScanMode ) { var -> vmode = FB_VMODE_DOUBLE ; } break ; } j ++ ; } } if ( ( var -> vmode & FB_VMODE_MASK ) == FB_VMODE_INTERLACED ) { var -> upper_margin <<= 1 ; var -> lower_margin <<= 1 ; var -> vsync_len <<= 1 ; } if ( ( var -> vmode & FB_VMODE_MASK ) == FB_VMODE_DOUBLE ) { var -> upper_margin >>= 1 ; var -> lower_margin >>= 1 ; var -> vsync_len >>= 1 ; } return 1 ; } 