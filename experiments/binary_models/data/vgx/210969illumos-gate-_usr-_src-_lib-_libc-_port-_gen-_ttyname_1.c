static const entry_t * get_pri_dirs ( void ) { int fd , state ; size_t sz ; ssize_t size ; struct stat64 sb ; char * buf , * ebuf ; entry_t * vec ; if ( ( fd = open ( TTYSRCH , 0 ) ) < 0 ) { return ( def_srch_dirs ) ; } if ( fstat64 ( fd , & sb ) < 0 ) { ( void ) close ( fd ) ; return ( def_srch_dirs ) ; } sz = ( size_t ) sb . st_size ; if ( dir_vec != NULL && sz == dir_size && sb . st_mtim . tv_sec == dir_mtim . tv_sec && sb . st_mtim . tv_nsec == dir_mtim . tv_nsec ) { ( void ) close ( fd ) ; return ( dir_vec ) ; } buf = realloc ( dir_buf , sz + 1 ) ; if ( buf != NULL ) { dir_buf = buf ; size = read ( fd , dir_buf , sz ) ; } ( void ) close ( fd ) ; if ( buf == NULL || size < 0 ) { if ( dir_vec != NULL ) { dir_vec = NULL ; } return ( ( entry_t * ) def_srch_dirs ) ; } dir_size = sz ; dir_mtim = sb . st_mtim ; ebuf = & dir_buf [ size ] ; * ebuf ++ = '\n' ; for ( sz = 1 , buf = dir_buf ; buf < ebuf ; ++ buf ) { if ( * buf == '\n' ) { ++ sz ; } } sz *= sizeof ( * dir_vec ) ; vec = realloc ( dir_vec , sz ) ; if ( vec == NULL ) { if ( dir_vec != NULL ) { free ( dir_vec ) ; dir_vec = NULL ; } return ( def_srch_dirs ) ; } dir_vec = vec ; state = START_STATE ; for ( buf = dir_buf ; buf < ebuf ; ++ buf ) { switch ( state ) { case START_STATE : if ( * buf == COMMENT_CHAR ) { state = COMMENT_STATE ; break ; } if ( ! isspace ( * buf ) ) { state = DIRNAME_STATE ; vec -> name = buf ; vec -> flags = 0 ; } break ; case COMMENT_STATE : if ( * buf == EOLN_CHAR ) { state = START_STATE ; } break ; case DIRNAME_STATE : if ( * buf == EOLN_CHAR ) { state = CHECK_STATE ; * buf = '\0' ; } if ( isspace ( * buf ) ) { state = FLAG_STATE ; * buf = '\0' ; } break ; case FLAG_STATE : switch ( * buf ) { case 'M' : vec -> flags |= MATCH_MM ; break ; case 'F' : vec -> flags |= MATCH_FS ; break ; case 'I' : vec -> flags |= MATCH_INO ; break ; case EOLN_CHAR : state = CHECK_STATE ; break ; } break ; case CHECK_STATE : if ( strncmp ( vec -> name , DEV , strlen ( DEV ) ) != 0 ) { int tfd = open ( "/dev/console" , O_WRONLY ) ; if ( tfd >= 0 ) { char buf [ 256 ] ; ( void ) snprintf ( buf , sizeof ( buf ) , _libc_gettext ( "ERROR: Entry '%s' in /etc/ttysrch ignored.\n" ) , vec -> name ) ; ( void ) write ( tfd , buf , strlen ( buf ) ) ; ( void ) close ( tfd ) ; } } else { char * slash ; slash = vec -> name + strlen ( vec -> name ) - 1 ; while ( * slash == '/' ) { * slash -- = '\0' ; } if ( vec -> flags == 0 ) { vec -> flags = MATCH_ALL ; } vec ++ ; } state = START_STATE ; buf -- ; break ; } } vec -> name = NULL ; return ( dir_vec ) ; } 