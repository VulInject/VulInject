void lpfc_ct_unsol_event ( struct lpfc_hba * phba , struct lpfc_sli_ring * pring , struct lpfc_iocbq * ctiocbq ) { struct lpfc_dmabuf * mp = NULL ; IOCB_t * icmd = & ctiocbq -> iocb ; int i ; struct lpfc_iocbq * iocbq ; struct lpfc_iocbq * iocb ; dma_addr_t dma_addr ; uint32_t size ; struct list_head head ; struct lpfc_sli_ct_request * ct_req ; struct lpfc_dmabuf * bdeBuf1 = ctiocbq -> cmd_dmabuf ; struct lpfc_dmabuf * bdeBuf2 = ctiocbq -> bpl_dmabuf ; u32 status , parameter , bde_count = 0 ; struct lpfc_wcqe_complete * wcqe_cmpl = NULL ; ctiocbq -> rsp_dmabuf = NULL ; ctiocbq -> bpl_dmabuf = NULL ; wcqe_cmpl = & ctiocbq -> wcqe_cmpl ; status = get_job_ulpstatus ( phba , ctiocbq ) ; parameter = get_job_word4 ( phba , ctiocbq ) ; if ( phba -> sli_rev == LPFC_SLI_REV4 ) { bde_count = wcqe_cmpl -> word3 ; } else { bde_count = icmd -> ulpBdeCount ; } if ( unlikely ( status == IOSTAT_NEED_BUFFER ) ) { lpfc_sli_hbqbuf_add_hbqs ( phba , LPFC_ELS_HBQ ) ; } if ( ( status == IOSTAT_LOCAL_REJECT ) && ( ( parameter & IOERR_PARAM_MASK ) == IOERR_RCV_BUFFER_WAITING ) ) { phba -> fc_stat . NoRcvBuf ++ ; if ( ! ( phba -> sli3_options & LPFC_SLI3_HBQ_ENABLED ) ) { lpfc_sli3_post_buffer ( phba , pring , 2 ) ; } return ; } if ( bde_count == 0 ) { return ; } ctiocbq -> cmd_dmabuf = bdeBuf1 ; if ( bde_count == 2 ) { ctiocbq -> bpl_dmabuf = bdeBuf2 ; } ct_req = ( lpfc_sli_ct_request * ) ctiocbq -> cmd_dmabuf -> virt ; if ( ct_req -> FsType == SLI_CT_MANAGEMENT_SERVICE && ct_req -> FsSubType == SLI_CT_MIB_Subtypes ) { lpfc_ct_handle_mibreq ( phba , ctiocbq ) ; } else { if ( ! lpfc_bsg_ct_unsol_event ( phba , pring , ctiocbq ) ) { return ; } } if ( phba -> sli3_options & LPFC_SLI3_HBQ_ENABLED ) { INIT_LIST_HEAD ( & head ) ; list_add_tail ( & head , & ctiocbq -> list ) ; list_for_each_entry ( , , ) { if ( phba -> sli_rev == LPFC_SLI_REV4 ) { bde_count = iocb -> wcqe_cmpl . word3 ; } else { bde_count = iocb -> iocb . ulpBdeCount ; } if ( ! bde_count ) { continue ; } bdeBuf1 = iocb -> cmd_dmabuf ; iocb -> cmd_dmabuf = NULL ; if ( phba -> sli_rev == LPFC_SLI_REV4 ) { size = iocb -> wqe . gen_req . bde . tus . f . bdeSize ; } else { size = iocb -> iocb . un . cont64 [ 0 ] . tus . f . bdeSize ; } lpfc_ct_unsol_buffer ( phba , ctiocbq , bdeBuf1 , size ) ; lpfc_in_buf_free ( phba , bdeBuf1 ) ; if ( bde_count == 2 ) { bdeBuf2 = iocb -> bpl_dmabuf ; iocb -> bpl_dmabuf = NULL ; if ( phba -> sli_rev == LPFC_SLI_REV4 ) { size = iocb -> unsol_rcv_len ; } else { size = iocb -> iocb . unsli3 . rcvsli3 . bde2 . tus . f . bdeSize ; } lpfc_ct_unsol_buffer ( phba , ctiocbq , bdeBuf2 , size ) ; lpfc_in_buf_free ( phba , bdeBuf2 ) ; } } list_del ( & head ) ; } else { INIT_LIST_HEAD ( & head ) ; list_add_tail ( & head , & ctiocbq -> list ) ; list_for_each_entry ( , , ) { icmd = & iocbq -> iocb ; if ( icmd -> ulpBdeCount == 0 ) { lpfc_ct_unsol_buffer ( phba , iocbq , NULL , 0 ) ; } for ( i = 0 ; i < icmd -> ulpBdeCount ; i ++ ) { dma_addr = getPaddr ( icmd -> un . cont64 [ i ] . addrHigh , icmd -> un . cont64 [ i ] . addrLow ) ; mp = lpfc_sli_ringpostbuf_get ( phba , pring , dma_addr ) ; size = icmd -> un . cont64 [ i ] . tus . f . bdeSize ; lpfc_ct_unsol_buffer ( phba , iocbq , mp , size ) ; lpfc_in_buf_free ( phba , mp ) ; } lpfc_sli3_post_buffer ( phba , pring , i ) ; } list_del ( & head ) ; } } 