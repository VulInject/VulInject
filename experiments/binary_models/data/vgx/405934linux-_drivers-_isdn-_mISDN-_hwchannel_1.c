int bchannel_get_rxbuf ( struct bchannel * bch , int reqlen ) { int len ; if ( bch -> rx_skb ) { len = skb_tailroom ( bch -> rx_skb ) ; if ( len < reqlen ) { pr_warn ( "B%d no space for %d (only %d) bytes\n" , bch -> nr , reqlen , len ) ; if ( test_bit ( FLG_TRANSPARENT , & bch -> Flags ) ) { recv_Bchannel ( bch , 0 , true ) ; } else { return - EMSGSIZE ; } } else { return len ; } } if ( unlikely ( bch -> maxlen != bch -> next_maxlen ) ) { bch -> maxlen = bch -> next_maxlen ; } if ( unlikely ( bch -> minlen != bch -> next_minlen ) ) { bch -> minlen = bch -> next_minlen ; } if ( test_bit ( FLG_TRANSPARENT , & bch -> Flags ) ) { if ( reqlen >= bch -> minlen ) { len = reqlen ; } else { len = 2 * bch -> minlen ; if ( len > bch -> maxlen ) { len = bch -> maxlen ; } } } else { len = bch -> maxlen ; } bch -> rx_skb = mI_alloc_skb ( len , GFP_ATOMIC ) ; if ( ! bch -> rx_skb ) { pr_warn ( "B%d receive no memory for %d bytes\n" , bch -> nr , len ) ; len = - ENOMEM ; } return len ; } 