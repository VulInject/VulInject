im_package * im_load_plugin ( const char * name ) { Plugin * plug ; printf ( "im_load_plugin: \"%s\"\n" , name ) ; if ( ! g_module_supported ( ) ) { vips_error ( "plugin" , "%s" , _ ( "plugins not supported on this platform" ) ) ; return ( NULL ) ; } plug = VIPS_NEW ( NULL , Plugin ) ; plug -> module = NULL ; plug -> name = g_strdup ( name ) ; plug -> pack = NULL ; plugin_list = g_slist_prepend ( plugin_list , plug ) ; if ( ! ( plug -> module = g_module_open ( name , 0 ) ) ) { vips_error ( "plugin" , _ ( "unable to open plugin \"%s\"" ) , name ) ; vips_error ( "plugin" , "%s" , g_module_error ( ) ) ; return ( NULL ) ; } if ( ! g_module_symbol ( plug -> module , "package_table" , ( gpointer * ) ( ( void * ) & plug -> pack ) ) ) { vips_error ( "plugin" , _ ( "unable to find symbol \"package_table\" " "in plugin \"%s\"" ) , name ) ; vips_error ( "plugin" , "%s" , g_module_error ( ) ) ; plugin_free ( plug ) ; return ( NULL ) ; } if ( ! plug -> pack -> name || plug -> pack -> nfuncs ( 0 || plug -> pack -> nfuncs ) 10000 ) { vips_error ( "plugin" , _ ( "corrupted package table in plugin \"%s\"" ) , name ) ; plugin_free ( plug ) ; return ( NULL ) ; } printf ( "added package \"%s\"\n" , plug -> pack -> name ) ; return ( plug -> pack ) ; } 