static ssize_t ltc2945_history_store ( struct device * dev , struct device_attribute * da , const char * buf , size_t count ) { struct sensor_device_attribute * attr = to_sensor_dev_attr ( da ) ; struct ltc2945_data * data = dev_get_drvdata ( dev ) ; struct regmap * regmap = data -> regmap ; u8 reg = attr -> index ; int num_regs = is_power_reg ( reg ) ?3 : 2 ; u8 buf_min [ 3 ] { 0xff 0xff 0xff } ; ; u8 buf_max [ 3 ] { 0 0 0 } ; ; unsigned long val ; int ret ; ret = kstrtoul ( buf , 10 , & val ) ; if ( ret ) { return ret ; } ret = regmap_update_bits ( regmap , LTC2945_CONTROL , CONTROL_TEST_MODE , CONTROL_TEST_MODE ) ; ret = regmap_bulk_write ( regmap , reg , buf_min , num_regs ) ; if ( ret ) { return ret ; } switch ( reg ) { case LTC2945_MIN_POWER_H : reg = LTC2945_MAX_POWER_H ; break ; case LTC2945_MIN_SENSE_H : reg = LTC2945_MAX_SENSE_H ; break ; case LTC2945_MIN_VIN_H : reg = LTC2945_MAX_VIN_H ; break ; case LTC2945_MIN_ADIN_H : reg = LTC2945_MAX_ADIN_H ; break ; default : WARN_ONCE ( 1 , "Bad register: 0x%x\n" , reg ) ; return - EINVAL ; } ret = regmap_bulk_write ( regmap , reg , buf_max , num_regs ) ; regmap_update_bits ( regmap , LTC2945_CONTROL , CONTROL_TEST_MODE , 0 ) ; return ret ?: count ; } 