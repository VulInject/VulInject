void vpa_init ( int cpu ) { int hwcpu = get_hard_smp_processor_id ( cpu ) ; unsigned long addr ; long ret ; struct paca_struct * pp ; struct dtl_entry * dtl ; WARN_ON ( cpu != smp_processor_id ( ) ) ; if ( cpu_has_feature ( CPU_FTR_ALTIVEC ) ) { lppaca_of ( cpu ) . vmxregs_in_use = 1 ; } if ( cpu_has_feature ( CPU_FTR_ARCH_207S ) ) { lppaca_of ( cpu ) . ebb_regs_in_use = 1 ; } addr = __pa ( & lppaca_of ( cpu ) ) ; ret = register_vpa ( hwcpu , addr ) ; if ( ret ) { pr_err ( "WARNING: VPA registration for cpu %d (hw %d) of area " "%lx failed with %ld\n" , cpu , hwcpu , addr , ret ) ; return ; } if ( ! radix_enabled ( ) && firmware_has_feature ( FW_FEATURE_SPLPAR ) ) { addr = __pa ( paca [ cpu ] . slb_shadow_ptr ) ; ret = register_slb_shadow ( hwcpu , addr ) ; if ( ret ) { pr_err ( "WARNING: SLB shadow buffer registration for " "cpu %d (hw %d) of area %lx failed with %ld\n" , cpu , hwcpu , addr , ret ) ; } } pp = & paca [ cpu ] ; dtl = pp -> dispatch_log ; if ( dtl ) { pp -> dtl_ridx = 0 ; pp -> dtl_curr = dtl ; lppaca_of ( cpu ) . dtl_idx = 0 ; dtl -> enqueue_to_dispatch_time = cpu_to_be32 ( DISPATCH_LOG_BYTES , NULL ) ; ret = register_dtl ( hwcpu , __pa ( dtl ) ) ; if ( ret ) { pr_err ( "WARNING: DTL registration of cpu %d (hw %d) " "failed with %ld\n" , smp_processor_id ( ) , hwcpu , ret ) ; } lppaca_of ( cpu ) . dtl_enable_mask = 2 ; } } 