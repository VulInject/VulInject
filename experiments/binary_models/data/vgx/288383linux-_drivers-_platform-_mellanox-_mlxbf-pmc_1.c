static int mlxbf_pmc_init_perftype_counter ( struct device * dev , int blk_num ) { struct mlxbf_pmc_attribute * attr ; int i = 0 , j = 0 ; attr = & pmc -> block [ blk_num ] . attr_event_list ; attr -> dev_attr . attr . mode = 0444 ; attr -> dev_attr . show = mlxbf_pmc_event_list_show ; attr -> nr = blk_num ; attr -> dev_attr . attr . name = devm_kasprintf ( dev , GFP_KERNEL , "event_list" ) ; pmc -> block [ blk_num ] . block_attr [ i ] = & attr -> dev_attr . attr ; attr = NULL ; if ( strstr ( pmc -> block_name [ blk_num ] , "l3cache" ) ) { attr = & pmc -> block [ blk_num ] . attr_enable ; attr -> dev_attr . attr . mode = 0644 ; attr -> dev_attr . show = mlxbf_pmc_enable_show ; attr -> dev_attr . store = mlxbf_pmc_enable_store ; attr -> nr = blk_num ; attr -> dev_attr . attr . name = devm_kasprintf ( dev , GFP_KERNEL , "enable" ) ; pmc -> block [ blk_num ] . block_attr [ ++ i ] = & attr -> dev_attr . attr ; attr = NULL ; } pmc -> block [ blk_num ] . attr_counter = devm_kcalloc ( dev , pmc -> block [ blk_num ] . counters , sizeof ( mlxbf_pmc_attribute ) , GFP_KERNEL ) ; pmc -> block [ blk_num ] . attr_event = devm_kcalloc ( dev , pmc -> block [ blk_num ] . counters , sizeof ( mlxbf_pmc_attribute ) , GFP_KERNEL ) ; if ( ! pmc -> block [ blk_num ] . attr_event ) { return - ENOMEM ; } for ( j = 0 ; j < pmc -> block [ blk_num ] . counters ; ++ j ) { attr = & pmc -> block [ blk_num ] . attr_counter [ j ] ; attr -> dev_attr . attr . mode = 0644 ; attr -> dev_attr . show = mlxbf_pmc_counter_show ; attr -> dev_attr . store = mlxbf_pmc_counter_store ; attr -> index = j ; attr -> nr = blk_num ; attr -> dev_attr . attr . name = devm_kasprintf ( dev , GFP_KERNEL , "counter%d" , j ) ; pmc -> block [ blk_num ] . block_attr [ ++ i ] = & attr -> dev_attr . attr ; attr = NULL ; attr = & pmc -> block [ blk_num ] . attr_event [ j ] ; attr -> dev_attr . attr . mode = 0644 ; attr -> dev_attr . show = mlxbf_pmc_event_show ; attr -> dev_attr . store = mlxbf_pmc_event_store ; attr -> index = j ; attr -> nr = blk_num ; attr -> dev_attr . attr . name = devm_kasprintf ( dev , GFP_KERNEL , "event%d" , j ) ; pmc -> block [ blk_num ] . block_attr [ ++ i ] = & attr -> dev_attr . attr ; attr = NULL ; } return 0 ; } 