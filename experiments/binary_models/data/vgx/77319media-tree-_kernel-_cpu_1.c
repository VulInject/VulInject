static ssize_t write_cpuhp_target ( struct device * dev , struct device_attribute * attr , const char * buf , size_t count ) { struct cpuhp_cpu_state * st = per_cpu_ptr ( & cpuhp_state , dev -> id ) ; struct cpuhp_step * sp ; int target , ret ; ret = kstrtoint ( buf , 10 , & target ) ; if ( ret ) { return ret ; } if ( target != CPUHP_OFFLINE && target != CPUHP_ONLINE ) { return - EINVAL ; } ret = lock_device_hotplug_sysfs ( ) ; if ( ret ) { return ret ; } mutex_lock ( & cpuhp_state_mutex ) ; sp = cpuhp_get_step ( target ) ; ret = ! sp -> name || sp -> cant_stop ?- EINVAL : 0 ; mutex_unlock ( & cpuhp_state_mutex ) ; if ( ret ) { return ret ; } if ( st -> state < target ) { ret = do_cpu_up ( dev -> id , target ) ; } else { ret = do_cpu_down ( dev -> id , target ) ; } unlock_device_hotplug ( ) ; return ret ?ret : count ; } 