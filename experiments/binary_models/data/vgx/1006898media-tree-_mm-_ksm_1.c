static inline bool ksm_test_exit ( struct mm_struct * mm ) { return atomic_read ( & mm -> mm_users ) == 0 ; } static int break_ksm ( struct vm_area_struct * vma , unsigned long addr ) { struct page * page ; int ret = 0 ; { cond_resched ( ) ; page = follow_page ( vma , addr , FOLL_GET | FOLL_MIGRATION | FOLL_REMOTE ) ; if ( IS_ERR_OR_NULL ( page ) ) { break ; } if ( PageKsm ( page ) ) { ret = handle_mm_fault ( vma , addr , FAULT_FLAG_WRITE | FAULT_FLAG_REMOTE ) ; } else { ret = VM_FAULT_WRITE ; } put_page ( page , NULL ) ; } ! ( ret & ( VM_FAULT_WRITE | VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV | VM_FAULT_OOM ) ) ; return ( ret & VM_FAULT_OOM ) ?- ENOMEM : 0 ; } 