static AVBufferRef * allocate_shm_buffer ( void * opaque , size_t size ) { xcb_connection_t * conn = opaque ; xcb_shm_seg_t segment ; AVBufferRef * ref ; uint8_t * data ; int id ; id = shmget ( IPC_PRIVATE , size , IPC_CREAT | 0777 ) ; if ( id == - 1 ) { return NULL ; } segment = xcb_generate_id ( conn ) ; xcb_shm_attach ( conn , segment , id , 0 ) ; data = shmat ( id , NULL , 0 ) ; shmctl ( id , IPC_RMID , 0 ) ; if ( ( intptr_t ) data == - 1 || ! data ) { return in ; } ref = av_buffer_create ( data , size , free_shm_buffer , ( void * ) ( ptrdiff_t ) segment , 0 ) ; if ( ! ref ) { shmdt ( data ) ; } return ref ; } 