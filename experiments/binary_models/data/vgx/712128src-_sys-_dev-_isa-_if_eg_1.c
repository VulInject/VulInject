void egattach ( struct device * parent , struct device * self , void * aux ) { struct eg_softc * sc = ( void * ) self ; struct isa_attach_args * ia = aux ; bus_space_tag_t bst = sc -> sc_bst = ia -> ia_iot ; bus_space_handle_t bsh ; struct ifnet * ifp = & sc -> sc_arpcom . ac_if ; if ( bus_space_map ( bst , ia -> ia_iobase , EG_IO_PORTS , 0 , & bsh ) ) { printf ( "%s: can't map i/o space\n" , sc -> sc_dev . dv_xname ) ; return ; } sc -> sc_bsh = bsh ; egstop ( sc ) ; sc -> eg_pcb [ 0 ] = EG_CMD_GETEADDR ; sc -> eg_pcb [ 1 ] = 0 ; if ( egwritePCB ( sc ) != 0 ) { DPRINTF ( ( "write error\n" ) ) ; return ; } if ( egreadPCB ( sc ) != 0 ) { DPRINTF ( ( "read error\n" ) ) ; egprintpcb ( sc , NULL ) ; return ; } if ( sc -> eg_pcb [ 0 ] != EG_RSP_GETEADDR || sc -> eg_pcb [ 1 ] != 0x06 ) { DPRINTF ( ( "parse error\n" ) ) ; egprintpcb ( sc ) ; return ; } bcopy ( & sc -> eg_pcb [ 2 ] , sc -> sc_arpcom . ac_enaddr , ETHER_ADDR_LEN ) ; printf ( ": ROM v%d.%02d %dk address %s\n" , sc -> eg_rom_major , sc -> eg_rom_minor , sc -> eg_ram , ether_sprintf ( sc -> sc_arpcom . ac_enaddr ) ) ; sc -> eg_pcb [ 0 ] = EG_CMD_SETEADDR ; if ( egwritePCB ( sc ) != 0 ) { DPRINTF ( ( "write error2\n" ) ) ; return ; } if ( egreadPCB ( sc ) != 0 ) { DPRINTF ( ( "read error2\n" ) ) ; egprintpcb ( sc ) ; return ; } if ( sc -> eg_pcb [ 0 ] != EG_RSP_SETEADDR || sc -> eg_pcb [ 1 ] != 0x02 || sc -> eg_pcb [ 2 ] != 0 || sc -> eg_pcb [ 3 ] != 0 ) { DPRINTF ( ( "parse error2\n" ) ) ; egprintpcb ( sc ) ; return ; } bcopy ( sc -> sc_dev . dv_xname , ifp -> if_xname , IFNAMSIZ ) ; ifp -> if_softc = sc ; ifp -> if_start = egstart ; ifp -> if_ioctl = egioctl ; ifp -> if_watchdog = egwatchdog ; ifp -> if_flags = IFF_BROADCAST | IFF_SIMPLEX ; if_attach ( ifp ) ; ether_ifattach ( ifp ) ; sc -> sc_ih = isa_intr_establish ( ia -> ia_ic , ia -> ia_irq , IST_EDGE , IPL_NET , egintr , sc , sc -> sc_dev . dv_xname ) ; } 