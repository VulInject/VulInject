k5_sha512_final ( , ) { unsigned char zeros [ 128 + 16 ] ; unsigned offset = ( m -> sz [ 0 ] / 8 ) % 128 ; unsigned int dstart = ( 240 - offset - 1 ) % 128 + 1 ; * zeros = 0x80 ; zeros [ dstart + 15 ] = ( m -> sz [ 0 ] >> 0 ) & 0xff ; zeros [ dstart + 14 ] = ( m -> sz [ 0 ] >> 8 ) & 0xff ; zeros [ dstart + 13 ] = ( m -> sz [ 0 ] >> 16 ) & 0xff ; zeros [ dstart + 12 ] = ( m -> sz [ 0 ] >> 24 ) & 0xff ; zeros [ dstart + 11 ] = ( m -> sz [ 0 ] >> 32 ) & 0xff ; zeros [ dstart + 10 ] = ( m -> sz [ 0 ] >> 40 ) & 0xff ; zeros [ dstart + 9 ] = ( m -> sz [ 0 ] >> 48 ) & 0xff ; zeros [ dstart + 8 ] = ( m -> sz [ 0 ] >> 56 ) & 0xff ; zeros [ dstart + 7 ] = ( m -> sz [ 1 ] >> 0 ) & 0xff ; zeros [ dstart + 6 ] = ( m -> sz [ 1 ] >> 8 ) & 0xff ; zeros [ dstart + 5 ] = ( m -> sz [ 1 ] >> 16 ) & 0xff ; zeros [ dstart + 4 ] = ( m -> sz [ 1 ] >> 24 ) & 0xff ; zeros [ dstart + 3 ] = ( m -> sz [ 1 ] >> 32 ) & 0xff ; zeros [ dstart + 2 ] = ( m -> sz [ 1 ] >> 40 ) & 0xff ; zeros [ dstart + 1 ] = ( m -> sz [ 1 ] >> 48 ) & 0xff ; zeros [ dstart + 0 ] = ( m -> sz [ 1 ] >> 56 ) & 0xff ; k5_sha512_update ( m , zeros , dstart + 16 ) ; { int i ; unsigned char * r = ( unsigned char * ) res ; for ( i = 0 ; i < 8 ; ++ i ) { r [ 8 * i + 7 ] = m -> counter [ i ] & 0xFF ; r [ 8 * i + 6 ] = ( m -> counter [ i ] >> 8 ) & 0xFF ; r [ 8 * i + 5 ] = ( m -> counter [ i ] >> 16 ) & 0xFF ; r [ 8 * i + 4 ] = ( m -> counter [ i ] >> 24 ) & 0xFF ; r [ 8 * i + 3 ] = ( m -> counter [ i ] >> 32 ) & 0XFF ; r [ 8 * i + 2 ] = ( m -> counter [ i ] >> 40 ) & 0xFF ; r [ 8 * i + 1 ] = ( m -> counter [ i ] >> 48 ) & 0xFF ; r [ 8 * i ] = ( m -> counter [ i ] >> 56 ) & 0xFF ; } } } 