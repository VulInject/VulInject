signed_error_t circpad_negotiate_padding ( origin_circuit_t * circ , circpad_machine_num_t machine , uint8_t target_hopnum , uint8_t command , uint32_t machine_ctr ) { circpad_negotiate_t type ; cell_t cell ; ssize_t len ; if ( ! circpad_circuit_supports_padding ( circ , target_hopnum ) ) { return - 1 ; } memset ( & type , 0 , sizeof ( circpad_negotiate_t ) ) ; cell . command = CELL_RELAY ; circpad_negotiate_set_command ( & type , command ) ; circpad_negotiate_set_version ( & type , 0 ) ; circpad_negotiate_set_machine_type ( & type , machine ) ; circpad_negotiate_set_machine_ctr ( & type , machine_ctr ) ; if ( ( len = circpad_negotiate_encode ( cell . payload , CELL_PAYLOAD_SIZE , & type ) ) < 0 ) { return - 1 ; } log_fn ( LOG_INFO , LD_CIRC , "Negotiating padding on circuit %u (%d), command %d, for ctr %u" , circ -> global_identifier , TO_CIRCUIT ( circ ) -> purpose , command , machine_ctr ) ; return circpad_send_command_to_hop ( circ , target_hopnum , RELAY_COMMAND_PADDING_NEGOTIATE , cell . payload , len ) ; } 