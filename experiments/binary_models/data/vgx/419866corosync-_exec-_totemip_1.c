int totemip_getifaddrs ( struct qb_list_head * addrs ) { struct ifaddrs * ifap , * ifa ; struct totem_ip_if_address * if_addr ; if ( getifaddrs ( & ifap ) != 0 ) { return ( - 1 ) ; } qb_list_init ( addrs ) ; for ( ifa = ifap ; ifa ; ifa = ifa -> ifa_next ) { if ( ifa -> ifa_addr == NULL || ifa -> ifa_netmask == NULL ) { continue ; } if ( ( ifa -> ifa_addr -> sa_family != AF_INET && ifa -> ifa_addr -> sa_family != AF_INET6 ) || ( ifa -> ifa_netmask -> sa_family != AF_INET && ifa -> ifa_netmask -> sa_family != AF_INET6 && ifa -> ifa_netmask -> sa_family != 0 ) ) { continue ; } if ( ifa -> ifa_netmask -> sa_family == 0 ) { ifa -> ifa_netmask -> sa_family = ifa -> ifa_addr -> sa_family ; } if_addr = malloc ( sizeof ( totem_ip_if_address ) ) ; if ( if_addr == NULL ) { error_free_ifaddrs } qb_list_init ( & if_addr -> list ) ; memset ( if_addr , 0 , sizeof ( totem_ip_if_address ) ) ; if_addr -> interface_up = ifa -> ifa_flags & IFF_UP ; if_addr -> interface_num = if_nametoindex ( ifa -> ifa_name ) ; if_addr -> name = strdup ( ifa -> ifa_name ) ; if ( if_addr -> name == NULL ) { error_free_addr } if ( totemip_sockaddr_to_totemip_convert ( ( const sockaddr_storage * ) ifa -> ifa_addr , & if_addr -> ip_addr ) == - 1 ) { error_free_addr_name } if ( totemip_sockaddr_to_totemip_convert ( ( const sockaddr_storage * ) ifa -> ifa_netmask , & if_addr -> mask_addr ) == - 1 ) { error_free_addr_name } qb_list_add_tail ( & if_addr -> list , addrs ) ; } freeifaddrs ( ifap ) ; return ( 0 ) ; error_free_addr_name error_free_addr free ( if_addr ) ; error_free_ifaddrs totemip_freeifaddrs ( addrs ) ; freeifaddrs ( ifap ) ; return ( - 1 ) ; } 