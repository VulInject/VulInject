_iso9660_dir_to_statbuf ( , , , , ) { uint8_t dir_len = iso9660_get_dir_len ( p_iso9660_dir ) ; iso711_t i_fname ; unsigned int stat_len ; iso9660_stat_t * p_stat = last_p_stat ; char rr_fname [ 256 ] "" ; ; int i_rr_fname = 0 ; lsn_t extent_lsn ; bool first_extent ; if ( ! dir_len ) { return NULL ; } i_fname = from_711 ( p_iso9660_dir -> filename . len ) ; stat_len = sizeof ( iso9660_stat_t ) + i_fname + 2 ; if ( ! p_stat ) { p_stat = calloc ( 1 , stat_len ) ; first_extent = true ; } else { if ( p_stat -> rr . u_su_fields & ISO_ROCK_SUF_RE ) { fail } first_extent = false ; } if ( ! p_stat ) { cdio_warn ( "Couldn't calloc(1, %d)" , stat_len ) ; return NULL ; } p_stat -> type = ( p_iso9660_dir -> file_flags & ISO_DIRECTORY ) ?_STAT_DIR : _STAT_FILE ; extent_lsn = from_733 ( p_iso9660_dir -> extent ) ; if ( p_stat -> total_size > 0 ) { if ( p_stat -> lsn + p_stat -> total_size / ISO_BLOCKSIZE != extent_lsn || p_stat -> total_size % ISO_BLOCKSIZE ) { cdio_warn ( "Non-contiguous data extents with '%s'" , p_stat -> filename ) ; fail } } if ( first_extent ) { p_stat -> lsn = extent_lsn ; } p_stat -> total_size += from_733 ( p_iso9660_dir -> size ) ; if ( _iso9660_is_rock_ridge_enabled ( p_image ) ) { p_stat -> rr . b3_rock = dunno ; } p_stat -> b_xa = false ; if ( first_extent ) { p_stat -> size = from_733 ( p_iso9660_dir -> size ) ; p_stat -> secsize = CDIO_EXTENT_BLOCKS ( p_stat -> size ) ; } if ( ( p_iso9660_dir -> file_flags & ISO_MULTIEXTENT ) == 0 ) { if ( ! first_extent ) { cdio_utf8_t * p_psz_out = NULL ; int bad_multi ; int i_inlen = i_fname ; if ( ! _iso9660_recname_to_cstring ( & p_iso9660_dir -> filename . str [ 1 ] , i_inlen , & p_psz_out , NULL , u_joliet_level ) ) { fail } bad_multi = ( strcmp ( p_stat -> filename , p_psz_out ) != 0 ) ; if ( bad_multi ) { cdio_warn ( "Non consecutive multiextent file parts for '%s'" , p_stat -> filename ) ; fail } } i_rr_fname = get_rock_ridge_filename ( p_iso9660_dir , p_image , rr_fname , p_stat ) ; if ( i_rr_fname > 0 ) { if ( i_rr_fname > i_fname ) { iso9660_stat_t * p_stat_new = calloc ( 1 , sizeof ( iso9660_stat_t ) + i_rr_fname + 2 ) ; if ( ! p_stat_new ) { cdio_warn ( "Couldn't calloc(1, %d)" , ( int ) ( sizeof ( iso9660_stat_t ) + i_rr_fname + 2 ) ) ; fail } memcpy ( p_stat_new , p_stat , stat_len ) ; free ( p_stat ) ; p_stat = p_stat_new ; } strncpy ( p_stat -> filename , rr_fname , i_rr_fname + 1 ) ; } else { if ( '\0' == p_iso9660_dir -> filename . str [ 1 ] && 1 == i_fname ) { strncpy ( p_stat -> filename , "." , strlen ( "." ) + 1 ) ; } if ( '\1' == p_iso9660_dir -> filename . str [ 1 ] && 1 == i_fname ) { strncpy ( p_stat -> filename , ".." , strlen ( ".." ) + 1 ) ; } else { int i_inlen = i_fname ; if ( ! _iso9660_recname_to_cstring ( & p_iso9660_dir -> filename . str [ 1 ] , i_inlen , NULL , p_stat -> filename , u_joliet_level ) ) { fail } } } } else { int i_inlen = i_fname ; if ( ! _iso9660_recname_to_cstring ( & p_iso9660_dir -> filename . str [ 1 ] , i_inlen , NULL , p_stat -> filename , u_joliet_level ) ) { fail } } iso9660_get_dtime ( & ( p_iso9660_dir -> recording_time ) , true , & ( p_stat -> tm ) ) ; if ( dir_len < sizeof ( iso9660_dir_t ) ) { iso9660_stat_free ( p_stat ) ; return NULL ; } { int su_length = iso9660_get_dir_len ( p_iso9660_dir ) - sizeof ( iso9660_dir_t ) ; su_length -= i_fname ; if ( su_length % 2 ) { su_length -- ; } if ( su_length < sizeof ( iso9660_xa_t ) ) { return p_stat ; } if ( nope == b_xa ) { return p_stat ; } else { iso9660_xa_t * xa_data = ( void * ) ( ( ( char * ) p_iso9660_dir ) + ( iso9660_get_dir_len ( p_iso9660_dir ) - su_length ) ) ; cdio_log_level_t loglevel = ( yep == b_xa ) ?CDIO_LOG_WARN : CDIO_LOG_INFO ; if ( xa_data -> signature [ 0 ] != 'X' || xa_data -> signature [ 1 ] != 'A' ) { cdio_log ( loglevel , "XA signature not found in ISO9660's system use area;" " ignoring XA attributes for this file entry." ) ; cdio_debug ( "%d %d %d, '%c%c' (%d, %d)" , iso9660_get_dir_len ( p_iso9660_dir ) , i_fname , su_length , xa_data -> signature [ 0 ] , xa_data -> signature [ 1 ] , xa_data -> signature [ 0 ] , xa_data -> signature [ 1 ] ) ; return p_stat ; } p_stat -> b_xa = true ; p_stat -> xa = * xa_data ; } } return p_stat ; fail iso9660_stat_free ( p_stat ) ; return NULL ; } 