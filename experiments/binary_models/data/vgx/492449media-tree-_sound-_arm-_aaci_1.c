static int aaci_pcm_hw_params ( struct snd_pcm_substream * substream , struct snd_pcm_hw_params * params ) { struct aaci_runtime * aacirun = substream -> runtime -> private_data ; unsigned int channels = params_channels ( params ) ; unsigned int rate = params_rate ( params ) ; int dbl = rate > 48000 ; int err ; aaci_pcm_hw_free ( substream ) ; if ( aacirun -> pcm_open ) { snd_ac97_pcm_close ( aacirun -> pcm ) ; aacirun -> pcm_open = 0 ; } err = snd_pcm_lib_malloc_pages ( substream , params_buffer_bytes ( params ) ) ; if ( err >= 0 ) { struct aaci * aaci = substream -> private_data ; err = snd_ac97_pcm_open ( aacirun -> pcm , rate , channels , aacirun -> pcm -> r [ dbl ] . slots ) ; aacirun -> pcm_open = err == 0 ; aacirun -> cr = CR_FEN | CR_COMPACT | CR_SZ16 ; aacirun -> cr |= channels_to_slotmask [ channels + dbl * 2 ] ; aacirun -> fifo_bytes = aaci -> fifo_depth * 4 / 2 ; } return err ; } 