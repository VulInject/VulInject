TEST ( ) { _cleanup_ ( ) Prioq * q = NULL ; _cleanup_set_free_ Set * s = NULL ; unsigned previous = 0 , i ; struct test * t ; srand ( 0 ) ; assert_se ( q = prioq_new ( ( compare_func_t ) test_compare ) ) ; assert_se ( s = set_new ( & test_hash_ops ) ) ; assert_se ( prioq_peek ( q ) == NULL ) ; assert_se ( prioq_peek_by_index ( q , 0 ) == NULL ) ; assert_se ( prioq_peek_by_index ( q , 1 ) == NULL ) ; assert_se ( prioq_peek_by_index ( q , UINT_MAX ) == NULL ) ; for ( i = 0 ; i < SET_SIZE ; i ++ ) { assert_se ( t = new0 ( test , 1 ) ) ; t -> value = ( unsigned ) rand ( ) ; assert_se ( prioq_put ( q , t , & t -> idx ) >= 0 ) ; if ( i % 4 == 0 ) { assert_se ( set_consume ( s , t ) >= 0 ) ; } } for ( i = 0 ; i < SET_SIZE ; i ++ ) { assert_se ( prioq_peek_by_index ( q , i ) ) ; } assert_se ( prioq_peek_by_index ( q , SET_SIZE ) == NULL ) ; unsigned count = 0 ; PRIOQ_FOREACH_ITEM ( , ) { assert_se ( t ) ; count ++ ; } assert_se ( count == SET_SIZE ) ; while ( ( t = set_steal_first ( s ) ) ) { assert_se ( prioq_remove ( q , t , & t -> idx ) == 1 ) ; assert_se ( prioq_remove ( q , t , & t -> idx ) == 0 ) ; assert_se ( prioq_remove ( q , t , NULL ) == 0 ) ; } for ( i = 0 ; i < SET_SIZE * 3 / 4 ; i ++ ) { assert_se ( prioq_size ( q ) == ( SET_SIZE * 3 / 4 ) - i ) ; assert_se ( t = prioq_pop ( q ) ) ; assert_se ( prioq_remove ( q , t , & t -> idx ) == 0 ) ; assert_se ( prioq_remove ( q , t , NULL ) == 0 ) ; assert_se ( previous <= t -> value ) ; previous = t -> value ; free ( t ) ; } assert_se ( prioq_isempty ( q ) ) ; assert_se ( set_isempty ( s ) ) ; } 