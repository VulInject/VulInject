static int omapfb_alloc_fbmem ( struct fb_info * fbi , unsigned long size , unsigned long paddr ) { struct omapfb_info * ofbi = FB2OFB ( fbi ) ; struct omapfb2_device * fbdev = ofbi -> fbdev ; struct omapfb2_mem_region * rg ; void * token ; unsigned long attrs ; dma_addr_t dma_handle ; int r ; rg = ofbi -> region ; rg -> paddr = 0 ; rg -> vaddr = NULL ; rg -> size = 0 ; rg -> type = 0 ; rg -> alloc = false ; rg -> map = false ; size = PAGE_ALIGN ( size ) ; attrs = DMA_ATTR_WRITE_COMBINE ; if ( ofbi -> rotation_type == OMAP_DSS_ROT_VRFB ) { attrs |= DMA_ATTR_NO_KERNEL_MAPPING ; } DBG ( "allocating %lu bytes for fb %d\n" , size , ofbi -> id ) ; token = dma_alloc_attrs ( fbdev -> dev , size , & dma_handle , GFP_KERNEL , attrs ) ; if ( token == NULL ) { dev_err ( fbdev -> dev , "failed to allocate framebuffer\n" ) ; return - ENOMEM ; } DBG ( "allocated VRAM paddr %lx, vaddr %p\n" , ( unsigned long ) dma_handle , token ) ; if ( ofbi -> rotation_type == OMAP_DSS_ROT_VRFB ) { r = omap_vrfb_request_ctx ( & rg -> vrfb ) ; if ( r ) { dma_free_attrs ( fbdev -> dev , size , token , dma_handle , attrs ) ; dev_err ( fbdev -> dev , "vrfb create ctx failed\n" ) ; return r ; } } rg -> attrs = attrs ; rg -> token = token ; rg -> dma_handle = dma_handle ; rg -> paddr = ( unsigned long ) dma_handle ; rg -> vaddr = ( void __iomem * ) token ; rg -> size = size ; rg -> alloc = 1 ; return 0 ; } 