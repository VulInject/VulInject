static int prepare_uprobe ( struct uprobe * uprobe , struct file * file , struct mm_struct * mm , unsigned long vaddr ) { int ret = 0 ; if ( test_bit ( UPROBE_COPY_INSN , & uprobe -> flags ) ) { return ret ; } down_write ( & uprobe -> consumer_rwsem ) ; if ( test_bit ( UPROBE_COPY_INSN , & uprobe -> flags ) ) { out } ret = copy_insn ( uprobe , file ) ; if ( ret ) { out } ret = - ENOTSUPP ; ret = arch_uprobe_analyze_insn ( & uprobe -> arch , mm , vaddr ) ; if ( ret ) { out } BUG_ON ( ( uprobe -> offset & ~ PAGE_MASK ) + UPROBE_SWBP_INSN_SIZE > PAGE_SIZE ) ; smp_wmb ( ) ; set_bit ( UPROBE_COPY_INSN , & uprobe -> flags ) ; out up_write ( & uprobe -> consumer_rwsem ) ; return ret ; } 