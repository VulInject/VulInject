static int pvscsi_queue_ring ( struct pvscsi_adapter * adapter , struct pvscsi_ctx * ctx , struct scsi_cmnd * cmd ) { struct PVSCSIRingsState * s ; struct PVSCSIRingReqDesc * e ; struct scsi_device * sdev ; u32 req_entries ; s = adapter -> rings_state ; sdev = cmd -> device ; req_entries = s -> reqNumEntriesLog2 ; if ( s -> reqProdIdx - s -> cmpConsIdx >= 1 << req_entries ) { scmd_printk ( KERN_ERR , cmd , "vmw_pvscsi: " "ring full: reqProdIdx=%d cmpConsIdx=%d\n" , s -> reqProdIdx , s -> cmpConsIdx ) ; return - 1 ; } e = adapter -> req_ring + ( s -> reqProdIdx & MASK ( req_entries ) ) ; e -> bus = sdev -> channel ; e -> target = sdev -> id ; e -> lun [ 1 ] = sdev -> lun ; if ( cmd -> sense_buffer ) { ctx -> sensePA = pci_map_single ( adapter -> dev , cmd -> sense_buffer , SCSI_SENSE_BUFFERSIZE , PCI_DMA_FROMDEVICE ) ; if ( pci_dma_mapping_error ( adapter -> dev , ctx -> sensePA ) ) { scmd_printk ( KERN_ERR , cmd , "vmw_pvscsi: Failed to map sense buffer for DMA.\n" ) ; ctx -> sensePA = 0 ; return - ENOMEM ; } e -> senseAddr = ctx -> sensePA ; e -> senseLen = SCSI_SENSE_BUFFERSIZE ; } else { e -> senseLen = 0 ; e -> senseAddr = 0 ; } e -> cdbLen = cmd -> cmd_len ; e -> vcpuHint = smp_processor_id ( ) ; memcpy ( e -> cdb , cmd -> cmnd , e -> cdbLen ) ; e -> tag = SIMPLE_QUEUE_TAG ; if ( cmd -> sc_data_direction == DMA_FROM_DEVICE ) { e -> flags = PVSCSI_FLAG_CMD_DIR_TOHOST ; } if ( cmd -> sc_data_direction == DMA_TO_DEVICE ) { e -> flags = PVSCSI_FLAG_CMD_DIR_TODEVICE ; } if ( cmd -> sc_data_direction == DMA_NONE ) { e -> flags = PVSCSI_FLAG_CMD_DIR_NONE ; } else { e -> flags = 0 ; } if ( pvscsi_map_buffers ( adapter , ctx , cmd , e ) != 0 ) { if ( cmd -> sense_buffer ) { pci_unmap_single ( adapter -> dev , ctx -> sensePA , SCSI_SENSE_BUFFERSIZE , PCI_DMA_FROMDEVICE ) ; ctx -> sensePA = 0 ; } return - ENOMEM ; } e -> context = pvscsi_map_context ( adapter , ctx ) ; barrier ( ) ; s -> reqProdIdx ++ ; return 0 ; } 