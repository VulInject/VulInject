static int tmp51x_probe ( struct i2c_client * client ) { struct device * dev = & client -> dev ; struct tmp51x_data * data ; struct device * hwmon_dev ; int ret ; data = devm_kzalloc ( dev , sizeof ( * data ) , GFP_KERNEL ) ; if ( client -> dev . of_node ) { data -> id = ( tmp51x_ids ) device_get_match_data ( & client -> dev ) ; } else { data -> id = i2c_match_id ( tmp51x_id , client ) -> driver_data ; } ret = tmp51x_configure ( dev , data ) ; if ( ret < 0 ) { dev_err ( dev , "error configuring the device: %d\n" , ret ) ; return ret ; } data -> regmap = devm_regmap_init_i2c ( client , & tmp51x_regmap_config ) ; if ( IS_ERR ( data -> regmap ) ) { dev_err ( dev , "failed to allocate register map\n" ) ; return PTR_ERR ( data -> regmap ) ; } ret = tmp51x_init ( data ) ; if ( ret < 0 ) { dev_err ( dev , "error configuring the device: %d\n" , ret ) ; return - ENODEV ; } hwmon_dev = devm_hwmon_device_register_with_info ( dev , client -> name , data , & tmp51x_chip_info , NULL ) ; if ( IS_ERR ( hwmon_dev ) ) { return PTR_ERR ( hwmon_dev ) ; } dev_dbg ( dev , "power monitor %s\n" , client -> name ) ; return 0 ; } 