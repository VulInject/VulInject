static void find_and_link_peer ( struct usb_hub * hub , int port1 ) { struct usb_port * port_dev = hub -> ports [ port1 - 1 ] , * peer ; struct usb_device * hdev = hub -> hdev ; struct usb_device * peer_hdev ; struct usb_hub * peer_hub ; if ( port_dev -> location ) { usb_for_each_dev ( port_dev , match_location ) ; return ; } if ( ! hdev -> parent ) { struct usb_hcd * hcd = bus_to_hcd ( hdev -> bus ) ; struct usb_hcd * peer_hcd = hcd -> shared_hcd ; if ( ! peer_hcd ) { return ; } peer_hdev = peer_hcd -> self . root_hub ; } else { struct usb_port * upstream ; struct usb_device * parent = hdev -> parent ; struct usb_hub * parent_hub = usb_hub_to_struct_hub ( parent ) ; if ( ! parent_hub ) { return ; } upstream = parent_hub -> ports [ hdev -> portnum - 1 ] ; if ( ! upstream || ! upstream -> peer ) { return ; } peer_hdev = upstream -> peer -> child ; } peer_hub = usb_hub_to_struct_hub ( peer_hdev , NULL ) ; if ( ! peer_hub || port1 > peer_hdev -> maxchild ) { return ; } peer = peer_hub -> ports [ port1 - 1 ] ; if ( peer && peer -> location == 0 ) { link_peers_report ( port_dev , peer ) ; } } 