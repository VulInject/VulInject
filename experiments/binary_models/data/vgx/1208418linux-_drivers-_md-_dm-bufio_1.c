static void __scan ( struct dm_bufio_client * c ) { int l ; struct dm_buffer * b , * tmp ; cfs_time_t freed = 0 ; unsigned long count = c -> n_buffers [ LIST_CLEAN ] + c -> n_buffers [ LIST_DIRTY ] ; unsigned long retain_target = get_retain_buffers ( c ) ; for ( l = 0 ; l < LIST_SIZE ; l ++ ) { list_for_each_entry_safe_reverse ( , , , ) { if ( count - freed <= retain_target ) { atomic_long_set ( & c -> need_shrink , 0 ) ; } if ( ! atomic_long_read ( & c -> need_shrink ) ) { return ; } if ( __try_evict_buffer ( b , GFP_KERNEL ) ) { atomic_long_dec ( & c -> need_shrink ) ; freed ++ ; } cond_resched ( ) ; } } } 