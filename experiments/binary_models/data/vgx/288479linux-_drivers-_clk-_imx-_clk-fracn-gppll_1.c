static int clk_fracn_gppll_set_rate ( struct clk_hw * hw , unsigned long drate , unsigned long prate ) { struct clk_fracn_gppll * pll = to_clk_fracn_gppll ( hw ) ; const struct imx_fracn_gppll_rate_table * rate ; u32 tmp , pll_div , ana_mfn ; int ret ; rate = imx_get_pll_settings ( pll , drate ) ; tmp = readl_relaxed ( pll -> base + PLL_CTRL ) ; tmp &= ~ CLKMUX_EN ; writel_relaxed ( tmp , pll -> base + PLL_CTRL ) ; tmp &= ~ POWERUP_MASK ; writel_relaxed ( tmp , pll -> base + PLL_CTRL ) ; tmp &= ~ CLKMUX_BYPASS ; writel_relaxed ( tmp , pll -> base + PLL_CTRL ) ; pll_div = FIELD_PREP ( PLL_RDIV_MASK , rate -> rdiv ) | rate -> odiv | FIELD_PREP ( PLL_MFI_MASK , rate -> mfi ) ; writel_relaxed ( pll_div , pll -> base + PLL_DIV ) ; writel_relaxed ( rate -> mfd , pll -> base + PLL_DENOMINATOR ) ; writel_relaxed ( FIELD_PREP ( PLL_MFN_MASK , rate -> mfn ) , pll -> base + PLL_NUMERATOR ) ; udelay ( 5 ) ; tmp |= POWERUP_MASK ; writel_relaxed ( tmp , pll -> base + PLL_CTRL ) ; ret = clk_fracn_gppll_wait_lock ( pll ) ; tmp |= CLKMUX_EN ; writel_relaxed ( tmp , pll -> base + PLL_CTRL ) ; ana_mfn = readl_relaxed ( pll -> base + PLL_STATUS ) ; ana_mfn = FIELD_GET ( PLL_MFN_MASK , ana_mfn ) ; WARN ( ana_mfn != rate -> mfn , "ana_mfn != rate->mfn\n" ) ; return 0 ; } 