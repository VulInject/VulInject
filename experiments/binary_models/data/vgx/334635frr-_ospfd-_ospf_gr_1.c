void ospf_gr_nvm_read ( struct ospf * ospf ) { char * filepath ; const char * inst_name ; json_object * json ; json_object * json_instances ; json_object * json_instance ; json_object * json_timestamp ; time_t timestamp = 0 ; filepath = ospf_gr_nvm_filepath ( ospf ) ; inst_name = ospf_get_name ( ospf ) ; json = json_object_from_file ( filepath ) ; if ( json == NULL ) { json = json_object_new_object ( ) ; } json_object_object_get_ex ( json , "instances" , & json_instances ) ; if ( ! json_instances ) { json_instances = json_object_new_object ( ) ; json_object_object_add ( json , "instances" , json_instances ) ; } json_object_object_get_ex ( json_instances , inst_name , & json_instance ) ; if ( ! json_instance ) { json_instance = json_object_new_object ( ) ; json_object_object_add ( json_instances , inst_name , json_instance ) ; } json_object_object_get_ex ( json_instance , "timestamp" , & json_timestamp ) ; if ( json_timestamp ) { time_t now ; unsigned long remaining_time ; now = time ( NULL ) ; timestamp = json_object_get_int ( json_timestamp ) ; if ( now > timestamp ) { ospf_gr_restart_exit ( ospf , "grace period has expired already" ) ; } else { ospf -> gr_info . restart_in_progress = true ; remaining_time = timestamp - time ( NULL ) ; if ( IS_DEBUG_OSPF_GR ) { zlog_debug ( "GR: remaining time until grace period expires: %lu(s)" , remaining_time ) ; } thread_add_timer ( master , ospf_gr_grace_period_expired , ospf , remaining_time , & ospf -> gr_info . t_grace_period ) ; } } json_object_object_del ( json_instances , inst_name ) ; json_object_to_file_ext ( filepath , json , JSON_C_TO_STRING_PRETTY ) ; } 