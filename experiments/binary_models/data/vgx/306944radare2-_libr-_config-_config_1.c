R_API RConfigNode * r_config_set ( RConfig * cfg , const char * name , const char * value ) { char * ov = NULL ; ut64 oi ; r_return_val_if_fail ( cfg && cfg -> ht , NULL ) ; r_return_val_if_fail ( ! IS_NULLSTR ( name ) , NULL ) ; RConfigNode * node = r_config_node_get ( cfg , name ) ; if ( node ) { if ( r_config_node_is_ro ( node ) ) { R_LOG_ERROR ( "Key '%s' is readonly" , name ) ; return node ; } oi = node -> i_value ; if ( node -> value ) { ov = strdup ( node -> value ) ; if ( ! ov ) { return node ; } } else { node -> value = strdup ( "" ) ; } R_DIRTY ( cfg ) ; if ( r_config_node_is_bool ( node ) ) { bool b = r_str_is_true ( value ) ; node -> i_value = b ; char * value = strdup ( r_str_bool ( b ) ) ; if ( value ) { node -> value = value ; } } else { if ( ! value ) { free ( node -> value ) ; node -> value = strdup ( "" ) ; node -> i_value = 0 ; } else { if ( node -> value == value ) { beach } free ( node -> value ) ; node -> value = strdup ( value ) ; if ( IS_DIGIT ( * value ) || ( value [ 0 ] == '-' && IS_DIGIT ( value [ 1 ] ) ) ) { if ( strchr ( value , '/' ) ) { node -> i_value = r_num_get ( cfg -> num , value ) ; } else { node -> i_value = r_num_math ( cfg -> num , value ) ; } } else { node -> i_value = 0 ; } node -> flags |= CN_INT ; } } } else { oi = UT64_MAX ; if ( ! cfg -> lock ) { node = r_config_node_new ( name , value ) ; if ( R_LIKELY ( node ) ) { if ( is_true_or_false ( value ) ) { node -> flags |= CN_BOOL ; node -> i_value = r_str_is_true ( value ) ?1 : 0 ; } ht_pp_insert ( cfg -> ht , node -> name , node ) ; r_list_append ( cfg -> nodes , node ) ; } else { R_LOG_ERROR ( "unable to create a new RConfigNode" ) ; } } else { R_LOG_ERROR ( "variable '%s' not found" , name ) ; } } if ( node && node -> setter ) { if ( ! node -> setter ( cfg -> user , node ) ) { if ( oi != UT64_MAX ) { node -> i_value = oi ; } free ( node -> value ) ; node -> value = strdup ( r_str_get ( ov ) ) ; if ( ov ) { free ( ov ) ; } return NULL ; } } beach free ( ov ) ; return node ; } 