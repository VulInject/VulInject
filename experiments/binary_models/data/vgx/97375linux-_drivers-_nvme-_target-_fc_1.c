static void nvmet_fc_ls_create_association ( struct nvmet_fc_tgtport * tgtport , struct nvmet_fc_ls_iod * iod ) { struct fcnvme_ls_cr_assoc_rqst * rqst = & iod -> rqstbuf -> rq_cr_assoc ; struct fcnvme_ls_cr_assoc_acc * acc = & iod -> rspbuf -> rsp_cr_assoc ; struct nvmet_fc_tgt_queue * queue ; int ret = 0 ; memset ( acc , 0 , sizeof ( * acc ) ) ; if ( iod -> rqstdatalen < FCNVME_LSDESC_CRA_RQST_MINLEN ) { ret = VERR_CR_ASSOC_LEN ; } if ( be32_to_cpu ( rqst -> desc_list_len ) < FCNVME_LSDESC_CRA_RQST_MIN_LISTLEN ) { ret = VERR_CR_ASSOC_RQST_LEN ; } if ( rqst -> assoc_cmd . desc_tag != cpu_to_be32 ( FCNVME_LSDESC_CREATE_ASSOC_CMD ) ) { ret = VERR_CR_ASSOC_CMD ; } if ( be32_to_cpu ( rqst -> assoc_cmd . desc_len ) < FCNVME_LSDESC_CRA_CMD_DESC_MIN_DESCLEN ) { ret = VERR_CR_ASSOC_CMD_LEN ; } if ( ! rqst -> assoc_cmd . ersp_ratio || ( be16_to_cpu ( rqst -> assoc_cmd . ersp_ratio ) >= be16_to_cpu ( rqst -> assoc_cmd . sqsize ) ) ) { ret = VERR_ERSP_RATIO ; } else { iod -> assoc = nvmet_fc_alloc_target_assoc ( tgtport , iod -> hosthandle ) ; if ( ! iod -> assoc ) { ret = VERR_ASSOC_ALLOC_FAIL ; } else { queue = nvmet_fc_alloc_target_queue ( iod -> assoc , 0 , be16_to_cpu ( rqst -> assoc_cmd . sqsize ) ) ; if ( ! queue ) { ret = VERR_QUEUE_ALLOC_FAIL ; nvmet_fc_tgt_a_put ( iod -> assoc ) ; } } } if ( ret ) { dev_err ( tgtport -> dev , "Create Association LS failed: %s\n" , validation_errors [ ret ] ) ; iod -> lsrsp -> rsplen = nvme_fc_format_rjt ( acc , sizeof ( * acc ) , rqst -> w0 . ls_cmd , FCNVME_RJT_RC_LOGIC , FCNVME_RJT_EXP_NONE , 0 ) ; return ; } queue -> ersp_ratio = be16_to_cpu ( rqst -> assoc_cmd . ersp_ratio ) ; atomic_set ( & queue -> connected , 1 ) ; queue -> sqhd = 0 ; dev_info ( tgtport -> dev , "{%d:%d} Association created\n" , tgtport -> fc_target_port . port_num , iod -> assoc -> a_id ) ; iod -> lsrsp -> rsplen = sizeof ( * acc ) ; nvme_fc_format_rsp_hdr ( acc , FCNVME_LS_ACC , fcnvme_lsdesc_len ( sizeof ( fcnvme_ls_cr_assoc_acc ) ) , FCNVME_LS_CREATE_ASSOCIATION ) ; acc -> associd . desc_tag = cpu_to_be32 ( FCNVME_LSDESC_ASSOC_ID , NULL ) ; acc -> associd . desc_len = fcnvme_lsdesc_len ( sizeof ( fcnvme_lsdesc_assoc_id ) ) ; acc -> associd . association_id = cpu_to_be64 ( nvmet_fc_makeconnid ( iod -> assoc , 0 ) ) ; acc -> connectid . desc_tag = cpu_to_be32 ( FCNVME_LSDESC_CONN_ID ) ; acc -> connectid . desc_len = fcnvme_lsdesc_len ( sizeof ( fcnvme_lsdesc_conn_id ) ) ; acc -> connectid . connection_id = acc -> associd . association_id ; } 