static int ixgbe_alloc_tbd_ring ( ixgbe_tx_ring_t * tx_ring ) { int ret ; size_t size ; size_t len ; uint_t cookie_num ; dev_info_t * devinfo ; ddi_dma_cookie_t cookie ; ixgbe_t * ixgbe = tx_ring -> ixgbe ; devinfo = ixgbe -> dip ; size = sizeof ( ixgbe_adv_tx_desc ) * tx_ring -> ring_size ; if ( ixgbe -> tx_head_wb_enable ) { size += sizeof ( ixgbe_adv_tx_desc ) ; } ret = ddi_dma_alloc_handle ( devinfo , & ixgbe_desc_dma_attr , DDI_DMA_DONTWAIT , NULL , & tx_ring -> tbd_area . dma_handle ) ; if ( ret != DDI_SUCCESS ) { ixgbe_error ( ixgbe , "Could not allocate tbd dma handle: %x" , ret ) ; return ( IXGBE_FAILURE ) ; } ret = ddi_dma_mem_alloc ( tx_ring -> tbd_area . dma_handle , size , & ixgbe_desc_acc_attr , DDI_DMA_CONSISTENT , DDI_DMA_DONTWAIT , NULL , ( caddr_t * ) & tx_ring -> tbd_area . address , & len , & tx_ring -> tbd_area . acc_handle ) ; if ( ret != DDI_SUCCESS ) { ixgbe_error ( ixgbe , "Could not allocate tbd dma memory: %x" , ret ) ; tx_ring -> tbd_area . acc_handle = NULL ; tx_ring -> tbd_area . address = NULL ; if ( tx_ring -> tbd_area . dma_handle != NULL ) { ddi_dma_free_handle ( & tx_ring -> tbd_area . dma_handle ) ; tx_ring -> tbd_area . dma_handle = NULL ; } return ( IXGBE_FAILURE ) ; } bzero ( tx_ring -> tbd_area . address , len ) ; ret = ddi_dma_addr_bind_handle ( tx_ring -> tbd_area . dma_handle , NULL , ( caddr_t ) tx_ring -> tbd_area . address , len , DDI_DMA_RDWR | DDI_DMA_CONSISTENT , DDI_DMA_DONTWAIT , NULL , & cookie , & cookie_num ) ; if ( ret != DDI_DMA_MAPPED ) { ixgbe_error ( ixgbe , "Could not bind tbd dma resource: %x" , ret ) ; tx_ring -> tbd_area . dma_address = 0 ; if ( tx_ring -> tbd_area . acc_handle != NULL ) { ddi_dma_mem_free ( & tx_ring -> tbd_area . acc_handle ) ; tx_ring -> tbd_area . acc_handle = NULL ; tx_ring -> tbd_area . address = NULL ; } if ( tx_ring -> tbd_area . dma_handle != NULL ) { ddi_dma_free_handle ( & tx_ring -> tbd_area . dma_handle ) ; tx_ring -> tbd_area . dma_handle = NULL ; } return ( IXGBE_FAILURE ) ; } ASSERT ( cookie_num == 1 ) ; tx_ring -> tbd_area . dma_address = cookie . dmac_laddress ; tx_ring -> tbd_area . size = len ; tx_ring -> tbd_ring = ( ixgbe_adv_tx_desc * ) ( uintptr_t ) tx_ring -> tbd_area . address ; return ( IXGBE_SUCCESS ) ; } 