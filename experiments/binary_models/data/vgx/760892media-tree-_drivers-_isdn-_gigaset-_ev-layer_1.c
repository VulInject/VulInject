static void add_cid_event ( struct cardstate * cs , int cid , int type , void * ptr , int parameter ) { unsigned long flags ; unsigned next , tail ; struct event_t * event ; gig_dbg ( DEBUG_EVENT , "queueing event %d for cid %d" , type , cid ) ; spin_lock_irqsave ( & cs -> ev_lock , flags ) ; tail = cs -> ev_tail ; next = ( tail + 1 ) % MAX_EVENTS ; if ( unlikely ( next == cs -> ev_head ) ) { dev_err ( cs -> dev , "event queue full\n" ) ; } else { event = cs -> events + tail ; event -> type = type ; event -> cid = cid ; event -> ptr = ptr ; event -> arg = NULL ; event -> parameter = parameter ; event -> at_state = NULL ; cs -> ev_tail = next ; } spin_unlock_irqrestore ( & cs -> ev_lock , flags ) ; } 