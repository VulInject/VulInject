static int cdns_torrent_clk ( struct cdns_torrent_phy * cdns_phy ) { struct device * dev = cdns_phy -> dev ; unsigned long ref_clk_rate ; int ret ; cdns_phy -> clk = devm_clk_get ( dev , "refclk" ) ; if ( IS_ERR ( cdns_phy -> clk ) ) { dev_err ( dev , "phy ref clock not found\n" ) ; return PTR_ERR ( cdns_phy -> clk ) ; } ret = clk_prepare_enable ( cdns_phy -> clk ) ; if ( ret ) { dev_err ( cdns_phy -> dev , "Failed to prepare ref clock\n" ) ; return ret ; } ref_clk_rate = clk_get_rate ( cdns_phy -> clk ) ; if ( ! ref_clk_rate ) { dev_err ( cdns_phy -> dev , "Failed to get ref clock rate\n" ) ; clk_disable_unprepare ( cdns_phy -> clk , NULL ) ; return - EINVAL ; } switch ( ref_clk_rate ) { case REF_CLK_19_2MHZ : cdns_phy -> ref_clk_rate = CLK_19_2_MHZ ; break ; case REF_CLK_25MHZ : cdns_phy -> ref_clk_rate = CLK_25_MHZ ; break ; case REF_CLK_100MHZ : cdns_phy -> ref_clk_rate = CLK_100_MHZ ; break ; default : dev_err ( cdns_phy -> dev , "Invalid Ref Clock Rate\n" ) ; clk_disable_unprepare ( cdns_phy -> clk ) ; return - EINVAL ; } return 0 ; } 