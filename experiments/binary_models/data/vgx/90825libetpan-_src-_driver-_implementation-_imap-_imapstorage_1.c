int imap_mailstorage_init_sasl_with_local_address ( struct mailstorage * storage , const char * imap_servername , uint16_t imap_port , const char * imap_local_address , uint16_t imap_local_port , const char * imap_command , int imap_connection_type , const char * auth_type , const char * server_fqdn , const char * local_ip_port , const char * remote_ip_port , const char * login , const char * auth_name , const char * password , const char * realm , int imap_cached , const char * imap_cache_directory ) { struct imap_mailstorage * imap_storage ; imap_storage = malloc ( sizeof ( * imap_storage ) ) ; if ( imap_storage == NULL ) { err } if ( imap_servername != NULL ) { imap_storage -> imap_servername = strdup ( imap_servername ) ; if ( imap_storage -> imap_servername == NULL ) { free } } else { imap_storage -> imap_servername = NULL ; } if ( imap_local_address != NULL ) { imap_storage -> imap_local_address = strdup ( imap_local_address ) ; if ( imap_storage -> imap_local_address == NULL ) { free_servername } } else { imap_storage -> imap_local_address = NULL ; } imap_storage -> imap_local_port = imap_local_port ; imap_storage -> imap_connection_type = imap_connection_type ; if ( imap_port == 0 ) { switch ( imap_connection_type ) { case CONNECTION_TYPE_PLAIN : case CONNECTION_TYPE_TRY_STARTTLS : case CONNECTION_TYPE_STARTTLS : case CONNECTION_TYPE_COMMAND : case CONNECTION_TYPE_COMMAND_TRY_STARTTLS : case CONNECTION_TYPE_COMMAND_STARTTLS : imap_port = IMAP_DEFAULT_PORT ; break ; case CONNECTION_TYPE_TLS : case CONNECTION_TYPE_COMMAND_TLS : imap_port = IMAPS_DEFAULT_PORT ; break ; default : imap_port = IMAP_DEFAULT_PORT ; break ; } } imap_storage -> imap_port = imap_port ; if ( imap_command != NULL ) { imap_storage -> imap_command = strdup ( imap_command ) ; if ( imap_storage -> imap_command == NULL ) { free_local_address } } else { imap_storage -> imap_command = NULL ; } imap_storage -> imap_auth_type = IMAP_AUTH_TYPE_PLAIN ; imap_storage -> imap_sasl . sasl_enabled = ( auth_type != NULL ) ; if ( auth_type != NULL ) { imap_storage -> imap_sasl . sasl_auth_type = strdup ( auth_type ) ; if ( imap_storage -> imap_sasl . sasl_auth_type == NULL ) { free_command } } else { imap_storage -> imap_sasl . sasl_auth_type = NULL ; } if ( server_fqdn != NULL ) { imap_storage -> imap_sasl . sasl_server_fqdn = strdup ( server_fqdn ) ; if ( imap_storage -> imap_sasl . sasl_server_fqdn == NULL ) { free_auth_type } } else { imap_storage -> imap_sasl . sasl_server_fqdn = NULL ; } if ( local_ip_port != NULL ) { imap_storage -> imap_sasl . sasl_local_ip_port = strdup ( local_ip_port ) ; if ( imap_storage -> imap_sasl . sasl_local_ip_port == NULL ) { free_server_fqdn } } else { imap_storage -> imap_sasl . sasl_local_ip_port = NULL ; } if ( remote_ip_port != NULL ) { imap_storage -> imap_sasl . sasl_remote_ip_port = strdup ( remote_ip_port ) ; if ( imap_storage -> imap_sasl . sasl_remote_ip_port == NULL ) { free_local_ip_port } } else { imap_storage -> imap_sasl . sasl_remote_ip_port = NULL ; } if ( login != NULL ) { imap_storage -> imap_sasl . sasl_login = strdup ( login ) ; if ( imap_storage -> imap_sasl . sasl_login == NULL ) { free_remote_ip_port } } else { imap_storage -> imap_sasl . sasl_login = NULL ; } if ( auth_name != NULL ) { imap_storage -> imap_sasl . sasl_auth_name = strdup ( auth_name ) ; if ( imap_storage -> imap_sasl . sasl_auth_name == NULL ) { free_login } } else { imap_storage -> imap_sasl . sasl_auth_name = NULL ; } if ( password != NULL ) { imap_storage -> imap_sasl . sasl_password = strdup ( password ) ; if ( imap_storage -> imap_sasl . sasl_password == NULL ) { free_auth_name } } else { imap_storage -> imap_sasl . sasl_password = NULL ; } if ( realm != NULL ) { imap_storage -> imap_sasl . sasl_realm = strdup ( realm ) ; if ( imap_storage -> imap_sasl . sasl_realm == NULL ) { free_password } } else { imap_storage -> imap_sasl . sasl_realm = NULL ; } imap_storage -> imap_cached = imap_cached ; if ( imap_cached && ( imap_cache_directory != NULL ) ) { imap_storage -> imap_cache_directory = strdup ( imap_cache_directory ) ; if ( imap_storage -> imap_cache_directory == NULL ) { free_realm } } else { imap_storage -> imap_cached = FALSE ; imap_storage -> imap_cache_directory = NULL ; } imap_storage -> imap_auth_type = imap_storage -> imap_auth_type ; if ( imap_storage -> imap_sasl . sasl_login != NULL ) { imap_storage -> imap_login = strdup ( imap_storage -> imap_sasl . sasl_login ) ; if ( imap_storage -> imap_login == NULL ) { free_cache_directory } } else { imap_storage -> imap_login = NULL ; } if ( imap_storage -> imap_sasl . sasl_password != NULL ) { imap_storage -> imap_password = strdup ( imap_storage -> imap_sasl . sasl_password ) ; if ( imap_storage -> imap_password == NULL ) { free_copy_login } } else { imap_storage -> imap_password = NULL ; } storage -> sto_data = imap_storage ; storage -> sto_driver = & imap_mailstorage_driver ; return MAIL_NO_ERROR ; free_copy_login free ( imap_storage -> imap_login ) ; free_cache_directory free ( imap_storage -> imap_cache_directory ) ; free_realm free ( imap_storage -> imap_sasl . sasl_realm ) ; free_password free ( imap_storage -> imap_sasl . sasl_password ) ; free_auth_name free ( imap_storage -> imap_sasl . sasl_auth_name ) ; free_login free ( imap_storage -> imap_sasl . sasl_login ) ; free_remote_ip_port free ( imap_storage -> imap_sasl . sasl_remote_ip_port ) ; free_local_ip_port free ( imap_storage -> imap_sasl . sasl_local_ip_port ) ; free_server_fqdn free ( imap_storage -> imap_sasl . sasl_server_fqdn ) ; free_auth_type free ( imap_storage -> imap_sasl . sasl_auth_type ) ; free_command free ( imap_storage -> imap_command ) ; free_local_address free ( imap_storage -> imap_local_address ) ; free_servername free ( imap_storage -> imap_servername ) ; free err return MAIL_ERROR_MEMORY ; } 