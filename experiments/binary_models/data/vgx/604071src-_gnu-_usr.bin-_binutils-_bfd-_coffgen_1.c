coff_get_normalized_symtab ( ) bfd * abfd ; { combined_entry_type * internal ; combined_entry_type * internal_ptr ; combined_entry_type * symbol_ptr ; combined_entry_type * internal_end ; size_t symesz ; char * raw_src ; char * raw_end ; const char * string_table = NULL ; char * debug_section = NULL ; bfd_size_type size ; if ( obj_raw_syments ( abfd ) != NULL ) { return obj_raw_syments ( abfd ) ; } size = obj_raw_syment_count ( abfd ) * sizeof ( combined_entry_type ) ; internal = ( combined_entry_type * ) bfd_zalloc ( abfd , size ) ; if ( internal == NULL && size != 0 ) { return in ; } internal_end = internal + obj_raw_syment_count ( abfd ) ; if ( ! _bfd_coff_get_external_symbols ( abfd ) ) { return NULL ; } raw_src = ( char * ) obj_coff_external_syms ( abfd ) ; symesz = bfd_coff_symesz ( abfd ) ; raw_end = ( char * ) raw_src + obj_raw_syment_count ( abfd ) * symesz ; for ( internal_ptr = internal ; raw_src < raw_end ; raw_src += symesz , internal_ptr ++ ) { unsigned int i ; bfd_coff_swap_sym_in ( abfd , ( PTR ) raw_src , ( PTR ) & internal_ptr -> u . syment ) ; symbol_ptr = internal_ptr ; for ( i = 0 ; i < symbol_ptr -> u . syment . n_numaux ; i ++ ) { internal_ptr ++ ; raw_src += symesz ; bfd_coff_swap_aux_in ( abfd , ( PTR ) raw_src , symbol_ptr -> u . syment . n_type , symbol_ptr -> u . syment . n_sclass , ( int ) i , symbol_ptr -> u . syment . n_numaux , & ( internal_ptr -> u . auxent ) ) ; coff_pointerize_aux ( abfd , internal , symbol_ptr , i , internal_ptr ) ; } } obj_coff_keep_strings ( abfd ) = TRUE ; if ( ! _bfd_coff_free_symbols ( abfd ) ) { return NULL ; } for ( internal_ptr = internal ; internal_ptr < internal_end ; internal_ptr ++ ) { if ( internal_ptr -> u . syment . n_sclass == C_FILE && internal_ptr -> u . syment . n_numaux > 0 ) { if ( ( internal_ptr + 1 ) -> u . auxent . x_file . x_n . x_zeroes == 0 ) { if ( string_table == NULL ) { string_table = _bfd_coff_read_string_table ( abfd ) ; if ( string_table == NULL ) { return NULL ; } } internal_ptr -> u . syment . _n . _n_n . _n_offset = ( ( long ) ( string_table + ( internal_ptr + 1 ) -> u . auxent . x_file . x_n . x_offset ) ) ; } else { if ( internal_ptr -> u . syment . n_numaux > 1 && coff_data ( abfd ) -> pe ) { internal_ptr -> u . syment . _n . _n_n . _n_offset = ( ( long ) copy_name ( abfd , ( internal_ptr + 1 ) -> u . auxent . x_file . x_fname , internal_ptr -> u . syment . n_numaux * symesz ) ) ; } else { internal_ptr -> u . syment . _n . _n_n . _n_offset = ( ( long ) copy_name ( abfd , ( internal_ptr + 1 ) -> u . auxent . x_file . x_fname , ( size_t ) bfd_coff_filnmlen ( abfd ) ) ) ; } } } else { if ( internal_ptr -> u . syment . _n . _n_n . _n_zeroes != 0 ) { size_t i ; char * newstring ; for ( i = 0 ; i < 8 ; ++ i ) { if ( internal_ptr -> u . syment . _n . _n_name [ i ] == '\0' ) { break ; } } newstring = ( PTR ) bfd_zalloc ( abfd , ( bfd_size_type ) ( i + 1 ) ) ; if ( newstring == NULL ) { return ( NULL ) ; } strncpy ( newstring , internal_ptr -> u . syment . _n . _n_name , i ) ; internal_ptr -> u . syment . _n . _n_n . _n_offset = ( long int ) newstring ; internal_ptr -> u . syment . _n . _n_n . _n_zeroes = 0 ; } if ( internal_ptr -> u . syment . _n . _n_n . _n_offset == 0 ) { internal_ptr -> u . syment . _n . _n_n . _n_offset = ( long int ) "" ; } if ( ! bfd_coff_symname_in_debug ( abfd , & internal_ptr -> u . syment ) ) { if ( string_table == NULL ) { string_table = _bfd_coff_read_string_table ( abfd ) ; if ( string_table == NULL ) { return NULL ; } } internal_ptr -> u . syment . _n . _n_n . _n_offset = ( ( long int ) ( string_table + internal_ptr -> u . syment . _n . _n_n . _n_offset ) ) ; } else { if ( debug_section == NULL ) { debug_section = build_debug_section ( abfd ) ; } internal_ptr -> u . syment . _n . _n_n . _n_offset = ( long int ) ( debug_section + internal_ptr -> u . syment . _n . _n_n . _n_offset ) ; } } internal_ptr += internal_ptr -> u . syment . n_numaux ; } obj_raw_syments ( abfd ) = internal ; BFD_ASSERT ( obj_raw_syment_count ( abfd ) == ( unsigned int ) ( internal_ptr - internal ) ) ; return ( internal ) ; } 