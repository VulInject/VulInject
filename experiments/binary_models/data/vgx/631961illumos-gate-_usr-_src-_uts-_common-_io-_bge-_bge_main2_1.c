static int bge_unicst_set ( void * arg , const uint8_t * macaddr , int slot ) { bge_t * bgep = arg ; BGE_TRACE ( ( "bge_unicst_set($%p, %s)" , arg , ether_sprintf ( ( void * ) macaddr ) ) ) ; if ( ! ( bgep -> progress & PROGRESS_INTR ) ) { ddi_fm_service_impact ( bgep -> devinfo , DDI_SERVICE_DEGRADED ) ; mutex_exit ( bgep -> genlock ) ; return ( EIO ) ; } ethaddr_copy ( macaddr , bgep -> curr_addr [ slot ] . addr ) ; if ( bge_chip_sync ( bgep , B_FALSE ) == DDI_FAILURE ) { if ( bge_chip_sync ( bgep ) == DDI_FAILURE ) { ( void ) bge_check_acc_handle ( bgep , bgep -> cfg_handle ) ; ( void ) bge_check_acc_handle ( bgep , bgep -> io_handle ) ; ddi_fm_service_impact ( bgep -> devinfo , DDI_SERVICE_DEGRADED ) ; mutex_exit ( bgep -> genlock ) ; return ( EIO ) ; } if ( bgep -> asf_enabled ) { if ( bgep -> asf_status == ASF_STAT_RUN ) { bge_asf_update_status ( bgep ) ; bge_asf_stop_timer ( bgep ) ; bgep -> asf_status = ASF_STAT_STOP ; bge_asf_pre_reset_operations ( bgep , BGE_INIT_RESET ) ; } bge_chip_stop ( bgep , B_FALSE ) ; if ( bge_restart ( bgep , B_FALSE ) == DDI_FAILURE ) { ( void ) bge_check_acc_handle ( bgep , bgep -> cfg_handle ) ; ( void ) bge_check_acc_handle ( bgep , bgep -> io_handle ) ; ddi_fm_service_impact ( bgep -> devinfo , DDI_SERVICE_DEGRADED ) ; mutex_exit ( bgep -> genlock ) ; return ( EIO ) ; } if ( bgep -> asf_status != ASF_STAT_RUN ) { bgep -> asf_timeout_id = timeout ( bge_asf_heartbeat , ( void * ) bgep , drv_usectohz ( BGE_ASF_HEARTBEAT_INTERVAL ) ) ; bgep -> asf_status = ASF_STAT_RUN ; } } BGE_DEBUG ( ( "bge_unicst_set($%p) done" , arg ) ) ; if ( bge_check_acc_handle ( bgep , bgep -> cfg_handle ) != DDI_FM_OK ) { ddi_fm_service_impact ( bgep -> devinfo , DDI_SERVICE_DEGRADED ) ; mutex_exit ( bgep -> genlock ) ; return ( EIO ) ; } if ( bge_check_acc_handle ( bgep , bgep -> io_handle ) != DDI_FM_OK ) { ddi_fm_service_impact ( bgep -> devinfo , DDI_SERVICE_DEGRADED ) ; mutex_exit ( bgep -> genlock ) ; return ( EIO ) ; } mutex_exit ( bgep -> genlock ) ; return ( 0 ) ; } } 