static int lowpan_frag_queue ( struct lowpan_frag_queue * fq , struct sk_buff * skb , u8 frag_type ) { struct sk_buff * prev_tail ; struct net_device * ldev ; int end , offset , err ; BUILD_BUG_ON ( sizeof ( lowpan_802154_cb ) > sizeof ( inet_skb_parm ) ) ; BUILD_BUG_ON ( sizeof ( lowpan_802154_cb ) > sizeof ( inet6_skb_parm ) ) ; if ( fq -> q . flags & INET_FRAG_COMPLETE ) { err } offset = lowpan_802154_cb ( skb ) -> d_offset << 3 ; end = lowpan_802154_cb ( skb ) -> d_size ; if ( offset + skb -> len == end ) { if ( end < fq -> q . len || ( ( fq -> q . flags & INET_FRAG_LAST_IN ) && end != fq -> q . len ) ) { err } fq -> q . flags |= INET_FRAG_LAST_IN ; fq -> q . len = end ; } else { if ( end > fq -> q . len ) { if ( fq -> q . flags & INET_FRAG_LAST_IN ) { err } fq -> q . len = end ; } } ldev = skb -> dev ; if ( ldev ) { skb -> dev = NULL ; } barrier ( ) ; prev_tail = fq -> q . fragments_tail ; err = inet_frag_queue_insert ( & fq -> q , skb , offset , end ) ; if ( err ) { err } fq -> q . stamp = skb -> tstamp ; fq -> q . mono_delivery_time = skb -> mono_delivery_time ; if ( frag_type == LOWPAN_DISPATCH_FRAG1 ) { fq -> q . flags |= INET_FRAG_FIRST_IN ; } fq -> q . meat += skb -> len ; add_frag_mem_limit ( fq -> q . fqdir , skb -> truesize ) ; if ( fq -> q . flags == ( INET_FRAG_FIRST_IN | INET_FRAG_LAST_IN ) && fq -> q . meat == fq -> q . len ) { int res ; unsigned long orefdst = skb -> _skb_refdst ; skb -> _skb_refdst = 0UL ; res = lowpan_frag_reasm ( fq , skb , prev_tail , ldev ) ; skb -> _skb_refdst = orefdst ; return res ; } skb_dst_drop ( skb ) ; return - 1 ; err return - 1 ; } 