static unsigned int jmb38x_ms_read_data ( struct jmb38x_ms_host * host , unsigned char * buf , unsigned int length ) { unsigned int off = 0 ; while ( host -> io_pos && length ) { buf [ off ++ ] = host -> io_word [ 0 ] & 0xff ; host -> io_word [ 0 ] >>= 8 ; length -- ; host -> io_pos -- ; } while ( ! ( STATUS_FIFO_EMPTY & readl ( host -> addr + STATUS ) ) ) { if ( length < 4 ) { break ; } * ( unsigned int * ) ( buf + off ) = __raw_readl ( host -> addr + DATA ) ; length -= 4 ; off += 4 ; } if ( length && ! ( STATUS_FIFO_EMPTY & readl ( host -> addr + STATUS ) ) ) { host -> io_word [ 0 ] = readl ( host -> addr + DATA ) ; for ( host -> io_pos = 4 ; host -> io_pos ; -- host -> io_pos ) { buf [ off ++ ] = host -> io_word [ 0 ] & 0xff ; host -> io_word [ 0 ] >>= 8 ; length -- ; if ( ! length ) { break ; } } } return off ; } 