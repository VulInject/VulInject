static int nx_fw_cmd_create_tx_ctx ( struct netxen_adapter * adapter ) { nx_hostrq_tx_ctx_t * prq ; nx_hostrq_cds_ring_t * prq_cds ; nx_cardrsp_tx_ctx_t * prsp ; void * rq_addr , * rsp_addr ; size_t rq_size , rsp_size ; u32 temp ; int err = 0 ; u64 offset , phys_addr ; dma_addr_t rq_phys_addr , rsp_phys_addr ; struct nx_host_tx_ring * tx_ring = adapter -> tx_ring ; struct netxen_recv_context * recv_ctx = & adapter -> recv_ctx ; struct netxen_cmd_args cmd ; rq_size = SIZEOF_HOSTRQ_TX ( nx_hostrq_tx_ctx_t ) ; rq_addr = dma_alloc_coherent ( & adapter -> pdev -> dev , rq_size , & rq_phys_addr , GFP_KERNEL ) ; if ( ! rq_addr ) { return - ENOMEM ; } rsp_size = SIZEOF_CARDRSP_TX ( nx_cardrsp_tx_ctx_t ) ; rsp_addr = dma_alloc_coherent ( & adapter -> pdev -> dev , rsp_size , & rsp_phys_addr , GFP_KERNEL ) ; if ( ! rsp_addr ) { err = - ENOMEM ; out_free_rq } prq = rq_addr ; prsp = rsp_addr ; prq -> host_rsp_dma_addr = cpu_to_le64 ( rsp_phys_addr ) ; temp = ( NX_CAP0_LEGACY_CONTEXT | NX_CAP0_LEGACY_MN | NX_CAP0_LSO ) ; prq -> capabilities [ 0 ] = cpu_to_le32 ( temp ) ; prq -> host_int_crb_mode = cpu_to_le32 ( NX_HOST_INT_CRB_MODE_SHARED ) ; prq -> interrupt_ctl = 0 ; prq -> msi_index = 0 ; prq -> dummy_dma_addr = cpu_to_le64 ( adapter -> dummy_dma . phys_addr ) ; offset = recv_ctx -> phys_addr + sizeof ( netxen_ring_ctx ) ; prq -> cmd_cons_dma_addr = cpu_to_le64 ( offset ) ; prq_cds = & prq -> cds_ring ; prq_cds -> host_phys_addr = cpu_to_le64 ( tx_ring -> phys_addr ) ; prq_cds -> ring_size = cpu_to_le32 ( tx_ring -> num_desc ) ; phys_addr = rq_phys_addr ; cmd . req . arg1 = ( u32 ) ( phys_addr >> 32 ) ; cmd . req . arg2 = ( ( u32 ) phys_addr & 0xffffffff ) ; cmd . req . arg3 = rq_size ; cmd . req . cmd = NX_CDRP_CMD_CREATE_TX_CTX ; err = netxen_issue_cmd ( adapter , & cmd ) ; if ( err == NX_RCODE_SUCCESS ) { temp = le32_to_cpu ( prsp -> cds_ring . host_producer_crb ) ; tx_ring -> crb_cmd_producer = netxen_get_ioaddr ( adapter , NETXEN_NIC_REG ( temp - 0x200 ) ) ; adapter -> tx_state = le32_to_cpu ( prsp -> host_ctx_state ) ; adapter -> tx_context_id = le16_to_cpu ( prsp -> context_id ) ; } else { printk ( KERN_WARNING "Failed to create tx ctx in firmware%d\n" , err ) ; err = - EIO ; } dma_free_coherent ( & adapter -> pdev -> dev , rsp_size , rsp_addr , rsp_phys_addr ) ; out_free_rq dma_free_coherent ( & adapter -> pdev -> dev , rq_size , rq_addr , rq_phys_addr ) ; return err ; } 