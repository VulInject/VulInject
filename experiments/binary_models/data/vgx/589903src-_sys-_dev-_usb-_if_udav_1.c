int udav_mem_read ( struct udav_softc * sc , int offset , void * buf , int len ) { usb_device_request_t req ; usbd_status err ; DPRINTFN ( 0x200 , ( "%s: %s: enter\n" , sc -> sc_dev . dv_xname , __func__ ) ) ; if ( usbd_is_dying ( sc -> sc_udev ) ) { return ( 0 ) ; } offset &= 0xffff ; len &= 0xff ; req . bmRequestType = UT_READ_VENDOR_DEVICE ; req . bRequest = UDAV_REQ_MEM_READ ; USETW ( req . wValue , 0x0000 ) ; USETW ( req . wIndex , offset ) ; USETW ( req . wLength , len ) ; sc -> sc_refcnt ++ ; err = usbd_do_request ( sc -> sc_udev , & req , buf ) ; if ( -- sc -> sc_refcnt < 0 ) { usb_detach_wakeup ( & sc -> sc_dev ) ; } if ( err ) { DPRINTF ( ( "%s: %s: read failed. off=%04x, err=%d\n" , sc -> sc_dev . dv_xname , __func__ , offset , err ) ) ; } return ( err ) ; } 