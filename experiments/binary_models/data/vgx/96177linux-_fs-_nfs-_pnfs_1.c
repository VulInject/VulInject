void pnfs_put_lseg ( struct pnfs_layout_segment * lseg ) { struct pnfs_layout_hdr * lo ; struct inode * inode ; if ( ! lseg ) { return ; } dprintk ( "%s: lseg %p ref %d valid %d\n" , __func__ , lseg , refcount_read ( & lseg -> pls_refcount ) , test_bit ( NFS_LSEG_VALID , & lseg -> pls_flags ) ) ; lo = lseg -> pls_layout ; inode = lo -> plh_inode ; if ( refcount_dec_and_lock ( & lseg -> pls_refcount , & inode -> i_lock ) ) { pnfs_get_layout_hdr ( lo , NULL ) ; pnfs_layout_remove_lseg ( lo , lseg ) ; if ( pnfs_cache_lseg_for_layoutreturn ( lo , lseg ) ) { lseg = NULL ; } spin_unlock ( & inode -> i_lock ) ; pnfs_free_lseg ( lseg ) ; pnfs_put_layout_hdr ( lo ) ; } } 