int iwm_add_sta_cmd ( struct iwm_softc * sc , struct iwm_node * in , int update ) { struct iwm_add_sta_cmd add_sta_cmd ; int err ; uint32_t status , aggsize ; const uint32_t max_aggsize = ( IWM_STA_FLG_MAX_AGG_SIZE_64K >> IWM_STA_FLG_MAX_AGG_SIZE_SHIFT ) ; size_t cmdsize ; struct ieee80211com * ic = & sc -> sc_ic ; if ( ! update && ( sc -> sc_flags & IWM_FLAG_STA_ACTIVE ) ) { panic ( "STA already added" ) ; } if ( ic -> ic_opmode == IEEE80211_M_MONITOR ) { add_sta_cmd . sta_id = IWM_MONITOR_STA_ID ; } else { add_sta_cmd . sta_id = IWM_STATION_ID ; } if ( isset ( sc -> sc_ucode_api , IWM_UCODE_TLV_API_STA_TYPE ) ) { if ( ic -> ic_opmode == IEEE80211_M_MONITOR ) { add_sta_cmd . station_type = IWM_STA_GENERAL_PURPOSE ; } else { add_sta_cmd . station_type = IWM_STA_LINK ; } } add_sta_cmd . mac_id_n_color = htole32 ( IWM_FW_CMD_ID_AND_COLOR ( in -> in_id , in -> in_color ) ) ; if ( ic -> ic_opmode == IEEE80211_M_MONITOR ) { int qid ; IEEE80211_ADDR_COPY ( & add_sta_cmd . addr , etheranyaddr ) ; if ( isset ( sc -> sc_enabled_capa , IWM_UCODE_TLV_CAPA_DQA_SUPPORT ) ) { qid = IWM_DQA_INJECT_MONITOR_QUEUE ; } else { qid = IWM_AUX_QUEUE ; } in -> tfd_queue_msk |= ( 1 << qid ) ; } else { int ac ; for ( ac = 0 ; ac < EDCA_NUM_AC ; ac ++ ) { int qid = ac ; if ( isset ( sc -> sc_enabled_capa , IWM_UCODE_TLV_CAPA_DQA_SUPPORT ) ) { qid += IWM_DQA_MIN_MGMT_QUEUE ; } in -> tfd_queue_msk |= ( 1 << qid ) ; } } if ( ! update ) { if ( ic -> ic_opmode == IEEE80211_M_MONITOR ) { IEEE80211_ADDR_COPY ( & add_sta_cmd . addr , etherbroadcastaddr ) ; } else { IEEE80211_ADDR_COPY ( & add_sta_cmd . addr , in -> in_macaddr ) ; } } add_sta_cmd . add_modify = update ?1 : 0 ; add_sta_cmd . station_flags_msk |= htole32 ( IWM_STA_FLG_FAT_EN_MSK | IWM_STA_FLG_MIMO_EN_MSK ) ; if ( update ) { add_sta_cmd . modify_mask |= ( IWM_STA_MODIFY_QUEUES | IWM_STA_MODIFY_TID_DISABLE_TX ) ; } add_sta_cmd . tid_disable_tx = htole16 ( in -> tid_disable_ampdu ) ; add_sta_cmd . tfd_queue_msk = htole32 ( in -> tfd_queue_msk ) ; if ( in -> in_ni . ni_flags & IEEE80211_NODE_HT ) { add_sta_cmd . station_flags_msk |= htole32 ( IWM_STA_FLG_MAX_AGG_SIZE_MSK | IWM_STA_FLG_AGG_MPDU_DENS_MSK ) ; if ( iwm_mimo_enabled ( sc ) ) { if ( in -> in_ni . ni_flags & IEEE80211_NODE_VHT ) { uint16_t rx_mcs = ( in -> in_ni . ni_vht_rxmcs & IEEE80211_VHT_MCS_FOR_SS_MASK ( 2 ) ) >> IEEE80211_VHT_MCS_FOR_SS_SHIFT ( 2 ) ; if ( rx_mcs != IEEE80211_VHT_MCS_SS_NOT_SUPP ) { add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_MIMO_EN_MIMO2 ) ; } } else { if ( in -> in_ni . ni_rxmcs [ 1 ] != 0 ) { add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_MIMO_EN_MIMO2 ) ; } if ( in -> in_ni . ni_rxmcs [ 2 ] != 0 ) { add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_MIMO_EN_MIMO3 ) ; } } } if ( IEEE80211_CHAN_40MHZ_ALLOWED ( in -> in_ni . ni_chan ) && ieee80211_node_supports_ht_chan40 ( & in -> in_ni ) ) { add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_FAT_EN_40MHZ ) ; } if ( in -> in_ni . ni_flags & IEEE80211_NODE_VHT ) { if ( IEEE80211_CHAN_80MHZ_ALLOWED ( in -> in_ni . ni_chan ) && ieee80211_node_supports_vht_chan80 ( & in -> in_ni ) ) { add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_FAT_EN_80MHZ ) ; } aggsize = ( in -> in_ni . ni_vhtcaps & IEEE80211_VHTCAP_MAX_AMPDU_LEN_MASK ) >> IEEE80211_VHTCAP_MAX_AMPDU_LEN_SHIFT ; } else { aggsize = ( in -> in_ni . ni_ampdu_param & IEEE80211_AMPDU_PARAM_LE ) ; } if ( aggsize > max_aggsize ) { aggsize = max_aggsize ; } add_sta_cmd . station_flags |= htole32 ( ( aggsize << IWM_STA_FLG_MAX_AGG_SIZE_SHIFT ) & IWM_STA_FLG_MAX_AGG_SIZE_MSK ) ; switch ( in -> in_ni . ni_ampdu_param & IEEE80211_AMPDU_PARAM_SS ) { case IEEE80211_AMPDU_PARAM_SS_2 : add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_AGG_MPDU_DENS_2US ) ; break ; case IEEE80211_AMPDU_PARAM_SS_4 : add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_AGG_MPDU_DENS_4US ) ; break ; case IEEE80211_AMPDU_PARAM_SS_8 : add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_AGG_MPDU_DENS_8US ) ; break ; case IEEE80211_AMPDU_PARAM_SS_16 : add_sta_cmd . station_flags |= htole32 ( IWM_STA_FLG_AGG_MPDU_DENS_16US ) ; break ; default : break ; } } status = IWM_ADD_STA_SUCCESS ; if ( isset ( sc -> sc_ucode_api , IWM_UCODE_TLV_API_STA_TYPE ) ) { cmdsize = sizeof ( add_sta_cmd ) ; } else { cmdsize = sizeof ( iwm_add_sta_cmd_v7 ) ; } err = iwm_send_cmd_pdu_status ( sc , IWM_ADD_STA , cmdsize , & add_sta_cmd , & status ) ; if ( ! err && ( status & IWM_ADD_STA_STATUS_MASK ) != IWM_ADD_STA_SUCCESS ) { err = EIO ; } return err ; } 