int mbedtls_x509_dn_gets ( char * buf , size_t size , const mbedtls_x509_name * dn ) { int ret = MBEDTLS_ERR_ERROR_CORRUPTION_DETECTED ; size_t i , j , n ; unsigned char c , merge = 0 ; const mbedtls_x509_name * name ; const char * short_name = NULL ; char s [ MBEDTLS_X509_MAX_DN_NAME_SIZE ] , * p ; name = dn ; p = buf ; n = size ; while ( name != NULL ) { if ( ! name -> oid . p ) { name = name -> next ; continue ; } if ( name != dn ) { ret = mbedtls_snprintf ( p , n , merge ?" + " : ", " ) ; MBEDTLS_X509_SAFE_SNPRINTF ; } ret = mbedtls_oid_get_attr_short_name ( & name -> oid , & short_name ) ; if ( ret == 0 ) { ret = mbedtls_snprintf ( p , n , "%s=" , short_name ) ; } else { ret = mbedtls_snprintf ( p , n , "\?\?=" ) ; } MBEDTLS_X509_SAFE_SNPRINTF ; for ( i = 0 , j = 0 ; i < name -> val . len ; i ++ , j ++ ) { if ( j >= sizeof ( s ) - 1 ) { return MBEDTLS_ERR_X509_BUFFER_TOO_SMALL ; } c = name -> val . p [ i ] ; if ( c && strchr ( ",=+<>#;\"\\" , c ) ) { if ( j + 1 >= sizeof ( s ) - 1 ) { return MBEDTLS_ERR_X509_BUFFER_TOO_SMALL ; } s [ j ++ ] = '\\' ; } if ( c < 32 || c >= 127 ) { s [ j ] = '?' ; } else { s [ j ] = c ; } } s [ j ] = '\0' ; ret = mbedtls_snprintf ( p , n , "%s" , s ) ; MBEDTLS_X509_SAFE_SNPRINTF ; merge = name -> next_merged ; name = name -> next ; } return ( int ) ( size - n ) ; } 