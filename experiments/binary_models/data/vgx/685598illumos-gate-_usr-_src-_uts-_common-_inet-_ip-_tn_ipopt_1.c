int tsol_compute_label_v4 ( const ts_label_t * tsl , zoneid_t zoneid , ipaddr_t dst , uchar_t * opt_storage , ip_stack_t * ipst ) { uint_t sec_opt_len ; ire_t * ire ; tsol_ire_gw_secattr_t * attrp = NULL ; if ( opt_storage != NULL ) { opt_storage [ IPOPT_OLEN ] = 0 ; } if ( tsl == NULL ) { return ( 0 ) ; } if ( CLASSD ( dst ) ) { return ( 0 ) ; } if ( tsl -> tsl_flags & TSLF_IMPLICIT_OUT ) { return ( 0 ) ; } if ( tsl -> tsl_flags & TSLF_UNLABELED ) { ire = ire_route_recursive_v4 ( dst , 0 , NULL , zoneid , tsl , MATCH_IRE_SECATTR , IRR_ALLOCATE , 0 , ipst , NULL , & attrp , NULL ) ; ASSERT ( ire != NULL ) ; if ( ire -> ire_flags & ( RTF_REJECT | RTF_BLACKHOLE ) ) { ire_refrele ( ire , NULL ) ; DTRACE_PROBE3 ( tx__tnopt__log__info__labeling__routedst__v4 , char * , "No route to unlabeled dest ip(1) with " "with label(2)." , ipaddr_t , dst , ts_label_t * , tsl ) ; return ( EHOSTUNREACH ) ; } if ( ire -> ire_type & ( IRE_BROADCAST | IRE_LOCAL | IRE_LOOPBACK | IRE_INTERFACE ) ) { ire_refrele ( ire ) ; return ( 0 ) ; } if ( attrp == NULL || attrp -> igsa_rhc == NULL || attrp -> igsa_rhc -> rhc_tpc -> tpc_tp . host_type == UNLABELED ) { ire_refrele ( ire ) ; return ( 0 ) ; } ire_refrele ( ire ) ; } sec_opt_len = tsol2cipso_tt1 ( & tsl -> tsl_label , opt_storage , tsl -> tsl_doi ) ; if ( sec_opt_len == 0 ) { DTRACE_PROBE3 ( tx__tnopt__log__error__labeling__lostops__v4 , char * , "options lack length for dest ip(1) with label(2)." , ipaddr_t , dst , ts_label_t * , tsl ) ; return ( EINVAL ) ; } return ( 0 ) ; } 