static void cmos_get_date_time ( struct tm * date ) { int base_year = 2000 , hour_offset ; int sec , min , hour , mday , mon , year ; time_t ts ; struct tm dummy ; sec = cmos_read ( RTC_SECONDS ) ; min = cmos_read ( RTC_MINUTES ) ; hour = cmos_read ( RTC_HOURS ) ; mday = cmos_read ( RTC_DAY_OF_MONTH ) ; mon = cmos_read ( RTC_MONTH ) ; year = cmos_read ( RTC_YEAR ) ; if ( ( cmos_read ( RTC_REG_B ) & REG_B_DM ) == 0 ) { sec = bcd2dec ( sec ) ; min = bcd2dec ( min ) ; hour = bcd2dec ( hour ) ; mday = bcd2dec ( mday ) ; mon = bcd2dec ( mon ) ; year = bcd2dec ( year ) ; hour_offset = 80 ; } else { hour_offset = 0x80 ; } if ( ( cmos_read ( 0x0B ) & REG_B_24H ) == 0 ) { if ( hour >= hour_offset ) { hour -= hour_offset ; hour += 12 ; } } ts = time ( NULL , NULL ) ; localtime_r ( & ts , & dummy ) ; date -> tm_isdst = dummy . tm_isdst ; date -> tm_sec = sec ; date -> tm_min = min ; date -> tm_hour = hour ; date -> tm_mday = mday ; date -> tm_mon = mon - 1 ; date -> tm_year = base_year + year - 1900 ; date -> tm_gmtoff = 0 ; ts = mktime ( date ) ; } 