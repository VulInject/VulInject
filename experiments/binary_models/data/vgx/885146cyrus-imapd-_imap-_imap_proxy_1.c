static void proxy_part_filldata ( partlist_t * part_list , int idx ) { char mytag [ 128 ] ; struct backend * be ; partitem_t * item = & part_list -> items [ idx ] ; item -> id = 0 ; item -> available = 0 ; item -> total = 0 ; item -> quota = 0. ; syslog ( LOG_DEBUG , "checking free space on server '%s'" , item -> value ) ; be = proxy_findserver ( item -> value , & imap_protocol , proxy_userid , & backend_cached , & backend_current , & backend_inbox , imapd_in ) ; if ( be ) { int server_available = 0 ; uint64_t server_total = 0 ; const char * annot = ( part_list -> mode == PART_SELECT_MODE_FREESPACE_MOST ) ?"freespace/total" : "freespace/percent/most" ; struct buf cmd = BUF_INITIALIZER ; int c ; proxy_gentag ( mytag , sizeof ( mytag ) ) ; if ( CAPA ( be , CAPA_METADATA ) ) { buf_printf ( & cmd , "METADATA \"\" (\"/shared" IMAP_ANNOT_NS "%s\"" , annot ) ; } else { buf_printf ( & cmd , "ANNOTATION \"\" \"" IMAP_ANNOT_NS "%s\" " "(\"value.shared\"" , annot ) ; } prot_printf ( be -> out , "%s GET%s)\r\n" , mytag , buf_cstring ( & cmd ) ) ; prot_flush ( be -> out ) ; for ( ; ; ) { c = prot_getc ( be -> in ) ; if ( c != '*' ) { break ; } c = prot_getc ( be -> in ) ; if ( c != ' ' ) { c = EOF ; break ; } c = chomp ( be -> in , buf_cstring ( & cmd ) ) ; if ( c == ' ' ) { c = prot_getc ( be -> in ) ; } if ( ( c == EOF ) || ( c != '\"' ) ) { eatline ( be -> in , c ) ; continue ; } c = getuint64 ( be -> in , & server_available ) ; if ( c != ';' ) { c = EOF ; break ; } c = getuint64 ( be -> in , & server_total ) ; if ( c != '\"' ) { c = EOF ; break ; } eatline ( be -> in , c ) ; } buf_free ( & cmd ) ; if ( c != EOF ) { prot_ungetc ( c , be -> in ) ; eatline ( be -> in , c ) ; } if ( c == EOF ) { fatal ( "Lost connection to backend" , EX_UNAVAILABLE ) ; } item -> id = idx ; item -> available = server_available ; item -> total = server_total ; } } 