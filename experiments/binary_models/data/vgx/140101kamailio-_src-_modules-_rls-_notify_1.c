void rls_notify_callback ( struct cell * t , int type , struct tmcb_params * ps ) { if ( ps -> param == NULL || * ps -> param == NULL || ( ( dialog_id_t * ) ( * ps -> param ) ) == NULL ) { LM_DBG ( "message id not received\n" ) ; return ; } LM_DBG ( "completed with status %d [to_tag:" "%.*s]\n" , ps -> code , ( ( dialog_id_t * ) ( * ps -> param ) ) -> to_tag . len , ( ( dialog_id_t * ) ( * ps -> param ) ) -> to_tag . s ) ; if ( ps -> code >= 300 ) { db_key_t db_keys [ 2 ] ; db_val_t db_vals [ 2 ] ; unsigned int hash_code ; subs_t subs ; subs . to_tag = ( ( dialog_id_t * ) ( * ps -> param ) ) -> to_tag ; subs . from_tag = ( ( dialog_id_t * ) ( * ps -> param ) ) -> from_tag ; subs . callid = ( ( dialog_id_t * ) ( * ps -> param ) ) -> callid ; if ( dbmode != RLS_DB_ONLY ) { hash_code = core_hash ( & subs . callid , & subs . to_tag , hash_size ) ; if ( pres_delete_shtable ( rls_table , hash_code , & subs ) < 0 ) { LM_ERR ( "record not found in hash table\n" ) ; } if ( rls_dbf . use_table ( rls_db , & rlsubs_table ) < 0 ) { LM_ERR ( "in use_table\n" ) ; done } db_keys [ 0 ] = & str_to_tag_col ; db_vals [ 0 ] . type = DB1_STR ; db_vals [ 0 ] . nul = 0 ; db_vals [ 0 ] . val . str_val = subs . to_tag ; db_keys [ 1 ] = & str_callid_col ; db_vals [ 1 ] . type = DB1_STR ; db_vals [ 1 ] . nul = 0 ; db_vals [ 1 ] . val . str_val = subs . callid ; if ( rls_dbf . delete ( rls_db , db_keys , 0 , db_vals , 2 ) < 0 ) { LM_ERR ( "cleaning expired messages\n" ) ; } } else { if ( delete_rlsdb ( & subs . callid , & subs . to_tag , NULL ) < 0 ) { LM_ERR ( "unable to delete record from DB\n" ) ; } } } done if ( * ps -> param != NULL ) { shm_free ( * ps -> param ) ; } return ; } 