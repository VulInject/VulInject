static int _snippet_get ( jmap_req_t * req , json_t * filter , json_t * messageids , json_t * jemailpartids , json_t * * snippets , json_t * * notfound ) { struct index_state * state = NULL ; void * intquery = NULL ; search_builder_t * bx = NULL ; search_text_receiver_t * rx = NULL ; struct mailbox * mbox = NULL ; struct searchargs * searchargs = NULL ; struct index_init init ; json_t * snippet = NULL ; int r = 0 ; json_t * val ; size_t i ; char * mboxname = NULL ; static search_snippet_markup_t markup = { "<mark>" "</mark>" "..." } ; strarray_t partids = STRARRAY_INITIALIZER ; strarray_t perf_filters = STRARRAY_INITIALIZER ; ptrarray_t search_attrs = PTRARRAY_INITIALIZER ; * snippets = json_array ( ) ; * notfound = json_array ( ) ; struct snippet_receiver sr = { { _snippet_tr_begin_mailbox _snippet_tr_first_unindexed_uid _snippet_tr_is_indexed _snippet_tr_begin_message _snippet_tr_begin_bodypart _snippet_tr_begin_part _snippet_tr_append_text _snippet_tr_end_part _snippet_tr_end_bodypart _snippet_tr_end_message _snippet_tr_end_mailbox _snippet_tr_flush _snippet_tr_audit_mailbox _snippet_tr_index_charset_flags _snippet_tr_index_message_format } NULL NULL NULL 0 BUF_INITIALIZER NULL } ; searchargs = new_searchargs ( NULL , GETSEARCH_CHARSET_FIRST , & jmap_namespace , req -> userid , req -> authstate , 0 ) ; searchargs -> root = _email_buildsearchexpr ( req , filter , NULL , NULL , 0 , & search_attrs , & perf_filters ) ; memset ( & init , 0 , sizeof ( init ) ) ; init . userid = req -> userid ; init . authstate = req -> authstate ; init . examine_mode = 1 ; char * qmboxname = search_expr_firstmailbox ( searchargs -> root ) ; if ( ! qmboxname ) { qmboxname = mboxname_user_mbox ( req -> accountid , NULL ) ; } r = index_open ( qmboxname , & init , & state ) ; if ( r ) { done } bx = search_begin_search ( state -> mailbox , SEARCH_MULTIPLE ) ; if ( ! bx ) { r = IMAP_INTERNAL ; done } search_build_query ( bx , searchargs -> root ) ; if ( ! bx -> get_internalised ) { r = IMAP_INTERNAL ; done } intquery = bx -> get_internalised ( bx ) ; search_end_search ( bx ) ; if ( ! intquery ) { r = IMAP_INTERNAL ; done } snippet = json_object ( ) ; struct search_text_receiver * srx = ( search_text_receiver * ) & sr ; rx = search_begin_snippets ( intquery , 0 , & markup , _snippet_get_cb , & sr ) ; if ( ! rx ) { r = IMAP_INTERNAL ; done } sr . next = rx ; sr . snippet = snippet ; if ( jemailpartids ) { sr . partids = & partids ; } json_array_foreach ( , , ) { message_t * msg ; msgrecord_t * mr = NULL ; uint32_t uid ; const char * msgid = json_string_value ( val ) ; r = jmap_email_find ( req , NULL , msgid , & mboxname , & uid ) ; if ( r ) { if ( r == IMAP_NOTFOUND ) { json_array_append_new ( * notfound , json_string ( msgid ) ) ; } r = 0 ; continue ; } r = jmap_openmbox ( req , mboxname , & mbox , 0 ) ; if ( r ) { doneloop } r = msgrecord_find ( mbox , uid , & mr ) ; if ( r ) { doneloop } r = msgrecord_get_message ( mr , & msg ) ; if ( r ) { doneloop } json_t * jpartids = json_object_get ( jemailpartids , msgid ) ; if ( jpartids ) { json_t * jpartid ; size_t j ; json_array_foreach ( , , ) { strarray_append ( & partids , json_string_value ( jpartid ) ) ; } } json_object_set_new ( snippet , "emailId" , json_string ( msgid ) ) ; json_object_set_new ( snippet , "subject" , json_null ( ) ) ; json_object_set_new ( snippet , "preview" , json_null ( ) ) ; json_object_set_new ( snippet , "attachments" , json_object ( ) ) ; sr . snippet = snippet ; r = srx -> begin_mailbox ( srx , mbox , 0 ) ; if ( ! r ) { r = index_getsearchtext ( msg , jpartids ?& partids : NULL , srx , INDEX_GETSEARCHTEXT_SNIPPET ) ; } if ( ! r || r == IMAP_OK_COMPLETED ) { json_t * jattachments = json_object_get ( snippet , "attachments" ) ; json_t * jmatch ; const char * part_id ; void * tmp ; json_object_foreach_safe ( , , , ) { if ( strarray_find ( & partids , part_id , 0 ) < 0 ) { json_object_del ( jattachments , part_id ) ; } } if ( ! json_object_size ( jattachments ) ) { json_object_set_new ( snippet , "attachments" , json_null ( ) ) ; } json_array_append_new ( * snippets , json_deep_copy ( snippet ) ) ; r = 0 ; } int r2 = srx -> end_mailbox ( srx , mbox ) ; if ( ! r ) { r = r2 ; } json_object_clear ( snippet ) ; strarray_truncate ( & partids , 0 ) ; msgrecord_unref ( & mr ) ; buf_reset ( & sr . buf ) ; doneloop if ( mr ) { msgrecord_unref ( & mr ) ; } jmap_closembox ( req , & mbox ) ; free ( mboxname ) ; mboxname = NULL ; if ( r ) { done } } if ( ! json_array_size ( * notfound ) ) { json_decref ( * notfound ) ; * notfound = json_null ( ) ; } done if ( rx ) { search_end_snippets ( rx ) ; } if ( snippet ) { json_decref ( snippet ) ; } if ( intquery ) { search_free_internalised ( intquery ) ; } if ( mboxname ) { free ( mboxname ) ; } if ( mbox ) { jmap_closembox ( req , & mbox ) ; } if ( searchargs ) { freesearchargs ( searchargs ) ; } strarray_fini ( & perf_filters ) ; if ( ptrarray_size ( & search_attrs ) ) { search_attr_t * attr ; while ( ( attr = ptrarray_pop ( & search_attrs ) ) ) { if ( attr -> freeattr ) { attr -> freeattr ( & attr ) ; } } } ptrarray_fini ( & search_attrs ) ; strarray_fini ( & partids ) ; index_close ( & state ) ; buf_free ( & sr . buf ) ; return r ; } 