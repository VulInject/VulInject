int ire_revalidate_nce ( ire_t * ire ) { nce_t * nce , * old_nce ; ire_t * nexthop ; ASSERT ( ! ire -> ire_testhidden || ! IS_IPMP ( ire -> ire_ill ) ) ; nexthop = ire_nexthop ( ire ) ; if ( nexthop == NULL ) { ( void ) ire_no_good ( ire ) ; return ( ENETUNREACH ) ; } if ( ire -> ire_type & ( IRE_LOCAL | IRE_LOOPBACK ) ) { ASSERT ( ire -> ire_ill != NULL ) ; if ( ire -> ire_ipversion == IPV4_VERSION ) { nce = nce_lookup_v4 ( ire -> ire_ill , & ire -> ire_addr ) ; } else { nce = nce_lookup_v6 ( ire -> ire_ill , & ire -> ire_addr_v6 ) ; } } else { ASSERT ( nexthop -> ire_type & IRE_ONLINK ) ; if ( ire -> ire_ipversion == IPV4_VERSION ) { nce = arp_nce_init ( nexthop -> ire_ill , nexthop -> ire_addr , nexthop -> ire_type ) ; } else { nce = ndp_nce_init ( nexthop -> ire_ill , & nexthop -> ire_addr_v6 , nexthop -> ire_type ) ; } } if ( nce == NULL ) { ire_refrele ( nexthop ) ; return ( ENOMEM ) ; } if ( nexthop != ire ) { mutex_enter ( & nexthop -> ire_lock ) ; old_nce = nexthop -> ire_nce_cache ; if ( ! IRE_IS_CONDEMNED ( nexthop ) ) { nce_refhold ( nce ) ; nexthop -> ire_nce_cache = nce ; } else { nexthop -> ire_nce_cache = NULL ; } mutex_exit ( & nexthop -> ire_lock ) ; if ( old_nce != NULL ) { nce_refrele ( old_nce ) ; } } ire_refrele ( nexthop ) ; mutex_enter ( & ire -> ire_lock ) ; old_nce = ire -> ire_nce_cache ; if ( ! IRE_IS_CONDEMNED ( ire ) ) { nce_refhold ( nce ) ; ire -> ire_nce_cache = nce ; } else { ire -> ire_nce_cache = NULL ; } mutex_exit ( & ire -> ire_lock ) ; if ( old_nce != NULL ) { nce_refrele ( old_nce ) ; } nce_refrele ( nce ) ; return ( 0 ) ; } 