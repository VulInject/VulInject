int dwarf_global_formref ( Dwarf_Attribute attr , Dwarf_Off * ret_offset , Dwarf_Error * error ) { Dwarf_Debug dbg = 0 ; Dwarf_Unsigned offset = 0 ; Dwarf_CU_Context cu_context = 0 ; Dwarf_Half context_version = 0 ; Dwarf_Byte_Ptr section_end = 0 ; int res = get_attr_dbg ( & dbg , & cu_context , attr , error ) ; section_end = _dwarf_calculate_info_section_end_ptr ( cu_context ) ; context_version = cu_context -> cc_version_stamp ; switch ( attr -> ar_attribute_form ) { case DW_FORM_ref1 : offset = * ( Dwarf_Small * ) attr -> ar_debug_ptr ; fixoffset case DW_FORM_ref2 : READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_HALF_SIZE , error , section_end ) ; fixoffset case DW_FORM_ref4 : READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_32BIT_SIZE , error , section_end ) ; fixoffset case DW_FORM_ref8 : READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_64BIT_SIZE , error , section_end ) ; fixoffset case DW_FORM_ref_udata : { Dwarf_Byte_Ptr ptr = attr -> ar_debug_ptr ; Dwarf_Unsigned localoffset = 0 ; DECODE_LEB128_UWORD_CK ( ptr , localoffset , dbg , error , section_end ) ; offset = localoffset ; fixoffset if ( offset >= cu_context -> cc_length + cu_context -> cc_length_size + cu_context -> cc_extension_size ) { _dwarf_error ( dbg , error , DW_DLE_ATTR_FORM_OFFSET_BAD ) ; return ( DW_DLV_ERROR ) ; } offset += cu_context -> cc_debug_offset ; } break ; case DW_FORM_data4 : if ( context_version >= DW_CU_VERSION4 ) { _dwarf_error ( dbg , error , DW_DLE_NOT_REF_FORM ) ; return ( DW_DLV_ERROR ) ; } READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_32BIT_SIZE , error , section_end ) ; break ; case DW_FORM_data8 : if ( context_version >= DW_CU_VERSION4 ) { _dwarf_error ( dbg , error , DW_DLE_NOT_REF_FORM ) ; return ( DW_DLV_ERROR ) ; } READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_64BIT_SIZE , error , section_end ) ; break ; case DW_FORM_ref_addr : { unsigned length_size = 0 ; if ( context_version == 2 ) { length_size = cu_context -> cc_address_size ; } else { length_size = cu_context -> cc_length_size ; } if ( length_size == 4 ) { READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_32BIT_SIZE , error , section_end ) ; } if ( length_size == 8 ) { READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_64BIT_SIZE , error , section_end ) ; } else { _dwarf_error ( dbg , error , DW_DLE_FORM_SEC_OFFSET_LENGTH_BAD ) ; return ( DW_DLV_ERROR ) ; } } break ; case DW_FORM_rnglistx : { unsigned length_size = cu_context -> cc_length_size ; READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , length_size , error , section_end ) ; } break ; case DW_FORM_sec_offset : case DW_FORM_GNU_ref_alt : case DW_FORM_GNU_strp_alt : case DW_FORM_strp_sup : case DW_FORM_line_strp : { unsigned length_size = cu_context -> cc_length_size ; if ( length_size == 4 ) { READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_32BIT_SIZE , error , section_end ) ; } if ( length_size == 8 ) { READ_UNALIGNED_CK ( dbg , offset , Dwarf_Unsigned , attr -> ar_debug_ptr , DWARF_64BIT_SIZE , error , section_end ) ; } else { _dwarf_error ( dbg , error , DW_DLE_FORM_SEC_OFFSET_LENGTH_BAD ) ; return ( DW_DLV_ERROR ) ; } } break ; case DW_FORM_ref_sig8 : _dwarf_error ( dbg , error , DW_DLE_REF_SIG8_NOT_HANDLED ) ; return ( DW_DLV_ERROR ) ; default : { dwarfstring m ; int formcode = attr -> ar_attribute_form ; int fcres = 0 ; const char * name = 0 ; dwarfstring_constructor ( & m ) ; dwarfstring_append_printf_u ( & m , "DW_DLE_BAD_REF_FORM: The form code is 0x%x " , formcode ) ; fcres = dwarf_get_FORM_name ( formcode , & name ) ; if ( fcres != DW_DLV_OK ) { name = "<UnknownFormCode>" ; } dwarfstring_append_printf_s ( & m , " %s." , ( char * ) name ) ; _dwarf_error_string ( dbg , error , DW_DLE_BAD_REF_FORM , dwarfstring_string ( & m ) ) ; dwarfstring_destructor ( & m ) ; return DW_DLV_ERROR ; } } * ret_offset = offset ; return DW_DLV_OK ; } 