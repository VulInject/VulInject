static void fec_enet_free_buffers ( struct net_device * ndev ) { struct fec_enet_private * fep = netdev_priv ( ndev ) ; unsigned int i ; struct sk_buff * skb ; struct bufdesc * bdp ; struct fec_enet_priv_tx_q * txq ; struct fec_enet_priv_rx_q * rxq ; unsigned int q ; for ( q = 0 ; q < fep -> num_rx_queues ; q ++ ) { rxq = fep -> rx_queue [ q ] ; bdp = rxq -> bd . base ; for ( i = 0 ; i < rxq -> bd . ring_size ; i ++ ) { skb = rxq -> rx_skbuff [ i ] ; rxq -> rx_skbuff [ i ] = NULL ; if ( skb ) { dma_unmap_single ( & fep -> pdev -> dev , fec32_to_cpu ( bdp -> cbd_bufaddr ) , FEC_ENET_RX_FRSIZE - fep -> rx_align , DMA_FROM_DEVICE ) ; dev_kfree_skb ( skb ) ; } bdp = fec_enet_get_nextdesc ( bdp , & rxq -> bd ) ; } } for ( q = 0 ; q < fep -> num_tx_queues ; q ++ ) { txq = fep -> tx_queue [ q ] ; bdp = txq -> bd . base ; for ( i = 0 ; i < txq -> bd . ring_size ; i ++ ) { txq -> tx_bounce [ i ] = NULL ; skb = txq -> tx_skbuff [ i ] ; txq -> tx_skbuff [ i ] = NULL ; dev_kfree_skb ( skb ) ; } } } 