static void init_rarpdev ( struct rarpdev * rdev ) { char * dev ; int unit ; struct ifdev * ifdev ; int retval ; char * str = NULL ; uint_t physaddrlen = DLPI_PHYSADDR_MAX ; char linkname [ DLPI_LINKNAME_MAX ] ; dlpi_handle_t dh ; ( void ) snprintf ( linkname , DLPI_LINKNAME_MAX , "%s%d" , rdev -> device , rdev -> unit ) ; if ( ( retval = dlpi_open ( linkname , & dh , 0 ) ) != DLPI_SUCCESS ) { error ( "cannot open link %s: %s" , linkname , dlpi_strerror ( retval ) ) ; } if ( ( retval = dlpi_bind ( dh , ETHERTYPE_REVARP , NULL ) ) != DLPI_SUCCESS ) { dlpi_close ( dh , NULL ) ; error ( "dlpi_bind failed: %s" , dlpi_strerror ( retval ) ) ; } if ( ( retval = dlpi_get_physaddr ( dh , DL_CURR_PHYS_ADDR , rdev -> physaddr , & physaddrlen ) ) != DLPI_SUCCESS ) { dlpi_close ( dh ) ; error ( "dlpi_get_physaddr failed: %s" , dlpi_strerror ( retval ) ) ; } rdev -> physaddrlen = physaddrlen ; rdev -> ifrarplen = sizeof ( arphdr ) + ( 2 * sizeof ( ipaddr_t ) ) + ( 2 * physaddrlen ) ; if ( dflag ) { str = _link_ntoa ( rdev -> physaddr , str , rdev -> physaddrlen , IFT_OTHER ) ; if ( str != NULL ) { debug ( "device %s physical address %s" , linkname , str ) ; free ( str ) ; } } rdev -> dh_rarp = dh ; for ( ifdev = rdev -> ifdev ; ifdev != NULL ; ifdev = ifdev -> next ) { if ( ifdev -> lunit == - 1 ) { dev = rdev -> device ; unit = rdev -> unit ; } else { dev = ifdev -> ldevice ; unit = ifdev -> lunit ; } get_ifdata ( dev , unit , & ifdev -> if_ipaddr , & ifdev -> if_netmask ) ; ifdev -> if_netnum = ifdev -> if_ipaddr & ifdev -> if_netmask ; ifdev -> ipaddr = ( ipaddr_t ) htonl ( ifdev -> if_ipaddr ) ; } } 