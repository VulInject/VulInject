static int btt_rw_integrity ( struct btt * btt , struct bio_integrity_payload * bip , struct arena_info * arena , u32 postmap , int rw ) { unsigned int len = btt_meta_size ( btt ) ; u64 meta_nsoff ; int ret = 0 ; meta_nsoff = to_namespace_offset ( arena , postmap ) + btt -> sector_size ; while ( len ) { unsigned int cur_len ; struct bio_vec bv ; void * mem ; bv = bvec_iter_bvec ( bip -> bip_vec , bip -> bip_iter ) ; cur_len = min ( len , bv . bv_len ) ; mem = bvec_kmap_local ( & bv ) ; if ( rw ) { ret = arena_write_bytes ( arena , meta_nsoff , mem , cur_len , NVDIMM_IO_ATOMIC ) ; } else { ret = arena_read_bytes ( arena , meta_nsoff , mem , cur_len , NVDIMM_IO_ATOMIC ) ; } kunmap_local ( mem ) ; if ( ret ) { return ret ; } len -= cur_len ; meta_nsoff += cur_len ; if ( ! bvec_iter_advance ( bip -> bip_vec , & bip -> bip_iter , cur_len ) ) { return - EIO ; } } return ret ; } 