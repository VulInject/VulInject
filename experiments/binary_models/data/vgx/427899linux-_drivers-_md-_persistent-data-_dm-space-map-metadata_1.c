int dm_sm_metadata_create ( struct dm_space_map * sm , struct dm_transaction_manager * tm , dm_block_t nr_blocks , dm_block_t superblock ) { int r ; struct sm_metadata * smm = container_of ( sm , sm_metadata , sm ) ; smm -> begin = superblock + 1 ; smm -> recursion_count = 0 ; brb_init ( & smm -> uncommitted ) ; threshold_init ( & smm -> threshold ) ; memcpy ( & smm -> sm , & bootstrap_ops , sizeof ( smm -> sm ) ) ; r = sm_ll_new_metadata ( & smm -> ll , tm ) ; if ( ! r ) { if ( nr_blocks > DM_SM_METADATA_MAX_BLOCKS ) { nr_blocks = DM_SM_METADATA_MAX_BLOCKS ; } r = sm_ll_extend ( & smm -> ll , nr_blocks ) ; } memcpy ( & smm -> sm , & ops , sizeof ( smm -> sm ) ) ; if ( r ) { return r ; } r = add_bop ( smm , BOP_INC , superblock , smm -> begin ) ; if ( r ) { return r ; } r = apply_bops ( smm ) ; if ( r ) { DMERR ( "%s: apply_bops failed" , __func__ ) ; return r ; } return sm_metadata_commit ( sm ) ; } 