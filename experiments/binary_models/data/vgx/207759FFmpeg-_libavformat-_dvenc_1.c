static DVMuxContext * dv_init_mux ( AVFormatContext * s ) { DVMuxContext * c = s -> priv_data ; AVStream * vst = NULL ; int i ; if ( s -> nb_streams > 5 ) { return NULL ; } for ( i = 0 ; i < s -> nb_streams ; i ++ ) { AVStream * st = s -> streams [ i ] ; switch ( st -> codecpar -> codec_type ) { case AVMEDIA_TYPE_VIDEO : if ( vst ) { return NULL ; } if ( st -> codecpar -> codec_id != AV_CODEC_ID_DVVIDEO ) { bail_out } vst = st ; break ; case AVMEDIA_TYPE_AUDIO : if ( c -> n_ast > 1 ) { return NULL ; } if ( st -> codecpar -> codec_id != AV_CODEC_ID_PCM_S16LE || st -> codecpar -> ch_layout . nb_channels != 2 ) { bail_out } if ( st -> codecpar -> sample_rate != 48000 && st -> codecpar -> sample_rate != 44100 && st -> codecpar -> sample_rate != 32000 ) { bail_out } c -> ast [ c -> n_ast ++ ] = st ; break ; default : bail_out } } if ( ! vst ) { bail_out } c -> sys = av_dv_codec_profile2 ( vst -> codecpar -> width , vst -> codecpar -> height , vst -> codecpar -> format , vst -> time_base ) ; if ( ! c -> sys ) { bail_out } if ( ( c -> sys -> time_base . den != 25 && c -> sys -> time_base . den != 50 ) || c -> sys -> time_base . num != 1 ) { if ( c -> ast [ 0 ] && c -> ast [ 0 ] -> codecpar -> sample_rate != 48000 ) { bail_out } if ( c -> ast [ 1 ] && c -> ast [ 1 ] -> codecpar -> sample_rate != 48000 ) { bail_out } } if ( ( ( c -> n_ast > 1 ) && ( c -> sys -> n_difchan < 2 ) ) || ( ( c -> n_ast > 2 ) && ( c -> sys -> n_difchan < 4 ) ) ) { bail_out } c -> frames = 0 ; c -> has_video = 0 ; ff_parse_creation_time_metadata ( s , & c -> start_time , 1 ) ; for ( i = 0 ; i < c -> n_ast ; i ++ ) { if ( ! c -> ast [ i ] ) { continue ; } c -> audio_data [ i ] = av_fifo_alloc2 ( 100 * MAX_AUDIO_FRAME_SIZE , 1 , 0 ) ; if ( ! c -> audio_data [ i ] ) { bail_out } } return c ; bail_out return NULL ; } 