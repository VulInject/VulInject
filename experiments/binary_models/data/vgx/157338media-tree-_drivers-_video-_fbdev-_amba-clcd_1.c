static int clcdfb_of_init_display ( struct clcd_fb * fb ) { struct device_node * endpoint , * panel ; int err ; unsigned int bpp ; u32 max_bandwidth ; u32 tft_r0b0g0 [ 3 ] ; fb -> panel = devm_kzalloc ( & fb -> dev -> dev , sizeof ( * fb -> panel ) , GFP_KERNEL ) ; if ( ! fb -> panel ) { return - ENOMEM ; } endpoint = of_graph_get_next_endpoint ( fb -> dev -> dev . of_node , NULL ) ; panel = of_graph_get_remote_port_parent ( endpoint ) ; if ( ! panel ) { return - ENODEV ; } if ( fb -> vendor -> init_panel ) { err = fb -> vendor -> init_panel ( fb , panel ) ; if ( err ) { return err ; } } err = clcdfb_of_get_backlight ( panel , fb -> panel ) ; if ( err ) { return err ; } err = clcdfb_of_get_mode ( & fb -> dev -> dev , panel , fb -> panel ) ; if ( err ) { return err ; } err = of_property_read_u32 ( fb -> dev -> dev . of_node , "max-memory-bandwidth" , & max_bandwidth ) ; if ( ! err ) { bpp = max_bandwidth / ( 1000 / 8 ) / PICOS2KHZ ( fb -> panel -> mode . pixclock ) ; bpp = rounddown_pow_of_two ( bpp ) ; if ( bpp > 32 ) { bpp = 32 ; } } else { bpp = 32 ; } fb -> panel -> bpp = bpp ; fb -> panel -> cntl |= CNTL_BEBO ; fb -> panel -> width = - 1 ; fb -> panel -> height = - 1 ; if ( of_property_read_u32_array ( endpoint , "arm,pl11x,tft-r0g0b0-pads" , tft_r0b0g0 , ARRAY_SIZE ( tft_r0b0g0 ) ) != 0 ) { return - ENOENT ; } return clcdfb_of_init_tft_panel ( fb , tft_r0b0g0 [ 0 ] , tft_r0b0g0 [ 1 ] , tft_r0b0g0 [ 2 ] ) ; } 