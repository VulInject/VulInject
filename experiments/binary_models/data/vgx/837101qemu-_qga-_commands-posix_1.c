GuestDiskInfoList * qmp_guest_get_disks ( Error * * errp ) { GuestDiskInfoList * ret ; GuestDiskInfo * disk ; DIR * dp = NULL ; struct dirent * de = NULL ; g_debug ( "listing /sys/block directory" ) ; dp = opendir ( "/sys/block" ) ; if ( dp == NULL ) { error_setg_errno ( errp , errno , "Can't open directory \"/sys/block\"" ) ; return NULL ; } while ( ( de = readdir ( dp ) ) != NULL ) { g_autofree char * disk_dir = NULL , * line = NULL , * size_path = NULL ; char * dev_name ; Error * local_err = NULL ; if ( de -> d_type != DT_LNK ) { g_debug ( "  skipping entry: %s" , de -> d_name ) ; continue ; } g_debug ( "  checking disk size" ) ; size_path = g_strdup_printf ( "/sys/block/%s/size" , de -> d_name ) ; if ( ! g_file_get_contents ( size_path , & line , NULL , NULL ) ) { g_debug ( "  failed to read disk size" ) ; continue ; } if ( g_strcmp0 ( line , "0\n" ) == 0 ) { g_debug ( "  skipping zero-sized disk" ) ; continue ; } g_debug ( "  adding %s" , de -> d_name ) ; disk_dir = g_strdup_printf ( "/sys/block/%s" , de -> d_name ) ; dev_name = get_device_for_syspath ( disk_dir ) ; if ( dev_name == NULL ) { g_debug ( "Failed to get device name for syspath: %s" , disk_dir ) ; continue ; } disk = g_new0 ( GuestDiskInfo , 1 ) ; disk -> name = dev_name ; disk -> partition = false ; disk -> alias = get_alias_for_syspath ( disk_dir ) ; disk -> has_alias = ( disk -> alias != NULL ) ; QAPI_LIST_PREPEND ( ret , disk ) ; bool is_virtual = is_disk_virtual ( disk_dir , & local_err ) ; if ( local_err != NULL ) { g_debug ( "  failed to check disk path, ignoring error: %s" , error_get_pretty ( local_err ) ) ; error_free ( local_err ) ; local_err = NULL ; is_virtual = true ; } if ( ! is_virtual ) { disk -> address = get_disk_address ( disk_dir , & local_err ) ; if ( local_err != NULL ) { g_debug ( "  failed to get device info, ignoring error: %s" , error_get_pretty ( local_err ) ) ; error_free ( local_err ) ; local_err = NULL ; } if ( disk -> address != NULL ) { disk -> has_address = true ; } } get_disk_deps ( disk_dir , disk ) ; ret = get_disk_partitions ( ret , de -> d_name , disk_dir , dev_name ) ; } closedir ( dp ) ; return ret ; } 