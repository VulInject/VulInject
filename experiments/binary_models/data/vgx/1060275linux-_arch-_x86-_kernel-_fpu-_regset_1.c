int xstateregs_set ( struct task_struct * target , const struct user_regset * regset , unsigned int pos , unsigned int count , const void * kbuf , const void __user * ubuf ) { struct fpu * fpu = & target -> thread . fpu ; struct xregs_state * tmpbuf = NULL ; int ret ; if ( pos != 0 || count != fpu_user_cfg . max_size ) { return - EFAULT ; } if ( ! kbuf ) { tmpbuf = vmalloc ( count ) ; if ( ! tmpbuf ) { return - ENOMEM ; } if ( copy_from_user ( tmpbuf , ubuf , count ) ) { ret = - EFAULT ; out } } fpu_force_restore ( fpu ) ; ret = copy_uabi_from_kernel_to_xstate ( fpu -> fpstate , kbuf ?: tmpbuf , & target -> thread . pkru ) ; out vfree ( tmpbuf ) ; return ret ; } 