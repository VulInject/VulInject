static int pci_fire_dequeue_msi ( struct pci_pbm_info * pbm , unsigned long msiqid , unsigned long * head , unsigned long * msi ) { unsigned long type_fmt , type , msi_num ; struct pci_msiq_entry * base , * ep ; base = ( pbm -> msi_queues + ( ( msiqid - pbm -> msiq_first ) * 8192 ) ) ; ep = & base [ * head ] ; if ( ( ep -> word0 & MSIQ_WORD0_FMT_TYPE ) == 0 ) { return 0 ; } type_fmt = ( ( ep -> word0 & MSIQ_WORD0_FMT_TYPE ) >> MSIQ_WORD0_FMT_TYPE_SHIFT ) ; type = ( type_fmt >> 3 ) ; * msi = msi_num = ( ( ep -> word0 & MSIQ_WORD0_DATA0 ) >> MSIQ_WORD0_DATA0_SHIFT ) ; upa_writeq ( MSI_CLEAR_EQWR_N , pbm -> pbm_regs + MSI_CLEAR ( msi_num ) ) ; ep -> word0 &= ~ MSIQ_WORD0_FMT_TYPE ; ( * head ) ++ ; if ( * head >= pbm -> msiq_ent_count ) { * head = 0 ; } return 1 ; } 