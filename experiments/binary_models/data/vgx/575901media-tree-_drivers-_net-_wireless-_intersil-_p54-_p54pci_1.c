static void p54p_stop ( struct ieee80211_hw * dev ) { struct p54p_priv * priv = dev -> priv ; struct p54p_ring_control * ring_control = priv -> ring_control ; int i ; struct p54p_desc * desc ; P54P_WRITE ( int_enable , cpu_to_le32 ( 0 ) ) ; P54P_READ ( int_enable ) ; udelay ( 10 ) ; free_irq ( priv -> pdev -> irq , dev ) ; tasklet_kill ( & priv -> tasklet ) ; P54P_WRITE ( dev_int , cpu_to_le32 ( ISL38XX_DEV_INT_RESET ) ) ; for ( i = 0 ; i < ARRAY_SIZE ( priv -> rx_buf_data ) ; i ++ ) { desc = & ring_control -> rx_data [ i ] ; if ( desc -> host_addr ) { pci_unmap_single ( priv -> pdev , le32_to_cpu ( desc -> host_addr ) , priv -> common . rx_mtu + 32 , PCI_DMA_FROMDEVICE ) ; } kfree_skb ( priv -> rx_buf_data [ i ] ) ; priv -> rx_buf_data [ i ] = NULL ; } for ( i = 0 ; i < ARRAY_SIZE ( priv -> rx_buf_mgmt ) ; i ++ ) { desc = & ring_control -> rx_mgmt [ i ] ; if ( desc -> host_addr ) { pci_unmap_single ( priv -> pdev , le32_to_cpu ( desc -> host_addr ) , priv -> common . rx_mtu + 32 , PCI_DMA_FROMDEVICE ) ; } kfree_skb ( priv -> rx_buf_mgmt [ i ] ) ; priv -> rx_buf_mgmt [ i ] = NULL ; } for ( i = 0 ; i < ARRAY_SIZE ( priv -> tx_buf_data ) ; i ++ ) { desc = & ring_control -> tx_data [ i ] ; if ( desc -> host_addr ) { pci_unmap_single ( priv -> pdev , le32_to_cpu ( desc -> host_addr ) , le16_to_cpu ( desc -> len ) , PCI_DMA_TODEVICE ) ; } p54_free_skb ( dev , priv -> tx_buf_data [ i ] ) ; priv -> tx_buf_data [ i ] = NULL ; } for ( i = 0 ; i < ARRAY_SIZE ( priv -> tx_buf_mgmt ) ; i ++ ) { desc = & ring_control -> tx_mgmt [ i ] ; if ( desc -> host_addr ) { pci_unmap_single ( priv -> pdev , le32_to_cpu ( desc -> host_addr ) , le16_to_cpu ( desc -> len ) , PCI_DMA_TODEVICE ) ; } p54_free_skb ( dev , priv -> tx_buf_mgmt [ i ] ) ; priv -> tx_buf_mgmt [ i ] = NULL ; } memset ( ring_control , 0 , sizeof ( * ring_control ) ) ; } 