static int rtl8365mb_mib_counter_read ( struct realtek_priv * priv , int port , u32 offset , u32 length , u64 * mibvalue ) { int tmpvalue = 0 ; u32 val ; int ret ; int i ; ret = regmap_write ( priv -> map , RTL8365MB_MIB_ADDRESS_REG , RTL8365MB_MIB_ADDRESS ( port , offset ) ) ; if ( ret ) { return ret ; } ret = regmap_read_poll_timeout ( priv -> map , RTL8365MB_MIB_CTRL0_REG , val , ! ( val & RTL8365MB_MIB_CTRL0_BUSY_MASK ) , 10 , 100 ) ; if ( ret ) { return ret ; } if ( val & RTL8365MB_MIB_CTRL0_RESET_MASK ) { return - EIO ; } if ( length == 4 ) { offset = 3 ; } else { offset = ( offset + 1 ) % 4 ; } for ( i = 0 ; i < length ; i ++ ) { ret = regmap_read ( priv -> map , RTL8365MB_MIB_COUNTER_REG ( offset - i ) , & val ) ; if ( ret ) { return ret ; } tmpvalue = ( ( tmpvalue ) << 16 ) | ( val & 0xFFFF ) ; } * mibvalue = tmpvalue ; return 0 ; } 