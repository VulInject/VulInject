static ssize_t pwm_store ( struct device * dev , struct device_attribute * attr , const char * buf , size_t count ) { struct sensor_device_attribute_2 * sattr = to_sensor_dev_attr_2 ( attr ) ; struct adt7475_data * data = dev_get_drvdata ( dev ) ; struct i2c_client * client = data -> client ; unsigned char reg = 0 ; long val ; mutex_lock ( & data -> lock ) ; switch ( sattr -> nr ) { case INPUT : data -> pwm [ CONTROL ] [ sattr -> index ] = adt7475_read ( PWM_CONFIG_REG ( sattr -> index ) ) ; if ( ( ( data -> pwm [ CONTROL ] [ sattr -> index ] >> 5 ) & 7 ) != 7 ) { mutex_unlock ( & data -> lock ) ; return count ; } reg = PWM_REG ( sattr -> index ) ; break ; case MIN : reg = PWM_MIN_REG ( sattr -> index ) ; break ; case MAX : reg = PWM_MAX_REG ( sattr -> index ) ; break ; } data -> pwm [ sattr -> nr ] [ sattr -> index ] = clamp_val ( val , 0 , 0xFF ) ; i2c_smbus_write_byte_data ( client , reg , data -> pwm [ sattr -> nr ] [ sattr -> index ] ) ; mutex_unlock ( & data -> lock ) ; return count ; } 