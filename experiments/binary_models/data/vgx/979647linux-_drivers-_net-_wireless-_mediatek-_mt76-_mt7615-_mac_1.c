static void mt7615_mac_scs_check ( struct mt7615_phy * phy ) { struct mt7615_dev * dev = phy -> dev ; struct mib_stats * mib = & phy -> mib ; u32 val , rts_err_rate = 0 ; u32 mdrdy_cck , mdrdy_ofdm , pd_cck , pd_ofdm ; bool ext_phy = phy != & dev -> phy ; if ( is_mt7663 ( & dev -> mt76 ) ) { val = mt76_rr ( dev , MT7663_WF_PHY_R0_PHYCTRL_STS0 ( ext_phy ) ) ; } else { val = mt76_rr ( dev , MT_WF_PHY_R0_PHYCTRL_STS0 ( ext_phy ) ) ; } pd_cck = FIELD_GET ( MT_WF_PHYCTRL_STAT_PD_CCK , val ) ; pd_ofdm = FIELD_GET ( MT_WF_PHYCTRL_STAT_PD_OFDM , val ) ; if ( is_mt7663 ( & dev -> mt76 ) ) { val = mt76_rr ( dev , MT7663_WF_PHY_R0_PHYCTRL_STS5 ( ext_phy ) ) ; } else { val = mt76_rr ( dev , MT_WF_PHY_R0_PHYCTRL_STS5 ( ext_phy ) ) ; } mdrdy_cck = FIELD_GET ( MT_WF_PHYCTRL_STAT_MDRDY_CCK , val ) ; mdrdy_ofdm = FIELD_GET ( MT_WF_PHYCTRL_STAT_MDRDY_OFDM , val ) ; phy -> false_cca_ofdm = pd_ofdm - mdrdy_ofdm ; phy -> false_cca_cck = pd_cck - mdrdy_cck ; mt7615_mac_cca_stats_reset ( phy ) ; if ( mib -> rts_cnt + mib -> rts_retries_cnt ) { rts_err_rate = MT_FRAC ( mib -> rts_retries_cnt , mib -> rts_cnt + mib -> rts_retries_cnt ) ; } mt7615_mac_adjust_sensitivity ( phy , rts_err_rate , false ) ; mt7615_mac_adjust_sensitivity ( phy , rts_err_rate , true ) ; if ( time_after ( jiffies , phy -> last_cca_adj + 10 * HZ ) ) { mt7615_mac_set_default_sensitivity ( phy ) ; } } 