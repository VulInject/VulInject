int auth_krb5_password ( Authctxt * authctxt , const char * password ) { krb5_creds creds ; krb5_principal server ; krb5_error_code problem ; krb5_ccache ccache = NULL ; int len ; char * client , * platform_client ; const char * errmsg ; platform_client = platform_krb5_get_principal_name ( authctxt -> pw -> pw_name ) ; client = platform_client ?platform_client : authctxt -> pw -> pw_name ; temporarily_use_uid ( authctxt -> pw , NULL ) ; problem = krb5_init ( authctxt ) ; if ( problem ) { out } problem = krb5_parse_name ( authctxt -> krb5_ctx , client , & authctxt -> krb5_user ) ; if ( problem ) { out } problem = krb5_cc_new_unique ( authctxt -> krb5_ctx , krb5_mcc_ops . prefix , NULL , & ccache ) ; problem = krb5_cc_gen_new ( authctxt -> krb5_ctx , & krb5_mcc_ops , & ccache ) ; if ( problem ) { out } problem = krb5_cc_initialize ( authctxt -> krb5_ctx , ccache , authctxt -> krb5_user ) ; if ( problem ) { out } restore_uid ( ) ; problem = krb5_verify_user ( authctxt -> krb5_ctx , authctxt -> krb5_user , ccache , password , 1 , NULL ) ; temporarily_use_uid ( authctxt -> pw ) ; if ( problem ) { out } problem = krb5_cc_new_unique ( authctxt -> krb5_ctx , krb5_fcc_ops . prefix , NULL , & authctxt -> krb5_fwd_ccache ) ; problem = krb5_cc_gen_new ( authctxt -> krb5_ctx , & krb5_fcc_ops , & authctxt -> krb5_fwd_ccache ) ; if ( problem ) { out } problem = krb5_cc_copy_cache ( authctxt -> krb5_ctx , ccache , authctxt -> krb5_fwd_ccache ) ; krb5_cc_destroy ( authctxt -> krb5_ctx , ccache ) ; ccache = NULL ; if ( problem ) { out } problem = krb5_get_init_creds_password ( authctxt -> krb5_ctx , & creds , authctxt -> krb5_user , ( char * ) password , NULL , NULL , 0 , NULL , NULL ) ; if ( problem ) { out } problem = krb5_sname_to_principal ( authctxt -> krb5_ctx , NULL , NULL , KRB5_NT_SRV_HST , & server ) ; if ( problem ) { out } restore_uid ( ) ; problem = krb5_verify_init_creds ( authctxt -> krb5_ctx , & creds , server , NULL , NULL , NULL ) ; krb5_free_principal ( authctxt -> krb5_ctx , server ) ; temporarily_use_uid ( authctxt -> pw ) ; if ( problem ) { out } if ( ! krb5_kuserok ( authctxt -> krb5_ctx , authctxt -> krb5_user , authctxt -> pw -> pw_name ) ) { problem = - 1 ; out } problem = ssh_krb5_cc_gen ( authctxt -> krb5_ctx , & authctxt -> krb5_fwd_ccache ) ; if ( problem ) { out } problem = krb5_cc_initialize ( authctxt -> krb5_ctx , authctxt -> krb5_fwd_ccache , authctxt -> krb5_user ) ; if ( problem ) { out } problem = krb5_cc_store_cred ( authctxt -> krb5_ctx , authctxt -> krb5_fwd_ccache , & creds ) ; if ( problem ) { out } authctxt -> krb5_ticket_file = ( char * ) krb5_cc_get_name ( authctxt -> krb5_ctx , authctxt -> krb5_fwd_ccache ) ; len = strlen ( authctxt -> krb5_ticket_file ) + 6 ; authctxt -> krb5_ccname = xmalloc ( len ) ; snprintf ( authctxt -> krb5_ccname , len , "FILE:%s" , authctxt -> krb5_ticket_file ) ; if ( options . use_pam ) { do_pam_putenv ( "KRB5CCNAME" , authctxt -> krb5_ccname ) ; } out restore_uid ( ) ; free ( platform_client ) ; if ( problem ) { if ( ccache ) { krb5_cc_destroy ( authctxt -> krb5_ctx , ccache ) ; } if ( authctxt -> krb5_ctx != NULL && problem != - 1 ) { errmsg = krb5_get_error_message ( authctxt -> krb5_ctx , problem ) ; debug ( "Kerberos password authentication failed: %s" , errmsg ) ; krb5_free_error_message ( authctxt -> krb5_ctx , errmsg ) ; } else { debug ( "Kerberos password authentication failed: %d" , problem ) ; } krb5_cleanup_proc ( authctxt ) ; if ( options . kerberos_or_local_passwd ) { return ( - 1 ) ; } else { return ( 0 ) ; } } return ( authctxt -> valid ?1 : 0 ) ; } 