static int worker_main ( int sock ) { save_netns ( ) ; while ( true ) { struct msg msg ; if ( recv_message ( sock , & msg ) < 0 ) { out } switch ( msg . type ) { case MSG_EXIT : if ( env . debug ) { fprintf ( stderr , "[%d]: worker exit.\n" , env . worker_id ) ; } out case MSG_DO_TEST : { int test_to_run = msg . do_test . num ; struct prog_test_def * test = & prog_test_defs [ test_to_run ] ; struct test_state * state = & test_states [ test_to_run ] ; struct msg msg ; if ( env . debug ) { fprintf ( stderr , "[%d]: #%d:%s running.\n" , env . worker_id , test_to_run + 1 , test -> test_name ) ; } run_one_test ( test_to_run ) ; msg . type = MSG_TEST_DONE ; msg . test_done . num = test_to_run ; msg . test_done . error_cnt = state -> error_cnt ; msg . test_done . skip_cnt = state -> skip_cnt ; msg . test_done . sub_succ_cnt = state -> sub_succ_cnt ; msg . test_done . subtest_num = state -> subtest_num ; msg . test_done . have_log = false ; if ( verbose ( ) || state -> force_log || state -> error_cnt ) { if ( state -> log_cnt ) { msg . test_done . have_log = true ; } } if ( send_message ( sock , & msg ) < 0 ) { perror ( "Fail to send message done" ) ; out } if ( msg . test_done . have_log ) { worker_main_send_log ( sock , state -> log_buf , state -> log_cnt ) ; } if ( state -> log_buf ) { free ( state -> log_buf ) ; state -> log_buf = NULL ; state -> log_cnt = 0 ; } if ( state -> subtest_num ) { if ( worker_main_send_subtests ( sock , state ) ) { out } } if ( env . debug ) { fprintf ( stderr , "[%d]: #%d:%s done.\n" , env . worker_id , test_to_run + 1 , test -> test_name ) ; } break ; } default : if ( env . debug ) { fprintf ( stderr , "[%d]: unknown message.\n" , env . worker_id ) ; } return - 1 ; } } out return 0 ; } 