if ( wolfSSL_CTX_use_PrivateKey_buffer ( ctx , KEY_BUF , SIZEOF_KEY_BUF , SSL_FILETYPE_ASN1 ) != SSL_SUCCESS ) { fprintf ( stderr , "ERROR: failed to load %s, please check the file.\n" , KEY_BUF ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } memset ( & servAddr , 0 , sizeof ( servAddr ) ) ; servAddr . sin_family = AF_INET ; servAddr . sin_port = htons ( BIND_PORT ) ; servAddr . sin_addr . s_addr = INADDR_ANY ; if ( bind ( sockfd , ( sockaddr * ) & servAddr , sizeof ( servAddr ) ) == - 1 ) { fprintf ( stderr , "ERROR: failed to bind\n" ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } if ( listen ( sockfd , 5 ) == - 1 ) { fprintf ( stderr , "ERROR: failed to listen\n" ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } while ( ! shutdown ) { printf ( "Waiting for a connection...\n" ) ; if ( ( connd = accept ( sockfd , ( sockaddr * ) & clientAddr , & size ) ) == - 1 ) { fprintf ( stderr , "ERROR: failed to accept the connection\n\n" ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } if ( ( ssl = wolfSSL_new ( ctx ) ) == NULL ) { fprintf ( stderr , "ERROR: failed to create WOLFSSL object\n" ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } wolfSSL_set_fd ( ssl , connd ) ; ret = wolfSSL_accept ( ssl ) ; if ( ret != SSL_SUCCESS ) { fprintf ( stderr , "wolfSSL_accept error = %d\n" , wolfSSL_get_error ( ssl , ret ) ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } printf ( "Client connected successfully\n" ) ; if ( wolfSSL_read ( ssl , buff , sizeof ( buff ) - 1 ) == - 1 ) { fprintf ( stderr , "ERROR: failed to read\n" ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } printf ( "Client: %s\n" , buff ) ; if ( strncmp ( buff , "shutdown" , 8 ) == 0 ) { printf ( "Shutdown command issued!\n" ) ; shutdown = 1 ; } memset ( buff , 0 , sizeof ( buff ) ) ; memcpy ( buff , reply , strlen ( reply ) ) ; len = strnlen ( buff , sizeof ( buff ) ) ; if ( wolfSSL_write ( ssl , buff , ( int ) len ) != len ) { fprintf ( stderr , "ERROR: failed to write\n" ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return - 1 ; } wolfSSL_free ( ssl ) ; close ( connd ) ; } printf ( "Shutdown complete\n" ) ; util_Cleanup ( sockfd , ctx , ssl ) ; return 0 ; 