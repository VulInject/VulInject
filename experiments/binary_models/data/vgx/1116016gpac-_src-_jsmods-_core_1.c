static JSValue bitstream_constructor ( JSContext * ctx , JSValueConst new_target , int argc , JSValueConst * argv ) { JSValue anobj ; JSBitstream * jbs ; GF_BitStream * bs = NULL ; if ( ! argc ) { bs = gf_bs_new ( NULL , 0 , GF_BITSTREAM_WRITE ) ; } if ( JS_IsObject ( argv [ 0 ] ) ) { FILE * f = JS_GetOpaque ( argv [ 0 ] , file_class_id ) ; if ( f ) { if ( ( argc > 1 ) && JS_ToBool ( ctx , argv [ 1 ] ) ) { bs = gf_bs_from_file ( f , GF_BITSTREAM_WRITE ) ; } else { bs = gf_bs_from_file ( f , GF_BITSTREAM_READ ) ; } } else { u8 * data ; size_t data_size ; data = JS_GetArrayBuffer ( ctx , & data_size , argv [ 0 ] ) ; if ( ! data ) { return GF_JS_EXCEPTION ( ctx ) ; } if ( ( argc > 1 ) && JS_ToBool ( ctx , argv [ 1 ] ) ) { bs = gf_bs_new ( data , data_size , GF_BITSTREAM_WRITE ) ; } else { bs = gf_bs_new ( data , data_size , GF_BITSTREAM_READ ) ; } } } else { return GF_JS_EXCEPTION ( ctx ) ; } GF_SAFEALLOC ( jbs , JSBitstream ) ; if ( ! jbs ) { gf_bs_del ( bs , NULL ) ; return js_throw_err ( ctx , GF_OUT_OF_MEM ) ; } anobj = JS_NewObjectClass ( ctx , bitstream_class_id ) ; if ( JS_IsException ( anobj ) ) { gf_bs_del ( bs ) ; gf_free ( jbs ) ; return anobj ; } jbs -> bs = bs ; jbs -> buf_ref = JS_UNDEFINED ; if ( argc ) { jbs -> buf_ref = JS_DupValue ( ctx , argv [ 0 ] ) ; } JS_SetOpaque ( anobj , jbs ) ; return anobj ; } 