static int netdev_linux_set_policing ( struct netdev * netdev_ , uint32_t kbits_rate , uint32_t kbits_burst , uint32_t kpkts_rate , uint32_t kpkts_burst ) { struct netdev_linux * netdev = netdev_linux_cast ( netdev_ ) ; const char * netdev_name = netdev_get_name ( netdev_ ) ; int ifindex ; int error ; kbits_burst = ( ! kbits_rate ?0 : ! kbits_burst ?8000 : kbits_burst ) ; kpkts_burst = ( ! kpkts_rate ?0 : ! kpkts_burst ?16 : kpkts_burst ) ; if ( netdev_linux_netnsid_is_remote ( netdev ) ) { error = EOPNOTSUPP ; out } if ( netdev -> cache_valid & VALID_POLICING ) { error = netdev -> netdev_policing_error ; if ( error || ( netdev -> kbits_rate == kbits_rate && netdev -> kpkts_rate == kpkts_rate && netdev -> kbits_burst == kbits_burst && netdev -> kpkts_burst == kpkts_burst ) ) { out } netdev -> cache_valid &= ~ VALID_POLICING ; } COVERAGE_INC ( netdev_set_policing ) ; if ( netdev_is_flow_api_enabled ( ) ) { error = tc_del_matchall_policer ( netdev_ ) ; if ( kbits_rate || kpkts_rate ) { error = tc_add_matchall_policer ( netdev_ , kbits_rate , kbits_burst , kpkts_rate , kpkts_burst ) ; } out } error = get_ifindex ( netdev_ , & ifindex ) ; if ( error ) { out } error = tc_add_del_qdisc ( ifindex , false , 0 , TC_INGRESS ) ; if ( error ) { VLOG_WARN_RL ( & rl , "%s: removing policing failed: %s" , netdev_name , ovs_strerror ( error ) ) ; out } if ( kbits_rate || kpkts_rate ) { const char * cls_name = "matchall" ; error = tc_add_del_qdisc ( ifindex , true , 0 , TC_INGRESS ) ; if ( error ) { VLOG_WARN_RL ( & rl , "%s: adding policing qdisc failed: %s" , netdev_name , ovs_strerror ( error ) ) ; out } error = tc_add_matchall_policer ( netdev_ , kbits_rate , kbits_burst , kpkts_rate , kpkts_burst ) ; if ( error == ENOENT ) { cls_name = "basic" ; error = tc_add_policer ( netdev_ , kbits_rate , kbits_burst , kpkts_rate , kpkts_burst ) ; } if ( error ) { VLOG_WARN_RL ( & rl , "%s: adding cls_%s policing action failed: %s" , netdev_name , cls_name , ovs_strerror ( error ) ) ; out } } out if ( ! error ) { netdev -> kbits_rate = kbits_rate ; netdev -> kbits_burst = kbits_burst ; netdev -> kpkts_rate = kpkts_rate ; netdev -> kpkts_burst = kpkts_burst ; } if ( ! error || error == ENODEV ) { netdev -> netdev_policing_error = error ; netdev -> cache_valid |= VALID_POLICING ; } ovs_mutex_unlock ( & netdev -> mutex ) ; return error ; } 