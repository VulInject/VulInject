static int packet_edns_malformed ( struct sldns_buffer * buf , int qtype ) { size_t len ; if ( sldns_buffer_limit ( buf ) < LDNS_HEADER_SIZE ) { return 1 ; } if ( LDNS_RCODE_WIRE ( sldns_buffer_begin ( buf ) ) != LDNS_RCODE_NOERROR ) { return 0 ; } if ( LDNS_QDCOUNT ( sldns_buffer_begin ( buf ) ) != 1 || LDNS_ANCOUNT ( sldns_buffer_begin ( buf ) ) == 0 ) { return 0 ; } len = dname_valid ( sldns_buffer_at ( buf , LDNS_HEADER_SIZE ) , sldns_buffer_limit ( buf ) - LDNS_HEADER_SIZE ) ; if ( len == 1 && qtype == 0 ) { return 0 ; } if ( sldns_buffer_limit ( buf ) < LDNS_HEADER_SIZE + len + 4 + 3 ) { return 0 ; } if ( sldns_buffer_at ( buf , LDNS_HEADER_SIZE + len + 4 ) [ 0 ] == 0 && sldns_buffer_at ( buf , LDNS_HEADER_SIZE + len + 4 ) [ 1 ] == 0 && sldns_buffer_at ( buf , LDNS_HEADER_SIZE + len + 4 ) [ 2 ] == 0 ) { return 1 ; } return 0 ; } 