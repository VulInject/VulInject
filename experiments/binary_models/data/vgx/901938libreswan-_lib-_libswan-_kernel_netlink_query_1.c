int nl_send_query ( const struct nlmsghdr * req , int protocol , struct logger * logger ) { int nl_fd = cloexec_socket ( AF_NETLINK , SOCK_DGRAM | SOCK_NONBLOCK , protocol ) ; if ( nl_fd < 0 ) { llog_error ( logger , errno , "socket() in nl_send_query() protocol %d" , protocol ) ; return nl_fd ; } size_t len = req -> nlmsg_len ; int r ; { r = write ( nl_fd , req , len ) ; } r < 0 && errno == EINTR ; if ( r < 0 ) { llog_error ( logger , errno , "netlink nl_send_query() write" ) ; close ( nl_fd ) ; return - 1 ; } if ( ( size_t ) r != len ) { llog_error ( logger , 0 , "netlink write() message truncated: %zd instead of %zu" , r , len ) ; close ( nl_fd ) ; return - 1 ; } return nl_fd ; } 