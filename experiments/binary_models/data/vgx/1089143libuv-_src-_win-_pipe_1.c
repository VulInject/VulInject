int uv__pipe_write_ipc ( uv_loop_t * loop , uv_write_t * req , uv_pipe_t * handle , const uv_buf_t data_bufs [ ] , size_t data_buf_count , uv_stream_t * send_handle , uv_write_cb cb ) { uv_buf_t stack_bufs [ 6 ] ; uv_buf_t * bufs ; size_t buf_count , buf_index ; uv__ipc_frame_header_t frame_header ; uv__ipc_socket_xfer_type_t xfer_type = UV__IPC_SOCKET_XFER_NONE ; uv__ipc_socket_xfer_info_t xfer_info ; uint64_t data_length ; size_t i ; int err ; data_length = 0 ; for ( i = 0 ; i < data_buf_count ; i ++ ) { data_length += data_bufs [ i ] . len ; } if ( send_handle != NULL ) { uv_tcp_t * send_tcp_handle = ( uv_tcp_t * ) send_handle ; if ( send_tcp_handle -> type != UV_TCP ) { return ERROR_NOT_SUPPORTED ; } err = uv__tcp_xfer_export ( send_tcp_handle , uv__pipe_get_ipc_remote_pid ( handle ) , & xfer_type , & xfer_info ) ; if ( err != 0 ) { return err ; } } buf_count = 1 + data_buf_count ; if ( send_handle != NULL ) { buf_count += 1 ; } if ( buf_count < ARRAY_SIZE ( stack_bufs ) ) { bufs = stack_bufs ; } else { bufs = uv__calloc ( buf_count , sizeof ( uv_buf_t ) ) ; if ( bufs == NULL ) { return ERROR_NOT_ENOUGH_MEMORY ; } } buf_index = 0 ; memset ( & frame_header , 0 , sizeof frame_header ) ; bufs [ buf_index ++ ] = uv_buf_init ( ( char * ) & frame_header , sizeof frame_header ) ; if ( send_handle != NULL ) { switch ( xfer_type ) { case UV__IPC_SOCKET_XFER_TCP_CONNECTION : frame_header . flags |= UV__IPC_FRAME_HAS_SOCKET_XFER | UV__IPC_FRAME_XFER_IS_TCP_CONNECTION ; break ; case UV__IPC_SOCKET_XFER_TCP_SERVER : frame_header . flags |= UV__IPC_FRAME_HAS_SOCKET_XFER ; break ; default : assert ( 0 ) ; } bufs [ buf_index ++ ] = uv_buf_init ( ( char * ) & xfer_info , sizeof xfer_info ) ; } if ( data_length > 0 ) { frame_header . flags |= UV__IPC_FRAME_HAS_DATA ; frame_header . data_length = ( uint32_t ) data_length ; for ( i = 0 ; i < data_buf_count ; i ++ ) { bufs [ buf_index ++ ] = data_bufs [ i ] ; } } err = uv__pipe_write_data ( loop , req , handle , bufs , buf_count , cb , 1 ) ; if ( bufs != stack_bufs ) { uv__free ( bufs ) ; } return err ; } 