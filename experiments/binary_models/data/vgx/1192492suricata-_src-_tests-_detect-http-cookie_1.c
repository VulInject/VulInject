static int DetectHttpCookieSigTest01 ( void ) { int result = 0 ; Flow f ; uint8_t httpbuf1 [ ] "POST / HTTP/1.0\r\nUser-Agent: Mozilla/1.0\r\nCookie:" " hellocatchme\r\n\r\n" ; ; uint32_t httplen1 = sizeof ( httpbuf1 ) - 1 ; TcpSession ssn ; Packet * p = NULL ; Signature * s = NULL ; ThreadVars th_v ; DetectEngineThreadCtx * det_ctx = NULL ; HtpState * http_state = NULL ; AppLayerParserThreadCtx * alp_tctx = AppLayerParserThreadCtxAlloc ( ) ; memset ( & f , 0 , sizeof ( f ) ) ; memset ( & ssn , 0 , sizeof ( ssn ) ) ; p = UTHBuildPacket ( NULL , 0 , IPPROTO_TCP ) ; FLOW_INITIALIZE ( & f ) ; f . protoctx = ( void * ) & ssn ; f . proto = IPPROTO_TCP ; f . flags |= FLOW_IPV4 ; p -> flow = & f ; p -> flowflags |= FLOW_PKT_TOSERVER ; p -> flowflags |= FLOW_PKT_ESTABLISHED ; p -> flags |= PKT_HAS_FLOW | PKT_STREAM_EST ; f . alproto = ALPROTO_HTTP1 ; StreamTcpInitConfig ( true ) ; DetectEngineCtx * de_ctx = DetectEngineCtxInit ( ) ; if ( de_ctx == NULL ) { end } de_ctx -> flags |= DE_QUIET ; s = de_ctx -> sig_list = SigInit ( de_ctx , "alert http any any ->any any (msg:" "\"HTTP cookie\"; content:\"me\"; " "http_cookie; sid:1;)" ) ; if ( s == NULL ) { end } s -> next = SigInit ( de_ctx , "alert http any any ->any any (msg:\"HTTP " "cookie\"; content:\"go\"; http_cookie; sid:2;)" ) ; if ( s -> next == NULL ) { end } SigGroupBuild ( de_ctx ) ; DetectEngineThreadCtxInit ( & th_v , ( void * ) de_ctx , ( void * ) & det_ctx ) ; int r = AppLayerParserParse ( NULL , alp_tctx , & f , ALPROTO_HTTP1 , STREAM_TOSERVER , httpbuf1 , httplen1 ) ; if ( r != 0 ) { printf ( "toserver chunk 1 returned %" PRId32 ", expected 0: " , r ) ; result = 0 ; end } http_state = f . alstate ; if ( http_state == NULL ) { printf ( "no http state: " ) ; result = 0 ; end } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; if ( ! ( PacketAlertCheck ( p , 1 ) ) ) { printf ( "sid 1 didn't match but should have: " ) ; end } if ( PacketAlertCheck ( p , 2 ) ) { printf ( "sid 2 matched but shouldn't: " ) ; end } result = 1 ; end if ( alp_tctx != NULL ) { AppLayerParserThreadCtxFree ( alp_tctx ) ; } if ( det_ctx != NULL ) { DetectEngineThreadCtxDeinit ( & th_v , ( void * ) det_ctx ) ; } if ( de_ctx != NULL ) { DetectEngineCtxFree ( de_ctx ) ; } StreamTcpFreeConfig ( true ) ; UTHFreePackets ( & p , 1 ) ; return result ; } 