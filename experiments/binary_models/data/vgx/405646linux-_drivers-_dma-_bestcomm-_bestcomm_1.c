static int mpc52xx_bcom_probe ( struct platform_device * op ) { struct device_node * ofn_sram ; struct resource res_bcom ; int rv ; printk ( KERN_INFO "DMA: MPC52xx BestComm driver\n" ) ; of_node_get ( op -> dev . of_node ) ; ofn_sram = of_find_matching_node ( NULL , mpc52xx_sram_ids ) ; if ( ! ofn_sram ) { printk ( ": " "No SRAM found in device tree\n" ) rv = - ENODEV ; error_ofput } rv = bcom_sram_init ( ofn_sram , DRIVER_NAME ) ; of_node_put ( ofn_sram ) ; if ( rv ) { printk ( ": " "Error in SRAM init\n" ) error_ofput } bcom_eng = kzalloc ( sizeof ( bcom_engine ) , GFP_KERNEL ) ; if ( ! bcom_eng ) { rv = - ENOMEM ; error_sramclean } bcom_eng -> ofnode = op -> dev . of_node ; if ( of_address_to_resource ( op -> dev . of_node , 0 , & res_bcom ) ) { printk ( ": " "Can't get resource\n" ) rv = - EINVAL ; error_sramclean } if ( ! request_mem_region ( res_bcom . start , resource_size ( & res_bcom ) , DRIVER_NAME ) ) { printk ( ": " "Can't request registers region\n" ) rv = - EBUSY ; error_sramclean } bcom_eng -> regs_base = res_bcom . start ; bcom_eng -> regs = ioremap ( res_bcom . start , sizeof ( mpc52xx_sdma ) ) ; if ( ! bcom_eng -> regs ) { printk ( ": " "Can't map registers\n" ) rv = - ENOMEM ; error_release } rv = bcom_engine_init ( ) ; if ( rv ) { error_unmap } printk ( KERN_INFO "DMA: MPC52xx BestComm engine @%08lx ok !\n" , ( long ) bcom_eng -> regs_base ) ; return 0 ; error_unmap iounmap ( bcom_eng -> regs ) ; error_release release_mem_region ( res_bcom . start , sizeof ( mpc52xx_sdma ) ) ; error_sramclean bcom_sram_cleanup ( ) ; error_ofput of_node_put ( op -> dev . of_node ) ; printk ( KERN_ERR "DMA: MPC52xx BestComm init failed !\n" ) ; return rv ; } 