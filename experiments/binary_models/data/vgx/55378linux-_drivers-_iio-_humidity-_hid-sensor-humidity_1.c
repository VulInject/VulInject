static int hid_humidity_probe ( struct platform_device * pdev ) { static const char * name = "humidity" ; struct iio_dev * indio_dev ; struct hid_humidity_state * humid_st ; struct iio_chan_spec * humid_chans ; struct hid_sensor_hub_device * hsdev = dev_get_platdata ( & pdev -> dev ) ; int ret ; indio_dev = devm_iio_device_alloc ( & pdev -> dev , sizeof ( * humid_st ) ) ; humid_st = iio_priv ( indio_dev ) ; humid_st -> common_attributes . hsdev = hsdev ; humid_st -> common_attributes . pdev = pdev ; ret = hid_sensor_parse_common_attributes ( hsdev , HID_USAGE_SENSOR_HUMIDITY , & humid_st -> common_attributes , humidity_sensitivity_addresses , ARRAY_SIZE ( humidity_sensitivity_addresses ) ) ; if ( ret ) { return ret ; } humid_chans = devm_kmemdup ( & indio_dev -> dev , humidity_channels , sizeof ( humidity_channels ) , GFP_KERNEL ) ; if ( ! humid_chans ) { return - ENOMEM ; } ret = humidity_parse_report ( pdev , hsdev , humid_chans , HID_USAGE_SENSOR_HUMIDITY , humid_st ) ; if ( ret ) { return ret ; } indio_dev -> channels = humid_chans ; indio_dev -> num_channels = ARRAY_SIZE ( humidity_channels ) ; indio_dev -> info = & humidity_info ; indio_dev -> name = name ; indio_dev -> modes = INDIO_DIRECT_MODE ; atomic_set ( & humid_st -> common_attributes . data_ready , 0 ) ; ret = hid_sensor_setup_trigger ( indio_dev , name , & humid_st -> common_attributes ) ; if ( ret ) { return ret ; } platform_set_drvdata ( pdev , indio_dev ) ; humidity_callbacks . pdev = pdev ; ret = sensor_hub_register_callback ( hsdev , HID_USAGE_SENSOR_HUMIDITY , & humidity_callbacks ) ; if ( ret ) { error_remove_trigger } ret = iio_device_register ( indio_dev ) ; if ( ret ) { error_remove_callback } return ret ; error_remove_callback sensor_hub_remove_callback ( hsdev , HID_USAGE_SENSOR_HUMIDITY ) ; error_remove_trigger hid_sensor_remove_trigger ( indio_dev , & humid_st -> common_attributes ) ; return ret ; } 