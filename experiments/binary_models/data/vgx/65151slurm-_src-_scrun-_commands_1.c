static void _load_config ( ) { int rc ; data_t * term , * ver , * rp , * annot , * config = NULL ; buf_t * buf ; xassert ( ! state . config_file ) ; xstrfmtcat ( state . config_file , "%s/config.json" , state . bundle ) ; if ( ! ( buf = create_mmap_buf ( state . config_file ) ) ) { fatal ( "unable to load %s: %m" , state . config_file ) ; } if ( ( rc = serialize_g_string_to_data ( & config , get_buf_data ( buf ) , size_buf ( buf ) , MIME_TYPE_JSON ) ) ) { fatal ( "unable to parse %s: %s" , state . config_file , slurm_strerror ( rc ) ) ; } FREE_NULL_BUFFER ( buf ) ; debug ( "%s: loaded container config: %s" , __func__ , state . config_file ) ; xassert ( ! state . config ) ; state . config = config ; xassert ( ! state . root_path ) ; rp = data_resolve_dict_path ( state . config , "/root/path/" ) ; if ( data_get_type ( rp ) != DATA_TYPE_STRING ) { fatal ( "Invalid /root/path" ) ; } if ( data_get_string ( rp ) [ 0 ] == '/' ) { state . root_path = xstrdup ( data_get_string ( rp ) ) ; } else { state . root_path = xstrdup_printf ( "%s/%s" , state . bundle , data_get_string ( rp ) ) ; } state . orig_root_path = xstrdup ( state . root_path ) ; if ( ( annot = data_key_get ( state . config , "annotations" ) ) && ( data_dict_for_each ( annot , _foreach_load_annotation , NULL ) < 0 ) ) { fatal ( "Invalid /annotations" ) ; } ver = data_resolve_dict_path ( state . config , "/ociVersion/" ) ; if ( data_get_type ( ver ) != DATA_TYPE_STRING ) { fatal ( "Invalid /ociVersion/ type %s" , data_type_to_string ( data_get_type ( ver ) ) ) ; } state . oci_version = xstrdup ( data_get_string ( ver ) ) ; if ( ( term = data_resolve_dict_path ( state . config , "/process/terminal" ) ) ) { if ( data_get_type ( term ) != DATA_TYPE_BOOL ) { fatal ( "Invalid /process/terminal type %s" , data_type_to_string ( data_get_type ( term ) ) ) ; } state . requested_terminal = data_get_bool ( term ) ; } else { state . requested_terminal = false ; } } 