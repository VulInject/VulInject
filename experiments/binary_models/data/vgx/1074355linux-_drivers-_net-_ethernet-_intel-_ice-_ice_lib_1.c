static void ice_set_agg_vsi ( struct ice_vsi * vsi ) { struct device * dev = ice_pf_to_dev ( vsi -> back ) ; struct ice_agg_node * agg_node_iter ; u32 agg_id = ICE_INVALID_AGG_NODE_ID ; struct ice_agg_node * agg_node = NULL ; int node_offset , max_agg_nodes = 0 ; struct ice_port_info * port_info ; struct ice_pf * pf = vsi -> back ; u32 agg_node_id_start = 0 ; int status ; port_info = pf -> hw . port_info ; if ( ! port_info ) { return ; } switch ( vsi -> type ) { case ICE_VSI_CTRL : case ICE_VSI_CHNL : case ICE_VSI_LB : case ICE_VSI_PF : case ICE_VSI_SWITCHDEV_CTRL : max_agg_nodes = ICE_MAX_PF_AGG_NODES ; agg_node_id_start = ICE_PF_AGG_NODE_ID_START ; agg_node_iter = & pf -> pf_agg_node [ 0 ] ; break ; case ICE_VSI_VF : max_agg_nodes = ICE_MAX_VF_AGG_NODES ; agg_node_id_start = ICE_VF_AGG_NODE_ID_START ; agg_node_iter = & pf -> vf_agg_node [ 0 ] ; break ; default : dev_dbg ( dev , "unexpected VSI type %s\n" , ice_vsi_type_str ( vsi -> type ) ) ; return ; } for ( node_offset = 0 ; node_offset < max_agg_nodes ; node_offset ++ ) { if ( agg_node_iter -> num_vsis && agg_node_iter -> num_vsis == ICE_MAX_VSIS_IN_AGG_NODE ) { agg_node_iter ++ ; continue ; } if ( agg_node_iter -> valid && agg_node_iter -> agg_id != ICE_INVALID_AGG_NODE_ID ) { agg_id = agg_node_iter -> agg_id ; agg_node = agg_node_iter ; break ; } if ( agg_node_iter -> agg_id == ICE_INVALID_AGG_NODE_ID ) { agg_id = node_offset + agg_node_id_start ; agg_node = agg_node_iter ; break ; } agg_node_iter ++ ; } if ( ! agg_node ) { return ; } if ( ! agg_node -> valid ) { status = ice_cfg_agg ( port_info , agg_id , ICE_AGG_TYPE_AGG , ( u8 ) vsi -> tc_cfg . ena_tc ) ; if ( status ) { dev_err ( dev , "unable to create aggregator node with agg_id %u\n" , agg_id ) ; return ; } agg_node -> valid = true ; agg_node -> agg_id = agg_id ; } status = ice_move_vsi_to_agg ( port_info , agg_id , vsi -> idx , ( u8 ) vsi -> tc_cfg . ena_tc ) ; if ( status ) { dev_err ( dev , "unable to move VSI idx %u into aggregator %u node" , vsi -> idx , agg_id ) ; return ; } agg_node -> num_vsis ++ ; vsi -> agg_node = agg_node ; dev_dbg ( dev , "successfully moved VSI idx %u tc_bitmap 0x%x) into aggregator node %d which has num_vsis %u\n" , vsi -> idx , vsi -> tc_cfg . ena_tc , vsi -> agg_node -> agg_id , vsi -> agg_node -> num_vsis ) ; } 