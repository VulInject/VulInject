int test__dso_data ( int subtest __maybe_unused ) { struct machine machine ; struct dso * dso ; char * file = test_file ( TEST_FILE_SIZE ) ; size_t i ; TEST_ASSERT_VAL ( "No test file" , file ) ; memset ( & machine , 0 , sizeof ( machine ) ) ; dso = dso__new ( ( const char * ) file ) ; TEST_ASSERT_VAL ( "Failed to access to dso" , dso__data_fd ( dso , & machine ) >= 0 ) ; for ( i = 0 ; i < ARRAY_SIZE ( offsets ) ; i ++ ) { struct test_data_offset * data = & offsets [ i ] ; ssize_t size ; u8 buf [ 10 ] ; memset ( buf , 0 , 10 ) ; size = dso__data_read_offset ( dso , & machine , data -> offset , buf , 10 ) ; TEST_ASSERT_VAL ( "Wrong size" , size == data -> size ) ; TEST_ASSERT_VAL ( "Wrong data" , ! memcmp ( buf , data -> data , 10 ) ) ; } { ssize_t size ; int c ; u8 * buf ; buf = malloc ( TEST_FILE_SIZE ) ; TEST_ASSERT_VAL ( "ENOMEM\n" , buf ) ; for ( c = 0 ; c < 2 ; c ++ ) { memset ( buf , 0 , TEST_FILE_SIZE ) ; size = dso__data_read_offset ( dso , & machine , 10 , buf , TEST_FILE_SIZE ) ; TEST_ASSERT_VAL ( "Wrong size" , size == ( TEST_FILE_SIZE - 10 ) ) ; for ( i = 0 ; i < ( size_t ) size ; i ++ ) { TEST_ASSERT_VAL ( "Wrong data" , buf [ i ] == ( i % 10 ) ) ; } } } dso__put ( dso ) ; unlink ( file ) ; return 0 ; } 