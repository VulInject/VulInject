static struct avc_node * avc_insert ( struct selinux_avc * avc , u32 ssid , u32 tsid , u16 tclass , struct av_decision * avd , struct avc_xperms_node * xp_node ) { struct avc_node * pos , * node = NULL ; int hvalue ; unsigned long flag ; spinlock_t * lock ; struct hlist_head * head ; if ( avc_latest_notif_update ( avc , avd -> seqno , 1 ) ) { return NULL ; } node = avc_alloc_node ( avc ) ; if ( ! node ) { return in ; } avc_node_populate ( node , ssid , tsid , tclass , avd ) ; if ( avc_xperms_populate ( node , xp_node ) ) { avc_node_kill ( avc , node ) ; return NULL ; } hvalue = avc_hash ( ssid , tsid , tclass ) ; head = & avc -> avc_cache . slots [ hvalue ] ; lock = & avc -> avc_cache . slots_lock [ hvalue ] ; spin_lock_irqsave ( lock , flag ) ; hlist_for_each_entry ( , , ) { if ( pos -> ae . ssid == ssid && pos -> ae . tsid == tsid && pos -> ae . tclass == tclass ) { avc_node_replace ( avc , node , pos ) ; found } } hlist_add_head_rcu ( & node -> list , head ) ; found spin_unlock_irqrestore ( lock , flag ) ; return node ; } 