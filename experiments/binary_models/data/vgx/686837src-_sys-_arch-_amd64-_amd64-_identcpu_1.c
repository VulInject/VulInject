void intelcore_update_sensor ( void * args ) { struct cpu_info * ci = ( cpu_info * ) args ; u_int64_t msr ; int max = 100 ; if ( ci -> ci_model == 0x0e && ( rdmsr ( MSR_TEMPERATURE_TARGET_UNDOCUMENTED ) & MSR_TEMPERATURE_TARGET_LOW_BIT_UNDOCUMENTED ) ) { max = 85 ; } if ( ci -> ci_model > 0x17 && ci -> ci_model != 0x1c && ci -> ci_model != 0x26 && ci -> ci_model != 0x27 && ci -> ci_model != 0x35 && ci -> ci_model != 0x36 ) { max = MSR_TEMPERATURE_TARGET_TJMAX ( rdmsr ( MSR_TEMPERATURE_TARGET ) ) ; } msr = rdmsr ( MSR_THERM_STATUS , NULL ) ; if ( msr & MSR_THERM_STATUS_VALID_BIT ) { ci -> ci_sensor . value = max - MSR_THERM_STATUS_TEMP ( msr ) ; ci -> ci_sensor . value *= 1000000 ; ci -> ci_sensor . value += 273150000 ; ci -> ci_sensor . flags &= ~ SENSOR_FINVALID ; } else { ci -> ci_sensor . value = 0 ; ci -> ci_sensor . flags |= SENSOR_FINVALID ; } } 