int main ( int argc , char * argv [ ] ) { struct kvm_vcpu * vcpu ; struct kvm_run * run ; struct kvm_vm * vm ; struct kvm_sregs sregs ; struct ucall uc ; TEST_REQUIRE ( kvm_cpu_has ( X86_FEATURE_XSAVE ) ) ; vm = vm_create_with_one_vcpu ( & vcpu , guest_code ) ; run = vcpu -> run ; while ( 1 ) { vcpu_run ( vcpu ) ; TEST_ASSERT ( run -> exit_reason == KVM_EXIT_IO , "Unexpected exit reason: %u (%s),\n" , run -> exit_reason , exit_reason_str ( run -> exit_reason ) ) ; switch ( get_ucall ( vcpu , & uc ) ) { case UCALL_SYNC : vcpu_sregs_get ( vcpu , & sregs ) ; sregs . cr4 &= ~ X86_CR4_OSXSAVE ; vcpu_sregs_set ( vcpu , & sregs ) ; break ; case UCALL_ABORT : REPORT_GUEST_ASSERT ( uc ) ; break ; case UCALL_DONE : done default : TEST_FAIL ( "Unknown ucall %lu" , uc . cmd ) ; } } done return 0 ; } 