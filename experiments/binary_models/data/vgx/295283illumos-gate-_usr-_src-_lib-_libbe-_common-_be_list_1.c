static int be_get_node_data ( zfs_handle_t * zhp , be_node_list_t * be_node , char * be_name , const char * rpool , char * current_be , char * be_ds ) { char prop_buf [ MAXPATHLEN ] ; nvlist_t * userprops = NULL ; nvlist_t * propval = NULL ; nvlist_t * zone_propval = NULL ; char * prop_str = NULL ; char * zone_prop_str = NULL ; char * grub_default_bootfs = NULL ; zpool_handle_t * zphp = NULL ; int err = 0 ; if ( be_node == NULL || be_name == NULL || current_be == NULL || be_ds == NULL ) { be_print_err ( gettext ( "be_get_node_data: invalid arguments, " "can not be NULL\n" ) ) ; return ( BE_ERR_INVAL ) ; } errno = 0 ; be_node -> be_root_ds = strdup ( be_ds ) ; if ( ( err = errno ) != 0 || be_node -> be_root_ds == NULL ) { be_print_err ( gettext ( "be_get_node_data: failed to " "copy root dataset name\n" ) ) ; return ( errno_to_be_err ( err ) ) ; } be_node -> be_node_name = strdup ( be_name ) ; if ( ( err = errno ) != 0 || be_node -> be_node_name == NULL ) { be_print_err ( gettext ( "be_get_node_data: failed to " "copy BE name\n" ) ) ; return ( errno_to_be_err ( err ) ) ; } if ( strncmp ( be_name , current_be , MAXPATHLEN ) == 0 ) { be_node -> be_active = B_TRUE ; } else { be_node -> be_active = B_FALSE ; } be_node -> be_rpool = strdup ( rpool ) ; if ( be_node -> be_rpool == NULL || ( err = errno ) != 0 ) { be_print_err ( gettext ( "be_get_node_data: failed to " "copy root pool name\n" ) ) ; return ( errno_to_be_err ( err ) ) ; } be_node -> be_space_used = zfs_prop_get_int ( zhp , ZFS_PROP_USED ) ; if ( getzoneid ( ) == GLOBAL_ZONEID ) { char * nextboot ; if ( ( zphp = zpool_open ( g_zfs , rpool ) ) == NULL ) { be_print_err ( gettext ( "be_get_node_data: failed to open " "pool (%s): %s\n" ) , rpool , libzfs_error_description ( g_zfs ) ) ; return ( zfs_err_to_be_err ( g_zfs ) ) ; } be_node -> be_active_next = B_FALSE ; if ( lzbe_get_boot_device ( rpool , & nextboot ) == 0 ) { if ( nextboot != NULL ) { if ( strcmp ( nextboot , be_ds ) == 0 ) { be_node -> be_active_next = B_TRUE ; } } } ( void ) zpool_get_prop ( zphp , ZPOOL_PROP_BOOTFS , prop_buf , ZFS_MAXPROPLEN , NULL , B_FALSE ) ; if ( be_has_grub ( ) && ( be_default_grub_bootfs ( rpool , & grub_default_bootfs ) == BE_SUCCESS ) && grub_default_bootfs != NULL ) { if ( strcmp ( grub_default_bootfs , be_ds ) == 0 ) { be_node -> be_active_on_boot = B_TRUE ; } else { be_node -> be_active_on_boot = B_FALSE ; } } if ( strcmp ( prop_buf , be_ds ) == 0 ) { be_node -> be_active_on_boot = B_TRUE ; } else { be_node -> be_active_on_boot = B_FALSE ; } be_node -> be_global_active = B_TRUE ; free ( grub_default_bootfs ) ; zpool_close ( zphp ) ; } else { if ( be_zone_compare_uuids ( be_node -> be_root_ds ) ) { be_node -> be_global_active = B_TRUE ; } else { be_node -> be_global_active = B_FALSE ; } } be_node -> be_mounted = zfs_is_mounted ( zhp , & ( be_node -> be_mntpt ) ) ; if ( ! be_node -> be_mounted ) { if ( zfs_prop_get ( zhp , ZFS_PROP_MOUNTPOINT , prop_buf , ZFS_MAXPROPLEN , NULL , NULL , 0 , B_FALSE ) == 0 ) { be_node -> be_mntpt = strdup ( prop_buf ) ; } else { return ( zfs_err_to_be_err ( g_zfs ) ) ; } } be_node -> be_node_creation = ( time_t ) zfs_prop_get_int ( zhp , ZFS_PROP_CREATION ) ; if ( ( userprops = zfs_get_user_props ( zhp ) ) == NULL ) { be_node -> be_policy_type = strdup ( be_default_policy ( ) ) ; } else { if ( getzoneid ( ) != GLOBAL_ZONEID ) { if ( nvlist_lookup_nvlist ( userprops , BE_ZONE_ACTIVE_PROPERTY , & zone_propval ) != 0 || zone_propval == NULL ) { be_node -> be_active_on_boot = B_FALSE ; } else { verify ( nvlist_lookup_string ( zone_propval , ZPROP_VALUE , & zone_prop_str ) == 0 ) ; if ( strcmp ( zone_prop_str , "on" ) == 0 ) { be_node -> be_active_on_boot = B_TRUE ; } else { be_node -> be_active_on_boot = B_FALSE ; } } } if ( nvlist_lookup_nvlist ( userprops , BE_POLICY_PROPERTY , & propval ) != 0 || propval == NULL ) { be_node -> be_policy_type = strdup ( be_default_policy ( ) ) ; } else { verify ( nvlist_lookup_string ( propval , ZPROP_VALUE , & prop_str ) == 0 ) ; if ( prop_str == NULL || strcmp ( prop_str , "-" ) == 0 || strcmp ( prop_str , "" ) == 0 ) { be_node -> be_policy_type = strdup ( be_default_policy ( ) ) ; } else { be_node -> be_policy_type = strdup ( prop_str ) ; } } if ( getzoneid ( ) != GLOBAL_ZONEID ) { if ( nvlist_lookup_nvlist ( userprops , BE_ZONE_PARENTBE_PROPERTY , & propval ) != 0 && nvlist_lookup_string ( propval , ZPROP_VALUE , & prop_str ) == 0 ) { be_node -> be_uuid_str = strdup ( prop_str ) ; } } else { if ( nvlist_lookup_nvlist ( userprops , BE_UUID_PROPERTY , & propval ) == 0 && nvlist_lookup_string ( propval , ZPROP_VALUE , & prop_str ) == 0 ) { be_node -> be_uuid_str = strdup ( prop_str ) ; } } } be_node -> be_node_num_datasets ++ ; return ( BE_SUCCESS ) ; } 