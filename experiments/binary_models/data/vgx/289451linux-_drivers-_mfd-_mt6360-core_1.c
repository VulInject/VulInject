static int mt6360_regmap_write ( void * context , const void * val , size_t val_size ) { struct mt6360_ddata * ddata = context ; u8 bank = * ( u8 * ) val ; u8 reg_addr = * ( u8 * ) ( val + 1 ) ; struct i2c_client * i2c ; bool crc_needed = false ; u8 * buf ; int buf_len = MT6360_ALLOC_WRITE_SIZE ( val_size ) ; int write_size = val_size - MT6360_REGMAP_REG_BYTE_SIZE ; int ret ; i2c = ddata -> i2c [ bank ] ; if ( bank == MT6360_SLAVE_PMIC || bank == MT6360_SLAVE_LDO ) { crc_needed = true ; ret = mt6360_xlate_pmicldo_addr ( & reg_addr , val_size - MT6360_REGMAP_REG_BYTE_SIZE ) ; if ( ret < 0 ) { return ret ; } } buf = kzalloc ( buf_len , GFP_KERNEL ) ; if ( ! buf ) { return - ENOMEM ; } buf [ 0 ] = I2C_ADDR_XLATE_8BIT ( i2c -> addr , I2C_SMBUS_WRITE ) ; buf [ 1 ] = reg_addr ; memcpy ( buf + MT6360_CRC_PREDATA_OFFSET , val + MT6360_REGMAP_REG_BYTE_SIZE , write_size ) ; if ( crc_needed ) { buf [ val_size ] = crc8 ( ddata -> crc8_tbl , buf , val_size , 0 ) ; write_size += ( MT6360_CRC_CRC8_SIZE + MT6360_CRC_DUMMY_BYTE_SIZE ) ; } ret = i2c_smbus_write_i2c_block_data ( i2c , reg_addr , write_size , buf + MT6360_CRC_PREDATA_OFFSET ) ; kfree ( buf ) ; return ret ; } 