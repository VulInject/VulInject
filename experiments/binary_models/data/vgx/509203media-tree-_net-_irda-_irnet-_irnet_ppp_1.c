static void irnet_get_discovery_log ( irnet_socket * ap ) { __u16 mask = irlmp_service_to_hint ( S_LAN ) ; ap -> discoveries = irlmp_get_discoveries ( & ap -> disco_number , mask , DISCOVERY_DEFAULT_SLOTS ) ; if ( ap -> discoveries == NULL ) { ap -> disco_number = - 1 ; } DEBUG ( CTRL_INFO , "Got the log (0x%p), size is %d\n" , ap -> discoveries , ap -> disco_number ) ; } static inline int irnet_read_discovery_log ( irnet_socket * ap , char * event , int buf_size ) { int done_event = 0 ; DENTER ( CTRL_TRACE , "(ap=0x%p, event=0x%p)\n" , ap , event ) ; if ( ap -> disco_number == - 1 ) { DEBUG ( CTRL_INFO , "Already done\n" ) ; return 0 ; } if ( ap -> discoveries == NULL ) { irnet_get_discovery_log ( ap ) ; } if ( ap -> disco_index < ap -> disco_number ) { snprintf ( event , buf_size , "Found %08x (%s) behind %08x {hints %02X-%02X}\n" , ap -> discoveries [ ap -> disco_index ] . daddr , ap -> discoveries [ ap -> disco_index ] . info , ap -> discoveries [ ap -> disco_index ] . saddr , ap -> discoveries [ ap -> disco_index ] . hints [ 0 ] , ap -> discoveries [ ap -> disco_index ] . hints [ 1 ] ) ; DEBUG ( CTRL_INFO , "Writing discovery %d : %s\n" , ap -> disco_index , ap -> discoveries [ ap -> disco_index ] . info ) ; done_event = 1 ; ap -> disco_index ++ ; } if ( ap -> disco_index >= ap -> disco_number ) { DEBUG ( CTRL_INFO , "Cleaning up log (0x%p)\n" , ap -> discoveries ) ; if ( ap -> discoveries != NULL ) { ap -> discoveries = NULL ; } ap -> disco_number = - 1 ; } return done_event ; } 