static int vga_switchto_stage2 ( struct vga_switcheroo_client * new_client ) { int ret ; struct vga_switcheroo_client * active ; active = find_active_client ( & vgasr_priv . clients ) ; active -> active = false ; set_audio_state ( active -> id , VGA_SWITCHEROO_OFF ) ; if ( new_client -> fb_info ) { struct fb_event event ; console_lock ( ) ; event . info = new_client -> fb_info ; fb_notifier_call_chain ( FB_EVENT_REMAP_ALL_CONSOLE , & event ) ; console_unlock ( ) ; } mutex_lock ( & vgasr_priv . mux_hw_lock ) ; ret = vgasr_priv . handler -> switchto ( new_client -> id ) ; mutex_unlock ( & vgasr_priv . mux_hw_lock ) ; if ( ret ) { return ret ; } if ( new_client -> ops -> reprobe ) { new_client -> ops -> reprobe ( new_client -> pdev ) ; } if ( active -> pwr_state == VGA_SWITCHEROO_ON ) { vga_switchoff ( active ) ; } set_audio_state ( new_client -> id , VGA_SWITCHEROO_ON ) ; new_client -> active = true ; return 0 ; } 