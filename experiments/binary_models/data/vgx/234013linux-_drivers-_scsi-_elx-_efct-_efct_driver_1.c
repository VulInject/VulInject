static int efct_firmware_write ( struct efct * efct , const u8 * buf , size_t buf_len , u8 * change_status ) { int rc = 0 ; u32 bytes_left ; u32 xfer_size ; u32 offset ; struct efc_dma dma ; int last = 0 ; struct efct_fw_write_result result ; init_completion ( & result . done ) ; bytes_left = buf_len ; offset = 0 ; dma . size = FW_WRITE_BUFSIZE ; dma . virt = dma_alloc_coherent ( & efct -> pci -> dev , dma . size , & dma . phys , GFP_KERNEL ) ; while ( bytes_left > 0 ) { if ( bytes_left > FW_WRITE_BUFSIZE ) { xfer_size = FW_WRITE_BUFSIZE ; } else { xfer_size = bytes_left ; } memcpy ( dma . virt , buf + offset , xfer_size ) ; if ( bytes_left == xfer_size ) { last = 1 ; } efct_hw_firmware_write ( & efct -> hw , & dma , xfer_size , offset , last , efct_fw_write_cb , & result ) ; if ( wait_for_completion_interruptible ( & result . done ) != 0 ) { rc = - ENXIO ; break ; } if ( result . actual_xfer == 0 || result . status != 0 ) { rc = - EFAULT ; break ; } if ( last ) { * change_status = result . change_status ; } bytes_left -= result . actual_xfer ; offset += result . actual_xfer ; } dma_free_coherent ( & efct -> pci -> dev , dma . size , dma . virt , dma . phys ) ; return rc ; } 