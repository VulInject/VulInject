static int tg3_hwtstamp_get ( struct net_device * dev , struct ifreq * ifr ) { struct tg3 * tp = netdev_priv ( dev ) ; struct hwtstamp_config stmpconf ; if ( ! tg3_flag ( tp , PTP_CAPABLE ) ) { return - EOPNOTSUPP ; } stmpconf . tx_type = ( tg3_flag ( tp , TX_TSTAMP_EN ) ?HWTSTAMP_TX_ON : HWTSTAMP_TX_OFF ) ; switch ( tp -> rxptpctl ) { case 0 : stmpconf . rx_filter = HWTSTAMP_FILTER_NONE ; break ; case TG3_RX_PTP_CTL_RX_PTP_V1_EN | TG3_RX_PTP_CTL_ALL_V1_EVENTS : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V1_L4_EVENT ; break ; case TG3_RX_PTP_CTL_RX_PTP_V1_EN | TG3_RX_PTP_CTL_SYNC_EVNT : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V1_L4_SYNC ; break ; case TG3_RX_PTP_CTL_RX_PTP_V1_EN | TG3_RX_PTP_CTL_DELAY_REQ : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V1_L4_DELAY_REQ ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_EN | TG3_RX_PTP_CTL_ALL_V2_EVENTS : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_EVENT ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_L2_EN | TG3_RX_PTP_CTL_ALL_V2_EVENTS : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_L2_EVENT ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_L4_EN | TG3_RX_PTP_CTL_ALL_V2_EVENTS : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_L4_EVENT ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_EN | TG3_RX_PTP_CTL_SYNC_EVNT : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_SYNC ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_L2_EN | TG3_RX_PTP_CTL_SYNC_EVNT : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_L2_SYNC ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_L4_EN | TG3_RX_PTP_CTL_SYNC_EVNT : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_L4_SYNC ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_EN | TG3_RX_PTP_CTL_DELAY_REQ : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_DELAY_REQ ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_L2_EN | TG3_RX_PTP_CTL_DELAY_REQ : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_L2_DELAY_REQ ; break ; case TG3_RX_PTP_CTL_RX_PTP_V2_L4_EN | TG3_RX_PTP_CTL_DELAY_REQ : stmpconf . rx_filter = HWTSTAMP_FILTER_PTP_V2_L4_DELAY_REQ ; break ; default : WARN_ON_ONCE ( 1 ) ; return - ERANGE ; } return copy_to_user ( ifr -> ifr_data , & stmpconf , sizeof ( stmpconf ) ) ?- EFAULT : 0 ; } 