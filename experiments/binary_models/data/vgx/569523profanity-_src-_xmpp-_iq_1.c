static int _mam_rsm_id_handler ( xmpp_stanza_t * const stanza , void * const userdata ) { const char * type = xmpp_stanza_get_type ( stanza ) ; if ( g_strcmp0 ( type , "error" ) == 0 ) { char * error_message = stanza_get_error_message ( stanza ) ; cons_show_error ( "Server error: %s" , error_message ) ; log_debug ( "MAM Error: %s" , error_message ) ; free ( error_message ) ; } if ( g_strcmp0 ( type , "result" ) == 0 ) { xmpp_stanza_t * fin = xmpp_stanza_get_child_by_name_and_ns ( stanza , STANZA_NAME_FIN , STANZA_NS_MAM2 ) ; if ( fin ) { gboolean is_complete = g_strcmp0 ( xmpp_stanza_get_attribute ( fin , "complete" ) , "true" ) == 0 ; MamRsmUserdata * data = ( MamRsmUserdata * ) userdata ; ProfWin * window = ( ProfWin * ) data -> win ; buffer_remove_entry ( window -> layout -> buffer , 0 ) ; char * start_str = NULL ; if ( data -> start_datestr ) { start_str = strdup ( data -> start_datestr ) ; start_str [ strlen ( start_str ) - 3 ] = '\0' ; } char * end_str = NULL ; if ( data -> end_datestr ) { end_str = strdup ( data -> end_datestr ) ; end_str [ strlen ( end_str ) - 3 ] = '\0' ; } if ( is_complete || ! data -> fetch_next ) { chatwin_db_history ( data -> win , is_complete ?NULL : start_str , end_str , TRUE ) ; if ( start_str ) { free ( start_str ) ; free ( data -> start_datestr ) ; } if ( end_str ) { free ( data -> end_datestr ) ; } free ( data -> barejid ) ; return 0 ; } chatwin_db_history ( data -> win , start_str , end_str , TRUE ) ; if ( start_str ) { free ( start_str ) ; } xmpp_stanza_t * set = xmpp_stanza_get_child_by_name_and_ns ( fin , STANZA_TYPE_SET , STANZA_NS_RSM ) ; if ( set ) { win_print_loading_history ( window ) ; char * firstid = NULL ; xmpp_stanza_t * first = xmpp_stanza_get_child_by_name ( set , STANZA_NAME_FIRST ) ; firstid = xmpp_stanza_get_text ( first ) ; xmpp_ctx_t * const ctx = connection_get_ctx ( ) ; if ( end_str ) { free ( data -> end_datestr ) ; } data -> end_datestr = NULL ; xmpp_stanza_t * iq = stanza_create_mam_iq ( ctx , data -> barejid , data -> start_datestr , data -> end_datestr , firstid , NULL ) ; free ( firstid ) ; iq_id_handler_add ( xmpp_stanza_get_id ( iq ) , _mam_rsm_id_handler , NULL , data ) ; iq_send_stanza ( iq ) ; xmpp_stanza_release ( iq ) ; } } } return 0 ; } 