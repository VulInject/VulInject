void cleanup_srcu_struct ( struct srcu_struct * sp ) { int cpu ; if ( WARN_ON ( ! srcu_get_delay ( sp ) ) ) { return ; } flush_delayed_work ( & sp -> work ) ; for_each_possible_cpu ( ) flush_delayed_work ( & per_cpu_ptr ( sp -> sda , cpu ) -> work ) ; if ( WARN_ON ( rcu_seq_state ( READ_ONCE ( sp -> srcu_gp_seq ) ) != SRCU_STATE_IDLE ) || WARN_ON ( srcu_readers_active ( sp ) ) ) { pr_info ( "cleanup_srcu_struct: Active srcu_struct %p state: %d\n" , sp , rcu_seq_state ( READ_ONCE ( sp -> srcu_gp_seq ) ) ) ; return ; } free_percpu ( sp -> sda ) ; sp -> sda = NULL ; } 