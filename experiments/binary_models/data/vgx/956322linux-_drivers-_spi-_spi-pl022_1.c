static void giveback ( struct pl022 * pl022 ) { struct spi_transfer * last_transfer ; pl022 -> next_msg_cs_active = false ; last_transfer = list_last_entry ( & pl022 -> cur_msg -> transfers , spi_transfer , transfer_list ) ; spi_transfer_delay_exec ( last_transfer ) ; if ( ! last_transfer -> cs_change ) { struct spi_message * next_msg ; next_msg = spi_get_next_queued_message ( pl022 -> master ) ; if ( next_msg && next_msg -> spi != pl022 -> cur_msg -> spi ) { next_msg = NULL ; } if ( ! next_msg || pl022 -> cur_msg -> state == STATE_ERROR ) { pl022_cs_control ( pl022 , SSP_CHIP_DESELECT ) ; } else { pl022 -> next_msg_cs_active = true ; } } pl022 -> cur_msg = NULL ; pl022 -> cur_chip = NULL ; writew ( ( readw ( SSP_CR1 ( pl022 -> virtbase ) ) & ( ~ SSP_CR1_MASK_SSE ) ) , SSP_CR1 ( pl022 -> virtbase ) ) ; spi_finalize_current_message ( pl022 -> master ) ; } 