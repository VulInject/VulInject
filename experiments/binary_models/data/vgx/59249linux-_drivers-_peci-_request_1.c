static struct peci_request * __ep_mmio_read ( struct peci_device * device , u8 bar , u8 addr_type , u8 seg , u8 bus , u8 dev , u8 func , u64 offset , u8 tx_len , u8 len ) { struct peci_request * req ; int ret ; req = peci_request_alloc ( device , tx_len , PECI_RDENDPTCFG_RD_LEN_BASE + len ) ; if ( ! req ) { return ERR_PTR ( - ENOMEM ) ; } req -> tx . buf [ 0 ] = PECI_RDENDPTCFG_CMD ; req -> tx . buf [ 2 ] = PECI_ENDPTCFG_TYPE_MMIO ; req -> tx . buf [ 3 ] = 0 ; req -> tx . buf [ 4 ] = 0 ; req -> tx . buf [ 5 ] = bar ; req -> tx . buf [ 6 ] = addr_type ; req -> tx . buf [ 7 ] = seg ; req -> tx . buf [ 8 ] = PCI_DEVFN ( dev , func ) ; req -> tx . buf [ 9 ] = bus ; if ( addr_type == PECI_ENDPTCFG_ADDR_TYPE_MMIO_D ) { put_unaligned_le32 ( offset , & req -> tx . buf [ 10 ] ) ; } else { put_unaligned_le64 ( offset , & req -> tx . buf [ 10 ] ) ; } ret = peci_request_xfer_retry ( req ) ; if ( ret ) { peci_request_free ( req ) ; return ERR_PTR ( ret ) ; } return req ; } 