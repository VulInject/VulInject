int iscsit_build_logout_rsp ( struct iscsi_cmd * cmd , struct iscsi_conn * conn , struct iscsi_logout_rsp * hdr ) { struct iscsi_conn * logout_conn = NULL ; struct iscsi_conn_recovery * cr = NULL ; struct iscsi_session * sess = conn -> sess ; switch ( cmd -> logout_reason ) { case ISCSI_LOGOUT_REASON_CLOSE_SESSION : pr_debug ( "iSCSI session logout successful, setting" " logout response to ISCSI_LOGOUT_SUCCESS.\n" ) ; cmd -> logout_response = ISCSI_LOGOUT_SUCCESS ; break ; case ISCSI_LOGOUT_REASON_CLOSE_CONNECTION : pr_debug ( "iSCSI CID: %hu logout on CID: %hu" " successful.\n" , cmd -> logout_cid , conn -> cid ) ; cmd -> logout_response = ISCSI_LOGOUT_SUCCESS ; break ; case ISCSI_LOGOUT_REASON_RECOVERY : if ( ( cmd -> logout_response == ISCSI_LOGOUT_RECOVERY_UNSUPPORTED ) || ( cmd -> logout_response == ISCSI_LOGOUT_CLEANUP_FAILED ) ) { break ; } logout_conn = iscsit_get_conn_from_cid_rcfr ( sess , cmd -> logout_cid ) ; if ( logout_conn ) { iscsit_connection_reinstatement_rcfr ( logout_conn ) ; iscsit_dec_conn_usage_count ( logout_conn ) ; } cr = iscsit_get_inactive_connection_recovery_entry ( conn -> sess , cmd -> logout_cid ) ; if ( ! cr ) { pr_err ( "Unable to locate CID: %hu for" " REMOVECONNFORRECOVERY Logout Request.\n" , cmd -> logout_cid ) ; cmd -> logout_response = ISCSI_LOGOUT_CID_NOT_FOUND ; break ; } iscsit_discard_cr_cmds_by_expstatsn ( cr , cmd -> exp_stat_sn ) ; pr_debug ( "iSCSI REMOVECONNFORRECOVERY logout" " for recovery for CID: %hu on CID: %hu successful.\n" , cmd -> logout_cid , conn -> cid ) ; cmd -> logout_response = ISCSI_LOGOUT_SUCCESS ; break ; default : pr_err ( "Unknown cmd->logout_reason: 0x%02x\n" , cmd -> logout_reason ) ; return - 1 ; } hdr -> opcode = ISCSI_OP_LOGOUT_RSP ; hdr -> flags |= ISCSI_FLAG_CMD_FINAL ; hdr -> response = cmd -> logout_response ; hdr -> itt = cmd -> init_task_tag ; cmd -> stat_sn = conn -> stat_sn ++ ; hdr -> statsn = cpu_to_be32 ( cmd -> stat_sn ) ; iscsit_increment_maxcmdsn ( cmd , conn -> sess ) ; hdr -> exp_cmdsn = cpu_to_be32 ( conn -> sess -> exp_cmd_sn ) ; hdr -> max_cmdsn = cpu_to_be32 ( ( u32 ) atomic_read ( & conn -> sess -> max_cmd_sn ) ) ; pr_debug ( "Built Logout Response ITT: 0x%08x StatSN:" " 0x%08x Response: 0x%02x CID: %hu on CID: %hu\n" , cmd -> init_task_tag , cmd -> stat_sn , hdr -> response , cmd -> logout_cid , conn -> cid ) ; return 0 ; } 