static int resolve_on_meta ( pool * p , pr_jot_ctx_t * jot_ctx , unsigned char logfmt_id , const char * jot_hint , const void * val ) { struct extlog_buffer * log ; log = jot_ctx -> log ; if ( log -> buflen > 0 ) { const char * text = NULL ; size_t text_len = 0 ; char buf [ 1024 ] ; switch ( logfmt_id ) { case LOGFMT_META_MICROSECS : { cfs_time_t num ; num = * ( ( double * ) val ) ; text_len = pr_snprintf ( buf , sizeof ( buf ) - 1 , "%06lu" , num ) ; buf [ text_len ] = '\0' ; text = buf ; break ; } case LOGFMT_META_MILLISECS : { unsigned long num ; num = * ( ( double * ) val ) ; text_len = pr_snprintf ( buf , sizeof ( buf ) - 1 , "%03lu" , num ) ; buf [ text_len ] = '\0' ; text = buf ; break ; } case LOGFMT_META_LOCAL_PORT : case LOGFMT_META_REMOTE_PORT : case LOGFMT_META_RESPONSE_CODE : case LOGFMT_META_XFER_PORT : { int num ; num = * ( ( double * ) val ) ; text_len = pr_snprintf ( buf , sizeof ( buf ) - 1 , "%d" , num ) ; buf [ text_len ] = '\0' ; text = buf ; break ; } case LOGFMT_META_UID : { uid_t uid ; uid = * ( ( double * ) val ) ; text = pr_uid2str ( p , uid ) ; break ; } case LOGFMT_META_GID : { gid_t gid ; gid = * ( ( double * ) val ) ; text = pr_gid2str ( p , gid ) ; break ; } case LOGFMT_META_BYTES_SENT : case LOGFMT_META_FILE_OFFSET : case LOGFMT_META_FILE_SIZE : case LOGFMT_META_RAW_BYTES_IN : case LOGFMT_META_RAW_BYTES_OUT : case LOGFMT_META_RESPONSE_MS : case LOGFMT_META_XFER_MS : { off_t num ; num = * ( ( double * ) val ) ; text_len = pr_snprintf ( buf , sizeof ( buf ) - 1 , "%" PR_LU , ( pr_off_t ) num ) ; buf [ text_len ] = '\0' ; text = buf ; break ; } case LOGFMT_META_EPOCH : case LOGFMT_META_PID : { unsigned long num ; num = * ( ( double * ) val ) ; text_len = pr_snprintf ( buf , sizeof ( buf ) - 1 , "%lu" , num ) ; buf [ text_len ] = '\0' ; text = buf ; break ; } case LOGFMT_META_FILE_MODIFIED : { int truth ; truth = * ( ( int * ) val ) ; text = truth ?"true" : "false" ; break ; } case LOGFMT_META_SECONDS : { float num ; num = * ( ( double * ) val ) ; text_len = pr_snprintf ( buf , sizeof ( buf ) - 1 , "%0.3f" , num ) ; buf [ text_len ] = '\0' ; text = buf ; break ; } case LOGFMT_META_TIME : { char sign , * time_fmt = "[%d/%b/%Y:%H:%M:%S " ; struct tm t ; int internal_fmt = TRUE , with_tz = FALSE ; if ( jot_hint != NULL ) { time_fmt = ( char * ) jot_hint ; internal_fmt = FALSE ; } t = * get_gmtoff ( p , & with_tz ) ; sign = ( with_tz < 0 ?'-' : '+' ) ; if ( with_tz < 0 ) { with_tz = - with_tz ; } if ( time_fmt != NULL ) { memset ( buf , '\0' , sizeof ( buf ) ) ; text_len = strftime ( buf , sizeof ( buf ) - 1 , time_fmt , & t ) ; if ( internal_fmt == TRUE ) { if ( text_len < sizeof ( buf ) ) { text_len += pr_snprintf ( buf + text_len , sizeof ( buf ) - text_len - 1 , "%c%.2d%.2d]" , sign , ( with_tz / 60 ) , ( with_tz % 60 ) ) ; } } text = buf ; } break ; } case LOGFMT_META_ANON_PASS : case LOGFMT_META_BASENAME : case LOGFMT_META_CLASS : case LOGFMT_META_CMD_PARAMS : case LOGFMT_META_COMMAND : case LOGFMT_META_DIR_NAME : case LOGFMT_META_DIR_PATH : case LOGFMT_META_ENV_VAR : case LOGFMT_META_EOS_REASON : case LOGFMT_META_FILENAME : case LOGFMT_META_GROUP : case LOGFMT_META_IDENT_USER : case LOGFMT_META_ISO8601 : case LOGFMT_META_LOCAL_FQDN : case LOGFMT_META_LOCAL_IP : case LOGFMT_META_LOCAL_NAME : case LOGFMT_META_METHOD : case LOGFMT_META_NOTE_VAR : case LOGFMT_META_ORIGINAL_USER : case LOGFMT_META_PROTOCOL : case LOGFMT_META_REMOTE_HOST : case LOGFMT_META_REMOTE_IP : case LOGFMT_META_RENAME_FROM : case LOGFMT_META_RESPONSE_STR : case LOGFMT_META_USER : case LOGFMT_META_VERSION : case LOGFMT_META_VHOST_IP : case LOGFMT_META_XFER_FAILURE : case LOGFMT_META_XFER_PATH : case LOGFMT_META_XFER_SPEED : case LOGFMT_META_XFER_STATUS : case LOGFMT_META_XFER_TYPE : default : text = val ; break ; } if ( text != NULL && text_len == 0 ) { text_len = strlen ( text ) ; } extlog_buffer_append ( log , text , text_len ) ; } return 0 ; } 