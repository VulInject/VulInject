MOCK_IMPL ( , , ) { char * signed_digest ; size_t keysize ; const int check_objtype = ! ( flags & CST_NO_CHECK_OBJTYPE ) ; tor_assert ( pkey ) ; tor_assert ( tok ) ; tor_assert ( digest ) ; if ( check_objtype ) { if ( strcmp ( tok -> object_type , "SIGNATURE" ) ) { log_warn ( LD_DIR , "Bad object type on %s signature" , doctype ) ; return - 1 ; } } keysize = crypto_pk_keysize ( pkey ) ; signed_digest = tor_malloc ( keysize ) ; if ( crypto_pk_public_checksig ( pkey , signed_digest , keysize , tok -> object_body , tok -> object_size ) < digest_len ) { log_warn ( LD_DIR , "Error reading %s: invalid signature." , doctype ) ; tor_free ( signed_digest ) ; return - 1 ; } if ( ! signed_digest_equals ( ( const uint8_t * ) digest , ( const uint8_t * ) signed_digest , digest_len ) ) { log_warn ( LD_DIR , "Error reading %s: signature does not match." , doctype ) ; tor_free ( signed_digest ) ; return - 1 ; } tor_free ( signed_digest ) ; return 0 ; } 