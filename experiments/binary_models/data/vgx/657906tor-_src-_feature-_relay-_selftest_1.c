void router_perform_bandwidth_test ( int num_circs , time_t now ) { int num_cells = ( int ) ( get_options ( ) -> BandwidthRate * 10 / CELL_MAX_NETWORK_SIZE ) ; int max_cells = num_cells < CIRCWINDOW_START ?num_cells : CIRCWINDOW_START ; int cells_per_circuit = max_cells / num_circs ; origin_circuit_t * circ ; log_notice ( LD_OR , "Performing bandwidth self-test...done." ) ; while ( ( circ = circuit_get_next_by_purpose ( circ , CIRCUIT_PURPOSE_TESTING ) ) ) { int i = cells_per_circuit ; if ( circ -> base_ . state != CIRCUIT_STATE_OPEN ) { continue ; } circ -> base_ . timestamp_dirty = now ; while ( i -- > 0 ) { if ( relay_send_command_from_edge ( 0 , TO_CIRCUIT ( circ ) , RELAY_COMMAND_DROP , NULL , 0 , circ -> cpath -> prev ) < 0 ) { return ; } } } } 