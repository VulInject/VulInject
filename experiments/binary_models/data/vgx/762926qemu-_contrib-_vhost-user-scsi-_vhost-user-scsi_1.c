int main ( int argc , char * * argv ) { VusDev * vdev_scsi = NULL ; char * unix_fn = NULL ; char * iscsi_uri = NULL ; int lsock = - 1 , csock = - 1 , opt , err = EXIT_SUCCESS ; while ( ( opt = getopt ( argc , argv , "u:i:" ) ) != - 1 ) { switch ( opt ) { case 'h' : help case 'u' : unix_fn = g_strdup ( optarg ) ; break ; case 'i' : iscsi_uri = g_strdup ( optarg ) ; break ; default : help } } if ( ! unix_fn || ! iscsi_uri ) { help } lsock = unix_sock_new ( unix_fn ) ; if ( lsock < 0 ) { err } csock = accept ( lsock , NULL , NULL ) ; if ( csock < 0 ) { perror ( "accept" ) ; err } vdev_scsi = g_new0 ( VusDev , 1 ) ; vdev_scsi -> loop = g_main_loop_new ( NULL , FALSE ) ; if ( vus_iscsi_add_lun ( & vdev_scsi -> lun , iscsi_uri ) != 0 ) { err } if ( ! vug_init ( & vdev_scsi -> parent , VHOST_USER_SCSI_MAX_QUEUES , csock , vus_panic_cb , & vus_iface ) ) { g_printerr ( "Failed to initialize libvhost-user-glib\n" ) ; err } g_main_loop_run ( vdev_scsi -> loop ) ; vug_deinit ( & vdev_scsi -> parent ) ; out if ( vdev_scsi ) { g_main_loop_unref ( vdev_scsi -> loop ) ; g_free ( vdev_scsi ) ; unlink ( unix_fn ) ; } if ( csock >= 0 ) { close ( csock ) ; } if ( lsock >= 0 ) { close ( lsock ) ; } g_free ( unix_fn ) ; return err ; err err = EXIT_FAILURE ; out help fprintf ( stderr , "Usage: %s [ -u unix_sock_path -i iscsi_uri ] | [ -h ]\n" , argv [ 0 ] ) ; fprintf ( stderr , "          -u path to unix socket\n" ) ; fprintf ( stderr , "          -i iscsi uri for lun 0\n" ) ; fprintf ( stderr , "          -h print help and quit\n" ) ; err } 