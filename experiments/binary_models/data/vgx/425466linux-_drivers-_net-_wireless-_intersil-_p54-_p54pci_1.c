static int p54p_open ( struct ieee80211_hw * dev ) { struct p54p_priv * priv = dev -> priv ; int err ; long timeout ; init_completion ( & priv -> boot_comp ) ; err = request_irq ( priv -> pdev -> irq , p54p_interrupt , IRQF_SHARED , "p54pci" , dev ) ; if ( err ) { dev_err ( & priv -> pdev -> dev , "failed to register IRQ handler\n" ) ; return err ; } err = p54p_upload_firmware ( dev ) ; if ( err ) { free_irq ( priv -> pdev -> irq , dev ) ; return err ; } priv -> rx_idx_data = priv -> tx_idx_data = 0 ; priv -> rx_idx_mgmt = priv -> tx_idx_mgmt = 0 ; p54p_refill_rx_ring ( dev , 0 , priv -> ring_control -> rx_data , ARRAY_SIZE ( priv -> ring_control -> rx_data ) , priv -> rx_buf_data , 0 ) ; p54p_refill_rx_ring ( dev , 2 , priv -> ring_control -> rx_mgmt , ARRAY_SIZE ( priv -> ring_control -> rx_mgmt ) , priv -> rx_buf_mgmt , 0 ) ; P54P_WRITE ( ring_control_base , cpu_to_le32 ( priv -> ring_control_dma ) ) ; P54P_READ ( ring_control_base ) ; wmb ( ) ; udelay ( 10 ) ; P54P_WRITE ( int_enable , cpu_to_le32 ( ISL38XX_INT_IDENT_INIT ) ) ; P54P_READ ( int_enable ) ; wmb ( ) ; udelay ( 10 ) ; P54P_WRITE ( dev_int , cpu_to_le32 ( ISL38XX_DEV_INT_RESET ) ) ; P54P_READ ( dev_int ) ; timeout = wait_for_completion_interruptible_timeout ( & priv -> boot_comp , HZ ) ; if ( timeout <= 0 ) { wiphy_err ( dev -> wiphy , "Cannot boot firmware!\n" ) ; p54p_stop ( dev ) ; return timeout ?- ERESTARTSYS : - ETIMEDOUT ; } P54P_WRITE ( int_enable , cpu_to_le32 ( ISL38XX_INT_IDENT_UPDATE ) ) ; P54P_READ ( int_enable ) ; wmb ( ) ; udelay ( 10 ) ; P54P_WRITE ( dev_int , cpu_to_le32 ( ISL38XX_DEV_INT_UPDATE ) ) ; P54P_READ ( dev_int ) ; wmb ( ) ; udelay ( 10 ) ; return 0 ; } 