void xfs_iflush_done ( struct xfs_buf * bp , struct xfs_log_item * lip ) { struct xfs_inode_log_item * iip ; struct xfs_log_item * blip ; struct xfs_log_item * next ; struct xfs_log_item * prev ; struct xfs_ail * ailp = lip -> li_ailp ; int need_ail = 0 ; blip = bp -> b_fspriv ; prev = NULL ; while ( blip != NULL ) { if ( blip -> li_cb != xfs_iflush_done ) { prev = blip ; blip = blip -> li_bio_list ; continue ; } next = blip -> li_bio_list ; if ( ! prev ) { bp -> b_fspriv = next ; } else { prev -> li_bio_list = next ; } blip -> li_bio_list = lip -> li_bio_list ; lip -> li_bio_list = blip ; iip = INODE_ITEM ( blip , NULL ) ; if ( iip -> ili_logged && blip -> li_lsn == iip -> ili_flush_lsn ) { need_ail ++ ; } blip = next ; } iip = INODE_ITEM ( lip ) ; if ( iip -> ili_logged && lip -> li_lsn == iip -> ili_flush_lsn ) { need_ail ++ ; } if ( need_ail ) { bool mlip_changed = false ; spin_lock ( & ailp -> xa_lock ) ; for ( blip = lip ; blip ; blip = blip -> li_bio_list ) { if ( INODE_ITEM ( blip ) -> ili_logged && blip -> li_lsn == INODE_ITEM ( blip ) -> ili_flush_lsn ) { mlip_changed |= xfs_ail_delete_one ( ailp , blip ) ; } } if ( mlip_changed ) { if ( ! XFS_FORCED_SHUTDOWN ( ailp -> xa_mount ) ) { xlog_assign_tail_lsn_locked ( ailp -> xa_mount ) ; } if ( list_empty ( & ailp -> xa_ail ) ) { wake_up_all ( & ailp -> xa_empty ) ; } } spin_unlock ( & ailp -> xa_lock ) ; if ( mlip_changed ) { xfs_log_space_wake ( ailp -> xa_mount ) ; } } for ( blip = lip ; blip ; blip = next ) { next = blip -> li_bio_list ; blip -> li_bio_list = NULL ; iip = INODE_ITEM ( blip ) ; iip -> ili_logged = 0 ; iip -> ili_last_fields = 0 ; xfs_ifunlock ( iip -> ili_inode ) ; } } 