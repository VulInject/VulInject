static void vb2_dma_sg_put_userptr ( void * buf_priv ) { struct vb2_dma_sg_buf * buf = buf_priv ; struct sg_table * sgt = & buf -> sg_table ; int i = buf -> num_pages ; dprintk ( 1 , "%s: Releasing userspace buffer of %d pages\n" , __func__ , buf -> num_pages ) ; dma_unmap_sg_attrs ( buf -> dev , sgt -> sgl , sgt -> orig_nents , buf -> dma_dir , DMA_ATTR_SKIP_CPU_SYNC ) ; if ( buf -> vaddr ) { vm_unmap_ram ( buf -> vaddr , buf -> num_pages ) ; } sg_free_table ( buf -> dma_sgt ) ; while ( -- i >= 0 ) { if ( buf -> dma_dir == DMA_FROM_DEVICE ) { set_page_dirty_lock ( buf -> pages [ i ] ) ; } } kfree ( buf ) ; } 