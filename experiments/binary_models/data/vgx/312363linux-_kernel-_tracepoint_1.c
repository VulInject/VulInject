static int tracepoint_add_func ( struct tracepoint * tp , struct tracepoint_func * func , int prio , bool warn ) { struct tracepoint_func * old , * tp_funcs ; int ret ; if ( tp -> regfunc && ! static_key_enabled ( & tp -> key ) ) { ret = tp -> regfunc ( ) ; if ( ret < 0 ) { return ret ; } } tp_funcs = rcu_dereference_protected ( tp -> funcs , lockdep_is_held ( & tracepoints_mutex ) ) ; old = func_add ( & tp_funcs , func , prio ) ; if ( IS_ERR ( old ) ) { WARN_ON_ONCE ( warn && PTR_ERR ( old ) != - ENOMEM ) ; return PTR_ERR ( old ) ; } switch ( nr_func_state ( tp_funcs ) ) { case TP_FUNC_1 : tp_rcu_cond_sync ( TP_TRANSITION_SYNC_1_0_1 ) ; tracepoint_update_call ( tp , tp_funcs ) ; rcu_assign_pointer ( tp -> funcs , tp_funcs ) ; static_key_enable ( & tp -> key ) ; break ; case TP_FUNC_2 : tracepoint_update_call ( tp , tp_funcs ) ; fallthrough ; case TP_FUNC_N : rcu_assign_pointer ( tp -> funcs , tp_funcs ) ; if ( tp_funcs [ 0 ] . data != old [ 0 ] . data ) { tp_rcu_get_state ( TP_TRANSITION_SYNC_N_2_1 ) ; } break ; default : WARN_ON_ONCE ( 1 ) ; break ; } return 0 ; } 