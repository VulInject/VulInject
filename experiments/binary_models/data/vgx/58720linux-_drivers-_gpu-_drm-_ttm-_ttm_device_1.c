static int ttm_global_init ( void ) { struct ttm_global * glob = & ttm_glob ; unsigned long num_pages , num_dma32 ; struct sysinfo si ; int ret = 0 ; mutex_lock ( & ttm_global_mutex ) ; if ( ++ ttm_glob_use_count > 1 ) { out } si_meminfo ( & si ) ; ttm_debugfs_root = debugfs_create_dir ( "ttm" , NULL ) ; if ( IS_ERR ( ttm_debugfs_root ) ) { ttm_debugfs_root = NULL ; } num_pages = ( ( u64 ) si . totalram * si . mem_unit ) >> PAGE_SHIFT ; num_pages /= 2 ; num_dma32 = ( u64 ) ( si . totalram - si . totalhigh ) * si . mem_unit >> PAGE_SHIFT ; num_dma32 = min ( num_dma32 , 2UL << ( 30 - PAGE_SHIFT ) ) ; ttm_pool_mgr_init ( num_pages , NULL ) ; ttm_tt_mgr_init ( num_pages , num_dma32 ) ; glob -> dummy_read_page = alloc_page ( __GFP_ZERO | GFP_DMA32 ) ; if ( unlikely ( glob -> dummy_read_page == NULL ) ) { ret = - ENOMEM ; out } INIT_LIST_HEAD ( & glob -> device_list ) ; atomic_set ( & glob -> bo_count , 0 ) ; debugfs_create_atomic_t ( "buffer_objects" , 0444 , ttm_debugfs_root , & glob -> bo_count ) ; out if ( ret && ttm_debugfs_root ) { debugfs_remove ( ttm_debugfs_root ) ; } if ( ret ) { -- ttm_glob_use_count ; } mutex_unlock ( & ttm_global_mutex ) ; return ret ; } 