void rate_control_rate_init ( struct sta_info * sta ) { struct ieee80211_local * local = sta -> sdata -> local ; struct rate_control_ref * ref = sta -> rate_ctrl ; struct ieee80211_sta * ista = & sta -> sta ; void * priv_sta = sta -> rate_ctrl_priv ; struct ieee80211_supported_band * sband ; struct ieee80211_chanctx_conf * chanctx_conf ; ieee80211_sta_set_rx_nss ( & sta -> deflink ) ; rcu_read_lock ( ) ; chanctx_conf = rcu_dereference ( sta -> sdata -> vif . bss_conf . chanctx_conf ) ; if ( WARN_ON ( ! chanctx_conf ) ) { rcu_read_unlock ( ) ; return ; } sband = local -> hw . wiphy -> bands [ chanctx_conf -> def . chan -> band ] ; if ( sband -> band == NL80211_BAND_S1GHZ ) { ieee80211_s1g_sta_rate_init ( sta ) ; rcu_read_unlock ( ) ; return ; } spin_lock_bh ( & sta -> rate_ctrl_lock ) ; ref -> ops -> rate_init ( ref -> priv , sband , & chanctx_conf -> def , ista , priv_sta ) ; spin_unlock_bh ( & sta -> rate_ctrl_lock ) ; rcu_read_unlock ( ) ; set_sta_flag ( sta , WLAN_STA_RATE_CONTROL ) ; } 