int i915_sw_fence_await_reservation ( struct i915_sw_fence * fence , struct reservation_object * resv , const struct dma_fence_ops * exclude , bool write , unsigned long timeout , gfp_t gfp ) { struct dma_fence * excl ; int ret = 0 , pending ; debug_fence_assert ( fence ) ; if ( write ) { struct dma_fence * * shared ; unsigned int count , i ; ret = reservation_object_get_fences_rcu ( resv , & excl , & count , & shared ) ; if ( ret ) { return ret ; } for ( i = 0 ; i < count ; i ++ ) { if ( shared [ i ] -> ops == exclude ) { continue ; } pending = i915_sw_fence_await_dma_fence ( fence , shared [ i ] , timeout , gfp ) ; if ( pending < 0 ) { ret = pending ; break ; } ret |= pending ; } for ( i = 0 ; i < count ; i ++ ) { dma_fence_put ( shared [ i ] ) ; } } else { excl = reservation_object_get_excl_rcu ( resv ) ; } if ( ret >= 0 && excl && excl -> ops != exclude ) { pending = i915_sw_fence_await_dma_fence ( fence , excl , timeout , gfp ) ; if ( pending < 0 ) { ret = pending ; } else { ret |= pending ; } } dma_fence_put ( excl ) ; return ret ; } 