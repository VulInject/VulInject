void fenced_register_level ( xmlNode * msg , char * * desc , pcmk__action_result_t * result ) { int id = 0 ; xmlNode * level ; enum fenced_target_by mode ; char * target ; stonith_topology_t * tp ; stonith_key_value_t * dIter = NULL ; stonith_key_value_t * devices = NULL ; CRM_CHECK ( , ) level = unpack_level_request ( msg , & mode , & target , & id , desc ) ; if ( level == NULL ) { fenced_set_protocol_error ( result ) ; return ; } if ( pcmk__str_empty ( ID ( level ) ) ) { crm_warn ( "Ignoring registration for topology level without ID" ) ; crm_log_xml_trace ( level , "Bad level" ) ; pcmk__format_result ( result , CRM_EX_INVALID_PARAM , PCMK_EXEC_INVALID , "Topology level is invalid without ID" ) ; return ; } if ( mode == fenced_target_by_unknown ) { crm_warn ( "Ignoring registration for topology level '%s' " "without valid target" , ID ( level ) ) ; free ( target ) ; crm_log_xml_trace ( level , "Bad level" ) ; pcmk__format_result ( result , CRM_EX_INVALID_PARAM , PCMK_EXEC_INVALID , "Invalid target for topology level '%s'" , ID ( level ) ) ; return ; } if ( ( id <= 0 ) || ( id >= ST_LEVEL_MAX ) ) { crm_warn ( "Ignoring topology registration for %s with invalid level %d" , target , id ) ; free ( target ) ; crm_log_xml_trace ( level , "Bad level" ) ; pcmk__format_result ( result , CRM_EX_INVALID_PARAM , PCMK_EXEC_INVALID , "Invalid level number '%s' for topology level '%s'" , pcmk__s ( crm_element_value ( level , XML_ATTR_STONITH_INDEX ) , "" ) , ID ( level ) ) ; return ; } tp = g_hash_table_lookup ( topology , target ) ; if ( tp == NULL ) { tp = calloc ( 1 , sizeof ( stonith_topology_t ) ) ; if ( tp == NULL ) { pcmk__set_result ( result , CRM_EX_ERROR , PCMK_EXEC_ERROR , strerror ( ENOMEM ) ) ; free ( target ) ; return ; } tp -> kind = mode ; tp -> target = target ; tp -> target_value = crm_element_value_copy ( level , XML_ATTR_STONITH_TARGET_VALUE ) ; tp -> target_pattern = crm_element_value_copy ( level , XML_ATTR_STONITH_TARGET_PATTERN ) ; tp -> target_attribute = crm_element_value_copy ( level , XML_ATTR_STONITH_TARGET_ATTRIBUTE ) ; g_hash_table_replace ( topology , tp -> target , tp ) ; crm_trace ( "Added %s (%d) to the topology (%d active entries)" , target , ( int ) mode , g_hash_table_size ( topology ) ) ; } else { free ( target ) ; } if ( tp -> levels [ id ] != NULL ) { crm_info ( "Adding to the existing %s[%d] topology entry" , tp -> target , id ) ; } devices = parse_device_list ( crm_element_value ( level , XML_ATTR_STONITH_DEVICES ) ) ; for ( dIter = devices ; dIter ; dIter = dIter -> next ) { const char * device = dIter -> value ; crm_trace ( "Adding device '%s' for %s[%d]" , device , tp -> target , id ) ; tp -> levels [ id ] = g_list_append ( tp -> levels [ id ] , strdup ( device ) ) ; } stonith_key_value_freeall ( devices , 1 , 1 ) ; { int nlevels = count_active_levels ( tp ) ; crm_info ( "Target %s has %d active fencing level%s" , tp -> target , nlevels , pcmk__plural_s ( nlevels ) ) ; } pcmk__set_result ( result , CRM_EX_OK , PCMK_EXEC_DONE , NULL ) ; } 