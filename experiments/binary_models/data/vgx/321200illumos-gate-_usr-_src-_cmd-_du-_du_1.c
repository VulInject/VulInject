int main ( int argc , char * * argv ) { blkcnt_t blocks = 0 ; int c ; extern int optind ; char * np ; pid_t pid , wpid ; int status , retcode = 0 ; setbuf ( stderr , NULL ) ; ( void ) setlocale ( LC_ALL , "" ) ; ( void ) textdomain ( TEXT_DOMAIN ) ; rflg ++ ; while ( ( c = getopt ( argc , argv , "aAdhHkLmorsx" ) ) != EOF ) { switch ( c ) { case 'a' : aflg ++ ; continue ; case 'h' : hflg ++ ; kflg = 0 ; mflg = 0 ; continue ; case 'r' : rflg ++ ; continue ; case 's' : sflg ++ ; continue ; case 'k' : kflg ++ ; hflg = 0 ; mflg = 0 ; continue ; case 'm' : mflg ++ ; hflg = 0 ; kflg = 0 ; continue ; case 'o' : oflg ++ ; continue ; case 'd' : dflg ++ ; continue ; case 'x' : dflg ++ ; continue ; case 'A' : Aflg ++ ; continue ; case 'H' : Hflg ++ ; Lflg = 0 ; cmdarg ++ ; continue ; case 'L' : Lflg ++ ; Hflg = 0 ; cmdarg = 0 ; continue ; case '?' : ( void ) fprintf ( stderr , gettext ( "usage: du [-Adorx] [-a|-s][-h|-k|-m] [-H|-L]" "[file...]\n" ) ) ; exit ( 2 ) ; } } if ( optind == argc ) { argv = & dot ; argc = 1 ; optind = 0 ; } if ( oflg && sflg ) { oflg = 0 ; } if ( ( base = ( char * ) calloc ( base_len , sizeof ( char ) ) ) == NULL ) { perror ( "du" ) ; exit ( 1 ) ; } if ( ( name = ( char * ) calloc ( name_len , sizeof ( char ) ) ) == NULL ) { perror ( "du" ) ; exit ( 1 ) ; } { if ( optind < argc - 1 ) { pid = fork ( ) ; if ( pid == ( pid_t ) - 1 ) { perror ( gettext ( "du: No more processes" ) ) ; exitdu ( 1 ) ; } if ( pid != 0 ) { while ( ( wpid = wait ( & status ) ) != pid && wpid != ( pid_t ) - 1 ) { } if ( pid != ( pid_t ) - 1 && status != 0 ) { retcode = 1 ; } } } if ( optind == argc - 1 || pid == 0 ) { while ( base_len < ( strlen ( argv [ optind ] ) + 1 ) ) { base_len = base_len * 2 ; if ( ( base = ( char * ) realloc ( base , base_len * sizeof ( char ) ) ) == NULL ) { if ( rflg ) { ( void ) fprintf ( stderr , gettext ( "du: can't process %s" ) , argv [ optind ] ) ; perror ( "" ) ; } exitdu ( 1 ) ; } } if ( base_len > name_len ) { name_len = base_len ; if ( ( name = ( char * ) realloc ( name , name_len * sizeof ( char ) ) ) == NULL ) { if ( rflg ) { ( void ) fprintf ( stderr , gettext ( "du: can't process %s" ) , argv [ optind ] ) ; perror ( "" ) ; } exitdu ( 1 ) ; } } ( void ) strcpy ( base , argv [ optind ] ) ; ( void ) strcpy ( name , argv [ optind ] ) ; if ( np = strrchr ( name , '/' ) ) { * np ++ = '\0' ; if ( chdir ( * name ?name : "/" ) < 0 ) { if ( rflg ) { ( void ) fprintf ( stderr , "du: " ) ; perror ( * name ?name : "/" ) ; exitdu ( 1 ) ; } exitdu ( 0 ) ; } } else { np = base ; } blocks = descend ( * np ?np : "." , 0 , & retcode , ( dev_t ) 0 ) ; if ( sflg ) { printsize ( blocks , base ) ; } if ( optind < argc - 1 ) { exitdu ( retcode ) ; } } optind ++ ; } optind < argc ; exitdu ( retcode ) ; return ( retcode ) ; } 