static void cmm_get_mpp ( void ) { const long __loaned_pages = atomic_long_read ( & loaned_pages ) ; const long total_pages = totalram_pages ( ) + __loaned_pages ; int rc ; struct hvcall_mpp_data mpp_data ; signed long active_pages_target , page_loan_request , target ; signed long min_mem_pages = ( min_mem_mb * 1024 * 1024 ) / PAGE_SIZE ; if ( likely ( ! simulate ) ) { rc = h_get_mpp ( & mpp_data ) ; page_loan_request = div_s64 ( ( s64 ) mpp_data . loan_request , PAGE_SIZE ) ; target = page_loan_request + __loaned_pages ; } else { target = KB2PAGES ( simulate_loan_target_kb ) ; page_loan_request = target - __loaned_pages ; } if ( target < 0 || total_pages < min_mem_pages ) { target = 0 ; } if ( target > oom_freed_pages ) { target -= oom_freed_pages ; } else { target = 0 ; } active_pages_target = total_pages - target ; if ( min_mem_pages > active_pages_target ) { target = total_pages - min_mem_pages ; } if ( target < 0 ) { target = 0 ; } loaned_pages_target = target ; cmm_dbg ( "delta = %ld, loaned = %lu, target = %lu, oom = %lu, totalram = %lu\n" , page_loan_request , __loaned_pages , loaned_pages_target , oom_freed_pages , totalram_pages ( ) ) ; } static struct notifier_block cmm_oom_nb = { . notifier_call = cmm_oom_notify } ; 