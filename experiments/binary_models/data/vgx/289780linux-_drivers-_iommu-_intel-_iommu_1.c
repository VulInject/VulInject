static void dmar_remove_one_dev_info ( struct device * dev ) { struct device_domain_info * info = dev_iommu_priv_get ( dev ) ; struct dmar_domain * domain = info -> domain ; struct intel_iommu * iommu = info -> iommu ; unsigned long flags ; if ( ! dev_is_real_dma_subdevice ( info -> dev ) ) { if ( dev_is_pci ( info -> dev ) && sm_supported ( iommu ) ) { intel_pasid_tear_down_entry ( iommu , info -> dev , PASID_RID2PASID , false ) ; } iommu_disable_pci_caps ( info ) ; domain_context_clear ( info ) ; } spin_lock_irqsave ( & domain -> lock , flags ) ; list_del ( & info -> link ) ; spin_unlock_irqrestore ( & domain -> lock , flags ) ; domain_detach_iommu ( domain , iommu ) ; } 