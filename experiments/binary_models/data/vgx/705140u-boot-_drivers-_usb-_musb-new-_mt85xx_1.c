static int musb_usb_probe ( struct udevice * dev ) { struct mtk_musb_glue * glue = dev_get_priv ( dev ) ; struct musb_host_data * host = & glue -> mdata ; struct musb_hdrc_platform_data pdata ; void * base = dev_read_addr_ptr ( dev ) ; int ret ; DBG_I ( "%s():\n" , __func__ ) ; struct usb_bus_priv * priv = dev_get_uclass_priv ( dev ) ; if ( ! base ) { return - EINVAL ; } glue -> cfg = ( mtk_musb_config * ) dev_get_driver_data ( dev ) ; if ( ! glue -> cfg ) { return - EINVAL ; } ret = clk_get_by_name ( dev , "usbpll" , & glue -> usbpllclk ) ; if ( ret ) { dev_err ( dev , "failed to get usbpll clock\n" ) ; return ret ; } ret = clk_get_by_name ( dev , "usbmcu" , & glue -> usbmcuclk ) ; if ( ret ) { dev_err ( dev , "failed to get usbmcu clock\n" ) ; return ret ; } ret = clk_get_by_name ( dev , "usb" , & glue -> usbclk ) ; if ( ret ) { dev_err ( dev , "failed to get usb clock\n" ) ; return ret ; } pdata . power = ( u8 ) 400 ; pdata . platform_ops = & mtk_musb_ops ; pdata . config = glue -> cfg -> config ; priv -> desc_before_addr = true ; pdata . mode = MUSB_HOST ; host -> host = musb_init_controller ( & pdata , & glue -> dev , base ) ; if ( ! host -> host ) { return - EIO ; } ret = musb_lowlevel_init ( host ) ; if ( ! ret ) { printf ( "MTK MUSB OTG (Host)\n" ) ; } pdata . mode = MUSB_PERIPHERAL ; host -> host = musb_register ( & pdata , & glue -> dev , base ) ; if ( ! host -> host ) { return - EIO ; } printf ( "MTK MUSB OTG (Peripheral)\n" ) ; mt_usb_phy_poweron ( ) ; return ret ; } 