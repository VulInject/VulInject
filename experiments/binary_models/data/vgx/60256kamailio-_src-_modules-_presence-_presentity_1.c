int ps_db_delete_presentity_if_dialog_id_exists ( presentity_t * presentity , char * dialog_id ) { db_key_t query_cols [ 13 ] , result_cols [ 6 ] ; db_op_t query_ops [ 13 ] ; db_val_t query_vals [ 13 ] ; int n_query_cols = 0 ; int rez_body_col = 0 , rez_etag_col = 0 , n_result_cols = 0 ; db1_res_t * result = NULL ; db_row_t * row = NULL ; db_val_t * row_vals = NULL ; char * db_dialog_id = NULL ; int db_is_dialog = 0 ; str tmp_db_body , tmp_db_etag ; int i = 0 ; presentity_t old_presentity ; if ( presentity -> event -> evp -> type != EVENT_DIALOG ) { return 0 ; } query_cols [ n_query_cols ] = & str_domain_col ; query_ops [ n_query_cols ] = OP_EQ ; query_vals [ n_query_cols ] . type = DB1_STR ; query_vals [ n_query_cols ] . nul = 0 ; query_vals [ n_query_cols ] . val . str_val = presentity -> domain ; n_query_cols ++ ; query_cols [ n_query_cols ] = & str_username_col ; query_ops [ n_query_cols ] = OP_EQ ; query_vals [ n_query_cols ] . type = DB1_STR ; query_vals [ n_query_cols ] . nul = 0 ; query_vals [ n_query_cols ] . val . str_val = presentity -> user ; n_query_cols ++ ; query_cols [ n_query_cols ] = & str_event_col ; query_ops [ n_query_cols ] = OP_EQ ; query_vals [ n_query_cols ] . type = DB1_STR ; query_vals [ n_query_cols ] . nul = 0 ; query_vals [ n_query_cols ] . val . str_val = presentity -> event -> name ; n_query_cols ++ ; result_cols [ rez_body_col = n_result_cols ++ ] = & str_body_col ; result_cols [ rez_etag_col = n_result_cols ++ ] = & str_etag_col ; if ( pa_dbf . use_table ( pa_db , & presentity_table ) < 0 ) { LM_ERR ( "unsuccessful sql use table\n" ) ; return - 1 ; } if ( pa_dbf . query ( pa_db , query_cols , query_ops , query_vals , result_cols , n_query_cols , n_result_cols , 0 , & result ) < 0 ) { LM_ERR ( "unsuccessful sql query\n" ) ; return - 2 ; } if ( result -> n <= 0 ) { pa_dbf . free_result ( pa_db , result ) ; return 0 ; } for ( i = 0 ; i < result -> n ; i ++ ) { row = & result -> rows [ i ] ; row_vals = ROW_VALUES ( row ) ; tmp_db_body . s = ( char * ) row_vals [ rez_body_col ] . val . string_val ; tmp_db_body . len = strlen ( tmp_db_body . s ) ; tmp_db_etag . s = ( char * ) row_vals [ rez_etag_col ] . val . string_val ; tmp_db_etag . len = strlen ( tmp_db_etag . s ) ; if ( check_if_dialog ( tmp_db_body , & db_is_dialog , & db_dialog_id ) == 0 ) { if ( db_dialog_id && ! strcmp ( db_dialog_id , dialog_id ) ) { old_presentity . domain = presentity -> domain ; old_presentity . user = presentity -> user ; old_presentity . event = presentity -> event ; old_presentity . etag = tmp_db_etag ; LM_DBG ( "Presentity found - deleting it\n" ) ; if ( delete_presentity ( & old_presentity , NULL ) < 0 ) { LM_ERR ( "failed to delete presentity\n" ) ; } pa_dbf . free_result ( pa_db , result ) ; result = NULL ; free ( db_dialog_id ) ; db_dialog_id = NULL ; return 1 ; } free ( db_dialog_id ) ; db_dialog_id = NULL ; } } pa_dbf . free_result ( pa_db , result ) ; result = NULL ; return 0 ; } 