static int DNP3ParserTestPartialFrame ( void ) { DNP3State * state = NULL ; DNP3Transaction * tx ; int r ; uint8_t request_partial1 [ ] { 0x05 0x64 0x1a 0xc4 0x02 0x00 0x01 0x00 0xa5 0xe9 0xff 0xc9 0x05 0x0c 0x01 0x28 0x01 0x00 0x00 } ; ; uint8_t request_partial2 [ ] { 0x00 0x01 0x01 0x01 0x00 0x00 0x00 0x72 0xef 0x00 0x00 0x00 0x00 0x00 0xff 0xff } ; ; uint8_t response_partial1 [ ] { 0x05 0x64 0x1c 0x44 0x01 0x00 0x02 0x00 0xe2 0x59 0xc3 0xc9 0x81 0x00 0x00 0x0c 0x01 0x28 0x01 } ; ; uint8_t response_partial2 [ ] { 0x00 0x00 0x00 0x01 0x01 0x01 0x00 0x7a 0x65 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xff 0xff } ; ; AppLayerParserThreadCtx * alp_tctx = AppLayerParserThreadCtxAlloc ( ) ; Flow flow ; TcpSession ssn ; memset ( & ssn , 0 , sizeof ( ssn ) ) ; flow . protoctx = ( void * ) & ssn ; flow . proto = IPPROTO_TCP ; flow . alproto = ALPROTO_DNP3 ; StreamTcpInitConfig ( true ) ; SCMutexLock ( & flow . m ) ; r = AppLayerParserParse ( NULL , alp_tctx , & flow , ALPROTO_DNP3 , STREAM_TOSERVER , request_partial1 , sizeof ( request_partial1 ) ) ; SCMutexUnlock ( & flow . m ) ; FAIL_IF ( r != 0 ) ; state = flow . alstate ; FAIL_IF ( state == NULL ) ; FAIL_IF ( state -> request_buffer . len != sizeof ( request_partial1 ) ) ; FAIL_IF ( state -> request_buffer . offset != 0 ) ; FAIL_IF ( memcmp ( state -> request_buffer . buffer , request_partial1 , sizeof ( request_partial1 ) ) ) ; FAIL_IF ( state -> transaction_max != 0 ) ; FAIL_IF ( DNP3GetTx ( state , 0 ) != NULL ) ; SCMutexLock ( & flow . m ) ; r = AppLayerParserParse ( NULL , alp_tctx , & flow , ALPROTO_DNP3 , STREAM_TOSERVER , request_partial2 , sizeof ( request_partial2 ) ) ; SCMutexUnlock ( & flow . m ) ; FAIL_IF ( r != 0 ) ; FAIL_IF ( state -> request_buffer . len != 0 ) ; FAIL_IF ( state -> request_buffer . offset != 0 ) ; tx = DNP3GetTx ( state , 0 ) ; FAIL_IF ( tx == NULL ) ; FAIL_IF ( tx -> tx_num != 1 ) ; FAIL_IF ( tx != state -> curr ) ; FAIL_IF ( tx -> buffer == NULL ) ; FAIL_IF ( tx -> buffer_len != 20 ) ; FAIL_IF ( tx -> ah . function_code != DNP3_APP_FC_DIR_OPERATE ) ; SCMutexLock ( & flow . m ) ; r = AppLayerParserParse ( NULL , alp_tctx , & flow , ALPROTO_DNP3 , STREAM_TOCLIENT , response_partial1 , sizeof ( response_partial1 ) ) ; SCMutexUnlock ( & flow . m ) ; FAIL_IF ( r != 0 ) ; FAIL_IF ( state -> response_buffer . len != sizeof ( response_partial1 ) ) ; FAIL_IF ( state -> response_buffer . offset != 0 ) ; tx = DNP3GetTx ( state , 1 ) ; FAIL_IF_NOT_NULL ( tx ) ; SCMutexLock ( & flow . m ) ; r = AppLayerParserParse ( NULL , alp_tctx , & flow , ALPROTO_DNP3 , STREAM_TOCLIENT , response_partial2 , sizeof ( response_partial2 ) ) ; SCMutexUnlock ( & flow . m ) ; FAIL_IF ( r != 0 ) ; FAIL_IF ( state -> response_buffer . len != 0 ) ; FAIL_IF ( state -> response_buffer . offset != 0 ) ; tx = DNP3GetTx ( state , 1 ) ; FAIL_IF_NULL ( tx ) ; FAIL_IF ( tx -> buffer == NULL ) ; FAIL_IF ( tx -> buffer_len == 0 ) ; AppLayerParserThreadCtxFree ( alp_tctx ) ; StreamTcpFreeConfig ( true ) ; FLOW_DESTROY ( & flow ) ; PASS ; } 