static void __update_hugetlb ( struct vm_area_struct * vma , unsigned long address , pte_t * ptep ) { int idx ; unsigned long lo ; unsigned long flags ; local_irq_save ( flags ) ; address &= ( PAGE_MASK << 1 ) ; write_csr_entryhi ( address ) ; tlb_probe ( ) ; idx = read_csr_tlbidx ( ) ; write_csr_pagesize ( PS_HUGE_SIZE ) ; lo = pmd_to_entrylo ( pte_val ( * ptep ) ) ; write_csr_entrylo0 ( lo , NULL ) ; write_csr_entrylo1 ( lo + ( HPAGE_SIZE >> 1 ) ) ; if ( idx < 0 ) { tlb_write_random ( ) ; } else { tlb_write_indexed ( ) ; } write_csr_pagesize ( PS_DEFAULT_SIZE ) ; local_irq_restore ( flags ) ; } 