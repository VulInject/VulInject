static lockdownd_error_t lockdownd_do_start_service ( lockdownd_client_t client , const char * identifier , int send_escrow_bag , lockdownd_service_descriptor_t * service ) { if ( ! client || ! identifier || ! service ) { return LOCKDOWN_E_INVALID_ARG ; } if ( * service ) { ( * service ) -> port = 0 ; ( * service ) -> ssl_enabled = 0 ; } plist_t dict = NULL ; uint16_t port_loc = 0 ; lockdownd_error_t ret = LOCKDOWN_E_UNKNOWN_ERROR ; ret = lockdownd_build_start_service_request ( client , identifier , send_escrow_bag , & dict ) ; ret = lockdownd_send ( client , dict ) ; plist_free ( dict ) ; dict = NULL ; if ( LOCKDOWN_E_SUCCESS != ret ) { return ret ; } ret = lockdownd_receive ( client , & dict ) ; if ( LOCKDOWN_E_SUCCESS != ret ) { return ret ; } if ( ! dict ) { return LOCKDOWN_E_PLIST_ERROR ; } ret = lockdown_check_result ( dict , "StartService" ) ; if ( ret == LOCKDOWN_E_SUCCESS ) { if ( * service == NULL ) { * service = ( lockdownd_service_descriptor_t ) malloc ( sizeof ( lockdownd_service_descriptor ) ) ; } ( * service ) -> port = 0 ; ( * service ) -> ssl_enabled = 0 ; ( * service ) -> identifier = strdup ( identifier ) ; plist_t node = plist_dict_get_item ( dict , "Port" ) ; if ( node && ( plist_get_node_type ( node ) == PLIST_UINT ) ) { uint64_t port_value = 0 ; plist_get_uint_val ( node , & port_value ) ; if ( port_value ) { port_loc = port_value ; ret = LOCKDOWN_E_SUCCESS ; } if ( port_loc && ret == LOCKDOWN_E_SUCCESS ) { ( * service ) -> port = port_loc ; } } node = plist_dict_get_item ( dict , "EnableServiceSSL" ) ; if ( node && ( plist_get_node_type ( node ) == PLIST_BOOLEAN ) ) { uint8_t b = 0 ; plist_get_bool_val ( node , & b ) ; ( * service ) -> ssl_enabled = b ; } } else { plist_t error_node = plist_dict_get_item ( dict , "Error" ) ; if ( error_node && PLIST_STRING == plist_get_node_type ( error_node ) ) { char * error = NULL ; plist_get_string_val ( error_node , & error ) ; ret = lockdownd_strtoerr ( error ) ; free ( error ) ; } } plist_free ( dict ) ; dict = NULL ; return ret ; } 