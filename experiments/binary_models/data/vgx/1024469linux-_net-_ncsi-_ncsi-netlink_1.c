static int ncsi_set_channel_mask_nl ( struct sk_buff * msg , struct genl_info * info ) { struct ncsi_package * np , * package ; struct ncsi_channel * nc , * channel ; u32 package_id , channel_id ; struct ncsi_dev_priv * ndp ; unsigned long flags ; if ( ! info || ! info -> attrs ) { return - EINVAL ; } if ( ! info -> attrs [ NCSI_ATTR_IFINDEX ] ) { return - EINVAL ; } if ( ! info -> attrs [ NCSI_ATTR_PACKAGE_ID ] ) { return - EINVAL ; } if ( ! info -> attrs [ NCSI_ATTR_CHANNEL_MASK ] ) { return - EINVAL ; } ndp = ndp_from_ifindex ( get_net ( sock_net ( msg -> sk ) ) , nla_get_u32 ( info -> attrs [ NCSI_ATTR_IFINDEX ] ) ) ; if ( ! ndp ) { return - ENODEV ; } package_id = nla_get_u32 ( info -> attrs [ NCSI_ATTR_PACKAGE_ID ] ) ; NCSI_FOR_EACH_PACKAGE ( , ) if ( np -> id == package_id ) { package = np ; break ; } if ( ! package ) { return - ERANGE ; } spin_lock_irqsave ( & package -> lock , flags ) ; channel = NULL ; if ( info -> attrs [ NCSI_ATTR_CHANNEL_ID ] ) { channel_id = nla_get_u32 ( info -> attrs [ NCSI_ATTR_CHANNEL_ID ] ) ; NCSI_FOR_EACH_CHANNEL ( , ) if ( nc -> id == channel_id ) { channel = nc ; break ; } if ( ! channel ) { spin_unlock_irqrestore ( & package -> lock , flags ) ; return - ERANGE ; } netdev_dbg ( ndp -> ndev . dev , "NCSI: Channel %u set as preferred channel\n" , channel -> id ) ; } package -> channel_whitelist = nla_get_u32 ( info -> attrs [ NCSI_ATTR_CHANNEL_MASK ] ) ; if ( package -> channel_whitelist == 0 ) { netdev_dbg ( ndp -> ndev . dev , "NCSI: Package %u set to all channels disabled\n" , package -> id ) ; } package -> preferred_channel = channel ; if ( nla_get_flag ( info -> attrs [ NCSI_ATTR_MULTI_FLAG ] ) ) { package -> multi_channel = true ; netdev_info ( ndp -> ndev . dev , "NCSI: Multi-channel enabled on package %u\n" , package_id ) ; } else { package -> multi_channel = false ; } spin_unlock_irqrestore ( & package -> lock , flags ) ; if ( ! ( ndp -> flags & NCSI_DEV_RESET ) ) { ncsi_reset_dev ( & ndp -> ndev ) ; } return 0 ; } 