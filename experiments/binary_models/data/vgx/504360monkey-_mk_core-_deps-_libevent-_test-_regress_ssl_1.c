X509 * ssl_getcert ( void ) { X509 * x509 = NULL ; X509_NAME * name = NULL ; EVP_PKEY * key = ssl_getkey ( ) ; int nid ; time_t now = time ( NULL ) ; tt_assert ( key ) ; x509 = X509_new ( ) ; tt_assert ( x509 ) ; tt_assert ( 0 != X509_set_version ( x509 , 2 ) ) ; tt_assert ( 0 != ASN1_INTEGER_set ( X509_get_serialNumber ( x509 ) , ( long ) now ) ) ; name = X509_NAME_new ( ) ; tt_assert ( name ) ; nid = OBJ_txt2nid ( "commonName" ) ; tt_assert ( NID_undef != nid ) ; tt_assert ( 0 != X509_NAME_add_entry_by_NID ( name , nid , MBSTRING_ASC , ( unsigned char * ) "example.com" , - 1 , - 1 , 0 ) ) ; X509_set_subject_name ( x509 , name ) ; X509_set_issuer_name ( x509 , name ) ; X509_time_adj ( X509_get_notBefore ( x509 ) , 0 , & now ) ; now += 3600 ; X509_time_adj ( X509_get_notAfter ( x509 ) , 0 , & now ) ; X509_set_pubkey ( x509 , key ) ; tt_assert ( 0 != X509_sign ( x509 , key , EVP_sha1 ( ) ) ) ; return x509 ; end return NULL ; } 