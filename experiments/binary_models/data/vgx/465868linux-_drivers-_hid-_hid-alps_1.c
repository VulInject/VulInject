static int t4_read_write_register ( struct hid_device * hdev , u32 address , u8 * read_val , u8 write_val , bool read_flag ) { int ret ; u16 check_sum ; u8 * input ; u8 * readbuf = NULL ; input = kzalloc ( T4_FEATURE_REPORT_LEN , GFP_KERNEL ) ; if ( ! input ) { return - ENOMEM ; } input [ 0 ] = T4_FEATURE_REPORT_ID ; if ( read_flag ) { input [ 1 ] = T4_CMD_REGISTER_READ ; input [ 8 ] = 0x00 ; } else { input [ 1 ] = T4_CMD_REGISTER_WRITE ; input [ 8 ] = write_val ; } put_unaligned_le32 ( address , input + 2 ) ; input [ 6 ] = 1 ; input [ 7 ] = 0 ; check_sum = t4_calc_check_sum ( input , 1 , 8 ) ; input [ 9 ] = ( u8 ) check_sum ; input [ 10 ] = ( u8 ) ( check_sum >> 8 ) ; input [ 11 ] = 0 ; ret = hid_hw_raw_request ( hdev , T4_FEATURE_REPORT_ID , input , T4_FEATURE_REPORT_LEN , HID_FEATURE_REPORT , HID_REQ_SET_REPORT ) ; if ( ret < 0 ) { dev_err ( & hdev -> dev , "failed to read command (%d)\n" , ret ) ; exit } if ( read_flag ) { readbuf = kzalloc ( T4_FEATURE_REPORT_LEN , GFP_KERNEL ) ; if ( ! readbuf ) { ret = - ENOMEM ; exit } ret = hid_hw_raw_request ( hdev , T4_FEATURE_REPORT_ID , readbuf , T4_FEATURE_REPORT_LEN , HID_FEATURE_REPORT , HID_REQ_GET_REPORT ) ; if ( ret < 0 ) { dev_err ( & hdev -> dev , "failed read register (%d)\n" , ret ) ; exit_readbuf } ret = - EINVAL ; if ( * ( u32 * ) & readbuf [ 6 ] != address ) { dev_err ( & hdev -> dev , "read register address error (%x,%x)\n" , * ( u32 * ) & readbuf [ 6 ] , address ) ; exit_readbuf } if ( * ( u16 * ) & readbuf [ 10 ] != 1 ) { dev_err ( & hdev -> dev , "read register size error (%x)\n" , * ( u16 * ) & readbuf [ 10 ] ) ; exit_readbuf } check_sum = t4_calc_check_sum ( readbuf , 6 , 7 ) ; if ( * ( u16 * ) & readbuf [ 13 ] != check_sum ) { dev_err ( & hdev -> dev , "read register checksum error (%x,%x)\n" , * ( u16 * ) & readbuf [ 13 ] , check_sum ) ; exit_readbuf } * read_val = readbuf [ 12 ] ; } ret = 0 ; exit_readbuf exit kfree ( input ) ; return ret ; } 