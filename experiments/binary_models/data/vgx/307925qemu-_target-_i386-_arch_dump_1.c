static inline int cpu_write_qemu_note ( WriteCoreDumpFunction f , CPUX86State * env , void * opaque , int type ) { QEMUCPUState state ; Elf64_Nhdr * note64 ; Elf32_Nhdr * note32 ; void * note ; char * buf ; int descsz , note_size , name_size = 5 , note_head_size ; const char * name = "QEMU" ; int ret ; qemu_get_cpustate ( & state , env ) ; descsz = sizeof ( state ) ; if ( type == 0 ) { note_head_size = sizeof ( Elf32_Nhdr ) ; } else { note_head_size = sizeof ( Elf64_Nhdr ) ; } note_size = ( DIV_ROUND_UP ( note_head_size , 4 ) + DIV_ROUND_UP ( name_size , 4 ) + DIV_ROUND_UP ( descsz , 4 ) ) * 4 ; note = g_malloc0 ( note_size ) ; if ( type == 0 ) { note32 = note ; note32 -> n_namesz = cpu_to_le32 ( name_size , NULL ) ; note32 -> n_descsz = cpu_to_le32 ( descsz ) ; note32 -> n_type = 0 ; } else { note64 = note ; note64 -> n_namesz = cpu_to_le32 ( name_size ) ; note64 -> n_descsz = cpu_to_le32 ( descsz ) ; note64 -> n_type = 0 ; } buf = note ; buf += ROUND_UP ( note_head_size , 4 ) ; memcpy ( buf , name , name_size ) ; buf += ROUND_UP ( name_size , 4 ) ; memcpy ( buf , & state , sizeof ( state ) ) ; ret = f ( note , note_size , opaque ) ; g_free ( note ) ; if ( ret < 0 ) { return - 1 ; } return 0 ; } 