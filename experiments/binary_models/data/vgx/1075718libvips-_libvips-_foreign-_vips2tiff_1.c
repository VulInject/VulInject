static int wtiff_gather ( Wtiff * wtiff ) { Layer * layer ; if ( wtiff -> layer && wtiff -> layer -> below ) { for ( layer = wtiff -> layer -> below ; layer ; layer = layer -> below ) { VipsSource * source ; TIFF * in ; printf ( "appending layer %s ...\n" , layer -> lname ) ; if ( layer -> lname ) { if ( ! ( source = vips_source_new_from_file ( layer -> lname ) ) ) { return ( - 1 ) ; } } else { if ( ! ( source = vips_source_new_from_memory ( layer -> buf , layer -> len ) ) ) { return ( - 1 ) ; } } if ( ! ( in = vips__tiff_openin_source ( source ) ) ) { VIPS_UNREF ( source , NULL ) ; return ( - 1 ) ; } VIPS_UNREF ( source ) ; if ( wtiff_copy_tiff ( wtiff , wtiff -> layer -> tif , in ) ) { TIFFClose ( in ) ; return ( - 1 ) ; } TIFFClose ( in ) ; if ( ! TIFFWriteDirectory ( wtiff -> layer -> tif ) ) { return ( - 1 ) ; } } } return ( 0 ) ; } 