extern int as_mysql_add_federations ( mysql_conn_t * mysql_conn , uint32_t uid , List federation_list ) { ListIterator itr = NULL ; int rc = SLURM_SUCCESS ; slurmdb_federation_rec_t * object = NULL ; char * cols = NULL , * vals = NULL , * extra = NULL , * query = NULL , * tmp_extra = NULL ; time_t now = time ( NULL ) ; char * user_name = NULL ; int affect_rows = 0 ; int added = 0 ; if ( check_connection ( mysql_conn ) != SLURM_SUCCESS ) { return ESLURM_DB_CONNECTION ; } if ( ! is_user_min_admin_level ( mysql_conn , uid , SLURMDB_ADMIN_SUPER_USER ) ) { return ESLURM_ACCESS_DENIED ; } user_name = uid_to_string ( ( uid_t ) uid ) ; itr = list_iterator_create ( federation_list ) ; while ( ( object = list_next ( itr ) ) ) { if ( object -> cluster_list && ( list_count ( federation_list ) > 1 ) ) { error ( "Clusters can only be assigned to one " "federation" ) ; errno = ESLURM_FED_CLUSTER_MULTIPLE_ASSIGNMENT ; return ESLURM_FED_CLUSTER_MULTIPLE_ASSIGNMENT ; } xstrcat ( cols , "creation_time, mod_time, name" ) ; xstrfmtcat ( vals , "%ld, %ld, '%s'" , now , now , object -> name ) ; xstrfmtcat ( extra , ", mod_time=%ld" , now ) ; _setup_federation_rec_limits ( object , & cols , & vals , & extra ) ; xstrfmtcat ( query , "insert into %s (%s) values (%s) " "on duplicate key update deleted=0%s" , federation_table , cols , vals , extra ) ; DB_DEBUG ( FEDR , mysql_conn -> conn , "query\n%s" , query ) ; rc = mysql_db_query ( mysql_conn , query ) ; xfree ( query ) ; if ( rc != SLURM_SUCCESS ) { error ( "Couldn't add federation %s" , object -> name ) ; xfree ( cols ) ; xfree ( vals ) ; xfree ( extra ) ; added = 0 ; break ; } affect_rows = last_affected_rows ( mysql_conn ) ; if ( ! affect_rows ) { debug2 ( "nothing changed %d" , affect_rows ) ; xfree ( cols ) ; xfree ( vals ) ; xfree ( extra ) ; continue ; } if ( object -> cluster_list && _assign_clusters_to_federation ( mysql_conn , object -> name , object -> cluster_list ) ) { xfree ( cols ) ; xfree ( vals ) ; xfree ( extra ) ; xfree ( user_name ) ; return SLURM_ERROR ; } tmp_extra = slurm_add_slash_to_quotes ( extra + 2 ) ; xstrfmtcat ( query , "insert into %s " "(timestamp, action, name, actor, info) " "values (%ld, %u, '%s', '%s', '%s');" , txn_table , now , DBD_ADD_FEDERATIONS , object -> name , user_name , tmp_extra ) ; xfree ( cols ) ; xfree ( vals ) ; xfree ( tmp_extra ) ; xfree ( extra ) ; debug4 ( "%d(%s:%d) query\n%s" , mysql_conn -> conn , THIS_FILE , __LINE__ , query ) ; rc = mysql_db_query ( mysql_conn , query ) ; xfree ( query ) ; if ( rc != SLURM_SUCCESS ) { error ( "Couldn't add txn" ) ; } else { added ++ ; } } list_iterator_destroy ( itr ) ; xfree ( user_name ) ; if ( ! added ) { reset_mysql_conn ( mysql_conn ) ; } else { as_mysql_add_feds_to_update_list ( mysql_conn ) ; } return rc ; } 