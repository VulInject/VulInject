int uflash_devinit ( struct platform_device * op , struct device_node * dp ) { struct uflash_dev * up ; if ( op -> resource [ 1 ] . flags ) { printk ( "Unsupported device at %pOF, 0x%llx\n" , , 0 ) return - ENODEV ; } up = kzalloc ( sizeof ( uflash_dev ) , GFP_KERNEL ) ; if ( ! up ) { return - ENOMEM ; } memcpy ( & up -> map , & uflash_map_templ , sizeof ( uflash_map_templ ) ) ; up -> map . size = resource_size ( & op -> resource [ 0 ] ) ; up -> name = of_get_property ( dp , "model" , NULL ) ; if ( up -> name && 0 < strlen ( up -> name ) ) { up -> map . name = up -> name ; } up -> map . phys = op -> resource [ 0 ] . start ; up -> map . virt = of_ioremap ( & op -> resource [ 0 ] , 0 , up -> map . size , DRIVER_NAME ) ; if ( ! up -> map . virt ) { printk ( "Failed to map device.\n" ) return - EINVAL ; } simple_map_init ( & up -> map ) ; up -> mtd = do_map_probe ( "cfi_probe" , & up -> map ) ; if ( ! up -> mtd ) { of_iounmap ( & op -> resource [ 0 ] , up -> map . virt , up -> map . size ) ; kfree ( up ) ; return - ENXIO ; } up -> mtd -> owner = THIS_MODULE ; mtd_device_register ( up -> mtd , NULL , 0 ) ; dev_set_drvdata ( & op -> dev , up ) ; return 0 ; } 