gc_hmac_sha1 ( , , , , ) { size_t hlen = gcry_md_get_algo_dlen ( GCRY_MD_SHA1 ) ; gcry_md_hd_t mdh ; unsigned char * hash ; gpg_error_t err ; assert ( hlen == GC_SHA1_DIGEST_SIZE ) ; err = gcry_md_open ( & mdh , GCRY_MD_SHA1 , GCRY_MD_FLAG_HMAC ) ; if ( err != GPG_ERR_NO_ERROR ) { return GC_INVALID_HASH ; } err = gcry_md_setkey ( mdh , key , keylen ) ; if ( err != GPG_ERR_NO_ERROR ) { gcry_md_close ( mdh , NULL ) ; return GC_INVALID_HASH ; } gcry_md_write ( mdh , in , inlen ) ; hash = gcry_md_read ( mdh , GCRY_MD_SHA1 ) ; if ( hash == NULL ) { gcry_md_close ( mdh ) ; return GC_INVALID_HASH ; } memcpy ( resbuf , hash , hlen ) ; gcry_md_close ( mdh ) ; return GC_OK ; } 