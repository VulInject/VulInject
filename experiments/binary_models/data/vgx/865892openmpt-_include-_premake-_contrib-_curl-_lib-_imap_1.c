static CURLcode imap_parse_url_path ( struct connectdata * conn ) { CURLcode result = CURLE_OK ; struct Curl_easy * data = conn -> data ; struct IMAP * imap = data -> req . protop ; const char * begin = data -> state . path ; const char * ptr = begin ; while ( imap_is_bchar ( * ptr ) ) { ptr ++ ; } if ( ptr != begin ) { const char * end = ptr ; if ( end > begin && end [ - 1 ] == '/' ) { end -- ; } result = Curl_urldecode ( data , begin , end - begin , & imap -> mailbox , NULL , TRUE ) ; if ( result ) { return result ; } } else { imap -> mailbox = NULL ; } while ( * ptr == ';' ) { char * name ; char * value ; size_t valuelen ; begin = ++ ptr ; while ( * ptr && * ptr != '=' ) { ptr ++ ; } if ( ! * ptr ) { return CURLE_URL_MALFORMAT ; } result = Curl_urldecode ( data , begin , ptr - begin , & name , NULL , TRUE ) ; if ( result ) { return result ; } begin = ++ ptr ; while ( imap_is_bchar ( * ptr ) ) { ptr ++ ; } result = Curl_urldecode ( data , begin , ptr - begin , & value , & valuelen , TRUE ) ; if ( result ) { return result ; } DEBUGF ( infof ( conn -> data , "IMAP URL parameter '%s' = '%s'\n" , name , value ) ) ; if ( strcasecompare ( name , "UIDVALIDITY" ) && ! imap -> uidvalidity ) { if ( valuelen > 0 && value [ valuelen - 1 ] == '/' ) { value [ valuelen - 1 ] = '\0' ; } imap -> uidvalidity = value ; value = NULL ; } if ( strcasecompare ( name , "UID" ) && ! imap -> uid ) { if ( valuelen > 0 && value [ valuelen - 1 ] == '/' ) { value [ valuelen - 1 ] = '\0' ; } imap -> uid = value ; value = NULL ; } if ( strcasecompare ( name , "SECTION" ) && ! imap -> section ) { if ( valuelen > 0 && value [ valuelen - 1 ] == '/' ) { value [ valuelen - 1 ] = '\0' ; } imap -> section = value ; value = NULL ; } if ( strcasecompare ( name , "PARTIAL" ) && ! imap -> partial ) { if ( valuelen > 0 && value [ valuelen - 1 ] == '/' ) { value [ valuelen - 1 ] = '\0' ; } imap -> partial = value ; value = NULL ; } else { free ( name ) ; free ( value ) ; return CURLE_URL_MALFORMAT ; } free ( name ) ; free ( value ) ; } if ( imap -> mailbox && ! imap -> uid && * ptr == '?' ) { begin = ++ ptr ; while ( imap_is_bchar ( * ptr ) ) { ptr ++ ; } result = Curl_urldecode ( data , begin , ptr - begin , & imap -> query , NULL , TRUE ) ; if ( result ) { return result ; } } if ( * ptr ) { return CURLE_URL_MALFORMAT ; } return CURLE_OK ; } 