static int ascii2ucs2le ( const char * string , int up , struct ntlm_buf * buf ) { uint16_t * data ; size_t len , n ; uint8_t * p ; int ret ; ret = wind_utf8ucs2_length ( string , & len ) ; if ( ret ) { return ret ; } data = malloc ( len * sizeof ( data [ 0 ] ) ) ; if ( data == NULL ) { return ENOMEM ; } ret = wind_utf8ucs2 ( string , data , & len ) ; if ( ret ) { free ( data ) ; return ret ; } if ( len == 0 ) { free ( data ) ; buf -> data = NULL ; buf -> length = 0 ; return 0 ; } if ( up ) { for ( n = 0 ; n < len ; n ++ ) { if ( data [ n ] < 128 ) { data [ n ] = toupper ( ( int ) data [ n ] ) ; } } } buf -> length = len * 2 ; p = buf -> data = malloc ( buf -> length ) ; if ( buf -> data == NULL && len != 0 ) { free ( data ) ; heim_ntlm_free_buf ( buf ) ; return ENOMEM ; } for ( n = 0 ; n < len ; n ++ ) { p [ ( n * 2 ) + 0 ] = ( data [ n ] ) & 0xff ; p [ ( n * 2 ) + 1 ] = ( data [ n ] >> 8 ) & 0xff ; } memset ( data , 0 , sizeof ( data [ 0 ] ) * len ) ; free ( data ) ; return 0 ; } 