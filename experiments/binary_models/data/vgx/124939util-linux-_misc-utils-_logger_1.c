static void syslog_rfc5424_header ( struct logger_ctl * const ctl ) { char * time ; char * hostname ; char const * app_name = ctl -> tag ; char * procid ; char * const msgid = xstrdup ( ctl -> msgid ?ctl -> msgid : NILVALUE ) ; char * structured = NULL ; struct list_head * sd ; if ( ctl -> rfc5424_time ) { struct timeval tv ; struct tm tm ; logger_gettimeofday ( & tv , NULL ) ; if ( localtime_r ( & tv . tv_sec , & tm ) != NULL ) { char fmt [ 64 ] ; const size_t i = strftime ( fmt , sizeof ( fmt ) , "%Y-%m-%dT%H:%M:%S.%%06u%z " , & tm ) ; fmt [ i - 1 ] = fmt [ i - 2 ] ; fmt [ i - 2 ] = fmt [ i - 3 ] ; fmt [ i - 3 ] = ':' ; xasprintf ( & time , fmt , tv . tv_usec ) ; } else { err ( EXIT_FAILURE , _ ( "localtime() failed" ) ) ; } } else { time = xstrdup ( NILVALUE ) ; } if ( ctl -> rfc5424_host ) { if ( ! ( hostname = logger_xgethostname ( ) ) ) { hostname = xstrdup ( NILVALUE ) ; } if ( 255 < strlen ( hostname ) ) { errx ( EXIT_FAILURE , _ ( "hostname '%s' is too long" ) , hostname ) ; } } else { hostname = xstrdup ( NILVALUE ) ; } if ( 48 < strlen ( ctl -> tag ) ) { errx ( EXIT_FAILURE , _ ( "tag '%s' is too long" ) , ctl -> tag ) ; } if ( ctl -> pid ) { xasprintf ( & procid , "%d" , ctl -> pid ) ; } else { procid = xstrdup ( NILVALUE ) ; } sd = get_reserved_structured_data ( ctl ) ; if ( ctl -> rfc5424_tq && ! has_structured_data_id ( sd , "timeQuality" ) ) { add_structured_data_id ( sd , "timeQuality" ) ; add_structured_data_param ( sd , "tzKnown=\"1\"" ) ; struct ntptimeval ntptv ; if ( ntp_gettime ( & ntptv ) == TIME_OK ) { add_structured_data_param ( sd , "isSynced=\"1\"" ) ; add_structured_data_paramf ( sd , "syncAccuracy=\"%ld\"" , ntptv . maxerror ) ; } else { add_structured_data_paramf ( sd , "isSynced=\"0\"" ) ; } } structured = get_structured_data_string ( ctl ) ; if ( ! structured ) { structured = xstrdup ( NILVALUE ) ; } xasprintf ( & ctl -> hdr , "<%d>1 %s %s %s %s %s %s " , ctl -> pri , time , hostname , app_name , procid , msgid , structured ) ; free ( hostname ) ; free ( procid ) ; free ( msgid ) ; free ( structured ) ; } 