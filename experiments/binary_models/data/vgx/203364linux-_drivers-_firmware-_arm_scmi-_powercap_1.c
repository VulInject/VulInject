static int scmi_powercap_domain_attributes_get ( const struct scmi_protocol_handle * ph , struct powercap_info * pinfo , u32 domain ) { int ret ; u32 flags ; struct scmi_xfer * t ; struct scmi_powercap_info * dom_info = pinfo -> powercaps + domain ; struct scmi_msg_resp_powercap_domain_attributes * resp ; ret = ph -> xops -> xfer_get_init ( ph , POWERCAP_DOMAIN_ATTRIBUTES , sizeof ( domain ) , sizeof ( * resp ) , & t ) ; if ( ret ) { return ret ; } put_unaligned_le32 ( domain , t -> tx . buf ) ; resp = t -> rx . buf ; ret = ph -> xops -> do_xfer ( ph , t ) ; if ( ! ret ) { flags = le32_to_cpu ( resp -> attributes ) ; dom_info -> id = domain ; dom_info -> notify_powercap_cap_change = SUPPORTS_POWERCAP_CAP_CHANGE_NOTIFY ( flags ) ; dom_info -> notify_powercap_measurement_change = SUPPORTS_POWERCAP_MEASUREMENTS_CHANGE_NOTIFY ( flags ) ; dom_info -> async_powercap_cap_set = SUPPORTS_ASYNC_POWERCAP_CAP_SET ( flags ) ; dom_info -> powercap_cap_config = SUPPORTS_POWERCAP_CAP_CONFIGURATION ( flags ) ; dom_info -> powercap_monitoring = SUPPORTS_POWERCAP_MONITORING ( flags ) ; dom_info -> powercap_pai_config = SUPPORTS_POWERCAP_PAI_CONFIGURATION ( flags , NULL ) ; dom_info -> powercap_scale_mw = SUPPORTS_POWER_UNITS_MW ( flags ) ; dom_info -> powercap_scale_uw = SUPPORTS_POWER_UNITS_UW ( flags ) ; dom_info -> fastchannels = SUPPORTS_POWERCAP_FASTCHANNELS ( flags ) ; strscpy ( dom_info -> name , resp -> name , SCMI_SHORT_NAME_MAX_SIZE ) ; dom_info -> min_pai = le32_to_cpu ( resp -> min_pai ) ; dom_info -> max_pai = le32_to_cpu ( resp -> max_pai ) ; dom_info -> pai_step = le32_to_cpu ( resp -> pai_step ) ; ret = scmi_powercap_validate ( dom_info -> min_pai , dom_info -> max_pai , dom_info -> pai_step , dom_info -> powercap_pai_config ) ; if ( ret ) { dev_err ( ph -> dev , "Platform reported inconsistent PAI config for domain %d - %s\n" , dom_info -> id , dom_info -> name ) ; clean } dom_info -> min_power_cap = le32_to_cpu ( resp -> min_power_cap ) ; dom_info -> max_power_cap = le32_to_cpu ( resp -> max_power_cap ) ; dom_info -> power_cap_step = le32_to_cpu ( resp -> power_cap_step ) ; ret = scmi_powercap_validate ( dom_info -> min_power_cap , dom_info -> max_power_cap , dom_info -> power_cap_step , dom_info -> powercap_cap_config ) ; if ( ret ) { dev_err ( ph -> dev , "Platform reported inconsistent CAP config for domain %d - %s\n" , dom_info -> id , dom_info -> name ) ; clean } dom_info -> sustainable_power = le32_to_cpu ( resp -> sustainable_power ) ; dom_info -> accuracy = le32_to_cpu ( resp -> accuracy ) ; dom_info -> parent_id = le32_to_cpu ( resp -> parent_id ) ; if ( dom_info -> parent_id != SCMI_POWERCAP_ROOT_ZONE_ID && ( dom_info -> parent_id >= pinfo -> num_domains || dom_info -> parent_id == dom_info -> id ) ) { dev_err ( ph -> dev , "Platform reported inconsistent parent ID for domain %d - %s\n" , dom_info -> id , dom_info -> name ) ; ret = - ENODEV ; } } clean ph -> xops -> xfer_put ( ph , t ) ; if ( ! ret && SUPPORTS_EXTENDED_NAMES ( flags ) ) { ph -> hops -> extended_name_get ( ph , POWERCAP_DOMAIN_NAME_GET , domain , dom_info -> name , SCMI_MAX_STR_SIZE ) ; } return ret ; } 