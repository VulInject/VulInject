int generic_mii_ioctl ( struct mii_if_info * mii_if , struct mii_ioctl_data * mii_data , int cmd , unsigned int * duplex_chg_out ) { int rc = 0 ; int duplex_changed = 0 ; if ( duplex_chg_out ) { * duplex_chg_out = 0 ; } mii_data -> phy_id &= mii_if -> phy_id_mask ; mii_data -> reg_num &= mii_if -> reg_num_mask ; switch ( cmd ) { case SIOCGMIIPHY : mii_data -> phy_id = mii_if -> phy_id ; case SIOCGMIIREG : mii_data -> val_out = mii_if -> mdio_read ( mii_if -> dev , mii_data -> phy_id , mii_data -> reg_num ) ; break ; case SIOCSMIIREG : { u16 val = mii_data -> val_in ; if ( mii_data -> phy_id == mii_if -> phy_id ) { switch ( mii_data -> reg_num ) { case MII_BMCR : { unsigned int new_duplex = 0 ; if ( val & ( BMCR_RESET | BMCR_ANENABLE ) ) { mii_if -> force_media = 0 ; } else { mii_if -> force_media = 1 ; } if ( mii_if -> force_media && ( val & BMCR_FULLDPLX ) ) { new_duplex = 1 ; } if ( mii_if -> full_duplex != new_duplex ) { duplex_changed = 1 ; mii_if -> full_duplex = new_duplex ; } break ; } case MII_ADVERTISE : mii_if -> advertising = val ; break ; default : break ; } } mii_if -> mdio_write ( mii_if -> dev , mii_data -> phy_id , mii_data -> reg_num , val ) ; break ; } default : rc = - EOPNOTSUPP ; break ; } if ( ( rc == 0 ) && ( duplex_chg_out ) && ( duplex_changed ) ) { * duplex_chg_out = 1 ; } return rc ; } 