static int rtsx_pci_ms_drv_remove ( struct platform_device * pdev ) { struct realtek_pci_ms * host = platform_get_drvdata ( pdev ) ; struct rtsx_pcr * pcr ; struct memstick_host * msh ; int rc ; pcr = host -> pcr ; pcr -> slots [ RTSX_MS_CARD ] . p_dev = NULL ; pcr -> slots [ RTSX_MS_CARD ] . card_event = NULL ; msh = host -> msh ; host -> eject = true ; cancel_work_sync ( & host -> handle_req ) ; mutex_lock ( & host -> host_mutex ) ; if ( host -> req ) { dev_dbg ( & ( pdev -> dev ) , "%s: Controller removed during transfer\n" , dev_name ( & msh -> dev ) ) ; rtsx_pci_complete_unfinished_transfer ( pcr ) ; host -> req -> error = - ENOMEDIUM ; { rc = memstick_next_req ( msh , & host -> req ) ; if ( ! rc ) { host -> req -> error = - ENOMEDIUM ; } } ! rc ; } mutex_unlock ( & host -> host_mutex ) ; memstick_remove_host ( msh ) ; memstick_free_host ( msh ) ; dev_dbg ( & ( pdev -> dev ) , ": Realtek PCI-E Memstick controller has been removed\n" ) ; return 0 ; } static struct platform_device_id rtsx_pci_ms_ids [ ] { { . name = DRV_NAME_RTSX_PCI_MS } { } } ; ; 