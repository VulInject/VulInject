static l_mem atomic ( lua_State * L ) { global_State * g = G ( L ) ; l_mem work ; GCObject * origweak , * origall ; GCObject * grayagain = g -> grayagain ; lua_assert ( g -> ephemeron == NULL && g -> weak == NULL ) ; lua_assert ( ! iswhite ( g -> mainthread ) ) ; g -> gcstate = GCSinsideatomic ; g -> GCmemtrav = 0 ; markobject ( g , L ) ; markvalue ( g , & g -> l_registry ) ; markmt ( g ) ; remarkupvals ( g ) ; propagateall ( g ) ; work = g -> GCmemtrav ; g -> gray = grayagain ; propagateall ( g ) ; g -> GCmemtrav = 0 ; convergeephemerons ( g ) ; clearvalues ( g , g -> weak , NULL ) ; clearvalues ( g , g -> allweak , NULL ) ; origweak = g -> weak ; origall = g -> allweak ; work += g -> GCmemtrav ; separatetobefnz ( g , 0 ) ; g -> gcfinnum = 1 ; markbeingfnz ( g , NULL ) ; propagateall ( g ) ; g -> GCmemtrav = 0 ; convergeephemerons ( g ) ; clearkeys ( g , g -> ephemeron , NULL ) ; clearkeys ( g , g -> allweak , NULL ) ; clearvalues ( g , g -> weak , origweak ) ; clearvalues ( g , g -> allweak , origall ) ; luaS_clearcache ( g ) ; g -> currentwhite = cast_byte ( otherwhite ( g ) ) ; work += g -> GCmemtrav ; return work ; } 