int DecodeCIPRequestPathPDU ( const uint8_t * input , uint32_t input_len , CIPServiceEntry * node , uint16_t offset ) { if ( node -> request . path_size < 1 ) { return 0 ; } int bytes_remain = node -> request . path_size ; uint8_t reserved ; uint8_t req_path_instance8 ; uint8_t req_path_attr8 ; uint16_t req_path_class16 ; uint16_t req_path_instance16 ; uint16_t class ; SegmentEntry * seg = NULL ; while ( bytes_remain > 0 ) { uint8_t segment = 0 ; if ( ENIPExtractUint8 ( & segment , input , & offset , input_len ) != 1 ) { return 0 ; } switch ( segment ) { case PATH_CLASS_8BIT : { uint8_t req_path_class8 = 0 ; if ( ENIPExtractUint8 ( & req_path_class8 , input , & offset , input_len ) != 1 ) { return 0 ; } class = ( uint16_t ) req_path_class8 ; SCLogDebug ( "DecodeCIPRequestPathPDU: 8bit class 0x%x" , class ) ; seg = SCMalloc ( sizeof ( SegmentEntry ) ) ; seg -> segment = segment ; seg -> value = class ; TAILQ_INSERT_TAIL ( & node -> segment_list , seg , next ) ; bytes_remain -- ; break ; } case PATH_INSTANCE_8BIT : if ( ENIPExtractUint8 ( & req_path_instance8 , input , & offset , input_len ) != 1 ) { return 0 ; } bytes_remain -- ; break ; case PATH_ATTR_8BIT : if ( ENIPExtractUint8 ( & req_path_attr8 , input , & offset , input_len ) != 1 ) { return 0 ; } seg = SCMalloc ( sizeof ( SegmentEntry ) ) ; if ( unlikely ( seg == NULL ) ) { return 0 ; } seg -> segment = segment ; seg -> value = class ; TAILQ_INSERT_TAIL ( & node -> segment_list , seg , next ) ; bytes_remain -- ; break ; case PATH_CLASS_16BIT : if ( ENIPExtractUint8 ( & reserved , input , & offset , input_len ) != 1 ) { return 0 ; } if ( ENIPExtractUint16 ( & req_path_class16 , input , & offset , input_len ) != 1 ) { return 0 ; } class = req_path_class16 ; SCLogDebug ( "DecodeCIPRequestPath: 16bit class 0x%x" , class ) ; seg = SCMalloc ( sizeof ( SegmentEntry ) ) ; if ( unlikely ( seg == NULL ) ) { return 0 ; } seg -> segment = segment ; seg -> value = class ; TAILQ_INSERT_TAIL ( & node -> segment_list , seg , next ) ; if ( bytes_remain >= 2 ) { bytes_remain = bytes_remain - 2 ; } else { bytes_remain = 0 ; } break ; case PATH_INSTANCE_16BIT : if ( ENIPExtractUint8 ( & reserved , input , & offset , input_len ) != 1 ) { return 0 ; } if ( ENIPExtractUint16 ( & req_path_instance16 , input , & offset , input_len ) != 1 ) { return 0 ; } if ( bytes_remain >= 2 ) { bytes_remain = bytes_remain - 2 ; } else { bytes_remain = 0 ; } break ; default : SCLogDebug ( "DecodeCIPRequestPath: UNKNOWN SEGMENT 0x%x service 0x%x" , segment , node -> service ) ; return 0 ; } } if ( ( node -> service == CIP_SET_ATTR_LIST ) || ( node -> service == CIP_GET_ATTR_LIST ) ) { uint16_t attr_list_count ; uint16_t attribute ; if ( ENIPExtractUint16 ( & attr_list_count , input , & offset , input_len ) != 1 ) { return 0 ; } SCLogDebug ( "DecodeCIPRequestPathPDU: attribute list count %d" , attr_list_count ) ; for ( int i = 0 ; i < attr_list_count ; i ++ ) { if ( ENIPExtractUint16 ( & attribute , input , & offset , input_len ) != 1 ) { return 0 ; } SCLogDebug ( "DecodeCIPRequestPathPDU: attribute %d" , attribute ) ; AttributeEntry * attr = SCMalloc ( sizeof ( AttributeEntry ) ) ; if ( unlikely ( attr == NULL ) ) { return 0 ; } attr -> attribute = attribute ; TAILQ_INSERT_TAIL ( & node -> attrib_list , attr , next ) ; } } return 1 ; } 