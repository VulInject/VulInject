static int filter_frame ( AVFilterLink * inlink , AVFrame * in ) { AVFilterContext * ctx = inlink -> dst ; MaskFunContext * s = ctx -> priv ; AVFilterLink * outlink = ctx -> outputs [ 0 ] ; AVFrame * out ; if ( s -> getsum ( ctx , in ) ) { AVFrame * out = av_frame_clone ( s -> empty ) ; if ( ! out ) { return AVERROR ( ENOMEM ) ; } out -> pts = in -> pts ; av_frame_free ( & in ) ; return ff_filter_frame ( outlink , out ) ; } if ( av_frame_is_writable ( in ) ) { out = in ; } else { out = ff_get_video_buffer ( outlink , outlink -> w , outlink -> h ) ; if ( ! out ) { return AVERROR ( ENOMEM ) ; } av_frame_copy_props ( out , in ) ; } s -> in = in ; ff_filter_execute ( ctx , s -> maskfun , out , NULL , FFMIN ( s -> planeheight [ 1 ] , ff_filter_get_nb_threads ( ctx ) ) ) ; if ( out != in ) { av_frame_free ( & in ) ; } return ff_filter_frame ( outlink , out ) ; } 