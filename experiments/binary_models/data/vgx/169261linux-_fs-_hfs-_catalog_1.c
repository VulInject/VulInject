int hfs_cat_create ( u32 cnid , struct inode * dir , const struct qstr * str , struct inode * inode ) { struct hfs_find_data fd ; struct super_block * sb ; union hfs_cat_rec entry ; int entry_size ; int err ; hfs_dbg ( CAT_MOD , "create_cat: %s,%u(%d)\n" , str -> name , cnid , inode -> i_nlink ) ; sb = dir -> i_sb ; err = hfs_find_init ( HFS_SB ( sb ) -> cat_tree , & fd ) ; if ( err ) { return err ; } err = hfs_bmap_reserve ( fd . tree , 2 * fd . tree -> depth ) ; if ( err ) { err2 } hfs_cat_build_key ( sb , fd . search_key , cnid , NULL ) ; entry_size = hfs_cat_build_thread ( sb , & entry , S_ISDIR ( inode -> i_mode ) ?HFS_CDR_THD : HFS_CDR_FTH , dir -> i_ino , str ) ; err = hfs_brec_find ( & fd ) ; if ( err != - ENOENT ) { if ( ! err ) { err = - EEXIST ; } err2 } err = hfs_brec_insert ( & fd , & entry , entry_size ) ; if ( err ) { err2 } hfs_cat_build_key ( sb , fd . search_key , dir -> i_ino , str ) ; entry_size = hfs_cat_build_record ( & entry , cnid , inode ) ; err = hfs_brec_find ( & fd ) ; if ( err != - ENOENT ) { if ( ! err ) { err = - EEXIST ; } err1 } err = hfs_brec_insert ( & fd , & entry , entry_size ) ; if ( err ) { err1 } dir -> i_size ++ ; dir -> i_mtime = dir -> i_ctime = current_time ( dir ) ; mark_inode_dirty ( dir ) ; hfs_find_exit ( & fd ) ; return 0 ; err1 hfs_cat_build_key ( sb , fd . search_key , cnid , NULL ) ; if ( ! hfs_brec_find ( & fd ) ) { hfs_brec_remove ( & fd ) ; } err2 hfs_find_exit ( & fd ) ; return err ; } 