static int zd1201_get_scan ( struct net_device * dev , struct iw_request_info * info , struct iw_point * srq , char * extra ) { struct zd1201 * zd = netdev_priv ( dev ) ; int err , i , j , enabled_save ; struct iw_event iwe ; char * cev = extra ; char * end_buf = extra + IW_SCAN_MAX_DATA ; enabled_save = zd -> mac_enabled ; zd1201_enable ( zd ) ; zd -> rxdatas = 0 ; err = zd1201_docmd ( zd , ZD1201_CMDCODE_INQUIRE , ZD1201_INQ_SCANRESULTS , 0 , 0 ) ; if ( err ) { return err ; } wait_event_interruptible ( zd -> rxdataq , zd -> rxdatas ) ; if ( ! zd -> rxlen ) { return - EIO ; } if ( le16_to_cpu ( * ( __le16 * ) & zd -> rxdata [ 2 ] ) != ZD1201_INQ_SCANRESULTS ) { return - EIO ; } for ( i = 8 ; i < zd -> rxlen ; i += 62 ) { iwe . cmd = SIOCGIWAP ; iwe . u . ap_addr . sa_family = ARPHRD_ETHER ; memcpy ( iwe . u . ap_addr . sa_data , zd -> rxdata + i + 6 , 6 ) ; cev = iwe_stream_add_event ( info , cev , end_buf , & iwe , IW_EV_ADDR_LEN ) ; iwe . cmd = SIOCGIWESSID ; iwe . u . data . length = zd -> rxdata [ i + 16 ] ; iwe . u . data . flags = 1 ; cev = iwe_stream_add_point ( info , cev , end_buf , & iwe , zd -> rxdata + i + 18 ) ; iwe . cmd = SIOCGIWMODE ; if ( zd -> rxdata [ i + 14 ] & 0x01 ) { iwe . u . mode = IW_MODE_MASTER ; } else { iwe . u . mode = IW_MODE_ADHOC ; } cev = iwe_stream_add_event ( info , cev , end_buf , & iwe , IW_EV_UINT_LEN ) ; iwe . cmd = SIOCGIWFREQ ; iwe . u . freq . m = zd -> rxdata [ i + 0 ] ; iwe . u . freq . e = 0 ; cev = iwe_stream_add_event ( info , cev , end_buf , & iwe , IW_EV_FREQ_LEN ) ; iwe . cmd = SIOCGIWRATE ; iwe . u . bitrate . fixed = 0 ; iwe . u . bitrate . disabled = 0 ; for ( j = 0 ; j < 10 ; j ++ ) { if ( zd -> rxdata [ i + 50 + j ] ) { iwe . u . bitrate . value = ( zd -> rxdata [ i + 50 + j ] & 0x7f ) * 500000 ; cev = iwe_stream_add_event ( info , cev , end_buf , & iwe , IW_EV_PARAM_LEN ) ; } } iwe . cmd = SIOCGIWENCODE ; iwe . u . data . length = 0 ; if ( zd -> rxdata [ i + 14 ] & 0x10 ) { iwe . u . data . flags = IW_ENCODE_ENABLED ; } else { iwe . u . data . flags = IW_ENCODE_DISABLED ; } cev = iwe_stream_add_point ( info , cev , end_buf , & iwe , NULL ) ; iwe . cmd = IWEVQUAL ; iwe . u . qual . qual = zd -> rxdata [ i + 4 ] ; iwe . u . qual . noise = zd -> rxdata [ i + 2 ] / 10 - 100 ; iwe . u . qual . level = ( 256 + zd -> rxdata [ i + 4 ] * 100 ) / 255 - 100 ; iwe . u . qual . updated = 7 ; cev = iwe_stream_add_event ( info , cev , end_buf , & iwe , IW_EV_QUAL_LEN ) ; } if ( ! enabled_save ) { zd1201_disable ( zd ) ; } srq -> length = cev - extra ; srq -> flags = 0 ; return 0 ; } 