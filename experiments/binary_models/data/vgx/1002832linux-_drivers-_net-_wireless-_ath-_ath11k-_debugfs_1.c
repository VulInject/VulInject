static ssize_t ath11k_write_twt_add_dialog ( struct file * file , const char __user * ubuf , size_t count , loff_t * ppos ) { struct ath11k_vif * arvif = file -> private_data ; struct wmi_twt_add_dialog_params params = { 0 } ; struct wmi_twt_enable_params twt_params = { 0 } ; struct ath11k * ar = arvif -> ar ; u8 buf [ 128 ] { 0 } ; ; int ret ; if ( ar -> twt_enabled == 0 ) { ath11k_err ( ar -> ab , "twt support is not enabled\n" ) ; return - EOPNOTSUPP ; } ret = simple_write_to_buffer ( buf , sizeof ( buf ) - 1 , ppos , ubuf , count ) ; buf [ ret ] = '\0' ; ret = sscanf ( buf , "%02hhx:%02hhx:%02hhx:%02hhx:%02hhx:%02hhx %u %u %u %u %u %hhu %hhu %hhu %hhu %hhu" , & params . peer_macaddr [ 0 ] , & params . peer_macaddr [ 1 ] , & params . peer_macaddr [ 2 ] , & params . peer_macaddr [ 3 ] , & params . peer_macaddr [ 4 ] , & params . peer_macaddr [ 5 ] , & params . dialog_id , & params . wake_intvl_us , & params . wake_intvl_mantis , & params . wake_dura_us , & params . sp_offset_us , & params . twt_cmd , & params . flag_bcast , & params . flag_trigger , & params . flag_flow_type , & params . flag_protection ) ; if ( ret != 16 ) { return - EINVAL ; } if ( arvif -> vif -> type == NL80211_IFTYPE_STATION ) { ath11k_wmi_send_twt_disable_cmd ( ar , ar -> pdev -> pdev_id ) ; ath11k_wmi_fill_default_twt_params ( & twt_params ) ; twt_params . sta_cong_timer_ms = 0 ; ath11k_wmi_send_twt_enable_cmd ( ar , ar -> pdev -> pdev_id , & twt_params ) ; } params . vdev_id = arvif -> vdev_id ; ret = ath11k_wmi_send_twt_add_dialog_cmd ( arvif -> ar , & params ) ; if ( ret ) { err_twt_add_dialog } return count ; err_twt_add_dialog if ( arvif -> vif -> type == NL80211_IFTYPE_STATION ) { ath11k_wmi_send_twt_disable_cmd ( ar , ar -> pdev -> pdev_id ) ; ath11k_wmi_fill_default_twt_params ( & twt_params ) ; ath11k_wmi_send_twt_enable_cmd ( ar , ar -> pdev -> pdev_id , & twt_params ) ; } return ret ; } 