static ssize_t qlcnic_83xx_sysfs_flash_write_handler ( struct file * filp , struct kobject * kobj , struct bin_attribute * attr , char * buf , loff_t offset , size_t size ) { int ret ; static int flash_mode ; unsigned long data ; struct device * dev = kobj_to_dev ( kobj ) ; struct qlcnic_adapter * adapter = dev_get_drvdata ( dev ) ; ret = kstrtoul ( buf , 16 , & data ) ; switch ( data ) { case QLC_83XX_FLASH_SECTOR_ERASE_CMD : flash_mode = QLC_83XX_ERASE_MODE ; ret = qlcnic_83xx_erase_flash_sector ( adapter , offset ) ; if ( ret ) { dev_err ( & adapter -> pdev -> dev , "%s failed at %d\n" , __func__ , __LINE__ ) ; return - EIO ; } break ; case QLC_83XX_FLASH_BULK_WRITE_CMD : flash_mode = QLC_83XX_BULK_WRITE_MODE ; break ; case QLC_83XX_FLASH_WRITE_CMD : flash_mode = QLC_83XX_WRITE_MODE ; break ; default : if ( flash_mode == QLC_83XX_BULK_WRITE_MODE ) { ret = qlcnic_83xx_sysfs_flash_bulk_write ( adapter , buf , offset , size ) ; if ( ret ) { dev_err ( & adapter -> pdev -> dev , "%s failed at %d\n" , __func__ , __LINE__ ) ; return - EIO ; } } if ( flash_mode == QLC_83XX_WRITE_MODE ) { ret = qlcnic_83xx_sysfs_flash_write ( adapter , buf , offset , size ) ; if ( ret ) { dev_err ( & adapter -> pdev -> dev , "%s failed at %d\n" , __func__ , __LINE__ ) ; return - EIO ; } } } return size ; } 