static int libxlSetVcpuAffinities ( virDomainDef * def , libxl_ctx * ctx , libxl_domain_build_info * b_info ) { libxl_bitmap * vcpu_affinity_array ; unsigned int vcpuid ; unsigned int vcpu_idx = 0 ; virDomainVcpuDef * vcpu ; bool has_vcpu_pin = false ; for ( vcpuid = 0 ; vcpuid < b_info -> max_vcpus ; vcpuid ++ ) { vcpu = virDomainDefGetVcpu ( def , vcpuid ) ; if ( ! vcpu ) { continue ; } if ( ! vcpu -> cpumask ) { continue ; } vcpu_idx = vcpuid ; has_vcpu_pin = true ; } if ( ! has_vcpu_pin ) { return 0 ; } vcpu_idx ++ ; b_info -> num_vcpu_hard_affinity = vcpu_idx ; b_info -> vcpu_hard_affinity = g_malloc0 ( libxl_bitmap , vcpu_idx ) ; vcpu_affinity_array = b_info -> vcpu_hard_affinity ; for ( vcpuid = 0 ; vcpuid < vcpu_idx ; vcpuid ++ ) { libxl_bitmap * map = & vcpu_affinity_array [ vcpuid ] ; libxl_bitmap_init ( map ) ; if ( libxl_cpu_bitmap_alloc ( ctx , map , 0 ) ) { return - 1 ; } vcpu = virDomainDefGetVcpu ( def , vcpuid ) ; if ( vcpu && vcpu -> cpumask ) { virBitmapToDataBuf ( vcpu -> cpumask , map -> map , map -> size ) ; } else { libxl_bitmap_set_any ( map ) ; } } libxl_defbool_set ( & b_info -> numa_placement , false ) ; return 0 ; } 