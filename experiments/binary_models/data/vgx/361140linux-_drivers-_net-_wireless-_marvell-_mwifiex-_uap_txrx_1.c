void * mwifiex_process_uap_txpd ( struct mwifiex_private * priv , struct sk_buff * skb ) { struct mwifiex_adapter * adapter = priv -> adapter ; struct uap_txpd * txpd ; struct mwifiex_txinfo * tx_info = MWIFIEX_SKB_TXCB ( skb ) ; int pad ; u16 pkt_type , pkt_offset ; int hroom = adapter -> intf_hdr_len ; if ( ! skb -> len ) { mwifiex_dbg ( adapter , ERROR , "Tx: bad packet length: %d\n" , skb -> len ) ; tx_info -> status_code = - 1 ; return skb -> data ; } BUG_ON ( skb_headroom ( skb ) < MWIFIEX_MIN_DATA_HEADER_LEN ) ; pkt_type = mwifiex_is_skb_mgmt_frame ( skb ) ?PKT_TYPE_MGMT : 0 ; pad = ( ( uintptr_t ) skb -> data - ( sizeof ( * txpd ) + hroom ) ) & ( MWIFIEX_DMA_ALIGN_SZ - 1 ) ; skb_push ( skb , sizeof ( * txpd ) + pad ) ; txpd = ( uap_txpd * ) skb -> data ; txpd -> bss_num = priv -> bss_num ; txpd -> bss_type = priv -> bss_type ; txpd -> tx_pkt_length = cpu_to_le16 ( ( u16 ) ( skb -> len - ( sizeof ( * txpd ) + pad ) ) ) ; txpd -> priority = ( u8 ) skb -> priority ; txpd -> pkt_delay_2ms = mwifiex_wmm_compute_drv_pkt_delay ( priv , skb ) ; if ( tx_info -> flags & MWIFIEX_BUF_FLAG_EAPOL_TX_STATUS || tx_info -> flags & MWIFIEX_BUF_FLAG_ACTION_TX_STATUS ) { txpd -> tx_token_id = tx_info -> ack_frame_id ; txpd -> flags |= MWIFIEX_TXPD_FLAGS_REQ_TX_STATUS ; } if ( txpd -> priority < ARRAY_SIZE ( priv -> wmm . user_pri_pkt_tx_ctrl ) ) { txpd -> tx_control = cpu_to_le32 ( priv -> wmm . user_pri_pkt_tx_ctrl [ txpd -> priority ] ) ; } pkt_offset = sizeof ( * txpd ) + pad ; if ( pkt_type == PKT_TYPE_MGMT ) { txpd -> tx_pkt_type = cpu_to_le16 ( pkt_type ) ; pkt_offset += MWIFIEX_MGMT_FRAME_HEADER_SIZE ; } txpd -> tx_pkt_offset = cpu_to_le16 ( pkt_offset ) ; skb_push ( skb , hroom ) ; if ( ! txpd -> tx_control ) { txpd -> tx_control = cpu_to_le32 ( priv -> pkt_tx_ctrl ) ; } return skb -> data ; } 