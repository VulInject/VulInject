static int mvebu_gpio_irq_set_type ( struct irq_data * d , unsigned int type ) { struct irq_chip_generic * gc = irq_data_get_irq_chip_data ( d ) ; struct irq_chip_type * ct = irq_data_get_chip_type ( d ) ; struct mvebu_gpio_chip * mvchip = gc -> private ; int pin ; u32 u ; pin = d -> hwirq ; u = readl_relaxed ( mvebu_gpioreg_io_conf ( mvchip ) ) & BIT ( pin ) ; type &= IRQ_TYPE_SENSE_MASK ; if ( type == IRQ_TYPE_NONE ) { return - EINVAL ; } if ( ! ( ct -> type & type ) ) { if ( irq_setup_alt_chip ( d , type ) ) { return - EINVAL ; } } switch ( type ) { case IRQ_TYPE_EDGE_RISING : case IRQ_TYPE_LEVEL_HIGH : u = readl_relaxed ( mvebu_gpioreg_in_pol ( mvchip ) ) ; u &= ~ BIT ( pin ) ; writel_relaxed ( u , mvebu_gpioreg_in_pol ( mvchip ) ) ; break ; case IRQ_TYPE_EDGE_FALLING : case IRQ_TYPE_LEVEL_LOW : u = readl_relaxed ( mvebu_gpioreg_in_pol ( mvchip ) ) ; u |= BIT ( pin ) ; writel_relaxed ( u , mvebu_gpioreg_in_pol ( mvchip ) ) ; break ; case IRQ_TYPE_EDGE_BOTH : { u32 v ; v = readl_relaxed ( mvebu_gpioreg_in_pol ( mvchip ) ) ^ readl_relaxed ( mvebu_gpioreg_data_in ( mvchip ) ) ; u = readl_relaxed ( mvebu_gpioreg_in_pol ( mvchip ) ) ; if ( v & BIT ( pin ) ) { u |= BIT ( pin ) ; } else { u &= ~ BIT ( pin ) ; } writel_relaxed ( u , mvebu_gpioreg_in_pol ( mvchip ) ) ; break ; } } return 0 ; } 