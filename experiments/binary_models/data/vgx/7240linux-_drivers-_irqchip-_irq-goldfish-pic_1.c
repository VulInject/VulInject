static int __init goldfish_pic_of_init ( struct device_node * of_node , struct device_node * parent ) { struct goldfish_pic_data * gfpic ; struct irq_chip_generic * gc ; struct irq_chip_type * ct ; unsigned int parent_irq ; int ret = 0 ; gfpic = kzalloc ( sizeof ( * gfpic ) , GFP_KERNEL ) ; if ( ! gfpic ) { ret = - ENOMEM ; out_err } parent_irq = irq_of_parse_and_map ( of_node , 0 ) ; if ( ! parent_irq ) { pr_err ( "Failed to map parent IRQ!\n" ) ; ret = - EINVAL ; out_free } gfpic -> base = of_iomap ( of_node , 0 ) ; if ( ! gfpic -> base ) { pr_err ( "Failed to map base address!\n" ) ; ret = - ENOMEM ; out_unmap_irq } writel ( 1 , gfpic -> base + GFPIC_REG_IRQ_DISABLE_ALL ) ; gc = irq_alloc_generic_chip ( "GFPIC" , 1 , GFPIC_IRQ_BASE , gfpic -> base , handle_level_irq ) ; if ( ! gc ) { pr_err ( "Failed to allocate chip structures!\n" ) ; ret = - ENOMEM ; out_iounmap } ct = gc -> chip_types ; ct -> regs . enable = GFPIC_REG_IRQ_ENABLE ; ct -> regs . disable = GFPIC_REG_IRQ_DISABLE ; ct -> chip . irq_unmask = irq_gc_unmask_enable_reg ; ct -> chip . irq_mask = irq_gc_mask_disable_reg ; irq_setup_generic_chip ( gc , IRQ_MSK ( GFPIC_NR_IRQS ) , 0 , IRQ_NOPROBE | IRQ_LEVEL , 0 ) ; gfpic -> irq_domain = irq_domain_add_legacy ( of_node , GFPIC_NR_IRQS , GFPIC_IRQ_BASE , 0 , & goldfish_irq_domain_ops , NULL ) ; if ( ! gfpic -> irq_domain ) { pr_err ( "Failed to add irqdomain!\n" ) ; ret = - ENOMEM ; out_destroy_generic_chip } irq_set_chained_handler_and_data ( parent_irq , goldfish_pic_cascade , gfpic ) ; pr_info ( "Successfully registered.\n" ) ; return 0 ; out_destroy_generic_chip irq_destroy_generic_chip ( gc , IRQ_MSK ( GFPIC_NR_IRQS ) , IRQ_NOPROBE | IRQ_LEVEL , 0 ) ; out_iounmap iounmap ( gfpic -> base ) ; out_unmap_irq irq_dispose_mapping ( parent_irq ) ; out_free out_err pr_err ( "Failed to initialize! (errno = %d)\n" , ret ) ; return ret ; } 