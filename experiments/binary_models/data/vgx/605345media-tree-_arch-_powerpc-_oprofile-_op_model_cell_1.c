static int cell_reg_setup ( struct op_counter_config * ctr , struct op_system_config * sys , int num_ctrs ) { int ret = 0 ; spu_cycle_reset = 0 ; pm_regs . debug_bus_control = 0 ; pm_regs . pm_cntrl . stop_at_max = 1 ; pm_regs . pm_cntrl . trace_mode = 0 ; pm_regs . pm_cntrl . freeze = 1 ; pm_regs . pm_cntrl . trace_buf_ovflw = 0 ; pm_regs . pm_cntrl . spu_addr_trace = 0 ; pm_rtas_token = rtas_token ( "ibm,cbe-perftools" ) ; if ( unlikely ( pm_rtas_token == RTAS_UNKNOWN_SERVICE ) ) { printk ( KERN_ERR "%s: rtas token ibm,cbe-perftools unknown\n" , __func__ ) ; return - EIO ; } if ( ctr [ 0 ] . event == SPU_CYCLES_EVENT_NUM ) { profiling_mode = SPU_PROFILING_CYCLES ; ret = cell_reg_setup_spu_cycles ( ctr , sys , num_ctrs ) ; } if ( ( ctr [ 0 ] . event >= SPU_EVENT_NUM_START ) && ( ctr [ 0 ] . event <= SPU_EVENT_NUM_STOP ) ) { profiling_mode = SPU_PROFILING_EVENTS ; spu_cycle_reset = ctr [ 0 ] . count ; cell_reg_setup_spu_events ( ctr , sys , num_ctrs ) ; } else { profiling_mode = PPU_PROFILING ; ret = cell_reg_setup_ppu ( ctr , sys , num_ctrs ) ; } return ret ; } 