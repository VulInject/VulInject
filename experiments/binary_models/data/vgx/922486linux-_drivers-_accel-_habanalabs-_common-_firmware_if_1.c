static int hl_fw_send_msi_info_msg ( struct hl_device * hdev ) { struct cpucp_array_data_packet * pkt ; size_t total_pkt_size , data_size ; u64 result ; int rc ; if ( ! hdev -> asic_funcs -> get_msi_info ) { return 0 ; } data_size = CPUCP_NUM_OF_MSI_TYPES * sizeof ( u32 ) ; total_pkt_size = sizeof ( cpucp_array_data_packet ) + data_size ; total_pkt_size = ( total_pkt_size + 0x7 ) & ~ 0x7 ; if ( total_pkt_size > USHRT_MAX ) { dev_err ( hdev -> dev , "CPUCP array data is too big\n" ) ; return - EINVAL ; } pkt = kzalloc ( total_pkt_size , GFP_KERNEL ) ; if ( ! pkt ) { return - ENOMEM ; } pkt -> length = cpu_to_le32 ( CPUCP_NUM_OF_MSI_TYPES ) ; memset ( ( void * ) & pkt -> data , 0xFF , data_size ) ; hdev -> asic_funcs -> get_msi_info ( pkt -> data , NULL ) ; pkt -> cpucp_pkt . ctl = cpu_to_le32 ( CPUCP_PACKET_MSI_INFO_SET << CPUCP_PKT_CTL_OPCODE_SHIFT ) ; rc = hdev -> asic_funcs -> send_cpu_message ( hdev , ( u32 * ) pkt , total_pkt_size , 0 , & result ) ; if ( rc && result == cpucp_packet_invalid ) { rc = 0 ; } if ( rc ) { dev_err ( hdev -> dev , "failed to send CPUCP array data\n" ) ; } kfree ( pkt ) ; return rc ; } 