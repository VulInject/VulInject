static int mvebu_pinctrl_build_functions ( struct platform_device * pdev , struct mvebu_pinctrl * pctl ) { struct mvebu_pinctrl_function * funcs ; int num = 0 , funcsize = pctl -> desc . npins ; int n , s ; funcs = devm_kzalloc ( & pdev -> dev , funcsize * sizeof ( mvebu_pinctrl_function ) , GFP_KERNEL ) ; for ( n = 0 ; n < pctl -> num_groups ; n ++ ) { struct mvebu_pinctrl_group * grp = & pctl -> groups [ n ] ; for ( s = 0 ; s < grp -> num_settings ; s ++ ) { int ret ; if ( pctl -> variant && ! ( pctl -> variant & grp -> settings [ s ] . variant ) ) { continue ; } ret = _add_function ( funcs , & funcsize , grp -> settings [ s ] . name ) ; if ( ret == - EOVERFLOW ) { dev_err ( & pdev -> dev , "More functions than pins(%d)\n" , pctl -> desc . npins ) ; } if ( ret < 0 ) { continue ; } num ++ ; } } pctl -> num_functions = num ; pctl -> functions = funcs ; for ( n = 0 ; n < pctl -> num_groups ; n ++ ) { struct mvebu_pinctrl_group * grp = & pctl -> groups [ n ] ; for ( s = 0 ; s < grp -> num_settings ; s ++ ) { struct mvebu_pinctrl_function * f ; const char * * groups ; if ( pctl -> variant && ! ( pctl -> variant & grp -> settings [ s ] . variant ) ) { continue ; } f = mvebu_pinctrl_find_function_by_name ( pctl , grp -> settings [ s ] . name ) ; if ( ! f -> groups ) { f -> groups = devm_kzalloc ( & pdev -> dev , f -> num_groups * sizeof ( char * ) , GFP_KERNEL ) ; if ( ! f -> groups ) { return - ENOMEM ; } } groups = f -> groups ; while ( * groups ) { groups ++ ; } * groups = grp -> name ; } } return 0 ; } 