static int adc128_probe ( struct i2c_client * client ) { struct device * dev = & client -> dev ; struct regulator * regulator ; struct device * hwmon_dev ; struct adc128_data * data ; int err , vref ; data = devm_kzalloc ( dev , sizeof ( adc128_data ) , GFP_KERNEL ) ; regulator = devm_regulator_get_optional ( dev , "vref" ) ; if ( ! IS_ERR ( regulator ) ) { data -> regulator = regulator ; err = regulator_enable ( regulator ) ; if ( err < 0 ) { return err ; } vref = regulator_get_voltage ( regulator ) ; if ( vref < 0 ) { err = vref ; error } data -> vref = DIV_ROUND_CLOSEST ( vref , 1000 ) ; } else { data -> vref = 2560 ; } if ( of_property_read_u8 ( dev -> of_node , "ti,mode" , & data -> mode ) == 0 ) { if ( data -> mode > 3 ) { dev_err ( dev , "invalid operation mode %d\n" , data -> mode ) ; err = - EINVAL ; error } } else { err = i2c_smbus_read_byte_data ( client , ADC128_REG_CONFIG_ADV ) ; if ( err < 0 ) { error } data -> mode = ( err >> 1 ) & ADC128_REG_MASK ; } data -> client = client ; i2c_set_clientdata ( client , data ) ; mutex_init ( & data -> update_lock ) ; err = adc128_init_client ( data ) ; if ( err < 0 ) { error } hwmon_dev = devm_hwmon_device_register_with_groups ( dev , client -> name , data , adc128_groups ) ; if ( IS_ERR ( hwmon_dev ) ) { err = PTR_ERR ( hwmon_dev ) ; error } return 0 ; error if ( data -> regulator ) { regulator_disable ( data -> regulator ) ; } return err ; } 