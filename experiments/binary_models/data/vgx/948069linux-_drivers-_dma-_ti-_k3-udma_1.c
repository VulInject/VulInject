static int bcdma_alloc_bchan_resources ( struct udma_chan * uc ) { struct k3_ring_cfg ring_cfg ; struct udma_dev * ud = uc -> ud ; int ret ; ret = bcdma_get_bchan ( uc ) ; if ( ret ) { return ret ; } ret = k3_ringacc_request_rings_pair ( ud -> ringacc , uc -> bchan -> id , - 1 , & uc -> bchan -> t_ring , & uc -> bchan -> tc_ring ) ; if ( ret ) { ret = - EBUSY ; err_ring } ring_cfg . size = K3_UDMA_DEFAULT_RING_SIZE ; ring_cfg . elm_size = K3_RINGACC_RING_ELSIZE_8 ; ring_cfg . mode = K3_RINGACC_RING_MODE_RING ; k3_configure_chan_coherency ( & uc -> vc . chan , ud -> asel ) ; ring_cfg . asel = ud -> asel ; ring_cfg . dma_dev = dmaengine_get_dma_device ( & uc -> vc . chan ) ; ret = k3_ringacc_ring_cfg ( uc -> bchan -> t_ring , & ring_cfg ) ; if ( ret ) { err_ringcfg } return 0 ; err_ringcfg k3_ringacc_ring_free ( uc -> bchan -> tc_ring ) ; uc -> bchan -> tc_ring = NULL ; k3_ringacc_ring_free ( uc -> bchan -> t_ring ) ; uc -> bchan -> t_ring = NULL ; k3_configure_chan_coherency ( & uc -> vc . chan , 0 ) ; err_ring bcdma_put_bchan ( uc ) ; return ret ; } 