int xfrm_dev_state_add ( struct net * net , struct xfrm_state * x , struct xfrm_user_offload * xuo ) { int err ; struct dst_entry * dst ; struct net_device * dev ; struct xfrm_state_offload * xso = & x -> xso ; xfrm_address_t * saddr ; xfrm_address_t * daddr ; if ( x -> encap || x -> tfcpad || ( x -> props . flags & XFRM_STATE_ESN ) ) { return 0 ; } dev = dev_get_by_index ( net , xuo -> ifindex ) ; if ( ! dev ) { if ( ! ( xuo -> flags & XFRM_OFFLOAD_INBOUND ) ) { saddr = & x -> props . saddr ; daddr = & x -> id . daddr ; } else { saddr = & x -> id . daddr ; daddr = & x -> props . saddr ; } dst = __xfrm_dst_lookup ( net , 0 , 0 , saddr , daddr , x -> props . family ) ; if ( IS_ERR ( dst ) ) { return 0 ; } dev = dst -> dev ; dev_hold ( dev ) ; dst_release ( dst ) ; } if ( ! dev -> xfrmdev_ops || ! dev -> xfrmdev_ops -> xdo_dev_state_add ) { dev_put ( dev ) ; return 0 ; } xso -> dev = dev ; xso -> num_exthdrs = 1 ; xso -> flags = xuo -> flags ; err = dev -> xfrmdev_ops -> xdo_dev_state_add ( x ) ; if ( err ) { dev_put ( dev ) ; return err ; } return 0 ; } 