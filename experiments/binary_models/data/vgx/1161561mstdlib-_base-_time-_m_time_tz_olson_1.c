M_time_tzs_t * M_time_tzs_load_zoneinfo ( const char * path , M_uint32 zones , M_uint32 alias_f , M_uint32 flags ) { M_time_tzs_t * tzs = NULL ; char * norm_path ; M_fs_error_t res ; if ( M_str_isempty ( path ) ) { return NULL ; { const char * path ; } , sys_paths [ ] { { "/usr/share/zoneinfo" } { "/usr/lib/zoneinfo" } { NULL } } ; int i ; for ( i = 0 ; sys_paths [ i ] . path != NULL ; i ++ ) { if ( M_fs_perms_can_access ( sys_paths [ i ] . path , M_FS_FILE_MODE_READ ) == M_FS_ERROR_SUCCESS ) { path = sys_paths [ i ] . path ; break ; } } if ( M_str_isempty ( path ) ) { return NULL ; } } res = M_fs_path_norm ( & norm_path , path , M_FS_PATH_NORM_ABSOLUTE | M_FS_PATH_NORM_RESALL , M_FS_SYSTEM_AUTO ) ; if ( res != M_FS_ERROR_SUCCESS ) { return NULL ; } tzs = M_time_tzs_create ( ) ; if ( flags & M_TIME_TZ_LOAD_LAZY ) { M_time_tzs_set_lazy_load ( tzs , M_time_tz_olson_lazy_load_tzfile , norm_path , M_free ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_AFRICA ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Africa" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_AMERICA ) { M_time_tz_olson_load_zone ( tzs , norm_path , "America" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_ANTARCTICA ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Antarctica" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_ARCTIC ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Arctic" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_ASIA ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Asia" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_ATLANTIC ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Atlantic" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_AUSTRALIA ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Australia" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_EUROPE ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Europe" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_INDIAN ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Indian" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_PACIFIC ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Pacific" , alias_f , flags ) ; } if ( zones == M_TIME_TZ_ZONE_ALL || zones & M_TIME_TZ_ZONE_ETC ) { M_time_tz_olson_load_zone ( tzs , norm_path , "Etc" , alias_f , flags ) ; } if ( ! ( flags & M_TIME_TZ_LOAD_LAZY ) ) { M_free ( norm_path ) ; } return tzs ; } 