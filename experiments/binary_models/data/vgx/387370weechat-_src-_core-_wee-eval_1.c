eval_expression_condition ( , ) { int logic , comp , length , level , rc , debug_id ; const char * pos , * pos_end ; char * expr2 , * sub_expr , * value , * tmp_value , * tmp_value2 ; EVAL_DEBUG_MSG ( 1 , "eval_expression_condition(\"%s\")" , expr ) ; value = NULL ; expr2 = NULL ; if ( ! expr ) { end } if ( ! expr [ 0 ] ) { value = strdup ( expr ) ; end } while ( expr [ 0 ] == ' ' ) { expr ++ ; } if ( ! expr [ 0 ] ) { value = strdup ( expr ) ; end } pos_end = expr + strlen ( expr ) - 1 ; while ( ( pos_end > expr ) && ( pos_end [ 0 ] == ' ' ) ) { pos_end -- ; } expr2 = string_strndup ( expr , pos_end + 1 - expr ) ; if ( ! expr2 ) { end } for ( logic = 0 ; logic < EVAL_NUM_LOGICAL_OPS ; logic ++ ) { pos = eval_strstr_level ( expr2 , eval_logical_ops [ logic ] , eval_context , "(" , ")" , 0 ) ; if ( pos > expr2 ) { pos_end = pos - 1 ; while ( ( pos_end > expr2 ) && ( pos_end [ 0 ] == ' ' ) ) { pos_end -- ; } sub_expr = string_strndup ( expr2 , pos_end + 1 - expr2 ) ; if ( ! sub_expr ) { end } tmp_value = eval_expression_condition ( sub_expr , eval_context ) ; rc = eval_is_true ( tmp_value ) ; if ( tmp_value ) { free ( tmp_value ) ; } if ( ( ! rc && ( logic == EVAL_LOGICAL_OP_AND ) ) || ( rc && ( logic == EVAL_LOGICAL_OP_OR ) ) ) { value = strdup ( ( rc ) ?EVAL_STR_TRUE : EVAL_STR_FALSE ) ; end } pos += strlen ( eval_logical_ops [ logic ] ) ; while ( pos [ 0 ] == ' ' ) { pos ++ ; } tmp_value = eval_expression_condition ( pos , eval_context ) ; rc = eval_is_true ( tmp_value ) ; if ( tmp_value ) { free ( tmp_value ) ; } value = strdup ( ( rc ) ?EVAL_STR_TRUE : EVAL_STR_FALSE ) ; end } } for ( comp = 0 ; comp < EVAL_NUM_COMPARISONS ; comp ++ ) { pos = eval_strstr_level ( expr2 , eval_comparisons [ comp ] , eval_context , "(" , ")" , 0 ) ; if ( pos >= expr2 ) { if ( pos > expr2 ) { pos_end = pos - 1 ; while ( ( pos_end > expr2 ) && ( pos_end [ 0 ] == ' ' ) ) { pos_end -- ; } sub_expr = string_strndup ( expr2 , pos_end + 1 - expr2 ) ; } else { sub_expr = strdup ( "" ) ; } if ( ! sub_expr ) { end } pos += strlen ( eval_comparisons [ comp ] ) ; while ( pos [ 0 ] == ' ' ) { pos ++ ; } if ( ( comp == EVAL_COMPARE_REGEX_MATCHING ) || ( comp == EVAL_COMPARE_REGEX_NOT_MATCHING ) ) { tmp_value = eval_replace_vars ( sub_expr , eval_context ) ; tmp_value2 = eval_replace_vars ( pos , eval_context ) ; } else { tmp_value = eval_expression_condition ( sub_expr , eval_context ) ; tmp_value2 = eval_expression_condition ( pos , eval_context ) ; } free ( sub_expr ) ; value = eval_compare ( tmp_value , comp , tmp_value2 , eval_context ) ; if ( tmp_value ) { free ( tmp_value ) ; } if ( tmp_value2 ) { free ( tmp_value2 ) ; } end } } while ( expr2 [ 0 ] == '(' ) { level = 0 ; pos = expr2 + 1 ; while ( pos [ 0 ] ) { if ( pos [ 0 ] == '(' ) { level ++ ; } if ( pos [ 0 ] == ')' ) { if ( level == 0 ) { break ; } level -- ; } pos ++ ; } if ( pos [ 0 ] != ')' ) { end } sub_expr = string_strndup ( expr2 + 1 , pos - expr2 - 1 ) ; if ( ! sub_expr ) { end } tmp_value = eval_expression_condition ( sub_expr , eval_context ) ; free ( sub_expr ) ; if ( ! pos [ 1 ] ) { value = tmp_value ; end } length = ( ( tmp_value ) ?strlen ( tmp_value ) : 0 ) + 1 + strlen ( pos + 1 ) + 1 ; tmp_value2 = malloc ( length ) ; if ( ! tmp_value2 ) { if ( tmp_value ) { free ( tmp_value ) ; } end } tmp_value2 [ 0 ] = '\0' ; if ( tmp_value ) { strcat ( tmp_value2 , tmp_value ) ; } strcat ( tmp_value2 , " " ) ; strcat ( tmp_value2 , pos + 1 ) ; free ( expr2 ) ; expr2 = tmp_value2 ; if ( tmp_value ) { free ( tmp_value ) ; } } value = eval_replace_vars ( expr2 , eval_context ) ; end if ( expr2 ) { free ( expr2 ) ; } EVAL_DEBUG_RESULT ( 1 , value ) ; return value ; } 