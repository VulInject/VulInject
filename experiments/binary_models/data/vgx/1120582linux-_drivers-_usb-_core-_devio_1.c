static int usbfs_start_wait_urb ( struct urb * urb , int timeout , unsigned int * actlen ) { DECLARE_COMPLETION_ONSTACK ( ctx ) ; unsigned long expire ; int rc ; urb -> context = & ctx ; urb -> complete = usbfs_blocking_completion ; * actlen = 0 ; rc = usb_submit_urb ( urb , GFP_KERNEL ) ; if ( unlikely ( rc ) ) { return rc ; } expire = ( timeout ?msecs_to_jiffies ( timeout ) : MAX_SCHEDULE_TIMEOUT ) ; rc = wait_for_completion_killable_timeout ( & ctx , expire ) ; if ( rc <= 0 ) { usb_kill_urb ( urb , NULL ) ; * actlen = urb -> actual_length ; if ( urb -> status != - ENOENT ) { } if ( rc < 0 ) { return - EINTR ; } else { return - ETIMEDOUT ; } } * actlen = urb -> actual_length ; return urb -> status ; } 