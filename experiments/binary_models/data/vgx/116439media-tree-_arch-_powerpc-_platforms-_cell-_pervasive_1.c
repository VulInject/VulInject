static void cbe_power_save ( void ) { unsigned long ctrl , thread_switch_control ; if ( ! prep_irq_for_idle ( ) ) { return ; } ctrl = mfspr ( SPRN_CTRLF ) ; thread_switch_control = mfspr ( SPRN_TSC_CELL , NULL ) ; thread_switch_control |= TSC_CELL_EE_ENABLE | TSC_CELL_EE_BOOST ; switch ( ctrl & CTRL_CT ) { case CTRL_CT0 : thread_switch_control |= TSC_CELL_DEC_ENABLE_0 ; break ; case CTRL_CT1 : thread_switch_control |= TSC_CELL_DEC_ENABLE_1 ; break ; default : printk ( KERN_WARNING "%s: unknown configuration\n" , __func__ ) ; break ; } mtspr ( SPRN_TSC_CELL , thread_switch_control ) ; HMT_low ( ) ; ctrl &= ~ ( CTRL_RUNLATCH | CTRL_TE ) ; mtspr ( SPRN_CTRLT , ctrl ) ; __hard_irq_enable ( ) ; } 