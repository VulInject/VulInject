bool knc_titan_set_work_multi ( const char * repr , void * const ctx , int channel , int die , int core_start , int slot , struct work * work , bool urgent , bool * work_accepted , struct knc_report * reports , int num ) { int REQUEST_BUFSIZE = 4 + 1 + BLOCK_HEADER_BYTES_WITHOUT_NONCE ; int RESPONSE_BUFSIZE = 1 + 1 + ( 1 + 4 ) * 5 ; int i , core ; uint8_t * requests = NULL ; uint8_t * responses = NULL ; int * request_lengths = NULL ; int * response_lengths = NULL ; int * statuses = NULL ; requests = malloc ( REQUEST_BUFSIZE * num ) ; if ( NULL == requests ) { exit_err } responses = malloc ( RESPONSE_BUFSIZE * num ) ; if ( NULL == responses ) { exit_err } request_lengths = malloc ( num * sizeof ( int ) ) ; if ( NULL == request_lengths ) { exit_err } response_lengths = malloc ( num * sizeof ( int ) ) ; if ( NULL == response_lengths ) { exit_err } statuses = malloc ( num * sizeof ( int ) ) ; if ( NULL == statuses ) { exit_err } for ( i = 0 , core = core_start ; i < num ; ++ i , ++ core ) { request_lengths [ i ] = knc_prepare_titan_setwork ( & requests [ REQUEST_BUFSIZE * i ] , die , core , slot , work , urgent ) ; response_lengths [ i ] = RESPONSE_BUFSIZE ; statuses [ i ] = KNC_ERR_UNAVAIL ; } knc_syncronous_transfer_multi ( ctx , channel , request_lengths , REQUEST_BUFSIZE , requests , response_lengths , RESPONSE_BUFSIZE , responses , statuses , num ) ; for ( i = 0 , core = core_start ; i < num ; ++ i , ++ core ) { uint8_t * response = & responses [ RESPONSE_BUFSIZE * i ] ; if ( statuses [ i ] == KNC_ACCEPTED ) { work_accepted [ i ] = true ; } else { work_accepted [ i ] = false ; if ( response [ 0 ] == 0x7f ) { applog ( LOG_DEBUG , "%s[%d:%d:%d]: Core disabled" , repr , channel , die , core ) ; continue ; } if ( statuses [ i ] & KNC_ERR_MASK ) { applog ( LOG_INFO , "%s[%d:%d:%d]: Failed to set work state (%x)" , repr , channel , die , core , statuses [ i ] ) ; continue ; } if ( ! ( statuses [ i ] & KNC_ERR_MASK ) ) { applog ( LOG_DEBUG , "%s[%d:%d:%d]: Core busy (%x)" , repr , channel , die , core , statuses [ i ] ) ; } } knc_decode_report ( response , & reports [ i ] , KNC_VERSION_TITAN ) ; } free ( response_lengths ) ; free ( request_lengths ) ; free ( statuses ) ; free ( responses ) ; return true ; exit_err if ( NULL != response_lengths ) { free ( response_lengths ) ; } if ( NULL != request_lengths ) { free ( request_lengths ) ; } if ( NULL != statuses ) { free ( statuses ) ; } if ( NULL != responses ) { free ( responses ) ; } if ( NULL != requests ) { free ( requests ) ; } return false ; } 