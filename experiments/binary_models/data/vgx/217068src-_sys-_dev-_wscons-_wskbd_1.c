int wskbdopen ( dev_t dev , int flags , int mode , struct proc * p ) { struct wskbd_softc * sc ; struct wseventvar * evar ; int unit , error ; unit = minor ( dev ) ; if ( unit >= wskbd_cd . cd_ndevs || ( sc = wskbd_cd . cd_devs [ unit ] ) == NULL ) { return ( ENXIO ) ; } DPRINTF ( ( "%s: %s mux=%p\n" , __func__ , sc -> sc_base . me_dv . dv_xname , sc -> sc_base . me_parent ) ) ; if ( ( flags & ( FREAD | FWRITE ) ) == FWRITE ) { return ( 0 ) ; } if ( sc -> sc_base . me_parent != NULL ) { DPRINTF ( ( "%s: detach\n" , __func__ ) ) ; wsmux_detach_sc ( & sc -> sc_base ) ; } if ( sc -> sc_base . me_evp != NULL ) { return ( EBUSY ) ; } evar = & sc -> sc_base . me_evar ; if ( wsevent_init ( evar ) ) { return ( EBUSY ) ; } error = wskbd_do_open ( sc , evar ) ; if ( error ) { wsevent_fini ( evar ) ; } return ( error ) ; } 