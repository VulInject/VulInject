static int dissect_bgp_update_pmsi_attr ( packet_info * pinfo , proto_tree * parent_tree , tvbuff_t * tvb , guint16 tlen , guint tvb_off ) { int offset = 0 ; guint8 tunnel_type = 0 ; guint8 opaque_value_type = 0 ; guint8 rn_addr_length = 0 ; guint16 tunnel_id_len = 0 ; guint16 opaque_value_length = 0 ; proto_item * tunnel_id_item = NULL ; proto_item * opaque_value_type_item ; proto_item * pmsi_tunnel_type_item = NULL ; proto_tree * tunnel_id_tree = NULL ; path_attr_data * data = NULL ; offset = tvb_off ; tunnel_id_len = tlen - 5 ; proto_tree_add_item ( parent_tree , hf_bgp_pmsi_tunnel_flags , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; pmsi_tunnel_type_item = proto_tree_add_item ( parent_tree , hf_bgp_pmsi_tunnel_type , tvb , offset + 1 , 1 , ENC_BIG_ENDIAN ) ; data = load_path_attr_data ( pinfo ) ; if ( data && data -> encaps_community_present && ( data -> encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLAN || data -> encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLANGPE ) ) { proto_tree_add_item ( parent_tree , hf_bgp_evpn_nlri_vni , tvb , offset + 2 , 3 , ENC_BIG_ENDIAN ) ; } else { proto_tree_add_item ( parent_tree , hf_bgp_update_mpls_label_value_20bits , tvb , offset + 2 , 3 , ENC_BIG_ENDIAN ) ; } tunnel_id_item = proto_tree_add_item ( parent_tree , hf_bgp_pmsi_tunnel_id , tvb , offset + 5 , tunnel_id_len , ENC_NA ) ; tunnel_id_tree = proto_item_add_subtree ( tunnel_id_item , ett_bgp_pmsi_tunnel_id ) ; tunnel_type = tvb_get_guint8 ( tvb , offset + 1 ) ; switch ( tunnel_type ) { case PMSI_TUNNEL_NOPRESENT : proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_not_present , tvb , offset + 1 , 1 , ENC_NA ) ; break ; case PMSI_TUNNEL_RSVPTE_P2MP : proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_rsvp_p2mp_id , tvb , offset + 5 , 4 , ENC_NA ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_rsvp_p2mp_tunnel_id , tvb , offset + 11 , 2 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_rsvp_p2mp_ext_tunnel_idv4 , tvb , offset + 13 , 4 , ENC_NA ) ; proto_item_append_text ( tunnel_id_item , ": Id %u, Ext Id %s" , tvb_get_ntohs ( tvb , offset + 11 ) , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 13 ) ) ; break ; case PMSI_TUNNEL_MLDP_P2MP : case PMSI_TUNNEL_MLDP_MP2MP : proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_type , tvb , offset + 5 , 1 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_afi , tvb , offset + 6 , 2 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_adr_len , tvb , offset + 8 , 1 , ENC_BIG_ENDIAN ) ; rn_addr_length = tvb_get_guint8 ( tvb , offset + 8 ) ; if ( rn_addr_length == 4 ) { proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_root_nodev4 , tvb , offset + 9 , 4 , ENC_BIG_ENDIAN ) ; } else { proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_root_nodev6 , tvb , offset + 9 , 16 , ENC_NA ) ; } proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_opa_len , tvb , offset + 9 + rn_addr_length , 2 , ENC_BIG_ENDIAN ) ; opaque_value_type_item = proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_opa_val_type , tvb , offset + 11 + rn_addr_length , 1 , ENC_BIG_ENDIAN ) ; opaque_value_type = tvb_get_guint8 ( tvb , offset + 11 + rn_addr_length ) ; if ( opaque_value_type == PMSI_MLDP_FEC_TYPE_GEN_LSP ) { proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_opa_val_len , tvb , offset + 12 + rn_addr_length , 2 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_opa_value_rn , tvb , offset + 14 + rn_addr_length , 4 , ENC_BIG_ENDIAN ) ; proto_item_append_text ( tunnel_id_item , ": Type: %s root node: %s Id: %u" , val_to_str_const ( tvb_get_guint8 ( tvb , offset + 5 ) , fec_types_vals , "Unknown" ) , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 9 ) , tvb_get_ntohl ( tvb , offset + 14 + rn_addr_length ) ) ; } if ( opaque_value_type == PMSI_MLDP_FEC_TYPE_EXT_TYPE ) { proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_opa_val_ext_type , tvb , offset + 12 + rn_addr_length , 2 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_opa_val_ext_len , tvb , offset + 14 + rn_addr_length , 2 , ENC_BIG_ENDIAN ) ; opaque_value_length = tvb_get_ntohs ( tvb , offset + 14 + rn_addr_length ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_mldp_fec_el_opa_value_str , tvb , offset + 16 + rn_addr_length , opaque_value_length , ENC_ASCII ) ; } else { expert_add_info_format ( pinfo , opaque_value_type_item , & ei_bgp_attr_pmsi_opaque_type , "Opaque Value type %u wrong, must be modulo 1 or 255" , opaque_value_type ) ; } break ; case PMSI_TUNNEL_PIMSSM : proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_pimssm_root_node , tvb , offset + 5 , 4 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_pimssm_pmc_group , tvb , offset + 9 , 4 , ENC_BIG_ENDIAN ) ; proto_item_append_text ( tunnel_id_item , ":<%s, %s>" , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 5 ) , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 9 ) ) ; break ; case PMSI_TUNNEL_PIMSM : proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_pimsm_sender , tvb , offset + 5 , 4 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_pimsm_pmc_group , tvb , offset + 9 , 4 , ENC_BIG_ENDIAN ) ; proto_item_append_text ( tunnel_id_item , ":<%s, %s>" , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 5 ) , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 9 ) ) ; break ; case PMSI_TUNNEL_BIDIR_PIM : proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_pimbidir_sender , tvb , offset + 5 , 4 , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_pimbidir_pmc_group , tvb , offset + 9 , 4 , ENC_BIG_ENDIAN ) ; proto_item_append_text ( tunnel_id_item , ":<%s, %s>" , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 5 ) , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 9 ) ) ; break ; case PMSI_TUNNEL_INGRESS : if ( tunnel_id_len == 4 ) { proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_ingress_rep_addr , tvb , offset + 5 , 4 , ENC_BIG_ENDIAN ) ; proto_item_append_text ( tunnel_id_item , ": tunnel end point ->%s" , tvb_ip_to_str ( pinfo -> pool , tvb , offset + 5 ) ) ; } else { proto_tree_add_item ( tunnel_id_tree , hf_bgp_pmsi_tunnel_ingress_rep_addr6 , tvb , offset + 5 , 16 , ENC_NA ) ; proto_item_append_text ( tunnel_id_item , ": tunnel end point ->%s" , tvb_ip6_to_str ( pinfo -> pool , tvb , offset + 5 ) ) ; } break ; default : expert_add_info_format ( pinfo , pmsi_tunnel_type_item , & ei_bgp_attr_pmsi_tunnel_type , "Tunnel type %u wrong" , tunnel_type ) ; break ; } return ( 0 ) ; } 