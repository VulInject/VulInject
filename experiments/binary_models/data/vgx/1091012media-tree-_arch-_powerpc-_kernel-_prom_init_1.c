static void __init scan_dt_build_struct ( phandle node , unsigned long * mem_start , unsigned long * mem_end ) { phandle child ; char * namep , * prev_name , * sstart , * p , * ep , * lp , * path ; unsigned long soff ; unsigned char * valp ; static char pname [ MAX_PROPERTY_NAME ] ; int l , room , has_phandle = 0 ; dt_push_token ( OF_DT_BEGIN_NODE , mem_start , mem_end ) ; namep = ( char * ) * mem_start ; room = * mem_end - * mem_start ; if ( room > 255 ) { room = 255 ; } l = call_prom ( "package-to-path" , 3 , 1 , node , namep , room ) ; if ( l >= 0 ) { if ( l >= room ) { if ( l >= * mem_end - * mem_start ) { namep = make_room ( mem_start , mem_end , l + 1 , 1 ) ; } call_prom ( "package-to-path" , 3 , 1 , node , namep , l ) ; } namep [ l ] = '\0' ; for ( lp = p = namep , ep = namep + l ; p < ep ; p ++ ) { if ( * p == '/' ) { lp = namep ; } if ( * p != 0 ) { * lp ++ = * p ; } } * lp = 0 ; * mem_start = _ALIGN ( ( unsigned long ) lp + 1 , 4 ) ; } path = prom_scratch ; call_prom ( "package-to-path" , 3 , 1 , node , path , PROM_SCRATCH_SIZE - 1 ) ; prev_name = "" ; sstart = ( char * ) dt_string_start ; for ( ; ; ) { if ( call_prom ( "nextprop" , 3 , 1 , node , prev_name , pname ) != 1 ) { break ; } if ( strcmp ( pname , "name" ) == 0 ) { prev_name = "name" ; continue ; } soff = dt_find_string ( pname ) ; if ( soff == 0 ) { prom_printf ( "WARNING: Can't find string index for" "<%s>, node %s\n" , pname , path ) ; break ; } prev_name = sstart + soff ; l = call_prom ( "getproplen" , 2 , 1 , node , pname ) ; if ( l == PROM_ERROR ) { continue ; } dt_push_token ( OF_DT_PROP , mem_start , mem_end ) ; dt_push_token ( l , mem_start , mem_end ) ; dt_push_token ( soff , mem_start , mem_end ) ; valp = make_room ( mem_start , mem_end , l , 4 ) ; call_prom ( "getprop" , 4 , 1 , node , pname , valp , l ) ; * mem_start = _ALIGN ( * mem_start , 4 ) ; if ( ! strcmp ( pname , "phandle" ) ) { has_phandle = 1 ; } } if ( ! has_phandle ) { soff = dt_find_string ( "linux,phandle" ) ; if ( soff == 0 ) { prom_printf ( "WARNING: Can't find string index for" "<linux-phandle>node %s\n" , path ) ; } else { dt_push_token ( OF_DT_PROP , mem_start , mem_end ) ; dt_push_token ( 4 , mem_start , mem_end ) ; dt_push_token ( soff , mem_start , mem_end ) ; valp = make_room ( mem_start , mem_end , 4 , 4 ) ; * ( __be32 * ) valp = cpu_to_be32 ( node ) ; } } child = call_prom ( "child" , 1 , 1 , node ) ; while ( child != 0 ) { scan_dt_build_struct ( child , mem_start , mem_end ) ; child = call_prom ( "peer" , 1 , 1 , child ) ; } dt_push_token ( OF_DT_END_NODE , mem_start , mem_end ) ; } 