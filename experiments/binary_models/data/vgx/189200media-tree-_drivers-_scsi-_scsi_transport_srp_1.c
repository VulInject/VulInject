( srp_rport_put ) ; struct srp_rport * srp_rport_add ( struct Scsi_Host * shost , struct srp_rport_identifiers * ids ) { struct srp_rport * rport ; struct device * parent = & shost -> shost_gendev ; struct srp_internal * i = to_srp_internal ( shost -> transportt ) ; int id , ret ; rport = kzalloc ( sizeof ( * rport ) , GFP_KERNEL ) ; if ( ! rport ) { return ERR_PTR ( - ENOMEM ) ; } device_initialize ( & rport -> dev ) ; rport -> dev . parent = get_device ( parent ) ; rport -> dev . release = srp_rport_release ; memcpy ( rport -> port_id , ids -> port_id , sizeof ( rport -> port_id ) ) ; rport -> roles = ids -> roles ; if ( i -> f -> reconnect ) { rport -> reconnect_delay = i -> f -> reconnect_delay ?* i -> f -> reconnect_delay : 10 ; } INIT_DELAYED_WORK ( & rport -> reconnect_work , srp_reconnect_work ) ; rport -> fast_io_fail_tmo = i -> f -> fast_io_fail_tmo ?* i -> f -> fast_io_fail_tmo : 15 ; rport -> dev_loss_tmo = i -> f -> dev_loss_tmo ?* i -> f -> dev_loss_tmo : 60 ; INIT_DELAYED_WORK ( & rport -> fast_io_fail_work , rport_fast_io_fail_timedout ) ; INIT_DELAYED_WORK ( & rport -> dev_loss_work , rport_dev_loss_timedout ) ; id = atomic_inc_return ( & to_srp_host_attrs ( shost ) -> next_port_id ) ; dev_set_name ( & rport -> dev , "port-%d:%d" , shost -> host_no , id ) ; transport_setup_device ( & rport -> dev ) ; ret = device_add ( & rport -> dev ) ; if ( ret ) { transport_destroy_device ( & rport -> dev ) ; put_device ( & rport -> dev ) ; return ERR_PTR ( ret ) ; } transport_add_device ( & rport -> dev ) ; transport_configure_device ( & rport -> dev ) ; return rport ; } 