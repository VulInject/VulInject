static int lpfc_send_npiv_logo ( struct lpfc_vport * vport , struct lpfc_nodelist * ndlp ) { int rc ; struct lpfc_hba * phba = vport -> phba ; DECLARE_WAIT_QUEUE_HEAD_ONSTACK ( waitq ) ; spin_lock_irq ( & ndlp -> lock ) ; if ( ! ( ndlp -> save_flags & NLP_WAIT_FOR_LOGO ) && ! ndlp -> logo_waitq ) { ndlp -> logo_waitq = & waitq ; ndlp -> nlp_fcp_info &= ~ NLP_FCP_2_DEVICE ; ndlp -> nlp_flag |= NLP_ISSUE_LOGO ; ndlp -> save_flags |= NLP_WAIT_FOR_LOGO ; } spin_unlock_irq ( & ndlp -> lock ) ; rc = lpfc_issue_els_npiv_logo ( vport , ndlp ) ; if ( ! rc ) { wait_event_timeout ( waitq , ( ! ( ndlp -> save_flags & NLP_WAIT_FOR_LOGO ) ) , msecs_to_jiffies ( phba -> fc_ratov * 2000 ) ) ; if ( ! ( ndlp -> save_flags & NLP_WAIT_FOR_LOGO ) ) { logo_cmpl } rc = - EINTR ; } else { rc = - EIO ; } spin_lock_irq ( & ndlp -> lock ) ; ndlp -> nlp_flag &= ~ NLP_ISSUE_LOGO ; ndlp -> save_flags &= ~ NLP_WAIT_FOR_LOGO ; spin_unlock_irq ( & ndlp -> lock ) ; logo_cmpl lpfc_printf_vlog ( vport , KERN_INFO , LOG_VPORT , "1824 Issue LOGO completes with status %d\n" , rc ) ; spin_lock_irq ( & ndlp -> lock ) ; spin_unlock_irq ( & ndlp -> lock ) ; return rc ; } 