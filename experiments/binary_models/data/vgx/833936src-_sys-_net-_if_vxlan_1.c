static struct mbuf * vxlan_encap_ipv4 ( struct vxlan_softc * sc , struct mbuf * m , const union vxlan_addr * endpoint , uint8_t tos ) { struct ip * ip ; m = m_prepend ( m , sizeof ( * ip ) , M_DONTWAIT ) ; ip = mtod ( m , ip * ) ; ip -> ip_v = IPVERSION ; ip -> ip_hl = sizeof ( * ip ) >> 2 ; ip -> ip_off = sc -> sc_df ; ip -> ip_tos = tos ; ip -> ip_len = htons ( m -> m_pkthdr . len ) ; ip -> ip_ttl = sc -> sc_ttl ; ip -> ip_p = IPPROTO_UDP ; ip -> ip_src = sc -> sc_src . in4 ; ip -> ip_dst = endpoint -> in4 ; return ( m ) ; } 