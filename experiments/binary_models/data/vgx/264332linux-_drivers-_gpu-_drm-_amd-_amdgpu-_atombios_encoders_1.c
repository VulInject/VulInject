void amdgpu_atombios_encoder_setup_dig_encoder ( struct drm_encoder * encoder , int action , int panel_mode ) { struct drm_device * dev = encoder -> dev ; struct amdgpu_device * adev = drm_to_adev ( dev ) ; struct amdgpu_encoder * amdgpu_encoder = to_amdgpu_encoder ( encoder ) ; struct amdgpu_encoder_atom_dig * dig = amdgpu_encoder -> enc_priv ; struct drm_connector * connector = amdgpu_get_connector_for_encoder ( encoder ) ; union dig_encoder_control args ; int index = GetIndexIntoMasterTable ( COMMAND , DIGxEncoderControl ) ; uint8_t frev , crev ; int dp_clock = 0 ; int dp_lane_count = 0 ; int hpd_id = AMDGPU_HPD_NONE ; if ( connector ) { struct amdgpu_connector * amdgpu_connector = to_amdgpu_connector ( connector ) ; struct amdgpu_connector_atom_dig * dig_connector = amdgpu_connector -> con_priv ; dp_clock = dig_connector -> dp_clock ; dp_lane_count = dig_connector -> dp_lane_count ; hpd_id = amdgpu_connector -> hpd . hpd ; } if ( dig -> dig_encoder == - 1 ) { return ; } if ( ! amdgpu_atom_parse_cmd_header ( adev -> mode_info . atom_context , index , & frev , & crev ) ) { return ; } switch ( frev ) { case 1 : switch ( crev ) { case 1 : args . v1 . ucAction = action ; args . v1 . usPixelClock = cpu_to_le16 ( amdgpu_encoder -> pixel_clock / 10 ) ; if ( action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE ) { args . v3 . ucPanelMode = panel_mode ; } else { args . v1 . ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode ( encoder ) ; } if ( ENCODER_MODE_IS_DP ( args . v1 . ucEncoderMode ) ) { args . v1 . ucLaneNum = dp_lane_count ; } if ( amdgpu_dig_monitor_is_duallink ( encoder , amdgpu_encoder -> pixel_clock ) ) { args . v1 . ucLaneNum = 8 ; } else { args . v1 . ucLaneNum = 4 ; } if ( ENCODER_MODE_IS_DP ( args . v1 . ucEncoderMode ) && ( dp_clock == 270000 ) ) { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_DPLINKRATE_2_70GHZ ; } switch ( amdgpu_encoder -> encoder_id ) { case ENCODER_OBJECT_ID_INTERNAL_UNIPHY : args . v1 . ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER1 ; break ; case ENCODER_OBJECT_ID_INTERNAL_UNIPHY1 : case ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA : args . v1 . ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER2 ; break ; case ENCODER_OBJECT_ID_INTERNAL_UNIPHY2 : args . v1 . ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER3 ; break ; } if ( dig -> linkb ) { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_LINKB ; } else { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_LINKA ; } break ; case 2 : case 3 : args . v3 . ucAction = action ; args . v3 . usPixelClock = cpu_to_le16 ( amdgpu_encoder -> pixel_clock / 10 ) ; if ( action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE ) { args . v3 . ucPanelMode = panel_mode ; } else { args . v3 . ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode ( encoder ) ; } if ( ENCODER_MODE_IS_DP ( args . v3 . ucEncoderMode ) ) { args . v3 . ucLaneNum = dp_lane_count ; } if ( amdgpu_dig_monitor_is_duallink ( encoder , amdgpu_encoder -> pixel_clock ) ) { args . v3 . ucLaneNum = 8 ; } else { args . v3 . ucLaneNum = 4 ; } if ( ENCODER_MODE_IS_DP ( args . v3 . ucEncoderMode ) && ( dp_clock == 270000 ) ) { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_V3_DPLINKRATE_2_70GHZ ; } args . v3 . acConfig . ucDigSel = dig -> dig_encoder ; args . v3 . ucBitPerColor = amdgpu_atombios_encoder_get_bpc ( encoder ) ; break ; case 4 : args . v4 . ucAction = action ; args . v4 . usPixelClock = cpu_to_le16 ( amdgpu_encoder -> pixel_clock / 10 ) ; if ( action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE ) { args . v4 . ucPanelMode = panel_mode ; } else { args . v4 . ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode ( encoder ) ; } if ( ENCODER_MODE_IS_DP ( args . v4 . ucEncoderMode ) ) { args . v4 . ucLaneNum = dp_lane_count ; } if ( amdgpu_dig_monitor_is_duallink ( encoder , amdgpu_encoder -> pixel_clock ) ) { args . v4 . ucLaneNum = 8 ; } else { args . v4 . ucLaneNum = 4 ; } if ( ENCODER_MODE_IS_DP ( args . v4 . ucEncoderMode ) ) { if ( dp_clock == 540000 ) { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_5_40GHZ ; } if ( dp_clock == 324000 ) { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_3_24GHZ ; } if ( dp_clock == 270000 ) { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_2_70GHZ ; } else { args . v1 . ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_1_62GHZ ; } } args . v4 . acConfig . ucDigSel = dig -> dig_encoder ; args . v4 . ucBitPerColor = amdgpu_atombios_encoder_get_bpc ( encoder ) ; if ( hpd_id == AMDGPU_HPD_NONE ) { args . v4 . ucHPD_ID = 0 ; } else { args . v4 . ucHPD_ID = hpd_id + 1 ; } break ; case 5 : switch ( action ) { case ATOM_ENCODER_CMD_SETUP_PANEL_MODE : args . v5 . asDPPanelModeParam . ucAction = action ; args . v5 . asDPPanelModeParam . ucPanelMode = panel_mode ; args . v5 . asDPPanelModeParam . ucDigId = dig -> dig_encoder ; break ; case ATOM_ENCODER_CMD_STREAM_SETUP : args . v5 . asStreamParam . ucAction = action ; args . v5 . asStreamParam . ucDigId = dig -> dig_encoder ; args . v5 . asStreamParam . ucDigMode = amdgpu_atombios_encoder_get_encoder_mode ( encoder ) ; if ( ENCODER_MODE_IS_DP ( args . v5 . asStreamParam . ucDigMode ) ) { args . v5 . asStreamParam . ucLaneNum = dp_lane_count ; } if ( amdgpu_dig_monitor_is_duallink ( encoder , amdgpu_encoder -> pixel_clock ) ) { args . v5 . asStreamParam . ucLaneNum = 8 ; } else { args . v5 . asStreamParam . ucLaneNum = 4 ; } args . v5 . asStreamParam . ulPixelClock = cpu_to_le32 ( amdgpu_encoder -> pixel_clock / 10 ) ; args . v5 . asStreamParam . ucBitPerColor = amdgpu_atombios_encoder_get_bpc ( encoder ) ; args . v5 . asStreamParam . ucLinkRateIn270Mhz = dp_clock / 27000 ; break ; case ATOM_ENCODER_CMD_DP_LINK_TRAINING_START : case ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN1 : case ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN2 : case ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN3 : case ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN4 : case ATOM_ENCODER_CMD_DP_LINK_TRAINING_COMPLETE : case ATOM_ENCODER_CMD_DP_VIDEO_OFF : case ATOM_ENCODER_CMD_DP_VIDEO_ON : args . v5 . asCmdParam . ucAction = action ; args . v5 . asCmdParam . ucDigId = dig -> dig_encoder ; break ; default : DRM_ERROR ( "Unsupported action 0x%x\n" , action ) ; break ; } break ; default : DRM_ERROR ( "Unknown table version %d, %d\n" , frev , crev ) ; break ; } break ; default : DRM_ERROR ( "Unknown table version %d, %d\n" , frev , crev ) ; break ; } amdgpu_atom_execute_table ( adev -> mode_info . atom_context , index , ( uint32_t * ) & args ) ; } 