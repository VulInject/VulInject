static int cmf_cmb_copy_wait ( struct ccw_device * cdev ) { struct copy_block_struct * copy_block ; int ret ; unsigned long flags ; spin_lock_irqsave ( cdev -> ccwlock , flags ) ; if ( ! cdev -> private -> cmb ) { ret = - ENODEV ; out } copy_block = kmalloc ( sizeof ( copy_block_struct ) , GFP_ATOMIC ) ; if ( ! copy_block ) { ret = - ENOMEM ; out } init_waitqueue_head ( & copy_block -> wait ) ; kref_init ( & copy_block -> kref ) ; ret = cmf_copy_block ( cdev ) ; if ( ret != - EBUSY ) { out_put } if ( cdev -> private -> state != DEV_STATE_ONLINE ) { ret = - EBUSY ; out_put } cdev -> private -> state = DEV_STATE_CMFUPDATE ; copy_block -> ret = CMF_PENDING ; cdev -> private -> cmb_wait = copy_block ; spin_unlock_irqrestore ( cdev -> ccwlock , flags ) ; if ( wait_event_interruptible ( copy_block -> wait , copy_block -> ret != CMF_PENDING ) ) { spin_lock_irqsave ( cdev -> ccwlock , flags ) ; if ( copy_block -> ret == CMF_PENDING ) { copy_block -> ret = - ERESTARTSYS ; if ( cdev -> private -> state == DEV_STATE_CMFUPDATE ) { cdev -> private -> state = DEV_STATE_ONLINE ; } } spin_unlock_irqrestore ( cdev -> ccwlock , flags ) ; } spin_lock_irqsave ( cdev -> ccwlock , flags ) ; cdev -> private -> cmb_wait = NULL ; ret = copy_block -> ret ; out_put kref_put ( & copy_block -> kref , cmf_copy_block_release ) ; out spin_unlock_irqrestore ( cdev -> ccwlock , flags ) ; return ret ; } 