int in_cksum ( struct mbuf * m , int len ) { int sum = 0 ; int mlen = 0 ; int clen = 0 ; caddr_t addr ; union l_util l_util ; union q_util q_util ; for ( ; m && len ; m = m -> m_next ) { if ( m -> m_len == 0 ) { continue ; } mlen = m -> m_len ; if ( len < mlen ) { mlen = len ; } addr = mtod ( m , caddr_t ) ; if ( ( clen ^ ( long ) addr ) & 1 ) { sum += in_cksumdata ( addr , mlen ) << 8 ; } else { sum += in_cksumdata ( addr , mlen ) ; } clen += mlen ; len -= mlen ; } REDUCE16 ; return ( ~ sum & 0xffff ) ; } 