rc = rf_get_munge_headers ( addr , rblock , & addr -> prop . extra_headers , & addr -> prop . remove_headers ) ; if ( rc != OK ) { return rc ; } if ( ! individual_transport_set ) { if ( ! rf_get_transport ( rblock -> transport_name , & ( rblock -> transport ) , addr , rblock -> name , NULL ) ) { return DEFER ; } transport = rblock -> transport ; } if ( transport && transport -> info -> local ) { if ( hostlist [ 0 ] ) { host_item * h ; addr -> host_list = h = store_get ( sizeof ( host_item ) , GET_UNTAINTED ) ; h -> name = string_copy ( hostlist ) ; h -> address = NULL ; h -> port = PORT_NONE ; h -> mx = MX_NONE ; h -> status = hstatus_unknown ; h -> why = hwhy_unknown ; h -> last_try = 0 ; h -> next = NULL ; } addr -> transport = transport ; return rf_queue_add ( addr , addr_local , addr_remote , rblock , pw ) ?OK : DEFER ; } if ( ! hostlist [ 0 ] ) { if ( verify != v_none ) { ROUTED } addr -> message = string_sprintf ( "error in %s router: no host(s) specified " "for domain %s" , rblock -> name , addr -> domain ) ; log_write ( 0 , LOG_MAIN , "%s" , addr -> message ) ; return DEFER ; } host_build_hostlist ( & addr -> host_list , hostlist , randomize ) ; rc = rf_lookup_hostlist ( rblock , addr , rblock -> ignore_target_hosts , lookup_type , ob -> hff_code , addr_new ) ; if ( rc != OK ) { return rc ; } if ( ! addr -> host_list ) { int i ; DEBUG ( ) debug_printf ( "host_find_failed ignored every host\n" ) ; if ( ob -> hai_code == hff_decline ) { return DECLINE ; } if ( ob -> hai_code == hff_pass ) { return PASS ; } for ( i = 0 ; i < hff_count ; i ++ ) { if ( ob -> hai_code == hff_codes [ i ] ) { break ; } } addr -> message = string_sprintf ( "lookup failed for all hosts in %s router: " "host_find_failed=ignore host_all_ignored=%s" , rblock -> name , hff_names [ i ] ) ; if ( ob -> hai_code == hff_defer ) { return DEFER ; } if ( ob -> hai_code == hff_fail ) { return FAIL ; } addr -> special_action = SPECIAL_FREEZE ; return DEFER ; } if ( ! transport && verify == v_none ) { log_write ( 0 , LOG_MAIN , "Error in %s router: no transport defined" , rblock -> name ) ; addr -> message = US "error in router: transport missing" ; return DEFER ; } ROUTED addr -> transport = transport ; ( void ) rf_queue_add ( addr , addr_local , addr_remote , rblock , NULL ) ; return OK ; 