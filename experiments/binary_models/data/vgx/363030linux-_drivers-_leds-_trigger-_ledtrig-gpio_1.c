static ssize_t gpio_trig_gpio_store ( struct device * dev , struct device_attribute * attr , const char * buf , size_t n ) { struct led_classdev * led = led_trigger_get_led ( dev ) ; struct gpio_trig_data * gpio_data = led_trigger_get_drvdata ( dev ) ; unsigned gpio ; int ret ; ret = sscanf ( buf , "%u" , & gpio ) ; if ( ret < 1 ) { dev_err ( dev , "couldn't read gpio number\n" ) ; return - EINVAL ; } if ( ! gpio_is_valid ( gpio ) ) { if ( gpio_is_valid ( gpio_data -> gpio ) ) { free_irq ( gpio_to_irq ( gpio_data -> gpio ) , led ) ; } gpio_data -> gpio = gpio ; return n ; } ret = request_threaded_irq ( gpio_to_irq ( gpio ) , NULL , gpio_trig_irq , IRQF_ONESHOT | IRQF_SHARED | IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING , "ledtrig-gpio" , led ) ; if ( ret ) { dev_err ( dev , "request_irq failed with error %d\n" , ret ) ; } else { if ( gpio_is_valid ( gpio_data -> gpio ) ) { free_irq ( gpio_to_irq ( gpio_data -> gpio ) , led ) ; } gpio_data -> gpio = gpio ; gpio_trig_irq ( 0 , led ) ; } return ret ?ret : n ; } 