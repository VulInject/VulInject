if_capabilities_t * capture_get_if_capabilities ( const gchar * ifname , gboolean monitor_mode , const gchar * auth_string , char * * err_primary_msg , char * * err_secondary_msg , void * update_cb ( void ) ) { if_capabilities_t * caps ; GList * linktype_list = NULL , * timestamp_list = NULL ; int err , i ; gchar * data , * primary_msg , * secondary_msg ; gchar * * raw_list ; caps = extcap_get_if_dlts ( ifname , err_primary_msg ) ; if ( caps != NULL ) { return caps ; } if ( err_primary_msg != NULL && * err_primary_msg != NULL ) { return NULL ; } err = sync_if_capabilities_open ( ifname , monitor_mode , auth_string , & data , & primary_msg , & secondary_msg , update_cb ) ; if ( err != 0 ) { ws_info ( "Capture Interface Capabilities failed. Error %d, %s" , err , primary_msg ?primary_msg : "no message" ) ; if ( err_primary_msg ) { * err_primary_msg = primary_msg ; } else { g_free ( primary_msg ) ; } if ( err_secondary_msg ) { * err_secondary_msg = secondary_msg ; } else { g_free ( secondary_msg ) ; } return NULL ; } raw_list = g_strsplit ( data , "\r\n" , 0 ) ; raw_list = g_strsplit ( data , "\n" , 0 ) ; g_free ( data ) ; if ( raw_list [ 0 ] == NULL || * raw_list [ 0 ] == '\0' ) { ws_info ( "Capture Interface Capabilities returned no information." ) ; if ( err_primary_msg ) { * err_primary_msg = g_strdup ( "Dumpcap returned no interface capability information" ) ; } g_strfreev ( raw_list ) ; return NULL ; } caps = ( if_capabilities_t * ) g_malloc ( sizeof caps ) ; switch ( * raw_list [ 0 ] ) { case '0' : caps -> can_set_rfmon = FALSE ; break ; case '1' : caps -> can_set_rfmon = TRUE ; break ; default : ws_info ( "Capture Interface Capabilities returned bad information." ) ; if ( err_primary_msg ) { * err_primary_msg = ws_strdup_printf ( "Dumpcap returned \"%s\" for monitor-mode capability" , raw_list [ 0 ] ) ; } g_strfreev ( raw_list ) ; return NULL ; } for ( i = 1 ; raw_list [ i ] != NULL && * raw_list [ i ] != '\0' ; i ++ ) { data_link_info_t * data_link_info ; char * * lt_parts = g_strsplit ( raw_list [ i ] , "\t" , 3 ) ; if ( lt_parts [ 0 ] == NULL || lt_parts [ 1 ] == NULL || lt_parts [ 2 ] == NULL ) { g_strfreev ( lt_parts ) ; continue ; } data_link_info = g_new ( data_link_info_t , 1 ) ; data_link_info -> dlt = ( int ) strtol ( lt_parts [ 0 ] , NULL , 10 ) ; data_link_info -> name = g_strdup ( lt_parts [ 1 ] ) ; if ( strcmp ( lt_parts [ 2 ] , "(not supported)" ) != 0 ) { data_link_info -> description = g_strdup ( lt_parts [ 2 ] ) ; } else { data_link_info -> description = NULL ; } g_strfreev ( lt_parts ) ; linktype_list = g_list_append ( linktype_list , data_link_info ) ; } if ( raw_list [ i ] ) { for ( i ++ ; raw_list [ i ] != NULL && * raw_list [ i ] != '\0' ; i ++ ) { timestamp_info_t * timestamp_info ; char * * tt_parts = g_strsplit ( raw_list [ i ] , "\t" , 2 ) ; if ( tt_parts [ 0 ] == NULL || tt_parts [ 1 ] == NULL ) { g_strfreev ( tt_parts ) ; continue ; } timestamp_info = g_new ( timestamp_info_t , 1 ) ; timestamp_info -> name = g_strdup ( tt_parts [ 0 ] ) ; timestamp_info -> description = g_strdup ( tt_parts [ 1 ] ) ; g_strfreev ( tt_parts ) ; timestamp_list = g_list_append ( timestamp_list , timestamp_info ) ; } } g_strfreev ( raw_list ) ; caps -> data_link_types = linktype_list ; caps -> timestamp_types = timestamp_list ; return caps ; } 