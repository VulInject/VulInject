int eeh_add_to_parent_pe ( struct eeh_dev * edev ) { struct eeh_pe * pe , * parent ; if ( ! eeh_has_flag ( EEH_VALID_PE_ZERO ) && ! edev -> pe_config_addr ) { pr_err ( "%s: Invalid PE#0 for edev 0x%x on PHB#%x\n" , __func__ , edev -> config_addr , edev -> phb -> global_number ) ; return - EINVAL ; } pe = eeh_pe_get ( edev ) ; if ( pe && ! ( pe -> type & EEH_PE_INVALID ) ) { pe -> type = EEH_PE_BUS ; edev -> pe = pe ; list_add_tail ( & edev -> list , & pe -> edevs ) ; pr_debug ( "EEH: Add %04x:%02x:%02x.%01x to Bus PE#%x\n" , edev -> phb -> global_number , edev -> config_addr >> 8 , PCI_SLOT ( edev -> config_addr & 0xFF ) , PCI_FUNC ( edev -> config_addr & 0xFF ) , pe -> addr ) ; return 0 ; } if ( pe && ( pe -> type & EEH_PE_INVALID ) ) { list_add_tail ( & edev -> list , & pe -> edevs ) ; edev -> pe = pe ; parent = pe ; while ( parent ) { if ( ! ( parent -> type & EEH_PE_INVALID ) ) { break ; } parent -> type &= ~ ( EEH_PE_INVALID | EEH_PE_KEEP ) ; parent = parent -> parent ; } pr_debug ( "EEH: Add %04x:%02x:%02x.%01x to Device " "PE#%x, Parent PE#%x\n" , edev -> phb -> global_number , edev -> config_addr >> 8 , PCI_SLOT ( edev -> config_addr & 0xFF ) , PCI_FUNC ( edev -> config_addr & 0xFF ) , pe -> addr , pe -> parent -> addr ) ; return 0 ; } if ( edev -> physfn ) { pe = eeh_pe_alloc ( edev -> phb , EEH_PE_VF ) ; } else { pe = eeh_pe_alloc ( edev -> phb , EEH_PE_DEVICE ) ; } if ( ! pe ) { pr_err ( "%s: out of memory!\n" , __func__ ) ; return - ENOMEM ; } pe -> addr = edev -> pe_config_addr ; pe -> config_addr = edev -> config_addr ; parent = eeh_pe_get_parent ( edev ) ; if ( ! parent ) { parent = eeh_phb_pe_get ( edev -> phb ) ; if ( ! parent ) { pr_err ( "%s: No PHB PE is found (PHB Domain=%d)\n" , __func__ , edev -> phb -> global_number ) ; edev -> pe = NULL ; return - EEXIST ; } } pe -> parent = parent ; list_add_tail ( & pe -> child , & parent -> child_list ) ; list_add_tail ( & edev -> list , & pe -> edevs ) ; edev -> pe = pe ; pr_debug ( "EEH: Add %04x:%02x:%02x.%01x to " "Device PE#%x, Parent PE#%x\n" , edev -> phb -> global_number , edev -> config_addr >> 8 , PCI_SLOT ( edev -> config_addr & 0xFF ) , PCI_FUNC ( edev -> config_addr & 0xFF ) , pe -> addr , pe -> parent -> addr ) ; return 0 ; } 