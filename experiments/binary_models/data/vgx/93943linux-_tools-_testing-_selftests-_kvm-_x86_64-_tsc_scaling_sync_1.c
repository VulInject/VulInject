int main ( int argc , char * argv [ ] ) { TEST_REQUIRE ( kvm_has_cap ( KVM_CAP_VM_TSC_CONTROL ) ) ; vm = vm_create ( NR_TEST_VCPUS ) ; vm_ioctl ( vm , KVM_SET_TSC_KHZ , ( void * ) TEST_TSC_KHZ ) ; pthread_spin_init ( & create_lock , PTHREAD_PROCESS_PRIVATE ) ; pthread_t cpu_threads [ NR_TEST_VCPUS ] ; unsigned long cpu ; for ( cpu = 0 ; cpu < NR_TEST_VCPUS ; cpu ++ ) { pthread_create ( & cpu_threads [ cpu ] , NULL , run_vcpu , ( void * ) cpu ) ; } cfs_time_t failures = 0 ; for ( cpu = 0 ; cpu < NR_TEST_VCPUS ; cpu ++ ) { void * this_cpu_failures ; pthread_join ( cpu_threads [ cpu ] , & this_cpu_failures ) ; failures += ( unsigned long ) this_cpu_failures ; } TEST_ASSERT ( ! failures , "TSC sync failed" ) ; pthread_spin_destroy ( & create_lock ) ; kvm_vm_free ( vm ) ; return 0 ; } 