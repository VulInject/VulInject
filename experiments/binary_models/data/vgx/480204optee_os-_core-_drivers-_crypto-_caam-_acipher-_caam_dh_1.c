static TEE_Result do_shared_secret ( struct drvcrypt_secret_data * sdata ) { TEE_Result ret = TEE_ERROR_GENERIC ; enum caam_status retstatus = CAAM_FAILURE ; struct dh_keypair * inkeypair = sdata -> key_priv ; struct caam_dh_keypair caam_dh_key = { } ; struct caamdmaobj secret = { } ; struct caam_jobctx jobctx = { } ; uint32_t * desc = NULL ; int desclen = 0 ; uint32_t pdb_sgt_flags = 0 ; DH_TRACE ( "DH Shared Secret" ) ; desc = caam_calloc_desc ( MAX_DESC_SHARED ) ; if ( ! desc ) { ret = TEE_ERROR_OUT_OF_MEMORY ; out } ret = caam_dmaobj_output_sgtbuf ( & secret , sdata -> secret . data , sdata -> secret . length , sdata -> secret . length ) ; if ( ret ) { out } if ( secret . sgtbuf . sgt_type ) { pdb_sgt_flags |= PDB_SGT_PKDH_SECRET ; } caam_dmaobj_cache_push ( & secret ) ; retstatus = do_keypriv_conv ( & caam_dh_key , inkeypair ) ; if ( retstatus != CAAM_NO_ERROR ) { ret = TEE_ERROR_OUT_OF_MEMORY ; out } retstatus = do_keypub_conv ( & caam_dh_key , sdata -> key_pub ) ; if ( retstatus != CAAM_NO_ERROR ) { ret = caam_status_to_tee_result ( retstatus ) ; out } caam_desc_init ( desc ) ; caam_desc_add_word ( desc , DESC_HEADER ( 0 ) ) ; caam_desc_add_word ( desc , pdb_sgt_flags | PDB_DL_KEY_L_SIZE ( caam_dh_key . y . length ) | PDB_DL_KEY_N_SIZE ( caam_dh_key . x . length ) ) ; caam_desc_add_ptr ( desc , caam_dh_key . p . paddr ) ; caam_desc_add_ptr ( desc , 0 ) ; caam_desc_add_ptr ( desc , caam_dh_key . y . paddr ) ; caam_desc_add_ptr ( desc , caam_dh_key . x . paddr ) ; caam_desc_add_ptr ( desc , secret . sgtbuf . paddr ) ; caam_desc_add_word ( desc , SHARED_SECRET ( DL ) ) ; desclen = caam_desc_get_len ( desc ) ; caam_desc_update_hdr ( desc , DESC_HEADER_IDX ( desclen , desclen - 1 ) ) ; DH_DUMPDESC ( desc ) ; jobctx . desc = desc ; retstatus = caam_jr_enqueue ( & jobctx , NULL ) ; if ( retstatus == CAAM_NO_ERROR ) { sdata -> secret . length = caam_dmaobj_copy_to_orig ( & secret ) ; DH_DUMPBUF ( "Secret" , sdata -> secret . data , sdata -> secret . length ) ; ret = caam_status_to_tee_result ( retstatus ) ; } else { DH_TRACE ( "CAAM Status 0x%08" PRIx32 , jobctx . status ) ; ret = job_status_to_tee_result ( jobctx . status ) ; } out caam_free_desc ( & desc ) ; do_keypair_free ( & caam_dh_key ) ; caam_dmaobj_free ( & secret ) ; return ret ; } 