void irc_free ( irc_t * irc ) { GSList * l ; GHashTableIter iter ; gpointer itervalue ; irc -> status |= USTATUS_SHUTDOWN ; log_message ( LOGLVL_INFO , "Destroying connection with fd %d" , irc -> fd ) ; if ( irc -> status & USTATUS_IDENTIFIED && set_getbool ( & irc -> b -> set , "save_on_quit" ) ) { if ( storage_save ( irc , NULL , TRUE ) != STORAGE_OK ) { log_message ( LOGLVL_WARNING , "Error while saving settings for user %s" , irc -> user -> nick ) ; } } for ( l = irc_plugins ; l ; l = l -> next ) { irc_plugin_t * p = l -> data ; if ( p -> irc_free ) { p -> irc_free ( irc ) ; } } irc_connection_list = g_slist_remove ( irc_connection_list , irc ) ; while ( irc -> queries != NULL ) { query_del ( irc , irc -> queries ) ; } bee_free ( irc -> b ) ; g_hash_table_iter_init ( & iter , irc -> nick_user_hash ) ; while ( g_hash_table_iter_next ( & iter , NULL , & itervalue ) ) { g_hash_table_iter_remove ( & iter ) ; irc_user_free ( irc , ( irc_user_t * ) itervalue ) ; } while ( irc -> channels ) { irc_channel_free ( irc -> channels -> data ) ; } if ( irc -> ping_source_id > 0 ) { b_event_remove ( irc -> ping_source_id ) ; } if ( irc -> r_watch_source_id > 0 ) { b_event_remove ( irc -> r_watch_source_id ) ; } if ( irc -> w_watch_source_id > 0 ) { b_event_remove ( irc -> w_watch_source_id ) ; } closesocket ( irc -> fd ) ; irc -> fd = - 1 ; g_hash_table_destroy ( irc -> nick_user_hash ) ; g_hash_table_foreach_remove ( irc -> watches , irc_free_hashkey , NULL ) ; g_hash_table_destroy ( irc -> watches ) ; if ( irc -> iconv != ( GIConv ) - 1 ) { g_iconv_close ( irc -> iconv ) ; } if ( irc -> oconv != ( GIConv ) - 1 ) { g_iconv_close ( irc -> oconv ) ; } g_string_free ( irc -> sendbuffer , TRUE ) ; g_free ( irc -> readbuffer ) ; g_free ( irc ) ; if ( global . conf -> runmode == RUNMODE_INETD || global . conf -> runmode == RUNMODE_FORKDAEMON || ( global . conf -> runmode == RUNMODE_DAEMON && global . listen_socket == - 1 && irc_connection_list == NULL ) ) { b_main_quit ( ) ; } } 