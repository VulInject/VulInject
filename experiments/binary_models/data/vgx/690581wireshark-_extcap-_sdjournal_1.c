int main ( int argc , char * * argv ) { char * configuration_init_error ; int result ; int option_idx = 0 ; int start_from_entries = 10 ; gboolean start_from_end = TRUE ; int ret = EXIT_FAILURE ; extcap_parameters * extcap_conf = g_new0 ( extcap_parameters , 1 ) ; char * help_url ; char * help_header = NULL ; extcap_log_init ( "sdjournal" ) ; init_process_policies ( ) ; configuration_init_error = configuration_init ( argv [ 0 ] , NULL ) ; if ( configuration_init_error != NULL ) { ws_warning ( "Can't get pathname of directory containing the extcap program: %s." , configuration_init_error ) ; } help_url = data_file_url ( "sdjournal.html" ) ; extcap_base_set_util_info ( extcap_conf , argv [ 0 ] , SDJOURNAL_VERSION_MAJOR , SDJOURNAL_VERSION_MINOR , SDJOURNAL_VERSION_RELEASE , help_url ) ; g_free ( help_url ) ; extcap_base_register_interface ( extcap_conf , SDJOURNAL_EXTCAP_INTERFACE , "systemd Journal Export" , 147 , "USER0" ) ; help_header = ws_strdup_printf ( " %s --extcap-interfaces\n" " %s --extcap-interface=%s --extcap-dlts\n" " %s --extcap-interface=%s --extcap-config\n" " %s --extcap-interface=%s --start-from=+0 --fifo=FILENAME --capture\n" , argv [ 0 ] , argv [ 0 ] , SDJOURNAL_EXTCAP_INTERFACE , argv [ 0 ] , SDJOURNAL_EXTCAP_INTERFACE , argv [ 0 ] , SDJOURNAL_EXTCAP_INTERFACE ) ; extcap_help_add_header ( extcap_conf , help_header ) ; g_free ( help_header ) ; extcap_help_add_option ( extcap_conf , "--help" , "print this help" ) ; extcap_help_add_option ( extcap_conf , "--version" , "print the version" ) ; extcap_help_add_option ( extcap_conf , "--start-from<entry count>" , "starting position" ) ; ws_opterr = 0 ; ws_optind = 0 ; if ( argc == 1 ) { extcap_help_print ( extcap_conf ) ; end } while ( ( result = ws_getopt_long ( argc , argv , ":" , longopts , & option_idx ) ) != - 1 ) { switch ( result ) { case OPT_HELP : extcap_help_print ( extcap_conf ) ; ret = EXIT_SUCCESS ; end case OPT_VERSION : extcap_version_print ( extcap_conf ) ; ret = EXIT_SUCCESS ; end case OPT_START_FROM : start_from_entries = ( int ) strtol ( ws_optarg , NULL , 10 ) ; if ( errno == EINVAL ) { ws_warning ( "Invalid entry count: %s" , ws_optarg ) ; end } if ( strlen ( ws_optarg ) > 0 && ws_optarg [ 0 ] == '+' ) { start_from_end = FALSE ; } if ( start_from_entries < 0 ) { start_from_end = TRUE ; start_from_entries *= - 1 ; } ws_debug ( "start %d from %s" , start_from_entries , start_from_end ?"end" : "beginning" ) ; break ; case ':' : ws_warning ( "Option '%s' requires an argument" , argv [ ws_optind - 1 ] ) ; break ; default : if ( ! extcap_base_parse_options ( extcap_conf , result - EXTCAP_OPT_LIST_INTERFACES , ws_optarg ) ) { ws_warning ( "Invalid option: %s" , argv [ ws_optind - 1 ] ) ; end } } } extcap_cmdline_debug ( argv , argc ) ; if ( extcap_base_handle_interface ( extcap_conf ) ) { ret = EXIT_SUCCESS ; end } if ( extcap_conf -> show_config ) { ret = list_config ( extcap_conf -> interface ) ; end } if ( extcap_conf -> capture ) { ret = sdj_start_export ( start_from_entries , start_from_end , extcap_conf -> fifo ) ; } else { ws_debug ( "You should not come here... maybe some parameter missing?" ) ; ret = EXIT_FAILURE ; } end extcap_base_cleanup ( & extcap_conf ) ; return ret ; } 