BOOL xf_create_window ( xfContext * xfc ) { XGCValues gcv = { 0 } ; XEvent xevent = { 0 } ; int width , height ; char * windowTitle ; rdpSettings * settings ; WINPR_ASSERT ( xfc ) ; settings = xfc -> common . context . settings ; WINPR_ASSERT ( settings ) ; width = settings -> DesktopWidth ; height = settings -> DesktopHeight ; const XSetWindowAttributes empty = { 0 } ; xfc -> attribs = empty ; if ( xfc -> remote_app ) { xfc -> depth = 32 ; } else { xfc -> depth = DefaultDepthOfScreen ( xfc -> screen ) ; } XVisualInfo vinfo = { 0 } ; if ( XMatchVisualInfo ( xfc -> display , xfc -> screen_number , xfc -> depth , TrueColor , & vinfo ) ) { Window root = XDefaultRootWindow ( xfc -> display ) ; xfc -> visual = vinfo . visual ; xfc -> attribs . colormap = xfc -> colormap = XCreateColormap ( xfc -> display , root , vinfo . visual , AllocNone ) ; } else { if ( xfc -> remote_app ) { WLog_WARN ( TAG , "running in remote app mode, but XServer does not support transparency" ) ; WLog_WARN ( TAG , "display of remote applications might be distorted (black frames, ...)" ) ; } xfc -> depth = DefaultDepthOfScreen ( xfc -> screen ) ; xfc -> visual = DefaultVisual ( xfc -> display , xfc -> screen_number ) ; xfc -> attribs . colormap = xfc -> colormap = DefaultColormap ( xfc -> display , xfc -> screen_number ) ; } if ( vinfo . red_mask & 0xFF ) { xfc -> invert = FALSE ; } if ( ! xfc -> hdc ) { if ( ! ( xfc -> hdc = gdi_CreateDC ( xf_get_local_color_format ( xfc , TRUE ) ) ) ) { return FALSE ; } } if ( ! xfc -> remote_app ) { xfc -> attribs . background_pixel = BlackPixelOfScreen ( xfc -> screen ) ; xfc -> attribs . border_pixel = WhitePixelOfScreen ( xfc -> screen ) ; xfc -> attribs . backing_store = xfc -> primary ?NotUseful : Always ; xfc -> attribs . override_redirect = False ; xfc -> attribs . bit_gravity = NorthWestGravity ; xfc -> attribs . win_gravity = NorthWestGravity ; xfc -> attribs_mask = CWBackPixel | CWBackingStore | CWOverrideRedirect | CWColormap | CWBorderPixel | CWWinGravity | CWBitGravity ; xfc -> offset_x = 0 ; xfc -> offset_y = 0 ; windowTitle = xf_window_get_title ( settings , NULL ) ; if ( ! windowTitle ) { return FALSE ; } if ( settings -> SmartSizing && ! xfc -> fullscreen ) { if ( settings -> SmartSizingWidth ) { width = settings -> SmartSizingWidth ; } if ( settings -> SmartSizingHeight ) { height = settings -> SmartSizingHeight ; } xfc -> scaledWidth = width ; xfc -> scaledHeight = height ; } xfc -> window = xf_CreateDesktopWindow ( xfc , windowTitle , width , height ) ; free ( windowTitle ) ; if ( xfc -> fullscreen ) { xf_SetWindowFullscreen ( xfc , xfc -> window , xfc -> fullscreen ) ; } xfc -> unobscured = ( xevent . xvisibility . state == VisibilityUnobscured ) ; XSetWMProtocols ( xfc -> display , xfc -> window -> handle , & ( xfc -> WM_DELETE_WINDOW ) , 1 ) ; xfc -> drawable = xfc -> window -> handle ; } else { xfc -> attribs . border_pixel = 0 ; xfc -> attribs . background_pixel = 0 ; xfc -> attribs . backing_store = xfc -> primary ?NotUseful : Always ; xfc -> attribs . override_redirect = False ; xfc -> attribs . bit_gravity = NorthWestGravity ; xfc -> attribs . win_gravity = NorthWestGravity ; xfc -> attribs_mask = CWBackPixel | CWBackingStore | CWOverrideRedirect | CWColormap | CWBorderPixel | CWWinGravity | CWBitGravity ; xfc -> drawable = xf_CreateDummyWindow ( xfc ) ; } if ( ! xfc -> gc ) { xfc -> gc = XCreateGC ( xfc -> display , xfc -> drawable , GCGraphicsExposures , & gcv ) ; } WINPR_ASSERT ( xfc -> depth != 0 ) ; if ( ! xfc -> primary ) { xfc -> primary = XCreatePixmap ( xfc -> display , xfc -> drawable , settings -> DesktopWidth , settings -> DesktopHeight , xfc -> depth ) ; } xfc -> drawing = xfc -> primary ; if ( ! xfc -> bitmap_mono ) { xfc -> bitmap_mono = XCreatePixmap ( xfc -> display , xfc -> drawable , 8 , 8 , 1 ) ; } if ( ! xfc -> gc_mono ) { xfc -> gc_mono = XCreateGC ( xfc -> display , xfc -> bitmap_mono , GCGraphicsExposures , & gcv ) ; } XSetFunction ( xfc -> display , xfc -> gc , GXcopy ) ; XSetFillStyle ( xfc -> display , xfc -> gc , FillSolid ) ; XSetForeground ( xfc -> display , xfc -> gc , BlackPixelOfScreen ( xfc -> screen ) ) ; XFillRectangle ( xfc -> display , xfc -> primary , xfc -> gc , 0 , 0 , settings -> DesktopWidth , settings -> DesktopHeight ) ; XFlush ( xfc -> display ) ; return TRUE ; } 