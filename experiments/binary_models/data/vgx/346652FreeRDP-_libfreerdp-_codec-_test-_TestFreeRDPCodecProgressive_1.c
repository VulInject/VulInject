static BOOL test_encode_decode ( const char * path ) { BOOL res = FALSE ; int rc ; BYTE * resultData = NULL ; BYTE * dstData = NULL ; int dstSize = 0 ; UINT32 ColorFormat = PIXEL_FORMAT_BGRX32 ; REGION16 invalidRegion = { 0 } ; wImage * image = winpr_image_new ( ) ; wImage * dstImage = winpr_image_new ( ) ; char * name = GetCombinedPath ( path , "progressive.bmp" ) ; PROGRESSIVE_CONTEXT * progressiveEnc = progressive_context_new ( TRUE ) ; PROGRESSIVE_CONTEXT * progressiveDec = progressive_context_new ( FALSE ) ; region16_init ( & invalidRegion ) ; if ( ! image || ! dstImage || ! name || ! progressiveEnc || ! progressiveDec ) { fail } rc = winpr_image_read ( image , name ) ; if ( rc <= 0 ) { fail } resultData = calloc ( image -> scanline , image -> height ) ; if ( ! resultData ) { fail } rc = progressive_compress ( progressiveEnc , image -> data , image -> scanline * image -> height , ColorFormat , image -> width , image -> height , image -> scanline , NULL , & dstData , & dstSize ) ; rc = progressive_create_surface_context ( progressiveDec , 0 , image -> width , image -> height ) ; if ( rc <= 0 ) { fail } rc = progressive_decompress ( progressiveDec , dstData , dstSize , resultData , ColorFormat , image -> scanline , 0 , 0 , & invalidRegion , 0 , 0 ) ; if ( rc < 0 ) { fail } if ( 0 ) { * dstImage = * image ; dstImage -> data = resultData ; winpr_image_write ( dstImage , "/tmp/test.bmp" ) ; } for ( UINT32 y = 0 ; y < image -> height ; y ++ ) { const BYTE * orig = & image -> data [ y * image -> scanline ] ; const BYTE * dec = & resultData [ y * image -> scanline ] ; for ( UINT32 x = 0 ; x < image -> width ; x ++ ) { const BYTE * po = & orig [ x * 4 ] ; const BYTE * pd = & dec [ x * 4 ] ; const DWORD a = FreeRDPReadColor ( po , ColorFormat ) ; const DWORD b = FreeRDPReadColor ( pd , ColorFormat ) ; if ( ! colordiff ( ColorFormat , a , b ) ) { printf ( "xxxxxxx [%u:%u] %08X != %08X\n" , x , y , a , b ) ; fail } } } res = TRUE ; fail region16_uninit ( & invalidRegion ) ; progressive_context_free ( progressiveEnc ) ; progressive_context_free ( progressiveDec ) ; winpr_image_free ( image , TRUE ) ; winpr_image_free ( dstImage , FALSE ) ; free ( resultData ) ; free ( name ) ; return res ; } 