long st_kim_start ( void * kim_data ) { long err = 0 ; long retry = POR_RETRY_COUNT ; struct ti_st_plat_data * pdata ; struct kim_data_s * kim_gdata = ( kim_data_s * ) kim_data ; pr_info ( " %s" , __func__ ) ; pdata = kim_gdata -> kim_pdev -> dev . platform_data ; { if ( pdata -> chip_enable ) { pdata -> chip_enable ( kim_gdata ) ; } gpio_set_value_cansleep ( kim_gdata -> nshutdown , GPIO_LOW ) ; mdelay ( 5 ) ; gpio_set_value_cansleep ( kim_gdata -> nshutdown , GPIO_HIGH ) ; mdelay ( 100 ) ; reinit_completion ( & kim_gdata -> ldisc_installed ) ; kim_gdata -> ldisc_install = 1 ; pr_info ( "ldisc_install = 1" ) ; sysfs_notify ( & kim_gdata -> kim_pdev -> dev . kobj , NULL , "install" ) ; err = wait_for_completion_interruptible_timeout ( & kim_gdata -> ldisc_installed , msecs_to_jiffies ( LDISC_TIME ) ) ; if ( ! err ) { pr_err ( "ldisc installation timeout" ) ; err = st_kim_stop ( kim_gdata , NULL ) ; continue ; } else { pr_info ( "line discipline installed" ) ; err = download_firmware ( kim_gdata ) ; if ( err != 0 ) { pr_err ( "download firmware failed" ) ; err = st_kim_stop ( kim_gdata ) ; continue ; } else { break ; } } } retry -- ; return err ; } 