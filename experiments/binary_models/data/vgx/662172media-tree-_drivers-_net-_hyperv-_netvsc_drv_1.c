static int netvsc_set_channels ( struct net_device * net , struct ethtool_channels * channels ) { struct net_device_context * net_device_ctx = netdev_priv ( net ) ; struct hv_device * dev = net_device_ctx -> device_ctx ; struct netvsc_device * nvdev = rtnl_dereference ( net_device_ctx -> nvdev ) ; unsigned int count = channels -> combined_count ; bool was_running ; int ret ; if ( count == 0 || channels -> rx_count || channels -> tx_count || channels -> other_count ) { return - EINVAL ; } if ( count > net -> num_tx_queues || count > net -> num_rx_queues ) { return - EINVAL ; } if ( nvdev -> nvsp_version < NVSP_PROTOCOL_VERSION_5 ) { return - EINVAL ; } if ( count > nvdev -> max_chn ) { return - EINVAL ; } was_running = netif_running ( net ) ; if ( was_running ) { ret = netvsc_close ( net ) ; if ( ret ) { return ret ; } } rndis_filter_device_remove ( dev , nvdev ) ; ret = netvsc_set_queues ( net , dev , count ) ; if ( ret == 0 ) { nvdev -> num_chn = count ; } else { netvsc_set_queues ( net , dev , nvdev -> num_chn ) ; } if ( was_running ) { ret = netvsc_open ( net ) ; } schedule_delayed_work ( & net_device_ctx -> dwork , 0 ) ; return ret ; } 