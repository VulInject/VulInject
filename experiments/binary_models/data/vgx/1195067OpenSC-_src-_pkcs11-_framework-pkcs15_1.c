static CK_RV pkcs15_prkey_derive ( struct sc_pkcs11_session * session , void * obj , CK_MECHANISM_PTR pMechanism , CK_BYTE_PTR pParameters , CK_ULONG ulParametersLen , CK_BYTE_PTR pData , CK_ULONG_PTR pulDataLen ) { struct sc_pkcs11_card * p11card = session -> slot -> p11card ; struct pkcs15_fw_data * fw_data = NULL ; struct pkcs15_prkey_object * prkey = ( pkcs15_prkey_object * ) obj ; int need_unlock = 0 , prkey_has_path = 0 ; int rv , flags = 0 ; CK_BYTE_PTR pSeedData = NULL ; CK_ULONG ulSeedDataLen = 0 ; sc_log ( context , "Initiating derivation" ) ; fw_data = ( pkcs15_fw_data * ) p11card -> fws_data [ session -> slot -> fw_data_idx ] ; if ( ! fw_data ) { return sc_to_cryptoki_error ( SC_ERROR_INTERNAL , "C_DeriveKey" ) ; } if ( ! fw_data -> p15_card ) { return sc_to_cryptoki_error ( SC_ERROR_INVALID_CARD , "C_DeriveKey" ) ; } while ( prkey && ! ( prkey -> prv_info -> usage & SC_PKCS15_PRKEY_USAGE_DERIVE ) ) { prkey = prkey -> prv_next ; } if ( prkey == NULL ) { return CKR_KEY_FUNCTION_NOT_PERMITTED ; } if ( prkey -> prv_info -> path . len || prkey -> prv_info -> path . aid . len ) { prkey_has_path = 1 ; } if ( pData != NULL && * pulDataLen > 0 ) { need_unlock = 1 ; rv = sc_lock ( p11card -> card ) ; if ( rv < 0 ) { return sc_to_cryptoki_error ( rv , "C_DeriveKey" ) ; } } switch ( prkey -> base . p15_object -> type ) { case SC_PKCS15_TYPE_PRKEY_EC : case SC_PKCS15_TYPE_PRKEY_XEDDSA : { CK_ECDH1_DERIVE_PARAMS * ecdh_params = ( CK_ECDH1_DERIVE_PARAMS * ) pParameters ; ulSeedDataLen = ecdh_params -> ulPublicDataLen ; pSeedData = ecdh_params -> pPublicData ; flags = SC_ALGORITHM_ECDH_CDH_RAW ; } break ; } size_t len = * pulDataLen ; rv = sc_pkcs15_derive ( fw_data -> p15_card , prkey -> prv_p15obj , flags , pSeedData , ulSeedDataLen , pData , & len ) ; if ( rv < 0 && ! sc_pkcs11_conf . lock_login && ! prkey_has_path && need_unlock ) { if ( reselect_app_df ( fw_data -> p15_card ) == SC_SUCCESS ) { rv = sc_pkcs15_derive ( fw_data -> p15_card , prkey -> prv_p15obj , flags , pSeedData , ulSeedDataLen , pData , & len ) ; } } * pulDataLen = len ; if ( need_unlock ) { sc_unlock ( p11card -> card ) ; } sc_log ( context , "Derivation complete. Result %d." , rv ) ; if ( rv < 0 ) { return sc_to_cryptoki_error ( rv , "C_DeriveKey" ) ; } return CKR_OK ; } 