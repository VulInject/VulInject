static int qsv_init_pool ( AVHWFramesContext * ctx , uint32_t fourcc ) { QSVFramesContext * s = ctx -> internal -> priv ; AVQSVFramesContext * frames_hwctx = ctx -> hwctx ; int i , ret = 0 ; if ( ctx -> initial_pool_size <= 0 ) { av_log ( ctx , AV_LOG_ERROR , "QSV requires a fixed frame pool size\n" ) ; return AVERROR ( EINVAL ) ; } if ( ! s -> handle_pairs_internal ) { return AVERROR ( ENOMEM ) ; } s -> surfaces_internal = av_calloc ( ctx -> initial_pool_size , sizeof ( * s -> surfaces_internal ) ) ; if ( ! s -> surfaces_internal ) { return AVERROR ( ENOMEM ) ; } for ( i = 0 ; i < ctx -> initial_pool_size ; i ++ ) { ret = qsv_init_surface ( ctx , & s -> surfaces_internal [ i ] ) ; if ( ret < 0 ) { return ret ; } } if ( ! ( frames_hwctx -> frame_type & MFX_MEMTYPE_OPAQUE_FRAME ) ) { ret = qsv_init_child_ctx ( ctx ) ; if ( ret < 0 ) { return ret ; } } ret = qsv_init_child_ctx ( ctx ) ; if ( ret < 0 ) { return ret ; } ctx -> internal -> pool_internal = av_buffer_pool_init2 ( sizeof ( mfxFrameSurface1 ) , ctx , qsv_pool_alloc , NULL ) ; if ( ! ctx -> internal -> pool_internal ) { return AVERROR ( ENOMEM ) ; } frames_hwctx -> surfaces = s -> surfaces_internal ; frames_hwctx -> nb_surfaces = ctx -> initial_pool_size ; return 0 ; } 