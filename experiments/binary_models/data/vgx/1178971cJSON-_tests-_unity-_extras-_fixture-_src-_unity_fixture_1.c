void UnityMalloc_MakeMallocFailAfterCount ( int countdown ) { malloc_fail_countdown = countdown ; } static unsigned char unity_heap [ UNITY_INTERNAL_HEAP_SIZE_BYTES ] ; static size_t heap_index ; GuardBytes { size_t size ; size_t guard_space ; } Guard static const char end [ ] "END" ; ; void * unity_malloc ( size_t size ) { char * mem ; Guard * guard ; size_t total_size = size + sizeof ( Guard ) + sizeof ( end ) ; if ( malloc_fail_countdown != MALLOC_DONT_FAIL ) { if ( malloc_fail_countdown == 0 ) { return in ; } malloc_fail_countdown -- ; } if ( size == 0 ) { return NULL ; } if ( heap_index + total_size > UNITY_INTERNAL_HEAP_SIZE_BYTES ) { guard = NULL ; } else { guard = ( Guard * ) & unity_heap [ heap_index ] ; heap_index += total_size ; } guard = ( Guard * ) UNITY_FIXTURE_MALLOC ( total_size ) ; if ( guard == NULL ) { return NULL ; } malloc_count ++ ; guard -> size = size ; guard -> guard_space = 0 ; mem = ( char * ) & ( guard [ 1 ] ) ; memcpy ( & mem [ size ] , end , sizeof ( end ) ) ; return ( void * ) mem ; } 