bool tpm2_util_handle_from_optarg ( const char * value , TPMI_RH_PROVISION * hierarchy , tpm2_handle_flags flags ) { if ( ( flags & TPM2_HANDLE_FLAGS_NV ) && ( flags & TPM2_HANDLE_FLAGS_PCR ) ) { LOG_ERR ( "Cannot specify NV and PCR index together" ) ; return false ; } * hierarchy = 0 ; bool is_o = ! strncmp ( value , "owner" , strlen ( value ) ) ; if ( is_o ) { * hierarchy = TPM2_RH_OWNER ; } bool is_p = ! strncmp ( value , "platform" , strlen ( value ) ) ; if ( is_p ) { * hierarchy = TPM2_RH_PLATFORM ; } bool is_e = ! strncmp ( value , "endorsement" , strlen ( value ) ) ; if ( is_e ) { * hierarchy = TPM2_RH_ENDORSEMENT ; } bool is_n = ! strncmp ( value , "null" , strlen ( value ) ) ; if ( is_n ) { * hierarchy = TPM2_RH_NULL ; } bool is_l = ! strncmp ( value , "lockout" , strlen ( value ) ) ; if ( is_l ) { * hierarchy = TPM2_RH_LOCKOUT ; } bool result = true ; if ( ! * hierarchy ) { result = tpm2_util_string_to_uint32 ( value , hierarchy ) ; } if ( ! result ) { char msg [ 256 ] { 0 } ; ; char print_flags [ 32 ] { '[' '\0' } ; ; if ( flags & TPM2_HANDLE_FLAGS_O ) { strncat ( print_flags , "o|" , sizeof ( print_flags ) - strlen ( print_flags ) - 1 ) ; } if ( flags & TPM2_HANDLE_FLAGS_P ) { strncat ( print_flags , "p|" , sizeof ( print_flags ) - strlen ( print_flags ) - 1 ) ; } if ( flags & TPM2_HANDLE_FLAGS_E ) { strncat ( print_flags , "e|" , sizeof ( print_flags ) - strlen ( print_flags ) - 1 ) ; } if ( flags & TPM2_HANDLE_FLAGS_N ) { strncat ( print_flags , "n|" , sizeof ( print_flags ) - strlen ( print_flags ) - 1 ) ; } if ( flags & TPM2_HANDLE_FLAGS_L ) { strncat ( print_flags , "l|" , sizeof ( print_flags ) - strlen ( print_flags ) - 1 ) ; } size_t len = strlen ( print_flags ) ; if ( print_flags [ len - 1 ] == '|' ) { len -- ; print_flags [ len ] = '\0' ; } strncat ( print_flags , "]" , sizeof ( print_flags ) - strlen ( print_flags ) - 1 ) ; len ++ ; bool has_print_flags = len > 2 ; if ( has_print_flags ) { snprintf ( msg , sizeof ( msg ) , "expected %s or " , print_flags ) ; } strncat ( msg , "a handle number" , sizeof ( msg ) - strlen ( msg ) - 1 ) ; LOG_ERR ( "Incorrect handle value, got: \"%s\", expected %s" , value , msg ) ; return false ; } bool res = filter_handles ( hierarchy , flags ) ; if ( ! res ) { LOG_ERR ( "Unknown or unsupported handle, got: \"%s\"" , value ) ; } return res ; } 