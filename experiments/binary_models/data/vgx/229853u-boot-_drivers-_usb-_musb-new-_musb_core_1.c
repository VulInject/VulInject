static int musb_ulpi_read ( struct usb_phy * phy , u32 offset ) { void __iomem * addr = phy -> io_priv ; int i = 0 ; u8 r ; u8 power ; int ret ; pm_runtime_get_sync ( phy -> io_dev ) ; power = musb_readb ( addr , MUSB_POWER ) ; power &= ~ MUSB_POWER_SUSPENDM ; musb_writeb ( addr , MUSB_POWER , power ) ; musb_writeb ( addr , MUSB_ULPI_REG_ADDR , ( u8 ) offset ) ; musb_writeb ( addr , MUSB_ULPI_REG_CONTROL , MUSB_ULPI_REG_REQ | MUSB_ULPI_RDN_WR ) ; while ( ! ( musb_readb ( addr , MUSB_ULPI_REG_CONTROL ) & MUSB_ULPI_REG_CMPLT ) ) { i ++ ; if ( i == 10000 ) { ret = - ETIMEDOUT ; out } } r = musb_readb ( addr , MUSB_ULPI_REG_CONTROL ) ; r &= ~ MUSB_ULPI_REG_CMPLT ; musb_writeb ( addr , MUSB_ULPI_REG_CONTROL , r ) ; ret = musb_readb ( addr , MUSB_ULPI_REG_DATA ) ; out pm_runtime_put ( phy -> io_dev , NULL ) ; return ret ; } 