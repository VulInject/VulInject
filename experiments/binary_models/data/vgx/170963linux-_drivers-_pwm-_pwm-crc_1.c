static int crc_pwm_apply ( struct pwm_chip * chip , struct pwm_device * pwm , const struct pwm_state * state ) { struct crystalcove_pwm * crc_pwm = to_crc_pwm ( chip ) ; struct device * dev = crc_pwm -> chip . dev ; int err ; if ( state -> period > PWM_MAX_PERIOD_NS ) { dev_err ( dev , "un-supported period_ns\n" ) ; return - EINVAL ; } if ( pwm_is_enabled ( pwm ) && ! state -> enabled ) { err = regmap_write ( crc_pwm -> regmap , BACKLIGHT_EN , 0 ) ; if ( err ) { dev_err ( dev , "Error writing BACKLIGHT_EN %d\n" , err ) ; return err ; } } if ( pwm_get_duty_cycle ( pwm ) != state -> duty_cycle || pwm_get_period ( pwm ) != state -> period ) { u64 level = state -> duty_cycle * PWM_MAX_LEVEL ; do_div ( level , state -> period ) ; err = regmap_write ( crc_pwm -> regmap , PWM0_DUTY_CYCLE , level ) ; if ( err ) { dev_err ( dev , "Error writing PWM0_DUTY_CYCLE %d\n" , err ) ; return err ; } } if ( pwm_is_enabled ( pwm ) && state -> enabled && pwm_get_period ( pwm ) != state -> period ) { err = regmap_write ( crc_pwm -> regmap , PWM0_CLK_DIV , 0 ) ; if ( err ) { dev_err ( dev , "Error writing PWM0_CLK_DIV %d\n" , err ) ; return err ; } } if ( pwm_get_period ( pwm ) != state -> period || pwm_is_enabled ( pwm ) != state -> enabled ) { int clk_div = crc_pwm_calc_clk_div ( state -> period ) ; int pwm_output_enable = state -> enabled ?PWM_OUTPUT_ENABLE : 0 ; err = regmap_write ( crc_pwm -> regmap , PWM0_CLK_DIV , clk_div | pwm_output_enable ) ; if ( err ) { dev_err ( dev , "Error writing PWM0_CLK_DIV %d\n" , err ) ; return err ; } } if ( ! pwm_is_enabled ( pwm ) && state -> enabled ) { err = regmap_write ( crc_pwm -> regmap , BACKLIGHT_EN , 1 ) ; if ( err ) { dev_err ( dev , "Error writing BACKLIGHT_EN %d\n" , err ) ; return err ; } } return 0 ; } 