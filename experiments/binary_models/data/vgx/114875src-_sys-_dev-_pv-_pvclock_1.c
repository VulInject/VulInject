uint pvclock_get_timecount ( struct timecounter * tc ) { struct pvclock_softc * sc = tc -> tc_priv ; struct pvclock_time_info * ti ; uint64_t tsc_timestamp , system_time , delta , ctr ; uint32_t version , mul_frac ; int8_t shift ; uint8_t flags ; ti = sc -> sc_time ; { version = pvclock_read_begin ( ti ) ; system_time = ti -> ti_system_time ; tsc_timestamp = ti -> ti_tsc_timestamp ; mul_frac = ti -> ti_tsc_to_system_mul ; shift = ti -> ti_tsc_shift ; flags = ti -> ti_flags ; } ! pvclock_read_done ( ti , version ) ; delta = rdtsc ( ) - tsc_timestamp ; if ( shift < 0 ) { delta >>= - shift ; } else { delta <<= shift ; } ctr = ( ( delta * mul_frac ) >> 32 ) + system_time ; if ( ( flags & PVCLOCK_FLAG_TSC_STABLE ) != 0 ) { return ( ctr ) ; } atomic_swap_uint ( & pvclock_lastcount , ctr ) ; return ( ctr ) ; } 