static int _run_report ( int type , int argc , char * * argv ) { int rc = SLURM_SUCCESS ; slurmdb_job_cond_t * job_cond = xmalloc ( sizeof ( slurmdb_job_cond_t ) ) ; uint32_t tres_id = TRES_CPU ; int i = 0 , tres_cnt = 0 ; slurmdb_tres_rec_t * tres ; uint64_t count1 , count2 ; ListIterator itr = NULL ; ListIterator itr2 = NULL ; ListIterator cluster_itr = NULL ; ListIterator local_itr = NULL ; ListIterator acct_itr = NULL ; slurmdb_report_cluster_grouping_t * cluster_group = NULL ; slurmdb_report_acct_grouping_t * acct_group = NULL ; slurmdb_report_job_grouping_t * job_group = NULL ; print_field_t * field = NULL ; print_field_t total_field ; slurmdb_report_time_format_t temp_format ; List slurmdb_report_cluster_grouping_list = NULL ; List assoc_list = NULL ; List format_list = list_create ( xfree_ptr ) ; List grouping_list = list_create ( xfree_ptr ) ; List header_list = NULL ; char * object_str = "" , * tmp_char ; print_fields_list = list_create ( destroy_print_field ) ; _set_cond ( & i , argc , argv , job_cond , format_list , grouping_list ) ; if ( ! individual_grouping && ! list_count ( grouping_list ) ) { slurm_addto_char_list ( grouping_list , "50,250,500,1000" ) ; } switch ( type ) { case GROUPED_ACCT : if ( ! ( slurmdb_report_cluster_grouping_list = slurmdb_report_job_sizes_grouped_by_account ( db_conn , job_cond , grouping_list , flat_view , acct_as_parent ) ) ) { exit_code = 1 ; end_it } if ( ! list_count ( format_list ) ) { slurm_addto_char_list ( format_list , "Cl,a" ) ; } break ; case GROUPED_WCKEY : if ( ! ( slurmdb_report_cluster_grouping_list = slurmdb_report_job_sizes_grouped_by_wckey ( db_conn , job_cond , grouping_list ) ) ) { exit_code = 1 ; end_it } if ( ! list_count ( format_list ) ) { slurm_addto_char_list ( format_list , "Cl,wc" ) ; } object_str = "by Wckey " ; break ; case GROUPED_ACCT_AND_WCKEY : if ( ! ( slurmdb_report_cluster_grouping_list = slurmdb_report_job_sizes_grouped_by_account_then_wckey ( db_conn , job_cond , grouping_list , flat_view , acct_as_parent ) ) ) { exit_code = 1 ; end_it } if ( ! list_count ( format_list ) ) { slurm_addto_char_list ( format_list , "Cl,a%-20" ) ; } break ; default : exit_code = 1 ; end_it break ; } if ( fed_name ) { _merge_cluster_groups ( slurmdb_report_cluster_grouping_list ) ; } itr2 = list_iterator_create ( tres_list ) ; while ( ( tres = list_next ( itr2 ) ) ) { if ( tres -> id == NO_VAL ) { continue ; } tres_id = tres -> id ; tres_cnt ++ ; } list_iterator_destroy ( itr2 ) ; if ( tres_cnt > 1 ) { fprintf ( stderr , " Job report only supports a single --tres type.\n" " Generate a separate report for each TRES type.\n" ) ; exit_code = 1 ; end_it } _setup_print_fields_list ( format_list ) ; FREE_NULL_LIST ( format_list ) ; if ( _setup_grouping_print_fields_list ( grouping_list ) != SLURM_SUCCESS ) { end_it } if ( print_fields_have_header ) { char start_char [ 256 ] ; char end_char [ 256 ] ; time_t my_start = job_cond -> usage_start ; time_t my_end = job_cond -> usage_end - 1 ; slurm_make_time_str ( & my_start , start_char , sizeof ( start_char ) ) ; slurm_make_time_str ( & my_end , end_char , sizeof ( end_char ) ) ; printf ( "----------------------------------------" "----------------------------------------\n" ) ; printf ( "Job Sizes %s%s - %s (%d secs)\n" , object_str , start_char , end_char , ( int ) ( job_cond -> usage_end - job_cond -> usage_start ) ) ; if ( tres_str ) { printf ( "TRES type is %s\n" , tres_str ) ; } if ( print_job_count ) { printf ( "Units are in number of jobs ran\n" ) ; } else { printf ( "Time reported in %s\n" , time_format_string ) ; } printf ( "----------------------------------------" "----------------------------------------\n" ) ; } header_list = list_create ( NULL ) ; list_append_list ( header_list , print_fields_list ) ; list_append_list ( header_list , grouping_print_fields_list ) ; total_field . type = PRINT_JOB_SIZE ; total_field . name = xstrdup ( "% of cluster" ) ; total_field . len = 12 ; total_field . print_routine = print_fields_str ; list_append ( header_list , & total_field ) ; print_fields_header ( header_list ) ; FREE_NULL_LIST ( header_list ) ; itr = list_iterator_create ( print_fields_list ) ; itr2 = list_iterator_create ( grouping_print_fields_list ) ; list_sort ( slurmdb_report_cluster_grouping_list , ( ListCmpF ) _sort_cluster_grouping_dec ) ; cluster_itr = list_iterator_create ( slurmdb_report_cluster_grouping_list ) ; while ( ( cluster_group = list_next ( cluster_itr ) ) ) { slurmdb_tres_rec_t * tres_rec ; uint64_t cluster_tres_alloc_secs = 0 ; if ( cluster_group -> tres_list && ( tres_rec = list_find_first ( cluster_group -> tres_list , slurmdb_find_tres_in_list , & tres_id ) ) ) { cluster_tres_alloc_secs = tres_rec -> alloc_secs ; } list_sort ( cluster_group -> acct_list , ( ListCmpF ) _sort_acct_grouping_dec ) ; acct_itr = list_iterator_create ( cluster_group -> acct_list ) ; while ( ( acct_group = list_next ( acct_itr ) ) ) { uint64_t acct_tres_alloc_secs = 0 ; if ( acct_group -> tres_list && ( tres_rec = list_find_first ( acct_group -> tres_list , slurmdb_find_tres_in_list , & tres_id ) ) ) { acct_tres_alloc_secs = tres_rec -> alloc_secs ; } while ( ( field = list_next ( itr ) ) ) { switch ( field -> type ) { case PRINT_JOB_CLUSTER : field -> print_routine ( field , cluster_group -> cluster , 0 ) ; break ; case PRINT_JOB_WCKEY : case PRINT_JOB_ACCOUNT : field -> print_routine ( field , acct_group -> acct , 0 ) ; break ; default : field -> print_routine ( field , NULL , 0 ) ; break ; } } list_iterator_reset ( itr ) ; local_itr = list_iterator_create ( acct_group -> groups ) ; while ( ( job_group = list_next ( local_itr ) ) ) { uint64_t job_cpu_alloc_secs = 0 ; if ( job_group -> tres_list && ( tres_rec = list_find_first ( job_group -> tres_list , slurmdb_find_tres_in_list , & tres_id ) ) ) { job_cpu_alloc_secs = tres_rec -> alloc_secs ; } field = list_next ( itr2 ) ; switch ( field -> type ) { case PRINT_JOB_SIZE : tmp_char = sreport_get_time_str ( job_cpu_alloc_secs , acct_tres_alloc_secs ) ; field -> print_routine ( field , tmp_char , 0 ) ; xfree ( tmp_char ) ; break ; case PRINT_JOB_COUNT : field -> print_routine ( field , & job_group -> count , 0 ) ; break ; default : field -> print_routine ( field , NULL , 0 ) ; break ; } } list_iterator_reset ( itr2 ) ; list_iterator_destroy ( local_itr ) ; temp_format = time_format ; time_format = SLURMDB_REPORT_TIME_PERCENT ; if ( ! print_job_count ) { count1 = acct_tres_alloc_secs ; count2 = cluster_tres_alloc_secs ; } else { count1 = acct_group -> count ; count2 = cluster_group -> count ; } tmp_char = sreport_get_time_str ( count1 , count2 ) ; total_field . print_routine ( & total_field , tmp_char , 1 ) ; xfree ( tmp_char ) ; time_format = temp_format ; printf ( "\n" ) ; } list_iterator_destroy ( acct_itr ) ; } list_iterator_destroy ( itr ) ; end_it xfree ( total_field . name ) ; if ( print_job_count ) { print_job_count = 0 ; } if ( individual_grouping ) { individual_grouping = 0 ; } slurmdb_destroy_job_cond ( job_cond ) ; FREE_NULL_LIST ( grouping_list ) ; FREE_NULL_LIST ( assoc_list ) ; FREE_NULL_LIST ( slurmdb_report_cluster_grouping_list ) ; FREE_NULL_LIST ( print_fields_list ) ; FREE_NULL_LIST ( grouping_print_fields_list ) ; return rc ; } 