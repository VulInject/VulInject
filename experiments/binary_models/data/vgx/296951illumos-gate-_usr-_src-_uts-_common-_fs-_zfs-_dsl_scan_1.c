static void dsl_scan_setup_sync ( void * arg , dmu_tx_t * tx ) { dsl_scan_t * scn = dmu_tx_pool ( tx ) -> dp_scan ; pool_scan_func_t * funcp = arg ; int ot = 0 ; dsl_pool_t * dp = scn -> scn_dp ; spa_t * spa = dp -> dp_spa ; ASSERT ( ! dsl_scan_is_running ( scn ) ) ; ASSERT ( * funcp > POOL_SCAN_NONE && * funcp < POOL_SCAN_FUNCS ) ; bzero ( & scn -> scn_phys , sizeof ( scn -> scn_phys ) ) ; scn -> scn_phys . scn_func = * funcp ; scn -> scn_phys . scn_state = DSS_SCANNING ; scn -> scn_phys . scn_min_txg = 0 ; scn -> scn_phys . scn_max_txg = tx -> tx_txg ; scn -> scn_phys . scn_ddt_class_max = DDT_CLASSES - 1 ; scn -> scn_phys . scn_start_time = gethrestime_sec ( ) ; scn -> scn_phys . scn_errors = 0 ; scn -> scn_phys . scn_to_examine = spa -> spa_root_vdev -> vdev_stat . vs_alloc ; scn -> scn_issued_before_pass = 0 ; scn -> scn_restart_txg = 0 ; scn -> scn_done_txg = 0 ; scn -> scn_last_checkpoint = 0 ; scn -> scn_checkpointing = B_FALSE ; spa_scan_stat_init ( spa ) ; if ( DSL_SCAN_IS_SCRUB_RESILVER ( scn ) ) { scn -> scn_phys . scn_ddt_class_max = zfs_scrub_ddt_class_max ; vdev_config_dirty ( spa -> spa_root_vdev ) ; if ( vdev_resilver_needed ( spa -> spa_root_vdev , & scn -> scn_phys . scn_min_txg , & scn -> scn_phys . scn_max_txg ) ) { spa_event_notify ( spa , NULL , NULL , ESC_ZFS_RESILVER_START ) ; } else { spa_event_notify ( spa , NULL , NULL , ESC_ZFS_SCRUB_START ) ; } spa -> spa_scrub_started = B_TRUE ; if ( scn -> scn_phys . scn_min_txg > TXG_INITIAL ) { scn -> scn_phys . scn_ddt_class_max = DDT_CLASS_DITTO ; } } if ( dp -> dp_blkstats == NULL ) { dp -> dp_blkstats = kmem_alloc ( sizeof ( zfs_all_blkstats_t ) , KM_SLEEP ) ; mutex_init ( & dp -> dp_blkstats -> zab_lock , NULL , MUTEX_DEFAULT , NULL ) ; } bzero ( & dp -> dp_blkstats -> zab_type , sizeof ( dp -> dp_blkstats -> zab_type ) ) ; if ( spa_version ( spa ) < SPA_VERSION_DSL_SCRUB ) { ot = DMU_OT_ZAP_OTHER ; } scn -> scn_phys . scn_queue_obj = zap_create ( dp -> dp_meta_objset , ot ?ot : DMU_OT_SCAN_QUEUE , DMU_OT_NONE , 0 , tx ) ; bcopy ( & scn -> scn_phys , & scn -> scn_phys_cached , sizeof ( scn -> scn_phys ) ) ; dsl_scan_sync_state ( scn , tx , SYNC_MANDATORY ) ; spa_history_log_internal ( spa , "scan setup" , tx , "func=%u mintxg=%llu maxtxg=%llu" , * funcp , scn -> scn_phys . scn_min_txg , scn -> scn_phys . scn_max_txg ) ; } 