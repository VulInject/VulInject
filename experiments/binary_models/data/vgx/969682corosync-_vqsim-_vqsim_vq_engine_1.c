int fork_new_instance ( int nodeid , int * vq_sock , pid_t * childpid ) { int pipes [ 2 ] ; pid_t pid ; if ( socketpair ( AF_UNIX , SOCK_SEQPACKET | SOCK_NONBLOCK , 0 , pipes ) ) { return - 1 ; } parent_socket = pipes [ 0 ] ; switch ( ( pid = fork ( ) ) ) { case - 1 : perror ( "fork failed" ) ; return - 1 ; case 0 : break ; default : * vq_sock = pipes [ 1 ] ; * childpid = pid ; return 0 ; } our_nodeid = nodeid ; poll_loop = qb_loop_create ( ) ; if ( icmap_get_uint32 ( "quorum.device.timeout" , & qdevice_timeout ) != CS_OK ) { qdevice_timeout = VOTEQUORUM_QDEVICE_DEFAULT_TIMEOUT ; } set_local_node_pos ( & corosync_api ) ; load_quorum_instance ( & corosync_api ) ; qb_loop_poll_add ( poll_loop , QB_LOOP_MED , parent_socket , POLLIN , NULL , parent_pipe_read_fn ) ; initial_sync ( nodeid ) ; qb_loop_run ( poll_loop , NULL ) ; return 0 ; } 