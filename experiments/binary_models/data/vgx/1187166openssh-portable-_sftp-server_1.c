static void process_rename ( u_int32_t id ) { char * oldpath , * newpath ; int r , status ; struct stat sb ; if ( ( r = sshbuf_get_cstring ( iqueue , & oldpath , NULL ) ) != 0 || ( r = sshbuf_get_cstring ( iqueue , & newpath , NULL ) ) != 0 ) { fatal_fr ( r , "parse" ) ; } debug3 ( "request %u: rename" , id ) ; logit ( "rename old \"%s\" new \"%s\"" , oldpath , newpath ) ; status = SSH2_FX_FAILURE ; if ( lstat ( oldpath , & sb ) == - 1 ) { status = errno_to_portable ( errno ) ; } if ( S_ISREG ( sb . st_mode ) ) { if ( link ( oldpath , newpath ) == - 1 ) { if ( errno == EOPNOTSUPP || errno == ENOSYS || errno == EXDEV || errno == LINK_OPNOTSUPP_ERRNO ) { struct stat st ; if ( stat ( newpath , & st ) == - 1 ) { if ( rename ( oldpath , newpath ) == - 1 ) { status = errno_to_portable ( errno ) ; } else { status = SSH2_FX_OK ; } } } else { status = errno_to_portable ( errno ) ; } } if ( unlink ( oldpath ) == - 1 ) { status = errno_to_portable ( errno ) ; unlink ( newpath ) ; } else { status = SSH2_FX_OK ; } } if ( stat ( newpath , & sb ) == - 1 ) { if ( rename ( oldpath , newpath ) == - 1 ) { status = errno_to_portable ( errno ) ; } else { status = SSH2_FX_OK ; } } send_status ( id , status ) ; free ( newpath ) ; } 