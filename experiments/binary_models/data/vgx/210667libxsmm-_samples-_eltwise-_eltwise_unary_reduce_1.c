void setup_tpp_kernel_and_param_struct ( libxsmm_meltwfunction_unary * res_kernel , libxsmm_meltwfunction_unary * res_kernel2 , libxsmm_meltw_unary_param * res_unary_param , libxsmm_meltw_unary_param * res_unary_param2 , libxsmm_blasint m , libxsmm_blasint n , libxsmm_blasint _ld_in , libxsmm_blasint n_cols_idx , unsigned int reduce_rows , unsigned int reduce_op , unsigned int reduce_elts , unsigned int reduce_elts_squared , libxsmm_datatype dtype , unsigned int idx_type , float * sinp , float * result_reduce_elts , char * sinp_lp , char * result_reduce_elts_lp , unsigned short * sinp_hp , unsigned short * result_reduce_elts_hp , unsigned long long * cols_ind_array , unsigned int * cols_ind_array_32bit , unsigned int record_idx , unsigned long long * argop_off , unsigned int * argop_off_i32 , unsigned int reduce_on_outputs ) { libxsmm_meltw_unary_flags unary_flags = LIBXSMM_MELTW_FLAG_UNARY_NONE ; libxsmm_meltw_unary_type unary_type = LIBXSMM_MELTW_TYPE_UNARY_NONE ; libxsmm_meltw_unary_shape unary_shape ; libxsmm_blasint ld_in = _ld_in ; libxsmm_meltwfunction_unary kernel = NULL ; libxsmm_meltw_unary_param unary_param ; libxsmm_meltwfunction_unary kernel2 = NULL ; libxsmm_meltw_unary_param params2 ; memset ( & unary_param , 0 , sizeof ( unary_param ) ) ; if ( reduce_rows == 1 ) { unary_flags = LIBXSMM_EOR ( libxsmm_meltw_unary_flags , unary_flags , LIBXSMM_MELTW_FLAG_UNARY_REDUCE_ROWS ) ; } else { unary_flags = LIBXSMM_EOR ( libxsmm_meltw_unary_flags , unary_flags , LIBXSMM_MELTW_FLAG_UNARY_REDUCE_COLS ) ; } if ( reduce_on_outputs > 0 ) { unary_flags = LIBXSMM_EOR ( libxsmm_meltw_unary_flags , unary_flags , LIBXSMM_MELTW_FLAG_UNARY_REDUCE_INIT_ACC ) ; } if ( reduce_op == 0 ) { if ( ( reduce_elts == 1 ) && ( reduce_elts_squared == 1 ) ) { unary_type = LIBXSMM_MELTW_TYPE_UNARY_REDUCE_X_X2_OP_ADD ; } if ( ( reduce_elts == 0 ) && ( reduce_elts_squared == 1 ) ) { unary_type = LIBXSMM_MELTW_TYPE_UNARY_REDUCE_X2_OP_ADD ; } if ( ( reduce_elts == 1 ) && ( reduce_elts_squared == 0 ) ) { unary_type = LIBXSMM_MELTW_TYPE_UNARY_REDUCE_X_OP_ADD ; } } else { if ( ( reduce_elts == 1 ) && ( reduce_elts_squared == 0 ) ) { unary_type = LIBXSMM_MELTW_TYPE_UNARY_REDUCE_X_OP_MAX ; } } unary_shape . m = m ; unary_shape . n = n ; unary_shape . ldi = ld_in ; unary_shape . ldo = ld_in ; unary_shape . in_type = LIBXSMM_DATATYPE_F16 ; unary_shape . out_type = LIBXSMM_DATATYPE_F16 ; unary_shape . in0_type = dtype ; unary_shape . out_type = dtype ; if ( dtype == LIBXSMM_DATATYPE_F64 ) { unary_shape . comp_type = LIBXSMM_DATATYPE_F64 ; } else { unary_shape . comp_type = LIBXSMM_DATATYPE_F32 ; } if ( n_cols_idx == 0 ) { kernel = libxsmm_dispatch_meltw_unary_v2 ( unary_type , unary_shape , unary_flags ) ; if ( kernel == NULL ) { fprintf ( stderr , "JIT for REDUCE TPP failed. Bailing...!\n" ) ; exit ( - 1 ) ; } } else { if ( idx_type == 0 ) { unary_flags = LIBXSMM_MELTW_FLAG_UNARY_IDX_SIZE_8BYTES ; } else { unary_flags = LIBXSMM_MELTW_FLAG_UNARY_IDX_SIZE_4BYTES ; } if ( reduce_on_outputs > 0 ) { unary_flags |= LIBXSMM_EOR ( libxsmm_meltw_unary_flags , unary_flags , LIBXSMM_MELTW_FLAG_UNARY_REDUCE_INIT_ACC ) ; } unary_shape . n = 0 ; if ( reduce_op == 0 ) { kernel2 = libxsmm_dispatch_meltw_unary_v2 ( LIBXSMM_MELTW_TYPE_UNARY_REDUCE_COLS_IDX_OP_ADD , unary_shape , unary_flags ) ; if ( kernel2 == NULL ) { fprintf ( stderr , "JIT for REDUCE TPP failed. Bailing...!\n" ) ; exit ( - 1 ) ; } } else { unary_flags = LIBXSMM_EOR ( libxsmm_meltw_unary_flags , unary_flags , LIBXSMM_MELTW_FLAG_UNARY_REDUCE_NEG_INF_ACC ) ; if ( record_idx > 0 ) { unary_flags = LIBXSMM_EOR ( libxsmm_meltw_unary_flags , unary_flags , LIBXSMM_MELTW_FLAG_UNARY_REDUCE_RECORD_ARGOP ) ; if ( idx_type == 0 ) { params2 . out . secondary = argop_off ; } else { params2 . out . secondary = argop_off_i32 ; } } kernel2 = libxsmm_dispatch_meltw_unary_v2 ( LIBXSMM_MELTW_TYPE_UNARY_REDUCE_COLS_IDX_OP_MAX , unary_shape , unary_flags ) ; if ( kernel2 == NULL ) { fprintf ( stderr , "JIT for REDUCE TPP failed. Bailing...!\n" ) ; exit ( - 1 ) ; } } } if ( dtype == LIBXSMM_DATATYPE_F32 || dtype == LIBXSMM_DATATYPE_F64 ) { unary_param . in . primary = sinp ; unary_param . out . primary = result_reduce_elts ; } else { unary_param . in . primary = sinp_lp ; unary_param . out . primary = result_reduce_elts_lp ; } params2 . in . primary = sinp_hp ; params2 . out . primary = result_reduce_elts_hp ; if ( dtype == LIBXSMM_DATATYPE_F32 ) { params2 . in . primary = sinp ; params2 . out . primary = result_reduce_elts ; } else { params2 . in . primary = sinp_lp ; params2 . out . primary = result_reduce_elts_lp ; } if ( idx_type == 0 ) { params2 . in . secondary = cols_ind_array ; } else { params2 . in . secondary = cols_ind_array_32bit ; } * res_kernel = kernel ; * res_kernel2 = kernel2 ; * res_unary_param = unary_param ; * res_unary_param2 = params2 ; } 