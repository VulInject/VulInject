void tipc_topsrv_queue_evt ( struct net * net , int conid , u32 event , struct tipc_event * evt ) { struct tipc_topsrv * srv = tipc_topsrv ( net ) ; struct outqueue_entry * e ; struct tipc_conn * con ; con = tipc_conn_lookup ( srv , conid ) ; if ( ! connected ( con ) ) { err } e = kmalloc ( sizeof ( * e ) , GFP_ATOMIC ) ; if ( ! e ) { err } e -> inactive = ( event == TIPC_SUBSCR_TIMEOUT ) ; memcpy ( & e -> evt , evt , sizeof ( * evt ) ) ; spin_lock_bh ( & con -> outqueue_lock ) ; list_add_tail ( & e -> list , & con -> outqueue ) ; spin_unlock_bh ( & con -> outqueue_lock ) ; if ( queue_work ( srv -> send_wq , & con -> swork ) ) { return ; } err conn_put ( con ) ; } 