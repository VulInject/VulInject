static int mlxbf_tmfifo_virtio_find_vqs ( struct virtio_device * vdev , unsigned int nvqs , struct virtqueue * vqs [ ] , vq_callback_t * callbacks [ ] , const char * const names [ ] , const bool * ctx , struct irq_affinity * desc ) { struct mlxbf_tmfifo_vdev * tm_vdev = mlxbf_vdev_to_tmfifo ( vdev ) ; struct mlxbf_tmfifo_vring * vring ; struct virtqueue * vq ; int i , ret , size ; if ( nvqs > ARRAY_SIZE ( tm_vdev -> vrings ) ) { return - EINVAL ; } for ( i = 0 ; i < nvqs ; ++ i ) { if ( ! names [ i ] ) { ret = - EINVAL ; error } vring = & tm_vdev -> vrings [ i ] ; size = vring_size ( vring -> num , vring -> align ) ; vq = vring_new_virtqueue ( i , vring -> num , vring -> align , vdev , false , false , vring -> va , mlxbf_tmfifo_virtio_notify , callbacks [ i ] , names [ i ] ) ; if ( ! vq ) { dev_err ( & vdev -> dev , "vring_new_virtqueue failed\n" ) ; ret = - ENOMEM ; error } vq -> num_max = vring -> num ; vqs [ i ] = vq ; vring -> vq = vq ; vq -> priv = vring ; } return 0 ; error mlxbf_tmfifo_virtio_del_vqs ( vdev ) ; return ret ; } 