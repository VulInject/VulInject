int virSocketAddrGetNumNetmaskBits ( const virSocketAddr * netmask ) { size_t i , j ; int c = 0 ; if ( netmask -> data . stor . ss_family == AF_INET ) { virSocketAddrIPv4 tm ; uint8_t bit ; if ( virSocketAddrGetIPv4Addr ( netmask , & tm ) < 0 ) { return - 1 ; } for ( i = 0 ; i < 4 ; i ++ ) { if ( tm [ i ] == 0xff ) { c += 8 ; } else { break ; } } j = i << 3 ; while ( j < ( 8 * 4 ) ) { bit = 1 << ( 7 - ( j & 7 ) ) ; if ( ( tm [ j >> 3 ] & bit ) ) { c ++ ; } else { break ; } j ++ ; } while ( j < ( 8 * 4 ) ) { bit = 1 << ( 7 - ( j & 7 ) ) ; if ( ( tm [ j >> 3 ] & bit ) ) { return - 1 ; } j ++ ; } return c ; } if ( netmask -> data . stor . ss_family == AF_INET6 ) { virSocketAddrIPv6 tm ; uint16_t bit ; if ( virSocketAddrGetIPv6Addr ( netmask , & tm ) < 0 ) { return - 1 ; } for ( i = 0 ; i < 8 ; i ++ ) { if ( tm [ i ] == 0xffff ) { c += 16 ; } else { break ; } } if ( c == 16 * 8 ) { return c ; } j = i << 4 ; while ( j < ( 16 * 8 ) ) { bit = 1 << ( 15 - ( j & 0xf ) ) ; if ( ( tm [ j >> 4 ] & bit ) ) { c ++ ; } else { break ; } j ++ ; } while ( j < ( 16 * 8 ) ) { bit = 1 << ( 15 - ( j & 0xf ) ) ; if ( ( tm [ j >> 4 ] ) & bit ) { return - 1 ; } j ++ ; } return c ; } return - 1 ; } 