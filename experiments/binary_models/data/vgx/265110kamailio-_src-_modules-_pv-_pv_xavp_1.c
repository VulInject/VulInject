int pv_var_to_xavp ( str * varname , str * xname ) { script_var_t * it ; sr_xavp_t * avp = NULL ; sr_xval_t xval ; LM_DBG ( "xname:%.*s varname:%.*s\n" , xname -> len , xname -> s , varname -> len , varname -> s ) ; xavp_rm_by_name ( xname , 1 , NULL ) ; if ( varname -> len == 1 && varname -> s [ 0 ] == '*' ) { for ( it = get_var_all ( ) ; it ; it = it -> next ) { if ( it -> v . flags == VAR_VAL_INT ) { xval . type = SR_XTYPE_LONG ; xval . v . l = it -> v . value . n ; LM_DBG ( "[%.*s]: %ld\n" , it -> name . len , it -> name . s , xval . v . l ) ; } else { if ( it -> v . value . s . len == 0 ) { continue ; } xval . type = SR_XTYPE_STR ; xval . v . s . s = it -> v . value . s . s ; xval . v . s . len = it -> v . value . s . len ; LM_DBG ( "[%.*s]: '%.*s'\n" , it -> name . len , it -> name . s , xval . v . s . len , xval . v . s . s ) ; } if ( xavp_add_value ( & it -> name , & xval , & avp ) == NULL ) { LM_ERR ( "can't copy [%.*s]\n" , it -> name . len , it -> name . s ) ; error } } if ( avp ) { memset ( & xval , 0 , sizeof ( sr_xval_t ) ) ; xval . type = SR_XTYPE_XAVP ; xval . v . xavp = avp ; if ( xavp_add_value ( xname , & xval , NULL ) == NULL ) { LM_ERR ( "Can't create xavp[%.*s]\n" , xname -> len , xname -> s ) ; error } } } else { it = get_var_by_name ( varname ) ; if ( it == NULL ) { LM_ERR ( "script var [%.*s] not found\n" , varname -> len , varname -> s ) ; return - 1 ; } memset ( & xval , 0 , sizeof ( sr_xval_t ) ) ; if ( it -> v . flags == VAR_VAL_INT ) { xval . type = SR_XTYPE_LONG ; xval . v . l = it -> v . value . n ; LM_DBG ( "[%.*s]: %ld\n" , it -> name . len , it -> name . s , xval . v . l ) ; } else { xval . type = SR_XTYPE_STR ; xval . v . s . s = it -> v . value . s . s ; xval . v . s . len = it -> v . value . s . len ; LM_DBG ( "[%.*s]: '%.*s'\n" , it -> name . len , it -> name . s , xval . v . s . len , xval . v . s . s ) ; } if ( xavp_add_xavp_value ( xname , & it -> name , & xval , NULL ) == NULL ) { LM_ERR ( "can't copy [%.*s]\n" , it -> name . len , it -> name . s ) ; return - 1 ; } } return 1 ; error if ( avp ) { xavp_destroy_list ( & avp ) ; } return - 1 ; } 