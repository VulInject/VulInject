static int array_setLength ( JSContext * c , GF_JSField * ptr , JSValueConst value ) { u32 len , i , sftype , old_len ; GF_JSClass * the_sf_class ; if ( ! JS_IsInteger ( value ) || ! ptr ) { return - 1 ; } len = - 1 ; JS_ToInt32 ( c , & len , value ) ; if ( ( s32 ) len < 0 ) { return - 1 ; } if ( ! len ) { if ( ptr -> field . fieldType == GF_SG_VRML_MFNODE ) { gf_node_unregister_children ( ptr -> owner , * ( GF_ChildNodeItem * * ) ptr -> field . far_ptr ) ; * ( GF_ChildNodeItem * * ) ptr -> field . far_ptr = NULL ; } else { gf_sg_vrml_mf_reset ( ptr -> field . far_ptr , ptr -> field . fieldType ) ; } while ( ptr -> mfvals_count ) { ptr -> mfvals_count -- ; JS_FreeValue ( c , ptr -> mfvals [ ptr -> mfvals_count ] ) ; } gf_free ( ptr -> mfvals ) ; ptr -> mfvals = NULL ; return 1 ; } old_len = ptr -> mfvals_count ; ptr -> mfvals_count = len ; the_sf_class = NULL ; switch ( ptr -> field . fieldType ) { case GF_SG_VRML_MFVEC2F : the_sf_class = & SFVec2fClass ; break ; case GF_SG_VRML_MFVEC3F : the_sf_class = & SFVec3fClass ; break ; case GF_SG_VRML_MFCOLOR : the_sf_class = & SFColorClass ; break ; case GF_SG_VRML_MFROTATION : the_sf_class = & SFRotationClass ; break ; case GF_SG_VRML_MFNODE : { u32 nb_nodes = gf_node_list_get_count ( * ( GF_ChildNodeItem * * ) ptr -> field . far_ptr ) ; while ( len < nb_nodes ) { GF_Node * n = gf_node_list_del_child_idx ( ( GF_ChildNodeItem * * ) ptr -> field . far_ptr , nb_nodes - 1 ) ; if ( n ) { gf_node_unregister ( n , ptr -> owner ) ; } nb_nodes -- ; } if ( len > nb_nodes ) { GF_LOG ( GF_LOG_ERROR , GF_LOG_SCRIPT , ( "[VRML] MFARRAY EXPANSION NOT SUPPORTED!!!\n" ) ) ; } } return 1 ; } ptr -> mfvals = gf_realloc ( ptr -> mfvals , sizeof ( JSValue ) * ptr -> mfvals_count ) ; sftype = gf_sg_vrml_get_sf_type ( ptr -> field . fieldType ) ; for ( i = old_len ; i < len ; i ++ ) { JSValue a_val ; if ( the_sf_class ) { GF_JSField * slot ; a_val = JS_NewObjectClass ( c , the_sf_class -> class_id ) ; slot = SFVec2f_Create ( c , a_val , 0 , 0 ) ; if ( slot ) { slot -> owner = ptr -> owner ; } } else { switch ( sftype ) { case GF_SG_VRML_SFBOOL : a_val = JS_FALSE ; break ; case GF_SG_VRML_SFFLOAT : case GF_SG_VRML_SFTIME : a_val = JS_NewFloat64 ( c , 0 ) ; break ; case GF_SG_VRML_SFSTRING : case GF_SG_VRML_SFURL : a_val = JS_NewString ( c , "" ) ; break ; case GF_SG_VRML_SFINT32 : default : a_val = JS_NewInt32 ( c , 0 ) ; break ; } } ptr -> mfvals [ i ] = a_val ; gf_sg_vrml_mf_append ( ptr -> field . far_ptr , ptr -> field . fieldType , NULL ) ; } return 1 ; } 