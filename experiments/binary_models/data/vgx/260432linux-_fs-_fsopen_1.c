static ssize_t fscontext_read ( struct file * file , char __user * _buf , size_t len , loff_t * pos ) { struct fs_context * fc = file -> private_data ; struct fc_log * log = fc -> log . log ; unsigned int logsize = ARRAY_SIZE ( log -> buffer ) ; ssize_t ret ; char * p ; bool need_free ; int index , n ; ret = mutex_lock_interruptible ( & fc -> uapi_mutex ) ; if ( ret < 0 ) { return ret ; } if ( log -> head == log -> tail ) { return - ENODATA ; } index = log -> tail & ( logsize - 1 ) ; p = log -> buffer [ index ] ; need_free = log -> need_free & ( 1 << index ) ; log -> buffer [ index ] = NULL ; log -> need_free &= ~ ( 1 << index ) ; log -> tail ++ ; mutex_unlock ( & fc -> uapi_mutex ) ; ret = - EMSGSIZE ; n = strlen ( p ) ; if ( n > len ) { err_free } ret = - EFAULT ; if ( copy_to_user ( _buf , p , n ) != 0 ) { err_free } ret = n ; err_free if ( need_free ) { kfree ( p ) ; } return ret ; } 