void DefragInitConfig ( bool quiet ) { SCLogDebug ( "initializing defrag engine..." ) ; SC_ATOMIC_INIT ( defragtracker_counter ) ; SC_ATOMIC_INIT ( defrag_memuse ) ; SC_ATOMIC_INIT ( defragtracker_prune_idx ) ; SC_ATOMIC_INIT ( defrag_config . memcap ) ; DefragTrackerQueueInit ( & defragtracker_spare_q ) ; defrag_config . hash_rand = ( uint32_t ) RandomGet ( ) ; defrag_config . hash_size = DEFRAG_DEFAULT_HASHSIZE ; defrag_config . prealloc = DEFRAG_DEFAULT_PREALLOC ; SC_ATOMIC_SET ( defrag_config . memcap , DEFRAG_DEFAULT_MEMCAP ) ; defrag_config . memcap_policy = ExceptionPolicyParse ( "defrag.memcap-policy" , false ) ; const char * conf_val ; uint32_t configval = 0 ; uint64_t defrag_memcap ; if ( ( ConfGet ( "defrag.memcap" , & conf_val ) ) == 1 ) { if ( ParseSizeStringU64 ( conf_val , & defrag_memcap ) < 0 ) { SCLogError ( "Error parsing defrag.memcap " "from conf file - %s.  Killing engine" , conf_val ) ; exit ( EXIT_FAILURE ) ; } else { SC_ATOMIC_SET ( defrag_config . memcap , defrag_memcap ) ; } } if ( ( ConfGet ( "defrag.hash-size" , & conf_val ) ) == 1 ) { if ( StringParseUint32 ( & configval , 10 , strlen ( conf_val ) , conf_val ) > 0 ) { defrag_config . hash_size = configval ; } else { WarnInvalidConfEntry ( "defrag.hash-size" , "%" PRIu32 , defrag_config . hash_size ) ; } } if ( ( ConfGet ( "defrag.trackers" , & conf_val ) ) == 1 ) { if ( StringParseUint32 ( & configval , 10 , strlen ( conf_val ) , conf_val ) > 0 ) { defrag_config . prealloc = configval ; } else { WarnInvalidConfEntry ( "defrag.trackers" , "%" PRIu32 , defrag_config . prealloc ) ; } } SCLogDebug ( "DefragTracker config from suricata.yaml: memcap: %" PRIu64 ", hash-size: " "%" PRIu32 ", prealloc: %" PRIu32 , SC_ATOMIC_GET ( defrag_config . memcap ) , defrag_config . hash_size , defrag_config . prealloc ) ; uint64_t hash_size = defrag_config . hash_size * sizeof ( DefragTrackerHashRow ) ; if ( ! ( DEFRAG_CHECK_MEMCAP ( hash_size ) ) ) { SCLogError ( "allocating defrag hash failed: " "max defrag memcap is smaller than projected hash size. " "Memcap: %" PRIu64 ", Hash table size %" PRIu64 ". Calculate " "total hash size by multiplying \"defrag.hash-size\" with %" PRIuMAX ", " "which is the hash bucket size." , SC_ATOMIC_GET ( defrag_config . memcap ) , hash_size , ( uintmax_t ) sizeof ( DefragTrackerHashRow ) ) ; exit ( EXIT_FAILURE ) ; } defragtracker_hash = SCCalloc ( defrag_config . hash_size , sizeof ( DefragTrackerHashRow ) ) ; if ( unlikely ( defragtracker_hash == NULL ) ) { FatalError ( "Fatal error encountered in DefragTrackerInitConfig. Exiting..." ) ; } memset ( defragtracker_hash , 0 , defrag_config . hash_size * sizeof ( DefragTrackerHashRow ) ) ; uint32_t i = 0 ; for ( i = 0 ; i < defrag_config . hash_size ; i ++ ) { DRLOCK_INIT ( & defragtracker_hash [ i ] ) ; } ( void ) SC_ATOMIC_ADD ( defrag_memuse , ( defrag_config . hash_size * sizeof ( DefragTrackerHashRow ) ) ) ; if ( ! quiet ) { SCLogConfig ( "allocated %" PRIu64 " bytes of memory for the defrag hash... " "%" PRIu32 " buckets of size %" PRIuMAX "" , SC_ATOMIC_GET ( defrag_memuse ) , defrag_config . hash_size , ( uintmax_t ) sizeof ( DefragTrackerHashRow ) ) ; } if ( ( ConfGet ( "defrag.prealloc" , & conf_val ) ) == 1 ) { if ( ConfValIsTrue ( conf_val ) ) { for ( i = 0 ; i < defrag_config . prealloc ; i ++ ) { if ( ! ( DEFRAG_CHECK_MEMCAP ( sizeof ( DefragTracker ) ) ) ) { SCLogError ( "preallocating defrag trackers failed: " "max defrag memcap reached. Memcap %" PRIu64 ", " "Memuse %" PRIu64 "." , SC_ATOMIC_GET ( defrag_config . memcap ) , ( ( uint64_t ) SC_ATOMIC_GET ( defrag_memuse ) + ( uint64_t ) sizeof ( DefragTracker ) ) ) ; exit ( EXIT_FAILURE ) ; } DefragTracker * h = DefragTrackerAlloc ( ) ; if ( h == NULL ) { SCLogError ( "preallocating defrag failed: %s" , strerror ( errno ) ) ; exit ( EXIT_FAILURE ) ; } DefragTrackerEnqueue ( & defragtracker_spare_q , h ) ; } if ( ! quiet ) { SCLogConfig ( "preallocated %" PRIu32 " defrag trackers of size %" PRIuMAX "" , defragtracker_spare_q . len , ( uintmax_t ) sizeof ( DefragTracker ) ) ; } } } if ( ! quiet ) { SCLogConfig ( "defrag memory usage: %" PRIu64 " bytes, maximum: %" PRIu64 , SC_ATOMIC_GET ( defrag_memuse ) , SC_ATOMIC_GET ( defrag_config . memcap ) ) ; } return ; } 