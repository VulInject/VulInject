s8 PHY_GetTxPowerLimit ( struct adapter * Adapter , u32 RegPwrTblSel , enum BAND_TYPE Band , enum CHANNEL_WIDTH Bandwidth , u8 RfPath , u8 DataRate , u8 Channel ) { struct hal_com_data * pHalData = GET_HAL_DATA ( Adapter ) ; s16 band = - 1 , regulation = - 1 , bandwidth = - 1 , rateSection = - 1 , channel = - 1 ; s8 powerLimit = MAX_POWER_INDEX ; switch ( Adapter -> registrypriv . RegPwrTblSel ) { case 1 : regulation = TXPWR_LMT_ETSI ; break ; case 2 : regulation = TXPWR_LMT_MKK ; break ; case 3 : regulation = TXPWR_LMT_FCC ; break ; case 4 : regulation = TXPWR_LMT_WW ; break ; default : regulation = ( Band == BAND_ON_2_4G ) ?pHalData -> Regulation2_4G : pHalData -> Regulation5G ; break ; } if ( Band == BAND_ON_2_4G ) { band = 0 ; } if ( Band == BAND_ON_5G ) { band = 1 ; } if ( Bandwidth == CHANNEL_WIDTH_20 ) { bandwidth = 0 ; } if ( Bandwidth == CHANNEL_WIDTH_40 ) { bandwidth = 1 ; } if ( Bandwidth == CHANNEL_WIDTH_80 ) { bandwidth = 2 ; } if ( Bandwidth == CHANNEL_WIDTH_160 ) { bandwidth = 3 ; } switch ( DataRate ) { case MGN_1M : case MGN_2M : case MGN_5_5M : case MGN_11M : rateSection = 0 ; break ; case MGN_6M : case MGN_9M : case MGN_12M : case MGN_18M : case MGN_24M : case MGN_36M : case MGN_48M : case MGN_54M : rateSection = 1 ; break ; case MGN_MCS0 : case MGN_MCS1 : case MGN_MCS2 : case MGN_MCS3 : case MGN_MCS4 : case MGN_MCS5 : case MGN_MCS6 : case MGN_MCS7 : rateSection = 2 ; break ; case MGN_MCS8 : case MGN_MCS9 : case MGN_MCS10 : case MGN_MCS11 : case MGN_MCS12 : case MGN_MCS13 : case MGN_MCS14 : case MGN_MCS15 : rateSection = 3 ; break ; case MGN_MCS16 : case MGN_MCS17 : case MGN_MCS18 : case MGN_MCS19 : case MGN_MCS20 : case MGN_MCS21 : case MGN_MCS22 : case MGN_MCS23 : rateSection = 4 ; break ; case MGN_MCS24 : case MGN_MCS25 : case MGN_MCS26 : case MGN_MCS27 : case MGN_MCS28 : case MGN_MCS29 : case MGN_MCS30 : case MGN_MCS31 : rateSection = 5 ; break ; case MGN_VHT1SS_MCS0 : case MGN_VHT1SS_MCS1 : case MGN_VHT1SS_MCS2 : case MGN_VHT1SS_MCS3 : case MGN_VHT1SS_MCS4 : case MGN_VHT1SS_MCS5 : case MGN_VHT1SS_MCS6 : case MGN_VHT1SS_MCS7 : case MGN_VHT1SS_MCS8 : case MGN_VHT1SS_MCS9 : rateSection = 6 ; break ; case MGN_VHT2SS_MCS0 : case MGN_VHT2SS_MCS1 : case MGN_VHT2SS_MCS2 : case MGN_VHT2SS_MCS3 : case MGN_VHT2SS_MCS4 : case MGN_VHT2SS_MCS5 : case MGN_VHT2SS_MCS6 : case MGN_VHT2SS_MCS7 : case MGN_VHT2SS_MCS8 : case MGN_VHT2SS_MCS9 : rateSection = 7 ; break ; case MGN_VHT3SS_MCS0 : case MGN_VHT3SS_MCS1 : case MGN_VHT3SS_MCS2 : case MGN_VHT3SS_MCS3 : case MGN_VHT3SS_MCS4 : case MGN_VHT3SS_MCS5 : case MGN_VHT3SS_MCS6 : case MGN_VHT3SS_MCS7 : case MGN_VHT3SS_MCS8 : case MGN_VHT3SS_MCS9 : rateSection = 8 ; break ; case MGN_VHT4SS_MCS0 : case MGN_VHT4SS_MCS1 : case MGN_VHT4SS_MCS2 : case MGN_VHT4SS_MCS3 : case MGN_VHT4SS_MCS4 : case MGN_VHT4SS_MCS5 : case MGN_VHT4SS_MCS6 : case MGN_VHT4SS_MCS7 : case MGN_VHT4SS_MCS8 : case MGN_VHT4SS_MCS9 : rateSection = 9 ; break ; default : DBG_871X ( "Wrong rate 0x%x\n" , DataRate ) ; break ; } if ( Band == BAND_ON_5G && rateSection == 0 ) { DBG_871X ( "Wrong rate 0x%x: No CCK in 5G Band\n" , DataRate ) ; } if ( rateSection == 1 ) { bandwidth = 0 ; } if ( rateSection == 0 ) { bandwidth = 0 ; } if ( ( rateSection == 2 || rateSection == 3 ) && Band == BAND_ON_5G && bandwidth == 2 ) { bandwidth = 1 ; } if ( Band == BAND_ON_2_4G ) { channel = phy_GetChannelIndexOfTxPowerLimit ( BAND_ON_2_4G , Channel ) ; } if ( Band == BAND_ON_5G ) { channel = phy_GetChannelIndexOfTxPowerLimit ( BAND_ON_5G , Channel ) ; } if ( Band == BAND_ON_BOTH ) { } if ( band == - 1 || regulation == - 1 || bandwidth == - 1 || rateSection == - 1 || channel == - 1 ) { return MAX_POWER_INDEX ; } if ( Band == BAND_ON_2_4G ) { s8 limits [ 10 ] { 0 } ; ; u8 i = 0 ; for ( i = 0 ; i < MAX_REGULATION_NUM ; i ++ ) { limits [ i ] = pHalData -> TxPwrLimit_2_4G [ i ] [ bandwidth ] [ rateSection ] [ channel ] [ RfPath ] ; } powerLimit = ( regulation == TXPWR_LMT_WW ) ?phy_GetWorldWideLimit ( limits ) : pHalData -> TxPwrLimit_2_4G [ regulation ] [ bandwidth ] [ rateSection ] [ channel ] [ RfPath ] ; } if ( Band == BAND_ON_5G ) { s8 limits [ 10 ] { 0 } ; ; u8 i = 0 ; for ( i = 0 ; i < MAX_REGULATION_NUM ; ++ i ) { limits [ i ] = pHalData -> TxPwrLimit_5G [ i ] [ bandwidth ] [ rateSection ] [ channel ] [ RfPath ] ; } powerLimit = ( regulation == TXPWR_LMT_WW ) ?phy_GetWorldWideLimit ( limits ) : pHalData -> TxPwrLimit_5G [ regulation ] [ bandwidth ] [ rateSection ] [ channel ] [ RfPath ] ; } else { DBG_871X ( "No power limit table of the specified band\n" ) ; } return powerLimit ; } 