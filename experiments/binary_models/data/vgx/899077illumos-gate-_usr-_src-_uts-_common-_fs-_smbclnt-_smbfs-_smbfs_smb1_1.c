int smbfs_smb1_oldrename ( struct smbnode * src , struct smbnode * tdnp , const char * tname , int tnmlen , struct smb_cred * scrp ) { struct smb_rq rq , * rqp = & rq ; struct smb_share * ssp = src -> n_mount -> smi_share ; struct mbchain * mbp ; int error ; uint16_t fa ; char sep ; error = smb_rq_init ( rqp , SSTOCP ( ssp ) , SMB_COM_RENAME , scrp ) ; if ( error ) { return ( error ) ; } smb_rq_getrequest ( rqp , & mbp ) ; smb_rq_wstart ( rqp , NULL ) ; fa = ( SMBTOV ( src ) -> v_type == VDIR ) ?SMB_FA_DIR : 0 ; fa |= SMB_FA_SYSTEM | SMB_FA_HIDDEN ; mb_put_uint16le ( mbp , fa ) ; smb_rq_wend ( rqp ) ; smb_rq_bstart ( rqp ) ; mb_put_uint8 ( mbp , SMB_DT_ASCII ) ; error = smbfs_fullpath ( mbp , SSTOVC ( ssp ) , src , NULL , 0 , 0 ) ; if ( error ) { out } sep = ( src -> n_flag & N_XATTR ) ?':' : '\\' ; mb_put_uint8 ( mbp , SMB_DT_ASCII ) ; error = smbfs_fullpath ( mbp , SSTOVC ( ssp ) , tdnp , tname , tnmlen , sep ) ; if ( error ) { out } smb_rq_bend ( rqp ) ; error = smb_rq_simple ( rqp ) ; out smb_rq_done ( rqp ) ; return ( error ) ; } 