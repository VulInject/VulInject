bool tipc_msg_bundle ( struct sk_buff * skb , struct tipc_msg * msg , u32 mtu ) { struct tipc_msg * bmsg ; unsigned int bsz ; unsigned int msz = msg_size ( msg ) ; u32 start , pad ; u32 max = mtu - INT_H_SIZE ; if ( likely ( msg_user ( msg ) == MSG_FRAGMENTER ) ) { return false ; } if ( ! skb ) { return false ; } bmsg = buf_msg ( skb ) ; bsz = msg_size ( bmsg ) ; start = align ( bsz ) ; pad = start - bsz ; if ( unlikely ( msg_user ( msg ) == BCAST_PROTOCOL ) ) { return false ; } if ( unlikely ( msg_user ( bmsg ) != MSG_BUNDLER ) ) { return false ; } if ( unlikely ( skb_tailroom ( skb ) < ( pad + msz ) ) ) { return false ; } if ( unlikely ( max < ( start + msz ) ) ) { return false ; } if ( ( msg_importance ( msg ) < TIPC_SYSTEM_IMPORTANCE ) && ( msg_importance ( bmsg ) == TIPC_SYSTEM_IMPORTANCE ) ) { return false ; } skb_put ( skb , pad + msz ) ; skb_copy_to_linear_data_offset ( skb , start , msg , msz ) ; msg_set_size ( bmsg , start + msz ) ; msg_set_msgcnt ( bmsg , msg_msgcnt ( bmsg ) + 1 ) ; return true ; } 