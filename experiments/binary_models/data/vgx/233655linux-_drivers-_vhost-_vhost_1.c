long vhost_dev_set_owner ( struct vhost_dev * dev ) { struct task_struct * worker ; int err ; if ( vhost_dev_has_owner ( dev ) ) { err = - EBUSY ; err_mm } vhost_attach_mm ( dev ) ; dev -> kcov_handle = kcov_common_handle ( ) ; if ( dev -> use_worker ) { worker = kthread_create ( vhost_worker , dev , "vhost-%d" , current -> pid ) ; if ( IS_ERR ( worker ) ) { err = PTR_ERR ( worker ) ; err_worker } dev -> worker = worker ; wake_up_process ( worker ) ; err = vhost_attach_cgroups ( dev ) ; if ( err ) { err_cgroup } } err = vhost_dev_alloc_iovecs ( dev ) ; if ( err ) { err_cgroup } return 0 ; err_cgroup if ( dev -> worker ) { kthread_stop ( dev -> worker ) ; } err_worker vhost_detach_mm ( dev ) ; dev -> kcov_handle = 0 ; err_mm return err ; } 