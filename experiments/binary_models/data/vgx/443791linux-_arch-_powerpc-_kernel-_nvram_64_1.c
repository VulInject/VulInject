void __init nvram_init_oops_partition ( int rtas_partition_exists ) { int rc ; rc = nvram_init_os_partition ( & oops_log_partition ) ; if ( rc != 0 ) { if ( ! rtas_partition_exists ) { pr_err ( "nvram: Failed to initialize oops partition!" ) ; return ; } pr_notice ( "nvram: Using %s partition to log both" " RTAS errors and oops/panic reports\n" , rtas_log_partition . name ) ; memcpy ( & oops_log_partition , & rtas_log_partition , sizeof ( rtas_log_partition ) ) ; pr_err ( "nvram: Failed to initialize oops partition!" ) ; return ; } oops_buf = kmalloc ( oops_log_partition . size , GFP_KERNEL ) ; if ( ! oops_buf ) { pr_err ( "nvram: No memory for %s partition\n" , oops_log_partition . name ) ; return ; } oops_data = oops_buf + sizeof ( oops_log_info ) ; oops_data_sz = oops_log_partition . size - sizeof ( oops_log_info ) ; rc = nvram_pstore_init ( ) ; if ( ! rc ) { return ; } big_oops_buf_sz = ( oops_data_sz * 100 ) / 45 ; big_oops_buf = kmalloc ( big_oops_buf_sz , GFP_KERNEL ) ; if ( big_oops_buf ) { stream . workspace = kmalloc ( zlib_deflate_workspacesize ( WINDOW_BITS , MEM_LEVEL ) , GFP_KERNEL ) ; if ( ! stream . workspace ) { pr_err ( "nvram: No memory for compression workspace; " "skipping compression of %s partition data\n" , oops_log_partition . name ) ; kfree ( big_oops_buf ) ; big_oops_buf = NULL ; } } else { pr_err ( "No memory for uncompressed %s data; " "skipping compression\n" , oops_log_partition . name ) ; } rc = kmsg_dump_register ( & nvram_kmsg_dumper ) ; if ( rc != 0 ) { pr_err ( "nvram: kmsg_dump_register() failed; returned %d\n" , rc ) ; kfree ( oops_buf ) ; kfree ( big_oops_buf ) ; kfree ( stream . workspace ) ; } } 