static int yt8521_fiber_config_aneg ( struct phy_device * phydev ) { int err , changed = 0 ; int bmcr ; u16 adv ; if ( phydev -> autoneg != AUTONEG_ENABLE ) { return yt8521_fiber_setup_forced ( phydev ) ; } err = ytphy_modify_ext ( phydev , YT8521_LINK_TIMER_CFG2_REG , 0 , YT8521_LTCR_EN_AUTOSEN ) ; err = ytphy_modify_ext ( phydev , YT8521_CHIP_CONFIG_REG , YT8521_CCR_SW_RST , 0 ) ; if ( err < 0 ) { return err ; } bmcr = __phy_read ( phydev , MII_BMCR ) ; if ( bmcr < 0 ) { return bmcr ; } if ( ! ( bmcr & BMCR_ANENABLE ) ) { __phy_modify ( phydev , MII_BMCR , 0 , BMCR_PDOWN ) ; usleep_range ( 1000 , 1100 ) ; __phy_modify ( phydev , MII_BMCR , BMCR_PDOWN , 0 ) ; } adv = linkmode_adv_to_mii_adv_x ( phydev -> advertising , ETHTOOL_LINK_MODE_1000baseX_Full_BIT ) ; err = __phy_modify_changed ( phydev , MII_ADVERTISE , ADVERTISE_1000XHALF | ADVERTISE_1000XFULL | ADVERTISE_1000XPAUSE | ADVERTISE_1000XPSE_ASYM , adv ) ; if ( err < 0 ) { return err ; } if ( err > 0 ) { changed = 1 ; } return ytphy_check_and_restart_aneg ( phydev , changed ) ; } 