static int do_mmc_sparse_write ( struct cmd_tbl * cmdtp , int flag , int argc , char * const argv [ ] ) { struct sparse_storage sparse ; struct blk_desc * dev_desc ; struct mmc * mmc ; char dest [ 11 ] ; void * addr ; u32 blk ; if ( argc != 3 ) { return CMD_RET_USAGE ; } addr = ( void * ) hextoul ( argv [ 1 ] , NULL ) ; blk = hextoul ( argv [ 2 ] , NULL ) ; if ( ! is_sparse_image ( addr ) ) { printf ( "Not a sparse image\n" ) ; return CMD_RET_FAILURE ; } mmc = init_mmc_device ( curr_device , false ) ; printf ( "\nMMC Sparse write: dev # %d, block # %d ... " , curr_device , blk ) ; if ( mmc_getwp ( mmc ) == 1 ) { printf ( "Error: card is write protected!\n" ) ; return CMD_RET_FAILURE ; } dev_desc = mmc_get_blk_desc ( mmc ) ; sparse . priv = dev_desc ; sparse . blksz = 512 ; sparse . start = blk ; sparse . size = dev_desc -> lba - blk ; sparse . write = mmc_sparse_write ; sparse . reserve = mmc_sparse_reserve ; sparse . mssg = NULL ; sprintf ( dest , "0x" LBAF , sparse . start * sparse . blksz ) ; if ( write_sparse_image ( & sparse , dest , addr , NULL ) ) { return CMD_RET_FAILURE ; } else { return CMD_RET_SUCCESS ; } } 