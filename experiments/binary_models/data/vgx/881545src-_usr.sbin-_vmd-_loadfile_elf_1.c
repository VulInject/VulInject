size_t mread ( gzFile fp , paddr_t addr , size_t sz ) { const char * errstr = NULL ; int errnum = 0 ; size_t ct ; size_t i , osz ; char buf [ PAGE_SIZE ] ; ct = 0 ; osz = sz ; if ( ( addr & PAGE_MASK ) != 0 ) { if ( sz > PAGE_SIZE ) { ct = PAGE_SIZE - ( addr & PAGE_MASK ) ; } else { ct = sz ; } if ( ( size_t ) gzread ( fp , buf , ct ) != ct ) { errstr = gzerror ( fp , & errnum ) ; if ( errnum == Z_ERRNO ) { errnum = errno ; } log_warnx ( "%s: error %d in mread, %s" , __progname , errnum , errstr ) ; return ( 0 ) ; } if ( write_mem ( addr , buf , ct ) ) { return ( 0 ) ; } addr += ct ; } sz = sz - ct ; if ( sz == 0 ) { return ( osz ) ; } for ( i = 0 ; i < sz ; i += PAGE_SIZE , addr += PAGE_SIZE ) { memset ( buf , 0 , sizeof ( buf ) ) ; if ( i + PAGE_SIZE > sz ) { ct = sz - i ; } else { ct = PAGE_SIZE ; } if ( ( size_t ) gzread ( fp , buf , ct ) != ct ) { errstr = gzerror ( fp , & errnum ) ; if ( errnum == Z_ERRNO ) { errnum = errno ; } log_warnx ( "%s: error %d in mread, %s" , __progname , errnum , errstr ) ; return ( 0 ) ; } if ( write_mem ( addr , buf , ct ) ) { return ( 0 ) ; } } return ( osz ) ; } 