static int virStorageSourceGetMetadataRecurse ( virStorageSource * src , virStorageSource * parent , uid_t uid , gid_t gid , bool report_broken , size_t max_depth , unsigned int depth ) { virStorageFileFormat orig_format = src -> format ; size_t headerLen ; int rv ; g_autofree char * buf = NULL ; g_autoptr ( ) backingStore = NULL ; VIR_DEBUG ( "path=%s format=%d uid=%u gid=%u depth=%u" , NULLSTR ( src -> path ) , src -> format , ( unsigned int ) uid , ( unsigned int ) gid , depth ) ; if ( depth > max_depth ) { virReportError ( VIR_ERR_INTERNAL_ERROR , _ ( "backing store for %s is self-referential or too deeply nested" ) , NULLSTR ( src -> path ) ) ; return - 1 ; } if ( src -> format == VIR_STORAGE_FILE_AUTO_SAFE ) { src -> format = VIR_STORAGE_FILE_AUTO ; } rv = virStorageSourceSupportsBackingChainTraversal ( src ) ; if ( rv <= 0 ) { if ( orig_format == VIR_STORAGE_FILE_AUTO ) { return - 2 ; } return rv ; } if ( virStorageSourceGetMetadataRecurseReadHeader ( src , parent , uid , gid , & buf , & headerLen ) < 0 ) { return - 1 ; } if ( virStorageFileProbeGetMetadata ( src , buf , headerLen ) < 0 ) { return - 1 ; } if ( orig_format == VIR_STORAGE_FILE_AUTO ) { if ( src -> backingStoreRaw ) { src -> format = VIR_STORAGE_FILE_RAW ; VIR_FREE ( src -> backingStoreRaw ) ; return - 2 ; } } if ( src -> backingStoreRaw ) { if ( ( rv = virStorageSourceNewFromBacking ( src , & backingStore ) ) < 0 ) { return - 1 ; } if ( ( rv = virStorageSourceGetMetadataRecurse ( backingStore , parent , uid , gid , report_broken , max_depth , depth + 1 ) ) < 0 ) { if ( ! report_broken ) { return 0 ; } if ( rv == - 2 ) { virReportError ( , "format of backing image '%s' of image '%s' was not specified in the image metadata " " ) } } } } 