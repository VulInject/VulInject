int del_mtd_blktrans_dev ( struct mtd_blktrans_dev * old ) { unsigned long flags ; lockdep_assert_held ( & mtd_table_mutex ) ; if ( old -> disk_attributes ) { sysfs_remove_group ( & disk_to_dev ( old -> disk ) -> kobj , old -> disk_attributes ) ; } del_gendisk ( old -> disk ) ; spin_lock_irqsave ( & old -> queue_lock , flags ) ; old -> rq -> queuedata = NULL ; spin_unlock_irqrestore ( & old -> queue_lock , flags ) ; blk_mq_freeze_queue ( old -> rq ) ; blk_mq_quiesce_queue ( old -> rq ) ; blk_mq_unquiesce_queue ( old -> rq ) ; blk_mq_unfreeze_queue ( old -> rq ) ; mutex_lock ( & old -> lock ) ; if ( old -> open ) { if ( old -> tr -> release ) { old -> tr -> release ( old ) ; } __put_mtd_device ( old -> mtd , NULL ) ; } old -> mtd = NULL ; mutex_unlock ( & old -> lock ) ; blktrans_dev_put ( old ) ; return 0 ; } 