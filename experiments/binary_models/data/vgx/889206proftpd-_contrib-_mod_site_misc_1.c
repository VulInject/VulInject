MODRET site_misc_utime_atime_mtime_ctime ( cmd_rec * cmd ) { register unsigned int i ; char * cmd_name , * decoded_path , * path = "" , * timestamp ; size_t timestamp_len ; unsigned int year , month , day , hour , min , sec = 0 ; time_t parsed_atime , parsed_mtime , parsed_ctime ; int tvs [ 2 ] ; for ( i = 2 ; i < cmd -> argc - 4 ; i ++ ) { path = pstrcat ( cmd -> tmp_pool , path , * path ?" " : "" , cmd -> argv [ i ] , NULL ) ; } decoded_path = pr_fs_decode_path2 ( cmd -> tmp_pool , path , FSIO_DECODE_FL_TELL_ERRORS ) ; if ( decoded_path == NULL ) { int xerrno = errno ; pr_log_debug ( DEBUG8 , "'%s' failed to decode properly: %s" , path , strerror ( xerrno ) ) ; pr_response_add_err ( R_550 , _ ( "%s: Illegal character sequence in filename" ) , path ) ; pr_cmd_set_errno ( cmd , xerrno ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } path = dir_canonical_path ( cmd -> tmp_pool , decoded_path ) ; if ( path == NULL ) { int xerrno = EINVAL ; pr_response_add_err ( R_550 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } cmd_name = cmd -> argv [ 0 ] ; cmd -> argv [ 0 ] = "SITE_UTIME" ; if ( ! dir_check_canon ( cmd -> tmp_pool , cmd , G_WRITE , path , NULL ) ) { int xerrno = EPERM ; cmd -> argv [ 0 ] = cmd_name ; pr_log_debug ( DEBUG4 , MOD_SITE_MISC_VERSION ": %s command denied by<Limit>" , ( char * ) cmd -> argv [ 0 ] ) ; pr_response_add_err ( R_550 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } cmd -> argv [ 0 ] = cmd_name ; if ( site_misc_check_filters ( cmd , path ) < 0 ) { int xerrno = EPERM ; pr_response_add_err ( R_550 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } timestamp = cmd -> argv [ cmd -> argc - 4 ] ; timestamp_len = strlen ( timestamp ) ; if ( timestamp_len != 12 && timestamp_len != 14 ) { int xerrno = EINVAL ; pr_log_debug ( DEBUG7 , MOD_SITE_MISC_VERSION ": wrong number of digits in timestamp argument '%s' (%lu)" , timestamp , ( unsigned long ) timestamp_len ) ; pr_response_add_err ( R_500 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } if ( site_misc_parsetime ( timestamp , timestamp_len , & year , & month , & day , & hour , & min , & sec ) < 0 ) { int xerrno = errno ; pr_response_add_err ( R_500 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } parsed_atime = site_misc_mktime ( year , month , day , hour , min , sec ) ; sec = 0 ; timestamp = cmd -> argv [ cmd -> argc - 3 ] ; timestamp_len = strlen ( timestamp ) ; if ( timestamp_len != 12 && timestamp_len != 14 ) { int xerrno = EINVAL ; pr_log_debug ( DEBUG7 , MOD_SITE_MISC_VERSION ": wrong number of digits in timestamp argument '%s' (%lu)" , timestamp , ( unsigned long ) timestamp_len ) ; pr_response_add_err ( R_500 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } if ( site_misc_parsetime ( timestamp , timestamp_len , & year , & month , & day , & hour , & min , & sec ) < 0 ) { int xerrno = errno ; pr_response_add_err ( R_500 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } parsed_mtime = site_misc_mktime ( year , month , day , hour , min , sec ) ; sec = 0 ; timestamp = cmd -> argv [ cmd -> argc - 2 ] ; timestamp_len = strlen ( timestamp ) ; if ( timestamp_len != 12 && timestamp_len != 14 ) { int xerrno = EINVAL ; pr_log_debug ( DEBUG7 , MOD_SITE_MISC_VERSION ": wrong number of digits in timestamp argument '%s' (%lu)" , timestamp , ( unsigned long ) timestamp_len ) ; pr_response_add_err ( R_500 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } if ( site_misc_parsetime ( timestamp , timestamp_len , & year , & month , & day , & hour , & min , & sec ) < 0 ) { int xerrno = errno ; pr_response_add_err ( R_500 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } parsed_ctime = site_misc_mktime ( year , month , day , hour , min , sec ) ; pr_trace_msg ( "command" , 9 , "SITE UTIME command sent ctime timestamp of %lu secs" , ( unsigned long ) parsed_ctime ) ; tvs [ 0 ] . tv_usec = tvs [ 1 ] . tv_usec = 0 ; tvs [ 0 ] . tv_sec = parsed_atime ; tvs [ 1 ] . tv_sec = parsed_mtime ; if ( pr_fsio_utimes_with_root ( path , tvs ) < 0 ) { int xerrno = errno ; pr_log_debug ( DEBUG2 , MOD_SITE_MISC_VERSION ": error modifying timestamps for '%s': %s" , path , strerror ( xerrno ) ) ; pr_response_add_err ( R_550 , "%s: %s" , cmd -> arg , strerror ( xerrno ) ) ; errno = xerrno ; return PR_ERROR ( cmd ) ; } pr_response_add ( R_200 , _ ( "SITE %s command successful" ) , ( char * ) cmd -> argv [ 1 ] ) ; return PR_HANDLED ( cmd ) ; } 