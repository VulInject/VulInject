static void create_unity_domain ( immu_t * immu ) { domain_t * domain ; domain = kmem_zalloc ( sizeof ( domain_t ) , KM_SLEEP ) ; rw_init ( & ( domain -> dom_pgtable_rwlock ) , RW_DEFAULT , NULL ) ; domain -> dom_did = IMMU_UNITY_DID ; domain -> dom_maptype = IMMU_MAPTYPE_UNITY ; domain -> dom_immu = immu ; immu -> immu_unity_domain = domain ; domain -> dom_pgtable_root = pgtable_alloc ( immu , IMMU_FLAGS_SLEEP ) ; pgtable_zero ( domain -> dom_pgtable_root ) ; if ( ! IMMU_ECAP_GET_PT ( immu -> immu_regs_excap ) ) { map_unity_domain ( domain ) ; } mutex_enter ( & ( immu_domain_lock ) ) ; list_insert_tail ( & immu_unity_domain_list , domain ) ; mutex_exit ( & ( immu_domain_lock ) ) ; } 