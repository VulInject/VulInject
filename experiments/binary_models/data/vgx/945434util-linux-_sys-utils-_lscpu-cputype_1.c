static int cpuinfo_parse_cache ( struct lscpu_cxt * cxt , int keynum , char * data ) { struct lscpu_cache * cache ; long long size ; char * p , type ; int level ; unsigned int line_size , associativity ; DBG ( GATHER , ul_debugobj ( cxt , " parse cpuinfo cache '%s'" , data ) ) ; p = strstr ( data , "scope=" ) + 6 ; if ( ! p || strncmp ( p , "Private" , 7 ) == 0 ) { return 0 ; } p = strstr ( data , "level=" ) ; if ( ! p || sscanf ( p , "level=%d" , & level ) != 1 ) { return 0 ; } p = strstr ( data , "type=" ) + 5 ; if ( ! p || ! * p ) { return 0 ; } type = 0 ; if ( strncmp ( p , "Data" , 4 ) == 0 ) { type = 'd' ; } if ( strncmp ( p , "Instruction" , 11 ) == 0 ) { type = 'i' ; } if ( strncmp ( p , "Unified" , 7 ) == 0 ) { type = 'u' ; } p = strstr ( data , "size=" ) ; if ( ! p || sscanf ( p , "size=%lld" , & size ) != 1 ) { return 0 ; } p = strstr ( data , "line_size=" ) ; if ( ! p || sscanf ( p , "line_size=%u" , & line_size ) != 1 ) { return 0 ; } p = strstr ( data , "associativity=" ) ; if ( ! p || sscanf ( p , "associativity=%u" , & associativity ) != 1 ) { return 0 ; } cxt -> necaches ++ ; cxt -> ecaches = xrealloc ( cxt -> ecaches , cxt -> necaches * sizeof ( lscpu_cache ) ) ; cache = & cxt -> ecaches [ cxt -> necaches - 1 ] ; if ( type == 'i' || type == 'd' ) { xasprintf ( & cache -> name , "L%d%c" , level , type ) ; } else { xasprintf ( & cache -> name , "L%d" , level ) ; } cache -> nth = keynum ; cache -> level = level ; cache -> size = size * 1024 ; cache -> ways_of_associativity = associativity ; cache -> coherency_line_size = line_size ; cache -> number_of_sets = line_size ?( cache -> size / line_size ) : 0 ; cache -> number_of_sets = associativity ?( cache -> number_of_sets / associativity ) : 0 ; cache -> type = type == 'i' ?xstrdup ( "Instruction" ) : type == 'd' ?xstrdup ( "Data" ) : type == 'u' ?xstrdup ( "Unified" ) : NULL ; return 1 ; } 