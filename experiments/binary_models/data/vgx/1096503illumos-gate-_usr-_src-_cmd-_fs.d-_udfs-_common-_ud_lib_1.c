static int32_t ud_get_ecma_ver ( ud_handle_t h , uint32_t offset ) { uint8_t * buf ; uint64_t off ; uint64_t end_off ; struct nsr_desc * ndsc ; uint32_t ecma_ver = UD_ECMA_UNKN ; if ( ( buf = ( uint8_t * ) malloc ( UD_VOL_REC_BSZ ) ) == NULL ) { end } off = offset * 2048 + UD_VOL_REC_START ; end_off = offset * 2048 + UD_VOL_REC_END ; for ( ; off < end_off ; off += UD_VOL_REC_BSZ ) { if ( ud_read_dev ( h , off , buf , UD_VOL_REC_BSZ ) == 0 ) { ndsc = ( nsr_desc * ) buf ; if ( ( ndsc -> nsr_str_type == 0 ) && ( ndsc -> nsr_ver == 1 ) && ( ndsc -> nsr_id [ 0 ] == 'N' ) && ( ndsc -> nsr_id [ 1 ] == 'S' ) && ( ndsc -> nsr_id [ 2 ] == 'R' ) && ( ndsc -> nsr_id [ 3 ] == '0' ) && ( ( ndsc -> nsr_id [ 4 ] == '2' ) || ( ndsc -> nsr_id [ 4 ] == '3' ) ) ) { ( void ) strncpy ( ( char * ) h -> udfs . ecma_id , ( char * ) ndsc -> nsr_id , 5 ) ; switch ( ndsc -> nsr_id [ 4 ] ) { case '2' : ecma_ver = UD_ECMA_VER2 ; end case '3' : ecma_ver = UD_ECMA_VER3 ; end } } } } end return ( ecma_ver ) ; } 