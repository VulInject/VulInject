static int max31785_probe ( struct i2c_client * client ) { struct device * dev = & client -> dev ; struct pmbus_driver_info * info ; bool dual_tach = false ; int ret ; if ( ! i2c_check_functionality ( client -> adapter , I2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA ) ) { return - ENODEV ; } info = devm_kzalloc ( dev , sizeof ( pmbus_driver_info ) , GFP_KERNEL ) ; * info = max31785_info ; ret = i2c_smbus_write_byte_data ( client , PMBUS_PAGE , 255 ) ; if ( ret < 0 ) { return ret ; } ret = i2c_smbus_read_word_data ( client , MFR_REVISION ) ; if ( ret < 0 ) { return ret ; } if ( ret == MAX31785A || ret == MAX31785B ) { dual_tach = true ; } if ( ret == MAX31785 ) { if ( ! strcmp ( "max31785a" , client -> name ) || ! strcmp ( "max31785b" , client -> name ) ) { dev_warn ( dev , "Expected max31785a/b, found max31785: cannot provide secondary tachometer readings\n" ) ; } } else { dev_err ( dev , "Unrecognized MAX31785 revision: %x\n" , ret ) ; return - ENODEV ; } if ( dual_tach ) { ret = max31785_configure_dual_tach ( client , info ) ; if ( ret < 0 ) { return ret ; } } return pmbus_do_probe ( client , info ) ; } 