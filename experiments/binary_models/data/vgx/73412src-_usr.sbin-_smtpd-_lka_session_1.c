void lka_session_forward_reply ( struct forward_req * fwreq , int fd ) { struct lka_session * lks ; struct dispatcher * dsp ; struct rule * rule ; struct expandnode * xn ; int ret ; lks = tree_xget ( & sessions , fwreq -> id ) ; xn = lks -> node ; rule = lks -> rule ; lks -> flags &= ~ F_WAITING ; switch ( fwreq -> status ) { case 0 : log_trace ( TRACE_EXPAND , "expand: ~/.forward failed for user %s" , fwreq -> user ) ; lks -> error = LKA_PERMFAIL ; break ; case 1 : if ( fd == - 1 ) { dsp = dict_get ( env -> sc_dispatchers , lks -> rule -> dispatcher ) ; if ( dsp -> u . local . forward_only ) { log_trace ( TRACE_EXPAND , "expand: no .forward " "for user %s on forward-only rule" , fwreq -> user ) ; lks -> error = LKA_TEMPFAIL ; } if ( dsp -> u . local . expand_only ) { log_trace ( TRACE_EXPAND , "expand: no .forward " "for user %s and no default action on rule" , fwreq -> user ) ; lks -> error = LKA_PERMFAIL ; } else { log_trace ( TRACE_EXPAND , "expand: no .forward for " "user %s, just deliver" , fwreq -> user ) ; lka_submit ( lks , rule , xn ) ; } } else { dsp = dict_get ( env -> sc_dispatchers , rule -> dispatcher ) ; lks -> expand . rule = rule ; lks -> expand . parent = xn ; ret = forwards_get ( fd , & lks -> expand ) ; if ( ret == - 1 ) { log_trace ( TRACE_EXPAND , "expand: temporary " "forward error for user %s" , fwreq -> user ) ; lks -> error = LKA_TEMPFAIL ; } if ( ret == 0 ) { if ( dsp -> u . local . forward_only ) { log_trace ( TRACE_EXPAND , "expand: empty .forward " "for user %s on forward-only rule" , fwreq -> user ) ; lks -> error = LKA_TEMPFAIL ; } if ( dsp -> u . local . expand_only ) { log_trace ( TRACE_EXPAND , "expand: empty .forward " "for user %s and no default action on rule" , fwreq -> user ) ; lks -> error = LKA_PERMFAIL ; } else { log_trace ( TRACE_EXPAND , "expand: empty .forward " "for user %s, just deliver" , fwreq -> user ) ; lka_submit ( lks , rule , xn ) ; } } } break ; default : lks -> error = LKA_TEMPFAIL ; } if ( lks -> error == LKA_TEMPFAIL && lks -> errormsg == NULL ) { lks -> errormsg = "424 4.2.4 Mailing list expansion problem" ; } if ( lks -> error == LKA_PERMFAIL && lks -> errormsg == NULL ) { lks -> errormsg = "524 5.2.4 Mailing list expansion problem" ; } lka_resume ( lks , NULL ) ; } 