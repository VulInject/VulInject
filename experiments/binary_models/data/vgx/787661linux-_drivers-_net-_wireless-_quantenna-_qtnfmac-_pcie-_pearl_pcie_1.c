static int qtnf_pcie_pearl_init_xfer ( struct qtnf_pcie_pearl_state * ps , unsigned int tx_bd_size , unsigned int rx_bd_size ) { struct qtnf_pcie_bus_priv * priv = & ps -> base ; int ret ; u32 val ; if ( tx_bd_size == 0 ) { tx_bd_size = PEARL_TX_BD_SIZE_DEFAULT ; } val = tx_bd_size * sizeof ( qtnf_pearl_tx_bd ) ; if ( ! is_power_of_2 ( tx_bd_size ) || val > PCIE_HHBM_MAX_SIZE ) { pr_warn ( "invalid tx_bd_size value %u, use default %u\n" , tx_bd_size , PEARL_TX_BD_SIZE_DEFAULT ) ; priv -> tx_bd_num = PEARL_TX_BD_SIZE_DEFAULT ; } else { priv -> tx_bd_num = tx_bd_size ; } if ( rx_bd_size == 0 ) { rx_bd_size = PEARL_RX_BD_SIZE_DEFAULT ; } val = rx_bd_size * sizeof ( dma_addr_t ) ; if ( ! is_power_of_2 ( rx_bd_size ) || val > PCIE_HHBM_MAX_SIZE ) { pr_warn ( "invalid rx_bd_size value %u, use default %u\n" , rx_bd_size , PEARL_RX_BD_SIZE_DEFAULT ) ; priv -> rx_bd_num = PEARL_RX_BD_SIZE_DEFAULT ; } else { priv -> rx_bd_num = rx_bd_size ; } priv -> rx_bd_r_index = 0 ; ret = pearl_hhbm_init ( ps ) ; if ( ret ) { pr_err ( "failed to init h/w queues\n" ) ; return ret ; } ret = qtnf_pcie_alloc_skb_array ( priv ) ; if ( ret ) { pr_err ( "failed to allocate skb array\n" ) ; return ret ; } ret = pearl_alloc_bd_table ( ps ) ; if ( ret ) { pr_err ( "failed to allocate bd table\n" ) ; return ret ; } ret = pearl_alloc_rx_buffers ( ps ) ; if ( ret ) { pr_err ( "failed to allocate rx buffers\n" ) ; return ret ; } return ret ; } 