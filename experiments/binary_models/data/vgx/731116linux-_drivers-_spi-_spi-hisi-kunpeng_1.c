static int hisi_spi_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct spi_controller * master ; struct hisi_spi * hs ; int ret , irq ; irq = platform_get_irq ( pdev , 0 ) ; if ( irq < 0 ) { return irq ; } master = devm_spi_alloc_master ( dev , sizeof ( * hs ) ) ; platform_set_drvdata ( pdev , master ) ; hs = spi_controller_get_devdata ( master ) ; hs -> dev = dev ; hs -> irq = irq ; hs -> regs = devm_platform_ioremap_resource ( pdev , 0 ) ; if ( IS_ERR ( hs -> regs ) ) { return PTR_ERR ( hs -> regs ) ; } ret = device_property_read_u32 ( dev , "spi-max-frequency" , & master -> max_speed_hz ) ; if ( ret ) { dev_err ( dev , "failed to get max SPI clocking speed, ret=%d\n" , ret ) ; return - EINVAL ; } ret = device_property_read_u16 ( dev , "num-cs" , & master -> num_chipselect ) ; if ( ret ) { master -> num_chipselect = DEFAULT_NUM_CS ; } master -> use_gpio_descriptors = true ; master -> mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH | SPI_LOOP ; master -> bits_per_word_mask = SPI_BPW_RANGE_MASK ( 4 , 32 ) ; master -> bus_num = pdev -> id ; master -> setup = hisi_spi_setup ; master -> cleanup = hisi_spi_cleanup ; master -> transfer_one = hisi_spi_transfer_one ; master -> handle_err = hisi_spi_handle_err ; master -> dev . fwnode = dev -> fwnode ; hisi_spi_hw_init ( hs ) ; ret = devm_request_irq ( dev , hs -> irq , hisi_spi_irq , 0 , dev_name ( dev ) , master ) ; if ( ret < 0 ) { dev_err ( dev , "failed to get IRQ=%d, ret=%d\n" , hs -> irq , ret ) ; return ret ; } ret = spi_register_controller ( master ) ; if ( ret ) { dev_err ( dev , "failed to register spi master, ret=%d\n" , ret ) ; return ret ; } if ( hisi_spi_debugfs_init ( hs ) ) { dev_info ( dev , "failed to create debugfs dir\n" ) ; } dev_info ( dev , "hw version:0x%x max-freq:%u kHz\n" , readl ( hs -> regs + HISI_SPI_VERSION ) , master -> max_speed_hz / 1000 ) ; return 0 ; } 