static void qede_ptp_task ( struct work_struct * work ) { struct skb_shared_hwtstamps shhwtstamps ; struct qede_dev * edev ; struct qede_ptp * ptp ; u64 timestamp , ns ; int rc ; ptp = container_of ( work , qede_ptp , work ) ; edev = ptp -> edev ; spin_lock_bh ( & ptp -> lock ) ; rc = ptp -> ops -> read_tx_ts ( edev -> cdev , & timestamp ) ; spin_unlock_bh ( & ptp -> lock ) ; if ( rc ) { schedule_work ( & ptp -> work ) ; return ; } ns = timecounter_cyc2time ( & ptp -> tc , timestamp ) ; shhwtstamps . hwtstamp = ns_to_ktime ( ns ) ; skb_tstamp_tx ( ptp -> tx_skb , & shhwtstamps ) ; dev_kfree_skb_any ( ptp -> tx_skb ) ; ptp -> tx_skb = NULL ; clear_bit_unlock ( QEDE_FLAGS_PTP_TX_IN_PRORGESS , & edev -> flags ) ; DP_VERBOSE ( edev , QED_MSG_DEBUG , "Tx timestamp, timestamp cycles = %llu, ns = %llu\n" , timestamp , ns ) ; } 