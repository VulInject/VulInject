struct mlx5_hairpin * mlx5_core_hairpin_create ( struct mlx5_core_dev * func_mdev , struct mlx5_core_dev * peer_mdev , struct mlx5_hairpin_params * params ) { struct mlx5_hairpin * hp ; int size , err ; size = sizeof ( * hp ) + params -> num_channels * 2 * sizeof ( u32 ) ; hp = kzalloc ( size , GFP_KERNEL ) ; hp -> func_mdev = func_mdev ; hp -> peer_mdev = peer_mdev ; hp -> num_channels = params -> num_channels ; hp -> rqn = ( void * ) hp + sizeof ( * hp ) ; hp -> sqn = hp -> rqn + params -> num_channels ; err = mlx5_hairpin_create_queues ( hp , params ) ; if ( err ) { err_create_queues } err = mlx5_hairpin_pair_queues ( hp ) ; if ( err ) { err_pair_queues } return hp ; err_pair_queues mlx5_hairpin_destroy_queues ( hp ) ; err_create_queues kfree ( hp ) ; return ERR_PTR ( err ) ; } 