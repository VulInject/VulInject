static int pxa_ep_set_halt ( struct usb_ep * _ep , int value ) { struct pxa_ep * ep ; struct udc_usb_ep * udc_usb_ep ; unsigned long flags ; int rc ; if ( ! _ep ) { return - EINVAL ; } udc_usb_ep = container_of ( _ep , udc_usb_ep , usb_ep ) ; ep = udc_usb_ep -> pxa_ep ; if ( value == 0 ) { ep_dbg ( ep , "only host can clear halt\n" ) ; return - EROFS ; } spin_lock_irqsave ( & ep -> lock , flags ) ; rc = - EAGAIN ; if ( ep -> dir_in && ( ep_is_full ( ep ) || ! list_empty ( & ep -> queue ) ) ) { out } rc = 0 ; ep_write_UDCCSR ( ep , UDCCSR_FST | UDCCSR_FEF ) ; if ( is_ep0 ( ep ) ) { set_ep0state ( ep -> dev , STALL ) ; } out spin_unlock_irqrestore ( & ep -> lock , flags ) ; return rc ; } 