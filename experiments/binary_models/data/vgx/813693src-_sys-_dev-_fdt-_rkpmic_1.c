int rkpmic_set_voltage ( void * cookie , uint32_t voltage ) { struct rkpmic_regulator * rr = cookie ; const struct rkpmic_vsel_range * vsel_range = rr -> rr_vsel_range ; uint32_t vmin , vmax , volt ; uint8_t reg , vsel ; while ( vsel_range -> base ) { vmin = vsel_range -> base ; vmax = vmin + ( vsel_range -> vsel_max - vsel_range -> vsel_min ) * vsel_range -> delta ; if ( voltage <= vmax ) { vsel = vsel_range -> vsel_min ; volt = vsel_range -> base ; while ( vsel <= vsel_range -> vsel_max ) { if ( volt == voltage ) { break ; } else { vsel ++ ; volt += vsel_range -> delta ; } } if ( volt != voltage ) { return EINVAL ; } break ; } vsel_range ++ ; } if ( vsel_range -> base == 0 ) { return EINVAL ; } reg = rkpmic_reg_read ( rr -> rr_sc , rr -> rr_reg ) ; reg &= ~ rr -> rr_mask ; reg |= vsel ; rkpmic_reg_write ( rr -> rr_sc , rr -> rr_reg , reg ) ; return 0 ; } 