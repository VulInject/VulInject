int parse_config_lines ( void ) { char * p , * start ; int i , k , step ; int mdm_nr , net_nr ; nr_of_networks = 0 ; nr_of_modems = 0 ; step = 1 ; if ( ( p = modems_config ) == 0 ) { LM_ERR ( "param \"modems\" not found\n" ) ; error } while ( * p ) { eat_spaces ( p , NULL ) ; start = p ; while ( * p != ' ' && * p != '\t' && * p != '[' && * p != 0 ) { p ++ ; } if ( p == start || * p == 0 ) { parse_error } memcpy ( modems [ nr_of_modems ] . name , start , p - start ) ; modems [ nr_of_modems ] . name [ p - start ] = 0 ; modems [ nr_of_modems ] . smsc [ 0 ] = 0 ; modems [ nr_of_modems ] . device [ 0 ] = 0 ; modems [ nr_of_modems ] . pin [ 0 ] = 0 ; modems [ nr_of_modems ] . mode = MODE_NEW ; modems [ nr_of_modems ] . retry = 4 ; modems [ nr_of_modems ] . looping_interval = 20 ; modems [ nr_of_modems ] . baudrate = B9600 ; modems [ nr_of_modems ] . scan = SMS_BODY_SCAN ; modems [ nr_of_modems ] . to [ 0 ] = 0 ; memset ( modems [ nr_of_modems ] . net_list , 0XFF , sizeof ( modems [ nr_of_modems ] . net_list ) ) ; eat_spaces ( p ) ; if ( * p != '[' ) { parse_error } p ++ ; while ( * p != ']' ) { eat_spaces ( p ) ; start = p ; while ( * p != ' ' && * p != '\t' && * p != ']' && * p != ';' && * p != 0 ) { p ++ ; } if ( p == start || * p == 0 ) { parse_error } if ( set_modem_arg ( & ( modems [ nr_of_modems ] ) , start , p ) == - 1 ) { error } eat_spaces ( p ) ; if ( * p == ';' ) { p ++ ; eat_spaces ( p ) ; } } if ( * p != ']' ) { parse_error } p ++ ; if ( modems [ nr_of_modems ] . device [ 0 ] == 0 ) { LM_ERR ( "modem %s has no device associated\n" , modems [ nr_of_modems ] . name ) ; error } if ( modems [ nr_of_modems ] . smsc [ 0 ] == 0 ) { LM_WARN ( "modem %s has no sms center associated ->using" " the default one from modem\n" , modems [ nr_of_modems ] . name ) ; } nr_of_modems ++ ; eat_spaces ( p ) ; if ( * p == ';' ) { p ++ ; eat_spaces ( p ) ; } } if ( nr_of_modems == 0 ) { LM_ERR ( "failed to parse config modems - no modem found!\n" ) ; error } step ++ ; if ( ( p = networks_config ) == 0 ) { LM_ERR ( "param \"networks\" not found\n" ) ; error } while ( * p ) { eat_spaces ( p ) ; start = p ; while ( * p != ' ' && * p != '\t' && * p != '[' && * p != 0 ) { p ++ ; } if ( p == start || * p == 0 ) { parse_error } memcpy ( networks [ nr_of_networks ] . name , start , p - start ) ; networks [ nr_of_networks ] . name [ p - start ] = 0 ; networks [ nr_of_networks ] . max_sms_per_call = 10 ; eat_spaces ( p ) ; if ( * p != '[' ) { parse_error } p ++ ; while ( * p != ']' ) { eat_spaces ( p ) ; start = p ; while ( * p != ' ' && * p != '\t' && * p != ']' && * p != ';' && * p != 0 ) { p ++ ; } if ( p == start || * p == 0 ) { parse_error } if ( set_network_arg ( & ( networks [ nr_of_networks ] ) , start , p ) == - 1 ) { error } eat_spaces ( p ) ; if ( * p == ';' ) { p ++ ; eat_spaces ( p ) ; } } if ( * p != ']' ) { parse_error } p ++ ; nr_of_networks ++ ; eat_spaces ( p ) ; if ( * p == ';' ) { p ++ ; } eat_spaces ( p ) ; } if ( nr_of_networks == 0 ) { LM_ERR ( "no network found!\n" ) ; error } step ++ ; if ( ( p = links_config ) == 0 ) { LM_ERR ( "param \"links\" not found\n" ) ; error } while ( * p ) { eat_spaces ( p ) ; start = p ; while ( * p != ' ' && * p != '\t' && * p != '[' && * p != 0 ) { p ++ ; } if ( p == start || * p == 0 ) { parse_error } for ( mdm_nr = - 1 , i = 0 ; i < nr_of_modems && mdm_nr == - 1 ; i ++ ) { if ( ! strncasecmp ( modems [ i ] . name , start , p - start ) && modems [ i ] . name [ p - start ] == 0 ) { mdm_nr = i ; } } if ( mdm_nr == - 1 ) { LM_ERR ( "unknown modem %.*s \n," , ( int ) ( p - start ) , start ) ; error } eat_spaces ( p ) ; if ( * p != '[' ) { parse_error } p ++ ; k = 0 ; while ( * p != ']' ) { eat_spaces ( p ) ; start = p ; while ( * p != ' ' && * p != '\t' && * p != ']' && * p != ';' && * p != 0 ) { p ++ ; } if ( p == start || * p == 0 ) { parse_error } for ( net_nr = - 1 , i = 0 ; i < nr_of_networks && net_nr == - 1 ; i ++ ) { if ( ! strncasecmp ( networks [ i ] . name , start , p - start ) && networks [ i ] . name [ p - start ] == 0 ) { net_nr = i ; } } if ( net_nr == - 1 ) { LM_ERR ( "associated net<%.*s>not found in net list\n" , ( int ) ( p - start ) , start ) ; error } LM_DBG ( "linking net \"%s\" to modem \"%s\" on pos %d.\n" , networks [ net_nr ] . name , modems [ mdm_nr ] . name , k ) ; modems [ mdm_nr ] . net_list [ k ++ ] = net_nr ; eat_spaces ( p ) ; if ( * p == ';' ) { p ++ ; eat_spaces ( p ) ; } } if ( * p != ']' ) { parse_error } p ++ ; eat_spaces ( p ) ; if ( * p == ';' ) { p ++ ; eat_spaces ( p ) ; } } if ( default_net_str ) { for ( net_nr = - 1 , i = 0 ; i < nr_of_networks && net_nr == - 1 ; i ++ ) { if ( ! strcasecmp ( networks [ i ] . name , default_net_str ) ) { net_nr = i ; } } if ( net_nr == - 1 ) { LM_ERR ( "network \"%s\" not found in net list!\n" , default_net_str ) ; error } default_net = net_nr ; } return 0 ; parse_error LM_ERR ( "SMS %s config: parse error before  chr %d [%.*s]\n" , ( step == 1 ) ?"modems" : ( step == 2 ?"networks" : "links" ) , ( int ) ( p - ( ( step == 1 ) ?modems_config : ( step == 2 ?networks_config : links_config ) ) ) , ( * p == 0 ) ?4 : 1 , ( * p == 0 ) ?"NULL" : p ) ; error return - 1 ; } 