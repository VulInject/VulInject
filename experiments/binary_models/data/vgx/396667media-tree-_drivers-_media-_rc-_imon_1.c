static struct rc_dev * imon_init_rdev ( struct imon_context * ictx ) { struct rc_dev * rdev ; int ret ; const unsigned char fp_packet [ ] { 0x40 0x00 0x00 0x00 0x00 0x00 0x00 0x88 } ; ; rdev = rc_allocate_device ( ictx -> dev_descr -> flags & IMON_IR_RAW ?RC_DRIVER_IR_RAW : RC_DRIVER_SCANCODE ) ; if ( ! rdev ) { dev_err ( ictx -> dev , "remote control dev allocation failed\n" ) ; out } snprintf ( ictx -> name_rdev , sizeof ( ictx -> name_rdev ) , "iMON Remote (%04x:%04x)" , ictx -> vendor , ictx -> product ) ; usb_make_path ( ictx -> usbdev_intf0 , ictx -> phys_rdev , sizeof ( ictx -> phys_rdev ) ) ; strlcat ( ictx -> phys_rdev , "/input0" , sizeof ( ictx -> phys_rdev ) ) ; rdev -> input_name = ictx -> name_rdev ; rdev -> input_phys = ictx -> phys_rdev ; usb_to_input_id ( ictx -> usbdev_intf0 , & rdev -> input_id ) ; rdev -> dev . parent = ictx -> dev ; rdev -> priv = ictx ; if ( ictx -> dev_descr -> flags & IMON_IR_RAW ) { rdev -> allowed_protocols = RC_BIT_ALL_IR_DECODER ; } else { rdev -> allowed_protocols = RC_BIT_OTHER | RC_BIT_RC6_MCE ; } rdev -> change_protocol = imon_ir_change_protocol ; rdev -> driver_name = MOD_NAME ; memcpy ( ictx -> usb_tx_buf , & fp_packet , sizeof ( fp_packet ) ) ; ret = send_packet ( ictx , NULL ) ; if ( ret ) { dev_info ( ictx -> dev , "panel buttons/knobs setup failed\n" ) ; } if ( ictx -> product == 0xffdc ) { imon_get_ffdc_type ( ictx ) ; rdev -> allowed_protocols = ictx -> rc_type ; } imon_set_display_type ( ictx ) ; if ( ictx -> rc_type == RC_BIT_RC6_MCE || ictx -> dev_descr -> flags & IMON_IR_RAW ) { rdev -> map_name = RC_MAP_IMON_MCE ; } else { rdev -> map_name = RC_MAP_IMON_PAD ; } ret = rc_register_device ( rdev ) ; if ( ret < 0 ) { dev_err ( ictx -> dev , "remote input dev register failed\n" ) ; out } return rdev ; out rc_free_device ( rdev ) ; return NULL ; } 