void rtwn_efuse_read ( struct rtwn_softc * sc , uint8_t * rom , size_t size ) { uint8_t off , msk , tmp ; uint16_t addr = 0 ; uint32_t reg ; int i , len ; if ( ! ( sc -> chip & ( RTWN_CHIP_92C | RTWN_CHIP_88C ) ) ) { rtwn_write_1 ( sc , R92C_EFUSE_ACCESS , R92C_EFUSE_ACCESS_ON ) ; } rtwn_efuse_switch_power ( sc ) ; len = ( sc -> chip & RTWN_CHIP_88E ) ?256 : 512 ; while ( addr < len ) { reg = rtwn_efuse_read_1 ( sc , addr ) ; if ( reg == 0xff ) { break ; } addr ++ ; if ( ( sc -> sc_flags & RTWN_FLAG_EXT_HDR ) && ( reg & 0x1f ) == 0x0f ) { tmp = ( reg & 0xe0 ) >> 5 ; reg = rtwn_efuse_read_1 ( sc , addr ) ; addr ++ ; if ( ( reg & 0x0f ) != 0x0f ) { off = ( ( reg & 0xf0 ) >> 1 ) | tmp ; } else { continue ; } } else { off = reg >> 4 ; } msk = reg & 0xf ; for ( i = 0 ; i < 4 ; i ++ ) { if ( msk & ( 1 << i ) ) { continue ; } rom [ off * 8 + i * 2 + 0 ] = rtwn_efuse_read_1 ( sc , addr ) ; addr ++ ; rom [ off * 8 + i * 2 + 1 ] = rtwn_efuse_read_1 ( sc , addr ) ; addr ++ ; } } if ( rtwn_debug >= 2 ) { printf ( "\n" ) ; for ( i = 0 ; i < size ; i ++ ) { printf ( "%02x:" , rom [ i ] ) ; } printf ( "\n" ) ; } if ( ! ( sc -> chip & ( RTWN_CHIP_92C | RTWN_CHIP_88C ) ) ) { rtwn_write_1 ( sc , R92C_EFUSE_ACCESS , R92C_EFUSE_ACCESS_OFF ) ; } } 