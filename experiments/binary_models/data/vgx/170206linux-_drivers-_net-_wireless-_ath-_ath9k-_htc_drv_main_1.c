void ath9k_htc_reset ( struct ath9k_htc_priv * priv ) { struct ath_hw * ah = priv -> ah ; struct ath_common * common = ath9k_hw_common ( ah ) ; struct ieee80211_channel * channel = priv -> hw -> conf . chandef . chan ; struct ath9k_hw_cal_data * caldata = NULL ; enum htc_phymode mode ; __be16 htc_mode ; u8 cmd_rsp ; int ret ; ath9k_htc_ps_wakeup ( priv ) ; ath9k_htc_stop_ani ( priv ) ; ieee80211_stop_queues ( priv -> hw ) ; del_timer_sync ( & priv -> tx . cleanup_timer ) ; ath9k_htc_tx_drain ( priv ) ; WMI_CMD ( WMI_DISABLE_INTR_CMDID ) ; WMI_CMD ( WMI_DRAIN_TXQ_ALL_CMDID ) ; WMI_CMD ( WMI_STOP_RECV_CMDID ) ; ath9k_wmi_event_drain ( priv ) ; caldata = & priv -> caldata ; ret = ath9k_hw_reset ( ah , ah -> curchan , caldata , false ) ; if ( ret ) { ath_err ( common , "Unable to reset device (%u Mhz) reset status %d\n" , channel -> center_freq , ret ) ; } ath9k_cmn_update_txpow ( ah , priv -> curtxpow , priv -> txpowlimit , & priv -> curtxpow ) ; WMI_CMD ( WMI_START_RECV_CMDID ) ; ath9k_host_rx_init ( priv ) ; mode = ath9k_htc_get_curmode ( priv , ah -> curchan ) ; htc_mode = cpu_to_be16 ( mode ) ; WMI_CMD_BUF ( WMI_SET_MODE_CMDID , & htc_mode ) ; WMI_CMD ( WMI_ENABLE_INTR_CMDID ) ; htc_start ( priv -> htc ) ; ath9k_htc_vif_reconfig ( priv ) ; ieee80211_wake_queues ( priv -> hw ) ; mod_timer ( & priv -> tx . cleanup_timer , jiffies + msecs_to_jiffies ( ATH9K_HTC_TX_CLEANUP_INTERVAL ) ) ; ath9k_htc_ps_restore ( priv ) ; mutex_unlock ( & priv -> mutex ) ; } 