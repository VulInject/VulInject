static void get_domtext_width ( GF_Node * node , SVGAllAttributes * atts , GF_TraverseState * tr_state ) { u32 i ; GF_Font * font ; Fixed block_width , * entry ; GF_FontManager * fm ; GF_TextSpan * span ; GF_DOMText * dom_text = ( GF_DOMText * ) node ; if ( ! dom_text -> textContent ) { return ; } fm = tr_state -> visual -> compositor -> font_manager ; font = svg_set_font ( tr_state , fm ) ; if ( ! font ) { return ; } span = svg_get_text_span ( fm , font , tr_state -> svg_props -> font_size -> value , ( tr_state -> count_x > 1 ) , ( tr_state -> count_y > 1 ) , GF_FALSE , atts , dom_text -> textContent , atts -> xml_lang ?* atts -> xml_lang : NULL , tr_state ) ; if ( ! span ) { return ; } i = 0 ; while ( ( i < span -> nb_glyphs ) && ( ( tr_state -> count_x > 1 ) || ( tr_state -> count_y > 1 ) ) ) { block_width = ( span -> glyphs [ i ] ?span -> glyphs [ i ] -> horiz_advance : font -> max_advance_h ) * span -> font_scale ; entry = ( Fixed * ) gf_malloc ( sizeof ( Fixed ) ) ; if ( span -> flags & GF_TEXT_SPAN_RIGHT_TO_LEFT ) { * entry = - block_width ; } else { * entry = block_width ; } gf_list_add ( tr_state -> x_anchors , entry ) ; if ( tr_state -> count_x > 0 ) { tr_state -> count_x -- ; } if ( tr_state -> count_y > 0 ) { tr_state -> count_y -- ; } i ++ ; } if ( i < span -> nb_glyphs ) { block_width = 0 ; while ( i < span -> nb_glyphs ) { block_width += ( span -> glyphs [ i ] ?span -> glyphs [ i ] -> horiz_advance : font -> max_advance_h ) * span -> font_scale ; i ++ ; } if ( ( tr_state -> count_x == 1 ) || ( tr_state -> count_y == 1 ) || ! gf_list_count ( tr_state -> x_anchors ) ) { entry = ( Fixed * ) gf_malloc ( sizeof ( Fixed ) ) ; if ( span -> flags & GF_TEXT_SPAN_RIGHT_TO_LEFT ) { * entry = - block_width ; } else { * entry = block_width ; } gf_list_add ( tr_state -> x_anchors , entry ) ; } else { Fixed * prec_lw = gf_list_last ( tr_state -> x_anchors ) ; ( * prec_lw ) += block_width ; } if ( tr_state -> count_x == 1 ) { tr_state -> count_x = 0 ; } if ( tr_state -> count_y == 1 ) { tr_state -> count_y = 0 ; } } gf_font_manager_delete_span ( fm , span ) ; } 