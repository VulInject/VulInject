void _zfs_diagnosis_init ( fmd_hdl_t * hdl ) { libzfs_handle_t * zhdl ; if ( ( zhdl = __libzfs_init ( ) ) == NULL ) { return ; } if ( ( zfs_case_pool = uu_list_pool_create ( "zfs_case_pool" , sizeof ( zfs_case_t ) , offsetof ( zfs_case_t , zc_node ) , NULL , UU_LIST_POOL_DEBUG ) ) == NULL ) { __libzfs_fini ( zhdl , NULL ) ; return ; } if ( ( zfs_cases = uu_list_create ( zfs_case_pool , NULL , UU_LIST_DEBUG ) ) == NULL ) { uu_list_pool_destroy ( zfs_case_pool ) ; __libzfs_fini ( zhdl ) ; return ; } if ( fmd_hdl_register ( hdl , FMD_API_VERSION , & fmd_info ) != 0 ) { uu_list_destroy ( zfs_cases ) ; uu_list_pool_destroy ( zfs_case_pool ) ; __libzfs_fini ( zhdl ) ; return ; } fmd_hdl_setspecific ( hdl , zhdl ) ; ( void ) fmd_stat_create ( hdl , FMD_STAT_NOALLOC , sizeof ( zfs_stats ) / sizeof ( fmd_stat_t ) , ( fmd_stat_t * ) & zfs_stats ) ; zfs_remove_timeout = fmd_prop_get_int64 ( hdl , "remove_timeout" ) ; } 