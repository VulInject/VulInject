void window_copy_vadd ( struct window_pane * wp , int parse , const char * fmt , va_list ap ) { struct window_mode_entry * wme = TAILQ_FIRST ( & wp -> modes ) ; struct window_copy_mode_data * data = wme -> data ; struct screen * backing = data -> backing ; struct screen * writing = data -> writing ; struct screen_write_ctx writing_ctx , backing_ctx , ctx ; struct grid_cell gc ; u_int old_hsize , old_cy ; u_int sx = screen_size_x ( backing ) ; char * text ; if ( parse ) { vasprintf ( & text , fmt , ap ) ; screen_write_start ( & writing_ctx , writing ) ; screen_write_reset ( & writing_ctx ) ; input_parse_screen ( data -> ictx , writing , window_copy_init_ctx_cb , data , text , strlen ( text ) ) ; } old_hsize = screen_hsize ( data -> backing ) ; screen_write_start ( & backing_ctx , backing ) ; if ( data -> backing_written ) { screen_write_carriagereturn ( & backing_ctx ) ; screen_write_linefeed ( & backing_ctx , 0 , 8 ) ; } else { data -> backing_written = 1 ; } old_cy = backing -> cy ; if ( parse ) { screen_write_fast_copy ( & backing_ctx , writing , 0 , 0 , sx , 1 ) ; } else { memcpy ( & gc , & grid_default_cell , sizeof gc ) ; screen_write_vnputs ( & backing_ctx , 0 , & gc , fmt , ap ) ; } screen_write_stop ( & backing_ctx ) ; data -> oy += screen_hsize ( data -> backing ) - old_hsize ; screen_write_start_pane ( & ctx , wp , & data -> screen ) ; if ( screen_hsize ( data -> backing ) ) { window_copy_redraw_lines ( wme , 0 , 1 ) ; } window_copy_redraw_lines ( wme , old_cy , backing -> cy - old_cy + 1 ) ; screen_write_stop ( & ctx ) ; } 