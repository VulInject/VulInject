static int odroid_card_hw_params ( struct snd_pcm_substream * substream , struct snd_pcm_hw_params * params ) { struct snd_soc_pcm_runtime * rtd = substream -> private_data ; struct odroid_priv * priv = snd_soc_card_get_drvdata ( rtd -> card ) ; unsigned int pll_freq , rclk_freq ; int ret ; switch ( params_rate ( params ) ) { case 32000 : case 64000 : pll_freq = 131072000U ; break ; case 44100 : case 88200 : case 176400 : pll_freq = 180633600U ; break ; case 48000 : case 96000 : case 192000 : pll_freq = 196608000U ; break ; default : return - EINVAL ; } ret = clk_set_rate ( priv -> pll , pll_freq + 1 ) ; rclk_freq = params_rate ( params ) * 256 * 4 ; ret = clk_set_rate ( priv -> rclk , rclk_freq ) ; if ( ret < 0 ) { return ret ; } if ( rtd -> num_codecs > 1 ) { struct snd_soc_dai * codec_dai = rtd -> codec_dais [ 1 ] ; ret = snd_soc_dai_set_sysclk ( codec_dai , 0 , rclk_freq , SND_SOC_CLOCK_IN ) ; if ( ret < 0 ) { return ret ; } } return 0 ; } 