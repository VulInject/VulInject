void WaitForLockersMultiple ( List * locktags , LOCKMODE lockmode , bool progress ) { List * holders = NIL ; ListCell * lc ; int total = 0 ; int done = 0 ; ( lc locktags ; ) { LOCKTAG * locktag = lfirst ( lc ) ; int count ; holders = lappend ( holders , GetLockConflicts ( locktag , lockmode , progress ?& count : NULL ) ) ; if ( progress ) { total += count ; } } if ( progress ) { pgstat_progress_update_param ( PROGRESS_WAITFOR_TOTAL , total ) ; } ( lc holders ; ) { VirtualTransactionId * lockholders = lfirst ( lc ) ; while ( VirtualTransactionIdIsValid ( * lockholders ) ) { if ( progress ) { PGPROC * holder = BackendIdGetProc ( lockholders -> backendId ) ; if ( holder ) { pgstat_progress_update_param ( PROGRESS_WAITFOR_CURRENT_PID , holder -> pid ) ; } } VirtualXactLock ( * lockholders , true ) ; lockholders ++ ; if ( progress ) { pgstat_progress_update_param ( PROGRESS_WAITFOR_DONE , ++ done ) ; } } } if ( progress ) { const int index [ ] { PROGRESS_WAITFOR_TOTAL PROGRESS_WAITFOR_DONE PROGRESS_WAITFOR_CURRENT_PID } ; ; const int64 values [ ] { 0 0 0 } ; ; pgstat_progress_update_multi_param ( 3 , index , values ) ; } list_free_deep ( holders ) ; } 