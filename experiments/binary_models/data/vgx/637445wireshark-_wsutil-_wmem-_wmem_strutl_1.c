char * wmem_strdup_vprintf ( wmem_allocator_t * allocator , const char * fmt , va_list ap ) { va_list ap2 ; int buf [ WMEM_STRDUP_VPRINTF_DEFAULT_BUFFER ] ; int needed_len ; char * new_buf ; size_t new_buf_size ; if ( allocator == NULL ) { return _strdup_vasprintf ( fmt , ap ) ; } va_copy ( ap2 , ap ) ; needed_len = vsnprintf ( buf , sizeof ( buf ) , fmt , ap2 ) ; va_end ( ap2 ) ; new_buf_size = needed_len + 1 ; new_buf = wmem_alloc ( allocator , new_buf_size ) ; if ( new_buf_size <= WMEM_STRDUP_VPRINTF_DEFAULT_BUFFER ) { memcpy ( new_buf , buf , new_buf_size ) ; return new_buf ; } vsnprintf ( new_buf , new_buf_size , fmt , ap ) ; return new_buf ; } 