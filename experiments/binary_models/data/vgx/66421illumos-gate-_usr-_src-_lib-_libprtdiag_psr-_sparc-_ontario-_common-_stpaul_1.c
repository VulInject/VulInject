int stpaul_pci_callback ( picl_nodehdl_t pcih , void * args ) { int err = PICL_SUCCESS ; picl_nodehdl_t nodeh ; char path [ MAXSTRLEN ] ; char parent_path [ MAXSTRLEN ] ; char piclclass [ PICL_CLASSNAMELEN_MAX ] ; char name [ MAXSTRLEN ] ; char model [ MAXSTRLEN ] ; char * compatible ; char binding_name [ MAXSTRLEN ] ; struct io_card pci_card ; int32_t instance ; char pn_type ; err = picl_get_propval_by_name ( pcih , PICL_PROP_DEVFS_PATH , parent_path , sizeof ( parent_path ) ) ; if ( err != PICL_SUCCESS ) { return ( err ) ; } err = picl_get_propval_by_name ( pcih , PICL_PROP_CHILD , & nodeh , sizeof ( picl_nodehdl_t ) ) ; while ( err == PICL_SUCCESS ) { err = picl_get_propval_by_name ( nodeh , PICL_PROP_CLASSNAME , piclclass , sizeof ( piclclass ) ) ; if ( err != PICL_SUCCESS ) { return ( err ) ; } if ( strcmp ( piclclass , PICL_CLASS_PCIEX ) == 0 ) { err = picl_get_propval_by_name ( nodeh , PICL_PROP_PEER , & nodeh , sizeof ( picl_nodehdl_t ) ) ; continue ; } if ( strcmp ( piclclass , PICL_CLASS_PCI ) == 0 ) { err = picl_get_propval_by_name ( nodeh , PICL_PROP_CHILD , & nodeh , sizeof ( picl_nodehdl_t ) ) ; continue ; } err = picl_get_propval_by_name ( nodeh , PICL_PROP_DEVFS_PATH , path , sizeof ( path ) ) ; if ( err != PICL_SUCCESS ) { return ( err ) ; } ( void ) strlcpy ( pci_card . notes , path , sizeof ( pci_card . notes ) ) ; get_bus_type ( path , & pci_card ) ; get_slot_number ( path , & pci_card ) ; err = picl_get_propval_by_name ( nodeh , PICL_PROP_NAME , & name , sizeof ( name ) ) ; if ( err == PICL_PROPNOTFOUND ) { ( void ) strlcpy ( name , "" , sizeof ( name ) ) ; } if ( err != PICL_SUCCESS ) { return ( err ) ; } if ( ( strcmp ( name , NETWORK ) == 0 ) && ( strcmp ( pci_card . slot_str , MOTHERBOARD ) == 0 ) ) { instance = stpaul_get_network_instance ( path ) ; ( void ) snprintf ( pci_card . status , sizeof ( pci_card . status ) , "%s/%s%d" , MOTHERBOARD , "NET" , instance ) ; } if ( ( strcmp ( name , SCSI ) == 0 ) && ( strcmp ( pci_card . slot_str , MOTHERBOARD ) == 0 ) ) { ( void ) snprintf ( pci_card . status , sizeof ( pci_card . status ) , "%s/%s" , MOTHERBOARD , SPL_SCSI_TAG ) ; } else { if ( pci_card . slot != - 1 ) { ( void ) snprintf ( pci_card . status , sizeof ( pci_card . status ) , "%s/%s%d" , MOTHERBOARD , pci_card . bus_type , pci_card . slot ) ; } else { ( void ) snprintf ( pci_card . status , sizeof ( pci_card . status ) , "%s/%s" , MOTHERBOARD , pci_card . bus_type ) ; } } if ( strncmp ( name , USB , strlen ( USB ) ) == 0 ) { instance = stpaul_get_usb_instance ( path ) ; if ( instance != - 1 ) { ( void ) snprintf ( pci_card . status , sizeof ( pci_card . status ) , "%s/%s%d" , MOTHERBOARD , "USB" , instance ) ; } } if ( ( instance = stpaul_get_io_instance ( path , & pn_type ) ) != - 1 ) { if ( pn_type == SPL_PEM_TYPE ) { ( void ) snprintf ( pci_card . status , sizeof ( pci_card . status ) , "%s/%s%d" , MOTHERBOARD , "PCI-EM" , instance ) ; } if ( pn_type == SPL_NEM_TYPE ) { ( void ) snprintf ( pci_card . status , sizeof ( pci_card . status ) , "%s/%s%d" , MOTHERBOARD , "NEM" , instance ) ; } } err = picl_get_propval_by_name ( nodeh , PICL_PROP_BINDING_NAME , & binding_name , sizeof ( binding_name ) ) ; if ( err == PICL_PROPNOTFOUND ) { err = stpaul_get_first_compatible_value ( nodeh , & compatible ) ; if ( err == PICL_SUCCESS ) { ( void ) strlcat ( name , "-" , MAXSTRLEN ) ; ( void ) strlcat ( name , compatible , MAXSTRLEN ) ; } if ( err != PICL_PROPNOTFOUND ) { return ( err ) ; } } if ( err != PICL_SUCCESS ) { return ( err ) ; } if ( strcmp ( name , binding_name ) != 0 ) { ( void ) strlcat ( name , "-" , MAXSTRLEN ) ; ( void ) strlcat ( name , binding_name , MAXSTRLEN ) ; } ( void ) strlcpy ( pci_card . name , name , sizeof ( pci_card . name ) ) ; err = picl_get_propval_by_name ( nodeh , OBP_PROP_MODEL , & model , sizeof ( model ) ) ; if ( err == PICL_PROPNOTFOUND ) { ( void ) strlcpy ( model , "" , sizeof ( model ) ) ; } if ( err != PICL_SUCCESS ) { return ( err ) ; } ( void ) strlcpy ( pci_card . model , model , sizeof ( pci_card . model ) ) ; log_printf ( "%-11s" , pci_card . status ) ; log_printf ( "%6s" , pci_card . bus_type ) ; log_printf ( "%5s" , pci_card . slot_str ) ; log_printf ( "%46.45s" , pci_card . notes ) ; if ( strlen ( pci_card . name ) > 24 ) { log_printf ( "%25.24s+" , pci_card . name ) ; } else { log_printf ( "%26s" , pci_card . name ) ; } if ( strlen ( pci_card . model ) > 10 ) { log_printf ( "%10.9s+" , pci_card . model ) ; } else { log_printf ( "%10s" , pci_card . model ) ; } log_printf ( "\n" ) ; err = picl_get_propval_by_name ( nodeh , PICL_PROP_PEER , & nodeh , sizeof ( picl_nodehdl_t ) ) ; } return ( PICL_WALK_CONTINUE ) ; } 