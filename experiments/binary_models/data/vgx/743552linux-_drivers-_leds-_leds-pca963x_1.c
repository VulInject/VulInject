static int pca963x_brightness ( struct pca963x_led * led , enum led_brightness brightness ) { struct i2c_client * client = led -> chip -> client ; struct pca963x_chipdef * chipdef = led -> chip -> chipdef ; u8 ledout_addr , ledout , mask , val ; int shift ; int ret ; ledout_addr = chipdef -> ledout_base + ( led -> led_num / 4 ) ; shift = 2 * ( led -> led_num % 4 ) ; mask = 0x3 << shift ; ledout = i2c_smbus_read_byte_data ( client , ledout_addr ) ; switch ( brightness ) { case LED_FULL : if ( led -> blinking ) { val = ( ledout & ~ mask ) | ( PCA963X_LED_GRP_PWM << shift ) ; ret = i2c_smbus_write_byte_data ( client , PCA963X_PWM_BASE + led -> led_num , LED_FULL ) ; } else { val = ( ledout & ~ mask ) | ( PCA963X_LED_ON << shift ) ; } ret = i2c_smbus_write_byte_data ( client , ledout_addr , val ) ; break ; case LED_OFF : val = ledout & ~ mask ; ret = i2c_smbus_write_byte_data ( client , ledout_addr , val ) ; led -> blinking = false ; break ; default : ret = i2c_smbus_write_byte_data ( client , PCA963X_PWM_BASE + led -> led_num , brightness ) ; if ( led -> blinking ) { val = ( ledout & ~ mask ) | ( PCA963X_LED_GRP_PWM << shift ) ; } else { val = ( ledout & ~ mask ) | ( PCA963X_LED_PWM << shift ) ; } ret = i2c_smbus_write_byte_data ( client , ledout_addr , val ) ; break ; } return ret ; } 