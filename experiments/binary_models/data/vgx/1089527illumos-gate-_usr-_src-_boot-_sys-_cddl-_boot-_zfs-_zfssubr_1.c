static int raidz_parity_verify ( raidz_map_t * rm ) { void * orig [ VDEV_RAIDZ_MAXPARITY ] ; int c , ret = 0 ; raidz_col_t * rc ; for ( c = 0 ; c < rm -> rm_firstdatacol ; c ++ ) { rc = & rm -> rm_col [ c ] ; if ( ! rc -> rc_tried || rc -> rc_error != 0 ) { continue ; } orig [ c ] = malloc ( rc -> rc_size ) ; if ( orig [ c ] != NULL ) { bcopy ( rc -> rc_data , orig [ c ] , rc -> rc_size ) ; } else { printf ( "Out of memory\n" ) ; } } vdev_raidz_generate_parity ( rm ) ; for ( c = rm -> rm_firstdatacol - 1 ; c >= 0 ; c -- ) { rc = & rm -> rm_col [ c ] ; if ( ! rc -> rc_tried || rc -> rc_error != 0 ) { continue ; } if ( orig [ c ] == NULL || bcmp ( orig [ c ] , rc -> rc_data , rc -> rc_size ) != 0 ) { rc -> rc_error = ECKSUM ; ret ++ ; } } return ( ret ) ; } 