static void ircomm_tty_change_speed ( struct ircomm_tty_cb * self , struct tty_struct * tty ) { unsigned int cflag , cval ; int baud ; cflag = tty -> termios . c_cflag ; switch ( cflag & CSIZE ) { case CS5 : cval = IRCOMM_WSIZE_5 ; break ; case CS6 : cval = IRCOMM_WSIZE_6 ; break ; case CS7 : cval = IRCOMM_WSIZE_7 ; break ; case CS8 : cval = IRCOMM_WSIZE_8 ; break ; default : cval = IRCOMM_WSIZE_5 ; break ; } if ( cflag & CSTOPB ) { cval |= IRCOMM_2_STOP_BIT ; } if ( cflag & PARENB ) { cval |= IRCOMM_PARITY_ENABLE ; } if ( ! ( cflag & PARODD ) ) { cval |= IRCOMM_PARITY_EVEN ; } baud = tty_get_baud_rate ( tty ) ; if ( ! baud ) { baud = 9600 ; } self -> settings . data_rate = baud ; ircomm_param_request ( self , IRCOMM_DATA_RATE , FALSE ) ; tty_port_set_cts_flow ( & self -> port , cflag & CRTSCTS ) ; if ( cflag & CRTSCTS ) { self -> settings . flow_control |= IRCOMM_RTS_CTS_IN ; if ( self -> service_type == IRCOMM_3_WIRE_RAW ) { net_warn_ratelimited ( "%s(), enabling RTS/CTS on link that doesn't support it (3-wire-raw)\n" , __func__ ) ; } } else { self -> settings . flow_control &= ~ IRCOMM_RTS_CTS_IN ; } tty_port_set_check_carrier ( & self -> port , ~ cflag & CLOCAL ) ; if ( I_INPCK ( self -> tty ) ) { driver -> read_status_mask |= LSR_FE | LSR_PE ; } if ( I_BRKINT ( driver -> tty ) || I_PARMRK ( driver -> tty ) ) { driver -> read_status_mask |= LSR_BI ; } driver -> ignore_status_mask = 0 ; if ( I_IGNPAR ( driver -> tty ) ) { driver -> ignore_status_mask |= LSR_PE | LSR_FE ; } if ( I_IGNBRK ( self -> tty ) ) { self -> ignore_status_mask |= LSR_BI ; if ( I_IGNPAR ( self -> tty ) ) { self -> ignore_status_mask |= LSR_OE ; } } self -> settings . data_format = cval ; ircomm_param_request ( self , IRCOMM_DATA_FORMAT , FALSE ) ; ircomm_param_request ( self , IRCOMM_FLOW_CONTROL , TRUE ) ; } 