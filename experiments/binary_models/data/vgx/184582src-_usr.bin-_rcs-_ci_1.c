static int checkin_init ( struct checkin_params * pb ) { BUF * bp ; char numb [ RCS_REV_BUFSZ ] ; int fetchlog ; struct stat st ; if ( pb -> newrev != NULL && RCSNUM_ZERO_ENDING ( pb -> newrev ) ) { pb -> frev = rcsnum_alloc ( ) ; rcsnum_cpy ( pb -> newrev , pb -> frev , 0 ) ; pb -> newrev = rcsnum_inc ( pb -> newrev ) ; fetchlog = 1 ; } if ( ( bp = buf_load ( pb -> filename ) ) == NULL ) { return ( - 1 ) ; } if ( pb -> flags & CI_KEYWORDSCAN ) { checkin_keywordscan ( bp , & pb -> newrev , & pb -> date , & pb -> state , & pb -> author ) ; } if ( pb -> flags & CI_SKIPDESC ) { skipdesc } if ( pb -> description == NULL && rcs_set_description ( pb -> file , NULL , pb -> flags ) == - 1 ) { warn ( "%s" , pb -> filename ) ; return ( - 1 ) ; } skipdesc if ( fetchlog == 1 ) { pb -> rcs_msg = checkin_getlogmsg ( pb -> frev , pb -> newrev , pb -> flags ) ; rcsnum_free ( pb -> frev ) ; } if ( pb -> date == DATE_MTIME ) { checkin_mtimedate ( pb ) ; } if ( rcs_rev_add ( pb -> file , ( pb -> newrev == NULL ?RCS_HEAD_REV : pb -> newrev ) , ( pb -> rcs_msg == NULL ?"Initial revision" : pb -> rcs_msg ) , pb -> date , pb -> author ) != 0 ) { warnx ( "failed to add new revision" ) ; return ( - 1 ) ; } if ( pb -> newrev != NULL ) { if ( rcs_head_set ( pb -> file , pb -> newrev ) < 0 ) { errx ( 1 , "rcs_head_set failed" ) ; } } else { pb -> newrev = pb -> file -> rf_head ; } if ( rcs_deltatext_set ( pb -> file , pb -> file -> rf_head , bp ) == - 1 ) { warnx ( "failed to set new head revision" ) ; return ( - 1 ) ; } if ( pb -> symbol != NULL && checkin_attach_symbol ( pb ) < 0 ) { return ( - 1 ) ; } if ( pb -> state != NULL ) { ( void ) rcs_state_set ( pb -> file , pb -> newrev , pb -> state ) ; } if ( fstat ( workfile_fd , & st ) == - 1 ) { err ( 1 , "%s" , pb -> filename ) ; } pb -> file -> rf_mode = st . st_mode & ~ ( S_IWUSR | S_IWGRP | S_IWOTH ) ; ( void ) close ( workfile_fd ) ; ( void ) unlink ( pb -> filename ) ; rcs_write ( pb -> file ) ; if ( ( ( pb -> flags & CO_LOCK ) || ( pb -> flags & CO_UNLOCK ) ) && ! ( pb -> flags & CI_DEFAULT ) ) { checkout_rev ( pb -> file , pb -> newrev , pb -> filename , pb -> flags , pb -> username , pb -> author , NULL , NULL ) ; } if ( ! ( pb -> flags & QUIET ) ) { fprintf ( stderr , "initial revision: %s\n" , rcsnum_tostr ( pb -> newrev , numb , sizeof ( numb ) ) ) ; } return ( 0 ) ; } 