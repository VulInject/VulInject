static ssize_t i2cdev_read ( struct file * file , char __user * buf , size_t count , loff_t * offset ) { char * tmp ; int ret ; struct i2c_client * client = file -> private_data ; if ( count > 8192 ) { count = 8192 ; } tmp = kmalloc ( count , GFP_KERNEL ) ; pr_debug ( "i2c-dev: i2c-%d reading %zu bytes.\n" , iminor ( file_inode ( file ) ) , count ) ; ret = i2c_master_recv ( client , tmp , count ) ; if ( ret >= 0 ) { ret = copy_to_user ( buf , tmp , count ) ?- EFAULT : ret ; } kfree ( tmp ) ; return ret ; } 