int kvm_arch_vcpu_run_pid_change ( struct kvm_vcpu * vcpu ) { struct kvm * kvm = vcpu -> kvm ; int ret ; if ( ! kvm_arm_vcpu_is_finalized ( vcpu ) ) { return - EPERM ; } ret = kvm_arch_vcpu_run_map_fp ( vcpu ) ; if ( ret ) { return ret ; } if ( likely ( vcpu_has_run_once ( vcpu ) ) ) { return 0 ; } kvm_arm_vcpu_init_debug ( vcpu ) ; if ( likely ( irqchip_in_kernel ( kvm ) ) ) { ret = kvm_vgic_map_resources ( kvm ) ; if ( ret ) { return ret ; } } ret = kvm_timer_enable ( vcpu ) ; if ( ret ) { return ret ; } ret = kvm_arm_pmu_v3_enable ( vcpu ) ; if ( ret ) { return ret ; } if ( is_protected_kvm_enabled ( ) ) { ret = pkvm_create_hyp_vm ( kvm ) ; if ( ret ) { return ret ; } } if ( ! irqchip_in_kernel ( kvm ) ) { static_branch_inc ( & userspace_irqchip_in_use ) ; } if ( kvm_vm_is_protected ( kvm ) ) { kvm_call_hyp_nvhe ( __pkvm_vcpu_init_traps , vcpu ) ; } mutex_lock ( & kvm -> lock ) ; set_bit ( KVM_ARCH_FLAG_HAS_RAN_ONCE , & kvm -> arch . flags ) ; mutex_unlock ( & kvm -> lock ) ; return ret ; } 