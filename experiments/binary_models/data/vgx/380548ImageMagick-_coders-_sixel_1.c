static MagickBooleanType sixel_encode_impl ( sixel_pixel_t * pixels , size_t width , size_t height , unsigned char * palette , size_t ncolors , int keycolor , sixel_output_t * context ) { while ( ( np = context -> node_free ) != NULL ) { context -> node_free = np -> next ; np = ( sixel_node_t * ) RelinquishMagickMemory ( np ) ; } map = ( sixel_pixel_t * ) RelinquishMagickMemory ( ) int c , i , left , pix , n , nwrite , right , x , y ; sixel_pixel_t * map ; sixel_node_t * np , top , * tp ; size_t len ; context -> pos = 0 ; len = ncolors * width ; context -> active_palette = ( - 1 ) ; map = ( sixel_pixel_t * ) AcquireQuantumMemory ( len , sizeof ( sixel_pixel_t ) ) ; if ( map == ( sixel_pixel_t * ) NULL ) { return ( MagickFalse ) ; } ( void ) memset ( map , 0 , len * sizeof ( sixel_pixel_t ) ) ; if ( context -> has_8bit_control ) { nwrite = FormatLocaleString ( ( char * ) context -> buffer , sizeof ( context -> buffer ) , "\x90" "0;0;0" "q" ) ; } else { nwrite = FormatLocaleString ( ( char * ) context -> buffer , sizeof ( context -> buffer ) , "\x1bP" "0;0;0" "q" ) ; } if ( nwrite <= 0 ) { return ( MagickFalse ) ; } sixel_advance ( context , nwrite ) ; nwrite = FormatLocaleString ( ( char * ) context -> buffer + context -> pos , sizeof ( context -> buffer ) , "\"1;1;%d;%d" , ( int ) width , ( int ) height ) ; if ( nwrite <= 0 ) { RelinquishNodesAndMap ; return ( MagickFalse ) ; } sixel_advance ( context , nwrite ) ; if ( ( ncolors != 2 ) || ( keycolor == - 1 ) ) { for ( n = 0 ; n < ( ssize_t ) ncolors ; n ++ ) { nwrite = FormatLocaleString ( ( char * ) context -> buffer + context -> pos , sizeof ( context -> buffer ) , "#%d;2;%d;%d;%d" , n , ( palette [ n * 3 + 0 ] * 100 + 127 ) / 255 , ( palette [ n * 3 + 1 ] * 100 + 127 ) / 255 , ( palette [ n * 3 + 2 ] * 100 + 127 ) / 255 ) ; if ( nwrite <= 0 ) { RelinquishNodesAndMap ; return ( MagickFalse ) ; } sixel_advance ( context , nwrite ) ; if ( nwrite <= 0 ) { RelinquishNodesAndMap ; return ( MagickFalse ) ; } } } for ( y = i = 0 ; y < ( int ) height ; y ++ ) { for ( x = 0 ; x < ( int ) width ; x ++ ) { pix = pixels [ y * width + x ] ; if ( ( pix >= 0 ) && ( pix < ( int ) ncolors ) && ( pix != keycolor ) ) { map [ pix * width + x ] |= ( 1 << i ) ; } } if ( ++ i < 6 && ( y + 1 ) < ( int ) height ) { continue ; } for ( c = 0 ; c < ( int ) ncolors ; c ++ ) { for ( left = 0 ; left < ( int ) width ; left ++ ) { if ( * ( map + c * width + left ) == 0 ) { continue ; } for ( right = left + 1 ; right < ( int ) width ; right ++ ) { if ( * ( map + c * width + right ) != 0 ) { continue ; } for ( n = 1 ; ( right + n ) < ( int ) width ; n ++ ) { if ( * ( map + c * width + right + n ) != 0 ) { break ; } } if ( ( n >= 10 ) || ( right + n >= ( int ) width ) ) { break ; } right = right + n - 1 ; } if ( ( np = context -> node_free ) != ( sixel_node_t * ) NULL ) { context -> node_free = np -> next ; } if ( ( np = ( sixel_node_t * ) AcquireMagickMemory ( sizeof ( sixel_node_t ) ) ) == ( sixel_node_t * ) NULL ) { RelinquishNodesAndMap ; return ( MagickFalse ) ; } np -> color = c ; np -> left = left ; np -> right = right ; np -> map = map + c * width ; top . next = context -> node_top ; tp = & top ; while ( tp -> next != ( sixel_node * ) NULL ) { if ( np -> left < tp -> next -> left ) { break ; } if ( ( np -> left == tp -> next -> left ) && ( np -> right > tp -> next -> right ) ) { break ; } tp = tp -> next ; } np -> next = tp -> next ; tp -> next = np ; context -> node_top = top . next ; left = right - 1 ; } } for ( x = 0 ; ( np = context -> node_top ) != ( sixel_node_t * ) NULL ; ) { if ( x > np -> left ) { context -> buffer [ context -> pos ] = '$' ; sixel_advance ( context , 1 ) ; x = 0 ; } x = sixel_put_node ( context , x , np , ( int ) ncolors , keycolor ) ; sixel_node_del ( context , np ) ; np = context -> node_top ; while ( np != ( sixel_node_t * ) NULL ) { if ( np -> left < x ) { np = np -> next ; continue ; } x = sixel_put_node ( context , x , np , ( int ) ncolors , keycolor ) ; sixel_node_del ( context , np ) ; np = context -> node_top ; } } context -> buffer [ context -> pos ] = '-' ; sixel_advance ( context , 1 ) ; if ( nwrite <= 0 ) { RelinquishNodesAndMap ; return ( MagickFalse ) ; } i = 0 ; ( void ) memset ( map , 0 , len * sizeof ( sixel_pixel_t ) ) ; } if ( context -> has_8bit_control ) { context -> buffer [ context -> pos ] = 0x9c ; sixel_advance ( context , 1 ) ; } else { context -> buffer [ context -> pos ] = 0x1b ; context -> buffer [ context -> pos + 1 ] = '\\' ; sixel_advance ( context , 2 ) ; } if ( nwrite <= 0 ) { RelinquishNodesAndMap ; return ( MagickFalse ) ; } if ( context -> pos > 0 ) { WriteBlob ( context -> image , context -> pos , context -> buffer ) ; } RelinquishNodesAndMap ; return ( MagickTrue ) ; } 