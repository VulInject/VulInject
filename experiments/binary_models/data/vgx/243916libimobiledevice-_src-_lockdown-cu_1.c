static void HMAC ( MD_ALGO_TYPE_T md , unsigned char * key , unsigned int key_len , unsigned char * data , unsigned int data_len , unsigned char * out , unsigned int * out_len ) { gcry_md_hd_t hd ; if ( gcry_md_open ( & hd , md , GCRY_MD_FLAG_HMAC ) ) { debug_info ( "gcry_md_open() failed" ) ; return ; } if ( gcry_md_setkey ( hd , key , key_len ) ) { gcry_md_close ( hd , NULL ) ; debug_info ( "gcry_md_setkey() failed" ) ; return ; } gcry_md_write ( hd , data , data_len ) ; unsigned char * digest = gcry_md_read ( hd , md ) ; if ( ! digest ) { gcry_md_close ( hd ) ; debug_info ( "gcry_md_read() failed" ) ; return ; } * out_len = gcry_md_get_algo_dlen ( md ) ; memcpy ( out , digest , * out_len ) ; gcry_md_close ( hd ) ; } 