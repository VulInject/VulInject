static int idio_24_probe ( struct pci_dev * pdev , const struct pci_device_id * id ) { struct device * const dev = & pdev -> dev ; struct idio_24_gpio * idio24gpio ; int err ; const size_t pci_plx_bar_index = 1 ; const size_t pci_bar_index = 2 ; const char * const name = pci_name ( pdev ) ; struct gpio_irq_chip * girq ; idio24gpio = devm_kzalloc ( dev , sizeof ( * idio24gpio ) , GFP_KERNEL ) ; err = pcim_enable_device ( pdev ) ; if ( err ) { dev_err ( dev , "Failed to enable PCI device (%d)\n" , err ) ; return err ; } err = pcim_iomap_regions ( pdev , BIT ( pci_plx_bar_index ) | BIT ( pci_bar_index ) , name ) ; if ( err ) { dev_err ( dev , "Unable to map PCI I/O addresses (%d)\n" , err ) ; return err ; } idio24gpio -> plx = pcim_iomap_table ( pdev ) [ pci_plx_bar_index ] ; idio24gpio -> reg = pcim_iomap_table ( pdev ) [ pci_bar_index ] ; idio24gpio -> chip . label = name ; idio24gpio -> chip . parent = dev ; idio24gpio -> chip . owner = THIS_MODULE ; idio24gpio -> chip . base = - 1 ; idio24gpio -> chip . ngpio = IDIO_24_NGPIO ; idio24gpio -> chip . names = idio_24_names ; idio24gpio -> chip . get_direction = idio_24_gpio_get_direction ; idio24gpio -> chip . direction_input = idio_24_gpio_direction_input ; idio24gpio -> chip . direction_output = idio_24_gpio_direction_output ; idio24gpio -> chip . get = idio_24_gpio_get ; idio24gpio -> chip . get_multiple = idio_24_gpio_get_multiple ; idio24gpio -> chip . set = idio_24_gpio_set ; idio24gpio -> chip . set_multiple = idio_24_gpio_set_multiple ; girq = & idio24gpio -> chip . irq ; girq -> chip = & idio_24_irqchip ; girq -> parent_handler = NULL ; girq -> num_parents = 0 ; girq -> parents = NULL ; girq -> default_type = IRQ_TYPE_NONE ; girq -> handler = handle_edge_irq ; raw_spin_lock_init ( & idio24gpio -> lock ) ; iowrite8 ( 0 , & idio24gpio -> reg -> soft_reset ) ; iowrite8 ( ( INTCSR_INTERNAL_PCI_WIRE | INTCSR_LOCAL_INPUT ) >> 8 , idio24gpio -> plx + PLX_PEX8311_PCI_LCS_INTCSR + 1 ) ; err = devm_gpiochip_add_data ( dev , & idio24gpio -> chip , idio24gpio ) ; if ( err ) { dev_err ( dev , "GPIO registering failed (%d)\n" , err ) ; return err ; } err = devm_request_irq ( dev , pdev -> irq , idio_24_irq_handler , IRQF_SHARED , name , idio24gpio ) ; if ( err ) { dev_err ( dev , "IRQ handler registering failed (%d)\n" , err ) ; return err ; } return 0 ; } 