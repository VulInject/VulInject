static void update_cib_cache_cb ( const char * event , xmlNode * msg ) { int rc = pcmk_ok ; long timeout_ms_saved = stonith_watchdog_timeout_ms ; bool need_full_refresh = false ; if ( ! have_cib_devices ) { crm_trace ( "Skipping updates until we get a full dump" ) ; return ; } if ( msg == NULL ) { crm_trace ( "Missing %s update" , event ) ; return ; } if ( local_cib != NULL ) { int rc = pcmk_ok ; xmlNode * patchset = NULL ; crm_element_value_int ( msg , F_CIB_RC , & rc ) ; if ( rc != pcmk_ok ) { return ; } patchset = get_message_xml ( msg , F_CIB_UPDATE_RESULT ) ; pcmk__output_set_log_level ( logger_out , LOG_TRACE ) ; out -> message ( out , "xml-patchset" , patchset ) ; rc = xml_apply_patchset ( local_cib , patchset , TRUE ) ; switch ( rc ) { case pcmk_ok : case - pcmk_err_old_data : break ; case - pcmk_err_diff_resync : case - pcmk_err_diff_failed : crm_notice ( "[%s] Patch aborted: %s (%d)" , event , pcmk_strerror ( rc ) , rc ) ; local_cib = NULL ; break ; default : crm_warn ( "[%s] ABORTED: %s (%d)" , event , pcmk_strerror ( rc ) , rc ) ; free_xml ( local_cib ) ; local_cib = NULL ; } } if ( local_cib == NULL ) { crm_trace ( "Re-requesting full CIB" ) ; rc = cib_api -> cmds -> query ( cib_api , NULL , & local_cib , cib_scope_local | cib_sync_call ) ; if ( rc != pcmk_ok ) { crm_err ( "Couldn't retrieve the CIB: %s (%d)" , pcmk_strerror ( rc ) , rc ) ; return ; } CRM_ASSERT ( local_cib != NULL ) ; need_full_refresh = true ; } pcmk__refresh_node_caches_from_cib ( local_cib ) ; update_stonith_watchdog_timeout_ms ( local_cib ) ; if ( timeout_ms_saved != stonith_watchdog_timeout_ms ) { need_full_refresh = true ; } if ( need_full_refresh ) { fencing_topology_init ( ) ; cib_devices_update ( ) ; } else { update_fencing_topology ( event , msg ) ; update_cib_stonith_devices ( event , msg ) ; } watchdog_device_update ( ) ; } 