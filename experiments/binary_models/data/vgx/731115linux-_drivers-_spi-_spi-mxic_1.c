static int mxic_spi_data_xfer ( struct mxic_spi * mxic , const void * txbuf , void * rxbuf , unsigned int len ) { unsigned int pos = 0 ; while ( pos < len ) { unsigned int nbytes = len - pos ; u32 data = 0xffffffff ; u32 sts ; int ret ; if ( nbytes > 4 ) { nbytes = 4 ; } if ( txbuf ) { memcpy ( & data , txbuf + pos , nbytes ) ; } ret = readl_poll_timeout ( mxic -> regs + INT_STS , sts , sts & INT_TX_EMPTY , 0 , USEC_PER_SEC ) ; writel ( data , mxic -> regs + TXD ( nbytes % 4 ) ) ; ret = readl_poll_timeout ( mxic -> regs + INT_STS , sts , sts & INT_TX_EMPTY , 0 , USEC_PER_SEC ) ; if ( ret ) { return ret ; } ret = readl_poll_timeout ( mxic -> regs + INT_STS , sts , sts & INT_RX_NOT_EMPTY , 0 , USEC_PER_SEC ) ; if ( ret ) { return ret ; } data = readl ( mxic -> regs + RXD ) ; if ( rxbuf ) { data >>= ( 8 * ( 4 - nbytes ) ) ; memcpy ( rxbuf + pos , & data , nbytes ) ; } WARN_ON ( readl ( mxic -> regs + INT_STS ) & INT_RX_NOT_EMPTY ) ; pos += nbytes ; } return 0 ; } 