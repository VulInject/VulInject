static int __process_one_device ( struct lsblk_devtree * tr , char * devname , dev_t devno ) { struct lsblk_device * dev = NULL ; struct lsblk_device * disk = NULL ; char buf [ PATH_MAX + 1 ] , * name = NULL , * diskname = NULL ; int real_part = 0 , rc = - EINVAL ; if ( devno == 0 && devname ) { struct stat st ; DBG ( DEV , ul_debug ( "%s: reading alone device" , devname ) ) ; if ( stat ( devname , & st ) || ! S_ISBLK ( st . st_mode ) ) { warnx ( _ ( "%s: not a block device" ) , devname ) ; leave } devno = st . st_rdev ; } if ( devno ) { DBG ( DEV , ul_debug ( "%d:%d: reading alone device" , major ( devno ) , minor ( devno ) ) ) ; } else { assert ( devno || devname ) ; return - EINVAL ; } name = sysfs_devno_to_devname ( devno , buf , sizeof ( buf ) ) ; if ( ! name ) { if ( devname ) { warn ( _ ( "%s: failed to get sysfs name" ) , devname ) ; } leave } name = xstrdup ( name ) ; if ( ! strncmp ( name , "dm-" , 3 ) ) { real_part = 0 ; } else { dev_t diskno = 0 ; if ( blkid_devno_to_wholedisk ( devno , buf , sizeof ( buf ) , & diskno ) ) { warn ( _ ( "%s: failed to get whole-disk device number" ) , name ) ; leave } diskname = buf ; real_part = devno != diskno ; } if ( ! real_part ) { DBG ( DEV , ul_debug ( " non-partition" ) ) ; dev = devtree_get_device_or_new ( tr , NULL , name ) ; if ( ! dev ) { leave } lsblk_devtree_add_root ( tr , dev ) ; process_dependencies ( tr , dev , ! lsblk -> inverse ) ; } else { DBG ( DEV , ul_debug ( " partition" ) ) ; disk = devtree_get_device_or_new ( tr , NULL , diskname ) ; if ( ! disk ) { leave } dev = devtree_get_device_or_new ( tr , disk , name ) ; if ( ! dev ) { leave } lsblk_devtree_add_root ( tr , dev ) ; process_dependencies ( tr , dev , 1 ) ; if ( lsblk -> inverse && lsblk_device_new_dependence ( dev , disk ) == 0 ) { process_dependencies ( tr , disk , 0 ) ; } else { ul_path_close_dirfd ( disk -> sysfs ) ; } } rc = 0 ; leave if ( dev && dev -> sysfs ) { ul_path_close_dirfd ( dev -> sysfs ) ; } if ( disk && disk -> sysfs ) { ul_path_close_dirfd ( disk -> sysfs ) ; } return rc ; } 