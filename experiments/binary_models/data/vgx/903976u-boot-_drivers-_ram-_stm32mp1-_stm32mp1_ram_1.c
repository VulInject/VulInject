int stm32mp1_ddr_clk_enable ( struct ddr_info * priv , uint32_t mem_speed ) { unsigned long ddrphy_clk ; unsigned long ddr_clk ; struct clk clk ; int ret ; int idx ; for ( idx = 0 ; idx < ARRAY_SIZE ( clkname ) ; idx ++ ) { ret = clk_get_by_name ( priv -> dev , clkname [ idx ] , & clk ) ; if ( ! ret ) { ret = clk_enable ( & clk ) ; } if ( ret ) { log_err ( "error for %s : %d\n" , clkname [ idx ] , ret ) ; return ret ; } } priv -> clk = clk ; ddrphy_clk = clk_get_rate ( & priv -> clk ) ; log_debug ( "DDR: mem_speed (%d kHz), RCC %d kHz\n" , mem_speed , ( u32 ) ( ddrphy_clk / 1000 ) ) ; ddr_clk = abs ( ddrphy_clk - mem_speed * 1000 ) ; if ( ddr_clk > ( mem_speed * 100 ) ) { log_err ( "DDR expected freq %d kHz, current is %d kHz\n" , mem_speed , ( u32 ) ( ddrphy_clk / 1000 ) ) ; return - EINVAL ; } return 0 ; } 