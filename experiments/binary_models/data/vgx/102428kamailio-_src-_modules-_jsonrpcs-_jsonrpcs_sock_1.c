void jsonrpc_dgram_server ( int rx_sock ) { int ret ; str scmd ; jsonrpc_plain_reply_t * jr = NULL ; fd_set readfds ; int n ; ret = 0 ; while ( 1 ) { cfg_update ( ) ; jsonrpc_dgram_reply_addr_len = sizeof ( jsonrpc_dgram_reply_addr ) ; FD_ZERO ( & readfds ) ; FD_SET ( rx_sock , & readfds ) ; n = select ( rx_sock + 1 , & readfds , 0 , 0 , 0 ) ; if ( n < 0 ) { LM_ERR ( "failure in select: (%d) %s\n" , errno , strerror ( errno ) ) ; continue ; } if ( ! FD_ISSET ( rx_sock , & readfds ) ) { continue ; } ret = recvfrom ( rx_sock , jsonrpc_dgram_buf , JSONRPC_DGRAM_BUF_SIZE , 0 , ( sockaddr * ) & jsonrpc_dgram_reply_addr , & jsonrpc_dgram_reply_addr_len ) ; if ( ret == - 1 ) { LM_ERR ( "recvfrom: (%d) %s\n" , errno , strerror ( errno ) ) ; if ( ( errno == EINTR ) || ( errno == EAGAIN ) || ( errno == EWOULDBLOCK ) || ( errno == ECONNREFUSED ) ) { LM_DBG ( "got %d (%s), going on\n" , errno , strerror ( errno ) ) ; continue ; } LM_DBG ( "error in recvfrom\n" ) ; continue ; } if ( ret == 0 ) { continue ; } LM_DBG ( "received %.*s\n" , ret , jsonrpc_dgram_buf ) ; if ( ret > JSONRPC_DGRAM_BUF_SIZE ) { LM_ERR ( "buffer overflow\n" ) ; continue ; } scmd . s = jsonrpc_dgram_buf ; scmd . len = ret ; trim ( & scmd ) ; LM_DBG ( "buf is %s and we have received %i bytes\n" , scmd . s , scmd . len ) ; if ( jsonrpc_exec_ex ( & scmd , NULL ) < 0 ) { LM_ERR ( "failed to execute the json document from datagram\n" ) ; continue ; } jr = jsonrpc_plain_reply_get ( ) ; LM_DBG ( "command executed - result: [%d] [%p][%.*s]\n" , jr -> rcode , jr -> rbody . s , jr -> rbody . len , jr -> rbody . s ) ; jsonrpc_dgram_send_data ( rx_sock , jr -> rbody . s , jr -> rbody . len , ( sockaddr * ) & jsonrpc_dgram_reply_addr , jsonrpc_dgram_reply_addr_len , jsonrpc_dgram_timeout ) ; } } 