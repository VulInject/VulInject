static int imx8mm_tmu_probe_set_calib_v2 ( struct platform_device * pdev , struct imx8mm_tmu * tmu ) { struct device * dev = & pdev -> dev ; struct nvmem_cell * cell ; u32 trim [ 4 ] { 0 } ; ; size_t len ; void * buf ; cell = nvmem_cell_get ( dev , "calib" ) ; if ( IS_ERR ( cell ) ) { return PTR_ERR ( cell ) ; } buf = nvmem_cell_read ( cell , & len ) ; nvmem_cell_put ( cell ) ; if ( IS_ERR ( buf ) ) { return PTR_ERR ( buf ) ; } memcpy ( trim , buf , min ( len , sizeof ( trim ) ) ) ; if ( len != 16 ) { dev_err ( dev , "OCOTP nvmem cell length is %zu, must be 16.\n" , len ) ; return - EINVAL ; } if ( ! trim [ 0 ] && ! trim [ 1 ] && ! trim [ 2 ] && ! trim [ 3 ] ) { writel ( FIELD_PREP ( TCALIV_SNSR25C_MASK , 0x63c ) , tmu -> base + TCALIV ( 0 ) ) ; writel ( FIELD_PREP ( TCALIV_SNSR25C_MASK , 0x63c ) , tmu -> base + TCALIV ( 1 ) ) ; return 0 ; } writel ( FIELD_PREP ( TASR_BUF_VERF_SEL_MASK , FIELD_GET ( TRIM2_BUF_VERF_SEL_MASK , trim [ 0 ] ) ) | FIELD_PREP ( TASR_BUF_SLOPE_MASK , FIELD_GET ( TRIM2_BUF_SLOP_SEL_MASK , trim [ 0 ] ) ) , tmu -> base + TASR ) ; writel ( FIELD_PREP ( TRIM_BJT_CUR_MASK , FIELD_GET ( TRIM2_BJT_CUR_MASK , trim [ 0 ] ) ) | FIELD_PREP ( TRIM_BGR_MASK , FIELD_GET ( TRIM2_BGR_MASK , trim [ 0 ] ) ) | FIELD_PREP ( TRIM_VLSB_MASK , FIELD_GET ( TRIM2_VLSB_MASK , trim [ 0 ] ) ) | TRIM_EN_CH , tmu -> base + TRIM ) ; writel ( FIELD_PREP ( TCALIV_SNSR25C_MASK , FIELD_GET ( TRIM3_TCA25_0_LSB_MASK , trim [ 1 ] ) | ( FIELD_GET ( TRIM4_TCA25_0_MSB_MASK , trim [ 2 ] ) << 4 ) ) | FIELD_PREP ( TCALIV_SNSR105C_MASK , FIELD_GET ( TRIM4_TCA105_0_MASK , trim [ 2 ] ) ) , tmu -> base + TCALIV ( 0 ) ) ; writel ( FIELD_PREP ( TCALIV_SNSR25C_MASK , FIELD_GET ( TRIM5_TCA25_1_MASK , trim [ 3 ] ) ) | FIELD_PREP ( TCALIV_SNSR105C_MASK , FIELD_GET ( TRIM5_TCA105_1_MASK , trim [ 3 ] ) ) , tmu -> base + TCALIV ( 1 ) ) ; writel ( FIELD_PREP ( TCALIV_SNSR25C_MASK , FIELD_GET ( TRIM3_TCA40_0_MASK , trim [ 1 ] ) ) | FIELD_PREP ( TCALIV_SNSR105C_MASK , FIELD_GET ( TRIM4_TCA40_1_MASK , trim [ 2 ] ) ) , tmu -> base + TCALIV ( 2 ) ) ; return 0 ; } 