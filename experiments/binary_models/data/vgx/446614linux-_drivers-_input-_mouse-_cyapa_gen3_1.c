static int cyapa_gen3_do_operational_check ( struct cyapa * cyapa ) { struct device * dev = & cyapa -> client -> dev ; int error ; switch ( cyapa -> state ) { case CYAPA_STATE_BL_ACTIVE : error = cyapa_gen3_bl_deactivate ( cyapa ) ; if ( error ) { dev_err ( dev , "failed to bl_deactivate: %d\n" , error ) ; return error ; } fallthrough ; case CYAPA_STATE_BL_IDLE : cyapa_gen3_bl_query_data ( cyapa ) ; error = cyapa_gen3_bl_exit ( cyapa ) ; if ( error ) { dev_err ( dev , "failed to bl_exit: %d\n" , error ) ; return error ; } fallthrough ; case CYAPA_STATE_OP : error = cyapa_gen3_set_power_mode ( cyapa , PWR_MODE_FULL_ACTIVE , 0 , CYAPA_PM_ACTIVE ) ; if ( error ) { dev_err ( dev , "%s: set full power mode failed: %d\n" , __func__ , error ) ; } error = cyapa_gen3_get_query_data ( cyapa ) ; if ( cyapa -> gen != CYAPA_GEN3 ) { dev_err ( dev , "unsupported protocol version (%d)" , cyapa -> gen ) ; return - EINVAL ; } if ( memcmp ( cyapa -> product_id , product_id , strlen ( product_id ) ) != 0 ) { dev_err ( dev , "unsupported product ID (%s)\n" , cyapa -> product_id ) ; return - EINVAL ; } return 0 ; default : return - EIO ; } return 0 ; } 