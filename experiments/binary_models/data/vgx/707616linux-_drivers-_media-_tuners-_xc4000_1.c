static int xc4000_set_analog_params ( struct dvb_frontend * fe , struct analog_parameters * params ) { struct xc4000_priv * priv = fe -> tuner_priv ; int type = 0 ; int ret = - EREMOTEIO ; if ( params -> mode == V4L2_TUNER_RADIO ) { dprintk ( 1 , "%s() frequency=%d (in units of 62.5Hz)\n" , __func__ , params -> frequency ) ; mutex_lock ( & priv -> lock ) ; params -> std = 0 ; priv -> freq_hz = params -> frequency * 125L / 2 ; if ( audio_std & XC4000_AUDIO_STD_INPUT1 ) { priv -> video_standard = XC4000_FM_Radio_INPUT1 ; type = FM | INPUT1 ; } else { priv -> video_standard = XC4000_FM_Radio_INPUT2 ; type = FM | INPUT2 ; } tune_channel } dprintk ( 1 , "%s() frequency=%d (in units of 62.5khz)\n" , __func__ , params -> frequency ) ; mutex_lock ( & priv -> lock ) ; priv -> freq_hz = params -> frequency * 62500 ; params -> std &= V4L2_STD_ALL ; if ( ! params -> std ) { params -> std = V4L2_STD_PAL_BG ; } if ( audio_std & XC4000_AUDIO_STD_MONO ) { type = MONO ; } if ( params -> std & V4L2_STD_MN ) { params -> std = V4L2_STD_MN ; if ( audio_std & XC4000_AUDIO_STD_MONO ) { priv -> video_standard = XC4000_MN_NTSC_PAL_Mono ; } if ( audio_std & XC4000_AUDIO_STD_A2 ) { params -> std |= V4L2_STD_A2 ; priv -> video_standard = XC4000_MN_NTSC_PAL_A2 ; } else { params -> std |= V4L2_STD_BTSC ; priv -> video_standard = XC4000_MN_NTSC_PAL_BTSC ; } tune_channel } if ( params -> std & V4L2_STD_PAL_BG ) { params -> std = V4L2_STD_PAL_BG ; if ( audio_std & XC4000_AUDIO_STD_MONO ) { priv -> video_standard = XC4000_BG_PAL_MONO ; } if ( ! ( audio_std & XC4000_AUDIO_STD_A2 ) ) { if ( ! ( audio_std & XC4000_AUDIO_STD_B ) ) { params -> std |= V4L2_STD_NICAM_A ; priv -> video_standard = XC4000_BG_PAL_NICAM ; } else { params -> std |= V4L2_STD_NICAM_B ; priv -> video_standard = XC4000_BG_PAL_NICAM ; } } else { if ( ! ( audio_std & XC4000_AUDIO_STD_B ) ) { params -> std |= V4L2_STD_A2_A ; priv -> video_standard = XC4000_BG_PAL_A2 ; } else { params -> std |= V4L2_STD_A2_B ; priv -> video_standard = XC4000_BG_PAL_A2 ; } } tune_channel } if ( params -> std & V4L2_STD_PAL_I ) { params -> std = V4L2_STD_PAL_I | V4L2_STD_NICAM ; if ( audio_std & XC4000_AUDIO_STD_MONO ) { priv -> video_standard = XC4000_I_PAL_NICAM_MONO ; } else { priv -> video_standard = XC4000_I_PAL_NICAM ; } tune_channel } if ( params -> std & V4L2_STD_PAL_DK ) { params -> std = V4L2_STD_PAL_DK ; if ( audio_std & XC4000_AUDIO_STD_MONO ) { priv -> video_standard = XC4000_DK_PAL_MONO ; } if ( audio_std & XC4000_AUDIO_STD_A2 ) { params -> std |= V4L2_STD_A2 ; priv -> video_standard = XC4000_DK_PAL_A2 ; } else { params -> std |= V4L2_STD_NICAM ; priv -> video_standard = XC4000_DK_PAL_NICAM ; } tune_channel } if ( params -> std & V4L2_STD_SECAM_DK ) { params -> std = V4L2_STD_SECAM_DK | V4L2_STD_A2 ; if ( audio_std & XC4000_AUDIO_STD_L ) { type = 0 ; priv -> video_standard = XC4000_DK_SECAM_NICAM ; } if ( audio_std & XC4000_AUDIO_STD_MONO ) { priv -> video_standard = XC4000_DK_SECAM_A2MONO ; } if ( audio_std & XC4000_AUDIO_STD_K3 ) { params -> std |= V4L2_STD_SECAM_K3 ; priv -> video_standard = XC4000_DK_SECAM_A2LDK3 ; } else { priv -> video_standard = XC4000_DK_SECAM_A2DK1 ; } tune_channel } if ( params -> std & V4L2_STD_SECAM_L ) { type = 0 ; params -> std = V4L2_STD_SECAM_L | V4L2_STD_NICAM ; priv -> video_standard = XC4000_L_SECAM_NICAM ; tune_channel } if ( params -> std & V4L2_STD_SECAM_LC ) { type = 0 ; params -> std = V4L2_STD_SECAM_LC | V4L2_STD_NICAM ; priv -> video_standard = XC4000_LC_SECAM_NICAM ; tune_channel } tune_channel priv -> rf_mode = XC_RF_MODE_CABLE ; if ( check_firmware ( fe , type , params -> std , xc4000_standard [ priv -> video_standard ] . int_freq ) != 0 ) { fail } ret = xc_set_signal_source ( priv , priv -> rf_mode ) ; if ( ret != 0 ) { printk ( KERN_ERR "xc4000: xc_set_signal_source(%d) failed\n" , priv -> rf_mode ) ; fail } else { u16 video_mode , audio_mode ; video_mode = xc4000_standard [ priv -> video_standard ] . video_mode ; audio_mode = xc4000_standard [ priv -> video_standard ] . audio_mode ; if ( priv -> video_standard < XC4000_BG_PAL_A2 ) { if ( type & NOGD ) { video_mode &= 0xFF7F ; } } if ( priv -> video_standard < XC4000_I_PAL_NICAM ) { if ( priv -> firm_version == 0x0102 ) { video_mode &= 0xFEFF ; } if ( audio_std & XC4000_AUDIO_STD_B ) { video_mode |= 0x0080 ; } } ret = xc_set_tv_standard ( priv , video_mode , audio_mode ) ; if ( ret != 0 ) { printk ( KERN_ERR "xc4000: xc_set_tv_standard failed\n" ) ; fail } } if ( xc_write_reg ( priv , XREG_D_CODE , 0 ) == 0 ) { ret = 0 ; } if ( xc_write_reg ( priv , XREG_AMPLITUDE , 1 ) != 0 ) { ret = - EREMOTEIO ; } if ( priv -> set_smoothedcvbs != 0 ) { if ( xc_write_reg ( priv , XREG_SMOOTHEDCVBS , 1 ) != 0 ) { ret = - EREMOTEIO ; } } if ( ret != 0 ) { printk ( KERN_ERR "xc4000: setting registers failed\n" ) ; fail } xc_tune_channel ( priv , priv -> freq_hz ) ; ret = 0 ; fail mutex_unlock ( & priv -> lock ) ; return ret ; } 