bool amdgpu_display_crtc_scaling_mode_fixup ( struct drm_crtc * crtc , const struct drm_display_mode * mode , struct drm_display_mode * adjusted_mode ) { struct drm_device * dev = crtc -> dev ; struct drm_encoder * encoder ; struct amdgpu_crtc * amdgpu_crtc = to_amdgpu_crtc ( crtc ) ; struct amdgpu_encoder * amdgpu_encoder ; struct drm_connector * connector ; u32 src_v = 1 , dst_v = 1 ; u32 src_h = 1 , dst_h = 1 ; amdgpu_crtc -> h_border = 0 ; amdgpu_crtc -> v_border = 0 ; list_for_each_entry ( , , ) { amdgpu_encoder = to_amdgpu_encoder ( encoder ) ; connector = amdgpu_get_connector_for_encoder ( encoder ) ; if ( amdgpu_encoder -> rmx_type == RMX_OFF ) { amdgpu_crtc -> rmx_type = RMX_OFF ; } if ( mode -> hdisplay < amdgpu_encoder -> native_mode . hdisplay || mode -> vdisplay < amdgpu_encoder -> native_mode . vdisplay ) { amdgpu_crtc -> rmx_type = amdgpu_encoder -> rmx_type ; } else { amdgpu_crtc -> rmx_type = RMX_OFF ; } memcpy ( & amdgpu_crtc -> native_mode , & amdgpu_encoder -> native_mode , sizeof ( drm_display_mode ) ) ; src_v = crtc -> mode . vdisplay ; dst_v = amdgpu_crtc -> native_mode . vdisplay ; src_h = crtc -> mode . hdisplay ; dst_h = amdgpu_crtc -> native_mode . hdisplay ; if ( ( ! ( mode -> flags & DRM_MODE_FLAG_INTERLACE ) ) && ( ( amdgpu_encoder -> underscan_type == UNDERSCAN_ON ) || ( ( amdgpu_encoder -> underscan_type == UNDERSCAN_AUTO ) && connector -> display_info . is_hdmi && amdgpu_display_is_hdtv_mode ( mode ) ) ) ) { if ( amdgpu_encoder -> underscan_hborder != 0 ) { amdgpu_crtc -> h_border = amdgpu_encoder -> underscan_hborder ; } else { amdgpu_crtc -> h_border = ( mode -> hdisplay >> 5 ) + 16 ; } if ( amdgpu_encoder -> underscan_vborder != 0 ) { amdgpu_crtc -> v_border = amdgpu_encoder -> underscan_vborder ; } else { amdgpu_crtc -> v_border = ( mode -> vdisplay >> 5 ) + 16 ; } amdgpu_crtc -> rmx_type = RMX_FULL ; src_v = crtc -> mode . vdisplay ; dst_v = crtc -> mode . vdisplay - ( amdgpu_crtc -> v_border * 2 ) ; src_h = crtc -> mode . hdisplay ; dst_h = crtc -> mode . hdisplay - ( amdgpu_crtc -> h_border * 2 ) ; } } if ( amdgpu_crtc -> rmx_type != RMX_OFF ) { fixed20_12 a , b ; a . full = dfixed_const ( src_v ) ; b . full = dfixed_const ( dst_v ) ; amdgpu_crtc -> vsc . full = dfixed_div ( a , b ) ; a . full = dfixed_const ( src_h ) ; b . full = dfixed_const ( dst_h ) ; amdgpu_crtc -> hsc . full = dfixed_div ( a , b ) ; } else { amdgpu_crtc -> vsc . full = dfixed_const ( 1 ) ; amdgpu_crtc -> hsc . full = dfixed_const ( 1 ) ; } return true ; } 