static int cmd_load_bpf ( char * bpf_string ) { char sp , * token , separator = ',' ; unsigned short bpf_len , i = 0 ; struct sock_filter tmp ; bpf_prog_len = 0 ; if ( sscanf ( bpf_string , "%hu%c" , & bpf_len , & sp ) != 2 || sp != separator || bpf_len > BPF_MAXINSNS || bpf_len == 0 ) { rl_printf ( "syntax error in head length encoding!\n" ) ; return CMD_ERR ; } token = bpf_string ; while ( ( token = strchr ( token , separator ) ) && ( ++ token ) [ 0 ] ) { if ( i >= bpf_len ) { rl_printf ( "program exceeds encoded length!\n" ) ; return CMD_ERR ; } if ( sscanf ( token , "%hu %hhu %hhu %u," , & tmp . code , & tmp . jt , & tmp . jf , & tmp . k ) != 4 ) { rl_printf ( "syntax error at instruction %d!\n" , i ) ; return CMD_ERR ; } bpf_image [ i ] . code = tmp . code ; bpf_image [ i ] . jt = tmp . jt ; bpf_image [ i ] . jf = tmp . jf ; bpf_image [ i ] . k = tmp . k ; i ++ ; } if ( i != bpf_len ) { rl_printf ( "syntax error exceeding encoded length!\n" ) ; return CMD_ERR ; } else { bpf_prog_len = bpf_len ; } if ( ! bpf_runnable ( bpf_image , bpf_prog_len ) ) { bpf_prog_len = 0 ; } return CMD_OK ; } 