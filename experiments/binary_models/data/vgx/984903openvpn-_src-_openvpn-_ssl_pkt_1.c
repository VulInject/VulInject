static void tls_wrap_control ( struct tls_wrap_ctx * ctx , uint8_t header , struct buffer * buf , struct session_id * session_id ) { if ( ctx -> mode == TLS_WRAP_AUTH || ctx -> mode == TLS_WRAP_NONE ) { ASSERT ( session_id_write_prepend ( session_id , buf ) ) ; ASSERT ( buf_write_prepend ( buf , & header , sizeof ( header ) ) ) ; } if ( ctx -> mode == TLS_WRAP_AUTH ) { struct buffer null = clear_buf ( ) ; openvpn_encrypt ( buf , null , & ctx -> opt ) ; ASSERT ( swap_hmac ( buf , & ctx -> opt , false ) ) ; } if ( ctx -> mode == TLS_WRAP_CRYPT ) { ASSERT ( buf_init ( & ctx -> work , buf -> offset ) ) ; ASSERT ( buf_write ( & ctx -> work , & header , sizeof ( header ) ) ) ; ASSERT ( session_id_write ( session_id , & ctx -> work ) ) ; if ( ! tls_crypt_wrap ( buf , & ctx -> work , & ctx -> opt ) ) { return ; } if ( ( header >> P_OPCODE_SHIFT ) == P_CONTROL_HARD_RESET_CLIENT_V3 || ( header >> P_OPCODE_SHIFT ) == P_CONTROL_WKC_V1 ) { if ( ! buf_copy ( & ctx -> work , ctx -> tls_crypt_v2_wkc ) ) { msg ( D_TLS_ERRORS , "Could not append tls-crypt-v2 client key" ) ; buf -> len = 0 ; return ; } } * buf = ctx -> work ; } } 