int qxl_hw_surface_dealloc ( struct qxl_device * qdev , struct qxl_bo * surf ) { struct qxl_surface_cmd * cmd ; struct qxl_release * release ; int ret ; int id ; if ( ! surf -> hw_surf_alloc ) { return 0 ; } ret = qxl_alloc_surface_release_reserved ( qdev , QXL_SURFACE_CMD_DESTROY , surf -> surf_create , & release ) ; if ( ret ) { return ret ; } surf -> surf_create = NULL ; spin_lock ( & qdev -> surf_id_idr_lock ) ; idr_replace ( & qdev -> surf_id_idr , NULL , surf -> surface_id ) ; spin_unlock ( & qdev -> surf_id_idr_lock ) ; surf -> hw_surf_alloc = false ; id = surf -> surface_id ; surf -> surface_id = 0 ; release -> surface_release_id = id ; cmd = ( qxl_surface_cmd * ) qxl_release_map ( qdev , release ) ; cmd -> type = QXL_SURFACE_CMD_DESTROY ; cmd -> surface_id = id ; qxl_release_unmap ( qdev , release , & cmd -> release_info ) ; qxl_push_command_ring_release ( qdev , release , QXL_CMD_SURFACE , false ) ; return 0 ; } 