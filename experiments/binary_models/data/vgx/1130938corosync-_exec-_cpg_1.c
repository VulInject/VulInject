static int cpg_exec_send_joinlist ( void ) { int count = 0 ; struct qb_list_head * iter ; struct qb_ipc_response_header * res ; char * buf ; size_t buf_size ; struct join_list_entry * jle ; struct iovec req_exec_cpg_iovec ; qb_list_for_each ( , ) { struct process_info * pi = qb_list_entry ( iter , process_info , list ) ; if ( pi -> nodeid == api -> totem_nodeid_get ( ) ) { count ++ ; } } if ( ! count ) { return 0 ; } buf_size = sizeof ( qb_ipc_response_header ) + sizeof ( join_list_entry ) * count ; buf = alloca ( buf_size ) ; if ( ! buf ) { log_printf ( LOGSYS_LEVEL_WARNING , "Unable to allocate joinlist buffer" ) ; return - 1 ; } jle = ( join_list_entry * ) ( buf + sizeof ( qb_ipc_response_header ) ) ; res = ( qb_ipc_response_header * ) buf ; qb_list_for_each ( , ) { struct process_info * pi = qb_list_entry ( iter , process_info , list ) ; if ( pi -> nodeid == api -> totem_nodeid_get ( ) ) { memcpy ( & jle -> group_name , & pi -> group , sizeof ( mar_cpg_name_t ) ) ; jle -> pid = pi -> pid ; jle ++ ; } } res -> id = SERVICE_ID_MAKE ( CPG_SERVICE , MESSAGE_REQ_EXEC_CPG_JOINLIST ) ; res -> size = sizeof ( qb_ipc_response_header ) + sizeof ( join_list_entry ) * count ; req_exec_cpg_iovec . iov_base = buf ; req_exec_cpg_iovec . iov_len = res -> size ; return ( api -> totem_mcast ( & req_exec_cpg_iovec , 1 , TOTEM_AGREED ) ) ; } 