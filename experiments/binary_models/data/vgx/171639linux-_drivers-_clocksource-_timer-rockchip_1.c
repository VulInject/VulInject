static int __init rk_clkevt_init ( struct device_node * np ) { struct clock_event_device * ce ; int ret = - EINVAL ; rk_clkevt = kzalloc ( sizeof ( rk_clkevt ) , GFP_KERNEL ) ; if ( ! rk_clkevt ) { ret = - ENOMEM ; out } ret = rk_timer_probe ( & rk_clkevt -> timer , np ) ; if ( ret ) { out_probe } ce = & rk_clkevt -> ce ; ce -> name = TIMER_NAME ; ce -> features = CLOCK_EVT_FEAT_PERIODIC | CLOCK_EVT_FEAT_ONESHOT | CLOCK_EVT_FEAT_DYNIRQ ; ce -> set_next_event = rk_timer_set_next_event ; ce -> set_state_shutdown = rk_timer_shutdown ; ce -> set_state_periodic = rk_timer_set_periodic ; ce -> irq = rk_clkevt -> timer . irq ; ce -> cpumask = cpu_possible_mask ; ce -> rating = 250 ; ret = request_irq ( rk_clkevt -> timer . irq , rk_timer_interrupt , IRQF_TIMER , TIMER_NAME , ce ) ; if ( ret ) { pr_err ( "Failed to initialize '%s': %d\n" , TIMER_NAME , ret ) ; out_irq } clockevents_config_and_register ( & rk_clkevt -> ce , rk_clkevt -> timer . freq , 1 , UINT_MAX ) ; return 0 ; out_irq rk_timer_cleanup ( & rk_clkevt -> timer ) ; out_probe out rk_clkevt = ERR_PTR ( ret ) ; return ret ; } 