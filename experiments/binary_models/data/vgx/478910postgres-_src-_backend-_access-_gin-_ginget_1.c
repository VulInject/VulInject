static bool collectMatchBitmap ( GinBtreeData * btree , GinBtreeStack * stack , GinScanEntry scanEntry , Snapshot snapshot ) { OffsetNumber attnum ; Form_pg_attribute attr ; scanEntry -> matchBitmap = tbm_create ( work_mem * 1024L , NULL ) ; if ( scanEntry -> isPartialMatch && scanEntry -> queryCategory != GIN_CAT_NORM_KEY ) { return true ; } attnum = scanEntry -> attnum ; attr = TupleDescAttr ( btree -> ginstate -> origTupdesc , attnum - 1 ) ; PredicateLockPage ( btree -> index , stack -> buffer , snapshot ) ; for ( ; ; ) { Page page ; IndexTuple itup ; Datum idatum ; GinNullCategory icategory ; if ( moveRightIfItNeeded ( btree , stack , snapshot ) == false ) { return true ; } page = BufferGetPage ( stack -> buffer ) ; TestForOldSnapshot ( snapshot , btree -> index , page ) ; itup = ( IndexTuple ) PageGetItem ( page , PageGetItemId ( page , stack -> off ) ) ; idatum = gintuple_get_key ( btree -> ginstate , itup , & icategory ) ; if ( scanEntry -> isPartialMatch ) { int32 cmp ; if ( icategory != GIN_CAT_NORM_KEY ) { return true ; } cmp = DatumGetInt32 ( FunctionCall4Coll ( & btree -> ginstate -> comparePartialFn [ attnum - 1 ] , btree -> ginstate -> supportCollation [ attnum - 1 ] , scanEntry -> queryKey , idatum , UInt16GetDatum ( scanEntry -> strategy ) , PointerGetDatum ( scanEntry -> extra_data ) ) ) ; if ( cmp > 0 ) { return true ; } if ( cmp < 0 ) { stack -> off ++ ; continue ; } } if ( scanEntry -> searchMode == GIN_SEARCH_MODE_ALL ) { if ( icategory == GIN_CAT_NULL_ITEM ) { return true ; } } if ( GinIsPostingTree ( itup ) ) { BlockNumber rootPostingTree = GinGetPostingTree ( itup ) ; if ( icategory == GIN_CAT_NORM_KEY ) { idatum = datumCopy ( idatum , attr -> attbyval , attr -> attlen ) ; } LockBuffer ( stack -> buffer , GIN_UNLOCK ) ; PredicateLockPage ( btree -> index , rootPostingTree , snapshot ) ; scanPostingTree ( btree -> index , scanEntry , rootPostingTree , snapshot ) ; LockBuffer ( stack -> buffer , GIN_SHARE ) ; page = BufferGetPage ( stack -> buffer ) ; if ( ! GinPageIsLeaf ( page ) ) { return false ; } for ( ; ; ) { if ( moveRightIfItNeeded ( btree , stack , snapshot ) == false ) { ereport ( ERROR , ( errcode ( ERRCODE_INTERNAL_ERROR ) , errmsg ( "failed to re-find tuple within index \"%s\"" , RelationGetRelationName ( btree -> index ) ) ) ) ; } page = BufferGetPage ( stack -> buffer ) ; itup = ( IndexTuple ) PageGetItem ( page , PageGetItemId ( page , stack -> off ) ) ; if ( gintuple_get_attrnum ( btree -> ginstate , itup ) == attnum ) { Datum newDatum ; GinNullCategory newCategory ; newDatum = gintuple_get_key ( btree -> ginstate , itup , & newCategory ) ; if ( ginCompareEntries ( btree -> ginstate , attnum , newDatum , newCategory , idatum , icategory ) == 0 ) { break ; } } stack -> off ++ ; } if ( icategory == GIN_CAT_NORM_KEY && ! attr -> attbyval ) { pfree ( DatumGetPointer ( idatum ) ) ; } } else { ItemPointer ipd ; int nipd ; ipd = ginReadTuple ( btree -> ginstate , scanEntry -> attnum , itup , & nipd ) ; tbm_add_tuples ( scanEntry -> matchBitmap , ipd , nipd , false ) ; scanEntry -> predictNumberResult += GinGetNPosting ( itup ) ; pfree ( ipd ) ; } stack -> off ++ ; } } 