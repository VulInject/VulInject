pid_t ptrace_wrap_fork ( ptrace_wrap_instance * inst , void * child_callback ( void * ) , void * child_callback_user ) { if ( inst -> th == pthread_self ( ) ) { pid_t r = fork ( ) ; if ( r == 0 ) { child_callback ( child_callback_user , NULL ) ; return 0 ; } return r ; } int _errno = 0 ; inst -> request . type = PTRACE_WRAP_REQUEST_TYPE_FORK ; inst -> request . fork . child_callback = child_callback ; inst -> request . fork . child_callback_user = child_callback_user ; inst -> request . fork . _errno = & _errno ; sem_post ( & inst -> request_sem ) ; sem_wait ( & inst -> result_sem ) ; errno = _errno ; return inst -> fork_result ; } 