extern bool gres_select_util_job_mem_set ( List job_gres_list , job_resources_t * job_res ) { ListIterator job_gres_iter ; gres_state_t * gres_state_job ; gres_job_state_t * gres_js ; bool rc = false , first_set = true ; uint64_t gres_cnt , mem_size , mem_per_gres ; int node_off ; node_record_t * node_ptr ; if ( ! bit_set_count ( job_res -> node_bitmap ) ) { return false ; } job_gres_iter = list_iterator_create ( job_gres_list ) ; while ( ( gres_state_job = list_next ( job_gres_iter ) ) ) { gres_js = ( gres_job_state_t * ) gres_state_job -> gres_data ; if ( gres_js -> mem_per_gres ) { mem_per_gres = gres_js -> mem_per_gres ; } else { mem_per_gres = gres_js -> def_mem_per_gres ; } if ( ( mem_per_gres == 0 ) || ! gres_js -> gres_cnt_node_select ) { continue ; } rc = true ; node_off = - 1 ; for ( int i = 0 ; ( node_ptr = next_node_bitmap ( job_res -> node_bitmap , & i ) ) ; i ++ ) { node_off ++ ; if ( job_res -> whole_node == 1 ) { gres_state_t * gres_state_node ; gres_node_state_t * gres_ns ; gres_state_node = list_find_first ( node_ptr -> gres_list , gres_find_id , & gres_state_job -> plugin_id ) ; if ( ! gres_state_node ) { continue ; } gres_ns = gres_state_node -> gres_data ; gres_cnt = gres_ns -> gres_cnt_avail ; } else { gres_cnt = gres_js -> gres_cnt_node_select [ i ] ; } mem_size = mem_per_gres * gres_cnt ; if ( first_set ) { job_res -> memory_allocated [ node_off ] = mem_size ; } else { job_res -> memory_allocated [ node_off ] += mem_size ; } } first_set = false ; } list_iterator_destroy ( job_gres_iter ) ; return rc ; } 