static char * set_eval_charset ( set_t * set , char * value ) { irc_t * irc = ( irc_t * ) set -> data ; char * test ; gsize test_bytes = 0 ; GIConv ic , oc ; if ( g_strcasecmp ( value , "none" ) == 0 ) { value = g_strdup ( "utf-8" ) ; } if ( ( oc = g_iconv_open ( value , "utf-8" ) ) == ( GIConv ) - 1 ) { return NULL ; } if ( ( test = g_convert_with_iconv ( " " , 1 , oc , NULL , & test_bytes , NULL ) ) == NULL || test_bytes > 1 ) { g_iconv_close ( oc ) ; irc_rootmsg ( irc , "Unsupported character set: The IRC protocol " "only supports 8-bit character sets." ) ; return NULL ; } g_free ( test ) ; if ( ( ic = g_iconv_open ( "utf-8" , value ) ) == ( GIConv ) - 1 ) { g_iconv_close ( oc ) ; return NULL ; } if ( irc -> iconv != ( GIConv ) - 1 ) { g_iconv_close ( irc -> iconv ) ; } if ( irc -> oconv != ( GIConv ) - 1 ) { g_iconv_close ( irc -> oconv ) ; } irc -> iconv = ic ; irc -> oconv = oc ; return value ; } 