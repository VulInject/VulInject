static int joycon_hid_send_sync ( struct joycon_ctlr * ctlr , u8 * data , size_t len , u32 timeout ) { int ret ; int tries = 2 ; while ( tries -- ) { joycon_enforce_subcmd_rate ( ctlr ) ; ret = __joycon_hid_send ( ctlr -> hdev , data , len ) ; if ( ret < 0 ) { return ret ; } ret = wait_event_timeout ( ctlr -> wait , ctlr -> received_resp , timeout ) ; if ( ! ret ) { hid_dbg ( ctlr -> hdev , "synchronous send/receive timed out\n" ) ; if ( tries ) { hid_dbg ( ctlr -> hdev , "retrying sync send after timeout\n" ) ; } memset ( ctlr -> input_buf , 0 , JC_MAX_RESP_SIZE ) ; ret = - ETIMEDOUT ; } else { ret = 0 ; break ; } } ctlr -> received_resp = false ; return ret ; } 