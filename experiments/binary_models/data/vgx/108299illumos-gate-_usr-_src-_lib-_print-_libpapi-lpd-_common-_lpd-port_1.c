static int massage_control_data ( char * data , int id ) { char * line , * iter = NULL ; char * ptr , * mod_ptr , * datacpy ; char host [ BUFSIZ ] ; int host_present = 0 ; if ( gethostname ( host , sizeof ( host ) ) != 0 ) { return ( - 1 ) ; } if ( ( datacpy = strdup ( data ) ) == NULL ) { return ( - 1 ) ; } for ( ptr = strtok_r ( datacpy , "\n" , & iter ) ; ptr != NULL ; ptr = strtok_r ( NULL , "\n" , & iter ) ) { if ( ptr [ 0 ] == 'H' ) { if ( strncmp ( ++ ptr , host , strlen ( host ) ) != 0 ) { return ( - 1 ) ; } host_present = 1 ; } if ( ( ptr [ 0 ] == 'P' ) || ( ptr [ 0 ] == 'L' ) ) { uid_t uid = getuid ( ) ; struct passwd * pw ; int len ; if ( uid == 0 ) { continue ; } if ( ( pw = getpwuid ( uid ) ) == NULL ) { free ( datacpy ) ; return ( - 1 ) ; } len = strlen ( pw -> pw_name ) ; if ( ( strncmp ( ++ ptr , pw -> pw_name , len ) != 0 ) ) { free ( datacpy ) ; return ( - 1 ) ; } } if ( ( islower ( ptr [ 0 ] ) != 0 ) || ( ptr [ 0 ] == 'U' ) ) { ptr ++ ; if ( strlen ( ptr ) < 6 ) { free ( datacpy ) ; return ( - 1 ) ; } mod_ptr = strstr ( data , ptr ) ; if ( ( mod_ptr [ 0 ] == 'd' ) && ( mod_ptr [ 1 ] == 'f' ) && ( mod_ptr [ 3 ] == 'X' ) && ( mod_ptr [ 4 ] == 'X' ) && ( mod_ptr [ 5 ] == 'X' ) ) { mod_ptr [ 3 ] = '0' + ( id / 100 ) % 10 ; mod_ptr [ 4 ] = '0' + ( id / 10 ) % 10 ; mod_ptr [ 5 ] = '0' + id % 10 ; if ( strncmp ( & mod_ptr [ 6 ] , host , strlen ( host ) ) != 0 ) { free ( datacpy ) ; return ( - 1 ) ; } } else { free ( datacpy ) ; return ( - 1 ) ; } } } free ( datacpy ) ; if ( ! host_present ) { return ( - 1 ) ; } return ( 1 ) ; } 