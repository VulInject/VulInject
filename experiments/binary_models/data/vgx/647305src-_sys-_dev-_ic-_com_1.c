int comioctl ( dev_t dev , u_long cmd , caddr_t data , int flag , struct proc * p ) { int unit = DEVUNIT ( dev ) ; struct com_softc * sc = com_cd . cd_devs [ unit ] ; struct tty * tp = sc -> sc_tty ; int error ; error = ( * linesw [ tp -> t_line ] . l_ioctl ) ( tp , cmd , data , flag , p ) ; error = ttioctl ( tp , cmd , data , flag , p ) ; if ( error >= 0 ) { return error ; } switch ( cmd ) { case TIOCSBRK : SET ( sc -> sc_lcr , LCR_SBREAK ) ; com_write_reg ( sc , com_lcr , sc -> sc_lcr ) ; break ; case TIOCCBRK : CLR ( sc -> sc_lcr , LCR_SBREAK ) ; com_write_reg ( sc , com_lcr , sc -> sc_lcr ) ; break ; case TIOCSDTR : SET ( sc -> sc_mcr , sc -> sc_dtr ) ; com_write_reg ( sc , com_mcr , sc -> sc_mcr ) ; break ; case TIOCCDTR : CLR ( sc -> sc_mcr , sc -> sc_dtr ) ; com_write_reg ( sc , com_mcr , sc -> sc_mcr ) ; break ; case TIOCMSET : CLR ( sc -> sc_mcr , MCR_DTR | MCR_RTS ) ; case TIOCMBIS : SET ( sc -> sc_mcr , tiocm_xxx2mcr ( * ( int * ) data ) ) ; com_write_reg ( sc , com_mcr , sc -> sc_mcr ) ; break ; case TIOCMBIC : CLR ( sc -> sc_mcr , tiocm_xxx2mcr ( * ( int * ) data ) ) ; com_write_reg ( sc , com_mcr , sc -> sc_mcr ) ; break ; case TIOCMGET : { u_char m ; int bits = 0 ; m = sc -> sc_mcr ; if ( ISSET ( m , MCR_DTR ) ) { SET ( bits , TIOCM_DTR ) ; } if ( ISSET ( m , MCR_RTS ) ) { SET ( bits , TIOCM_RTS ) ; } m = sc -> sc_msr ; if ( ISSET ( m , MSR_DCD ) ) { SET ( bits , TIOCM_CD ) ; } if ( ISSET ( m , MSR_CTS ) ) { SET ( bits , TIOCM_CTS ) ; } if ( ISSET ( m , MSR_DSR ) ) { SET ( bits , TIOCM_DSR ) ; } if ( ISSET ( m , MSR_RI | MSR_TERI ) ) { SET ( bits , TIOCM_RI ) ; } if ( com_read_reg ( sc , com_ier ) ) { SET ( bits , TIOCM_LE ) ; } * ( int * ) data = bits ; break ; } case TIOCGFLAGS : { int driverbits , userbits = 0 ; driverbits = sc -> sc_swflags ; if ( ISSET ( driverbits , COM_SW_SOFTCAR ) ) { SET ( userbits , TIOCFLAG_SOFTCAR ) ; } if ( ISSET ( driverbits , COM_SW_CLOCAL ) ) { SET ( userbits , TIOCFLAG_CLOCAL ) ; } if ( ISSET ( driverbits , COM_SW_CRTSCTS ) ) { SET ( userbits , TIOCFLAG_CRTSCTS ) ; } if ( ISSET ( driverbits , COM_SW_MDMBUF ) ) { SET ( userbits , TIOCFLAG_MDMBUF ) ; } if ( ISSET ( driverbits , COM_SW_PPS ) ) { SET ( userbits , TIOCFLAG_PPS ) ; } * ( int * ) data = userbits ; break ; } case TIOCSFLAGS : { int userbits , driverbits = 0 ; error = suser ( p ) ; if ( error != 0 ) { return ( EPERM ) ; } userbits = * ( int * ) data ; if ( ISSET ( userbits , TIOCFLAG_SOFTCAR ) || ISSET ( sc -> sc_hwflags , COM_HW_CONSOLE ) ) { SET ( driverbits , COM_SW_SOFTCAR ) ; } if ( ISSET ( userbits , TIOCFLAG_CLOCAL ) ) { SET ( driverbits , COM_SW_CLOCAL ) ; } if ( ISSET ( userbits , TIOCFLAG_CRTSCTS ) ) { SET ( driverbits , COM_SW_CRTSCTS ) ; } if ( ISSET ( userbits , TIOCFLAG_MDMBUF ) ) { SET ( driverbits , COM_SW_MDMBUF ) ; } if ( ISSET ( userbits , TIOCFLAG_PPS ) ) { SET ( driverbits , COM_SW_PPS ) ; } sc -> sc_swflags = driverbits ; break ; } default : return ENOTTY ; } return 0 ; } 