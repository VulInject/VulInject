int create_task_io_context ( struct task_struct * task , gfp_t gfp_flags , int node ) { struct io_context * ioc ; int ret ; ioc = kmem_cache_alloc_node ( iocontext_cachep , gfp_flags | __GFP_ZERO , node ) ; if ( unlikely ( ! ioc ) ) { return - ENOMEM ; } atomic_long_set ( & ioc -> refcount , 1 ) ; atomic_set ( & ioc -> nr_tasks , 1 ) ; atomic_set ( & ioc -> active_ref , 1 ) ; spin_lock_init ( & ioc -> lock ) ; INIT_RADIX_TREE ( & ioc -> icq_tree , GFP_ATOMIC | __GFP_HIGH ) ; INIT_HLIST_HEAD ( & ioc -> icq_list ) ; INIT_WORK ( & ioc -> release_work , ioc_release_fn ) ; task_lock ( task , NULL ) ; if ( ! task -> io_context && ( task == current || ! ( task -> flags & PF_EXITING ) ) ) { task -> io_context = ioc ; } else { kmem_cache_free ( iocontext_cachep , ioc ) ; } ret = task -> io_context ?0 : - EBUSY ; task_unlock ( task ) ; return ret ; } 