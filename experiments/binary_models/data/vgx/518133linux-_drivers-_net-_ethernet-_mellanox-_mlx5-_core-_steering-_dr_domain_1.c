static int dr_domain_init_resources ( struct mlx5dr_domain * dmn ) { int ret ; dmn -> ste_ctx = mlx5dr_ste_get_ctx ( dmn -> info . caps . sw_format_ver ) ; if ( ! dmn -> ste_ctx ) { mlx5dr_err ( dmn , "SW Steering on this device is unsupported\n" ) ; return - EOPNOTSUPP ; } ret = mlx5_core_alloc_pd ( dmn -> mdev , & dmn -> pdn ) ; if ( ret ) { mlx5dr_err ( dmn , "Couldn't allocate PD, ret: %d" , ret ) ; return ret ; } dmn -> uar = mlx5_get_uars_page ( dmn -> mdev ) ; if ( IS_ERR ( dmn -> uar ) ) { mlx5dr_err ( dmn , "Couldn't allocate UAR\n" ) ; ret = PTR_ERR ( dmn -> uar ) ; clean_pd } ret = dr_domain_init_mem_resources ( dmn , NULL ) ; if ( ret ) { mlx5dr_err ( dmn , "Couldn't create domain memory resources\n" ) ; clean_uar } ret = mlx5dr_send_ring_alloc ( dmn ) ; if ( ret ) { mlx5dr_err ( dmn , "Couldn't create send-ring\n" ) ; clean_mem_resources } return 0 ; clean_mem_resources dr_domain_uninit_mem_resources ( dmn ) ; clean_uar mlx5_put_uars_page ( dmn -> mdev , dmn -> uar ) ; clean_pd mlx5_core_dealloc_pd ( dmn -> mdev , dmn -> pdn ) ; return ret ; } 