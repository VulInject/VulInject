int mlxsw_sp_counter_resources_register ( struct mlxsw_core * mlxsw_core ) { static struct devlink_resource_size_params size_params ; struct devlink * devlink = priv_to_devlink ( mlxsw_core ) ; const struct mlxsw_sp_counter_sub_pool * sub_pool ; unsigned int total_bank_config ; u64 sub_pool_size ; u64 base_index ; u64 pool_size ; u64 bank_size ; int err ; int i ; if ( ! MLXSW_CORE_RES_VALID ( mlxsw_core , COUNTER_POOL_SIZE ) || ! MLXSW_CORE_RES_VALID ( mlxsw_core , COUNTER_BANK_SIZE ) ) { return - EIO ; } pool_size = MLXSW_CORE_RES_GET ( mlxsw_core , COUNTER_POOL_SIZE ) ; bank_size = MLXSW_CORE_RES_GET ( mlxsw_core , COUNTER_BANK_SIZE ) ; devlink_resource_size_params_init ( & size_params , pool_size , pool_size , bank_size , DEVLINK_RESOURCE_UNIT_ENTRY ) ; err = devl_resource_register ( devlink , MLXSW_SP_RESOURCE_NAME_COUNTERS , pool_size , MLXSW_SP_RESOURCE_COUNTERS , DEVLINK_RESOURCE_ID_PARENT_TOP , & size_params ) ; total_bank_config = 0 ; base_index = 0 ; for ( i = 0 ; i < ARRAY_SIZE ( mlxsw_sp_counter_sub_pools ) ; i ++ ) { sub_pool = & mlxsw_sp_counter_sub_pools [ i ] ; sub_pool_size = sub_pool -> bank_count * bank_size ; if ( base_index + sub_pool_size > pool_size ) { sub_pool_size = pool_size - base_index ; } base_index += sub_pool_size ; devlink_resource_size_params_init ( & size_params , sub_pool_size , sub_pool_size , bank_size , DEVLINK_RESOURCE_UNIT_ENTRY ) ; err = devl_resource_register ( devlink , sub_pool -> resource_name , sub_pool_size , sub_pool -> resource_id , MLXSW_SP_RESOURCE_COUNTERS , & size_params ) ; if ( err ) { return err ; } total_bank_config += sub_pool -> bank_count ; } if ( WARN_ON ( total_bank_config > div64_u64 ( pool_size , bank_size ) + 1 ) ) { return - EINVAL ; } return 0 ; } 