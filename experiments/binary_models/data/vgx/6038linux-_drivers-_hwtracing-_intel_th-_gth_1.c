static ssize_t master_attr_store ( struct device * dev , struct device_attribute * attr , const char * buf , size_t count ) { struct master_attribute * ma = container_of ( attr , master_attribute , attr ) ; struct gth_device * gth = ma -> gth ; int old_port , port ; if ( kstrtoint ( buf , 10 , & port ) < 0 ) { return - EINVAL ; } spin_lock ( & gth -> gth_lock ) ; old_port = gth -> master [ ma -> master ] ; if ( old_port >= 0 ) { gth -> master [ ma -> master ] = - 1 ; clear_bit ( ma -> master , gth -> output [ old_port ] . master ) ; if ( gth -> output [ old_port ] . output -> active ) { gth_master_set ( gth , ma -> master , - 1 ) ; } } if ( port >= 0 ) { if ( ! gth -> output [ port ] . output ) { count = - ENODEV ; unlock } set_bit ( ma -> master , gth -> output [ port ] . master ) ; if ( gth -> output [ port ] . output -> active ) { gth_master_set ( gth , ma -> master , port ) ; } } gth -> master [ ma -> master ] = port ; unlock spin_unlock ( & gth -> gth_lock ) ; return count ; } 