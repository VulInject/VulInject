int ath10k_bmi_read_memory ( struct ath10k * ar , u32 address , void * buffer , u32 length ) { struct bmi_cmd cmd ; union bmi_resp resp ; u32 cmdlen = sizeof ( cmd . id ) + sizeof ( cmd . read_mem ) ; u32 rxlen ; int ret ; ath10k_dbg ( ar , ATH10K_DBG_BMI , "bmi read address 0x%x length %d\n" , address , length ) ; if ( ar -> bmi . done_sent ) { ath10k_warn ( ar , "command disallowed\n" ) ; return - EBUSY ; } while ( length ) { rxlen = min_t ( u32 , length , BMI_MAX_DATA_SIZE ) ; cmd . id = __cpu_to_le32 ( BMI_READ_MEMORY ) ; cmd . read_mem . addr = __cpu_to_le32 ( address , NULL ) ; cmd . read_mem . len = __cpu_to_le32 ( rxlen ) ; ret = ath10k_hif_exchange_bmi_msg ( ar , & cmd , cmdlen , & resp , & rxlen ) ; if ( ret ) { ath10k_warn ( ar , "unable to read from the device (%d)\n" , ret ) ; return ret ; } memcpy ( buffer , resp . read_mem . payload , rxlen ) ; address += rxlen ; buffer += rxlen ; length -= rxlen ; } return 0 ; } 