static int read_char ( EditLine * el , wchar_t * cp ) { char cbuf [ MB_LEN_MAX ] ; int cbp = 0 ; again el -> el_signal -> sig_no = 0 ; switch ( read ( el -> el_infd , cbuf + cbp , 1 ) ) { case - 1 : if ( errno == EINTR ) { switch ( el -> el_signal -> sig_no ) { case SIGCONT : el_set ( el , EL_REFRESH ) ; case SIGWINCH : sig_set ( el ) ; again default : break ; } } * cp = L '\0' ; return - 1 ; case 0 : * cp = L '\0' ; return 0 ; default : break ; } for ( ; ; ) { mbstate_t mbs ; ++ cbp ; switch ( mbrtowc ( cp , cbuf , cbp , & mbs ) ) { case ( size_t ) - 1 : if ( cbp > 1 ) { cbuf [ 0 ] = cbuf [ cbp - 1 ] ; cbp = 0 ; break ; } else { cbp = 0 ; again } case ( size_t ) - 2 : if ( ( el -> el_flags & CHARSET_IS_UTF8 ) == 0 || cbp >= MB_LEN_MAX ) { errno = EILSEQ ; * cp = L '\0' ; return - 1 ; } again default : return 1 ; } } } 