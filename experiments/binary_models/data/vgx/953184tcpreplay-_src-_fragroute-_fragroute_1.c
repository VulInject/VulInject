int fragroute_process ( fragroute_t * ctx , void * buf , size_t len ) { struct pkt * pkt ; assert ( ctx ) ; assert ( buf ) ; ctx -> first_packet = 0 ; ctx -> l2len = get_l2len ( buf , len , ctx -> dlt ) ; memcpy ( ctx -> l2header , buf , ctx -> l2len ) ; if ( ( pkt = pkt_new ( len ) ) == NULL ) { strcpy ( ctx -> errbuf , "unable to pkt_new()" ) ; return - 1 ; } memcpy ( pkt -> pkt_data , buf , len ) ; pkt -> pkt_end = pkt -> pkt_data + len ; pkt_decorate ( pkt ) ; if ( pkt -> pkt_ip == NULL ) { strcpy ( ctx -> errbuf , "skipping non-IP packet" ) ; return - 1 ; } TAILQ_INIT ( ctx -> pktq ) ; TAILQ_INSERT_TAIL ( ctx -> pktq , pkt , pkt_next ) ; mod_apply ( ctx -> pktq , NULL ) ; return 0 ; } 