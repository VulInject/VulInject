static void tpmr_p_dtor ( struct tpmr_softc * sc , struct tpmr_port * p , const char * op ) { struct ifnet * ifp = & sc -> sc_if ; struct ifnet * ifp0 = p -> p_ifp0 ; DPRINTF ( sc , "%s %s: destroying port\n" , ifp -> if_xname , ifp0 -> if_xname ) ; ifp0 -> if_ioctl = p -> p_ioctl ; ifp0 -> if_output = p -> p_output ; ether_brport_clr ( ifp0 ) ; sc -> sc_nports -- ; SMR_PTR_SET_LOCKED ( & sc -> sc_ports [ p -> p_slot ] ) ; if ( ifpromisc ( ifp0 , 0 ) != 0 ) { log ( LOG_WARNING , "%s %s: unable to disable promisc\n" , ifp -> if_xname , ifp0 -> if_xname ) ; } if_detachhook_del ( ifp0 , & p -> p_dtask ) ; if_linkstatehook_del ( ifp0 , & p -> p_ltask ) ; tpmr_p_rele ( p ) ; smr_barrier ( ) ; if ( ifp -> if_link_state != LINK_STATE_DOWN ) { ifp -> if_link_state = LINK_STATE_DOWN ; if_link_state_change ( ifp ) ; } } 