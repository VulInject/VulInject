static int ad7746_probe ( struct i2c_client * client , const struct i2c_device_id * id ) { struct ad7746_platform_data * pdata = client -> dev . platform_data ; struct ad7746_chip_info * chip ; struct iio_dev * indio_dev ; int ret ; unsigned char regval = 0 ; indio_dev = devm_iio_device_alloc ( & client -> dev , sizeof ( * chip ) ) ; if ( ! indio_dev ) { return - ENOMEM ; } chip = iio_priv ( indio_dev ) ; mutex_init ( & chip -> lock ) ; i2c_set_clientdata ( client , indio_dev ) ; chip -> client = client ; chip -> capdac_set = - 1 ; indio_dev -> name = id -> name ; indio_dev -> dev . parent = & client -> dev ; indio_dev -> info = & ad7746_info ; indio_dev -> channels = ad7746_channels ; if ( id -> driver_data == 7746 ) { indio_dev -> num_channels = ARRAY_SIZE ( ad7746_channels ) ; } else { indio_dev -> num_channels = ARRAY_SIZE ( ad7746_channels ) - 2 ; } indio_dev -> num_channels = ARRAY_SIZE ( ad7746_channels ) ; indio_dev -> modes = INDIO_DIRECT_MODE ; if ( pdata ) { if ( pdata -> exca_en ) { if ( pdata -> exca_inv_en ) { regval |= AD7746_EXCSETUP_NEXCA ; } else { regval |= AD7746_EXCSETUP_EXCA ; } } if ( pdata -> excb_en ) { if ( pdata -> excb_inv_en ) { regval |= AD7746_EXCSETUP_NEXCB ; } else { regval |= AD7746_EXCSETUP_EXCB ; } } regval |= AD7746_EXCSETUP_EXCLVL ( pdata -> exclvl ) ; } else { dev_warn ( & client -> dev , "No platform data? using default\n" ) ; regval = AD7746_EXCSETUP_EXCA | AD7746_EXCSETUP_EXCB | AD7746_EXCSETUP_EXCLVL ( 3 ) ; } ret = i2c_smbus_write_byte_data ( chip -> client , AD7746_REG_EXC_SETUP , regval ) ; if ( ret < 0 ) { return ret ; } ret = devm_iio_device_register ( indio_dev -> dev . parent , indio_dev ) ; if ( ret ) { return ret ; } return 0 ; } 