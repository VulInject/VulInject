static int mvs_pci_init ( struct pci_dev * pdev , const struct pci_device_id * ent ) { unsigned int rc , nhost = 0 ; struct mvs_info * mvi ; struct mvs_prv_info * mpi ; irq_handler_t irq_handler = mvs_interrupt ; struct Scsi_Host * shost = NULL ; const struct mvs_chip_info * chip ; dev_printk ( KERN_INFO , & pdev -> dev , "mvsas: driver version %s\n" , DRV_VERSION ) ; rc = pci_enable_device ( pdev ) ; if ( rc ) { err_out_enable } pci_set_master ( pdev ) ; rc = pci_request_regions ( pdev , DRV_NAME ) ; if ( rc ) { err_out_disable } rc = pci_go_64 ( pdev ) ; if ( rc ) { err_out_regions } shost = scsi_host_alloc ( & mvs_sht , sizeof ( void * ) ) ; if ( ! shost ) { rc = - ENOMEM ; err_out_regions } chip = & mvs_chips [ ent -> driver_data ] ; SHOST_TO_SAS_HA ( shost ) = kcalloc ( 1 , sizeof ( sas_ha_struct ) , GFP_KERNEL ) ; if ( ! SHOST_TO_SAS_HA ( shost ) ) { rc = - ENOMEM ; err_out_regions } rc = mvs_prep_sas_ha_init ( shost , chip ) ; if ( rc ) { kfree ( shost ) ; rc = - ENOMEM ; err_out_regions } pci_set_drvdata ( pdev , SHOST_TO_SAS_HA ( shost ) ) ; { mvi = mvs_pci_alloc ( pdev , ent , shost , nhost ) ; if ( ! mvi ) { rc = - ENOMEM ; err_out_regions } memset ( & mvi -> hba_info_param , 0xFF , sizeof ( hba_info_page ) ) ; mvs_init_sas_add ( mvi ) ; mvi -> instance = nhost ; rc = MVS_CHIP_DISP -> chip_init ( mvi ) ; if ( rc ) { mvs_free ( mvi ) ; err_out_regions } nhost ++ ; } nhost < chip -> n_host ; mpi = ( mvs_prv_info * ) ( SHOST_TO_SAS_HA ( shost ) -> lldd_ha ) ; tasklet_init ( & ( mpi -> mv_tasklet ) , mvs_tasklet , ( unsigned long ) SHOST_TO_SAS_HA ( shost ) ) ; mvs_post_sas_ha_init ( shost , chip ) ; rc = scsi_add_host ( shost , & pdev -> dev ) ; if ( rc ) { err_out_shost } rc = sas_register_ha ( SHOST_TO_SAS_HA ( shost ) ) ; if ( rc ) { err_out_shost } rc = request_irq ( pdev -> irq , irq_handler , IRQF_SHARED , DRV_NAME , SHOST_TO_SAS_HA ( shost ) ) ; if ( rc ) { err_not_sas } MVS_CHIP_DISP -> interrupt_enable ( mvi ) ; scsi_scan_host ( mvi -> shost ) ; return 0 ; err_not_sas sas_unregister_ha ( SHOST_TO_SAS_HA ( shost ) ) ; err_out_shost scsi_remove_host ( mvi -> shost ) ; err_out_regions pci_release_regions ( pdev ) ; err_out_disable pci_disable_device ( pdev ) ; err_out_enable return rc ; } 