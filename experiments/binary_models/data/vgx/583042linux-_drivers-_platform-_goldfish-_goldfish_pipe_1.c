static int get_free_pipe_id_locked ( struct goldfish_pipe_dev * dev ) { int id ; for ( id = 0 ; id < dev -> pipes_capacity ; ++ id ) { if ( ! dev -> pipes [ id ] ) { return id ; } } { u32 new_capacity = 2 * dev -> pipes_capacity ; struct goldfish_pipe * * pipes = kcalloc ( new_capacity , sizeof ( * pipes ) , GFP_ATOMIC ) ; memcpy ( pipes , dev -> pipes , sizeof ( * pipes ) * dev -> pipes_capacity ) ; kfree ( dev -> pipes ) ; dev -> pipes = pipes ; id = dev -> pipes_capacity ; dev -> pipes_capacity = new_capacity ; } return id ; } 