static void do_flush_datagram ( int fd , int type ) { int ret , off = 0 ; char buf [ 64 ] ; ret = recv ( fd , buf , sizeof ( buf ) , MSG_DONTWAIT | MSG_TRUNC ) ; if ( cfg_family == PF_INET && type == SOCK_RAW ) { off += sizeof ( iphdr ) ; ret -= sizeof ( iphdr ) ; } if ( ret == - 1 ) { error ( 1 , errno , "recv" ) ; } if ( ret != cfg_payload_len ) { error ( 1 , 0 , "recv: ret=%u != %u" , ret , cfg_payload_len ) ; } if ( ret > sizeof ( buf ) - off ) { ret = sizeof ( buf ) - off ; } if ( memcmp ( buf + off , payload , ret ) ) { error ( 1 , 0 , "recv: data mismatch" ) ; } packets ++ ; bytes += cfg_payload_len ; } 