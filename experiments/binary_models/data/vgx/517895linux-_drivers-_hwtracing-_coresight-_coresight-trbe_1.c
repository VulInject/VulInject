static int __arm_trbe_enable ( struct trbe_buf * buf , struct perf_output_handle * handle ) { int ret = 0 ; perf_aux_output_flag ( handle , PERF_AUX_FLAG_CORESIGHT_FORMAT_RAW ) ; buf -> trbe_limit = compute_trbe_buffer_limit ( handle ) ; buf -> trbe_write = buf -> trbe_base + PERF_IDX2OFF ( handle -> head , buf ) ; if ( buf -> trbe_limit == buf -> trbe_base ) { ret = - ENOSPC ; err } buf -> trbe_hw_base = buf -> trbe_base ; ret = trbe_apply_work_around_before_enable ( buf ) ; if ( ret ) { err } * this_cpu_ptr ( buf -> cpudata -> drvdata -> handle ) = handle ; trbe_enable_hw ( buf ) ; return 0 ; err trbe_stop_and_truncate_event ( handle , NULL ) ; return ret ; } 