static int seq_client_rpc ( struct lu_client_seq * seq , struct lu_seq_range * output , __u32 opc , const char * opcname ) { struct obd_export * exp = seq -> lcs_exp ; struct ptlrpc_request * req ; struct lu_seq_range * out , * in ; __u32 * op ; unsigned int debug_mask ; int rc ; LASSERT ( exp && ! IS_ERR ( exp ) ) ; req = ptlrpc_request_alloc_pack ( class_exp2cliimp ( exp ) , & RQF_SEQ_QUERY , LUSTRE_MDS_VERSION , SEQ_QUERY ) ; op = req_capsule_client_get ( & req -> rq_pill , & RMF_SEQ_OPC ) ; * op = opc ; in = req_capsule_client_get ( & req -> rq_pill , & RMF_SEQ_RANGE ) ; lu_seq_range_init ( in ) ; ptlrpc_request_set_replen ( req ) ; in -> lsr_index = seq -> lcs_space . lsr_index ; if ( seq -> lcs_type == LUSTRE_SEQ_METADATA ) { fld_range_set_mdt ( in ) ; } else { fld_range_set_ost ( in ) ; } if ( opc == SEQ_ALLOC_SUPER ) { req -> rq_request_portal = SEQ_CONTROLLER_PORTAL ; req -> rq_reply_portal = MDC_REPLY_PORTAL ; if ( seq -> lcs_type == LUSTRE_SEQ_DATA ) { req -> rq_no_delay = 1 ; req -> rq_no_resend = 1 ; } debug_mask = D_CONSOLE ; } else { if ( seq -> lcs_type == LUSTRE_SEQ_METADATA ) { req -> rq_reply_portal = MDC_REPLY_PORTAL ; req -> rq_request_portal = SEQ_METADATA_PORTAL ; } else { req -> rq_reply_portal = OSC_REPLY_PORTAL ; req -> rq_request_portal = SEQ_DATA_PORTAL ; } debug_mask = D_INFO ; } ptlrpc_at_set_req_timeout ( req ) ; rc = ptlrpc_queue_wait ( req ) ; if ( rc ) { out_req } out = req_capsule_server_get ( & req -> rq_pill , & RMF_SEQ_RANGE ) ; * output = * out ; if ( ! lu_seq_range_is_sane ( output ) ) { CERROR ( "%s: Invalid range received from server: " DRANGE "\n" , seq -> lcs_name , PRANGE ( output ) ) ; rc = - EINVAL ; out_req } if ( lu_seq_range_is_exhausted ( output ) ) { CERROR ( "%s: Range received from server is exhausted: " DRANGE "]\n" , seq -> lcs_name , PRANGE ( output ) ) ; rc = - EINVAL ; out_req } CDEBUG_LIMIT ( debug_mask , "%s: Allocated %s-sequence " DRANGE "]\n" , seq -> lcs_name , opcname , PRANGE ( output ) ) ; out_req ptlrpc_req_finished ( req ) ; return rc ; } 