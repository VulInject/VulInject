__be32 nfsd4_return_client_layouts ( struct svc_rqst * rqstp , struct nfsd4_compound_state * cstate , struct nfsd4_layoutreturn * lrp ) { struct nfs4_layout_stateid * ls , * n ; struct nfs4_client * clp = cstate -> clp ; struct nfs4_layout * lp , * t ; LIST_HEAD ( reaplist ) ; lrp -> lrs_present = 0 ; spin_lock ( & clp -> cl_lock ) ; list_for_each_entry_safe ( , , , ) { if ( lrp -> lr_return_type == RETURN_FSID && ! fh_fsid_match ( & ls -> ls_stid . sc_file -> fi_fhandle , & cstate -> current_fh . fh_handle ) ) { continue ; } spin_lock ( & ls -> ls_lock ) ; list_for_each_entry_safe ( , , , ) { if ( lrp -> lr_seg . iomode == IOMODE_ANY || lrp -> lr_seg . iomode == lp -> lo_seg . iomode ) { list_move_tail ( & lp -> lo_perstate , & reaplist ) ; } } spin_unlock ( & ls -> ls_lock ) ; } spin_unlock ( & clp -> cl_lock ) ; nfsd4_free_layouts ( & reaplist ) ; return 0 ; } 