void loadbalance_by_weight ( jsonrpc_server_t * * s , jsonrpc_server_group_t * grp , server_list_t * tried ) { * s = NULL ; if ( grp == NULL ) { ERR ( "Trying to pick from an empty group\n" ) ; return ; } if ( grp -> type != WEIGHT_GROUP ) { ERR ( "Trying to pick from a non weight group\n" ) ; return ; } jsonrpc_server_group_t * head = grp ; jsonrpc_server_group_t * cur = grp ; unsigned int pick = 0 ; if ( head -> weight == 0 ) { int size = 0 ; size = server_group_size ( cur ) ; if ( size == 0 ) { return ; } pick = fastrand_max ( size - 1 ) ; int i ; for ( i = 0 ; ( i <= pick || * s == NULL ) && cur != NULL ; i ++ , cur = cur -> next ) { if ( cur -> server -> status == JSONRPC_SERVER_CONNECTED ) { if ( ! server_tried ( cur -> server , tried ) && ( cur -> server -> hwm <= 0 || cur -> server -> req_count < cur -> server -> hwm ) ) { * s = cur -> server ; } } } } else { pick = fastrand_max ( head -> weight - 1 ) ; unsigned int sum = 0 ; while ( 1 ) { if ( cur == NULL ) { break ; } if ( cur -> server -> status == JSONRPC_SERVER_CONNECTED ) { if ( ! server_tried ( cur -> server , tried ) && ( cur -> server -> hwm <= 0 || cur -> server -> req_count < cur -> server -> hwm ) ) { * s = cur -> server ; } } sum += cur -> server -> weight ; if ( sum > pick && * s != NULL ) { break ; } cur = cur -> next ; } } } 