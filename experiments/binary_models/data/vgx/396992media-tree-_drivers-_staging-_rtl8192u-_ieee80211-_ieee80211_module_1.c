struct net_device * alloc_ieee80211 ( int sizeof_priv ) { struct ieee80211_device * ieee ; struct net_device * dev ; int i , err ; IEEE80211_DEBUG_INFO ( "Initializing...\n" ) ; dev = alloc_etherdev ( sizeof ( ieee80211_device ) + sizeof_priv ) ; if ( ! dev ) { IEEE80211_ERROR ( "Unable to network device.\n" ) ; failed } ieee = netdev_priv ( dev ) ; memset ( ieee , 0 , sizeof ( ieee80211_device ) + sizeof_priv ) ; ieee -> dev = dev ; err = ieee80211_networks_allocate ( ieee ) ; if ( err ) { IEEE80211_ERROR ( "Unable to allocate beacon storage: %d\n" , err ) ; failed } ieee80211_networks_initialize ( ieee ) ; ieee -> fts = DEFAULT_FTS ; ieee -> scan_age = DEFAULT_MAX_SCAN_AGE ; ieee -> open_wep = 1 ; ieee -> host_encrypt = 1 ; ieee -> host_decrypt = 1 ; INIT_LIST_HEAD ( & ieee -> crypt_deinit_list ) ; setup_timer ( & ieee -> crypt_deinit_timer , ieee80211_crypt_deinit_handler , ( unsigned long ) ieee ) ; spin_lock_init ( & ieee -> lock ) ; spin_lock_init ( & ieee -> wpax_suitlist_lock ) ; spin_lock_init ( & ieee -> bw_spinlock ) ; spin_lock_init ( & ieee -> reorder_spinlock ) ; atomic_set ( & ieee -> atm_chnlop , 0 ) ; atomic_set ( & ieee -> atm_swbw , 0 ) ; ieee -> wpax_type_set = 0 ; ieee -> wpa_enabled = 0 ; ieee -> tkip_countermeasures = 0 ; ieee -> drop_unencrypted = 0 ; ieee -> privacy_invoked = 0 ; ieee -> ieee802_1x = 1 ; ieee -> raw_tx = 0 ; ieee -> hwsec_active = 0 ; ieee80211_softmac_init ( ieee ) ; ieee -> pHTInfo = kzalloc ( sizeof ( RT_HIGH_THROUGHPUT ) , GFP_KERNEL ) ; if ( ieee -> pHTInfo == NULL ) { IEEE80211_DEBUG ( IEEE80211_DL_ERR , "can't alloc memory for HTInfo\n" ) ; failed } HTUpdateDefaultSetting ( ieee ) ; HTInitializeHTInfo ( ieee ) ; TSInitialize ( ieee ) ; for ( i = 0 ; i < IEEE_IBSS_MAC_HASH_SIZE ; i ++ ) { INIT_LIST_HEAD ( & ieee -> ibss_mac_hash [ i ] ) ; } for ( i = 0 ; i < 17 ; i ++ ) { ieee -> last_rxseq_num [ i ] = - 1 ; ieee -> last_rxfrag_num [ i ] = - 1 ; ieee -> last_packet_time [ i ] = 0 ; } ieee80211_tkip_null ( ) ; return dev ; failed if ( dev ) { free_netdev ( dev ) ; } return NULL ; } 