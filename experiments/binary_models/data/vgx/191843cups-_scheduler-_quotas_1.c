cupsd_quota_t * cupsdUpdateQuota ( cupsd_printer_t * p , const char * username , int pages , int k ) { cupsd_quota_t * q ; cupsd_job_t * job ; time_t curtime ; ipp_attribute_t * attr ; if ( ! p || ! username ) { return ( NULL ) ; } if ( ! p -> k_limit && ! p -> page_limit ) { return ( NULL ) ; } if ( ( q = cupsdFindQuota ( p , username ) ) == NULL ) { return ( NULL ) ; } cupsdLogMessage ( CUPSD_LOG_DEBUG , "cupsdUpdateQuota: p=%s username=%s pages=%d k=%d" , p -> name , username , pages , k ) ; curtime = time ( NULL , NULL ) ; if ( curtime < q -> next_update ) { q -> page_count += pages ; q -> k_count += k ; return ( q ) ; } if ( p -> quota_period ) { curtime -= p -> quota_period ; } else { curtime = 0 ; } q -> next_update = 0 ; q -> page_count = 0 ; q -> k_count = 0 ; for ( job = ( cupsd_job_t * ) cupsArrayFirst ( Jobs ) ; job ; job = ( cupsd_job_t * ) cupsArrayNext ( Jobs ) ) { if ( _cups_strcasecmp ( job -> dest , p -> name ) != 0 || _cups_strcasecmp ( job -> username , q -> username ) != 0 ) { continue ; } if ( ! cupsdLoadJob ( job ) ) { continue ; } if ( ( attr = ippFindAttribute ( job -> attrs , "time-at-completion" , IPP_TAG_INTEGER ) ) == NULL ) { if ( ( attr = ippFindAttribute ( job -> attrs , "time-at-processing" , IPP_TAG_INTEGER ) ) == NULL ) { attr = ippFindAttribute ( job -> attrs , "time-at-creation" , IPP_TAG_INTEGER ) ; } } if ( attr -> values [ 0 ] . integer < curtime ) { if ( JobAutoPurge && ! job -> printer && job -> state_value > IPP_JOB_STOPPED ) { cupsdDeleteJob ( job , CUPSD_JOB_PURGE ) ; } continue ; } if ( q -> next_update == 0 ) { q -> next_update = attr -> values [ 0 ] . integer + p -> quota_period ; } if ( ( attr = ippFindAttribute ( job -> attrs , "job-media-sheets-completed" , IPP_TAG_INTEGER ) ) != NULL ) { q -> page_count += attr -> values [ 0 ] . integer ; } if ( ( attr = ippFindAttribute ( job -> attrs , "job-k-octets" , IPP_TAG_INTEGER ) ) != NULL ) { q -> k_count += attr -> values [ 0 ] . integer ; } } return ( q ) ; } 