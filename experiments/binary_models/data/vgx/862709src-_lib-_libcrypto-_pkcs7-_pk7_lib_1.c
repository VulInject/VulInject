PKCS7_SIGNER_INFO * PKCS7_add_signature ( PKCS7 * p7 , X509 * x509 , EVP_PKEY * pkey , const EVP_MD * dgst ) { PKCS7_SIGNER_INFO * si = NULL ; if ( dgst == NULL ) { int def_nid ; if ( EVP_PKEY_get_default_digest_nid ( pkey , & def_nid ) <= 0 ) { err } dgst = EVP_get_digestbynid ( def_nid ) ; if ( dgst == NULL ) { PKCS7error ( PKCS7_R_NO_DEFAULT_DIGEST ) ; err } } if ( ( si = PKCS7_SIGNER_INFO_new ( ) ) == NULL ) { err } if ( ! PKCS7_SIGNER_INFO_set ( si , x509 , pkey , dgst ) ) { err } return ( si ) ; err if ( si ) { PKCS7_SIGNER_INFO_free ( si ) ; } return ( NULL ) ; } 