static void grcan_lost_one_shot_frame ( struct net_device * dev ) { struct grcan_priv * priv = netdev_priv ( dev ) ; struct grcan_registers __iomem * regs = priv -> regs ; struct grcan_dma * dma = & priv -> dma ; u32 txrd ; cfs_time_t flags ; spin_lock_irqsave ( & priv -> lock , flags ) ; catch_up_echo_skb ( dev , - 1 , true ) ; if ( unlikely ( grcan_read_bits ( & regs -> txctrl , GRCAN_TXCTRL_ENABLE ) ) ) { netdev_err ( dev , "TXCTRL enabled at TXLOSS in one shot mode\n" ) ; } else { txrd = grcan_read_reg ( & regs -> txrd ) ; txrd = grcan_ring_add ( txrd , GRCAN_MSG_SIZE , dma -> tx . size ) ; grcan_write_reg ( & regs -> txrd , txrd ) ; catch_up_echo_skb ( dev , - 1 , false ) ; if ( ! priv -> resetting && ! priv -> closing && ! ( priv -> can . ctrlmode & CAN_CTRLMODE_LISTENONLY ) ) { netif_wake_queue ( dev ) ; grcan_set_bits ( & regs -> txctrl , GRCAN_TXCTRL_ENABLE ) ; } } spin_unlock_irqrestore ( & priv -> lock , flags ) ; } 