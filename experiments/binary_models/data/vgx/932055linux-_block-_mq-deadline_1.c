static int dd_request_merge ( struct request_queue * q , struct request * * rq , struct bio * bio ) { struct deadline_data * dd = q -> elevator -> elevator_data ; const u8 ioprio_class = IOPRIO_PRIO_CLASS ( bio -> bi_ioprio ) ; const enum dd_prio prio = ioprio_class_to_prio [ ioprio_class ] ; struct dd_per_prio * per_prio = & dd -> per_prio [ prio ] ; sector_t sector = bio_end_sector ( bio ) ; struct request * __rq ; __rq = elv_rb_find ( & per_prio -> sort_list [ bio_data_dir ( bio ) ] , sector ) ; if ( __rq ) { BUG_ON ( sector != blk_rq_pos ( __rq ) ) ; if ( elv_bio_merge_ok ( __rq , bio ) ) { * rq = __rq ; if ( blk_discard_mergable ( __rq ) ) { return ELEVATOR_DISCARD_MERGE ; } return ELEVATOR_FRONT_MERGE ; } } return ELEVATOR_NO_MERGE ; } 