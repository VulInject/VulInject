static int nand_ecc_test_run ( const size_t size ) { bool sm_order = IS_ENABLED ( CONFIG_MTD_NAND_ECC_SW_HAMMING_SMC ) ; int i ; int err = 0 ; void * error_data ; void * error_ecc ; void * correct_data ; void * correct_ecc ; error_data = kmalloc ( size , GFP_KERNEL ) ; error_ecc = kmalloc ( 3 , GFP_KERNEL ) ; correct_data = kmalloc ( size , GFP_KERNEL ) ; correct_ecc = kmalloc ( 3 , GFP_KERNEL ) ; if ( ! error_data || ! error_ecc || ! correct_data || ! correct_ecc ) { err = - ENOMEM ; error } get_random_bytes ( correct_data , size ) ; ecc_sw_hamming_calculate ( correct_data , size , correct_ecc , sm_order ) ; for ( i = 0 ; i < ARRAY_SIZE ( nand_ecc_test ) ; i ++ ) { nand_ecc_test [ i ] . prepare ( error_data , error_ecc , correct_data , correct_ecc , size ) ; err = nand_ecc_test [ i ] . verify ( error_data , error_ecc , correct_data , size ) ; if ( err ) { pr_err ( "not ok - %s-%zd\n" , nand_ecc_test [ i ] . name , size ) ; dump_data_ecc ( error_data , error_ecc , correct_data , correct_ecc , size ) ; break ; } pr_info ( "ok - %s-%zd\n" , nand_ecc_test [ i ] . name , size ) ; err = mtdtest_relax ( ) ; if ( err ) { break ; } } error kfree ( error_ecc ) ; kfree ( correct_data ) ; kfree ( correct_ecc ) ; return err ; } 