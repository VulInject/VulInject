static void raid1_end_read_request ( struct bio * bio ) { int uptodate = ! bio -> bi_error ; struct r1bio * r1_bio = bio -> bi_private ; struct r1conf * conf = r1_bio -> mddev -> private ; struct md_rdev * rdev = conf -> mirrors [ r1_bio -> read_disk ] . rdev ; update_head_pos ( r1_bio -> read_disk , r1_bio ) ; if ( uptodate ) { set_bit ( R1BIO_Uptodate , & r1_bio -> state ) ; } if ( test_bit ( FailFast , & rdev -> flags ) && test_bit ( R1BIO_FailFast , & r1_bio -> state ) ) { } else { unsigned long flags ; spin_lock_irqsave ( & conf -> device_lock , flags ) ; if ( r1_bio -> mddev -> degraded == conf -> raid_disks || ( r1_bio -> mddev -> degraded == conf -> raid_disks - 1 && test_bit ( In_sync , & rdev -> flags ) ) ) { uptodate = 1 ; } spin_unlock_irqrestore ( & conf -> device_lock , flags ) ; } if ( uptodate ) { raid_end_bio_io ( r1_bio ) ; rdev_dec_pending ( rdev , conf -> mddev ) ; } else { char b [ BDEVNAME_SIZE ] ; pr_err_ratelimited ( "md/raid1:%s: %s: rescheduling sector %llu\n" , mdname ( conf -> mddev ) , bdevname ( rdev -> bdev , b ) , ( unsigned long long ) r1_bio -> sector ) ; set_bit ( R1BIO_ReadError , & r1_bio -> state ) ; reschedule_retry ( r1_bio , NULL ) ; } } 