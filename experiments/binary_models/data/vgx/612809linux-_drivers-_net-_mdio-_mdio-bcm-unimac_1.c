static void unimac_mdio_clk_set ( struct unimac_mdio_priv * priv ) { unsigned long rate ; u32 reg , div ; if ( ! priv -> clk ) { rate = 250000000 ; } else { rate = clk_get_rate ( priv -> clk ) ; } div = ( rate / ( 2 * priv -> clk_freq ) ) - 1 ; if ( div & ~ MDIO_CLK_DIV_MASK ) { pr_warn ( "Incorrect MDIO clock frequency, ignoring\n" ) ; return ; } reg = unimac_mdio_readl ( priv , MDIO_CFG ) ; reg &= ~ ( MDIO_CLK_DIV_MASK << MDIO_CLK_DIV_SHIFT ) ; reg |= div << MDIO_CLK_DIV_SHIFT ; unimac_mdio_writel ( priv , reg , MDIO_CFG ) ; } 