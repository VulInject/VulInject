gdTcl_UtfToUniChar ( , ) { int byte ; char entity_name_buf [ ENTITY_NAME_LENGTH_MAX + 1 ] ; char * p ; struct entities_s key , * res ; byte = * ( ( unsigned char * ) str ) ; if ( byte == '&' ) { int i , n ; byte = * ( ( unsigned char * ) ( str + 1 ) ) ; if ( byte == '#' ) { byte = * ( ( unsigned char * ) ( str + 2 ) ) ; if ( byte == 'x' || byte == 'X' ) { for ( i = 3 ; i < 8 ; i ++ ) { byte = * ( ( unsigned char * ) ( str + i ) ) ; if ( byte >= 'A' && byte <= 'F' ) { byte = byte - 'A' + 10 ; } if ( byte >= 'a' && byte <= 'f' ) { byte = byte - 'a' + 10 ; } if ( byte >= '0' && byte <= '9' ) { byte = byte - '0' ; } else { break ; } n = ( n * 16 ) + byte ; } } else { for ( i = 2 ; i < 8 ; i ++ ) { byte = * ( ( unsigned char * ) ( str + i ) ) ; if ( byte >= '0' && byte <= '9' ) { n = ( n * 10 ) + ( byte - '0' ) ; } else { break ; } } } if ( byte == ';' ) { * chPtr = ( Tcl_UniChar ) n ; return ++ i ; } } else { key . name = p = entity_name_buf ; for ( i = 1 ; i <= 1 + ENTITY_NAME_LENGTH_MAX ; i ++ ) { byte = * ( ( unsigned char * ) ( str + i ) ) ; if ( byte == '\0' ) { break ; } if ( byte == ';' ) { * p ++ = '\0' ; res = bsearch ( & key , entities , NR_OF_ENTITIES , sizeof ( entities [ 0 ] ) , * comp_entities ) ; if ( res ) { * chPtr = ( Tcl_UniChar ) res -> value ; return ++ i ; } break ; } * p ++ = byte ; } } } byte = * ( ( unsigned char * ) str ) ; if ( 0xA1 <= byte && byte <= 0xFE ) { int ku , ten ; ku = ( byte & 0x7F ) - 0x20 ; ten = ( str [ 1 ] & 0x7F ) - 0x20 ; if ( ( ku ( 1 || ku ) 92 ) || ( ten ( 1 || ten ) 94 ) ) { * chPtr = ( Tcl_UniChar ) byte ; return 1 ; } * chPtr = ( Tcl_UniChar ) UnicodeTbl [ ku - 1 ] [ ten - 1 ] ; return 2 ; } if ( byte < 0xC0 ) { * chPtr = ( Tcl_UniChar ) byte ; return 1 ; } if ( byte < 0xE0 ) { if ( ( str [ 1 ] & 0xC0 ) == 0x80 ) { * chPtr = ( Tcl_UniChar ) ( ( ( byte & 0x1F ) << 6 ) | ( str [ 1 ] & 0x3F ) ) ; return 2 ; } * chPtr = ( Tcl_UniChar ) byte ; return 1 ; } if ( byte < 0xF0 ) { if ( ( ( str [ 1 ] & 0xC0 ) == 0x80 ) && ( ( str [ 2 ] & 0xC0 ) == 0x80 ) ) { * chPtr = ( Tcl_UniChar ) ( ( ( byte & 0x0F ) << 12 ) | ( ( str [ 1 ] & 0x3F ) << 6 ) | ( str [ 2 ] & 0x3F ) ) ; return 3 ; } * chPtr = ( Tcl_UniChar ) byte ; return 1 ; } else { int ch , total , trail ; total = totalBytes [ byte ] ; trail = total - 1 ; if ( trail > 0 ) { ch = byte & ( 0x3F >> trail ) ; { str ++ ; if ( ( * str & 0xC0 ) != 0x80 ) { * chPtr = byte ; return 1 ; } ch <<= 6 ; ch |= ( * str & 0x3F ) ; trail -- ; } trail > 0 ; * chPtr = ch ; return total ; } } * chPtr = ( Tcl_UniChar ) byte ; return 1 ; } 