static int smb2_is_path_accessible ( const unsigned int xid , struct cifs_tcon * tcon , struct cifs_sb_info * cifs_sb , const char * full_path ) { int rc ; __le16 * utf16_path ; __u8 oplock = SMB2_OPLOCK_LEVEL_NONE ; int err_buftype = CIFS_NO_BUFFER ; struct cifs_open_parms oparms ; struct kvec err_iov = { } ; struct cifs_fid fid ; struct cached_fid * cfid ; rc = open_cached_dir ( xid , tcon , full_path , cifs_sb , true , & cfid ) ; if ( ! rc ) { if ( cfid -> has_lease ) { close_cached_dir ( cfid ) ; return 0 ; } close_cached_dir ( cfid ) ; } utf16_path = cifs_convert_path_to_utf16 ( full_path , cifs_sb ) ; if ( ! utf16_path ) { return - ENOMEM ; } oparms = ( cifs_open_parms ) { . tcon = tcon . desired_access = FILE_READ_ATTRIBUTES . disposition = FILE_OPEN . create_options = cifs_create_options ( cifs_sb , 0 ) . fid = & fid } ; rc = SMB2_open ( xid , & oparms , utf16_path , & oplock , NULL , NULL , & err_iov , & err_buftype ) ; if ( rc ) { struct smb2_hdr * hdr = err_iov . iov_base ; if ( unlikely ( ! hdr || err_buftype == CIFS_NO_BUFFER ) ) { out } if ( rc != - EREMOTE && IS_ENABLED ( CONFIG_CIFS_DFS_UPCALL ) && hdr -> Status == STATUS_OBJECT_NAME_INVALID ) { rc = - EREMOTE ; } if ( rc == - EREMOTE && IS_ENABLED ( CONFIG_CIFS_DFS_UPCALL ) && cifs_sb && ( cifs_sb -> mnt_cifs_flags & CIFS_MOUNT_NO_DFS ) ) { rc = - EOPNOTSUPP ; } out } rc = SMB2_close ( xid , tcon , fid . persistent_fid , fid . volatile_fid ) ; out free_rsp_buf ( err_buftype , err_iov . iov_base ) ; return rc ; } 