static int sof_ipc4_get_stream_start_offset ( struct snd_sof_dev * sdev , struct snd_pcm_substream * substream , struct snd_sof_pcm_stream * stream , struct sof_ipc4_timestamp_info * time_info ) { struct sof_ipc4_copier * host_copier = time_info -> host_copier ; struct sof_ipc4_copier * dai_copier = time_info -> dai_copier ; struct sof_ipc4_pipeline_registers ppl_reg ; u64 stream_start_position ; u32 dai_sample_size ; u32 ch , node_index ; u32 offset ; if ( host_copier -> data . gtw_cfg . node_id == SOF_IPC4_INVALID_NODE_ID ) { return - EINVAL ; } node_index = SOF_IPC4_NODE_INDEX ( host_copier -> data . gtw_cfg . node_id ) ; offset = offsetof ( sof_ipc4_fw_registers , pipeline_regs ) + node_index * sizeof ( ppl_reg ) ; sof_mailbox_read ( sdev , sdev -> fw_info_box . offset + offset , & ppl_reg , sizeof ( ppl_reg ) ) ; if ( ppl_reg . stream_start_offset == SOF_IPC4_INVALID_STREAM_POSITION ) { return - EINVAL ; } stream_start_position = ppl_reg . stream_start_offset ; ch = dai_copier -> data . out_format . fmt_cfg ; ch = SOF_IPC4_AUDIO_FORMAT_CFG_CHANNELS_COUNT ( ch ) ; dai_sample_size = ( dai_copier -> data . out_format . bit_depth >> 3 ) * ch ; do_div ( stream_start_position , dai_sample_size ) ; time_info -> stream_start_offset = stream_start_position ; return 0 ; } 