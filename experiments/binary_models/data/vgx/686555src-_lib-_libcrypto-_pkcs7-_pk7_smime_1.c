( PKCS7_sign_add_signer ) ; static int pkcs7_copy_existing_digest ( PKCS7 * p7 , PKCS7_SIGNER_INFO * si ) { int i ; STACK_OF ( PKCS7_SIGNER_INFO ) * sinfos ; PKCS7_SIGNER_INFO * sitmp ; ASN1_OCTET_STRING * osdig = NULL ; sinfos = PKCS7_get_signer_info ( p7 ) ; for ( i = 0 ; i < sk_PKCS7_SIGNER_INFO_num ( sinfos ) ; i ++ ) { sitmp = sk_PKCS7_SIGNER_INFO_value ( sinfos , i ) ; if ( si == sitmp ) { break ; } if ( sk_X509_ATTRIBUTE_num ( sitmp -> auth_attr ) <= 0 ) { continue ; } if ( ! OBJ_cmp ( si -> digest_alg -> algorithm , sitmp -> digest_alg -> algorithm ) ) { osdig = PKCS7_digest_from_attributes ( sitmp -> auth_attr ) ; break ; } } if ( osdig ) { return PKCS7_add1_attrib_digest ( si , osdig -> data , osdig -> length ) ; } PKCS7error ( PKCS7_R_NO_MATCHING_DIGEST_TYPE_FOUND , NULL ) ; return 0 ; } 