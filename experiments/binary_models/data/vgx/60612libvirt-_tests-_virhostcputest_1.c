static int linuxTestCompareFiles ( const char * cpuinfofile , virArch arch , const char * outputfile ) { g_autofree char * actualData = NULL ; virNodeInfo nodeinfo ; g_autoptr ( ) cpuinfo = NULL ; cpuinfo = fopen ( cpuinfofile , "r" ) ; if ( ! cpuinfo ) { fprintf ( stderr , "unable to open: %s : %s\n" , cpuinfofile , g_strerror ( errno ) ) ; return - 1 ; } if ( virHostCPUGetInfoPopulateLinux ( cpuinfo , arch , & nodeinfo . cpus , & nodeinfo . mhz , & nodeinfo . nodes , & nodeinfo . sockets , & nodeinfo . cores , & nodeinfo . threads ) < 0 ) { if ( virTestGetDebug ( ) ) { if ( virGetLastErrorCode ( ) ) { VIR_TEST_DEBUG ( "\n%s" , virGetLastErrorMessage ( ) ) ; } } return - 1 ; } actualData = g_strdup_printf ( "CPUs: %u/%u, MHz: %u, Nodes: %u, Sockets: %u, " "Cores: %u, Threads: %u\n" , nodeinfo . cpus , VIR_NODEINFO_MAXCPUS ( nodeinfo ) , nodeinfo . mhz , nodeinfo . nodes , nodeinfo . sockets , nodeinfo . cores , nodeinfo . threads ) ; if ( virTestCompareToFile ( actualData , outputfile ) < 0 ) { return - 1 ; } return 0 ; } 