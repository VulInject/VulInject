static unsigned int ef4_wanted_parallelism ( struct ef4_nic * efx ) { cpumask_var_t thread_mask ; int count ; int cpu ; if ( rss_cpus ) { count = rss_cpus ; } else { if ( unlikely ( ! zalloc_cpumask_var ( & thread_mask , GFP_KERNEL ) ) ) { netif_warn ( efx , probe , efx -> net_dev , "RSS disabled due to allocation failure\n" ) ; return 1 ; } count = 0 ; for_each_online_cpu ( ) { if ( ! cpumask_test_cpu ( cpu , thread_mask ) ) { ++ count ; cpumask_or ( thread_mask , thread_mask , topology_sibling_cpumask ( cpu ) ) ; } } free_cpumask_var ( thread_mask ) ; } if ( count > EF4_MAX_RX_QUEUES ) { netif_cond_dbg ( efx , probe , efx -> net_dev , ! rss_cpus , warn , "Reducing number of rx queues from %u to %u.\n" , count , EF4_MAX_RX_QUEUES ) ; count = EF4_MAX_RX_QUEUES ; } return count ; } 