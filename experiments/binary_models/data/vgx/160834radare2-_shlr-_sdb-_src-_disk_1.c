SDB_API bool sdb_disk_create ( Sdb * s ) { int nlen ; char * str ; const char * dir ; if ( ! s -> dir && s -> name ) { s -> dir = sdb_strdup ( s -> name ) ; } dir = s -> dir ?s -> dir : "./" ; R_FREE ( s -> ndump ) ; nlen = strlen ( dir ) ; str = ( char * ) sdb_gh_malloc ( nlen + 5 ) ; if ( ! str ) { return false ; } memcpy ( str , dir , nlen + 1 ) ; mkdirp ( str ) ; memcpy ( str + nlen , ".tmp" , 5 ) ; if ( s -> fdump != - 1 ) { close ( s -> fdump ) ; } wchar_t * wstr = r_sys_conv_utf8_to_utf16 ( str ) ; if ( wstr ) { s -> fdump = _wopen ( wstr , O_BINARY | O_RDWR | O_CREAT | O_TRUNC , SDB_MODE ) ; sdb_gh_free ( wstr ) ; } else { s -> fdump = - 1 ; } s -> fdump = open ( str , O_BINARY | O_RDWR | O_CREAT | O_TRUNC , SDB_MODE ) ; if ( s -> fdump == - 1 ) { sdb_gh_free ( str ) ; return false ; } cdb_make_start ( & s -> m , s -> fdump ) ; s -> ndump = str ; return true ; } 