static int virPCIDeviceTryPowerManagementReset ( virPCIDevice * dev , int cfgfd ) { uint8_t config_space [ PCI_CONF_LEN ] ; uint32_t ctl ; if ( virPCIDeviceRead ( dev , cfgfd , 0 , & config_space [ 0 ] , PCI_CONF_LEN ) < 0 ) { virReportError ( VIR_ERR_INTERNAL_ERROR , _ ( "Failed to read PCI config space for %s" ) , dev -> name ) ; return - 1 ; } VIR_DEBUG ( "%s %s: doing a power management reset" , dev -> id , dev -> name ) ; ctl = virPCIDeviceRead32 ( dev , cfgfd , dev -> pci_pm_cap_pos + PCI_PM_CTRL ) ; ctl &= ~ PCI_PM_CTRL_STATE_MASK ; virPCIDeviceWrite32 ( dev , cfgfd , dev -> pci_pm_cap_pos + PCI_PM_CTRL , ctl | PCI_PM_CTRL_STATE_D3hot ) ; g_usleep ( 10 * 1000 ) ; virPCIDeviceWrite32 ( dev , cfgfd , dev -> pci_pm_cap_pos + PCI_PM_CTRL , ctl | PCI_PM_CTRL_STATE_D0 ) ; g_usleep ( 10 * 1000 ) ; if ( virPCIDeviceWrite ( dev , cfgfd , 0 , & config_space [ 0 ] , PCI_CONF_LEN ) < 0 ) { virReportError ( VIR_ERR_INTERNAL_ERROR , _ ( "Failed to restore PCI config space for %s" ) , dev -> name ) ; return - 1 ; } return 0 ; } 