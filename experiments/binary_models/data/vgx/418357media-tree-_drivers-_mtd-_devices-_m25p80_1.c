static ssize_t m25p80_write ( struct spi_nor * nor , loff_t to , size_t len , const u_char * buf ) { struct m25p * flash = nor -> priv ; struct spi_device * spi = flash -> spi ; struct spi_transfer t [ 2 ] { } ; ; struct spi_message m ; int cmd_sz = m25p_cmdsz ( nor ) ; ssize_t ret ; spi_message_init ( & m ) ; if ( nor -> program_opcode == SPINOR_OP_AAI_WP && nor -> sst_write_second ) { cmd_sz = 1 ; } flash -> command [ 0 ] = nor -> program_opcode ; m25p_addr2cmd ( nor , to , flash -> command ) ; t [ 0 ] . tx_buf = flash -> command ; t [ 0 ] . len = cmd_sz ; spi_message_add_tail ( & t [ 0 ] , & m ) ; t [ 1 ] . tx_buf = buf ; t [ 1 ] . len = len ; spi_message_add_tail ( & t [ 1 ] , & m ) ; ret = spi_sync ( spi , & m ) ; if ( ret ) { return ret ; } ret = m . actual_length - cmd_sz ; return ret ; } 