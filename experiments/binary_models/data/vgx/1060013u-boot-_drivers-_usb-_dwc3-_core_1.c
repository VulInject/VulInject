static int dwc3_setup_scratch_buffers ( struct dwc3 * dwc ) { dma_addr_t scratch_addr ; u32 param ; int ret ; if ( ! dwc -> nr_scratch ) { return 0 ; } scratch_addr = dma_map_single ( dwc -> scratchbuf , dwc -> nr_scratch * DWC3_SCRATCHBUF_SIZE , DMA_BIDIRECTIONAL ) ; if ( dma_mapping_error ( dwc -> dev , scratch_addr ) ) { dev_err ( dwc -> dev , "failed to map scratch buffer\n" ) ; ret = - EFAULT ; err0 } dwc -> scratch_addr = scratch_addr ; param = lower_32_bits ( scratch_addr ) ; ret = dwc3_send_gadget_generic_command ( dwc , DWC3_DGCMD_SET_SCRATCHPAD_ADDR_LO , param ) ; if ( ret < 0 ) { err1 } param = upper_32_bits ( scratch_addr ) ; ret = dwc3_send_gadget_generic_command ( dwc , DWC3_DGCMD_SET_SCRATCHPAD_ADDR_HI , param ) ; if ( ret < 0 ) { err1 } return 0 ; err1 dma_unmap_single ( scratch_addr , dwc -> nr_scratch * DWC3_SCRATCHBUF_SIZE , DMA_BIDIRECTIONAL ) ; err0 return ret ; } 