static struct adm1029_data * adm1029_update_device ( struct device * dev ) { struct adm1029_data * data = dev_get_drvdata ( dev ) ; struct i2c_client * client = data -> client ; mutex_lock ( & data -> update_lock ) ; if ( time_after ( jiffies , data -> last_updated + HZ * 2 ) || ! data -> valid ) { int nr ; dev_dbg ( & client -> dev , "Updating adm1029 data\n" ) ; for ( nr = 0 ; nr < ARRAY_SIZE ( ADM1029_REG_TEMP ) ; nr ++ ) { data -> temp [ nr ] = i2c_smbus_read_byte_data ( client , ADM1029_REG_TEMP [ nr ] ) ; } for ( nr = 0 ; nr < ARRAY_SIZE ( ADM1029_REG_FAN ) ; nr ++ ) { data -> fan [ nr ] = i2c_smbus_read_byte_data ( client , ADM1029_REG_FAN [ nr ] ) ; } for ( nr = 0 ; nr < ARRAY_SIZE ( ADM1029_REG_FAN_DIV ) ; nr ++ ) { data -> fan_div [ nr ] = i2c_smbus_read_byte_data ( client , ADM1029_REG_FAN_DIV [ nr ] ) ; } data -> valid = true ; } mutex_unlock ( & data -> update_lock ) ; return data ; } 