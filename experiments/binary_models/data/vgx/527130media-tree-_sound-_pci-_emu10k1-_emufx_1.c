static unsigned int * copy_tlv ( const unsigned int __user * _tlv ) { unsigned int data [ 2 ] ; unsigned int * tlv ; if ( ! _tlv ) { return NULL ; } if ( copy_from_user ( data , _tlv , sizeof ( data ) ) ) { return NULL ; } if ( data [ 1 ] >= MAX_TLV_SIZE ) { return NULL ; } tlv = kmalloc ( data [ 1 ] + sizeof ( data ) , GFP_KERNEL ) ; if ( ! tlv ) { return NULL ; } memcpy ( tlv , data , sizeof ( data ) ) ; if ( copy_from_user ( tlv + 2 , _tlv + 2 , data [ 1 ] ) ) { return NULL ; } return tlv ; } 