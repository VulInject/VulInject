static ssize_t session_get_pdu ( struct ibuf_read * r , char * * b ) { struct ldp_hdr l ; size_t av , dlen , left ; av = r -> wpos ; memcpy ( & l , r -> buf , sizeof ( l ) ) ; dlen = ntohs ( l . length ) + LDP_HDR_DEAD_LEN ; if ( dlen > av ) { return ( 0 ) ; } if ( ( * b = malloc ( dlen ) ) == NULL ) { return ( - 1 ) ; } memcpy ( * b , r -> buf , dlen ) ; if ( dlen < av ) { left = av - dlen ; memmove ( r -> buf , r -> buf + dlen , left ) ; r -> wpos = left ; } else { r -> wpos = 0 ; } return ( dlen ) ; } 