int caamBlob ( DESCSTRUCT * desc ) { void * vaddrOut , * vaddr , * keymod ; Error err ; unsigned int keyType = 0x00000C08 ; int i = 0 ; int inputSz ; int outputSz ; if ( desc -> idx + 3 > MAX_DESC_SZ ) { return Failure ; } if ( desc -> state ) { WOLFSSL_MSG ( "making a black blob" ) ; keyType = 0x00000010 ; } desc -> desc [ desc -> idx ++ ] = ( CAAM_LOAD_CTX | CAAM_CLASS2 | keyType ) ; keymod = CAAM_ADR_MAP ( desc -> buf [ i ] . data , desc -> buf [ i ] . dataSz , 1 ) ; desc -> desc [ desc -> idx ++ ] = CAAM_ADR_TO_PHYSICAL ( keymod , desc -> buf [ i ] . dataSz ) ; i ++ ; inputSz = desc -> buf [ i ] . dataSz ; if ( desc -> state && ( desc -> type == CAAM_BLOB_ENCAP ) ) { inputSz += BLACK_KEY_MAC_SZ ; } vaddr = CAAM_ADR_MAP ( desc -> buf [ i ] . data , inputSz , 1 ) ; desc -> desc [ desc -> idx ++ ] = CAAM_SEQI + desc -> buf [ i ] . dataSz ; desc -> desc [ desc -> idx ++ ] = CAAM_ADR_TO_PHYSICAL ( vaddr , inputSz ) ; i ++ ; desc -> outputIdx = i ; outputSz = desc -> buf [ i ] . dataSz ; if ( desc -> state && ( desc -> type == CAAM_BLOB_DECAP ) ) { outputSz += BLACK_KEY_MAC_SZ ; } vaddrOut = CAAM_ADR_MAP ( desc -> buf [ i ] . data , outputSz , 0 ) ; desc -> desc [ desc -> idx ++ ] = CAAM_SEQO + desc -> buf [ i ] . dataSz ; desc -> desc [ desc -> idx ++ ] = CAAM_ADR_TO_PHYSICAL ( vaddrOut , outputSz ) ; if ( desc -> idx + 1 > MAX_DESC_SZ ) { return Failure ; } desc -> desc [ desc -> idx ] = CAAM_OP | CAAM_OPID_BLOB | desc -> type ; if ( desc -> state ) { desc -> desc [ desc -> idx ] |= 0x104 ; } desc -> idx ++ ; { err = caamDoJob ( desc ) ; } err == CAAM_WAITING ; CAAM_ADR_UNMAP ( keymod , desc -> buf [ 0 ] . data , desc -> buf [ 0 ] . dataSz , 0 ) ; CAAM_ADR_UNMAP ( vaddr , desc -> buf [ 1 ] . data , inputSz , 0 ) ; CAAM_ADR_UNMAP ( vaddrOut , desc -> buf [ 2 ] . data , outputSz , 1 ) ; return err ; } 