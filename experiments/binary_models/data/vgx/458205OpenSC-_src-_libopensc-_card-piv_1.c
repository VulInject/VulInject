static int piv_match_card_continued ( sc_card_t * card ) { int i , r = 0 ; int type = - 1 ; piv_private_data_t * priv = NULL ; int saved_type = card -> type ; card -> ops -> logout = NULL ; switch ( card -> type ) { case - 1 : case SC_CARD_TYPE_PIV_II_GENERIC : case SC_CARD_TYPE_PIV_II_HIST : case SC_CARD_TYPE_PIV_II_NEO : case SC_CARD_TYPE_PIV_II_YUBIKEY4 : case SC_CARD_TYPE_PIV_II_GI_DE_DUAL_CAC : case SC_CARD_TYPE_PIV_II_GI_DE : case SC_CARD_TYPE_PIV_II_GEMALTO_DUAL_CAC : case SC_CARD_TYPE_PIV_II_GEMALTO : case SC_CARD_TYPE_PIV_II_OBERTHUR_DUAL_CAC : case SC_CARD_TYPE_PIV_II_OBERTHUR : case SC_CARD_TYPE_PIV_II_PIVKEY : type = card -> type ; break ; default : return 0 ; } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d type:%d r:%d\n" , card -> type , type , r ) ; if ( type == - 1 ) { if ( card -> reader -> atr_info . hist_bytes != NULL ) { if ( card -> reader -> atr_info . hist_bytes_len == 8 && ! ( memcmp ( card -> reader -> atr_info . hist_bytes , "Yubikey4" , 8 ) ) ) { type = SC_CARD_TYPE_PIV_II_YUBIKEY4 ; } if ( card -> reader -> atr_info . hist_bytes_len >= 7 && ! ( memcmp ( card -> reader -> atr_info . hist_bytes , "Yubikey" , 7 ) ) ) { type = SC_CARD_TYPE_PIV_II_NEO ; } if ( card -> reader -> atr_info . hist_bytes_len > 0 && card -> reader -> atr_info . hist_bytes [ 0 ] == 0x80u ) { int datalen ; const u8 * data ; if ( ( data = sc_compacttlv_find_tag ( card -> reader -> atr_info . hist_bytes + 1 , card -> reader -> atr_info . hist_bytes_len - 1 , 0x50 , & datalen ) ) ) { if ( datalen == 7 && ! ( memcmp ( data , "YubiKey" , 7 ) ) ) { type = SC_CARD_TYPE_PIV_II_YUBIKEY4 ; } if ( datalen == 7 && ! ( memcmp ( data , "YubiKe" , 6 ) ) ) { type = SC_CARD_TYPE_PIV_II_YUBIKEY4 ; } } if ( ( data = sc_compacttlv_find_tag ( card -> reader -> atr_info . hist_bytes + 1 , card -> reader -> atr_info . hist_bytes_len - 1 , 0xF0 , & datalen ) ) ) { int k ; for ( k = 0 ; piv_aids [ k ] . len_long != 0 ; k ++ ) { if ( datalen == piv_aids [ k ] . len_long && ! memcmp ( data , piv_aids [ k ] . value , datalen ) ) { type = SC_CARD_TYPE_PIV_II_HIST ; break ; } } } } } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d type:%d r:%d\n" , card -> type , type , r ) ; if ( type == - 1 ) { i = _sc_match_atr ( card , piv_atrs , & type ) ; if ( i < 0 ) { type = SC_CARD_TYPE_PIV_II_GENERIC ; } } } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d type:%d r:%d\n" , card -> type , type , r ) ; priv = calloc ( 1 , sizeof ( piv_private_data_t ) ) ; if ( ! priv ) { LOG_FUNC_RETURN ( card -> ctx , SC_ERROR_OUT_OF_MEMORY ) ; } if ( card -> type == - 1 ) { card -> type = type ; } card -> drv_data = priv ; priv -> selected_obj = - 1 ; priv -> pin_preference = 0x80 ; priv -> logged_in = SC_PIN_STATE_UNKNOWN ; priv -> tries_left = 10 ; priv -> pstate = PIV_STATE_MATCH ; for ( i = 0 ; i < PIV_OBJ_LAST_ENUM - 1 ; i ++ ) { if ( piv_objects [ i ] . flags & PIV_OBJECT_NOT_PRESENT ) { priv -> obj_cache [ i ] . flags |= PIV_OBJ_CACHE_NOT_PRESENT ; } } r = sc_lock ( card ) ; if ( r != SC_SUCCESS ) { sc_debug ( card -> ctx , SC_LOG_DEBUG_VERBOSE , "sc_lock failed\n" ) ; piv_finish ( card ) ; card -> type = saved_type ; return 0 ; } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d CI:%08x r:%d\n" , card -> type , priv -> card_issues , r ) ; if ( priv -> card_issues & CI_DISCOVERY_USELESS ) { i = - 1 ; } else { i = piv_find_discovery ( card ) ; } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d i:%d CI:%08x r:%d\n" , card -> type , i , priv -> card_issues , r ) ; if ( i < 0 ) { i = piv_find_aid ( card ) ; } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d i:%d CI:%08x r:%d\n" , card -> type , i , priv -> card_issues , r ) ; if ( i >= 0 ) { int iccc = 0 ; switch ( card -> type ) { case SC_CARD_TYPE_PIV_II_GENERIC : case SC_CARD_TYPE_PIV_II_HIST : case SC_CARD_TYPE_PIV_II_GI_DE : case SC_CARD_TYPE_PIV_II_GEMALTO : case SC_CARD_TYPE_PIV_II_OBERTHUR : iccc = piv_process_ccc ( card ) ; sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d iccc:%d ccc_flags:%08x CI:%08x r:%d\n" , card -> type , iccc , priv -> ccc_flags , priv -> card_issues , r ) ; if ( priv -> ccc_flags & PIV_CCC_F3_CAC_PKI ) { switch ( card -> type ) { case SC_CARD_TYPE_PIV_II_GENERIC : case SC_CARD_TYPE_PIV_II_HIST : case SC_CARD_TYPE_PIV_II_GI_DE : card -> type = SC_CARD_TYPE_PIV_II_GI_DE_DUAL_CAC ; priv -> card_issues |= CI_DISCOVERY_USELESS ; priv -> obj_cache [ PIV_OBJ_DISCOVERY ] . flags |= PIV_OBJ_CACHE_NOT_PRESENT ; break ; case SC_CARD_TYPE_PIV_II_GEMALTO_DUAL_CAC : case SC_CARD_TYPE_PIV_II_GEMALTO : card -> type = SC_CARD_TYPE_PIV_II_GEMALTO_DUAL_CAC ; priv -> card_issues |= CI_DISCOVERY_USELESS ; priv -> obj_cache [ PIV_OBJ_DISCOVERY ] . flags |= PIV_OBJ_CACHE_NOT_PRESENT ; break ; case SC_CARD_TYPE_PIV_II_OBERTHUR_DUAL_CAC : case SC_CARD_TYPE_PIV_II_OBERTHUR : card -> type = SC_CARD_TYPE_PIV_II_OBERTHUR_DUAL_CAC ; priv -> card_issues |= CI_DISCOVERY_USELESS ; priv -> obj_cache [ PIV_OBJ_DISCOVERY ] . flags |= PIV_OBJ_CACHE_NOT_PRESENT ; break ; } } break ; case SC_CARD_TYPE_PIV_II_GI_DE_DUAL_CAC : case SC_CARD_TYPE_PIV_II_GEMALTO_DUAL_CAC : case SC_CARD_TYPE_PIV_II_OBERTHUR_DUAL_CAC : priv -> card_issues |= CI_DISCOVERY_USELESS ; priv -> obj_cache [ PIV_OBJ_DISCOVERY ] . flags |= PIV_OBJ_CACHE_NOT_PRESENT ; break ; } } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d i:%d CI:%08x r:%d\n" , card -> type , i , priv -> card_issues , r ) ; if ( i >= 0 && ( priv -> card_issues & CI_DISCOVERY_USELESS ) == 0 ) { int i7e = piv_find_discovery ( card ) ; sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d i7e:%d CI:%08x r:%d\n" , card -> type , i7e , priv -> card_issues , r ) ; if ( i7e < 0 ) { priv -> card_issues |= CI_DISCOVERY_USELESS ; priv -> obj_cache [ PIV_OBJ_DISCOVERY ] . flags |= PIV_OBJ_CACHE_NOT_PRESENT ; } } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d i:%d CI:%08x r:%d\n" , card -> type , i , priv -> card_issues , r ) ; if ( i < 0 ) { sc_unlock ( card ) ; piv_finish ( card ) ; card -> type = saved_type ; return 0 ; } sc_debug ( card -> ctx , SC_LOG_DEBUG_MATCH , "PIV_MATCH card->type:%d i:%d CI:%08x r:%d\n" , card -> type , i , priv -> card_issues , r ) ; priv -> pstate = PIV_STATE_INIT ; return 1 ; } 