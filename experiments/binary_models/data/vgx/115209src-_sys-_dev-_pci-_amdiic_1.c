int amdiic_intr ( void * arg ) { struct amdiic_softc * sc = arg ; int st ; u_int8_t * b ; int len ; if ( ( st = amdiic_read ( sc , AMD8111_SMB_STAT ) ) == - 1 ) { return ( - 1 ) ; } if ( st == 0 ) { return ( 0 ) ; } DPRINTF ( ( "%s: intr: st 0x%02x\n" , sc -> sc_dev . dv_xname , st ) ) ; if ( ( st & AMD8111_SMB_STAT_MASK ) != 0 ) { sc -> sc_i2c_xfer . error = 1 ; done } if ( st & AMD8111_SMB_STAT_DONE ) { if ( I2C_OP_WRITE_P ( sc -> sc_i2c_xfer . op ) ) { done } b = sc -> sc_i2c_xfer . buf ; len = sc -> sc_i2c_xfer . len ; if ( len > 0 ) { b [ 0 ] = amdiic_read ( sc , AMD8111_SMB_DATA ( 0 ) ) ; } if ( len > 1 ) { b [ 1 ] = amdiic_read ( sc , AMD8111_SMB_DATA ( 1 ) ) ; } } done if ( ( sc -> sc_i2c_xfer . flags & I2C_F_POLL ) == 0 ) { wakeup ( sc ) ; } return ( 1 ) ; } 