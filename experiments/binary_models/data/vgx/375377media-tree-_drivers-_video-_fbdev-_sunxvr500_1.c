static int e3d_set_fbinfo ( struct e3d_info * ep ) { struct fb_info * info = ep -> info ; struct fb_var_screeninfo * var = & info -> var ; info -> flags = FBINFO_DEFAULT ; info -> fbops = & e3d_ops ; info -> screen_base = ep -> fb_base ; info -> screen_size = ep -> fb_size ; info -> pseudo_palette = ep -> pseudo_palette ; strlcpy ( info -> fix . id , "e3d" , sizeof ( info -> fix . id ) ) ; info -> fix . smem_start = ep -> fb_base_phys ; info -> fix . smem_len = ep -> fb_size ; info -> fix . type = FB_TYPE_PACKED_PIXELS ; if ( ep -> depth == 32 || ep -> depth == 24 ) { info -> fix . visual = FB_VISUAL_TRUECOLOR ; } else { info -> fix . visual = FB_VISUAL_PSEUDOCOLOR ; } var -> xres = ep -> width ; var -> yres = ep -> height ; var -> xres_virtual = var -> xres ; var -> yres_virtual = var -> yres ; var -> bits_per_pixel = ep -> depth ; var -> red . offset = 8 ; var -> red . length = 8 ; var -> green . offset = 16 ; var -> green . length = 8 ; var -> blue . offset = 24 ; var -> blue . length = 8 ; var -> transp . offset = 0 ; if ( fb_alloc_cmap ( & info -> cmap , 256 , 0 ) ) { printk ( KERN_ERR "e3d: Cannot allocate color map.\n" ) ; return - ENOMEM ; } return 0 ; } 