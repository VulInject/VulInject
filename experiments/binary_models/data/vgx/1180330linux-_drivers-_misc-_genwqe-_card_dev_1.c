static int genwqe_pin_mem ( struct genwqe_file * cfile , struct genwqe_mem * m ) { int rc ; struct genwqe_dev * cd = cfile -> cd ; struct pci_dev * pci_dev = cfile -> cd -> pci_dev ; struct dma_mapping * dma_map ; unsigned long map_addr ; unsigned long map_size ; if ( ( m -> addr == 0x0 ) || ( m -> size == 0 ) ) { return - EINVAL ; } if ( m -> size > ULONG_MAX - PAGE_SIZE - ( m -> addr & ~ PAGE_MASK ) ) { return - EINVAL ; } map_addr = ( m -> addr & PAGE_MASK ) ; map_size = round_up ( m -> size + ( m -> addr & ~ PAGE_MASK ) , PAGE_SIZE ) ; dma_map = kzalloc ( sizeof ( dma_mapping ) , GFP_KERNEL ) ; if ( dma_map == NULL ) { return - ENOMEM ; } genwqe_mapping_init ( dma_map , GENWQE_MAPPING_SGL_PINNED ) ; rc = genwqe_user_vmap ( cd , dma_map , ( void * ) map_addr , map_size ) ; if ( rc != 0 ) { dev_err ( & pci_dev -> dev , "[%s] genwqe_user_vmap rc=%d\n" , __func__ , rc ) ; return rc ; } genwqe_add_pin ( cfile , dma_map ) ; return 0 ; } 