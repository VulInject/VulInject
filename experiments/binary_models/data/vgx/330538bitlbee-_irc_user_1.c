int irc_user_set_nick ( irc_user_t * iu , const char * new ) ( irc_t * irc = iu -> irc , irc_user_t * new_iu , char key [ strlen ( new ) + 1 ] , GSList * cl , strcpy ( key , new ) , ( iu == NULL || ! nick_lc ( irc , key ) || ( ( new_iu = irc_user_by_name ( irc , new ) ) && new_iu != iu ) ) { return 0 ; } for ( cl = irc -> channels ; cl ; cl = cl -> next ) { irc_channel_t * ic = cl -> data if ( iu == irc -> user || ( ( ic -> flags & IRC_CHANNEL_JOINED ) && irc_channel_has_user ( ic , iu ) ) ) { irc_send_nick ( iu , new ) } ; break ; } g_hash_table_remove ( irc -> nick_user_hash , iu -> key ) ; ) ; if ( iu -> nick == iu -> user ) { iu -> user = NULL ; } if ( iu -> nick == iu -> host ) { iu -> host = NULL ; } if ( iu -> nick == iu -> fullname ) { iu -> fullname = NULL ; } iu -> nick = g_strdup ( new ) ; if ( iu -> user == NULL ) { iu -> user = g_strdup ( iu -> nick ) ; } if ( iu -> host == NULL ) { iu -> host = g_strdup ( iu -> nick ) ; } if ( iu -> fullname == NULL ) { iu -> fullname = g_strdup ( iu -> nick ) ; } g_free ( iu -> key ) ; iu -> key = g_strdup ( key ) ; g_hash_table_insert ( irc -> nick_user_hash , iu -> key , iu ) ; if ( iu == irc -> user ) { ipc_to_master_str ( "NICK :%s\r\n" , new ) ; } return 1 ; 