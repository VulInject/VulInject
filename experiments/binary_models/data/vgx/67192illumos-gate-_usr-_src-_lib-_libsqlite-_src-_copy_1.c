void sqliteCopy ( Parse * pParse , SrcList * pTableName , Token * pFilename , Token * pDelimiter , int onError ) { Table * pTab ; int i ; Vdbe * v ; int addr , end ; char * zFile = 0 ; const char * zDb ; sqlite * db = pParse -> db ; if ( sqlite_malloc_failed ) { copy_cleanup } assert ( pTableName -> nSrc == 1 ) ; pTab = sqliteSrcListLookup ( pParse , pTableName ) ; if ( pTab == 0 || sqliteIsReadOnly ( pParse , pTab , 0 ) ) { copy_cleanup } zFile = sqliteStrNDup ( pFilename -> z , pFilename -> n ) ; sqliteDequote ( zFile , NULL ) ; assert ( pTab -> iDb < db -> nDb ) ; zDb = db -> aDb [ pTab -> iDb ] . zName ; if ( sqliteAuthCheck ( pParse , SQLITE_INSERT , pTab -> zName , 0 , zDb ) || sqliteAuthCheck ( pParse , SQLITE_COPY , pTab -> zName , zFile , zDb ) ) { copy_cleanup } v = sqliteGetVdbe ( pParse ) ; if ( v ) { sqliteBeginWriteOperation ( pParse , 1 , pTab -> iDb ) ; addr = sqliteVdbeOp3 ( v , OP_FileOpen , 0 , 0 , pFilename -> z , pFilename -> n ) ; sqliteVdbeDequoteP3 ( v , addr ) ; sqliteOpenTableAndIndices ( pParse , pTab , 0 ) ; if ( db -> flags & SQLITE_CountRows ) { sqliteVdbeAddOp ( v , OP_Integer , 0 , 0 ) ; } end = sqliteVdbeMakeLabel ( v ) ; addr = sqliteVdbeAddOp ( v , OP_FileRead , pTab -> nCol , end ) ; if ( pDelimiter ) { sqliteVdbeChangeP3 ( v , addr , pDelimiter -> z , pDelimiter -> n ) ; sqliteVdbeDequoteP3 ( v , addr ) ; } else { sqliteVdbeChangeP3 ( v , addr , "\t" , 1 ) ; } if ( pTab -> iPKey >= 0 ) { sqliteVdbeAddOp ( v , OP_FileColumn , pTab -> iPKey , 0 ) ; sqliteVdbeAddOp ( v , OP_MustBeInt , 0 , 0 ) ; } else { sqliteVdbeAddOp ( v , OP_NewRecno , 0 , 0 ) ; } for ( i = 0 ; i < pTab -> nCol ; i ++ ) { if ( i == pTab -> iPKey ) { sqliteVdbeAddOp ( v , OP_String , 0 , 0 ) ; } else { sqliteVdbeAddOp ( v , OP_FileColumn , i , 0 ) ; } } sqliteGenerateConstraintChecks ( pParse , pTab , 0 , 0 , pTab -> iPKey >= 0 , 0 , onError , addr ) ; sqliteCompleteInsertion ( pParse , pTab , 0 , 0 , 0 , 0 , - 1 ) ; if ( ( db -> flags & SQLITE_CountRows ) != 0 ) { sqliteVdbeAddOp ( v , OP_AddImm , 1 , 0 ) ; } sqliteVdbeAddOp ( v , OP_Goto , 0 , addr ) ; sqliteVdbeResolveLabel ( v , end ) ; sqliteVdbeAddOp ( v , OP_Noop , 0 , 0 ) ; sqliteEndWriteOperation ( pParse ) ; if ( db -> flags & SQLITE_CountRows ) { sqliteVdbeAddOp ( v , OP_ColumnName , 0 , 1 ) ; sqliteVdbeChangeP3 ( v , - 1 , "rows inserted" , P3_STATIC ) ; sqliteVdbeAddOp ( v , OP_Callback , 1 , 0 ) ; } } copy_cleanup sqliteSrcListDelete ( pTableName ) ; sqliteFree ( zFile ) ; return ; } 