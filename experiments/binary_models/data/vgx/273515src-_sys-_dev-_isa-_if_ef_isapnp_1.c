int ef_miibus_readreg ( struct device * dev , int phy , int reg ) { struct ef_softc * sc = ( ef_softc * ) dev ; int i , ack , s , val = 0 ; s = splnet ( ) ; GO_WINDOW ( 4 ) ; bus_space_write_2 ( sc -> sc_iot , sc -> sc_ioh , EP_W4_CTRLR_STATUS , 0 ) ; MII_SET ( sc , EF_MII_DIR ) ; MII_CLR ( sc , EF_MII_CLK ) ; ef_mii_sync ( sc ) ; ef_mii_writeb ( sc , 0 ) ; ef_mii_writeb ( sc , 1 ) ; ef_mii_writeb ( sc , 1 ) ; ef_mii_writeb ( sc , 0 ) ; for ( i = 0x10 ; i ; i >>= 1 ) { ef_mii_writeb ( sc , ( phy & i ) ?1 : 0 ) ; } for ( i = 0x10 ; i ; i >>= 1 ) { ef_mii_writeb ( sc , ( reg & i ) ?1 : 0 ) ; } MII_CLR ( sc , EF_MII_CLK | EF_MII_DATA ) ; DELAY ( 1 ) ; MII_SET ( sc , EF_MII_CLK ) ; DELAY ( 1 ) ; MII_CLR ( sc , EF_MII_DIR ) ; MII_CLR ( sc , EF_MII_CLK ) ; DELAY ( 1 ) ; MII_SET ( sc , EF_MII_CLK ) ; DELAY ( 1 ) ; ack = bus_space_read_2 ( sc -> sc_iot , sc -> sc_ioh , EP_W4_CTRLR_STATUS ) & EF_MII_DATA ; for ( i = 0x8000 ; i ; i >>= 1 ) { MII_CLR ( sc , EF_MII_CLK ) ; DELAY ( 1 ) ; if ( bus_space_read_2 ( sc -> sc_iot , sc -> sc_ioh , EP_W4_CTRLR_STATUS ) & EF_MII_DATA ) { val |= i ; } MII_SET ( sc , EF_MII_CLK ) ; DELAY ( 1 ) ; } MII_CLR ( sc , EF_MII_CLK ) ; DELAY ( 1 ) ; MII_SET ( sc , EF_MII_CLK ) ; DELAY ( 1 ) ; splx ( s , NULL ) ; return ( val ) ; } 