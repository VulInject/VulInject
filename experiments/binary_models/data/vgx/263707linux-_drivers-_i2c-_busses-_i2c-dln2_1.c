static int dln2_i2c_read ( struct dln2_i2c * dln2 , u16 addr , u8 * data , u16 data_len ) { int ret ; { u8 port ; u8 addr ; u8 mem_addr_len ; __le32 mem_addr ; __le16 buf_len ; } , __packed tx { __le16 buf_len ; int buf [ DLN2_I2C_MAX_XFER_SIZE ] ; } , __packed * rx = dln2 -> buf unsigned rx_len = sizeof ( * rx ) ; BUILD_BUG_ON ( sizeof ( * rx ) > DLN2_I2C_BUF_SIZE ) ; tx . port = dln2 -> port ; tx . addr = addr ; tx . mem_addr_len = 0 ; tx . mem_addr = 0 ; tx . buf_len = cpu_to_le16 ( data_len ) ; ret = dln2_transfer ( dln2 -> pdev , DLN2_I2C_READ , & tx , sizeof ( tx ) , rx , & rx_len ) ; if ( ret < 0 ) { return ret ; } if ( rx_len < sizeof ( rx -> buf_len ) + data_len ) { return - EPROTO ; } if ( le16_to_cpu ( rx -> buf_len ) != data_len ) { return - EPROTO ; } memcpy ( data , rx -> buf , data_len ) ; return data_len ; } 