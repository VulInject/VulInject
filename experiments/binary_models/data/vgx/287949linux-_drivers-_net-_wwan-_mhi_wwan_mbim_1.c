static struct sk_buff * mbim_tx_fixup ( struct sk_buff * skb , unsigned int session , u16 tx_seq ) { unsigned int dgram_size = skb -> len ; struct usb_cdc_ncm_nth16 * nth16 ; struct usb_cdc_ncm_ndp16 * ndp16 ; struct mbim_tx_hdr * mbim_hdr ; if ( skb_cow_head ( skb , sizeof ( mbim_tx_hdr ) ) ) { dev_kfree_skb_any ( skb ) ; return NULL ; } mbim_hdr = skb_push ( skb , sizeof ( mbim_tx_hdr ) ) ; nth16 = & mbim_hdr -> nth16 ; nth16 -> dwSignature = cpu_to_le32 ( USB_CDC_NCM_NTH16_SIGN ) ; nth16 -> wHeaderLength = cpu_to_le16 ( sizeof ( usb_cdc_ncm_nth16 ) ) ; nth16 -> wSequence = cpu_to_le16 ( tx_seq ) ; nth16 -> wBlockLength = cpu_to_le16 ( skb -> len ) ; nth16 -> wNdpIndex = cpu_to_le16 ( sizeof ( usb_cdc_ncm_nth16 ) ) ; ndp16 = & mbim_hdr -> ndp16 ; ndp16 -> dwSignature = cpu_to_le32 ( USB_CDC_MBIM_NDP16_IPS_SIGN | ( session << 24 ) ) ; ndp16 -> wLength = cpu_to_le16 ( sizeof ( usb_cdc_ncm_ndp16 ) + sizeof ( usb_cdc_ncm_dpe16 ) * 2 ) ; ndp16 -> dpe16 [ 0 ] . wDatagramIndex = cpu_to_le16 ( sizeof ( mbim_tx_hdr ) ) ; ndp16 -> dpe16 [ 0 ] . wDatagramLength = cpu_to_le16 ( dgram_size ) ; ndp16 -> dpe16 [ 1 ] . wDatagramIndex = 0 ; ndp16 -> dpe16 [ 1 ] . wDatagramLength = 0 ; return skb ; } 