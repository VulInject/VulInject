int nft_fib_init ( const struct nft_ctx * ctx , const struct nft_expr * expr , const struct nlattr * const tb [ ] ) { struct nft_fib * priv = nft_expr_priv ( expr ) ; int len ; int err ; if ( ! tb [ NFTA_FIB_DREG ] || ! tb [ NFTA_FIB_RESULT ] || ! tb [ NFTA_FIB_FLAGS ] ) { return - EINVAL ; } priv -> flags = ntohl ( nla_get_be32 ( tb [ NFTA_FIB_FLAGS ] ) ) ; if ( priv -> flags == 0 || ( priv -> flags & ~ NFTA_FIB_F_ALL ) ) { return - EINVAL ; } if ( ( priv -> flags & ( NFTA_FIB_F_SADDR | NFTA_FIB_F_DADDR ) ) == ( NFTA_FIB_F_SADDR | NFTA_FIB_F_DADDR ) ) { return - EINVAL ; } if ( ( priv -> flags & ( NFTA_FIB_F_IIF | NFTA_FIB_F_OIF ) ) == ( NFTA_FIB_F_IIF | NFTA_FIB_F_OIF ) ) { return - EINVAL ; } if ( ( priv -> flags & ( NFTA_FIB_F_SADDR | NFTA_FIB_F_DADDR ) ) == 0 ) { return - EINVAL ; } priv -> result = ntohl ( nla_get_be32 ( tb [ NFTA_FIB_RESULT ] ) ) ; switch ( priv -> result ) { case NFT_FIB_RESULT_OIF : if ( priv -> flags & NFTA_FIB_F_OIF ) { return - EINVAL ; } len = sizeof ( int ) ; break ; case NFT_FIB_RESULT_OIFNAME : if ( priv -> flags & NFTA_FIB_F_OIF ) { return - EINVAL ; } len = IFNAMSIZ ; break ; case NFT_FIB_RESULT_ADDRTYPE : len = sizeof ( u32 ) ; break ; default : return - EINVAL ; } err = nft_parse_register_store ( ctx , tb [ NFTA_FIB_DREG ] , & priv -> dreg , NULL , NFT_DATA_VALUE , len ) ; if ( err < 0 ) { return err ; } return 0 ; } 