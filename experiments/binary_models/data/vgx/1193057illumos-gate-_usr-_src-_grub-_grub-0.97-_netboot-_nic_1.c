static int await_dhcp ( int ival __unused , void * ptr __unused , unsigned short ptype __unused , struct iphdr * ip __unused , struct udphdr * udp ) { struct dhcp_t * dhcpreply ; int len ; if ( ! udp ) { return 0 ; } dhcpreply = ( dhcp_t * ) & nic . packet [ ETH_HLEN + sizeof ( iphdr ) + sizeof ( udphdr ) ] ; len = nic . packetlen - ( ETH_HLEN + sizeof ( iphdr ) + sizeof ( udphdr ) + sizeof ( dhcp_t ) - DHCP_OPT_LEN ) ; if ( len < 0 ) { return 0 ; } if ( udp -> dest != htons ( BOOTP_CLIENT ) ) { return 0 ; } if ( dhcpreply -> bp_op != BOOTP_REPLY ) { return 0 ; } if ( dhcpreply -> bp_xid != xid ) { return 0 ; } if ( memcmp ( ( char * ) & dhcpreply -> bp_siaddr , ( char * ) & zeroIP , sizeof ( in_addr ) ) == 0 ) { return 0 ; } if ( ( memcmp ( broadcast , dhcpreply -> bp_hwaddr , ETH_ALEN ) != 0 ) && ( memcmp ( arptable [ ARP_CLIENT ] . node , dhcpreply -> bp_hwaddr , ETH_ALEN ) != 0 ) ) { return 0 ; } dhcpack_length = len + sizeof ( dhcp_t ) - DHCP_OPT_LEN ; memcpy ( ( char * ) dhcpack_buf , ( char * ) dhcpreply , dhcpack_length ) ; arptable [ ARP_CLIENT ] . ipaddr . s_addr = dhcpreply -> bp_yiaddr . s_addr ; dhcp_addr . s_addr = dhcpreply -> bp_yiaddr . s_addr ; netmask = default_netmask ( ) ; arptable [ ARP_SERVER ] . ipaddr . s_addr = dhcpreply -> bp_siaddr . s_addr ; arptable [ ARP_GATEWAY ] . ipaddr . s_addr = dhcpreply -> bp_giaddr . s_addr ; memset ( arptable [ ARP_GATEWAY ] . node , 0 , ETH_ALEN ) ; bootfile = dhcpreply -> bp_file ; memcpy ( ( char * ) rfc1533_venddata , ( char * ) ( dhcpreply -> bp_vend ) , len ) ; decode_rfc1533 ( rfc1533_venddata , 0 , len , 1 ) ; return ( 1 ) ; } 