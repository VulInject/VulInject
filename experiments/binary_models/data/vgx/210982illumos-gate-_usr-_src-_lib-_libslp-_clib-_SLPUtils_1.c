SLPError SLPEscape ( const char * pcInbuf , char * * ppcOutBuf , SLPBoolean isTag ) { char * buf , * pin , * pout ; if ( ! ( buf = malloc ( strlen ( pcInbuf ) * 3 + 1 ) ) ) { slp_err ( LOG_CRIT , 0 , "SLPEscape" , "out of memory" ) ; return ( SLP_MEMORY_ALLOC_FAILED ) ; } * ppcOutBuf = buf ; for ( pin = ( char * ) pcInbuf , pout = buf ; * pin ; ) { int len ; if ( ( len = mblen ( pin , MB_CUR_MAX ) ) > 1 ) { int i ; for ( i = 0 ; i < len && * pin ; i ++ ) { * pout ++ = * pin ++ ; } continue ; } if ( isTag && isBadTagChar ( * pin ) ) { return ( SLP_PARSE_ERROR ) ; } if ( isReserved ( * pin ) ) { if ( isTag ) { return ( SLP_PARSE_ERROR ) ; } ( void ) sprintf ( pout , "\\%.2x" , * pin ) ; pout += 3 ; pin ++ ; } else { * pout ++ = * pin ++ ; } } * pout = 0 ; return ( SLP_OK ) ; } 