static int upload_firmware ( struct wfx_dev * wdev , const u8 * data , size_t len ) { int ret ; u32 offs , bytes_done = 0 ; ktime_t now , start ; if ( len % DNLD_BLOCK_SIZE ) { dev_err ( wdev -> dev , "firmware size is not aligned. Buffer overrun will occur\n" ) ; return - EIO ; } offs = 0 ; while ( offs < len ) { start = ktime_get ( ) ; for ( ; ; ) { now = ktime_get ( ) ; if ( offs + DNLD_BLOCK_SIZE - bytes_done < DNLD_FIFO_SIZE ) { break ; } if ( ktime_after ( now , ktime_add_ms ( start , DCA_TIMEOUT ) ) ) { return - ETIMEDOUT ; } ret = wfx_sram_reg_read ( wdev , WFX_DCA_GET , & bytes_done ) ; } if ( ktime_compare ( now , start ) ) { dev_dbg ( wdev -> dev , "answer after %lldus\n" , ktime_us_delta ( now , start ) ) ; } ret = wfx_sram_write_dma_safe ( wdev , WFX_DNLD_FIFO + ( offs % DNLD_FIFO_SIZE ) , data + offs , DNLD_BLOCK_SIZE ) ; if ( ret < 0 ) { return ret ; } offs += DNLD_BLOCK_SIZE ; ret = wfx_sram_reg_write ( wdev , WFX_DCA_PUT , offs ) ; if ( ret < 0 ) { return ret ; } } return 0 ; } 