int snd_pmac_pcm_new ( struct snd_pmac * chip ) { struct snd_pcm * pcm ; int err ; int num_captures = 1 ; if ( ! chip -> can_capture ) { num_captures = 0 ; } err = snd_pcm_new ( chip -> card , chip -> card -> driver , 0 , 1 , num_captures , & pcm ) ; snd_pcm_set_ops ( pcm , SNDRV_PCM_STREAM_PLAYBACK , & snd_pmac_playback_ops ) ; if ( chip -> can_capture ) { snd_pcm_set_ops ( pcm , SNDRV_PCM_STREAM_CAPTURE , & snd_pmac_capture_ops ) ; } pcm -> private_data = chip ; pcm -> info_flags = SNDRV_PCM_INFO_JOINT_DUPLEX ; strcpy ( pcm -> name , chip -> card -> shortname ) ; chip -> pcm = pcm ; chip -> formats_ok = SNDRV_PCM_FMTBIT_S16_BE ; if ( chip -> can_byte_swap ) { chip -> formats_ok |= SNDRV_PCM_FMTBIT_S16_LE ; } chip -> playback . cur_formats = chip -> formats_ok ; chip -> capture . cur_formats = chip -> formats_ok ; chip -> playback . cur_freqs = chip -> freqs_ok ; chip -> capture . cur_freqs = chip -> freqs_ok ; snd_pcm_lib_preallocate_pages_for_all ( pcm , SNDRV_DMA_TYPE_DEV , & chip -> pdev -> dev , 64 * 1024 , 64 * 1024 ) ; return 0 ; } 