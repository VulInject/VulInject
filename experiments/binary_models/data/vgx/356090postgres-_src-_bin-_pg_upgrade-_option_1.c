void get_sock_dir ( ClusterInfo * cluster , bool live_check ) { if ( ! live_check ) { cluster -> sockdir = user_opts . socketdir ; } else { unsigned short orig_port = cluster -> port ; char filename [ MAXPGPATH ] , line [ MAXPGPATH ] ; FILE * fp ; int lineno ; sprintf ( filename , "%s/postmaster.pid" , cluster -> pgdata ) ; if ( ( fp = fopen ( filename , "r" ) ) == NULL ) { pg_fatal ( "could not open file \"%s\": %s" , filename , strerror ( errno ) ) ; } for ( lineno = 1 ; lineno <= Max ( LOCK_FILE_LINE_PORT , LOCK_FILE_LINE_SOCKET_DIR ) ; lineno ++ ) { if ( fgets ( line , sizeof ( line ) , fp ) == NULL ) { pg_fatal ( "could not read line %d from file \"%s\": %s" , lineno , filename , strerror ( errno ) ) ; } if ( lineno == LOCK_FILE_LINE_PORT ) { sscanf ( line , "%hu" , & old_cluster . port ) ; } if ( lineno == LOCK_FILE_LINE_SOCKET_DIR ) { cluster -> sockdir = pg_strdup ( line ) ; ( void ) pg_strip_crlf ( cluster -> sockdir ) ; } } fclose ( fp ) ; if ( orig_port != DEF_PGUPORT && old_cluster . port != orig_port ) { pg_log ( PG_WARNING , "user-supplied old port number %hu corrected to %hu" , orig_port , cluster -> port ) ; } } cluster -> sockdir = NULL ; } 