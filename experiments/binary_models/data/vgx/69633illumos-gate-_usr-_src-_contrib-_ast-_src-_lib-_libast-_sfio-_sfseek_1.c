Sfoff_t sfseek ( f , p , type ) Sfio_t * f ; Sfoff_t p ; int type ; { Sfoff_t r , s ; int mode , local , hardseek , mustsync ; SFMTXDECL ( f , NULL ) ; SFMTXENTER ( f , ( Sfoff_t ) ( - 1 ) ) ; GETLOCAL ( f , local ) ; hardseek = ( type | f -> flags ) & ( SF_SHARE | SF_PUBLIC ) ; if ( hardseek && f -> mode == ( SF_READ | SF_SYNCED ) ) { newpos ( f , f -> here ) ; f -> mode = SF_READ ; } if ( ( int ) SFMODE ( f , local ) != ( mode = f -> mode & SF_RDWR ) ) { int flags = f -> flags ; if ( hardseek & SF_PUBLIC ) { f -> flags |= SF_SHARE | SF_PUBLIC ; } mode = _sfmode ( f , mode , local ) ; if ( hardseek & SF_PUBLIC ) { f -> flags = flags ; } if ( mode < 0 ) { SFMTXRETURN ( f , ( Sfoff_t ) ( - 1 ) ) ; } } mustsync = ( type & SF_SHARE ) && ! ( type & SF_PUBLIC ) && ( f -> mode & SF_READ ) && ! ( f -> flags & SF_STRING ) ; if ( ( type &= ( SEEK_SET | SEEK_CUR | SEEK_END ) ) != SEEK_SET && type != SEEK_CUR && type != SEEK_END ) { errno = EINVAL ; SFMTXRETURN ( f , ( Sfoff_t ) ( - 1 ) ) ; } if ( f -> extent < 0 ) { ( void ) SFSK ( f , ( Sfoff_t ) 0 , SEEK_CUR , f -> disc ) ; SFMTXRETURN ( f , ( Sfoff_t ) ( - 1 ) ) ; } if ( f -> disc == _Sfudisc ) { ( void ) sfclose ( * _Sfstack ( f , NIL ( Sfio_t * ) ) ) ; } SFLOCK ( f , local ) ; f -> flags &= ~ ( SF_EOF | SF_ERROR ) ; while ( f -> flags & SF_STRING ) { SFSTRSIZE ( f ) ; if ( type == SEEK_CUR ) { r = p + ( f -> next - f -> data ) ; } if ( type == SEEK_END ) { r = p + f -> extent ; } else { r = p ; } if ( r >= 0 && r <= f -> size ) { p = r ; f -> next = f -> data + p ; f -> here = p ; if ( p > f -> extent ) { memclear ( ( char * ) ( f -> data + f -> extent ) , ( int ) ( p - f -> extent ) ) ; } done } if ( SFSK ( f , r , SEEK_SET , f -> disc ) != r ) { p = - 1 ; done } if ( ! ( f -> flags & SF_STRING ) ) { p = r ; done } } if ( f -> mode & SF_WRITE ) { if ( ! hardseek && type < SEEK_END && ! ( f -> flags & SF_APPENDWR ) ) { s = f -> here + ( f -> next - f -> data ) ; r = p + ( type == SEEK_SET ?0 : s ) ; if ( r == s ) { p = r ; done } } if ( f -> next > f -> data && SFSYNC ( f ) < 0 ) { p = - 1 ; done } } if ( type == SEEK_END || ( f -> mode & SF_WRITE ) ) { if ( ( hardseek & SF_PUBLIC ) || type == SEEK_END ) { p = SFSK ( f , p , type , f -> disc ) ; } else { r = p + ( type == SEEK_CUR ?f -> here : 0 ) ; p = ( hardseek || r != f -> here ) ?SFSK ( f , r , SEEK_SET , f -> disc ) : r ; } if ( p >= 0 ) { newpos ( f , p ) ; } done } s = f -> here - ( f -> endb - f -> next ) ; r = p + ( type == SEEK_CUR ?s : 0 ) ; if ( r <= f -> here && r >= ( f -> here - ( f -> endb - f -> data ) ) ) { if ( ( hardseek || ( type == SEEK_CUR && p == 0 ) ) ) { if ( ( s = SFSK ( f , ( Sfoff_t ) 0 , SEEK_CUR , f -> disc ) ) == f -> here || ( s >= 0 && ! ( hardseek & SF_PUBLIC ) && ( s = SFSK ( f , f -> here , SEEK_SET , f -> disc ) ) == f -> here ) ) { near_done } if ( s < 0 ) { p = - 1 ; done } else { newpos ( f , s ) ; hardseek = 0 ; } } else { near_done f -> next = f -> endb - ( f -> here - r ) ; p = r ; done } } if ( ( p += type == SEEK_CUR ?s : 0 ) < 0 ) { done } if ( f -> bits & SF_MMAP ) { if ( ( f -> next - f -> data ) < ( ( f -> endb - f -> data ) / 4 ) ) { SFSETBUF ( f , ( Void_t * ) f -> tiny , ( size_t ) SF_UNBOUND ) ; hardseek = 1 ; } else { newpos ( f , p ) ; if ( ! hardseek ) { done } } } if ( f -> endb > f -> next ) { f -> iosz = ( f -> next - f -> data ) + ( f -> endb - f -> next ) / 2 ; f -> iosz = ( ( f -> iosz + f -> blksz - 1 ) / f -> blksz ) * f -> blksz ; } if ( f -> iosz >= f -> size ) { f -> iosz = 0 ; } f -> next = f -> endr = f -> endb = f -> data ; if ( p ( f -> lpos && f -> size ) f -> blksz && ( p + f -> blksz ) > s ) { if ( ( r = s - f -> size ) < 0 ) { r = 0 ; } } if ( f -> blksz > 0 && f -> size >= 2 * f -> blksz ) { r = p - ( p % f -> blksz ) ; } else { r = p ; if ( f -> iosz > 0 && ( p > f -> lpos || p < f -> lpos - f -> size ) ) { f -> bits |= SF_JUSTSEEK ; } } if ( ( hardseek || r != f -> here ) && ( f -> here = SFSK ( f , r , SEEK_SET , f -> disc ) ) != r ) { if ( r < p ) { f -> here = SFSK ( f , p , SEEK_SET , f -> disc ) ; } if ( f -> here != p ) { p = - 1 ; } done } if ( r < p ) { ( void ) SFRD ( f , f -> data , f -> size , f -> disc ) ; if ( p <= f -> here && p >= ( f -> here - ( f -> endb - f -> data ) ) ) { f -> next = f -> endb - ( size_t ) ( f -> here - p ) ; } else { f -> next = f -> endb = f -> data ; if ( ( f -> here = SFSK ( f , p , SEEK_SET , f -> disc ) ) != p ) { p = - 1 ; } } } done if ( f -> here < 0 ) { f -> extent = - 1 ; f -> here = 0 ; } f -> lpos = p ; SFOPEN ( f , local ) ; if ( mustsync ) { sfsync ( f ) ; } SFMTXRETURN ( f , p ) ; } 