static int create_core_data ( struct platform_device * pdev , unsigned int cpu , int pkg_flag ) { struct temp_data * tdata ; struct platform_data * pdata = platform_get_drvdata ( pdev ) ; struct cpuinfo_x86 * c = & cpu_data ( cpu ) ; u32 eax , edx ; int err , attr_no ; attr_no = pkg_flag ?PKG_SYSFS_ATTR_NO : TO_ATTR_NO ( cpu ) ; if ( attr_no > MAX_CORE_DATA - 1 ) { return - ERANGE ; } tdata = init_temp_data ( cpu , pkg_flag ) ; if ( ! tdata ) { return - ENOMEM ; } err = rdmsr_safe_on_cpu ( cpu , tdata -> status_reg , & eax , & edx ) ; if ( err ) { exit_free } tdata -> tjmax = get_tjmax ( c , cpu , & pdev -> dev ) ; if ( c -> x86_model > 0xe && c -> x86_model != 0x1c ) { err = rdmsr_safe_on_cpu ( cpu , MSR_IA32_TEMPERATURE_TARGET , & eax , & edx ) ; if ( ! err ) { tdata -> ttarget = tdata -> tjmax - ( ( eax >> 8 ) & 0xff ) * 1000 ; tdata -> attr_size ++ ; } } pdata -> core_data [ attr_no ] = tdata ; err = create_core_attrs ( tdata , pdata -> hwmon_dev , attr_no ) ; if ( err ) { exit_free } return 0 ; exit_free pdata -> core_data [ attr_no ] = NULL ; return err ; } 