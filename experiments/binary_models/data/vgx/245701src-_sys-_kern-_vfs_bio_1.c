int bwrite ( struct buf * bp ) { int rv , async , wasdelayed , s ; struct vnode * vp ; struct mount * mp ; vp = bp -> b_vp ; if ( vp != NULL ) { mp = vp -> v_type == VBLK ?vp -> v_specmountpoint : vp -> v_mount ; } else { mp = NULL ; } async = ISSET ( bp -> b_flags , B_ASYNC ) ; if ( ! async && mp && ISSET ( mp -> mnt_flag , MNT_ASYNC ) ) { if ( ! ISSET ( bp -> b_flags , B_NOCACHE ) ) { bdwrite ( bp , NULL ) ; return ( 0 ) ; } } if ( mp != NULL ) { if ( async ) { mp -> mnt_stat . f_asyncwrites ++ ; } else { mp -> mnt_stat . f_syncwrites ++ ; } } bcstats . pendingwrites ++ ; bcstats . numwrites ++ ; wasdelayed = ISSET ( bp -> b_flags , B_DELWRI ) ; CLR ( bp -> b_flags , ( B_READ | B_DONE | B_ERROR | B_DELWRI ) ) ; s = splbio ( ) ; if ( wasdelayed ) { reassignbuf ( bp ) ; } else { curproc -> p_ru . ru_oublock ++ ; } bp -> b_vp -> v_numoutput ++ ; splx ( s ) ; buf_flip_dma ( bp ) ; SET ( bp -> b_flags , B_WRITEINPROG ) ; VOP_STRATEGY ( bp -> b_vp , bp ) ; if ( bp -> b_bq ) { bufq_wait ( bp -> b_bq ) ; } if ( async ) { return ( 0 ) ; } rv = biowait ( bp ) ; brelse ( bp ) ; return ( rv ) ; } 