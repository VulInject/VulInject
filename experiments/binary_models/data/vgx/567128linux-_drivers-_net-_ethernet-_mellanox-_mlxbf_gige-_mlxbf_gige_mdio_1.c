int mlxbf_gige_mdio_probe ( struct platform_device * pdev , struct mlxbf_gige * priv ) { struct device * dev = & pdev -> dev ; struct resource * res ; int ret ; if ( priv -> hw_version > MLXBF_GIGE_VERSION_BF3 ) { return - ENODEV ; } priv -> mdio_io = devm_platform_ioremap_resource ( pdev , MLXBF_GIGE_RES_MDIO9 ) ; if ( IS_ERR ( priv -> mdio_io ) ) { return PTR_ERR ( priv -> mdio_io ) ; } res = platform_get_resource ( pdev , IORESOURCE_MEM , MLXBF_GIGE_RES_CLK ) ; if ( ! res ) { res = & corepll_params [ priv -> hw_version ] ; } priv -> clk_io = devm_ioremap ( dev , res -> start , resource_size ( res ) ) ; priv -> mdio_gw = & mlxbf_gige_mdio_gw_t [ priv -> hw_version ] ; mlxbf_gige_mdio_cfg ( priv ) ; priv -> mdiobus = devm_mdiobus_alloc ( dev ) ; if ( ! priv -> mdiobus ) { dev_err ( dev , "Failed to alloc MDIO bus\n" ) ; return - ENOMEM ; } priv -> mdiobus -> name = "mlxbf-mdio" ; priv -> mdiobus -> read = mlxbf_gige_mdio_read ; priv -> mdiobus -> write = mlxbf_gige_mdio_write ; priv -> mdiobus -> parent = dev ; priv -> mdiobus -> priv = priv ; snprintf ( priv -> mdiobus -> id , MII_BUS_ID_SIZE , "%s" , dev_name ( dev ) ) ; ret = mdiobus_register ( priv -> mdiobus ) ; if ( ret ) { dev_err ( dev , "Failed to register MDIO bus\n" ) ; } return ret ; } 