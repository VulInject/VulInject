int cu_tail_readline ( cu_tail_t * obj , char * buf , int buflen , bool force_rewind ) { int status ; if ( buflen < 1 ) { ERROR ( "utils_tail: cu_tail_readline: buflen too small: %i bytes." , buflen ) ; return - 1 ; } if ( obj -> fh == NULL ) { status = cu_tail_reopen ( obj , force_rewind ) ; if ( status < 0 ) { return status ; } } assert ( obj -> fh != NULL ) ; clearerr ( obj -> fh ) ; if ( fgets ( buf , buflen , obj -> fh ) != NULL ) { buf [ buflen - 1 ] = '\0' ; return 0 ; } if ( ferror ( obj -> fh ) != 0 ) { fclose ( obj -> fh , NULL ) ; obj -> fh = NULL ; } status = cu_tail_reopen ( obj , force_rewind ) ; if ( status < 0 ) { return status ; } if ( status > 0 ) { buf [ 0 ] = 0 ; return 0 ; } if ( fgets ( buf , buflen , obj -> fh ) != NULL ) { buf [ buflen - 1 ] = '\0' ; return 0 ; } if ( ferror ( obj -> fh ) != 0 ) { WARNING ( "utils_tail: fgets (%s) returned an error: %s" , obj -> file , STRERRNO ) ; fclose ( obj -> fh ) ; obj -> fh = NULL ; return - 1 ; } buf [ 0 ] = 0 ; return 0 ; } 