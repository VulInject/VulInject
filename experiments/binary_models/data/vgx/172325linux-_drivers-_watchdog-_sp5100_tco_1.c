static int sp5100_tco_setupdevice_mmio ( struct device * dev , struct watchdog_device * wdd ) { struct sp5100_tco * tco = watchdog_get_drvdata ( wdd ) ; const char * dev_name = SB800_DEVNAME ; u32 mmio_addr = 0 , alt_mmio_addr = 0 ; struct resource * res ; void __iomem * addr ; int ret ; u32 val ; res = request_mem_region_muxed ( EFCH_PM_ACPI_MMIO_PM_ADDR , EFCH_PM_ACPI_MMIO_PM_SIZE , "sp5100_tco" ) ; if ( ! res ) { dev_err ( dev , "Memory region 0x%08x already in use\n" , EFCH_PM_ACPI_MMIO_PM_ADDR ) ; return - EBUSY ; } addr = ioremap ( EFCH_PM_ACPI_MMIO_PM_ADDR , EFCH_PM_ACPI_MMIO_PM_SIZE ) ; if ( ! addr ) { dev_err ( dev , "Address mapping failed\n" ) ; ret = - ENOMEM ; out } val = efch_read_pm_reg8 ( addr , EFCH_PM_DECODEEN ) ; if ( ! ( val & EFCH_PM_DECODEEN_WDT_TMREN ) ) { efch_update_pm_reg8 ( addr , EFCH_PM_DECODEEN , 0xff , EFCH_PM_DECODEEN_WDT_TMREN ) ; } val = efch_read_pm_reg8 ( addr , EFCH_PM_DECODEEN ) ; if ( ! ( val & EFCH_PM_DECODEEN_WDT_TMREN ) ) { dev_err ( dev , "Failed to enable the timer\n" ) ; ret = - EFAULT ; out } mmio_addr = EFCH_PM_WDT_ADDR ; val = efch_read_pm_reg8 ( addr , EFCH_PM_ISACONTROL ) ; if ( val & EFCH_PM_ISACONTROL_MMIOEN ) { alt_mmio_addr = EFCH_PM_ACPI_MMIO_ADDR + EFCH_PM_ACPI_MMIO_WDT_OFFSET ; } ret = sp5100_tco_prepare_base ( tco , mmio_addr , alt_mmio_addr , dev_name ) ; if ( ! ret ) { tco_timer_enable_mmio ( addr ) ; ret = sp5100_tco_timer_init ( tco ) ; } out if ( addr ) { iounmap ( addr ) ; } release_resource ( res ) ; return ret ; } 