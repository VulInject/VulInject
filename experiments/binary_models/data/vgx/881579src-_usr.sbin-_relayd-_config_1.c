int config_getroute ( struct relayd * env , struct imsg * imsg ) { struct router * rt ; struct netroute * nr ; if ( ( nr = calloc ( 1 , sizeof ( * nr ) ) ) == NULL ) { return ( - 1 ) ; } IMSG_SIZE_CHECK ( imsg , & nr -> nr_conf ) ; memcpy ( & nr -> nr_conf , imsg -> data , sizeof ( nr -> nr_conf ) ) ; if ( route_find ( env , nr -> nr_conf . id ) != NULL ) { log_debug ( "%s: route %d already exists" , __func__ , nr -> nr_conf . id ) ; return ( - 1 ) ; } if ( ( rt = router_find ( env , nr -> nr_conf . routerid ) ) == NULL ) { log_debug ( "%s: received route for unknown router" , __func__ ) ; free ( nr ) ; return ( - 1 ) ; } nr -> nr_router = rt ; TAILQ_INSERT_TAIL ( env -> sc_routes , nr , nr_route ) ; TAILQ_INSERT_TAIL ( & rt -> rt_netroutes , nr , nr_entry ) ; env -> sc_routecount ++ ; DPRINTF ( "%s: %s %d received route %d for router %s" , __func__ , env -> sc_ps -> ps_title [ privsep_process ] , env -> sc_ps -> ps_instance , nr -> nr_conf . id , rt -> rt_conf . name ) ; return ( 0 ) ; } 