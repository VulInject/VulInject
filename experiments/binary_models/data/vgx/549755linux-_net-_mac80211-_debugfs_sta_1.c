static ssize_t sta_aqm_read ( struct file * file , char __user * userbuf , size_t count , loff_t * ppos ) { struct sta_info * sta = file -> private_data ; struct ieee80211_local * local = sta -> local ; size_t bufsz = AQM_TXQ_ENTRY_LEN * ( IEEE80211_NUM_TIDS + 2 ) ; char * buf = kzalloc ( bufsz , GFP_KERNEL ) , * p = buf ; struct txq_info * txqi ; ssize_t rv ; int i ; if ( ! buf ) { return - ENOMEM ; } spin_lock_bh ( & local -> fq . lock ) ; rcu_read_lock ( ) ; p += scnprintf ( p , bufsz + buf - p , "target %uus interval %uus ecn %s\n" , codel_time_to_us ( sta -> cparams . target ) , codel_time_to_us ( sta -> cparams . interval ) , sta -> cparams . ecn ?"yes" : "no" ) ; p += scnprintf ( p , bufsz + buf - p , "tid ac backlog-bytes backlog-packets new-flows drops marks overlimit collisions tx-bytes tx-packets flags\n" ) ; for ( i = 0 ; i < ARRAY_SIZE ( sta -> sta . txq ) ; i ++ ) { txqi = to_txq_info ( sta -> sta . txq [ i ] ) ; p += scnprintf ( p , bufsz + buf - p , "%d %d %u %u %u %u %u %u %u %u %u 0x%lx(%s%s%s%s)\n" , txqi -> txq . tid , txqi -> txq . ac , txqi -> tin . backlog_bytes , txqi -> tin . backlog_packets , txqi -> tin . flows , txqi -> cstats . drop_count , txqi -> cstats . ecn_mark , txqi -> tin . overlimit , txqi -> tin . collisions , txqi -> tin . tx_bytes , txqi -> tin . tx_packets , txqi -> flags , test_bit ( IEEE80211_TXQ_STOP , & txqi -> flags ) ?"STOP" : "RUN" , test_bit ( IEEE80211_TXQ_AMPDU , & txqi -> flags ) ?" AMPDU" : "" , test_bit ( IEEE80211_TXQ_NO_AMSDU , & txqi -> flags ) ?" NO-AMSDU" : "" , test_bit ( IEEE80211_TXQ_DIRTY , & txqi -> flags ) ?" DIRTY" : "" ) ; } rcu_read_unlock ( ) ; spin_unlock_bh ( & local -> fq . lock ) ; rv = simple_read_from_buffer ( userbuf , count , ppos , buf , p - buf ) ; kfree ( buf ) ; return rv ; } 