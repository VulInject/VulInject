static int abx80x_rtc_set_time ( struct udevice * dev , const struct rtc_time * tm ) { unsigned char buf [ 8 ] ; int err , flags ; buf [ ABX8XX_REG_HTH ] = 0 ; buf [ ABX8XX_REG_SC ] = bin2bcd ( tm -> tm_sec ) ; buf [ ABX8XX_REG_MN ] = bin2bcd ( tm -> tm_min ) ; buf [ ABX8XX_REG_HR ] = bin2bcd ( tm -> tm_hour ) ; buf [ ABX8XX_REG_DA ] = bin2bcd ( tm -> tm_mday ) ; buf [ ABX8XX_REG_MO ] = bin2bcd ( tm -> tm_mon ) ; buf [ ABX8XX_REG_YR ] = bin2bcd ( tm -> tm_year - 2000 ) ; buf [ ABX8XX_REG_WD ] = tm -> tm_wday ; err = dm_i2c_write ( dev , ABX8XX_REG_HTH , buf , sizeof ( buf ) ) ; if ( err < 0 ) { log_err ( "Unable to write to date registers\n" ) ; return - EIO ; } flags = dm_i2c_reg_read ( dev , ABX8XX_REG_OSS ) ; if ( flags < 0 ) { log_err ( "Unable to read oscillator status.\n" ) ; return flags ; } err = dm_i2c_reg_write ( dev , ABX8XX_REG_OSS , flags & ~ ABX8XX_OSS_OF ) ; if ( err < 0 ) { log_err ( "Unable to write oscillator status register\n" ) ; return err ; } return 0 ; } 