static UINT rdpgfx_recv_wire_to_surface_1_pdu ( GENERIC_CHANNEL_CALLBACK * callback , wStream * s ) { RDPGFX_SURFACE_COMMAND cmd = { 0 } ; RDPGFX_WIRE_TO_SURFACE_PDU_1 pdu = { 0 } ; WINPR_ASSERT ( callback ) ; RDPGFX_PLUGIN * gfx = ( RDPGFX_PLUGIN * ) callback -> plugin ; UINT error ; WINPR_ASSERT ( gfx ) ; if ( ! Stream_CheckAndLogRequiredLength ( TAG , s , RDPGFX_WIRE_TO_SURFACE_PDU_1_SIZE ) ) { return ERROR_INVALID_DATA ; } Stream_Read_UINT16 ( s , pdu . surfaceId ) ; Stream_Read_UINT16 ( s , pdu . codecId ) ; Stream_Read_UINT8 ( s , pdu . pixelFormat ) ; if ( ( error = rdpgfx_read_rect16 ( s , & ( pdu . destRect ) ) ) ) { WLog_Print ( gfx -> log , WLOG_ERROR , "rdpgfx_read_rect16 failed with error %" PRIu32 "" , error ) ; return error ; } Stream_Read_UINT32 ( s , pdu . bitmapDataLength ) ; if ( ! Stream_CheckAndLogRequiredLength ( TAG , s , pdu . bitmapDataLength ) ) { return ERROR_INVALID_DATA ; } pdu . bitmapData = Stream_Pointer ( s ) ; Stream_Seek ( s , pdu . bitmapDataLength ) ; DEBUG_RDPGFX ( gfx -> log , "RecvWireToSurface1Pdu: surfaceId: %" PRIu16 " codecId: %s (0x%04" PRIX16 ") pixelFormat: 0x%02" PRIX8 " " "destRect: left: %" PRIu16 " top: %" PRIu16 " right: %" PRIu16 " bottom: %" PRIu16 " bitmapDataLength: %" PRIu32 "" , pdu . surfaceId , rdpgfx_get_codec_id_string ( pdu . codecId ) , pdu . codecId , pdu . pixelFormat , pdu . destRect . left , pdu . destRect . top , pdu . destRect . right , pdu . destRect . bottom , pdu . bitmapDataLength ) ; cmd . surfaceId = pdu . surfaceId ; cmd . codecId = pdu . codecId ; switch ( pdu . pixelFormat ) { case GFX_PIXEL_FORMAT_XRGB_8888 : cmd . format = PIXEL_FORMAT_BGRX32 ; break ; case GFX_PIXEL_FORMAT_ARGB_8888 : cmd . format = PIXEL_FORMAT_BGRA32 ; break ; default : return ERROR_INVALID_DATA ; } cmd . left = pdu . destRect . left ; cmd . top = pdu . destRect . top ; cmd . right = pdu . destRect . right ; cmd . bottom = pdu . destRect . bottom ; cmd . width = cmd . right - cmd . left ; cmd . height = cmd . bottom - cmd . top ; cmd . length = pdu . bitmapDataLength ; cmd . data = pdu . bitmapData ; cmd . extra = NULL ; if ( cmd . right < cmd . left ) { WLog_Print ( gfx -> log , WLOG_ERROR , "RecvWireToSurface1Pdu right=%" PRIu32 "<left=%" PRIu32 , cmd . right , cmd . left ) ; return ERROR_INVALID_DATA ; } if ( cmd . bottom < cmd . top ) { WLog_Print ( gfx -> log , WLOG_ERROR , "RecvWireToSurface1Pdu bottom=%" PRIu32 "<top=%" PRIu32 , cmd . bottom , cmd . top ) ; return ERROR_INVALID_DATA ; } if ( ( error = rdpgfx_decode ( gfx , & cmd ) ) ) { WLog_Print ( gfx -> log , WLOG_ERROR , "rdpgfx_decode failed with error %" PRIu32 "!" , error ) ; } return error ; } 