struct certreq_aca * certreq_decode ( u_int16_t type , u_int8_t * data , u_int32_t datalen ) { struct cert_handler * handler ; struct certreq_aca aca , * ret ; handler = cert_get ( type ) ; if ( ! handler ) { return 0 ; } aca . id = type ; aca . handler = handler ; aca . data = aca . raw_ca = NULL ; if ( datalen > 0 ) { int rc ; rc = handler -> certreq_decode ( & aca . data , data , datalen ) ; if ( ! rc ) { return 0 ; } aca . raw_ca = malloc ( datalen , NULL ) ; if ( aca . raw_ca == NULL ) { log_error ( "certreq_decode: malloc (%lu) failed" , ( unsigned long ) datalen ) ; handler -> free_aca ( aca . data ) ; return 0 ; } memcpy ( aca . raw_ca , data , datalen ) ; } aca . raw_ca_len = datalen ; ret = malloc ( sizeof aca ) ; if ( ! ret ) { log_error ( "certreq_decode: malloc (%lu) failed" , ( unsigned long ) sizeof aca ) ; free ( aca . raw_ca ) ; handler -> free_aca ( aca . data ) ; return 0 ; } memcpy ( ret , & aca , sizeof aca ) ; return ret ; } 