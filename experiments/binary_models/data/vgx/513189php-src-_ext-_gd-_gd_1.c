static int _php_image_type ( zend_string * data ) { if ( ZSTR_LEN ( data ) < 12 ) { return - 1 ; } if ( ! memcmp ( ZSTR_VAL ( data ) , php_sig_gd2 , sizeof ( php_sig_gd2 ) ) ) { return PHP_GDIMG_TYPE_GD2 ; } if ( ! memcmp ( ZSTR_VAL ( data ) , php_sig_jpg , sizeof ( php_sig_jpg ) ) ) { return PHP_GDIMG_TYPE_JPG ; } if ( ! memcmp ( ZSTR_VAL ( data ) , php_sig_png , sizeof ( php_sig_png ) ) ) { return PHP_GDIMG_TYPE_PNG ; } if ( ! memcmp ( ZSTR_VAL ( data ) , php_sig_gif , sizeof ( php_sig_gif ) ) ) { return PHP_GDIMG_TYPE_GIF ; } if ( ! memcmp ( ZSTR_VAL ( data ) , php_sig_bmp , sizeof ( php_sig_bmp ) ) ) { return PHP_GDIMG_TYPE_BMP ; } if ( ! memcmp ( ZSTR_VAL ( data ) , php_sig_riff , sizeof ( php_sig_riff ) ) && ! memcmp ( ZSTR_VAL ( data ) + sizeof ( php_sig_riff ) + sizeof ( uint32_t ) , php_sig_webp , sizeof ( php_sig_webp ) ) ) { return PHP_GDIMG_TYPE_WEBP ; } php_stream * image_stream = php_stream_memory_open ( TEMP_STREAM_READONLY , data ) ; if ( image_stream != NULL ) { bool is_avif = php_is_image_avif ( image_stream ) ; php_stream_close ( image_stream , NULL ) ; if ( is_avif ) { return PHP_GDIMG_TYPE_AVIF ; } } gdIOCtx * io_ctx ; io_ctx = gdNewDynamicCtxEx ( 8 , ZSTR_VAL ( data ) , 0 ) ; if ( io_ctx ) { if ( _php_ctx_getmbi ( io_ctx ) == 0 && _php_ctx_getmbi ( io_ctx ) >= 0 ) { io_ctx -> gd_free ( io_ctx ) ; return PHP_GDIMG_TYPE_WBM ; } else { io_ctx -> gd_free ( io_ctx ) ; } } return - 1 ; } 