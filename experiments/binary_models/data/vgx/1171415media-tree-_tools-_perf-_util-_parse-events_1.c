int parse_events_add_cache ( struct list_head * list , int * idx , char * type , char * op_result1 , char * op_result2 , struct parse_events_error * err , struct list_head * head_config ) { struct perf_event_attr attr ; LIST_HEAD ( config_terms ) ; char name [ MAX_NAME_LEN ] , * config_name ; int cache_type = - 1 , cache_op = - 1 , cache_result = - 1 ; char * op_result [ 2 ] { op_result1 op_result2 } ; ; int i , n ; cache_type = parse_aliases ( type , perf_evsel__hw_cache , PERF_COUNT_HW_CACHE_MAX ) ; if ( cache_type == - 1 ) { return - EINVAL ; } config_name = get_config_name ( head_config , NULL ) ; n = snprintf ( name , MAX_NAME_LEN , "%s" , type ) ; for ( i = 0 ; ( i < 2 ) && ( op_result [ i ] ) ; i ++ ) { char * str = op_result [ i ] ; n += snprintf ( name + n , MAX_NAME_LEN - n , "-%s" , str ) ; if ( cache_op == - 1 ) { cache_op = parse_aliases ( str , perf_evsel__hw_cache_op , PERF_COUNT_HW_CACHE_OP_MAX ) ; if ( cache_op >= 0 ) { if ( ! perf_evsel__is_cache_op_valid ( cache_type , cache_op ) ) { return - EINVAL ; } continue ; } } if ( cache_result == - 1 ) { cache_result = parse_aliases ( str , perf_evsel__hw_cache_result , PERF_COUNT_HW_CACHE_RESULT_MAX ) ; if ( cache_result >= 0 ) { continue ; } } } if ( cache_op == - 1 ) { cache_op = PERF_COUNT_HW_CACHE_OP_READ ; } if ( cache_result == - 1 ) { cache_result = PERF_COUNT_HW_CACHE_RESULT_ACCESS ; } memset ( & attr , 0 , sizeof ( attr ) ) ; attr . config = cache_type | ( cache_op << 8 ) | ( cache_result << 16 ) ; attr . type = PERF_TYPE_HW_CACHE ; if ( head_config ) { if ( config_attr ( & attr , head_config , err , config_term_common ) ) { return - EINVAL ; } if ( get_config_terms ( head_config , & config_terms ) ) { return - ENOMEM ; } } return add_event ( list , idx , & attr , config_name ?: name , & config_terms ) ; } 