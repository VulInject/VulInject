static int ccg_read ( struct ucsi_ccg * uc , u16 rab , u8 * data , u32 len ) { struct i2c_client * client = uc -> client ; const struct i2c_adapter_quirks * quirks = client -> adapter -> quirks ; unsigned char buf [ 2 ] ; struct i2c_msg msgs [ ] { { . addr = client -> addr . flags = 0x0 . len = sizeof ( buf ) . buf = buf } { . addr = client -> addr . flags = I2C_M_RD . buf = data } } ; ; u32 rlen , rem_len = len , max_read_len = len ; int status ; if ( quirks && quirks -> max_read_len ) { max_read_len = quirks -> max_read_len ; } pm_runtime_get_sync ( uc -> dev , NULL ) ; while ( rem_len > 0 ) { msgs [ 1 ] . buf = & data [ len - rem_len ] ; rlen = min_t ( u16 , rem_len , max_read_len ) ; msgs [ 1 ] . len = rlen ; put_unaligned_le16 ( rab , buf ) ; status = i2c_transfer ( client -> adapter , msgs , ARRAY_SIZE ( msgs ) ) ; if ( status < 0 ) { dev_err ( uc -> dev , "i2c_transfer failed %d\n" , status ) ; pm_runtime_put_sync ( uc -> dev ) ; return status ; } rab += rlen ; rem_len -= rlen ; } pm_runtime_put_sync ( uc -> dev ) ; return 0 ; } 