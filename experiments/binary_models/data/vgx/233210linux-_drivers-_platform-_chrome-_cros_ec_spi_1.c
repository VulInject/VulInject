static int cros_ec_spi_receive_packet ( struct cros_ec_device * ec_dev , int need_len ) { struct ec_host_response * response ; u8 * ptr , * end ; int ret ; unsigned long deadline ; int todo ; if ( ec_dev -> din_size < EC_MSG_PREAMBLE_COUNT ) { return - EINVAL ; } deadline = jiffies + msecs_to_jiffies ( EC_MSG_DEADLINE_MS ) ; while ( true ) { unsigned long start_jiffies = jiffies ; ret = receive_n_bytes ( ec_dev , ec_dev -> din , EC_MSG_PREAMBLE_COUNT ) ; if ( ret < 0 ) { return ret ; } ptr = ec_dev -> din ; for ( end = ptr + EC_MSG_PREAMBLE_COUNT ; ptr != end ; ptr ++ ) { if ( * ptr == EC_SPI_FRAME_START ) { dev_dbg ( ec_dev -> dev , "msg found at %zd\n" , ptr - ec_dev -> din ) ; break ; } } if ( ptr != end ) { break ; } if ( time_after ( start_jiffies , deadline ) ) { dev_warn ( ec_dev -> dev , "EC failed to respond in time\n" ) ; return - ETIMEDOUT ; } } todo = end - ++ ptr ; todo = min ( todo , need_len ) ; memmove ( ec_dev -> din , ptr , todo ) ; ptr = ec_dev -> din + todo ; dev_dbg ( ec_dev -> dev , "need %d, got %d bytes from preamble\n" , need_len , todo ) ; need_len -= todo ; if ( todo < sizeof ( * response ) ) { ret = receive_n_bytes ( ec_dev , ptr , sizeof ( * response ) - todo ) ; if ( ret < 0 ) { return - EBADMSG ; } ptr += ( sizeof ( * response ) - todo ) ; todo = sizeof ( * response ) ; } response = ( ec_host_response * ) ec_dev -> din ; while ( need_len > 0 ) { todo = min ( need_len , 256 ) ; dev_dbg ( ec_dev -> dev , "loop, todo=%d, need_len=%d, ptr=%zd\n" , todo , need_len , ptr - ec_dev -> din ) ; ret = receive_n_bytes ( ec_dev , ptr , todo ) ; if ( ret < 0 ) { return ret ; } ptr += todo ; need_len -= todo ; } dev_dbg ( ec_dev -> dev , "loop done, ptr=%zd\n" , ptr - ec_dev -> din ) ; return 0 ; } 