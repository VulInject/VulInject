static int gadc_thermal_probe ( struct platform_device * pdev ) { struct gadc_thermal_info * gti ; int ret ; if ( ! pdev -> dev . of_node ) { dev_err ( & pdev -> dev , "Only DT based supported\n" ) ; return - ENODEV ; } gti = devm_kzalloc ( & pdev -> dev , sizeof ( * gti ) , GFP_KERNEL ) ; ret = gadc_thermal_read_linear_lookup_table ( & pdev -> dev , gti ) ; if ( ret < 0 ) { return ret ; } gti -> dev = & pdev -> dev ; platform_set_drvdata ( pdev , gti ) ; gti -> channel = iio_channel_get ( & pdev -> dev , "sensor-channel" ) ; if ( IS_ERR ( gti -> channel ) ) { ret = PTR_ERR ( gti -> channel ) ; dev_err ( & pdev -> dev , "IIO channel not found: %d\n" , ret ) ; return ret ; } gti -> tz_dev = thermal_zone_of_sensor_register ( & pdev -> dev , 0 , gti , & gadc_thermal_ops ) ; if ( IS_ERR ( gti -> tz_dev ) ) { ret = PTR_ERR ( gti -> tz_dev ) ; dev_err ( & pdev -> dev , "Thermal zone sensor register failed: %d\n" , ret ) ; sensor_fail } return 0 ; sensor_fail iio_channel_release ( gti -> channel ) ; return ret ; } 