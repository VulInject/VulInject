static int do_tls_ordering_tests ( void ) { struct tls * client = NULL , * server = NULL , * server_cctx = NULL ; struct tls_config * client_cfg , * server_cfg ; int failure = 0 ; printf ( "== TLS ordering tests ==\n" ) ; if ( ( client = tls_client ( ) ) == NULL ) { errx ( 1 , "failed to create tls client" ) ; } if ( ( client_cfg = tls_config_new ( ) ) == NULL ) { errx ( 1 , "failed to create tls client config" ) ; } tls_config_insecure_noverifyname ( client_cfg ) ; if ( tls_config_set_ca_file ( client_cfg , cafile ) == - 1 ) { errx ( 1 , "failed to set ca: %s" , tls_config_error ( client_cfg ) ) ; } if ( ( server = tls_server ( ) ) == NULL ) { errx ( 1 , "failed to create tls server" ) ; } if ( ( server_cfg = tls_config_new ( ) ) == NULL ) { errx ( 1 , "failed to create tls server config" ) ; } if ( tls_config_set_keypair_file ( server_cfg , certfile , keyfile ) == - 1 ) { errx ( 1 , "failed to set keypair: %s" , tls_config_error ( server_cfg ) ) ; } if ( tls_configure ( client , client_cfg ) == - 1 ) { errx ( 1 , "failed to configure client: %s" , tls_error ( client ) ) ; } if ( tls_configure ( server , server_cfg ) == - 1 ) { errx ( 1 , "failed to configure server: %s" , tls_error ( server ) ) ; } tls_config_free ( client_cfg ) ; tls_config_free ( server_cfg ) ; if ( tls_handshake ( client ) != - 1 ) { printf ( "FAIL: TLS handshake succeeded on unconnnected " "client context\n" ) ; failure = 1 ; done } circular_init ( ) ; if ( tls_accept_cbs ( server , & server_cctx , server_read , server_write , NULL ) == - 1 ) { errx ( 1 , "failed to accept: %s" , tls_error ( server ) ) ; } if ( tls_connect_cbs ( client , client_read , client_write , NULL , "test" ) == - 1 ) { errx ( 1 , "failed to connect: %s" , tls_error ( client ) ) ; } if ( do_client_server_handshake ( "ordering" , client , server_cctx ) != 0 ) { failure = 1 ; done } if ( tls_handshake ( client ) != - 1 ) { printf ( "FAIL: TLS handshake succeeded twice\n" ) ; failure = 1 ; done } if ( tls_handshake ( server_cctx ) != - 1 ) { printf ( "FAIL: TLS handshake succeeded twice\n" ) ; failure = 1 ; done } if ( do_client_server_close ( "ordering" , client , server_cctx ) != 0 ) { failure = 1 ; done } done tls_free ( client ) ; tls_free ( server_cctx ) ; printf ( "\n" ) ; return ( failure ) ; } test_versions { char * client ; char * server ; } 