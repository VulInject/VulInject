int mt7921e_tx_prepare_skb ( struct mt76_dev * mdev , void * txwi_ptr , enum mt76_txq_id qid , struct mt76_wcid * wcid , struct ieee80211_sta * sta , struct mt76_tx_info * tx_info ) { struct mt7921_dev * dev = container_of ( mdev , mt7921_dev , mt76 ) ; struct ieee80211_tx_info * info = IEEE80211_SKB_CB ( tx_info -> skb ) ; struct ieee80211_key_conf * key = info -> control . hw_key ; struct mt76_connac_hw_txp * txp ; struct mt76_txwi_cache * t ; int id , pid ; u8 * txwi = ( u8 * ) txwi_ptr ; if ( ! wcid ) { wcid = & dev -> mt76 . global_wcid ; } t = ( mt76_txwi_cache * ) ( txwi + mdev -> drv -> txwi_size ) ; t -> skb = tx_info -> skb ; id = mt76_token_consume ( mdev , & t ) ; if ( id < 0 ) { return id ; } if ( sta ) { struct mt7921_sta * msta = ( mt7921_sta * ) sta -> drv_priv ; if ( time_after ( jiffies , msta -> last_txs + HZ / 4 ) ) { info -> flags |= IEEE80211_TX_CTL_REQ_TX_STATUS ; msta -> last_txs = jiffies ; } } pid = mt76_tx_status_skb_add ( mdev , wcid , tx_info -> skb ) ; mt76_connac2_mac_write_txwi ( mdev , txwi_ptr , tx_info -> skb , wcid , key , pid , qid , 0 ) ; txp = ( mt76_connac_hw_txp * ) ( txwi + MT_TXD_SIZE ) ; memset ( txp , 0 , sizeof ( mt76_connac_hw_txp ) ) ; mt76_connac_write_hw_txp ( mdev , tx_info , txp , id ) ; tx_info -> skb = DMA_DUMMY_DATA ; return 0 ; } 