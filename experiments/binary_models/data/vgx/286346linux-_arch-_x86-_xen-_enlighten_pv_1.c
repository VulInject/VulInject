static bool __init xen_check_mwait ( void ) { struct xen_platform_op op = { . cmd = XENPF_set_processor_pminfo . u . set_pminfo . id = - 1 . u . set_pminfo . type = XEN_PM_PDC } ; uint32_t buf [ 3 ] ; unsigned int ax , bx , cx , dx ; unsigned int mwait_mask ; if ( ! xen_initial_domain ( ) ) { return false ; } ax = 1 ; cx = 0 ; native_cpuid ( & ax , & bx , & cx , & dx ) ; mwait_mask = ( 1 << ( X86_FEATURE_EST % 32 ) ) | ( 1 << ( X86_FEATURE_MWAIT % 32 ) ) ; if ( ( cx & mwait_mask ) != mwait_mask ) { return false ; } ax = CPUID_MWAIT_LEAF ; bx = 0 ; cx = 0 ; dx = 0 ; native_cpuid ( & ax , & bx , & cx , & dx ) ; buf [ 0 ] = ACPI_PDC_REVISION_ID ; buf [ 1 ] = 1 ; buf [ 2 ] = ( ACPI_PDC_C_CAPABILITY_SMP | ACPI_PDC_EST_CAPABILITY_SWSMP ) ; set_xen_guest_handle ( op . u . set_pminfo . pdc , buf ) ; if ( ( HYPERVISOR_platform_op ( & op ) == 0 ) && ( buf [ 2 ] & ( ACPI_PDC_C_C1_FFH | ACPI_PDC_C_C2C3_FFH ) ) ) { cpuid_leaf5_ecx_val = cx ; cpuid_leaf5_edx_val = dx ; } return true ; return false ; } 