void arc_init ( void ) { uint64_t allmem = ptob ( physmem - swapfs_minfree ) ; uint64_t allmem = ( physmem * PAGESIZE ) / 2 ; mutex_init ( & arc_adjust_lock , MUTEX_DEFAULT , NULL ) ; cv_init ( & arc_adjust_waiters_cv , NULL , CV_DEFAULT , NULL ) ; arc_c_min = MAX ( allmem / 32 , 64 << 20 ) ; if ( allmem >= 1 << 30 ) { arc_c_max = allmem - ( 1 << 30 ) ; } else { arc_c_max = arc_c_min ; } arc_c_max = MAX ( allmem * 3 / 4 , arc_c_max ) ; arc_c_min = arc_c_max / 2 ; if ( zfs_arc_max > 64 << 20 && zfs_arc_max < allmem ) { arc_c_max = zfs_arc_max ; arc_c_min = MIN ( arc_c_min , arc_c_max ) ; } if ( zfs_arc_min > 64 << 20 && zfs_arc_min <= arc_c_max ) { arc_c_min = zfs_arc_min ; } arc_c = arc_c_max ; arc_p = ( arc_c >> 1 ) ; arc_meta_limit = arc_c_max / 4 ; arc_meta_limit = MIN ( arc_meta_limit , vmem_size ( heap_arena , VMEM_ALLOC | VMEM_FREE ) / 2 ) ; if ( zfs_arc_meta_limit > 0 && zfs_arc_meta_limit <= arc_c_max ) { arc_meta_limit = zfs_arc_meta_limit ; } if ( arc_c_min < arc_meta_limit / 2 && zfs_arc_min == 0 ) { arc_c_min = arc_meta_limit / 2 ; } if ( zfs_arc_meta_min > 0 ) { arc_meta_min = zfs_arc_meta_min ; } else { arc_meta_min = arc_c_min / 2 ; } if ( zfs_arc_grow_retry > 0 ) { arc_grow_retry = zfs_arc_grow_retry ; } if ( zfs_arc_shrink_shift > 0 ) { arc_shrink_shift = zfs_arc_shrink_shift ; } if ( arc_no_grow_shift >= arc_shrink_shift ) { arc_no_grow_shift = arc_shrink_shift - 1 ; } if ( zfs_arc_p_min_shift > 0 ) { arc_p_min_shift = zfs_arc_p_min_shift ; } if ( kmem_debugging ( ) ) { arc_c = arc_c / 2 ; } if ( arc_c < arc_c_min ) { arc_c = arc_c_min ; } arc_state_init ( ) ; ASSERT ( ! arc_initialized ) ; buf_init ( ) ; arc_ksp = kstat_create ( "zfs" , 0 , "arcstats" , "misc" , KSTAT_TYPE_NAMED , sizeof ( arc_stats ) / sizeof ( kstat_named_t ) , KSTAT_FLAG_VIRTUAL ) ; if ( arc_ksp != NULL ) { arc_ksp -> ks_data = & arc_stats ; arc_ksp -> ks_update = arc_kstat_update ; kstat_install ( arc_ksp ) ; } arc_adjust_zthr = zthr_create ( arc_adjust_cb_check , arc_adjust_cb , NULL ) ; arc_reap_zthr = zthr_create_timer ( arc_reap_cb_check , arc_reap_cb , NULL , SEC2NSEC ( 1 ) ) ; arc_initialized = B_TRUE ; arc_warm = B_FALSE ; if ( zfs_dirty_data_max == 0 ) { zfs_dirty_data_max = physmem * PAGESIZE * zfs_dirty_data_max_percent / 100 ; zfs_dirty_data_max = MIN ( zfs_dirty_data_max , zfs_dirty_data_max_max ) ; } } 