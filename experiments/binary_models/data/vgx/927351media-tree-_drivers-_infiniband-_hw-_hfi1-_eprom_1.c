static int read_partition_platform_config ( struct hfi1_devdata * dd , void * * data , u32 * size ) { void * buffer ; void * p ; u32 length ; int ret ; buffer = kmalloc ( P1_SIZE , GFP_KERNEL ) ; ret = read_length ( dd , P1_START , P1_SIZE , buffer ) ; if ( ret ) { kfree ( buffer ) ; return ret ; } p = strnstr ( buffer , IMAGE_TRAIL_MAGIC , P1_SIZE ) ; if ( p ) { length = p - buffer ; } else { length = P1_SIZE ; } * data = buffer ; * size = length ; return 0 ; } 