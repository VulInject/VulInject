static int prestera_br_mdb_sync ( struct prestera_bridge * br_dev ) { struct prestera_br_mdb_port * br_mdb_port ; struct prestera_bridge_port * br_port ; struct prestera_br_mdb_entry * br_mdb ; struct prestera_mdb_entry * mdb ; struct prestera_port * pr_port ; int err = 0 ; if ( ! br_dev -> multicast_enabled ) { return 0 ; } list_for_each_entry ( , , ) { mdb = br_mdb -> mdb ; list_for_each_entry ( , , ) { br_port = br_mdb_port -> br_port ; pr_port = prestera_port_dev_lower_find ( br_port -> dev , NULL ) ; if ( br_dev -> vlan_enabled && ! prestera_port_vlan_by_vid ( pr_port , mdb -> vid ) ) { continue ; } if ( prestera_br_mdb_port_is_member ( br_mdb , br_mdb_port -> br_port -> dev ) && br_dev -> mrouter_exist ) { err = prestera_mdb_port_add ( mdb , br_port -> dev , mdb -> addr , mdb -> vid ) ; } else { prestera_mdb_port_del ( mdb , br_port -> dev ) ; } if ( err ) { return err ; } } list_for_each_entry ( , , ) { pr_port = prestera_port_dev_lower_find ( br_port -> dev ) ; if ( br_dev -> vlan_enabled && ! prestera_port_vlan_by_vid ( pr_port , mdb -> vid ) ) { continue ; } if ( br_port -> mrouter ) { err = prestera_mdb_port_add ( mdb , br_port -> dev , mdb -> addr , mdb -> vid ) ; if ( err ) { return err ; } } if ( ! br_port -> mrouter && ! prestera_br_mdb_port_is_member ( br_mdb , br_port -> dev ) ) { prestera_mdb_port_del ( mdb , br_port -> dev ) ; } } } return 0 ; } 