int hashtab_insert ( struct hashtab * h , void * key , void * datum ) { u32 hvalue ; struct hashtab_node * prev , * cur , * newnode ; cond_resched ( ) ; if ( ! h || h -> nel == HASHTAB_MAX_NODES ) { return - EINVAL ; } hvalue = h -> hash_value ( h , key ) ; prev = NULL ; cur = h -> htable [ hvalue ] ; while ( cur && h -> keycmp ( h , key , cur -> key ) > 0 ) { prev = cur ; cur = cur -> next ; } if ( cur && ( h -> keycmp ( h , key , cur -> key ) == 0 ) ) { return - EEXIST ; } newnode = kmalloc ( sizeof ( * newnode ) , GFP_KERNEL ) ; if ( ! newnode ) { return - ENOMEM ; } newnode -> key = key ; newnode -> datum = datum ; if ( prev ) { newnode -> next = prev -> next ; prev -> next = newnode ; } else { newnode -> next = h -> htable [ hvalue ] ; h -> htable [ hvalue ] = newnode ; } h -> nel ++ ; return 0 ; } 