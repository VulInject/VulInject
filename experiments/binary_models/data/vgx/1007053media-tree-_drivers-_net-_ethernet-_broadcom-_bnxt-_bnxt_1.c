static int bnxt_hwrm_do_send_msg ( struct bnxt * bp , void * msg , u32 msg_len , int timeout , bool silent ) { int i , intr_process , rc , tmo_count ; struct input * req = msg ; u32 * data = msg ; __le32 * resp_len , * valid ; u16 cp_ring_id , len = 0 ; struct hwrm_err_output * resp = bp -> hwrm_cmd_resp_addr ; req -> seq_id = cpu_to_le16 ( bp -> hwrm_cmd_seq ++ ) ; cp_ring_id = le16_to_cpu ( req -> cmpl_ring ) ; intr_process = ( cp_ring_id == INVALID_HW_RING_ID ) ?0 : 1 ; __iowrite32_copy ( bp -> bar0 , data , msg_len / 4 ) ; for ( i = msg_len ; i < BNXT_HWRM_MAX_REQ_LEN ; i += 4 ) { writel ( 0 , bp -> bar0 + i ) ; } if ( intr_process ) { bp -> hwrm_intr_seq_id = le16_to_cpu ( req -> seq_id ) ; } writel ( 1 , bp -> bar0 + 0x100 ) ; if ( ! timeout ) { timeout = DFLT_HWRM_CMD_TIMEOUT ; } i = 0 ; tmo_count = timeout * 40 ; if ( intr_process ) { while ( bp -> hwrm_intr_seq_id != HWRM_SEQ_ID_INVALID && i ++ < tmo_count ) { usleep_range ( 25 , 40 ) ; } if ( bp -> hwrm_intr_seq_id != HWRM_SEQ_ID_INVALID ) { netdev_err ( bp -> dev , "Resp cmpl intr err msg: 0x%x\n" , le16_to_cpu ( req -> req_type ) ) ; return - 1 ; } } else { resp_len = bp -> hwrm_cmd_resp_addr + HWRM_RESP_LEN_OFFSET ; for ( i = 0 ; i < tmo_count ; i ++ ) { len = ( le32_to_cpu ( * resp_len ) & HWRM_RESP_LEN_MASK ) >> HWRM_RESP_LEN_SFT ; if ( len ) { break ; } usleep_range ( 25 , 40 ) ; } if ( i >= tmo_count ) { netdev_err ( bp -> dev , "Error (timeout: %d) msg {0x%x 0x%x} len:%d\n" , timeout , le16_to_cpu ( req -> req_type ) , le16_to_cpu ( req -> seq_id ) , len ) ; return - 1 ; } valid = bp -> hwrm_cmd_resp_addr + len - 4 ; for ( i = 0 ; i < 5 ; i ++ ) { if ( le32_to_cpu ( * valid ) & HWRM_RESP_VALID_MASK ) { break ; } udelay ( 1 ) ; } if ( i >= 5 ) { netdev_err ( bp -> dev , "Error (timeout: %d) msg {0x%x 0x%x} len:%d v:%d\n" , timeout , le16_to_cpu ( req -> req_type ) , le16_to_cpu ( req -> seq_id ) , len , * valid ) ; return - 1 ; } } rc = le16_to_cpu ( resp -> error_code ) ; if ( rc && ! silent ) { netdev_err ( bp -> dev , "hwrm req_type 0x%x seq id 0x%x error 0x%x\n" , le16_to_cpu ( resp -> req_type ) , le16_to_cpu ( resp -> seq_id ) , rc ) ; } return rc ; } 