static int send_request_dev_dep_msg_in ( struct usbtmc_device_data * data , size_t transfer_size ) { int retval ; u8 * buffer ; int actual ; buffer = kmalloc ( USBTMC_HEADER_SIZE , GFP_KERNEL ) ; buffer [ 0 ] = 2 ; buffer [ 1 ] = data -> bTag ; buffer [ 2 ] = ~ data -> bTag ; buffer [ 3 ] = 0 ; buffer [ 4 ] = transfer_size >> 0 ; buffer [ 5 ] = transfer_size >> 8 ; buffer [ 6 ] = transfer_size >> 16 ; buffer [ 7 ] = transfer_size >> 24 ; buffer [ 8 ] = data -> TermCharEnabled * 2 ; buffer [ 9 ] = data -> TermChar ; buffer [ 10 ] = 0 ; buffer [ 11 ] = 0 ; retval = usb_bulk_msg ( data -> usb_dev , usb_sndbulkpipe ( data -> usb_dev , data -> bulk_out ) , buffer , USBTMC_HEADER_SIZE , & actual , USBTMC_TIMEOUT ) ; data -> bTag_last_write = data -> bTag ; data -> bTag ++ ; if ( ! data -> bTag ) { data -> bTag ++ ; } kfree ( buffer ) ; if ( retval < 0 ) { dev_err ( & data -> intf -> dev , "usb_bulk_msg in send_request_dev_dep_msg_in() returned %d\n" , retval ) ; return retval ; } return 0 ; } 