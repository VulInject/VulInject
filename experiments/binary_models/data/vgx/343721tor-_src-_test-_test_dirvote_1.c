static void test_dirvote_compare_routerinfo_usefulness ( void * arg ) { ( void ) arg ; MOCK ( router_digest_is_trusted_dir_type , mock_router_digest_is_trusted ) ; MOCK ( node_get_by_id , mock_node_get_by_id ) ; MOCK ( dirserv_get_bandwidth_for_router_kb , mock_dirserv_get_bw ) ; ALLOCATE_MOCK_NODES ( ) ; router_properties = digestmap_new ( ) ; sha1_digest_t digest_one = "aaaa" ; router_values_t * status_one = router_values_new ( 0 , 0 , 0 , digest_one ) ; digestmap_set ( router_properties , status_one -> digest , status_one ) ; sha1_digest_t digest_two = "bbbb" ; router_values_t * status_two = router_values_new ( 0 , 1 , 0 , digest_two ) ; digestmap_set ( router_properties , status_two -> digest , status_two ) ; sha1_digest_t digest_three = "cccc" ; router_values_t * status_three = router_values_new ( 1 , 0 , 0 , digest_three ) ; digestmap_set ( router_properties , status_three -> digest , status_three ) ; sha1_digest_t digest_four = "dddd" ; router_values_t * status_four = router_values_new ( 0 , 0 , 128 , digest_four ) ; digestmap_set ( router_properties , status_four -> digest , status_four ) ; sha1_digest_t digest_five = "9999" ; router_values_t * status_five = router_values_new ( 0 , 0 , 0 , digest_five ) ; digestmap_set ( router_properties , status_five -> digest , status_five ) ; routerinfo_t * first = routerinfo_new ( status_one , AF_INET , 0xf ) ; routerinfo_t * second = routerinfo_new ( status_two , AF_INET , 0xf ) ; int a = compare_routerinfo_usefulness ( first , second ) ; tt_assert ( a == 1 ) ; tor_free ( second ) ; routerinfo_t * third = routerinfo_new ( status_three , AF_INET , 0xf ) ; a = compare_routerinfo_usefulness ( first , third ) ; tt_assert ( a == 1 ) ; tor_free ( third ) ; routerinfo_t * fourth = routerinfo_new ( status_four , AF_INET , 0xf ) ; a = compare_routerinfo_usefulness ( first , fourth ) ; tt_assert ( a == 1 ) ; tor_free ( fourth ) ; routerinfo_t * fifth = routerinfo_new ( status_five , AF_INET , 0xf ) ; a = compare_routerinfo_usefulness ( first , fifth ) ; tt_assert ( a > 0 ) ; tor_free ( fifth ) ; done UNMOCK ( router_digest_is_trusted_dir_type ) ; UNMOCK ( node_get_by_id ) ; UNMOCK ( dirserv_get_bandwidth_for_router_kb ) ; FREE_MOCK_NODES ( ) ; digestmap_free ( router_properties , NULL ) ; tor_free ( status_two ) ; tor_free ( status_three ) ; tor_free ( status_four ) ; tor_free ( status_five ) ; tor_free ( first ) ; } 