cm_image ( ) { char * name_arg , * w_arg , * h_arg , * alt_arg , * ext_arg ; if ( arg == END ) { return ; } name_arg = get_xref_token ( 1 ) ; w_arg = get_xref_token ( 0 ) ; h_arg = get_xref_token ( 0 ) ; alt_arg = get_xref_token ( 1 ) ; ext_arg = get_xref_token ( 0 ) ; if ( * name_arg ) { struct stat file_info ; char * pathname ; char * fullname = xmalloc ( strlen ( name_arg ) + ( ext_arg && * ext_arg ?strlen ( ext_arg ) + 1 : 4 ) + 1 ) ; if ( ext_arg && * ext_arg ) { sprintf ( fullname , "%s%s" , name_arg , ext_arg ) ; if ( access ( fullname , R_OK ) != 0 ) { pathname = get_file_info_in_path ( fullname , include_files_path , & file_info ) ; } if ( pathname == NULL ) { sprintf ( fullname , "%s.%s" , name_arg , ext_arg ) ; if ( access ( fullname , R_OK ) != 0 ) { pathname = get_file_info_in_path ( fullname , include_files_path , & file_info ) ; } } } else { sprintf ( fullname , "%s.png" , name_arg ) ; if ( access ( fullname , R_OK ) != 0 ) { pathname = get_file_info_in_path ( fullname , include_files_path , & file_info ) ; if ( pathname == NULL ) { sprintf ( fullname , "%s.jpg" , name_arg ) ; if ( access ( fullname , R_OK ) != 0 ) { sprintf ( fullname , "%s.gif" , name_arg ) ; if ( access ( fullname , R_OK ) != 0 ) { pathname = get_file_info_in_path ( fullname , include_files_path , & file_info ) ; } } } } } if ( html ) { int image_in_div = 0 ; if ( pathname == NULL && access ( fullname , R_OK ) != 0 ) { line_error ( _ ( "@image file `%s' (for HTML) not readable: %s" ) , fullname , strerror ( errno ) ) ; return ; } if ( pathname != NULL && access ( pathname , R_OK ) != 0 ) { line_error ( _ ( "No such file `%s'" ) , fullname ) ; return ; } if ( ! paragraph_is_open ) { add_html_block_elt ( "<div class=\"block-image\">" ) ; image_in_div = 1 ; } add_html_elt ( "<img src=" ) ; add_word_args ( "\"%s\"" , fullname ) ; add_html_elt ( " alt=" ) ; add_word_args ( "\"%s\">" , escape_string ( * alt_arg ?text_expansion ( alt_arg ) : fullname ) ) ; if ( image_in_div ) { add_html_block_elt ( "</div>" ) ; } } if ( xml && docbook ) { xml_insert_docbook_image ( name_arg ) ; } if ( xml ) { extern int xml_in_para ; extern int xml_no_para ; int elt = xml_in_para ?INLINEIMAGE : IMAGE ; if ( ! xml_in_para ) { xml_no_para ++ ; } xml_insert_element_with_attribute ( elt , START , "width=\"%s\" height=\"%s\" name=\"%s\" extension=\"%s\"" , w_arg , h_arg , name_arg , ext_arg ) ; xml_insert_element ( IMAGEALTTEXT , START ) ; execute_string ( "%s" , alt_arg ) ; xml_insert_element ( IMAGEALTTEXT , END ) ; xml_insert_element ( elt , END ) ; if ( ! xml_in_para ) { xml_no_para -- ; } } else { FILE * image_file ; char * txtpath = NULL ; char * txtname = xmalloc ( strlen ( name_arg ) + ( ext_arg && * ext_arg ?strlen ( ext_arg ) : 4 ) + 1 ) ; strcpy ( txtname , name_arg ) ; strcat ( txtname , ".txt" ) ; image_file = fopen ( txtname , "r" ) ; if ( image_file == NULL ) { txtpath = get_file_info_in_path ( txtname , include_files_path , & file_info ) ; if ( txtpath != NULL ) { image_file = fopen ( txtpath , "r" ) ; } } if ( image_file != NULL || access ( fullname , R_OK ) == 0 || ( pathname != NULL && access ( pathname , R_OK ) == 0 ) ) { int ch ; int save_inhibit_indentation = inhibit_paragraph_indentation ; int save_filling_enabled = filling_enabled ; int image_in_brackets = paragraph_is_open ; int use_magic_cookie = ! no_headers && access ( fullname , R_OK ) == 0 && ! STREQ ( fullname , txtname ) ; inhibit_paragraph_indentation = 1 ; filling_enabled = 0 ; last_char_was_newline = 0 ; if ( use_magic_cookie ) { add_char ( '\0' ) ; add_word ( "\010[image" ) ; if ( access ( fullname , R_OK ) == 0 || ( pathname != NULL && access ( pathname , R_OK ) == 0 ) ) { add_word_args ( " src=\"%s\"" , fullname ) ; } if ( * alt_arg ) { add_word_args ( " alt=\"%s\"" , alt_arg ) ; } } if ( image_file != NULL ) { if ( use_magic_cookie ) { add_word ( " text=\"" ) ; } if ( image_in_brackets ) { add_char ( '[' ) ; } while ( ( ch = getc ( image_file ) ) != EOF ) { if ( use_magic_cookie && ( ch == '"' || ch == '\\' ) ) { add_char ( '\\' ) ; } add_char ( ch ) ; } if ( image_in_brackets ) { add_char ( ']' ) ; } if ( use_magic_cookie ) { add_char ( '"' ) ; } if ( fclose ( image_file ) != 0 ) { perror ( txtname ) ; } } if ( use_magic_cookie ) { add_char ( '\0' ) ; add_word ( "\010]" ) ; } inhibit_paragraph_indentation = save_inhibit_indentation ; filling_enabled = save_filling_enabled ; } else { warning ( _ ( "@image file `%s' (for text) unreadable: %s" ) , txtname , strerror ( errno ) ) ; } } free ( fullname ) ; if ( pathname ) { free ( pathname ) ; } } else { line_error ( _ ( "@image missing filename argument" ) ) ; } if ( name_arg ) { free ( name_arg ) ; } if ( w_arg ) { free ( w_arg ) ; } if ( h_arg ) { free ( h_arg ) ; } if ( alt_arg ) { free ( alt_arg ) ; } if ( ext_arg ) { free ( ext_arg ) ; } } 