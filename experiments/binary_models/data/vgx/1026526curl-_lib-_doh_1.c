static DOHcode store_cname ( const unsigned char * doh , size_t dohlen , unsigned int index , struct dohentry * d ) { struct dynbuf * c ; unsigned int loop = 128 ; unsigned char length ; if ( d -> numcname == DOH_MAX_CNAME ) { return DOH_OK ; } c = & d -> cname [ d -> numcname ++ ] ; { length = doh [ index ] ; if ( ( length & 0xc0 ) == 0xc0 ) { int newpos ; if ( ( index + 1 ) >= dohlen ) { return DOH_DNS_OUT_OF_RANGE ; } newpos = ( length & 0x3f ) << 8 | doh [ index + 1 ] ; index = newpos ; continue ; } if ( length & 0xc0 ) { return DOH_DNS_BAD_LABEL ; } else { index ++ ; } if ( length ) { if ( Curl_dyn_len ( c ) ) { if ( Curl_dyn_addn ( c , STRCONST ( "." ) ) ) { return DOH_OUT_OF_MEM ; } } if ( ( index + length ) > dohlen ) { return DOH_DNS_BAD_LABEL ; } if ( Curl_dyn_addn ( c , & doh [ index ] , length ) ) { return DOH_OUT_OF_MEM ; } index += length ; } } length && -- loop ; if ( ! loop ) { return DOH_DNS_LABEL_LOOP ; } return DOH_OK ; } 