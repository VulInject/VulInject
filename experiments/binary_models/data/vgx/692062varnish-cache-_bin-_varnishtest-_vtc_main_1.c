static void i_mode ( void ) { struct vsb * vsb ; char * p , * topbuild , * topsrc ; vsb = VSB_new_auto ( ) ; AN ( vsb ) ; p = VFIL_readfile ( NULL , "Makefile" , NULL ) ; if ( p == NULL ) { fprintf ( stderr , "No Makefile to search for -i flag.\n" ) ; exit ( 2 ) ; } topbuild = top_dir ( p , "\nabs_top_builddir" ) ; topsrc = top_dir ( p , "\nabs_top_srcdir" ) ; free ( p ) ; if ( topbuild == NULL || topsrc == NULL ) { free ( topbuild ) ; exit ( 2 ) ; } extmacro_def ( "topbuild" , NULL , "%s" , topbuild ) ; extmacro_def ( "topsrc" , NULL , "%s" , topsrc ) ; VSB_clear ( vsb ) ; VSB_cat ( vsb , "PATH=" ) ; build_path ( topbuild , "bin" , "varnish" , "" , vsb ) ; VSB_putc ( vsb , ':' ) ; build_path ( topsrc , "" , "contrib" , "" , vsb ) ; VSB_printf ( vsb , ":%s" , getenv ( "PATH" ) ) ; AZ ( VSB_finish ( vsb ) ) ; AZ ( putenv ( strdup ( VSB_data ( vsb ) ) ) ) ; VSB_clear ( vsb ) ; build_path ( topbuild , "vmod" , ".libs" , "" , vsb ) ; AZ ( VSB_finish ( vsb ) ) ; vmod_path = strdup ( VSB_data ( vsb ) ) ; AN ( vmod_path ) ; free ( topbuild ) ; free ( topsrc ) ; VSB_destroy ( & vsb ) ; AZ ( putenv ( strdup ( "MALLOC_CONF=abort:true,junk:true" ) ) ) ; } 