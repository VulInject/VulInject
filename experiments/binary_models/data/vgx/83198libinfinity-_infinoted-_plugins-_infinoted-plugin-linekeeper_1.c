static guint infinoted_plugin_linekeeper_count_lines ( InfTextBuffer * buffer ) { InfTextBufferIter * iter ; guint n_lines ; gboolean has_iter ; guint length ; gsize bytes ; gchar * text ; gchar * pos ; gchar * new_pos ; gunichar c ; g_assert ( strcmp ( inf_text_buffer_get_encoding ( buffer ) , "UTF-8" ) == 0 ) ; n_lines = 0 ; iter = inf_text_buffer_create_end_iter ( buffer ) ; if ( iter == NULL ) { return 0 ; } { length = inf_text_buffer_iter_get_length ( buffer , iter ) ; bytes = inf_text_buffer_iter_get_bytes ( buffer , iter ) ; text = inf_text_buffer_iter_get_text ( buffer , iter ) ; pos = text + bytes ; while ( length > 0 ) { new_pos = g_utf8_prev_char ( pos ) ; g_assert ( bytes >= ( pos - new_pos ) ) ; c = g_utf8_get_char ( new_pos ) ; if ( c == '\n' || g_unichar_type ( c ) == G_UNICODE_LINE_SEPARATOR ) { ++ n_lines ; } else { break ; } -- length ; bytes -= ( pos - new_pos ) ; pos = new_pos ; } } length == 0 && inf_text_buffer_iter_prev ( buffer , iter ) ; inf_text_buffer_destroy_iter ( buffer , iter ) ; return n_lines ; } 