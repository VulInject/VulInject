script = fopen ( argv [ 1 ] , "r" ) ; if ( script == NULL ) { fprintf ( stdout , "500 Failed to open script %s: %s\r\n" , argv [ 1 ] , strerror ( errno ) ) ; exit ( 1 ) ; } logfile = argv [ 2 ] ; if ( logfile [ 0 ] == '+' ) { logfile ++ ; logmode = "a" ; } log = fopen ( logfile , logmode ) ; if ( log == NULL ) { fprintf ( stdout , "500 Failed to open log %s: %s\r\n" , logfile , strerror ( errno ) ) ; exit ( 1 ) ; } signal ( SIGALRM , sigalrm_handler ) ; while ( fgets ( , , ) != NULL ) { int n = ( int ) strlen ( ) ; while ( n > 0 && isspace ( sbuffer [ n - 1 ] ) ) { n -- ; } sbuffer [ n ] = 0 ; if ( isdigit ( sbuffer [ 0 ] ) ) { fprintf ( log , "%s\n" , sbuffer ) ; fflush ( log ) ; fprintf ( stdout , "%s\r\n" , sbuffer ) ; fflush ( stdout ) ; } if ( strncmp ( , "*sleep " , 7 ) == 0 ) { sleep ( atoi ( 7 ) ) ; } else { int data = strcmp ( , "." ) == 0 ; fprintf ( log , "%s\n" , sbuffer ) ; fflush ( log ) ; for ( ; ; ) { int n ; alarm ( 5 ) ; if ( fgets ( , , ) == NULL ) { fprintf ( log , "%sxpected EOF read from client\n" , ( strncmp ( , "*eof" , 4 ) == 0 ) ?"E" : "Une" ) ; END_OFF } alarm ( 0 ) ; n = ( int ) strlen ( ) ; while ( n > 0 && isspace ( ibuffer [ n - 1 ] ) ) { n -- ; } ibuffer [ n ] = 0 ; fprintf ( log , "<<<%s\n" , ibuffer ) ; if ( ! data || strcmp ( , "." ) == 0 ) { break ; } } if ( strncmp ( , , ) != 0 ) { fprintf ( log , "Comparison failed - bailing out\n" ) ; END_OFF } } } END_OFF fclose ( script ) ; fclose ( log , NULL ) ; exit ( 0 ) ; 