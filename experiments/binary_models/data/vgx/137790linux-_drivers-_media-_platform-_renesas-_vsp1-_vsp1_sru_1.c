static void sru_try_format ( struct vsp1_sru * sru , struct v4l2_subdev_state * sd_state , unsigned int pad , struct v4l2_mbus_framefmt * fmt ) { struct v4l2_mbus_framefmt * format ; unsigned int input_area ; unsigned int output_area ; switch ( pad ) { case SRU_PAD_SINK : if ( fmt -> code != MEDIA_BUS_FMT_ARGB8888_1X32 && fmt -> code != MEDIA_BUS_FMT_AYUV8_1X32 ) { fmt -> code = MEDIA_BUS_FMT_AYUV8_1X32 ; } fmt -> width = clamp ( fmt -> width , SRU_MIN_SIZE , SRU_MAX_SIZE ) ; fmt -> height = clamp ( fmt -> height , SRU_MIN_SIZE , SRU_MAX_SIZE ) ; break ; case SRU_PAD_SOURCE : format = vsp1_entity_get_pad_format ( & sru -> entity , sd_state , SRU_PAD_SINK ) ; fmt -> code = format -> code ; input_area = format -> width * format -> height ; output_area = min ( fmt -> width , SRU_MAX_SIZE ) * min ( fmt -> height , SRU_MAX_SIZE ) ; if ( fmt -> width <= SRU_MAX_SIZE / 2 && fmt -> height <= SRU_MAX_SIZE / 2 && output_area > input_area * 9 / 4 ) { fmt -> width = format -> width * 2 ; fmt -> height = format -> height * 2 ; } else { fmt -> width = format -> width ; fmt -> height = format -> height ; } break ; } fmt -> colorspace = V4L2_COLORSPACE_SRGB ; } 