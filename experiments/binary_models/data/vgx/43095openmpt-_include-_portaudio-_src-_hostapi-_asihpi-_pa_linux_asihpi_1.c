static PaError PaAsiHpi_BuildDeviceList ( PaAsiHpiHostApiRepresentation * hpiHostApi ) { PaError result = paNoError ; PaUtilHostApiRepresentation * hostApi = & hpiHostApi -> baseHostApiRep ; PaHostApiInfo * baseApiInfo = & hostApi -> info ; PaAsiHpiDeviceInfo * hpiDeviceList ; int numAdapters ; hpi_err_t hpiError = 0 ; int i , j , deviceCount = 0 , deviceIndex = 0 ; assert ( hpiHostApi ) ; PA_ASIHPI_UNLESS_ ( HPI_SubSysGetNumAdapters ( NULL , & numAdapters ) , paNoError ) ; for ( i = 0 ; i < numAdapters ; ++ i ) { uint16_t inStreams , outStreams ; uint16_t version ; uint32_t serial ; uint16_t type ; uint32_t idx ; hpiError = HPI_SubSysGetAdapter ( NULL , i , & idx , & type ) ; if ( hpiError ) { continue ; } hpiError = HPI_AdapterOpen ( NULL , idx ) ; if ( hpiError ) { PA_ASIHPI_REPORT_ERROR_ ( hpiError ) ; continue ; } hpiError = HPI_AdapterGetInfo ( NULL , idx , & outStreams , & inStreams , & version , & serial , & type ) ; if ( hpiError ) { PA_ASIHPI_REPORT_ERROR_ ( hpiError ) ; continue ; } else { if ( ( baseApiInfo -> defaultInputDevice == paNoDevice ) && ( inStreams > 0 ) ) { baseApiInfo -> defaultInputDevice = deviceCount ; } deviceCount += inStreams ; if ( ( baseApiInfo -> defaultOutputDevice == paNoDevice ) && ( outStreams > 0 ) ) { baseApiInfo -> defaultOutputDevice = deviceCount ; } deviceCount += outStreams ; } } if ( deviceCount > 0 ) { PA_UNLESS_ ( hostApi -> deviceInfos = ( PaDeviceInfo * * ) PaUtil_GroupAllocateMemory ( hpiHostApi -> allocations , sizeof ( PaDeviceInfo * ) * deviceCount ) , paInsufficientMemory ) ; PA_UNLESS_ ( hpiDeviceList = ( PaAsiHpiDeviceInfo * ) PaUtil_GroupAllocateMemory ( hpiHostApi -> allocations , sizeof ( PaAsiHpiDeviceInfo ) * deviceCount ) , paInsufficientMemory ) ; for ( i = 0 ; i < numAdapters ; ++ i ) { uint16_t inStreams , outStreams ; uint16_t version ; uint32_t serial ; uint16_t type ; uint32_t idx ; hpiError = HPI_SubSysGetAdapter ( NULL , i , & idx , & type ) ; if ( hpiError ) { continue ; } hpiError = HPI_AdapterGetInfo ( NULL , idx , & outStreams , & inStreams , & version , & serial , & type ) ; if ( hpiError ) { PA_ASIHPI_REPORT_ERROR_ ( hpiError ) ; continue ; } else { PA_DEBUG ( ( "Found HPI Adapter ID=%4X Idx=%d #In=%d #Out=%d S/N=%d HWver=%c%d DSPver=%03d\n" , type , idx , inStreams , outStreams , serial , ( ( version >> 3 ) & 0xf ) + 'A' , version & 0x7 , ( ( version >> 13 ) * 100 ) + ( ( version >> 7 ) & 0x3f ) ) ) ; } for ( j = 0 ; j < inStreams ; ++ j ) { PaAsiHpiDeviceInfo * hpiDevice = & hpiDeviceList [ deviceIndex ] ; PaDeviceInfo * baseDeviceInfo = & hpiDevice -> baseDeviceInfo ; char srcName [ 72 ] ; char * deviceName ; hpiDevice -> adapterIndex = idx ; hpiDevice -> adapterType = type ; hpiDevice -> adapterVersion = version ; hpiDevice -> adapterSerialNumber = serial ; hpiDevice -> streamIndex = j ; hpiDevice -> streamIsOutput = 0 ; baseDeviceInfo -> structVersion = 2 ; sprintf ( srcName , "Adapter %d (%4X) - Input Stream %d" , i + 1 , type , j + 1 ) ; PA_UNLESS_ ( deviceName = ( char * ) PaUtil_GroupAllocateMemory ( hpiHostApi -> allocations , strlen ( srcName ) + 1 ) , paInsufficientMemory ) ; strcpy ( deviceName , srcName ) ; baseDeviceInfo -> name = deviceName ; baseDeviceInfo -> hostApi = hpiHostApi -> hostApiIndex ; baseDeviceInfo -> maxInputChannels = HPI_MAX_CHANNELS ; baseDeviceInfo -> maxOutputChannels = 0 ; baseDeviceInfo -> defaultLowInputLatency = 0.01 ; baseDeviceInfo -> defaultLowOutputLatency = - 1.0 ; baseDeviceInfo -> defaultHighInputLatency = 0.2 ; baseDeviceInfo -> defaultHighOutputLatency = - 1.0 ; baseDeviceInfo -> defaultSampleRate = 44100 ; hostApi -> deviceInfos [ deviceIndex ++ ] = ( PaDeviceInfo * ) hpiDevice ; } for ( j = 0 ; j < outStreams ; ++ j ) { PaAsiHpiDeviceInfo * hpiDevice = & hpiDeviceList [ deviceIndex ] ; PaDeviceInfo * baseDeviceInfo = & hpiDevice -> baseDeviceInfo ; char srcName [ 72 ] ; char * deviceName ; memset ( hpiDevice , 0 , sizeof ( PaAsiHpiDeviceInfo ) ) ; hpiDevice -> adapterIndex = idx ; hpiDevice -> adapterType = type ; hpiDevice -> adapterVersion = version ; hpiDevice -> adapterSerialNumber = serial ; hpiDevice -> streamIndex = j ; hpiDevice -> streamIsOutput = 1 ; baseDeviceInfo -> structVersion = 2 ; sprintf ( srcName , "Adapter %d (%4X) - Output Stream %d" , i + 1 , type , j + 1 ) ; PA_UNLESS_ ( deviceName = ( char * ) PaUtil_GroupAllocateMemory ( hpiHostApi -> allocations , strlen ( srcName ) + 1 ) , paInsufficientMemory ) ; strcpy ( deviceName , srcName ) ; baseDeviceInfo -> name = deviceName ; baseDeviceInfo -> hostApi = hpiHostApi -> hostApiIndex ; baseDeviceInfo -> maxInputChannels = 0 ; baseDeviceInfo -> maxOutputChannels = HPI_MAX_CHANNELS ; baseDeviceInfo -> defaultLowInputLatency = - 1.0 ; baseDeviceInfo -> defaultLowOutputLatency = 0.01 ; baseDeviceInfo -> defaultHighInputLatency = - 1.0 ; baseDeviceInfo -> defaultHighOutputLatency = 0.2 ; baseDeviceInfo -> defaultSampleRate = 44100 ; hostApi -> deviceInfos [ deviceIndex ++ ] = ( PaDeviceInfo * ) hpiDevice ; } } } baseApiInfo -> deviceCount = deviceIndex ; error return result ; } 