int cifs_rename_pending_delete ( const char * full_path , struct dentry * dentry , const unsigned int xid ) { int oplock = 0 ; int rc ; struct cifs_fid fid ; struct cifs_open_parms oparms ; struct inode * inode = d_inode ( dentry ) ; struct cifsInodeInfo * cifsInode = CIFS_I ( inode ) ; struct cifs_sb_info * cifs_sb = CIFS_SB ( inode -> i_sb ) ; struct tcon_link * tlink ; struct cifs_tcon * tcon ; __u32 dosattr , origattr ; FILE_BASIC_INFO * info_buf = NULL ; tlink = cifs_sb_tlink ( cifs_sb ) ; if ( IS_ERR ( tlink ) ) { return PTR_ERR ( tlink ) ; } tcon = tlink_tcon ( tlink ) ; if ( ! ( tcon -> ses -> capabilities & CAP_INFOLEVEL_PASSTHRU ) ) { rc = - EBUSY ; out } oparms . tcon = tcon ; oparms . cifs_sb = cifs_sb ; oparms . desired_access = DELETE | FILE_WRITE_ATTRIBUTES ; oparms . create_options = CREATE_NOT_DIR ; oparms . disposition = FILE_OPEN ; oparms . path = full_path ; oparms . fid = & fid ; oparms . reconnect = false ; rc = CIFS_open ( xid , & oparms , & oplock , NULL ) ; if ( rc != 0 ) { out } origattr = cifsInode -> cifsAttrs ; if ( origattr == 0 ) { origattr |= ATTR_NORMAL ; } dosattr = origattr & ~ ATTR_READONLY ; if ( dosattr == 0 ) { dosattr |= ATTR_NORMAL ; } dosattr |= ATTR_HIDDEN ; if ( dosattr != origattr ) { info_buf = kzalloc ( sizeof ( * info_buf ) , GFP_KERNEL ) ; if ( info_buf == NULL ) { rc = - ENOMEM ; out_close } info_buf -> Attributes = cpu_to_le32 ( dosattr ) ; rc = CIFSSMBSetFileInfo ( xid , tcon , info_buf , fid . netfid , current -> tgid ) ; if ( ! rc ) { cifsInode -> cifsAttrs = dosattr ; } else { dosattr = origattr ; } } rc = CIFSSMBRenameOpenFile ( xid , tcon , fid . netfid , NULL , cifs_sb -> local_nls , cifs_remap ( cifs_sb ) ) ; if ( rc != 0 ) { rc = - EBUSY ; undo_setattr } if ( ! test_bit ( CIFS_INO_DELETE_PENDING , & cifsInode -> flags ) ) { rc = CIFSSMBSetFileDisposition ( xid , tcon , true , fid . netfid , current -> tgid ) ; if ( rc == - ENOENT ) { rc = 0 ; } if ( rc != 0 ) { rc = - EBUSY ; undo_rename } set_bit ( CIFS_INO_DELETE_PENDING , & cifsInode -> flags ) ; } out_close CIFSSMBClose ( xid , tcon , fid . netfid ) ; out cifs_put_tlink ( tlink ) ; return rc ; undo_rename CIFSSMBRenameOpenFile ( xid , tcon , fid . netfid , dentry -> d_name . name , cifs_sb -> local_nls , cifs_remap ( cifs_sb ) ) ; undo_setattr if ( dosattr != origattr ) { info_buf -> Attributes = cpu_to_le32 ( origattr ) ; if ( ! CIFSSMBSetFileInfo ( xid , tcon , info_buf , fid . netfid , current -> tgid ) ) { cifsInode -> cifsAttrs = origattr ; } } out_close } 