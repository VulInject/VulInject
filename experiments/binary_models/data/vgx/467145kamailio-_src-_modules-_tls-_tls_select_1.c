struct tcp_connection * get_cur_connection ( struct sip_msg * msg ) { struct tcp_connection * c ; if ( msg -> rcv . proto != PROTO_TLS ) { ERR ( "Transport protocol is not TLS (bug in config)\n" ) ; return 0 ; } c = tcpconn_get ( msg -> rcv . proto_reserved1 , 0 , 0 , 0 , cfg_get ( tls , tls_cfg , con_lifetime ) ) ; if ( c && c -> type != PROTO_TLS ) { ERR ( "Connection found but is not TLS\n" ) ; tcpconn_put ( c ) ; return 0 ; } return c ; } 