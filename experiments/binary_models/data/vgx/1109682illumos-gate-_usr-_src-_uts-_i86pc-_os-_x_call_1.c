static void xc_priority_common ( xc_func_t func , xc_arg_t arg1 , xc_arg_t arg2 , xc_arg_t arg3 , ulong_t * set ) { int i ; int c ; struct cpu * cpup ; for ( c = 0 ; c < max_ncpus ; ++ c ) { cpup = cpu [ c ] ; for ( i = 0 ; BT_TEST ( xc_priority_set , c ) && i < 40000 ; ++ i ) { SMT_PAUSE ( ) ; } if ( BT_TEST ( xc_priority_set , c ) ) { BT_ATOMIC_CLEAR ( xc_priority_set , c ) ; if ( cpup -> cpu_m . xc_work_cnt > 0 ) { xc_decrement ( & cpup -> cpu_m ) ; } } } xc_priority_data . xc_func = func ; xc_priority_data . xc_a1 = arg1 ; xc_priority_data . xc_a2 = arg2 ; xc_priority_data . xc_a3 = arg3 ; for ( c = 0 ; c < max_ncpus ; ++ c ) { if ( ! BT_TEST ( set , c ) ) { continue ; } cpup = cpu [ c ] ; if ( cpup == NULL || ! ( cpup -> cpu_flags & CPU_READY ) || cpup == CPU ) { continue ; } ( void ) xc_increment ( & cpup -> cpu_m ) ; BT_ATOMIC_SET ( xc_priority_set , c ) ; send_dirint ( c , XC_HI_PIL ) ; for ( i = 0 ; i < 10 ; ++ i ) { ( void ) atomic_cas_ptr ( & cpup -> cpu_m . xc_msgbox , cpup -> cpu_m . xc_msgbox , cpup -> cpu_m . xc_msgbox ) ; } } } 