void lpfc_mem_free_all ( struct lpfc_hba * phba ) { struct lpfc_sli * psli = & phba -> sli ; LPFC_MBOXQ_t * mbox , * next_mbox ; struct lpfc_dmabuf * mp ; list_for_each_entry_safe ( , , , ) { mp = ( lpfc_dmabuf * ) ( mbox -> ctx_buf ) ; if ( mp ) { lpfc_mbuf_free ( phba , mp -> virt , mp -> phys ) ; kfree ( mp ) ; } list_del ( & mbox -> list ) ; mempool_free ( mbox , phba -> mbox_mem_pool ) ; } list_for_each_entry_safe ( , , , ) { mp = ( lpfc_dmabuf * ) ( mbox -> ctx_buf ) ; if ( mp ) { lpfc_mbuf_free ( phba , mp -> virt , mp -> phys ) ; kfree ( mp ) ; } list_del ( & mbox -> list ) ; mempool_free ( mbox , phba -> mbox_mem_pool ) ; } spin_lock_irq ( & phba -> hbalock ) ; psli -> sli_flag &= ~ LPFC_SLI_MBOX_ACTIVE ; spin_unlock_irq ( & phba -> hbalock ) ; if ( psli -> mbox_active ) { mbox = psli -> mbox_active ; mp = ( lpfc_dmabuf * ) ( mbox -> ctx_buf ) ; if ( mp ) { lpfc_mbuf_free ( phba , mp -> virt , mp -> phys ) ; kfree ( mp ) ; } mempool_free ( mbox , phba -> mbox_mem_pool ) ; psli -> mbox_active = NULL ; } lpfc_mem_free ( phba ) ; dma_pool_destroy ( phba -> lpfc_sg_dma_buf_pool ) ; phba -> lpfc_sg_dma_buf_pool = NULL ; dma_pool_destroy ( phba -> lpfc_cmd_rsp_buf_pool ) ; phba -> lpfc_cmd_rsp_buf_pool = NULL ; if ( phba -> cgn_i ) { dma_free_coherent ( & phba -> pcidev -> dev , sizeof ( lpfc_cgn_info ) , phba -> cgn_i -> virt , phba -> cgn_i -> phys ) ; kfree ( phba -> cgn_i ) ; phba -> cgn_i = NULL ; } if ( phba -> rx_monitor ) { lpfc_rx_monitor_destroy_ring ( phba -> rx_monitor ) ; phba -> rx_monitor = NULL ; } kfree ( psli -> iocbq_lookup ) ; psli -> iocbq_lookup = NULL ; return ; } 