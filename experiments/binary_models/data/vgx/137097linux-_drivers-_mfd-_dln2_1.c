int dln2_register_event_cb ( struct platform_device * pdev , u16 id , dln2_event_cb_t event_cb ) { struct dln2_dev * dln2 = dev_get_drvdata ( pdev -> dev . parent ) ; struct dln2_event_cb_entry * i , * entry ; unsigned long flags ; int ret = 0 ; entry = kzalloc ( sizeof ( * entry ) , GFP_KERNEL ) ; entry -> id = id ; entry -> callback = event_cb ; entry -> pdev = pdev ; spin_lock_irqsave ( & dln2 -> event_cb_lock , flags ) ; list_for_each_entry ( , , ) { if ( i -> id == id ) { ret = - EBUSY ; break ; } } if ( ! ret ) { list_add_rcu ( & entry -> list , & dln2 -> event_cb_list ) ; } spin_unlock_irqrestore ( & dln2 -> event_cb_lock , flags ) ; if ( ret ) { kfree ( entry ) ; } return ret ; } 