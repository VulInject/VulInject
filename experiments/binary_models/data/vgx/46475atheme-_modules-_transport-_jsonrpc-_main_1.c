static bool jsonrpcmethod_login ( void * conn , mowgli_list_t * params , char * id ) { struct myuser * mu ; struct authcookie * ac ; char * sourceip , * accountname , * password ; size_t len = MOWGLI_LIST_LENGTH ( params ) ; if ( len < 2 ) { jsonrpc_failure_string ( conn , fault_needmoreparams , "Insufficient parameters." , id ) ; return false ; } accountname = mowgli_node_nth_data ( params , 0 ) ; password = mowgli_node_nth_data ( params , 1 ) ; sourceip = len >= 3 ?mowgli_node_nth_data ( params , 2 ) : NULL ; if ( ! ( mu = myuser_find ( accountname ) ) ) { jsonrpc_failure_string ( conn , fault_nosuch_source , "The account is not registered." , id ) ; return false ; } if ( metadata_find ( mu , "private:freeze:freezer" ) != NULL ) { logcommand_external ( nicksvs . me , "jsonrpc" , conn , sourceip , NULL , CMDLOG_LOGIN , "failed LOGIN to \2%s\2 (frozen)" , entity ( mu ) -> name ) ; jsonrpc_failure_string ( conn , fault_noprivs , "The account has been frozen." , id ) ; return false ; } if ( ! verify_password ( mu , password ) ) { struct sourceinfo * si ; logcommand_external ( nicksvs . me , "jsonrpc" , conn , sourceip , NULL , CMDLOG_LOGIN , "failed LOGIN to \2%s\2 (bad password)" , entity ( mu ) -> name ) ; jsonrpc_failure_string ( conn , fault_authfail , "The password is incorrect." , id ) ; si = sourceinfo_create ( ) ; struct jsonrpc_sourceinfo * jsi = ( jsonrpc_sourceinfo * ) si ; si -> service = NULL ; si -> sourcedesc = sourceip ; si -> connection = conn ; si -> v = & jsonrpc_vtable ; si -> force_language = language_find ( "en" ) ; jsi -> base = si ; jsi -> id = id ; bad_password ( si , mu ) ; return false ; } mu -> lastlogin = CURRTIME ; ac = authcookie_create ( mu ) ; logcommand_external ( nicksvs . me , "jsonrpc" , conn , sourceip , mu , CMDLOG_LOGIN , "LOGIN" ) ; jsonrpc_success_string ( conn , ac -> ticket , id ) ; return true ; } 