static void uart_set_termios ( struct tty_struct * tty , const struct ktermios * old_termios ) { struct uart_state * state = tty -> driver_data ; struct uart_port * uport ; unsigned int cflag = tty -> termios . c_cflag ; unsigned int iflag_mask = IGNBRK | BRKINT | IGNPAR | PARMRK | INPCK ; bool sw_changed = false ; mutex_lock ( & state -> port . mutex ) ; uport = uart_port_check ( state ) ; if ( uport -> flags & UPF_SOFT_FLOW ) { iflag_mask |= IXANY | IXON | IXOFF ; sw_changed = tty -> termios . c_cc [ VSTART ] != old_termios -> c_cc [ VSTART ] || tty -> termios . c_cc [ VSTOP ] != old_termios -> c_cc [ VSTOP ] ; } if ( ( cflag ^ old_termios -> c_cflag ) == 0 && tty -> termios . c_ospeed == old_termios -> c_ospeed && tty -> termios . c_ispeed == old_termios -> c_ispeed && ( ( tty -> termios . c_iflag ^ old_termios -> c_iflag ) & iflag_mask ) == 0 && ! sw_changed ) { out } uart_change_speed ( tty , state , old_termios ) ; cflag = tty -> termios . c_cflag ; if ( ( old_termios -> c_cflag & CBAUD ) && ! ( cflag & CBAUD ) ) { uart_clear_mctrl ( uport , TIOCM_RTS | TIOCM_DTR ) ; } if ( ! ( old_termios -> c_cflag & CBAUD ) && ( cflag & CBAUD ) ) { unsigned int mask = TIOCM_DTR ; if ( ! ( cflag & CRTSCTS ) || ! tty_throttled ( tty ) ) { mask |= TIOCM_RTS ; } uart_set_mctrl ( uport , mask ) ; } out mutex_unlock ( & state -> port . mutex ) ; } 