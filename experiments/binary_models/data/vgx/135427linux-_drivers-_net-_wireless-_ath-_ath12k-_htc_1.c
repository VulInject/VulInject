int ath12k_htc_connect_service ( struct ath12k_htc * htc , struct ath12k_htc_svc_conn_req * conn_req , struct ath12k_htc_svc_conn_resp * conn_resp ) { struct ath12k_base * ab = htc -> ab ; struct ath12k_htc_conn_svc * req_msg ; struct ath12k_htc_conn_svc_resp resp_msg_dummy ; struct ath12k_htc_conn_svc_resp * resp_msg = & resp_msg_dummy ; enum ath12k_htc_ep_id assigned_eid = ATH12K_HTC_EP_COUNT ; struct ath12k_htc_ep * ep ; struct sk_buff * skb ; unsigned int max_msg_size = 0 ; int length , status ; unsigned long time_left ; bool disable_credit_flow_ctrl = false ; u16 message_id , service_id , flags = 0 ; u8 tx_alloc = 0 ; if ( conn_req -> service_id == ATH12K_HTC_SVC_ID_RSVD_CTRL ) { disable_credit_flow_ctrl = true ; assigned_eid = ATH12K_HTC_EP_0 ; max_msg_size = ATH12K_HTC_MAX_CTRL_MSG_LEN ; setup } tx_alloc = ath12k_htc_get_credit_allocation ( htc , conn_req -> service_id ) ; if ( ! tx_alloc ) { ath12k_dbg ( ab , ATH12K_DBG_BOOT , "boot htc service %s does not allocate target credits\n" , htc_service_name ( conn_req -> service_id ) ) ; } skb = ath12k_htc_build_tx_ctrl_skb ( ) ; if ( ! skb ) { ath12k_warn ( ab , "Failed to allocate HTC packet\n" ) ; return - ENOMEM ; } length = sizeof ( * req_msg ) ; skb_put ( skb , length ) ; memset ( skb -> data , 0 , length ) ; req_msg = ( ath12k_htc_conn_svc * ) skb -> data ; req_msg -> msg_svc_id = le32_encode_bits ( ATH12K_HTC_MSG_CONNECT_SERVICE_ID , HTC_MSG_MESSAGEID ) ; flags |= u32_encode_bits ( tx_alloc , ATH12K_HTC_CONN_FLAGS_RECV_ALLOC ) ; if ( ! ( conn_req -> service_id == ATH12K_HTC_SVC_ID_WMI_CONTROL || conn_req -> service_id == ATH12K_HTC_SVC_ID_WMI_CONTROL_MAC1 || conn_req -> service_id == ATH12K_HTC_SVC_ID_WMI_CONTROL_MAC2 ) ) { flags |= ATH12K_HTC_CONN_FLAGS_DISABLE_CREDIT_FLOW_CTRL ; disable_credit_flow_ctrl = true ; } req_msg -> flags_len = le32_encode_bits ( flags , HTC_SVC_MSG_CONNECTIONFLAGS ) ; req_msg -> msg_svc_id |= le32_encode_bits ( conn_req -> service_id , HTC_SVC_MSG_SERVICE_ID ) ; reinit_completion ( & htc -> ctl_resp ) ; status = ath12k_htc_send ( htc , ATH12K_HTC_EP_0 , skb ) ; if ( status ) { kfree_skb ( skb ) ; return status ; } time_left = wait_for_completion_timeout ( & htc -> ctl_resp , ATH12K_HTC_CONN_SVC_TIMEOUT_HZ ) ; if ( ! time_left ) { ath12k_err ( ab , "Service connect timeout\n" ) ; return - ETIMEDOUT ; } resp_msg = ( ath12k_htc_conn_svc_resp * ) htc -> control_resp_buffer ; message_id = le32_get_bits ( resp_msg -> msg_svc_id , HTC_MSG_MESSAGEID ) ; service_id = le32_get_bits ( resp_msg -> msg_svc_id , HTC_SVC_RESP_MSG_SERVICEID ) ; if ( ( message_id != ATH12K_HTC_MSG_CONNECT_SERVICE_RESP_ID ) || ( htc -> control_resp_len < sizeof ( * resp_msg ) ) ) { ath12k_err ( ab , "Invalid resp message ID 0x%x" , message_id ) ; return - EPROTO ; } ath12k_dbg ( ab , ATH12K_DBG_HTC , "HTC Service %s connect response: status: %u, assigned ep: %u\n" , htc_service_name ( service_id ) , le32_get_bits ( resp_msg -> flags_len , HTC_SVC_RESP_MSG_STATUS ) , le32_get_bits ( resp_msg -> flags_len , HTC_SVC_RESP_MSG_ENDPOINTID ) ) ; conn_resp -> connect_resp_code = le32_get_bits ( resp_msg -> flags_len , HTC_SVC_RESP_MSG_STATUS ) ; if ( conn_resp -> connect_resp_code != ATH12K_HTC_CONN_SVC_STATUS_SUCCESS ) { ath12k_err ( ab , "HTC Service %s connect request failed: 0x%x)\n" , htc_service_name ( service_id ) , conn_resp -> connect_resp_code ) ; return - EPROTO ; } assigned_eid = le32_get_bits ( resp_msg -> flags_len , HTC_SVC_RESP_MSG_ENDPOINTID ) ; max_msg_size = le32_get_bits ( resp_msg -> flags_len , HTC_SVC_RESP_MSG_MAXMSGSIZE ) ; setup if ( assigned_eid >= ATH12K_HTC_EP_COUNT ) { return - EPROTO ; } if ( max_msg_size == 0 ) { return - EPROTO ; } ep = & htc -> endpoint [ assigned_eid ] ; ep -> eid = assigned_eid ; if ( ep -> service_id != ATH12K_HTC_SVC_ID_UNUSED ) { return - EPROTO ; } conn_resp -> eid = assigned_eid ; conn_resp -> max_msg_len = le32_get_bits ( resp_msg -> flags_len , HTC_SVC_RESP_MSG_MAXMSGSIZE ) ; ep -> service_id = conn_req -> service_id ; ep -> max_tx_queue_depth = conn_req -> max_send_queue_depth ; ep -> max_ep_message_len = le32_get_bits ( resp_msg -> flags_len , HTC_SVC_RESP_MSG_MAXMSGSIZE ) ; ep -> tx_credits = tx_alloc ; ep -> ep_ops = conn_req -> ep_ops ; status = ath12k_hif_map_service_to_pipe ( htc -> ab , ep -> service_id , & ep -> ul_pipe_id , & ep -> dl_pipe_id ) ; if ( status ) { return status ; } ath12k_dbg ( ab , ATH12K_DBG_BOOT , "boot htc service '%s' ul pipe %d dl pipe %d eid %d ready\n" , htc_service_name ( ep -> service_id ) , ep -> ul_pipe_id , ep -> dl_pipe_id , ep -> eid ) ; if ( disable_credit_flow_ctrl && ep -> tx_credit_flow_enabled ) { ep -> tx_credit_flow_enabled = false ; ath12k_dbg ( ab , ATH12K_DBG_BOOT , "boot htc service '%s' eid %d TX flow control disabled\n" , htc_service_name ( ep -> service_id ) , assigned_eid ) ; } return status ; } 