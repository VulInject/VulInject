static int CmdRemoveServices ( ) { SC_HANDLE service ; SC_HANDLE svc_ctl_mgr ; SERVICE_STATUS status ; int i , ret = _service_max ; svc_ctl_mgr = OpenSCManager ( NULL , NULL , SC_MANAGER_CONNECT ) ; if ( svc_ctl_mgr == NULL ) { wprintf ( TEXT ( "OpenSCManager failed - %ls\n" ) , GetLastErrorText ( ) ) ; return 1 ; } for ( i = 0 ; i < _service_max ; i ++ ) { openvpn_service_t * ovpn_svc = & openvpn_service [ i ] ; service = OpenService ( svc_ctl_mgr , ovpn_svc -> name , DELETE | SERVICE_STOP | SERVICE_QUERY_STATUS ) ; if ( service == NULL ) { wprintf ( TEXT ( "OpenService failed - %ls\n" ) , GetLastErrorText ( ) ) ; out } if ( ControlService ( service , SERVICE_CONTROL_STOP , & status ) ) { wprintf ( TEXT ( "Stopping %ls." ) , ovpn_svc -> display_name ) ; Sleep ( 1000 ) ; while ( QueryServiceStatus ( service , & status ) ) { if ( status . dwCurrentState == SERVICE_STOP_PENDING ) { wprintf ( TEXT ( "." ) ) ; Sleep ( 1000 ) ; } else { break ; } } if ( status . dwCurrentState == SERVICE_STOPPED ) { wprintf ( TEXT ( "\n%ls stopped.\n" ) , ovpn_svc -> display_name ) ; } else { wprintf ( TEXT ( "\n%ls failed to stop.\n" ) , ovpn_svc -> display_name ) ; } } if ( DeleteService ( service ) ) { wprintf ( TEXT ( "%ls removed.\n" ) , ovpn_svc -> display_name ) ; -- ret ; } else { wprintf ( TEXT ( "DeleteService failed - %ls\n" ) , GetLastErrorText ( ) ) ; } CloseServiceHandle ( service , NULL ) ; } out CloseServiceHandle ( svc_ctl_mgr ) ; return ret ; } 