static BIGNUM * BN_gcd_no_branch ( BIGNUM * in , const BIGNUM * a , const BIGNUM * n , BN_CTX * ctx ) { BIGNUM * A , * B , * X , * Y , * M , * D , * T , * R = NULL ; BIGNUM local_A , local_B ; BIGNUM * pA , * pB ; BIGNUM * ret ; int sign ; if ( in == NULL ) { err } R = in ; BN_init ( & local_A ) ; BN_init ( & local_B ) ; BN_CTX_start ( ctx ) ; if ( ( A = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ( B = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ( X = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ( D = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ( M = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ( Y = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ( T = BN_CTX_get ( ctx ) ) == NULL ) { err } if ( ! BN_one ( X ) ) { err } BN_zero ( Y ) ; if ( BN_copy ( B , a ) == NULL ) { err } if ( BN_copy ( A , n ) == NULL ) { err } A -> neg = 0 ; if ( B -> neg || ( BN_ucmp ( B , A ) >= 0 ) ) { pB = & local_B ; BN_with_flags ( pB , B , BN_FLG_CONSTTIME ) ; if ( ! BN_nnmod ( B , pB , A , ctx ) ) { err } } sign = - 1 ; while ( ! BN_is_zero ( B ) ) { BIGNUM * tmp ; pA = & local_A ; BN_with_flags ( pA , A , BN_FLG_CONSTTIME ) ; if ( ! BN_div_ct ( D , M , pA , B , ctx ) ) { err } tmp = A ; A = B ; B = M ; if ( ! BN_mul ( tmp , D , X , ctx ) ) { err } if ( ! BN_add ( tmp , tmp , Y ) ) { err } M = Y ; Y = X ; X = tmp ; sign = - sign ; } if ( ! BN_copy ( R , A ) ) { err } ret = R ; err if ( ( ret == NULL ) && ( in == NULL ) ) { BN_free ( R ) ; } BN_CTX_end ( ctx ) ; return ( ret ) ; } 