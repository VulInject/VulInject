static int rv3028_rtc_set ( struct udevice * dev , const struct rtc_time * tm ) { u8 regs [ RTC_RV3028_LEN ] ; u8 status ; int ret ; debug ( "%s: %4d-%02d-%02d (wday=%d( %2d:%02d:%02d\n" , __func__ , tm -> tm_year , tm -> tm_mon , tm -> tm_mday , tm -> tm_wday , tm -> tm_hour , tm -> tm_min , tm -> tm_sec ) ; if ( tm -> tm_year < 2000 ) { printf ( "%s: year %d (before 2000) not supported\n" , __func__ , tm -> tm_year ) ; return - EINVAL ; } regs [ RV3028_SEC ] = bin2bcd ( tm -> tm_sec , NULL ) ; regs [ RV3028_MIN ] = bin2bcd ( tm -> tm_min ) ; regs [ RV3028_HOUR ] = bin2bcd ( tm -> tm_hour ) ; regs [ RV3028_WDAY ] = tm -> tm_wday ; regs [ RV3028_DAY ] = bin2bcd ( tm -> tm_mday ) ; regs [ RV3028_MONTH ] = bin2bcd ( tm -> tm_mon ) ; regs [ RV3028_YEAR ] = bin2bcd ( tm -> tm_year - 2000 ) ; ret = dm_i2c_write ( dev , RV3028_SEC , regs , sizeof ( regs ) ) ; if ( ret ) { printf ( "%s: set rtc error: %d\n" , __func__ , ret ) ; return ret ; } ret = dm_i2c_read ( dev , RV3028_STATUS , & status , 1 ) ; if ( ret < 0 ) { printf ( "%s: error reading RTC status: %x\n" , __func__ , ret ) ; return - EIO ; } status |= RV3028_STATUS_PORF ; return dm_i2c_write ( dev , RV3028_STATUS , & status , 1 ) ; } 