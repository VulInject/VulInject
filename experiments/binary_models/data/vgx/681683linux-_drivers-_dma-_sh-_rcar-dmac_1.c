static irqreturn_t rcar_dmac_isr_channel ( int irq , void * dev ) { u32 mask = RCAR_DMACHCR_DSE | RCAR_DMACHCR_TE ; struct rcar_dmac_chan * chan = dev ; irqreturn_t ret = IRQ_NONE ; bool reinit = false ; u32 chcr ; spin_lock ( & chan -> lock ) ; chcr = rcar_dmac_chan_read ( chan , RCAR_DMACHCR ) ; if ( chcr & RCAR_DMACHCR_CAE ) { struct rcar_dmac * dmac = to_rcar_dmac ( chan -> chan . device ) ; rcar_dmac_chan_clear ( dmac , chan ) ; rcar_dmac_chcr_de_barrier ( chan ) ; reinit = true ; spin_lock_end } if ( chcr & RCAR_DMACHCR_TE ) { mask |= RCAR_DMACHCR_DE ; } rcar_dmac_chan_write ( chan , RCAR_DMACHCR , chcr & ~ mask ) ; if ( mask & RCAR_DMACHCR_DE ) { rcar_dmac_chcr_de_barrier ( chan ) ; } if ( chcr & RCAR_DMACHCR_DSE ) { ret |= rcar_dmac_isr_desc_stage_end ( chan ) ; } if ( chcr & RCAR_DMACHCR_TE ) { ret |= rcar_dmac_isr_transfer_end ( chan ) ; } spin_lock_end spin_unlock ( & chan -> lock ) ; if ( reinit ) { dev_err ( chan -> chan . device -> dev , "Channel Address Error\n" ) ; rcar_dmac_chan_reinit ( chan , NULL ) ; ret = IRQ_HANDLED ; } return ret ; } 