int load_domains ( domain_t * * dest ) { db_res_t * res = NULL ; db_rec_t * rec ; int flags ; domain_t * d , * list ; list = 0 ; if ( ( db_exec ( & res , load_domains_cmd ) < 0 ) || ( res == NULL ) ) { ERR ( "Error while querying database\n" ) ; return - 1 ; } rec = db_first ( res ) ; while ( rec ) { if ( rec -> fld [ 0 ] . flags & DB_NULL || rec -> fld [ 1 ] . flags & DB_NULL || rec -> fld [ 2 ] . flags & DB_NULL ) { ERR ( "Row with NULL column(s), skipping\n" ) ; skip } flags = rec -> fld [ 2 ] . v . int4 ; if ( flags & SRDB_DISABLED ) { skip } if ( ! ( flags & SRDB_LOAD_SER ) ) { skip } DBG ( "Processing entry (%.*s, %.*s, %u)\n" , rec -> fld [ 0 ] . v . lstr . len , ZSW ( rec -> fld [ 0 ] . v . lstr . s ) , rec -> fld [ 1 ] . v . lstr . len , ZSW ( rec -> fld [ 1 ] . v . lstr . s ) , flags ) ; d = domain_search ( list , & rec -> fld [ 0 ] . v . lstr ) ; if ( d ) { if ( domain_add ( d , & rec -> fld [ 1 ] . v . lstr , flags ) < 0 ) { error } } else { d = new_domain ( & rec -> fld [ 0 ] . v . lstr , & rec -> fld [ 1 ] . v . lstr , flags ) ; if ( ! d ) { error } d -> next = list ; list = d ; } skip rec = db_next ( res ) ; } db_res_free ( res ) ; res = NULL ; if ( load_domain_attrs ) { d = list ; while ( d ) { if ( db_load_domain_attrs ( d ) < 0 ) { error } d = d -> next ; } } * dest = list ; return 0 ; error if ( res ) { db_res_free ( res ) ; } free_domain_list ( list ) ; return 1 ; } 