static int _mci_cmd_unlocked ( struct mci * state , u32 * cmd , u32 cmd_len , u32 * res , u32 res_len ) { struct ddb_link * link = state -> base -> link ; u32 i , val ; unsigned long stat ; val = ddblreadl ( link , MCI_CONTROL ) ; if ( cmd && cmd_len ) { for ( i = 0 ; i < cmd_len ; i ++ ) { ddblwritel ( link , cmd [ i ] , MCI_COMMAND + i * 4 ) ; } } val |= ( MCI_CONTROL_START_COMMAND | MCI_CONTROL_ENABLE_DONE_INTERRUPT ) ; ddblwritel ( link , val , MCI_CONTROL ) ; stat = wait_for_completion_timeout ( & state -> base -> completion , HZ ) ; if ( stat == 0 ) { dev_warn ( state -> base -> dev , "MCI-%d: MCI timeout\n" , state -> nr ) ; return - EIO ; } if ( res && res_len ) { for ( i = 0 ; i < res_len ; i ++ ) { res [ i ] = ddblreadl ( link , MCI_RESULT + i * 4 ) ; } } return 0 ; } 