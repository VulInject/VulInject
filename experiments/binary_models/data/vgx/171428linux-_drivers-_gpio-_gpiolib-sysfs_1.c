static int gpio_sysfs_request_irq ( struct device * dev , unsigned char flags ) { struct gpiod_data * data = dev_get_drvdata ( dev ) ; struct gpio_desc * desc = data -> desc ; unsigned long irq_flags ; int ret ; data -> irq = gpiod_to_irq ( desc ) ; if ( data -> irq < 0 ) { return - EIO ; } data -> value_kn = sysfs_get_dirent ( dev -> kobj . sd , "value" ) ; irq_flags = IRQF_SHARED ; if ( flags & GPIO_IRQF_TRIGGER_FALLING ) { irq_flags |= test_bit ( FLAG_ACTIVE_LOW , & desc -> flags ) ?IRQF_TRIGGER_RISING : IRQF_TRIGGER_FALLING ; } if ( flags & GPIO_IRQF_TRIGGER_RISING ) { irq_flags |= test_bit ( FLAG_ACTIVE_LOW , & desc -> flags ) ?IRQF_TRIGGER_FALLING : IRQF_TRIGGER_RISING ; } ret = gpiochip_lock_as_irq ( desc -> gdev -> chip , gpio_chip_hwgpio ( desc ) ) ; if ( ret < 0 ) { err_put_kn } ret = request_any_context_irq ( data -> irq , gpio_sysfs_irq , irq_flags , "gpiolib" , data ) ; if ( ret < 0 ) { err_unlock } data -> irq_flags = flags ; return 0 ; err_unlock gpiochip_unlock_as_irq ( desc -> gdev -> chip , gpio_chip_hwgpio ( desc ) ) ; err_put_kn sysfs_put ( data -> value_kn ) ; return ret ; } 