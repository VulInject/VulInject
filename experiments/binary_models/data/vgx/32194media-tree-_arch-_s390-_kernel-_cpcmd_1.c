int cpcmd ( const char * cmd , char * response , int rlen , int * response_code ) { char * lowbuf ; int len ; unsigned long flags ; if ( ( virt_to_phys ( response ) != ( unsigned long ) response ) || ( ( ( unsigned long ) response + rlen ) >> 31 ) ) { lowbuf = kmalloc ( rlen , GFP_KERNEL | GFP_DMA ) ; if ( ! lowbuf ) { pr_warn ( "The cpcmd kernel function failed to allocate a response buffer\n" ) ; return - ENOMEM ; } spin_lock_irqsave ( & cpcmd_lock , flags ) ; len = __cpcmd ( cmd , lowbuf , rlen , response_code ) ; spin_unlock_irqrestore ( & cpcmd_lock , flags ) ; memcpy ( response , lowbuf , rlen ) ; } else { spin_lock_irqsave ( & cpcmd_lock , flags ) ; len = __cpcmd ( cmd , response , rlen , response_code ) ; spin_unlock_irqrestore ( & cpcmd_lock , flags ) ; } return len ; } 