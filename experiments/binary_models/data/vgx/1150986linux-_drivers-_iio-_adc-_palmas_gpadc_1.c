static int palmas_gpadc_read_raw ( struct iio_dev * indio_dev , struct iio_chan_spec const * chan , int * val , int * val2 , long mask ) { struct palmas_gpadc * adc = iio_priv ( indio_dev ) ; int adc_chan = chan -> channel ; int ret ; if ( adc_chan > PALMAS_ADC_CH_MAX ) { return - EINVAL ; } mutex_lock ( & adc -> lock ) ; switch ( mask ) { case IIO_CHAN_INFO_RAW : case IIO_CHAN_INFO_PROCESSED : ret = palmas_gpadc_read_prepare ( adc , adc_chan ) ; if ( ret < 0 ) { out } ret = palmas_gpadc_start_conversion ( adc , adc_chan ) ; if ( ret < 0 ) { dev_err ( adc -> dev , "ADC start conversion failed\n" ) ; out } if ( mask == IIO_CHAN_INFO_PROCESSED ) { ret = palmas_gpadc_get_calibrated_code ( adc , adc_chan , ret ) ; } * val = ret ; ret = IIO_VAL_INT ; out } mutex_unlock ( & adc -> lock ) ; return ret ; out palmas_gpadc_read_done ( adc , adc_chan ) ; mutex_unlock ( & adc -> lock ) ; return ret ; } static const struct iio_info palmas_gpadc_iio_info = { . read_raw = palmas_gpadc_read_raw } ; 