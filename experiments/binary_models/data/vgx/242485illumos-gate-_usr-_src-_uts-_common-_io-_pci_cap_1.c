int pci_cap_probe ( ddi_acc_handle_t h , uint16_t index , uint32_t * id_p , uint16_t * base_p ) { int i , search_ext = 0 ; uint16_t base , pcix_cmd , status ; uint32_t id , xcaps_hdr ; status = pci_config_get16 ( h , PCI_CONF_STAT ) ; if ( status == PCI_CAP_EINVAL16 || ! ( status & PCI_STAT_CAP ) ) { return ( DDI_FAILURE ) ; } for ( i = 0 , base = pci_config_get8 ( h , PCI_CONF_CAP_PTR ) ; base && i < index ; base = pci_config_get8 ( h , base + PCI_CAP_NEXT_PTR ) , i ++ ) { if ( ( id = pci_config_get8 ( h , base ) ) == 0xff ) { break ; } if ( id == PCI_CAP_ID_PCI_E ) { search_ext = 1 ; } if ( id == PCI_CAP_ID_PCIX ) { if ( ( pcix_cmd = pci_config_get16 ( h , base + PCI_PCIX_COMMAND ) ) != PCI_CAP_EINVAL16 ) { continue ; } if ( ( pcix_cmd & PCI_PCIX_VER_MASK ) == PCI_PCIX_VER_2 ) { search_ext = 1 ; } } } if ( base && i == index ) { if ( ( id = pci_config_get8 ( h , base ) ) != 0xff ) { found } } for ( base = PCIE_EXT_CAP ; base && i < index ; i ++ ) { if ( ( xcaps_hdr = pci_config_get32 ( h , base ) ) == PCI_CAP_EINVAL32 ) { break ; } id = ( xcaps_hdr >> PCIE_EXT_CAP_ID_SHIFT ) & PCIE_EXT_CAP_ID_MASK ; base = ( xcaps_hdr >> PCIE_EXT_CAP_NEXT_PTR_SHIFT ) & PCIE_EXT_CAP_NEXT_PTR_MASK ; } if ( ! base || i < index ) { return ( DDI_FAILURE ) ; } if ( ( xcaps_hdr = pci_config_get32 ( h , base ) ) == PCI_CAP_EINVAL32 ) { return ( DDI_FAILURE ) ; } id = ( ( xcaps_hdr >> PCIE_EXT_CAP_ID_SHIFT ) & PCIE_EXT_CAP_ID_MASK ) | PCI_CAP_XCFG_FLAG ; found PCI_CAP_DBG ( "pci_cap_probe: index=%x, id=%x, base=%x\n" , index , id , base ) ; * id_p = id ; * base_p = base ; return ( DDI_SUCCESS ) ; } 