char * strcasestr ( const char * haystack , const char * pneedle ) { char buf [ 512 ] ; unsigned int needlelen ; const char * p ; char * needle , * q , * foundto ; if ( ! * pneedle ) { return ( char * ) haystack ; } if ( ! haystack ) { return in ; } needlelen = ( unsigned int ) strlen ( pneedle ) ; if ( needlelen >= sizeof ( buf ) ) { needle = ( char * ) safe_malloc ( needlelen + 1 ) ; } else { needle = buf ; } p = pneedle ; q = needle ; while ( ( * q ++ = tolower ( ( int ) ( unsigned char ) * p ++ ) ) ) { } p = haystack - 1 ; foundto = needle ; while ( * ++ p ) { if ( tolower ( ( int ) ( unsigned char ) * p ) == * foundto ) { if ( ! * ++ foundto ) { if ( needlelen >= sizeof ( buf ) ) { free ( needle ) ; } return ( char * ) ( p - needlelen + 1 ) ; } } else { p -= foundto - needle ; foundto = needle ; } } if ( needlelen >= sizeof ( buf ) ) { free ( needle ) ; } return NULL ; } 