static void p4_ht_error ( void ) { kstat_ctl_t * kc ; kstat_t * ksp ; kstat_named_t * k ; int i ; int max ; int stat ; int * designees ; int * must_offline ; char buf [ BUFSIZE ] ; char * cmd ; int noffline = 0 ; int ndone = 0 ; ( void ) fprintf ( stderr , "%s\n" , gettext ( "Pentium 4 processors with HyperThreading present.\nOffline" " all but one logical processor on each physical processor in" " order to use\ncputrack.\n" ) ) ; if ( ( kc = kstat_open ( ) ) == NULL ) { return ; } max = sysconf ( _SC_CPUID_MAX ) ; if ( ( designees = malloc ( max * sizeof ( * designees ) ) ) == NULL ) { ( void ) fprintf ( stderr , gettext ( "%s: no memory available\n" ) , opts -> pgmname ) ; exit ( 0 ) ; } if ( ( must_offline = malloc ( max * sizeof ( * designees ) ) ) == NULL ) { ( void ) fprintf ( stderr , gettext ( "%s: no memory available\n" ) , opts -> pgmname ) ; exit ( 0 ) ; } for ( i = 0 ; i < max ; i ++ ) { designees [ i ] = - 1 ; must_offline [ i ] = 0 ; } for ( i = 0 ; i < max ; i ++ ) { stat = p_online ( i , P_STATUS ) ; if ( stat != P_ONLINE && stat != P_NOINTR ) { continue ; } if ( ( ksp = kstat_lookup ( kc , "cpu_info" , i , NULL ) ) == NULL ) { free ( designees ) ; return ; } if ( kstat_read ( kc , ksp , NULL ) == - 1 ) { free ( designees ) ; free ( must_offline ) ; return ; } if ( ( k = ( kstat_named_t * ) kstat_data_lookup ( ksp , "chip_id" ) ) == NULL ) { free ( designees ) ; free ( must_offline ) ; return ; } if ( designees [ k -> value . i32 ] == - 1 ) { designees [ k -> value . i32 ] = i ; } else { must_offline [ i ] = 1 ; noffline ++ ; } } if ( ( cmd = malloc ( strlen ( OFFLINE_CMD ) + ( noffline * BUFSIZE ) + 1 ) ) == NULL ) { ( void ) fprintf ( stderr , gettext ( "%s: no memory available\n" ) , opts -> pgmname ) ; exit ( 0 ) ; } ( void ) strcpy ( cmd , OFFLINE_CMD ) ; for ( i = 0 ; i < max ; i ++ ) { if ( must_offline [ i ] == 0 ) { continue ; } ndone ++ ; ( void ) snprintf ( buf , BUFSIZE , "%d" , i ) ; if ( ndone < noffline ) { ( void ) strcat ( buf , " " ) ; } ( void ) strcat ( cmd , buf ) ; } ( void ) fprintf ( stderr , "%s:\n%s\n" , gettext ( "The following command " "will configure the system appropriately" ) , cmd ) ; exit ( 1 ) ; } 