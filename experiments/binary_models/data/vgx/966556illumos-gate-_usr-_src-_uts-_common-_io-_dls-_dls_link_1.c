void dls_link_remove ( dls_link_t * dlp , dld_str_t * dsp ) { mod_hash_t * hash = dlp -> dl_str_hash ; dld_str_t * * pp ; dld_str_t * p ; dls_head_t * dhp ; ASSERT ( MAC_PERIM_HELD ( dlp -> dl_mh ) ) ; dhp = dsp -> ds_head ; mutex_enter ( & dhp -> dh_lock ) ; dhp -> dh_removing = B_TRUE ; while ( dhp -> dh_ref != 0 ) { cv_wait ( & dhp -> dh_cv , & dhp -> dh_lock ) ; } mutex_exit ( & dhp -> dh_lock ) ; for ( pp = & dhp -> dh_list ; ( p = * pp ) != NULL ; pp = & ( p -> ds_next ) ) { if ( p == dsp ) { break ; } } ASSERT ( p != NULL ) ; * pp = p -> ds_next ; p -> ds_next = NULL ; ASSERT ( dlp -> dl_impl_count != 0 ) ; dlp -> dl_impl_count -- ; if ( dhp -> dh_list == NULL ) { mod_hash_val_t val = NULL ; ( void ) mod_hash_remove ( hash , dhp -> dh_key , & val ) ; ASSERT ( dhp == ( dls_head_t * ) val ) ; i_dls_head_free ( dhp ) ; } else { mutex_enter ( & dhp -> dh_lock ) ; dhp -> dh_removing = B_FALSE ; mutex_exit ( & dhp -> dh_lock ) ; } } 