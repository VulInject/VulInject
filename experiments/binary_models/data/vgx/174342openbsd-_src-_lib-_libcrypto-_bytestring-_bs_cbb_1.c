int CBB_flush ( CBB * cbb ) { size_t child_start , i , len ; if ( cbb -> base == NULL ) { return 0 ; } if ( cbb -> child == NULL || cbb -> pending_len_len == 0 ) { return 1 ; } child_start = cbb -> offset + cbb -> pending_len_len ; if ( ! CBB_flush ( cbb -> child ) || child_start < cbb -> offset || cbb -> base -> len < child_start ) { return 0 ; } len = cbb -> base -> len - child_start ; if ( cbb -> pending_is_asn1 ) { size_t len_len = 1 ; uint8_t initial_length_byte ; if ( cbb -> pending_len_len != 1 ) { return 0 ; } if ( len > 0xfffffffe ) { return 0 ; } if ( len > 0xffffff ) { len_len = 5 ; } if ( len > 0xffff ) { len_len = 4 ; } if ( len > 0xff ) { len_len = 3 ; } if ( len > 0x7f ) { len_len = 2 ; } if ( len_len == 1 ) { initial_length_byte = len ; len = 0 ; } else { initial_length_byte = 0x80 | ( len_len - 1 ) ; size_t extra_bytes = len_len - 1 ; if ( ! cbb_buffer_add ( cbb -> base , NULL , extra_bytes ) ) { return 0 ; } memmove ( cbb -> base -> buf + child_start + extra_bytes , cbb -> base -> buf + child_start , len ) ; } cbb -> base -> buf [ cbb -> offset ++ ] = initial_length_byte ; cbb -> pending_len_len = len_len - 1 ; } for ( i = cbb -> pending_len_len - 1 ; i < cbb -> pending_len_len ; i -- ) { cbb -> base -> buf [ cbb -> offset + i ] = len ; len >>= 8 ; } if ( len != 0 ) { return 0 ; } cbb -> child -> base = NULL ; cbb -> pending_len_len = 0 ; cbb -> pending_is_asn1 = 0 ; cbb -> offset = 0 ; return 1 ; } 