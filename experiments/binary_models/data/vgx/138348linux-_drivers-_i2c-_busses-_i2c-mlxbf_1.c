static int mlxbf_i2c_smbus_start_transaction ( struct mlxbf_i2c_priv * priv , struct mlxbf_i2c_smbus_request * request ) { u8 data_desc [ MLXBF_I2C_MASTER_DATA_DESC_SIZE ] { 0 } ; ; u8 op_idx , data_idx , data_len , write_len , read_len ; struct mlxbf_i2c_smbus_operation * operation ; u8 read_en , write_en , block_en , pec_en ; u8 slave , flags , addr ; u8 * read_buf ; int ret = 0 ; if ( request -> operation_cnt > MLXBF_I2C_SMBUS_MAX_OP_CNT ) { return - EINVAL ; } read_buf = NULL ; data_idx = 0 ; read_en = 0 ; write_len = 0 ; read_len = 0 ; block_en = 0 ; pec_en = 0 ; slave = request -> slave & GENMASK ( 6 , 0 ) ; addr = slave << 1 ; if ( WARN_ON ( ! mlxbf_i2c_smbus_master_lock ( priv ) ) ) { return - EBUSY ; } if ( WARN_ON ( ! mlxbf_i2c_smbus_master_wait_for_idle ( priv ) ) ) { ret = - EBUSY ; out_unlock } data_desc [ data_idx ++ ] = addr ; for ( op_idx = 0 ; op_idx < request -> operation_cnt ; op_idx ++ ) { operation = & request -> operation [ op_idx ] ; flags = operation -> flags ; if ( op_idx == 0 && flags & MLXBF_I2C_F_SMBUS_OPERATION ) { block_en = flags & MLXBF_I2C_F_SMBUS_BLOCK ; pec_en = flags & MLXBF_I2C_F_SMBUS_PEC ; } if ( flags & MLXBF_I2C_F_WRITE ) { write_en = 1 ; write_len += operation -> length ; if ( data_idx + operation -> length > MLXBF_I2C_MASTER_DATA_DESC_SIZE ) { ret = - ENOBUFS ; out_unlock } memcpy ( data_desc + data_idx , operation -> buffer , operation -> length ) ; data_idx += operation -> length ; } if ( flags & MLXBF_I2C_F_READ ) { read_en = 1 ; read_len = operation -> length - 1 ; read_buf = operation -> buffer ; } } data_len = write_len + 1 ; mlxbf_i2c_smbus_write_data ( priv , ( const u8 * ) data_desc , data_len , MLXBF_I2C_MASTER_DATA_DESC_ADDR , true ) ; if ( write_en ) { ret = mlxbf_i2c_smbus_enable ( priv , slave , write_len , block_en , pec_en , 0 ) ; if ( ret ) { out_unlock } } if ( read_en ) { mlxbf_i2c_smbus_write_data ( priv , ( const u8 * ) & addr , 1 , MLXBF_I2C_MASTER_DATA_DESC_ADDR , true ) ; ret = mlxbf_i2c_smbus_enable ( priv , slave , read_len , block_en , pec_en , 1 ) ; if ( ! ret ) { mlxbf_i2c_smbus_read_data ( priv , data_desc , read_len + 1 , MLXBF_I2C_MASTER_DATA_DESC_ADDR , true ) ; memcpy ( read_buf , data_desc , read_len + 1 ) ; } writel ( MLXBF_I2C_SMBUS_MASTER_FSM_PS_STATE_MASK , priv -> mst -> io + priv -> chip -> smbus_master_fsm_off ) ; } out_unlock mlxbf_i2c_smbus_master_unlock ( priv ) ; return ret ; } 