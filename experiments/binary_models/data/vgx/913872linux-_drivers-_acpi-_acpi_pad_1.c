static int power_saving_thread ( void * data ) { int do_sleep ; unsigned int tsk_index = ( unsigned long ) data ; int last_jiffies = 0 ; sched_set_fifo_low ( current ) ; while ( ! kthread_should_stop ( ) ) { unsigned long expire_time ; expire_time = last_jiffies + round_robin_time * HZ ; if ( time_before ( expire_time , jiffies ) ) { last_jiffies = jiffies ; round_robin_cpu ( tsk_index ) ; } do_sleep = 0 ; expire_time = jiffies + HZ * ( 100 - idle_pct ) / 100 ; while ( ! need_resched ( ) ) { if ( tsc_detected_unstable && ! tsc_marked_unstable ) { mark_tsc_unstable ( "TSC halts in idle" ) ; tsc_marked_unstable = 1 ; } local_irq_disable ( ) ; perf_lopwr_cb ( true ) ; tick_broadcast_enable ( ) ; tick_broadcast_enter ( ) ; stop_critical_timings ( ) ; mwait_idle_with_hints ( power_saving_mwait_eax , 1 ) ; start_critical_timings ( ) ; tick_broadcast_exit ( ) ; perf_lopwr_cb ( false ) ; local_irq_enable ( ) ; if ( time_before ( expire_time , jiffies ) ) { do_sleep = 1 ; break ; } } if ( unlikely ( do_sleep ) ) { schedule_timeout_killable ( HZ * idle_pct / 100 ) ; } if ( unlikely ( need_resched ( ) ) ) { schedule ( ) ; } } exit_round_robin ( tsk_index ) ; return 0 ; } static struct task_struct * ps_tsks [ NR_CPUS ] ; static unsigned int ps_tsk_num ; static int create_power_saving_task ( void ) { int rc ; ps_tsks [ ps_tsk_num ] = kthread_run ( power_saving_thread , ( void * ) ( unsigned long ) ps_tsk_num , "acpi_pad/%d" , ps_tsk_num ) ; if ( IS_ERR ( ps_tsks [ ps_tsk_num ] ) ) { rc = PTR_ERR ( ps_tsks [ ps_tsk_num ] ) ; ps_tsks [ ps_tsk_num ] = NULL ; } else { rc = 0 ; ps_tsk_num ++ ; } return rc ; } 