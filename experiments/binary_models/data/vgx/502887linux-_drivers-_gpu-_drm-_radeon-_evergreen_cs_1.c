static int evergreen_cs_track_validate_stencil ( struct radeon_cs_parser * p ) { struct evergreen_cs_track * track = p -> track ; struct eg_surface surf ; unsigned pitch , slice , mslice ; unsigned long offset ; int r ; mslice = G_028008_SLICE_MAX ( track -> db_depth_view ) + 1 ; pitch = G_028058_PITCH_TILE_MAX ( track -> db_depth_size ) ; slice = track -> db_depth_slice ; surf . nbx = ( pitch + 1 ) * 8 ; surf . nby = ( ( slice + 1 ) * 64 ) / surf . nbx ; surf . mode = G_028040_ARRAY_MODE ( track -> db_z_info ) ; surf . format = G_028044_FORMAT ( track -> db_s_info ) ; surf . tsplit = G_028044_TILE_SPLIT ( track -> db_s_info ) ; surf . nbanks = G_028040_NUM_BANKS ( track -> db_z_info ) ; surf . bankw = G_028040_BANK_WIDTH ( track -> db_z_info ) ; surf . bankh = G_028040_BANK_HEIGHT ( track -> db_z_info ) ; surf . mtilea = G_028040_MACRO_TILE_ASPECT ( track -> db_z_info ) ; surf . nsamples = 1 ; if ( surf . format != 1 ) { dev_warn ( p -> dev , "%s:%d stencil invalid format %d\n" , __func__ , __LINE__ , surf . format ) ; return - EINVAL ; } surf . format = V_028C70_COLOR_8 ; r = evergreen_surface_value_conv_check ( p , & surf , "stencil" ) ; r = evergreen_surface_check ( p , & surf , NULL ) ; if ( r ) { surf . format = V_028C70_COLOR_8_8_8_8 ; r = evergreen_surface_check ( p , & surf , "stencil" ) ; if ( r ) { dev_warn ( p -> dev , "%s:%d stencil invalid (0x%08x 0x%08x 0x%08x 0x%08x)\n" , __func__ , __LINE__ , track -> db_depth_size , track -> db_depth_slice , track -> db_s_info , track -> db_z_info ) ; } return r ; } offset = track -> db_s_read_offset << 8 ; if ( offset & ( surf . base_align - 1 ) ) { dev_warn ( p -> dev , "%s:%d stencil read bo base %ld not aligned with %ld\n" , __func__ , __LINE__ , offset , surf . base_align ) ; return - EINVAL ; } offset += surf . layer_size * mslice ; if ( offset > radeon_bo_size ( track -> db_s_read_bo ) ) { dev_warn ( p -> dev , "%s:%d stencil read bo too small (layer size %d, " "offset %ld, max layer %d, bo size %ld)\n" , __func__ , __LINE__ , surf . layer_size , ( unsigned long ) track -> db_s_read_offset << 8 , mslice , radeon_bo_size ( track -> db_s_read_bo ) ) ; dev_warn ( p -> dev , "%s:%d stencil invalid (0x%08x 0x%08x 0x%08x 0x%08x)\n" , __func__ , __LINE__ , track -> db_depth_size , track -> db_depth_slice , track -> db_s_info , track -> db_z_info ) ; return - EINVAL ; } offset = track -> db_s_write_offset << 8 ; if ( offset & ( surf . base_align - 1 ) ) { dev_warn ( p -> dev , "%s:%d stencil write bo base %ld not aligned with %ld\n" , __func__ , __LINE__ , offset , surf . base_align ) ; return - EINVAL ; } offset += surf . layer_size * mslice ; if ( offset > radeon_bo_size ( track -> db_s_write_bo ) ) { dev_warn ( p -> dev , "%s:%d stencil write bo too small (layer size %d, " "offset %ld, max layer %d, bo size %ld)\n" , __func__ , __LINE__ , surf . layer_size , ( unsigned long ) track -> db_s_write_offset << 8 , mslice , radeon_bo_size ( track -> db_s_write_bo ) ) ; return - EINVAL ; } if ( G_028040_TILE_SURFACE_ENABLE ( track -> db_z_info ) ) { r = evergreen_cs_track_validate_htile ( p , surf . nbx , surf . nby ) ; if ( r ) { return r ; } } return 0 ; } 