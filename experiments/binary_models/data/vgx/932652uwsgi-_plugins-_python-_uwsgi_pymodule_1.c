PyObject * py_uwsgi_queue_pop ( PyObject * self , PyObject * args ) { char * message ; uint64_t size ; PyObject * res ; char * storage ; if ( uwsgi . queue_size ) { UWSGI_RELEASE_GIL uwsgi_wlock ( uwsgi . queue_lock ) ; message = uwsgi_queue_pop ( & size ) ; if ( ! message || size == 0 ) { uwsgi_rwunlock ( uwsgi . queue_lock ) ; UWSGI_GET_GIL Py_INCREF ( Py_None ) ; return Py_None ; } storage = uwsgi_malloc ( size ) ; memcpy ( storage , message , size ) ; uwsgi_rwunlock ( uwsgi . queue_lock ) ; UWSGI_GET_GIL res = PyString_FromStringAndSize ( storage , size ) ; return res ; } Py_INCREF ( Py_None ) ; return Py_None ; } 