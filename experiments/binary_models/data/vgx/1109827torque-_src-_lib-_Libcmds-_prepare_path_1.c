int prepare_path ( char * path_in , char * path_out , char * host ) { int i ; char * c ; char host_name [ PBS_MAXSERVERNAME + 1 ] ; int h_pos ; char path_name [ MAXPATHLEN + 1 ] ; int p_pos ; char cwd [ MAXPATHLEN + 1 ] ; char * host_given ; struct stat statbuf ; dev_t dev ; ino_t ino ; if ( path_out != NULL ) { path_out [ 0 ] = '\0' ; } if ( ( path_in == NULL ) || ( path_out == NULL ) ) { return ( 1 ) ; } for ( i = 0 ; i <= PBS_MAXSERVERNAME ; i ++ ) { host_name [ i ] = '\0' ; } h_pos = 0 ; for ( i = 0 ; i <= MAXPATHLEN ; i ++ ) { path_name [ i ] = '\0' ; } p_pos = 0 ; cwd [ MAXPATHLEN ] = '\0' ; c = path_in ; while ( ( int ) isspace ( * c ) ) { c ++ ; } if ( ( host_given = strchr ( path_in , ':' ) ) != NULL ) { while ( ( * c != ':' ) && ( * c != '\0' ) ) { if ( isalnum ( * c ) || ( * c == '.' ) || ( * c == '-' ) || ( * c == '_' ) ) { host_name [ h_pos ++ ] = * c ; } else { break ; } c ++ ; } } if ( ( * c == ':' ) || ( c == path_in ) ) { if ( * c == ':' ) { c ++ ; } while ( * c != '\0' ) { if ( ( ! isgraph ( * c ) ) && ( * c != ' ' ) ) { break ; } path_name [ p_pos ++ ] = * c ; c ++ ; } } if ( * c != '\0' ) { return ( 1 ) ; } if ( strlen ( path_name ) == 0 ) { if ( host_given != NULL ) { strcpy ( path_out , host_name ) ; strcat ( path_out , ":" ) ; } return ( 3 ) ; } if ( host_name [ 0 ] == '\0' ) { if ( host != NULL ) { snprintf ( host_name , sizeof ( host_name ) , "%s" , host ) ; } if ( gethostname ( host_name , PBS_MAXSERVERNAME ) != 0 ) { return ( 2 ) ; } } strcpy ( path_out , host_name ) ; strcat ( path_out , ":" ) ; if ( ( path_name [ 0 ] != '/' ) && ( strncmp ( path_name , "$HOME" , strlen ( "$HOME" ) ) != 0 ) && ( strncmp ( path_name , "${HOME}" , strlen ( "${HOME}" ) ) != 0 ) && ( host_given == NULL ) ) { c = getenv ( "PWD" ) ; if ( c != NULL ) { if ( stat ( c , & statbuf ) < 0 ) { c = NULL ; } else { dev = statbuf . st_dev ; ino = statbuf . st_ino ; if ( stat ( "." , & statbuf ) < 0 ) { perror ( "prepare_path: cannot stat current directory:" ) ; return ( 1 ) ; } } if ( c != NULL ) { if ( ( ! memcmp ( & dev , & statbuf . st_dev , sizeof ( dev_t ) ) ) && ( ! memcmp ( & ino , & statbuf . st_ino , sizeof ( ino_t ) ) ) ) { if ( c != NULL ) { snprintf ( cwd , MAXPATHLEN , "%s" , c ) ; } } else { c = NULL ; } } } if ( c == NULL ) { c = getcwd ( cwd , MAXPATHLEN ) ; if ( c == NULL ) { perror ( "prepare_path: getcwd failed: " ) ; return ( 1 ) ; } } strcat ( path_out , cwd ) ; strcat ( path_out , "/" ) ; } if ( ( host_given == NULL ) && ( path_name [ strlen ( path_name ) - 1 ] != '/' ) ) { if ( ( stat ( path_name , & statbuf ) == 0 ) && ( S_ISDIR ( statbuf . st_mode ) ) ) { strcat ( path_name , "/" ) ; } } if ( strncmp ( path_name , "$HOME" , strlen ( "$HOME" ) ) == 0 ) { size_t path_out_length ; size_t home_val_length ; char * HomeVal = getenv ( "HOME" ) ; char * NamePtr = path_name + strlen ( "$HOME" ) ; if ( ( HomeVal == NULL ) || ( NamePtr == NULL ) ) { return ( 1 ) ; } path_out_length = strlen ( HomeVal ) ; home_val_length = strlen ( NamePtr ) ; } } 