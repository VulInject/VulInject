int fwrandom ( char * buf , size_t buflen ) { EFI_STATUS status ; EFI_RNG_PROTOCOL * rng = NULL ; UINT8 * random ; int i ; int ret = 0 ; status = EFI_CALL ( BS -> LocateProtocol , & rng_guid , NULL , ( void * * ) & rng ) ; if ( rng == NULL || EFI_ERROR ( status ) ) { return - 1 ; } random = alloc ( buflen ) ; status = EFI_CALL ( rng -> GetRNG , rng , NULL , buflen , random ) ; if ( EFI_ERROR ( status ) ) { printf ( "RNG GetRNG() failed (%d)\n" , status ) ; ret = - 1 ; out } for ( i = 0 ; i < buflen ; i ++ ) { buf [ i ] ^= random [ i ] ; } out free ( random , buflen ) ; return ret ; } 