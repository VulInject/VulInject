int pdr_restart_pd ( struct pdr_handle * pdr , struct pdr_service * pds ) { struct servreg_restart_pd_resp resp ; struct servreg_restart_pd_req req = { 0 } ; struct sockaddr_qrtr addr ; struct pdr_service * tmp ; struct qmi_txn txn ; int ret ; if ( IS_ERR_OR_NULL ( pdr ) || IS_ERR_OR_NULL ( pds ) ) { return - EINVAL ; } mutex_lock ( & pdr -> list_lock ) ; list_for_each_entry ( , , ) { if ( tmp != pds ) { continue ; } if ( ! pds -> service_connected ) { break ; } strscpy ( req . service_path , pds -> service_path , sizeof ( req . service_path ) ) ; addr = pds -> addr ; break ; } mutex_unlock ( & pdr -> list_lock ) ; ret = qmi_txn_init ( & pdr -> notifier_hdl , & txn , servreg_restart_pd_resp_ei , & resp ) ; if ( ret < 0 ) { return ret ; } ret = qmi_send_request ( & pdr -> notifier_hdl , & addr , & txn , SERVREG_RESTART_PD_REQ , SERVREG_RESTART_PD_REQ_MAX_LEN , servreg_restart_pd_req_ei , & req ) ; if ( ret < 0 ) { qmi_txn_cancel ( & txn ) ; return ret ; } ret = qmi_txn_wait ( & txn , 5 * HZ ) ; if ( ret < 0 ) { pr_err ( "PDR: %s PD restart txn wait failed: %d\n" , req . service_path , ret ) ; return ret ; } if ( resp . resp . result == QMI_RESULT_FAILURE_V01 && resp . resp . error == QMI_ERR_DISABLED_V01 ) { pr_err ( "PDR: %s PD restart is disabled: 0x%x\n" , req . service_path , resp . resp . error ) ; return - EOPNOTSUPP ; } if ( resp . resp . result != QMI_RESULT_SUCCESS_V01 ) { pr_err ( "PDR: %s request for PD restart failed: 0x%x\n" , req . service_path , resp . resp . error ) ; return - EREMOTEIO ; } return 0 ; } 