static int setup_xattrs ( struct archive_read_disk * a , struct archive_entry * entry , int * fd ) { char * list , * p ; const char * path ; ssize_t list_size ; path = NULL ; if ( * fd < 0 ) { path = archive_read_disk_entry_setup_path ( a , entry , fd ) ; if ( path == NULL ) { return ( ARCHIVE_WARN ) ; } } if ( * fd >= 0 ) { list_size = flistxattr ( * fd , NULL , 0 ) ; list_size = flistxattr ( * fd , NULL , 0 , 0 ) ; list_size = flistea ( * fd , NULL , 0 ) ; } if ( ! a -> follow_symlinks ) { list_size = llistxattr ( path , NULL , 0 ) ; list_size = listxattr ( path , NULL , 0 , XATTR_NOFOLLOW ) ; list_size = llistea ( path , NULL , 0 ) ; } else { list_size = listxattr ( path , NULL , 0 ) ; list_size = listxattr ( path , NULL , 0 , 0 ) ; list_size = listea ( path , NULL , 0 ) ; } if ( list_size == - 1 ) { if ( errno == ENOTSUP || errno == ENOSYS ) { return ( ARCHIVE_OK ) ; } archive_set_error ( & a -> archive , errno , "Couldn't list extended attributes" ) ; return ( ARCHIVE_WARN ) ; } if ( list_size == 0 ) { return ( ARCHIVE_OK ) ; } if ( ( list = malloc ( list_size ) ) == NULL ) { archive_set_error ( & a -> archive , errno , "Out of memory" ) ; return ( ARCHIVE_FATAL ) ; } if ( * fd >= 0 ) { list_size = flistxattr ( * fd , list , list_size ) ; list_size = flistxattr ( * fd , list , list_size , 0 ) ; list_size = flistea ( * fd , list , list_size ) ; } if ( ! a -> follow_symlinks ) { list_size = llistxattr ( path , list , list_size ) ; list_size = listxattr ( path , list , list_size , XATTR_NOFOLLOW ) ; list_size = llistea ( path , list , list_size ) ; } else { list_size = listxattr ( path , list , list_size ) ; list_size = listxattr ( path , list , list_size , 0 ) ; list_size = listea ( path , list , list_size ) ; } if ( list_size == - 1 ) { archive_set_error ( & a -> archive , errno , "Couldn't retrieve extended attributes" ) ; return ( ARCHIVE_WARN ) ; } for ( p = list ; ( p - list ) < list_size ; p += strlen ( p ) + 1 ) { if ( strncmp ( p , "system." , 7 ) == 0 && ( strcmp ( p + 7 , "posix_acl_access" ) == 0 || strcmp ( p + 7 , "posix_acl_default" ) == 0 ) ) { continue ; } if ( strncmp ( p , "trusted.SGI_" , 12 ) == 0 && ( strcmp ( p + 12 , "ACL_DEFAULT" ) == 0 || strcmp ( p + 12 , "ACL_FILE" ) == 0 ) ) { continue ; } if ( strncmp ( p , "xfsroot." , 8 ) == 0 ) { continue ; } setup_xattr ( a , entry , p , * fd , path ) ; } free ( list ) ; return ( ARCHIVE_OK ) ; } 