static inline int nsock_vprintf ( int sd , const char * fmt , va_list ap , int plus ) { va_list ap_dup ; char stack_buf [ 4096 ] ; int len ; va_copy ( ap_dup , ap ) ; len = vsnprintf ( stack_buf , sizeof ( stack_buf ) , fmt , ap_dup ) ; va_end ( ap_dup ) ; if ( len < 0 ) { return len ; } if ( len < sizeof ( stack_buf ) ) { stack_buf [ len ] = 0 ; if ( plus ) { ++ len ; } return write ( sd , stack_buf , len ) ; } else { char * heap_buf ; len = vasprintf ( & heap_buf , fmt , ap ) ; if ( len < 0 ) { return len ; } if ( plus ) { ++ len ; } len = write ( sd , heap_buf , len ) ; free ( heap_buf ) ; return len ; } } 