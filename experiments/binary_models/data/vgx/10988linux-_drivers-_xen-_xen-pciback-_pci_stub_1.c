static int __init pcistub_init_devices_late ( void ) { struct pcistub_device * psdev ; unsigned long flags ; int err = 0 ; spin_lock_irqsave ( & pcistub_devices_lock , flags ) ; while ( ! list_empty ( & seized_devices ) ) { psdev = container_of ( seized_devices . next , pcistub_device , dev_list ) ; list_del ( & psdev -> dev_list ) ; spin_unlock_irqrestore ( & pcistub_devices_lock , flags ) ; err = pcistub_init_device ( psdev -> dev ) ; if ( err ) { dev_err ( & psdev -> dev -> dev , "error %d initializing device\n" , err ) ; psdev = NULL ; } spin_lock_irqsave ( & pcistub_devices_lock , flags ) ; if ( psdev ) { list_add_tail ( & psdev -> dev_list , & pcistub_devices ) ; } } initialize_devices = 1 ; spin_unlock_irqrestore ( & pcistub_devices_lock , flags ) ; return 0 ; } 