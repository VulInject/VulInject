int lpfc_nvme_create_localport ( struct lpfc_vport * vport ) { int ret = 0 ; struct lpfc_hba * phba = vport -> phba ; struct nvme_fc_port_info nfcp_info ; struct nvme_fc_local_port * localport ; struct lpfc_nvme_lport * lport ; int len ; nfcp_info . port_role = FC_PORT_ROLE_NVME_INITIATOR ; nfcp_info . node_name = wwn_to_u64 ( vport -> fc_nodename . u . wwn ) ; nfcp_info . port_name = wwn_to_u64 ( vport -> fc_portname . u . wwn ) ; if ( phba -> cfg_sg_seg_cnt > LPFC_MAX_NVME_SEG_CNT ) { lpfc_printf_vlog ( vport , KERN_INFO , LOG_NVME | LOG_INIT , "6300 Reducing sg segment cnt to %d\n" , LPFC_MAX_NVME_SEG_CNT ) ; phba -> cfg_nvme_seg_cnt = LPFC_MAX_NVME_SEG_CNT ; } else { phba -> cfg_nvme_seg_cnt = phba -> cfg_sg_seg_cnt ; } lpfc_nvme_template . max_sgl_segments = phba -> cfg_nvme_seg_cnt + 1 ; lpfc_nvme_template . max_hw_queues = phba -> cfg_nvme_io_channel ; ret = nvme_fc_register_localport ( & nfcp_info , & lpfc_nvme_template , & vport -> phba -> pcidev -> dev , & localport ) ; ret = - ENOMEM ; if ( ! ret ) { lpfc_printf_vlog ( vport , KERN_INFO , LOG_NVME | LOG_NVME_DISC , "6005 Successfully registered local " "NVME port num %d, localP %p, private %p, " "sg_seg %d\n" , localport -> port_num , localport , localport -> private , lpfc_nvme_template . max_sgl_segments ) ; lport = ( lpfc_nvme_lport * ) localport -> private ; vport -> localport = localport ; lport -> vport = vport ; INIT_LIST_HEAD ( & lport -> rport_list ) ; vport -> nvmei_support = 1 ; len = lpfc_new_nvme_buf ( vport , phba -> sli4_hba . nvme_xri_max ) ; vport -> phba -> total_nvme_bufs += len ; } return ret ; } 