static void * clipboard_synthesize_utf8_string ( wClipboard * clipboard , UINT32 formatId , const void * data , UINT32 * pSize ) { size_t size ; char * pDstData = NULL ; if ( formatId == CF_UNICODETEXT ) { pDstData = ConvertWCharNToUtf8Alloc ( data , * pSize / sizeof ( WCHAR ) , & size ) ; if ( ! pDstData ) { return NULL ; } size = ConvertLineEndingToLF ( pDstData , size ) ; * pSize = ( UINT32 ) size ; return pDstData ; } if ( ( formatId == CF_TEXT ) || ( formatId == CF_OEMTEXT ) || ( formatId == ClipboardGetFormatId ( clipboard , mime_text_plain ) ) ) { int rc ; size = * pSize ; pDstData = ( char * ) malloc ( size ) ; if ( ! pDstData ) { return NULL ; } CopyMemory ( pDstData , data , size ) ; rc = ConvertLineEndingToLF ( pDstData , size ) ; if ( rc < 0 ) { return NULL ; } * pSize = ( UINT32 ) rc ; return pDstData ; } return NULL ; } 