static int a2mp_chan_recv_cb ( struct l2cap_chan * chan , struct sk_buff * skb ) { struct a2mp_cmd * hdr ; struct amp_mgr * mgr = chan -> data ; int err = 0 ; amp_mgr_get ( mgr , NULL ) ; while ( skb -> len >= sizeof ( * hdr ) ) { u16 len ; hdr = ( void * ) skb -> data ; len = le16_to_cpu ( hdr -> len ) ; BT_DBG ( "code 0x%2.2x id %d len %u" , hdr -> code , hdr -> ident , len ) ; skb_pull ( skb , sizeof ( * hdr ) ) ; if ( len > skb -> len || ! hdr -> ident ) { err = - EINVAL ; break ; } mgr -> ident = hdr -> ident ; switch ( hdr -> code ) { case A2MP_COMMAND_REJ : a2mp_command_rej ( mgr , skb , hdr ) ; break ; case A2MP_DISCOVER_REQ : err = a2mp_discover_req ( mgr , skb , hdr ) ; break ; case A2MP_CHANGE_NOTIFY : err = a2mp_change_notify ( mgr , skb , hdr ) ; break ; case A2MP_GETINFO_REQ : err = a2mp_getinfo_req ( mgr , skb , hdr ) ; break ; case A2MP_GETAMPASSOC_REQ : err = a2mp_getampassoc_req ( mgr , skb , hdr ) ; break ; case A2MP_CREATEPHYSLINK_REQ : err = a2mp_createphyslink_req ( mgr , skb , hdr ) ; break ; case A2MP_DISCONNPHYSLINK_REQ : err = a2mp_discphyslink_req ( mgr , skb , hdr ) ; break ; case A2MP_DISCOVER_RSP : err = a2mp_discover_rsp ( mgr , skb , hdr ) ; break ; case A2MP_GETINFO_RSP : err = a2mp_getinfo_rsp ( mgr , skb , hdr ) ; break ; case A2MP_GETAMPASSOC_RSP : err = a2mp_getampassoc_rsp ( mgr , skb , hdr ) ; break ; case A2MP_CHANGE_RSP : case A2MP_CREATEPHYSLINK_RSP : case A2MP_DISCONNPHYSLINK_RSP : err = a2mp_cmd_rsp ( mgr , skb , hdr ) ; break ; default : BT_ERR ( "Unknown A2MP sig cmd 0x%2.2x" , hdr -> code ) ; err = - EINVAL ; break ; } } if ( err ) { struct a2mp_cmd_rej rej ; rej . reason = cpu_to_le16 ( 0 ) ; hdr = ( void * ) skb -> data ; BT_DBG ( "Send A2MP Rej: cmd 0x%2.2x err %d" , hdr -> code , err ) ; a2mp_send ( mgr , A2MP_COMMAND_REJ , hdr -> ident , sizeof ( rej ) , & rej ) ; } kfree_skb ( skb ) ; amp_mgr_put ( mgr ) ; return 0 ; } 