bool wsm_flush_tx ( struct cw1200_common * priv ) { unsigned long timestamp = jiffies ; bool pending = false ; long timeout ; int i ; BUG_ON ( ! atomic_read ( & priv -> tx_lock ) ) ; if ( ! priv -> hw_bufs_used ) { return true ; } if ( priv -> bh_error ) { pr_err ( "[WSM] Fatal error occurred, will not flush TX.\n" ) ; return false ; } else { for ( i = 0 ; i < 4 ; ++ i ) { pending |= cw1200_queue_get_xmit_timestamp ( & priv -> tx_queue [ i ] , & timestamp , 0xffffffff ) ; } timeout = timestamp + WSM_CMD_LAST_CHANCE_TIMEOUT - jiffies ; if ( timeout < 0 || wait_event_timeout ( priv -> bh_evt_wq , ! priv -> hw_bufs_used , timeout ) <= 0 ) { priv -> bh_error = 1 ; wiphy_err ( priv -> hw -> wiphy , "[WSM] TX Frames (%d) stuck in firmware, killing BH\n" , priv -> hw_bufs_used ) ; wake_up ( & priv -> bh_wq ) ; return false ; } return true ; } } 