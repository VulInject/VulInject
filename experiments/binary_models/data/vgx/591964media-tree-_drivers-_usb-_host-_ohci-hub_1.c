int ohci_hub_control ( struct usb_hcd * hcd , u16 typeReq , u16 wValue , u16 wIndex , char * buf , u16 wLength ) { struct ohci_hcd * ohci = hcd_to_ohci ( hcd ) ; int ports = ohci -> num_ports ; u32 temp ; int retval = 0 ; switch ( typeReq ) { case ClearHubFeature : switch ( wValue ) { case C_HUB_OVER_CURRENT : ohci_writel ( ohci , RH_HS_OCIC , & ohci -> regs -> roothub . status ) ; case C_HUB_LOCAL_POWER : break ; default : error } break ; case ClearPortFeature : if ( ! wIndex || wIndex > ports ) { error } wIndex -- ; switch ( wValue ) { case USB_PORT_FEAT_ENABLE : temp = RH_PS_CCS ; break ; case USB_PORT_FEAT_C_ENABLE : temp = RH_PS_PESC ; break ; case USB_PORT_FEAT_SUSPEND : temp = RH_PS_POCI ; break ; case USB_PORT_FEAT_C_SUSPEND : temp = RH_PS_PSSC ; break ; case USB_PORT_FEAT_POWER : temp = RH_PS_LSDA ; break ; case USB_PORT_FEAT_C_CONNECTION : temp = RH_PS_CSC ; break ; case USB_PORT_FEAT_C_OVER_CURRENT : temp = RH_PS_OCIC ; break ; case USB_PORT_FEAT_C_RESET : temp = RH_PS_PRSC ; break ; default : error } ohci_writel ( ohci , temp , & ohci -> regs -> roothub . portstatus [ wIndex ] ) ; break ; case GetHubDescriptor : ohci_hub_descriptor ( ohci , ( usb_hub_descriptor * ) buf ) ; break ; case GetHubStatus : temp = roothub_status ( ohci ) & ~ ( RH_HS_CRWE | RH_HS_DRWE ) ; put_unaligned_le32 ( temp , buf ) ; break ; case GetPortStatus : if ( ! wIndex || wIndex > ports ) { error } wIndex -- ; temp = roothub_portstatus ( ohci , wIndex ) ; put_unaligned_le32 ( temp , buf ) ; if ( * ( u16 * ) ( buf + 2 ) ) { dbg_port ( ohci , "GetStatus" , wIndex , temp ) ; } break ; case SetHubFeature : switch ( wValue ) { case C_HUB_OVER_CURRENT : case C_HUB_LOCAL_POWER : break ; default : error } break ; case SetPortFeature : if ( ! wIndex || wIndex > ports ) { error } wIndex -- ; switch ( wValue ) { case USB_PORT_FEAT_SUSPEND : if ( hcd -> self . otg_port == ( wIndex + 1 ) && hcd -> self . b_hnp_enable ) { ohci -> start_hnp ( ohci ) ; } else { ohci_writel ( ohci , RH_PS_PSS , & ohci -> regs -> roothub . portstatus [ wIndex ] ) ; } break ; case USB_PORT_FEAT_POWER : ohci_writel ( ohci , RH_PS_PPS , & ohci -> regs -> roothub . portstatus [ wIndex ] ) ; break ; case USB_PORT_FEAT_RESET : retval = root_port_reset ( ohci , wIndex ) ; break ; default : error } break ; default : error retval = - EPIPE ; } return retval ; } 