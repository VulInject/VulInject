static int rockchip_rk3399_efuse_read ( void * context , unsigned int offset , void * val , size_t bytes ) { struct rockchip_efuse_chip * efuse = context ; unsigned int addr_start , addr_end , addr_offset , addr_len ; u32 out_value ; u8 * buf ; int ret , i = 0 ; ret = clk_prepare_enable ( efuse -> clk ) ; if ( ret < 0 ) { dev_err ( efuse -> dev , "failed to prepare/enable efuse clk\n" ) ; return ret ; } addr_start = rounddown ( offset , RK3399_NBYTES ) / RK3399_NBYTES ; addr_end = roundup ( offset + bytes , RK3399_NBYTES ) / RK3399_NBYTES ; addr_offset = offset % RK3399_NBYTES ; addr_len = addr_end - addr_start ; buf = kzalloc ( array3_size ( addr_len , RK3399_NBYTES , sizeof ( * buf ) ) , GFP_KERNEL ) ; if ( ! buf ) { clk_disable_unprepare ( efuse -> clk ) ; return - ENOMEM ; } writel ( RK3399_LOAD | RK3399_PGENB | RK3399_STROBSFTSEL | RK3399_RSB , efuse -> base + REG_EFUSE_CTRL ) ; udelay ( 1 ) ; while ( addr_len -- ) { writel ( readl ( efuse -> base + REG_EFUSE_CTRL ) | RK3399_STROBE | ( ( addr_start ++ & RK3399_A_MASK ) << RK3399_A_SHIFT ) , efuse -> base + REG_EFUSE_CTRL ) ; udelay ( 1 ) ; out_value = readl ( efuse -> base + REG_EFUSE_DOUT ) ; writel ( readl ( efuse -> base + REG_EFUSE_CTRL ) & ( ~ RK3399_STROBE ) , efuse -> base + REG_EFUSE_CTRL ) ; udelay ( 1 ) ; memcpy ( & buf [ i ] , & out_value , RK3399_NBYTES ) ; i += RK3399_NBYTES ; } writel ( RK3399_PD | RK3399_CSB , efuse -> base + REG_EFUSE_CTRL ) ; memcpy ( val , buf + addr_offset , bytes ) ; clk_disable_unprepare ( efuse -> clk ) ; return 0 ; } 