static int __xipram cfi_probe_chip ( struct map_info * map , __u32 base , unsigned long * chip_map , struct cfi_private * cfi ) { int i ; if ( ( base + 0 ) >= map -> size ) { printk ( KERN_NOTICE "Probe at base[0x00](0x%08lx) past the end of the map(0x%08lx)\n" , ( unsigned long ) base , map -> size - 1 ) ; return 0 ; } if ( ( base + 0xff ) >= map -> size ) { printk ( KERN_NOTICE "Probe at base[0x55](0x%08lx) past the end of the map(0x%08lx)\n" , ( unsigned long ) base + 0x55 , map -> size - 1 ) ; return 0 ; } xip_disable ( ) ; if ( ! cfi_qry_mode_on ( base , map , cfi ) ) { xip_enable ( base , map , cfi ) ; return 0 ; } for ( i = 0 ; i < ( base >> cfi -> chipshift ) ; i ++ ) { unsigned long start ; if ( ! test_bit ( i , chip_map ) ) { continue ; } start = i << cfi -> chipshift ; if ( cfi_qry_present ( map , start , cfi ) ) { cfi_qry_mode_off ( start , map , cfi ) ; if ( ! cfi_qry_present ( map , start , cfi ) ) { xip_allowed ( base , map ) ; printk ( KERN_DEBUG "%s: Found an alias at 0x%x for the chip at 0x%lx\n" , map -> name , base , start ) ; return 0 ; } cfi_qry_mode_off ( base , map , cfi ) ; if ( cfi_qry_present ( map , base , cfi ) ) { xip_allowed ( base , map ) ; printk ( KERN_DEBUG "%s: Found an alias at 0x%x for the chip at 0x%lx\n" , map -> name , base , start ) ; return 0 ; } } } set_bit ( ( base >> cfi -> chipshift ) , chip_map ) ; cfi -> numchips ++ ; cfi_qry_mode_off ( base , map , cfi ) ; xip_allowed ( base , map ) ; printk ( KERN_INFO "%s: Found %d x%d devices at 0x%x in %d-bit bank\n" , map -> name , cfi -> interleave , cfi -> device_type * 8 , base , map -> bankwidth * 8 ) ; return 1 ; } 