static struct mt76_txwi * mt7601u_push_txwi ( struct mt7601u_dev * dev , struct sk_buff * skb , struct ieee80211_sta * sta , struct mt76_wcid * wcid , int pkt_len ) { struct ieee80211_tx_info * info = IEEE80211_SKB_CB ( skb ) ; struct ieee80211_tx_rate * rate = & info -> control . rates [ 0 ] ; struct mt76_txwi * txwi ; unsigned long flags ; bool is_probe ; u32 pkt_id ; u16 rate_ctl ; u8 nss ; txwi = skb_push ( skb , sizeof ( mt76_txwi ) ) ; if ( ! wcid -> tx_rate_set ) { ieee80211_get_tx_rates ( info -> control . vif , sta , skb , info -> control . rates , 1 ) ; } spin_lock_irqsave ( & dev -> lock , flags ) ; if ( rate -> idx < 0 || ! rate -> count ) { rate_ctl = wcid -> tx_rate ; } else { rate_ctl = mt76_mac_tx_rate_val ( dev , rate , & nss ) ; } spin_unlock_irqrestore ( & dev -> lock , flags ) ; txwi -> rate_ctl = cpu_to_le16 ( rate_ctl ) ; if ( ! ( info -> flags & IEEE80211_TX_CTL_NO_ACK ) ) { txwi -> ack_ctl |= MT_TXWI_ACK_CTL_REQ ; } if ( info -> flags & IEEE80211_TX_CTL_ASSIGN_SEQ ) { txwi -> ack_ctl |= MT_TXWI_ACK_CTL_NSEQ ; } if ( ( info -> flags & IEEE80211_TX_CTL_AMPDU ) && sta ) { u8 ba_size = IEEE80211_MIN_AMPDU_BUF ; ba_size <<= sta -> deflink . ht_cap . ampdu_factor ; ba_size = min_t ( int , 63 , ba_size ) ; if ( info -> flags & IEEE80211_TX_CTL_RATE_CTRL_PROBE ) { ba_size = 0 ; } txwi -> ack_ctl |= FIELD_PREP ( MT_TXWI_ACK_CTL_BA_WINDOW , ba_size ) ; txwi -> flags = cpu_to_le16 ( MT_TXWI_FLAGS_AMPDU | FIELD_PREP ( MT_TXWI_FLAGS_MPDU_DENSITY , sta -> deflink . ht_cap . ampdu_density ) ) ; if ( info -> flags & IEEE80211_TX_CTL_RATE_CTRL_PROBE ) { txwi -> flags = 0 ; } } txwi -> wcid = wcid -> idx ; is_probe = ! ! ( info -> flags & IEEE80211_TX_CTL_RATE_CTRL_PROBE ) ; pkt_id = mt7601u_tx_pktid_enc ( dev , rate_ctl & 0x7 , is_probe ) ; pkt_len |= FIELD_PREP ( MT_TXWI_LEN_PKTID , pkt_id ) ; txwi -> len_ctl = cpu_to_le16 ( pkt_len ) ; return txwi ; } 