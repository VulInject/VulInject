static int check_limitations ( struct slot * slot_cur ) { u8 i ; struct slot * tmp_slot ; u8 count = 0 ; u8 limitation = 0 ; for ( i = slot_cur -> bus_on -> slot_min ; i <= slot_cur -> bus_on -> slot_max ; i ++ ) { tmp_slot = ibmphp_get_slot_from_physical_num ( i ) ; if ( ( SLOT_PWRGD ( tmp_slot -> status ) ) && ! ( SLOT_CONNECT ( tmp_slot -> status ) ) ) { count ++ ; } } get_cur_bus_info ( & slot_cur ) ; switch ( slot_cur -> bus_on -> current_speed ) { case BUS_SPEED_33 : limitation = slot_cur -> bus_on -> slots_at_33_conv ; break ; case BUS_SPEED_66 : if ( slot_cur -> bus_on -> current_bus_mode == BUS_MODE_PCIX ) { limitation = slot_cur -> bus_on -> slots_at_66_pcix ; } else { limitation = slot_cur -> bus_on -> slots_at_66_conv ; } break ; case BUS_SPEED_100 : limitation = slot_cur -> bus_on -> slots_at_100_pcix ; break ; case BUS_SPEED_133 : limitation = slot_cur -> bus_on -> slots_at_133_pcix ; break ; } if ( ( count + 1 ) > limitation ) { return - EINVAL ; } return 0 ; } 