int hns_roce_buf_write_mtt ( struct hns_roce_dev * hr_dev , struct hns_roce_mtt * mtt , struct hns_roce_buf * buf ) { u32 i = 0 ; int ret = 0 ; u64 * page_list ; page_list = kmalloc_array ( buf -> npages , sizeof ( * page_list ) , GFP_KERNEL ) ; if ( ! page_list ) { return - ENOMEM ; } for ( i = 0 ; i < buf -> npages ; ++ i ) { if ( buf -> nbufs == 1 ) { page_list [ i ] = buf -> direct . map + ( i << buf -> page_shift ) ; } else { page_list [ i ] = buf -> page_list [ i ] . map ; } } ret = hns_roce_write_mtt ( hr_dev , mtt , 0 , buf -> npages , page_list ) ; kfree ( page_list ) ; return ret ; } 