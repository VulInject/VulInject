static struct memlist * dr_get_memlist ( dr_mem_unit_t * mp ) { struct memlist * mlist = NULL ; sbd_error_t * err ; static fn_t f = "dr_get_memlist" ; PR_MEM ( "%s for %s...\n" , f , mp -> sbm_cm . sbdev_path ) ; if ( mp -> sbm_mlist ) { PR_MEM ( "%s: found cached memlist\n" , f ) ; mlist = memlist_dup ( mp -> sbm_mlist ) ; } else { uint64_t basepa = _ptob64 ( mp -> sbm_basepfn ) ; basepa &= ~ ( mp -> sbm_slice_size - 1 ) ; memlist_read_lock ( ) ; mlist = memlist_dup ( phys_install ) ; memlist_read_unlock ( ) ; if ( mlist ) { mlist = memlist_del_span ( mlist , 0ull , basepa ) ; } if ( mlist ) { int endpa ; basepa += mp -> sbm_slice_size ; endpa = _ptob64 ( physmax + 1 ) ; if ( endpa > basepa ) { mlist = memlist_del_span ( mlist , basepa , endpa - basepa ) ; } } if ( mlist ) { PR_MEM ( "%s: derived memlist from phys_install\n" , f ) ; } if ( ! mlist ) { err = drmach_mem_get_memlist ( mp -> sbm_cm . sbdev_id , & mlist ) ; if ( err ) { DRERR_SET_C ( & mp -> sbm_cm . sbdev_error , & err ) ; mlist = NULL ; } } } PR_MEM ( "%s: memlist for %s\n" , f , mp -> sbm_cm . sbdev_path ) ; PR_MEMLIST_DUMP ( mlist ) ; return ( mlist ) ; } 