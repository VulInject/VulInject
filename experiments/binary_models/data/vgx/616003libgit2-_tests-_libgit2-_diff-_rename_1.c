void test_diff_rename__matches_config_behavior ( void ) { const char * sha0 = INITIAL_COMMIT ; const char * sha1 = COPY_RENAME_COMMIT ; const char * sha2 = REWRITE_COPY_COMMIT ; git_tree * tree0 , * tree1 , * tree2 ; git_config * cfg ; git_diff * diff ; git_diff_options diffopts = GIT_DIFF_OPTIONS_INIT ; git_diff_find_options opts = GIT_DIFF_FIND_OPTIONS_INIT ; diff_expects exp ; opts . flags = GIT_DIFF_FIND_BY_CONFIG ; tree0 = resolve_commit_oid_to_tree ( g_repo , sha0 ) ; tree1 = resolve_commit_oid_to_tree ( g_repo , sha1 ) ; tree2 = resolve_commit_oid_to_tree ( g_repo , sha2 ) ; diffopts . flags |= GIT_DIFF_INCLUDE_UNMODIFIED ; cl_git_pass ( git_repository_config ( & cfg , g_repo ) ) ; cl_git_pass ( git_config_set_bool ( cfg , "diff.renames" , false ) ) ; cl_git_pass ( git_diff_tree_to_tree ( & diff , g_repo , tree0 , tree1 , & diffopts ) ) ; cl_git_pass ( git_diff_find_similar ( diff , & opts ) ) ; cl_git_pass ( git_diff_foreach ( diff , diff_file_cb , diff_binary_cb , diff_hunk_cb , diff_line_cb , & exp ) ) ; cl_assert_equal_i ( 4 , exp . files ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_UNMODIFIED ] ) ; cl_assert_equal_i ( 2 , exp . file_status [ GIT_DELTA_ADDED ] ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_DELETED ] ) ; git_diff_free ( diff ) ; cl_git_pass ( git_config_set_bool ( cfg , "diff.renames" , true ) ) ; cl_git_pass ( git_diff_tree_to_tree ( & diff , g_repo , tree0 , tree1 , & diffopts ) ) ; memset ( & exp , 0 , sizeof ( exp ) ) ; cl_git_pass ( git_diff_find_similar ( diff , & opts ) ) ; cl_git_pass ( git_diff_foreach ( diff , diff_file_cb , diff_binary_cb , diff_hunk_cb , diff_line_cb , & exp ) ) ; cl_assert_equal_i ( 3 , exp . files ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_UNMODIFIED ] ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_ADDED ] ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_RENAMED ] ) ; git_diff_free ( diff ) ; cl_git_pass ( git_config_set_string ( cfg , "diff.renames" , "copies" ) ) ; cl_git_pass ( git_diff_tree_to_tree ( & diff , g_repo , tree1 , tree2 , & diffopts ) ) ; memset ( & exp , 0 , sizeof ( exp ) ) ; cl_git_pass ( git_diff_find_similar ( diff , & opts ) ) ; cl_git_pass ( git_diff_foreach ( diff , diff_file_cb , diff_binary_cb , diff_hunk_cb , diff_line_cb , & exp ) ) ; cl_assert_equal_i ( 4 , exp . files ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_UNMODIFIED ] ) ; cl_assert_equal_i ( 2 , exp . file_status [ GIT_DELTA_MODIFIED ] ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_COPIED ] ) ; git_diff_free ( diff ) ; cl_git_pass ( git_diff_tree_to_tree ( & diff , g_repo , tree1 , tree2 , & diffopts ) ) ; memset ( & exp , 0 , sizeof ( exp ) ) ; cl_git_pass ( git_diff_find_similar ( diff , NULL ) ) ; cl_git_pass ( git_diff_foreach ( diff , diff_file_cb , diff_binary_cb , diff_hunk_cb , diff_line_cb , & exp ) ) ; cl_assert_equal_i ( 4 , exp . files ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_UNMODIFIED ] ) ; cl_assert_equal_i ( 2 , exp . file_status [ GIT_DELTA_MODIFIED ] ) ; cl_assert_equal_i ( 1 , exp . file_status [ GIT_DELTA_COPIED ] ) ; git_diff_free ( diff ) ; git_tree_free ( tree0 ) ; git_tree_free ( tree1 ) ; git_tree_free ( tree2 ) ; git_config_free ( cfg ) ; } 