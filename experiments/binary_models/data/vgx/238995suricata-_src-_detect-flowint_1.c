static int DetectFlowintTestPacket02Real ( void ) { Packet * p = NULL ; ThreadVars th_v ; DetectEngineThreadCtx * det_ctx = NULL ; DetectEngineCtx * de_ctx = DetectEngineCtxInit ( ) ; FAIL_IF ( de_ctx == NULL ) ; de_ctx -> flags |= DE_QUIET ; const char * sigs [ 5 ] ; sigs [ 0 ] = "alert tcp any any ->any any (msg:\"Setting a flowint counter\"; content:\"GET\"; flowint: myvar, notset; flowint:maxvar,notset; flowint: myvar,=,1; flowint: maxvar,=,6; sid:101;)" ; sigs [ 1 ] = "alert tcp any any ->any any (msg:\"Adding to flowint counter\"; content:\"Unauthorized\"; flowint:myvar,isset; flowint: myvar,+,2; sid:102;)" ; sigs [ 2 ] = "alert tcp any any ->any any (msg:\"if the flowint counter is 3 create a new counter\"; content:\"Unauthorized\"; flowint: myvar, isset; flowint: myvar,==,3; flowint:cntpackets,notset; flowint: cntpackets, =, 0; sid:103;)" ; sigs [ 3 ] = "alert tcp any any ->any any (msg:\"and count the rest of the packets received without generating alerts!!!\"; flowint: cntpackets,isset; flowint: cntpackets, +, 1; noalert;sid:104;)" ; sigs [ 4 ] = "alert tcp any any ->any any (msg:\" and fire this when it reach 6\"; flowint: cntpackets, isset; flowint: maxvar,isset; flowint: cntpackets, ==, maxvar; sid:105;)" ; FAIL_IF ( UTHAppendSigs ( de_ctx , sigs , 5 ) == 0 ) ; SCSigRegisterSignatureOrderingFuncs ( de_ctx ) ; SCSigOrderSignatures ( de_ctx ) ; SCSigSignatureOrderingModuleCleanup ( de_ctx ) ; SigGroupBuild ( de_ctx ) ; DetectEngineThreadCtxInit ( & th_v , ( void * ) de_ctx , ( void * ) & det_ctx ) ; Flow * f = UTHBuildFlow ( AF_INET , "192.168.1.5" , "192.168.1.1" , 41424 , 80 ) ; FAIL_IF ( f == NULL ) ; f -> proto = IPPROTO_TCP ; p = UTHBuildPacket ( ( uint8_t * ) "GET" , 3 , IPPROTO_TCP ) ; FAIL_IF ( p == NULL ) ; UTHAssignFlow ( p , f ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; FAIL_IF ( ! PacketAlertCheck ( p , 101 ) ) ; UTHFreePacket ( p ) ; p = UTHBuildPacket ( ( uint8_t * ) "Unauthorized" , 12 , IPPROTO_TCP ) ; FAIL_IF ( p == NULL ) ; UTHAssignFlow ( p , f ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; FAIL_IF ( ! PacketAlertCheck ( p , 102 ) ) ; FAIL_IF ( ! PacketAlertCheck ( p , 103 ) ) ; UTHFreePacket ( p ) ; p = UTHBuildPacket ( ( uint8_t * ) "1" , 1 , IPPROTO_TCP ) ; FAIL_IF ( p == NULL ) ; UTHAssignFlow ( p , f ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; UTHFreePacket ( p ) ; p = UTHBuildPacket ( ( uint8_t * ) "X" , 1 , IPPROTO_TCP ) ; FAIL_IF ( p == NULL ) ; UTHAssignFlow ( p , f ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; FAIL_IF ( ! PacketAlertCheck ( p , 105 ) ) ; UTHFreePacket ( p ) ; UTHFreeFlow ( f ) ; DetectEngineThreadCtxDeinit ( & th_v , ( void * ) det_ctx ) ; DetectEngineCtxFree ( de_ctx ) ; PASS ; } 