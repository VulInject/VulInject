static int createVport ( virStoragePoolDef * def , const char * configFile , virStorageAdapterFCHost * fchost ) { virStoragePoolFCRefreshInfo * cbdata = NULL ; virThread thread ; g_autofree char * name = NULL ; VIR_DEBUG ( "configFile='%s' parent='%s', wwnn='%s' wwpn='%s'" , NULLSTR ( configFile ) , NULLSTR ( fchost -> parent ) , fchost -> wwnn , fchost -> wwpn ) ; if ( ( name = virVHBAGetHostByWWN ( NULL , fchost -> wwnn , fchost -> wwpn ) ) ) { if ( ! fchost -> parent || checkParent ( name , fchost -> parent ) ) { return 0 ; } return - 1 ; } if ( fchost -> managed != VIR_TRISTATE_BOOL_YES ) { fchost -> managed = VIR_TRISTATE_BOOL_YES ; if ( configFile ) { if ( virStoragePoolSaveConfig ( configFile , def ) < 0 ) { return - 1 ; } } } if ( ! ( name = virNodeDeviceCreateVport ( fchost ) ) ) { return - 1 ; } cbdata = g_new0 ( virStoragePoolFCRefreshInfo , 1 ) ; memcpy ( cbdata -> pool_uuid , def -> uuid , VIR_UUID_BUFLEN ) ; cbdata -> fchost_name = g_steal_pointer ( & name ) ; if ( virThreadCreateFull ( & thread , false , virStoragePoolFCRefreshThread , "scsi-refresh" , false , cbdata ) < 0 ) { VIR_DEBUG ( "Failed to create FC Pool Refresh Thread" ) ; virStoragePoolFCRefreshDataFree ( cbdata ) ; } return 0 ; } 