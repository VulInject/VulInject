bool PortalRun ( Portal portal , long count , bool isTopLevel , bool run_once , DestReceiver * dest , DestReceiver * altdest , QueryCompletion * qc ) { bool result ; uint64 nprocessed ; ResourceOwner saveTopTransactionResourceOwner ; MemoryContext saveTopTransactionContext ; Portal saveActivePortal ; ResourceOwner saveResourceOwner ; MemoryContext savePortalContext ; MemoryContext saveMemoryContext ; Assert ( PortalIsValid ( portal ) ) ; TRACE_POSTGRESQL_QUERY_EXECUTE_START ( ) ; if ( qc ) { InitializeQueryCompletion ( qc ) ; } if ( log_executor_stats && portal -> strategy != PORTAL_MULTI_QUERY ) { elog ( DEBUG3 , "PortalRun" ) ; ResetUsage ( ) ; } MarkPortalActive ( portal , NULL ) ; Assert ( ! portal -> run_once || run_once ) ; portal -> run_once = run_once ; saveTopTransactionResourceOwner = TopTransactionResourceOwner ; saveTopTransactionContext = TopTransactionContext ; saveActivePortal = ActivePortal ; saveResourceOwner = CurrentResourceOwner ; savePortalContext = PortalContext ; saveMemoryContext = CurrentMemoryContext ; PG_TRY ( ) ; { ActivePortal = portal ; if ( portal -> resowner ) { CurrentResourceOwner = portal -> resowner ; } PortalContext = portal -> portalContext ; MemoryContextSwitchTo ( PortalContext ) ; switch ( portal -> strategy ) { case PORTAL_ONE_SELECT : case PORTAL_ONE_RETURNING : case PORTAL_ONE_MOD_WITH : case PORTAL_UTIL_SELECT : if ( portal -> strategy != PORTAL_ONE_SELECT && ! portal -> holdStore ) { FillPortalStore ( portal , isTopLevel ) ; } nprocessed = PortalRunSelect ( portal , true , count , dest ) ; if ( qc && portal -> qc . commandTag != CMDTAG_UNKNOWN ) { CopyQueryCompletion ( qc , & portal -> qc ) ; qc -> nprocessed = nprocessed ; } portal -> status = PORTAL_READY ; result = portal -> atEnd ; break ; case PORTAL_MULTI_QUERY : PortalRunMulti ( portal , isTopLevel , false , dest , altdest , qc ) ; MarkPortalDone ( portal ) ; result = true ; break ; default : elog ( ERROR , "unrecognized portal strategy: %d" , ( int ) portal -> strategy ) ; result = false ; break ; } } PG_CATCH ( ) ; { MarkPortalFailed ( portal ) ; if ( saveMemoryContext == saveTopTransactionContext ) { MemoryContextSwitchTo ( TopTransactionContext ) ; } else { MemoryContextSwitchTo ( saveMemoryContext ) ; } ActivePortal = saveActivePortal ; if ( saveResourceOwner == saveTopTransactionResourceOwner ) { CurrentResourceOwner = TopTransactionResourceOwner ; } else { CurrentResourceOwner = saveResourceOwner ; } PortalContext = savePortalContext ; PG_RE_THROW ( ) ; } PG_END_TRY ( ) ; if ( saveMemoryContext == saveTopTransactionContext ) { MemoryContextSwitchTo ( TopTransactionContext ) ; } else { MemoryContextSwitchTo ( saveMemoryContext ) ; } ActivePortal = saveActivePortal ; if ( saveResourceOwner == saveTopTransactionResourceOwner ) { CurrentResourceOwner = TopTransactionResourceOwner ; } else { CurrentResourceOwner = saveResourceOwner ; } PortalContext = savePortalContext ; if ( log_executor_stats && portal -> strategy != PORTAL_MULTI_QUERY ) { ShowUsage ( "EXECUTOR STATISTICS" ) ; } TRACE_POSTGRESQL_QUERY_EXECUTE_DONE ( ) ; return result ; } 