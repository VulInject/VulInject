static int asus_battery_probe ( struct hid_device * hdev ) { struct asus_drvdata * drvdata = hid_get_drvdata ( hdev ) ; struct power_supply_config pscfg = { . drv_data = drvdata } ; int ret = 0 ; drvdata -> battery_capacity = 0 ; drvdata -> battery_stat = POWER_SUPPLY_STATUS_UNKNOWN ; drvdata -> battery_in_query = false ; drvdata -> battery_desc . properties = asus_battery_props ; drvdata -> battery_desc . num_properties = ARRAY_SIZE ( asus_battery_props ) ; drvdata -> battery_desc . get_property = asus_battery_get_property ; drvdata -> battery_desc . type = POWER_SUPPLY_TYPE_BATTERY ; drvdata -> battery_desc . use_for_apm = 0 ; drvdata -> battery_desc . name = devm_kasprintf ( & hdev -> dev , GFP_KERNEL , "asus-keyboard-%s-battery" , strlen ( hdev -> uniq ) ?hdev -> uniq : dev_name ( & hdev -> dev ) ) ; if ( ! drvdata -> battery_desc . name ) { return - ENOMEM ; } drvdata -> battery_next_query = jiffies ; drvdata -> battery = devm_power_supply_register ( & hdev -> dev , & ( drvdata -> battery_desc ) , & pscfg ) ; if ( IS_ERR ( drvdata -> battery ) ) { ret = PTR_ERR ( drvdata -> battery ) ; hid_err ( hdev , "Unable to register battery device\n" ) ; return ret ; } power_supply_powers ( drvdata -> battery , & hdev -> dev ) ; return ret ; } 