static struct dns_msg * neg_nsec3_proof_ds ( struct val_neg_zone * zone , uint8_t * qname , size_t qname_len , int qlabs , sldns_buffer * buf , struct rrset_cache * rrset_cache , struct regional * region , time_t now , uint8_t * topname ) { struct dns_msg * msg ; struct val_neg_data * data ; uint8_t hashnc [ NSEC3_SHA_LEN ] ; size_t nclen ; struct ub_packed_rrset_key * ce_rrset , * nc_rrset ; struct nsec3_cached_hash c ; uint8_t nc_b32 [ 257 ] ; if ( ! zone -> nsec3_hash ) { return NULL ; } if ( ! ( data = neg_find_nsec3_ce ( zone , qname , qname_len , qlabs , buf , hashnc , & nclen ) ) ) { return NULL ; } ce_rrset = grab_nsec ( rrset_cache , data -> name , data -> len , LDNS_RR_TYPE_NSEC3 , zone -> dclass , 0 , region , 1 , LDNS_RR_TYPE_DS , now ) ; if ( ! ce_rrset ) { return NULL ; } if ( ! neg_params_ok ( zone , ce_rrset ) ) { return NULL ; } if ( nclen == 0 ) { if ( nsec3_has_type ( ce_rrset , 0 , LDNS_RR_TYPE_SOA ) || nsec3_has_type ( ce_rrset , 0 , LDNS_RR_TYPE_DS ) || ! nsec3_has_type ( ce_rrset , 0 , LDNS_RR_TYPE_NS ) ) { return NULL ; } if ( ! ( msg = dns_msg_create ( qname , qname_len , LDNS_RR_TYPE_DS , zone -> dclass , region , 1 ) ) ) { return NULL ; } if ( ! dns_msg_authadd ( msg , region , ce_rrset , 0 ) ) { return NULL ; } return msg ; } if ( ! topname ) { return in ; } nc_rrset = neg_nsec3_getnc ( zone , hashnc , nclen , rrset_cache , region , now , nc_b32 , sizeof ( nc_b32 ) ) ; if ( ! nc_rrset ) { return NULL ; } if ( ! neg_params_ok ( zone , nc_rrset ) ) { return NULL ; } if ( ! nsec3_has_optout ( nc_rrset , 0 ) ) { return NULL ; } c . hash = hashnc ; c . hash_len = nclen ; c . b32 = nc_b32 + 1 ; c . b32_len = ( size_t ) nc_b32 [ 0 ] ; if ( nsec3_covers ( zone -> name , & c , nc_rrset , 0 , buf ) ) { if ( ! ( msg = dns_msg_create ( qname , qname_len , LDNS_RR_TYPE_DS , zone -> dclass , region , 3 ) ) ) { return NULL ; } if ( ! dns_msg_authadd ( msg , region , ce_rrset , 0 ) ) { return NULL ; } if ( ! dns_msg_authadd ( msg , region , nc_rrset , 0 ) ) { return NULL ; } return msg ; } return NULL ; } 