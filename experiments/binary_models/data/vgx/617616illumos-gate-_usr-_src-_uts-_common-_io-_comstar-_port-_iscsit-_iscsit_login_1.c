static idm_status_t login_sm_req_pdu_check ( iscsit_conn_t * ict , idm_pdu_t * pdu ) { int csg_req ; iscsit_conn_login_t * lsm = & ict -> ict_login_sm ; iscsi_login_hdr_t * lh = ( iscsi_login_hdr_t * ) pdu -> isp_hdr ; iscsi_login_rsp_hdr_t * lh_resp = lsm -> icl_login_resp_tmpl ; csg_req = ISCSI_LOGIN_CURRENT_STAGE ( lh -> flags ) ; switch ( csg_req ) { case ISCSI_SECURITY_NEGOTIATION_STAGE : case ISCSI_OP_PARMS_NEGOTIATION_STAGE : if ( ( csg_req != lsm -> icl_login_csg ) && ( lsm -> icl_login_state != ILS_LOGIN_INIT ) ) { pdu_check_fail } break ; case ISCSI_FULL_FEATURE_PHASE : default : pdu_check_fail } if ( ict -> ict_sess != NULL ) { if ( ( ict -> ict_cid != ntohs ( lh -> cid ) ) || ( bcmp ( ict -> ict_sess -> ist_isid , lh -> isid , ISCSI_ISID_LEN ) != 0 ) ) { pdu_check_fail } } if ( ( lh -> min_version > ISCSIT_MAX_VERSION ) || ( lh -> max_version < ISCSIT_MIN_VERSION ) ) { pdu_check_fail } if ( ( lh_resp -> opcode == ISCSI_OP_LOGIN_RSP ) && ( ( lh -> min_version > lh_resp -> active_version ) || ( lh -> max_version < lh_resp -> active_version ) ) ) { pdu_check_fail } return ( IDM_STATUS_SUCCESS ) ; pdu_check_fail return ( IDM_STATUS_FAIL ) ; } 