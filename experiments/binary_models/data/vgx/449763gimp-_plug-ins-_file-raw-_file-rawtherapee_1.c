load_thumbnail_image ( , , ) { GimpImage * image = NULL ; GFile * file_out = gimp_temp_file ( "jpg" ) ; GFile * thumb_pp3_file = gimp_temp_file ( "pp3" ) ; FILE * thumb_pp3_f = g_fopen ( g_file_peek_path ( thumb_pp3_file ) , "w" ) ; gchar * rawtherapee_stdout = NULL ; const char * pp3_content = "[Version]\n" "AppVersion=5.0\n" "Version=326\n" "\n" "[Resize]\n" "Enabled=true\n" "AppliesTo=Cropped area\n" "Method=Lanczos\n" "Width=%d\n" "Height=%d\n" "\n" "[Sharpening]\n" "Enabled=false\n" "\n" "[SharpenEdge]\n" "Enabled=false\n" "\n" "[SharpenMicro]\n" "Enabled=false\n" "\n" "[Defringing]\n" "Enabled=false\n" "\n" "[Directional Pyramid Equalizer]\n" "Enabled=false\n" "\n" "[PostResizeSharpening]\n" "Enabled=false\n" "\n" "[Directional Pyramid Denoising]\n" "Enabled=false\n" "\n" "[Impulse Denoising]\n" "Enabled=false\n" "\n" "[Wavelet]\n" "Enabled=false\n" "\n" "[RAW Bayer]\n" "Method=fast\n" "\n" "[RAW X-Trans]\n" "Method=fast\n" ; gboolean search_path = FALSE ; gchar * exec_path = file_raw_get_executable_path ( "rawtherapee" , "-cli" , "RAWTHERAPEE_EXECUTABLE" , "com.rawtherapee.rawtherapee" , REGISTRY_KEY_BASE , & search_path ) ; gchar * argv [ ] { exec_path "-o" ( gchar * ) g_file_peek_path ( file_out ) "-d" "-s" "-j" "-p" ( gchar * ) g_file_peek_path ( thumb_pp3_file ) "-f" "-c" ( gchar * ) g_file_peek_path ( file ) NULL } ; ; if ( thumb_pp3_f ) { if ( fprintf ( thumb_pp3_f , pp3_content , thumb_size , thumb_size ) < 0 ) { fclose ( thumb_pp3_f , NULL ) ; thumb_pp3_f = NULL ; } } gimp_progress_init_printf ( _ ( "Opening thumbnail for '%s'" ) , gimp_file_get_utf8_name ( file ) ) ; if ( thumb_pp3_f && g_spawn_sync ( NULL , argv , NULL , G_SPAWN_STDERR_TO_DEV_NULL | ( search_path ?G_SPAWN_SEARCH_PATH : 0 ) , NULL , NULL , & rawtherapee_stdout , NULL , NULL , error ) ) { gimp_progress_update ( 0.5 ) ; image = gimp_file_load ( GIMP_RUN_NONINTERACTIVE , file_out ) ; } gimp_progress_update ( 1.0 ) ; if ( thumb_pp3_f ) { fclose ( thumb_pp3_f ) ; } g_file_delete ( thumb_pp3_file , NULL , NULL ) ; g_free ( rawtherapee_stdout ) ; g_free ( exec_path ) ; return image ; } 