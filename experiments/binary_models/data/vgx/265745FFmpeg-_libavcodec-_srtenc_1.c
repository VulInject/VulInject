static int encode_frame ( AVCodecContext * avctx , unsigned char * buf , int bufsize , const AVSubtitle * sub , const ASSCodesCallbacks * cb ) { SRTContext * s = avctx -> priv_data ; ASSDialog * dialog ; int i ; av_bprint_clear ( & s -> buffer ) ; for ( i = 0 ; i < sub -> num_rects ; i ++ ) { const char * ass = sub -> rects [ i ] -> ass ; if ( sub -> rects [ i ] -> type != SUBTITLE_ASS ) { av_log ( avctx , AV_LOG_ERROR , "Only SUBTITLE_ASS type supported.\n" ) ; return AVERROR ( EINVAL ) ; } dialog = ff_ass_split_dialog ( s -> ass_ctx , ass ) ; if ( ! dialog ) { return AVERROR ( ENOMEM ) ; } if ( avctx -> codec_id == AV_CODEC_ID_SUBRIP ) { srt_style_apply ( s , dialog -> style ) ; } ff_ass_split_override_codes ( cb , s , dialog -> text ) ; ff_ass_free_dialog ( & dialog ) ; } if ( ! av_bprint_is_complete ( & s -> buffer ) ) { return AVERROR ( ENOMEM ) ; } if ( ! s -> buffer . len ) { return 0 ; } if ( s -> buffer . len > bufsize ) { av_log ( avctx , AV_LOG_ERROR , "Buffer too small for ASS event.\n" ) ; return AVERROR_BUFFER_TOO_SMALL ; } memcpy ( buf , s -> buffer . str , s -> buffer . len ) ; return s -> buffer . len ; } 