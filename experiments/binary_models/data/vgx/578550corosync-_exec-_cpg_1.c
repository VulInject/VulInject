static void downlist_inform_clients ( void ) { struct qb_list_head * iter , * tmp_iter ; struct process_info * left_pi ; qb_map_t * group_map ; struct cpg_name cpg_group ; mar_cpg_name_t group ; confchg_data { struct cpg_name cpg_group ; mar_cpg_address_t left_list [ CPG_MEMBERS_MAX ] ; int left_list_entries ; struct qb_list_head list ; } , * pcd qb_map_iter_t * miter ; int i , size ; downlist_log ( "my downlist" , & g_req_exec_cpg_downlist ) ; group_map = qb_skiplist_create ( ) ; qb_list_for_each_safe ( , , ) { struct process_info * pi = qb_list_entry ( iter , process_info , list ) ; left_pi = NULL ; for ( i = 0 ; i < g_req_exec_cpg_downlist . left_nodes ; i ++ ) { if ( pi -> nodeid == g_req_exec_cpg_downlist . nodeids [ i ] ) { left_pi = pi ; break ; } } if ( left_pi ) { marshall_from_mar_cpg_name_t ( & cpg_group , & left_pi -> group ) ; cpg_group . value [ cpg_group . length ] = 0 ; pcd = ( confchg_data * ) qb_map_get ( group_map , cpg_group . value ) ; if ( pcd == NULL ) { pcd = ( confchg_data * ) calloc ( 1 , sizeof ( confchg_data ) ) ; memcpy ( & pcd -> cpg_group , & cpg_group , sizeof ( cpg_name ) ) ; qb_map_put ( group_map , pcd -> cpg_group . value , pcd ) ; } size = pcd -> left_list_entries ; pcd -> left_list [ size ] . nodeid = left_pi -> nodeid ; pcd -> left_list [ size ] . pid = left_pi -> pid ; pcd -> left_list [ size ] . reason = CONFCHG_CPG_REASON_NODEDOWN ; pcd -> left_list_entries ++ ; qb_list_del ( & left_pi -> list ) ; } } miter = qb_map_iter_create ( group_map ) ; while ( qb_map_iter_next ( miter , ( void * * ) & pcd ) ) { marshall_to_mar_cpg_name_t ( & group , & pcd -> cpg_group ) ; log_printf ( LOG_DEBUG , "left_list_entries:%d" , pcd -> left_list_entries ) ; for ( i = 0 ; i < pcd -> left_list_entries ; i ++ ) { log_printf ( LOG_DEBUG , "left_list[%d] group:%s, ip:%s, pid:%d" , i , cpg_print_group_name ( & group ) , ( char * ) api -> totem_ifaces_print ( pcd -> left_list [ i ] . nodeid ) , pcd -> left_list [ i ] . pid ) ; } notify_lib_joinlist ( & group , 0 , NULL , pcd -> left_list_entries , pcd -> left_list , MESSAGE_RES_CPG_CONFCHG_CALLBACK ) ; free ( pcd ) ; } qb_map_iter_free ( miter ) ; qb_map_destroy ( group_map ) ; } 