static int isert_connect_request ( struct rdma_cm_id * cma_id , struct rdma_cm_event * event ) { struct isert_np * isert_np = cma_id -> context ; struct iscsi_np * np = isert_np -> np ; struct isert_conn * isert_conn ; struct isert_device * device ; int ret = 0 ; spin_lock_bh ( & np -> np_thread_lock ) ; if ( ! np -> enabled ) { spin_unlock_bh ( & np -> np_thread_lock ) ; isert_dbg ( "iscsi_np is not enabled, reject connect request\n" ) ; return rdma_reject ( cma_id , NULL , 0 ) ; } spin_unlock_bh ( & np -> np_thread_lock ) ; isert_dbg ( "cma_id: %p, portal: %p\n" , cma_id , cma_id -> context ) ; isert_conn = kzalloc ( sizeof ( isert_conn ) , GFP_KERNEL ) ; isert_init_conn ( isert_conn ) ; isert_conn -> cm_id = cma_id ; ret = isert_alloc_login_buf ( isert_conn , cma_id -> device ) ; if ( ret ) { out } device = isert_device_get ( cma_id ) ; if ( IS_ERR ( device ) ) { ret = PTR_ERR ( device ) ; out_rsp_dma_map } isert_conn -> device = device ; isert_set_nego_params ( isert_conn , & event -> param . conn ) ; ret = isert_conn_setup_qp ( isert_conn , cma_id ) ; if ( ret ) { out_conn_dev } ret = isert_login_post_recv ( isert_conn ) ; if ( ret ) { out_conn_dev } ret = isert_rdma_accept ( isert_conn ) ; if ( ret ) { out_conn_dev } mutex_lock ( & isert_np -> mutex ) ; list_add_tail ( & isert_conn -> node , & isert_np -> accepted ) ; mutex_unlock ( & isert_np -> mutex ) ; return 0 ; out_conn_dev isert_device_put ( device ) ; out_rsp_dma_map isert_free_login_buf ( isert_conn ) ; out kfree ( isert_conn ) ; rdma_reject ( cma_id , NULL , 0 ) ; return ret ; } 