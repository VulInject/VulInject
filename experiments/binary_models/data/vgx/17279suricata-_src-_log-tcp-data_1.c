OutputInitResult LogTcpDataLogInitCtx ( ConfNode * conf ) { OutputInitResult result = { NULL false } ; char filename [ PATH_MAX ] "" ; ; char dirname [ 32 ] "" ; ; strlcpy ( filename , DEFAULT_LOG_FILENAME , sizeof ( filename ) ) ; LogFileCtx * file_ctx = LogFileNewCtx ( ) ; if ( file_ctx == NULL ) { SCLogError ( "couldn't create new file_ctx" ) ; return result ; } LogTcpDataFileCtx * tcpdatalog_ctx = SCMalloc ( sizeof ( LogTcpDataFileCtx ) ) ; if ( unlikely ( tcpdatalog_ctx == NULL ) ) { LogFileFreeCtx ( file_ctx ) ; return result ; } tcpdatalog_ctx -> file_ctx = file_ctx ; if ( conf ) { if ( conf -> name ) { if ( strcmp ( conf -> name , "tcp-data" ) == 0 ) { tcpdatalog_ctx -> type = STREAMING_TCP_DATA ; snprintf ( filename , sizeof ( filename ) , "%s.log" , conf -> name ) ; strlcpy ( dirname , "tcp" , sizeof ( dirname ) ) ; } if ( strcmp ( conf -> name , "http-body-data" ) == 0 ) { tcpdatalog_ctx -> type = STREAMING_HTTP_BODIES ; snprintf ( filename , sizeof ( filename ) , "%s.log" , conf -> name ) ; strlcpy ( dirname , "http" , sizeof ( dirname ) ) ; } } const char * logtype = ConfNodeLookupChildValue ( conf , "type" ) ; if ( logtype == NULL ) { logtype = "file" ; } if ( strcmp ( logtype , "file" ) == 0 ) { tcpdatalog_ctx -> file = 1 ; } if ( strcmp ( logtype , "dir" ) == 0 ) { tcpdatalog_ctx -> dir = 1 ; } if ( strcmp ( logtype , "both" ) == 0 ) { tcpdatalog_ctx -> file = 1 ; tcpdatalog_ctx -> dir = 1 ; } } else { tcpdatalog_ctx -> file = 1 ; tcpdatalog_ctx -> dir = 0 ; } if ( tcpdatalog_ctx -> file == 1 ) { SCLogInfo ( "opening logfile" ) ; if ( SCConfLogOpenGeneric ( conf , file_ctx , filename , 1 ) < 0 ) { LogFileFreeCtx ( file_ctx ) ; SCFree ( tcpdatalog_ctx ) ; return result ; } } if ( tcpdatalog_ctx -> dir == 1 ) { tcpdatalog_ctx -> log_dir = ConfigGetLogDirectory ( ) ; char dirfull [ PATH_MAX ] ; snprintf ( dirfull , PATH_MAX , "%s/%s" , tcpdatalog_ctx -> log_dir , dirname ) ; SCLogInfo ( "using directory %s" , dirfull ) ; ( void ) SCMkDir ( dirfull , 0700 ) ; } OutputCtx * output_ctx = SCCalloc ( 1 , sizeof ( OutputCtx ) ) ; if ( unlikely ( output_ctx == NULL ) ) { parsererror } output_ctx -> data = tcpdatalog_ctx ; output_ctx -> DeInit = LogTcpDataLogDeInitCtx ; SCLogDebug ( "Streaming log output initialized" ) ; result . ctx = output_ctx ; result . ok = true ; return result ; parsererror LogFileFreeCtx ( file_ctx ) ; SCFree ( tcpdatalog_ctx ) ; SCLogError ( "Syntax error in custom http log format string." ) ; return result ; } 