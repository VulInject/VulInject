struct bpf_insn * icode_to_fcode ( struct icode * ic , struct block * root , u_int * lenp , char * errbuf ) { u_int n ; struct bpf_insn * fp ; conv_state_t conv_state ; conv_state . fstart = NULL ; conv_state . errbuf = errbuf ; if ( setjmp ( conv_state . top_ctx ) != 0 ) { return NULL ; } for ( ; ; ) { unMarkAll ( ic ) ; n = * lenp = count_stmts ( ic , root ) ; fp = ( bpf_insn * ) malloc ( sizeof ( * fp ) * n ) ; if ( fp == NULL ) { ( void ) snprintf ( errbuf , PCAP_ERRBUF_SIZE , "malloc" ) ; free ( fp ) ; return NULL ; } memset ( ( char * ) fp , 0 , sizeof ( * fp ) * n ) ; conv_state . fstart = fp ; conv_state . ftail = fp + n ; unMarkAll ( ic ) ; if ( convert_code_r ( & conv_state , ic , root ) ) { break ; } free ( fp ) ; } return fp ; } 