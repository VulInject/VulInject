static int usb_write ( struct i2c_adapter * adapter , int cmd , int value , int index , void * data , int len ) static int usb_xfer ( struct i2c_adapter * adapter , struct i2c_msg * msgs , int num ) { unsigned char * pstatus ; struct i2c_msg * pmsg ; int i , ret ; dev_dbg ( & adapter -> dev , "master xfer %d messages:\n" , num ) ; pstatus = kmalloc ( sizeof ( * pstatus ) , GFP_KERNEL ) ; if ( ! pstatus ) { return - ENOMEM ; } for ( i = 0 ; i < num ; i ++ ) { int cmd = CMD_I2C_IO ; if ( i == 0 ) { cmd |= CMD_I2C_IO_BEGIN ; } if ( i == num - 1 ) { cmd |= CMD_I2C_IO_END ; } pmsg = & msgs [ i ] ; dev_dbg ( & adapter -> dev , "  %d: %s (flags %d) %d bytes to 0x%02x\n" , i , pmsg -> flags & I2C_M_RD ?"read" : "write" , pmsg -> flags , pmsg -> len , pmsg -> addr ) ; if ( pmsg -> flags & I2C_M_RD ) { if ( usb_read ( adapter , cmd , pmsg -> flags , pmsg -> addr , pmsg -> buf , pmsg -> len ) != pmsg -> len ) { dev_err ( & adapter -> dev , "failure reading data\n" ) ; ret = - EIO ; out } } else { if ( usb_write ( adapter , cmd , pmsg -> flags , pmsg -> addr , pmsg -> buf , pmsg -> len ) != pmsg -> len ) { dev_err ( & adapter -> dev , "failure writing data\n" ) ; ret = - EIO ; out } } if ( usb_read ( adapter , CMD_GET_STATUS , 0 , 0 , pstatus , 1 ) != 1 ) { dev_err ( & adapter -> dev , "failure reading status\n" ) ; ret = - EIO ; out } dev_dbg ( & adapter -> dev , "  status = %d\n" , * pstatus ) ; if ( * pstatus == STATUS_ADDRESS_NAK ) { ret = - ENXIO ; out } } ret = i ; out return ret ; } 