int mutt_sasl_client_new ( struct Connection * conn , sasl_conn_t * * saslconn ) { sasl_security_properties_t secprops ; struct sockaddr_storage local , remote ; socklen_t size ; char iplocalport [ IP_PORT_BUFLEN ] , ipremoteport [ IP_PORT_BUFLEN ] ; char * plp = NULL ; char * prp = NULL ; int rc ; if ( mutt_sasl_start ( ) != SASL_OK ) { return - 1 ; } if ( ! conn -> account . service ) { mutt_error ( _ ( "Unknown SASL profile" ) ) ; return - 1 ; } size = sizeof ( local ) ; if ( getsockname ( conn -> fd , ( sockaddr * ) & local , & size ) == 0 ) { if ( iptostring ( ( sockaddr * ) & local , size , iplocalport , IP_PORT_BUFLEN ) == SASL_OK ) { plp = iplocalport ; } else { mutt_debug ( LL_DEBUG2 , "SASL failed to parse local IP address\n" ) ; } } else { mutt_debug ( LL_DEBUG2 , "SASL failed to get local IP address\n" ) ; } size = sizeof ( remote ) ; if ( getpeername ( conn -> fd , ( sockaddr * ) & remote , & size ) == 0 ) { if ( iptostring ( ( sockaddr * ) & remote , size , ipremoteport , IP_PORT_BUFLEN ) == SASL_OK ) { prp = ipremoteport ; } else { mutt_debug ( LL_DEBUG2 , "SASL failed to parse remote IP address\n" ) ; } } else { mutt_debug ( LL_DEBUG2 , "SASL failed to get remote IP address\n" ) ; } mutt_debug ( LL_DEBUG2 , "SASL local ip: %s, remote ip:%s\n" , NONULL ( plp ) , NONULL ( prp ) ) ; rc = sasl_client_new ( conn -> account . service , conn -> account . host , plp , prp , mutt_sasl_get_callbacks ( & conn -> account ) , 0 , saslconn ) ; if ( rc != SASL_OK ) { mutt_error ( _ ( "Error allocating SASL connection" ) ) ; return - 1 ; } secprops . max_ssf = 0x7fff ; secprops . maxbufsize = MUTT_SASL_MAXBUF ; if ( sasl_setprop ( * saslconn , SASL_SEC_PROPS , & secprops ) != SASL_OK ) { mutt_error ( _ ( "Error setting SASL security properties" ) ) ; sasl_dispose ( saslconn ) ; return - 1 ; } if ( conn -> ssf != 0 ) { mutt_debug ( LL_DEBUG2 , "External SSF: %d\n" , conn -> ssf ) ; if ( sasl_setprop ( * saslconn , SASL_SSF_EXTERNAL , & conn -> ssf ) != SASL_OK ) { mutt_error ( _ ( "Error setting SASL external security strength" ) ) ; sasl_dispose ( saslconn ) ; return - 1 ; } } if ( conn -> account . user [ 0 ] ) { mutt_debug ( LL_DEBUG2 , "External authentication name: %s\n" , conn -> account . user ) ; if ( sasl_setprop ( * saslconn , SASL_AUTH_EXTERNAL , conn -> account . user ) != SASL_OK ) { mutt_error ( _ ( "Error setting SASL external user name" ) ) ; sasl_dispose ( saslconn ) ; return - 1 ; } } return 0 ; } 