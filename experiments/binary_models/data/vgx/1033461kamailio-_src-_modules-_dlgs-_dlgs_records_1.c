dlgs_ht_t * dlgs_ht_init ( void ) { int i ; dlgs_ht_t * dsht = NULL ; dsht = ( dlgs_ht_t * ) shm_malloc ( sizeof ( dlgs_ht_t ) ) ; if ( dsht == NULL ) { SHM_MEM_ERROR ; return NULL ; } dsht -> htsize = _dlgs_htsize ; dsht -> alifetime = _dlgs_active_lifetime ; dsht -> ilifetime = _dlgs_init_lifetime ; dsht -> flifetime = _dlgs_finish_lifetime ; dsht -> slots = ( dlgs_slot_t * ) shm_malloc ( dsht -> htsize * sizeof ( dlgs_slot_t ) ) ; if ( dsht -> slots == NULL ) { SHM_MEM_ERROR ; shm_free ( dsht ) ; dsht = NULL ; return NULL ; } memset ( dsht -> slots , 0 , dsht -> htsize * sizeof ( dlgs_slot_t ) ) ; for ( i = 0 ; i < dsht -> htsize ; i ++ ) { if ( lock_init ( & dsht -> slots [ i ] . lock ) == 0 ) { LM_ERR ( "cannot initialize lock[%d]\n" , i ) ; i -- ; while ( i >= 0 ) { lock_destroy ( & dsht -> slots [ i ] . lock ) ; i -- ; } shm_free ( dsht -> slots ) ; shm_free ( dsht ) ; dsht = NULL ; return NULL ; } } return dsht ; } 