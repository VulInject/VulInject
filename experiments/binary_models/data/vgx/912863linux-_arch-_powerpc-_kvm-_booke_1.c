int kvmppc_core_prepare_to_enter ( struct kvm_vcpu * vcpu ) { int r = 0 ; WARN_ON_ONCE ( ! irqs_disabled ( ) ) ; kvmppc_core_check_exceptions ( vcpu ) ; if ( vcpu -> arch . shared -> msr & MSR_WE ) { local_irq_enable ( ) ; kvm_vcpu_halt ( vcpu ) ; hard_irq_disable ( ) ; kvmppc_set_exit_type ( vcpu , EMULATED_MTMSRWE_EXITS ) ; r = 1 ; } return r ; } 