static int ldma_chan_cctrl_cfg ( struct ldma_chan * c , u32 val ) { struct ldma_dev * d = to_ldma_dev ( c -> vchan . chan . device ) ; u32 class_low , class_high ; cfs_time_t flags ; u32 reg ; spin_lock_irqsave ( & d -> dev_lock , flags ) ; ldma_update_bits ( d , DMA_CS_MASK , c -> nr , DMA_CS ) ; reg = readl ( d -> base + DMA_CCTRL ) ; if ( reg & DMA_CCTRL_DIR_TX ) { c -> flags |= DMA_TX_CH ; } else { c -> flags |= DMA_RX_CH ; } class_low = FIELD_GET ( DMA_CCTRL_CLASS , reg ) ; class_high = FIELD_GET ( DMA_CCTRL_CLASSH , reg ) ; val &= ~ DMA_CCTRL_CLASS ; val |= FIELD_PREP ( DMA_CCTRL_CLASS , class_low ) ; val &= ~ DMA_CCTRL_CLASSH ; val |= FIELD_PREP ( DMA_CCTRL_CLASSH , class_high ) ; writel ( val , d -> base + DMA_CCTRL ) ; spin_unlock_irqrestore ( & d -> dev_lock , flags ) ; return 0 ; } 