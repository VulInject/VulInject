int ssl_handshake ( struct fdinfo * sinfo ) { int ret = 0 ; int sslerr = 0 ; if ( sinfo == NULL ) { if ( o . debug ) { logdebug ( "ncat_ssl.c: Invoking ssl_handshake() with a NULL parameter " "is a serious bug. Please fix it.\n" ) ; } return - 1 ; } if ( ! sinfo -> ssl ) { sinfo -> ssl = new_ssl ( sinfo -> fd ) ; } ret = SSL_accept ( sinfo -> ssl ) ; if ( ret == 1 ) { return NCAT_SSL_HANDSHAKE_COMPLETED ; } sslerr = SSL_get_error ( sinfo -> ssl , ret ) ; if ( ret == - 1 ) { if ( sslerr == SSL_ERROR_WANT_READ ) { return NCAT_SSL_HANDSHAKE_PENDING_READ ; } if ( sslerr == SSL_ERROR_WANT_WRITE ) { return NCAT_SSL_HANDSHAKE_PENDING_WRITE ; } } if ( o . verbose ) { loguser ( "Failed SSL connection from %s: %s\n" , inet_socktop ( & sinfo -> remoteaddr ) , ERR_error_string ( ERR_get_error ( ) , NULL ) ) ; } return NCAT_SSL_HANDSHAKE_FAILED ; } 