static const struct xattr_handler * squashfs_xattr_handler ( int ) ssize_t squashfs_listxattr ( struct dentry * d , char * buffer , size_t buffer_size ) { struct inode * inode = d_inode ( d ) ; struct super_block * sb = inode -> i_sb ; struct squashfs_sb_info * msblk = sb -> s_fs_info ; u64 start = SQUASHFS_XATTR_BLK ( squashfs_i ( inode ) -> xattr ) + msblk -> xattr_table ; int offset = SQUASHFS_XATTR_OFFSET ( squashfs_i ( inode ) -> xattr ) ; int count = squashfs_i ( inode ) -> xattr_count ; size_t rest = buffer_size ; int err ; while ( count -- ) { struct squashfs_xattr_entry entry ; struct squashfs_xattr_val val ; const struct xattr_handler * handler ; int name_size ; err = squashfs_read_metadata ( sb , & entry , & start , & offset , sizeof ( entry ) ) ; if ( err < 0 ) { failed } name_size = le16_to_cpu ( entry . size ) ; handler = squashfs_xattr_handler ( le16_to_cpu ( entry . type ) ) ; if ( handler && ( ! handler -> list || handler -> list ( d ) ) ) { const char * prefix = handler -> prefix ?: handler -> name ; size_t prefix_size = strlen ( prefix ) ; if ( buffer ) { if ( prefix_size + name_size + 1 > rest ) { err = - ERANGE ; failed } memcpy ( buffer , prefix , prefix_size ) ; buffer += prefix_size ; } err = squashfs_read_metadata ( sb , buffer , & start , & offset , name_size ) ; if ( err < 0 ) { failed } if ( buffer ) { buffer [ name_size ] = '\0' ; buffer += name_size + 1 ; } rest -= prefix_size + name_size + 1 ; } else { err = squashfs_read_metadata ( sb , NULL , & start , & offset , name_size ) ; if ( err < 0 ) { failed } } err = squashfs_read_metadata ( sb , & val , & start , & offset , sizeof ( val ) ) ; if ( err < 0 ) { failed } err = squashfs_read_metadata ( sb , NULL , & start , & offset , le32_to_cpu ( val . vsize ) ) ; if ( err < 0 ) { failed } } err = buffer_size - rest ; failed return err ; } 