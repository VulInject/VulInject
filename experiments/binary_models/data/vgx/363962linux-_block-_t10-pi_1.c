static void ext_pi_type1_prepare ( struct request * rq ) { const int tuple_sz = rq -> q -> integrity . tuple_size ; u64 ref_tag = ext_pi_ref_tag ( rq ) ; struct bio * bio ; __rq_for_each_bio ( , ) { struct bio_integrity_payload * bip = bio_integrity ( bio ) ; u64 virt = lower_48_bits ( bip_get_seed ( bip ) ) ; struct bio_vec iv ; struct bvec_iter iter ; if ( bip -> bip_flags & BIP_MAPPED_INTEGRITY ) { break ; } bip_for_each_vec ( , , ) { unsigned int j ; void * p ; p = bvec_kmap_local ( & iv ) ; for ( j = 0 ; j < iv . bv_len ; j += tuple_sz ) { struct crc64_pi_tuple * pi = p ; u64 ref = get_unaligned_be48 ( pi -> ref_tag ) ; if ( ref == virt ) { put_unaligned_be48 ( ref_tag , pi -> ref_tag ) ; } virt ++ ; ref_tag ++ ; p += tuple_sz ; } kunmap_local ( p , NULL ) ; } bip -> bip_flags |= BIP_MAPPED_INTEGRITY ; } } 