static int starcos_write_pukey ( sc_profile_t * profile , sc_card_t * card , struct sc_pkcs15_prkey_rsa * rsa , sc_pkcs15_prkey_info_t * kinfo ) { int r ; size_t len , keylen , endpos ; u8 * buf , key [ 280 ] , * p , num_keys ; sc_file_t * tfile = NULL ; sc_path_t tpath ; tpath = kinfo -> path ; r = sc_profile_get_file_in ( profile , & tpath , "p15_ipf" , & tfile ) ; if ( r < 0 ) { return r ; } tpath = tfile -> path ; sc_file_free ( tfile ) ; tfile = NULL ; r = sc_select_file ( card , & tpath , & tfile ) ; if ( r != SC_SUCCESS ) { return r ; } len = tfile -> size ; sc_file_free ( tfile ) ; buf = malloc ( len ) ; if ( ! buf ) { return SC_ERROR_OUT_OF_MEMORY ; } r = sc_read_binary ( card , 0 , buf , len , 0 ) ; if ( r < 0 || r != ( int ) len ) { return r ; } num_keys = buf [ 0 ] ; if ( num_keys == 0xff ) { num_keys = 0 ; } keylen = starcos_encode_pukey ( rsa , NULL , kinfo ) ; if ( ! keylen ) { return SC_ERROR_INTERNAL ; } p = key ; * p ++ = ( u8 ) kinfo -> key_reference ; * p ++ = ( keylen >> 8 ) & 0xff ; * p ++ = keylen & 0xff ; * p ++ = STARCOS_AC_ALWAYS ; * p ++ = 0x0f ; * p ++ = 0 ; * p ++ = 0x09 ; * p ++ = 0x4a ; * p ++ = ( ( keylen >> 8 ) & 0xff ) | 0x80 ; * p ++ = keylen & 0xff ; r = starcos_encode_pukey ( rsa , p , kinfo ) ; if ( r != SC_SUCCESS ) { free ( buf ) ; return SC_ERROR_INTERNAL ; } p += keylen ; * p ++ = 0x04 ; * p = ( u8 ) kinfo -> key_reference ; num_keys ++ ; r = sc_update_binary ( card , 0 , & num_keys , 1 , 0 ) ; if ( r < 0 ) { return r ; } endpos = starcos_ipf_get_lastpos ( buf , len ) ; free ( buf ) ; return sc_update_binary ( card , endpos , key , keylen + 12 , 0 ) ; } 