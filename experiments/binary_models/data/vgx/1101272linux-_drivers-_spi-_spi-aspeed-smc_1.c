static int aspeed_spi_set_window ( struct aspeed_spi * aspi , const struct aspeed_spi_window * win ) { u32 start = aspi -> ahb_base_phy + win -> offset ; u32 end = start + win -> size ; void __iomem * seg_reg = aspi -> regs + CE0_SEGMENT_ADDR_REG + win -> cs * 4 ; u32 seg_val_backup = readl ( seg_reg ) ; u32 seg_val = aspi -> data -> segment_reg ( aspi , start , end ) ; writel ( seg_val , seg_reg ) ; if ( seg_val != readl ( seg_reg ) ) { dev_err ( aspi -> dev , "CE%d invalid window [ 0x%.8x - 0x%.8x ] %dMB" , win -> cs , start , end - 1 , win -> size >> 20 ) ; writel ( seg_val_backup , seg_reg ) ; return - EIO ; } if ( win -> size ) { dev_dbg ( aspi -> dev , "CE%d new window [ 0x%.8x - 0x%.8x ] %dMB" , win -> cs , start , end - 1 , win -> size >> 20 ) ; } else { dev_dbg ( aspi -> dev , "CE%d window closed" , win -> cs ) ; } return 0 ; } 