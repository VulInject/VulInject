static void srpc_service_fini ( struct srpc_service * svc ) { struct srpc_service_cd * scd ; struct srpc_server_rpc * rpc ; struct srpc_buffer * buf ; struct list_head * q ; int i ; if ( ! svc -> sv_cpt_data ) { return ; } cfs_percpt_for_each ( , , ) { while ( 1 ) { if ( ! list_empty ( & scd -> scd_buf_posted ) ) { q = & scd -> scd_buf_posted ; } if ( ! list_empty ( & scd -> scd_buf_blocked ) ) { q = & scd -> scd_buf_blocked ; } else { break ; } while ( ! list_empty ( q ) ) { buf = list_entry ( q -> next , srpc_buffer , buf_list ) ; list_del ( & buf -> buf_list ) ; LIBCFS_FREE ( buf , sizeof ( * buf ) ) ; } } LASSERT ( list_empty ( & scd -> scd_rpc_active ) ) ; while ( ! list_empty ( & scd -> scd_rpc_free ) ) { rpc = list_entry ( scd -> scd_rpc_free . next , srpc_server_rpc , srpc_list ) ; list_del ( & rpc -> srpc_list ) ; LIBCFS_FREE ( rpc , sizeof ( * rpc ) ) ; } } cfs_percpt_free ( svc -> sv_cpt_data ) ; svc -> sv_cpt_data = NULL ; } 