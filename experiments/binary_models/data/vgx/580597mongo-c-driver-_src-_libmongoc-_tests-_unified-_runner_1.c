test_check_event ( , , , ) { bool ret = false ; bson_iter_t iter ; bson_t expected_bson ; bson_parser_t * bp = NULL ; const char * expected_event_type ; bson_t * expected_command = NULL ; char * expected_command_name = NULL ; char * expected_database_name = NULL ; bson_t * expected_reply = NULL ; bool * expected_has_service_id = NULL ; bool * expected_has_server_connection_id = NULL ; if ( bson_count_keys ( expected ) != 1 ) { test_set_error ( error , "expected 1 key in expected event, but got: %s" , tmp_json ( expected ) ) ; done } bson_iter_init ( & iter , expected ) ; bson_iter_next ( & iter ) ; expected_event_type = bson_iter_key ( & iter ) ; if ( 0 != strcmp ( expected_event_type , actual -> type ) ) { test_set_error ( error , "expected event type: %s, but got: %s" , expected_event_type , actual -> type ) ; done } if ( ! BSON_ITER_HOLDS_DOCUMENT ( & iter ) ) { test_set_error ( error , "unexpected non-document event assertion: %s" , tmp_json ( expected ) ) ; done } bson_iter_bson ( & iter , & expected_bson ) ; bp = bson_parser_new ( ) ; bson_parser_doc_optional ( bp , "command" , & expected_command ) ; bson_parser_utf8_optional ( bp , "commandName" , & expected_command_name ) ; bson_parser_utf8_optional ( bp , "databaseName" , & expected_database_name ) ; bson_parser_doc_optional ( bp , "reply" , & expected_reply ) ; bson_parser_bool_optional ( bp , "hasServiceId" , & expected_has_service_id ) ; bson_parser_bool_optional ( bp , "hasServerConnectionId" , & expected_has_server_connection_id ) ; if ( ! bson_parser_parse ( bp , & expected_bson , error ) ) { done } if ( expected_command ) { bson_val_t * expected_val ; bson_val_t * actual_val ; if ( ! actual || ! actual -> command ) { test_set_error ( error , "Expected a value but got NULL" ) ; done } expected_val = bson_val_from_bson ( expected_command ) ; actual_val = bson_val_from_bson ( actual -> command ) ; if ( ! entity_map_match ( test -> entity_map , expected_val , actual_val , false , error ) ) { bson_val_destroy ( expected_val ) ; done } bson_val_destroy ( expected_val ) ; bson_val_destroy ( actual_val ) ; } if ( expected_command_name && 0 != strcmp ( expected_command_name , actual -> command_name ) ) { test_set_error ( error , "expected commandName: %s, but got: %s" , expected_command_name , actual -> command_name ) ; done } if ( expected_database_name && 0 != strcmp ( expected_database_name , actual -> database_name ) ) { test_set_error ( error , "expected databaseName: %s, but got: %s" , expected_database_name , actual -> database_name ) ; done } if ( expected_reply ) { bson_val_t * expected_val = bson_val_from_bson ( expected_reply ) ; bson_val_t * actual_val = bson_val_from_bson ( actual -> reply ) ; if ( ! entity_map_match ( test -> entity_map , expected_val , actual_val , false , error ) ) { bson_val_destroy ( expected_val ) ; bson_val_destroy ( actual_val ) ; done } bson_val_destroy ( expected_val ) ; bson_val_destroy ( actual_val ) ; } if ( expected_has_service_id ) { char oid_str [ 25 ] { 0 } ; ; bool has_service_id = false ; bson_oid_to_string ( & actual -> service_id , oid_str ) ; has_service_id = 0 != bson_oid_compare ( & actual -> service_id , & kZeroServiceId ) ; if ( * expected_has_service_id && ! has_service_id ) { test_error ( "expected serviceId, but got none" ) ; } if ( ! * expected_has_service_id && has_service_id ) { test_error ( "expected no serviceId, but got %s" , oid_str ) ; } } if ( expected_has_server_connection_id ) { const bool has_server_connection_id = actual -> server_connection_id != MONGOC_NO_SERVER_CONNECTION_ID ; if ( * expected_has_server_connection_id && ! has_server_connection_id ) { test_error ( "expected server connectionId, but got none" ) ; } if ( ! * expected_has_server_connection_id && has_server_connection_id ) { test_error ( "expected no server connectionId, but got %" PRId64 , actual -> server_connection_id ) ; } } ret = true ; done bson_parser_destroy_with_parsed_fields ( bp ) ; return ret ; } 