static int pqi_aio_submit_r56_write_io ( struct pqi_ctrl_info * ctrl_info , struct scsi_cmnd * scmd , struct pqi_queue_group * queue_group , struct pqi_encryption_info * encryption_info , struct pqi_scsi_dev * device , struct pqi_scsi_dev_raid_map_data * rmd ) { int rc ; struct pqi_io_request * io_request ; struct pqi_aio_r56_path_request * r56_request ; io_request = pqi_alloc_io_request ( ctrl_info , scmd ) ; if ( ! io_request ) { return SCSI_MLQUEUE_HOST_BUSY ; } io_request -> io_complete_callback = pqi_aio_io_complete ; io_request -> scmd = scmd ; io_request -> raid_bypass = true ; r56_request = io_request -> iu ; if ( device -> raid_level == SA_RAID_5 || device -> raid_level == SA_RAID_51 ) { r56_request -> header . iu_type = PQI_REQUEST_IU_AIO_PATH_RAID5_IO ; } else { r56_request -> header . iu_type = PQI_REQUEST_IU_AIO_PATH_RAID6_IO ; } put_unaligned_le16 ( * ( u16 * ) device -> scsi3addr & 0x3fff , & r56_request -> volume_id ) ; put_unaligned_le32 ( rmd -> aio_handle , & r56_request -> data_it_nexus ) ; put_unaligned_le32 ( rmd -> p_parity_it_nexus , & r56_request -> p_parity_it_nexus ) ; if ( rmd -> raid_level == SA_RAID_6 ) { put_unaligned_le32 ( rmd -> q_parity_it_nexus , & r56_request -> q_parity_it_nexus ) ; r56_request -> xor_multiplier = rmd -> xor_mult ; } put_unaligned_le32 ( scsi_bufflen ( scmd ) , & r56_request -> data_length ) ; r56_request -> task_attribute = SOP_TASK_ATTRIBUTE_SIMPLE ; put_unaligned_le64 ( rmd -> row , & r56_request -> row ) ; put_unaligned_le16 ( io_request -> index , & r56_request -> request_id ) ; r56_request -> error_index = r56_request -> request_id ; if ( rmd -> cdb_length > sizeof ( r56_request -> cdb ) ) { rmd -> cdb_length = sizeof ( r56_request -> cdb ) ; } r56_request -> cdb_length = rmd -> cdb_length ; memcpy ( r56_request -> cdb , rmd -> cdb , rmd -> cdb_length ) ; r56_request -> data_direction = SOP_READ_FLAG ; if ( encryption_info ) { r56_request -> encryption_enable = true ; put_unaligned_le16 ( encryption_info -> data_encryption_key_index , & r56_request -> data_encryption_key_index ) ; put_unaligned_le32 ( encryption_info -> encrypt_tweak_lower , & r56_request -> encrypt_tweak_lower ) ; put_unaligned_le32 ( encryption_info -> encrypt_tweak_upper , & r56_request -> encrypt_tweak_upper ) ; } rc = pqi_build_aio_r56_sg_list ( ctrl_info , r56_request , scmd , io_request ) ; if ( rc ) { pqi_free_io_request ( io_request ) ; return SCSI_MLQUEUE_HOST_BUSY ; } pqi_start_io ( ctrl_info , queue_group , AIO_PATH , io_request ) ; return 0 ; } 