static int mpfs_sys_controller_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct mpfs_sys_controller * sys_controller ; int i , ret ; sys_controller = kzalloc ( sizeof ( * sys_controller ) , GFP_KERNEL ) ; if ( ! sys_controller ) { return - ENOMEM ; } sys_controller -> client . dev = dev ; sys_controller -> client . rx_callback = rx_callback ; sys_controller -> client . tx_block = 1U ; sys_controller -> chan = mbox_request_channel ( & sys_controller -> client , 0 ) ; if ( IS_ERR ( sys_controller -> chan ) ) { ret = dev_err_probe ( dev , PTR_ERR ( sys_controller -> chan ) , "Failed to get mbox channel\n" ) ; return ret ; } init_completion ( & sys_controller -> c ) ; kref_init ( & sys_controller -> consumers ) ; platform_set_drvdata ( pdev , sys_controller ) ; dev_info ( & pdev -> dev , "Registered MPFS system controller\n" ) ; for ( i = 0 ; i < ARRAY_SIZE ( subdevs ) ; i ++ ) { subdevs [ i ] . dev . parent = dev ; if ( platform_device_register ( & subdevs [ i ] ) ) { dev_warn ( dev , "Error registering sub device %s\n" , subdevs [ i ] . name ) ; } } return 0 ; } 