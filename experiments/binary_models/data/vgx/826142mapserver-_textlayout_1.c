hb_font_t * get_hb_font ( struct _ms_hb_user_data * font_data ) { face_element * fcache = font_data -> run -> face ; hb_font_element * hbf = fcache -> hbfont ; FT_Face face = fcache -> face ; int reqsize = MS_NINT ( font_data -> glyph_size * 96.0 / 72.0 ) ; if ( reqsize != fcache -> face -> size -> metrics . x_ppem ) { FT_Set_Pixel_Sizes ( face , 0 , reqsize ) ; } if ( ! hbf ) { hbf = msSmallMalloc ( sizeof ( hb_font_element ) ) ; hbf -> hbparentfont = hb_ft_font_create ( face , NULL ) ; hbf -> hbfont = hb_font_create_sub_font ( hbf -> hbparentfont ) ; hbf -> funcs = hb_font_funcs_create ( ) ; hb_font_funcs_set_glyph_h_advance_func ( hbf -> funcs , _ms_get_glyph_h_advance_func , NULL , NULL ) ; hb_font_funcs_set_nominal_glyph_func ( hbf -> funcs , _ms_get_nominal_glyph_func , NULL ) ; hb_font_funcs_set_variation_glyph_func ( hbf -> funcs , _ms_get_variation_glyph_func , NULL , NULL ) ; hb_font_funcs_set_glyph_func ( hbf -> funcs , _ms_get_glyph_func , NULL , NULL ) ; hb_font_funcs_set_glyph_v_advance_func ( hbf -> funcs , _ms_get_glyph_v_advance_func , NULL , NULL ) ; hbf -> cursize = reqsize ; fcache -> hbfont = hbf ; hb_font_set_funcs ( hbf -> hbfont , hbf -> funcs , font_data , NULL ) ; } else { if ( hbf -> cursize != reqsize ) { hb_font_set_scale ( hbf -> hbparentfont , ( ( uint64_t ) face -> size -> metrics . x_scale * ( uint64_t ) face -> units_per_EM ) >> 16 , ( ( uint64_t ) face -> size -> metrics . y_scale * ( uint64_t ) face -> units_per_EM ) >> 16 ) ; hb_font_set_ppem ( hbf -> hbparentfont , face -> size -> metrics . x_ppem , face -> size -> metrics . y_ppem ) ; hbf -> cursize = reqsize ; } } hb_font_set_funcs_data ( hbf -> hbfont , font_data , NULL ) ; return hbf -> hbfont ; } 