void oosiop_scsicmd ( struct scsi_xfer * xs ) { struct oosiop_softc * sc ; struct oosiop_cb * cb ; struct oosiop_xfer * xfer ; int s , err ; int dopoll ; sc = xs -> sc_link -> bus -> sb_adapter_softc ; s = splbio ( ) ; cb = xs -> io ; cb -> xs = xs ; cb -> xsflags = xs -> flags ; cb -> cmdlen = xs -> cmdlen ; cb -> datalen = 0 ; cb -> flags = 0 ; cb -> id = xs -> sc_link -> target ; cb -> lun = xs -> sc_link -> lun ; xfer = cb -> xfer ; err = bus_dmamap_load ( sc -> sc_dmat , cb -> cmddma , & xs -> cmd , xs -> cmdlen , NULL , ( ( xs -> flags & SCSI_NOSLEEP ) ?BUS_DMA_NOWAIT : BUS_DMA_WAITOK ) | BUS_DMA_STREAMING | BUS_DMA_WRITE ) ; if ( err ) { printf ( "%s: unable to load cmd DMA map: %d" , sc -> sc_dev . dv_xname , err ) ; splx ( s , NULL ) ; xs -> error = XS_DRIVER_STUFFUP ; scsi_done ( xs ) ; return ; } bus_dmamap_sync ( sc -> sc_dmat , cb -> cmddma , 0 , xs -> cmdlen , BUS_DMASYNC_PREWRITE ) ; if ( xs -> flags & ( SCSI_DATA_IN | SCSI_DATA_OUT ) ) { cb -> datalen = xs -> datalen ; err = bus_dmamap_load ( sc -> sc_dmat , cb -> datadma , xs -> data , xs -> datalen , NULL , ( ( xs -> flags & SCSI_NOSLEEP ) ?BUS_DMA_NOWAIT : BUS_DMA_WAITOK ) | BUS_DMA_STREAMING | ( ( xs -> flags & SCSI_DATA_IN ) ?BUS_DMA_READ : BUS_DMA_WRITE ) ) ; if ( err ) { printf ( "%s: unable to load data DMA map: %d" , sc -> sc_dev . dv_xname , err ) ; bus_dmamap_unload ( sc -> sc_dmat , cb -> cmddma ) ; splx ( s ) ; xs -> error = XS_DRIVER_STUFFUP ; scsi_done ( xs ) ; return ; } bus_dmamap_sync ( sc -> sc_dmat , cb -> datadma , 0 , xs -> datalen , BUS_DMASYNC_PREREAD | BUS_DMASYNC_PREWRITE ) ; } xfer -> status = SCSI_OOSIOP_NOSTATUS ; timeout_set ( & xs -> stimeout , oosiop_timeout , cb ) ; if ( xs -> flags & SCSI_POLL ) { dopoll = 1 ; } else { dopoll = 0 ; timeout_add_msec ( & xs -> stimeout , xs -> timeout ) ; } splx ( s ) ; oosiop_setup ( sc , cb ) ; TAILQ_INSERT_TAIL ( & sc -> sc_cbq , cb , chain ) ; if ( ! sc -> sc_active ) { oosiop_write_1 ( sc , OOSIOP_ISTAT , OOSIOP_ISTAT_ABRT ) ; } if ( dopoll ) { oosiop_poll ( sc , cb ) ; } } 