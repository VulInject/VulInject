int copy_thread ( struct task_struct * p , const struct kernel_clone_args * args ) { unsigned long clone_flags = args -> flags ; unsigned long usp = args -> stack ; unsigned long tls = args -> tls ; struct pt_regs * childregs = task_pt_regs ( p ) ; struct thread_info * ti = task_thread_info ( p ) ; if ( unlikely ( args -> fn ) ) { memset ( childregs , 0 , sizeof ( pt_regs ) ) ; ti -> cpu_context . r1 = ( unsigned long ) childregs ; ti -> cpu_context . r20 = ( unsigned long ) args -> fn ; ti -> cpu_context . r19 = ( unsigned long ) args -> fn_arg ; childregs -> pt_mode = 1 ; local_save_flags ( childregs -> msr ) ; ti -> cpu_context . msr = childregs -> msr & ~ MSR_IE ; ti -> cpu_context . r15 = ( unsigned long ) ret_from_kernel_thread - 8 ; return 0 ; } * childregs = * current_pt_regs ( ) ; if ( usp ) { childregs -> r1 = usp ; } memset ( & ti -> cpu_context , 0 , sizeof ( cpu_context ) ) ; ti -> cpu_context . r1 = ( unsigned long ) childregs ; childregs -> msr |= MSR_UMS ; childregs -> msr &= ~ MSR_EIP ; childregs -> msr |= MSR_IE ; childregs -> msr &= ~ MSR_VM ; childregs -> msr |= MSR_VMS ; childregs -> msr |= MSR_EE ; ti -> cpu_context . msr = ( childregs -> msr | MSR_VM ) ; ti -> cpu_context . msr &= ~ MSR_UMS ; ti -> cpu_context . msr &= ~ MSR_IE ; ti -> cpu_context . r15 = ( unsigned long ) ret_from_fork - 8 ; if ( clone_flags & CLONE_SETTLS ) { childregs -> r21 = tls ; } return 0 ; } 