static int __init hp300_8250_init ( void ) { static int called ; int line ; unsigned long base ; struct uart_8250_port uart ; struct hp300_port * port ; int i ; if ( called ) { return - ENODEV ; } called = 1 ; if ( ! MACH_IS_HP300 ) { return - ENODEV ; } dio_register_driver ( & hpdca_driver ) ; if ( hp300_model < HP_400 ) { if ( ! num_ports ) { return - ENODEV ; } return 0 ; } for ( i = 1 ; i < 4 ; i ++ ) { if ( i == 1 ) { continue ; } port = kmalloc ( sizeof ( hp300_port ) , GFP_KERNEL ) ; if ( ! port ) { return - ENOMEM ; } base = ( FRODO_BASE + FRODO_APCI_OFFSET ( i ) ) ; uart . port . iotype = UPIO_MEM ; uart . port . flags = UPF_SKIP_TEST | UPF_SHARE_IRQ | UPF_BOOT_AUTOCONF ; uart . port . irq = 0 ; uart . port . uartclk = HPAPCI_BAUD_BASE * 16 ; uart . port . mapbase = base ; uart . port . membase = ( char * ) ( base + DIO_VIRADDRBASE ) ; uart . port . regshift = 2 ; line = serial8250_register_8250_port ( & uart ) ; if ( line < 0 ) { dev_notice ( uart . port . dev , "8250_hp300: register_serial() APCI %d irq %d failed\n" , i , uart . port . irq ) ; kfree ( port ) ; continue ; } port -> line = line ; port -> next = hp300_ports ; hp300_ports = port ; num_ports ++ ; } if ( ! num_ports ) { return - ENODEV ; } return 0 ; } 