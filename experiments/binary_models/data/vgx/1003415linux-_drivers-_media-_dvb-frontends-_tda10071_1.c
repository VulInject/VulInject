static int tda10071_probe ( struct i2c_client * client ) { struct tda10071_dev * dev ; struct tda10071_platform_data * pdata = client -> dev . platform_data ; int ret ; unsigned int uitmp ; static const struct regmap_config regmap_config = { . reg_bits = 8 . val_bits = 8 } ; dev = kmalloc ( sizeof ( * dev ) , GFP_KERNEL ) ; if ( ! dev ) { ret = - ENOMEM ; err } dev -> client = client ; mutex_init ( & dev -> cmd_execute_mutex ) ; dev -> clk = pdata -> clk ; dev -> i2c_wr_max = pdata -> i2c_wr_max ; dev -> ts_mode = pdata -> ts_mode ; dev -> spec_inv = pdata -> spec_inv ; dev -> pll_multiplier = pdata -> pll_multiplier ; dev -> tuner_i2c_addr = pdata -> tuner_i2c_addr ; dev -> regmap = devm_regmap_init_i2c ( client , & regmap_config ) ; if ( IS_ERR ( dev -> regmap ) ) { ret = PTR_ERR ( dev -> regmap ) ; err_kfree } ret = regmap_read ( dev -> regmap , 0xff , & uitmp ) ; if ( ret ) { err_kfree } if ( uitmp != 0x0f ) { ret = - ENODEV ; err_kfree } ret = regmap_read ( dev -> regmap , 0xdd , & uitmp ) ; if ( ret ) { err_kfree } if ( uitmp != 0x00 ) { ret = - ENODEV ; err_kfree } ret = regmap_read ( dev -> regmap , 0xfe , & uitmp ) ; if ( ret ) { err_kfree } if ( uitmp != 0x01 ) { ret = - ENODEV ; err_kfree } memcpy ( & dev -> fe . ops , & tda10071_ops , sizeof ( dvb_frontend_ops ) ) ; dev -> fe . demodulator_priv = dev ; i2c_set_clientdata ( client , dev ) ; pdata -> get_dvb_frontend = tda10071_get_dvb_frontend ; dev_info ( & client -> dev , "NXP TDA10071 successfully identified\n" ) ; return 0 ; err_kfree kfree ( dev ) ; err dev_dbg ( & client -> dev , "failed=%d\n" , ret ) ; return ret ; } 