int mbox_do_cmd ( enum mbox_cmd cmd , u32 * in , int nin , u32 * out , int nout ) { const int tries = 50 ; int i ; u32 status ; clrbits_le32 ( RWTM_HOST_INT_MASK , SP_CMD_COMPLETE ) ; for ( i = 0 ; i < nin ; i ++ ) { writel ( in [ i ] , RWTM_CMD_PARAM ( i ) ) ; } for ( ; i < MAX_ARGS ; i ++ ) { writel ( 0x0 , RWTM_CMD_PARAM ( i ) ) ; } writel ( cmd , RWTM_CMD ) ; for ( i = 0 ; i < tries ; ++ i ) { mdelay ( 10 ) ; if ( readl ( RWTM_HOST_INT_RESET ) & SP_CMD_COMPLETE ) { break ; } } if ( i == tries ) { setbits_le32 ( RWTM_HOST_INT_RESET , SP_CMD_COMPLETE ) ; return - ETIMEDOUT ; } for ( i = 0 ; i < nout ; ++ i ) { out [ i ] = readl ( RWTM_CMD_STATUS ( i ) ) ; } status = readl ( RWTM_CMD_RETSTATUS ) ; setbits_le32 ( RWTM_HOST_INT_RESET , SP_CMD_COMPLETE ) ; if ( MBOX_STS_CMD ( status ) != cmd ) { return - MBOX_STS_MARVELL_ERROR ( status ) ; } if ( MBOX_STS_ERROR ( status ) == MBOX_STS_FAIL ) { return - ( int ) MBOX_STS_VALUE ( status ) ; } if ( MBOX_STS_ERROR ( status ) == MBOX_STS_BADCMD ) { return - ENOSYS ; } if ( MBOX_STS_ERROR ( status ) != MBOX_STS_SUCCESS ) { return - EIO ; } else { return MBOX_STS_VALUE ( status ) ; } } 