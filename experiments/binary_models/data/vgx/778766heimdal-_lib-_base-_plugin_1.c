static char * resolve_origin ( const char * di , const char * module ) { Dl_info dl_info ; const char * dname ; char * path , * p ; if ( strncmp ( di , "$ORIGIN/" , sizeof ( "$ORIGIN/" ) - 1 ) != 0 && strcmp ( di , "$ORIGIN" ) != 0 ) { return strdup ( di ) ; } di += sizeof ( "$ORIGIN" ) - 1 ; if ( dladdr ( heim_plugin_register , & dl_info ) == 0 ) { char * s ; if ( asprintf ( & s , LIBDIR "/plugin/%s" , module ) == - 1 ) { return NULL ; } return s ; } dname = dl_info . dli_fname ; p = strrchr ( dname , '\\' ) ; if ( p == NULL ) { p = strrchr ( dname , '/' ) ; } if ( p ) { if ( asprintf ( & path , "%.*s%s" , ( int ) ( p - dname ) , dname , di ) == - 1 ) { return NULL ; } } else { if ( asprintf ( & path , "%s%s" , dname , di ) == - 1 ) { return NULL ; } } return path ; char * s = NULL ; if ( strncmp ( di , "$ORIGIN/" , sizeof ( "$ORIGIN/" ) - 1 ) != 0 && strcmp ( di , "$ORIGIN" ) != 0 ) { return strdup ( di ) ; } if ( asprintf ( & s , LIBDIR "/plugin/%s" , module ) == - 1 ) { return NULL ; } return s ; } 