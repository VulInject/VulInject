static bool limit_mt ( const struct sk_buff * skb , struct xt_action_param * par ) { const struct xt_rateinfo * r = par -> matchinfo ; struct xt_limit_priv * priv = r -> master ; cfs_time_t now = jiffies ; spin_lock_bh ( & priv -> lock ) ; priv -> credit += ( now - xchg ( & priv -> prev , now ) ) * CREDITS_PER_JIFFY ; if ( priv -> credit > r -> credit_cap ) { priv -> credit = r -> credit_cap ; } if ( priv -> credit >= r -> cost ) { priv -> credit -= r -> cost ; spin_unlock_bh ( & priv -> lock ) ; return true ; } spin_unlock_bh ( & priv -> lock ) ; return false ; } 