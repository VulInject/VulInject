static uint8_t lombus_cmd ( HANDLE_TYPE * hdlp , ptrdiff_t vreg , uint_t val , uint_t cmd ) { struct lombus_state * ssp ; clock_t start ; uint8_t * p ; ssp = HANDLE_PRIVATE ( hdlp ) ; mutex_enter ( ssp -> lo_mutex ) ; while ( ssp -> cmdstate != LOMBUS_CMDSTATE_IDLE && ! panicstr ) { cv_wait ( ssp -> lo_cv , ssp -> lo_mutex ) ; } ssp -> cmdstate = LOMBUS_CMDSTATE_BUSY ; ssp -> sequence = ( ssp -> sequence + LOMBUS_SEQ_LSB ) & LOMBUS_SEQ ; p = & ssp -> cmdbuf [ 0 ] ; * p ++ = LOMBUS_CMD | ssp -> sequence | cmd ; switch ( cmd ) { case LOMBUS_CMD_WRITE : * p ++ = val & 0x7f ; if ( val >= 0x80 ) { ssp -> cmdbuf [ 0 ] |= LOMBUS_CMD_WMSB ; } case LOMBUS_CMD_READ : if ( LOMBUS_VREG_HI ( vreg ) != 0 ) { * p ++ = LOMBUS_VREG_HI ( vreg ) ; ssp -> cmdbuf [ 0 ] |= LOMBUS_CMD_XADDR ; } * p ++ = LOMBUS_VREG_LO ( vreg ) ; case LOMBUS_CMD_NOP : break ; } sio_check_fault_status ( ssp ) ; start = ddi_get_lbolt ( ) ; ssp -> deadline = start + drv_usectohz ( LOMBUS_CTS_TIMEOUT / 1000 ) ; while ( ! sio_lom_ready ( ssp ) ) { if ( ddi_get_lbolt ( ) > ssp -> deadline ) { break ; } ( void ) cv_reltimedwait ( ssp -> lo_cv , ssp -> lo_mutex , drv_usectohz ( LOMBUS_CTS_POLL / 1000 ) , TR_CLOCK_TICK ) ; } lombus_receive ( ssp ) ; mutex_enter ( ssp -> hw_mutex ) ; while ( p > ssp -> cmdbuf ) { sio_put_reg ( ssp , SIO_TXD , * -- p ) ; } mutex_exit ( ssp -> hw_mutex ) ; start = ddi_get_lbolt ( ) ; ssp -> deadline = start + drv_usectohz ( LOMBUS_CMD_TIMEOUT / 1000 ) ; ssp -> error = 0 ; ssp -> result = DUMMY_VALUE ; ssp -> cmdstate = LOMBUS_CMDSTATE_WAITING ; while ( ssp -> cmdstate == LOMBUS_CMDSTATE_WAITING ) { if ( cv_reltimedwait ( ssp -> lo_cv , ssp -> lo_mutex , drv_usectohz ( LOMBUS_CMD_POLL / 1000 ) , TR_CLOCK_TICK ) == - 1 ) { lombus_receive ( ssp ) ; } } val = ssp -> result ; if ( sio_faulty ( ssp ) ) { val = DUMMY_VALUE ; HANDLE_FAULT ( hdlp ) = LOMBUS_ERR_SIOHW ; } if ( ssp -> cmdstate != LOMBUS_CMDSTATE_READY ) { if ( ssp -> error != 0 ) { HANDLE_FAULT ( hdlp ) = ssp -> error ; } else { HANDLE_FAULT ( hdlp ) = LOMBUS_ERR_BADERRCODE ; } } ssp -> index = 0 ; ssp -> cmdstate = LOMBUS_CMDSTATE_IDLE ; cv_broadcast ( ssp -> lo_cv ) ; mutex_exit ( ssp -> lo_mutex ) ; return ( val ) ; } 