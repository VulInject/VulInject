static int stm32f4_adc_clk_sel ( struct platform_device * pdev , struct stm32_adc_priv * priv ) { unsigned long rate ; u32 val ; int i ; rate = clk_get_rate ( priv -> aclk ) ; for ( i = 0 ; i < ARRAY_SIZE ( stm32f4_pclk_div ) ; i ++ ) { if ( ( rate / stm32f4_pclk_div [ i ] ) <= STM32F4_ADC_MAX_CLK_RATE ) { break ; } } val = readl_relaxed ( priv -> common . base + STM32F4_ADC_CCR ) ; val &= ~ STM32F4_ADC_ADCPRE_MASK ; val |= i << STM32F4_ADC_ADCPRE_SHIFT ; writel_relaxed ( val , priv -> common . base + STM32F4_ADC_CCR ) ; dev_dbg ( & pdev -> dev , "Using analog clock source at %ld kHz\n" , rate / ( stm32f4_pclk_div [ i ] * 1000 ) ) ; return 0 ; } 