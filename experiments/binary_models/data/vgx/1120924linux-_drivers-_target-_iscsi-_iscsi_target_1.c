int iscsit_build_text_rsp ( struct iscsit_cmd * cmd , struct iscsit_conn * conn , struct iscsi_text_rsp * hdr , enum iscsit_transport_type network_transport ) { int text_length , padding ; bool completed = true ; text_length = iscsit_build_sendtargets_response ( cmd , network_transport , cmd -> read_data_done , & completed ) ; if ( completed ) { hdr -> flags = ISCSI_FLAG_CMD_FINAL ; } else { hdr -> flags = ISCSI_FLAG_TEXT_CONTINUE ; cmd -> read_data_done += text_length ; if ( cmd -> targ_xfer_tag == 0xFFFFFFFF ) { cmd -> targ_xfer_tag = session_get_next_ttt ( conn -> sess ) ; } } hdr -> opcode = ISCSI_OP_TEXT_RSP ; padding = ( ( - text_length ) & 3 ) ; hton24 ( hdr -> dlength , text_length ) ; hdr -> itt = cmd -> init_task_tag ; hdr -> ttt = cpu_to_be32 ( cmd -> targ_xfer_tag ) ; cmd -> stat_sn = conn -> stat_sn ++ ; hdr -> statsn = cpu_to_be32 ( cmd -> stat_sn ) ; iscsit_increment_maxcmdsn ( cmd , conn -> sess ) ; cmd -> maxcmdsn_inc = 0 ; hdr -> exp_cmdsn = cpu_to_be32 ( conn -> sess -> exp_cmd_sn ) ; hdr -> max_cmdsn = cpu_to_be32 ( ( u32 ) atomic_read ( & conn -> sess -> max_cmd_sn ) ) ; pr_debug ( "Built Text Response: ITT: 0x%08x, TTT: 0x%08x, StatSN: 0x%08x," " Length: %u, CID: %hu F: %d C: %d\n" , cmd -> init_task_tag , cmd -> targ_xfer_tag , cmd -> stat_sn , text_length , conn -> cid , ! ! ( hdr -> flags & ISCSI_FLAG_CMD_FINAL ) , ! ! ( hdr -> flags & ISCSI_FLAG_TEXT_CONTINUE ) ) ; return text_length + padding ; } 