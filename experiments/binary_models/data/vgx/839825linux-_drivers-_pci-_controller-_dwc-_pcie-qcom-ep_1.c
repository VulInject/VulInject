static int qcom_pcie_ep_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct qcom_pcie_ep * pcie_ep ; char * name ; int ret ; pcie_ep = devm_kzalloc ( dev , sizeof ( * pcie_ep ) , GFP_KERNEL ) ; pcie_ep -> pci . dev = dev ; pcie_ep -> pci . ops = & pci_ops ; pcie_ep -> pci . ep . ops = & pci_ep_ops ; platform_set_drvdata ( pdev , pcie_ep ) ; ret = qcom_pcie_ep_get_resources ( pdev , pcie_ep ) ; if ( ret ) { return ret ; } ret = qcom_pcie_enable_resources ( pcie_ep ) ; if ( ret ) { dev_err ( dev , "Failed to enable resources: %d\n" , ret ) ; return ret ; } ret = dw_pcie_ep_init ( & pcie_ep -> pci . ep ) ; if ( ret ) { dev_err ( dev , "Failed to initialize endpoint: %d\n" , ret ) ; err_disable_resources } ret = qcom_pcie_ep_enable_irq_resources ( pdev , pcie_ep ) ; if ( ret ) { err_disable_resources } name = devm_kasprintf ( dev , GFP_KERNEL , "%pOFP" , dev -> of_node ) ; if ( ! name ) { ret = - ENOMEM ; err_disable_irqs } pcie_ep -> debugfs = debugfs_create_dir ( name , NULL ) ; qcom_pcie_ep_init_debugfs ( pcie_ep ) ; return 0 ; err_disable_irqs disable_irq ( pcie_ep -> global_irq ) ; disable_irq ( pcie_ep -> perst_irq ) ; err_disable_resources qcom_pcie_disable_resources ( pcie_ep ) ; return ret ; } 