static int omap_enter_idle_smp ( struct cpuidle_device * dev , struct cpuidle_driver * drv , int index ) { struct idle_statedata * cx = state_ptr + index ; cfs_time_t flag ; raw_spin_lock_irqsave ( & mpu_lock , flag ) ; cx -> mpu_state_vote ++ ; if ( cx -> mpu_state_vote == num_online_cpus ( ) ) { pwrdm_set_logic_retst ( mpu_pd , cx -> mpu_logic_state ) ; omap_set_pwrdm_state ( mpu_pd , cx -> mpu_state ) ; } raw_spin_unlock_irqrestore ( & mpu_lock , flag ) ; omap4_enter_lowpower ( dev -> cpu , cx -> cpu_state ) ; raw_spin_lock_irqsave ( & mpu_lock , flag ) ; if ( cx -> mpu_state_vote == num_online_cpus ( ) ) { omap_set_pwrdm_state ( mpu_pd , PWRDM_POWER_ON ) ; } cx -> mpu_state_vote -- ; raw_spin_unlock_irqrestore ( & mpu_lock , flag ) ; return index ; } 