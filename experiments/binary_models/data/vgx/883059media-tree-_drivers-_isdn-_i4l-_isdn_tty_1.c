int isdn_tty_modem_init ( void ) { isdn_modem_t * m ; int i , retval ; modem_info * info ; m = & dev -> mdm ; m -> tty_modem = alloc_tty_driver ( ISDN_MAX_CHANNELS ) ; if ( ! m -> tty_modem ) { return - ENOMEM ; } m -> tty_modem -> name = "ttyI" ; m -> tty_modem -> major = ISDN_TTY_MAJOR ; m -> tty_modem -> minor_start = 0 ; m -> tty_modem -> type = TTY_DRIVER_TYPE_SERIAL ; m -> tty_modem -> subtype = SERIAL_TYPE_NORMAL ; m -> tty_modem -> init_termios = tty_std_termios ; m -> tty_modem -> init_termios . c_cflag = B9600 | CS8 | CREAD | HUPCL | CLOCAL ; m -> tty_modem -> flags = TTY_DRIVER_REAL_RAW ; m -> tty_modem -> driver_name = "isdn_tty" ; tty_set_operations ( m -> tty_modem , & modem_ops ) ; retval = tty_register_driver ( m -> tty_modem ) ; if ( retval ) { printk ( KERN_WARNING "isdn_tty: Couldn't register modem-device\n" ) ; err } for ( i = 0 ; i < ISDN_MAX_CHANNELS ; i ++ ) { info = & m -> info [ i ] ; if ( ! ( info -> fax = kmalloc ( sizeof ( T30_s ) , GFP_KERNEL ) ) ) { printk ( KERN_ERR "Could not allocate fax t30-buffer\n" ) ; retval = - ENOMEM ; err_unregister } tty_port_init ( & info -> port ) ; info -> port . ops = & isdn_tty_port_ops ; spin_lock_init ( & info -> readlock ) ; sprintf ( info -> last_cause , "0000" ) ; sprintf ( info -> last_num , "none" ) ; info -> last_dir = 0 ; info -> last_lhup = 1 ; info -> last_l2 = - 1 ; info -> last_si = 0 ; isdn_tty_reset_profile ( & info -> emu ) ; isdn_tty_modem_reset_regs ( info , 1 ) ; info -> magic = ISDN_ASYNC_MAGIC ; info -> line = i ; info -> x_char = 0 ; info -> isdn_driver = - 1 ; info -> isdn_channel = - 1 ; info -> drv_index = - 1 ; info -> xmit_size = ISDN_SERIAL_XMIT_SIZE ; setup_timer ( & info -> nc_timer , isdn_tty_modem_do_ncarrier , ( unsigned long ) info ) ; skb_queue_head_init ( & info -> xmit_queue ) ; skb_queue_head_init ( & info -> dtmf_queue ) ; info -> port . xmit_buf = kmalloc ( ISDN_SERIAL_XMIT_MAX + 5 , GFP_KERNEL ) ; if ( ! info -> port . xmit_buf ) { printk ( KERN_ERR "Could not allocate modem xmit-buffer\n" ) ; retval = - ENOMEM ; err_unregister } info -> port . xmit_buf += 4 ; } return 0 ; err_unregister for ( i -- ; i >= 0 ; i -- ) { info = & m -> info [ i ] ; kfree ( info -> port . xmit_buf - 4 ) ; info -> port . xmit_buf = NULL ; tty_port_destroy ( & info -> port ) ; } tty_unregister_driver ( m -> tty_modem ) ; err put_tty_driver ( m -> tty_modem ) ; m -> tty_modem = NULL ; return retval ; } 