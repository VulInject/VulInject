static unsigned int arp_mangle ( void * priv , struct sk_buff * skb , const struct nf_hook_state * state ) { struct arphdr * arp = arp_hdr ( skb ) ; struct arp_payload * payload ; struct clusterip_config * c ; struct net * net = state -> net ; if ( arp -> ar_hrd != htons ( ARPHRD_ETHER ) || arp -> ar_pro != htons ( ETH_P_IP ) || arp -> ar_pln != 4 || arp -> ar_hln != ETH_ALEN ) { return NF_ACCEPT ; } if ( arp -> ar_op != htons ( ARPOP_REPLY ) && arp -> ar_op != htons ( ARPOP_REQUEST ) ) { return NF_ACCEPT ; } payload = ( void * ) ( arp + 1 ) ; c = clusterip_config_find_get ( net , payload -> src_ip , 0 ) ; if ( c -> dev != state -> out ) { pr_debug ( "not mangling arp reply on different " "interface: cip'%s'-skb'%s'\n" , c -> dev -> name , state -> out -> name ) ; clusterip_config_put ( c ) ; return NF_ACCEPT ; } memcpy ( payload -> src_hw , c -> clustermac , arp -> ar_hln ) ; pr_debug ( "mangled arp reply: " ) ; arp_print ( payload ) ; clusterip_config_put ( c ) ; return NF_ACCEPT ; } 