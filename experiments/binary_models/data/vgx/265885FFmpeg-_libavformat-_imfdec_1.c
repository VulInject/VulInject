static int parse_imf_asset_map_from_xml_dom ( AVFormatContext * s , xmlDocPtr doc , IMFAssetLocatorMap * asset_map , const char * base_url ) { xmlNodePtr asset_map_element = NULL ; xmlNodePtr node = NULL ; xmlNodePtr asset_element = NULL ; unsigned long elem_count ; char * uri ; int ret = 0 ; IMFAssetLocator * asset = NULL ; void * tmp ; asset_map_element = xmlDocGetRootElement ( doc ) ; if ( ! asset_map_element ) { av_log ( s , AV_LOG_ERROR , "Unable to parse asset map XML - missing root node\n" ) ; return AVERROR_INVALIDDATA ; } if ( asset_map_element -> type != XML_ELEMENT_NODE || av_strcasecmp ( asset_map_element -> name , "AssetMap" ) ) { av_log ( s , AV_LOG_ERROR , "Unable to parse asset map XML - wrong root node name[%s] type[%d]\n" , asset_map_element -> name , ( int ) asset_map_element -> type ) ; return AVERROR_INVALIDDATA ; } if ( ! ( node = ff_imf_xml_get_child_element_by_name ( asset_map_element , "AssetList" ) ) ) { av_log ( s , AV_LOG_ERROR , "Unable to parse asset map XML - missing AssetList node\n" ) ; return AVERROR_INVALIDDATA ; } elem_count = xmlChildElementCount ( node ) ; tmp = av_realloc_array ( asset_map -> assets , elem_count + asset_map -> asset_count , sizeof ( IMFAssetLocator ) ) ; if ( ! tmp ) { av_log ( s , AV_LOG_ERROR , "Cannot allocate IMF asset locators\n" ) ; return AVERROR ( ENOMEM ) ; } asset_map -> assets = tmp ; asset_element = xmlFirstElementChild ( node ) ; while ( asset_element ) { if ( av_strcasecmp ( asset_element -> name , "Asset" ) != 0 ) { continue ; } asset = & ( asset_map -> assets [ asset_map -> asset_count ] ) ; if ( ! ( node = ff_imf_xml_get_child_element_by_name ( asset_element , "Id" ) ) ) { av_log ( s , AV_LOG_ERROR , "Unable to parse asset map XML - missing Id node\n" ) ; return AVERROR_INVALIDDATA ; } if ( ff_imf_xml_read_uuid ( node , asset -> uuid ) ) { av_log ( s , AV_LOG_ERROR , "Could not parse UUID from asset in asset map.\n" ) ; return AVERROR_INVALIDDATA ; } av_log ( s , AV_LOG_DEBUG , "Found asset id: " AV_PRI_URN_UUID "\n" , AV_UUID_ARG ( asset -> uuid ) ) ; if ( ! ( node = ff_imf_xml_get_child_element_by_name ( asset_element , "ChunkList" ) ) ) { av_log ( s , AV_LOG_ERROR , "Unable to parse asset map XML - missing ChunkList node\n" ) ; return AVERROR_INVALIDDATA ; } if ( ! ( node = ff_imf_xml_get_child_element_by_name ( node , "Chunk" ) ) ) { av_log ( s , AV_LOG_ERROR , "Unable to parse asset map XML - missing Chunk node\n" ) ; return AVERROR_INVALIDDATA ; } uri = xmlNodeGetContent ( ff_imf_xml_get_child_element_by_name ( node , "Path" ) ) ; if ( ! imf_uri_is_url ( uri ) && ! imf_uri_is_unix_abs_path ( uri ) && ! imf_uri_is_dos_abs_path ( uri ) ) { asset -> absolute_uri = av_append_path_component ( base_url , uri ) ; } else { asset -> absolute_uri = av_strdup ( uri ) ; } xmlFree ( uri ) ; if ( ! asset -> absolute_uri ) { return AVERROR ( ENOMEM ) ; } av_log ( s , AV_LOG_DEBUG , "Found asset absolute URI: %s\n" , asset -> absolute_uri ) ; asset_map -> asset_count ++ ; asset_element = xmlNextElementSibling ( asset_element ) ; } return ret ; } 