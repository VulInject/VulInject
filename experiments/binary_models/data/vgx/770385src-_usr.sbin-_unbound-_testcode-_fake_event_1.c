struct comm_point * outnet_comm_point_for_tcp ( struct outside_network * outnet , comm_point_callback_type * cb , void * cb_arg , struct sockaddr_storage * to_addr , socklen_t to_addrlen , struct sldns_buffer * query , int timeout , int ATTR_UNUSED ( ssl ) , char * ATTR_UNUSED ( host ) ) { struct replay_runtime * runtime = ( replay_runtime * ) outnet -> base ; struct fake_commpoint * fc = ( fake_commpoint * ) calloc ( 1 , sizeof ( * fc ) ) ; struct fake_pending * pend = ( fake_pending * ) calloc ( 1 , sizeof ( fake_pending ) ) ; if ( ! fc || ! pend ) { free ( fc ) ; return NULL ; } fc -> typecode = FAKE_COMMPOINT_TYPECODE ; fc -> type_tcp_out = 1 ; fc -> cb = cb ; fc -> cb_arg = cb_arg ; fc -> runtime = runtime ; fc -> pending = pend ; pend -> buffer = sldns_buffer_new ( sldns_buffer_limit ( query ) + 10 ) ; if ( ! pend -> buffer ) { free ( fc ) ; free ( pend ) ; return NULL ; } sldns_buffer_copy ( pend -> buffer , query ) ; memcpy ( & pend -> addr , to_addr , to_addrlen ) ; pend -> addrlen = to_addrlen ; pend -> zone = NULL ; pend -> zonelen = 0 ; if ( LDNS_QDCOUNT ( sldns_buffer_begin ( query ) ) > 0 ) { char buf [ 512 ] ; char addrbuf [ 128 ] ; ( void ) sldns_wire2str_rrquestion_buf ( sldns_buffer_at ( query , LDNS_HEADER_SIZE ) , sldns_buffer_limit ( query ) - LDNS_HEADER_SIZE , buf , sizeof ( buf ) ) ; addr_to_str ( ( sockaddr_storage * ) to_addr , to_addrlen , addrbuf , sizeof ( addrbuf ) ) ; if ( verbosity >= VERB_ALGO ) { strip_end_white ( buf ) ; log_info ( "tcp to %s: %s" , addrbuf , buf ) ; } log_assert ( sldns_buffer_limit ( query ) - LDNS_HEADER_SIZE >= 2 ) ; pend -> qtype = ( int ) sldns_buffer_read_u16_at ( query , LDNS_HEADER_SIZE + dname_valid ( sldns_buffer_at ( query , LDNS_HEADER_SIZE ) , sldns_buffer_limit ( query ) - LDNS_HEADER_SIZE ) ) ; } pend -> callback = cb ; pend -> cb_arg = cb_arg ; pend -> timeout = timeout ; pend -> transport = transport_tcp ; pend -> pkt = NULL ; pend -> runtime = runtime ; pend -> serviced = 0 ; pend -> pkt_len = sldns_buffer_limit ( pend -> buffer ) ; pend -> pkt = memdup ( sldns_buffer_begin ( pend -> buffer ) , pend -> pkt_len ) ; if ( ! pend -> pkt ) { fatal_exit ( "out of memory" ) ; } log_info ( "testbound: created fake pending for tcp_out" ) ; pend -> next = runtime -> pending_list ; runtime -> pending_list = pend ; return ( comm_point * ) fc ; } 