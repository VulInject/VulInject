int netxen_pinit_from_rom ( struct netxen_adapter * adapter ) { int addr , val ; int i , n , init_delay = 0 ; struct crb_addr_pair * buf ; unsigned offset ; u32 off ; netxen_rom_lock ( adapter ) ; NXWR32 ( adapter , NETXEN_ROMUSB_GLB_SW_RESET , 0xfeffffff ) ; netxen_rom_unlock ( adapter ) ; if ( NX_IS_REVISION_P3 ( adapter -> ahw . revision_id ) ) { if ( netxen_rom_fast_read ( adapter , 0 , & n ) != 0 || ( n != 0xcafecafe ) || netxen_rom_fast_read ( adapter , 4 , & n ) != 0 ) { printk ( KERN_ERR "%s: ERROR Reading crb_init area: " "n: %08x\n" , netxen_nic_driver_name , n ) ; return - EIO ; } offset = n & 0xffffU ; n = ( n >> 16 ) & 0xffffU ; } else { if ( netxen_rom_fast_read ( adapter , 0 , & n ) != 0 || ! ( n & 0x80000000 ) ) { printk ( KERN_ERR "%s: ERROR Reading crb_init area: " "n: %08x\n" , netxen_nic_driver_name , n ) ; return - EIO ; } offset = 1 ; n &= ~ 0x80000000 ; } if ( n >= 1024 ) { printk ( KERN_ERR "%s:n=0x%x Error! NetXen card flash not" " initialized.\n" , __func__ , n ) ; return - EIO ; } buf = kcalloc ( n , sizeof ( crb_addr_pair ) , GFP_KERNEL ) ; if ( buf == NULL ) { return - ENOMEM ; } for ( i = 0 ; i < n ; i ++ ) { if ( netxen_rom_fast_read ( adapter , 8 * i + 4 * offset , & val ) != 0 || netxen_rom_fast_read ( adapter , 8 * i + 4 * offset + 4 , & addr ) != 0 ) { return - EIO ; } buf [ i ] . addr = addr ; buf [ i ] . data = val ; } for ( i = 0 ; i < n ; i ++ ) { off = netxen_decode_crb_addr ( buf [ i ] . addr ) ; if ( off == NETXEN_ADDR_ERROR ) { printk ( KERN_ERR "CRB init value out of range %x\n" , buf [ i ] . addr ) ; continue ; } off += NETXEN_PCI_CRBSPACE ; if ( off & 1 ) { continue ; } if ( off == NETXEN_CAM_RAM ( 0x1fc ) ) { continue ; } if ( NX_IS_REVISION_P3 ( adapter -> ahw . revision_id ) ) { if ( off == ( NETXEN_CRB_I2C0 + 0x1c ) ) { continue ; } if ( off == ( ROMUSB_GLB + 0xbc ) ) { continue ; } if ( off == ( ROMUSB_GLB + 0xa8 ) ) { continue ; } if ( off == ( ROMUSB_GLB + 0xc8 ) ) { continue ; } if ( off == ( ROMUSB_GLB + 0x24 ) ) { continue ; } if ( off == ( ROMUSB_GLB + 0x1c ) ) { continue ; } if ( ( off & 0x0ff00000 ) == NETXEN_CRB_DDR_NET ) { continue ; } if ( off == ( NETXEN_CRB_PEG_NET_1 + 0x18 ) && ! NX_IS_REVISION_P3P ( adapter -> ahw . revision_id ) ) { buf [ i ] . data = 0x1020 ; } if ( off == NETXEN_PCIE_REG ( PCIE_SETUP_FUNCTION ) ) { continue ; } if ( off == NETXEN_PCIE_REG ( PCIE_SETUP_FUNCTION2 ) ) { continue ; } if ( ( off & 0x0ff00000 ) == NETXEN_CRB_SMB ) { continue ; } } init_delay = 1 ; if ( off == NETXEN_ROMUSB_GLB_SW_RESET ) { init_delay = 1000 ; if ( NX_IS_REVISION_P2 ( adapter -> ahw . revision_id ) ) { buf [ i ] . data = NETXEN_NIC_XDMA_RESET ; buf [ i ] . data = 0x8000ff ; } } NXWR32 ( adapter , off , buf [ i ] . data ) ; msleep ( init_delay ) ; } kfree ( buf ) ; if ( NX_IS_REVISION_P2 ( adapter -> ahw . revision_id ) ) { val = NXRD32 ( adapter , NETXEN_ROMUSB_GLB_SW_RESET ) ; NXWR32 ( adapter , NETXEN_ROMUSB_GLB_SW_RESET , ( val & 0xffffff0f ) ) ; } NXWR32 ( adapter , NETXEN_CRB_PEG_NET_D + 0xec , 0x1e ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_D + 0x4c , 8 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_I + 0x4c , 8 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_0 + 0x8 , 0 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_0 + 0xc , 0 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_1 + 0x8 , 0 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_1 + 0xc , 0 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_2 + 0x8 , 0 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_2 + 0xc , 0 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_3 + 0x8 , 0 ) ; NXWR32 ( adapter , NETXEN_CRB_PEG_NET_3 + 0xc , 0 ) ; return 0 ; } 