void mISDNisar_irq ( struct isar_hw * isar ) { struct isar_ch * ch ; get_irq_infos ( isar ) ; switch ( isar -> iis & ISAR_IIS_MSCMSD ) { case ISAR_IIS_RDATA : ch = sel_bch_isar ( isar , isar -> iis >> 6 ) ; if ( ch ) { isar_rcv_frame ( ch ) ; } else { pr_debug ( "%s: ISAR spurious IIS_RDATA %x/%x/%x\n" , isar -> name , isar -> iis , isar -> cmsb , isar -> clsb ) ; isar -> write_reg ( isar -> hw , ISAR_IIA , 0 ) ; } break ; case ISAR_IIS_GSTEV : isar -> write_reg ( isar -> hw , ISAR_IIA , 0 ) ; isar -> bstat |= isar -> cmsb ; check_send ( isar , isar -> cmsb ) ; break ; case ISAR_IIS_BSTEV : ch = sel_bch_isar ( isar , isar -> iis >> 6 ) ; if ( ch ) { if ( isar -> cmsb == BSTEV_TBO ) { ch -> bch . err_tx ++ ; } if ( isar -> cmsb == BSTEV_RBO ) { ch -> bch . err_rdo ++ ; } } pr_debug ( "%s: Buffer STEV dpath%d msb(%x)\n" , isar -> name , isar -> iis >> 6 , isar -> cmsb ) ; isar -> write_reg ( isar -> hw , ISAR_IIA , 0 ) ; break ; case ISAR_IIS_PSTEV : ch = sel_bch_isar ( isar , isar -> iis >> 6 ) ; if ( ch ) { rcv_mbox ( isar ) ; if ( ch -> bch . state == ISDN_P_B_MODEM_ASYNC ) { isar_pump_statev_modem ( ch , isar -> cmsb ) ; } if ( ch -> bch . state == ISDN_P_B_T30_FAX ) { isar_pump_statev_fax ( ch , isar -> cmsb ) ; } if ( ch -> bch . state == ISDN_P_B_RAW ) { int tt ; tt = isar -> cmsb | 0x30 ; if ( tt == 0x3e ) { tt = '*' ; } if ( tt == 0x3f ) { tt = '#' ; } if ( tt > '9' ) { tt += 7 ; } tt |= DTMF_TONE_VAL ; _queue_data ( & ch -> bch . ch , PH_CONTROL_IND , MISDN_ID_ANY , sizeof ( tt ) , & tt , GFP_ATOMIC ) ; } else { pr_debug ( "%s: ISAR IIS_PSTEV pm %d sta %x\n" , isar -> name , ch -> bch . state , isar -> cmsb ) ; } } else { pr_debug ( "%s: ISAR spurious IIS_PSTEV %x/%x/%x\n" , isar -> name , isar -> iis , isar -> cmsb , isar -> clsb ) ; isar -> write_reg ( isar -> hw , ISAR_IIA , 0 ) ; } break ; case ISAR_IIS_PSTRSP : ch = sel_bch_isar ( isar , isar -> iis >> 6 ) ; if ( ch ) { rcv_mbox ( isar , NULL ) ; isar_pump_status_rsp ( ch ) ; } else { pr_debug ( "%s: ISAR spurious IIS_PSTRSP %x/%x/%x\n" , isar -> name , isar -> iis , isar -> cmsb , isar -> clsb ) ; isar -> write_reg ( isar -> hw , ISAR_IIA , 0 ) ; } break ; case ISAR_IIS_DIAG : case ISAR_IIS_BSTRSP : case ISAR_IIS_IOM2RSP : rcv_mbox ( isar , NULL ) ; break ; case ISAR_IIS_INVMSG : rcv_mbox ( isar , NULL ) ; pr_debug ( "%s: invalid msg his:%x\n" , isar -> name , isar -> cmsb ) ; break ; default : rcv_mbox ( isar , NULL ) ; pr_debug ( "%s: unhandled msg iis(%x) ctrl(%x/%x)\n" , isar -> name , isar -> iis , isar -> cmsb , isar -> clsb ) ; break ; } } 