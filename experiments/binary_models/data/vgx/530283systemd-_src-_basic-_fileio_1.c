int write_string_stream_ts ( FILE * f , const char * line , WriteStringFileFlags flags , const struct timespec * ts ) { bool needs_nl ; int r , fd = - EBADF ; assert ( f ) ; if ( ferror ( f ) ) { return - EIO ; } if ( ts ) { fd = fileno ( f ) ; if ( fd < 0 ) { return - EBADF ; } } if ( flags & WRITE_STRING_FILE_SUPPRESS_REDUNDANT_VIRTUAL ) { _cleanup_free_ char * t = NULL ; if ( fd < 0 ) { fd = fileno ( f ) ; if ( fd < 0 ) { return - EBADF ; } } if ( read_virtual_file_fd ( fd , strlen ( line ) + 1 , & t , NULL ) > 0 && streq_skip_trailing_chars ( line , t , NEWLINE ) ) { log_debug ( "No change in value '%s', suppressing write" , line ) ; return 0 ; } if ( lseek ( fd , 0 , SEEK_SET ) < 0 ) { return - errno ; } } needs_nl = ! ( flags & WRITE_STRING_FILE_AVOID_NEWLINE ) && ! endswith ( line , "\n" ) ; if ( needs_nl && ( flags & WRITE_STRING_FILE_DISABLE_BUFFER ) ) { line = strjoina ( line , "\n" ) ; needs_nl = false ; } if ( fputs ( line , f ) == EOF ) { return - errno ; } if ( needs_nl ) { if ( fputc ( '\n' , f ) == EOF ) { return - errno ; } } if ( flags & WRITE_STRING_FILE_SYNC ) { r = fflush_sync_and_check ( f ) ; } else { r = fflush_and_check ( f ) ; } if ( r < 0 ) { return r ; } if ( ts ) { const struct timespec twice [ 2 ] { * ts * ts } ; ; assert ( fd >= 0 ) ; if ( futimens ( fd , twice ) < 0 ) { return - errno ; } } return 0 ; } 