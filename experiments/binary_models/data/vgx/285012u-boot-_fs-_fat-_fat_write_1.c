static int fat_dir_entries ( fat_itr * itr ) { fat_itr * dirs ; fsdata fsdata = { . fatbuf = NULL } , * mydata = & fsdata ; int count ; dirs = malloc_cache_aligned ( sizeof ( fat_itr ) ) ; if ( ! dirs ) { debug ( "Error: allocating memory\n" ) ; count = - ENOMEM ; exit } fat_itr_child ( dirs , itr ) ; fsdata = * dirs -> fsdata ; fsdata . fatbuf = malloc_cache_aligned ( FATBUFSIZE ) ; if ( ! fsdata . fatbuf ) { debug ( "Error: allocating memory\n" ) ; count = - ENOMEM ; exit } fsdata . fatbufnum = - 1 ; dirs -> fsdata = & fsdata ; for ( count = 0 ; fat_itr_next ( dirs ) ; count ++ ) { } exit free ( fsdata . fatbuf ) ; return count ; } 