int handle__suback ( struct mosquitto * mosq ) { uint16_t mid ; uint8_t qos ; int * granted_qos ; int qos_count ; int i = 0 ; int rc ; mosquitto_property * properties = NULL ; assert ( mosq ) ; if ( mosquitto__get_state ( mosq ) != mosq_cs_active ) { return MOSQ_ERR_PROTOCOL ; } if ( mosq -> in_packet . command != CMD_SUBACK ) { return MOSQ_ERR_MALFORMED_PACKET ; } log__printf ( NULL , MOSQ_LOG_DEBUG , "Received SUBACK from %s" , SAFE_PRINT ( mosq -> id ) ) ; log__printf ( mosq , MOSQ_LOG_DEBUG , "Client %s received SUBACK" , SAFE_PRINT ( mosq -> id ) ) ; rc = packet__read_uint16 ( & mosq -> in_packet , & mid ) ; if ( rc ) { return rc ; } if ( mid == 0 ) { return MOSQ_ERR_PROTOCOL ; } if ( mosq -> protocol == mosq_p_mqtt5 ) { rc = property__read_all ( CMD_SUBACK , & mosq -> in_packet , & properties ) ; if ( rc ) { return rc ; } } qos_count = ( int ) ( mosq -> in_packet . remaining_length - mosq -> in_packet . pos ) ; granted_qos = mosquitto__malloc ( ( size_t ) qos_count * sizeof ( int ) ) ; if ( ! granted_qos ) { mosquitto_property_free_all ( & properties ) ; return MOSQ_ERR_NOMEM ; } while ( mosq -> in_packet . pos < mosq -> in_packet . remaining_length ) { rc = packet__read_byte ( & mosq -> in_packet , & qos ) ; if ( rc ) { mosquitto__free ( granted_qos ) ; mosquitto_property_free_all ( & properties ) ; return rc ; } granted_qos [ i ] = ( int ) qos ; i ++ ; } mosquitto_property_free_all ( & properties ) ; pthread_mutex_lock ( & mosq -> callback_mutex ) ; if ( mosq -> on_subscribe ) { mosq -> in_callback = true ; mosq -> on_subscribe ( mosq , mosq -> userdata , mid , qos_count , granted_qos ) ; mosq -> in_callback = false ; } if ( mosq -> on_subscribe_v5 ) { mosq -> in_callback = true ; mosq -> on_subscribe_v5 ( mosq , mosq -> userdata , mid , qos_count , granted_qos , properties ) ; mosq -> in_callback = false ; } pthread_mutex_unlock ( & mosq -> callback_mutex ) ; mosquitto_property_free_all ( & properties ) ; mosquitto__free ( granted_qos ) ; return MOSQ_ERR_SUCCESS ; } 