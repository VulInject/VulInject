static void vici_parse_message ( struct vici_conn * vici , struct zbuf * msg , void * parser ( struct vici_message_ctx * ctx , enum vici_type_t msgtype , const struct blob * key , const struct blob * val ) , struct vici_message_ctx * ctx ) { uint8_t * type ; struct blob key = { 0 } ; struct blob val = { 0 } ; while ( ( type = zbuf_may_pull ( msg , uint8_t ) ) != NULL ) { switch ( * type ) { case VICI_SECTION_START : key . len = zbuf_get8 ( msg ) ; key . ptr = zbuf_pulln ( msg , key . len ) ; debugf ( NHRP_DEBUG_VICI , "VICI: Section start '%.*s'" , key . len , key . ptr ) ; parser ( ctx , * type , & key , NULL ) ; ctx -> nsections ++ ; break ; case VICI_SECTION_END : debugf ( NHRP_DEBUG_VICI , "VICI: Section end" ) ; parser ( ctx , * type , NULL ) ; ctx -> nsections -- ; break ; case VICI_KEY_VALUE : key . len = zbuf_get8 ( msg ) ; key . ptr = zbuf_pulln ( msg , key . len ) ; val . len = zbuf_get_be16 ( msg ) ; val . ptr = zbuf_pulln ( msg , val . len ) ; debugf ( NHRP_DEBUG_VICI , "VICI: Key '%.*s'='%.*s'" , key . len , key . ptr , val . len , val . ptr ) ; parser ( ctx , * type , & key , & val ) ; break ; case VICI_LIST_START : key . len = zbuf_get8 ( msg ) ; key . ptr = zbuf_pulln ( msg , key . len ) ; debugf ( NHRP_DEBUG_VICI , "VICI: List start '%.*s'" , key . len , key . ptr ) ; break ; case VICI_LIST_ITEM : val . len = zbuf_get_be16 ( msg ) ; val . ptr = zbuf_pulln ( msg , val . len ) ; debugf ( NHRP_DEBUG_VICI , "VICI: List item: '%.*s'" , val . len , val . ptr ) ; parser ( ctx , * type , & key , & val ) ; break ; case VICI_LIST_END : debugf ( NHRP_DEBUG_VICI , "VICI: List end" ) ; break ; } } } 