int test_restart ( void ) { int pipefd [ 2 ] ; pid_t pid ; char buf [ 512 ] ; if ( pipe ( pipefd ) == - 1 ) { perror ( "pipe" ) ; exit ( EXIT_FAILURE ) ; } pid = fork ( ) ; if ( pid == - 1 ) { perror ( "fork" ) ; exit ( EXIT_FAILURE ) ; } if ( pid == 0 ) { struct sigaction act ; int fd ; sigaddset ( & act . sa_mask , SIGUSR2 ) ; act . sa_handler = SIGUSR1_handler ; act . sa_flags = SA_RESTART ; if ( sigaction ( SIGUSR1 , & act , NULL ) == - 1 ) { perror ( "sigaction" ) ; exit ( EXIT_FAILURE ) ; } memset ( & act , 0 , sizeof ( act ) ) ; act . sa_handler = SIGUSR2_handler ; act . sa_flags = SA_RESTART ; if ( sigaction ( SIGUSR2 , & act , NULL ) == - 1 ) { perror ( "sigaction" ) ; exit ( EXIT_FAILURE ) ; } while ( ( fd = dup ( pipefd [ 0 ] ) ) != 512 ) { if ( fd == - 1 ) { perror ( "dup" ) ; exit ( EXIT_FAILURE ) ; } } if ( raw_read ( fd , buf , 512 ) == - 1 ) { if ( errno == ENOANO ) { fprintf ( stderr , "Double restart moved restart before sc instruction.\n" ) ; _exit ( EXIT_FAILURE ) ; } perror ( "read" ) ; exit ( EXIT_FAILURE ) ; } if ( strncmp ( buf , DATA , DLEN ) ) { fprintf ( stderr , "bad test string %s\n" , buf ) ; exit ( EXIT_FAILURE ) ; } return 0 ; } else { int wstatus ; usleep ( 100000 ) ; kill ( pid , SIGUSR1 ) ; usleep ( 100000 ) ; if ( write ( pipefd [ 1 ] , DATA , DLEN ) != DLEN ) { perror ( "write" ) ; exit ( EXIT_FAILURE ) ; } close ( pipefd [ 0 ] ) ; close ( pipefd [ 1 ] ) ; if ( wait ( & wstatus ) == - 1 ) { perror ( "wait" ) ; exit ( EXIT_FAILURE ) ; } if ( ! WIFEXITED ( wstatus ) ) { fprintf ( stderr , "child exited abnormally\n" ) ; exit ( EXIT_FAILURE ) ; } FAIL_IF ( WEXITSTATUS ( wstatus ) != EXIT_SUCCESS ) ; return 0 ; } } 