static void ublk_mark_io_ready ( struct ublk_device * ub , struct ublk_queue * ubq ) { ubq -> nr_io_ready ++ ; if ( ublk_queue_ready ( ubq ) ) { ubq -> ubq_daemon = current ; get_task_struct ( ubq -> ubq_daemon ) ; ub -> nr_queues_ready ++ ; if ( capable ( CAP_SYS_ADMIN ) ) { ub -> nr_privileged_daemon ++ ; } } if ( ub -> nr_queues_ready == ub -> dev_info . nr_hw_queues ) { complete_all ( & ub -> completion ) ; } mutex_unlock ( & ub -> mutex ) ; } 