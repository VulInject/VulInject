static int qede_alloc_rx_buffers ( qede_t * qede , qede_rx_ring_t * rx_ring ) { int ret = DDI_SUCCESS , i , j ; qede_rx_buffer_t * rx_buffer ; qede_rx_buf_area_t * rx_buf_area = rx_ring -> rx_buf_area ; u32 bufs_per_page , buf_size ; int page_size = ( int ) ddi_ptob ( qede -> dip , 1 ) ; qede_dma_info_t * dma_info ; ddi_dma_cookie_t temp_cookie ; int allocated = 0 ; u64 dma_addr ; u8 * vaddr ; ddi_dma_handle_t dma_handle ; ddi_acc_handle_t acc_handle ; if ( rx_ring -> rx_buf_size > page_size ) { bufs_per_page = 1 ; buf_size = rx_ring -> rx_buf_size ; } else { bufs_per_page = ( page_size ) / DEFAULT_RX_BUF_SIZE ; buf_size = page_size ; } rx_buffer = & rx_buf_area -> rx_buf_pool [ 0 ] ; rx_buf_area -> bufs_per_page = bufs_per_page ; mutex_init ( & rx_buf_area -> active_buf_list . lock , MUTEX_DRIVER , 0 ) ; mutex_init ( & rx_buf_area -> passive_buf_list . lock , NULL , MUTEX_DRIVER , 0 ) ; for ( i = 0 ; i < rx_ring -> rx_buf_count ; i += bufs_per_page ) { dma_info = & rx_buffer -> dma_info ; ret = qede_dma_mem_alloc ( qede , buf_size , DDI_DMA_READ | DDI_DMA_STREAMING | DDI_DMA_CONSISTENT , ( caddr_t * ) & dma_info -> virt_addr , & temp_cookie , & dma_info -> dma_handle , & dma_info -> acc_handle , & qede_dma_attr_rxbuf , & qede_buf_acc_attr ) ; if ( ret != DDI_SUCCESS ) { err } allocated ++ ; vaddr = dma_info -> virt_addr ; dma_addr = temp_cookie . dmac_laddress ; dma_handle = dma_info -> dma_handle ; acc_handle = dma_info -> acc_handle ; for ( j = 0 ; j < bufs_per_page ; j ++ ) { dma_info = & rx_buffer -> dma_info ; dma_info -> virt_addr = vaddr ; dma_info -> phys_addr = dma_addr ; dma_info -> dma_handle = dma_handle ; dma_info -> acc_handle = acc_handle ; dma_info -> offset = j * rx_ring -> rx_buf_size ; rx_buffer -> recycle . free_func = qede_recycle_rx_buffer ; rx_buffer -> recycle . free_arg = ( caddr_t ) rx_buffer ; rx_buffer -> mp = desballoc ( dma_info -> virt_addr , rx_ring -> rx_buf_size , 0 , & rx_buffer -> recycle ) ; if ( rx_buffer -> mp == NULL ) { qede_warn ( qede , "desballoc() failed, index %d" , i ) ; } rx_buffer -> rx_ring = rx_ring ; rx_buffer -> rx_buf_area = rx_buf_area ; rx_buffer -> index = i + j ; rx_buffer -> ref_cnt = 1 ; rx_buffer ++ ; vaddr += rx_ring -> rx_buf_size ; dma_addr += rx_ring -> rx_buf_size ; } rx_ring -> sw_rx_prod ++ ; } ret = qede_init_bd ( qede , rx_ring ) ; if ( ret != DDI_SUCCESS ) { err } rx_buf_area -> buf_upstream = 0 ; return ( ret ) ; err qede_free_rx_buffers ( qede , rx_ring ) ; return ( ret ) ; } 