static int msb_cache_read ( struct msb_data * msb , int lba , int page , struct scatterlist * sg , int offset ) { int pba = msb -> lba_to_pba_table [ lba ] ; struct scatterlist sg_tmp [ 10 ] ; int error = 0 ; if ( lba == msb -> cache_block_lba && test_bit ( page , & msb -> valid_cache_bitmap ) ) { dbg_verbose ( "Read of LBA %d (pba %d) sector %d from cache" , lba , pba , page ) ; sg_init_table ( sg_tmp , ARRAY_SIZE ( sg_tmp ) ) ; msb_sg_copy ( sg , sg_tmp , ARRAY_SIZE ( sg_tmp ) , offset , msb -> page_size ) ; sg_copy_from_buffer ( sg_tmp , sg_nents ( sg_tmp ) , msb -> cache + msb -> page_size * page , msb -> page_size ) ; } else { dbg_verbose ( "Read of LBA %d (pba %d) sector %d from device" , lba , pba , page ) ; error = msb_read_page ( msb , pba , page , NULL , sg , offset ) ; msb_cache_write ( msb , lba , page , true , sg , offset ) ; } return error ; } 