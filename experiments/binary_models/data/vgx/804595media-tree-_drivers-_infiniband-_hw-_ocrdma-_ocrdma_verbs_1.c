static int ocrdma_build_pbl_tbl ( struct ocrdma_dev * dev , struct ocrdma_hw_mr * mr ) { int status = 0 ; int i ; u32 dma_len = mr -> pbl_size ; struct pci_dev * pdev = dev -> nic_info . pdev ; void * va ; dma_addr_t pa ; mr -> pbl_table = kzalloc ( sizeof ( ocrdma_pbl ) * mr -> num_pbls , GFP_KERNEL ) ; if ( ! mr -> pbl_table ) { return - ENOMEM ; } for ( i = 0 ; i < mr -> num_pbls ; i ++ ) { va = dma_alloc_coherent ( & pdev -> dev , dma_len , & pa , GFP_KERNEL ) ; if ( ! va ) { ocrdma_free_mr_pbl_tbl ( dev , mr ) ; status = - ENOMEM ; break ; } mr -> pbl_table [ i ] . va = va ; mr -> pbl_table [ i ] . pa = pa ; } return status ; } 