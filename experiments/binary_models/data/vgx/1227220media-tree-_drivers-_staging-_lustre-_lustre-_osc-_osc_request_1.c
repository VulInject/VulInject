static int osc_statfs ( const struct lu_env * env , struct obd_export * exp , struct obd_statfs * osfs , __u64 max_age , __u32 flags ) { struct obd_device * obd = class_exp2obd ( exp ) ; struct obd_statfs * msfs ; struct ptlrpc_request * req ; struct obd_import * imp = NULL ; int rc ; down_read ( & obd -> u . cli . cl_sem ) ; if ( obd -> u . cli . cl_import ) { imp = class_import_get ( obd -> u . cli . cl_import ) ; } up_read ( & obd -> u . cli . cl_sem ) ; if ( ! imp ) { return - ENODEV ; } req = ptlrpc_request_alloc ( imp , & RQF_OST_STATFS ) ; class_import_put ( imp ) ; if ( ! req ) { return - ENOMEM ; } rc = ptlrpc_request_pack ( req , LUSTRE_OST_VERSION , OST_STATFS ) ; if ( rc ) { return rc ; } ptlrpc_request_set_replen ( req ) ; req -> rq_request_portal = OST_CREATE_PORTAL ; ptlrpc_at_set_req_timeout ( req ) ; if ( flags & OBD_STATFS_NODELAY ) { req -> rq_no_resend = 1 ; req -> rq_no_delay = 1 ; } rc = ptlrpc_queue_wait ( req ) ; if ( rc ) { out } msfs = req_capsule_server_get ( & req -> rq_pill , & RMF_OBD_STATFS ) ; if ( ! msfs ) { rc = - EPROTO ; out } * osfs = * msfs ; out ptlrpc_req_finished ( req ) ; return rc ; } 