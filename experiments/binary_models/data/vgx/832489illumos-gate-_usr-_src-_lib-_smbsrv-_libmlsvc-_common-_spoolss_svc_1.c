static int spoolss_s_EndDocPrinter ( void * arg , ndr_xa_t * mxa ) { struct spoolss_EndDocPrinter * param = arg ; ndr_hdid_t * id = ( ndr_hdid_t * ) & param -> handle ; smb_spooldoc_t * sp ; if ( ndr_hdlookup ( mxa , id ) == NULL ) { smb_tracef ( "spoolss_s_EndDocPrinter: invalid handle" ) ; param -> status = ERROR_INVALID_HANDLE ; return ( NDR_DRC_OK ) ; } param -> status = ERROR_INVALID_HANDLE ; ( void ) rw_wrlock ( & spoolss_splist . sp_rwl ) ; sp = list_head ( & spoolss_splist . sp_list ) ; while ( sp != NULL ) { if ( ! memcmp ( id , & ( sp -> sd_handle ) , sizeof ( ndr_hdid_t ) ) ) { spoolss_copyfile ( & sp -> sd_ipaddr , sp -> sd_username , sp -> sd_path , sp -> sd_doc_name ) ; ( void ) close ( sp -> sd_fd ) ; list_remove ( & spoolss_splist . sp_list , sp ) ; param -> status = ERROR_SUCCESS ; break ; } sp = list_next ( & spoolss_splist . sp_list , sp ) ; } ( void ) rw_unlock ( & spoolss_splist . sp_rwl ) ; if ( param -> status != ERROR_SUCCESS ) { smb_tracef ( "spoolss_s_EndDocPrinter: document not found" ) ; } return ( NDR_DRC_OK ) ; } 