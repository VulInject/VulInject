static int cx88_alsa_dma_init ( struct cx88_audio_dev * chip , int nr_pages ) { struct cx88_audio_buffer * buf = chip -> buf ; struct page * pg ; int i ; buf -> vaddr = vmalloc_32 ( nr_pages << PAGE_SHIFT ) ; if ( ! buf -> vaddr ) { dprintk ( 1 , "vmalloc_32(%d pages) failed\n" , nr_pages ) ; return - ENOMEM ; } dprintk ( 1 , "vmalloc is at addr 0x%08lx, size=%d\n" , ( unsigned long ) buf -> vaddr , nr_pages << PAGE_SHIFT ) ; memset ( buf -> vaddr , 0 , nr_pages << PAGE_SHIFT ) ; buf -> nr_pages = nr_pages ; buf -> sglist = vzalloc ( buf -> nr_pages * sizeof ( * buf -> sglist ) ) ; if ( ! buf -> sglist ) { vzalloc_err } sg_init_table ( buf -> sglist , buf -> nr_pages ) ; for ( i = 0 ; i < buf -> nr_pages ; i ++ ) { pg = vmalloc_to_page ( buf -> vaddr + i * PAGE_SIZE ) ; if ( ! pg ) { vmalloc_to_page_err } sg_set_page ( & buf -> sglist [ i ] , pg , PAGE_SIZE , 0 ) ; } return 0 ; vmalloc_to_page_err vfree ( buf -> sglist ) ; buf -> sglist = NULL ; vzalloc_err vfree ( buf -> vaddr ) ; return - ENOMEM ; } 