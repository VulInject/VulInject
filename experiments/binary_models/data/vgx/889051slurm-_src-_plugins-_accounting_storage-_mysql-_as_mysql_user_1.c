extern List as_mysql_remove_coord ( mysql_conn_t * mysql_conn , uint32_t uid , List acct_list , slurmdb_user_cond_t * user_cond ) { char * query = NULL , * object = NULL , * extra = NULL , * last_user = NULL ; char * user_name = NULL ; time_t now = time ( NULL ) ; int set = 0 , is_admin = 0 , rc = SLURM_SUCCESS ; ListIterator itr = NULL ; slurmdb_user_rec_t * user_rec = NULL ; List ret_list = NULL ; List user_list = NULL ; MYSQL_RES * result = NULL ; MYSQL_ROW row ; slurmdb_user_rec_t user ; if ( ! user_cond && ! acct_list ) { error ( "we need something to remove" ) ; return NULL ; } if ( user_cond && user_cond -> assoc_cond ) { user_list = user_cond -> assoc_cond -> user_list ; } if ( check_connection ( mysql_conn ) != SLURM_SUCCESS ) { return NULL ; } memset ( & user , 0 , sizeof ( slurmdb_user_rec_t ) ) ; user . uid = uid ; if ( ! ( is_admin = is_user_min_admin_level ( mysql_conn , uid , SLURMDB_ADMIN_OPERATOR ) ) ) { if ( ! is_user_any_coord ( mysql_conn , & user ) ) { error ( "Only admins/coordinators can " "remove coordinators" ) ; errno = ESLURM_ACCESS_DENIED ; return NULL ; } } if ( user_list && list_count ( user_list ) ) { set = 0 ; if ( extra ) { xstrcat ( extra , "&&(" ) ; } else { xstrcat ( extra , "(" ) ; } itr = list_iterator_create ( user_list ) ; while ( ( object = list_next ( itr ) ) ) { if ( ! object [ 0 ] ) { continue ; } if ( set ) { xstrcat ( extra , " || " ) ; } xstrfmtcat ( extra , "user='%s'" , object ) ; set = 1 ; } list_iterator_destroy ( itr ) ; xstrcat ( extra , ")" ) ; } if ( acct_list && list_count ( acct_list ) ) { set = 0 ; if ( extra ) { xstrcat ( extra , "&&(" ) ; } else { xstrcat ( extra , "(" ) ; } itr = list_iterator_create ( acct_list ) ; while ( ( object = list_next ( itr ) ) ) { if ( ! object [ 0 ] ) { continue ; } if ( set ) { xstrcat ( extra , " || " ) ; } xstrfmtcat ( extra , "acct='%s'" , object ) ; set = 1 ; } list_iterator_destroy ( itr ) ; xstrcat ( extra , ")" ) ; } if ( ! extra ) { errno = SLURM_ERROR ; DB_DEBUG ( DB_ASSOC , mysql_conn -> conn , "No conditions given" ) ; return NULL ; } query = xstrdup_printf ( "select user, acct from %s where deleted=0&&%s order by user" , acct_coord_table , extra ) ; DB_DEBUG ( DB_ASSOC , mysql_conn -> conn , "query\n%s" , query ) ; if ( ! ( result = mysql_db_query_ret ( mysql_conn , query , 0 ) ) ) { xfree ( extra ) ; errno = SLURM_ERROR ; return NULL ; } xfree ( query ) ; ret_list = list_create ( xfree_ptr ) ; user_list = list_create ( xfree_ptr ) ; while ( ( row = mysql_fetch_row ( result ) ) ) { if ( ! is_admin ) { slurmdb_coord_rec_t * coord = NULL ; if ( ! user . coord_accts ) { error ( "We are here with no coord accts" ) ; errno = ESLURM_ACCESS_DENIED ; FREE_NULL_LIST ( ret_list ) ; FREE_NULL_LIST ( user_list ) ; xfree ( extra ) ; mysql_free_result ( result ) ; return NULL ; } itr = list_iterator_create ( user . coord_accts ) ; while ( ( coord = list_next ( itr ) ) ) { if ( ! xstrcasecmp ( coord -> name , row [ 1 ] ) ) { break ; } } list_iterator_destroy ( itr ) ; if ( ! coord ) { error ( "User %s(%d) does not have the " "ability to change this account (%s)" , user . name , user . uid , row [ 1 ] ) ; errno = ESLURM_ACCESS_DENIED ; FREE_NULL_LIST ( ret_list ) ; FREE_NULL_LIST ( user_list ) ; xfree ( extra ) ; mysql_free_result ( result ) ; return NULL ; } } if ( ! last_user || xstrcasecmp ( last_user , row [ 0 ] ) ) { list_append ( user_list , xstrdup ( row [ 0 ] ) ) ; last_user = row [ 0 ] ; } list_append ( ret_list , xstrdup_printf ( "U = %-9s A = %-10s" , row [ 0 ] , row [ 1 ] ) ) ; } mysql_free_result ( result ) ; user_name = uid_to_string ( ( uid_t ) uid ) ; rc = remove_common ( mysql_conn , DBD_REMOVE_ACCOUNT_COORDS , now , user_name , acct_coord_table , extra , NULL , NULL , NULL , NULL , NULL ) ; xfree ( user_name ) ; xfree ( extra ) ; if ( rc == SLURM_ERROR ) { FREE_NULL_LIST ( ret_list ) ; FREE_NULL_LIST ( user_list ) ; errno = SLURM_ERROR ; return NULL ; } itr = list_iterator_create ( user_list ) ; while ( ( last_user = list_next ( itr ) ) ) { user_rec = xmalloc ( sizeof ( slurmdb_user_rec_t ) ) ; user_rec -> name = xstrdup ( last_user ) ; _get_user_coords ( mysql_conn , user_rec ) ; if ( addto_update_list ( mysql_conn -> update_list , SLURMDB_REMOVE_COORD , user_rec ) != SLURM_SUCCESS ) { slurmdb_destroy_user_rec ( user_rec ) ; } } list_iterator_destroy ( itr ) ; FREE_NULL_LIST ( user_list ) ; return ret_list ; } 