int gdTestImageCompareToImage ( const char * file , unsigned int line , const char * message , gdImagePtr expected , gdImagePtr actual ) { unsigned int width_a , height_a ; unsigned int width_b , height_b ; gdImagePtr surface_diff = NULL ; CuTestImageResult result = { 0 0 } ; ( void ) message ; if ( ! actual ) { _gdTestErrorMsg ( file , line , "Image is NULL\n" ) ; fail } width_a = gdImageSX ( expected ) ; height_a = gdImageSY ( expected ) ; width_b = gdImageSX ( actual ) ; height_b = gdImageSY ( actual ) ; if ( width_a != width_b || height_a != height_b ) { _gdTestErrorMsg ( file , line , "Image size mismatch: (%ux%u) vs. (%ux%u)\n       for %s vs. buffer\n" , width_a , height_a , width_b , height_b , file ) ; fail } surface_diff = gdImageCreateTrueColor ( width_a , height_a ) ; if ( surface_diff == NULL ) { fail } gdTestImageDiff ( expected , actual , surface_diff , & result ) ; if ( result . pixels_changed > 0 ) { char file_diff [ 255 ] ; char file_out [ 1024 ] ; FILE * fp ; int len , p ; _gdTestErrorMsg ( file , line , "Total pixels changed: %d with a maximum channel difference of %d.\n" , result . pixels_changed , result . max_diff ) ; p = len = strlen ( file ) ; p -- ; while ( p > 0 && ( file [ p ] != '/' && file [ p ] != '\\' ) ) { p -- ; } sprintf ( file_diff , "%s_%u_diff.png" , file + p + 1 , line ) ; sprintf ( file_out , "%s_%u_out.png" , file + p + 1 , line ) ; fp = fopen ( file_diff , "wb" ) ; if ( ! fp ) { fail } gdImagePng ( surface_diff , fp ) ; fclose ( fp , NULL ) ; gdImageDestroy ( surface_diff ) ; surface_diff = NULL ; fp = fopen ( file_out , "wb" ) ; if ( ! fp ) { fail } gdImagePng ( actual , fp ) ; fclose ( fp ) ; return 0 ; } else { if ( surface_diff ) { gdImageDestroy ( surface_diff ) ; surface_diff = NULL ; } return 1 ; } fail if ( surface_diff ) { gdImageDestroy ( surface_diff ) ; } return 1 ; } 