static unsigned int mx51_ecspi_clkdiv ( struct spi_imx_data * spi_imx , unsigned int fspi , unsigned int * fres ) { unsigned int pre , post ; unsigned int fin = spi_imx -> spi_clk ; post = fls ( fin ) - fls ( fspi ) ; if ( fin > fspi << post ) { post ++ ; } post = max ( 4U , post ) - 4 ; if ( unlikely ( post > 0xf ) ) { dev_err ( spi_imx -> dev , "cannot set clock freq: %u (base freq: %u)\n" , fspi , fin ) ; return 0xff ; } pre = DIV_ROUND_UP ( fin , fspi << post ) - 1 ; dev_dbg ( spi_imx -> dev , "%s: fin: %u, fspi: %u, post: %u, pre: %u\n" , __func__ , fin , fspi , post , pre ) ; * fres = ( fin / ( pre + 1 ) ) >> post ; return ( pre << MX51_ECSPI_CTRL_PREDIV_OFFSET ) | ( post << MX51_ECSPI_CTRL_POSTDIV_OFFSET ) ; } 