static int stx104_read_raw ( struct iio_dev * indio_dev , struct iio_chan_spec const * chan , int * val , int * val2 , long mask ) { struct stx104_iio * const priv = iio_priv ( indio_dev ) ; int adc_config ; int adbu ; int gain ; switch ( mask ) { case IIO_CHAN_INFO_HARDWAREGAIN : adc_config = inb ( priv -> base + 11 ) ; gain = adc_config & 0x3 ; * val = 1 << gain ; return IIO_VAL_INT ; case IIO_CHAN_INFO_RAW : if ( chan -> output ) { * val = priv -> chan_out_states [ chan -> channel ] ; return IIO_VAL_INT ; } outb ( chan -> channel | ( chan -> channel << 4 ) , priv -> base + 2 ) ; outb ( 0 , priv -> base ) ; while ( inb ( priv -> base + 8 ) & BIT ( 7 ) ) { } * val = inw ( priv -> base ) ; return IIO_VAL_INT ; case IIO_CHAN_INFO_OFFSET : adc_config = inb ( priv -> base + 11 ) ; adbu = ! ( adc_config & BIT ( 2 ) ) ; * val = - 32768 * adbu ; return IIO_VAL_INT ; case IIO_CHAN_INFO_SCALE : adc_config = inb ( priv -> base + 11 ) ; adbu = ! ( adc_config & BIT ( 2 ) ) ; gain = adc_config & 0x3 ; * val = 5 ; * val2 = 15 - adbu + gain ; return IIO_VAL_FRACTIONAL_LOG2 ; } return - EINVAL ; } 