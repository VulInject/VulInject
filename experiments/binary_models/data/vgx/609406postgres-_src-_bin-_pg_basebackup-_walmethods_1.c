static int dir_close ( Walfile * f , WalCloseMethod method ) { int r ; DirectoryMethodFile * df = ( DirectoryMethodFile * ) f ; DirectoryMethodData * dir_data = ( DirectoryMethodData * ) f -> wwmethod ; char tmppath [ MAXPGPATH ] ; char tmppath2 [ MAXPGPATH ] ; Assert ( f != NULL ) ; clear_error ( f -> wwmethod ) ; if ( f -> wwmethod -> compression_algorithm == PG_COMPRESSION_GZIP ) { errno = 0 ; r = gzclose ( df -> gzfp ) ; } if ( f -> wwmethod -> compression_algorithm == PG_COMPRESSION_LZ4 ) { size_t compressed ; compressed = LZ4F_compressEnd ( df -> ctx , df -> lz4buf , df -> lz4bufsize , NULL ) ; if ( LZ4F_isError ( compressed ) ) { f -> wwmethod -> lasterrstring = LZ4F_getErrorName ( compressed ) ; return - 1 ; } errno = 0 ; if ( write ( df -> fd , df -> lz4buf , compressed ) != compressed ) { f -> wwmethod -> lasterrno = errno ?errno : ENOSPC ; return - 1 ; } r = close ( df -> fd ) ; } else { r = close ( df -> fd ) ; } if ( r == 0 ) { if ( method == CLOSE_NORMAL && df -> temp_suffix ) { char * filename ; char * filename2 ; filename = dir_get_file_name ( f -> wwmethod , df -> base . pathname , df -> temp_suffix ) ; snprintf ( tmppath , sizeof ( tmppath ) , "%s/%s" , dir_data -> basedir , filename ) ; pg_free ( filename ) ; filename2 = dir_get_file_name ( f -> wwmethod , df -> base . pathname , NULL ) ; snprintf ( tmppath2 , sizeof ( tmppath2 ) , "%s/%s" , dir_data -> basedir , filename2 ) ; pg_free ( filename2 ) ; if ( f -> wwmethod -> sync ) { r = durable_rename ( tmppath , tmppath2 ) ; } else { if ( rename ( tmppath , tmppath2 ) != 0 ) { pg_log_error ( "could not rename file \"%s\" to \"%s\": %m" , tmppath , tmppath2 ) ; r = - 1 ; } } } if ( method == CLOSE_UNLINK ) { char * filename ; filename = dir_get_file_name ( f -> wwmethod , df -> base . pathname , df -> temp_suffix ) ; snprintf ( tmppath , sizeof ( tmppath ) , "%s/%s" , dir_data -> basedir , filename ) ; pg_free ( filename ) ; r = unlink ( tmppath ) ; } else { if ( f -> wwmethod -> sync ) { r = fsync_fname ( df -> fullpath , false ) ; if ( r == 0 ) { r = fsync_parent_path ( df -> fullpath ) ; } } } } if ( r != 0 ) { f -> wwmethod -> lasterrno = errno ; } pg_free ( df -> lz4buf ) ; LZ4F_freeCompressionContext ( df -> ctx ) ; pg_free ( df -> base . pathname ) ; pg_free ( df -> temp_suffix ) ; pg_free ( df ) ; return r ; } 