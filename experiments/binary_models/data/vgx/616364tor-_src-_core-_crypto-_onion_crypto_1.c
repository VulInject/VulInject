int onion_skin_create ( int type , const extend_info_t * node , onion_handshake_state_t * state_out , uint8_t * onion_skin_out , size_t onion_skin_out_maxlen ) { int r = - 1 ; switch ( type ) { case ONION_HANDSHAKE_TYPE_TAP : if ( onion_skin_out_maxlen < TAP_ONIONSKIN_CHALLENGE_LEN ) { return - 1 ; } if ( ! node -> onion_key ) { return - 1 ; } if ( onion_skin_TAP_create ( node -> onion_key , & state_out -> u . tap , ( char * ) onion_skin_out ) < 0 ) { return - 1 ; } r = TAP_ONIONSKIN_CHALLENGE_LEN ; break ; case ONION_HANDSHAKE_TYPE_FAST : if ( fast_onionskin_create ( & state_out -> u . fast , onion_skin_out ) < 0 ) { return - 1 ; } r = CREATE_FAST_LEN ; break ; case ONION_HANDSHAKE_TYPE_NTOR : if ( onion_skin_out_maxlen < NTOR_ONIONSKIN_LEN ) { return - 1 ; } if ( ! extend_info_supports_ntor ( node ) ) { return - 1 ; } if ( onion_skin_ntor_create ( ( const uint8_t * ) node -> identity_digest , & node -> curve25519_onion_key , & state_out -> u . ntor , onion_skin_out ) < 0 ) { return - 1 ; } r = NTOR_ONIONSKIN_LEN ; break ; case ONION_HANDSHAKE_TYPE_NTOR_V3 : if ( ! extend_info_supports_ntor_v3 ( node ) ) { return - 1 ; } if ( ed25519_public_key_is_zero ( & node -> ed_identity ) ) { return - 1 ; } size_t msg_len = 0 ; uint8_t * msg = NULL ; if ( client_circ_negotiation_message ( node , & msg , & msg_len ) < 0 ) { return - 1 ; } uint8_t * onion_skin = NULL ; int onion_skin_len = 0 ; int status = onion_skin_ntor3_create ( & node -> ed_identity , & node -> curve25519_onion_key , NTOR3_VERIFICATION_ARGS , msg , msg_len , & state_out -> u . ntor3 , & onion_skin , & onion_skin_len ) ; tor_free ( msg ) ; if ( status < 0 ) { return - 1 ; } if ( onion_skin_len > onion_skin_out_maxlen ) { tor_free ( onion_skin ) ; return - 1 ; } memcpy ( onion_skin_out , onion_skin , onion_skin_len ) ; tor_free ( onion_skin ) ; r = ( int ) onion_skin_len ; break ; default : log_warn ( LD_BUG , "called with unknown handshake state type %d" , type ) ; tor_fragile_assert ( ) ; r = - 1 ; } if ( r > 0 ) { state_out -> tag = ( uint16_t ) type ; } return r ; } 