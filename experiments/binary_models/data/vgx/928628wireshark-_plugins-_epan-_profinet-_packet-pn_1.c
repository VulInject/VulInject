char * pn_fgets ( char * str , int n , FILE * stream , wmem_allocator_t * scope ) { const char XML_COMMENT_START [ ] "<!--" ; ; const char XML_COMMENT_END [ ] "-->" ; ; char * retVal = fgets ( str , n , stream ) ; char * comment_start = strstr ( str , XML_COMMENT_START ) ; char * common_start_end = comment_start + sizeof ( XML_COMMENT_START ) - 1 ; if ( comment_start == NULL ) { return retVal ; } * comment_start = '\0' ; size_t used_space = comment_start - str ; size_t remaining_space = n - used_space ; char * comment_end = strstr ( common_start_end , XML_COMMENT_END ) ; if ( comment_end == NULL ) { char * temp = ( char * ) wmem_alloc ( scope , MAX_LINE_LENGTH ) ; char * next_line = temp ; while ( ( comment_end == NULL ) && ( next_line != NULL ) ) { next_line = fgets ( temp , MAX_LINE_LENGTH , stream ) ; if ( next_line == NULL ) { break ; } comment_end = strstr ( next_line , XML_COMMENT_END ) ; } } if ( comment_end == NULL ) { return retVal ; } char * comment_end_end = comment_end + sizeof ( XML_COMMENT_END ) - 1 ; size_t remaining_bytes = strlen ( comment_end_end ) + 1 ; if ( remaining_bytes < remaining_space ) { ( void ) g_strlcat ( str , comment_end_end , n ) ; } else { fseek ( stream , - ( long ) ( remaining_bytes ) , SEEK_CUR ) ; } return retVal ; } 