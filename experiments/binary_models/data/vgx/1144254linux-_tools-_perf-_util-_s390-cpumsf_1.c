static bool s390_cpumsf_make_event ( size_t pos , struct hws_basic_entry * basic , struct s390_cpumsf_queue * sfq ) { struct perf_sample sample = { . ip = basic -> ia . pid = basic -> hpp & S390_LPP_PID_MASK . tid = basic -> hpp & S390_LPP_PID_MASK . cpumode = PERF_RECORD_MISC_CPUMODE_UNKNOWN . cpu = sfq -> cpu . period = 1 } ; union perf_event event ; if ( basic -> CL == 1 ) { sample . cpumode = basic -> P ?PERF_RECORD_MISC_USER : PERF_RECORD_MISC_KERNEL ; } if ( basic -> CL == 2 ) { sample . cpumode = basic -> P ?PERF_RECORD_MISC_GUEST_USER : PERF_RECORD_MISC_GUEST_KERNEL ; } if ( basic -> gpp || basic -> prim_asn != 0xffff ) { sample . cpumode = basic -> P ?PERF_RECORD_MISC_GUEST_USER : PERF_RECORD_MISC_GUEST_KERNEL ; } else { sample . cpumode = basic -> P ?PERF_RECORD_MISC_USER : PERF_RECORD_MISC_KERNEL ; } event . sample . header . type = PERF_RECORD_SAMPLE ; event . sample . header . misc = sample . cpumode ; event . sample . header . size = sizeof ( perf_event_header ) ; pr_debug4 ( "%s pos:%#zx ip:%#" PRIx64 " P:%d CL:%d pid:%d.%d cpumode:%d cpu:%d\n" , __func__ , pos , sample . ip , basic -> P , basic -> CL , sample . pid , sample . tid , sample . cpumode , sample . cpu ) ; if ( perf_session__deliver_synth_event ( sfq -> sf -> session , & event , & sample ) ) { pr_err ( "s390 Auxiliary Trace: failed to deliver event\n" ) ; return false ; } return true ; } 