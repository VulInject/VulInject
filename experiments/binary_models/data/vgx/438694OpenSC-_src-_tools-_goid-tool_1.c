int paccess_get_security_attributes ( struct sc_context * ctx , const char * ac , int * chatbits , size_t chatbits_len , u8 sec_attr [ 2 ] ) { int ok = 0 ; if ( ! ac || 0 == strcmp ( ac , "never" ) ) { sec_attr [ 0 ] |= 0xFF ; } if ( 0 == strcmp ( ac , "always" ) ) { } else { size_t i ; if ( 0 == strcmp ( ac , "ta" ) ) { sec_attr [ 0 ] |= 0xA0 ; } if ( 0 == strcmp ( ac , "sm" ) ) { sec_attr [ 0 ] |= 0xC0 ; } else { SC_TEST_GOTO_ERR ( ctx , SC_LOG_DEBUG_VERBOSE_TOOL , SC_ERROR_INVALID_ARGUMENTS , "unknown access condition." ) ; } for ( i = 0 ; i < chatbits_len ; i ++ ) { u8 byte = chatbits [ i ] / 8 ; u8 bit = chatbits [ i ] % 8 + 1 ; if ( byte > 5 ) { SC_TEST_GOTO_ERR ( ctx , SC_LOG_DEBUG_VERBOSE_TOOL , SC_ERROR_INVALID_ARGUMENTS , "Only CHAT bits with index 0..39 are available." ) ; } sec_attr [ 0 ] |= 0x8 | byte ; sec_attr [ 1 ] |= bit ; } } ok = 1 ; err return ok ; } 