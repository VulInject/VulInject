static CK_RV soft_build_certificate_object ( CK_ATTRIBUTE_PTR template , CK_ULONG ulAttrNum , soft_object_t * new_object , CK_CERTIFICATE_TYPE cert_type ) { uint64_t attr_mask = 0 ; CK_RV rv = CKR_OK ; CK_ULONG i ; int owner_set = 0 ; int value_set = 0 ; int subject_set = 0 ; certificate_obj_t * cert ; CK_CERTIFICATE_TYPE certtype = cert_type ; CK_ATTRIBUTE string_tmp ; int isLabel = 0 ; uchar_t object_type = 0 ; for ( i = 0 ; i < ulAttrNum ; i ++ ) { switch ( [ i ] . type ) { case CKA_CERTIFICATE_TYPE : certtype = * ( ( CK_CERTIFICATE_TYPE * ) ; break ; case CKA_SUBJECT : subject_set = 1 ; break ; case CKA_OWNER : owner_set = 1 ; break ; case CKA_VALUE : value_set = 1 ; break ; } } if ( certtype != CKC_X_509 && certtype != CKC_X_509_ATTR_CERT ) { return ( CKR_TEMPLATE_INCOMPLETE ) ; } if ( certtype == CKC_X_509 && ( ! subject_set || ! value_set ) ) { return ( CKR_TEMPLATE_INCOMPLETE ) ; } if ( certtype == CKC_X_509_ATTR_CERT && ( ! owner_set || ! value_set ) ) { return ( CKR_TEMPLATE_INCOMPLETE ) ; } string_tmp . pValue = NULL ; cert = calloc ( 1 , sizeof ( certificate_obj_t ) ) ; cert -> certificate_type = certtype ; for ( i = 0 ; i < ulAttrNum ; i ++ ) { switch ( certtype ) { case CKC_X_509 : switch ( [ i ] . type ) { case CKA_SUBJECT : rv = get_cert_attr_from_template ( , ) ; break ; case CKA_VALUE : rv = get_cert_attr_from_template ( , ) ; break ; case CKA_LABEL : isLabel = 1 ; rv = get_string_from_template ( , ) ; if ( rv != CKR_OK ) { fail_cleanup } break ; case CKA_ID : case CKA_ISSUER : case CKA_SERIAL_NUMBER : rv = soft_add_extra_attr ( , ) ; break ; case CKA_MODIFIABLE : if ( ( * ( CK_BBOOL * ) == B_FALSE ; ) attr_mask |= NOT_MODIFIABLE_BOOL_ON ) break ; case CKA_CERTIFICATE_TYPE : break ; default : rv = soft_parse_common_attrs ( , ) ; if ( rv != CKR_OK ) { fail_cleanup } } break ; case CKC_X_509_ATTR_CERT : switch ( [ i ] . type ) { case CKA_OWNER : rv = get_cert_attr_from_template ( , ) ; break ; case CKA_VALUE : rv = get_cert_attr_from_template ( , ) ; break ; case CKA_LABEL : isLabel = 1 ; rv = get_string_from_template ( , ) ; if ( rv != CKR_OK ) { fail_cleanup } break ; case CKA_SERIAL_NUMBER : case CKA_AC_ISSUER : case CKA_ATTR_TYPES : rv = soft_add_extra_attr ( , ) ; break ; case CKA_MODIFIABLE : if ( ( * ( CK_BBOOL * ) == B_FALSE ; ) attr_mask |= NOT_MODIFIABLE_BOOL_ON ) break ; case CKA_CERTIFICATE_TYPE : break ; default : rv = soft_parse_common_attrs ( , ) ; if ( rv != CKR_OK ) { fail_cleanup } break ; } break ; default : rv = CKR_TEMPLATE_INCOMPLETE ; break ; } } if ( rv == CKR_OK ) { new_object -> object_class_u . certificate = cert ; new_object -> class = CKO_CERTIFICATE ; new_object -> object_type = object_type ; new_object -> cert_type = certtype ; new_object -> bool_attr_mask = attr_mask ; if ( isLabel ) { rv = soft_add_extra_attr ( & string_tmp , new_object ) ; if ( rv != CKR_OK ) { fail_cleanup } string_attr_cleanup ( & string_tmp ) ; } } fail_cleanup if ( rv != CKR_OK ) { soft_cleanup_cert_object ( new_object ) ; } return ( rv ) ; } 