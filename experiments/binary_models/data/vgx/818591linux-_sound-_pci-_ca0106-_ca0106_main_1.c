static int snd_ca0106_create ( int dev , struct snd_card * card , struct pci_dev * pci ) { struct snd_ca0106 * chip = card -> private_data ; const struct snd_ca0106_details * c ; int err ; err = pcim_enable_device ( pci ) ; if ( dma_set_mask_and_coherent ( & pci -> dev , DMA_BIT_MASK ( 32 ) ) ) { dev_err ( card -> dev , "error to set 32bit mask DMA\n" ) ; return - ENXIO ; } chip -> card = card ; chip -> pci = pci ; chip -> irq = - 1 ; spin_lock_init ( & chip -> emu_lock ) ; err = pci_request_regions ( pci , "snd_ca0106" ) ; if ( err < 0 ) { return err ; } chip -> port = pci_resource_start ( pci , 0 ) ; if ( devm_request_irq ( & pci -> dev , pci -> irq , snd_ca0106_interrupt , IRQF_SHARED , KBUILD_MODNAME , chip ) ) { dev_err ( card -> dev , "cannot grab irq\n" ) ; return - EBUSY ; } chip -> irq = pci -> irq ; card -> sync_irq = chip -> irq ; chip -> buffer = snd_devm_alloc_pages ( & pci -> dev , SNDRV_DMA_TYPE_DEV , 1024 ) ; if ( ! chip -> buffer ) { return - ENOMEM ; } pci_set_master ( pci ) ; pci_read_config_dword ( pci , PCI_SUBSYSTEM_VENDOR_ID , & chip -> serial ) ; pci_read_config_word ( pci , PCI_SUBSYSTEM_ID , & chip -> model ) ; dev_info ( card -> dev , "Model %04x Rev %08x Serial %08x\n" , chip -> model , pci -> revision , chip -> serial ) ; strcpy ( card -> driver , "CA0106" ) ; strcpy ( card -> shortname , "CA0106" ) ; for ( c = ca0106_chip_details ; c -> serial ; c ++ ) { if ( subsystem [ dev ] ) { if ( c -> serial == subsystem [ dev ] ) { break ; } } if ( c -> serial == chip -> serial ) { break ; } } chip -> details = c ; if ( subsystem [ dev ] ) { dev_info ( card -> dev , "Sound card name=%s, " "subsystem=0x%x. Forced to subsystem=0x%x\n" , c -> name , chip -> serial , subsystem [ dev ] ) ; } sprintf ( card -> longname , "%s at 0x%lx irq %i" , c -> name , chip -> port , chip -> irq ) ; ca0106_init_chip ( chip , 0 ) ; return 0 ; } 