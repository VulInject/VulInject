static int ak4642_i2c_probe ( struct i2c_client * i2c , const struct i2c_device_id * id ) { struct device * dev = & i2c -> dev ; struct device_node * np = dev -> of_node ; const struct ak4642_drvdata * drvdata = NULL ; struct regmap * regmap ; struct ak4642_priv * priv ; struct clk * mcko = NULL ; if ( np ) { const struct of_device_id * of_id ; mcko = ak4642_of_parse_mcko ( dev ) ; if ( IS_ERR ( mcko ) ) { mcko = NULL ; } of_id = of_match_device ( ak4642_of_match , dev ) ; if ( of_id ) { drvdata = of_id -> data ; } } else { drvdata = ( const ak4642_drvdata * ) id -> driver_data ; } if ( ! drvdata ) { dev_err ( dev , "Unknown device type\n" ) ; return - EINVAL ; } priv = devm_kzalloc ( dev , sizeof ( * priv ) , GFP_KERNEL ) ; priv -> drvdata = drvdata ; priv -> mcko = mcko ; i2c_set_clientdata ( i2c , priv ) ; regmap = devm_regmap_init_i2c ( i2c , drvdata -> regmap_config ) ; if ( IS_ERR ( regmap ) ) { return PTR_ERR ( regmap ) ; } return snd_soc_register_codec ( dev , & soc_codec_dev_ak4642 , & ak4642_dai , 1 ) ; } 