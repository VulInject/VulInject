void smbd_user_auth_logoff ( uint32_t audit_sid ) { smb_audit_t * entry ; adt_session_data_t * ah ; adt_event_data_t * event ; struct passwd pw ; char buf [ NSS_LINELEN_PASSWD ] ; if ( ( entry = smbd_audit_unlink ( audit_sid ) ) == NULL ) { return ; } if ( IDMAP_ID_IS_EPHEMERAL ( entry -> sa_uid ) ) { smb_autohome_remove ( entry -> sa_username ) ; } else { if ( getpwuid_r ( entry -> sa_uid , & pw , buf , sizeof ( buf ) ) == NULL ) { return ; } smb_autohome_remove ( pw . pw_name ) ; } ah = entry -> sa_handle ; if ( ( event = adt_alloc_event ( ah , ADT_smbd_logoff ) ) == NULL ) { syslog ( LOG_AUTH | LOG_ALERT , "adt_alloc_event(ADT_smbd_logoff): %m" ) ; } else { event -> adt_smbd_logoff . domain = entry -> sa_domain ; event -> adt_smbd_logoff . username = entry -> sa_username ; if ( adt_put_event ( event , ADT_SUCCESS , ADT_SUCCESS ) ) { syslog ( LOG_AUTH | LOG_ALERT , "adt_put_event: %m" ) ; } adt_free_event ( event ) ; } ( void ) adt_end_session ( ah ) ; free ( entry -> sa_username ) ; free ( entry ) ; } 