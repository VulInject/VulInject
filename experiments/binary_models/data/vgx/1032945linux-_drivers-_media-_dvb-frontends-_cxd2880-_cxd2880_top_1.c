static int cxd2880_get_stats ( struct dvb_frontend * fe , enum fe_status status ) { struct cxd2880_priv * priv = NULL ; struct dtv_frontend_properties * c = NULL ; u32 pre_bit_err = 0 , pre_bit_count = 0 ; u32 post_bit_err = 0 , post_bit_count = 0 ; u32 block_err = 0 , block_count = 0 ; int ret ; if ( ! fe ) { pr_err ( "invalid arg\n" ) ; return - EINVAL ; } priv = fe -> demodulator_priv ; c = & fe -> dtv_property_cache ; if ( ! ( status & FE_HAS_LOCK ) || ! ( status & FE_HAS_CARRIER ) ) { c -> pre_bit_error . len = 1 ; c -> pre_bit_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> pre_bit_count . len = 1 ; c -> pre_bit_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> post_bit_error . len = 1 ; c -> post_bit_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> post_bit_count . len = 1 ; c -> post_bit_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> block_error . len = 1 ; c -> block_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> block_count . len = 1 ; c -> block_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; return 0 ; } if ( time_after ( jiffies , priv -> pre_ber_update ) ) { priv -> pre_ber_update = jiffies + msecs_to_jiffies ( priv -> pre_ber_interval ) ; if ( c -> delivery_system == SYS_DVBT ) { ret = cxd2880_pre_bit_err_t ( & priv -> tnrdmd , & pre_bit_err , & pre_bit_count ) ; mutex_unlock ( priv -> spi_mutex ) ; } if ( c -> delivery_system == SYS_DVBT2 ) { mutex_lock ( priv -> spi_mutex ) ; ret = cxd2880_pre_bit_err_t2 ( & priv -> tnrdmd , & pre_bit_err , & pre_bit_count ) ; mutex_unlock ( priv -> spi_mutex ) ; } else { return - EINVAL ; } if ( ! ret ) { c -> pre_bit_error . len = 1 ; c -> pre_bit_error . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> pre_bit_error . stat [ 0 ] . uvalue += pre_bit_err ; c -> pre_bit_count . len = 1 ; c -> pre_bit_count . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> pre_bit_count . stat [ 0 ] . uvalue += pre_bit_count ; } else { c -> pre_bit_error . len = 1 ; c -> pre_bit_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> pre_bit_count . len = 1 ; c -> pre_bit_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; pr_debug ( "pre_bit_error_t failed %d\n" , ret ) ; } } if ( time_after ( jiffies , priv -> post_ber_update ) ) { priv -> post_ber_update = jiffies + msecs_to_jiffies ( priv -> post_ber_interval ) ; if ( c -> delivery_system == SYS_DVBT ) { mutex_lock ( priv -> spi_mutex ) ; ret = cxd2880_post_bit_err_t ( & priv -> tnrdmd , & post_bit_err , & post_bit_count ) ; mutex_unlock ( priv -> spi_mutex ) ; } if ( c -> delivery_system == SYS_DVBT2 ) { mutex_lock ( priv -> spi_mutex ) ; ret = cxd2880_post_bit_err_t2 ( & priv -> tnrdmd , & post_bit_err , & post_bit_count ) ; mutex_unlock ( priv -> spi_mutex ) ; } else { return - EINVAL ; } if ( ! ret ) { c -> post_bit_error . len = 1 ; c -> post_bit_error . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> post_bit_error . stat [ 0 ] . uvalue += post_bit_err ; c -> post_bit_count . len = 1 ; c -> post_bit_count . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> post_bit_count . stat [ 0 ] . uvalue += post_bit_count ; } else { c -> post_bit_error . len = 1 ; c -> post_bit_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> post_bit_count . len = 1 ; c -> post_bit_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; pr_debug ( "post_bit_err_t %d\n" , ret ) ; } } if ( time_after ( jiffies , priv -> ucblock_update ) ) { priv -> ucblock_update = jiffies + msecs_to_jiffies ( priv -> ucblock_interval ) ; if ( c -> delivery_system == SYS_DVBT ) { mutex_lock ( priv -> spi_mutex ) ; ret = cxd2880_read_block_err_t ( & priv -> tnrdmd , & block_err , & block_count ) ; mutex_unlock ( priv -> spi_mutex ) ; } if ( c -> delivery_system == SYS_DVBT2 ) { mutex_lock ( priv -> spi_mutex ) ; ret = cxd2880_read_block_err_t2 ( & priv -> tnrdmd , & block_err , & block_count ) ; mutex_unlock ( priv -> spi_mutex ) ; } else { return - EINVAL ; } if ( ! ret ) { c -> block_error . len = 1 ; c -> block_error . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> block_error . stat [ 0 ] . uvalue += block_err ; c -> block_count . len = 1 ; c -> block_count . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> block_count . stat [ 0 ] . uvalue += block_count ; } else { c -> block_error . len = 1 ; c -> block_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> block_count . len = 1 ; c -> block_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; pr_debug ( "read_block_err_t  %d\n" , ret ) ; } } return 0 ; } 