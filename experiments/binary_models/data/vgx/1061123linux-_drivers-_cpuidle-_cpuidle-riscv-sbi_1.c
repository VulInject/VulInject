static LIST_HEAD ( sbi_pd_providers ) ; static int sbi_pd_init ( struct device_node * np ) { struct generic_pm_domain * pd ; struct sbi_pd_provider * pd_provider ; struct dev_power_governor * pd_gov ; int ret = - ENOMEM ; pd = dt_idle_pd_alloc ( np , sbi_dt_parse_state_node ) ; if ( ! pd ) { out } pd_provider = kzalloc ( sizeof ( * pd_provider ) , GFP_KERNEL ) ; if ( ! pd_provider ) { free_pd } pd -> flags |= GENPD_FLAG_IRQ_SAFE | GENPD_FLAG_CPU_DOMAIN ; if ( sbi_cpuidle_use_osi ) { pd -> power_off = sbi_cpuidle_pd_power_off ; } else { pd -> flags |= GENPD_FLAG_ALWAYS_ON ; } pd_gov = pd -> states ?& pm_domain_cpu_gov : NULL ; ret = pm_genpd_init ( pd , pd_gov , false ) ; if ( ret ) { free_pd_prov } ret = of_genpd_add_provider_simple ( np , pd ) ; if ( ret ) { remove_pd } pd_provider -> node = of_node_get ( np ) ; list_add ( & pd_provider -> link , & sbi_pd_providers ) ; pr_debug ( "init PM domain %s\n" , pd -> name ) ; return 0 ; remove_pd pm_genpd_remove ( pd ) ; free_pd_prov free_pd dt_idle_pd_free ( pd ) ; out pr_err ( "failed to init PM domain ret=%d %pOF\n" , ret , np ) ; return ret ; } 