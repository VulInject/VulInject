unsigned long intel_vgpu_gma_to_gpa ( struct intel_vgpu_mm * mm , unsigned long gma ) { struct intel_vgpu * vgpu = mm -> vgpu ; struct intel_gvt * gvt = vgpu -> gvt ; const struct intel_gvt_gtt_pte_ops * pte_ops = gvt -> gtt . pte_ops ; const struct intel_gvt_gtt_gma_ops * gma_ops = gvt -> gtt . gma_ops ; unsigned long gpa = INTEL_GVT_INVALID_ADDR ; unsigned long gma_index [ 4 ] ; struct intel_gvt_gtt_entry e ; int i , levels ; int ret ; GEM_BUG_ON ( mm -> type != INTEL_GVT_MM_GGTT && mm -> type != INTEL_GVT_MM_PPGTT ) ; if ( mm -> type == INTEL_GVT_MM_GGTT ) { if ( ! vgpu_gmadr_is_valid ( vgpu , gma ) ) { err } ggtt_get_guest_entry ( mm , & e , gma_ops -> gma_to_ggtt_pte_index ( gma ) ) ; gpa = ( pte_ops -> get_pfn ( & e ) << I915_GTT_PAGE_SHIFT ) + ( gma & ~ I915_GTT_PAGE_MASK ) ; trace_gma_translate ( vgpu -> id , "ggtt" , 0 , 0 , gma , gpa ) ; } else { switch ( mm -> ppgtt_mm . root_entry_type ) { case GTT_TYPE_PPGTT_ROOT_L4_ENTRY : ppgtt_get_shadow_root_entry ( mm , & e , 0 ) ; gma_index [ 0 ] = gma_ops -> gma_to_pml4_index ( gma ) ; gma_index [ 1 ] = gma_ops -> gma_to_l4_pdp_index ( gma ) ; gma_index [ 2 ] = gma_ops -> gma_to_pde_index ( gma ) ; gma_index [ 3 ] = gma_ops -> gma_to_pte_index ( gma ) ; levels = 4 ; break ; case GTT_TYPE_PPGTT_ROOT_L3_ENTRY : ppgtt_get_shadow_root_entry ( mm , & e , gma_ops -> gma_to_l3_pdp_index ( gma ) ) ; gma_index [ 0 ] = gma_ops -> gma_to_pde_index ( gma ) ; gma_index [ 1 ] = gma_ops -> gma_to_pte_index ( gma ) ; levels = 2 ; break ; default : GEM_BUG_ON ( 1 ) ; } for ( i = 0 ; i < levels ; i ++ ) { ret = ppgtt_get_next_level_entry ( mm , & e , gma_index [ i ] , ( i == levels - 1 ) ) ; if ( ret ) { err } if ( ! pte_ops -> test_present ( & e ) ) { gvt_dbg_core ( "GMA 0x%lx is not present\n" , gma ) ; err } } gpa = ( pte_ops -> get_pfn ( & e ) << I915_GTT_PAGE_SHIFT ) + ( gma & ~ I915_GTT_PAGE_MASK ) ; trace_gma_translate ( vgpu -> id , "ppgtt" , 0 , mm -> ppgtt_mm . root_entry_type , gma , gpa ) ; } return gpa ; err gvt_vgpu_err ( "invalid mm type: %d gma %lx\n" , mm -> type , gma ) ; return INTEL_GVT_INVALID_ADDR ; } 