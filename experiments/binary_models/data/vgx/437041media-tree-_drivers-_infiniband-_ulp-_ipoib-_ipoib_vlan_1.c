int ipoib_vlan_delete ( struct net_device * pdev , unsigned short pkey ) { struct ipoib_dev_priv * ppriv , * priv , * tpriv ; struct net_device * dev = NULL ; if ( ! capable ( CAP_NET_ADMIN ) ) { return - EPERM ; } ppriv = ipoib_priv ( pdev ) ; if ( test_bit ( IPOIB_FLAG_GOING_DOWN , & ppriv -> flags ) ) { return - EPERM ; } if ( ! rtnl_trylock ( ) ) { return restart_syscall ( ) ; } down_write ( & ppriv -> vlan_rwsem ) ; list_for_each_entry_safe ( , , , ) { if ( priv -> pkey == pkey && priv -> child_type == IPOIB_LEGACY_CHILD ) { list_del ( & priv -> list ) ; dev = priv -> dev ; break ; } } up_write ( & ppriv -> vlan_rwsem ) ; if ( dev ) { ipoib_dbg ( ppriv , "delete child vlan %s\n" , dev -> name ) ; unregister_netdevice ( dev ) ; } rtnl_unlock ( ) ; if ( dev ) { return 0 ; } return - ENODEV ; } 