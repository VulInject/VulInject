static int DNP3HandleRequestLinkLayer ( DNP3State * dnp3 , const uint8_t * input , uint32_t input_len ) { SCEnter ( ) ; uint32_t processed = 0 ; while ( input_len ) { if ( input_len < sizeof ( DNP3LinkHeader ) ) { break ; } DNP3LinkHeader * header = ( DNP3LinkHeader * ) input ; if ( ! DNP3CheckStartBytes ( header ) ) { error } if ( ! DNP3CheckLinkHeaderCRC ( header ) ) { DNP3SetEvent ( dnp3 , DNP3_DECODER_EVENT_BAD_LINK_CRC ) ; error } uint32_t frame_len = DNP3CalculateLinkLength ( header -> len ) ; if ( frame_len == 0 ) { DNP3SetEvent ( dnp3 , DNP3_DECODER_EVENT_LEN_TOO_SMALL ) ; error } if ( input_len < frame_len ) { break ; } if ( ! DNP3IsUserData ( header ) ) { next } if ( ! DNP3HasUserData ( header , STREAM_TOSERVER ) ) { DNP3SetEvent ( dnp3 , DNP3_DECODER_EVENT_LEN_TOO_SMALL ) ; next } if ( ! DNP3CheckUserDataCRCs ( input + sizeof ( DNP3LinkHeader ) , frame_len - sizeof ( DNP3LinkHeader ) ) ) { DNP3SetEvent ( dnp3 , DNP3_DECODER_EVENT_BAD_TRANSPORT_CRC ) ; next } DNP3HandleUserDataRequest ( dnp3 , input , frame_len ) ; next input += frame_len ; input_len -= frame_len ; processed += frame_len ; } SCReturnInt ( processed , NULL ) ; error SCReturnInt ( - 1 ) ; } 