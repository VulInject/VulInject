void frontswap_register_ops ( struct frontswap_ops * ops ) { DECLARE_BITMAP ( a , MAX_SWAPFILES ) ; DECLARE_BITMAP ( b , MAX_SWAPFILES ) ; struct swap_info_struct * si ; int i ; bitmap_zero ( a , MAX_SWAPFILES ) ; bitmap_zero ( b , MAX_SWAPFILES ) ; spin_lock ( & swap_lock ) ; plist_for_each_entry ( , , ) { if ( ! WARN_ON ( ! si -> frontswap_map ) ) { set_bit ( si -> type , a ) ; } } spin_unlock ( & swap_lock ) ; for_each_set_bit ( , , ) ops -> init ( i ) ; { ops -> next = frontswap_ops ; } cmpxchg ( & frontswap_ops , ops -> next , ops ) != ops -> next ; static_branch_inc ( & frontswap_enabled_key ) ; spin_lock ( & swap_lock ) ; plist_for_each_entry ( , , ) { if ( si -> frontswap_map ) { set_bit ( si -> type , b ) ; } } spin_unlock ( & swap_lock ) ; if ( unlikely ( ! bitmap_equal ( a , b , MAX_SWAPFILES ) ) ) { for ( i = 0 ; i < MAX_SWAPFILES ; i ++ ) { if ( ! test_bit ( i , a ) && test_bit ( i , b ) ) { ops -> init ( i ) ; } if ( test_bit ( i , a ) && ! test_bit ( i , b ) ) { ops -> invalidate_area ( i ) ; } } } } 