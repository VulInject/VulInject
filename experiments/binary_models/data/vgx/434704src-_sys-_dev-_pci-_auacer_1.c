static void auacer_setup_chan ( struct auacer_softc * sc , struct auacer_chan * chan , uint32_t start , uint32_t size , uint32_t blksize , void * intr ( void * ) , void * arg ) { uint32_t port , slot ; uint32_t offs , val ; chan -> start = start ; chan -> ptr = 0 ; chan -> p = chan -> start ; chan -> end = chan -> start + size ; chan -> blksize = blksize ; chan -> ack = 0 ; chan -> intr = intr ; chan -> arg = arg ; auacer_add_entry ( chan , NULL ) ; auacer_add_entry ( chan ) ; port = chan -> port ; slot = ALI_PORT2SLOT ( port ) ; WRITE1 ( sc , port + ALI_OFF_CIV , 0 ) ; WRITE1 ( sc , port + ALI_OFF_LVI , ( chan -> ptr - 1 ) & ALI_LVI_MASK ) ; offs = ( char * ) chan -> dmalist - ( char * ) sc -> sc_cdata ; WRITE4 ( sc , port + ALI_OFF_BDBAR , sc -> sc_cddma + offs ) ; WRITE1 ( sc , port + ALI_OFF_CR , ALI_CR_IOCE | ALI_CR_FEIE | ALI_CR_LVBIE | ALI_CR_RPBM ) ; val = READ4 ( sc , ALI_DMACR ) ; val &= ~ ( 1 << ( slot + 16 ) ) ; val |= 1 << slot ; WRITE4 ( sc , ALI_DMACR , val ) ; } 