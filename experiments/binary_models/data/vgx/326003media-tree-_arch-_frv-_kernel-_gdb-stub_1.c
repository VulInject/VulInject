static void gdbstub_recv_packet ( char * buffer ) { unsigned char checksum ; unsigned char xmitcsum ; unsigned char ch ; int count , i , ret , error ; for ( ; ; ) { { gdbstub_rx_char ( & ch , 0 ) ; } ch != '$' ; checksum = 0 ; xmitcsum = - 1 ; count = 0 ; error = 0 ; while ( count < BUFMAX ) { ret = gdbstub_rx_char ( & ch , 0 ) ; if ( ret < 0 ) { error = ret ; } if ( ch == '#' ) { break ; } checksum += ch ; buffer [ count ] = ch ; count ++ ; } if ( error == - EIO ) { gdbstub_proto ( "### GDB Rx Error - Skipping packet ###\n" ) ; gdbstub_proto ( "### GDB Tx NAK\n" ) ; gdbstub_tx_char ( '-' ) ; continue ; } buffer [ count ] = 0 ; ret = gdbstub_rx_char ( & ch , 0 ) ; if ( ret < 0 ) { error = ret ; } xmitcsum = hex ( ch ) << 4 ; ret = gdbstub_rx_char ( & ch , 0 ) ; if ( ret < 0 ) { error = ret ; } xmitcsum |= hex ( ch ) ; if ( error ) { if ( error == - EIO ) { gdbstub_proto ( "### GDB Rx Error - Skipping packet\n" ) ; } gdbstub_proto ( "### GDB Tx NAK\n" ) ; gdbstub_tx_char ( '-' ) ; continue ; } if ( checksum != xmitcsum ) { gdbstub_proto ( "### GDB Tx NAK\n" ) ; gdbstub_tx_char ( '-' ) ; continue ; } gdbstub_proto ( "### GDB Rx '$%s#%02x' ###\n" , buffer , checksum ) ; gdbstub_proto ( "### GDB Tx ACK\n" ) ; gdbstub_tx_char ( '+' ) ; if ( buffer [ 2 ] == ':' ) { gdbstub_tx_char ( buffer [ 0 ] ) ; gdbstub_tx_char ( buffer [ 1 ] ) ; count = 0 ; while ( buffer [ count ] ) { count ++ ; } for ( i = 3 ; i <= count ; i ++ ) { buffer [ i - 3 ] = buffer [ i ] ; } } break ; } } 