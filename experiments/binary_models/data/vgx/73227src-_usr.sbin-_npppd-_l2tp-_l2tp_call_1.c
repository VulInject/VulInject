static int l2tp_call_send_ICRP ( l2tp_call * _this ) { int rval ; struct l2tp_avp * avp ; char buf [ L2TP_AVP_MAXSIZ ] ; bytebuffer * bytebuf ; bytebuf = l2tp_ctrl_prepare_snd_buffer ( _this -> ctrl , 1 ) ; if ( bytebuf == NULL ) { l2tp_call_log ( _this , LOG_ERR , "sending ICRP failed: no buffer" ) ; return 1 ; } avp = ( l2tp_avp * ) buf ; avp -> is_mandatory = 1 ; avp -> attr_type = L2TP_AVP_TYPE_MESSAGE_TYPE ; avp_set_val16 ( avp , L2TP_AVP_MESSAGE_TYPE_ICRP ) ; bytebuf_add_avp ( bytebuf , avp , 2 ) ; memset ( avp , 0 , sizeof ( * avp ) ) ; avp -> is_mandatory = 1 ; avp -> attr_type = L2TP_AVP_TYPE_ASSIGNED_SESSION_ID ; avp_set_val16 ( avp , _this -> session_id ) ; bytebuf_add_avp ( bytebuf , avp , 2 ) ; if ( ( rval = l2tp_ctrl_send_packet ( _this -> ctrl , _this -> peer_session_id , bytebuf ) ) != 0 ) { l2tp_call_log ( _this , LOG_ERR , "failed to SendICRP: %m" ) ; return 1 ; } l2tp_call_log ( _this , LOG_INFO , "SendICRP session_id=%u" , _this -> session_id ) ; return 0 ; } 