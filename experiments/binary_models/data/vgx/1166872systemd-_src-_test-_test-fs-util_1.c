TEST ( ) { static const char * const table [ ] { "/reg" "/dir" "/fifo" "/socket" "/symlink" NULL } ; ; _cleanup_ ( ) char * z ; const char * j = NULL ; if ( arg_test_dir ) { j = strjoina ( arg_test_dir , "/testXXXXXX" ) ; } assert_se ( mkdtemp_malloc ( j , & z ) >= 0 ) ; j = strjoina ( z , table [ 0 ] ) ; assert_se ( touch ( j ) >= 0 ) ; j = strjoina ( z , table [ 1 ] ) ; assert_se ( mkdir ( j , 0777 ) >= 0 ) ; j = strjoina ( z , table [ 2 ] ) ; ( void ) mkfifo ( j , 0777 ) ; j = strjoina ( z , table [ 3 ] ) ; ( void ) mknod ( j , S_IFSOCK | 0777 , 0 ) ; j = strjoina ( z , table [ 4 ] ) ; ( void ) symlink ( "foobar" , j ) ; STRV_FOREACH ( , ) { _cleanup_free_ char * x = NULL , * y = NULL ; x = strjoin ( z , * a ) ; assert_se ( x ) ; if ( access ( x , F_OK ) < 0 ) { assert_se ( errno == ENOENT ) ; continue ; } STRV_FOREACH ( , ) { _cleanup_free_ char * w = NULL ; w = strjoin ( z , * b ) ; assert_se ( w ) ; if ( access ( w , F_OK ) < 0 ) { assert_se ( errno == ENOENT ) ; continue ; } assert_se ( rename_noreplace ( AT_FDCWD , x , AT_FDCWD , w ) == - EEXIST ) ; } y = strjoin ( z , "/somethingelse" ) ; assert_se ( y ) ; assert_se ( rename_noreplace ( AT_FDCWD , x , AT_FDCWD , y ) >= 0 ) ; assert_se ( rename_noreplace ( AT_FDCWD , y , AT_FDCWD , x ) >= 0 ) ; } } 