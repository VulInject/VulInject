static int tpm_tis_i2c_send ( struct tpm_chip * chip , u8 * buf , size_t len ) { int rc , status ; ssize_t burstcnt ; size_t count = 0 ; u8 retries = 0 ; u8 sts = TPM_STS_GO ; if ( request_locality ( chip , 0 ) < 0 ) { return - EBUSY ; } status = tpm_tis_i2c_status ( chip ) ; if ( ( status & TPM_STS_COMMAND_READY ) == 0 ) { tpm_tis_i2c_ready ( chip ) ; if ( wait_for_stat ( chip , TPM_STS_COMMAND_READY , chip -> timeout_b , & status ) < 0 ) { rc = - ETIME ; out_err } } while ( count < len - 1 ) { burstcnt = get_burstcount ( chip ) ; if ( burstcnt < 0 ) { return burstcnt ; } if ( burstcnt > ( len - 1 - count ) ) { burstcnt = len - 1 - count ; } rc = iic_tpm_write ( TPM_DATA_FIFO ( tpm_dev . locality ) , & ( buf [ count ] ) , burstcnt ) ; if ( rc == 0 ) { count += burstcnt ; } if ( rc < 0 ) { retries ++ ; } if ( retries > MAX_COUNT_LONG ) { rc = - EIO ; out_err } wait_for_stat ( chip , TPM_STS_VALID , chip -> timeout_c , & status ) ; if ( ( status & TPM_STS_DATA_EXPECT ) == 0 ) { rc = - EIO ; out_err } } iic_tpm_write ( TPM_DATA_FIFO ( tpm_dev . locality ) , & ( buf [ count ] ) , 1 ) ; wait_for_stat ( chip , TPM_STS_VALID , chip -> timeout_c , & status ) ; if ( ( status & TPM_STS_DATA_EXPECT ) != 0 ) { rc = - EIO ; out_err } iic_tpm_write ( TPM_STS ( tpm_dev . locality ) , & sts , 1 ) ; return len ; out_err tpm_tis_i2c_ready ( chip ) ; usleep_range ( SLEEP_DURATION_RESET_LOW , SLEEP_DURATION_RESET_HI ) ; release_locality ( chip , tpm_dev . locality , 0 ) ; return rc ; } 