static mchunkptr mmap_chunk ( size ) size_t size ; { size_t page_mask = malloc_getpagesize - 1 ; mchunkptr p ; static int fd = - 1 ; size = ( size + SIZE_SZ + page_mask ) & ~ page_mask ; p = ( mchunkptr ) mmap ( 0 , size , PROT_READ | PROT_WRITE , MAP_PRIVATE | MAP_ANONYMOUS , - 1 , 0 ) ; if ( fd < 0 ) { fd = open ( "/dev/zero" , O_RDWR ) ; if ( fd < 0 ) { return 0 ; } } p = ( mchunkptr ) mmap ( 0 , size , PROT_READ | PROT_WRITE , MAP_PRIVATE , fd , 0 ) ; if ( p == ( mchunkptr ) - 1 ) { return 0 ; } n_mmaps ++ ; if ( n_mmaps > max_n_mmaps ) { max_n_mmaps = n_mmaps ; } assert ( aligned_OK ( chunk2mem ( p ) ) ) ; p -> prev_size = 0 ; set_head ( p , size | IS_MMAPPED ) ; mmapped_mem += size ; if ( ( unsigned long ) mmapped_mem > ( unsigned long ) max_mmapped_mem ) { max_mmapped_mem = mmapped_mem ; } if ( ( unsigned long ) ( mmapped_mem + sbrked_mem ) > ( unsigned long ) max_total_mem ) { max_total_mem = mmapped_mem + sbrked_mem ; } return p ; } 