void restore_rp_filter ( void ) { list_head_t * ifq ; interface_t * ifp ; unsigned rp_filter ; sysctl_opts_t rpfilter_sysctl [ ] { { IPV4_DEVCONF_RP_FILTER 1 } { 0 0 } } ; ; rp_filter = get_sysctl ( "net/ipv4/conf" , "all" , "rp_filter" ) ; if ( rp_filter == 0 ) { log_message ( LOG_INFO , "NOTICE: resetting sysctl net.ipv4.conf.all.rp_filter to %u" , all_rp_filter ) ; set_sysctl ( "net/ipv4/conf" , "all" , "rp_filter" , all_rp_filter ) ; } if ( default_rp_filter != UINT_MAX ) { rp_filter = get_sysctl ( "net/ipv4/conf" , "default" , "rp_filter" ) ; if ( rp_filter == all_rp_filter ) { log_message ( LOG_INFO , "NOTICE: resetting sysctl net.ipv4.conf.default.rp_filter to %u" , default_rp_filter ) ; set_sysctl ( "net/ipv4/conf" , "default" , "rp_filter" , default_rp_filter ) ; } default_rp_filter = UINT_MAX ; } ifq = get_interface_queue ( ) ; list_for_each_entry ( , , ) { if ( ifp -> rp_filter != UINT_MAX ) { rp_filter = get_sysctl ( "net/ipv4/conf" , ifp -> ifname , "rp_filter" ) ; if ( rp_filter == all_rp_filter ) { rpfilter_sysctl [ 0 ] . value = ifp -> rp_filter ; netlink_set_interface_flags ( ifp -> ifindex , rpfilter_sysctl ) ; set_sysctl ( "net/ipv4/conf" , ifp -> ifname , "rp_filter" , ifp -> rp_filter ) ; } } } all_rp_filter = UINT_MAX ; } 