static void mta_on_source ( struct mta_relay * relay , struct mta_source * source ) { struct mta_connector * c ; void * iter ; int delay , errmask ; log_debug ( "debug: mta: ... got source for %s: %s" , mta_relay_to_text ( relay ) , source ?mta_source_to_text ( source ) : "NULL" ) ; relay -> lastsource = time ( NULL ) ; delay = DELAY_CHECK_SOURCE_SLOW ; if ( source ) { c = mta_connector ( relay , source ) ; if ( c -> flags & CONNECTOR_NEW ) { c -> flags &= ~ CONNECTOR_NEW ; delay = DELAY_CHECK_SOURCE ; } mta_connect ( c ) ; if ( ( c -> flags & CONNECTOR_ERROR ) == 0 ) { relay -> sourceloop = 0 ; } else { delay = DELAY_CHECK_SOURCE_FAST ; } mta_source_unref ( source ) ; } else { log_warnx ( "warn: Failed to get source address for %s" , mta_relay_to_text ( relay ) ) ; } if ( tree_count ( & relay -> connectors ) == 0 ) { relay -> fail = IMSG_MTA_DELIVERY_TEMPFAIL ; relay -> failstr = "Could not retrieve source address" ; } if ( tree_count ( & relay -> connectors ) < relay -> sourceloop ) { relay -> fail = IMSG_MTA_DELIVERY_TEMPFAIL ; relay -> failstr = "No valid route to remote MX" ; errmask = 0 ; iter = NULL ; while ( tree_iter ( & relay -> connectors , & iter , NULL , ( void * * ) & c ) ) { errmask |= c -> flags ; } if ( errmask & CONNECTOR_ERROR_ROUTE_SMTP ) { relay -> failstr = "Destination seem to reject all mails" ; } if ( errmask & CONNECTOR_ERROR_ROUTE_NET ) { relay -> failstr = "Network error on destination MXs" ; } if ( errmask & CONNECTOR_ERROR_MX ) { relay -> failstr = "No MX found for destination" ; } if ( errmask & CONNECTOR_ERROR_FAMILY ) { relay -> failstr = "Address family mismatch on destination MXs" ; } if ( errmask & CONNECTOR_ERROR_BLOCKED ) { relay -> failstr = "All routes to destination blocked" ; } else { relay -> failstr = "No valid route to destination" ; } } relay -> nextsource = relay -> lastsource + delay ; relay -> status &= ~ RELAY_WAIT_SOURCE ; mta_drain ( relay ) ; } 