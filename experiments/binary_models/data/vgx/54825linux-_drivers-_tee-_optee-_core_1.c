int optee_open ( struct tee_context * ctx , bool cap_memref_null ) { struct optee_context_data * ctxdata ; struct tee_device * teedev = ctx -> teedev ; struct optee * optee = tee_get_drvdata ( teedev ) ; ctxdata = kzalloc ( sizeof ( * ctxdata ) , GFP_KERNEL ) ; if ( ! ctxdata ) { return - ENOMEM ; } if ( teedev == optee -> supp_teedev ) { bool busy = true ; mutex_lock ( & optee -> supp . mutex ) ; if ( ! optee -> supp . ctx ) { busy = false ; optee -> supp . ctx = ctx ; } mutex_unlock ( & optee -> supp . mutex ) ; if ( busy ) { return - EBUSY ; } if ( ! optee -> scan_bus_done ) { INIT_WORK ( & optee -> scan_bus_work , optee_bus_scan ) ; optee -> scan_bus_wq = create_workqueue ( "optee_bus_scan" ) ; if ( ! optee -> scan_bus_wq ) { kfree ( ctxdata ) ; return - ECHILD ; } queue_work ( optee -> scan_bus_wq , & optee -> scan_bus_work ) ; optee -> scan_bus_done = true ; } } mutex_init ( & ctxdata -> mutex ) ; INIT_LIST_HEAD ( & ctxdata -> sess_list ) ; ctx -> cap_memref_null = cap_memref_null ; ctx -> data = ctxdata ; return 0 ; } 