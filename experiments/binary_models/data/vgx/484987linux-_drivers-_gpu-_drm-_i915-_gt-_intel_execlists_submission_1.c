static __maybe_unused noinline bool assert_pending_valid ( const struct intel_engine_execlists * execlists , const char * msg ) { struct intel_engine_cs * engine = container_of ( execlists , typeof ( * engine ) , execlists ) ; struct i915_request * const * port , * rq , * prev = NULL ; struct intel_context * ce = NULL ; u32 ccid = - 1 ; trace_ports ( execlists , msg , execlists -> pending ) ; if ( ! execlists -> pending [ 0 ] ) { GEM_TRACE_ERR ( "%s: Nothing pending for promotion!\n" , engine -> name ) ; return false ; } if ( execlists -> pending [ execlists_num_ports ( execlists ) ] ) { GEM_TRACE_ERR ( "%s: Excess pending[%d] for promotion!\n" , engine -> name , execlists_num_ports ( execlists ) ) ; return false ; } for ( port = execlists -> pending ; ( rq = * port ) ; port ++ ) { unsigned long flags ; bool ok = true ; GEM_BUG_ON ( ! kref_read ( & rq -> fence . refcount ) ) ; GEM_BUG_ON ( ! i915_request_is_active ( rq ) ) ; if ( ce == rq -> context ) { GEM_TRACE_ERR ( "%s: Dup context:%llx in pending[%zd]\n" , engine -> name , ce -> timeline -> fence_context , port - execlists -> pending ) ; return false ; } ce = rq -> context ; if ( ccid == ce -> lrc . ccid ) { GEM_TRACE_ERR ( "%s: Dup ccid:%x context:%llx in pending[%zd]\n" , engine -> name , ccid , ce -> timeline -> fence_context , port - execlists -> pending ) ; return false ; } ccid = ce -> lrc . ccid ; if ( prev && i915_request_has_sentinel ( prev ) && ! READ_ONCE ( prev -> fence . error ) ) { GEM_TRACE_ERR ( "%s: context:%llx after sentinel in pending[%zd]\n" , engine -> name , ce -> timeline -> fence_context , port - execlists -> pending ) ; return false ; } prev = rq ; if ( rq -> execution_mask != engine -> mask && port != execlists -> pending ) { GEM_TRACE_ERR ( "%s: virtual engine:%llx not in prime position[%zd]\n" , engine -> name , ce -> timeline -> fence_context , port - execlists -> pending ) ; return false ; } if ( ! spin_trylock_irqsave ( & rq -> lock , flags ) ) { continue ; } if ( __i915_request_is_complete ( rq ) ) { unlock } if ( i915_active_is_idle ( & ce -> active ) && ! intel_context_is_barrier ( ce ) ) { GEM_TRACE_ERR ( "%s: Inactive context:%llx in pending[%zd]\n" , engine -> name , ce -> timeline -> fence_context , port - execlists -> pending ) ; ok = false ; unlock } if ( ! i915_vma_is_pinned ( ce -> state ) ) { GEM_TRACE_ERR ( "%s: Unpinned context:%llx in pending[%zd]\n" , engine -> name , ce -> timeline -> fence_context , port - execlists -> pending ) ; ok = false ; unlock } if ( ! i915_vma_is_pinned ( ce -> ring -> vma ) ) { GEM_TRACE_ERR ( "%s: Unpinned ring:%llx in pending[%zd]\n" , engine -> name , ce -> timeline -> fence_context , port - execlists -> pending ) ; ok = false ; unlock } unlock spin_unlock_irqrestore ( & rq -> lock , flags ) ; if ( ! ok ) { return false ; } } return ce ; } 