static char * format_grouped_double ( const struct lc_monetary * lmon , const struct lc_numeric * lnum , double value , int * flags , int left_prec , int right_prec , int pad_char ) { char * rslt ; char * avalue ; int avalue_size ; char fmt [ 32 ] ; size_t bufsize ; char * bufend ; int padded ; const char * grouping ; const char * decimal_point ; const char * thousands_sep ; int decimal_len ; int thousands_len ; int groups = 0 ; grouping = lmon -> mon_grouping ; decimal_point = lmon -> mon_decimal_point ; if ( * decimal_point == '\0' ) { decimal_point = lnum -> decimal_point ; } thousands_sep = lmon -> mon_thousands_sep ; if ( * thousands_sep == '\0' ) { thousands_sep = lnum -> thousands_sep ; } decimal_len = strlen ( decimal_point ) ; thousands_len = strlen ( thousands_sep ) ; if ( left_prec == - 1 ) { left_prec = 0 ; } if ( right_prec == - 1 ) { if ( * flags & USE_INTL_CURRENCY ) { right_prec = lmon -> int_frac_digits [ 0 ] ; } else { right_prec = lmon -> frac_digits [ 0 ] ; } if ( right_prec == CHAR_MAX ) { right_prec = 2 ; } } if ( * flags & NEED_GROUPING ) { left_prec += get_groups ( left_prec , grouping ) ; } ( void ) snprintf ( fmt , sizeof ( fmt ) , "%%%d.%df" , left_prec + right_prec + 1 , right_prec ) ; avalue_size = asprintf ( & avalue , fmt , value ) ; if ( avalue_size < 0 ) { return ( NULL ) ; } bufsize = strlen ( avalue ) * 2 + 1 ; rslt = calloc ( 1 , bufsize ) ; if ( rslt == NULL ) { return ( NULL ) ; } bufend = rslt + bufsize - 1 ; padded = 0 ; while ( avalue [ padded ] == ' ' ) { padded ++ ; avalue_size -- ; } if ( right_prec > 0 ) { bufend -= right_prec ; ( void ) memcpy ( bufend , avalue + avalue_size + padded - right_prec , right_prec ) ; bufend -= decimal_len ; ( void ) memcpy ( bufend , decimal_point , decimal_len ) ; avalue_size -= ( right_prec + decimal_len ) ; } if ( ( * flags & NEED_GROUPING ) && thousands_len != 0 && * grouping != CHAR_MAX && * grouping > 0 ) { while ( avalue_size > ( int ) * grouping ) { GRPCPY ( * grouping ) ; GRPSEP ; grouping ++ ; if ( * grouping == CHAR_MAX ) { break ; } if ( * grouping == 0 ) { grouping -- ; while ( avalue_size > * grouping ) { GRPCPY ( * grouping ) ; GRPSEP ; } } } if ( avalue_size != 0 ) { GRPCPY ( avalue_size ) ; } padded -= groups ; } else { bufend -= avalue_size ; ( void ) memcpy ( bufend , avalue + padded , avalue_size ) ; if ( right_prec == 0 ) { padded -- ; } } if ( padded > 0 ) { bufend -= padded ; ( void ) memset ( bufend , pad_char , padded ) ; } bufsize = bufsize - ( bufend - rslt ) + 1 ; ( void ) memmove ( rslt , bufend , bufsize ) ; free ( avalue ) ; return ( rslt ) ; } 