static QSVFrame * query_frame ( QSVVPPContext * s , AVFilterLink * outlink ) { AVFilterContext * ctx = outlink -> src ; QSVFrame * out_frame ; int ret ; clear_unused_frames ( s -> out_frame_list ) ; out_frame = get_free_frame ( & s -> out_frame_list ) ; if ( ! out_frame ) { return NULL ; } if ( ! IS_SYSTEM_MEMORY ( s -> out_mem_mode ) ) { out_frame -> frame = av_frame_alloc ( ) ; if ( ! out_frame -> frame ) { return in ; } ret = av_hwframe_get_buffer ( outlink -> hw_frames_ctx , out_frame -> frame , 0 ) ; if ( ret < 0 ) { av_log ( ctx , AV_LOG_ERROR , "Can't allocate a surface.\n" ) ; return NULL ; } out_frame -> surface = ( mfxFrameSurface1 * ) out_frame -> frame -> data [ 3 ] ; } else { out_frame -> frame = ff_get_video_buffer ( outlink , FFALIGN ( outlink -> w , 128 ) , FFALIGN ( outlink -> h , 64 ) ) ; if ( ! out_frame -> frame ) { return NULL ; } out_frame -> frame -> width = outlink -> w ; out_frame -> frame -> height = outlink -> h ; ret = map_frame_to_surface ( out_frame -> frame , & out_frame -> surface_internal ) ; if ( ret < 0 ) { return NULL ; } out_frame -> surface = & out_frame -> surface_internal ; } out_frame -> surface -> Info = s -> vpp_param . vpp . Out ; return out_frame ; } 