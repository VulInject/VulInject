static int proc_thermal_add ( struct device * dev , struct proc_thermal_device * * priv ) { struct proc_thermal_device * proc_priv ; struct acpi_device * adev ; acpi_status status ; unsigned long long tmp ; struct thermal_zone_device_ops * ops = NULL ; int ret ; adev = ACPI_COMPANION ( dev ) ; if ( ! adev ) { return - ENODEV ; } proc_priv = devm_kzalloc ( dev , sizeof ( * proc_priv ) , GFP_KERNEL ) ; proc_priv -> dev = dev ; proc_priv -> adev = adev ; * priv = proc_priv ; ret = proc_thermal_read_ppcc ( proc_priv ) ; if ( ! ret ) { ret = sysfs_create_group ( & dev -> kobj , & power_limit_attribute_group ) ; } if ( ret ) { return ret ; } status = acpi_evaluate_integer ( adev -> handle , "_TMP" , NULL , & tmp ) ; if ( ACPI_FAILURE ( status ) ) { stored_tjmax = get_tjmax ( ) ; if ( stored_tjmax > 0 ) { ops = & proc_thermal_local_ops ; } } proc_priv -> int340x_zone = int340x_thermal_zone_add ( adev , ops ) ; if ( IS_ERR ( proc_priv -> int340x_zone ) ) { ret = PTR_ERR ( proc_priv -> int340x_zone ) ; remove_group } else { ret = 0 ; } ret = acpi_install_notify_handler ( adev -> handle , ACPI_DEVICE_NOTIFY , proc_thermal_notify , ( void * ) proc_priv ) ; if ( ret ) { remove_zone } return 0 ; remove_zone int340x_thermal_zone_remove ( proc_priv -> int340x_zone ) ; remove_group sysfs_remove_group ( & proc_priv -> dev -> kobj , & power_limit_attribute_group ) ; return ret ; } 