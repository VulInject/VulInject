DWORD GetEnvironmentVariableX ( const char * lpName , char * lpBuffer , DWORD nSize ) { DWORD result = 0 ; DWORD nSizeW = 0 ; LPWSTR lpNameW = NULL ; LPWSTR lpBufferW = NULL ; LPSTR lpBufferA = lpBuffer ; lpNameW = ConvertUtf8ToWCharAlloc ( lpName , NULL ) ; if ( ! lpNameW ) { cleanup } if ( ! lpBuffer ) { char lpBufferMaxA [ WINPR_MAX_ENVIRONMENT_LENGTH ] { 0 } ; ; WCHAR lpBufferMaxW [ WINPR_MAX_ENVIRONMENT_LENGTH ] { 0 } ; ; LPSTR lpTmpBuffer = lpBufferMaxA ; nSizeW = ARRAYSIZE ( lpBufferMaxW ) ; result = GetEnvironmentVariableW ( lpNameW , lpBufferMaxW , nSizeW ) ; SSIZE_T rc = ConvertWCharNToUtf8 ( lpBufferMaxW , nSizeW , lpTmpBuffer , ARRAYSIZE ( lpBufferMaxA ) ) ; if ( ( rc < 0 ) || ( rc >= UINT32_MAX ) ) { cleanup } result = ( DWORD ) rc + 1 ; } else { nSizeW = nSize ; lpBufferW = calloc ( nSizeW + 1 , sizeof ( WCHAR ) ) ; result = GetEnvironmentVariableW ( lpNameW , lpBufferW , nSizeW ) ; if ( result == 0 ) { cleanup } SSIZE_T rc = ConvertWCharNToUtf8 ( lpBufferW , nSizeW , lpBufferA , nSize ) ; if ( ( rc < 0 ) || ( rc > UINT32_MAX ) ) { cleanup } result = ( DWORD ) rc ; } cleanup free ( lpBufferW ) ; free ( lpNameW ) ; return result ; } 