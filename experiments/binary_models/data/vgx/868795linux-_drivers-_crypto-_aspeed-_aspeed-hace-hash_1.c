static int aspeed_sham_setkey ( struct crypto_ahash * tfm , const u8 * key , unsigned int keylen ) { struct aspeed_sham_ctx * tctx = crypto_ahash_ctx ( tfm ) ; struct aspeed_hace_dev * hace_dev = tctx -> hace_dev ; struct aspeed_sha_hmac_ctx * bctx = tctx -> base ; int ds = crypto_shash_digestsize ( bctx -> shash ) ; int bs = crypto_shash_blocksize ( bctx -> shash ) ; int err = 0 ; int i ; AHASH_DBG ( hace_dev , "%s: keylen:%d\n" , crypto_tfm_alg_name ( & tfm -> base ) , keylen ) ; if ( keylen > bs ) { err = aspeed_sham_shash_digest ( bctx -> shash , crypto_shash_get_flags ( bctx -> shash ) , key , keylen , bctx -> ipad ) ; if ( err ) { return err ; } keylen = ds ; } else { memcpy ( bctx -> ipad , key , keylen ) ; } memcpy ( bctx -> opad , bctx -> ipad , bs ) ; for ( i = 0 ; i < bs ; i ++ ) { bctx -> ipad [ i ] ^= HMAC_IPAD_VALUE ; bctx -> opad [ i ] ^= HMAC_OPAD_VALUE ; } return err ; } 