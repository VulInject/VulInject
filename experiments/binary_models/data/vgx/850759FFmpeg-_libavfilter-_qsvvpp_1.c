static QSVFrame * submit_frame ( QSVVPPContext * s , AVFilterLink * inlink , AVFrame * picref ) { QSVFrame * qsv_frame ; AVFilterContext * ctx = inlink -> dst ; clear_unused_frames ( s -> in_frame_list ) ; qsv_frame = get_free_frame ( & s -> in_frame_list ) ; if ( ! qsv_frame ) { return NULL ; } if ( ! IS_SYSTEM_MEMORY ( s -> in_mem_mode ) ) { if ( picref -> format != AV_PIX_FMT_QSV ) { av_log ( ctx , AV_LOG_ERROR , "QSVVPP gets a wrong frame.\n" ) ; return NULL ; } qsv_frame -> frame = av_frame_clone ( picref ) ; qsv_frame -> surface = * ( mfxFrameSurface1 * ) qsv_frame -> frame -> data [ 3 ] ; } else { if ( picref -> height & 31 || picref -> linesize [ 0 ] & 31 ) { qsv_frame -> frame = ff_get_video_buffer ( inlink , FFALIGN ( inlink -> w , 32 ) , FFALIGN ( inlink -> h , 32 ) ) ; if ( ! qsv_frame -> frame ) { return NULL ; } qsv_frame -> frame -> width = picref -> width ; qsv_frame -> frame -> height = picref -> height ; if ( av_frame_copy ( qsv_frame -> frame , picref ) < 0 ) { return NULL ; } if ( av_frame_copy_props ( qsv_frame -> frame , picref ) < 0 ) { av_frame_free ( & qsv_frame -> frame ) ; return NULL ; } } else { qsv_frame -> frame = av_frame_clone ( picref ) ; } if ( map_frame_to_surface ( qsv_frame -> frame , & qsv_frame -> surface ) < 0 ) { av_log ( ctx , AV_LOG_ERROR , "Unsupported frame.\n" ) ; return NULL ; } } qsv_frame -> surface . Info = s -> frame_infos [ FF_INLINK_IDX ( inlink ) ] ; qsv_frame -> surface . Data . TimeStamp = av_rescale_q ( qsv_frame -> frame -> pts , inlink -> time_base , default_tb ) ; qsv_frame -> surface . Info . PicStruct = ! qsv_frame -> frame -> interlaced_frame ?MFX_PICSTRUCT_PROGRESSIVE : ( qsv_frame -> frame -> top_field_first ?MFX_PICSTRUCT_FIELD_TFF : MFX_PICSTRUCT_FIELD_BFF ) ; if ( qsv_frame -> frame -> repeat_pict == 1 ) { qsv_frame -> surface . Info . PicStruct |= MFX_PICSTRUCT_FIELD_REPEATED ; } if ( qsv_frame -> frame -> repeat_pict == 2 ) { qsv_frame -> surface . Info . PicStruct |= MFX_PICSTRUCT_FRAME_DOUBLING ; } if ( qsv_frame -> frame -> repeat_pict == 4 ) { qsv_frame -> surface . Info . PicStruct |= MFX_PICSTRUCT_FRAME_TRIPLING ; } return qsv_frame ; } 