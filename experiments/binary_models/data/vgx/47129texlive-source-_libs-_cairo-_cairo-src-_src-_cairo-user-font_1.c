_cairo_user_scaled_glyph_init ( , , ) { cairo_int_status_t status = CAIRO_STATUS_SUCCESS ; cairo_user_scaled_font_t * scaled_font = abstract_font ; cairo_surface_t * recording_surface = scaled_glyph -> recording_surface ; if ( ! scaled_glyph -> recording_surface ) { cairo_user_font_face_t * face = ( cairo_user_font_face_t * ) scaled_font -> base . font_face ; cairo_text_extents_t extents = scaled_font -> default_glyph_extents ; cairo_t * cr ; if ( ! face -> scaled_font_methods . render_glyph ) { return CAIRO_STATUS_USER_FONT_NOT_IMPLEMENTED ; } recording_surface = _cairo_user_scaled_font_create_recording_surface ( scaled_font ) ; if ( ! _cairo_matrix_is_scale_0 ( & scaled_font -> base . scale ) ) { cr = _cairo_user_scaled_font_create_recording_context ( scaled_font , recording_surface ) ; status = face -> scaled_font_methods . render_glyph ( ( cairo_scaled_font_t * ) scaled_font , _cairo_scaled_glyph_index ( scaled_glyph ) , cr , & extents ) ; if ( status == CAIRO_INT_STATUS_SUCCESS ) { status = cairo_status ( cr ) ; } cairo_destroy ( cr ) ; if ( unlikely ( status ) ) { return status ; } } _cairo_scaled_glyph_set_recording_surface ( scaled_glyph , & scaled_font -> base , recording_surface ) ; if ( extents . width == 0. ) { cairo_box_t bbox ; double x1 , y1 , x2 , y2 ; double x_scale , y_scale ; status = _cairo_recording_surface_get_bbox ( ( cairo_recording_surface_t * ) recording_surface , & bbox , & scaled_font -> extent_scale ) ; if ( unlikely ( status ) ) { return status ; } _cairo_box_to_doubles ( & bbox , & x1 , & y1 , & x2 , & y2 ) ; x_scale = scaled_font -> extent_x_scale ; y_scale = scaled_font -> extent_y_scale ; extents . x_bearing = x1 * x_scale ; extents . y_bearing = y1 * y_scale ; extents . width = ( x2 - x1 ) * x_scale ; extents . height = ( y2 - y1 ) * y_scale ; } if ( scaled_font -> base . options . hint_metrics != CAIRO_HINT_METRICS_OFF ) { extents . x_advance = _cairo_lround ( extents . x_advance / scaled_font -> snap_x_scale ) * scaled_font -> snap_x_scale ; extents . y_advance = _cairo_lround ( extents . y_advance / scaled_font -> snap_y_scale ) * scaled_font -> snap_y_scale ; } _cairo_scaled_glyph_set_metrics ( scaled_glyph , & scaled_font -> base , & extents ) ; } if ( info & CAIRO_SCALED_GLYPH_INFO_SURFACE ) { cairo_surface_t * surface ; cairo_format_t format ; int width , height ; width = _cairo_fixed_integer_ceil ( scaled_glyph -> bbox . p2 . x ) - _cairo_fixed_integer_floor ( scaled_glyph -> bbox . p1 . x ) ; height = _cairo_fixed_integer_ceil ( scaled_glyph -> bbox . p2 . y ) - _cairo_fixed_integer_floor ( scaled_glyph -> bbox . p1 . y ) ; switch ( scaled_font -> base . options . antialias ) { default : case CAIRO_ANTIALIAS_DEFAULT : case CAIRO_ANTIALIAS_FAST : case CAIRO_ANTIALIAS_GOOD : case CAIRO_ANTIALIAS_GRAY : format = CAIRO_FORMAT_A8 ; break ; case CAIRO_ANTIALIAS_NONE : format = CAIRO_FORMAT_A1 ; break ; case CAIRO_ANTIALIAS_BEST : case CAIRO_ANTIALIAS_SUBPIXEL : format = CAIRO_FORMAT_ARGB32 ; break ; } surface = cairo_image_surface_create ( format , width , height ) ; cairo_surface_set_device_offset ( surface , - _cairo_fixed_integer_floor ( scaled_glyph -> bbox . p1 . x ) , - _cairo_fixed_integer_floor ( scaled_glyph -> bbox . p1 . y ) ) ; status = _cairo_recording_surface_replay ( recording_surface , surface ) ; if ( unlikely ( status ) ) { cairo_surface_destroy ( surface ) ; return status ; } _cairo_scaled_glyph_set_surface ( scaled_glyph , & scaled_font -> base , ( cairo_image_surface_t * ) surface ) ; } if ( info & CAIRO_SCALED_GLYPH_INFO_PATH ) { cairo_path_fixed_t * path = _cairo_path_fixed_create ( ) ; if ( ! path ) { return _cairo_error ( CAIRO_STATUS_NO_MEMORY ) ; } status = _cairo_recording_surface_get_path ( recording_surface , path ) ; if ( unlikely ( status ) ) { _cairo_path_fixed_destroy ( path ) ; return status ; } _cairo_scaled_glyph_set_path ( scaled_glyph , & scaled_font -> base , path ) ; } return status ; } 