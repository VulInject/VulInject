static int amdgpu_ttm_tt_pin_userptr ( struct ttm_tt * ttm ) { struct amdgpu_device * adev = amdgpu_ttm_adev ( ttm -> bdev ) ; struct amdgpu_ttm_tt * gtt = ( void * ) ttm ; unsigned nents ; int r ; int write = ! ( gtt -> userflags & AMDGPU_GEM_USERPTR_READONLY ) ; enum dma_data_direction direction = write ?DMA_BIDIRECTIONAL : DMA_TO_DEVICE ; r = sg_alloc_table_from_pages ( ttm -> sg , ttm -> pages , ttm -> num_pages , 0 , ttm -> num_pages << PAGE_SHIFT , GFP_KERNEL ) ; if ( r ) { release_sg } r = - ENOMEM ; nents = dma_map_sg ( adev -> dev , ttm -> sg -> sgl , ttm -> sg -> nents , direction ) ; if ( nents != ttm -> sg -> nents ) { release_sg } drm_prime_sg_to_page_addr_arrays ( ttm -> sg , ttm -> pages , gtt -> ttm . dma_address , ttm -> num_pages ) ; return 0 ; release_sg return r ; } 