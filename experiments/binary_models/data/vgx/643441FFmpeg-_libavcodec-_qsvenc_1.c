int ff_qsv_enc_close ( AVCodecContext * avctx , QSVEncContext * q ) { QSVFrame * cur ; if ( q -> session ) { MFXVideoENCODE_Close ( q -> session ) ; } ff_qsv_close_internal_session ( & q -> internal_qs ) ; av_buffer_unref ( & q -> frames_ctx . hw_frames_ctx ) ; av_buffer_unref ( & q -> frames_ctx . mids_buf ) ; cur = q -> work_frames ; while ( cur ) { q -> work_frames = cur -> next ; av_frame_free ( & cur -> frame ) ; free_encoder_ctrl ( & cur -> enc_ctrl ) ; av_freep ( & cur ) ; cur = q -> work_frames ; } if ( q -> async_fifo ) { QSVPacket pkt ; while ( av_fifo_read ( q -> async_fifo , & pkt , 1 ) >= 0 ) { if ( avctx -> codec_id == AV_CODEC_ID_H264 ) { mfxExtBuffer * * enc_buf = pkt . bs -> ExtParam ; mfxExtAVCEncodedFrameInfo * enc_info = ( mfxExtAVCEncodedFrameInfo * ) ( * enc_buf ) ; av_freep ( & enc_info ) ; av_freep ( & enc_buf ) ; } av_freep ( & pkt . sync ) ; av_freep ( & pkt . bs ) ; av_packet_unref ( & pkt . pkt ) ; } av_fifo_freep2 ( & q -> async_fifo ) ; } av_freep ( & q -> opaque_surfaces ) ; av_buffer_unref ( & q -> opaque_alloc_buf ) ; av_freep ( & q -> extparam ) ; return 0 ; } 