static int renesas_sdhi_hs400 ( struct udevice * dev ) { struct tmio_sd_priv * priv = dev_get_priv ( dev ) ; struct mmc * mmc = mmc_get_mmc_dev ( dev ) ; bool hs400 = ( mmc -> selected_mode == MMC_HS_400 ) ; int ret , taps = hs400 ?priv -> nrtaps : 8 ; const u32 sdn_rate = 200000000 ; u32 sdnh_rate = 800000000 ; unsigned long new_tap ; u32 reg ; if ( clk_valid ( & priv -> clkh ) && ! priv -> needs_clkh_fallback ) { if ( taps == 4 ) { sdnh_rate /= 2 ; } ret = clk_set_rate ( & priv -> clkh , sdnh_rate ) ; } ret = clk_set_rate ( & priv -> clk , sdn_rate ) ; if ( ret < 0 ) { return ret ; } reg = tmio_sd_readl ( priv , RENESAS_SDHI_SCC_RVSCNTL ) ; reg &= ~ RENESAS_SDHI_SCC_RVSCNTL_RVSEN ; tmio_sd_writel ( priv , reg , RENESAS_SDHI_SCC_RVSCNTL ) ; reg = tmio_sd_readl ( priv , RENESAS_SDHI_SCC_TMPPORT2 ) ; if ( hs400 ) { reg |= RENESAS_SDHI_SCC_TMPPORT2_HS400EN | RENESAS_SDHI_SCC_TMPPORT2_HS400OSEL ; } else { reg &= ~ ( RENESAS_SDHI_SCC_TMPPORT2_HS400EN | RENESAS_SDHI_SCC_TMPPORT2_HS400OSEL ) ; } tmio_sd_writel ( priv , reg , RENESAS_SDHI_SCC_TMPPORT2 ) ; if ( ! hs400 ) { renesas_sdhi_adjust_hs400_mode_disable ( priv ) ; } tmio_sd_writel ( priv , ( 0x8 << RENESAS_SDHI_SCC_DTCNTL_TAPNUM_SHIFT ) | RENESAS_SDHI_SCC_DTCNTL_TAPEN , RENESAS_SDHI_SCC_DTCNTL ) ; if ( priv -> hs400_bad_tap & BIT ( priv -> tap_set ) ) { new_tap = ( priv -> tap_set + priv -> tap_num + 1 ) % priv -> tap_num ; if ( priv -> hs400_bad_tap & BIT ( new_tap ) ) { new_tap = ( priv -> tap_set + priv -> tap_num - 1 ) % priv -> tap_num ; } if ( priv -> hs400_bad_tap & BIT ( new_tap ) ) { new_tap = priv -> tap_set ; debug ( "Three consecutive bad tap is prohibited\n" ) ; } priv -> tap_set = new_tap ; tmio_sd_writel ( priv , priv -> tap_set , RENESAS_SDHI_SCC_TAPSET ) ; } if ( taps == 4 ) { tmio_sd_writel ( priv , priv -> tap_set >> 1 , RENESAS_SDHI_SCC_TAPSET ) ; tmio_sd_writel ( priv , hs400 ?0x100 : 0x300 , RENESAS_SDHI_SCC_DT2FF ) ; } else { tmio_sd_writel ( priv , priv -> tap_set , RENESAS_SDHI_SCC_TAPSET ) ; tmio_sd_writel ( priv , 0x300 , RENESAS_SDHI_SCC_DT2FF ) ; } reg = tmio_sd_readl ( priv , RENESAS_SDHI_SCC_CKSEL ) ; reg |= RENESAS_SDHI_SCC_CKSEL_DTSEL ; tmio_sd_writel ( priv , reg , RENESAS_SDHI_SCC_CKSEL ) ; if ( hs400 ) { priv -> needs_adjust_hs400 = true ; } return 0 ; } 