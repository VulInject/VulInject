static void M_sql_trace_message ( M_sql_trace_t type , M_sql_connpool_t * pool , M_sql_conn_t * conn , M_sql_trans_t * trans , M_sql_stmt_t * stmt , M_sql_error_t err , const char * error ) { void * cb_arg = NULL ; M_sql_trace_cb_t cb ; M_sql_trace_data_t data ; if ( trans == NULL ) { if ( stmt != NULL ) { trans = M_sql_stmt_get_trans ( stmt ) ; } } if ( conn == NULL ) { if ( trans != NULL ) { conn = M_sql_trans_get_conn ( trans ) ; } if ( stmt != NULL ) { conn = M_sql_stmt_get_conn ( stmt ) ; } } if ( pool == NULL ) { pool = M_sql_driver_conn_get_pool ( conn ) ; } if ( stmt == NULL ) { stmt = M_sql_conn_get_curr_stmt ( conn ) ; } cb = M_sql_connpool_get_cb ( pool , & cb_arg ) ; if ( cb == NULL ) { return ; } if ( stmt != NULL && err == M_SQL_ERROR_UNSET ) { err = M_sql_stmt_get_error ( stmt ) ; } if ( stmt != NULL && M_str_isempty ( error ) ) { error = M_sql_stmt_get_error_string ( stmt ) ; } data . type = type ; data . conn = conn ; data . trans = trans ; data . stmt = stmt ; data . err = err ; data . error_msg = error ; cb ( type , & data , cb_arg ) ; if ( err == M_SQL_ERROR_UNSET ) { return ; } if ( type == M_SQL_TRACE_TRANFAIL || type == M_SQL_TRACE_CONNFAIL || type == M_SQL_TRACE_CONNECT_FAILED ) { return ; } if ( M_sql_error_is_fatal ( err ) && ( stmt == NULL || ! stmt -> ignore_tranfail ) ) { M_sql_trace_message ( M_SQL_TRACE_TRANFAIL , pool , conn , trans , stmt , err , error ) ; } if ( M_sql_error_is_disconnect ( err ) ) { M_sql_trace_message ( M_SQL_TRACE_CONNFAIL , pool , conn , trans , stmt , err , error ) ; } } 