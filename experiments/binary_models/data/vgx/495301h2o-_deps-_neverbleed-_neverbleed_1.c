static int setuidgid_stub ( neverbleed_iobuf_t * buf ) { const char * user ; size_t change_socket_ownership ; struct passwd pwbuf , * pw ; char pwstrbuf [ 65536 ] ; int ret = - 1 ; if ( ( user = iobuf_shift_str ( buf ) ) == NULL || iobuf_shift_num ( buf , & change_socket_ownership ) != 0 ) { errno = 0 ; warnf ( "%s: failed to parse request" , __FUNCTION__ ) ; return - 1 ; } errno = 0 ; if ( getpwnam_r ( user , & pwbuf , pwstrbuf , sizeof ( pwstrbuf ) , & pw ) != 0 ) { warnf ( "%s: getpwnam_r failed" , __FUNCTION__ ) ; Respond } if ( pw == NULL ) { warnf ( "%s: failed to obtain information of user:%s" , __FUNCTION__ , user ) ; Respond } if ( change_socket_ownership ) { char * dir ; if ( chown ( daemon_vars . nb -> sun_ . sun_path , pw -> pw_uid , pw -> pw_gid ) != 0 ) { dief ( "chown failed for:%s" , daemon_vars . nb -> sun_ . sun_path ) ; } dir = dirname ( daemon_vars . nb -> sun_ . sun_path ) ; if ( chown ( dir , pw -> pw_uid , pw -> pw_gid ) != 0 ) { dief ( "chown failed for:%s" , dir ) ; } } if ( setgid ( pw -> pw_gid ) != 0 ) { warnf ( "%s: setgid(%d) failed" , __FUNCTION__ , ( int ) pw -> pw_gid ) ; Respond } if ( initgroups ( pw -> pw_name , pw -> pw_gid ) != 0 ) { warnf ( "%s: initgroups(%s, %d) failed" , __FUNCTION__ , pw -> pw_name , ( int ) pw -> pw_gid ) ; Respond } if ( setuid ( pw -> pw_uid ) != 0 ) { warnf ( "%s: setuid(%d) failed\n" , __FUNCTION__ , ( int ) pw -> pw_uid ) ; Respond } ret = 0 ; Respond iobuf_dispose ( buf ) ; iobuf_push_num ( buf , ret ) ; return 0 ; } 