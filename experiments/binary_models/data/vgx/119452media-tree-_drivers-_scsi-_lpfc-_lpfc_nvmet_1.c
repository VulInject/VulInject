static int lpfc_nvmet_xmt_ls_rsp ( struct nvmet_fc_target_port * tgtport , struct nvmefc_tgt_ls_req * rsp ) { struct lpfc_nvmet_rcv_ctx * ctxp = container_of ( rsp , lpfc_nvmet_rcv_ctx , ctx . ls_req ) ; struct lpfc_hba * phba = ctxp -> phba ; struct hbq_dmabuf * nvmebuf = ( hbq_dmabuf * ) ctxp -> rqb_buffer ; struct lpfc_iocbq * nvmewqeq ; struct lpfc_nvmet_tgtport * nvmep = tgtport -> private ; struct lpfc_dmabuf dmabuf ; struct ulp_bde64 bpl ; int rc ; lpfc_printf_log ( phba , KERN_INFO , LOG_NVME_DISC , "6023 %s: Entrypoint ctx %p %p\n" , __func__ , ctxp , tgtport ) ; nvmewqeq = lpfc_nvmet_prep_ls_wqe ( phba , ctxp , rsp -> rspdma , rsp -> rsplen ) ; if ( nvmewqeq == NULL ) { atomic_inc ( & nvmep -> xmt_ls_drop ) ; lpfc_printf_log ( phba , KERN_ERR , LOG_NVME_IOERR , "6150 LS Drop IO x%x: Prep\n" , ctxp -> oxid ) ; lpfc_in_buf_free ( phba , & nvmebuf -> dbuf ) ; lpfc_nvmet_unsol_ls_issue_abort ( phba , ctxp , ctxp -> sid , ctxp -> oxid ) ; return - ENOMEM ; } nvmewqeq -> rsvd2 = 1 ; nvmewqeq -> hba_wqidx = 0 ; nvmewqeq -> context3 = & dmabuf ; dmabuf . virt = & bpl ; bpl . addrLow = nvmewqeq -> wqe . xmit_sequence . bde . addrLow ; bpl . addrHigh = nvmewqeq -> wqe . xmit_sequence . bde . addrHigh ; bpl . tus . f . bdeSize = rsp -> rsplen ; bpl . tus . f . bdeFlags = 0 ; bpl . tus . w = le32_to_cpu ( bpl . tus . w ) ; nvmewqeq -> wqe_cmpl = lpfc_nvmet_xmt_ls_rsp_cmp ; nvmewqeq -> context2 = ctxp ; lpfc_nvmeio_data ( phba , "NVMET LS  RESP: xri x%x wqidx x%x len x%x\n" , ctxp -> oxid , nvmewqeq -> hba_wqidx , rsp -> rsplen ) ; rc = lpfc_sli4_issue_wqe ( phba , LPFC_ELS_RING , nvmewqeq ) ; if ( rc == WQE_SUCCESS ) { lpfc_in_buf_free ( phba , & nvmebuf -> dbuf ) ; ctxp -> rqb_buffer = 0 ; atomic_inc ( & nvmep -> xmt_ls_rsp ) ; return 0 ; } atomic_inc ( & nvmep -> xmt_ls_drop ) ; lpfc_printf_log ( phba , KERN_ERR , LOG_NVME_IOERR , "6151 LS Drop IO x%x: Issue %d\n" , ctxp -> oxid , rc ) ; lpfc_nlp_put ( nvmewqeq -> context1 ) ; lpfc_in_buf_free ( phba , & nvmebuf -> dbuf ) ; lpfc_nvmet_unsol_ls_issue_abort ( phba , ctxp , ctxp -> sid , ctxp -> oxid ) ; return - ENXIO ; } 