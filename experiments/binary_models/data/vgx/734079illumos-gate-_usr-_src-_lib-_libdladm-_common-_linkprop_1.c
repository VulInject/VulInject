static dladm_status_t dladm_str2cid ( char * buf , mac_dhcpcid_t * cid ) { char * ptr = buf ; char tmp_buf [ DLADM_STRSIZE ] ; uint_t hexlen , cidlen ; bzero ( cid , sizeof ( * cid ) ) ; if ( isdigit ( * ptr ) && ptr [ strspn ( ptr , "0123456789" ) ] == '.' ) { char * cp ; ulong_t duidtype ; ulong_t subtype = 0 ; ulong_t timestamp ; uchar_t * lladdr ; int addrlen ; errno = 0 ; duidtype = strtoul ( ptr , & cp , 0 ) ; if ( ptr == cp || errno != 0 || * cp != '.' || duidtype > USHRT_MAX ) { return ( DLADM_STATUS_BADARG ) ; } ptr = cp + 1 ; if ( duidtype != 0 && duidtype <= DHCPV6_DUID_LL ) { errno = 0 ; subtype = strtoul ( ptr , & cp , 0 ) ; if ( ptr == cp || errno != 0 || * cp != '.' ) { return ( DLADM_STATUS_BADARG ) ; } ptr = cp + 1 ; } switch ( duidtype ) { case DHCPV6_DUID_LLT : { duid_llt_t llt ; errno = 0 ; timestamp = strtoul ( ptr , & cp , 0 ) ; if ( ptr == cp || errno != 0 || * cp != '.' ) { return ( DLADM_STATUS_BADARG ) ; } ptr = cp + 1 ; lladdr = _link_aton ( ptr , & addrlen ) ; if ( lladdr == NULL ) { return ( DLADM_STATUS_BADARG ) ; } cidlen = sizeof ( llt ) + addrlen ; if ( cidlen > sizeof ( cid -> dc_id ) ) { return ( DLADM_STATUS_TOOSMALL ) ; } llt . dllt_dutype = htons ( duidtype ) ; llt . dllt_hwtype = htons ( subtype ) ; llt . dllt_time = htonl ( timestamp ) ; bcopy ( & llt , cid -> dc_id , sizeof ( llt ) ) ; bcopy ( lladdr , cid -> dc_id + sizeof ( llt ) , addrlen ) ; free ( lladdr ) ; break ; } case DHCPV6_DUID_LL : { duid_ll_t ll ; lladdr = _link_aton ( ptr , & addrlen ) ; if ( lladdr == NULL ) { return ( DLADM_STATUS_BADARG ) ; } cidlen = sizeof ( ll ) + addrlen ; if ( cidlen > sizeof ( cid -> dc_id ) ) { free ( lladdr ) ; return ( DLADM_STATUS_TOOSMALL ) ; } ll . dll_dutype = htons ( duidtype ) ; ll . dll_hwtype = htons ( subtype ) ; bcopy ( & ll , cid -> dc_id , sizeof ( ll ) ) ; bcopy ( lladdr , cid -> dc_id + sizeof ( ll ) , addrlen ) ; free ( lladdr ) ; break ; } default : { hexlen = sizeof ( tmp_buf ) ; if ( hexascii_to_octet ( ptr , strlen ( ptr ) , tmp_buf , & hexlen ) != 0 ) { return ( DLADM_STATUS_BADARG ) ; } if ( duidtype == DHCPV6_DUID_EN ) { duid_en_t en ; en . den_dutype = htons ( duidtype ) ; DHCPV6_SET_ENTNUM ( & en , subtype ) ; cidlen = sizeof ( en ) + hexlen ; if ( cidlen > sizeof ( cid -> dc_id ) ) { return ( DLADM_STATUS_TOOSMALL ) ; } bcopy ( & en , cid -> dc_id , sizeof ( en ) ) ; bcopy ( tmp_buf , cid -> dc_id + sizeof ( en ) , hexlen ) ; } else { uint16_t dutype = htons ( duidtype ) ; cidlen = sizeof ( dutype ) + hexlen ; if ( cidlen > sizeof ( cid -> dc_id ) ) { return ( DLADM_STATUS_TOOSMALL ) ; } bcopy ( & dutype , cid -> dc_id , sizeof ( dutype ) ) ; bcopy ( tmp_buf , cid -> dc_id + sizeof ( dutype ) , hexlen ) ; } break ; } } cid -> dc_form = CIDFORM_TYPED ; } if ( strncasecmp ( "0x" , ptr , 2 ) == 0 && ptr [ 2 ] != '\0' ) { ptr += 2 ; hexlen = sizeof ( tmp_buf ) ; if ( hexascii_to_octet ( ptr , strlen ( ptr ) , tmp_buf , & hexlen ) != 0 ) { return ( DLADM_STATUS_BADARG ) ; } cidlen = hexlen ; if ( cidlen > sizeof ( cid -> dc_id ) ) { return ( DLADM_STATUS_TOOSMALL ) ; } bcopy ( tmp_buf , cid -> dc_id , cidlen ) ; cid -> dc_form = CIDFORM_HEX ; } else { cidlen = strlen ( ptr ) ; if ( cidlen > sizeof ( cid -> dc_id ) ) { return ( DLADM_STATUS_TOOSMALL ) ; } bcopy ( ptr , cid -> dc_id , cidlen ) ; cid -> dc_form = CIDFORM_STR ; } cid -> dc_len = cidlen ; return ( DLADM_STATUS_OK ) ; } 