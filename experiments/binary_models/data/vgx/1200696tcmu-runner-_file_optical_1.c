static int fbo_do_format ( struct tcmu_device * dev , uint8_t * sense ) { struct fbo_state * state = tcmur_dev_get_private ( dev ) ; uint32_t done_blocks = 0 ; uint64_t offset = 0 ; uint8_t * buf ; unsigned int length = 1024 * 1024 ; ssize_t ret ; int rc = TCMU_STS_OK ; buf = malloc ( length ) ; if ( ! buf ) { tcmu_dbg ( "  malloc failed\n" ) ; return TCMU_STS_NO_RESOURCE ; } pthread_cleanup_push ( fbo_cleanup_buffer , buf ) ; while ( done_blocks < state -> num_lbas ) { if ( ( state -> num_lbas - done_blocks ) * state -> block_size < length ) { length = ( state -> num_lbas - done_blocks ) * state -> block_size ; } ret = pwrite ( state -> fd , buf , length , offset ) ; if ( ret == - 1 ) { tcmu_err ( "Could not write: %m\n" ) ; rc = TCMU_STS_WR_ERR ; break ; } done_blocks += length / state -> block_size ; offset += length ; if ( done_blocks < state -> num_lbas ) { state -> format_progress = ( 0x10000 * done_blocks ) / state -> num_lbas ; } } pthread_mutex_lock ( & state -> state_mtx ) ; state -> flags &= ~ FBO_FORMATTING ; pthread_mutex_unlock ( & state -> state_mtx ) ; free ( buf ) ; pthread_cleanup_pop ( 0 ) ; return rc ; } 