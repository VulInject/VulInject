void sf_pci_attach ( struct device * parent , struct device * self , void * aux ) { struct sf_pci_softc * psc = ( void * ) self ; struct sf_softc * sc = & psc -> sc_starfire ; struct pci_attach_args * pa = aux ; pci_intr_handle_t ih ; const char * intrstr = NULL ; bus_space_tag_t iot , memt ; bus_space_handle_t ioh , memh ; int ioh_valid , memh_valid ; bus_size_t iosize , memsize ; pcireg_t reg ; pci_set_powerstate ( pa -> pa_pc , pa -> pa_tag , PCI_PMCSR_STATE_D0 ) ; reg = pci_mapreg_type ( pa -> pa_pc , pa -> pa_tag , SF_PCI_MEMBA ) ; switch ( reg ) { case PCI_MAPREG_TYPE_MEM | PCI_MAPREG_MEM_TYPE_32BIT : case PCI_MAPREG_TYPE_MEM | PCI_MAPREG_MEM_TYPE_64BIT : memh_valid = ( pci_mapreg_map ( pa , SF_PCI_MEMBA , reg , 0 , & memt , & memh , & memsize , NULL , 0 ) == 0 ) ; break ; default : memh_valid = 0 ; } ioh_valid = ( pci_mapreg_map ( pa , ( reg == ( PCI_MAPREG_TYPE_MEM | PCI_MAPREG_MEM_TYPE_64BIT ) ) ?SF_PCI_IOBA : SF_PCI_IOBA - 0x04 , PCI_MAPREG_TYPE_IO , 0 , & iot , & ioh , & iosize , NULL , 0 ) == 0 ) ; if ( memh_valid ) { sc -> sc_st = memt ; sc -> sc_sh = memh ; sc -> sc_iomapped = 0 ; } if ( ioh_valid ) { sc -> sc_st = iot ; sc -> sc_sh = ioh ; sc -> sc_iomapped = 1 ; } else { printf ( ": unable to map device registers\n" ) ; return ; } sc -> sc_dmat = pa -> pa_dmat ; if ( pci_intr_map ( pa , & ih ) ) { printf ( ": unable to map interrupt\n" ) ; out } intrstr = pci_intr_string ( pa -> pa_pc , ih ) ; psc -> sc_ih = pci_intr_establish ( pa -> pa_pc , ih , IPL_NET , sf_intr , sc , self -> dv_xname ) ; if ( psc -> sc_ih == NULL ) { printf ( ": unable to establish interrupt" ) ; if ( intrstr != NULL ) { printf ( " at %s" , intrstr ) ; } printf ( "\n" ) ; out } printf ( ": %s" , intrstr ) ; sf_attach ( sc , NULL ) ; return ; out if ( ioh_valid ) { bus_space_unmap ( iot , ioh , iosize ) ; } if ( memh_valid ) { bus_space_unmap ( memt , memh , memsize ) ; } } 