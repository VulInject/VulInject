int krb5_kdf_hmac_sha2 ( const struct gss_krb5_enctype * gk5e , const struct xdr_netobj * inkey , struct xdr_netobj * outkey , const struct xdr_netobj * label , gfp_t gfp_mask ) { struct crypto_shash * tfm ; struct xdr_netobj K1 = { . data = NULL } ; int ret ; tfm = crypto_alloc_shash ( gk5e -> cksum_name , 0 , 0 ) ; if ( IS_ERR ( tfm ) ) { ret = PTR_ERR ( tfm ) ; out } ret = crypto_shash_setkey ( tfm , inkey -> data , inkey -> len ) ; if ( ret ) { out_free_tfm } K1 . len = crypto_shash_digestsize ( tfm ) ; K1 . data = kmalloc ( K1 . len , gfp_mask ) ; if ( ! K1 . data ) { ret = - ENOMEM ; out_free_tfm } ret = krb5_hmac_K1 ( tfm , label , outkey -> len , & K1 ) ; if ( ret ) { out_free_tfm } memcpy ( outkey -> data , K1 . data , outkey -> len ) ; out_free_tfm kfree_sensitive ( K1 . data ) ; out return ret ; } 