static void process_fru_envseg ( ) { env_sensor_t * sensorp ; sensor_thresh_t * threshp ; envseg_layout_t * envsegp ; envseg_sensor_data_t * datap ; fruenvseg_t * frup , * fruenvsegs ; int i , envseglen , sensorcnt ; uint_t offset , length , mapentries ; fruenvsegs = get_fru_envsegs ( ) ; for ( sensorp = & envd_sensors [ 0 ] ; sensorp -> name != NULL ; sensorp ++ ) { if ( sensorp -> fru == NULL ) { continue ; } for ( frup = fruenvsegs ; frup != NULL ; frup = frup -> next ) { if ( strcmp ( frup -> fru , sensorp -> fru ) == 0 ) { break ; } } if ( frup == NULL || frup -> envsegbufp == NULL ) { continue ; } envsegp = ( envseg_layout_t * ) frup -> envsegbufp ; envseglen = frup -> envseglen ; sensorcnt = envsegp -> sensor_count ; for ( i = 0 ; i < sensorcnt ; i ++ ) { uint32_t id ; id = GET_UNALIGN32 ( & envsegp -> sensors [ i ] . sensor_id [ 0 ] ) ; if ( env_debug > 1 ) { envd_log ( LOG_INFO , " sensor[%d]: id:%x\n" , i , id ) ; } if ( id == sensorp -> fru_sensor ) { break ; } } offset = ( uint_t ) GET_UNALIGN16 ( & envsegp -> sensors [ i ] . offset ) ; datap = ( envseg_sensor_data_t * ) ( ( intptr_t ) frup -> envsegbufp + offset ) ; mapentries = GET_UNALIGN16 ( & datap -> obs2exp_cnt ) ; length = sizeof ( envseg_sensor_data_t ) - sizeof ( envseg_map_t ) + mapentries * sizeof ( envseg_map_t ) ; if ( env_debug > 1 ) { envd_log ( LOG_INFO , "Found sensor_id:%x idx:%x " "off:%x #maps:%x expected length:%x\n" , sensorp -> fru_sensor , i , offset , mapentries , length ) ; } if ( offset >= envseglen || ( offset + length ) > envseglen ) { envd_log ( LOG_CRIT , ENV_FRU_BAD_SENSOR_ENTRY , sensorp -> fru_sensor , sensorp -> name , sensorp -> fru ) ; continue ; } if ( env_debug > 1 ) { envd_log ( LOG_INFO , "Thresholds: HPwrOff %d  HShutDn %d  HWarn %d\n" , datap -> high_power_off , datap -> high_shutdown , datap -> high_warning ) ; envd_log ( LOG_INFO , "Thresholds: LWarn %d  LShutDn %d  LPwrOff %d\n" , datap -> low_warning , datap -> low_shutdown , datap -> low_power_off ) ; envd_log ( LOG_INFO , " Policy type: %d #%d data: %x %x %x %x %x %x\n" , datap -> policy_type , datap -> policy_entries , datap -> policy_data [ 0 ] , datap -> policy_data [ 1 ] , datap -> policy_data [ 2 ] , datap -> policy_data [ 3 ] , datap -> policy_data [ 4 ] , datap -> policy_data [ 5 ] ) ; for ( i = 0 ; i < mapentries ; i ++ ) { envd_log ( LOG_INFO , " Map pair# %d: %d %d\n" , i , datap -> obs2exp_map [ i ] . observed , datap -> obs2exp_map [ i ] . expected ) ; } } threshp = sensorp -> temp_thresh ; threshp -> high_power_off = datap -> high_power_off ; threshp -> high_shutdown = datap -> high_shutdown ; threshp -> high_warning = datap -> high_warning ; threshp -> low_warning = datap -> low_warning ; threshp -> low_shutdown = datap -> low_shutdown ; threshp -> low_power_off = datap -> low_power_off ; threshp -> policy_type = datap -> policy_type ; threshp -> policy_entries = datap -> policy_entries ; for ( i = 0 ; i < MAX_POLICY_ENTRIES ; i ++ ) { threshp -> policy_data [ i ] = ( tempr_t ) datap -> policy_data [ i ] ; } if ( sensorp -> obs2exp_map ) { ( void ) free ( sensorp -> obs2exp_map ) ; sensorp -> obs2exp_map = NULL ; sensorp -> obs2exp_cnt = 0 ; } if ( mapentries > 0 ) { tempr_map_t * map ; int cnt ; tempr_t observed , expected ; map = ( tempr_map_t * ) malloc ( mapentries * sizeof ( tempr_map_t ) ) ; if ( map == NULL ) { envd_log ( LOG_CRIT , ENV_FRU_SENSOR_MAP_NOMEM , sensorp -> fru_sensor , sensorp -> name , sensorp -> fru ) ; continue ; } for ( i = 0 , cnt = 0 ; i < mapentries ; i ++ ) { observed = ( tempr_t ) datap -> obs2exp_map [ i ] . observed ; expected = ( tempr_t ) datap -> obs2exp_map [ i ] . expected ; if ( cnt > 0 && observed == map [ cnt - 1 ] . observed && expected == map [ cnt - 1 ] . expected ) { continue ; } map [ cnt ] . observed = observed ; map [ cnt ] . expected = expected ; cnt ++ ; } sensorp -> obs2exp_cnt = cnt ; sensorp -> obs2exp_map = map ; } if ( env_debug > 2 && sensorp -> obs2exp_cnt > 1 ) { char msgbuf [ 256 ] ; envd_log ( LOG_INFO , "Measured -->Correct temperature table " "for sensor: %s\n" , sensorp -> name ) ; for ( i = - 128 ; i < 128 ; i ++ ) { ( void ) sprintf ( & msgbuf [ 6 * ( i & 0x7 ) ] , "%6d" , xlate_obs2exp ( sensorp , i ) ) ; if ( ( i & 0x7 ) == 0x7 ) { envd_log ( LOG_INFO , "%8d: %s\n" , ( i & ~ 0x7 ) , msgbuf ) ; } } if ( ( i & 0x7 ) != 0 ) { ( void ) printf ( "%8d: %s\n" , ( i & ~ 0x7 ) , msgbuf ) ; } envd_log ( LOG_INFO , "Correct -->Measured temperature table " "for sensor: %s\n" , sensorp -> name ) ; for ( i = - 128 ; i < 128 ; i ++ ) { ( void ) sprintf ( & msgbuf [ 6 * ( i & 0x7 ) ] , "%6d" , xlate_exp2obs ( sensorp , i ) ) ; if ( ( i & 0x7 ) == 0x7 ) { envd_log ( LOG_INFO , "%8d: %s\n" , ( i & ~ 0x7 ) , msgbuf ) ; } } if ( ( i & 0x7 ) != 0 ) { envd_log ( LOG_INFO , "%8d: %s\n" , ( i & ~ 0x7 ) , msgbuf ) ; } } } while ( fruenvsegs ) { frup = fruenvsegs ; fruenvsegs = frup -> next ; if ( frup -> envsegbufp != NULL ) { ( void ) free ( frup -> envsegbufp ) ; } ( void ) free ( frup ) ; } } 