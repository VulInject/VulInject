static void apne_block_input ( struct net_device * dev , int count , struct sk_buff * skb , int ring_offset ) static void apne_block_output ( struct net_device * dev , const int count , const unsigned char * buf , const int start_page ) static irqreturn_t apne_interrupt ( int irq , void * dev_id ) static int init_pcmcia ( void ) static const char version [ ] "apne.c:v1.1 7/10/98 Alain Malek (Alain.Malek@cryogen.ch)\n" ; ; static int apne_owned ; static u32 apne_msg_enable ; module_param_named ( msg_enable , apne_msg_enable , uint , ( S_IRUSR | S_IRGRP | S_IROTH ) ) ; MODULE_PARM_DESC ( msg_enable , "Debug message level (see linux/netdevice.h for bitmap)" ) ; struct net_device * __init apne_probe ( int unit ) { struct net_device * dev ; struct ei_device * ei_local ; char tuple [ 8 ] ; int err ; if ( ! MACH_IS_AMIGA ) { return ERR_PTR ( - ENODEV ) ; } if ( apne_owned ) { return ERR_PTR ( - ENODEV ) ; } if ( ! ( AMIGAHW_PRESENT ( PCMCIA ) ) ) { return ERR_PTR ( - ENODEV ) ; } pr_info ( "Looking for PCMCIA ethernet card : " ) ; if ( ! ( PCMCIA_INSERTED ) ) { pr_cont ( "NO PCMCIA card inserted\n" ) ; return ERR_PTR ( - ENODEV ) ; } dev = alloc_ei_netdev ( ) ; if ( ! dev ) { return ERR_PTR ( - ENOMEM ) ; } if ( unit >= 0 ) { sprintf ( dev -> name , "eth%d" , unit ) ; netdev_boot_setup_check ( dev ) ; } ei_local = netdev_priv ( dev ) ; ei_local -> msg_enable = apne_msg_enable ; pcmcia_disable_irq ( ) ; if ( ( pcmcia_copy_tuple ( CISTPL_FUNCID , tuple , 8 ) < 3 ) || ( tuple [ 2 ] != CISTPL_FUNCID_NETWORK ) ) { pr_cont ( "not an ethernet card\n" ) ; return ERR_PTR ( - ENODEV ) ; } pr_cont ( "ethernet PCMCIA card inserted\n" ) ; if ( ! init_pcmcia ( ) ) { free_netdev ( dev ) ; return ERR_PTR ( - ENODEV ) ; } if ( ! request_region ( IOBASE , 0x20 , DRV_NAME ) ) { free_netdev ( dev ) ; return ERR_PTR ( - EBUSY ) ; } err = apne_probe1 ( dev , IOBASE ) ; if ( err ) { release_region ( IOBASE , 0x20 ) ; free_netdev ( dev ) ; return ERR_PTR ( err ) ; } err = register_netdev ( dev ) ; if ( ! err ) { return dev ; } pcmcia_disable_irq ( ) ; free_irq ( IRQ_AMIGA_PORTS , dev ) ; pcmcia_reset ( ) ; release_region ( IOBASE , 0x20 ) ; free_netdev ( dev ) ; return ERR_PTR ( err ) ; } 