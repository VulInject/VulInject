static int lm3533_led_probe ( struct platform_device * pdev ) { struct lm3533 * lm3533 ; struct lm3533_led_platform_data * pdata ; struct lm3533_led * led ; int ret ; dev_dbg ( & pdev -> dev , "%s\n" , __func__ ) ; lm3533 = dev_get_drvdata ( pdev -> dev . parent ) ; if ( ! lm3533 ) { return - EINVAL ; } pdata = dev_get_platdata ( & pdev -> dev ) ; if ( ! pdata ) { dev_err ( & pdev -> dev , "no platform data\n" ) ; return - EINVAL ; } if ( pdev -> id < 0 || pdev -> id >= LM3533_LVCTRLBANK_COUNT ) { dev_err ( & pdev -> dev , "illegal LED id %d\n" , pdev -> id ) ; return - EINVAL ; } led = devm_kzalloc ( & pdev -> dev , sizeof ( * led ) , GFP_KERNEL ) ; if ( ! led ) { return - ENOMEM ; } led -> lm3533 = lm3533 ; led -> cdev . name = pdata -> name ; led -> cdev . default_trigger = pdata -> default_trigger ; led -> cdev . brightness_set_blocking = lm3533_led_set ; led -> cdev . brightness_get = lm3533_led_get ; led -> cdev . blink_set = lm3533_led_blink_set ; led -> cdev . brightness = LED_OFF ; led -> cdev . groups = lm3533_led_attribute_groups ; led -> id = pdev -> id ; led -> cb . lm3533 = lm3533 ; led -> cb . id = lm3533_led_get_ctrlbank_id ( led ) ; led -> cb . dev = lm3533 -> dev ; platform_set_drvdata ( pdev , led ) ; ret = led_classdev_register ( pdev -> dev . parent , & led -> cdev ) ; if ( ret ) { dev_err ( & pdev -> dev , "failed to register LED %d\n" , pdev -> id ) ; return ret ; } led -> cb . dev = led -> cdev . dev ; ret = lm3533_led_setup ( led , pdata ) ; if ( ret ) { err_deregister } ret = lm3533_ctrlbank_enable ( & led -> cb ) ; if ( ret ) { err_deregister } return 0 ; err_deregister led_classdev_unregister ( & led -> cdev ) ; return ret ; } 