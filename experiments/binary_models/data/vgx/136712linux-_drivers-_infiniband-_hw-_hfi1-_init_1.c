void hfi1_free_devdata ( struct hfi1_devdata * dd ) { struct hfi1_asic_data * ad ; unsigned long flags ; xa_lock_irqsave ( & hfi1_dev_table , flags ) ; __xa_erase ( & hfi1_dev_table , dd -> unit ) ; ad = release_asic_data ( dd ) ; xa_unlock_irqrestore ( & hfi1_dev_table , flags ) ; finalize_asic_data ( dd , ad ) ; free_platform_config ( dd ) ; rcu_barrier ( ) ; free_percpu ( dd -> int_counter ) ; free_percpu ( dd -> rcv_limit ) ; free_percpu ( dd -> send_schedule ) ; free_percpu ( dd -> tx_opstats ) ; dd -> int_counter = NULL ; dd -> rcv_limit = NULL ; dd -> send_schedule = NULL ; kfree ( dd -> comp_vect ) ; dd -> comp_vect = NULL ; if ( dd -> rcvhdrtail_dummy_kvaddr ) { dma_free_coherent ( & dd -> pcidev -> dev , sizeof ( u64 ) , ( void * ) dd -> rcvhdrtail_dummy_kvaddr , dd -> rcvhdrtail_dummy_dma ) ; } dd -> rcvhdrtail_dummy_kvaddr = NULL ; sdma_clean ( dd , dd -> num_sdma ) ; rvt_dealloc_device ( & dd -> verbs_dev . rdi ) ; } 