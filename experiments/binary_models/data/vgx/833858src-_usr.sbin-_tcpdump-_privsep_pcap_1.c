pcap_t * priv_pcap_offline ( const char * fname , char * errbuf ) { pcap_t * p ; FILE * fp = NULL ; struct pcap_file_header hdr ; int linklen , err ; if ( priv_fd < 0 ) { errx ( 1 , "%s: called from privileged portion" , __func__ ) ; } p = malloc ( sizeof ( * p ) ) ; if ( p == NULL ) { strlcpy ( errbuf , "out of swap" , PCAP_ERRBUF_SIZE ) ; return ( NULL ) ; } memset ( ( char * ) p , 0 , sizeof ( * p ) ) ; if ( fname [ 0 ] == '-' && fname [ 1 ] == '\0' ) { p -> fd = - 1 ; fp = stdin ; } else { write_command ( priv_fd , PRIV_OPEN_DUMP ) ; p -> fd = receive_fd ( priv_fd , NULL ) ; must_read ( priv_fd , & err , sizeof ( int ) ) ; if ( p -> fd < 0 ) { snprintf ( errbuf , PCAP_ERRBUF_SIZE , "Failed to open input file %s: %s" , fname , strerror ( err ) ) ; bad } fp = fdopen ( p -> fd , "r" ) ; if ( fp == NULL ) { snprintf ( errbuf , PCAP_ERRBUF_SIZE , "%s: %s" , fname , pcap_strerror ( errno ) ) ; close ( p -> fd ) ; p -> fd = - 1 ; bad } } if ( fread ( ( char * ) & hdr , sizeof ( hdr ) , 1 , fp ) != 1 ) { snprintf ( errbuf , PCAP_ERRBUF_SIZE , "fread: %s" , pcap_strerror ( errno ) ) ; bad } if ( hdr . magic != TCPDUMP_MAGIC ) { if ( swap32 ( hdr . magic ) != TCPDUMP_MAGIC ) { snprintf ( errbuf , PCAP_ERRBUF_SIZE , "bad dump file format" ) ; bad } p -> sf . swapped = 1 ; swap_hdr ( & hdr ) ; } if ( hdr . version_major < PCAP_VERSION_MAJOR ) { snprintf ( errbuf , PCAP_ERRBUF_SIZE , "archaic file format" ) ; bad } p -> tzoff = hdr . thiszone ; p -> snapshot = hdr . snaplen ; p -> linktype = hdr . linktype ; p -> sf . rfile = fp ; p -> bufsize = hdr . snaplen ; switch ( p -> linktype ) { case DLT_EN10MB : linklen = 14 ; break ; case DLT_FDDI : linklen = 13 + 8 ; break ; case DLT_NULL : default : linklen = 0 ; break ; } if ( p -> bufsize < 0 ) { p -> bufsize = BPF_MAXBUFSIZE ; } p -> sf . base = malloc ( p -> bufsize + BPF_ALIGNMENT ) ; if ( p -> sf . base == NULL ) { strlcpy ( errbuf , "out of swap" , PCAP_ERRBUF_SIZE ) ; bad } p -> buffer = p -> sf . base + BPF_ALIGNMENT - ( linklen % BPF_ALIGNMENT ) ; p -> sf . version_major = hdr . version_major ; p -> sf . version_minor = hdr . version_minor ; pcap_fddipad = 0 ; return ( p ) ; bad if ( fp != NULL && p -> fd != - 1 ) { fclose ( fp ) ; } free ( p ) ; return ( NULL ) ; } 