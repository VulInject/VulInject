int lldp_network_bind_raw_socket ( int ifindex ) { static const struct sock_filter filter [ ] { BPF_STMT ( BPF_LD + BPF_W + BPF_ABS , offsetof ( ethhdr , h_dest ) ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , 0x0180c200 , 1 , 0 ) BPF_STMT ( BPF_RET + BPF_K , 0 ) BPF_STMT ( BPF_LD + BPF_H + BPF_ABS , offsetof ( ethhdr , h_dest ) + 4 ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , 0x0000 , 3 , 0 ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , 0x0003 , 2 , 0 ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , 0x000e , 1 , 0 ) BPF_STMT ( BPF_RET + BPF_K , 0 ) BPF_STMT ( BPF_LD + BPF_H + BPF_ABS , offsetof ( ethhdr , h_proto ) ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , ETHERTYPE_LLDP , 1 , 0 ) BPF_STMT ( BPF_RET + BPF_K , 0 ) BPF_STMT ( BPF_RET + BPF_K , UINT32_MAX ) } ; ; static const struct sock_fprog fprog = { . len = ELEMENTSOF ( filter ) . filter = ( sock_filter * ) filter } ; struct packet_mreq mreq = { . mr_ifindex = ifindex . mr_type = PACKET_MR_MULTICAST . mr_alen = ETH_ALEN . mr_address = { 0x01 0x80 0xC2 0x00 0x00 0x00 } } ; union sockaddr_union saddrll = { . ll . sll_family = AF_PACKET . ll . sll_ifindex = ifindex } ; _cleanup_close_ int fd = - EBADF ; assert ( ifindex > 0 ) ; fd = socket ( AF_PACKET , SOCK_RAW | SOCK_CLOEXEC | SOCK_NONBLOCK , htobe16 ( ETHERTYPE_LLDP ) ) ; if ( setsockopt ( fd , SOL_SOCKET , SO_ATTACH_FILTER , & fprog , sizeof ( fprog ) ) < 0 ) { return - errno ; } if ( setsockopt ( fd , SOL_PACKET , PACKET_ADD_MEMBERSHIP , & mreq , sizeof ( mreq ) ) < 0 ) { return - errno ; } mreq . mr_address [ ETH_ALEN - 1 ] = 0x03 ; if ( setsockopt ( fd , SOL_PACKET , PACKET_ADD_MEMBERSHIP , & mreq , sizeof ( mreq ) ) < 0 ) { return - errno ; } mreq . mr_address [ ETH_ALEN - 1 ] = 0x0E ; if ( setsockopt ( fd , SOL_PACKET , PACKET_ADD_MEMBERSHIP , & mreq , sizeof ( mreq ) ) < 0 ) { return - errno ; } if ( bind ( fd , & saddrll . sa , sizeof ( saddrll . ll ) ) < 0 ) { return - errno ; } return TAKE_FD ( fd ) ; } 