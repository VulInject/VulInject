static int qeth_l2_set_online ( struct qeth_card * card , bool carrier_ok ) { struct net_device * dev = card -> dev ; int rc = 0 ; qeth_l2_detect_dev2br_support ( card ) ; mutex_lock ( & card -> sbp_lock ) ; qeth_bridgeport_query_support ( card ) ; if ( card -> options . sbp . supported_funcs ) { qeth_l2_setup_bridgeport_attrs ( card ) ; dev_info ( & card -> gdev -> dev , "The device represents a Bridge Capable Port\n" ) ; } mutex_unlock ( & card -> sbp_lock ) ; qeth_l2_register_dev_addr ( card ) ; qeth_l2_vnicc_init ( card ) ; qeth_l2_trace_features ( card ) ; QETH_CARD_TEXT ( card , 2 , "softsetp" ) ; card -> state = CARD_STATE_SOFTSETUP ; qeth_set_allowed_threads ( card , 0xffffffff , 0 ) ; if ( dev -> reg_state != NETREG_REGISTERED ) { rc = qeth_l2_setup_netdev ( card ) ; if ( rc ) { err_setup } if ( carrier_ok ) { netif_carrier_on ( dev ) ; } } else { rtnl_lock ( ) ; rc = qeth_set_real_num_tx_queues ( card , qeth_tx_actual_queues ( card ) ) ; if ( rc ) { rtnl_unlock ( ) ; err_set_queues } if ( carrier_ok ) { netif_carrier_on ( dev ) ; } else { netif_carrier_off ( dev ) ; } netif_device_attach ( dev ) ; qeth_enable_hw_features ( dev ) ; qeth_l2_enable_brport_features ( card , NULL ) ; if ( card -> info . open_when_online ) { card -> info . open_when_online = 0 ; dev_open ( dev , NULL ) ; } rtnl_unlock ( ) ; } return 0 ; err_set_queues err_setup qeth_set_allowed_threads ( card , 0 , 1 ) ; card -> state = CARD_STATE_DOWN ; return rc ; } 