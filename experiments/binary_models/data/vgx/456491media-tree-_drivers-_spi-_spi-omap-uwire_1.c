static int uwire_probe ( struct platform_device * pdev ) { struct spi_master * master ; struct uwire_spi * uwire ; int status ; master = spi_alloc_master ( & pdev -> dev , sizeof uwire ) ; if ( ! master ) { return - ENODEV ; } uwire = spi_master_get_devdata ( master ) ; uwire_base = devm_ioremap ( & pdev -> dev , UWIRE_BASE_PHYS , UWIRE_IO_SIZE ) ; if ( ! uwire_base ) { dev_dbg ( & pdev -> dev , "can't ioremap UWIRE\n" ) ; spi_master_put ( master , NULL ) ; return - ENOMEM ; } platform_set_drvdata ( pdev , uwire ) ; uwire -> ck = devm_clk_get ( & pdev -> dev , "fck" ) ; if ( IS_ERR ( uwire -> ck ) ) { status = PTR_ERR ( uwire -> ck ) ; dev_dbg ( & pdev -> dev , "no functional clock?\n" ) ; spi_master_put ( master ) ; return status ; } clk_enable ( uwire -> ck ) ; if ( cpu_is_omap7xx ( ) ) { uwire_idx_shift = 1 ; } else { uwire_idx_shift = 2 ; } uwire_write_reg ( UWIRE_SR3 , 1 ) ; master -> mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH ; master -> bits_per_word_mask = SPI_BPW_RANGE_MASK ( 1 , 16 ) ; master -> flags = SPI_MASTER_HALF_DUPLEX ; master -> bus_num = 2 ; master -> num_chipselect = 4 ; master -> setup = uwire_setup ; master -> cleanup = uwire_cleanup ; uwire -> bitbang . master = master ; uwire -> bitbang . chipselect = uwire_chipselect ; uwire -> bitbang . setup_transfer = uwire_setup_transfer ; uwire -> bitbang . txrx_bufs = uwire_txrx ; status = spi_bitbang_start ( & uwire -> bitbang ) ; if ( status < 0 ) { uwire_off ( uwire ) ; } return status ; } 