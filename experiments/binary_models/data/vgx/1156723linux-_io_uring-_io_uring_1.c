int io_submit_sqes ( io_ring_ctx * ctx , unsigned int nr ) __must_hold ( & ctx -> uring_lock ) ( unsigned int entries = io_sqring_entries ( ctx ) , unsigned int left , int ret , ( unlikely ( ! entries ) ) return 0 ; ) ; ret = left = min3 ( nr , ctx -> sq_entries , entries ) ; io_get_task_refs ( left ) ; io_submit_state_start ( & ctx -> submit_state , left ) ; { const struct io_uring_sqe * sqe ; struct io_kiocb * req ; if ( unlikely ( ! io_alloc_req ( ctx , & req ) ) ) { break ; } if ( unlikely ( ! io_get_sqe ( ctx , & sqe ) ) ) { io_req_add_to_cache ( req , ctx ) ; break ; } if ( unlikely ( io_submit_sqe ( ctx , req , sqe ) ) && ! ( ctx -> flags & IORING_SETUP_SUBMIT_ALL ) ) { left -- ; break ; } } -- left ; if ( unlikely ( left ) ) { ret -= left ; if ( ! ret && io_req_cache_empty ( ctx ) ) { ret = - EAGAIN ; } current -> io_uring -> cached_refs += left ; } io_submit_state_end ( ctx , NULL ) ; io_commit_sqring ( ctx ) ; return ret ; 