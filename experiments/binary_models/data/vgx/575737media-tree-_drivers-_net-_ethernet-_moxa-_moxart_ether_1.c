static int moxart_mac_probe ( struct platform_device * pdev ) { struct device * p_dev = & pdev -> dev ; struct device_node * node = p_dev -> of_node ; struct net_device * ndev ; struct moxart_mac_priv_t * priv ; struct resource * res ; unsigned int irq ; int ret ; ndev = alloc_etherdev ( sizeof ( moxart_mac_priv_t ) ) ; if ( ! ndev ) { return - ENOMEM ; } irq = irq_of_parse_and_map ( node , 0 ) ; if ( irq <= 0 ) { netdev_err ( ndev , "irq_of_parse_and_map failed\n" ) ; ret = - EINVAL ; irq_map_fail } priv = netdev_priv ( ndev ) ; priv -> ndev = ndev ; res = platform_get_resource ( pdev , IORESOURCE_MEM , 0 ) ; ndev -> base_addr = res -> start ; priv -> base = devm_ioremap_resource ( p_dev , res ) ; if ( IS_ERR ( priv -> base ) ) { dev_err ( p_dev , "devm_ioremap_resource failed\n" ) ; ret = PTR_ERR ( priv -> base ) ; init_fail } spin_lock_init ( & priv -> txlock ) ; priv -> tx_buf_size = TX_BUF_SIZE ; priv -> rx_buf_size = RX_BUF_SIZE ; priv -> tx_desc_base = dma_alloc_coherent ( NULL , TX_REG_DESC_SIZE * TX_DESC_NUM , & priv -> tx_base , GFP_DMA | GFP_KERNEL ) ; if ( priv -> tx_desc_base == NULL ) { ret = - ENOMEM ; init_fail } priv -> rx_desc_base = dma_alloc_coherent ( NULL , RX_REG_DESC_SIZE * RX_DESC_NUM , & priv -> rx_base , GFP_DMA | GFP_KERNEL ) ; if ( priv -> rx_desc_base == NULL ) { ret = - ENOMEM ; init_fail } priv -> tx_buf_base = kmalloc ( priv -> tx_buf_size * TX_DESC_NUM , GFP_ATOMIC ) ; if ( ! priv -> tx_buf_base ) { ret = - ENOMEM ; init_fail } priv -> rx_buf_base = kmalloc ( priv -> rx_buf_size * RX_DESC_NUM , GFP_ATOMIC ) ; if ( ! priv -> rx_buf_base ) { ret = - ENOMEM ; init_fail } platform_set_drvdata ( pdev , ndev ) ; ret = devm_request_irq ( p_dev , irq , moxart_mac_interrupt , 0 , pdev -> name , ndev ) ; if ( ret ) { netdev_err ( ndev , "devm_request_irq failed\n" ) ; init_fail } ndev -> netdev_ops = & moxart_netdev_ops ; netif_napi_add ( ndev , & priv -> napi , moxart_rx_poll , RX_DESC_NUM ) ; ndev -> priv_flags |= IFF_UNICAST_FLT ; ndev -> irq = irq ; SET_NETDEV_DEV ( ndev , & pdev -> dev ) ; ret = register_netdev ( ndev ) ; if ( ret ) { init_fail } netdev_dbg ( ndev , "%s: IRQ=%d address=%pM\n" , __func__ , ndev -> irq , ndev -> dev_addr ) ; return 0 ; init_fail netdev_err ( ndev , "init failed\n" ) ; moxart_mac_free_memory ( ndev ) ; irq_map_fail free_netdev ( ndev ) ; return ret ; } 