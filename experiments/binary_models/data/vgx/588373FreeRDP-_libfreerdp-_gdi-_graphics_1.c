HGDI_BITMAP gdi_create_bitmap ( rdpGdi * gdi , UINT32 nWidth , UINT32 nHeight , UINT32 SrcFormat , BYTE * data ) { UINT32 nSrcStep ; UINT32 nDstStep ; BYTE * pSrcData ; BYTE * pDstData ; HGDI_BITMAP bitmap ; if ( ! gdi ) { return NULL ; } nDstStep = nWidth * FreeRDPGetBytesPerPixel ( gdi -> dstFormat ) ; pDstData = winpr_aligned_malloc ( nHeight * nDstStep * 1ULL , 16 ) ; if ( ! pDstData ) { return NULL ; } pSrcData = data ; nSrcStep = nWidth * FreeRDPGetBytesPerPixel ( SrcFormat ) ; if ( ! freerdp_image_copy ( pDstData , gdi -> dstFormat , nDstStep , 0 , 0 , nWidth , nHeight , pSrcData , SrcFormat , nSrcStep , 0 , 0 , & gdi -> palette , FREERDP_FLIP_NONE ) ) { return NULL ; } bitmap = gdi_CreateBitmap ( nWidth , nHeight , gdi -> dstFormat , pDstData ) ; return bitmap ; } 