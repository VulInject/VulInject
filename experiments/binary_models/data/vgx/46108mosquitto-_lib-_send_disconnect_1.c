int send__disconnect ( struct mosquitto * mosq , uint8_t reason_code , const mosquitto_property * properties ) { struct mosquitto__packet * packet = NULL ; int rc ; assert ( mosq ) ; if ( mosq -> bridge ) { log__printf ( mosq , MOSQ_LOG_DEBUG , "Bridge %s sending DISCONNECT" , SAFE_PRINT ( mosq -> id ) ) ; } else { log__printf ( mosq , MOSQ_LOG_DEBUG , "Sending DISCONNECT to %s (rc%d)" , SAFE_PRINT ( mosq -> id ) , reason_code ) ; } log__printf ( mosq , MOSQ_LOG_DEBUG , "Client %s sending DISCONNECT" , SAFE_PRINT ( mosq -> id ) ) ; assert ( mosq ) ; packet = mosquitto__calloc ( 1 , sizeof ( mosquitto__packet ) ) ; if ( ! packet ) { return MOSQ_ERR_NOMEM ; } packet -> command = CMD_DISCONNECT ; if ( mosq -> protocol == mosq_p_mqtt5 && ( reason_code != 0 || properties ) ) { packet -> remaining_length = 1 ; if ( properties ) { packet -> remaining_length += property__get_remaining_length ( properties ) ; } } else { packet -> remaining_length = 0 ; } rc = packet__alloc ( packet ) ; if ( rc ) { return rc ; } if ( mosq -> protocol == mosq_p_mqtt5 && ( reason_code != 0 || properties ) ) { packet__write_byte ( packet , reason_code ) ; if ( properties ) { property__write_all ( packet , properties , true ) ; } } return packet__queue ( mosq , packet ) ; } 