static int tiadc_read_raw ( struct iio_dev * indio_dev , struct iio_chan_spec const * chan , int * val , int * val2 , long mask ) { struct tiadc_device * adc_dev = iio_priv ( indio_dev ) ; int i , map_val ; unsigned int fifo1count , read , stepid ; bool found = false ; u32 step_en ; unsigned long timeout ; int ret ; switch ( mask ) { case IIO_CHAN_INFO_RAW : break ; case IIO_CHAN_INFO_SCALE : switch ( chan -> type ) { case IIO_VOLTAGE : * val = 1800 ; * val2 = chan -> scan_type . realbits ; return IIO_VAL_FRACTIONAL_LOG2 ; default : return - EINVAL ; } break ; default : return - EINVAL ; } if ( iio_buffer_enabled ( indio_dev ) ) { return - EBUSY ; } step_en = get_adc_chan_step_mask ( adc_dev , chan ) ; mutex_lock ( & adc_dev -> fifo1_lock ) ; ret = tiadc_wait_idle ( adc_dev ) ; if ( ret ) { err_unlock } fifo1count = tiadc_readl ( adc_dev , REG_FIFO1CNT ) ; while ( fifo1count -- ) { tiadc_readl ( adc_dev , REG_FIFO1 ) ; } am335x_tsc_se_set_once ( adc_dev -> mfd_tscadc , step_en ) ; timeout = jiffies + msecs_to_jiffies ( IDLE_TIMEOUT_MS * adc_dev -> channels ) ; while ( 1 ) { fifo1count = tiadc_readl ( adc_dev , REG_FIFO1CNT ) ; if ( fifo1count ) { break ; } if ( time_after ( jiffies , timeout ) ) { am335x_tsc_se_adc_done ( adc_dev -> mfd_tscadc ) ; ret = - EAGAIN ; err_unlock } } map_val = adc_dev -> channel_step [ chan -> scan_index ] ; for ( i = 0 ; i < fifo1count ; i ++ ) { read = tiadc_readl ( adc_dev , REG_FIFO1 ) ; stepid = read & FIFOREAD_CHNLID_MASK ; stepid = stepid >> 0x10 ; if ( stepid == map_val ) { read = read & FIFOREAD_DATA_MASK ; found = true ; * val = ( u16 ) read ; } } am335x_tsc_se_adc_done ( adc_dev -> mfd_tscadc ) ; if ( ! found ) { ret = - EBUSY ; } err_unlock mutex_unlock ( & adc_dev -> fifo1_lock ) ; return ret ?ret : IIO_VAL_INT ; } 