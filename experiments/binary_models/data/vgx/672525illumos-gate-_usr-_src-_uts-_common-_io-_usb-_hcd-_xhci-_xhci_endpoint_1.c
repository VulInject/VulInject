int xhci_endpoint_update_default ( xhci_t * xhcip , xhci_device_t * xd , xhci_endpoint_t * xep ) { int mps , desc , info , ret ; mps = XHCI_EPCTX_GET_MPS ( xd -> xd_endout [ xep -> xep_num ] -> xec_info2 ) ; desc = xd -> xd_usbdev -> usb_dev_descr -> bMaxPacketSize0 ; if ( xd -> xd_usbdev -> usb_port_status >= USBA_SUPER_SPEED_DEV ) { desc = 1 << desc ; } if ( mps == desc ) { return ( USB_SUCCESS ) ; } mutex_enter ( & xd -> xd_imtx ) ; info = LE_32 ( xd -> xd_endout [ xep -> xep_num ] -> xec_info2 ) ; info &= ~ XHCI_EPCTX_SET_MPS ( mps ) ; info |= XHCI_EPCTX_SET_MPS ( desc ) ; xd -> xd_endin [ xep -> xep_num ] -> xec_info2 = LE_32 ( info ) ; xd -> xd_input -> xic_drop_flags = LE_32 ( 0 ) ; xd -> xd_input -> xic_add_flags = LE_32 ( XHCI_INCTX_MASK_DCI ( 1 ) ) ; ret = xhci_command_evaluate_context ( xhcip , xd ) ; mutex_exit ( & xd -> xd_imtx ) ; return ( ret ) ; } 