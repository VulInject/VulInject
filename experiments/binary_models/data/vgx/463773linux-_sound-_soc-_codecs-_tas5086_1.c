static int tas5086_hw_params ( struct snd_pcm_substream * substream , struct snd_pcm_hw_params * params , struct snd_soc_dai * dai ) { struct snd_soc_component * component = dai -> component ; struct tas5086_private * priv = snd_soc_component_get_drvdata ( component ) ; int val ; int ret ; priv -> rate = params_rate ( params ) ; val = index_in_array ( tas5086_sample_rates , ARRAY_SIZE ( tas5086_sample_rates ) , priv -> rate ) ; if ( val < 0 ) { dev_err ( component -> dev , "Invalid sample rate\n" ) ; return - EINVAL ; } ret = regmap_update_bits ( priv -> regmap , TAS5086_CLOCK_CONTROL , TAS5086_CLOCK_RATE_MASK , TAS5086_CLOCK_RATE ( val ) ) ; val = index_in_array ( tas5086_ratios , ARRAY_SIZE ( tas5086_ratios ) , priv -> mclk / priv -> rate ) ; if ( val < 0 ) { dev_err ( component -> dev , "Invalid MCLK / Fs ratio\n" ) ; return - EINVAL ; } ret = regmap_update_bits ( priv -> regmap , TAS5086_CLOCK_CONTROL , TAS5086_CLOCK_RATIO_MASK , TAS5086_CLOCK_RATIO ( val ) ) ; if ( ret < 0 ) { return ret ; } ret = regmap_update_bits ( priv -> regmap , TAS5086_CLOCK_CONTROL , TAS5086_CLOCK_SCLK_RATIO_48 , ( priv -> sclk == 48 * priv -> rate ) ?TAS5086_CLOCK_SCLK_RATIO_48 : 0 ) ; if ( ret < 0 ) { return ret ; } switch ( priv -> format & SND_SOC_DAIFMT_FORMAT_MASK ) { case SND_SOC_DAIFMT_RIGHT_J : val = 0x00 ; break ; case SND_SOC_DAIFMT_I2S : val = 0x03 ; break ; case SND_SOC_DAIFMT_LEFT_J : val = 0x06 ; break ; default : dev_err ( component -> dev , "Invalid DAI format\n" ) ; return - EINVAL ; } switch ( params_width ( params ) ) { case 16 : val += 0 ; break ; case 20 : val += 1 ; break ; case 24 : val += 2 ; break ; default : dev_err ( component -> dev , "Invalid bit width\n" ) ; return - EINVAL ; } ret = regmap_write ( priv -> regmap , TAS5086_SERIAL_DATA_IF , val ) ; if ( ret < 0 ) { return ret ; } ret = regmap_update_bits ( priv -> regmap , TAS5086_CLOCK_CONTROL , TAS5086_CLOCK_VALID , TAS5086_CLOCK_VALID ) ; if ( ret < 0 ) { return ret ; } return tas5086_set_deemph ( component ) ; } 