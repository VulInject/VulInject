static int papr_scm_meta_set ( struct papr_scm_priv * p , struct nd_cmd_set_config_hdr * hdr ) { unsigned long offset , data_offset ; int len , wrote ; unsigned long data ; __be64 data_be ; int64_t ret ; if ( ( hdr -> in_offset + hdr -> in_length ) > p -> metadata_size ) { return - EINVAL ; } for ( len = hdr -> in_length ; len ; len -= wrote ) { data_offset = hdr -> in_length - len ; offset = hdr -> in_offset + data_offset ; if ( len >= 8 ) { data = * ( uint64_t * ) ( hdr -> in_buf + data_offset ) ; data_be = cpu_to_be64 ( data , NULL ) ; wrote = 8 ; } if ( len >= 4 ) { data = * ( uint32_t * ) ( hdr -> in_buf + data_offset ) ; data &= 0xffffffff ; data_be = cpu_to_be32 ( data ) ; wrote = 4 ; } if ( len >= 2 ) { data = * ( uint16_t * ) ( hdr -> in_buf + data_offset ) ; data &= 0xffff ; data_be = cpu_to_be16 ( data ) ; wrote = 2 ; } else { data_be = * ( uint8_t * ) ( hdr -> in_buf + data_offset ) ; data_be &= 0xff ; wrote = 1 ; } ret = plpar_hcall_norets ( H_SCM_WRITE_METADATA , p -> drc_index , offset , data_be , wrote ) ; if ( ret == H_PARAMETER ) { return - ENODEV ; } if ( ret ) { return - EINVAL ; } } return 0 ; } 