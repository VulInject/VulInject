static krb5_error_code k5identity_choose ( krb5_context context , krb5_ccselect_moddata data , krb5_principal server , krb5_ccache * cache_out , krb5_principal * princ_out ) { krb5_error_code ret ; krb5_principal princ = NULL ; char * filename , * homedir ; FILE * fp ; char buf [ 256 ] ; * cache_out = NULL ; * princ_out = NULL ; homedir = get_homedir ( context ) ; if ( homedir == NULL ) { return KRB5_PLUGIN_NO_HANDLE ; } ret = k5_path_join ( homedir , ".k5identity" , & filename ) ; if ( ret ) { return ret ; } fp = fopen ( filename , "r" ) ; free ( filename ) ; if ( fp == NULL ) { return KRB5_PLUGIN_NO_HANDLE ; } while ( fgets ( buf , sizeof ( buf ) , fp ) != NULL ) { if ( parse_line ( context , buf , server , & princ ) ) { break ; } } fclose ( fp ) ; if ( princ == NULL ) { return KRB5_PLUGIN_NO_HANDLE ; } ret = krb5_cc_cache_match ( context , princ , cache_out ) ; if ( ret == 0 || ret == KRB5_CC_NOTFOUND ) { * princ_out = princ ; } else { krb5_free_principal ( context , princ ) ; } return ret ; } 