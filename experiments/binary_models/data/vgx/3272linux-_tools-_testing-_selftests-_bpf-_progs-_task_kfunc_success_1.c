int BPF_PROG ( test_task_xchg_release , struct task_struct * task , u64 clone_flags ) { struct task_struct * kptr ; struct __tasks_kfunc_map_value * v ; int status ; if ( ! is_test_kfunc_task ( ) ) { return 0 ; } status = tasks_kfunc_map_insert ( task ) ; if ( status ) { err = 1 ; return 0 ; } v = tasks_kfunc_map_value_lookup ( task ) ; if ( ! v ) { err = 2 ; return 0 ; } kptr = bpf_kptr_xchg ( & v -> task , NULL ) ; if ( ! kptr ) { err = 3 ; return 0 ; } bpf_task_release ( kptr ) ; return 0 ; } 