static int lock_image_fd ( int image_fd , const char * ip ) { int r ; assert ( image_fd >= 0 ) ; assert ( ip ) ; r = getenv_bool ( "SYSTEMD_LUKS_LOCK" ) ; if ( r == - ENXIO ) { return 0 ; } if ( r < 0 ) { return log_error_errno ( r , "Failed to parse $SYSTEMD_LUKS_LOCK environment variable: %m" ) ; } if ( flock ( image_fd , LOCK_EX | LOCK_NB ) < 0 ) { if ( errno == EAGAIN ) { log_error_errno ( errno , "Image file '%s' already locked, can't use." , ip ) ; } else { log_error_errno ( errno , "Failed to lock image file '%s': %m" , ip ) ; } return errno != EAGAIN ?- errno : - EADDRINUSE ; } log_info ( "Successfully locked image file '%s'." , ip ) ; r = sd_pid_notify_with_fds ( 0 , false , "SYSTEMD_LUKS_LOCK_FD=1" , & image_fd , 1 ) ; if ( r < 0 ) { log_warning_errno ( r , "Failed to send LUKS lock fd to parent, ignoring: %m" ) ; } return 0 ; } 