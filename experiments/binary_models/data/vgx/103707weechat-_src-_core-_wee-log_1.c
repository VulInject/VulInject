char * weechat_log_filename = NULL ; FILE * weechat_log_file = NULL ; int weechat_log_use_time = 1 ; int log_open ( const char * filename , const char * mode ) { int filename_length ; if ( weechat_log_file ) { return 0 ; } if ( weechat_log_stdout ) { weechat_log_file = stdout ; } if ( filename ) { weechat_log_filename = strdup ( filename ) ; weechat_log_file = fopen ( weechat_log_filename , mode ) ; } else { filename_length = strlen ( weechat_data_dir ) + 64 ; weechat_log_filename = malloc ( filename_length ) ; snprintf ( weechat_log_filename , filename_length , "%s/%s" , weechat_data_dir , WEECHAT_LOG_NAME ) ; weechat_log_file = fopen ( weechat_log_filename , mode ) ; } if ( ! weechat_log_file ) { if ( weechat_log_filename ) { weechat_log_filename = NULL ; } return 0 ; } if ( ( flock ( fileno ( weechat_log_file ) , LOCK_EX | LOCK_NB ) != 0 ) ) { if ( errno == EWOULDBLOCK ) { fclose ( weechat_log_file ) ; weechat_log_file = NULL ; free ( weechat_log_filename ) ; weechat_log_filename = NULL ; return 0 ; } } return 1 ; } 