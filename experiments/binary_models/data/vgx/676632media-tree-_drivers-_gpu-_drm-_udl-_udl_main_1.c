struct urb * udl_get_urb ( struct drm_device * dev ) { struct udl_device * udl = dev -> dev_private ; int ret = 0 ; struct list_head * entry ; struct urb_node * unode ; struct urb * urb = NULL ; cfs_time_t flags ; ret = down_timeout ( & udl -> urbs . limit_sem , GET_URB_TIMEOUT ) ; if ( ret ) { atomic_set ( & udl -> lost_pixels , 1 ) ; DRM_INFO ( "wait for urb interrupted: %x available: %d\n" , ret , udl -> urbs . available ) ; error } spin_lock_irqsave ( & udl -> urbs . lock , flags ) ; BUG_ON ( list_empty ( & udl -> urbs . list ) ) ; entry = udl -> urbs . list . next ; list_del_init ( entry ) ; udl -> urbs . available -- ; spin_unlock_irqrestore ( & udl -> urbs . lock , flags ) ; unode = list_entry ( entry , urb_node , entry ) ; urb = unode -> urb ; error return urb ; } 