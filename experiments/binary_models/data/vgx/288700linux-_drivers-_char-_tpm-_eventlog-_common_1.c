void tpm_bios_log_setup ( struct tpm_chip * chip ) { const char * name = dev_name ( & chip -> dev ) ; unsigned int cnt ; int log_version ; int rc = 0 ; if ( chip -> flags & TPM_CHIP_FLAG_VIRTUAL ) { return ; } rc = tpm_read_log ( chip ) ; if ( rc < 0 ) { return ; } log_version = rc ; cnt = 0 ; chip -> bios_dir [ cnt ] = securityfs_create_dir ( name , NULL ) ; if ( IS_ERR ( chip -> bios_dir [ cnt ] ) ) { err } cnt ++ ; chip -> bin_log_seqops . chip = chip ; if ( log_version == EFI_TCG2_EVENT_LOG_FORMAT_TCG_2 ) { chip -> bin_log_seqops . seqops = & tpm2_binary_b_measurements_seqops ; } else { chip -> bin_log_seqops . seqops = & tpm1_binary_b_measurements_seqops ; } chip -> bios_dir [ cnt ] = securityfs_create_file ( "binary_bios_measurements" , 0440 , chip -> bios_dir [ 0 ] , ( void * ) & chip -> bin_log_seqops , & tpm_bios_measurements_ops ) ; if ( IS_ERR ( chip -> bios_dir [ cnt ] ) ) { err } cnt ++ ; if ( ! ( chip -> flags & TPM_CHIP_FLAG_TPM2 ) ) { chip -> ascii_log_seqops . chip = chip ; chip -> ascii_log_seqops . seqops = & tpm1_ascii_b_measurements_seqops ; chip -> bios_dir [ cnt ] = securityfs_create_file ( "ascii_bios_measurements" , 0440 , chip -> bios_dir [ 0 ] , ( void * ) & chip -> ascii_log_seqops , & tpm_bios_measurements_ops ) ; if ( IS_ERR ( chip -> bios_dir [ cnt ] ) ) { err } cnt ++ ; } return ; err tpm_bios_log_teardown ( chip ) ; return ; } 