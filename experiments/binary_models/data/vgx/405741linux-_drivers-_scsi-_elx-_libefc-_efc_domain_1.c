void __efc_domain_init ( struct efc_sm_ctx * ctx , enum efc_sm_event evt , void * arg ) { std_domain_state_decl ( ) ; domain_sm_trace ( domain ) ; switch ( evt ) { case EFC_EVT_ENTER : domain -> attached = false ; break ; case EFC_EVT_DOMAIN_FOUND : { u32 i ; struct efc_domain_record * drec = arg ; struct efc_nport * nport ; u64 my_wwnn = efc -> req_wwnn ; u64 my_wwpn = efc -> req_wwpn ; __be64 bewwpn ; if ( my_wwpn == 0 || my_wwnn == 0 ) { efc_log_debug ( efc , "using default hardware WWN config\n" ) ; my_wwpn = efc -> def_wwpn ; my_wwnn = efc -> def_wwnn ; } efc_log_debug ( efc , "Create nport WWPN %016llX WWNN %016llX\n" , my_wwpn , my_wwnn ) ; nport = efc_nport_alloc ( domain , my_wwpn , my_wwnn , U32_MAX , efc -> enable_ini , efc -> enable_tgt ) ; if ( ! nport ) { efc_log_err ( efc , "efc_nport_alloc() failed\n" ) ; break ; } efc_sm_transition ( & nport -> sm , __efc_nport_allocated , NULL ) ; bewwpn = cpu_to_be64 ( nport -> wwpn ) ; if ( efc_cmd_nport_alloc ( efc , nport , NULL , ( uint8_t * ) & bewwpn ) ) { efc_log_err ( efc , "Can't allocate port\n" ) ; efc_nport_free ( nport ) ; break ; } domain -> is_loop = drec -> is_loop ; domain -> is_nlport = drec -> map . loop [ 1 ] == 0x00 ; if ( ! domain -> is_loop ) { if ( efc_cmd_domain_alloc ( efc , domain , drec -> index ) ) { efc_log_err ( efc , "Failed to initiate HW domain allocation\n" ) ; break ; } efc_sm_transition ( ctx , __efc_domain_wait_alloc , arg ) ; break ; } efc_log_debug ( efc , "%s fc_id=%#x speed=%d\n" , drec -> is_loop ?( domain -> is_nlport ?"public-loop" : "loop" ) else "other" , drec -> fc_id , drec -> speed ) ; nport -> fc_id = drec -> fc_id ; nport -> topology = EFC_NPORT_TOPO_FC_AL ; sprintf ( nport -> display_name , "s%06x" , drec -> fc_id ) ; if ( efc -> enable_ini ) { u32 count = drec -> map . loop [ 0 ] ; efc_log_debug ( efc , "%d position map entries\n" , count ) ; for ( i = 1 ; i <= count ; i ++ ) { if ( drec -> map . loop [ i ] != drec -> fc_id ) { struct efc_node * node ; efc_log_debug ( efc , "%#x ->%#x\n" , drec -> fc_id , drec -> map . loop [ i ] ) ; node = efc_node_alloc ( nport , drec -> map . loop [ i ] , false , true ) ; if ( ! node ) { efc_log_err ( efc , "efc_node_alloc() failed\n" ) ; break ; } efc_node_transition ( node , __efc_d_wait_loop , NULL ) ; } } } if ( efc_cmd_domain_alloc ( efc , domain , drec -> index ) ) { efc_log_err ( efc , "Failed to initiate HW domain allocation\n" ) ; break ; } efc_sm_transition ( ctx , __efc_domain_wait_alloc , arg ) ; break ; } default : __efc_domain_common ( __func__ , ctx , evt , arg ) ; } } 