static int tpm_ibmvtpm_recv ( struct tpm_chip * chip , u8 * buf , size_t count ) { struct ibmvtpm_dev * ibmvtpm = dev_get_drvdata ( & chip -> dev ) ; u16 len ; int sig ; if ( ! ibmvtpm -> rtce_buf ) { dev_err ( ibmvtpm -> dev , "ibmvtpm device is not ready\n" ) ; return 0 ; } sig = wait_event_interruptible ( ibmvtpm -> wq , ! ibmvtpm -> tpm_processing_cmd ) ; if ( sig ) { return - EINTR ; } len = ibmvtpm -> res_len ; if ( count < len ) { dev_err ( ibmvtpm -> dev , "Invalid size in recv: count=%zd, crq_size=%d\n" , count , len ) ; return - EIO ; } spin_lock ( & ibmvtpm -> rtce_lock ) ; memcpy ( ( void * ) buf , ( void * ) ibmvtpm -> rtce_buf , len ) ; ibmvtpm -> res_len = 0 ; spin_unlock ( & ibmvtpm -> rtce_lock ) ; return len ; } 