int xfs_qm_dqget ( xfs_mount_t * mp , xfs_inode_t * ip , xfs_dqid_t id , uint type , uint flags , xfs_dquot_t * * O_dqpp ) { struct xfs_quotainfo * qi = mp -> m_quotainfo ; struct radix_tree_root * tree = xfs_dquot_tree ( qi , type ) ; struct xfs_dquot * dqp ; loff_t eof = 0 ; int error ; ASSERT ( XFS_IS_QUOTA_RUNNING ( mp ) ) ; if ( ( ! XFS_IS_UQUOTA_ON ( mp ) && type == XFS_DQ_USER ) || ( ! XFS_IS_PQUOTA_ON ( mp ) && type == XFS_DQ_PROJ ) || ( ! XFS_IS_GQUOTA_ON ( mp ) && type == XFS_DQ_GROUP ) ) { return - ESRCH ; } if ( xfs_do_dqerror ) { if ( ( xfs_dqerror_target == mp -> m_ddev_targp ) && ( xfs_dqreq_num ++ % xfs_dqerror_mod ) == 0 ) { xfs_debug ( mp , "Returning error in dqget" ) ; return - EIO ; } } ASSERT ( type == XFS_DQ_USER || type == XFS_DQ_PROJ || type == XFS_DQ_GROUP ) ; if ( ip ) { ASSERT ( xfs_isilocked ( ip , XFS_ILOCK_EXCL ) ) ; ASSERT ( xfs_inode_dquot ( ip , type ) == NULL ) ; } if ( flags & XFS_QMOPT_DQNEXT ) { struct xfs_inode * quotip ; xfs_fileoff_t last ; uint lock_mode ; quotip = xfs_quota_inode ( mp , type ) ; lock_mode = xfs_ilock_data_map_shared ( quotip ) ; error = xfs_bmap_last_offset ( quotip , & last , XFS_DATA_FORK ) ; xfs_iunlock ( quotip , lock_mode ) ; eof = XFS_FSB_TO_B ( mp , last ) ; } restart mutex_lock ( & qi -> qi_tree_lock ) ; dqp = radix_tree_lookup ( tree , id ) ; if ( dqp ) { xfs_dqlock ( dqp ) ; if ( dqp -> dq_flags & XFS_DQ_FREEING ) { xfs_dqunlock ( dqp ) ; mutex_unlock ( & qi -> qi_tree_lock ) ; trace_xfs_dqget_freeing ( dqp ) ; delay ( 1 ) ; restart } if ( flags & XFS_QMOPT_DQNEXT ) { if ( XFS_IS_DQUOT_UNINITIALIZED ( dqp ) ) { xfs_dqunlock ( dqp ) ; mutex_unlock ( & qi -> qi_tree_lock ) ; error = xfs_dq_get_next_id ( mp , type , & id , eof ) ; if ( error ) { return error ; } restart } } dqp -> q_nrefs ++ ; mutex_unlock ( & qi -> qi_tree_lock ) ; trace_xfs_dqget_hit ( dqp ) ; XFS_STATS_INC ( mp , xs_qm_dqcachehits ) ; * O_dqpp = dqp ; return 0 ; } mutex_unlock ( & qi -> qi_tree_lock ) ; XFS_STATS_INC ( mp , xs_qm_dqcachemisses ) ; if ( ip ) { xfs_iunlock ( ip , XFS_ILOCK_EXCL ) ; } error = xfs_qm_dqread ( mp , id , type , flags , & dqp ) ; if ( ip ) { xfs_ilock ( ip , XFS_ILOCK_EXCL ) ; } if ( error == - ENOENT && ( flags & XFS_QMOPT_DQNEXT ) ) { error = xfs_dq_get_next_id ( mp , type , & id , eof ) ; if ( ! error ) { restart } } if ( error ) { return error ; } if ( ip ) { if ( xfs_this_quota_on ( mp , type ) ) { struct xfs_dquot * dqp1 ; dqp1 = xfs_inode_dquot ( ip , type ) ; if ( dqp1 ) { xfs_qm_dqdestroy ( dqp ) ; dqp = dqp1 ; xfs_dqlock ( dqp ) ; dqret } } else { xfs_qm_dqdestroy ( dqp ) ; return - ESRCH ; } } mutex_lock ( & qi -> qi_tree_lock ) ; error = radix_tree_insert ( tree , id , dqp ) ; if ( unlikely ( error ) ) { WARN_ON ( error != - EEXIST ) ; mutex_unlock ( & qi -> qi_tree_lock ) ; trace_xfs_dqget_dup ( dqp ) ; xfs_qm_dqdestroy ( dqp ) ; XFS_STATS_INC ( mp , xs_qm_dquot_dups ) ; restart } xfs_dqlock ( dqp ) ; dqp -> q_nrefs = 1 ; qi -> qi_dquots ++ ; mutex_unlock ( & qi -> qi_tree_lock ) ; if ( flags & XFS_QMOPT_DQNEXT ) { if ( XFS_IS_DQUOT_UNINITIALIZED ( dqp ) ) { xfs_qm_dqput ( dqp ) ; error = xfs_dq_get_next_id ( mp , type , & id , eof ) ; if ( error ) { return error ; } restart } } dqret ASSERT ( ( ip == NULL ) || xfs_isilocked ( ip , XFS_ILOCK_EXCL ) ) ; trace_xfs_dqget_miss ( dqp ) ; * O_dqpp = dqp ; return 0 ; } 