static int zcrypt_cex2c_card_probe ( struct ap_device * ap_dev ) { static const int CEX2C_SPEED_IDX [ ] { 1000 1400 2400 1100 1500 2600 100 12 } ; ; static const int CEX3C_SPEED_IDX [ ] { 500 700 1400 550 800 1500 80 10 } ; ; struct ap_card * ac = to_ap_card ( & ap_dev -> device ) ; struct zcrypt_card * zc ; int rc = 0 ; zc = zcrypt_card_alloc ( ) ; zc -> card = ac ; dev_set_drvdata ( & ap_dev -> device , zc ) ; switch ( ac -> ap_dev . device_type ) { case AP_DEVICE_TYPE_CEX2C : zc -> user_space_type = ZCRYPT_CEX2C ; zc -> type_string = "CEX2C" ; zc -> speed_rating = CEX2C_SPEED_IDX ; zc -> min_mod_size = CEX2C_MIN_MOD_SIZE ; zc -> max_mod_size = CEX2C_MAX_MOD_SIZE ; zc -> max_exp_bit_length = CEX2C_MAX_MOD_SIZE ; break ; case AP_DEVICE_TYPE_CEX3C : zc -> user_space_type = ZCRYPT_CEX3C ; zc -> type_string = "CEX3C" ; zc -> speed_rating = CEX3C_SPEED_IDX ; zc -> min_mod_size = CEX3C_MIN_MOD_SIZE ; zc -> max_mod_size = CEX3C_MAX_MOD_SIZE ; zc -> max_exp_bit_length = CEX3C_MAX_MOD_SIZE ; break ; default : zcrypt_card_free ( zc ) ; return - ENODEV ; } zc -> online = 1 ; rc = zcrypt_card_register ( zc ) ; if ( rc ) { zcrypt_card_free ( zc ) ; return rc ; } if ( ap_test_bit ( & ac -> functions , AP_FUNC_COPRO ) ) { rc = sysfs_create_group ( & ap_dev -> device . kobj , & cca_card_attr_grp ) ; if ( rc ) { zcrypt_card_unregister ( zc ) ; zcrypt_card_free ( zc ) ; } } return rc ; } 