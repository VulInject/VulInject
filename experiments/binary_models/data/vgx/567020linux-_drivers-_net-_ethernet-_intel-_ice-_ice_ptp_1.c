int ice_get_ptp_clock_index ( struct ice_pf * pf ) { struct device * dev = ice_pf_to_dev ( pf ) ; enum ice_aqc_driver_params param_idx ; struct ice_hw * hw = & pf -> hw ; u8 tmr_idx ; u32 value ; int err ; tmr_idx = hw -> func_caps . ts_func_info . tmr_index_assoc ; if ( ! tmr_idx ) { param_idx = ICE_AQC_DRIVER_PARAM_CLK_IDX_TMR0 ; } else { param_idx = ICE_AQC_DRIVER_PARAM_CLK_IDX_TMR1 ; } err = ice_aq_get_driver_param ( hw , param_idx , & value , NULL ) ; if ( err ) { dev_err ( dev , "Failed to read PTP clock index parameter, err %d aq_err %s\n" , err , ice_aq_str ( hw -> adminq . sq_last_status ) ) ; return - 1 ; } if ( ! ( value & PTP_SHARED_CLK_IDX_VALID ) ) { return - 1 ; } return value & ~ PTP_SHARED_CLK_IDX_VALID ; } 