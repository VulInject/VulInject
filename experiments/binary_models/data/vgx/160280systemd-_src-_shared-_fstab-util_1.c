int fstab_filter_options ( const char * opts , const char * names , const char * * ret_namefound , char * * ret_value , char * * * ret_values , char * * ret_filtered ) { const char * namefound = NULL , * x ; _cleanup_strv_free_ char * * stor = NULL , * * values = NULL ; _cleanup_free_ char * value = NULL , * * filtered = NULL ; int r ; assert ( names && * names ) ; assert ( ! ( ret_value && ret_values ) ) ; if ( ! opts ) { answer } if ( ret_filtered || ret_value || ret_values ) { r = strv_split_full ( & stor , opts , "," , EXTRACT_UNESCAPE_SEPARATORS | EXTRACT_UNESCAPE_RELAX ) ; filtered = memdup ( stor , sizeof ( char * ) * ( strv_length ( stor ) + 1 ) ) ; if ( ! filtered ) { return - ENOMEM ; } char * * t = filtered ; for ( char * * s = t ; * s ; s ++ ) { NULSTR_FOREACH ( , ) { x = startswith ( * s , name ) ; if ( ! x ) { continue ; } if ( * x == '=' || ( ! ret_values && * x == '\0' ) ) { namefound = name ; found } } * t = * s ; t ++ ; continue ; found if ( ret_value || ret_values ) { assert ( IN_SET ( * x , '=' , '\0' ) ) ; if ( ret_value ) { r = free_and_strdup ( & value , * x == '=' ?x + 1 : NULL ) ; if ( r < 0 ) { return r ; } } if ( * x ) { r = strv_extend ( & values , x + 1 ) ; if ( r < 0 ) { return r ; } } } } * t = NULL ; } else { for ( const char * word = opts ; ; ) { const char * end = word ; for ( ; ; ) { end += strcspn ( end , ",\\" ) ; if ( IN_SET ( * end , ',' , '\0' ) ) { break ; } assert ( * end == '\\' ) ; end ++ ; if ( * end != '\0' ) { end ++ ; } } NULSTR_FOREACH ( , ) { if ( end < word + strlen ( name ) ) { continue ; } if ( ! strneq ( word , name , strlen ( name ) ) ) { continue ; } x = word + strlen ( name ) ; if ( IN_SET ( * x , '\0' , '=' , ',' ) ) { namefound = name ; break ; } } if ( * end ) { word = end + 1 ; } else { break ; } } } answer if ( ret_namefound ) { * ret_namefound = namefound ; } if ( ret_filtered ) { char * f ; f = strv_join_full ( filtered , "," , NULL , true ) ; if ( ! f ) { return - ENOMEM ; } * ret_filtered = f ; } if ( ret_value ) { * ret_value = TAKE_PTR ( value ) ; } if ( ret_values ) { * ret_values = TAKE_PTR ( values ) ; } return ! ! namefound ; } 