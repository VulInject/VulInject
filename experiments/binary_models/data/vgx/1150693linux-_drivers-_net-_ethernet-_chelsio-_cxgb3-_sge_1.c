static void write_tx_pkt_wr ( adapter * adap , sk_buff * skb , const port_info * pi , unsigned int pidx , unsigned int gen , sge_txq * q , unsigned int ndesc , unsigned int compl , const dma_addr_t * addr ) ( unsigned int flits , sgl_flits , cntrl , tso_info , sg_ent * sgp , sgl [ MAX_SKB_FRAGS / 2 + 1 ] , tx_desc * d = & q -> desc [ pidx ] , cpl_tx_pkt * cpl = ( cpl_tx_pkt * ) d , cpl -> len = htonl ( skb -> len ) , cntrl = V_TXPKT_INTF ( pi -> port_id ) , ( skb_vlan_tag_present ( skb ) ) cntrl |= F_TXPKT_VLAN_VLD | V_TXPKT_VLAN ( skb_vlan_tag_get ( skb ) ) , tso_info = V_LSO_MSS ( skb_shinfo ( skb ) -> gso_size ) , ( tso_info ) { int eth_type cpl_tx_pkt_lso * hdr = ( cpl_tx_pkt_lso * ) cpl d -> flit [ 2 ] = 0 cntrl |= V_TXPKT_OPCODE ( CPL_TX_PKT_LSO ) hdr -> cntrl = htonl ( cntrl ) eth_type = skb_network_offset ( skb ) == ETH_HLEN ?CPL_ETH_II : CPL_ETH_II_VLAN tso_info |= V_LSO_ETH_TYPE ( eth_type ) | V_LSO_IPHDR_WORDS ( ip_hdr ( skb ) -> ihl ) | V_LSO_TCPHDR_WORDS ( tcp_hdr ( skb ) -> doff ) hdr -> lso_info = htonl ( tso_info ) flits = 3 } else { cntrl |= V_TXPKT_OPCODE ( CPL_TX_PKT ) cntrl |= F_TXPKT_IPCSUM_DIS } ; ) ; cntrl |= V_TXPKT_L4CSUM_DIS ( skb -> ip_summed != CHECKSUM_PARTIAL ) ; cpl -> cntrl = htonl ( cntrl ) ; if ( skb -> len <= WR_LEN - sizeof ( * cpl ) ) { q -> sdesc [ pidx ] . skb = NULL ; if ( ! skb -> data_len ) { skb_copy_from_linear_data ( skb , & d -> flit [ 2 ] , skb -> len ) ; } else { skb_copy_bits ( skb , 0 , & d -> flit [ 2 ] , skb -> len ) ; } flits = ( skb -> len + 7 ) / 8 + 2 ; cpl -> wr . wr_hi = htonl ( V_WR_BCNTLFLT ( skb -> len & 7 ) | V_WR_OP ( FW_WROPCODE_TUNNEL_TX_PKT ) | F_WR_SOP | F_WR_EOP | compl ) ; dma_wmb ( ) ; cpl -> wr . wr_lo = htonl ( V_WR_LEN ( flits ) | V_WR_GEN ( gen ) | V_WR_TID ( q -> token ) ) ; wr_gen2 ( d , gen ) ; dev_consume_skb_any ( skb , NULL ) ; return ; } flits = 2 ; = ndesc == 1 ?( sg_ent * ) & d -> flit [ flits ] : sgl ; sgl_flits = write_sgl ( skb , sgp , skb -> data , skb_headlen ( skb ) , addr ) ; write_wr_hdr_sgl ( ndesc , skb , d , pidx , q , sgl , flits , sgl_flits , gen , htonl ( V_WR_OP ( FW_WROPCODE_TUNNEL_TX_PKT ) | compl ) , htonl ( V_WR_TID ( q -> token ) ) ) ; 