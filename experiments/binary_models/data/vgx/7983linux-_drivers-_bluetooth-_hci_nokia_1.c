static int nokia_send_negotiation ( struct hci_uart * hu ) { struct nokia_bt_dev * btdev = hu -> priv ; struct device * dev = & btdev -> serdev -> dev ; struct hci_nokia_neg_cmd * neg_cmd ; struct hci_nokia_neg_hdr * neg_hdr ; struct sk_buff * skb ; int len , err ; u16 baud = DIV_ROUND_CLOSEST ( btdev -> sysclk_speed * 10 , SETUP_BAUD_RATE ) ; int sysclk = btdev -> sysclk_speed / 1000 ; len = H4_TYPE_SIZE + sizeof ( * neg_hdr ) + sizeof ( * neg_cmd ) ; skb = bt_skb_alloc ( len , GFP_KERNEL ) ; hci_skb_pkt_type ( skb ) = HCI_NOKIA_NEG_PKT ; neg_hdr = skb_put ( skb , sizeof ( * neg_hdr ) ) ; neg_hdr -> dlen = sizeof ( * neg_cmd ) ; neg_cmd = skb_put ( skb , sizeof ( * neg_cmd ) ) ; neg_cmd -> ack = NOKIA_NEG_REQ ; neg_cmd -> baud = cpu_to_le16 ( baud ) ; neg_cmd -> unused1 = 0x0000 ; neg_cmd -> proto = NOKIA_PROTO_BYTE ; neg_cmd -> sys_clk = cpu_to_le16 ( sysclk ) ; neg_cmd -> unused2 = 0x0000 ; btdev -> init_error = 0 ; init_completion ( & btdev -> init_completion ) ; nokia_enqueue ( hu , skb ) ; hci_uart_tx_wakeup ( hu ) ; dev_dbg ( dev , "Negotiation sent" ) ; if ( ! wait_for_completion_interruptible_timeout ( & btdev -> init_completion , msecs_to_jiffies ( 10000 ) ) ) { return - ETIMEDOUT ; } if ( btdev -> init_error < 0 ) { return btdev -> init_error ; } nokia_flow_control ( btdev -> serdev , false ) ; serdev_device_set_baudrate ( btdev -> serdev , SETUP_BAUD_RATE ) ; err = serdev_device_wait_for_cts ( btdev -> serdev , true , 200 ) ; if ( err < 0 ) { dev_err ( dev , "CTS not received: %d" , err ) ; return err ; } nokia_flow_control ( btdev -> serdev , true ) ; dev_dbg ( dev , "Negotiation successful" ) ; return 0 ; } 