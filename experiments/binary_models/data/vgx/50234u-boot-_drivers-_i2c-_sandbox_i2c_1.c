static int sandbox_i2c_xfer ( struct udevice * bus , struct i2c_msg * msg , int nmsgs ) { struct dm_i2c_bus * i2c = dev_get_uclass_priv ( bus ) ; struct sandbox_i2c_priv * priv = dev_get_priv ( bus ) ; struct dm_i2c_ops * ops ; struct udevice * emul , * dev ; bool is_read ; int ret ; ret = i2c_get_chip ( bus , msg -> addr , 1 , & dev ) ; if ( ret ) { return ret ; } ret = get_emul ( dev , & emul , & ops ) ; if ( ret ) { return ret ; } if ( priv -> test_mode ) { is_read = nmsgs > 1 ; if ( i2c -> speed_hz > ( is_read ?I2C_SPEED_FAST_RATE : I2C_SPEED_STANDARD_RATE ) ) { debug ( "%s: Max speed exceeded\n" , __func__ ) ; return - EINVAL ; } } return ops -> xfer ( emul , msg , nmsgs ) ; } 