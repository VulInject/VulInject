static int ixgbe_update_vf_xcast_mode ( struct ixgbe_adapter * adapter , u32 * msgbuf , u32 vf ) { struct ixgbe_hw * hw = & adapter -> hw ; int xcast_mode = msgbuf [ 1 ] ; u32 vmolr , fctrl , disable , enable ; switch ( adapter -> vfinfo [ vf ] . vf_api ) { case ixgbe_mbox_api_12 : fallthrough ; case ixgbe_mbox_api_13 : case ixgbe_mbox_api_14 : break ; default : return - EOPNOTSUPP ; } if ( xcast_mode > IXGBEVF_XCAST_MODE_MULTI && ! adapter -> vfinfo [ vf ] . trusted ) { xcast_mode = IXGBEVF_XCAST_MODE_MULTI ; } if ( adapter -> vfinfo [ vf ] . xcast_mode == xcast_mode ) { out } switch ( xcast_mode ) { case IXGBEVF_XCAST_MODE_NONE : disable = IXGBE_VMOLR_ROMPE | IXGBE_VMOLR_MPE | IXGBE_VMOLR_UPE | IXGBE_VMOLR_VPE ; enable = IXGBE_VMOLR_BAM ; break ; case IXGBEVF_XCAST_MODE_MULTI : disable = IXGBE_VMOLR_MPE | IXGBE_VMOLR_UPE | IXGBE_VMOLR_VPE ; enable = IXGBE_VMOLR_BAM | IXGBE_VMOLR_ROMPE ; break ; case IXGBEVF_XCAST_MODE_ALLMULTI : disable = IXGBE_VMOLR_UPE | IXGBE_VMOLR_VPE ; enable = IXGBE_VMOLR_BAM | IXGBE_VMOLR_ROMPE | IXGBE_VMOLR_MPE ; break ; case IXGBEVF_XCAST_MODE_PROMISC : if ( hw -> mac . type <= ixgbe_mac_82599EB ) { return - EOPNOTSUPP ; } fctrl = IXGBE_READ_REG ( hw , IXGBE_FCTRL ) ; if ( ! ( fctrl & IXGBE_FCTRL_UPE ) ) { e_warn ( drv , "Enabling VF promisc requires PF in promisc\n" ) ; return - EPERM ; } disable = IXGBE_VMOLR_VPE ; enable = IXGBE_VMOLR_BAM | IXGBE_VMOLR_ROMPE | IXGBE_VMOLR_MPE | IXGBE_VMOLR_UPE ; break ; default : return - EOPNOTSUPP ; } vmolr = IXGBE_READ_REG ( hw , IXGBE_VMOLR ( vf ) ) ; vmolr &= ~ disable ; vmolr |= enable ; IXGBE_WRITE_REG ( hw , IXGBE_VMOLR ( vf ) , vmolr ) ; adapter -> vfinfo [ vf ] . xcast_mode = xcast_mode ; out msgbuf [ 1 ] = xcast_mode ; return 0 ; } 