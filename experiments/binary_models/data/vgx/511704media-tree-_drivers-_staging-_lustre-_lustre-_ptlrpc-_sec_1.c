int sptlrpc_req_get_ctx ( struct ptlrpc_request * req ) { struct obd_import * imp = req -> rq_import ; struct ptlrpc_sec * sec ; int rc ; LASSERT ( ! req -> rq_cli_ctx ) ; LASSERT ( imp ) ; rc = import_sec_validate_get ( imp , & sec ) ; if ( rc ) { return rc ; } req -> rq_cli_ctx = get_my_ctx ( sec ) ; sptlrpc_sec_put ( sec ) ; if ( ! req -> rq_cli_ctx ) { CERROR ( "req %p: fail to get context\n" , req ) ; return - ECONNREFUSED ; } return 0 ; } void sptlrpc_req_put_ctx ( struct ptlrpc_request * req , int sync ) { LASSERT ( req ) ; LASSERT ( req -> rq_cli_ctx ) ; if ( ! list_empty ( & req -> rq_ctx_chain ) ) { spin_lock ( & req -> rq_cli_ctx -> cc_lock ) ; list_del_init ( & req -> rq_ctx_chain ) ; spin_unlock ( & req -> rq_cli_ctx -> cc_lock ) ; } sptlrpc_cli_ctx_put ( req -> rq_cli_ctx , sync ) ; } 