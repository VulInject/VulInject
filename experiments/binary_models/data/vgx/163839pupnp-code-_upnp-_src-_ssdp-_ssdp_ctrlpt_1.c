int SearchByTarget ( int Mx , char * St , void * Cookie ) { char errorBuffer [ ERROR_BUFFER_LEN ] ; int * id = NULL ; int ret = 0 ; char ReqBufv4 [ BUFSIZE ] ; char ReqBufv6 [ BUFSIZE ] ; char ReqBufv6UlaGua [ BUFSIZE ] ; struct sockaddr_storage __ss_v4 ; struct sockaddr_storage __ss_v6 ; struct sockaddr_in * destAddr4 = ( sockaddr_in * ) & __ss_v4 ; struct sockaddr_in6 * destAddr6 = ( sockaddr_in6 * ) & __ss_v6 ; fd_set wrSet ; SsdpSearchArg * newArg = NULL ; int timeTillRead = 0 ; int handle ; struct Handle_Info * ctrlpt_info = NULL ; enum SsdpSearchType requestType ; unsigned long addrv4 = inet_addr ( gIF_IPV4 ) ; SOCKET max_fd = 0 ; int retVal ; ThreadPoolJob job ; memset ( & job , 0 , sizeof ( job ) ) ; requestType = ssdp_request_type1 ( St ) ; if ( requestType == SSDP_SERROR ) { return UPNP_E_INVALID_PARAM ; } UpnpPrintf ( UPNP_INFO , SSDP , __FILE__ , __LINE__ , "Inside SearchByTarget\n" ) ; timeTillRead = Mx ; if ( timeTillRead < MIN_SEARCH_TIME ) { timeTillRead = MIN_SEARCH_TIME ; } if ( timeTillRead > MAX_SEARCH_TIME ) { timeTillRead = MAX_SEARCH_TIME ; } retVal = CreateClientRequestPacket ( ReqBufv4 , sizeof ( ReqBufv4 ) , timeTillRead , St , AF_INET ) ; if ( retVal != UPNP_E_SUCCESS ) { return retVal ; } retVal = CreateClientRequestPacket ( ReqBufv6 , sizeof ( ReqBufv6 ) , timeTillRead , St , AF_INET6 ) ; if ( retVal != UPNP_E_SUCCESS ) { return retVal ; } retVal = CreateClientRequestPacketUlaGua ( ReqBufv6UlaGua , sizeof ( ReqBufv6UlaGua ) , timeTillRead , St , AF_INET6 ) ; if ( retVal != UPNP_E_SUCCESS ) { return retVal ; } memset ( & __ss_v4 , 0 , sizeof ( __ss_v4 ) ) ; destAddr4 -> sin_family = ( sa_family_t ) AF_INET ; inet_pton ( AF_INET , SSDP_IP , & destAddr4 -> sin_addr ) ; destAddr4 -> sin_port = htons ( SSDP_PORT ) ; destAddr6 -> sin6_family = ( sa_family_t ) AF_INET6 ; inet_pton ( AF_INET6 , SSDP_IPV6_SITELOCAL , & destAddr6 -> sin6_addr ) ; destAddr6 -> sin6_port = htons ( SSDP_PORT ) ; destAddr6 -> sin6_scope_id = gIF_INDEX ; HandleLock ( ) ; if ( GetClientHandleInfo ( & handle , & ctrlpt_info ) != HND_CLIENT ) { HandleUnlock ( ) ; return UPNP_E_INTERNAL_ERROR ; } newArg = ( SsdpSearchArg * ) malloc ( sizeof ( SsdpSearchArg ) ) ; newArg -> searchTarget = strdup ( St ) ; newArg -> cookie = Cookie ; newArg -> requestType = requestType ; id = ( int * ) malloc ( sizeof ( int ) ) ; TPJobInit ( & job , ( start_routine ) searchExpired , id ) ; TPJobSetPriority ( & job , MED_PRIORITY ) ; TPJobSetFreeFunction ( & job , ( free_routine ) free ) ; TimerThreadSchedule ( & gTimerThread , timeTillRead , REL_SEC , & job , SHORT_TERM , id ) ; newArg -> timeoutEventId = * id ; ListAddTail ( & ctrlpt_info -> SsdpSearchList , newArg ) ; HandleUnlock ( ) ; FD_ZERO ( & wrSet ) ; if ( gSsdpReqSocket4 != INVALID_SOCKET ) { setsockopt ( gSsdpReqSocket4 , IPPROTO_IP , IP_MULTICAST_IF , ( char * ) & addrv4 , sizeof ( addrv4 ) ) ; FD_SET ( gSsdpReqSocket4 , & wrSet ) ; max_fd = max ( max_fd , gSsdpReqSocket4 ) ; } if ( gSsdpReqSocket6 != INVALID_SOCKET ) { setsockopt ( gSsdpReqSocket6 , IPPROTO_IPV6 , IPV6_MULTICAST_IF , ( char * ) & gIF_INDEX , sizeof ( gIF_INDEX ) ) ; FD_SET ( gSsdpReqSocket6 , & wrSet ) ; max_fd = max ( max_fd , gSsdpReqSocket6 ) ; } ret = select ( max_fd + 1 , NULL , & wrSet , NULL , NULL ) ; if ( ret == - 1 ) { strerror_r ( errno , errorBuffer , ERROR_BUFFER_LEN ) ; UpnpPrintf ( UPNP_INFO , SSDP , __FILE__ , __LINE__ , "SSDP_LIB: Error in select(): %s\n" , errorBuffer ) ; UpnpCloseSocket ( gSsdpReqSocket4 ) ; UpnpCloseSocket ( gSsdpReqSocket6 ) ; return UPNP_E_INTERNAL_ERROR ; } if ( gSsdpReqSocket6 != INVALID_SOCKET && FD_ISSET ( gSsdpReqSocket6 , & wrSet ) ) { int NumCopy = 0 ; while ( NumCopy < NUM_SSDP_COPY ) { UpnpPrintf ( UPNP_INFO , SSDP , __FILE__ , __LINE__ , ">>>SSDP SEND M-SEARCH>>>\n%s\n" , ReqBufv6UlaGua ) ; sendto ( gSsdpReqSocket6 , ReqBufv6UlaGua , strlen ( ReqBufv6UlaGua ) , 0 , ( sockaddr * ) & __ss_v6 , sizeof ( sockaddr_in6 ) ) ; NumCopy ++ ; imillisleep ( SSDP_PAUSE ) ; } NumCopy = 0 ; inet_pton ( AF_INET6 , SSDP_IPV6_LINKLOCAL , & destAddr6 -> sin6_addr ) ; while ( NumCopy < NUM_SSDP_COPY ) { UpnpPrintf ( UPNP_INFO , SSDP , __FILE__ , __LINE__ , ">>>SSDP SEND M-SEARCH>>>\n%s\n" , ReqBufv6 ) ; sendto ( gSsdpReqSocket6 , ReqBufv6 , strlen ( ReqBufv6 ) , 0 , ( sockaddr * ) & __ss_v6 , sizeof ( sockaddr_in6 ) ) ; NumCopy ++ ; imillisleep ( SSDP_PAUSE ) ; } } if ( gSsdpReqSocket4 != INVALID_SOCKET && FD_ISSET ( gSsdpReqSocket4 , & wrSet ) ) { int NumCopy = 0 ; while ( NumCopy < NUM_SSDP_COPY ) { UpnpPrintf ( UPNP_INFO , SSDP , __FILE__ , __LINE__ , ">>>SSDP SEND M-SEARCH>>>\n%s\n" , ReqBufv4 ) ; sendto ( gSsdpReqSocket4 , ReqBufv4 , strlen ( ReqBufv4 ) , 0 , ( sockaddr * ) & __ss_v4 , sizeof ( sockaddr_in ) ) ; NumCopy ++ ; imillisleep ( SSDP_PAUSE ) ; } } return 1 ; } 