static unsigned int opticon_write_room ( struct tty_struct * tty ) { struct usb_serial_port * port = tty -> driver_data ; struct opticon_private * priv = usb_get_serial_port_data ( port ) ; cfs_time_t flags ; spin_lock_irqsave ( & priv -> lock , flags ) ; if ( priv -> outstanding_urbs > URB_UPPER_LIMIT * 2 / 3 ) { spin_unlock_irqrestore ( & priv -> lock , flags ) ; dev_dbg ( & port -> dev , "%s - write limit hit\n" , __func__ ) ; return 0 ; } spin_unlock_irqrestore ( & priv -> lock , flags ) ; return 2048 ; } 