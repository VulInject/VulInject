static int kabylake_audio_probe ( struct platform_device * pdev ) { struct kbl_codec_private * ctx ; struct snd_soc_acpi_mach * mach ; int ret ; ctx = devm_kzalloc ( & pdev -> dev , sizeof ( * ctx ) , GFP_KERNEL ) ; if ( ! ctx ) { return - ENOMEM ; } INIT_LIST_HEAD ( & ctx -> hdmi_pcm_list ) ; kabylake_audio_card . dev = & pdev -> dev ; snd_soc_card_set_drvdata ( & kabylake_audio_card , ctx ) ; mach = pdev -> dev . platform_data ; if ( mach ) { dmic_constraints = mach -> mach_params . dmic_num == 2 ?& constraints_dmic_2ch : & constraints_dmic_channels ; } ctx -> mclk = devm_clk_get ( & pdev -> dev , "ssp1_mclk" ) ; if ( IS_ERR ( ctx -> mclk ) ) { ret = PTR_ERR ( ctx -> mclk , NULL ) ; if ( ret == - ENOENT ) { dev_info ( & pdev -> dev , "Failed to get ssp1_mclk, defer probe\n" ) ; return - EPROBE_DEFER ; } dev_err ( & pdev -> dev , "Failed to get ssp1_mclk with err:%d\n" , ret ) ; return ret ; } ctx -> sclk = devm_clk_get ( & pdev -> dev , "ssp1_sclk" ) ; if ( IS_ERR ( ctx -> sclk ) ) { ret = PTR_ERR ( ctx -> sclk ) ; if ( ret == - ENOENT ) { dev_info ( & pdev -> dev , "Failed to get ssp1_sclk, defer probe\n" ) ; return - EPROBE_DEFER ; } dev_err ( & pdev -> dev , "Failed to get ssp1_sclk with err:%d\n" , ret ) ; return ret ; } return devm_snd_soc_register_card ( & pdev -> dev , & kabylake_audio_card ) ; } 