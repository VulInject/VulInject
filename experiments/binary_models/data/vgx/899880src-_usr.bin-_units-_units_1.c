int addunit ( struct unittype * theunit , char * toadd , int flip ) { char * scratch , * savescr ; char * item ; char * divider , * slash ; int doingtop ; savescr = scratch = dupstr ( toadd ) ; for ( slash = scratch + 1 ; * slash ; slash ++ ) { if ( * slash == '-' && ( tolower ( ( unsigned char ) * ( slash - 1 ) ) != 'e' || ! strchr ( ".0123456789" , * ( slash + 1 ) ) ) ) { * slash = ' ' ; } } slash = strchr ( scratch , '/' ) ; if ( slash ) { * slash = 0 ; } doingtop = 1 ; { item = strtok ( scratch , " *\t\n/" ) ; while ( item ) { if ( strchr ( "0123456789." , * item ) ) { double num ; divider = strchr ( item , '|' ) ; if ( divider ) { * divider = 0 ; num = atof ( item ) ; if ( ! num ) { zeroerror ( ) ; return 1 ; } if ( doingtop ^ flip ) { theunit -> factor *= num ; } else { theunit -> factor /= num ; } num = atof ( divider + 1 ) ; if ( ! num ) { zeroerror ( ) ; free ( savescr ) ; return 1 ; } if ( doingtop ^ flip ) { theunit -> factor /= num ; } else { theunit -> factor *= num ; } } else { num = atof ( item ) ; if ( ! num ) { zeroerror ( ) ; free ( savescr ) ; return 1 ; } if ( doingtop ^ flip ) { theunit -> factor *= num ; } else { theunit -> factor /= num ; } } } else { int repeat = 1 ; if ( strchr ( "23456789" , item [ strlen ( item ) - 1 ] ) ) { repeat = item [ strlen ( item ) - 1 ] - '0' ; item [ strlen ( item ) - 1 ] = 0 ; } for ( ; repeat ; repeat -- ) { if ( addsubunit ( doingtop ^ flip ?theunit -> numerator : theunit -> denominator , item ) ) { free ( savescr ) ; return 1 ; } } } item = strtok ( NULL , " *\t/\n" ) ; } doingtop -- ; if ( slash ) { scratch = slash + 1 ; } else { doingtop -- ; } } doingtop >= 0 ; free ( savescr ) ; return 0 ; } 