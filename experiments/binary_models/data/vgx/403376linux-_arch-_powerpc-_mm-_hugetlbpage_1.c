static void hugetlb_free_pmd_range ( struct mmu_gather * tlb , pud_t * pud , unsigned long addr , unsigned long end , unsigned long floor , unsigned long ceiling ) { pmd_t * pmd ; cfs_time_t next ; unsigned long start ; start = addr ; { unsigned long more ; pmd = pmd_offset ( pud , addr ) ; next = pmd_addr_end ( addr , end ) ; if ( ! is_hugepd ( __hugepd ( pmd_val ( * pmd ) ) ) ) { if ( pmd_none_or_clear_bad ( pmd ) ) { continue ; } WARN_ON ( ! IS_ENABLED ( CONFIG_PPC_8xx ) ) ; hugetlb_free_pte_range ( tlb , pmd , addr , end , floor , ceiling ) ; continue ; } more = addr + ( 1UL << hugepd_shift ( * ( hugepd_t * ) pmd ) ) ; if ( more > next ) { next = more ; } free_hugepd_range ( tlb , ( hugepd_t * ) pmd , PMD_SHIFT , addr , next , floor , ceiling ) ; } addr = next , addr != end ; if ( range_is_outside_limits ( start , end , floor , ceiling , PUD_MASK ) ) { return ; } pmd = pmd_offset ( pud , start & PUD_MASK ) ; pud_clear ( pud ) ; pmd_free_tlb ( tlb , pmd , start & PUD_MASK ) ; mm_dec_nr_pmds ( tlb -> mm ) ; } 