static int fill_in_l1_pcache ( struct kfd_cache_properties * * props_ext , struct kfd_gpu_cache_info * pcache_info , struct kfd_cu_info * cu_info , int cu_bitmask , int cache_type , unsigned int cu_processor_id , int cu_block ) { unsigned int cu_sibling_map_mask ; int first_active_cu ; struct kfd_cache_properties * pcache = NULL ; cu_sibling_map_mask = cu_bitmask ; cu_sibling_map_mask >>= cu_block ; cu_sibling_map_mask &= ( ( 1 << pcache_info [ cache_type ] . num_cu_shared ) - 1 ) ; first_active_cu = ffs ( cu_sibling_map_mask ) ; if ( first_active_cu ) { pcache = kfd_alloc_struct ( pcache ) ; if ( ! pcache ) { return - ENOMEM ; } pcache -> processor_id_low = cu_processor_id + ( first_active_cu - 1 ) ; pcache -> cache_level = pcache_info [ cache_type ] . cache_level ; pcache -> cache_size = pcache_info [ cache_type ] . cache_size ; if ( pcache_info [ cache_type ] . flags & CRAT_CACHE_FLAGS_DATA_CACHE ) { pcache -> cache_type |= HSA_CACHE_TYPE_DATA ; } if ( pcache_info [ cache_type ] . flags & CRAT_CACHE_FLAGS_INST_CACHE ) { pcache -> cache_type |= HSA_CACHE_TYPE_INSTRUCTION ; } if ( pcache_info [ cache_type ] . flags & CRAT_CACHE_FLAGS_CPU_CACHE ) { pcache -> cache_type |= HSA_CACHE_TYPE_CPU ; } if ( pcache_info [ cache_type ] . flags & CRAT_CACHE_FLAGS_SIMD_CACHE ) { pcache -> cache_type |= HSA_CACHE_TYPE_HSACU ; } cu_sibling_map_mask = cu_sibling_map_mask >> ( first_active_cu - 1 ) ; pcache -> sibling_map [ 0 ] = ( uint8_t ) ( cu_sibling_map_mask & 0xFF ) ; pcache -> sibling_map [ 1 ] = ( uint8_t ) ( ( cu_sibling_map_mask >> 8 ) & 0xFF ) ; pcache -> sibling_map [ 2 ] = ( uint8_t ) ( ( cu_sibling_map_mask >> 16 ) & 0xFF ) ; pcache -> sibling_map [ 3 ] = ( uint8_t ) ( ( cu_sibling_map_mask >> 24 ) & 0xFF ) ; pcache -> sibling_map_size = 4 ; * props_ext = pcache ; return 0 ; } return 1 ; } 