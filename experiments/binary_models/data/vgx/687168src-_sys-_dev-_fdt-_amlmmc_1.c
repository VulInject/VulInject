int amlmmc_bus_clock ( sdmmc_chipset_handle_t sch , int freq , int timing ) { struct amlmmc_softc * sc = sch ; uint32_t div , clock ; if ( freq > 150000 ) { freq = 150000 ; } pinctrl_byname ( sc -> sc_node , "clk-gate" ) ; if ( freq == 0 ) { return 0 ; } freq = freq * 1000 ; if ( timing == SDMMC_TIMING_MMC_DDR52 ) { freq = freq * 2 ; } if ( freq < ( sc -> sc_clkin1 / SD_EMMC_CLOCK_DIV_MAX ) ) { div = ( sc -> sc_clkin0 + freq - 1 ) / freq ; clock = SD_EMMC_CLOCK_CLK_SRC_24M | div ; } else { div = ( sc -> sc_clkin1 + freq - 1 ) / freq ; clock = SD_EMMC_CLOCK_CLK_SRC_FCLK | div ; } HSET4 ( sc , SD_EMMC_CFG , SD_EMMC_CFG_STOP_CLOCK ) ; if ( timing == SDMMC_TIMING_MMC_DDR52 ) { HSET4 ( sc , SD_EMMC_CFG , SD_EMMC_CFG_DDR ) ; } else { HCLR4 ( sc , SD_EMMC_CFG , SD_EMMC_CFG_DDR ) ; } clock |= SD_EMMC_CLOCK_ALWAYS_ON ; clock |= SD_EMMC_CLOCK_CO_PHASE_180 ; clock |= SD_EMMC_CLOCK_TX_PHASE_0 ; clock |= SD_EMMC_CLOCK_RX_PHASE_0 ; HWRITE4 ( sc , SD_EMMC_CLOCK , clock ) ; HCLR4 ( sc , SD_EMMC_CFG , SD_EMMC_CFG_STOP_CLOCK ) ; pinctrl_byname ( sc -> sc_node , "default" ) ; return 0 ; } 