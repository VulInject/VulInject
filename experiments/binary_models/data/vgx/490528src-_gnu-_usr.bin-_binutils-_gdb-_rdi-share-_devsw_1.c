AdpErrs DevSW_Read ( const DeviceDescr * device , const DevChanID type , Packet * * packet , bool block ) { int read_err ; DevSWState * ds = device -> SwitcherState ; if ( ds -> ds_nextreadpacket == NULL ) { if ( initialise_read ( ds ) < 0 ) { * packet = Adp_removeFromQueue ( & ds -> ds_readqueue [ type ] ) ; return adp_ok ; } } read_err = device -> DeviceRead ( & ds -> ds_activeread , block ) ; switch ( read_err ) { case 1 : printf ( "got a complete packet\n" ) ; if ( angelDebugLogEnable ) { dumpPacket ( angelDebugLogFile , "rx:" , & ds -> ds_activeread . dc_packet ) ; } enqueue_packet ( ds , NULL ) ; * packet = Adp_removeFromQueue ( & ds -> ds_readqueue [ type ] ) ; return adp_ok ; case 0 : * packet = Adp_removeFromQueue ( & ds -> ds_readqueue [ type ] ) ; return adp_ok ; case - 1 : printf ( "got a bad packet\n" ) ; * packet = NULL ; return adp_bad_packet ; default : panic ( "DevSW_Read: bad read status %d" , read_err ) ; } return 0 ; } 