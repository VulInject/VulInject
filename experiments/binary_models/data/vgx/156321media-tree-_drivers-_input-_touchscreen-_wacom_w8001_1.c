static int w8001_connect ( struct serio * serio , struct serio_driver * drv ) { struct w8001 * w8001 ; struct input_dev * input_dev_pen ; struct input_dev * input_dev_touch ; char basename [ 64 ] ; int err , err_pen , err_touch ; w8001 = kzalloc ( sizeof ( w8001 ) , GFP_KERNEL ) ; input_dev_pen = input_allocate_device ( ) ; input_dev_touch = input_allocate_device ( ) ; if ( ! w8001 || ! input_dev_pen || ! input_dev_touch ) { err = - ENOMEM ; fail1 } w8001 -> serio = serio ; w8001 -> pen_dev = input_dev_pen ; w8001 -> touch_dev = input_dev_touch ; init_completion ( & w8001 -> cmd_done ) ; snprintf ( w8001 -> phys , sizeof ( w8001 -> phys ) , "%s/input0" , serio -> phys ) ; serio_set_drvdata ( serio , w8001 ) ; err = serio_open ( serio , drv ) ; if ( err ) { fail2 } err = w8001_detect ( w8001 ) ; if ( err ) { fail3 } strlcpy ( basename , "Wacom Serial" , sizeof ( basename ) ) ; err_pen = w8001_setup_pen ( w8001 , basename , sizeof ( basename ) ) ; err_touch = w8001_setup_touch ( w8001 , basename , sizeof ( basename ) ) ; if ( err_pen && err_touch ) { err = - ENXIO ; fail3 } if ( ! err_pen ) { strlcpy ( w8001 -> pen_name , basename , sizeof ( w8001 -> pen_name ) ) ; strlcat ( w8001 -> pen_name , " Pen" , sizeof ( w8001 -> pen_name ) ) ; input_dev_pen -> name = w8001 -> pen_name ; w8001_set_devdata ( input_dev_pen , w8001 , serio ) ; err = input_register_device ( w8001 -> pen_dev ) ; if ( err ) { fail3 } } else { input_free_device ( input_dev_pen ) ; input_dev_pen = NULL ; w8001 -> pen_dev = NULL ; } if ( ! err_touch ) { strlcpy ( w8001 -> touch_name , basename , sizeof ( w8001 -> touch_name ) ) ; strlcat ( w8001 -> touch_name , " Finger" , sizeof ( w8001 -> touch_name ) ) ; input_dev_touch -> name = w8001 -> touch_name ; w8001_set_devdata ( input_dev_touch , w8001 , serio ) ; err = input_register_device ( w8001 -> touch_dev ) ; if ( err ) { fail4 } } else { input_free_device ( input_dev_touch ) ; input_dev_touch = NULL ; w8001 -> touch_dev = NULL ; } return 0 ; fail4 if ( w8001 -> pen_dev ) { input_unregister_device ( w8001 -> pen_dev ) ; } fail3 serio_close ( serio ) ; fail2 serio_set_drvdata ( serio , NULL ) ; fail1 input_free_device ( input_dev_pen ) ; input_free_device ( input_dev_touch ) ; kfree ( w8001 ) ; return err ; } 