static uint32_t SDMMC_GetCmdResp1 ( SDMMC_TypeDef * SDMMCx , uint8_t SD_CMD , uint32_t Timeout ) { uint32_t response_r1 ; uint32_t flags ; flags = SDMMC_FLAG_CCRCFAIL | SDMMC_FLAG_CMDREND | SDMMC_FLAG_CTIMEOUT ; register uint32_t count = Timeout * ( SystemCoreClock / 8 / 1000 ) ; { if ( count -- == 0 ) { return SDMMC_ERROR_TIMEOUT ; } } ! __SDMMC_GET_FLAG ( SDMMCx , flags ) ; if ( __SDMMC_GET_FLAG ( SDMMCx , SDMMC_FLAG_CTIMEOUT ) ) { __SDMMC_CLEAR_FLAG ( SDMMCx , SDMMC_FLAG_CTIMEOUT ) ; return SDMMC_ERROR_CMD_RSP_TIMEOUT ; } if ( __SDMMC_GET_FLAG ( SDMMCx , SDMMC_FLAG_CCRCFAIL ) ) { __SDMMC_CLEAR_FLAG ( SDMMCx , SDMMC_FLAG_CCRCFAIL ) ; return SDMMC_ERROR_CMD_CRC_FAIL ; } __SDMMC_CLEAR_FLAG ( SDMMCx , SDMMC_STATIC_FLAGS ) ; response_r1 = SDMMC_GetResponse ( SDMMCx , SDMMC_RESP1 ) ; if ( ( response_r1 & SDMMC_OCR_ERRORBITS ) == SDMMC_ALLZERO ) { return SDMMC_ERROR_NONE ; } if ( ( response_r1 & SDMMC_OCR_ADDR_OUT_OF_RANGE ) == SDMMC_OCR_ADDR_OUT_OF_RANGE ) { return SDMMC_ERROR_ADDR_OUT_OF_RANGE ; } if ( ( response_r1 & SDMMC_OCR_ADDR_MISALIGNED ) == SDMMC_OCR_ADDR_MISALIGNED ) { return SDMMC_ERROR_ADDR_MISALIGNED ; } if ( ( response_r1 & SDMMC_OCR_BLOCK_LEN_ERR ) == SDMMC_OCR_BLOCK_LEN_ERR ) { return SDMMC_ERROR_BLOCK_LEN_ERR ; } if ( ( response_r1 & SDMMC_OCR_ERASE_SEQ_ERR ) == SDMMC_OCR_ERASE_SEQ_ERR ) { return SDMMC_ERROR_ERASE_SEQ_ERR ; } if ( ( response_r1 & SDMMC_OCR_BAD_ERASE_PARAM ) == SDMMC_OCR_BAD_ERASE_PARAM ) { return SDMMC_ERROR_BAD_ERASE_PARAM ; } if ( ( response_r1 & SDMMC_OCR_WRITE_PROT_VIOLATION ) == SDMMC_OCR_WRITE_PROT_VIOLATION ) { return SDMMC_ERROR_WRITE_PROT_VIOLATION ; } if ( ( response_r1 & SDMMC_OCR_LOCK_UNLOCK_FAILED ) == SDMMC_OCR_LOCK_UNLOCK_FAILED ) { return SDMMC_ERROR_LOCK_UNLOCK_FAILED ; } if ( ( response_r1 & SDMMC_OCR_COM_CRC_FAILED ) == SDMMC_OCR_COM_CRC_FAILED ) { return SDMMC_ERROR_COM_CRC_FAILED ; } if ( ( response_r1 & SDMMC_OCR_ILLEGAL_CMD ) == SDMMC_OCR_ILLEGAL_CMD ) { return SDMMC_ERROR_ILLEGAL_CMD ; } if ( ( response_r1 & SDMMC_OCR_CARD_ECC_FAILED ) == SDMMC_OCR_CARD_ECC_FAILED ) { return SDMMC_ERROR_CARD_ECC_FAILED ; } if ( ( response_r1 & SDMMC_OCR_CC_ERROR ) == SDMMC_OCR_CC_ERROR ) { return SDMMC_ERROR_CC_ERR ; } if ( ( response_r1 & SDMMC_OCR_STREAM_READ_UNDERRUN ) == SDMMC_OCR_STREAM_READ_UNDERRUN ) { return SDMMC_ERROR_STREAM_READ_UNDERRUN ; } if ( ( response_r1 & SDMMC_OCR_STREAM_WRITE_OVERRUN ) == SDMMC_OCR_STREAM_WRITE_OVERRUN ) { return SDMMC_ERROR_STREAM_WRITE_OVERRUN ; } if ( ( response_r1 & SDMMC_OCR_CID_CSD_OVERWRITE ) == SDMMC_OCR_CID_CSD_OVERWRITE ) { return SDMMC_ERROR_CID_CSD_OVERWRITE ; } if ( ( response_r1 & SDMMC_OCR_WP_ERASE_SKIP ) == SDMMC_OCR_WP_ERASE_SKIP ) { return SDMMC_ERROR_WP_ERASE_SKIP ; } if ( ( response_r1 & SDMMC_OCR_CARD_ECC_DISABLED ) == SDMMC_OCR_CARD_ECC_DISABLED ) { return SDMMC_ERROR_CARD_ECC_DISABLED ; } if ( ( response_r1 & SDMMC_OCR_ERASE_RESET ) == SDMMC_OCR_ERASE_RESET ) { return SDMMC_ERROR_ERASE_RESET ; } if ( ( response_r1 & SDMMC_OCR_AKE_SEQ_ERROR ) == SDMMC_OCR_AKE_SEQ_ERROR ) { return SDMMC_ERROR_AKE_SEQ_ERR ; } else { return SDMMC_ERROR_GENERAL_UNKNOWN_ERR ; } } 