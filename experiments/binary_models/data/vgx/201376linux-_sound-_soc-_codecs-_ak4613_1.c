static void ak4613_hw_constraints ( struct ak4613_priv * priv , struct snd_pcm_substream * substream ) { struct snd_pcm_runtime * runtime = substream -> runtime ; static const unsigned int ak4613_rates [ ] { 32000 44100 48000 64000 88200 96000 176400 192000 } ; ; static const unsigned int ak4613_channels [ ] { [ AK4613_CHANNEL_2 ] = 2 [ AK4613_CHANNEL_4 ] = 4 [ AK4613_CHANNEL_8 ] = 8 [ AK4613_CHANNEL_12 ] = 12 } ; ; static const int mask_list [ MODE_MAX ] [ SDTx_MAX ] { [ AK4613_CONFIG_MODE_STEREO ] = { MASK ( 2 ) MASK ( 2 ) MASK ( 2 ) MASK ( 2 ) } [ AK4613_CONFIG_MODE_TDM512 ] = { MASK ( 4 ) MASK ( 12 ) MASK ( 12 ) MASK ( 12 ) } [ AK4613_CONFIG_MODE_TDM256 ] = { MASK ( 4 ) MASK ( 8 ) MASK ( 8 ) | MASK ( 12 ) MASK ( 8 ) | MASK ( 12 ) } [ AK4613_CONFIG_MODE_TDM128 ] = { MASK ( 4 ) MASK ( 4 ) MASK ( 4 ) | MASK ( 8 ) MASK ( 4 ) | MASK ( 8 ) | MASK ( 12 ) } } ; ; struct snd_pcm_hw_constraint_list * constraint ; unsigned int mask ; unsigned int mode ; unsigned int fs ; int is_play = substream -> stream == SNDRV_PCM_STREAM_PLAYBACK ; int sdti_num ; int i ; constraint = & priv -> constraint_rates ; constraint -> list = ak4613_rates ; constraint -> count = 0 ; for ( i = 0 ; i < ARRAY_SIZE ( ak4613_rates ) ; i ++ ) { fs = ( ak4613_rates [ i ] <= 96000 ) ?256 : 128 ; if ( priv -> sysclk >= ak4613_rates [ i ] * fs ) { constraint -> count = i + 1 ; } } snd_pcm_hw_constraint_list ( runtime , 0 , SNDRV_PCM_HW_PARAM_RATE , constraint ) ; sdti_num = AK4613_CONFIG_SDTI_get ( priv ) ; if ( WARN_ON ( sdti_num >= SDTx_MAX ) ) { return ; } if ( priv -> cnt ) { mode = AK4613_CTRL1_TO_MODE ( priv ) ; mask = 0 ; } else { mode = AK4613_CONFIG_GET ( priv , MODE ) ; mask = mask_list [ AK4613_CONFIG_MODE_STEREO ] [ is_play * sdti_num ] ; } if ( WARN_ON ( mode >= MODE_MAX ) ) { return ; } mask |= mask_list [ mode ] [ is_play * sdti_num ] ; constraint = & priv -> constraint_channels ; constraint -> list = ak4613_channels ; constraint -> mask = mask ; constraint -> count = sizeof ( ak4613_channels ) ; snd_pcm_hw_constraint_list ( runtime , 0 , SNDRV_PCM_HW_PARAM_CHANNELS , constraint ) ; } 