int get_dev_list ( crypto_get_dev_list_t * * ppdevlist ) { crypto_get_dev_list_t * pdevlist ; int fd = - 1 ; int count = DEFAULT_DEV_NUM ; pdevlist = malloc ( sizeof ( crypto_get_dev_list_t ) + sizeof ( crypto_dev_list_entry_t ) * ( count - 1 ) ) ; if ( pdevlist == NULL ) { cryptodebug ( "out of memory." ) ; return ( FAILURE ) ; } if ( ( fd = open ( ADMIN_IOCTL_DEVICE , O_RDONLY ) ) == - 1 ) { cryptoerror ( LOG_STDERR , gettext ( "failed to open %s: %s" ) , ADMIN_IOCTL_DEVICE , strerror ( errno ) ) ; return ( FAILURE ) ; } pdevlist -> dl_dev_count = count ; if ( ioctl ( fd , CRYPTO_GET_DEV_LIST , pdevlist ) == - 1 ) { cryptodebug ( "CRYPTO_GET_DEV_LIST ioctl failed: %s" , strerror ( errno ) ) ; free ( pdevlist ) ; ( void ) close ( fd ) ; return ( FAILURE ) ; } if ( pdevlist -> dl_return_value == CRYPTO_BUFFER_TOO_SMALL ) { count = pdevlist -> dl_dev_count ; free ( pdevlist ) ; pdevlist = malloc ( sizeof ( crypto_get_dev_list_t ) + sizeof ( crypto_dev_list_entry_t ) * ( count - 1 ) ) ; if ( pdevlist == NULL ) { cryptodebug ( "out of memory." ) ; ( void ) close ( fd ) ; return ( FAILURE ) ; } if ( ioctl ( fd , CRYPTO_GET_DEV_LIST , pdevlist ) == - 1 ) { cryptodebug ( "CRYPTO_GET_DEV_LIST ioctl failed: %s" , strerror ( errno ) ) ; free ( pdevlist ) ; ( void ) close ( fd ) ; return ( FAILURE ) ; } } if ( pdevlist -> dl_return_value != CRYPTO_SUCCESS ) { cryptodebug ( "CRYPTO_GET_DEV_LIST ioctl failed, " "return_value = %d" , pdevlist -> dl_return_value ) ; free ( pdevlist ) ; ( void ) close ( fd ) ; return ( FAILURE ) ; } * ppdevlist = pdevlist ; ( void ) close ( fd ) ; return ( SUCCESS ) ; } 