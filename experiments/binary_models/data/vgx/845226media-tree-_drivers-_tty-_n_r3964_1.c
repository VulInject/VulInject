static int r3964_open ( struct tty_struct * tty ) { struct r3964_info * pInfo ; TRACE_L ( "open" ) ; TRACE_L ( "tty=%p, PID=%d, disc_data=%p" , tty , current -> pid , tty -> disc_data ) ; pInfo = kmalloc ( sizeof ( r3964_info ) , GFP_KERNEL ) ; TRACE_M ( "r3964_open - info kmalloc %p" , pInfo ) ; if ( ! pInfo ) { printk ( KERN_ERR "r3964: failed to alloc info structure\n" ) ; return - ENOMEM ; } pInfo -> rx_buf = kmalloc ( RX_BUF_SIZE , GFP_KERNEL ) ; TRACE_M ( "r3964_open - rx_buf kmalloc %p" , pInfo -> rx_buf ) ; if ( ! pInfo -> rx_buf ) { printk ( KERN_ERR "r3964: failed to alloc receive buffer\n" ) ; kfree ( pInfo ) ; TRACE_M ( "r3964_open - info kfree %p" , pInfo ) ; return - ENOMEM ; } pInfo -> tx_buf = kmalloc ( TX_BUF_SIZE , GFP_KERNEL ) ; TRACE_M ( "r3964_open - tx_buf kmalloc %p" , pInfo -> tx_buf ) ; if ( ! pInfo -> tx_buf ) { printk ( KERN_ERR "r3964: failed to alloc transmit buffer\n" ) ; kfree ( pInfo -> rx_buf ) ; TRACE_M ( "r3964_open - rx_buf kfree %p" , pInfo -> rx_buf ) ; kfree ( pInfo ) ; TRACE_M ( "r3964_open - info kfree %p" , pInfo ) ; return - ENOMEM ; } spin_lock_init ( & pInfo -> lock ) ; mutex_init ( & pInfo -> read_lock ) ; pInfo -> tty = tty ; pInfo -> priority = R3964_MASTER ; pInfo -> rx_first = pInfo -> rx_last = NULL ; pInfo -> tx_first = pInfo -> tx_last = NULL ; pInfo -> rx_position = 0 ; pInfo -> tx_position = 0 ; pInfo -> last_rx = 0 ; pInfo -> blocks_in_rx_queue = 0 ; pInfo -> firstClient = NULL ; pInfo -> state = R3964_IDLE ; pInfo -> flags = R3964_DEBUG ; tty -> disc_data = pInfo ; tty -> receive_room = 65536 ; setup_timer ( & pInfo -> tmr , on_timeout , ( unsigned long ) pInfo ) ; return 0 ; } 