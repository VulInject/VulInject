int config_setkeys ( struct iked * env ) { FILE * fp = NULL ; EVP_PKEY * key = NULL ; struct iked_id privkey ; struct iked_id pubkey ; int iov [ 2 ] ; int ret = - 1 ; memset ( & privkey , 0 , sizeof ( privkey ) ) ; memset ( & pubkey , 0 , sizeof ( pubkey ) ) ; if ( ( fp = fopen ( IKED_PRIVKEY , "r" ) ) == NULL ) { log_warn ( "%s: failed to open private key" , __func__ ) ; done } if ( ( key = PEM_read_PrivateKey ( fp , NULL , NULL , NULL ) ) == NULL ) { log_warnx ( "%s: failed to read private key" , __func__ ) ; done } if ( ca_privkey_serialize ( key , & privkey ) != 0 ) { log_warnx ( "%s: failed to serialize private key" , __func__ ) ; done } if ( ca_pubkey_serialize ( key , & pubkey ) != 0 ) { log_warnx ( "%s: failed to serialize public key" , __func__ ) ; done } iov [ 0 ] . iov_base = & privkey ; iov [ 0 ] . iov_len = sizeof ( privkey ) ; iov [ 1 ] . iov_base = ibuf_data ( privkey . id_buf ) ; iov [ 1 ] . iov_len = ibuf_length ( privkey . id_buf ) ; if ( proc_composev ( & env -> sc_ps , PROC_CERT , IMSG_PRIVKEY , iov , 2 ) == - 1 ) { log_warnx ( "%s: failed to send private key" , __func__ ) ; done } iov [ 0 ] . iov_base = & pubkey ; iov [ 0 ] . iov_len = sizeof ( pubkey ) ; iov [ 1 ] . iov_base = ibuf_data ( pubkey . id_buf ) ; iov [ 1 ] . iov_len = ibuf_length ( pubkey . id_buf ) ; if ( proc_composev ( & env -> sc_ps , PROC_CERT , IMSG_PUBKEY , iov , 2 ) == - 1 ) { log_warnx ( "%s: failed to send public key" , __func__ ) ; done } ret = 0 ; done if ( fp != NULL ) { fclose ( fp ) ; } ibuf_release ( pubkey . id_buf ) ; ibuf_release ( privkey . id_buf ) ; EVP_PKEY_free ( key ) ; return ( ret ) ; } 