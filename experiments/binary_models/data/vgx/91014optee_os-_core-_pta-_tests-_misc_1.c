static int self_test_malloc ( void ) { char * p1 = NULL , * p2 = NULL ; int * p3 = NULL , * p4 = NULL ; bool r ; int ret = 0 ; LOG ( "malloc tests:" ) ; LOG ( "  p1=%p  p2=%p  p3=%p  p4=%p" , ( void * ) p1 , ( void * ) p2 , ( void * ) p3 , ( void * ) p4 ) ; p1 = malloc ( 1024 ) ; LOG ( "- p1 = malloc(1024)" ) ; p2 = malloc ( 1024 ) ; LOG ( "- p2 = malloc(1024)" ) ; LOG ( "  p1=%p  p2=%p  p3=%p  p4=%p" , ( void * ) p1 , ( void * ) p2 , ( void * ) p3 , ( void * ) p4 ) ; r = ( p1 && p2 && malloc_buffer_is_within_alloced ( p1 , 1024 ) && ! malloc_buffer_is_within_alloced ( p1 + 25 , 1000 ) && ! malloc_buffer_is_within_alloced ( p1 - 25 , 500 ) && malloc_buffer_overlaps_heap ( p1 - 25 , 500 ) ) ; if ( ! r ) { ret = - 1 ; } LOG ( "  =>test %s" , r ?"ok" : "FAILED" ) ; LOG ( "" ) ; p3 = realloc ( p1 , 3 * 1024 ) ; if ( p3 ) { p1 = NULL ; } LOG ( "- p3 = realloc(p1, 3*1024)" ) ; LOG ( "- free p2" ) ; p2 = malloc ( 1024 ) ; LOG ( "- p2 = malloc(1024)" ) ; LOG ( "  p1=%p  p2=%p  p3=%p  p4=%p" , ( void * ) p1 , ( void * ) p2 , ( void * ) p3 , ( void * ) p4 ) ; r = ( p2 && p3 ) ; if ( ! r ) { ret = - 1 ; } LOG ( "  =>test %s" , r ?"ok" : "FAILED" ) ; LOG ( "" ) ; LOG ( "- free p1, p2, p3" ) ; free ( p1 ) ; free ( p2 ) ; free ( p3 ) ; p1 = NULL ; p2 = NULL ; p3 = NULL ; p3 = calloc ( 4 , 1024 ) ; p4 = calloc ( 0x100 , 1024 * 1024 ) ; LOG ( "- p3 = calloc(4, 1024)" ) ; LOG ( "- p4 = calloc(0x100, 1024*1024)   too big: should fail!" ) ; LOG ( "  p1=%p  p2=%p  p3=%p  p4=%p" , ( void * ) p1 , ( void * ) p2 , ( void * ) p3 , ( void * ) p4 ) ; r = ( p3 && ! p4 ) ; if ( ! r ) { ret = - 1 ; } LOG ( "  =>test %s" , r ?"ok" : "FAILED" ) ; LOG ( "" ) ; LOG ( "- free p3, p4" ) ; free ( p3 ) ; free ( p4 ) ; p3 = NULL ; p4 = NULL ; p3 = memalign ( 0x1000 , 1024 ) ; LOG ( "- p3 = memalign(%d, 1024)" , 0x1000 ) ; p1 = malloc ( 1024 ) ; LOG ( "- p1 = malloc(1024)" ) ; p4 = memalign ( 0x100 , 512 ) ; LOG ( "- p4 = memalign(%d, 512)" , 0x100 ) ; LOG ( "  p1=%p  p2=%p  p3=%p  p4=%p" , ( void * ) p1 , ( void * ) p2 , ( void * ) p3 , ( void * ) p4 ) ; r = ( p1 && p3 && p4 && ! ( ( vaddr_t ) p3 % 0x1000 ) && ! ( ( vaddr_t ) p4 % 0x100 ) ) ; if ( ! r ) { ret = - 1 ; } LOG ( "  =>test %s" , r ?"ok" : "FAILED" ) ; LOG ( "" ) ; LOG ( "- free p1, p3, p4" ) ; free ( p1 ) ; free ( p3 ) ; free ( p4 ) ; p1 = NULL ; p3 = NULL ; p4 = NULL ; p3 = memalign ( 100 , 1024 ) ; LOG ( "- p3 = memalign(%d, 1024)" , 100 ) ; p4 = memalign ( 0 , 1024 ) ; LOG ( "- p4 = memalign(%d, 1024)" , 0 ) ; LOG ( "  p1=%p  p2=%p  p3=%p  p4=%p" , ( void * ) p1 , ( void * ) p2 , ( void * ) p3 , ( void * ) p4 ) ; r = ( ! p3 && ! p4 ) ; if ( ! r ) { ret = - 1 ; } LOG ( "  =>test %s" , r ?"ok" : "FAILED" ) ; LOG ( "" ) ; LOG ( "- free p3, p4" ) ; free ( p3 ) ; free ( p4 ) ; p3 = NULL ; p4 = NULL ; LOG ( "- free NULL" ) ; free ( NULL ) ; LOG ( "" ) ; LOG ( "malloc test done" ) ; return ret ; } 