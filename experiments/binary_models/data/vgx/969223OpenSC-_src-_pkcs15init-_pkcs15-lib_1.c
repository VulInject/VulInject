int sc_pkcs15init_store_certificate ( struct sc_pkcs15_card * p15card , struct sc_profile * profile , struct sc_pkcs15init_certargs * args , struct sc_pkcs15_object * * res_obj ) { struct sc_context * ctx = p15card -> card -> ctx ; struct sc_pkcs15_cert_info * cert_info = NULL ; struct sc_pkcs15_object * object = NULL ; struct sc_pkcs15_object * key_object = NULL ; struct sc_path existing_path ; const char * label = NULL ; int r ; LOG_FUNC_CALLED ( ctx ) ; label = args -> label ; if ( ! label ) { label = "Certificate" ; } r = sc_pkcs15init_select_intrinsic_id ( p15card , profile , SC_PKCS15_TYPE_CERT_X509 , & args -> id , & args -> der_encoded ) ; LOG_TEST_RET ( ctx , r , "Get certificate 'intrinsic ID' error" ) ; sc_log ( ctx , "Cert(ID:%s) rv %i" , sc_pkcs15_print_id ( & args -> id ) , r ) ; r = select_id ( p15card , SC_PKCS15_TYPE_CERT , & args -> id ) ; if ( r == SC_ERROR_NON_UNIQUE_ID && args -> update ) { struct sc_pkcs15_object * existing_obj = NULL ; r = sc_pkcs15_find_object_by_id ( p15card , SC_PKCS15_TYPE_CERT , & args -> id , & existing_obj ) ; if ( ! r ) { sc_log ( ctx , "Found cert(ID:%s)" , sc_pkcs15_print_id ( & args -> id ) ) ; existing_path = ( ( sc_pkcs15_cert_info * ) existing_obj -> data ) -> path ; sc_pkcs15_remove_object ( p15card , existing_obj ) ; sc_pkcs15_free_object ( existing_obj ) ; } r = select_id ( p15card , SC_PKCS15_TYPE_CERT , & args -> id ) ; } sc_log ( ctx , "Select ID Cert(ID:%s) rv %i" , sc_pkcs15_print_id ( & args -> id ) , r ) ; LOG_TEST_RET ( ctx , r , "Select certificate ID error" ) ; object = sc_pkcs15init_new_object ( SC_PKCS15_TYPE_CERT_X509 , label , NULL , NULL ) ; if ( object == NULL ) { LOG_TEST_RET ( ctx , SC_ERROR_OUT_OF_MEMORY , "Failed to allocate certificate object" ) ; } cert_info = ( sc_pkcs15_cert_info * ) object -> data ; cert_info -> id = args -> id ; cert_info -> authority = args -> authority ; sc_der_copy ( & object -> content , & args -> der_encoded ) ; sc_der_copy ( & cert_info -> value , & args -> der_encoded ) ; if ( existing_path . len ) { sc_log ( ctx , "Using existing path %s" , sc_print_path ( & existing_path ) ) ; cert_info -> path = existing_path ; } sc_log ( ctx , "Store cert(%.*s,ID:%s,der(%p,%" SC_FORMAT_LEN_SIZE_T "u))" , ( int ) sizeof object -> label , object -> label , sc_pkcs15_print_id ( & cert_info -> id ) , args -> der_encoded . value , args -> der_encoded . len ) ; if ( ! profile -> pkcs15 . direct_certificates ) { r = sc_pkcs15init_store_data ( p15card , profile , object , & args -> der_encoded , & cert_info -> path ) ; } if ( r >= 0 ) { r = sc_pkcs15init_add_object ( p15card , profile , SC_PKCS15_CDF , object ) ; } if ( r >= 0 ) { r = sc_pkcs15_prkey_attrs_from_cert ( p15card , object , & key_object ) ; if ( r ) { r = 0 ; } if ( key_object ) { if ( profile -> ops -> emu_update_any_df ) { r = profile -> ops -> emu_update_any_df ( profile , p15card , SC_AC_OP_UPDATE , key_object ) ; if ( r == SC_ERROR_NOT_SUPPORTED ) { r = SC_SUCCESS ; } } else { r = sc_pkcs15init_update_any_df ( p15card , profile , key_object -> df , 0 ) ; sc_log ( ctx , "update_any_df returned %i" , r ) ; } } } if ( r < 0 ) { sc_pkcs15_remove_object ( p15card , object ) ; sc_pkcs15_free_object ( object ) ; } if ( res_obj ) { * res_obj = object ; } profile -> dirty = 1 ; LOG_FUNC_RETURN ( ctx , r ) ; } 