static void mcam_frame_tasklet ( unsigned long data ) { struct mcam_camera * cam = ( mcam_camera * ) data ; int i ; cfs_time_t flags ; struct mcam_vb_buffer * buf ; spin_lock_irqsave ( & cam -> dev_lock , flags ) ; for ( i = 0 ; i < cam -> nbufs ; i ++ ) { int bufno = cam -> next_buf ; if ( cam -> state != S_STREAMING || bufno < 0 ) { break ; } if ( ++ ( cam -> next_buf ) >= cam -> nbufs ) { cam -> next_buf = 0 ; } if ( ! test_bit ( bufno , & cam -> flags ) ) { continue ; } if ( list_empty ( & cam -> buffers ) ) { cam -> frame_state . singles ++ ; break ; } cam -> frame_state . delivered ++ ; clear_bit ( bufno , & cam -> flags ) ; buf = list_first_entry ( & cam -> buffers , mcam_vb_buffer , queue ) ; list_del_init ( & buf -> queue ) ; spin_unlock_irqrestore ( & cam -> dev_lock , flags ) ; memcpy ( vb2_plane_vaddr ( & buf -> vb_buf . vb2_buf , 0 ) , cam -> dma_bufs [ bufno ] , cam -> pix_format . sizeimage ) ; mcam_buffer_done ( cam , bufno , & buf -> vb_buf ) ; spin_lock_irqsave ( & cam -> dev_lock , flags ) ; } spin_unlock_irqrestore ( & cam -> dev_lock , flags ) ; } 