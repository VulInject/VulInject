static int finddev_readdir_alt ( const char * path , finddevhdl_t * handlep ) { struct finddevhdl * handle ; DIR * dir ; struct dirent * dp ; size_t n ; * handlep = NULL ; if ( ( dir = opendir ( path ) ) == NULL ) { return ( ENOENT ) ; } restart handle = calloc ( 1 , sizeof ( finddevhdl ) ) ; if ( handle == NULL ) { ( void ) closedir ( dir ) ; return ( ENOMEM ) ; } handle -> npaths = 0 ; handle -> curpath = 0 ; handle -> paths = NULL ; n = 0 ; rewinddir ( dir ) ; while ( ( dp = readdir ( dir ) ) != NULL ) { if ( ( strcmp ( dp -> d_name , "." ) == 0 ) || ( strcmp ( dp -> d_name , ".." ) == 0 ) ) { continue ; } n ++ ; } handle -> npaths = n ; handle -> paths = calloc ( n , sizeof ( char * ) ) ; if ( handle -> paths == NULL ) { ( void ) closedir ( dir ) ; return ( ENOMEM ) ; } n = 0 ; rewinddir ( dir ) ; while ( ( dp = readdir ( dir ) ) != NULL ) { if ( ( strcmp ( dp -> d_name , "." ) == 0 ) || ( strcmp ( dp -> d_name , ".." ) == 0 ) ) { continue ; } if ( n == handle -> npaths ) { finddev_close ( ( finddevhdl_t ) handle ) ; restart } handle -> paths [ n ] = strdup ( dp -> d_name ) ; if ( handle -> paths [ n ] == NULL ) { ( void ) closedir ( dir ) ; finddev_close ( ( finddevhdl_t ) handle ) ; return ( ENOMEM ) ; } n ++ ; } ( void ) closedir ( dir ) ; * handlep = ( finddevhdl_t ) handle ; return ( 0 ) ; } 