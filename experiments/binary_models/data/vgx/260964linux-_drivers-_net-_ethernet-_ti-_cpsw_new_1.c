static int cpsw_probe_dt ( struct cpsw_common * cpsw ) { struct device_node * node = cpsw -> dev -> of_node , * tmp_node , * port_np ; struct cpsw_platform_data * data = & cpsw -> data ; struct device * dev = cpsw -> dev ; int ret ; u32 prop ; if ( ! node ) { return - EINVAL ; } tmp_node = of_get_child_by_name ( node , "ethernet-ports" ) ; if ( ! tmp_node ) { return - ENOENT ; } data -> slaves = of_get_child_count ( tmp_node ) ; if ( data -> slaves != CPSW_SLAVE_PORTS_NUM ) { of_node_put ( tmp_node ) ; return - ENOENT ; } data -> active_slave = 0 ; data -> dual_emac = true ; data -> bd_ram_size = CPSW_BD_RAM_SIZE ; data -> mac_control = 0 ; data -> slave_data = devm_kcalloc ( dev , CPSW_SLAVE_PORTS_NUM , sizeof ( cpsw_slave_data ) , GFP_KERNEL ) ; if ( ! data -> slave_data ) { of_node_put ( tmp_node ) ; return - ENOMEM ; } ret = devm_of_platform_populate ( dev ) ; if ( ret ) { dev_warn ( dev , "Doesn't have any child node\n" ) ; } for_each_child_of_node ( , ) { struct cpsw_slave_data * slave_data ; u32 port_id ; ret = of_property_read_u32 ( port_np , "reg" , & port_id ) ; if ( ret < 0 ) { dev_err ( dev , "%pOF error reading port_id %d\n" , port_np , ret ) ; err_node_put } if ( ! port_id || port_id > CPSW_SLAVE_PORTS_NUM ) { dev_err ( dev , "%pOF has invalid port_id %u\n" , port_np , port_id ) ; ret = - EINVAL ; err_node_put } slave_data = & data -> slave_data [ port_id - 1 ] ; slave_data -> disabled = ! of_device_is_available ( port_np ) ; if ( slave_data -> disabled ) { continue ; } slave_data -> slave_node = port_np ; slave_data -> ifphy = devm_of_phy_get ( dev , port_np , NULL ) ; if ( IS_ERR ( slave_data -> ifphy ) ) { ret = PTR_ERR ( slave_data -> ifphy ) ; dev_err ( dev , "%pOF: Error retrieving port phy: %d\n" , port_np , ret ) ; err_node_put } if ( of_phy_is_fixed_link ( port_np ) ) { ret = of_phy_register_fixed_link ( port_np ) ; if ( ret ) { dev_err_probe ( dev , ret , "%pOF failed to register fixed-link phy\n" , port_np ) ; err_node_put } slave_data -> phy_node = of_node_get ( port_np ) ; } else { slave_data -> phy_node = of_parse_phandle ( port_np , "phy-handle" , 0 ) ; } if ( ! slave_data -> phy_node ) { dev_err ( dev , "%pOF no phy found\n" , port_np ) ; ret = - ENODEV ; err_node_put } ret = of_get_phy_mode ( port_np , & slave_data -> phy_if ) ; if ( ret ) { dev_err ( dev , "%pOF read phy-mode err %d\n" , port_np , ret ) ; err_node_put } ret = of_get_mac_address ( port_np , slave_data -> mac_addr ) ; if ( ret ) { ret = ti_cm_get_macid ( dev , port_id - 1 , slave_data -> mac_addr ) ; if ( ret ) { err_node_put } } if ( of_property_read_u32 ( port_np , "ti,dual-emac-pvid" , & prop ) ) { dev_err ( dev , "%pOF Missing dual_emac_res_vlan in DT.\n" , port_np ) ; slave_data -> dual_emac_res_vlan = port_id ; dev_err ( dev , "%pOF Using %d as Reserved VLAN\n" , port_np , slave_data -> dual_emac_res_vlan ) ; } else { slave_data -> dual_emac_res_vlan = prop ; } } of_node_put ( tmp_node ) ; return 0 ; err_node_put of_node_put ( port_np ) ; of_node_put ( tmp_node ) ; return ret ; } 