static int query_perf_config_data ( struct drm_i915_private * i915 , struct drm_i915_query_item * query_item , bool use_uuid ) { struct drm_i915_query_perf_config __user * user_query_config_ptr = u64_to_user_ptr ( query_item -> data_ptr ) ; struct drm_i915_perf_oa_config __user * user_config_ptr = u64_to_user_ptr ( query_item -> data_ptr + sizeof ( drm_i915_query_perf_config ) ) ; struct drm_i915_perf_oa_config user_config ; struct i915_perf * perf = & i915 -> perf ; struct i915_oa_config * oa_config ; char uuid [ UUID_STRING_LEN + 1 ] ; u64 config_id ; u32 flags , total_size ; int ret ; total_size = sizeof ( drm_i915_query_perf_config ) + sizeof ( drm_i915_perf_oa_config ) ; if ( query_item -> length == 0 ) { return total_size ; } if ( query_item -> length < total_size ) { drm_dbg ( & i915 -> drm , "Invalid query config data item size=%u expected=%u\n" , query_item -> length , total_size ) ; return - EINVAL ; } if ( get_user ( flags , & user_query_config_ptr -> flags ) ) { return - EFAULT ; } if ( flags != 0 ) { return - EINVAL ; } if ( use_uuid ) { struct i915_oa_config * tmp ; int id ; BUILD_BUG_ON ( sizeof ( user_query_config_ptr -> uuid ) >= sizeof ( uuid ) ) ; memset ( & uuid , 0 , sizeof ( uuid ) ) ; if ( copy_from_user ( uuid , user_query_config_ptr -> uuid , sizeof ( user_query_config_ptr -> uuid ) ) ) { return - EFAULT ; } oa_config = NULL ; rcu_read_lock ( ) ; idr_for_each_entry ( , , ) { if ( ! strcmp ( tmp -> uuid , uuid ) ) { oa_config = i915_oa_config_get ( tmp ) ; break ; } } rcu_read_unlock ( ) ; } else { if ( get_user ( config_id , & user_query_config_ptr -> config ) ) { return - EFAULT ; } oa_config = i915_perf_get_oa_config ( perf , config_id ) ; } if ( ! oa_config ) { return - ENOENT ; } if ( copy_from_user ( & user_config , user_config_ptr , sizeof ( user_config ) ) ) { ret = - EFAULT ; out } ret = can_copy_perf_config_registers_or_number ( user_config . n_boolean_regs , user_config . boolean_regs_ptr , oa_config -> b_counter_regs_len ) ; if ( ret ) { out } ret = can_copy_perf_config_registers_or_number ( user_config . n_flex_regs , user_config . flex_regs_ptr , oa_config -> flex_regs_len ) ; if ( ret ) { out } ret = can_copy_perf_config_registers_or_number ( user_config . n_mux_regs , user_config . mux_regs_ptr , oa_config -> mux_regs_len ) ; if ( ret ) { out } ret = copy_perf_config_registers_or_number ( oa_config -> b_counter_regs , oa_config -> b_counter_regs_len , user_config . boolean_regs_ptr , & user_config . n_boolean_regs ) ; if ( ret ) { out } ret = copy_perf_config_registers_or_number ( oa_config -> flex_regs , oa_config -> flex_regs_len , user_config . flex_regs_ptr , & user_config . n_flex_regs ) ; if ( ret ) { out } ret = copy_perf_config_registers_or_number ( oa_config -> mux_regs , oa_config -> mux_regs_len , user_config . mux_regs_ptr , & user_config . n_mux_regs ) ; if ( ret ) { out } memcpy ( user_config . uuid , oa_config -> uuid , sizeof ( user_config . uuid ) ) ; if ( copy_to_user ( user_config_ptr , & user_config , sizeof ( user_config ) ) ) { ret = - EFAULT ; out } ret = total_size ; out i915_oa_config_put ( oa_config ) ; return ret ; } 