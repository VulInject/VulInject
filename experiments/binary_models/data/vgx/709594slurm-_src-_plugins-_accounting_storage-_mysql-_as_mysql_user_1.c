extern int as_mysql_add_coord ( mysql_conn_t * mysql_conn , uint32_t uid , List acct_list , slurmdb_user_cond_t * user_cond ) { char * query = NULL , * user = NULL , * acct = NULL ; char * user_name = NULL , * txn_query = NULL ; ListIterator itr , itr2 ; time_t now = time ( NULL ) ; int rc = SLURM_SUCCESS ; slurmdb_user_rec_t * user_rec = NULL ; if ( ! user_cond || ! user_cond -> assoc_cond || ! user_cond -> assoc_cond -> user_list || ! list_count ( user_cond -> assoc_cond -> user_list ) || ! acct_list || ! list_count ( acct_list ) ) { error ( "we need something to add" ) ; return SLURM_ERROR ; } if ( check_connection ( mysql_conn ) != SLURM_SUCCESS ) { return ESLURM_DB_CONNECTION ; } if ( ! is_user_min_admin_level ( mysql_conn , uid , SLURMDB_ADMIN_OPERATOR ) ) { slurmdb_user_rec_t user ; slurmdb_coord_rec_t * coord = NULL ; char * acct = NULL ; memset ( & user , 0 , sizeof ( slurmdb_user_rec_t ) ) ; user . uid = uid ; if ( ! is_user_any_coord ( mysql_conn , & user ) ) { error ( "Only admins/operators/coordinators " "can add account coordinators" ) ; return ESLURM_ACCESS_DENIED ; } itr = list_iterator_create ( acct_list ) ; itr2 = list_iterator_create ( user . coord_accts ) ; while ( ( acct = list_next ( itr ) ) ) { while ( ( coord = list_next ( itr2 ) ) ) { if ( ! xstrcasecmp ( coord -> name , acct ) ) { break ; } } if ( ! coord ) { break ; } list_iterator_reset ( itr2 ) ; } list_iterator_destroy ( itr2 ) ; list_iterator_destroy ( itr ) ; if ( ! coord ) { error ( "Coordinator %s(%d) tried to add another " "coordinator to an account they aren't " "coordinator over." , user . name , user . uid ) ; return ESLURM_ACCESS_DENIED ; } } user_name = uid_to_string ( ( uid_t ) uid ) ; itr = list_iterator_create ( user_cond -> assoc_cond -> user_list ) ; itr2 = list_iterator_create ( acct_list ) ; while ( ( user = list_next ( itr ) ) ) { if ( ! user [ 0 ] ) { continue ; } while ( ( acct = list_next ( itr2 ) ) ) { if ( ! acct [ 0 ] ) { continue ; } if ( query ) { xstrfmtcat ( query , ", (%ld, %ld, '%s', '%s')" , ( long ) now , ( long ) now , acct , user ) ; } else { query = xstrdup_printf ( "insert into %s (creation_time, " "mod_time, acct, user) values " "(%ld, %ld, '%s', '%s')" , acct_coord_table , ( long ) now , ( long ) now , acct , user ) ; } if ( txn_query ) { xstrfmtcat ( txn_query , ", (%ld, %u, '%s', '%s', '%s')" , ( long ) now , DBD_ADD_ACCOUNT_COORDS , user , user_name , acct ) ; } else { xstrfmtcat ( txn_query , "insert into %s " "(timestamp, action, name, " "actor, info) " "values (%ld, %u, '%s', " "'%s', '%s')" , txn_table , ( long ) now , DBD_ADD_ACCOUNT_COORDS , user , user_name , acct ) ; } } list_iterator_reset ( itr2 ) ; } xfree ( user_name ) ; list_iterator_destroy ( itr ) ; list_iterator_destroy ( itr2 ) ; if ( query ) { xstrfmtcat ( query , " on duplicate key update mod_time=%ld, " "deleted=0, user=VALUES(user);%s" , ( long ) now , txn_query ) ; DB_DEBUG ( DB_ASSOC , mysql_conn -> conn , "query\n%s" , query ) ; rc = mysql_db_query ( mysql_conn , query ) ; xfree ( txn_query ) ; if ( rc != SLURM_SUCCESS ) { error ( "Couldn't add cluster hour rollup" ) ; return rc ; } itr = list_iterator_create ( user_cond -> assoc_cond -> user_list ) ; while ( ( user = list_next ( itr ) ) ) { user_rec = xmalloc ( sizeof ( slurmdb_user_rec_t ) ) ; user_rec -> name = xstrdup ( user ) ; _get_user_coords ( mysql_conn , user_rec ) ; if ( addto_update_list ( mysql_conn -> update_list , SLURMDB_ADD_COORD , user_rec ) != SLURM_SUCCESS ) { slurmdb_destroy_user_rec ( user_rec ) ; } } list_iterator_destroy ( itr ) ; } return SLURM_SUCCESS ; } 