( ldc_map_sg ) ; int ldc_map_single ( struct ldc_channel * lp , void * buf , unsigned int len , struct ldc_trans_cookie * cookies , int ncookies , unsigned int map_perm ) { unsigned long npages , pa ; struct ldc_mtable_entry * base ; struct cookie_state state ; struct ldc_iommu * iommu ; if ( ( map_perm & ~ LDC_MAP_ALL ) || ( ncookies < 1 ) ) { return - EINVAL ; } pa = __pa ( buf ) ; if ( ( pa | len ) & ( 8UL - 1 ) ) { return - EFAULT ; } npages = pages_in_region ( pa , len ) ; iommu = & lp -> iommu ; base = alloc_npages ( iommu , npages ) ; state . page_table = iommu -> page_table ; state . cookies = cookies ; state . mte_base = perm_to_mte ( map_perm ) ; state . prev_cookie = ~ ( u64 ) 0 ; state . pte_idx = ( base - iommu -> page_table ) ; state . nc = 0 ; fill_cookies ( & state , ( pa & PAGE_MASK ) , ( pa & ~ PAGE_MASK ) , len ) ; BUG_ON ( state . nc > ncookies ) ; return state . nc ; } 