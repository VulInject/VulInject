static void ledtrig_tty_work ( struct work_struct * work ) { struct ledtrig_tty_data * trigger_data = container_of ( work , ledtrig_tty_data , dwork . work ) ; struct serial_icounter_struct icount ; int ret ; if ( ! trigger_data -> ttyname ) { mutex_unlock ( & trigger_data -> mutex ) ; return ; } if ( ! trigger_data -> tty ) { dev_t devno ; struct tty_struct * tty ; int ret ; ret = tty_dev_name_to_number ( trigger_data -> ttyname , & devno ) ; if ( ret < 0 ) { out } tty = tty_kopen_shared ( devno ) ; if ( IS_ERR ( tty ) || ! tty ) { out } trigger_data -> tty = tty ; } ret = tty_get_icount ( trigger_data -> tty , & icount ) ; if ( ret ) { dev_info ( trigger_data -> tty -> dev , "Failed to get icount, stopped polling\n" ) ; mutex_unlock ( & trigger_data -> mutex ) ; return ; } if ( icount . rx != trigger_data -> rx || icount . tx != trigger_data -> tx ) { led_set_brightness_sync ( trigger_data -> led_cdev , LED_ON ) ; trigger_data -> rx = icount . rx ; trigger_data -> tx = icount . tx ; } else { led_set_brightness_sync ( trigger_data -> led_cdev , LED_OFF ) ; } out mutex_unlock ( & trigger_data -> mutex ) ; schedule_delayed_work ( & trigger_data -> dwork , msecs_to_jiffies ( 100 ) ) ; } 