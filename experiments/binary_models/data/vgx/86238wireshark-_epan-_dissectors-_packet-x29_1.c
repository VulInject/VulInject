static int dissect_x29 ( tvbuff_t * tvb , packet_info * pinfo , proto_tree * tree , void * data ) { int offset = 0 ; proto_tree * x29_tree ; proto_item * ti ; gboolean * q_bit_set ; guint8 msg_code ; guint8 error_type ; guint8 type_ref ; gint next_offset ; int linelen ; q_bit_set = ( gboolean * ) data ; col_set_str ( pinfo -> cinfo , COL_PROTOCOL , "X.29" ) ; col_clear ( pinfo -> cinfo , COL_INFO ) ; ti = proto_tree_add_item ( tree , proto_x29 , tvb , offset , - 1 , ENC_NA ) ; x29_tree = proto_item_add_subtree ( ti , ett_x29 ) ; if ( * q_bit_set ) { msg_code = tvb_get_guint8 ( tvb , offset ) ; col_add_fstr ( pinfo -> cinfo , COL_INFO , "%s PAD message" , val_to_str ( msg_code , message_code_vals , "Unknown (0x%02x)" ) ) ; proto_tree_add_uint ( x29_tree , hf_msg_code , tvb , offset , 1 , msg_code ) ; offset ++ ; switch ( msg_code ) { case SET_MSG : case READ_MSG : case SET_AND_READ_MSG : case PARAMETER_IND_MSG : while ( tvb_reported_length_remaining ( tvb , offset ) > 0 ) { proto_tree_add_item ( x29_tree , hf_x29_parameter , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; proto_tree_add_item ( x29_tree , hf_x29_value , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; } break ; case INV_TO_CLEAR_MSG : break ; case ERROR_MSG : error_type = tvb_get_guint8 ( tvb , offset ) ; proto_tree_add_uint ( x29_tree , hf_error_type , tvb , offset , 1 , error_type ) ; offset ++ ; if ( error_type != 0 ) { proto_tree_add_item ( x29_tree , hf_inv_msg_code , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; } break ; case BREAK_IND_MSG : if ( tvb_reported_length_remaining ( tvb , offset ) > 0 ) { type_ref = tvb_get_guint8 ( tvb , offset ) ; proto_tree_add_item ( x29_tree , hf_x29_type_reference , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; switch ( type_ref ) { case 0x01 : proto_tree_add_item ( x29_tree , hf_x29_type_of_aspect , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; break ; case 0x08 : proto_tree_add_item ( x29_tree , hf_x29_break_value , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; break ; default : proto_tree_add_item ( x29_tree , hf_x29_type_reference_value , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; break ; } } break ; case RESELECTION_MSG : proto_tree_add_item ( x29_tree , hf_x29_reselection_message_data , tvb , offset , - 1 , ENC_NA ) ; break ; case RESEL_WITH_TOA_NPI_MSG : proto_tree_add_item ( x29_tree , hf_x29_reselection_message_data , tvb , offset , - 1 , ENC_NA ) ; break ; default : proto_tree_add_item ( x29_tree , hf_x29_pad_message_data , tvb , offset , - 1 , ENC_NA ) ; break ; } } else { col_set_str ( pinfo -> cinfo , COL_INFO , "Data ..." ) ; if ( tree ) { while ( tvb_offset_exists ( tvb , offset ) ) { tvb_find_line_end ( tvb , offset , - 1 , & next_offset , FALSE ) ; linelen = next_offset - offset ; proto_tree_add_item ( x29_tree , hf_x29_data , tvb , offset , linelen , ENC_NA | ENC_ASCII ) ; offset = next_offset ; } } } return tvb_captured_length ( tvb ) ; } 