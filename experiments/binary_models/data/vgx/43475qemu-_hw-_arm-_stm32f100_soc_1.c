static void stm32f100_soc_realize ( DeviceState * dev_soc , Error * * errp ) { STM32F100State * s = STM32F100_SOC ( dev_soc ) ; DeviceState * dev , * armv7m ; SysBusDevice * busdev ; int i ; MemoryRegion * system_memory = get_system_memory ( ) ; if ( clock_has_source ( s -> refclk ) ) { error_setg ( errp , "refclk clock must not be wired up by the board code" ) ; return ; } if ( ! clock_has_source ( s -> sysclk ) ) { error_setg ( errp , "sysclk clock must be wired up by the board code" ) ; return ; } clock_set_mul_div ( s -> refclk , 8 , 1 ) ; clock_set_source ( s -> refclk , s -> sysclk ) ; memory_region_init_rom ( & s -> flash , OBJECT ( dev_soc ) , "STM32F100.flash" , FLASH_SIZE , & error_fatal ) ; memory_region_init_alias ( & s -> flash_alias , OBJECT ( dev_soc ) , "STM32F100.flash.alias" , & s -> flash , 0 , FLASH_SIZE ) ; memory_region_add_subregion ( system_memory , FLASH_BASE_ADDRESS , & s -> flash ) ; memory_region_add_subregion ( system_memory , 0 , & s -> flash_alias ) ; memory_region_init_ram ( & s -> sram , NULL , "STM32F100.sram" , SRAM_SIZE , & error_abort ) ; memory_region_add_subregion ( system_memory , SRAM_BASE_ADDRESS , & s -> sram ) ; armv7m = DEVICE ( & s -> armv7m ) ; qdev_prop_set_uint32 ( armv7m , "num-irq" , 61 ) ; qdev_prop_set_string ( armv7m , "cpu-type" , s -> cpu_type ) ; qdev_prop_set_bit ( armv7m , "enable-bitband" , true ) ; qdev_connect_clock_in ( armv7m , "cpuclk" , s -> sysclk ) ; qdev_connect_clock_in ( armv7m , "refclk" , s -> refclk ) ; object_property_set_link ( OBJECT ( & s -> armv7m ) , "memory" , OBJECT ( get_system_memory ( ) ) , & error_abort ) ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> armv7m ) , errp ) ) { return ; } for ( i = 0 ; i < STM_NUM_USARTS ; i ++ ) { dev = DEVICE ( & ( s -> usart [ i ] ) ) ; qdev_prop_set_chr ( dev , "chardev" , serial_hd ( i ) ) ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> usart [ i ] ) , errp ) ) { return ; } busdev = SYS_BUS_DEVICE ( dev ) ; sysbus_mmio_map ( busdev , 0 , usart_addr [ i ] ) ; sysbus_connect_irq ( busdev , 0 , qdev_get_gpio_in ( armv7m , usart_irq [ i ] ) ) ; } for ( i = 0 ; i < STM_NUM_SPIS ; i ++ ) { dev = DEVICE ( & ( s -> spi [ i ] ) ) ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> spi [ i ] ) , errp ) ) { return ; } busdev = SYS_BUS_DEVICE ( dev ) ; sysbus_mmio_map ( busdev , 0 , spi_addr [ i ] ) ; sysbus_connect_irq ( busdev , 0 , qdev_get_gpio_in ( armv7m , spi_irq [ i ] ) ) ; } create_unimplemented_device ( "timer[2]" , 0x40000000 , 0x400 ) ; create_unimplemented_device ( "timer[3]" , 0x40000400 , 0x400 ) ; create_unimplemented_device ( "timer[4]" , 0x40000800 , 0x400 ) ; create_unimplemented_device ( "timer[6]" , 0x40001000 , 0x400 ) ; create_unimplemented_device ( "timer[7]" , 0x40001400 , 0x400 ) ; create_unimplemented_device ( "RTC" , 0x40002800 , 0x400 ) ; create_unimplemented_device ( "WWDG" , 0x40002C00 , 0x400 ) ; create_unimplemented_device ( "IWDG" , 0x40003000 , 0x400 ) ; create_unimplemented_device ( "I2C1" , 0x40005400 , 0x400 ) ; create_unimplemented_device ( "I2C2" , 0x40005800 , 0x400 ) ; create_unimplemented_device ( "BKP" , 0x40006C00 , 0x400 ) ; create_unimplemented_device ( "PWR" , 0x40007000 , 0x400 ) ; create_unimplemented_device ( "DAC" , 0x40007400 , 0x400 ) ; create_unimplemented_device ( "CEC" , 0x40007800 , 0x400 ) ; create_unimplemented_device ( "AFIO" , 0x40010000 , 0x400 ) ; create_unimplemented_device ( "EXTI" , 0x40010400 , 0x400 ) ; create_unimplemented_device ( "GPIOA" , 0x40010800 , 0x400 ) ; create_unimplemented_device ( "GPIOB" , 0x40010C00 , 0x400 ) ; create_unimplemented_device ( "GPIOC" , 0x40011000 , 0x400 ) ; create_unimplemented_device ( "GPIOD" , 0x40011400 , 0x400 ) ; create_unimplemented_device ( "GPIOE" , 0x40011800 , 0x400 ) ; create_unimplemented_device ( "ADC1" , 0x40012400 , 0x400 ) ; create_unimplemented_device ( "timer[1]" , 0x40012C00 , 0x400 ) ; create_unimplemented_device ( "timer[15]" , 0x40014000 , 0x400 ) ; create_unimplemented_device ( "timer[16]" , 0x40014400 , 0x400 ) ; create_unimplemented_device ( "timer[17]" , 0x40014800 , 0x400 ) ; create_unimplemented_device ( "DMA" , 0x40020000 , 0x400 ) ; create_unimplemented_device ( "RCC" , 0x40021000 , 0x400 ) ; create_unimplemented_device ( "Flash Int" , 0x40022000 , 0x400 ) ; create_unimplemented_device ( "CRC" , 0x40023000 , 0x400 ) ; } 