static int ahci_reset_port_reject_pkts ( ahci_ctl_t * ahci_ctlp , ahci_port_t * ahci_portp , ahci_addr_t * addrp ) { uint32_t slot_status = 0 ; int reset_tags = 0 ; uint32_t finished_tags = 0 ; uint8_t port = addrp -> aa_port ; ASSERT ( MUTEX_HELD ( & ahci_portp -> ahciport_mutex ) ) ; AHCIDBG ( AHCIDBG_ENTRY , ahci_ctlp , "ahci_reset_port_reject_pkts at port: %d" , port ) ; if ( ahci_portp -> ahciport_flags & AHCI_PORT_FLAG_MOPPING ) { AHCIDBG ( AHCIDBG_ERRS , ahci_ctlp , "ahci_reset_port_reject_pkts: port %d is in " "mopping process, so return directly " , port ) ; return ( SATA_SUCCESS ) ; } ahci_portp -> ahciport_flags |= AHCI_PORT_FLAG_MOPPING ; ahci_portp -> ahciport_mop_in_progress ++ ; if ( NON_NCQ_CMD_IN_PROGRESS ( ahci_portp ) ) { slot_status = ddi_get32 ( ahci_ctlp -> ahcictl_ahci_acc_handle , ( uint32_t * ) AHCI_PORT_PxCI ( ahci_ctlp , port ) ) ; reset_tags = slot_status & AHCI_SLOT_MASK ( ahci_ctlp ) ; } if ( NCQ_CMD_IN_PROGRESS ( ahci_portp ) ) { slot_status = ddi_get32 ( ahci_ctlp -> ahcictl_ahci_acc_handle , ( uint32_t * ) AHCI_PORT_PxSACT ( ahci_ctlp , port ) ) ; reset_tags = slot_status & AHCI_NCQ_SLOT_MASK ( ahci_portp ) ; } if ( ahci_restart_port_wait_till_ready ( ahci_ctlp , ahci_portp , port , AHCI_PORT_RESET | AHCI_RESET_NO_EVENTS_UP , NULL ) != AHCI_SUCCESS ) { ahci_portp -> ahciport_mop_in_progress -- ; if ( ahci_portp -> ahciport_mop_in_progress == 0 ) { ahci_portp -> ahciport_flags &= ~ AHCI_PORT_FLAG_MOPPING ; } return ( SATA_FAILURE ) ; } if ( NON_NCQ_CMD_IN_PROGRESS ( ahci_portp ) ) { finished_tags = ahci_portp -> ahciport_pending_tags & ~ slot_status & AHCI_SLOT_MASK ( ahci_ctlp ) ; } if ( NCQ_CMD_IN_PROGRESS ( ahci_portp ) ) { finished_tags = ahci_portp -> ahciport_pending_ncq_tags & ~ slot_status & AHCI_NCQ_SLOT_MASK ( ahci_portp ) ; } reset_tags &= ~ finished_tags ; ahci_mop_commands ( ahci_ctlp , ahci_portp , slot_status , 0 , 0 , 0 , reset_tags ) ; return ( SATA_SUCCESS ) ; } 