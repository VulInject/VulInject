static void mtd_init ( struct ifnet * ifp ) { struct mtd_softc * sc = ifp -> if_softc ; int s ; s = splnet ( ) ; mtd_stop ( ifp ) ; mtd_reset ( sc ) ; CSR_WRITE_4 ( MTD_BCR , BCR_PBL8 ) ; CSR_WRITE_4 ( MTD_TCRRCR , TCR_TFTSF | RCR_RBLEN | RCR_RPBL512 ) ; if ( sc -> sc_devid == PCI_PRODUCT_MYSON_MTD891 ) { CSR_SETBIT ( MTD_BCR , BCR_PROG ) ; CSR_SETBIT ( MTD_TCRRCR , TCR_ENHANCED ) ; } if ( ifp -> if_flags & IFF_PROMISC ) { CSR_SETBIT ( MTD_TCRRCR , RCR_PROM ) ; } else { CSR_CLRBIT ( MTD_TCRRCR , RCR_PROM ) ; } if ( ifp -> if_flags & IFF_BROADCAST ) { CSR_SETBIT ( MTD_TCRRCR , RCR_AB ) ; } else { CSR_CLRBIT ( MTD_TCRRCR , RCR_AB ) ; } mtd_setmulti ( sc ) ; if ( mtd_list_rx_init ( sc ) ) { printf ( "%s: can't allocate memory for rx buffers\n" , sc -> sc_dev . dv_xname ) ; splx ( s , NULL ) ; return ; } mtd_list_tx_init ( sc ) ; CSR_WRITE_4 ( MTD_RXLBA , sc -> sc_listmap -> dm_segs [ 0 ] . ds_addr + offsetof ( mtd_list_data , mtd_rx_list [ 0 ] ) ) ; CSR_WRITE_4 ( MTD_TXLBA , sc -> sc_listmap -> dm_segs [ 0 ] . ds_addr + offsetof ( mtd_list_data , mtd_tx_list [ 0 ] ) ) ; CSR_WRITE_4 ( MTD_IMR , IMR_INTRS ) ; CSR_WRITE_4 ( MTD_ISR , 0xffffffff ) ; CSR_SETBIT ( MTD_TCRRCR , TCR_TE | RCR_RE ) ; CSR_WRITE_4 ( MTD_RXPDR , 0xffffffff ) ; ifp -> if_flags |= IFF_RUNNING ; ifq_clr_oactive ( & ifp -> if_snd ) ; splx ( s ) ; } 