static int denali_pci_probe ( struct pci_dev * dev , const struct pci_device_id * id ) { resource_size_t csr_base , mem_base ; unsigned long csr_len , mem_len ; struct denali_controller * denali ; struct denali_chip * dchip ; int nsels , ret , i ; denali = devm_kzalloc ( & dev -> dev , sizeof ( * denali ) , GFP_KERNEL ) ; ret = pcim_enable_device ( dev ) ; if ( ret ) { dev_err ( & dev -> dev , "Spectra: pci_enable_device failed.\n" ) ; return ret ; } if ( id -> driver_data == INTEL_CE4100 ) { mem_base = pci_resource_start ( dev , 0 ) ; mem_len = pci_resource_len ( dev , 1 ) ; csr_base = pci_resource_start ( dev , 1 ) ; csr_len = pci_resource_len ( dev , 1 ) ; } else { csr_base = pci_resource_start ( dev , 0 ) ; csr_len = pci_resource_len ( dev , 0 ) ; mem_base = pci_resource_start ( dev , 1 ) ; mem_len = pci_resource_len ( dev , 1 ) ; if ( ! mem_len ) { mem_base = csr_base + csr_len ; mem_len = csr_len ; } } pci_set_master ( dev ) ; denali -> dev = & dev -> dev ; denali -> irq = dev -> irq ; denali -> ecc_caps = & denali_pci_ecc_caps ; denali -> clk_rate = 50000000 ; denali -> clk_x_rate = 200000000 ; ret = pci_request_regions ( dev , DENALI_NAND_NAME ) ; if ( ret ) { dev_err ( & dev -> dev , "Spectra: Unable to request memory regions\n" ) ; return ret ; } denali -> reg = devm_ioremap ( denali -> dev , csr_base , csr_len ) ; if ( ! denali -> reg ) { dev_err ( & dev -> dev , "Spectra: Unable to remap memory region\n" ) ; return - ENOMEM ; } denali -> host = devm_ioremap ( denali -> dev , mem_base , mem_len ) ; if ( ! denali -> host ) { dev_err ( & dev -> dev , "Spectra: ioremap failed!" ) ; return - ENOMEM ; } ret = denali_init ( denali ) ; if ( ret ) { return ret ; } nsels = denali -> nbanks ; dchip = devm_kzalloc ( denali -> dev , struct_size ( dchip , sels , nsels ) , GFP_KERNEL ) ; if ( ! dchip ) { ret = - ENOMEM ; out_remove_denali } dchip -> chip . base . ecc . user_conf . flags |= NAND_ECC_MAXIMIZE_STRENGTH ; dchip -> nsels = nsels ; for ( i = 0 ; i < nsels ; i ++ ) { dchip -> sels [ i ] . bank = i ; } ret = denali_chip_init ( denali , dchip ) ; if ( ret ) { out_remove_denali } pci_set_drvdata ( dev , denali ) ; return 0 ; out_remove_denali denali_remove ( denali ) ; return ret ; } 