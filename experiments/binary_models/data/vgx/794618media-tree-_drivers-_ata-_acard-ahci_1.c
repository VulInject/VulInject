static void acard_ahci_qc_prep ( struct ata_queued_cmd * qc ) { struct ata_port * ap = qc -> ap ; struct ahci_port_priv * pp = ap -> private_data ; int is_atapi = ata_is_atapi ( qc -> tf . protocol ) ; void * cmd_tbl ; u32 opts ; const u32 cmd_fis_len = 5 ; unsigned int n_elem ; cmd_tbl = pp -> cmd_tbl + qc -> tag * AHCI_CMD_TBL_SZ ; ata_tf_to_fis ( & qc -> tf , qc -> dev -> link -> pmp , 1 , cmd_tbl ) ; if ( is_atapi ) { memcpy ( cmd_tbl + AHCI_CMD_TBL_CDB , qc -> cdb , qc -> dev -> cdb_len ) ; } n_elem = 0 ; if ( qc -> flags & ATA_QCFLAG_DMAMAP ) { n_elem = acard_ahci_fill_sg ( qc , cmd_tbl ) ; } opts = cmd_fis_len | ( qc -> dev -> link -> pmp << 12 ) ; if ( qc -> tf . flags & ATA_TFLAG_WRITE ) { opts |= AHCI_CMD_WRITE ; } if ( is_atapi ) { opts |= AHCI_CMD_ATAPI | AHCI_CMD_PREFETCH ; } ahci_fill_cmd_slot ( pp , qc -> tag , opts ) ; } 