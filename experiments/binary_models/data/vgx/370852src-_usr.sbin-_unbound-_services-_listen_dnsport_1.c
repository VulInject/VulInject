static int resolve_ifa_name ( struct ifaddrs * ifas , const char * search_ifa , char * * * ip_addresses , int * ip_addresses_size ) { struct ifaddrs * ifa ; void * tmpbuf ; int last_ip_addresses_size = * ip_addresses_size ; for ( ifa = ifas ; ifa != NULL ; ifa = ifa -> ifa_next ) { sa_family_t family ; const char * atsign ; char addr_buf [ INET6_ADDRSTRLEN + 1 + IF_NAMESIZE + 1 + 16 + 1 ] ; char addr_buf [ INET_ADDRSTRLEN + 1 + 16 + 1 ] ; if ( ( atsign = strrchr ( search_ifa , '@' ) ) != NULL ) { if ( strlen ( ifa -> ifa_name ) != ( size_t ) ( atsign - search_ifa ) || strncmp ( ifa -> ifa_name , search_ifa , atsign - search_ifa ) != 0 ) { continue ; } } else { if ( strcmp ( ifa -> ifa_name , search_ifa ) != 0 ) { continue ; } atsign = "" ; } if ( ifa -> ifa_addr == NULL ) { continue ; } family = ifa -> ifa_addr -> sa_family ; if ( family == AF_INET ) { char a4 [ INET_ADDRSTRLEN + 1 ] ; struct sockaddr_in * in4 = ( sockaddr_in * ) ifa -> ifa_addr ; if ( ! inet_ntop ( family , & in4 -> sin_addr , a4 , sizeof ( a4 ) ) ) { log_err ( "inet_ntop failed" ) ; return 0 ; } sprintf ( addr_buf , "%s%s" , a4 , atsign ) ; } if ( family == AF_INET6 ) { struct sockaddr_in6 * in6 = ( sockaddr_in6 * ) ifa -> ifa_addr ; char a6 [ INET6_ADDRSTRLEN + 1 ] ; char if_index_name [ IF_NAMESIZE + 1 ] ; if_index_name [ 0 ] = 0 ; if ( ! inet_ntop ( family , & in6 -> sin6_addr , a6 , sizeof ( a6 ) ) ) { log_err ( "inet_ntop failed" ) ; return 0 ; } ( void ) if_indextoname ( in6 -> sin6_scope_id , ( char * ) if_index_name ) ; if ( strlen ( if_index_name ) != 0 ) { snprintf ( addr_buf , sizeof ( addr_buf ) , "%s%%%s%s" , a6 , if_index_name , atsign ) ; } else { snprintf ( addr_buf , sizeof ( addr_buf ) , "%s%s" , a6 , atsign ) ; } } else { continue ; } verbose ( 4 , "interface %s has address %s" , search_ifa , addr_buf ) ; tmpbuf = realloc ( * ip_addresses , sizeof ( char * ) * ( * ip_addresses_size + 1 ) ) ; if ( ! tmpbuf ) { log_err ( "realloc failed: out of memory" ) ; return 0 ; } else { * ip_addresses = tmpbuf ; } ( * ip_addresses ) [ * ip_addresses_size ] = strdup ( addr_buf ) ; if ( ! ( * ip_addresses ) [ * ip_addresses_size ] ) { log_err ( "strdup failed: out of memory" ) ; return 0 ; } ( * ip_addresses_size ) ++ ; } if ( * ip_addresses_size == last_ip_addresses_size ) { tmpbuf = realloc ( * ip_addresses , sizeof ( char * ) * ( * ip_addresses_size + 1 ) ) ; if ( ! tmpbuf ) { log_err ( "realloc failed: out of memory" ) ; return 0 ; } else { * ip_addresses = tmpbuf ; } ( * ip_addresses ) [ * ip_addresses_size ] = strdup ( search_ifa ) ; if ( ! ( * ip_addresses ) [ * ip_addresses_size ] ) { log_err ( "strdup failed: out of memory" ) ; return 0 ; } ( * ip_addresses_size ) ++ ; } return 1 ; } 