void cvs_add_tobranch ( struct cvs_file * cf , char * tag ) { BUF * bp ; char attic [ PATH_MAX ] , repo [ PATH_MAX ] ; char * msg ; struct stat st ; RCSNUM * branch ; cvs_log ( LP_TRACE , "cvs_add_tobranch(%s)" , cf -> file_name ) ; if ( cvs_noexec == 1 ) { return ; } if ( fstat ( cf -> fd , & st ) == - 1 ) { fatal ( "cvs_add_tobranch: %s" , strerror ( errno ) ) ; } cvs_get_repository_path ( cf -> file_wd , repo , PATH_MAX ) ; ( void ) xsnprintf ( attic , PATH_MAX , "%s/%s" , repo , CVS_PATH_ATTIC ) ; if ( mkdir ( attic , 0755 ) == - 1 && errno != EEXIST ) { fatal ( "cvs_add_tobranch: failed to create Attic" ) ; } ( void ) xsnprintf ( attic , PATH_MAX , "%s/%s/%s%s" , repo , CVS_PATH_ATTIC , cf -> file_name , RCS_FILE_EXT ) ; cf -> file_rpath = xstrdup ( attic ) ; cf -> repo_fd = open ( cf -> file_rpath , O_CREAT | O_RDONLY ) ; if ( cf -> repo_fd == - 1 ) { fatal ( "cvs_add_tobranch: %s: %s" , cf -> file_rpath , strerror ( errno ) ) ; } cf -> file_rcs = rcs_open ( cf -> file_rpath , cf -> repo_fd , RCS_CREATE | RCS_WRITE , 0444 ) ; if ( cf -> file_rcs == NULL ) { fatal ( "cvs_add_tobranch: failed to create RCS file for %s" , cf -> file_path ) ; } if ( ( branch = rcsnum_parse ( "1.1.2" ) ) == NULL ) { fatal ( "cvs_add_tobranch: failed to parse branch" ) ; } if ( rcs_sym_add ( cf -> file_rcs , tag , branch ) == - 1 ) { fatal ( "cvs_add_tobranch: failed to add vendor tag" ) ; } ( void ) xasprintf ( & msg , "file %s was initially added on branch %s." , cf -> file_name , tag ) ; if ( rcs_rev_add ( cf -> file_rcs , RCS_HEAD_REV , msg , - 1 , NULL ) == - 1 ) { fatal ( "cvs_add_tobranch: failed to create first branch " "revision" ) ; } free ( msg ) ; if ( rcs_findrev ( cf -> file_rcs , cf -> file_rcs -> rf_head ) == NULL ) { fatal ( "cvs_add_tobranch: cannot find newly added revision" ) ; } bp = buf_alloc ( 1 ) ; if ( rcs_deltatext_set ( cf -> file_rcs , cf -> file_rcs -> rf_head , bp ) == - 1 ) { fatal ( "cvs_add_tobranch: failed to set deltatext" ) ; } rcs_comment_set ( cf -> file_rcs , " * " ) ; if ( rcs_state_set ( cf -> file_rcs , cf -> file_rcs -> rf_head , RCS_STATE_DEAD ) == - 1 ) { fatal ( "cvs_add_tobranch: failed to set state" ) ; } } 