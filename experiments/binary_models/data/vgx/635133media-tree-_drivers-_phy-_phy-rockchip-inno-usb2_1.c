static int rockchip_usb2phy_init ( struct phy * phy ) { struct rockchip_usb2phy_port * rport = phy_get_drvdata ( phy ) ; struct rockchip_usb2phy * rphy = dev_get_drvdata ( phy -> dev . parent ) ; int ret = 0 ; mutex_lock ( & rport -> mutex ) ; if ( rport -> port_id == USB2PHY_PORT_OTG ) { if ( rport -> mode != USB_DR_MODE_HOST ) { ret = property_enable ( rphy , & rport -> port_cfg -> bvalid_det_clr , true ) ; ret = property_enable ( rphy , & rport -> port_cfg -> bvalid_det_en , true ) ; if ( ret ) { out } schedule_delayed_work ( & rport -> otg_sm_work , OTG_SCHEDULE_DELAY ) ; } else { dev_dbg ( & rport -> phy -> dev , "mode %d\n" , rport -> mode ) ; } } if ( rport -> port_id == USB2PHY_PORT_HOST ) { ret = property_enable ( rphy , & rport -> port_cfg -> ls_det_clr , true ) ; if ( ret ) { out } ret = property_enable ( rphy , & rport -> port_cfg -> ls_det_en , true ) ; if ( ret ) { out } schedule_delayed_work ( & rport -> sm_work , SCHEDULE_DELAY ) ; } out mutex_unlock ( & rport -> mutex ) ; return ret ; } 