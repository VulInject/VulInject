int ipc_task_queue_send_task ( struct iosm_imem * imem , int * func ( struct iosm_imem * ipc_imem , int arg , void * msg , size_t size ) , int arg , void * msg , size_t size , bool wait ) { bool is_copy = false ; void * copy = msg ; int ret = - ENOMEM ; if ( size > 0 ) { copy = kmemdup ( msg , size , GFP_ATOMIC ) ; is_copy = true ; } ret = ipc_task_queue_add_task ( imem , arg , copy , func , size , is_copy , wait ) ; if ( ret < 0 ) { dev_err ( imem -> ipc_task -> dev , "add task failed for %ps %d, %p, %zu, %d" , func , arg , copy , size , is_copy ) ; if ( is_copy ) { kfree ( copy ) ; } out } ret = 0 ; out return ret ; } 