static int orinoco_ioctl_setpower ( struct net_device * dev , struct iw_request_info * info , union iwreq_data * wrqu , char * extra ) { struct iw_param * prq = & wrqu -> power ; struct orinoco_private * priv = ndev_priv ( dev ) ; int err = - EINPROGRESS ; cfs_time_t flags ; if ( orinoco_lock ( priv , & flags ) != 0 ) { return - EBUSY ; } if ( prq -> disabled ) { priv -> pm_on = 0 ; } else { switch ( prq -> flags & IW_POWER_MODE ) { case IW_POWER_UNICAST_R : priv -> pm_mcast = 0 ; priv -> pm_on = 1 ; break ; case IW_POWER_ALL_R : priv -> pm_mcast = 1 ; priv -> pm_on = 1 ; break ; case IW_POWER_ON : break ; default : err = - EINVAL ; out } if ( prq -> flags & IW_POWER_TIMEOUT ) { priv -> pm_on = 1 ; priv -> pm_timeout = prq -> value / 1000 ; } if ( prq -> flags & IW_POWER_PERIOD ) { priv -> pm_on = 1 ; priv -> pm_period = prq -> value / 1000 ; } if ( ! priv -> pm_on ) { err = - EINVAL ; out } } out orinoco_unlock ( priv , & flags ) ; return err ; } 