tor_socket_t tor_open_socket_with_extensions ( int domain , int type , int protocol , int cloexec , int nonblock ) { tor_socket_t s ; if ( get_n_open_sockets ( ) >= max_sockets - 1 ) { WSASetLastError ( WSAEMFILE ) ; errno = EMFILE ; return TOR_INVALID_SOCKET ; } int ext_flags = ( cloexec ?SOCK_CLOEXEC : 0 ) | ( nonblock ?SOCK_NONBLOCK : 0 ) ; s = socket ( domain , type | ext_flags , protocol ) ; if ( SOCKET_OK ( s ) ) { socket_ok } if ( errno != EINVAL ) { return s ; } s = socket ( domain , type , protocol ) ; if ( cloexec ) { if ( fcntl ( s , F_SETFD , FD_CLOEXEC ) == - 1 ) { log_warn ( LD_FS , "Couldn't set FD_CLOEXEC: %s" , strerror ( errno ) ) ; tor_close_socket_simple ( s ) ; return TOR_INVALID_SOCKET ; } } ( void ) cloexec ; if ( nonblock ) { if ( set_socket_nonblocking ( s ) == - 1 ) { tor_close_socket_simple ( s ) ; return TOR_INVALID_SOCKET ; } } socket_ok socket_ok tor_take_socket_ownership ( s ) ; return s ; } 