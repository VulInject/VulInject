static void do_run_with_base_page ( test_fn fn , bool swapout ) { char * mem ; int ret ; mem = mmap ( NULL , pagesize , PROT_READ | PROT_WRITE , MAP_PRIVATE | MAP_ANONYMOUS , - 1 , 0 ) ; if ( mem == MAP_FAILED ) { ksft_test_result_fail ( "mmap() failed\n" ) ; return ; } ret = madvise ( mem , pagesize , MADV_NOHUGEPAGE ) ; if ( ret && errno != EINVAL ) { ksft_test_result_fail ( "MADV_NOHUGEPAGE failed\n" ) ; munmap } if ( swapout ) { madvise ( mem , pagesize , MADV_PAGEOUT ) ; if ( ! pagemap_is_swapped ( pagemap_fd , mem ) ) { ksft_test_result_skip ( "MADV_PAGEOUT did not work, is swap enabled?\n" ) ; munmap } } fn ( mem , pagesize ) ; munmap munmap ( mem , pagesize ) ; } 