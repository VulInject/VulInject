int pk_setpin ( int argc , char * argv [ ] ) { int opt ; int rv ; extern int optind_av ; extern char * optarg_av ; char * token_spec = NULL ; char * dir = NULL ; char * prefix = NULL ; char * utype ; KMF_HANDLE_T handle ; KMF_KEYSTORE_TYPE kstype = KMF_KEYSTORE_PK11TOKEN ; boolean_t souser = 0 ; while ( ( opt = getopt_av ( argc , argv , "T:(token)k:(keystore)d:(dir)" "p:(prefix)u:(usertype)" ) ) != EOF ) { switch ( opt ) { case 'k' : kstype = KS2Int ( optarg_av ) ; if ( kstype == 0 ) { return ( PK_ERR_USAGE ) ; } break ; case 'T' : if ( token_spec ) { return ( PK_ERR_USAGE ) ; } token_spec = optarg_av ; break ; case 'd' : if ( dir ) { return ( PK_ERR_USAGE ) ; } dir = optarg_av ; break ; case 'p' : if ( prefix ) { return ( PK_ERR_USAGE ) ; } prefix = optarg_av ; break ; case 'u' : utype = optarg_av ; break ; default : return ( PK_ERR_USAGE ) ; } } argc -= optind_av ; argv += optind_av ; if ( argc != 0 ) { return ( PK_ERR_USAGE ) ; } if ( kstype == KMF_KEYSTORE_PK11TOKEN && EMPTYSTRING ( token_spec ) ) { token_spec = PK_DEFAULT_PK11TOKEN ; } if ( kstype == KMF_KEYSTORE_NSS && EMPTYSTRING ( token_spec ) ) { token_spec = DEFAULT_NSS_TOKEN ; } if ( ( rv = kmf_initialize ( & handle , NULL , NULL ) ) != KMF_OK ) { return ( rv ) ; } if ( utype != NULL ) { if ( strcmp ( utype , "so" ) == 0 ) { souser = 1 ; } if ( strcmp ( utype , "user" ) == 0 ) { souser = 0 ; } else { return ( PK_ERR_USAGE ) ; } } switch ( kstype ) { case KMF_KEYSTORE_PK11TOKEN : rv = setpin_pkcs11 ( handle , token_spec , souser ) ; break ; case KMF_KEYSTORE_NSS : rv = setpin_nss ( handle , token_spec , dir , prefix ) ; break ; default : cryptoerror ( LOG_STDERR , gettext ( "incorrect keystore." ) ) ; return ( PK_ERR_USAGE ) ; } ( void ) kmf_finalize ( handle ) ; if ( rv == KMF_ERR_AUTH_FAILED ) { cryptoerror ( LOG_STDERR , gettext ( "Incorrect passphrase." ) ) ; return ( PK_ERR_SYSTEM ) ; } if ( rv != CKR_OK ) { cryptoerror ( LOG_STDERR , gettext ( "Unable to change passphrase." ) ) ; return ( PK_ERR_SYSTEM ) ; } else { ( void ) fprintf ( stdout , gettext ( "Passphrase changed.\n" ) ) ; } return ( 0 ) ; } 