nwam_error_t nwam_update_object_in_files_backend ( char * filename , char * objname , uint64_t flags , void * proplist ) { nwam_error_t err ; void * objlist , * objnamelist ; char * * object_names ; nwam_value_t value = NULL ; uint_t i , num_objects ; assert ( filename != NULL ) ; if ( flags & NWAM_FLAG_CREATE ) { char discard_objname [ NWAM_MAX_NAME_LEN ] ; void * discard_objlist ; ( void ) strlcpy ( discard_objname , objname , sizeof ( discard_objname ) ) ; if ( ( err = nwam_read_object_from_files_backend ( filename , discard_objname , 0 , & discard_objlist ) ) == NWAM_SUCCESS ) { nwam_free_object_list ( discard_objlist ) ; return ( NWAM_ENTITY_EXISTS ) ; } } err = nwam_read_object_from_files_backend ( filename , NULL , flags , & objnamelist ) ; switch ( err ) { case NWAM_SUCCESS : if ( ( err = nwam_alloc_object_list ( & objlist ) ) != NWAM_SUCCESS ) { return ( err ) ; } if ( ( err = nwam_get_prop_value ( objnamelist , NWAM_OBJECT_NAMES_STRING , & value ) ) != NWAM_SUCCESS || ( err = nwam_value_get_string_array ( value , & object_names , & num_objects ) ) != NWAM_SUCCESS ) { nwam_value_free ( value ) ; nwam_free_object_list ( objnamelist ) ; nwam_free_object_list ( objlist ) ; return ( err ) ; } nwam_free_object_list ( objnamelist ) ; for ( i = 0 ; i < num_objects ; i ++ ) { void * oproplist = NULL ; if ( objname != NULL && strcmp ( objname , object_names [ i ] ) == 0 ) { continue ; } if ( ( err = nwam_read_object_from_files_backend ( filename , object_names [ i ] , flags , & oproplist ) ) != NWAM_SUCCESS || ( err = nwam_object_list_add_object_list ( objlist , object_names [ i ] , oproplist ) ) != NWAM_SUCCESS ) { nwam_free_object_list ( oproplist ) ; nwam_free_object_list ( objlist ) ; nwam_value_free ( value ) ; return ( err ) ; } nwam_free_object_list ( oproplist ) ; } nwam_value_free ( value ) ; break ; case NWAM_ENTITY_NOT_FOUND : return ( nwam_write_object_to_files_backend ( filename , objname , flags , proplist ) ) ; default : return ( err ) ; } if ( objname != NULL && proplist != NULL ) { if ( ( err = nwam_object_list_add_object_list ( objlist , ( char * ) objname , proplist ) ) != NWAM_SUCCESS ) { nwam_free_object_list ( objlist ) ; return ( err ) ; } } err = nwam_write_object_to_files_backend ( filename , NULL , flags , objlist ) ; nwam_free_object_list ( objlist ) ; return ( err ) ; } 