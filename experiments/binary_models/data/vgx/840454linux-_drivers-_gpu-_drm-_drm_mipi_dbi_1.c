static int mipi_dbi_poweron_reset_conditional ( struct mipi_dbi_dev * dbidev , bool cond ) { struct device * dev = dbidev -> drm . dev ; struct mipi_dbi * dbi = & dbidev -> dbi ; int ret ; if ( dbidev -> regulator ) { ret = regulator_enable ( dbidev -> regulator ) ; if ( ret ) { DRM_DEV_ERROR ( dev , "Failed to enable regulator (%d)\n" , ret ) ; return ret ; } } if ( dbidev -> io_regulator ) { ret = regulator_enable ( dbidev -> io_regulator ) ; if ( ret ) { DRM_DEV_ERROR ( dev , "Failed to enable I/O regulator (%d)\n" , ret ) ; if ( dbidev -> regulator ) { regulator_disable ( dbidev -> regulator ) ; } return ret ; } } if ( cond && mipi_dbi_display_is_on ( dbi ) ) { return 1 ; } mipi_dbi_hw_reset ( dbi , NULL ) ; ret = mipi_dbi_command ( dbi , MIPI_DCS_SOFT_RESET ) ; if ( ret ) { DRM_DEV_ERROR ( dev , "Failed to send reset command (%d)\n" , ret ) ; if ( dbidev -> regulator ) { regulator_disable ( dbidev -> regulator ) ; } if ( dbidev -> io_regulator ) { regulator_disable ( dbidev -> io_regulator ) ; } return ret ; } if ( dbi -> reset ) { usleep_range ( 5000 , 20000 ) ; } else { msleep ( 120 ) ; } return 0 ; } 