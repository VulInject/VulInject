static rpc_connection_t * rpc_connection_new ( int type , const char * ident ) { rpc_connection_t * connection ; if ( ident == NULL ) { return NULL ; } if ( ( connection = ( rpc_connection_t * ) calloc ( 1 , sizeof ( * connection ) ) ) == NULL ) { return NULL ; } connection -> type = type ; connection -> refcnt = 1 ; connection -> status = RPC_STATUS_CLOSED ; connection -> socket = - 1 ; connection -> server_socket = - 1 ; connection -> server_thread_active = 0 ; connection -> error_callback = NULL ; connection -> error_callback_data = NULL ; connection -> dispatch_depth = 0 ; connection -> invoke_depth = 0 ; connection -> handle_depth = 0 ; connection -> is_sync = false ; connection -> pending_sync_depth = 0 ; if ( ( connection -> types = rpc_map_new_full ( ( free ) ) ) == NULL ) { rpc_exit ( connection ) ; return NULL ; } if ( ( connection -> methods = rpc_map_new ( ) ) == NULL ) { rpc_exit ( connection ) ; return NULL ; } int fd = socket ( AF_UNIX , SOCK_STREAM | SOCK_CLOEXEC , 0 ) ; if ( fd < 0 ) { perror ( "socket" ) ; rpc_exit ( connection ) ; return NULL ; } if ( type == RPC_CONNECTION_SERVER ) { connection -> server_socket = fd ; } else { connection -> socket = fd ; if ( rpc_set_non_blocking_io ( fd ) < 0 ) { perror ( "socket set non-blocking" ) ; rpc_exit ( connection ) ; return NULL ; } } connection -> socket_addr . sun_family = AF_UNIX ; connection -> socket_path = NULL ; connection -> socket_addr_len = _rpc_socket_path ( & connection -> socket_path , ident ) ; memcpy ( & connection -> socket_addr . sun_path [ 0 ] , connection -> socket_path , connection -> socket_addr_len ) ; connection -> socket_addr_len += offsetof ( sockaddr_un , sun_path ) ; connection -> socket_addr . sun_len = connection -> socket_addr_len ; return connection ; } 