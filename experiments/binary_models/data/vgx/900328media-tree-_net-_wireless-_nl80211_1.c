static int __nl80211_set_channel ( struct cfg80211_registered_device * rdev , struct net_device * dev , struct genl_info * info ) { struct cfg80211_chan_def chandef ; int result ; enum nl80211_iftype iftype = NL80211_IFTYPE_MONITOR ; struct wireless_dev * wdev = NULL ; if ( dev ) { wdev = dev -> ieee80211_ptr ; } if ( wdev ) { iftype = wdev -> iftype ; } result = nl80211_parse_chandef ( rdev , info , & chandef ) ; if ( result ) { return result ; } switch ( iftype ) { case NL80211_IFTYPE_AP : case NL80211_IFTYPE_P2P_GO : if ( ! cfg80211_reg_can_beacon_relax ( & rdev -> wiphy , & chandef , iftype ) ) { result = - EINVAL ; break ; } if ( wdev -> beacon_interval ) { if ( ! dev || ! rdev -> ops -> set_ap_chanwidth || ! ( rdev -> wiphy . features & NL80211_FEATURE_AP_MODE_CHAN_WIDTH_CHANGE ) ) { result = - EBUSY ; break ; } if ( chandef . chan != wdev -> preset_chandef . chan ) { result = - EBUSY ; break ; } result = rdev_set_ap_chanwidth ( rdev , dev , & chandef ) ; if ( result ) { break ; } } wdev -> preset_chandef = chandef ; result = 0 ; break ; case NL80211_IFTYPE_MESH_POINT : result = cfg80211_set_mesh_channel ( rdev , wdev , & chandef ) ; break ; case NL80211_IFTYPE_MONITOR : result = cfg80211_set_monitor_channel ( rdev , & chandef ) ; break ; default : result = - EINVAL ; } return result ; } 