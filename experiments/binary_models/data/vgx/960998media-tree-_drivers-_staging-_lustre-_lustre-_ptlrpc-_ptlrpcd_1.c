void ptlrpcd_free ( struct ptlrpcd_ctl * pc ) { struct ptlrpc_request_set * set = pc -> pc_set ; if ( ! test_bit ( LIOD_START , & pc -> pc_flags ) ) { CWARN ( "Thread for pc %p was not started\n" , pc ) ; out } wait_for_completion ( & pc -> pc_finishing ) ; spin_lock ( & pc -> pc_lock ) ; pc -> pc_set = NULL ; spin_unlock ( & pc -> pc_lock ) ; ptlrpc_set_destroy ( set ) ; clear_bit ( LIOD_START , & pc -> pc_flags ) ; clear_bit ( LIOD_STOP , & pc -> pc_flags ) ; clear_bit ( LIOD_FORCE , & pc -> pc_flags ) ; out if ( pc -> pc_npartners > 0 ) { LASSERT ( pc -> pc_partners ) ; pc -> pc_partners = NULL ; } pc -> pc_npartners = 0 ; pc -> pc_error = 0 ; } 