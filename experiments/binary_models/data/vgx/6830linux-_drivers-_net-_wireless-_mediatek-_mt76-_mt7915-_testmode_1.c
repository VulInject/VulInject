static int mt7915_tm_dump_stats ( struct mt76_phy * mphy , struct sk_buff * msg ) { struct mt7915_phy * phy = mphy -> priv ; struct mt7915_dev * dev = phy -> dev ; enum mt76_rxq_id q ; void * rx , * rssi ; u16 fcs_err ; int i ; u32 cnt ; rx = nla_nest_start ( msg , MT76_TM_STATS_ATTR_LAST_RX ) ; if ( nla_put_s32 ( msg , MT76_TM_RX_ATTR_FREQ_OFFSET , phy -> test . last_freq_offset ) ) { return - ENOMEM ; } rssi = nla_nest_start ( msg , MT76_TM_RX_ATTR_RCPI ) ; if ( ! rssi ) { return - ENOMEM ; } for ( i = 0 ; i < ARRAY_SIZE ( phy -> test . last_rcpi ) ; i ++ ) { if ( nla_put_u8 ( msg , i , phy -> test . last_rcpi [ i ] ) ) { return - ENOMEM ; } } nla_nest_end ( msg , rssi ) ; rssi = nla_nest_start ( msg , MT76_TM_RX_ATTR_IB_RSSI ) ; if ( ! rssi ) { return - ENOMEM ; } for ( i = 0 ; i < ARRAY_SIZE ( phy -> test . last_ib_rssi ) ; i ++ ) { if ( nla_put_s8 ( msg , i , phy -> test . last_ib_rssi [ i ] ) ) { return - ENOMEM ; } } nla_nest_end ( msg , rssi ) ; rssi = nla_nest_start ( msg , MT76_TM_RX_ATTR_WB_RSSI ) ; if ( ! rssi ) { return - ENOMEM ; } for ( i = 0 ; i < ARRAY_SIZE ( phy -> test . last_wb_rssi ) ; i ++ ) { if ( nla_put_s8 ( msg , i , phy -> test . last_wb_rssi [ i ] ) ) { return - ENOMEM ; } } nla_nest_end ( msg , rssi ) ; if ( nla_put_u8 ( msg , MT76_TM_RX_ATTR_SNR , phy -> test . last_snr ) ) { return - ENOMEM ; } nla_nest_end ( msg , rx ) ; cnt = mt76_rr ( dev , MT_MIB_SDR3 ( phy -> mt76 -> band_idx ) ) ; fcs_err = is_mt7915 ( & dev -> mt76 ) ?FIELD_GET ( MT_MIB_SDR3_FCS_ERR_MASK , cnt ) : FIELD_GET ( MT_MIB_SDR3_FCS_ERR_MASK_MT7916 , cnt ) ; q = phy -> mt76 -> band_idx ?MT_RXQ_BAND1 : MT_RXQ_MAIN ; mphy -> test . rx_stats . packets [ q ] += fcs_err ; mphy -> test . rx_stats . fcs_error [ q ] += fcs_err ; return 0 ; } 