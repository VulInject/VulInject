static int do_command ( struct gspca_dev * gspca_dev , u16 command , u8 a , u8 b , u8 c , u8 d ) { struct sd * sd = ( sd * ) gspca_dev ; int ret , datasize ; u8 cmd [ 8 ] ; switch ( command ) { case CPIA_COMMAND_GetCPIAVersion : case CPIA_COMMAND_GetPnPID : case CPIA_COMMAND_GetCameraStatus : case CPIA_COMMAND_GetVPVersion : case CPIA_COMMAND_GetColourParams : case CPIA_COMMAND_GetColourBalance : case CPIA_COMMAND_GetExposure : datasize = 8 ; break ; case CPIA_COMMAND_ReadMCPorts : case CPIA_COMMAND_ReadVCRegs : datasize = 4 ; break ; default : datasize = 0 ; break ; } cmd [ 0 ] = command >> 8 ; cmd [ 1 ] = command & 0xff ; cmd [ 2 ] = a ; cmd [ 3 ] = b ; cmd [ 4 ] = c ; cmd [ 5 ] = d ; cmd [ 6 ] = datasize ; ret = cpia_usb_transferCmd ( gspca_dev , cmd ) ; if ( ret ) { return ret ; } switch ( command ) { case CPIA_COMMAND_GetCPIAVersion : sd -> params . version . firmwareVersion = gspca_dev -> usb_buf [ 0 ] ; sd -> params . version . firmwareRevision = gspca_dev -> usb_buf [ 1 ] ; sd -> params . version . vcVersion = gspca_dev -> usb_buf [ 2 ] ; sd -> params . version . vcRevision = gspca_dev -> usb_buf [ 3 ] ; break ; case CPIA_COMMAND_GetPnPID : sd -> params . pnpID . vendor = gspca_dev -> usb_buf [ 0 ] | ( gspca_dev -> usb_buf [ 1 ] << 8 ) ; sd -> params . pnpID . product = gspca_dev -> usb_buf [ 2 ] | ( gspca_dev -> usb_buf [ 3 ] << 8 ) ; sd -> params . pnpID . deviceRevision = gspca_dev -> usb_buf [ 4 ] | ( gspca_dev -> usb_buf [ 5 ] << 8 ) ; break ; case CPIA_COMMAND_GetCameraStatus : sd -> params . status . systemState = gspca_dev -> usb_buf [ 0 ] ; sd -> params . status . grabState = gspca_dev -> usb_buf [ 1 ] ; sd -> params . status . streamState = gspca_dev -> usb_buf [ 2 ] ; sd -> params . status . fatalError = gspca_dev -> usb_buf [ 3 ] ; sd -> params . status . cmdError = gspca_dev -> usb_buf [ 4 ] ; sd -> params . status . debugFlags = gspca_dev -> usb_buf [ 5 ] ; sd -> params . status . vpStatus = gspca_dev -> usb_buf [ 6 ] ; sd -> params . status . errorCode = gspca_dev -> usb_buf [ 7 ] ; break ; case CPIA_COMMAND_GetVPVersion : sd -> params . vpVersion . vpVersion = gspca_dev -> usb_buf [ 0 ] ; sd -> params . vpVersion . vpRevision = gspca_dev -> usb_buf [ 1 ] ; sd -> params . vpVersion . cameraHeadID = gspca_dev -> usb_buf [ 2 ] | ( gspca_dev -> usb_buf [ 3 ] << 8 ) ; break ; case CPIA_COMMAND_GetColourParams : sd -> params . colourParams . brightness = gspca_dev -> usb_buf [ 0 ] ; sd -> params . colourParams . contrast = gspca_dev -> usb_buf [ 1 ] ; sd -> params . colourParams . saturation = gspca_dev -> usb_buf [ 2 ] ; break ; case CPIA_COMMAND_GetColourBalance : sd -> params . colourBalance . redGain = gspca_dev -> usb_buf [ 0 ] ; sd -> params . colourBalance . greenGain = gspca_dev -> usb_buf [ 1 ] ; sd -> params . colourBalance . blueGain = gspca_dev -> usb_buf [ 2 ] ; break ; case CPIA_COMMAND_GetExposure : sd -> params . exposure . gain = gspca_dev -> usb_buf [ 0 ] ; sd -> params . exposure . fineExp = gspca_dev -> usb_buf [ 1 ] ; sd -> params . exposure . coarseExpLo = gspca_dev -> usb_buf [ 2 ] ; sd -> params . exposure . coarseExpHi = gspca_dev -> usb_buf [ 3 ] ; sd -> params . exposure . redComp = gspca_dev -> usb_buf [ 4 ] ; sd -> params . exposure . green1Comp = gspca_dev -> usb_buf [ 5 ] ; sd -> params . exposure . green2Comp = gspca_dev -> usb_buf [ 6 ] ; sd -> params . exposure . blueComp = gspca_dev -> usb_buf [ 7 ] ; break ; case CPIA_COMMAND_ReadMCPorts : a = ( ( gspca_dev -> usb_buf [ 1 ] & 0x02 ) == 0 ) ; if ( a != sd -> params . qx3 . button ) { input_report_key ( gspca_dev -> input_dev , KEY_CAMERA , a ) ; input_sync ( gspca_dev -> input_dev ) ; sd -> params . qx3 . button = a ; } if ( sd -> params . qx3 . button ) { do_command ( gspca_dev , CPIA_COMMAND_WriteMCPort , 3 , 0xdf , 0xdf , 0 ) ; do_command ( gspca_dev , CPIA_COMMAND_WriteMCPort , 3 , 0xff , 0xff , 0 ) ; } sd -> params . qx3 . cradled = ( ( gspca_dev -> usb_buf [ 2 ] & 0x40 ) == 0 ) ; break ; } return 0 ; } 