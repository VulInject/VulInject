static void brcmf_chip_socram_ramsize ( struct brcmf_core_priv * sr , u32 * ramsize , u32 * srsize ) { u32 coreinfo ; uint nb , banksize , lss ; int retent ; int i ; * ramsize = 0 ; * srsize = 0 ; if ( WARN_ON ( sr -> pub . rev < 4 ) ) { return ; } if ( ! brcmf_chip_iscoreup ( & sr -> pub ) ) { brcmf_chip_resetcore ( & sr -> pub , 0 , 0 , 0 ) ; } coreinfo = brcmf_chip_core_read32 ( sr , SOCRAMREGOFFS ( coreinfo ) ) ; nb = ( coreinfo & SRCI_SRNB_MASK ) >> SRCI_SRNB_SHIFT ; if ( ( sr -> pub . rev <= 7 ) || ( sr -> pub . rev == 12 ) ) { banksize = ( coreinfo & SRCI_SRBSZ_MASK ) ; lss = ( coreinfo & SRCI_LSS_MASK ) >> SRCI_LSS_SHIFT ; if ( lss != 0 ) { nb -- ; } * ramsize = nb * ( 1 << ( banksize + SR_BSZ_BASE ) ) ; if ( lss != 0 ) { * ramsize += ( 1 << ( ( lss - 1 ) + SR_BSZ_BASE ) ) ; } } else { if ( sr -> pub . rev >= 23 ) { nb = ( coreinfo & ( SRCI_SRNB_MASK | SRCI_SRNB_MASK_EXT ) ) >> SRCI_SRNB_SHIFT ; } else { nb = ( coreinfo & SRCI_SRNB_MASK ) >> SRCI_SRNB_SHIFT ; } for ( i = 0 ; i < nb ; i ++ ) { retent = brcmf_chip_socram_banksize ( sr , i , & banksize ) ; * ramsize += banksize ; if ( retent ) { * srsize += banksize ; } } } switch ( sr -> chip -> pub . chip ) { case BRCM_CC_4334_CHIP_ID : if ( sr -> chip -> pub . chiprev < 2 ) { * srsize = ( 32 * 1024 ) ; } break ; case BRCM_CC_43430_CHIP_ID : case CY_CC_43439_CHIP_ID : * srsize = ( 64 * 1024 ) ; break ; default : break ; } } 