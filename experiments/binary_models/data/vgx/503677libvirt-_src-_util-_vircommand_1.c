pid_t virFork ( void ) { sigset_t oldmask , newmask ; struct sigaction sig_action ; int saved_errno ; pid_t pid ; sigfillset ( & newmask ) ; if ( pthread_sigmask ( SIG_SETMASK , & newmask , & oldmask ) != 0 ) { virReportSystemError ( errno , "%s" , _ ( "cannot block signals" ) ) ; return - 1 ; } virLogLock ( ) ; pid = fork ( ) ; saved_errno = errno ; virLogUnlock ( ) ; if ( pid < 0 ) { ignore_value ( pthread_sigmask ( SIG_SETMASK , & oldmask , NULL ) ) ; virReportSystemError ( saved_errno , "%s" , _ ( "cannot fork child process" ) ) ; errno = saved_errno ; } if ( pid ) { ignore_value ( pthread_sigmask ( SIG_SETMASK , & oldmask , NULL ) ) ; } else { int logprio ; int i ; virSetErrorFunc ( NULL , NULL ) ; virSetErrorLogPriorityFunc ( NULL ) ; logprio = virLogGetDefaultPriority ( ) ; virLogReset ( ) ; virLogSetDefaultPriority ( logprio ) ; sig_action . sa_handler = SIG_DFL ; sig_action . sa_flags = 0 ; sigemptyset ( & sig_action . sa_mask ) ; for ( i = 1 ; i < NSIG ; i ++ ) { ignore_value ( sigaction ( i , & sig_action , NULL ) ) ; } sig_action . sa_handler = virDummyHandler ; ignore_value ( sigaction ( SIGPIPE , & sig_action , NULL ) ) ; sigemptyset ( & newmask ) ; if ( pthread_sigmask ( SIG_SETMASK , & newmask , NULL ) != 0 ) { virReportSystemError ( errno , "%s" , _ ( "cannot unblock signals" ) ) ; virDispatchError ( NULL ) ; _exit ( EXIT_CANCELED ) ; } } return pid ; } 