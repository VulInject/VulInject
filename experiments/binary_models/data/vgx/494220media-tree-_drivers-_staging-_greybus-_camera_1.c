static int gb_camera_setup_data_connection ( struct gb_camera * gcam , struct gb_camera_configure_streams_response * resp , struct gb_camera_csi_params * csi_params ) { struct ap_csi_config_request csi_cfg ; struct gb_connection * conn ; unsigned int clk_freq ; int ret ; conn = gb_connection_create_offloaded ( gcam -> bundle , gcam -> data_cport_id , GB_CONNECTION_FLAG_NO_FLOWCTRL | GB_CONNECTION_FLAG_CDSI1 ) ; if ( IS_ERR ( conn ) ) { return PTR_ERR ( conn ) ; } gcam -> data_connection = conn ; gb_connection_set_data ( conn , gcam ) ; ret = gb_connection_enable ( conn ) ; if ( ret ) { error_conn_destroy } ret = gb_camera_set_power_mode ( gcam , true ) ; if ( ret < 0 ) { error_conn_disable } csi_cfg . csi_id = 1 ; csi_cfg . flags = 0 ; csi_cfg . num_lanes = GB_CAMERA_CSI_NUM_DATA_LANES ; clk_freq = resp -> data_rate / 2 / GB_CAMERA_CSI_NUM_DATA_LANES ; clk_freq = clamp ( clk_freq + GB_CAMERA_CSI_CLK_FREQ_MARGIN , GB_CAMERA_CSI_CLK_FREQ_MIN , GB_CAMERA_CSI_CLK_FREQ_MAX ) ; csi_cfg . csi_clk_freq = clk_freq ; ret = gb_camera_get_max_pkt_size ( gcam , resp ) ; if ( ret < 0 ) { ret = - EIO ; error_power } csi_cfg . max_pkt_size = ret ; ret = gb_hd_output ( gcam -> connection -> hd , & csi_cfg , sizeof ( csi_cfg ) , GB_APB_REQUEST_CSI_TX_CONTROL , false ) ; if ( ret < 0 ) { gcam_err ( gcam , "failed to start the CSI transmitter\n" ) ; error_power } if ( csi_params ) { csi_params -> clk_freq = csi_cfg . csi_clk_freq ; csi_params -> num_lanes = csi_cfg . num_lanes ; } return 0 ; error_power gb_camera_set_power_mode ( gcam , false ) ; error_conn_disable gb_connection_disable ( gcam -> data_connection ) ; error_conn_destroy gb_connection_destroy ( gcam -> data_connection ) ; gcam -> data_connection = NULL ; return ret ; } 