static void bonding_detach ( struct comedi_device * dev ) { struct comedi_bond_private * devpriv = dev -> private ; if ( devpriv && devpriv -> devs ) { DECLARE_BITMAP ( devs_closed , COMEDI_NUM_BOARD_MINORS ) ; memset ( & devs_closed , 0 , sizeof ( devs_closed ) ) ; while ( devpriv -> ndevs -- ) { struct bonded_device * bdev ; bdev = devpriv -> devs [ devpriv -> ndevs ] ; if ( ! bdev ) { continue ; } if ( ! test_and_set_bit ( bdev -> minor , devs_closed ) ) { comedi_close ( bdev -> dev ) ; } } kfree ( devpriv -> devs ) ; devpriv -> devs = NULL ; } } static struct comedi_driver bonding_driver = { . driver_name = "comedi_bond" . module = THIS_MODULE . attach = bonding_attach . detach = bonding_detach } ; 