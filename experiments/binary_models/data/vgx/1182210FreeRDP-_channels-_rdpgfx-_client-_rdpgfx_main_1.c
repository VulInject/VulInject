static UINT rdpgfx_recv_reset_graphics_pdu ( GENERIC_CHANNEL_CALLBACK * callback , wStream * s ) { int pad ; UINT32 index ; MONITOR_DEF * monitor ; RDPGFX_RESET_GRAPHICS_PDU pdu = { 0 } ; WINPR_ASSERT ( callback ) ; RDPGFX_PLUGIN * gfx = ( RDPGFX_PLUGIN * ) callback -> plugin ; WINPR_ASSERT ( gfx ) ; RdpgfxClientContext * context = gfx -> context ; UINT error = CHANNEL_RC_OK ; GraphicsResetEventArgs graphicsReset = { 0 } ; if ( ! Stream_CheckAndLogRequiredLength ( TAG , s , 12 ) ) { return ERROR_INVALID_DATA ; } Stream_Read_UINT32 ( s , pdu . width ) ; Stream_Read_UINT32 ( s , pdu . height ) ; Stream_Read_UINT32 ( s , pdu . monitorCount ) ; if ( ! Stream_CheckAndLogRequiredLengthOfSize ( TAG , s , pdu . monitorCount , 20ull ) ) { return ERROR_INVALID_DATA ; } pdu . monitorDefArray = ( MONITOR_DEF * ) calloc ( pdu . monitorCount , sizeof ( MONITOR_DEF ) ) ; if ( ! pdu . monitorDefArray ) { WLog_Print ( gfx -> log , WLOG_ERROR , "calloc failed!" ) ; return CHANNEL_RC_NO_MEMORY ; } for ( index = 0 ; index < pdu . monitorCount ; index ++ ) { monitor = & ( pdu . monitorDefArray [ index ] ) ; Stream_Read_INT32 ( s , monitor -> left ) ; Stream_Read_INT32 ( s , monitor -> top ) ; Stream_Read_INT32 ( s , monitor -> right ) ; Stream_Read_INT32 ( s , monitor -> bottom ) ; Stream_Read_UINT32 ( s , monitor -> flags ) ; } pad = 340 - ( RDPGFX_HEADER_SIZE + 12 + ( pdu . monitorCount * 20 ) ) ; if ( ! Stream_CheckAndLogRequiredLength ( TAG , s , ( size_t ) pad ) ) { return CHANNEL_RC_NO_MEMORY ; } Stream_Seek ( s , pad ) ; DEBUG_RDPGFX ( gfx -> log , "RecvResetGraphicsPdu: width: %" PRIu32 " height: %" PRIu32 " count: %" PRIu32 "" , pdu . width , pdu . height , pdu . monitorCount ) ; for ( index = 0 ; index < pdu . monitorCount ; index ++ ) { monitor = & ( pdu . monitorDefArray [ index ] ) ; DEBUG_RDPGFX ( gfx -> log , "RecvResetGraphicsPdu: monitor left:%" PRIi32 " top:%" PRIi32 " right:%" PRIi32 " bottom:%" PRIi32 " flags:0x%" PRIx32 "" , monitor -> left , monitor -> top , monitor -> right , monitor -> bottom , monitor -> flags ) ; } if ( context ) { IFCALLRET ( context -> ResetGraphics , error , context , & pdu ) ; if ( error ) { WLog_Print ( gfx -> log , WLOG_ERROR , "context->ResetGraphics failed with error %" PRIu32 "" , error ) ; } } EventArgsInit ( & graphicsReset , "libfreerdp" ) ; graphicsReset . width = pdu . width ; graphicsReset . height = pdu . height ; PubSub_OnGraphicsReset ( gfx -> rdpcontext -> pubSub , gfx -> rdpcontext , & graphicsReset ) ; free ( pdu . monitorDefArray ) ; return error ; } 