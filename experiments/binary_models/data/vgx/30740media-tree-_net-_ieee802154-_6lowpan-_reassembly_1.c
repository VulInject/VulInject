static int lowpan_frag_queue ( struct lowpan_frag_queue * fq , struct sk_buff * skb , u8 frag_type ) { struct sk_buff * prev , * next ; struct net_device * ldev ; int end , offset ; if ( fq -> q . flags & INET_FRAG_COMPLETE ) { err } offset = lowpan_802154_cb ( skb ) -> d_offset << 3 ; end = lowpan_802154_cb ( skb ) -> d_size ; if ( offset + skb -> len == end ) { if ( end < fq -> q . len || ( ( fq -> q . flags & INET_FRAG_LAST_IN ) && end != fq -> q . len ) ) { err } fq -> q . flags |= INET_FRAG_LAST_IN ; fq -> q . len = end ; } else { if ( end > fq -> q . len ) { if ( fq -> q . flags & INET_FRAG_LAST_IN ) { err } fq -> q . len = end ; } } prev = fq -> q . fragments_tail ; if ( ! prev || lowpan_802154_cb ( prev ) -> d_offset < lowpan_802154_cb ( skb ) -> d_offset ) { next = NULL ; found } prev = NULL ; for ( next = fq -> q . fragments ; next != NULL ; next = next -> next ) { if ( lowpan_802154_cb ( next ) -> d_offset >= lowpan_802154_cb ( skb ) -> d_offset ) { break ; } prev = next ; } found skb -> next = next ; if ( ! next ) { fq -> q . fragments_tail = skb ; } if ( prev ) { prev -> next = skb ; } else { fq -> q . fragments = skb ; } ldev = skb -> dev ; if ( ldev ) { skb -> dev = NULL ; } fq -> q . stamp = skb -> tstamp ; if ( frag_type == LOWPAN_DISPATCH_FRAG1 ) { fq -> q . flags |= INET_FRAG_FIRST_IN ; } fq -> q . meat += skb -> len ; add_frag_mem_limit ( fq -> q . net , skb -> truesize ) ; if ( fq -> q . flags == ( INET_FRAG_FIRST_IN | INET_FRAG_LAST_IN ) && fq -> q . meat == fq -> q . len ) { int res ; unsigned long orefdst = skb -> _skb_refdst ; skb -> _skb_refdst = 0UL ; res = lowpan_frag_reasm ( fq , prev , ldev ) ; skb -> _skb_refdst = orefdst ; return res ; } return - 1 ; err return - 1 ; } 