void gpiochip_sysfs_unregister ( struct gpio_device * gdev ) { struct gpio_desc * desc ; struct gpio_chip * chip = gdev -> chip ; int i ; if ( ! gdev -> mockdev ) { return ; } device_unregister ( gdev -> mockdev ) ; mutex_lock ( & sysfs_lock ) ; gdev -> mockdev = NULL ; mutex_unlock ( & sysfs_lock ) ; for ( i = 0 ; i < chip -> ngpio ; i ++ ) { desc = & gdev -> descs [ i ] ; if ( test_and_clear_bit ( FLAG_SYSFS , & desc -> flags ) ) { gpiod_free ( desc ) ; } } } 