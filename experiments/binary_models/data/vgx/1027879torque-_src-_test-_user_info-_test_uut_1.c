START_TEST ( ) { job pjob ; users . lock ( ) ; users . clear ( ) ; user_info * ui = ( user_info * ) calloc ( 1 , sizeof ( user_info ) ) ; ui -> user_name = strdup ( "tom" ) ; ui -> num_jobs_queued = 1 ; users . insert ( ui , ui -> user_name ) ; ui = ( user_info * ) calloc ( 1 , sizeof ( user_info ) ) ; ui -> user_name = strdup ( "bob" ) ; ui -> num_jobs_queued = 0 ; users . insert ( ui , ui -> user_name ) ; users . unlock ( ) ; fail_unless ( increment_queued_jobs ( & users , ( char * ) "tom" , & pjob ) == 0 , "can't increment queued jobs" ) ; pjob . ji_queue_counted = 0 ; fail_unless ( increment_queued_jobs ( & users , ( char * ) "bob" , & pjob ) == 0 , "can't increment queued jobs" ) ; pjob . ji_queue_counted = 0 ; fail_unless ( get_num_queued ( & users , "tom" ) == 2 , "didn't actually increment tom 1" ) ; fail_unless ( increment_queued_jobs ( & users , strdup ( "tom@napali" ) , & pjob ) == 0 ) ; fail_unless ( get_num_queued ( & users , "tom" ) == 3 , "didn't actually increment tom 2" ) ; fail_unless ( increment_queued_jobs ( & users , strdup ( "tom@napali" ) , & pjob ) == 0 ) ; fail_unless ( get_num_queued ( & users , "tom" ) == 3 , "Shouldn't have incremented with the bit set" ) ; } END_TEST START_TEST ( decrement_queued_jobs_test ) { users . lock ( ) ; users . clear ( ) ; user_info * ui = ( user_info * ) calloc ( 1 , sizeof ( user_info ) ) ; ui -> user_name = strdup ( "tom" ) ; ui -> num_jobs_queued = 1 ; job pjob ; memset ( & pjob , 0 , sizeof ( pjob ) ) ; users . insert ( ui , ui -> user_name ) ; users . unlock ( ) ; pjob . ji_queue_counted = COUNTED_GLOBALLY ; fail_unless ( decrement_queued_jobs ( & users , ( char * ) "bob" , & pjob ) == THING_NOT_FOUND , "decremented for non-existent user" ) ; pjob . ji_queue_counted = COUNTED_GLOBALLY ; fail_unless ( decrement_queued_jobs ( & users , ( char * ) "tom@neverland.com" , & pjob ) == 0 , "couldn't decrement for tom?" ) ; fail_unless ( get_num_queued ( & users , "tom" ) == 0 , "didn't actually decrement tom" ) ; pjob . ji_queue_counted = COUNTED_GLOBALLY ; fail_unless ( decrement_queued_jobs ( & users , ( char * ) "tom" , & pjob ) == 0 , "couldn't decrement for tom?" ) ; fail_unless ( get_num_queued ( & users , "tom" ) == 0 , "Disallow going negative in the count" ) ; fail_unless ( increment_queued_jobs ( & users , strdup ( "tom@napali" ) , & pjob ) == 0 ) ; fail_unless ( get_num_queued ( & users , "tom" ) == 1 ) ; fail_unless ( decrement_queued_jobs ( & users , ( char * ) "tom" , & pjob ) == 0 ) ; fail_unless ( get_num_queued ( & users , "tom" ) == 0 ) ; } END_TEST Suite * user_info_suite ( void ) { Suite * s = suite_create ( "user_info test suite methods" ) ; TCase * tc_core = tcase_create ( "get_num_queued_test" ) ; tcase_add_test ( tc_core , get_num_queued_test ) ; suite_add_tcase ( s , tc_core ) ; tc_core = tcase_create ( "count_jobs_submitted_test" ) ; tcase_add_test ( tc_core , count_jobs_submitted_test ) ; suite_add_tcase ( s , tc_core ) ; tc_core = tcase_create ( "can_queue_new_job_test" ) ; tcase_add_test ( tc_core , can_queue_new_job_test ) ; suite_add_tcase ( s , tc_core ) ; tc_core = tcase_create ( "increment_queued_jobs_test" ) ; tcase_add_test ( tc_core , increment_queued_jobs_test ) ; suite_add_tcase ( s , tc_core ) ; tc_core = tcase_create ( "decrement_queued_jobs_test" ) ; tcase_add_test ( tc_core , decrement_queued_jobs_test ) ; tcase_add_test ( tc_core , remove_server_suffix_test ) ; } 