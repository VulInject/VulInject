void S_UpdateBackgroundTrack ( void ) { int bufferSamples ; int fileSamples ; byte raw [ 30000 ] ; int fileBytes ; int r ; if ( ! s_backgroundStream ) { return ; } if ( s_musicVolume -> value <= 0 ) { return ; } if ( s_rawend [ 0 ] < s_soundtime ) { s_rawend [ 0 ] = s_soundtime ; } while ( s_rawend [ 0 ] < s_soundtime + MAX_RAW_SAMPLES ) { bufferSamples = MAX_RAW_SAMPLES - ( s_rawend [ 0 ] - s_soundtime ) ; fileSamples = bufferSamples * s_backgroundStream -> info . rate / dma . speed ; fileBytes = fileSamples * ( s_backgroundStream -> info . width * s_backgroundStream -> info . channels ) ; if ( fileBytes > sizeof ( raw ) ) { fileBytes = sizeof ( raw ) ; fileSamples = fileBytes / ( s_backgroundStream -> info . width * s_backgroundStream -> info . channels ) ; } r = S_CodecReadStream ( s_backgroundStream , fileBytes , raw ) ; if ( r < fileBytes ) { fileSamples = r / ( s_backgroundStream -> info . width * s_backgroundStream -> info . channels ) ; } if ( r > 0 ) { S_Base_RawSamples ( 0 , fileSamples , s_backgroundStream -> info . rate , s_backgroundStream -> info . width , s_backgroundStream -> info . channels , raw , s_musicVolume -> value , - 1 ) ; } else { if ( s_backgroundLoop [ 0 ] ) { S_OpenBackgroundStream ( s_backgroundLoop ) ; if ( ! s_backgroundStream ) { return ; } } else { S_Base_StopBackgroundTrack ( ) ; return ; } } } } 