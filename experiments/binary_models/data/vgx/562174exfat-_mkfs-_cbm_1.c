static int cbm_write ( struct exfat_dev * dev ) { uint32_t allocated_clusters = DIV_ROUND_UP ( cbm . get_size ( ) , get_cluster_size ( ) ) + DIV_ROUND_UP ( uct . get_size ( ) , get_cluster_size ( ) ) + DIV_ROUND_UP ( rootdir . get_size ( ) , get_cluster_size ( ) ) ; size_t bitmap_size = ROUND_UP ( allocated_clusters , CHAR_BIT ) ; bitmap_t * bitmap = malloc ( BMAP_SIZE ( bitmap_size ) ) ; size_t i ; if ( bitmap == NULL ) { exfat_error ( "failed to allocate bitmap of %zu bytes" , BMAP_SIZE ( bitmap_size ) ) ; return 1 ; } memset ( bitmap , 0 , BMAP_SIZE ( bitmap_size ) ) ; for ( i = 0 ; i < bitmap_size ; i ++ ) { if ( i < allocated_clusters ) { BMAP_SET ( bitmap , i ) ; } } if ( exfat_write ( dev , bitmap , bitmap_size / CHAR_BIT ) < 0 ) { exfat_error ( "failed to write bitmap of %zu bytes" , bitmap_size / CHAR_BIT ) ; return 1 ; } free ( bitmap ) ; return 0 ; } const struct fs_object cbm = { . get_alignment = cbm_alignment . get_size = cbm_size . write = cbm_write } ; 