static int xen_9pfs_front_probe ( struct xenbus_device * dev , const struct xenbus_device_id * id ) { int ret , i ; struct xenbus_transaction xbt ; struct xen_9pfs_front_priv * priv = NULL ; char * versions ; unsigned int max_rings , max_ring_order , len = 0 ; versions = xenbus_read ( XBT_NIL , dev -> otherend , "versions" , & len ) ; if ( IS_ERR ( versions ) ) { return PTR_ERR ( versions ) ; } if ( strcmp ( versions , "1" ) ) { kfree ( versions ) ; return - EINVAL ; } kfree ( versions ) ; max_rings = xenbus_read_unsigned ( dev -> otherend , "max-rings" , 0 ) ; if ( max_rings < XEN_9PFS_NUM_RINGS ) { return - EINVAL ; } max_ring_order = xenbus_read_unsigned ( dev -> otherend , "max-ring-page-order" , 0 ) ; if ( max_ring_order > XEN_9PFS_RING_ORDER ) { max_ring_order = XEN_9PFS_RING_ORDER ; } if ( p9_xen_trans . maxsize > XEN_FLEX_RING_SIZE ( max_ring_order ) ) { p9_xen_trans . maxsize = XEN_FLEX_RING_SIZE ( max_ring_order ) / 2 ; } priv = kzalloc ( sizeof ( * priv ) , GFP_KERNEL ) ; if ( ! priv ) { return - ENOMEM ; } priv -> dev = dev ; priv -> num_rings = XEN_9PFS_NUM_RINGS ; priv -> rings = kcalloc ( priv -> num_rings , sizeof ( * priv -> rings ) , GFP_KERNEL ) ; if ( ! priv -> rings ) { return - ENOMEM ; } for ( i = 0 ; i < priv -> num_rings ; i ++ ) { priv -> rings [ i ] . priv = priv ; ret = xen_9pfs_front_alloc_dataring ( dev , & priv -> rings [ i ] , max_ring_order ) ; if ( ret < 0 ) { error } } again ret = xenbus_transaction_start ( & xbt ) ; if ( ret ) { xenbus_dev_fatal ( dev , ret , "starting transaction" ) ; error } ret = xenbus_printf ( xbt , dev -> nodename , "version" , "%u" , 1 ) ; if ( ret ) { error_xenbus } ret = xenbus_printf ( xbt , dev -> nodename , "num-rings" , "%u" , priv -> num_rings ) ; if ( ret ) { error_xenbus } for ( i = 0 ; i < priv -> num_rings ; i ++ ) { char str [ 16 ] ; BUILD_BUG_ON ( XEN_9PFS_NUM_RINGS > 9 ) ; sprintf ( str , "ring-ref%d" , i ) ; ret = xenbus_printf ( xbt , dev -> nodename , str , "%d" , priv -> rings [ i ] . ref ) ; if ( ret ) { error_xenbus } sprintf ( str , "event-channel-%d" , i ) ; ret = xenbus_printf ( xbt , dev -> nodename , str , "%u" , priv -> rings [ i ] . evtchn ) ; if ( ret ) { error_xenbus } } priv -> tag = xenbus_read ( xbt , dev -> nodename , "tag" , NULL ) ; if ( IS_ERR ( priv -> tag ) ) { ret = PTR_ERR ( priv -> tag ) ; error_xenbus } ret = xenbus_transaction_end ( xbt , 0 ) ; if ( ret ) { if ( ret == - EAGAIN ) { again } xenbus_dev_fatal ( dev , ret , "completing transaction" ) ; error } write_lock ( & xen_9pfs_lock ) ; list_add_tail ( & priv -> list , & xen_9pfs_devs ) ; write_unlock ( & xen_9pfs_lock ) ; dev_set_drvdata ( & dev -> dev , priv ) ; xenbus_switch_state ( dev , XenbusStateInitialised ) ; return 0 ; error_xenbus xenbus_transaction_end ( xbt , 1 ) ; xenbus_dev_fatal ( dev , ret , "writing xenstore" ) ; error dev_set_drvdata ( & dev -> dev , NULL ) ; xen_9pfs_front_free ( priv ) ; return ret ; } 