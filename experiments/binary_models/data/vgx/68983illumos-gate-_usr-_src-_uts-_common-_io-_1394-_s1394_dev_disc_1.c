static int s1394_wait_for_cfgrom_callbacks ( s1394_hal_t * hal , uint_t wait_gen , hcmd_ret_t * handle_cmd_fn ( s1394_hal_t * hal , cmd1394_cmd_t * cmd ) ) { cmd1394_cmd_t * cmd ; s1394_cmd_priv_t * s_priv ; int ret , done = 0 ; hcmd_ret_t cmdret ; ASSERT ( MUTEX_NOT_HELD ( & hal -> topology_tree_mutex ) ) ; ret = DDI_SUCCESS ; while ( ! done ) { mutex_enter ( & hal -> br_cmplq_mutex ) ; mutex_enter ( & hal -> topology_tree_mutex ) ; while ( wait_gen == hal -> generation_count && ( hal -> br_thread_ev_type & BR_THR_GO_AWAY ) == 0 && hal -> br_cmplq_head == NULL ) { mutex_exit ( & hal -> topology_tree_mutex ) ; cv_wait ( & hal -> br_cmplq_cv , & hal -> br_cmplq_mutex ) ; mutex_enter ( & hal -> topology_tree_mutex ) ; } ASSERT ( MUTEX_HELD ( & hal -> topology_tree_mutex ) ) ; if ( wait_gen != hal -> generation_count || ( hal -> br_thread_ev_type & BR_THR_GO_AWAY ) != 0 ) { mutex_exit ( & hal -> topology_tree_mutex ) ; mutex_exit ( & hal -> br_cmplq_mutex ) ; s1394_flush_cmplq ( hal , NULL ) ; return ( DDI_FAILURE ) ; } mutex_exit ( & hal -> topology_tree_mutex ) ; if ( ( cmd = hal -> br_cmplq_head ) != NULL ) { s_priv = S1394_GET_CMD_PRIV ( cmd ) ; hal -> br_cmplq_head = s_priv -> cmd_priv_next ; } if ( cmd == hal -> br_cmplq_tail ) { hal -> br_cmplq_tail = NULL ; } mutex_exit ( & hal -> br_cmplq_mutex ) ; if ( cmd != NULL ) { if ( cmd -> bus_generation != wait_gen ) { ( void ) s1394_free_cmd ( hal , & cmd ) ; continue ; } cmdret = * handle_cmd_fn ( hal , cmd ) ; ASSERT ( cmdret != S1394_HCMD_INVALID ) ; if ( cmdret == S1394_HCMD_LOCK_FAILED ) { ret = DDI_FAILURE ; s1394_flush_cmplq ( hal ) ; break ; } if ( cmdret == S1394_HCMD_NODE_DONE ) { if ( -- hal -> cfgroms_being_read == 0 ) { break ; } } else { ASSERT ( cmdret == S1394_HCMD_NODE_EXPECT_MORE ) ; done = 0 ; } } } return ( ret ) ; } 