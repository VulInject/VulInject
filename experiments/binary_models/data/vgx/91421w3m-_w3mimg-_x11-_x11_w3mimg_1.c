w3mimg_op * w3mimg_x11open ( ) { w3mimg_op * wop = NULL ; struct x11_info * xi = NULL ; char * id ; int revert , i ; unsigned int nchildren ; XWindowAttributes attr ; Window root , * children ; wop = ( w3mimg_op * ) malloc ( sizeof ( w3mimg_op ) ) ; if ( wop == NULL ) { return NULL ; } if ( getenv ( "W3M_USE_REMOTE_IMAGE" ) ) { end } xi = ( x11_info * ) malloc ( sizeof ( x11_info ) ) ; if ( xi == NULL ) { error } memset ( xi , 0 , sizeof ( x11_info ) ) ; xi -> display = XOpenDisplay ( NULL ) ; if ( xi -> display == NULL ) { error } if ( ( id = getenv ( "WINDOWID" ) ) != NULL ) { xi -> window = ( Window ) atoi ( id ) ; } else { XGetInputFocus ( xi -> display , & xi -> window , & revert ) ; } if ( ! xi -> window ) { exit ( 1 ) ; } XGetWindowAttributes ( xi -> display , xi -> window , & attr ) ; wop -> width = attr . width ; wop -> height = attr . height ; while ( 1 ) { Window p_window ; XQueryTree ( xi -> display , xi -> window , & root , & xi -> parent , & children , & nchildren ) ; p_window = xi -> window ; for ( i = 0 ; i < nchildren ; i ++ ) { XGetWindowAttributes ( xi -> display , children [ i ] , & attr ) ; if ( attr . width > wop -> width * 0.7 && attr . height > wop -> height * 0.7 ) { wop -> width = attr . width ; wop -> height = attr . height ; xi -> window = children [ i ] ; } } if ( p_window == xi -> window ) { break ; } } wop -> offset_x = OFFSET_X ; for ( i = 0 ; i < nchildren ; i ++ ) { XGetWindowAttributes ( xi -> display , children [ i ] , & attr ) ; if ( attr . x <= 0 && attr . width ( 30 && attr . height ) wop -> height * 0.7 ) { wop -> offset_x += attr . x + attr . width + attr . border_width * 2 ; break ; } } wop -> offset_y = OFFSET_Y ; wop -> priv = xi ; end wop -> init = x11_init ; wop -> finish = x11_finish ; wop -> active = x11_active ; wop -> set_background = x11_set_background ; wop -> sync = x11_sync ; wop -> close = x11_close ; wop -> clear = x11_clear ; wop -> load_image = x11_load_image ; wop -> show_image = x11_show_image ; wop -> free_image = x11_free_image ; wop -> get_image_size = x11_get_image_size ; return wop ; error if ( xi ) { free ( xi ) ; } free ( wop ) ; return NULL ; } 