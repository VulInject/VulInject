static int shift_fds ( int fds [ ] , size_t n_fds ) { if ( n_fds <= 0 ) { return 0 ; } for ( int start = 0 ; ; ) { int restart_from = - 1 ; for ( int i = start ; i < ( int ) n_fds ; i ++ ) { int nfd ; if ( fds [ i ] == i + 3 ) { continue ; } nfd = fcntl ( fds [ i ] , F_DUPFD , i + 3 ) ; if ( nfd < 0 ) { return - errno ; } safe_close ( fds [ i ] ) ; fds [ i ] = nfd ; if ( nfd != i + 3 && restart_from < 0 ) { restart_from = i ; } } if ( restart_from < 0 ) { break ; } start = restart_from ; } return 0 ; } 