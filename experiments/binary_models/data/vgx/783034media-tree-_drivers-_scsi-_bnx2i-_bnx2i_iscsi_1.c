static int bnx2i_setup_free_cid_que ( struct bnx2i_hba * hba ) { int mem_size ; int i ; mem_size = hba -> max_active_conns * sizeof ( u32 ) ; mem_size = ( mem_size + ( PAGE_SIZE - 1 ) ) & PAGE_MASK ; hba -> cid_que . cid_que_base = kmalloc ( mem_size , GFP_KERNEL ) ; if ( ! hba -> cid_que . cid_que_base ) { return - ENOMEM ; } mem_size = hba -> max_active_conns * sizeof ( bnx2i_conn * ) ; mem_size = ( mem_size + ( PAGE_SIZE - 1 ) ) & PAGE_MASK ; hba -> cid_que . conn_cid_tbl = kmalloc ( mem_size , GFP_KERNEL ) ; if ( ! hba -> cid_que . conn_cid_tbl ) { kfree ( hba -> cid_que . cid_que_base ) ; return - ENOMEM ; } hba -> cid_que . cid_que = ( u32 * ) hba -> cid_que . cid_que_base ; hba -> cid_que . cid_q_prod_idx = 0 ; hba -> cid_que . cid_q_cons_idx = 0 ; hba -> cid_que . cid_q_max_idx = hba -> max_active_conns ; hba -> cid_que . cid_free_cnt = hba -> max_active_conns ; for ( i = 0 ; i < hba -> max_active_conns ; i ++ ) { hba -> cid_que . cid_que [ i ] = i ; hba -> cid_que . conn_cid_tbl [ i ] = NULL ; } return 0 ; } 