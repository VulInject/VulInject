static int sbp2_add_logical_unit ( struct sbp2_target * tgt , int lun_entry ) { struct sbp2_logical_unit * lu ; lu = kmalloc ( sizeof ( * lu ) , GFP_KERNEL ) ; if ( ! lu ) { return - ENOMEM ; } lu -> address_handler . length = 0x100 ; lu -> address_handler . address_callback = sbp2_status_write ; lu -> address_handler . callback_data = lu ; if ( fw_core_add_address_handler ( & lu -> address_handler , & fw_high_memory_region ) < 0 ) { return - ENOMEM ; } lu -> tgt = tgt ; lu -> lun = lun_entry & 0xffff ; lu -> login_id = INVALID_LOGIN_ID ; lu -> retries = 0 ; lu -> has_sdev = false ; lu -> blocked = false ; ++ tgt -> dont_block ; INIT_LIST_HEAD ( & lu -> orb_list ) ; lu -> workfn = sbp2_login ; INIT_DELAYED_WORK ( & lu -> work , sbp2_lu_workfn ) ; list_add_tail ( & lu -> link , & tgt -> lu_list ) ; return 0 ; } 