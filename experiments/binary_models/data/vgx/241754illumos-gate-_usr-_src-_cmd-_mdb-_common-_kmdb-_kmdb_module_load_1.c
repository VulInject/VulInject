int mdb_module_load ( const char * fname , int mode ) { const char * modname = strbasename ( fname ) ; kmdb_wr_load_t * dlr ; kmdb_modctl_t * kmc ; const char * wformat = NULL ; mdb_var_t * v ; if ( ! mdb_module_validate_name ( modname , & wformat ) ) { module_load_err } if ( ( v = mdb_nv_lookup ( & mdb . m_dmodctl , modname ) ) != NULL ) { kmc = MDB_NV_COOKIE ( v ) ; if ( kmc -> kmc_state == KMDB_MC_STATE_LOADING ) { wformat = "module %s is already being loaded\n" ; } else { wformat = "module %s is being unloaded\n" ; } module_load_err } kmc = mdb_zalloc ( sizeof ( kmdb_modctl_t ) , UM_SLEEP ) ; kmc -> kmc_loadmode = mode ; kmc -> kmc_modname = strdup ( modname ) ; kmc -> kmc_state = KMDB_MC_STATE_LOADING ; if ( mdb_nv_insert ( & mdb . m_dmodctl , modname , NULL , ( uintptr_t ) kmc , 0 ) == NULL ) { wformat = "module %s can't be registered for load\n" ; kmc_free ( kmc ) ; module_load_err } dlr = mdb_zalloc ( sizeof ( kmdb_wr_load_t ) , UM_SLEEP ) ; dlr -> dlr_node . wn_task = WNTASK_DMOD_LOAD ; dlr -> dlr_fname = strdup ( fname ) ; kmdb_wr_driver_notify ( dlr ) ; if ( ! ( mode & MDB_MOD_DEFER ) && mdb_tgt_continue ( mdb . m_target , NULL ) == 0 ) { return ( 0 ) ; } if ( ! ( mode & MDB_MOD_SILENT ) ) { mdb_printf ( "%s load pending (:c to complete)\n" , modname ) ; } return ( 0 ) ; module_load_err if ( ! ( mode & MDB_MOD_SILENT ) ) { warn ( wformat , modname ) ; } return ( - 1 ) ; } 