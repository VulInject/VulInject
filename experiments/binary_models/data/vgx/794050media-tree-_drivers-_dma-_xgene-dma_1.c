static void xgene_dma_setup_ring ( struct xgene_dma_ring * ring ) { void * ring_cfg = ring -> state ; u64 addr = ring -> desc_paddr ; u32 i , val ; ring -> slots = ring -> size / XGENE_DMA_RING_WQ_DESC_SIZE ; xgene_dma_clr_ring_state ( ring ) ; XGENE_DMA_RING_TYPE_SET ( ring_cfg , XGENE_DMA_RING_TYPE_REGULAR ) ; if ( ring -> owner == XGENE_DMA_RING_OWNER_DMA ) { XGENE_DMA_RING_RECOMBBUF_SET ( ring_cfg ) ; XGENE_DMA_RING_RECOMTIMEOUTL_SET ( ring_cfg ) ; XGENE_DMA_RING_RECOMTIMEOUTH_SET ( ring_cfg ) ; } XGENE_DMA_RING_SELTHRSH_SET ( ring_cfg ) ; XGENE_DMA_RING_ACCEPTLERR_SET ( ring_cfg ) ; XGENE_DMA_RING_COHERENT_SET ( ring_cfg ) ; XGENE_DMA_RING_ADDRL_SET ( ring_cfg , addr ) ; XGENE_DMA_RING_ADDRH_SET ( ring_cfg , addr ) ; XGENE_DMA_RING_SIZE_SET ( ring_cfg , ring -> cfgsize ) ; xgene_dma_wr_ring_state ( ring ) ; iowrite32 ( XGENE_DMA_RING_ID_SETUP ( ring -> id ) , ring -> pdma -> csr_ring + XGENE_DMA_RING_ID ) ; iowrite32 ( XGENE_DMA_RING_ID_BUF_SETUP ( ring -> num ) , ring -> pdma -> csr_ring + XGENE_DMA_RING_ID_BUF ) ; for ( i = 0 ; i < ring -> slots ; i ++ ) { struct xgene_dma_desc_hw * desc ; desc = & ring -> desc_hw [ i ] ; desc -> m0 = cpu_to_le64 ( XGENE_DMA_DESC_EMPTY_SIGNATURE ) ; } val = ioread32 ( ring -> pdma -> csr_ring + XGENE_DMA_RING_NE_INT_MODE ) ; XGENE_DMA_RING_NE_INT_MODE_SET ( val , ring -> buf_num ) ; iowrite32 ( val , ring -> pdma -> csr_ring + XGENE_DMA_RING_NE_INT_MODE ) ; } 