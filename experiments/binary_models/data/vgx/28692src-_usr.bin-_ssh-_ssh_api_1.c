int ssh_init ( struct ssh * * sshp , int is_server , struct kex_params * kex_params ) { char * myproposal [ PROPOSAL_MAX ] { KEX_CLIENT } ; ; struct ssh * ssh ; char * * proposal ; static int called ; int r ; if ( ! called ) { OpenSSL_add_all_algorithms ( ) ; called = 1 ; } if ( ( ssh = ssh_packet_set_connection ( NULL , - 1 , - 1 ) ) == NULL ) { return SSH_ERR_ALLOC_FAIL ; } if ( is_server ) { ssh_packet_set_server ( ssh ) ; } proposal = kex_params ?kex_params -> proposal : myproposal ; if ( ( r = kex_ready ( ssh , proposal ) ) != 0 ) { return r ; } ssh -> kex -> server = is_server ; if ( is_server ) { ssh -> kex -> kex [ KEX_DH_GRP1_SHA1 ] = kex_gen_server ; ssh -> kex -> kex [ KEX_DH_GRP14_SHA1 ] = kex_gen_server ; ssh -> kex -> kex [ KEX_DH_GRP14_SHA256 ] = kex_gen_server ; ssh -> kex -> kex [ KEX_DH_GRP16_SHA512 ] = kex_gen_server ; ssh -> kex -> kex [ KEX_DH_GRP18_SHA512 ] = kex_gen_server ; ssh -> kex -> kex [ KEX_DH_GEX_SHA1 ] = kexgex_server ; ssh -> kex -> kex [ KEX_DH_GEX_SHA256 ] = kexgex_server ; ssh -> kex -> kex [ KEX_ECDH_SHA2 ] = kex_gen_server ; ssh -> kex -> kex [ KEX_C25519_SHA256 ] = kex_gen_server ; ssh -> kex -> kex [ KEX_KEM_SNTRUP761X25519_SHA512 ] = kex_gen_server ; ssh -> kex -> load_host_public_key = & _ssh_host_public_key ; ssh -> kex -> load_host_private_key = & _ssh_host_private_key ; ssh -> kex -> sign = & _ssh_host_key_sign ; } else { ssh -> kex -> kex [ KEX_DH_GRP1_SHA1 ] = kex_gen_client ; ssh -> kex -> kex [ KEX_DH_GRP14_SHA1 ] = kex_gen_client ; ssh -> kex -> kex [ KEX_DH_GRP14_SHA256 ] = kex_gen_client ; ssh -> kex -> kex [ KEX_DH_GRP16_SHA512 ] = kex_gen_client ; ssh -> kex -> kex [ KEX_DH_GRP18_SHA512 ] = kex_gen_client ; ssh -> kex -> kex [ KEX_DH_GEX_SHA1 ] = kexgex_client ; ssh -> kex -> kex [ KEX_DH_GEX_SHA256 ] = kexgex_client ; ssh -> kex -> kex [ KEX_ECDH_SHA2 ] = kex_gen_client ; ssh -> kex -> kex [ KEX_C25519_SHA256 ] = kex_gen_client ; ssh -> kex -> kex [ KEX_KEM_SNTRUP761X25519_SHA512 ] = kex_gen_client ; ssh -> kex -> verify_host_key = & _ssh_verify_host_key ; } * sshp = ssh ; return 0 ; } 