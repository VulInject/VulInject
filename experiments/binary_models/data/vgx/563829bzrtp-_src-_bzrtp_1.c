static int bzrtp_initChannelContext ( bzrtpContext_t * zrtpContext , bzrtpChannelContext_t * zrtpChannelContext , uint32_t selfSSRC , uint8_t isMain ) { int i ; int retval ; bzrtpPacket_t * helloPacket ; if ( zrtpChannelContext == NULL ) { return BZRTP_ERROR_INVALIDCHANNELCONTEXT ; } zrtpChannelContext -> clientData = NULL ; zrtpChannelContext -> stateMachine = NULL ; zrtpChannelContext -> timer . status = BZRTP_TIMER_OFF ; zrtpChannelContext -> timer . timerStep = HELLO_BASE_RETRANSMISSION_STEP ; zrtpChannelContext -> selfSSRC = selfSSRC ; zrtpChannelContext -> isSecure = 0 ; zrtpChannelContext -> isMainChannel = isMain ; zrtpChannelContext -> isClear = 0 ; zrtpChannelContext -> hasReceivedAGoClear = BZRTP_RECEPTION_UNKNOWN ; zrtpChannelContext -> role = BZRTP_ROLE_INITIATOR ; bctbx_rng_get ( zrtpContext -> RNGContext , zrtpChannelContext -> selfH [ 0 ] , 32 ) ; bctbx_sha256 ( zrtpChannelContext -> selfH [ 0 ] , 32 , 32 , zrtpChannelContext -> selfH [ 1 ] ) ; bctbx_sha256 ( zrtpChannelContext -> selfH [ 1 ] , 32 , 32 , zrtpChannelContext -> selfH [ 2 ] ) ; bctbx_sha256 ( zrtpChannelContext -> selfH [ 2 ] , 32 , 32 , zrtpChannelContext -> selfH [ 3 ] ) ; for ( i = 0 ; i < PACKET_STORAGE_CAPACITY ; i ++ ) { zrtpChannelContext -> selfPackets [ i ] = NULL ; zrtpChannelContext -> peerPackets [ i ] = NULL ; } zrtpChannelContext -> peerHelloHash = NULL ; zrtpChannelContext -> incomingFragmentedPacket . fragments = NULL ; zrtpChannelContext -> incomingFragmentedPacket . messageId = 0 ; zrtpChannelContext -> incomingFragmentedPacket . packetString = NULL ; bctbx_rng_get ( zrtpContext -> RNGContext , ( uint8_t * ) & ( zrtpChannelContext -> selfSequenceNumber ) , 2 ) ; zrtpChannelContext -> selfSequenceNumber &= 0x0FFF ; zrtpChannelContext -> selfSequenceNumber ++ ; zrtpChannelContext -> selfMessageSequenceNumber = zrtpChannelContext -> selfSequenceNumber ; zrtpChannelContext -> peerSequenceNumber = 0 ; zrtpChannelContext -> hashAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> cipherAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> authTagAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> keyAgreementAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> sasAlgo = ZRTP_UNSET_ALGO ; bzrtp_updateCryptoFunctionPointers ( zrtpChannelContext ) ; zrtpChannelContext -> s0 = NULL ; zrtpChannelContext -> KDFContext = NULL ; zrtpChannelContext -> KDFContextLength = 0 ; zrtpChannelContext -> mackeyi = NULL ; zrtpChannelContext -> mackeyr = NULL ; zrtpChannelContext -> zrtpkeyi = NULL ; zrtpChannelContext -> zrtpkeyr = NULL ; zrtpChannelContext -> srtpSecrets . selfSrtpKey = NULL ; zrtpChannelContext -> srtpSecrets . selfSrtpSalt = NULL ; zrtpChannelContext -> srtpSecrets . peerSrtpKey = NULL ; zrtpChannelContext -> srtpSecrets . peerSrtpSalt = NULL ; zrtpChannelContext -> srtpSecrets . selfSrtpKeyLength = 0 ; zrtpChannelContext -> srtpSecrets . selfSrtpSaltLength = 0 ; zrtpChannelContext -> srtpSecrets . peerSrtpKeyLength = 0 ; zrtpChannelContext -> srtpSecrets . peerSrtpSaltLength = 0 ; zrtpChannelContext -> srtpSecrets . cipherAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> srtpSecrets . cipherKeyLength = 0 ; zrtpChannelContext -> srtpSecrets . authTagAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> srtpSecrets . sasLength = 0 ; zrtpChannelContext -> srtpSecrets . hashAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> srtpSecrets . keyAgreementAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> srtpSecrets . sasAlgo = ZRTP_UNSET_ALGO ; zrtpChannelContext -> srtpSecrets . cacheMismatch = 0 ; zrtpChannelContext -> srtpSecrets . auxSecretMismatch = BZRTP_AUXSECRET_UNSET ; helloPacket = bzrtp_createZrtpPacket ( zrtpContext , zrtpChannelContext , MSGTYPE_HELLO , & retval ) ; if ( retval != 0 ) { return retval ; } if ( bzrtp_packetBuild ( zrtpContext , zrtpChannelContext , helloPacket ) == 0 ) { zrtpChannelContext -> selfPackets [ HELLO_MESSAGE_STORE_ID ] = helloPacket ; } else { bzrtp_freeZrtpPacket ( helloPacket ) ; return retval ; } return 0 ; } 