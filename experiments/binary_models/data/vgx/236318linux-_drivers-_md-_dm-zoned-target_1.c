static void dmz_handle_bio ( struct dmz_target * dmz , struct dm_chunk_work * cw , struct bio * bio ) { struct dmz_bioctx * bioctx = dm_per_bio_data ( bio , sizeof ( dmz_bioctx ) ) ; struct dmz_metadata * zmd = dmz -> metadata ; struct dm_zone * zone ; int ret ; dmz_lock_metadata ( zmd ) ; zone = dmz_get_chunk_mapping ( zmd , dmz_bio_chunk ( zmd , bio ) , bio_op ( bio ) ) ; if ( IS_ERR ( zone ) ) { ret = PTR_ERR ( zone ) ; out } if ( zone ) { dmz_activate_zone ( zone , NULL ) ; bioctx -> zone = zone ; dmz_reclaim_bio_acc ( zone -> dev -> reclaim ) ; } switch ( bio_op ( bio ) ) { case REQ_OP_READ : ret = dmz_handle_read ( dmz , zone , bio ) ; break ; case REQ_OP_WRITE : ret = dmz_handle_write ( dmz , zone , bio ) ; break ; case REQ_OP_DISCARD : case REQ_OP_WRITE_ZEROES : ret = dmz_handle_discard ( dmz , zone , bio ) ; break ; default : DMERR ( "(%s): Unsupported BIO operation 0x%x" , dmz_metadata_label ( dmz -> metadata ) , bio_op ( bio ) ) ; ret = - EIO ; } if ( zone ) { dmz_put_chunk_mapping ( zmd , zone ) ; } out dmz_bio_endio ( bio , errno_to_blk_status ( ret ) ) ; dmz_unlock_metadata ( zmd ) ; } 