void get_rtaddrs ( int , struct sockaddr * , struct sockaddr * * ) void if_change ( u_short , int , struct if_data * ) void if_announce ( void * ) int send_rtmsg ( int , struct ktable * , struct kroute_full * ) int dispatch_rtmsg ( void ) int fetchtable ( struct ktable * ) int fetchifs ( int ) int dispatch_rtmsg_addr ( struct rt_msghdr * , struct kroute_full * ) int kr_fib_delete ( struct ktable * , struct kroute_full * , int ) int kr_fib_change ( struct ktable * , struct kroute_full * , int , int ) RB_PROTOTYPE ( , , , ) RB_GENERATE ( , , , ) RB_PROTOTYPE ( , , , ) RB_GENERATE ( , , , ) RB_PROTOTYPE ( , , , ) RB_GENERATE ( , , , ) RB_PROTOTYPE ( , , , ) RB_GENERATE ( , , , ) RB_HEAD ( , ) kit ; RB_PROTOTYPE ( , , , ) RB_GENERATE ( , , , ) int kr_init ( int * fd , uint8_t fib_prio ) { int opt = 0 , rcvbuf , default_rcvbuf ; unsigned int tid = RTABLE_ANY ; socklen_t optlen ; if ( ( kr_state . fd = socket ( AF_ROUTE , SOCK_RAW | SOCK_CLOEXEC | SOCK_NONBLOCK , 0 ) ) == - 1 ) { log_warn ( "%s: socket" , __func__ ) ; return ( - 1 ) ; } if ( setsockopt ( kr_state . fd , SOL_SOCKET , SO_USELOOPBACK , & opt , sizeof ( opt ) ) == - 1 ) { log_warn ( "%s: setsockopt" , __func__ ) ; } optlen = sizeof ( default_rcvbuf ) ; if ( getsockopt ( kr_state . fd , SOL_SOCKET , SO_RCVBUF , & default_rcvbuf , & optlen ) == - 1 ) { log_warn ( "%s: getsockopt SOL_SOCKET SO_RCVBUF" , __func__ ) ; } else { for ( rcvbuf = MAX_RTSOCK_BUF ; rcvbuf > default_rcvbuf && setsockopt ( kr_state . fd , SOL_SOCKET , SO_RCVBUF , & rcvbuf , sizeof ( rcvbuf ) ) == - 1 && errno == ENOBUFS ; rcvbuf /= 2 ) { } } if ( setsockopt ( kr_state . fd , AF_ROUTE , ROUTE_TABLEFILTER , & tid , sizeof ( tid ) ) == - 1 ) { log_warn ( "%s: setsockopt AF_ROUTE ROUTE_TABLEFILTER" , __func__ ) ; return ( - 1 ) ; } kr_state . pid = getpid ( ) ; kr_state . fib_prio = fib_prio ; RB_INIT ( & kit ) ; if ( fetchifs ( 0 ) == - 1 ) { return ( - 1 ) ; } * fd = kr_state . fd ; return ( 0 ) ; } 