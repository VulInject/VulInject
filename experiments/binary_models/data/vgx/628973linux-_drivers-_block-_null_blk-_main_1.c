static ssize_t nullb_device_badblocks_store ( struct config_item * item , const char * page , size_t count ) { struct nullb_device * t_dev = to_nullb_device ( item ) ; char * orig , * buf , * tmp ; u64 start , end ; int ret ; orig = kstrndup ( page , count , GFP_KERNEL ) ; if ( ! orig ) { return - ENOMEM ; } buf = strstrip ( orig ) ; ret = - EINVAL ; if ( buf [ 0 ] != '+' && buf [ 0 ] != '-' ) { out } tmp = strchr ( & buf [ 1 ] , '-' ) ; if ( ! tmp ) { out } * tmp = '\0' ; ret = kstrtoull ( buf + 1 , 0 , & start ) ; if ( ret ) { out } ret = kstrtoull ( tmp + 1 , 0 , & end ) ; if ( ret ) { out } ret = - EINVAL ; if ( start > end ) { out } cmpxchg ( & t_dev -> badblocks . shift , - 1 , 0 ) ; if ( buf [ 0 ] == '+' ) { ret = badblocks_set ( & t_dev -> badblocks , start , end - start + 1 , 1 ) ; } else { ret = badblocks_clear ( & t_dev -> badblocks , start , end - start + 1 ) ; } if ( ret == 0 ) { ret = count ; } out return ret ; } 