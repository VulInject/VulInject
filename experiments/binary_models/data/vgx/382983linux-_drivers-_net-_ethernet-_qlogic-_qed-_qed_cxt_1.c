int qed_cxt_cfg_ilt_compute ( struct qed_hwfn * p_hwfn , u32 * line_count ) { struct qed_cxt_mngr * p_mngr = p_hwfn -> p_cxt_mngr ; u32 curr_line , total , i , task_size , line ; struct qed_ilt_client_cfg * p_cli ; struct qed_ilt_cli_blk * p_blk ; struct qed_cdu_iids cdu_iids ; struct qed_src_iids src_iids ; struct qed_qm_iids qm_iids ; struct qed_tm_iids tm_iids ; struct qed_tid_seg * p_seg ; memset ( & cdu_iids , 0 , sizeof ( cdu_iids ) ) ; memset ( & src_iids , 0 , sizeof ( src_iids ) ) ; memset ( & tm_iids , 0 , sizeof ( tm_iids ) ) ; p_mngr -> pf_start_line = RESC_START ( p_hwfn , QED_ILT ) ; qed_cxt_ilt_blk_reset ( p_hwfn ) ; DP_VERBOSE ( p_hwfn , QED_MSG_ILT , "hwfn [%d] - Set context manager starting line to be 0x%08x\n" , p_hwfn -> my_id , p_hwfn -> p_cxt_mngr -> pf_start_line ) ; p_cli = qed_cxt_set_cli ( & p_mngr -> clients [ ILT_CLI_CDUC ] ) ; curr_line = p_mngr -> pf_start_line ; p_cli -> pf_total_lines = 0 ; qed_cxt_cdu_iids ( p_mngr , & cdu_iids ) ; p_blk = qed_cxt_set_blk ( & p_cli -> pf_blks [ CDUC_BLK ] ) ; total = cdu_iids . pf_cids * CONN_CXT_SIZE ( p_hwfn ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total , CONN_CXT_SIZE ( p_hwfn ) ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUC ) ; p_cli -> pf_total_lines = curr_line - p_blk -> start_line ; p_blk -> dynamic_line_cnt = qed_ilt_get_dynamic_line_cnt ( p_hwfn , ILT_CLI_CDUC ) ; p_blk = qed_cxt_set_blk ( & p_cli -> vf_blks [ CDUC_BLK ] ) ; total = cdu_iids . per_vf_cids * CONN_CXT_SIZE ( p_hwfn ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total , CONN_CXT_SIZE ( p_hwfn ) ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUC ) ; p_cli -> vf_total_lines = curr_line - p_blk -> start_line ; for ( i = 1 ; i < p_mngr -> vf_count ; i ++ ) { qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUC ) ; } p_cli = qed_cxt_set_cli ( & p_mngr -> clients [ ILT_CLI_CDUT ] ) ; p_cli -> first . val = curr_line ; for ( i = 0 ; i < NUM_TASK_PF_SEGMENTS ; i ++ ) { p_seg = qed_cxt_tid_seg_info ( p_hwfn , i ) ; if ( ! p_seg || p_seg -> count == 0 ) { continue ; } p_blk = qed_cxt_set_blk ( & p_cli -> pf_blks [ CDUT_SEG_BLK ( i ) ] ) ; total = p_seg -> count * p_mngr -> task_type_size [ p_seg -> type ] ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total , p_mngr -> task_type_size [ p_seg -> type ] ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUT ) ; } for ( i = 0 ; i < NUM_TASK_PF_SEGMENTS ; i ++ ) { p_seg = qed_cxt_tid_seg_info ( p_hwfn , i ) ; if ( ! p_seg || p_seg -> count == 0 ) { continue ; } p_blk = qed_cxt_set_blk ( & p_cli -> pf_blks [ CDUT_FL_SEG_BLK ( i , PF ) ] ) ; if ( ! p_seg -> has_fl_mem ) { line = p_cli -> pf_blks [ CDUT_SEG_BLK ( i ) ] . start_line ; qed_ilt_cli_blk_fill ( p_cli , p_blk , line , 0 , 0 ) ; continue ; } total = p_seg -> count * p_mngr -> task_type_size [ p_seg -> type ] ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total , p_mngr -> task_type_size [ p_seg -> type ] ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUT ) ; } p_cli -> pf_total_lines = curr_line - p_cli -> pf_blks [ 0 ] . start_line ; p_seg = qed_cxt_tid_seg_info ( p_hwfn , TASK_SEGMENT_VF ) ; if ( p_seg && p_seg -> count ) { total = p_seg -> count * p_mngr -> task_type_size [ p_seg -> type ] ; p_blk = qed_cxt_set_blk ( & p_cli -> vf_blks [ CDUT_SEG_BLK ( 0 ) ] ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total , p_mngr -> task_type_size [ p_seg -> type ] ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUT ) ; p_blk = qed_cxt_set_blk ( & p_cli -> vf_blks [ CDUT_FL_SEG_BLK ( 0 , VF ) ] ) ; if ( ! p_seg -> has_fl_mem ) { line = p_cli -> vf_blks [ CDUT_SEG_BLK ( 0 ) ] . start_line ; qed_ilt_cli_blk_fill ( p_cli , p_blk , line , 0 , 0 ) ; } else { task_size = p_mngr -> task_type_size [ p_seg -> type ] ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total , task_size ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUT ) ; } p_cli -> vf_total_lines = curr_line - p_cli -> vf_blks [ 0 ] . start_line ; for ( i = 1 ; i < p_mngr -> vf_count ; i ++ ) { p_blk = & p_cli -> vf_blks [ CDUT_SEG_BLK ( 0 ) ] ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUT ) ; p_blk = & p_cli -> vf_blks [ CDUT_FL_SEG_BLK ( 0 , VF ) ] ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_CDUT ) ; } } p_cli = qed_cxt_set_cli ( & p_mngr -> clients [ ILT_CLI_QM ] ) ; p_blk = qed_cxt_set_blk ( & p_cli -> pf_blks [ 0 ] ) ; qed_cxt_qm_iids ( p_hwfn , & qm_iids ) ; total = qed_qm_pf_mem_size ( qm_iids . cids , qm_iids . vf_cids , qm_iids . tids , p_hwfn -> qm_info . num_pqs , p_hwfn -> qm_info . num_vf_pqs ) ; DP_VERBOSE ( p_hwfn , QED_MSG_ILT , "QM ILT Info, (cids=%d, vf_cids=%d, tids=%d, num_pqs=%d, num_vf_pqs=%d, memory_size=%d)\n" , qm_iids . cids , qm_iids . vf_cids , qm_iids . tids , p_hwfn -> qm_info . num_pqs , p_hwfn -> qm_info . num_vf_pqs , total ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total * 0x1000 , QM_PQ_ELEMENT_SIZE ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_QM ) ; p_cli -> pf_total_lines = curr_line - p_blk -> start_line ; p_cli = qed_cxt_set_cli ( & p_mngr -> clients [ ILT_CLI_SRC ] ) ; qed_cxt_src_iids ( p_mngr , & src_iids ) ; total = src_iids . pf_cids + src_iids . per_vf_cids * p_mngr -> vf_count ; if ( total ) { u32 local_max = max_t ( u32 , total , SRC_MIN_NUM_ELEMS ) ; total = roundup_pow_of_two ( local_max ) ; p_blk = qed_cxt_set_blk ( & p_cli -> pf_blks [ 0 ] ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total * sizeof ( src_ent ) , sizeof ( src_ent ) ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_SRC ) ; p_cli -> pf_total_lines = curr_line - p_blk -> start_line ; } p_cli = qed_cxt_set_cli ( & p_mngr -> clients [ ILT_CLI_TM ] ) ; qed_cxt_tm_iids ( p_hwfn , p_mngr , & tm_iids ) ; total = tm_iids . pf_cids + tm_iids . pf_tids_total ; if ( total ) { p_blk = qed_cxt_set_blk ( & p_cli -> pf_blks [ 0 ] ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total * TM_ELEM_SIZE , TM_ELEM_SIZE ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_TM ) ; p_cli -> pf_total_lines = curr_line - p_blk -> start_line ; } total = tm_iids . per_vf_cids + tm_iids . per_vf_tids ; if ( total ) { p_blk = qed_cxt_set_blk ( & p_cli -> vf_blks [ 0 ] ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total * TM_ELEM_SIZE , TM_ELEM_SIZE ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_TM ) ; p_cli -> vf_total_lines = curr_line - p_blk -> start_line ; for ( i = 1 ; i < p_mngr -> vf_count ; i ++ ) { qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_TM ) ; } } total = qed_cxt_get_total_srq_count ( p_hwfn ) ; if ( total ) { p_cli = qed_cxt_set_cli ( & p_mngr -> clients [ ILT_CLI_TSDM ] ) ; p_blk = qed_cxt_set_blk ( & p_cli -> pf_blks [ SRQ_BLK ] ) ; qed_ilt_cli_blk_fill ( p_cli , p_blk , curr_line , total * SRQ_CXT_SIZE , SRQ_CXT_SIZE ) ; qed_ilt_cli_adv_line ( p_hwfn , p_cli , p_blk , & curr_line , ILT_CLI_TSDM ) ; p_cli -> pf_total_lines = curr_line - p_blk -> start_line ; } * line_count = curr_line - p_hwfn -> p_cxt_mngr -> pf_start_line ; if ( curr_line - p_hwfn -> p_cxt_mngr -> pf_start_line > RESC_NUM ( p_hwfn , QED_ILT ) ) { return - EINVAL ; } return 0 ; } 