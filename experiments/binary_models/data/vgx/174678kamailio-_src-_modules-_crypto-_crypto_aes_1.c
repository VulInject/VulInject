unsigned char * crypto_aes_decrypt ( EVP_CIPHER_CTX * e , unsigned char * ciphertext , int * len ) { int p_len = * len , f_len = 0 ; unsigned char * plaintext = ( unsigned char * ) malloc ( p_len ) ; if ( plaintext == NULL ) { LM_ERR ( "no more system memory\n" ) ; return NULL ; } if ( ! EVP_DecryptInit_ex ( e , NULL , NULL , NULL , NULL ) ) { LM_ERR ( "failure in EVP_DecryptInit_ex \n" ) ; return NULL ; } if ( ! EVP_DecryptUpdate ( e , plaintext , & p_len , ciphertext , * len ) ) { LM_ERR ( "failure in EVP_DecryptUpdate\n" ) ; free ( plaintext ) ; return NULL ; } if ( ! EVP_DecryptFinal_ex ( e , plaintext + p_len , & f_len ) ) { LM_ERR ( "failure in EVP_DecryptFinal_ex\n" ) ; free ( plaintext ) ; return NULL ; } * len = p_len + f_len ; return plaintext ; } 