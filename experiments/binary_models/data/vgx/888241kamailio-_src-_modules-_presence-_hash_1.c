int ps_ptable_insert ( ps_presentity_t * pt ) { ps_presentity_t ptc ; ps_presentity_t * ptn = NULL ; int idx = 0 ; memcpy ( & ptc , pt , sizeof ( ps_presentity_t ) ) ; ptc . hashid = core_case_hash ( & pt -> user , & pt -> domain , 0 ) ; if ( ptc . ruid . s == NULL ) { if ( sruid_next ( & pres_sruid ) < 0 ) { return - 1 ; } ptc . ruid = pres_sruid . uid ; } ptn = ps_presentity_new ( & ptc , 0 ) ; if ( ptn == NULL ) { return - 1 ; } idx = core_hash_idx ( ptn -> hashid , _ps_ptable -> ssize ) ; lock_get ( & _ps_ptable -> slots [ idx ] . lock ) ; if ( _ps_ptable -> slots [ idx ] . plist == NULL ) { _ps_ptable -> slots [ idx ] . plist = ptn ; } else { _ps_ptable -> slots [ idx ] . plist -> prev = ptn ; ptn -> next = _ps_ptable -> slots [ idx ] . plist ; _ps_ptable -> slots [ idx ] . plist = ptn ; } lock_release ( & _ps_ptable -> slots [ idx ] . lock ) ; return 0 ; } 