static uint64_t aspeed_smc_flash_read ( void * opaque , hwaddr addr , unsigned size ) { AspeedSMCFlash * fl = opaque ; AspeedSMCState * s = fl -> controller ; int ret = 0 ; int i ; switch ( aspeed_smc_flash_mode ( fl ) ) { case CTRL_USERMODE : for ( i = 0 ; i < size ; i ++ ) { ret |= ssi_transfer ( s -> spi , 0x0 ) << ( 8 * i ) ; } break ; case CTRL_READMODE : case CTRL_FREADMODE : aspeed_smc_flash_select ( fl ) ; aspeed_smc_flash_setup ( fl , addr ) ; for ( i = 0 ; i < size ; i ++ ) { ret |= ssi_transfer ( s -> spi , 0x0 ) << ( 8 * i ) ; } aspeed_smc_flash_unselect ( fl ) ; break ; default : aspeed_smc_error ( "invalid flash mode %d" , aspeed_smc_flash_mode ( fl ) ) ; } trace_aspeed_smc_flash_read ( fl -> cs , addr , size , ret , aspeed_smc_flash_mode ( fl ) ) ; return ret ; } 