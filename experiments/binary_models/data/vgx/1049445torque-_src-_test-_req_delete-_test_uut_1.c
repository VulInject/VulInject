START_TEST ( ) { job * pjob ; batch_request * preq ; pjob = new job ( ) ; preq = ( batch_request * ) calloc ( 1 , sizeof ( batch_request ) ) ; strcpy ( pjob -> ji_qs . ji_jobid , "1.napali" ) ; memset ( pjob -> ji_arraystructid , 0 , sizeof ( pjob -> ji_arraystructid ) ) ; preq -> rq_extend = strdup ( delpurgestr ) ; nanny = 0 ; fail_unless ( forced_jobpurge ( pjob , preq ) == - 1 ) ; preq -> rq_perm = ATR_DFLAG_MGRD ; fail_unless ( forced_jobpurge ( pjob , preq ) == PURGE_SUCCESS ) ; preq -> rq_extend = NULL ; fail_unless ( forced_jobpurge ( pjob , preq ) == PBSE_NONE ) ; nanny = 1 ; } END_TEST START_TEST ( test_delete_all_work ) { job * pjob ; batch_request * preq ; pjob = new job ( ) ; pjob -> ji_mutex = ( pthread_mutex_t * ) calloc ( 1 , sizeof ( pthread_mutex_t ) ) ; pthread_mutex_init ( pjob -> ji_mutex , NULL ) ; preq = ( batch_request * ) calloc ( 1 , sizeof ( batch_request ) ) ; preq -> rq_extend = strdup ( delpurgestr ) ; nanny = 0 ; insert_job ( & alljobs , pjob ) ; fail_unless ( delete_all_work ( ( void * ) preq ) == NULL && pthread_mutex_trylock ( pjob -> ji_mutex ) == 0 ) ; nanny = 1 ; } END_TEST START_TEST ( test_post_job_delete_nanny ) { batch_request * preq_sig ; br_freed = FALSE ; post_job_delete_nanny ( NULL ) ; fail_unless ( br_freed == FALSE ) ; preq_sig = ( batch_request * ) calloc ( 1 , sizeof ( batch_request ) ) ; br_freed = FALSE ; nanny = 0 ; post_job_delete_nanny ( preq_sig , NULL ) ; fail_unless ( br_freed == TRUE ) ; preq_sig = ( batch_request * ) calloc ( 1 , sizeof ( batch_request ) ) ; br_freed = FALSE ; nanny = 1 ; strcpy ( preq_sig -> rq_ind . rq_signal . rq_jid , "2.napali" ) ; post_job_delete_nanny ( preq_sig ) ; fail_unless ( br_freed == TRUE ) ; preq_sig = ( batch_request * ) calloc ( 1 , sizeof ( batch_request ) ) ; br_freed = FALSE ; nanny = 1 ; strcpy ( preq_sig -> rq_ind . rq_signal . rq_jid , "1.napali" ) ; post_job_delete_nanny ( preq_sig ) ; fail_unless ( br_freed == TRUE ) ; preq_sig = ( batch_request * ) calloc ( 1 , sizeof ( batch_request ) ) ; br_freed = FALSE ; nanny = 1 ; strcpy ( preq_sig -> rq_ind . rq_signal . rq_jid , "1.napali" ) ; preq_sig -> rq_reply . brp_code = PBSE_UNKJOBID ; post_job_delete_nanny ( preq_sig ) ; fail_unless ( br_freed == TRUE ) ; } END_TEST START_TEST ( test_job_delete_nanny ) { struct work_task * ptask ; ptask = ( work_task * ) calloc ( 1 , sizeof ( work_task ) ) ; ptask -> wt_mutex = ( pthread_mutex_t * ) calloc ( 1 , sizeof ( pthread_mutex_t ) ) ; ptask -> wt_parm1 = strdup ( "1.napali" ) ; nanny = 0 ; job_delete_nanny ( ptask ) ; fail_unless ( signal_issued == FALSE ) ; ptask = ( work_task * ) calloc ( 1 , sizeof ( work_task ) ) ; ptask -> wt_mutex = ( pthread_mutex_t * ) calloc ( 1 , sizeof ( pthread_mutex_t ) ) ; ptask -> wt_parm1 = strdup ( "1.napali" ) ; nanny = 1 ; job_delete_nanny ( ptask ) ; fail_unless ( signal_issued == TRUE ) ; } END_TEST START_TEST ( test_apply_job_delete_nanny ) { job * pjob = new job ( ) ; fail_unless ( apply_job_delete_nanny ( pjob , - 1 ) == - 1 ) ; fail_unless ( pjob -> ji_has_delete_nanny == FALSE ) ; fail_unless ( apply_job_delete_nanny ( pjob , 0 ) == PBSE_NONE ) ; fail_unless ( pjob -> ji_has_delete_nanny == TRUE ) ; pjob -> ji_has_delete_nanny = FALSE ; fail_unless ( apply_job_delete_nanny ( pjob , 10 ) == PBSE_NONE ) ; fail_unless ( pjob -> ji_has_delete_nanny == TRUE ) ; fail_unless ( apply_job_delete_nanny ( pjob , 1 ) == PBSE_NONE ) ; } END_TEST START_TEST ( test_ensure_deleted ) { struct work_task * ptask = ( work_task * ) calloc ( 1 , sizeof ( work_task ) ) ; ptask -> wt_mutex = ( pthread_mutex_t * ) calloc ( 1 , sizeof ( pthread_mutex_t ) ) ; ptask -> wt_parm1 = strdup ( "1.napali" ) ; ensure_deleted ( ptask ) ; } END_TEST 