static ssize_t bh1770_lux_calib_store ( struct device * dev , struct device_attribute * attr , const char * buf , size_t len ) { struct bh1770_chip * chip = dev_get_drvdata ( dev ) ; unsigned long value ; u32 old_calib ; u32 new_corr ; int ret ; ret = kstrtoul ( buf , 0 , & value ) ; mutex_lock ( & chip -> mutex ) ; old_calib = chip -> lux_calib ; chip -> lux_calib = value ; new_corr = bh1770_get_corr_value ( chip ) ; if ( new_corr == 0 ) { chip -> lux_calib = old_calib ; mutex_unlock ( & chip -> mutex ) ; return - EINVAL ; } chip -> lux_corr = new_corr ; bh1770_lux_update_thresholds ( chip , chip -> lux_threshold_hi , chip -> lux_threshold_lo ) ; mutex_unlock ( & chip -> mutex ) ; return len ; } 