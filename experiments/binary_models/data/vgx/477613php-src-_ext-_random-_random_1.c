PHPAPI uint32_t php_random_range32 ( const php_random_algo * algo , php_random_status * status , uint32_t umax ) { uint32_t result , limit ; size_t total_size = 0 ; uint32_t count = 0 ; result = 0 ; total_size = 0 ; { uint32_t r = algo -> generate ( status ) ; result = result | ( r << ( total_size * 8 ) ) ; total_size += status -> last_generated_size ; if ( EG ( exception ) ) { return 0 ; } } total_size < sizeof ( uint32_t ) ; umax ++ ; if ( ( umax & ( umax - 1 ) ) == 0 ) { return result & ( umax - 1 ) ; } limit = UINT32_MAX - ( UINT32_MAX % umax ) - 1 ; while ( UNEXPECTED ( result > limit ) ) { if ( ++ count > PHP_RANDOM_RANGE_ATTEMPTS ) { zend_throw_error ( random_ce_Random_BrokenRandomEngineError , "Failed to generate an acceptable random number in %d attempts" , PHP_RANDOM_RANGE_ATTEMPTS ) ; return 0 ; } result = 0 ; total_size = 0 ; { uint32_t r = algo -> generate ( status ) ; result = result | ( r << ( total_size * 8 ) ) ; total_size += status -> last_generated_size ; if ( EG ( exception ) ) { return 0 ; } } total_size < sizeof ( uint32_t ) ; } return result % umax ; } 