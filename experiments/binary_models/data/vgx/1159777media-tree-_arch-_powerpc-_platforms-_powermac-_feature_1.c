static long ohare_htw_scc_enable ( struct device_node * node , long param , long value ) { struct macio_chip * macio ; unsigned long chan_mask ; unsigned long fcr ; unsigned long flags ; int htw , trans ; unsigned long rmask ; macio = macio_find ( node , 0 ) ; if ( ! strcmp ( node -> name , "ch-a" ) ) { chan_mask = MACIO_FLAG_SCCA_ON ; } if ( ! strcmp ( node -> name , "ch-b" ) ) { chan_mask = MACIO_FLAG_SCCB_ON ; } else { return - ENODEV ; } htw = ( macio -> type == macio_heathrow || macio -> type == macio_paddington || macio -> type == macio_gatwick ) ; trans = ( pmac_mb . model_id != PMAC_TYPE_YOSEMITE && pmac_mb . model_id != PMAC_TYPE_YIKES ) ; if ( value ) { if ( ( param & 0xfff ) == PMAC_SCC_IRDA ) { pmu_enable_irled ( 1 ) ; } LOCK ( flags ) ; fcr = MACIO_IN32 ( OHARE_FCR ) ; if ( ! ( fcr & OH_SCC_ENABLE ) ) { fcr |= OH_SCC_ENABLE ; if ( htw ) { if ( trans ) { fcr &= ~ HRW_SCC_TRANS_EN_N ; } MACIO_OUT32 ( OHARE_FCR , fcr ) ; fcr |= ( rmask = HRW_RESET_SCC ) ; MACIO_OUT32 ( OHARE_FCR , fcr ) ; } else { fcr |= ( rmask = OH_SCC_RESET ) ; MACIO_OUT32 ( OHARE_FCR , fcr ) ; } UNLOCK ( flags ) ; ( void ) MACIO_IN32 ( OHARE_FCR ) ; mdelay ( 15 ) ; LOCK ( flags ) ; fcr &= ~ rmask ; MACIO_OUT32 ( OHARE_FCR , fcr ) ; } if ( chan_mask & MACIO_FLAG_SCCA_ON ) { fcr |= OH_SCCA_IO ; } if ( chan_mask & MACIO_FLAG_SCCB_ON ) { fcr |= OH_SCCB_IO ; } MACIO_OUT32 ( OHARE_FCR , fcr ) ; macio -> flags |= chan_mask ; UNLOCK ( flags ) ; if ( param & PMAC_SCC_FLAG_XMON ) { macio -> flags |= MACIO_FLAG_SCC_LOCKED ; } } else { if ( macio -> flags & MACIO_FLAG_SCC_LOCKED ) { return - EPERM ; } LOCK ( flags ) ; fcr = MACIO_IN32 ( OHARE_FCR ) ; if ( chan_mask & MACIO_FLAG_SCCA_ON ) { fcr &= ~ OH_SCCA_IO ; } if ( chan_mask & MACIO_FLAG_SCCB_ON ) { fcr &= ~ OH_SCCB_IO ; } MACIO_OUT32 ( OHARE_FCR , fcr ) ; if ( ( fcr & ( OH_SCCA_IO | OH_SCCB_IO ) ) == 0 ) { fcr &= ~ OH_SCC_ENABLE ; if ( htw && trans ) { fcr |= HRW_SCC_TRANS_EN_N ; } MACIO_OUT32 ( OHARE_FCR , fcr ) ; } macio -> flags &= ~ ( chan_mask ) ; UNLOCK ( flags ) ; mdelay ( 10 ) ; if ( ( param & 0xfff ) == PMAC_SCC_IRDA ) { pmu_enable_irled ( 0 ) ; } } return 0 ; } 