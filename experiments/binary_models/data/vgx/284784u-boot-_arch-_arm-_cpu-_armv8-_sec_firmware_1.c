static int sec_firmware_check_copy_loadable ( const void * sec_firmware_img , u32 * loadable_l , u32 * loadable_h ) { phys_addr_t sec_firmware_loadable_addr = 0 ; int conf_node_off , ld_node_off , images ; const void * data ; size_t size ; ulong load ; const char * name , * str , * type ; int len ; conf_node_off = fit_conf_get_node ( sec_firmware_img , NULL ) ; if ( conf_node_off < 0 ) { puts ( "SEC Firmware: no config\n" ) ; return - ENOENT ; } images = fdt_path_offset ( sec_firmware_img , FIT_IMAGES_PATH ) ; if ( images < 0 ) { printf ( "%s: Cannot find /images node: %d\n" , __func__ , images ) ; return - 1 ; } type = FIT_LOADABLE_PROP ; name = fdt_getprop ( sec_firmware_img , conf_node_off , type , & len ) ; printf ( "SEC Firmware: '%s' present in config\n" , type ) ; for ( str = name ; str && ( ( str - name ) < len ) ; str = strchr ( str , '\0' ) + 1 ) { printf ( "%s: '%s'\n" , type , str ) ; ld_node_off = fdt_subnode_offset ( sec_firmware_img , images , str ) ; if ( ld_node_off < 0 ) { printf ( "cannot find image node '%s': %d\n" , str , ld_node_off ) ; return - EINVAL ; } if ( ! ( fit_image_verify ( sec_firmware_img , ld_node_off ) ) ) { printf ( "SEC Loadable: Bad loadable image (bad CRC)\n" ) ; return - EINVAL ; } if ( fit_image_get_data ( sec_firmware_img , ld_node_off , & data , & size ) ) { printf ( "SEC Loadable: Can't get subimage data/size" ) ; return - ENOENT ; } if ( fit_image_get_load ( sec_firmware_img , ld_node_off , & load ) ) { printf ( "SEC Loadable: Can't get subimage load" ) ; return - ENOENT ; } sec_firmware_loadable_addr = ( sec_firmware_addr - gd -> arch . tlb_size ) + load ; debug ( "%s copied to address 0x%p\n" , FIT_LOADABLE_PROP , ( void * ) sec_firmware_loadable_addr ) ; memcpy ( ( void * ) sec_firmware_loadable_addr , data , size ) ; flush_dcache_range ( sec_firmware_loadable_addr , sec_firmware_loadable_addr + size ) ; if ( ! strcmp ( str , "trustedOS@1" ) ) { out_le32 ( loadable_l , ( sec_firmware_loadable_addr & WORD_MASK ) ) ; out_le32 ( loadable_h , ( sec_firmware_loadable_addr >> WORD_SHIFT ) ) ; } } return 0 ; } 