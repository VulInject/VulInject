node_info * * query_nodes ( int pbs_sd , server_info * sinfo ) { struct batch_status * nodes ; struct batch_status * cur_node ; node_info * * ninfo_arr ; node_info * ninfo ; char errbuf [ 256 ] ; char * err ; int num_nodes = 0 ; int i ; int local_errno ; if ( ( nodes = pbs_statnode_err ( pbs_sd , NULL , NULL , NULL , & local_errno ) ) == NULL ) { err = pbs_geterrmsg ( pbs_sd ) ; sprintf ( errbuf , "Error getting nodes: %s" , err ) ; sched_log ( PBSEVENT_SCHED , PBS_EVENTCLASS_NODE , "" , errbuf ) ; return NULL ; } cur_node = nodes ; while ( cur_node != NULL ) { num_nodes ++ ; cur_node = cur_node -> next ; } if ( ( ninfo_arr = ( node_info * * ) malloc ( ( num_nodes + 1 ) * sizeof ( node_info * ) ) ) == NULL ) { perror ( "Error Allocating Memory" ) ; pbs_statfree ( nodes ) ; return NULL ; } cur_node = nodes ; for ( i = 0 ; cur_node != NULL ; i ++ ) { if ( ( ninfo = query_node_info ( cur_node , sinfo ) ) == NULL ) { pbs_statfree ( nodes ) ; free_nodes ( ninfo_arr ) ; return NULL ; } talk_with_mom ( ninfo ) ; ninfo_arr [ i ] = ninfo ; cur_node = cur_node -> next ; } ninfo_arr [ i ] = NULL ; sinfo -> num_nodes = num_nodes ; pbs_statfree ( nodes ) ; return ninfo_arr ; } node_info * query_node_info ( struct batch_status * node , server_info * sinfo ) { node_info * ninfo ; struct attrl * attrp ; if ( ( ninfo = new_node_info ( ) ) == NULL ) { return NULL ; } attrp = node -> attribs ; ninfo -> name = string_dup ( node -> name ) ; ninfo -> server = sinfo ; while ( attrp != NULL ) { if ( ! strcmp ( attrp -> name , ATTR_NODE_state ) ) { set_node_state ( ninfo , attrp -> value ) ; } if ( ! strcmp ( attrp -> name , ATTR_NODE_properties ) ) { ninfo -> properties = break_comma_list ( attrp -> value ) ; } if ( ! strcmp ( attrp -> name , ATTR_NODE_jobs ) ) { ninfo -> jobs = break_comma_list ( attrp -> value ) ; } if ( ! strcmp ( attrp -> name , ATTR_NODE_ntype ) ) { set_node_type ( ninfo , attrp -> value ) ; } attrp = attrp -> next ; } return ninfo ; } node_info * new_node_info ( ) { node_info * new_node_info ; if ( ( new_node_info = ( node_info * ) malloc ( sizeof ( node_info ) ) ) == NULL ) { perror ( "Memory Allocation Error" ) ; return NULL ; } new_node_info -> is_free = 0 ; new_node_info -> is_offline = 0 ; new_node_info -> is_unknown = 0 ; new_node_info -> is_reserved = 0 ; new_node_info -> is_exclusive = 0 ; new_node_info -> is_sharing = 0 ; new_node_info -> is_timeshare = 0 ; new_node_info -> is_cluster = 0 ; new_node_info -> name = NULL ; new_node_info -> properties = NULL ; new_node_info -> jobs = NULL ; new_node_info -> max_load = 0.0 ; new_node_info -> ideal_load = 0.0 ; new_node_info -> arch = NULL ; new_node_info -> ncpus = 0 ; new_node_info -> physmem = 0 ; new_node_info -> loadave = 0.0 ; return new_node_info ; } void free_nodes ( node_info * * ninfo_arr ) { int i ; if ( ninfo_arr != NULL ) { for ( i = 0 ; ninfo_arr [ i ] != NULL ; i ++ ) { free_node_info ( ninfo_arr [ i ] ) ; } free ( ninfo_arr ) ; } } 