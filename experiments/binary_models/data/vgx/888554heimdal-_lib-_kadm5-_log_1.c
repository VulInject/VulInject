static off_t seek_prev ( krb5_storage * sp , uint32_t * verp , uint32_t * lenp ) { krb5_error_code ret ; uint32_t len , ver ; off_t off_len ; off_t off , new_off ; if ( lenp == NULL ) { lenp = & len ; } if ( verp == NULL ) { verp = & ver ; } * verp = 0 ; * lenp = 0 ; off = krb5_storage_seek ( sp , 0 , SEEK_CUR ) ; if ( off < 0 ) { return off ; } if ( off == 0 ) { return 0 ; } if ( off < LOG_WRAPPER_SZ ) { log_corrupt } new_off = krb5_storage_seek ( sp , - 8 , SEEK_CUR ) ; if ( new_off != off - 8 ) { errno = EIO ; return - 1 ; } ret = krb5_ret_uint32 ( sp , lenp ) ; if ( ret ) { log_corrupt } off_len = ( off_t ) * lenp ; if ( off_len < 0 || * lenp != ( uint32_t ) off_len ) { log_corrupt } ret = krb5_ret_uint32 ( sp , verp ) ; if ( ret ) { log_corrupt } if ( off < LOG_WRAPPER_SZ + off_len ) { log_corrupt } new_off = krb5_storage_seek ( sp , - ( LOG_WRAPPER_SZ + off_len ) , SEEK_CUR ) ; if ( new_off == - 1 ) { return - 1 ; } if ( new_off != off - ( LOG_WRAPPER_SZ + off_len ) ) { errno = EIO ; return - 1 ; } return new_off ; log_corrupt ( void ) krb5_storage_seek ( sp , off , SEEK_SET ) ; errno = KADM5_LOG_CORRUPT ; return - 1 ; } 