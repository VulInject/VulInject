static int mt6358_amic_enable ( struct mt6358_priv * priv ) { unsigned int mic_type = priv -> mux_select [ MUX_MIC_TYPE ] ; int mux_pga_l = priv -> mux_select [ MUX_PGA_L ] ; unsigned int mux_pga_r = priv -> mux_select [ MUX_PGA_R ] ; dev_info ( priv -> dev , "%s(), mux, mic %u, pga l %u, pga r %u\n" , __func__ , mic_type , mux_pga_l , mux_pga_r ) ; if ( IS_DCC_BASE ( mic_type ) ) { regmap_write ( priv -> regmap , MT6358_AFE_DCCLK_CFG0 , 0x2062 ) ; regmap_write ( priv -> regmap , MT6358_AFE_DCCLK_CFG0 , 0x2062 ) ; regmap_write ( priv -> regmap , MT6358_AFE_DCCLK_CFG0 , 0x2060 ) ; regmap_write ( priv -> regmap , MT6358_AFE_DCCLK_CFG0 , 0x2061 ) ; regmap_write ( priv -> regmap , MT6358_AFE_DCCLK_CFG1 , 0x0100 ) ; } if ( mux_pga_l == PGA_MUX_AIN0 || mux_pga_l == PGA_MUX_AIN2 || mux_pga_r == PGA_MUX_AIN0 || mux_pga_r == PGA_MUX_AIN2 ) { switch ( mic_type ) { case MIC_TYPE_MUX_DCC_ECM_DIFF : regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON9 , 0xff00 , 0x7700 ) ; break ; case MIC_TYPE_MUX_DCC_ECM_SINGLE : regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON9 , 0xff00 , 0x1100 ) ; break ; default : regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON9 , 0xff00 , 0x0000 ) ; break ; } regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON9 , 0xff , 0x21 ) ; } if ( mux_pga_l == PGA_MUX_AIN1 || mux_pga_r == PGA_MUX_AIN1 ) { if ( mic_type == MIC_TYPE_MUX_DCC_ECM_SINGLE ) { regmap_write ( priv -> regmap , MT6358_AUDENC_ANA_CON10 , 0x0161 ) ; } else { regmap_write ( priv -> regmap , MT6358_AUDENC_ANA_CON10 , 0x0061 ) ; } } if ( IS_DCC_BASE ( mic_type ) ) { regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , 0xf8ff , 0x0004 ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , 0xf8ff , 0x0004 ) ; } else { regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , 0xf8ff , 0x0000 ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , 0xf8ff , 0x0000 ) ; } if ( mux_pga_l != PGA_MUX_NONE ) { regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , RG_AUDPREAMPLINPUTSEL_MASK_SFT , mux_pga_l << RG_AUDPREAMPLINPUTSEL_SFT ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , RG_AUDPREAMPLON_MASK_SFT , 0x1 << RG_AUDPREAMPLON_SFT ) ; if ( IS_DCC_BASE ( mic_type ) ) { regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , RG_AUDPREAMPLDCCEN_MASK_SFT , 0x1 << RG_AUDPREAMPLDCCEN_SFT ) ; } regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , RG_AUDADCLINPUTSEL_MASK_SFT , ADC_MUX_PREAMPLIFIER << RG_AUDADCLINPUTSEL_SFT ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , RG_AUDADCLPWRUP_MASK_SFT , 0x1 << RG_AUDADCLPWRUP_SFT ) ; } if ( mux_pga_r != PGA_MUX_NONE ) { regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , RG_AUDPREAMPRINPUTSEL_MASK_SFT , mux_pga_r << RG_AUDPREAMPRINPUTSEL_SFT ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , RG_AUDPREAMPRON_MASK_SFT , 0x1 << RG_AUDPREAMPRON_SFT ) ; if ( IS_DCC_BASE ( mic_type ) ) { regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , RG_AUDPREAMPRDCCEN_MASK_SFT , 0x1 << RG_AUDPREAMPRDCCEN_SFT ) ; } regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , RG_AUDADCRINPUTSEL_MASK_SFT , ADC_MUX_PREAMPLIFIER << RG_AUDADCRINPUTSEL_SFT ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , RG_AUDADCRPWRUP_MASK_SFT , 0x1 << RG_AUDADCRPWRUP_SFT ) ; } if ( IS_DCC_BASE ( mic_type ) ) { usleep_range ( 100 , 150 ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON0 , RG_AUDPREAMPLDCPRECHARGE_MASK_SFT , 0x0 ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON1 , RG_AUDPREAMPRDCPRECHARGE_MASK_SFT , 0x0 ) ; regmap_update_bits ( priv -> regmap , MT6358_AUDENC_ANA_CON3 , 0x1 << 12 , 0x0 ) ; } mt6358_mtkaif_tx_enable ( priv ) ; regmap_write ( priv -> regmap , MT6358_AFE_UL_SRC_CON0_H , 0x0000 ) ; regmap_write ( priv -> regmap , MT6358_AFE_UL_SRC_CON0_L , 0x0001 ) ; return 0 ; } 