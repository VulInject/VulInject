void ptm_bfd_echo_fp_snd ( struct bfd_session * bfd ) { int sd ; struct bfd_vrf_global * bvrf = bfd_vrf_look_by_session ( bfd ) ; int total_len = 0 ; struct ethhdr * eth ; struct udphdr * uh ; struct iphdr * iph ; struct bfd_echo_pkt * beph ; static char sendbuff [ 100 ] ; struct timeval time_sent ; if ( ! bvrf ) { return ; } if ( ! CHECK_FLAG ( bfd -> flags , BFD_SESS_FLAG_MAC_SET ) ) { return ; } if ( ! CHECK_FLAG ( bfd -> flags , BFD_SESS_FLAG_ECHO_ACTIVE ) ) { SET_FLAG ( bfd -> flags , BFD_SESS_FLAG_ECHO_ACTIVE ) ; } eth = ( ethhdr * ) ( sendbuff ) ; memcpy ( eth -> h_source , bfd -> ifp -> hw_addr , sizeof ( eth -> h_source ) ) ; memcpy ( eth -> h_dest , bfd -> peer_hw_addr , sizeof ( eth -> h_dest ) ) ; total_len += sizeof ( ethhdr ) ; sd = bvrf -> bg_echo ; eth -> h_proto = htons ( ETH_P_IP ) ; iph = ( iphdr * ) ( sendbuff + sizeof ( ethhdr ) ) ; iph -> ihl = sizeof ( ip ) >> 2 ; iph -> version = IPVERSION ; iph -> tos = IPTOS_PREC_INTERNETCONTROL ; iph -> id = ( uint16_t ) frr_weak_random ( ) ; iph -> ttl = BFD_TTL_VAL ; iph -> protocol = IPPROTO_UDP ; memcpy ( & iph -> saddr , & bfd -> local_address . sa_sin . sin_addr , sizeof ( bfd -> local_address . sa_sin . sin_addr ) ) ; memcpy ( & iph -> daddr , & bfd -> local_address . sa_sin . sin_addr , sizeof ( bfd -> local_address . sa_sin . sin_addr ) ) ; total_len += sizeof ( iphdr ) ; uh = ( udphdr * ) ( sendbuff + sizeof ( iphdr ) + sizeof ( ethhdr ) ) ; uh -> source = htons ( BFD_DEF_ECHO_PORT ) ; uh -> dest = htons ( BFD_DEF_ECHO_PORT ) ; total_len += sizeof ( udphdr ) ; beph = ( bfd_echo_pkt * ) ( sendbuff + sizeof ( udphdr ) + sizeof ( iphdr ) + sizeof ( ethhdr ) ) ; beph -> ver = BFD_ECHO_VERSION ; beph -> len = BFD_ECHO_PKT_LEN ; beph -> my_discr = htonl ( bfd -> discrs . my_discr ) ; monotime ( & time_sent ) ; beph -> time_sent_sec = htobe64 ( time_sent . tv_sec ) ; beph -> time_sent_usec = htobe64 ( time_sent . tv_usec ) ; total_len += sizeof ( bfd_echo_pkt ) ; uh -> len = htons ( total_len - sizeof ( iphdr ) - sizeof ( ethhdr ) ) ; uh -> check = bfd_pkt_checksum ( uh , ( total_len - sizeof ( iphdr ) - sizeof ( ethhdr ) ) , ( in6_addr * ) & iph -> saddr , AF_INET ) ; iph -> tot_len = htons ( total_len - sizeof ( ethhdr ) ) ; iph -> check = in_cksum ( ( const void * ) iph , sizeof ( iphdr ) ) ; if ( bp_udp_send_fp ( sd , ( uint8_t * ) & sendbuff , total_len , bfd ) == - 1 ) { return ; } bfd -> stats . tx_echo_pkt ++ ; } 