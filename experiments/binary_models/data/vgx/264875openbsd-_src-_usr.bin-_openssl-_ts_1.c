static int query_command ( const char * data , char * digest , const EVP_MD * md , const char * policy , int no_nonce , int cert , const char * in , const char * out , int text ) { int ret = 0 ; TS_REQ * query = NULL ; BIO * in_bio = NULL ; BIO * data_bio = NULL ; BIO * out_bio = NULL ; if ( in != NULL ) { if ( ( in_bio = BIO_new_file ( in , "rb" ) ) == NULL ) { end } query = d2i_TS_REQ_bio ( in_bio , NULL ) ; } else { if ( digest == NULL && ( data_bio = BIO_open_with_default ( data , "rb" , stdin ) ) == NULL ) { end } query = create_query ( data_bio , digest , md , policy , no_nonce , cert ) ; } if ( query == NULL ) { end } if ( ( out_bio = BIO_open_with_default ( out , "wb" , stdout ) ) == NULL ) { end } if ( text ) { if ( ! TS_REQ_print_bio ( out_bio , query ) ) { end } } else { if ( ! i2d_TS_REQ_bio ( out_bio , query ) ) { end } } ret = 1 ; end ERR_print_errors ( bio_err ) ; BIO_free_all ( in_bio ) ; BIO_free_all ( out_bio ) ; TS_REQ_free ( query ) ; return ret ; } 