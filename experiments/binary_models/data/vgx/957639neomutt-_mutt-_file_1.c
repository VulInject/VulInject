char * mutt_file_read_line ( char * line , size_t * size , FILE * fp , int * line_num , ReadLineFlags flags ) { if ( ! size || ! fp ) { return in ; } size_t offset = 0 ; char * ch = NULL ; if ( ! line ) { * size = 256 ; line = mutt_mem_malloc ( * size ) ; } while ( true ) { if ( ! fgets ( line + offset , * size - offset , fp ) ) { FREE ( & line ) ; return NULL ; } ch = strchr ( line + offset , '\n' ) ; if ( ch ) { if ( line_num ) { ( * line_num ) ++ ; } if ( flags & MUTT_RL_EOL ) { return line ; } * ch = '\0' ; if ( ( ch > line ) && ( * ( ch - 1 ) == '\r' ) ) { * -- ch = '\0' ; } if ( ! ( flags & MUTT_RL_CONT ) || ( ch == line ) || ( * ( ch - 1 ) != '\\' ) ) { return line ; } offset = ch - line - 1 ; } else { int c ; c = getc ( fp ) ; if ( c == EOF ) { if ( line_num ) { ( * line_num ) ++ ; } return line ; } else { ungetc ( c , fp ) ; offset = * size - 1 ; * size += 256 ; mutt_mem_realloc ( & line , * size ) ; } } } } 