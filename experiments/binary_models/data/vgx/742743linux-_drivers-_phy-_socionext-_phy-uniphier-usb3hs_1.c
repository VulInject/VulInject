static int uniphier_u3hsphy_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct uniphier_u3hsphy_priv * priv ; struct phy_provider * phy_provider ; struct phy * phy ; priv = devm_kzalloc ( dev , sizeof ( * priv ) , GFP_KERNEL ) ; if ( ! priv ) { return - ENOMEM ; } priv -> dev = dev ; priv -> data = of_device_get_match_data ( dev ) ; priv -> base = devm_platform_ioremap_resource ( pdev , 0 ) ; if ( IS_ERR ( priv -> base ) ) { return PTR_ERR ( priv -> base ) ; } if ( ! priv -> data -> is_legacy ) { priv -> clk = devm_clk_get ( dev , "phy" ) ; if ( IS_ERR ( priv -> clk ) ) { return PTR_ERR ( priv -> clk ) ; } priv -> clk_ext = devm_clk_get_optional ( dev , "phy-ext" ) ; if ( IS_ERR ( priv -> clk_ext ) ) { return PTR_ERR ( priv -> clk_ext ) ; } priv -> rst = devm_reset_control_get_shared ( dev , "phy" ) ; if ( IS_ERR ( priv -> rst ) ) { return PTR_ERR ( priv -> rst ) ; } } else { priv -> clk_parent_gio = devm_clk_get ( dev , "gio" ) ; if ( IS_ERR ( priv -> clk_parent_gio ) ) { return PTR_ERR ( priv -> clk_parent_gio ) ; } priv -> rst_parent_gio = devm_reset_control_get_shared ( dev , "gio" ) ; if ( IS_ERR ( priv -> rst_parent_gio ) ) { return PTR_ERR ( priv -> rst_parent_gio ) ; } } priv -> clk_parent = devm_clk_get ( dev , "link" ) ; if ( IS_ERR ( priv -> clk_parent ) ) { return PTR_ERR ( priv -> clk_parent ) ; } priv -> rst_parent = devm_reset_control_get_shared ( dev , "link" ) ; if ( IS_ERR ( priv -> rst_parent ) ) { return PTR_ERR ( priv -> rst_parent ) ; } priv -> vbus = devm_regulator_get_optional ( dev , "vbus" ) ; if ( IS_ERR ( priv -> vbus ) ) { if ( PTR_ERR ( priv -> vbus ) == - EPROBE_DEFER ) { return PTR_ERR ( priv -> vbus ) ; } priv -> vbus = NULL ; } phy = devm_phy_create ( dev , dev -> of_node , & uniphier_u3hsphy_ops ) ; if ( IS_ERR ( phy ) ) { return PTR_ERR ( phy ) ; } phy_set_drvdata ( phy , priv ) ; phy_provider = devm_of_phy_provider_register ( dev , of_phy_simple_xlate ) ; return PTR_ERR_OR_ZERO ( phy_provider ) ; } 