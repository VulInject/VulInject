static int maybe_resize_underlying_device ( int mountfd , const char * mountpath , dev_t main_devno ) { _cleanup_free_ char * devpath = NULL , * fstype = NULL ; dev_t devno ; int r ; assert ( mountfd >= 0 ) ; assert ( mountpath ) ; cryptsetup_enable_logging ( NULL , NULL ) ; r = get_block_device_harder_fd ( mountfd , & devno ) ; if ( r < 0 ) { return log_error_errno ( r , "Failed to determine underlying block device of \"%s\": %m" , mountpath ) ; } if ( devno == 0 ) { return log_error_errno ( SYNTHETIC_ERRNO ( ENODEV ) , "File system \"%s\" not backed by block device." , arg_target ) ; } log_debug ( "Underlying device " DEVNUM_FORMAT_STR ", main dev " DEVNUM_FORMAT_STR ", %s" , DEVNUM_FORMAT_VAL ( devno ) , DEVNUM_FORMAT_VAL ( main_devno ) , devno == main_devno ?"same" : "different" ) ; if ( devno == main_devno ) { return 0 ; } r = devname_from_devnum ( S_IFBLK , devno , & devpath ) ; if ( r < 0 ) { return log_error_errno ( r , "Failed to get devpath for block device " DEVNUM_FORMAT_STR ": %m" , DEVNUM_FORMAT_VAL ( devno ) ) ; } r = probe_filesystem ( devpath , & fstype ) ; if ( r == - EUCLEAN ) { return log_warning_errno ( r , "Cannot reliably determine probe \"%s\", refusing to proceed." , devpath ) ; } if ( r < 0 ) { return log_warning_errno ( r , "Failed to probe \"%s\": %m" , devpath ) ; } if ( streq_ptr ( fstype , "crypto_LUKS" ) ) { return resize_crypt_luks_device ( devno , fstype , main_devno ) ; } log_debug ( "Don't know how to resize %s of type %s, ignoring." , devpath , strnull ( fstype ) ) ; return 0 ; } 