char * gf_text_get_utf8_line ( char * szLine , u32 lineSize , FILE * txt_in , s32 unicode_type ) { u32 i , j , len ; char * sOK ; char szLineConv [ 2048 ] ; unsigned short * sptr ; memset ( szLine , 0 , sizeof ( char ) * lineSize ) ; sOK = gf_fgets ( szLine , lineSize , txt_in ) ; if ( ! sOK ) { return in ; } if ( unicode_type <= 1 ) { j = 0 ; len = ( u32 ) strlen ( szLine ) ; for ( i = 0 ; i < len ; i ++ ) { if ( ! unicode_type && ( szLine [ i ] & 0x80 ) ) { if ( ( szLine [ i + 1 ] & 0xc0 ) != 0x80 ) { if ( j >= GF_ARRAY_LENGTH ( szLineConv ) ) { break ; } szLineConv [ j ] = 0xc0 | ( ( szLine [ i ] >> 6 ) & 0x3 ) ; j ++ ; szLine [ i ] &= 0xbf ; } if ( ( szLine [ i ] & 0xe0 ) == 0xc0 ) { if ( j >= GF_ARRAY_LENGTH ( szLineConv ) ) { break ; } szLineConv [ j ] = szLine [ i ] ; i ++ ; j ++ ; } if ( ( szLine [ i ] & 0xf0 ) == 0xe0 ) { if ( j + 1 >= GF_ARRAY_LENGTH ( szLineConv ) ) { break ; } szLineConv [ j ] = szLine [ i ] ; i ++ ; j ++ ; szLineConv [ j ] = szLine [ i ] ; i ++ ; j ++ ; } if ( ( szLine [ i ] & 0xf8 ) == 0xf0 ) { if ( j + 2 >= GF_ARRAY_LENGTH ( szLineConv ) ) { break ; } szLineConv [ j ] = szLine [ i ] ; i ++ ; j ++ ; szLineConv [ j ] = szLine [ i ] ; i ++ ; j ++ ; szLineConv [ j ] = szLine [ i ] ; i ++ ; j ++ ; } else { i += 1 ; continue ; } } if ( j >= GF_ARRAY_LENGTH ( szLineConv ) ) { break ; } szLineConv [ j ] = szLine [ i ] ; j ++ ; } if ( j >= GF_ARRAY_LENGTH ( szLineConv ) ) { GF_LOG ( GF_LOG_DEBUG , GF_LOG_PARSER , ( "[TXTIn] Line too long to convert to utf8 (len: %d)\n" , len ) ) ; j = GF_ARRAY_LENGTH ( szLineConv ) - 1 ; } szLineConv [ j ] = 0 ; strcpy ( szLine , szLineConv ) ; return sOK ; } if ( unicode_type == 3 ) { if ( unicode_type == 2 ) { i = 0 ; while ( 1 ) { char c ; if ( ! szLine [ i ] && ! szLine [ i + 1 ] ) { break ; } c = szLine [ i + 1 ] ; szLine [ i + 1 ] = szLine [ i ] ; szLine [ i ] = c ; i += 2 ; } } } sptr = ( u16 * ) szLine ; i = gf_utf8_wcstombs ( szLineConv , 2048 , ( const unsigned short * * ) & sptr ) ; if ( i == GF_UTF8_FAIL ) { i = 0 ; } szLineConv [ i ] = 0 ; strcpy ( szLine , szLineConv ) ; if ( unicode_type == 3 ) { gf_fgetc ( txt_in ) ; } return sOK ; } 