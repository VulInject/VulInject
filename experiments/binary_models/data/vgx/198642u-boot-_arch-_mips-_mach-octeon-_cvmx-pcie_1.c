static void __cvmx_pcie_rc_initialize_config_space ( int node , int pcie_port ) { { cvmx_pciercx_cfg030_t pciercx_cfg030 ; pciercx_cfg030 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG030 ( pcie_port ) ) ; pciercx_cfg030 . s . mps = MPS_CN6XXX ; pciercx_cfg030 . s . mrrs = MRRS_CN6XXX ; pciercx_cfg030 . s . ro_en = 1 ; pciercx_cfg030 . s . ns_en = 1 ; pciercx_cfg030 . s . ce_en = 1 ; pciercx_cfg030 . s . nfe_en = 1 ; pciercx_cfg030 . s . fe_en = 1 ; pciercx_cfg030 . s . ur_en = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG030 ( pcie_port ) , pciercx_cfg030 . u32 ) ; } cvmx_dpi_sli_prtx_cfg_t prt_cfg ; cvmx_sli_s2m_portx_ctl_t sli_s2m_portx_ctl ; prt_cfg . u64 = CVMX_READ_CSR ( CVMX_DPI_SLI_PRTX_CFG ( pcie_port ) ) ; prt_cfg . s . mps = MPS_CN6XXX ; prt_cfg . s . mrrs = MRRS_CN6XXX ; prt_cfg . s . molr = 32 ; CVMX_WRITE_CSR ( CVMX_DPI_SLI_PRTX_CFG ( pcie_port ) , prt_cfg . u64 ) ; sli_s2m_portx_ctl . u64 = CVMX_READ_CSR ( CVMX_PEXP_SLI_S2M_PORTX_CTL ( pcie_port ) ) ; if ( ! ( OCTEON_IS_MODEL ( OCTEON_CN78XX ) || OCTEON_IS_MODEL ( OCTEON_CN73XX ) || OCTEON_IS_MODEL ( OCTEON_CNF75XX ) ) ) { sli_s2m_portx_ctl . cn61xx . mrrs = MRRS_CN6XXX ; } CVMX_WRITE_CSR ( CVMX_PEXP_SLI_S2M_PORTX_CTL ( pcie_port ) , sli_s2m_portx_ctl . u64 ) ; { cvmx_pciercx_cfg070_t pciercx_cfg070 ; pciercx_cfg070 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG070 ( pcie_port ) ) ; pciercx_cfg070 . s . ge = 1 ; pciercx_cfg070 . s . ce = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG070 ( pcie_port ) , pciercx_cfg070 . u32 ) ; } { cvmx_pciercx_cfg001_t pciercx_cfg001 ; pciercx_cfg001 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG001 ( pcie_port ) ) ; pciercx_cfg001 . s . msae = 1 ; pciercx_cfg001 . s . me = 1 ; pciercx_cfg001 . s . i_dis = 1 ; pciercx_cfg001 . s . see = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG001 ( pcie_port ) , pciercx_cfg001 . u32 ) ; } CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG066 ( pcie_port ) , 0 ) ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG069 ( pcie_port ) , 0 ) ; { cvmx_pciercx_cfg032_t pciercx_cfg032 ; pciercx_cfg032 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG032 ( pcie_port ) ) ; pciercx_cfg032 . s . aslpc = 0 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG032 ( pcie_port ) , pciercx_cfg032 . u32 ) ; } { cvmx_pciercx_cfg006_t pciercx_cfg006 ; pciercx_cfg006 . s . pbnum = cvmx_primary_pcie_bus_number ; pciercx_cfg006 . s . sbnum = cvmx_primary_pcie_bus_number ; pciercx_cfg006 . s . subbnum = cvmx_primary_pcie_bus_number ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG006 ( pcie_port ) , pciercx_cfg006 . u32 ) ; } { cvmx_pciercx_cfg008_t pciercx_cfg008 ; pciercx_cfg008 . u32 = 0 ; pciercx_cfg008 . s . mb_addr = 0x100 ; pciercx_cfg008 . s . ml_addr = 0 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG008 ( pcie_port ) , pciercx_cfg008 . u32 ) ; } { cvmx_pciercx_cfg009_t pciercx_cfg009 ; cvmx_pciercx_cfg010_t pciercx_cfg010 ; cvmx_pciercx_cfg011_t pciercx_cfg011 ; pciercx_cfg009 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG009 ( pcie_port ) ) ; pciercx_cfg010 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG010 ( pcie_port ) ) ; pciercx_cfg011 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG011 ( pcie_port ) ) ; pciercx_cfg009 . s . lmem_base = 0x100 ; pciercx_cfg009 . s . lmem_limit = 0 ; pciercx_cfg010 . s . umem_base = 0x100 ; pciercx_cfg011 . s . umem_limit = 0 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG009 ( pcie_port ) , pciercx_cfg009 . u32 ) ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG010 ( pcie_port ) , pciercx_cfg010 . u32 ) ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG011 ( pcie_port ) , pciercx_cfg011 . u32 ) ; } { cvmx_pciercx_cfg035_t pciercx_cfg035 ; pciercx_cfg035 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG035 ( pcie_port ) ) ; pciercx_cfg035 . s . secee = 1 ; pciercx_cfg035 . s . sefee = 1 ; pciercx_cfg035 . s . senfee = 1 ; pciercx_cfg035 . s . pmeie = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG035 ( pcie_port ) , pciercx_cfg035 . u32 ) ; } { cvmx_pciercx_cfg075_t pciercx_cfg075 ; pciercx_cfg075 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG075 ( pcie_port ) ) ; pciercx_cfg075 . s . cere = 1 ; pciercx_cfg075 . s . nfere = 1 ; pciercx_cfg075 . s . fere = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG075 ( pcie_port ) , pciercx_cfg075 . u32 ) ; } { cvmx_pciercx_cfg034_t pciercx_cfg034 ; pciercx_cfg034 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG034 ( pcie_port ) ) ; pciercx_cfg034 . s . hpint_en = 1 ; pciercx_cfg034 . s . dlls_en = 1 ; pciercx_cfg034 . s . ccint_en = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG034 ( pcie_port ) , pciercx_cfg034 . u32 ) ; } if ( OCTEON_IS_MODEL ( OCTEON_CN78XX ) || OCTEON_IS_MODEL ( OCTEON_CN73XX ) || OCTEON_IS_MODEL ( OCTEON_CNF75XX ) ) { int qlm = __cvmx_pcie_get_qlm ( node , pcie_port ) ; int speed = cvmx_qlm_get_gbaud_mhz ( qlm ) ; cvmx_pemx_cfg_t pem_cfg ; cvmx_pciercx_cfg031_t cfg031 ; cvmx_pciercx_cfg040_t cfg040 ; cvmx_pciercx_cfg452_t cfg452 ; cvmx_pciercx_cfg089_t cfg089 ; cvmx_pciercx_cfg090_t cfg090 ; cvmx_pciercx_cfg091_t cfg091 ; cvmx_pciercx_cfg092_t cfg092 ; cvmx_pciercx_cfg554_t cfg554 ; switch ( speed ) { case 2500 : pem_cfg . u64 = CVMX_READ_CSR ( CVMX_PEMX_CFG ( pcie_port ) ) ; pem_cfg . s . md = 0 ; CVMX_WRITE_CSR ( CVMX_PEMX_CFG ( pcie_port ) , pem_cfg . u64 ) ; cfg040 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG040 ( pcie_port ) ) ; cfg040 . s . tls = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG040 ( pcie_port ) , cfg040 . u32 ) ; break ; case 5000 : pem_cfg . u64 = CVMX_READ_CSR ( CVMX_PEMX_CFG ( pcie_port ) ) ; pem_cfg . s . md = 1 ; CVMX_WRITE_CSR ( CVMX_PEMX_CFG ( pcie_port ) , pem_cfg . u64 ) ; cfg040 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG040 ( pcie_port ) ) ; cfg040 . s . tls = 2 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG040 ( pcie_port ) , cfg040 . u32 ) ; break ; case 8000 : pem_cfg . u64 = CVMX_READ_CSR ( CVMX_PEMX_CFG ( pcie_port ) ) ; pem_cfg . s . md = 2 ; CVMX_WRITE_CSR ( CVMX_PEMX_CFG ( pcie_port ) , pem_cfg . u64 ) ; cfg040 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG040 ( pcie_port ) ) ; cfg040 . s . tls = 3 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG040 ( pcie_port ) , cfg040 . u32 ) ; break ; default : break ; } pem_cfg . u64 = CVMX_READ_CSR ( CVMX_PEMX_CFG ( pcie_port ) ) ; cfg452 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG452 ( pcie_port ) ) ; if ( qlm >= 5 ) { cfg452 . s . lme = 0x3 ; } else { cfg452 . s . lme = ( pem_cfg . cn78xx . lanes8 ) ?0xf : 0x7 ; } CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG452 ( pcie_port ) , cfg452 . u32 ) ; cfg031 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG031 ( pcie_port ) ) ; cfg031 . s . aslpms = 0 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG031 ( pcie_port ) , cfg031 . u32 ) ; cfg554 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG554 ( pcie_port ) ) ; cfg554 . s . prv = pcie_preset_vec [ pcie_port ] ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG554 ( pcie_port ) , cfg554 . u32 ) ; cfg554 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG554 ( pcie_port ) ) ; cfg554 . s . p23td = 1 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG554 ( pcie_port ) , cfg554 . u32 ) ; cfg089 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG089 ( pcie_port ) ) ; cfg089 . s . l1ddtp = 7 ; cfg089 . s . l1utp = 7 ; cfg089 . s . l0dtp = 7 ; cfg089 . s . l0utp = 7 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG089 ( pcie_port ) , cfg089 . u32 ) ; cfg090 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG090 ( pcie_port ) ) ; cfg090 . s . l3dtp = 7 ; cfg090 . s . l3utp = 7 ; cfg090 . s . l2dtp = 7 ; cfg090 . s . l2utp = 7 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG090 ( pcie_port ) , cfg090 . u32 ) ; cfg091 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG091 ( pcie_port ) ) ; cfg091 . s . l5dtp = 7 ; cfg091 . s . l5utp = 7 ; cfg091 . s . l4dtp = 7 ; cfg091 . s . l4utp = 7 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG091 ( pcie_port ) , cfg091 . u32 ) ; cfg092 . u32 = CVMX_PCIE_CFGX_READ ( pcie_port , CVMX_PCIERCX_CFG092 ( pcie_port ) ) ; cfg092 . s . l7dtp = 7 ; cfg092 . s . l7utp = 7 ; cfg092 . s . l6dtp = 7 ; cfg092 . s . l6utp = 7 ; CVMX_PCIE_CFGX_WRITE ( pcie_port , CVMX_PCIERCX_CFG092 ( pcie_port ) , cfg092 . u32 ) ; } } 