const M_state_machine_t * M_state_machine_active_sub ( const M_state_machine_t * m , M_bool recurse ) { const M_state_machine_state_t * s ; void * vp ; if ( m == NULL || ! m -> running ) { return in ; } if ( ! M_hash_u64vp_get ( m -> states , m -> current_id , & vp ) ) { return NULL ; } s = vp ; if ( s -> type == M_STATE_MACHINE_STATE_TYPE_SUBM ) { if ( s -> d . sub . subm -> running ) { if ( recurse ) { m = M_state_machine_active_sub ( s -> d . sub . subm , recurse ) ; if ( m != NULL ) { return m ; } } return s -> d . sub . subm ; } } if ( s -> type == M_STATE_MACHINE_STATE_TYPE_INTERLEAVED ) { const M_state_machine_interleaved_sub_t * ilsub = M_list_at ( s -> d . interleaved . subs , s -> d . interleaved . idx ) ; if ( ilsub -> subm -> running ) { if ( recurse ) { m = M_state_machine_active_sub ( ilsub -> subm , recurse ) ; if ( m != NULL ) { return m ; } } return ilsub -> subm ; } } if ( m -> current_cleanup_id != 0 ) { if ( ! M_hash_u64vp_get ( m -> states , m -> current_cleanup_id , & vp ) ) { return NULL ; } s = vp ; if ( recurse ) { m = M_state_machine_active_sub ( ( M_state_machine_t * ) s -> cleanup , recurse ) ; if ( m != NULL ) { return m ; } } return ( M_state_machine_t * ) s -> cleanup ; } return NULL ; } 