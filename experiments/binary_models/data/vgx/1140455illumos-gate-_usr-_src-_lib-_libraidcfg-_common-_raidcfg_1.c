static int obj_array_complist ( raid_obj_tab_t * raid_tab , raid_obj_id_t obj_id , int comp_num , raid_obj_id_t * comp_list , raid_obj_type_id_t comp_type ) { array_attr_t * attr ; controller_attr_t * ctl_attrp ; raid_obj_id_t controller_obj_id ; raid_lib_t * raid_lib ; int ret , i , fd ; uint32_t * ids ; if ( raid_obj_get_type ( raid_tab , obj_id ) != OBJ_TYPE_ARRAY ) { return ( ERR_DEVICE_TYPE ) ; } if ( comp_type != OBJ_TYPE_ARRAY_PART && comp_type != OBJ_TYPE_ARRAY && comp_type != OBJ_TYPE_TASK ) { return ( 0 ) ; } if ( comp_num <= 0 || comp_list == NULL ) { return ( ERR_OP_ILLEGAL ) ; } for ( i = 0 ; i < comp_num ; ++ i ) { if ( raid_obj_get_type ( raid_tab , * ( comp_list + i ) ) != comp_type ) { return ( ERR_DEVICE_TYPE ) ; } } attr = raid_obj_get_data_ptr ( raid_tab , obj_id ) ; if ( attr == NULL ) { return ( ERR_DEVICE_INVALID ) ; } controller_obj_id = obj_get_controller ( raid_tab , obj_id ) ; if ( controller_obj_id < OBJ_NONE ) { return ( ERR_DEVICE_INVALID ) ; } ctl_attrp = raid_obj_get_data_ptr ( raid_tab , controller_obj_id ) ; if ( ctl_attrp == NULL ) { return ( ERR_DEVICE_INVALID ) ; } raid_lib = raid_obj_get_lib ( raid_tab , controller_obj_id ) ; fd = raid_obj_get_fd ( raid_tab , controller_obj_id ) ; if ( ( raid_lib == NULL ) || ( fd == 0 ) ) { return ( ERR_DRIVER_CLOSED ) ; } ids = malloc ( comp_num * sizeof ( uint32_t ) ) ; if ( ids == NULL ) { return ( ERR_NOMEM ) ; } ret = raid_lib -> complist ( ctl_attrp -> controller_id , attr -> array_id , OBJ_TYPE_ARRAY , comp_type , comp_num , ids ) ; if ( ret < SUCCESS ) { return ( ret ) ; } for ( i = 0 ; i < comp_num ; ++ i ) { array_attr_t * array_attr ; arraypart_attr_t * arraypart_attr ; task_attr_t * task_attr ; void * attr_buf ; attr_buf = raid_obj_get_data_ptr ( raid_tab , * ( comp_list + i ) ) ; if ( attr_buf == NULL ) { free ( ids ) ; return ( ERR_DEVICE_INVALID ) ; } switch ( comp_type ) { case OBJ_TYPE_ARRAY : array_attr = attr_buf ; array_attr -> array_id = * ( ids + i ) ; break ; case OBJ_TYPE_ARRAY_PART : arraypart_attr = attr_buf ; arraypart_attr -> disk_id = * ( ids + i ) ; break ; case OBJ_TYPE_TASK : task_attr = attr_buf ; task_attr -> task_id = * ( ids + i ) ; break ; default : free ( ids ) ; return ( ERR_DEVICE_INVALID ) ; } } free ( ids ) ; return ( ret ) ; } 