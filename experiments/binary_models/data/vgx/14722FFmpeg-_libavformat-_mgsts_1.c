static int read_header ( AVFormatContext * s ) { AVIOContext * pb = s -> pb ; AVStream * st ; AVRational fps ; uint32_t chunk_size ; avio_skip ( pb , 4 ) ; chunk_size = avio_rb32 ( pb ) ; avio_skip ( pb , 20 ) ; st = avformat_new_stream ( s , 0 ) ; if ( ! st ) { return AVERROR ( ENOMEM ) ; } ffstream ( st ) -> need_parsing = AVSTREAM_PARSE_HEADERS ; st -> start_time = 0 ; st -> nb_frames = st -> duration = avio_rb32 ( pb ) ; fps = av_d2q ( av_int2float ( avio_rb32 ( pb ) ) , INT_MAX ) ; st -> codecpar -> width = avio_rb32 ( pb ) ; st -> codecpar -> height = avio_rb32 ( pb ) ; avio_skip ( pb , 12 ) ; st -> codecpar -> codec_type = AVMEDIA_TYPE_VIDEO ; st -> codecpar -> codec_tag = avio_rb32 ( pb ) ; st -> codecpar -> codec_id = ff_codec_get_id ( ff_codec_bmp_tags , st -> codecpar -> codec_tag ) ; avpriv_set_pts_info ( st , 64 , fps . den , fps . num ) ; avio_skip ( pb , 20 ) ; return 0 ; } 