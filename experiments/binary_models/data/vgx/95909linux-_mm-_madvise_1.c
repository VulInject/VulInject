static int madvise_cold_or_pageout_pte_range ( pmd_t * pmd , unsigned long addr , unsigned long end , struct mm_walk * walk ) { struct madvise_walk_private * walk -> private ; ; struct mmu_gather * tlb = private -> tlb ; bool pageout = private -> pageout ; struct mm_struct * mm = tlb -> mm ; struct vm_area_struct * vma = walk -> vma ; pte_t * orig_pte , * pte , ptent ; spinlock_t * ptl ; struct folio * folio = NULL ; LIST_HEAD ( folio_list ) ; bool pageout_anon_only_filter ; if ( fatal_signal_pending ( current ) ) { return - EINTR ; } pageout_anon_only_filter = pageout && ! vma_is_anonymous ( vma ) && ! can_do_file_pageout ( vma ) ; if ( pmd_trans_huge ( * pmd ) ) { pmd_t orig_pmd ; unsigned long next = pmd_addr_end ( addr , end ) ; tlb_change_page_size ( tlb , HPAGE_PMD_SIZE ) ; ptl = pmd_trans_huge_lock ( pmd , vma ) ; if ( ! ptl ) { return 0 ; } orig_pmd = * pmd ; if ( is_huge_zero_pmd ( orig_pmd ) ) { huge_unlock } if ( unlikely ( ! pmd_present ( orig_pmd ) ) ) { VM_BUG_ON ( thp_migration_supported ( ) && ! is_pmd_migration_entry ( orig_pmd ) ) ; huge_unlock } folio = pfn_folio ( pmd_pfn ( orig_pmd ) ) ; if ( folio_mapcount ( folio ) != 1 ) { huge_unlock } if ( pageout_anon_only_filter && ! folio_test_anon ( folio ) ) { huge_unlock } if ( next - addr != HPAGE_PMD_SIZE ) { int err ; folio_get ( folio ) ; spin_unlock ( ptl ) ; folio_lock ( folio ) ; err = split_folio ( folio ) ; folio_unlock ( folio ) ; folio_put ( folio ) ; if ( ! err ) { regular_folio } return 0 ; } if ( pmd_young ( orig_pmd ) ) { pmdp_invalidate ( vma , addr , pmd ) ; orig_pmd = pmd_mkold ( orig_pmd ) ; set_pmd_at ( mm , addr , pmd , orig_pmd ) ; tlb_remove_pmd_tlb_entry ( tlb , pmd , addr ) ; } folio_clear_referenced ( folio ) ; folio_test_clear_young ( folio ) ; if ( pageout ) { if ( folio_isolate_lru ( folio ) ) { if ( folio_test_unevictable ( folio ) ) { folio_putback_lru ( folio ) ; } else { list_add ( & folio -> lru , & folio_list ) ; } } } else { folio_deactivate ( folio ) ; } huge_unlock spin_unlock ( ptl ) ; if ( pageout ) { reclaim_pages ( & folio_list ) ; } return 0 ; } regular_folio tlb_change_page_size ( tlb , PAGE_SIZE ) ; orig_pte = pte = pte_offset_map_lock ( vma -> vm_mm , pmd , addr , & ptl ) ; flush_tlb_batched_pending ( mm ) ; arch_enter_lazy_mmu_mode ( ) ; for ( ; addr < end ; pte ++ , addr += PAGE_SIZE ) { ptent = * pte ; if ( pte_none ( ptent ) ) { continue ; } if ( ! pte_present ( ptent ) ) { continue ; } folio = vm_normal_folio ( vma , addr , ptent ) ; if ( ! folio || folio_is_zone_device ( folio ) ) { continue ; } if ( folio_test_large ( folio ) ) { if ( folio_mapcount ( folio ) != 1 ) { break ; } if ( pageout_anon_only_filter && ! folio_test_anon ( folio ) ) { break ; } folio_get ( folio ) ; if ( ! folio_trylock ( folio ) ) { folio_put ( folio ) ; break ; } pte_unmap_unlock ( orig_pte , ptl ) ; if ( split_folio ( folio ) ) { folio_unlock ( folio ) ; folio_put ( folio ) ; orig_pte = pte_offset_map_lock ( mm , pmd , addr , & ptl ) ; break ; } folio_unlock ( folio ) ; folio_put ( folio ) ; orig_pte = pte = pte_offset_map_lock ( mm , pmd , addr , & ptl ) ; pte -- ; addr -= PAGE_SIZE ; continue ; } if ( ! folio_test_lru ( folio ) || folio_mapcount ( folio ) != 1 ) { continue ; } if ( pageout_anon_only_filter && ! folio_test_anon ( folio ) ) { continue ; } VM_BUG_ON_FOLIO ( folio_test_large ( folio ) , folio ) ; if ( pte_young ( ptent ) ) { ptent = ptep_get_and_clear_full ( mm , addr , pte , tlb -> fullmm ) ; ptent = pte_mkold ( ptent ) ; set_pte_at ( mm , addr , pte , ptent ) ; tlb_remove_tlb_entry ( tlb , pte , addr ) ; } folio_clear_referenced ( folio ) ; folio_test_clear_young ( folio ) ; if ( pageout ) { if ( folio_isolate_lru ( folio ) ) { if ( folio_test_unevictable ( folio ) ) { folio_putback_lru ( folio ) ; } else { list_add ( & folio -> lru , & folio_list ) ; } } } else { folio_deactivate ( folio ) ; } } arch_leave_lazy_mmu_mode ( ) ; pte_unmap_unlock ( orig_pte , ptl ) ; if ( pageout ) { reclaim_pages ( & folio_list ) ; } cond_resched ( ) ; return 0 ; } 