int fld_client_add_target ( struct lu_client_fld * fld , struct lu_fld_target * tar ) { const char * name ; struct lu_fld_target * target , * tmp ; LASSERT ( tar ) ; name = fld_target_name ( tar ) ; LASSERT ( name ) ; LASSERT ( tar -> ft_srv || tar -> ft_exp ) ; CDEBUG ( D_INFO , "%s: Adding target %s (idx %llu)\n" , fld -> lcf_name , name , tar -> ft_idx ) ; target = kmalloc ( sizeof ( * target ) , GFP_NOFS ) ; if ( ! target ) { return - ENOMEM ; } spin_lock ( & fld -> lcf_lock ) ; list_for_each_entry ( , , ) { if ( tmp -> ft_idx == tar -> ft_idx ) { spin_unlock ( & fld -> lcf_lock ) ; kfree ( target ) ; CERROR ( "Target %s exists in FLD and known as %s:#%llu\n" , name , fld_target_name ( tmp ) , tmp -> ft_idx ) ; return - EEXIST ; } } target -> ft_exp = tar -> ft_exp ; if ( target -> ft_exp ) { class_export_get ( target -> ft_exp ) ; } target -> ft_srv = tar -> ft_srv ; target -> ft_idx = tar -> ft_idx ; list_add_tail ( & target -> ft_chain , & fld -> lcf_targets ) ; fld -> lcf_count ++ ; spin_unlock ( & fld -> lcf_lock ) ; return 0 ; } 