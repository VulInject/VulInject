char * virSCSIHostFindByPCI ( const char * sysfs_prefix , const char * parentaddr , unsigned int unique_id ) { const char * prefix = sysfs_prefix ?sysfs_prefix : SYSFS_SCSI_HOST_PATH ; struct dirent * entry = NULL ; g_autoptr ( ) dir = NULL ; char * host_link = NULL ; char * host_path = NULL ; char * p = NULL ; char * ret = NULL ; char * buf ; char * unique_path = NULL ; unsigned int read_unique_id ; if ( virDirOpen ( & dir , prefix ) < 0 ) { return NULL ; } while ( virDirRead ( dir , & entry , prefix ) > 0 ) { if ( ! virFileIsLink ( entry -> d_name ) ) { continue ; } host_link = g_strdup_printf ( "%s/%s" , prefix , entry -> d_name ) ; if ( virFileResolveLink ( host_link , & host_path ) < 0 ) { cleanup } if ( ! strstr ( host_path , parentaddr ) ) { VIR_FREE ( host_link ) ; VIR_FREE ( host_path ) ; continue ; } VIR_FREE ( host_link ) ; VIR_FREE ( host_path ) ; unique_path = g_strdup_printf ( "%s/%s/unique_id" , prefix , entry -> d_name ) ; if ( ! virFileExists ( unique_path ) ) { VIR_FREE ( unique_path ) ; continue ; } if ( virFileReadAll ( unique_path , 1024 , & buf ) < 0 ) { cleanup } if ( ( p = strchr ( buf , '\n' ) ) ) { * p = '\0' ; } if ( virStrToLong_ui ( buf , NULL , 10 , & read_unique_id ) < 0 ) { cleanup } VIR_FREE ( buf ) ; if ( read_unique_id != unique_id ) { VIR_FREE ( unique_path ) ; continue ; } ret = g_strdup ( entry -> d_name ) ; break ; } cleanup VIR_FREE ( unique_path ) ; VIR_FREE ( host_link ) ; VIR_FREE ( host_path ) ; VIR_FREE ( buf ) ; return ret ; } 