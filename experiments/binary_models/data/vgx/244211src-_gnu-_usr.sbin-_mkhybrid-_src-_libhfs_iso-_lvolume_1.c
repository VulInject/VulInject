int v_allocblocks ( hfsvol * vol , ExtDescriptor * blocks ) { unsigned int request , found , foundat , start , end , pt ; block * vbm ; int wrap ; if ( vol -> mdb . drFreeBks == 0 ) { ERROR ( ENOSPC , "volume full" ) ; return - 1 ; } request = blocks -> xdrNumABlks ; found = 0 ; foundat = 0 ; start = vol -> mdb . drAllocPtr ; end = vol -> mdb . drNmAlBlks ; pt = start ; vbm = vol -> vbm ; if ( request == 0 ) { abort ( ) ; } while ( 1 ) { unsigned int mark ; while ( pt < end && BMTST ( vbm , pt ) ) { ++ pt ; } if ( wrap && pt >= start ) { break ; } mark = pt ; while ( pt < end && pt - mark < request && ! BMTST ( vbm , pt ) ) { ++ pt ; } if ( pt - mark > found ) { found = pt - mark ; foundat = mark ; } if ( pt == end ) { pt = 0 , wrap = 1 ; } if ( found == request ) { break ; } } if ( found == 0 || found > vol -> mdb . drFreeBks ) { ERROR ( EIO , "bad volume bitmap or free block count" ) ; return - 1 ; } blocks -> xdrStABN = foundat ; blocks -> xdrNumABlks = found ; vol -> mdb . drAllocPtr = pt ; vol -> mdb . drFreeBks -= found ; for ( pt = foundat ; pt < foundat + found ; ++ pt ) { BMSET ( vbm , pt ) ; } vol -> flags |= HFS_UPDATE_MDB | HFS_UPDATE_VBM ; return 0 ; } 