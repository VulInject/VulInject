void move_cache_to_base_index ( struct index_state * istate ) { struct split_index * si = istate -> split_index ; int i ; if ( si -> base && si -> base -> ce_mem_pool ) { if ( ! istate -> ce_mem_pool ) { istate -> ce_mem_pool = xmalloc ( sizeof ( mem_pool ) ) ; mem_pool_init ( istate -> ce_mem_pool , 0 ) ; } mem_pool_combine ( istate -> ce_mem_pool , istate -> split_index -> base -> ce_mem_pool ) ; } ALLOC_ARRAY ( si -> base , 1 ) ; index_state_init ( si -> base , istate -> repo ) ; si -> base -> version = istate -> version ; si -> base -> timestamp = istate -> timestamp ; ALLOC_GROW ( si -> base -> cache , istate -> cache_nr , si -> base -> cache_alloc ) ; si -> base -> cache_nr = istate -> cache_nr ; si -> base -> ce_mem_pool = istate -> ce_mem_pool ; istate -> ce_mem_pool = NULL ; COPY_ARRAY ( si -> base -> cache , istate -> cache , istate -> cache_nr ) ; mark_base_index_entries ( si -> base , NULL ) ; for ( i = 0 ; i < si -> base -> cache_nr ; i ++ ) { si -> base -> cache [ i ] -> ce_flags &= ~ CE_UPDATE_IN_BASE ; } } 