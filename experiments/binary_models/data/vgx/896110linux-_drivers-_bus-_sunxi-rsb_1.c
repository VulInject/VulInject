static int sunxi_rsb_read ( struct sunxi_rsb * rsb , u8 rtaddr , u8 addr , u32 * buf , size_t len ) { u32 cmd ; int ret ; switch ( len ) { case 1 : cmd = RSB_CMD_RD8 ; break ; case 2 : cmd = RSB_CMD_RD16 ; break ; case 4 : cmd = RSB_CMD_RD32 ; break ; default : dev_err ( rsb -> dev , "Invalid access width: %zd\n" , len ) ; return - EINVAL ; } ret = pm_runtime_resume_and_get ( rsb -> dev ) ; if ( ret ) { return ret ; } mutex_lock ( & rsb -> lock ) ; writel ( addr , rsb -> regs + RSB_ADDR ) ; writel ( RSB_DAR_RTA ( rtaddr ) , rsb -> regs + RSB_DAR ) ; writel ( cmd , rsb -> regs + RSB_CMD ) ; ret = _sunxi_rsb_run_xfer ( rsb ) ; if ( ret ) { unlock } * buf = readl ( rsb -> regs + RSB_DATA ) & GENMASK ( len * 8 - 1 , 0 ) ; unlock mutex_unlock ( & rsb -> lock ) ; pm_runtime_mark_last_busy ( rsb -> dev ) ; pm_runtime_put_autosuspend ( rsb -> dev ) ; return ret ; } 