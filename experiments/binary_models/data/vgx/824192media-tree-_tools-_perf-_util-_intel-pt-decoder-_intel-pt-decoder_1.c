static int intel_pt_pkt_lookahead ( struct intel_pt_decoder * decoder , intel_pt_pkt_cb_t cb , void * data ) { struct intel_pt_pkt_info pkt_info ; const unsigned char * buf = decoder -> buf ; size_t len = decoder -> len ; int ret ; pkt_info . decoder = decoder ; pkt_info . pos = decoder -> pos ; pkt_info . pkt_len = decoder -> pkt_step ; pkt_info . last_packet_type = decoder -> last_packet_type ; pkt_info . data = data ; while ( 1 ) { { pkt_info . pos += pkt_info . pkt_len ; buf += pkt_info . pkt_len ; len -= pkt_info . pkt_len ; ret = intel_pt_get_packet ( buf , len , & pkt_info . packet ) ; if ( ! ret ) { return INTEL_PT_NEED_MORE_BYTES ; } if ( ret < 0 ) { return ret ; } pkt_info . pkt_len = ret ; } pkt_info . packet . type == INTEL_PT_PAD ; ret = cb ( & pkt_info ) ; if ( ret ) { return 0 ; } pkt_info . last_packet_type = pkt_info . packet . type ; } } 