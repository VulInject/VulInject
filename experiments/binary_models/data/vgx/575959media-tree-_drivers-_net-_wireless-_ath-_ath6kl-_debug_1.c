static ssize_t read_file_credit_dist_stats ( struct file * file , char __user * user_buf , size_t count , loff_t * ppos ) { struct ath6kl * ar = file -> private_data ; struct htc_target * target = ar -> htc_target ; struct htc_endpoint_credit_dist * ep_list ; char * buf ; unsigned int buf_len , len = 0 ; ssize_t ret_cnt ; buf_len = CREDIT_INFO_DISPLAY_STRING_LEN + get_queue_depth ( & target -> cred_dist_list ) * CREDIT_INFO_LEN ; buf = kmalloc ( buf_len , GFP_KERNEL ) ; if ( ! buf ) { return - ENOMEM ; } len += scnprintf ( buf + len , buf_len - len , "%25s%5d\n" , "Total Avail Credits: " , target -> credit_info -> total_avail_credits ) ; len += scnprintf ( buf + len , buf_len - len , "%25s%5d\n" , "Free credits :" , target -> credit_info -> cur_free_credits ) ; len += scnprintf ( buf + len , buf_len - len , " Epid  Flags    Cred_norm  Cred_min  Credits  Cred_assngd" "  Seek_cred  Cred_sz  Cred_per_msg  Cred_to_dist" "  qdepth\n" ) ; list_for_each_entry ( , , ) { print_credit_info ( "  %2d" , endpoint ) ; print_credit_info ( "%10x" , dist_flags ) ; print_credit_info ( "%8d" , cred_norm ) ; print_credit_info ( "%9d" , cred_min ) ; print_credit_info ( "%9d" , credits ) ; print_credit_info ( "%10d" , cred_assngd ) ; print_credit_info ( "%13d" , seek_cred ) ; print_credit_info ( "%12d" , cred_sz ) ; print_credit_info ( "%9d" , cred_per_msg ) ; print_credit_info ( "%14d" , cred_to_dist ) ; len += scnprintf ( buf + len , buf_len - len , "%12d\n" , get_queue_depth ( & ep_list -> htc_ep -> txq ) ) ; } if ( len > buf_len ) { len = buf_len ; } ret_cnt = simple_read_from_buffer ( user_buf , count , ppos , buf , len ) ; kfree ( buf ) ; return ret_cnt ; } 