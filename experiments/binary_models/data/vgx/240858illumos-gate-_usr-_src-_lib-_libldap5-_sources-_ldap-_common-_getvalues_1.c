static int parse_subtypes ( const char * target , int * baseLenp , char * * langp , _SubStringIndex * * subs , int * nsubtypes ) { int nSubtypes = 0 ; int ind = 0 ; char * nextToken ; _SubStringIndex * result = NULL ; int langIndex ; int targetLen ; int subtypeStart ; langIndex = LANG_SUBTYPE_INDEX_NONE ; * subs = NULL ; * langp = NULL ; * baseLenp = 0 ; * nsubtypes = 0 ; targetLen = strlen ( target ) ; nextToken = strchr ( target , ';' ) ; if ( NULL != nextToken ) { subtypeStart = nextToken - target + 1 ; * baseLenp = subtypeStart - 1 ; } else { subtypeStart = targetLen ; * baseLenp = subtypeStart ; } ind = subtypeStart ; nextToken = ( char * ) target + subtypeStart ; while ( nextToken && * nextToken ) { char * thisToken = nextToken ; nextToken = strchr ( thisToken , ';' ) ; if ( NULL != nextToken ) { nextToken ++ ; } if ( 0 == strncasecmp ( thisToken , "lang-" , 5 ) ) { if ( langIndex != LANG_SUBTYPE_INDEX_NONE ) { langIndex = LANG_SUBTYPE_INDEX_DUPLICATE ; return langIndex ; } else { langIndex = nSubtypes ; } } else { nSubtypes ++ ; } } if ( nSubtypes > 0 ) { result = ( _SubStringIndex * ) NSLDAPI_MALLOC ( sizeof ( * result ) * nSubtypes ) ; if ( result == NULL ) { return LANG_SUBTYPE_INDEX_NONE ; } memset ( result , 0 , sizeof ( * result ) * nSubtypes ) ; } ind = 0 ; nSubtypes = 0 ; ind = subtypeStart ; nextToken = ( char * ) target + subtypeStart ; while ( nextToken && * nextToken ) { char * thisToken = nextToken ; int len ; nextToken = strchr ( thisToken , ';' ) ; if ( NULL != nextToken ) { len = nextToken - thisToken ; nextToken ++ ; } else { nextToken = ( char * ) target + targetLen ; len = nextToken - thisToken ; } if ( 0 == strncasecmp ( thisToken , "lang-" , 5 ) ) { int i ; * langp = ( char * ) NSLDAPI_MALLOC ( len + 1 ) ; if ( * langp == NULL ) { if ( result != NULL ) { NSLDAPI_FREE ( result ) ; } return LANG_SUBTYPE_INDEX_NONE ; } for ( i = 0 ; i < len ; i ++ ) { ( * langp ) [ i ] = toupper ( target [ ind + i ] ) ; } ( * langp ) [ len ] = 0 ; } else { result [ nSubtypes ] . start = thisToken - target ; result [ nSubtypes ] . length = len ; nSubtypes ++ ; } } * subs = result ; * nsubtypes = nSubtypes ; return langIndex ; } 