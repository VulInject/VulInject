int arch_setup_msi_irq ( struct pci_dev * pdev , struct msi_desc * desc ) { struct pci_controller * controller ; gxio_trio_context_t * trio_context ; struct msi_msg msg ; int default_irq ; uint64_t mem_map_base ; uint64_t mem_map_limit ; u64 msi_addr ; int mem_map ; int cpu ; int irq ; int ret ; irq = irq_alloc_hwirq ( - 1 ) ; if ( desc -> msi_attrib . is_64 == 0 ) { dev_info ( & pdev -> dev , "64-bit MSI message address not supported, falling back to legacy interrupts\n" ) ; ret = - ENOMEM ; is_64_failure } default_irq = desc -> msi_attrib . default_irq ; controller = irq_get_handler_data ( default_irq ) ; BUG_ON ( ! controller ) ; trio_context = controller -> trio ; mem_map = gxio_trio_alloc_scatter_queues ( trio_context , 1 , 0 , 0 ) ; if ( mem_map >= 0 ) { TRIO_MAP_SQ_DOORBELL_FMT_t doorbell_template = { { . pop = 0 . doorbell = 1 } } ; mem_map += TRIO_NUM_MAP_MEM_REGIONS ; mem_map_base = MEM_MAP_INTR_REGIONS_BASE + mem_map * MEM_MAP_INTR_REGION_SIZE ; mem_map_limit = mem_map_base + MEM_MAP_INTR_REGION_SIZE - 1 ; msi_addr = mem_map_base + MEM_MAP_INTR_REGION_SIZE - 8 ; msg . data = ( unsigned int ) doorbell_template . word ; } else { mem_map = gxio_trio_alloc_memory_maps ( trio_context , 1 , 0 , 0 ) ; if ( mem_map < 0 ) { dev_info ( & pdev -> dev , "%s Mem-Map alloc failure - failed to initialize MSI interrupts - falling back to legacy interrupts\n" , desc -> msi_attrib . is_msix ?"MSI-X" : "MSI" ) ; ret = - ENOMEM ; msi_mem_map_alloc_failure } mem_map_base = MEM_MAP_INTR_REGIONS_BASE + mem_map * MEM_MAP_INTR_REGION_SIZE ; mem_map_limit = mem_map_base + MEM_MAP_INTR_REGION_SIZE - 1 ; msi_addr = mem_map_base + TRIO_MAP_MEM_REG_INT3 - TRIO_MAP_MEM_REG_INT0 ; msg . data = mem_map ; } cpu = tile_irq_cpu ( irq ) ; ret = gxio_trio_config_msi_intr ( trio_context , cpu_x ( cpu ) , cpu_y ( cpu ) , KERNEL_PL , irq , controller -> mac , mem_map , mem_map_base , mem_map_limit , trio_context -> asid ) ; if ( ret < 0 ) { dev_info ( & pdev -> dev , "HV MSI config failed\n" ) ; hv_msi_config_failure } irq_set_msi_desc ( irq , desc ) ; msg . address_hi = msi_addr >> 32 ; msg . address_lo = msi_addr & 0xffffffff ; pci_write_msi_msg ( irq , & msg ) ; irq_set_chip_and_handler ( irq , & tilegx_msi_chip , handle_level_irq ) ; irq_set_handler_data ( irq , controller ) ; return 0 ; hv_msi_config_failure msi_mem_map_alloc_failure is_64_failure irq_free_hwirq ( irq ) ; return ret ; } 