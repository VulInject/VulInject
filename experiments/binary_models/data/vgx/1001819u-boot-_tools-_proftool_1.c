static int read_system_map ( FILE * fin ) { unsigned long offset , start = 0 ; struct func_info * func ; char buff [ MAX_LINE_LEN ] ; char symtype ; char symname [ MAX_LINE_LEN + 1 ] ; int linenum ; int alloced ; for ( linenum = 1 , alloced = func_count = 0 ; ; linenum ++ ) { int fields = 0 ; if ( fgets ( buff , sizeof ( buff ) , fin ) ) { fields = sscanf ( buff , "%lx %c %100s\n" , & offset , & symtype , symname ) ; } if ( fields == 2 ) { continue ; } if ( feof ( fin ) ) { break ; } if ( fields < 2 ) { error ( "Map file line %d: invalid format\n" , linenum ) ; return 1 ; } symtype = tolower ( symtype ) ; if ( symtype != 't' && symtype != 'w' ) { continue ; } if ( func_count == alloced ) { alloced += 256 ; func_list = realloc ( func_list , sizeof ( func_info ) * alloced ) ; } if ( ! func_count ) { start = offset ; } func = & func_list [ func_count ++ ] ; memset ( func , '\0' , sizeof ( * func ) ) ; func -> offset = offset - start ; func -> name = strdup ( symname ) ; func -> flags = FUNCF_TRACE ; if ( func_count > 1 ) { func [ - 1 ] . code_size = func -> offset - func [ - 1 ] . offset ; } } notice ( "%d functions found in map file, start addr %lx\n" , func_count , start ) ; text_offset = start ; return 0 ; } 