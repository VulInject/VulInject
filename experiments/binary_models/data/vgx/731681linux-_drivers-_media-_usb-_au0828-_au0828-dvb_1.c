static int start_urb_transfer ( struct au0828_dev * dev ) { struct urb * purb ; int i , ret ; dprintk ( 2 , "%s()\n" , __func__ ) ; if ( dev -> urb_streaming ) { dprintk ( 2 , "%s: bulk xfer already running!\n" , __func__ ) ; return 0 ; } for ( i = 0 ; i < URB_COUNT ; i ++ ) { dev -> urbs [ i ] = usb_alloc_urb ( 0 , GFP_KERNEL ) ; purb = dev -> urbs [ i ] ; if ( preallocate_big_buffers ) { purb -> transfer_buffer = dev -> dig_transfer_buffer [ i ] ; } else { purb -> transfer_buffer = kzalloc ( URB_BUFSIZE , GFP_KERNEL ) ; } if ( ! purb -> transfer_buffer ) { usb_free_urb ( purb ) ; dev -> urbs [ i ] = NULL ; ret = - ENOMEM ; pr_err ( "%s: failed big buffer allocation, err = %d\n" , __func__ , ret ) ; return ret ; } purb -> status = - EINPROGRESS ; usb_fill_bulk_urb ( purb , dev -> usbdev , usb_rcvbulkpipe ( dev -> usbdev , _AU0828_BULKPIPE ) , purb -> transfer_buffer , URB_BUFSIZE , urb_completion , dev ) ; } for ( i = 0 ; i < URB_COUNT ; i ++ ) { ret = usb_submit_urb ( dev -> urbs [ i ] , GFP_ATOMIC ) ; if ( ret != 0 ) { stop_urb_transfer ( dev ) ; pr_err ( "%s: failed urb submission, err = %d\n" , __func__ , ret ) ; return ret ; } } dev -> urb_streaming = true ; mod_timer ( & dev -> bulk_timeout , jiffies + ( HZ ) ) ; dev -> bulk_timeout_running = 1 ; return 0 ; } 