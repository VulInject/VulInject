int cfg80211_mlme_register_mgmt ( struct wireless_dev * wdev , u32 snd_portid , u16 frame_type , const u8 * match_data , int match_len ) { struct wiphy * wiphy = wdev -> wiphy ; struct cfg80211_registered_device * rdev = wiphy_to_rdev ( wiphy ) ; struct cfg80211_mgmt_registration * reg , * nreg ; int err = 0 ; u16 mgmt_type ; if ( ! wdev -> wiphy -> mgmt_stypes ) { return - EOPNOTSUPP ; } if ( ( frame_type & IEEE80211_FCTL_FTYPE ) != IEEE80211_FTYPE_MGMT ) { return - EINVAL ; } if ( frame_type & ~ ( IEEE80211_FCTL_FTYPE | IEEE80211_FCTL_STYPE ) ) { return - EINVAL ; } mgmt_type = ( frame_type & IEEE80211_FCTL_STYPE ) >> 4 ; if ( ! ( wdev -> wiphy -> mgmt_stypes [ wdev -> iftype ] . rx & BIT ( mgmt_type ) ) ) { return - EINVAL ; } nreg = kzalloc ( sizeof ( * reg ) + match_len , GFP_KERNEL ) ; if ( ! nreg ) { return - ENOMEM ; } spin_lock_bh ( & wdev -> mgmt_registrations_lock ) ; list_for_each_entry ( , , ) { int mlen = min ( match_len , reg -> match_len ) ; if ( frame_type != le16_to_cpu ( reg -> frame_type ) ) { continue ; } if ( memcmp ( reg -> match , match_data , mlen ) == 0 ) { err = - EALREADY ; break ; } } if ( err ) { out } memcpy ( nreg -> match , match_data , match_len ) ; nreg -> match_len = match_len ; nreg -> nlportid = snd_portid ; nreg -> frame_type = cpu_to_le16 ( frame_type ) ; nreg -> wdev = wdev ; list_add ( & nreg -> list , & wdev -> mgmt_registrations ) ; spin_unlock_bh ( & wdev -> mgmt_registrations_lock ) ; cfg80211_process_mlme_unregistrations ( rdev ) ; if ( rdev -> ops -> mgmt_frame_register ) { rdev_mgmt_frame_register ( rdev , wdev , frame_type , true ) ; } return 0 ; out spin_unlock_bh ( & wdev -> mgmt_registrations_lock ) ; return err ; } 