int main ( int argc , const char * argv [ ] ) { int pipefds [ 2 ] ; struct mevent * evp ; start_test ( argv [ 0 ] , 5 ) ; start_event_thread ( ) ; if ( pipe ( pipefds ) != 0 ) { FAIL_ERRNO ( "pipe" ) ; } if ( fcntl ( pipefds [ 0 ] , F_SETFL , O_NONBLOCK ) != 0 ) { FAIL_ERRNO ( "set pipe nonblocking" ) ; } evp = mevent_add ( pipefds [ 0 ] , EVF_READ , munch , cookie ) ; ASSERT_PTR_NEQ ( ( "mevent_add" ) , evp , NULL ) ; for ( int i = 0 ; cookie [ i ] != '\0' ; i ++ ) { int written ; pthread_mutex_lock ( & mtx ) ; written = write ( pipefds [ 1 ] , cookie + i , 1 ) ; if ( written < 0 ) { FAIL_ERRNO ( "bad write" ) ; } ASSERT_INT64_EQ ( ( "write byte %d of cookie" , i ) , written , 1 ) ; pthread_cond_wait ( & cv , & mtx ) ; pthread_mutex_unlock ( & mtx ) ; } PASS ( ) ; } 