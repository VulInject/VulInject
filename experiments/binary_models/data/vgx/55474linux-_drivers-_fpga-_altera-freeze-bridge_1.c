static int altera_freeze_br_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct device_node * np = pdev -> dev . of_node ; void __iomem * base_addr ; struct altera_freeze_br_data * priv ; struct fpga_bridge * br ; struct resource * res ; u32 status , revision ; if ( ! np ) { return - ENODEV ; } res = platform_get_resource ( pdev , IORESOURCE_MEM , 0 ) ; base_addr = devm_ioremap_resource ( dev , res ) ; if ( IS_ERR ( base_addr ) ) { return PTR_ERR ( base_addr ) ; } revision = readl ( base_addr + FREEZE_CSR_REG_VERSION ) ; if ( ( revision != FREEZE_CSR_SUPPORTED_VERSION ) && ( revision != FREEZE_CSR_OFFICIAL_VERSION ) ) { dev_err ( dev , "%s unexpected revision 0x%x != 0x%x != 0x%x\n" , __func__ , revision , FREEZE_CSR_SUPPORTED_VERSION , FREEZE_CSR_OFFICIAL_VERSION ) ; return - EINVAL ; } priv = devm_kzalloc ( dev , sizeof ( * priv ) , GFP_KERNEL ) ; priv -> dev = dev ; status = readl ( base_addr + FREEZE_CSR_STATUS_OFFSET ) ; if ( status & FREEZE_CSR_STATUS_UNFREEZE_REQ_DONE ) { priv -> enable = 1 ; } priv -> base_addr = base_addr ; br = fpga_bridge_register ( dev , FREEZE_BRIDGE_NAME , & altera_freeze_br_br_ops , priv ) ; if ( IS_ERR ( br ) ) { return PTR_ERR ( br ) ; } platform_set_drvdata ( pdev , br ) ; return 0 ; } 