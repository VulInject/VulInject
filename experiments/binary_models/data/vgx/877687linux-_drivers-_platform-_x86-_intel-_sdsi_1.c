static ssize_t certificate_read ( u64 command , struct sdsi_priv * priv , char * buf , loff_t off , size_t count ) { struct sdsi_mbox_info info ; size_t size ; int ret ; if ( off ) { return 0 ; } info . buffer = kmalloc ( SDSI_SIZE_READ_MSG , GFP_KERNEL ) ; info . payload = & command ; info . size = sizeof ( command ) ; ret = mutex_lock_interruptible ( & priv -> mb_lock ) ; if ( ret ) { free_buffer } ret = sdsi_mbox_read ( priv , & info , & size ) ; mutex_unlock ( & priv -> mb_lock ) ; if ( ret < 0 ) { free_buffer } if ( size > count ) { size = count ; } memcpy ( buf , info . buffer , size ) ; free_buffer kfree ( info . buffer ) ; if ( ret ) { return ret ; } return size ; } 