void btrfs_free_stale_device ( struct btrfs_device * cur_dev ) { struct btrfs_fs_devices * fs_devs ; struct btrfs_device * dev ; list_for_each_entry ( , , ) { int del = 1 ; if ( fs_devs -> opened ) { continue ; } if ( fs_devs -> seeding ) { continue ; } list_for_each_entry ( , , ) { if ( dev == cur_dev ) { continue ; } if ( ! dev -> name ) { continue ; } rcu_read_lock ( ) ; del = strcmp ( rcu_str_deref ( dev -> name ) , rcu_str_deref ( cur_dev -> name ) ) ; rcu_read_unlock ( ) ; if ( ! del ) { break ; } } if ( ! del ) { if ( fs_devs -> num_devices == 1 ) { btrfs_sysfs_remove_fsid ( fs_devs ) ; list_del ( & fs_devs -> list ) ; free_fs_devices ( fs_devs ) ; } else { fs_devs -> num_devices -- ; list_del ( & dev -> dev_list ) ; rcu_string_free ( dev -> name ) ; kfree ( dev ) ; } break ; } } } 