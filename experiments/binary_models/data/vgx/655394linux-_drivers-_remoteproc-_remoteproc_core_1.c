static int rproc_fw_boot ( struct rproc * rproc , const struct firmware * fw ) { struct device * dev = & rproc -> dev ; const char * name = rproc -> firmware ; int ret ; ret = rproc_fw_sanity_check ( rproc , fw ) ; if ( ret ) { return ret ; } dev_info ( dev , "Booting fw image %s, size %zd\n" , name , fw -> size ) ; ret = rproc_enable_iommu ( rproc ) ; if ( ret ) { dev_err ( dev , "can't enable iommu: %d\n" , ret ) ; return ret ; } ret = rproc_prepare_device ( rproc ) ; if ( ret ) { dev_err ( dev , "can't prepare rproc %s: %d\n" , rproc -> name , ret ) ; disable_iommu } rproc -> bootaddr = rproc_get_boot_addr ( rproc , fw ) ; ret = rproc_parse_fw ( rproc , fw ) ; if ( ret ) { unprepare_rproc } rproc -> max_notifyid = - 1 ; rproc -> nb_vdev = 0 ; ret = rproc_handle_resources ( rproc , rproc_loading_handlers ) ; if ( ret ) { dev_err ( dev , "Failed to process resources: %d\n" , ret ) ; clean_up_resources } ret = rproc_alloc_registered_carveouts ( rproc ) ; if ( ret ) { dev_err ( dev , "Failed to allocate associated carveouts: %d\n" , ret ) ; clean_up_resources } ret = rproc_start ( rproc , fw ) ; if ( ret ) { clean_up_resources } return 0 ; clean_up_resources rproc_resource_cleanup ( rproc ) ; kfree ( rproc -> cached_table ) ; rproc -> table_ptr = NULL ; unprepare_rproc rproc_unprepare_device ( rproc ) ; disable_iommu rproc_disable_iommu ( rproc ) ; return ret ; } 