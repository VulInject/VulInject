static int nvme_submit_user_cmd ( struct request_queue * q , struct nvme_command * cmd , u64 ubuffer , unsigned bufflen , void __user * meta_buffer , unsigned meta_len , u32 meta_seed , u64 * result , unsigned timeout , unsigned int flags ) { struct nvme_ns * ns = q -> queuedata ; struct nvme_ctrl * ctrl ; struct request * req ; void * meta = NULL ; struct bio * bio ; u32 effects ; int ret ; req = nvme_alloc_user_request ( q , cmd , 0 , 0 ) ; if ( IS_ERR ( req ) ) { return PTR_ERR ( req ) ; } req -> timeout = timeout ; if ( ubuffer && bufflen ) { ret = nvme_map_user_request ( req , ubuffer , bufflen , meta_buffer , meta_len , meta_seed , & meta , NULL , flags ) ; } bio = req -> bio ; ctrl = nvme_req ( req ) -> ctrl ; effects = nvme_passthru_start ( ctrl , ns , cmd -> common . opcode ) ; ret = nvme_execute_rq ( req , false ) ; if ( result ) { * result = le64_to_cpu ( nvme_req ( req ) -> result . u64 ) ; } if ( meta ) { ret = nvme_finish_user_metadata ( req , meta_buffer , meta , meta_len , ret ) ; } if ( bio ) { blk_rq_unmap_user ( bio ) ; } blk_mq_free_request ( req ) ; if ( effects ) { nvme_passthru_end ( ctrl , effects , cmd , ret ) ; } return ret ; } 