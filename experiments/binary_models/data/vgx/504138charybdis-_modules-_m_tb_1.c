mapi_clist_av1 tb_clist [ ] { & tb_msgtab & etb_msgtab NULL } ; ; DECLARE_MODULE_AV2 ( tb , NULL , NULL , tb_clist , NULL , NULL , NULL , NULL , tb_desc ) ; static void ms_tb ( struct MsgBuf * msgbuf_p , struct Client * client_p , struct Client * source_p , int parc , const char * parv [ ] ) { struct Channel * chptr ; const char * newtopic ; const char * newtopicwho ; time_t newtopicts ; struct Client * fakesource_p ; chptr = find_channel ( parv [ 1 ] ) ; newtopicts = atol ( parv [ 2 ] ) ; if ( ConfigServerHide . flatten_links && ! HasSentEob ( source_p ) ) { fakesource_p = & me ; } else { fakesource_p = source_p ; } if ( parc == 5 ) { newtopic = parv [ 4 ] ; newtopicwho = parv [ 3 ] ; } else { newtopic = parv [ 3 ] ; newtopicwho = fakesource_p -> name ; } if ( EmptyString ( newtopic ) ) { return ; } if ( chptr -> topic == NULL || chptr -> topic_time > newtopicts ) { if ( chptr -> topic != NULL && strcmp ( chptr -> topic , newtopic ) == 0 ) { return ; } set_channel_topic ( chptr , newtopic , newtopicwho , newtopicts ) ; sendto_channel_local ( fakesource_p , ALL_MEMBERS , chptr , ":%s TOPIC %s :%s" , fakesource_p -> name , chptr -> chname , newtopic ) ; sendto_server ( client_p , chptr , CAP_TB | CAP_TS6 , NOCAPS , ":%s TB %s %ld %s%s:%s" , use_id ( source_p ) , chptr -> chname , ( long ) chptr -> topic_time , ConfigChannel . burst_topicwho ?chptr -> topic_info : "" , ConfigChannel . burst_topicwho ?" " : "" , chptr -> topic ) ; } } 