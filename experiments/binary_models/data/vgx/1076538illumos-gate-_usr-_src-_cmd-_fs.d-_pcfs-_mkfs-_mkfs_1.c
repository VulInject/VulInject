void write_fat ( int fd , off64_t seekto , char * fn , char * lbl , char * ffn , bpb_t * wbpb ) { struct fat_od_fsi fsinfo ; pc_cluster32_t ffsc ; boot_sector_t bootsect ; uchar_t * fatp , * rdirp ; ulong_t bootblksize , fatsize , rdirsize , ffsize ; int bsfd = - 1 ; int fffd = - 1 ; compute_file_area_size ( wbpb ) ; bsfd = copy_bootblk ( fn , & bootsect , & bootblksize ) ; label_volume ( lbl , wbpb ) ; if ( Verbose ) { ( void ) printf ( gettext ( "Building FAT.\n" ) ) ; } fatp = build_fat ( wbpb , & fsinfo , bootblksize , & fatsize , ffn , & fffd , & ffsize , & ffsc ) ; write_bootsects ( fd , & bootsect , wbpb , & fsinfo , seekto ) ; if ( lseek64 ( fd , seekto + ( BPSEC * wbpb -> bpb . resv_sectors ) , SEEK_SET ) < 0 ) { ( void ) close ( fd ) ; perror ( gettext ( "Seek to end of reserved sectors" ) ) ; exit ( 4 ) ; } if ( Verbose ) { ( void ) printf ( gettext ( "Writing FAT(s). %d bytes times %d.\n" ) , fatsize , wbpb -> bpb . num_fats ) ; } if ( ! Notreally ) { int nf , wb ; for ( nf = 0 ; nf < ( int ) wbpb -> bpb . num_fats ; nf ++ ) { if ( ( wb = write ( fd , fatp , fatsize ) ) != fatsize ) { perror ( gettext ( "FAT write" ) ) ; exit ( 4 ) ; } else { if ( Verbose ) { ( void ) printf ( gettext ( "Wrote %d bytes\n" ) , wb ) ; } } } } if ( Verbose ) { ( void ) printf ( gettext ( "Building root directory.\n" ) ) ; } rdirp = build_rootdir ( wbpb , ffn , fffd , ffsize , ffsc , & rdirsize ) ; if ( ! MakeFAT32 ) { if ( Verbose ) { ( void ) printf ( gettext ( "Writing root directory. " "%d bytes.\n" ) , rdirsize ) ; } if ( ! Notreally ) { if ( write ( fd , rdirp , rdirsize ) != rdirsize ) { perror ( gettext ( "Root directory write" ) ) ; exit ( 4 ) ; } } free ( rdirp ) ; } if ( bootblksize > BPSEC ) { if ( Verbose ) { ( void ) printf ( gettext ( "Writing remainder of " "boot block.\n" ) ) ; } if ( ! Notreally ) { write_rest ( wbpb , fn , fd , bsfd , bootblksize - BPSEC ) ; } } if ( MakeFAT32 ) { if ( Verbose ) { ( void ) printf ( gettext ( "Writing root directory. " "%d bytes.\n" ) , rdirsize ) ; } if ( ! Notreally ) { if ( write ( fd , rdirp , rdirsize ) != rdirsize ) { perror ( gettext ( "Root directory write" ) ) ; exit ( 4 ) ; } } free ( rdirp ) ; } if ( fffd >= 0 ) { if ( Verbose ) { ( void ) printf ( gettext ( "Writing first file.\n" ) ) ; } if ( ! Notreally ) { write_rest ( wbpb , ffn , fd , fffd , ffsize ) ; } } } 