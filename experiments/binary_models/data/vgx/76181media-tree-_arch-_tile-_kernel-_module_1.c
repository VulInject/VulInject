void * module_alloc ( unsigned long size ) { struct page * * pages ; pgprot_t prot_rwx = __pgprot ( _PAGE_KERNEL | _PAGE_KERNEL_EXEC ) ; struct vm_struct * area ; int i = 0 ; int npages ; npages = ( size + PAGE_SIZE - 1 ) / PAGE_SIZE ; pages = kmalloc_array ( npages , sizeof ( * pages ) , GFP_KERNEL ) ; for ( ; i < npages ; ++ i ) { pages [ i ] = alloc_page ( GFP_KERNEL | __GFP_HIGHMEM ) ; if ( ! pages [ i ] ) { free_pages } } area = __get_vm_area ( size , VM_ALLOC , MEM_MODULE_START , MEM_MODULE_END ) ; if ( ! area ) { free_pages } area -> nr_pages = npages ; area -> pages = pages ; if ( map_vm_area ( area , prot_rwx , pages ) ) { vunmap ( area -> addr ) ; free_pages } return area -> addr ; free_pages while ( -- i >= 0 ) { __free_page ( pages [ i ] ) ; } kfree ( pages ) ; return NULL ; } 