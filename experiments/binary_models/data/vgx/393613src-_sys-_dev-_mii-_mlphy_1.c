int mlphy_service ( struct mii_softc * sc , struct mii_data * mii , int cmd ) { struct ifmedia_entry * ife = mii -> mii_media . ifm_cur ; struct mii_softc * other = NULL ; struct mlphy_softc * msc = ( mlphy_softc * ) sc ; int other_inst , reg ; LIST_FOREACH ( , , ) if ( other != sc ) { break ; } if ( ( sc -> mii_dev . dv_flags & DVF_ACTIVE ) == 0 ) { return ( ENXIO ) ; } switch ( cmd ) { case MII_POLLSTAT : if ( IFM_INST ( ife -> ifm_media ) != sc -> mii_inst ) { return ( 0 ) ; } break ; case MII_MEDIACHG : if ( ( mii -> mii_ifp -> if_flags & IFF_UP ) == 0 ) { break ; } switch ( IFM_SUBTYPE ( ife -> ifm_media ) ) { case IFM_AUTO : msc -> ml_state = ML_STATE_AUTO_SELF ; if ( other != NULL ) { mii_phy_reset ( other ) ; PHY_WRITE ( other , MII_BMCR , BMCR_ISO ) ; } ( void ) mii_phy_auto ( sc , 0 ) ; msc -> ml_linked = 0 ; break ; case IFM_10_T : if ( other != NULL ) { mii_phy_reset ( other ) ; PHY_WRITE ( other , MII_BMCR , ife -> ifm_data ) ; } mii_phy_setmedia ( sc ) ; msc -> ml_state = 0 ; break ; case IFM_100_TX : if ( other != NULL ) { mii_phy_reset ( other ) ; PHY_WRITE ( other , MII_BMCR , BMCR_ISO ) ; } mii_phy_setmedia ( sc ) ; msc -> ml_state = 0 ; break ; default : return ( EINVAL ) ; } break ; case MII_TICK : if ( ( mii -> mii_ifp -> if_flags & IFF_UP ) == 0 ) { return ( 0 ) ; } if ( IFM_SUBTYPE ( ife -> ifm_media ) != IFM_AUTO ) { break ; } if ( msc -> ml_state == ML_STATE_AUTO_OTHER ) { reg = PHY_READ ( other , MII_BMSR ) | PHY_READ ( other , MII_BMSR ) ; } else { reg = PHY_READ ( sc , MII_BMSR ) | PHY_READ ( sc , MII_BMSR ) ; } if ( reg & BMSR_LINK ) { if ( ! msc -> ml_linked ) { msc -> ml_linked = 1 ; mlphy_status ( sc ) ; } sc -> mii_ticks = 0 ; break ; } if ( ++ sc -> mii_ticks <= MII_ANEGTICKS ) { break ; } sc -> mii_ticks = 0 ; msc -> ml_linked = 0 ; mii -> mii_media_active = IFM_NONE ; mii_phy_reset ( sc ) ; msc -> ml_state = ML_STATE_AUTO_SELF ; if ( other != NULL ) { mii_phy_reset ( other ) ; PHY_WRITE ( other , MII_BMCR , BMCR_ISO ) ; } mii_phy_auto ( sc , 0 ) ; break ; case MII_DOWN : mii_phy_down ( sc , NULL ) ; return ( 0 ) ; } if ( msc -> ml_state == ML_STATE_AUTO_OTHER && other != NULL ) { other_inst = other -> mii_inst ; other -> mii_inst = sc -> mii_inst ; if ( IFM_INST ( ife -> ifm_media ) == other -> mii_inst ) { ( void ) PHY_SERVICE ( other , mii , MII_POLLSTAT ) ; } other -> mii_inst = other_inst ; sc -> mii_media_active = other -> mii_media_active ; sc -> mii_media_status = other -> mii_media_status ; } else { ukphy_status ( sc ) ; } mii_phy_update ( sc , cmd ) ; return ( 0 ) ; } 