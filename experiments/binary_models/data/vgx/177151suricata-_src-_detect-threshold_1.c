static int DetectThresholdTestSig1 ( void ) { Packet * p = NULL ; Signature * s = NULL ; ThreadVars th_v ; DetectEngineThreadCtx * det_ctx ; int result = 0 ; int alerts = 0 ; HostInitConfig ( HOST_QUIET ) ; p = UTHBuildPacketReal ( ( uint8_t * ) "A" , 1 , IPPROTO_TCP , "1.1.1.1" , "2.2.2.2" , 1024 , 80 ) ; DetectEngineCtx * de_ctx = DetectEngineCtxInit ( ) ; if ( de_ctx == NULL ) { end } de_ctx -> flags |= DE_QUIET ; s = de_ctx -> sig_list = SigInit ( de_ctx , "alert tcp any any ->any 80 (msg:\"Threshold limit\"; content:\"A\"; threshold: type limit, track by_dst, count 5, seconds 60; sid:1;)" ) ; if ( s == NULL ) { end } SigGroupBuild ( de_ctx ) ; if ( s -> flags & SIG_FLAG_IPONLY ) { printf ( "signature is ip-only: " ) ; end } DetectEngineThreadCtxInit ( & th_v , ( void * ) de_ctx , ( void * ) & det_ctx ) ; SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts = PacketAlertCheck ( p , 1 ) ; if ( alerts != 1 ) { printf ( "alerts %" PRIi32 ", expected 1: " , alerts ) ; } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts += PacketAlertCheck ( p , 1 ) ; if ( alerts != 2 ) { printf ( "alerts %" PRIi32 ", expected 2: " , alerts ) ; } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts += PacketAlertCheck ( p , 1 ) ; if ( alerts != 3 ) { printf ( "alerts %" PRIi32 ", expected 3: " , alerts ) ; } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts += PacketAlertCheck ( p , 1 ) ; if ( alerts != 4 ) { printf ( "alerts %" PRIi32 ", expected 4: " , alerts ) ; } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts += PacketAlertCheck ( p , 1 ) ; if ( alerts != 5 ) { printf ( "alerts %" PRIi32 ", expected 5: " , alerts ) ; } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts += PacketAlertCheck ( p , 1 ) ; if ( alerts != 5 ) { printf ( "alerts %" PRIi32 ", expected 5: " , alerts ) ; } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts += PacketAlertCheck ( p , 1 ) ; if ( alerts != 5 ) { printf ( "alerts %" PRIi32 ", expected 5: " , alerts ) ; } SigMatchSignatures ( & th_v , de_ctx , det_ctx , p ) ; alerts += PacketAlertCheck ( p , 1 ) ; if ( alerts != 5 ) { printf ( "alerts %" PRIi32 ", expected 5: " , alerts ) ; } if ( alerts == 5 ) { result = 1 ; } else { printf ( "alerts %" PRIi32 ", expected 5: " , alerts ) ; } SigGroupCleanup ( de_ctx ) ; SigCleanSignatures ( de_ctx ) ; DetectEngineThreadCtxDeinit ( & th_v , ( void * ) det_ctx ) ; DetectEngineCtxFree ( de_ctx ) ; UTHFreePackets ( & p , 1 ) ; HostShutdown ( ) ; end return result ; } 