static int hpre_ecdh_fill_curve ( struct hpre_ctx * ctx , struct ecdh * params , unsigned int cur_sz ) { unsigned int shifta = ctx -> key_sz << 1 ; unsigned int shiftb = ctx -> key_sz << 2 ; void * p = ctx -> ecdh . p + ctx -> key_sz - cur_sz ; void * a = ctx -> ecdh . p + shifta - cur_sz ; void * b = ctx -> ecdh . p + shiftb - cur_sz ; void * x = ctx -> ecdh . g + ctx -> key_sz - cur_sz ; void * y = ctx -> ecdh . g + shifta - cur_sz ; const struct ecc_curve * curve = ecc_get_curve ( ctx -> curve_id ) ; char * n ; if ( unlikely ( ! curve ) ) { return - EINVAL ; } n = kzalloc ( ctx -> key_sz , GFP_KERNEL ) ; if ( ! n ) { return - ENOMEM ; } fill_curve_param ( p , curve -> p , cur_sz , curve -> g . ndigits ) ; fill_curve_param ( a , curve -> a , cur_sz , curve -> g . ndigits ) ; fill_curve_param ( b , curve -> b , cur_sz , curve -> g . ndigits ) ; fill_curve_param ( x , curve -> g . x , cur_sz , curve -> g . ndigits ) ; fill_curve_param ( y , curve -> g . y , cur_sz , curve -> g . ndigits ) ; fill_curve_param ( n , curve -> n , cur_sz , curve -> g . ndigits ) ; if ( params -> key_size == cur_sz && memcmp ( params -> key , n , cur_sz ) >= 0 ) { return - EINVAL ; } kfree ( n ) ; return 0 ; } 