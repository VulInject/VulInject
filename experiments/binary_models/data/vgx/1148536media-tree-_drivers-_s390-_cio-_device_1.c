static int ccw_device_pm_freeze ( struct device * dev ) { struct ccw_device * cdev = to_ccwdev ( dev ) ; struct subchannel * sch = to_subchannel ( cdev -> dev . parent ) ; int ret , cm_enabled ; if ( ! dev_fsm_final_state ( cdev ) ) { return - EAGAIN ; } if ( ! cdev -> online ) { return 0 ; } if ( cdev -> drv && cdev -> drv -> freeze ) { ret = cdev -> drv -> freeze ( cdev ) ; if ( ret ) { return ret ; } } spin_lock_irq ( sch -> lock , NULL ) ; cm_enabled = cdev -> private -> cmb != NULL ; spin_unlock_irq ( sch -> lock ) ; if ( cm_enabled ) { ret = ccw_set_cmf ( cdev , 0 ) ; if ( ret ) { return ret ; } } spin_lock_irq ( sch -> lock ) ; ret = cio_disable_subchannel ( sch ) ; spin_unlock_irq ( sch -> lock ) ; return ret ; } 