static void survey_child_resources ( struct hv_pcibus_device * hbus ) { struct hv_pci_dev * hpdev ; resource_size_t bar_size = 0 ; unsigned long flags ; struct completion * event ; u64 bar_val ; int i ; event = xchg ( & hbus -> survey_event , NULL ) ; if ( hbus -> low_mmio_space || hbus -> high_mmio_space ) { complete ( event ) ; return ; } spin_lock_irqsave ( & hbus -> device_list_lock , flags ) ; list_for_each_entry ( , , ) { for ( i = 0 ; i < PCI_STD_NUM_BARS ; i ++ ) { if ( hpdev -> probed_bar [ i ] & PCI_BASE_ADDRESS_SPACE_IO ) { dev_err ( & hbus -> hdev -> device , "There's an I/O BAR in this list!\n" ) ; } if ( hpdev -> probed_bar [ i ] != 0 ) { bar_val = hpdev -> probed_bar [ i ] ; if ( bar_val & PCI_BASE_ADDRESS_MEM_TYPE_64 ) { bar_val |= ( ( u64 ) hpdev -> probed_bar [ ++ i ] << 32 ) ; } else { bar_val |= 0xffffffff00000000ULL ; } bar_size = get_bar_size ( bar_val ) ; if ( bar_val & PCI_BASE_ADDRESS_MEM_TYPE_64 ) { hbus -> high_mmio_space += bar_size ; } else { hbus -> low_mmio_space += bar_size ; } } } } spin_unlock_irqrestore ( & hbus -> device_list_lock , flags ) ; complete ( event ) ; } 