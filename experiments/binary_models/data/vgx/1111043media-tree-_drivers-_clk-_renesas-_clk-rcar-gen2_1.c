static struct clk * __init cpg_adsp_clk_register ( struct rcar_gen2_cpg * cpg ) { const char * parent_name = "pll1" ; struct clk_divider * div ; struct clk_gate * gate ; struct clk * clk ; div = kmalloc ( sizeof ( * div ) , GFP_KERNEL ) ; if ( ! div ) { return ERR_PTR ( - ENOMEM ) ; } div -> reg = cpg -> reg + CPG_ADSPCKCR ; div -> width = 4 ; div -> table = cpg_adsp_div_table ; div -> lock = & cpg -> lock ; gate = kzalloc ( sizeof ( * gate ) , GFP_KERNEL ) ; if ( ! gate ) { kfree ( div ) ; return ERR_PTR ( - ENOMEM ) ; } gate -> reg = cpg -> reg + CPG_ADSPCKCR ; gate -> bit_idx = 8 ; gate -> flags = CLK_GATE_SET_TO_DISABLE ; gate -> lock = & cpg -> lock ; clk = clk_register_composite ( NULL , "adsp" , & parent_name , 1 , NULL , NULL , & div -> hw , & clk_divider_ops , & gate -> hw , & clk_gate_ops , 0 ) ; if ( IS_ERR ( clk ) ) { kfree ( gate ) ; kfree ( div ) ; } return clk ; } 