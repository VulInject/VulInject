static int vdec_vp8_decode ( void * h_vdec , struct mtk_vcodec_mem * bs , struct vdec_fb * fb , bool * res_chg ) { struct vdec_vp8_inst * inst = ( vdec_vp8_inst * ) h_vdec ; struct vdec_vp8_dec_info * dec = & inst -> vsi -> dec ; struct vdec_vpu_inst * vpu = & inst -> vpu ; unsigned char * bs_va ; unsigned int data ; int err = 0 ; uint64_t y_fb_dma ; uint64_t c_fb_dma ; if ( bs == NULL ) { move_fb_list_use_to_free ( inst ) ; return vpu_dec_reset ( vpu ) ; } y_fb_dma = fb ?( u64 ) fb -> base_y . dma_addr : 0 ; c_fb_dma = fb ?( u64 ) fb -> base_c . dma_addr : 0 ; mtk_vcodec_debug ( inst , "+ [%d] FB y_dma=%llx c_dma=%llx fb=%p" , inst -> frm_cnt , y_fb_dma , c_fb_dma , fb ) ; inst -> cur_fb = fb ; dec -> bs_dma = ( unsigned long ) bs -> dma_addr ; dec -> bs_sz = bs -> size ; dec -> cur_y_fb_dma = y_fb_dma ; dec -> cur_c_fb_dma = c_fb_dma ; mtk_vcodec_debug ( inst , "\n + FRAME[%d] +\n" , inst -> frm_cnt ) ; write_hw_segmentation_data ( inst , NULL ) ; enable_hw_rw_function ( inst ) ; store_dec_table ( inst ) ; bs_va = ( unsigned char * ) bs -> va ; data = ( * ( bs_va + 9 ) << 24 ) | ( * ( bs_va + 8 ) << 16 ) | ( * ( bs_va + 7 ) << 8 ) | * ( bs_va + 6 ) ; err = vpu_dec_start ( vpu , & data , 1 ) ; if ( err ) { add_fb_to_free_list ( inst , fb ) ; if ( dec -> wait_key_frame ) { mtk_vcodec_debug ( inst , "wait key frame !" ) ; return 0 ; } error } if ( dec -> resolution_changed ) { mtk_vcodec_debug ( inst , "- resolution_changed -" ) ; * res_chg = true ; add_fb_to_free_list ( inst , fb ) ; return 0 ; } mtk_vcodec_wait_for_done_ctx ( inst -> ctx , MTK_INST_IRQ_RECEIVED , WAIT_INTR_TIMEOUT_MS , 0 ) ; if ( inst -> vsi -> load_data ) { load_dec_table ( inst ) ; } vp8_dec_finish ( inst ) ; read_hw_segmentation_data ( inst ) ; err = vpu_dec_end ( vpu ) ; if ( err ) { error } mtk_vcodec_debug ( inst , "\n - FRAME[%d] - show=%d\n" , inst -> frm_cnt , dec -> show_frame ) ; inst -> frm_cnt ++ ; * res_chg = false ; return 0 ; error mtk_vcodec_err ( inst , "\n - FRAME[%d] - err=%d\n" , inst -> frm_cnt , err ) ; return err ; } 