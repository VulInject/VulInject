static int process_dmesg_files ( PStoreList * list ) { _cleanup_free_ char * erst_subdir = NULL ; uint64_t last_record_id = 0 ; for ( size_t n = list -> n_entries ; n > 0 ; n -- ) { PStoreEntry * pe ; char * p ; pe = & list -> entries [ n - 1 ] ; if ( pe -> handled ) { continue ; } if ( endswith ( pe -> dirent . d_name , ".enc.z" ) ) { continue ; } if ( ! startswith ( pe -> dirent . d_name , "dmesg-" ) ) { continue ; } if ( ( p = startswith ( pe -> dirent . d_name , "dmesg-efi-" ) ) ) { _cleanup_free_ char * subdir1 = NULL , * subdir2 = NULL ; size_t plen = strlen ( p ) ; if ( plen < 6 ) { continue ; } subdir1 = strndup ( p , plen - 5 ) ; subdir2 = strndup ( p + plen - 3 , 3 ) ; if ( ! subdir2 ) { return log_oom ( ) ; } ( void ) move_file ( pe , subdir1 , subdir2 ) ; ( void ) append_dmesg ( pe , subdir1 , subdir2 ) ; } if ( ( p = startswith ( pe -> dirent . d_name , "dmesg-erst-" ) ) ) { uint64_t record_id ; if ( safe_atou64 ( p , & record_id ) < 0 ) { continue ; } if ( last_record_id - 1 != record_id ) { if ( free_and_strdup ( & erst_subdir , p ) < 0 ) { return log_oom ( ) ; } } ( void ) move_file ( pe , erst_subdir , NULL ) ; ( void ) append_dmesg ( pe , erst_subdir , NULL ) ; last_record_id = record_id ; } else { log_debug ( "Unknown backend, ignoring \"%s\"." , pe -> dirent . d_name ) ; } } return 0 ; } 