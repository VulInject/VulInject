gimp_color_transform_new ( , , , , , ) { GimpColorTransform * transform ; GimpColorTransformPrivate * priv ; cmsHPROFILE src_lcms ; cmsHPROFILE dest_lcms ; cmsUInt32Number lcms_src_format ; cmsUInt32Number lcms_dest_format ; GError * error = NULL ; g_return_val_if_fail ( GIMP_IS_COLOR_PROFILE ( src_profile ) , NULL ) ; g_return_val_if_fail ( src_format != NULL , NULL ) ; g_return_val_if_fail ( GIMP_IS_COLOR_PROFILE ( dest_profile ) , NULL ) ; g_return_val_if_fail ( dest_format != NULL , NULL ) ; transform = g_object_new ( GIMP_TYPE_COLOR_TRANSFORM , NULL ) ; priv = transform -> priv ; priv -> src_format = gimp_color_profile_get_format ( src_profile , src_format , GIMP_COLOR_RENDERING_INTENT_RELATIVE_COLORIMETRIC , & error ) ; if ( ! priv -> src_format ) { g_printerr ( "%s: error making src format: %s\n" , G_STRFUNC , error -> message ) ; g_clear_error ( & error ) ; } priv -> dest_format = gimp_color_profile_get_format ( dest_profile , dest_format , rendering_intent , & error ) ; if ( ! priv -> dest_format ) { g_printerr ( "%s: error making dest format: %s\n" , G_STRFUNC , error -> message ) ; g_clear_error ( & error ) ; } if ( ! g_getenv ( "GIMP_COLOR_TRANSFORM_DISABLE_BABL" ) && priv -> src_format && priv -> dest_format ) { priv -> fish = babl_fish ( priv -> src_format , priv -> dest_format ) ; g_debug ( "%s: using babl for '%s' ->'%s'" , G_STRFUNC , gimp_color_profile_get_label ( src_profile ) , gimp_color_profile_get_label ( dest_profile ) ) ; return transform ; } src_format = babl_format_with_space ( ( const gchar * ) src_format , NULL ) ; dest_format = babl_format_with_space ( ( const gchar * ) dest_format , NULL ) ; priv -> src_format = gimp_color_profile_get_lcms_format ( src_format , & lcms_src_format ) ; priv -> dest_format = gimp_color_profile_get_lcms_format ( dest_format , & lcms_dest_format ) ; src_lcms = gimp_color_profile_get_lcms_profile ( src_profile ) ; dest_lcms = gimp_color_profile_get_lcms_profile ( dest_profile ) ; lcms_error_clear ( ) ; priv -> transform = cmsCreateTransform ( src_lcms , lcms_src_format , dest_lcms , lcms_dest_format , rendering_intent , flags | cmsFLAGS_COPY_ALPHA ) ; if ( lcms_last_error ) { if ( priv -> transform ) { cmsDeleteTransform ( priv -> transform ) ; priv -> transform = NULL ; } g_printerr ( "%s: %s\n" , G_STRFUNC , lcms_last_error ) ; } if ( ! priv -> transform ) { transform = NULL ; } return transform ; } 