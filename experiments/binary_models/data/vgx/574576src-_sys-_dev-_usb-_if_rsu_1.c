int rsu_read_rom ( struct rsu_softc * sc ) { uint8_t * rom = sc -> rom ; uint16_t addr = 0 ; uint32_t reg ; uint8_t off , msk ; int i ; reg = rsu_read_1 ( sc , R92S_EE_9346CR ) ; if ( ( reg & ( R92S_9356SEL | R92S_EEPROM_EN ) ) != R92S_EEPROM_EN ) { return ( EIO ) ; } reg = rsu_read_1 ( sc , R92S_EFUSE_TEST + 3 ) ; rsu_write_1 ( sc , R92S_EFUSE_TEST + 3 , reg | 0x80 ) ; DELAY ( 1000 ) ; rsu_write_1 ( sc , R92S_EFUSE_TEST + 3 , reg & ~ 0x80 ) ; while ( addr < 512 ) { reg = rsu_efuse_read_1 ( sc , addr ) ; if ( reg == 0xff ) { break ; } addr ++ ; off = reg >> 4 ; msk = reg & 0xf ; for ( i = 0 ; i < 4 ; i ++ ) { if ( msk & ( 1 << i ) ) { continue ; } rom [ off * 8 + i * 2 + 0 ] = rsu_efuse_read_1 ( sc , addr ) ; addr ++ ; rom [ off * 8 + i * 2 + 1 ] = rsu_efuse_read_1 ( sc , addr ) ; addr ++ ; } } if ( rsu_debug >= 5 ) { printf ( "\n" ) ; for ( i = 0 ; i < sizeof ( sc -> rom ) ; i ++ ) { printf ( "%02x:" , rom [ i ] ) ; } printf ( "\n" ) ; } return ( 0 ) ; } 