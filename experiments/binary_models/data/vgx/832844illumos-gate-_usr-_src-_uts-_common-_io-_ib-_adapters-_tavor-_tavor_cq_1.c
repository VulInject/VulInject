static int tavor_cq_errcqe_consume ( tavor_state_t * state , tavor_cqhdl_t cq , tavor_hw_cqe_t * cqe , ibt_wc_t * wc ) { int next_wqeaddr ; uint32_t imm_eth_pkey_cred ; uint_t nextwqesize , dbd ; uint_t doorbell_cnt , status ; tavor_wrid_entry_t wre ; wc -> wc_id = tavor_wrid_get_entry ( cq , cqe , & wre ) ; imm_eth_pkey_cred = TAVOR_CQE_IMM_ETH_PKEY_CRED_GET ( cq , cqe ) ; status = imm_eth_pkey_cred >> TAVOR_CQE_ERR_STATUS_SHIFT ; switch ( status ) { case TAVOR_CQE_LOC_LEN_ERR : status = IBT_WC_LOCAL_LEN_ERR ; break ; case TAVOR_CQE_LOC_OP_ERR : status = IBT_WC_LOCAL_QP_OP_ERR ; break ; case TAVOR_CQE_LOC_PROT_ERR : status = IBT_WC_LOCAL_PROTECT_ERR ; break ; case TAVOR_CQE_WR_FLUSHED_ERR : status = IBT_WC_WR_FLUSHED_ERR ; break ; case TAVOR_CQE_MW_BIND_ERR : status = IBT_WC_MEM_WIN_BIND_ERR ; break ; case TAVOR_CQE_BAD_RESPONSE_ERR : status = IBT_WC_BAD_RESPONSE_ERR ; break ; case TAVOR_CQE_LOCAL_ACCESS_ERR : status = IBT_WC_LOCAL_ACCESS_ERR ; break ; case TAVOR_CQE_REM_INV_REQ_ERR : status = IBT_WC_REMOTE_INVALID_REQ_ERR ; break ; case TAVOR_CQE_REM_ACC_ERR : status = IBT_WC_REMOTE_ACCESS_ERR ; break ; case TAVOR_CQE_REM_OP_ERR : status = IBT_WC_REMOTE_OP_ERR ; break ; case TAVOR_CQE_TRANS_TO_ERR : status = IBT_WC_TRANS_TIMEOUT_ERR ; break ; case TAVOR_CQE_RNRNAK_TO_ERR : status = IBT_WC_RNR_NAK_TIMEOUT_ERR ; break ; default : TAVOR_WARNING ( state , "unknown error CQE status" ) ; status = IBT_WC_LOCAL_QP_OP_ERR ; break ; } wc -> wc_status = status ; dbd = ( wre . wr_signaled_dbd & TAVOR_WRID_ENTRY_DOORBELLED ) ?1 : 0 ; next_wqeaddr = wre . wr_wqeaddrsz ; nextwqesize = wre . wr_wqeaddrsz & TAVOR_WQE_NDS_MASK ; doorbell_cnt = imm_eth_pkey_cred & TAVOR_CQE_ERR_DBDCNT_MASK ; if ( ( nextwqesize == 0 ) || ( ( doorbell_cnt == 0 ) && ( dbd == 1 ) ) ) { return ( TAVOR_CQ_SYNC_AND_DB ) ; } else { doorbell_cnt = doorbell_cnt - dbd ; TAVOR_CQE_IMM_ETH_PKEY_CRED_SET ( cq , cqe , ( ( TAVOR_CQE_WR_FLUSHED_ERR << TAVOR_CQE_ERR_STATUS_SHIFT ) | ( doorbell_cnt & TAVOR_CQE_ERR_DBDCNT_MASK ) ) ) ; TAVOR_CQE_WQEADDRSZ_SET ( cq , cqe , TAVOR_QP_WQEADDRSZ ( next_wqeaddr , nextwqesize ) ) ; return ( TAVOR_CQ_RECYCLE_ENTRY ) ; } } 