int SSL_server_tests ( void ) { int ret = - 1 ; struct stat stat_buf ; SVR_CTX svr_test_ctx ; printf ( "### starting server tests\n" ) ; TTY_FLUSH ( ) ; if ( ( ret = SSL_server_test ( "AES128-SHA TLS1.2" , "-cipher AES128-SHA -tls1_2" , DEFAULT_CERT , NULL , DEFAULT_KEY , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES256-SHA TLS1.2" , "-cipher AES256-SHA -tls1_2" , DEFAULT_CERT , NULL , DEFAULT_KEY , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES128-SHA256 TLS1.2" , "-cipher AES128-SHA256 -tls1_2" , DEFAULT_CERT , NULL , DEFAULT_KEY , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES256-SHA256 TLS1.2" , "-cipher AES256-SHA256 -tls1_2" , DEFAULT_CERT , NULL , DEFAULT_KEY , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES128-SHA TLS1.1" , "-cipher AES128-SHA -tls1_1" , DEFAULT_CERT , NULL , DEFAULT_KEY , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES128-SHA TLS1.0" , "-cipher AES128-SHA -tls1" , DEFAULT_CERT , NULL , DEFAULT_KEY , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "Session Reuse" , "-cipher AES128-SHA -reconnect -tls1_2" , DEFAULT_CERT , NULL , DEFAULT_KEY , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "1024 bit key" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_1024.cer" , NULL , "../ssl/test/axTLS.key_1024" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "2048 bit key" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_2048.cer" , NULL , "../ssl/test/axTLS.key_2048" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "4096 bit key" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_4096.cer" , NULL , "../ssl/test/axTLS.key_4096" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "RSA1024/SHA256" , "-tls1_2" , "../ssl/test/axTLS.x509_1024_sha256.pem" , NULL , "../ssl/test/axTLS.key_1024" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "RSA1024/SHA384" , "-tls1_2" , "../ssl/test/axTLS.x509_1024_sha384.pem" , NULL , "../ssl/test/axTLS.key_1024" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "RSA1024/SHA512" , "-tls1_2" , "../ssl/test/axTLS.x509_1024_sha512.pem" , NULL , "../ssl/test/axTLS.key_1024" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "Client Verification TLS1.2" , "-cipher AES128-SHA -tls1_2 " "-cert ../ssl/test/axTLS.x509_2048.pem " "-key ../ssl/test/axTLS.key_2048.pem " , NULL , "../ssl/test/axTLS.x509_1024.pem" , "../ssl/test/axTLS.key_1024.pem" , "../ssl/test/axTLS.ca_x509.cer" , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "Client Verification TLS1.1" , "-cipher AES128-SHA -tls1_1 " "-cert ../ssl/test/axTLS.x509_2048.pem " "-key ../ssl/test/axTLS.key_2048.pem " , NULL , "../ssl/test/axTLS.x509_1024.pem" , "../ssl/test/axTLS.key_1024.pem" , "../ssl/test/axTLS.ca_x509.cer" , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) ) { cleanup } if ( stat ( "../ssl/test/axTLS.x509_bad_before.pem" , & stat_buf ) >= 0 ) { if ( ( ret = SSL_server_test ( "Error: Bad Before Cert" , "-cipher AES128-SHA -tls1_2 " "-cert ../ssl/test/axTLS.x509_bad_before.pem " "-key ../ssl/test/axTLS.key_1024.pem " , NULL , "../ssl/test/axTLS.x509_1024.pem" , "../ssl/test/axTLS.key_1024.pem" , "../ssl/test/axTLS.ca_x509.cer" , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) != SSL_X509_ERROR ( X509_VFY_ERROR_NOT_YET_VALID ) ) { cleanup } printf ( "SSL server test \"%s\" passed\n" , "Bad Before Cert" ) ; TTY_FLUSH ( ) ; } if ( ( ret = SSL_server_test ( "Error: Bad After Cert" , "-cipher AES128-SHA -tls1_2 " "-cert ../ssl/test/axTLS.x509_bad_after.pem " "-key ../ssl/test/axTLS.key_1024.pem " , NULL , "../ssl/test/axTLS.x509_1024.pem" , "../ssl/test/axTLS.key_1024.pem" , "../ssl/test/axTLS.ca_x509.cer" , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) != SSL_X509_ERROR ( X509_VFY_ERROR_EXPIRED ) ) { cleanup } printf ( "SSL server test \"%s\" passed\n" , "Bad After Cert" ) ; TTY_FLUSH ( ) ; if ( ( ret = SSL_server_test ( "Error: No trusted certificate" , "-cipher AES128-SHA -tls1_2 " "-cert ../ssl/test/axTLS.x509_1024.pem " "-key ../ssl/test/axTLS.key_1024.pem " , NULL , "../ssl/test/axTLS.x509_1024.pem" , "../ssl/test/axTLS.key_1024.pem" , NULL , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) != SSL_X509_ERROR ( X509_VFY_ERROR_NO_TRUSTED_CERT ) ) { cleanup } printf ( "SSL server test \"%s\" passed\n" , "No trusted certificate" ) ; TTY_FLUSH ( ) ; if ( ( ret = SSL_server_test ( "Error: Self-signed certificate (from server)" , "-cipher AES128-SHA -tls1_2 " "-cert ../ssl/test/axTLS.x509_1024.pem " "-key ../ssl/test/axTLS.key_1024.pem " "-CAfile ../ssl/test/axTLS.ca_x509.pem " , NULL , "../ssl/test/axTLS.x509_1024.pem" , "../ssl/test/axTLS.key_1024.pem" , NULL , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) != SSL_X509_ERROR ( X509_VFY_ERROR_SELF_SIGNED ) ) { cleanup } printf ( "SSL server test \"%s\" passed\n" , "Self-signed certificate (from server)" ) ; TTY_FLUSH ( ) ; if ( ( ret = SSL_server_test ( "Self-signed certificate (from client)" , "-cipher AES128-SHA -tls1_2 " "-cert ../ssl/test/axTLS.x509_1024.pem " "-key ../ssl/test/axTLS.key_1024.pem " , NULL , "../ssl/test/axTLS.x509_1024.pem" , "../ssl/test/axTLS.key_1024.pem" , "../ssl/test/axTLS.ca_x509.cer" , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "Key in PEM format" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_1024.cer" , NULL , "../ssl/test/axTLS.key_1024.pem" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "Cert in PEM format" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_1024.pem" , NULL , "../ssl/test/axTLS.key_1024.pem" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "Cert chain in PEM format" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_device.pem" , NULL , "../ssl/test/axTLS.key_device.pem" , "../ssl/test/axTLS.ca_x509.pem" , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES128 encrypted key" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_aes128.pem" , NULL , "../ssl/test/axTLS.key_aes128.pem" , NULL , "abcd" , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES256 encrypted key" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_aes256.pem" , NULL , "../ssl/test/axTLS.key_aes256.pem" , NULL , "abcd" , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "AES128 encrypted invalid key" , "-cipher AES128-SHA -tls1_2" , "../ssl/test/axTLS.x509_aes128.pem" , NULL , "../ssl/test/axTLS.key_aes128.pem" , NULL , "xyz" , DEFAULT_SVR_OPTION ) ) != SSL_ERROR_INVALID_KEY ) { cleanup } printf ( "SSL server test \"%s\" passed\n" , "AES128 encrypted invalid key" ) ; TTY_FLUSH ( ) ; if ( ( ret = SSL_server_test ( "pkcs#8 encrypted" , "-cipher AES128-SHA -tls1_2" , DEFAULT_CERT , NULL , "../ssl/test/axTLS.encrypted.p8" , NULL , "abcd" , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "pkcs#8 DER unencrypted" , "-cipher AES128-SHA -tls1_2" , DEFAULT_CERT , NULL , "../ssl/test/axTLS.unencrypted.p8" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "pkcs#8 PEM unencrypted" , "-cipher AES128-SHA -tls1_2" , DEFAULT_CERT , NULL , "../ssl/test/axTLS.unencrypted_pem.p8" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "pkcs#12 with CA" , "-cipher AES128-SHA" , NULL , NULL , "../ssl/test/axTLS.withCA.p12" , NULL , "abcd" , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "pkcs#12 no CA" , "-cipher AES128-SHA" , DEFAULT_CERT , NULL , "../ssl/test/axTLS.withoutCA.p12" , NULL , "abcd" , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "GNUTLS client" , "" , "../ssl/test/axTLS.x509_1024.cer" , NULL , "../ssl/test/axTLS.key_1024" , NULL , NULL , DEFAULT_SVR_OPTION ) ) ) { cleanup } if ( ( ret = SSL_server_test ( "GNUTLS client with verify" , "--x509certfile ../ssl/test/axTLS.x509_1024.pem " "--x509keyfile ../ssl/test/axTLS.key_1024.pem" , "../ssl/test/axTLS.x509_1024.cer" , NULL , "../ssl/test/axTLS.key_1024" , "../ssl/test/axTLS.ca_x509.cer" , NULL , DEFAULT_SVR_OPTION | SSL_CLIENT_AUTHENTICATION ) ) ) { cleanup } ret = 0 ; cleanup if ( ret ) { printf ( "Error: A server test failed\n" ) ; ssl_display_error ( ret ) ; exit ( 1 ) ; } else { printf ( "All server tests passed\n" ) ; TTY_FLUSH ( ) ; } return ret ; } 