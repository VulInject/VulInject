STATIC int wi_set_nwkey ( struct wi_softc * sc , struct ieee80211_nwkey * nwkey ) { int i , len , error ; struct wi_req wreq ; struct wi_ltv_keys * wk = ( wi_ltv_keys * ) & wreq ; if ( ! ( sc -> wi_flags & WI_FLAGS_HAS_WEP ) ) { return ENODEV ; } if ( nwkey -> i_defkid <= 0 || nwkey -> i_defkid > IEEE80211_WEP_NKID ) { return EINVAL ; } memcpy ( wk , & sc -> wi_keys , sizeof ( * wk ) ) ; for ( i = 0 ; i < IEEE80211_WEP_NKID ; i ++ ) { len = nwkey -> i_key [ i ] . i_keylen ; if ( len > sizeof ( wk -> wi_keys [ i ] . wi_keydat ) ) { return EINVAL ; } error = copyin ( nwkey -> i_key [ i ] . i_keydat , wk -> wi_keys [ i ] . wi_keydat , len ) ; if ( error ) { return error ; } wk -> wi_keys [ i ] . wi_keylen = htole16 ( len ) ; } wk -> wi_len = ( sizeof ( * wk ) / 2 ) + 1 ; wk -> wi_type = WI_RID_DEFLT_CRYPT_KEYS ; if ( sc -> sc_ic . ic_if . if_flags & IFF_UP ) { error = wi_write_record ( sc , ( wi_ltv_gen * ) & wreq ) ; if ( error ) { return error ; } } if ( ( error = wi_setdef ( sc , & wreq ) ) ) { return ( error ) ; } wreq . wi_len = 2 ; wreq . wi_type = WI_RID_TX_CRYPT_KEY ; wreq . wi_val [ 0 ] = htole16 ( nwkey -> i_defkid - 1 ) ; if ( sc -> sc_ic . ic_if . if_flags & IFF_UP ) { error = wi_write_record ( sc , ( wi_ltv_gen * ) & wreq ) ; if ( error ) { return error ; } } if ( ( error = wi_setdef ( sc , & wreq ) ) ) { return ( error ) ; } wreq . wi_type = WI_RID_ENCRYPTION ; wreq . wi_val [ 0 ] = htole16 ( nwkey -> i_wepon ) ; if ( sc -> sc_ic . ic_if . if_flags & IFF_UP ) { error = wi_write_record ( sc , ( wi_ltv_gen * ) & wreq ) ; if ( error ) { return error ; } } if ( ( error = wi_setdef ( sc , & wreq ) ) ) { return ( error ) ; } if ( sc -> sc_ic . ic_if . if_flags & IFF_UP ) { wi_init ( sc ) ; } return 0 ; } 