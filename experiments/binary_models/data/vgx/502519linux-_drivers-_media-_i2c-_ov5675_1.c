static int ov5675_probe ( struct i2c_client * client ) { struct ov5675 * ov5675 ; bool full_power ; int ret ; ov5675 = devm_kzalloc ( & client -> dev , sizeof ( * ov5675 ) , GFP_KERNEL ) ; if ( ! ov5675 ) { return - ENOMEM ; } ret = ov5675_get_hwcfg ( ov5675 , & client -> dev ) ; if ( ret ) { dev_err ( & client -> dev , "failed to get HW configuration: %d" , ret ) ; return ret ; } v4l2_i2c_subdev_init ( & ov5675 -> sd , client , & ov5675_subdev_ops ) ; ret = ov5675_power_on ( & client -> dev ) ; if ( ret ) { dev_err ( & client -> dev , "failed to power on: %d\n" , ret ) ; return ret ; } full_power = acpi_dev_state_d0 ( & client -> dev ) ; if ( full_power ) { ret = ov5675_identify_module ( ov5675 ) ; if ( ret ) { dev_err ( & client -> dev , "failed to find sensor: %d" , ret ) ; probe_power_off } } ov5675 -> cur_mode = & supported_modes [ 0 ] ; ret = ov5675_init_controls ( ov5675 ) ; if ( ret ) { dev_err ( & client -> dev , "failed to init controls: %d" , ret ) ; probe_error_v4l2_ctrl_handler_free } ov5675 -> sd . internal_ops = & ov5675_internal_ops ; ov5675 -> sd . flags |= V4L2_SUBDEV_FL_HAS_DEVNODE ; ov5675 -> sd . entity . ops = & ov5675_subdev_entity_ops ; ov5675 -> sd . entity . function = MEDIA_ENT_F_CAM_SENSOR ; ov5675 -> pad . flags = MEDIA_PAD_FL_SOURCE ; ret = media_entity_pads_init ( & ov5675 -> sd . entity , 1 , & ov5675 -> pad ) ; if ( ret ) { dev_err ( & client -> dev , "failed to init entity pads: %d" , ret ) ; probe_error_v4l2_ctrl_handler_free } ret = v4l2_async_register_subdev_sensor ( & ov5675 -> sd ) ; if ( ret < 0 ) { dev_err ( & client -> dev , "failed to register V4L2 subdev: %d" , ret ) ; probe_error_media_entity_cleanup } if ( full_power ) { pm_runtime_set_active ( & client -> dev ) ; } pm_runtime_enable ( & client -> dev ) ; pm_runtime_idle ( & client -> dev ) ; return 0 ; probe_error_media_entity_cleanup media_entity_cleanup ( & ov5675 -> sd . entity ) ; probe_error_v4l2_ctrl_handler_free v4l2_ctrl_handler_free ( ov5675 -> sd . ctrl_handler ) ; mutex_destroy ( & ov5675 -> mutex ) ; probe_power_off ov5675_power_off ( & client -> dev ) ; return ret ; } 