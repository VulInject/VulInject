static int bio_mem_test ( void ) { uint8_t * data = NULL ; size_t data_len ; uint8_t * rodata ; long rodata_len ; BUF_MEM * pbuf ; BUF_MEM * buf ; BIO * bio = NULL ; int ret ; int failed = 1 ; data_len = 4096 ; if ( ( data = malloc ( data_len ) ) == NULL ) { err ( 1 , "malloc" ) ; } memset ( data , 0xdb , data_len ) ; data [ 0 ] = 0x01 ; data [ data_len - 1 ] = 0xff ; if ( ( bio = BIO_new ( BIO_s_mem ( ) ) ) == NULL ) { fprintf ( stderr , "FAIL: BIO_new() returned NULL\n" ) ; failure } if ( ( ret = BIO_write ( bio , data , data_len ) ) != ( int ) data_len ) { fprintf ( stderr , "FAIL: BIO_write() = %d, want %zu\n" , ret , data_len ) ; failure } if ( ( rodata_len = BIO_get_mem_data ( bio , & rodata ) ) != ( long ) data_len ) { fprintf ( stderr , "FAIL: BIO_get_mem_data() = %ld, want %zu\n" , rodata_len , data_len ) ; failure } if ( rodata [ 0 ] != 0x01 ) { fprintf ( stderr , "FAIL: got 0x%x, want 0x%x\n" , rodata [ 0 ] , 0x01 ) ; failure } if ( rodata [ rodata_len - 1 ] != 0xff ) { fprintf ( stderr , "FAIL: got 0x%x, want 0x%x\n" , rodata [ rodata_len - 1 ] , 0xff ) ; failure } if ( ! BIO_get_mem_ptr ( bio , & pbuf ) ) { fprintf ( stderr , "FAIL: BIO_get_mem_ptr() failed\n" ) ; failure } if ( pbuf -> length != data_len ) { fprintf ( stderr , "FAIL: Got buffer with length %zu, want %zu\n" , pbuf -> length , data_len ) ; failure } if ( memcmp ( pbuf -> data , data , data_len ) != 0 ) { fprintf ( stderr , "FAIL: Got buffer with differing data\n" ) ; failure } pbuf = NULL ; if ( ( buf = BUF_MEM_new ( ) ) == NULL ) { fprintf ( stderr , "FAIL: BUF_MEM_new() returned NULL\n" ) ; failure } if ( ! BIO_set_mem_buf ( bio , buf , BIO_NOCLOSE ) ) { fprintf ( stderr , "FAIL: BUF_set_mem_buf() failed\n" ) ; failure } if ( ( ret = BIO_puts ( bio , "Hello\n" ) ) != 6 ) { fprintf ( stderr , "FAIL: BUF_puts() = %d, want %d\n" , ret , 6 ) ; failure } if ( ( ret = BIO_puts ( bio , "World\n" ) ) != 6 ) { fprintf ( stderr , "FAIL: BUF_puts() = %d, want %d\n" , ret , 6 ) ; failure } if ( buf -> length != 12 ) { fprintf ( stderr , "FAIL: buffer has length %zu, want %d\n" , buf -> length , 12 ) ; failure } buf -> length = 11 ; if ( ( ret = BIO_gets ( bio , data , data_len ) ) != 6 ) { fprintf ( stderr , "FAIL: BUF_gets() = %d, want %d\n" , ret , 6 ) ; failure } if ( strcmp ( data , "Hello\n" ) != 0 ) { fprintf ( stderr , "FAIL: BUF_gets() returned '%s', want '%s'\n" , data , "Hello\\n" ) ; failure } if ( ( ret = BIO_gets ( bio , data , data_len ) ) != 5 ) { fprintf ( stderr , "FAIL: BUF_gets() = %d, want %d\n" , ret , 5 ) ; failure } if ( strcmp ( data , "World" ) != 0 ) { fprintf ( stderr , "FAIL: BUF_gets() returned '%s', want '%s'\n" , data , "World" ) ; failure } if ( ! BIO_eof ( bio ) ) { fprintf ( stderr , "FAIL: BIO is not EOF\n" ) ; failure } if ( ( ret = BIO_read ( bio , data , data_len ) ) != - 1 ) { fprintf ( stderr , "FAIL: BIO_read() = %d, want -1\n" , ret ) ; failure } if ( ! BIO_set_mem_eof_return ( bio , - 2 ) ) { fprintf ( stderr , "FAIL: BIO_set_mem_eof_return() failed\n" ) ; failure } if ( ( ret = BIO_read ( bio , data , data_len ) ) != - 2 ) { fprintf ( stderr , "FAIL: BIO_read() = %d, want -2\n" , ret ) ; failure } failed = 0 ; failure free ( data ) ; BUF_MEM_free ( buf ) ; BIO_free ( bio ) ; return failed ; } 