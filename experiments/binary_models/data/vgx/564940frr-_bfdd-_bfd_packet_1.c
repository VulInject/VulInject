static int ptm_bfd_process_echo_pkt ( struct bfd_vrf_global * bvrf , int s ) { struct bfd_session * bfd ; uint32_t my_discr = 0 ; int my_rtt = 0 ; uint8_t ttl = 0 ; if ( bp_bfd_echo_in ( bvrf , s , & ttl , & my_discr , & my_rtt ) == - 1 ) { return 0 ; } bfd = bfd_id_lookup ( my_discr ) ; if ( bfd == NULL ) { if ( bglobal . debug_network ) { zlog_debug ( "echo-packet: no matching session (id:%u)" , my_discr ) ; } return - 1 ; } if ( ! CHECK_FLAG ( bfd -> flags , BFD_SESS_FLAG_ECHO_ACTIVE ) ) { if ( bglobal . debug_network ) { zlog_debug ( "echo-packet: echo disabled [%s] (id:%u)" , bs_to_string ( bfd ) , my_discr ) ; } return - 1 ; } if ( my_rtt != 0 ) { bfd -> rtt [ bfd -> rtt_index ] = my_rtt ; bfd -> rtt_index ++ ; if ( bfd -> rtt_index >= BFD_RTT_SAMPLE ) { bfd -> rtt_index = 0 ; } if ( bfd -> rtt_valid < BFD_RTT_SAMPLE ) { bfd -> rtt_valid ++ ; } } bfd -> stats . rx_echo_pkt ++ ; bfd -> echo_detect_TO = bfd -> remote_detect_mult * bfd -> echo_xmt_TO ; if ( bfd -> echo_detect_TO > 0 ) { bfd_echo_recvtimer_update ( bfd ) ; } return 0 ; } 