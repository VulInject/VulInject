static enum decode_result decode_prefix ( struct x86_decode_state * state , struct x86_insn * insn ) { enum decode_result res = DECODE_ERROR ; struct x86_prefix * prefix ; uint8_t byte ; if ( ! is_valid_state ( state , __func__ ) || insn == NULL ) { return ( - 1 ) ; } prefix = & insn -> insn_prefix ; while ( ( res = peek_byte ( state , & byte ) ) != DECODE_ERROR ) { switch ( byte ) { case LEG_1_LOCK : case LEG_1_REPNE : case LEG_1_REP : prefix -> pfx_group1 = byte ; break ; case LEG_2_CS : case LEG_2_SS : case LEG_2_DS : case LEG_2_ES : case LEG_2_FS : case LEG_2_GS : prefix -> pfx_group2 = byte ; break ; case LEG_3_OPSZ : prefix -> pfx_group3 = byte ; break ; case LEG_4_ADDRSZ : prefix -> pfx_group4 = byte ; break ; case REX_BASE ... REX_BASE + 0x0F : if ( insn -> insn_cpu_mode == VMM_CPU_MODE_LONG ) { prefix -> pfx_rex = byte ; } else { return ( DECODE_ERROR ) ; } break ; case VEX_2_BYTE : case VEX_3_BYTE : log_warnx ( "%s: VEX not supported" , __func__ ) ; return ( DECODE_ERROR ) ; default : return ( DECODE_MORE ) ; } next_byte ( state , NULL ) ; } return ( res ) ; } 