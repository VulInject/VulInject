mpfr_atanu ( , , , ) { mpfr_t tmp , pi ; mpfr_prec_t prec ; mpfr_exp_t expx ; int inex ; MPFR_SAVE_EXPO_DECL ( expo ) ; MPFR_ZIV_DECL ( loop ) ; MPFR_LOG_FUNC ( ( "x[%Pu]=%.*Rg u=%lu rnd=%d" , mpfr_get_prec ( x ) , mpfr_log_prec , x , u , rnd_mode ) , ( "y[%Pu]=%.*Rg inexact=%d" , mpfr_get_prec ( y ) , mpfr_log_prec , y , inex ) ) ; if ( MPFR_UNLIKELY ( MPFR_IS_SINGULAR ( x ) ) ) { if ( MPFR_IS_NAN ( x ) ) { MPFR_SET_NAN ( y ) ; MPFR_RET_NAN ; } if ( MPFR_IS_INF ( x ) ) { if ( MPFR_IS_POS ( x ) ) { return mpfr_set_ui_2exp ( y , u , - 2 , rnd_mode ) ; } else { inex = mpfr_set_ui_2exp ( y , u , - 2 , MPFR_INVERT_RND ( rnd_mode ) ) ; MPFR_CHANGE_SIGN ( y ) ; return - inex ; } } else { MPFR_ASSERTD ( MPFR_IS_ZERO ( x ) ) ; MPFR_SET_ZERO ( y ) ; MPFR_SET_SAME_SIGN ( y , x ) ; MPFR_RET ( 0 ) ; } } if ( u == 0 ) { MPFR_SET_ZERO ( y ) ; MPFR_SET_SAME_SIGN ( y , x ) ; MPFR_RET ( 0 ) ; } if ( mpfr_cmpabs_ui ( x , 1 ) == 0 ) { if ( MPFR_SIGN ( x ) > 0 ) { return mpfr_set_ui_2exp ( y , u , - 3 , rnd_mode ) ; } else { inex = mpfr_set_ui_2exp ( y , u , - 3 , MPFR_INVERT_RND ( rnd_mode ) ) ; MPFR_CHANGE_SIGN ( y ) ; return - inex ; } } expx = MPFR_GET_EXP ( x ) ; if ( expx >= 65 && expx - 1 >= MPFR_PREC ( y ) + 2 ) { prec = ( MPFR_PREC ( y ) <= 63 ) ?65 : MPFR_PREC ( y ) + 2 ; mpfr_init2 ( tmp , prec ) ; inex = mpfr_set_ui ( tmp , u , MPFR_RNDN ) ; MPFR_ASSERTD ( inex == 0 ) ; mpfr_nextbelow ( tmp ) ; MPFR_ASSERTD ( mpfr_min_prec ( tmp ) > MPFR_PREC ( y ) ) ; if ( MPFR_SIGN ( x ) < 0 ) { MPFR_CHANGE_SIGN ( tmp ) ; } inex = mpfr_div_2ui ( y , tmp , 2 , rnd_mode ) ; return inex ; } prec = MPFR_PREC ( y ) ; MPFR_SAVE_EXPO_MARK ( expo ) ; prec += MPFR_INT_CEIL_LOG2 ( prec ) + 10 ; mpfr_init2 ( tmp , prec ) ; mpfr_init2 ( pi , prec ) ; MPFR_ZIV_INIT ( loop , prec ) ; for ( ; ; ) { mpfr_atan ( tmp , x , MPFR_RNDA ) ; mpfr_mul_ui ( tmp , tmp , u , MPFR_RNDA ) ; mpfr_const_pi ( pi , MPFR_RNDZ ) ; mpfr_div ( tmp , tmp , pi , MPFR_RNDA ) ; if ( MPFR_EXP ( tmp ) == __gmpfr_emin ) { mpfr_clear ( tmp ) ; mpfr_clear ( pi ) ; MPFR_SAVE_EXPO_FREE ( expo ) ; return mpfr_underflow ( y , ( rnd_mode == MPFR_RNDN ) ?MPFR_RNDZ : rnd_mode , 1 ) ; } mpfr_div_2ui ( tmp , tmp , 1 , MPFR_RNDA ) ; MPFR_ASSERTD ( ! MPFR_IS_ZERO ( tmp ) ) ; if ( MPFR_LIKELY ( MPFR_CAN_ROUND ( tmp , prec - 4 , MPFR_PREC ( y ) , rnd_mode ) ) ) { break ; } MPFR_ZIV_NEXT ( loop , prec ) ; mpfr_set_prec ( tmp , prec ) ; mpfr_set_prec ( pi , prec ) ; } MPFR_ZIV_FREE ( loop ) ; inex = mpfr_set ( y , tmp , rnd_mode ) ; mpfr_clear ( tmp ) ; mpfr_clear ( pi ) ; MPFR_SAVE_EXPO_FREE ( expo ) ; return mpfr_check_range ( y , inex , rnd_mode ) ; } 