int parse_ded_file ( const char * filename ) { FILE * fp ; char line [ 256 ] ; int error = 0 ; struct tm tm_from , tm_to ; time_t from , to ; int i ; if ( ( fp = fopen ( filename , "r" ) ) == NULL ) { sprintf ( line , "Error opening file %s" , filename ) ; perror ( line ) ; return 1 ; } i = 0 ; memset ( conf . ded_time , 0 , MAX_DEDTIME_SIZE ) ; while ( fgets ( line , 256 , fp ) != NULL ) { if ( ! skip_line ( line ) ) { tm_from . tm_isdst = - 1 ; memset ( & tm_to , 0 , sizeof ( tm ) ) ; tm_to . tm_isdst = - 1 ; if ( sscanf ( line , "%d/%d/%d %d:%d %d/%d/%d %d:%d" , & tm_from . tm_mon , & tm_from . tm_mday , & tm_from . tm_year , & tm_from . tm_hour , & tm_from . tm_min , & tm_to . tm_mon , & tm_to . tm_mday , & tm_to . tm_year , & tm_to . tm_hour , & tm_to . tm_min ) != 10 ) { error = 1 ; } else { tm_from . tm_mon -- ; if ( tm_from . tm_year < 90 ) { tm_from . tm_year += 100 ; } if ( tm_from . tm_year > 1900 ) { tm_from . tm_year -= 1900 ; } from = mktime ( & tm_from ) ; tm_to . tm_mon -- ; if ( tm_from . tm_year < 90 ) { tm_from . tm_year += 100 ; } if ( tm_to . tm_year > 1900 ) { tm_to . tm_year -= 1900 ; } to = mktime ( & tm_to ) ; if ( ! ( from < cstat . current_time && to < cstat . current_time ) ) { conf . ded_time [ i ] . from = from ; conf . ded_time [ i ] . to = to ; i ++ ; } } if ( error ) { printf ( "Error: %s\n" , line ) ; error = 0 ; } } } qsort ( conf . ded_time , MAX_DEDTIME_SIZE , sizeof ( timegap ) , cmp_ded_time ) ; fclose ( fp ) ; return 0 ; } int cmp_ded_time ( const void * v1 , const void * v2 ) { if ( ( ( timegap * ) v1 ) -> from == 0 && ( ( timegap * ) v2 ) -> from != 0 ) { return 1 ; } if ( ( ( timegap * ) v2 ) -> from == 0 && ( ( timegap * ) v1 ) -> from != 0 ) { return - 1 ; } if ( ( ( timegap * ) v1 ) -> from > ( ( timegap * ) v2 ) -> from ) { return 1 ; } if ( ( ( timegap * ) v1 ) -> from < ( ( timegap * ) v2 ) -> from ) { return - 1 ; } else { return 0 ; } } int is_ded_time ( void ) { if ( cstat . current_time > conf . ded_time [ 0 ] . from && cstat . current_time < conf . ded_time [ 0 ] . to ) { return 1 ; } else { return 0 ; } } 