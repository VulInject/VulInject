static long do_fb_ioctl ( struct fb_info * info , unsigned int cmd , unsigned long arg ) { const struct fb_ops * fb ; struct fb_var_screeninfo var ; struct fb_fix_screeninfo fix ; struct fb_cmap cmap_from ; struct fb_cmap_user cmap ; void __user * argp = ( void __user * ) arg ; long ret = 0 ; switch ( cmd ) { case FBIOGET_VSCREENINFO : lock_fb_info ( info , NULL ) ; var = info -> var ; unlock_fb_info ( info ) ; ret = copy_to_user ( argp , & var , sizeof ( var ) ) ?- EFAULT : 0 ; break ; case FBIOPUT_VSCREENINFO : if ( copy_from_user ( & var , argp , sizeof ( var ) ) ) { return - EFAULT ; } console_lock ( ) ; lock_fb_info ( info ) ; ret = fbcon_modechange_possible ( info , & var ) ; if ( ! ret ) { ret = fb_set_var ( info , & var ) ; } if ( ! ret ) { fbcon_update_vcs ( info , var . activate & FB_ACTIVATE_ALL ) ; } unlock_fb_info ( info ) ; console_unlock ( ) ; if ( ! ret && copy_to_user ( argp , & var , sizeof ( var ) ) ) { ret = - EFAULT ; } break ; case FBIOGET_FSCREENINFO : lock_fb_info ( info ) ; memcpy ( & fix , & info -> fix , sizeof ( fix ) ) ; if ( info -> flags & FBINFO_HIDE_SMEM_START ) { fix . smem_start = 0 ; } unlock_fb_info ( info ) ; ret = copy_to_user ( argp , & fix , sizeof ( fix ) ) ?- EFAULT : 0 ; break ; case FBIOPUTCMAP : if ( copy_from_user ( & cmap , argp , sizeof ( cmap ) ) ) { return - EFAULT ; } ret = fb_set_user_cmap ( & cmap , info ) ; break ; case FBIOGETCMAP : if ( copy_from_user ( & cmap , argp , sizeof ( cmap ) ) ) { return - EFAULT ; } lock_fb_info ( info ) ; cmap_from = info -> cmap ; unlock_fb_info ( info ) ; ret = fb_cmap_to_user ( & cmap_from , & cmap ) ; break ; case FBIOPAN_DISPLAY : if ( copy_from_user ( & var , argp , sizeof ( var ) ) ) { return - EFAULT ; } console_lock ( ) ; lock_fb_info ( info ) ; ret = fb_pan_display ( info , & var ) ; unlock_fb_info ( info ) ; console_unlock ( ) ; if ( ret == 0 && copy_to_user ( argp , & var , sizeof ( var ) ) ) { return - EFAULT ; } break ; case FBIO_CURSOR : ret = - EINVAL ; break ; case FBIOGET_CON2FBMAP : ret = fbcon_get_con2fb_map_ioctl ( argp ) ; break ; case FBIOPUT_CON2FBMAP : ret = fbcon_set_con2fb_map_ioctl ( argp ) ; break ; case FBIOBLANK : if ( arg > FB_BLANK_POWERDOWN ) { return - EINVAL ; } console_lock ( ) ; lock_fb_info ( info ) ; ret = fb_blank ( info , arg ) ; fbcon_fb_blanked ( info , arg ) ; unlock_fb_info ( info ) ; console_unlock ( ) ; break ; default : lock_fb_info ( info ) ; fb = info -> fbops ; if ( fb -> fb_ioctl ) { ret = fb -> fb_ioctl ( info , cmd , arg ) ; } else { ret = - ENOTTY ; } unlock_fb_info ( info ) ; } return ret ; } 