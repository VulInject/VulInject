static void virtscsi_handle_transport_reset ( struct virtio_scsi * vscsi , struct virtio_scsi_event * event ) { struct scsi_device * sdev ; struct Scsi_Host * shost = virtio_scsi_host ( vscsi -> vdev ) ; unsigned int target = event -> lun [ 1 ] ; int lun = ( event -> lun [ 2 ] << 8 ) | event -> lun [ 3 ] ; switch ( virtio32_to_cpu ( vscsi -> vdev , event -> reason ) ) { case VIRTIO_SCSI_EVT_RESET_RESCAN : if ( lun == 0 ) { scsi_scan_target ( & shost -> shost_gendev , 0 , target , SCAN_WILD_CARD , SCSI_SCAN_INITIAL ) ; } else { scsi_add_device ( shost , 0 , target , lun ) ; } break ; case VIRTIO_SCSI_EVT_RESET_REMOVED : sdev = scsi_device_lookup ( shost , 0 , target , lun ) ; if ( sdev ) { scsi_remove_device ( sdev ) ; scsi_device_put ( sdev ) ; } else { pr_err ( "SCSI device %d 0 %d %d not found\n" , shost -> host_no , target , lun ) ; } break ; default : pr_info ( "Unsupported virtio scsi event reason %x\n" , event -> reason ) ; } } 