static int mt7530_probe ( struct mdio_device * mdiodev ) { struct mt7530_priv * priv ; struct device_node * dn ; dn = mdiodev -> dev . of_node ; priv = devm_kzalloc ( & mdiodev -> dev , sizeof ( * priv ) , GFP_KERNEL ) ; priv -> ds = devm_kzalloc ( & mdiodev -> dev , sizeof ( * priv -> ds ) , GFP_KERNEL ) ; if ( ! priv -> ds ) { return - ENOMEM ; } priv -> ds -> dev = & mdiodev -> dev ; priv -> ds -> num_ports = MT7530_NUM_PORTS ; priv -> mcm = of_property_read_bool ( dn , "mediatek,mcm" ) ; if ( priv -> mcm ) { dev_info ( & mdiodev -> dev , "MT7530 adapts as multi-chip module\n" ) ; priv -> rstc = devm_reset_control_get ( & mdiodev -> dev , "mcm" ) ; if ( IS_ERR ( priv -> rstc ) ) { dev_err ( & mdiodev -> dev , "Couldn't get our reset line\n" ) ; return PTR_ERR ( priv -> rstc ) ; } } priv -> info = of_device_get_match_data ( & mdiodev -> dev ) ; if ( ! priv -> info ) { return - EINVAL ; } if ( ! priv -> info -> sw_setup || ! priv -> info -> pad_setup || ! priv -> info -> phy_read_c22 || ! priv -> info -> phy_write_c22 || ! priv -> info -> mac_port_get_caps || ! priv -> info -> mac_port_config ) { return - EINVAL ; } priv -> id = priv -> info -> id ; if ( priv -> id == ID_MT7530 ) { priv -> core_pwr = devm_regulator_get ( & mdiodev -> dev , "core" ) ; if ( IS_ERR ( priv -> core_pwr ) ) { return PTR_ERR ( priv -> core_pwr ) ; } priv -> io_pwr = devm_regulator_get ( & mdiodev -> dev , "io" ) ; if ( IS_ERR ( priv -> io_pwr ) ) { return PTR_ERR ( priv -> io_pwr ) ; } } if ( ! priv -> mcm ) { priv -> reset = devm_gpiod_get_optional ( & mdiodev -> dev , "reset" , GPIOD_OUT_LOW ) ; if ( IS_ERR ( priv -> reset ) ) { dev_err ( & mdiodev -> dev , "Couldn't get our reset line\n" ) ; return PTR_ERR ( priv -> reset ) ; } } priv -> bus = mdiodev -> bus ; priv -> dev = & mdiodev -> dev ; priv -> ds -> priv = priv ; priv -> ds -> ops = & mt7530_switch_ops ; mutex_init ( & priv -> reg_mutex ) ; dev_set_drvdata ( & mdiodev -> dev , priv ) ; return dsa_register_switch ( priv -> ds ) ; } 