static int expect_matches ( ipptool_expect_t * expect , ipp_attribute_t * attr ) { int i , count , match ; char * of_type , * paren , * next , sep ; ipp_tag_t value_tag ; int lower , upper ; value_tag = ippGetValueTag ( attr ) ; count = ippGetCount ( attr ) ; for ( of_type = expect -> of_type , match = 0 ; ! match && * of_type ; of_type = next ) { for ( next = of_type ; * next && * next != '|' && * next != ',' ; next ++ ) { } if ( ( sep = * next ) != '\0' ) { * next = '\0' ; } if ( ( paren = strchr ( of_type , '(' ) ) != NULL ) { char * ptr ; * paren = '\0' ; if ( ! strncmp ( paren + 1 , "MIN:" , 4 ) ) { lower = INT_MIN ; ptr = paren + 5 ; } if ( ( ptr = strchr ( paren + 1 , ':' ) ) != NULL ) { lower = atoi ( paren + 1 ) ; } else { lower = 0 ; ptr = paren + 1 ; } if ( ! strcmp ( ptr , "MAX)" ) ) { upper = INT_MAX ; } else { upper = atoi ( ptr ) ; } } else { lower = INT_MIN ; upper = INT_MAX ; } if ( ! strcmp ( of_type , "text" ) ) { if ( upper == INT_MAX ) { upper = 1023 ; } if ( value_tag == IPP_TAG_TEXTLANG || value_tag == IPP_TAG_TEXT ) { for ( i = 0 ; i < count ; i ++ ) { if ( strlen ( ippGetString ( attr , i , NULL ) ) > ( size_t ) upper ) { break ; } } match = ( i == count ) ; } } if ( ! strcmp ( of_type , "name" ) ) { if ( upper == INT_MAX ) { upper = 255 ; } if ( value_tag == IPP_TAG_NAMELANG || value_tag == IPP_TAG_NAME ) { for ( i = 0 ; i < count ; i ++ ) { if ( strlen ( ippGetString ( attr , i , NULL ) ) > ( size_t ) upper ) { break ; } } match = ( i == count ) ; } } if ( ! strcmp ( of_type , "collection" ) ) { match = value_tag == IPP_TAG_BEGIN_COLLECTION ; } if ( value_tag == ippTagValue ( of_type ) ) { switch ( value_tag ) { case IPP_TAG_KEYWORD : case IPP_TAG_URI : if ( upper == INT_MAX ) { if ( value_tag == IPP_TAG_KEYWORD ) { upper = 255 ; } else { upper = 1023 ; } } for ( i = 0 ; i < count ; i ++ ) { if ( strlen ( ippGetString ( attr , i , NULL ) ) > ( size_t ) upper ) { break ; } } match = ( i == count ) ; break ; case IPP_TAG_STRING : if ( upper == INT_MAX ) { upper = 1023 ; } for ( i = 0 ; i < count ; i ++ ) { int datalen ; ippGetOctetString ( attr , i , & datalen ) ; if ( datalen > upper ) { break ; } } match = ( i == count ) ; break ; case IPP_TAG_INTEGER : for ( i = 0 ; i < count ; i ++ ) { int value = ippGetInteger ( attr , i ) ; if ( value ( lower || value ) upper ) { break ; } } match = ( i == count ) ; break ; case IPP_TAG_RANGE : for ( i = 0 ; i < count ; i ++ ) { int vupper , vlower = ippGetRange ( attr , i , & vupper ) ; if ( vlower ( lower || vlower ) upper || vupper ( lower || vupper ) upper ) { break ; } } match = ( i == count ) ; break ; default : match = 1 ; break ; } } if ( paren ) { * paren = '(' ; } if ( sep ) { * next ++ = sep ; } } return ( match ) ; } 