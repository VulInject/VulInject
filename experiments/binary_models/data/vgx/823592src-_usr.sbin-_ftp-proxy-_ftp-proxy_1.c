void client_read ( struct bufferevent * bufev , void * arg ) { struct session * s = arg ; size_t buf_avail , read ; int n ; { buf_avail = sizeof s -> cbuf - s -> cbuf_valid ; read = bufferevent_read ( bufev , s -> cbuf + s -> cbuf_valid , buf_avail ) ; s -> cbuf_valid += read ; while ( ( n = get_line ( s -> cbuf , & s -> cbuf_valid ) ) > 0 ) { logmsg ( LOG_DEBUG , "#%d client: %s" , s -> id , linebuf ) ; if ( ! client_parse ( s ) ) { return ; } bufferevent_write ( s -> server_bufev , linebuf , linelen ) ; } if ( n == - 1 ) { logmsg ( LOG_ERR , "#%d client command too long or not" " clean" , s -> id ) ; end_session ( s ) ; return ; } } read == buf_avail ; } 