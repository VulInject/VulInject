if ( woff == NULL ) { return ( we_cantopen ) ; } start = strrchr ( filename , '/' ) ; if ( start == NULL ) { start = filename ; } else { ++ start ; } ext = strrchr ( start , '.' ) ; if ( ext == NULL ) { ext = start + strlen ( start ) ; } fseek ( woff , 0 , SEEK_END ) ; len = ftell ( woff ) ; rewind ( woff ) ; if ( getlong ( woff ) != CHR ( 'w' , 'O' , 'F' , 'F' ) ) { return ( we_badsignature ) ; } flavour = getlong ( woff ) ; iscff = ( flavour == CHR ( 'O' , 'T' , 'T' , 'O' ) ) ; len_stated = getlong ( woff ) ; if ( len != len_stated ) { return ( we_badwofflength ) ; } num_tabs = getushort ( woff ) ; if ( getushort ( woff ) != 0 ) { return ( we_mbz ) ; } getlong ( woff ) ; getushort ( woff ) ; getushort ( woff ) ; metaOffset = getlong ( woff ) ; metaLenCompressed = getlong ( woff ) ; metaLenUncompressed = getlong ( woff ) ; privOffset = getlong ( woff ) ; privLength = getlong ( woff ) ; outname = malloc ( strlen ( start ) + 20 ) ; strcpy ( outname , start ) ; strcpy ( outname + ( ext - start ) , iscff ?".otf" : ".ttf" ) ; sfnt = fopen ( outname , "wb+" ) ; if ( sfnt == NULL ) { free ( outname ) ; fclose ( woff , NULL ) ; return ( we_cantopenout ) ; } putlong ( sfnt , flavour ) ; putshort ( sfnt , num_tabs ) ; for ( i = 1 , j = 0 ; 2 * i <= num_tabs ; i <<= 1 , ++ j ) { } putshort ( sfnt , i * 16 ) ; putshort ( sfnt , j ) ; putshort ( sfnt , ( num_tabs - i ) * 16 ) ; tab_start = ftell ( sfnt ) ; for ( i = 0 ; i < 4 * num_tabs ; ++ i ) { putlong ( sfnt , 0 ) ; } for ( i = 0 ; i < num_tabs ; ++ i ) { tag = getlong ( woff ) ; offset = getlong ( woff ) ; compLen = getlong ( woff ) ; uncompLen = getlong ( woff ) ; checksum = getlong ( woff ) ; if ( compLen > uncompLen || offset + compLen > len ) { fclose ( sfnt ) ; fclose ( woff ) ; free ( outname ) ; return ( we_badtablen ) ; } here = ftell ( woff ) ; next = ftell ( sfnt ) ; fseek ( sfnt , tab_start , SEEK_SET ) ; putlong ( sfnt , tag ) ; putlong ( sfnt , checksum ) ; putlong ( sfnt , next ) ; putlong ( sfnt , uncompLen ) ; if ( tag == CHR ( 'h' , 'e' , 'a' , 'd' ) ) { head_pos = next ; } tab_start = ftell ( sfnt ) ; fseek ( sfnt , next , SEEK_SET ) ; if ( compLen == uncompLen ) { copydata ( sfnt , next , woff , offset , compLen ) ; } else { err = decompressdata ( sfnt , next , woff , offset , compLen , uncompLen ) ; if ( err != we_good ) { fclose ( sfnt ) ; fclose ( woff ) ; free ( outname ) ; return ( err ) ; } } if ( ( ftell ( sfnt ) & 3 ) != 0 ) { if ( ftell ( sfnt ) & 1 ) { putc ( '\0' , sfnt ) ; } if ( ftell ( sfnt ) & 2 ) { putshort ( sfnt , 0 ) ; } } fseek ( woff , here , SEEK_SET ) ; } if ( head_pos != - 1 ) { fseek ( sfnt , head_pos + 8 , SEEK_SET ) ; putlong ( sfnt , 0 ) ; checksum = filecheck ( sfnt ) ; checksum = 0xb1b0afba - checksum ; fseek ( sfnt , head_pos + 8 , SEEK_SET ) ; putlong ( sfnt , checksum ) ; } fclose ( sfnt ) ; if ( metaOffset != 0 ) { strcpy ( outname + ( ext - start ) , "_meta.xml" ) ; meta = fopen ( outname , "wb" ) ; if ( meta == NULL ) { fclose ( woff ) ; free ( outname ) ; return ( we_cantopenout ) ; } err = decompressdata ( meta , 0 , woff , metaOffset , metaLenCompressed , metaLenUncompressed ) ; fclose ( meta ) ; if ( err != we_good ) { fclose ( woff ) ; free ( outname ) ; return ( err ) ; } } if ( privOffset != 0 ) { strcpy ( outname + ( ext - start ) , ".priv" ) ; priv = fopen ( outname , "wb" ) ; if ( priv == NULL ) { fclose ( woff ) ; return ( we_cantopenout ) ; } copydata ( priv , 0 , woff , privOffset , privLength ) ; fclose ( priv ) ; } fclose ( woff ) ; free ( outname ) ; return ( we_good ) ; 