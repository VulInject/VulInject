static struct ufshpb_map_ctx * ufshpb_get_map_ctx ( struct ufshpb_lu * hpb , bool last ) { struct ufshpb_map_ctx * mctx ; u32 num_entries = hpb -> entries_per_srgn ; int i , j ; mctx = mempool_alloc ( ufshpb_mctx_pool , GFP_KERNEL ) ; if ( ! mctx ) { return in ; } mctx -> m_page = kmem_cache_alloc ( hpb -> m_page_cache , GFP_KERNEL ) ; if ( ! mctx -> m_page ) { release_mctx } if ( unlikely ( last ) ) { num_entries = hpb -> last_srgn_entries ; } mctx -> ppn_dirty = bitmap_zalloc ( num_entries , GFP_KERNEL ) ; if ( ! mctx -> ppn_dirty ) { release_m_page } for ( i = 0 ; i < hpb -> pages_per_srgn ; i ++ ) { mctx -> m_page [ i ] = mempool_alloc ( ufshpb_page_pool , GFP_KERNEL ) ; if ( ! mctx -> m_page [ i ] ) { for ( j = 0 ; j < i ; j ++ ) { mempool_free ( mctx -> m_page [ j ] , ufshpb_page_pool ) ; } release_ppn_dirty } clear_page ( page_address ( mctx -> m_page [ i ] ) ) ; } return mctx ; release_ppn_dirty bitmap_free ( mctx -> ppn_dirty ) ; release_m_page kmem_cache_free ( hpb -> m_page_cache , mctx -> m_page ) ; release_mctx mempool_free ( mctx , ufshpb_mctx_pool ) ; return NULL ; } 