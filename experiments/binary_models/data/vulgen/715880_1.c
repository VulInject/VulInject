static ssize_t flash_write ( struct file * file , const char __user * buf , size_t size , loff_t * ppos ) { unsigned long p = * ppos ; unsigned int count = size ; int written ; int nBlock , temp , rc ; int i , j ; if ( flashdebug ) { printk ( "flash_write: offset=0x%lX, buffer=0x%p, count=0x%X.\n" , p , buf , count ) ; } if ( ! gbWriteEnable ) { return - EINVAL ; } if ( p < 64 * 1024 && ( ! gbWriteBase64Enable ) ) { return - EINVAL ; } if ( p >= gbFlashSize ) { return count ?- ENXIO : 0 ; } if ( count > gbFlashSize - p ) { count = gbFlashSize - p ; } if ( ! access_ok ( buf , count ) ) { return - EFAULT ; } written = 0 ; nBlock = ( int ) p >> 16 ; temp = ( ( int ) ( p + count ) >> 16 ) - nBlock + 1 ; if ( ( ( int ) ( p + count ) & 0xFFFF ) == 0 ) { temp -= 1 ; } if ( flashdebug ) { printk ( KERN_DEBUG "flash_write: writing %d block(s) " "starting at %d.\n" , temp , nBlock ) ; } for ( ; temp ; temp -- , nBlock ++ ) { if ( flashdebug ) { printk ( KERN_DEBUG "flash_write: erasing block %d.\n" , nBlock ) ; } i = 0 ; j = 0 ; RetryBlock { rc = erase_block ( nBlock ) ; i ++ ; } rc && i < 10 ; if ( rc ) { printk ( KERN_ERR "flash_write: erase error %x\n" , rc ) ; break ; } if ( flashdebug ) { printk ( KERN_DEBUG "flash_write: writing offset %lX, " "from buf %p, bytes left %X.\n" , p , buf , count - written ) ; } rc = write_block ( p , buf , count - written ) ; j ++ ; if ( ! rc ) { if ( j < 10 ) { RetryBlock } else { rc = - 1 ; } } if ( rc < 0 ) { printk ( KERN_ERR "flash_write: write error %X\n" , rc ) ; break ; } p += rc ; buf += rc ; written += rc ; * ppos += rc ; if ( flashdebug ) { printk ( KERN_DEBUG "flash_write: written 0x%X bytes OK.\n" , written ) ; } } mutex_unlock ( & nwflash_mutex ) ; return written ; } 