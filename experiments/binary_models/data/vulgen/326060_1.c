NTSTATUS VIOSockRxVqInit ( IN PDEVICE_CONTEXT pContext ) { NTSTATUS status = STATUS_SUCCESS ; USHORT uNumEntries ; ULONG uRingSize , uHeapSize , uBufferSize ; TraceEvents ( TRACE_LEVEL_VERBOSE , DBG_HW_ACCESS , "-->%s\n" , __FUNCTION__ ) ; pContext -> RxPktList . Next = NULL ; status = virtio_query_queue_allocation ( & pContext -> VDevice . VIODevice , VIOSOCK_VQ_RX , & uNumEntries , & uRingSize , & uHeapSize ) ; if ( ! NT_SUCCESS ( status ) ) { TraceEvents ( TRACE_LEVEL_ERROR , DBG_HW_ACCESS , "virtio_query_queue_allocation(VIOSOCK_VQ_RX) failed\n" ) ; return status ; } pContext -> RxPktNum = uNumEntries ; uBufferSize = sizeof ( VIOSOCK_RX_PKT ) * uNumEntries ; TraceEvents ( TRACE_LEVEL_INFORMATION , DBG_HW_ACCESS , "Allocating common buffer of %u bytes for %u Rx packets\n" , uBufferSize , uNumEntries ) ; pContext -> RxPktVA = ( PVIOSOCK_RX_PKT ) VirtIOWdfDeviceAllocDmaMemory ( & pContext -> VDevice . VIODevice , uBufferSize , VIOSOCK_DRIVER_MEMORY_TAG ) ; ASSERT ( pContext -> RxPktVA ) ; if ( ! pContext -> RxPktVA ) { TraceEvents ( TRACE_LEVEL_ERROR , DBG_HW_ACCESS , "VirtIOWdfDeviceAllocDmaMemory(%u bytes for RxPackets) failed\n" , uBufferSize ) ; status = STATUS_INSUFFICIENT_RESOURCES ; } if ( VIOSockRxCbInit ( pContext ) ) { ULONG i ; PVIOSOCK_RX_PKT RxPktVA = ( PVIOSOCK_RX_PKT ) pContext -> RxPktVA ; pContext -> RxPktPA = VirtIOWdfDeviceGetPhysicalAddress ( & pContext -> VDevice . VIODevice , pContext -> RxPktVA ) ; ASSERT ( pContext -> RxPktPA . QuadPart ) ; for ( i = 0 ; i < uNumEntries ; i ++ ) { if ( ! VIOSockRxPktInsert ( pContext , & RxPktVA [ i ] ) ) { TraceEvents ( TRACE_LEVEL_ERROR , DBG_HW_ACCESS , "VIOSockRxPktInsert[%u] failed\n" , i ) ; status = STATUS_UNSUCCESSFUL ; break ; } } } else { TraceEvents ( TRACE_LEVEL_ERROR , DBG_HW_ACCESS , "VIOSockRxCbInit failed\n" ) ; status = STATUS_UNSUCCESSFUL ; } if ( ! NT_SUCCESS ( status ) ) { VIOSockRxVqCleanup ( pContext ) ; } return status ; } 