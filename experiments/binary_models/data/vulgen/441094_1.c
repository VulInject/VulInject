static timestruc_t todsg_get ( void ) { tod_iosram_t tod_buf ; time_t seconds ; time_t domain_skew ; int complained = 0 ; ASSERT ( MUTEX_HELD ( & tod_lock ) ) ; if ( ! verify_sc_tod_version ( ) ) { return_hrestime } if ( watchdog_activated != 0 || watchdog_enable != 0 ) { complained = update_heartbeat ( ) ; } if ( ! complained && ( iosram_read ( SBBC_TOD_KEY , OFFSET ( tod_buf , tod_get_value ) , ( char * ) & seconds , sizeof ( time_t ) ) ) ) { complained ++ ; cmn_err ( CE_WARN , "todsg_get(): read 64-bit tod value failed" ) ; } if ( ! complained && skew_adjust ) { complained = update_tod_skew ( 0 ) ; } if ( ! complained && iosram_read ( SBBC_TOD_KEY , OFFSET ( tod_buf , tod_domain_skew ) , ( char * ) & domain_skew , sizeof ( time_t ) ) ) { complained ++ ; cmn_err ( CE_WARN , "todsg_get(): read tod domain skew failed" ) ; } if ( complained ) { cmn_err ( CE_WARN , "todsg_get(): turned off using tod" ) ; todsg_use_sc = 0 ; return_hrestime } if ( seconds != pre_seconds ) { pre_seconds = seconds ; if ( is_sc_down >= SC_DOWN_COUNT_THRESHOLD && adjust_sc_down ) { skew_adjust = hrestime . tv_sec - ( seconds + domain_skew ) ; complained = update_tod_skew ( 0 ) ; if ( ! complained && ( iosram_read ( SBBC_TOD_KEY , OFFSET ( tod_buf , tod_domain_skew ) , ( char * ) & domain_skew , sizeof ( time_t ) ) ) ) { complained ++ ; cmn_err ( CE_WARN , "todsg_get(): " "read tod domain skew failed" ) ; } } is_sc_down = 0 ; adjust_sc_down = 0 ; if ( ! complained ) { tod_status_clear ( TOD_GET_FAILED ) ; timestruc_t ts = { 0 0 } ; ts . tv_sec = seconds + domain_skew ; return ( ts ) ; } else { return_hrestime } } is_sc_down ++ ; if ( timedelta != 0 ) { adjust_sc_down = 1 ; } return_hrestime tod_status_set ( TOD_GET_FAILED ) ; return ( hrestime ) ; } 