static __init int tcpprobe_init ( void ) { int ret = - ENOMEM ; BUILD_BUG_ON ( __same_type ( tcp_rcv_established , jtcp_rcv_established ) == 0 ) ; init_waitqueue_head ( & tcp_probe . wait ) ; spin_lock_init ( & tcp_probe . lock ) ; bufsize = roundup_pow_of_two ( bufsize ) ; tcp_probe . log = kcalloc ( bufsize , sizeof ( tcp_log ) , GFP_KERNEL ) ; if ( ! tcp_probe . log ) { err0 } if ( ! proc_create ( procname , S_IRUSR , init_net . proc_net , & tcpprobe_fops ) ) { err0 } ret = register_jprobe ( & tcp_jprobe ) ; if ( ret ) { err1 } pr_info ( "probe registered (port=%d/fwmark=%u) bufsize=%u\n" , port , fwmark , bufsize ) ; return 0 ; err1 remove_proc_entry ( procname , init_net . proc_net ) ; err0 kfree ( tcp_probe . log ) ; return ret ; } 