u16 usnic_transport_rsrv_port ( enum usnic_transport_type type , u16 port_num ) { if ( type == USNIC_TRANSPORT_ROCE_CUSTOM ) { spin_lock ( & roce_bitmap_lock ) ; if ( ! port_num ) { port_num = bitmap_find_next_zero_area ( roce_bitmap , ROCE_BITMAP_SZ , roce_next_port , 1 , 0 ) ; roce_next_port = ( port_num & 4095 ) + 1 ; } if ( test_bit ( port_num , roce_bitmap ) ) { usnic_err ( "Failed to allocate port for %s\n" , usnic_transport_to_str ( type ) ) ; spin_unlock ( & roce_bitmap_lock ) ; out_fail } spin_unlock ( & roce_bitmap_lock ) ; } else { usnic_err ( "Failed to allocate port - transport %s unsupported\n" , usnic_transport_to_str ( type ) ) ; out_fail } usnic_dbg ( "Allocating port %hu for %s\n" , port_num , usnic_transport_to_str ( type ) ) ; return port_num ; out_fail return 0 ; } 