void acpi_arch_dma_setup ( struct device * dev ) { int ret ; u64 end , mask ; u64 size = 0 ; const struct bus_dma_region * map = NULL ; if ( ! dev -> dma_mask ) { dev_warn ( dev , "DMA mask not set\n" ) ; } if ( dev -> coherent_dma_mask ) { size = max ( dev -> coherent_dma_mask , dev -> coherent_dma_mask + 1 ) ; } else { size = 1ULL << 32 ; } ret = acpi_dma_get_range ( dev , & map ) ; if ( ! ret && map ) { const struct bus_dma_region * r = map ; for ( end = 0 ; r -> size ; r ++ ) { if ( r -> dma_start + r -> size - 1 > end ) { end = r -> dma_start + r -> size - 1 ; } } size = end + 1 ; dev -> dma_range_map = map ; } if ( ret == - ENODEV ) { ret = iort_dma_get_ranges ( dev , & size ) ; } if ( ! ret ) { end = size - 1 ; mask = DMA_BIT_MASK ( ilog2 ( end ) + 1 ) ; dev -> bus_dma_limit = end ; dev -> coherent_dma_mask = min ( dev -> coherent_dma_mask , mask ) ; * dev -> dma_mask = min ( * dev -> dma_mask , mask ) ; } } 