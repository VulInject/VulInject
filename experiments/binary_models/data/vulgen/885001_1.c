static void r8169_transmit ( struct nic * nic , const char * d , unsigned int t , unsigned int s , const char * p ) { u16 nstype ; u32 to ; u8 * ptxb ; int entry = tpc -> cur_tx % NUM_TX_DESC ; ptxb = tpc -> Tx_skbuff [ entry * MAX_ETH_FRAME_SIZE ] ; memcpy ( ptxb , d , ETH_ALEN ) ; memcpy ( ptxb + ETH_ALEN , nic -> node_addr , ETH_ALEN ) ; nstype = htons ( ( u16 ) t ) ; memcpy ( ptxb + 2 * ETH_ALEN , ( u8 * ) & nstype , 2 ) ; memcpy ( ptxb + ETH_HLEN , p , s ) ; s += ETH_HLEN ; s &= 0x0FFF ; while ( s < ETH_ZLEN ) { ptxb [ s ++ ] = '\0' ; } tpc -> TxDescArray [ entry ] . buf_addr = virt_to_bus ( ptxb ) ; if ( entry != ( NUM_TX_DESC - 1 ) ) { tpc -> TxDescArray [ entry ] . status = ( OWNbit | FSbit | LSbit ) | ( ( s > ETH_ZLEN ) ?s : ETH_ZLEN ) ; } else { tpc -> TxDescArray [ entry ] . status = ( OWNbit | EORbit | FSbit | LSbit ) | ( ( s > ETH_ZLEN ) ?s : ETH_ZLEN ) ; } RTL_W8 ( TxPoll , 0x40 ) ; tpc -> cur_tx ++ ; while ( ( tpc -> TxDescArray [ entry ] . status & OWNbit ) && ( currticks ( ) < to ) ) { } if ( currticks ( ) >= to ) { printf ( "TX Time Out" ) ; } } 