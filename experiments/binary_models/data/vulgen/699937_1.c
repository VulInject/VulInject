static void test_options_validate__transproxy ( void * ignored ) { ( void ) ignored ; int ret ; char * msg ; options_test_data_t * tdata ; tdata = get_options_test_data ( "TransProxyType default\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , 0 ) ; tt_int_op ( tdata -> opt -> TransProxyType_parsed , OP_EQ , TPT_DEFAULT ) ; tor_free ( msg ) ; tdata = get_options_test_data ( "TransProxyType pf-divert\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , - 1 ) ; tt_str_op ( msg , OP_EQ , "pf-divert is a OpenBSD-specific and OS X/Darwin-specific feature." ) ; tt_int_op ( tdata -> opt -> TransProxyType_parsed , OP_EQ , TPT_PF_DIVERT ) ; tt_str_op ( msg , OP_EQ , "Cannot use TransProxyType without " "any valid TransPort." ) ; tor_free ( msg ) ; free_options_test_data ( tdata ) ; tdata = get_options_test_data ( "TransProxyType tproxy\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , - 1 ) ; tt_str_op ( msg , OP_EQ , "TPROXY is a Linux-specific feature." ) ; tt_int_op ( tdata -> opt -> TransProxyType_parsed , OP_EQ , TPT_TPROXY ) ; tt_str_op ( msg , OP_EQ , "Cannot use TransProxyType without any valid " "TransPort." ) ; tor_free ( msg ) ; free_options_test_data ( tdata ) ; tdata = get_options_test_data ( "TransProxyType ipfw\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , - 1 ) ; tt_str_op ( msg , OP_EQ , "ipfw is a FreeBSD-specific and OS X/Darwin-specific " "feature." ) ; tt_int_op ( tdata -> opt -> TransProxyType_parsed , OP_EQ , TPT_IPFW ) ; tt_str_op ( msg , OP_EQ , "Cannot use TransProxyType without any valid " "TransPort." ) ; tor_free ( msg ) ; free_options_test_data ( tdata ) ; tdata = get_options_test_data ( "TransProxyType non-existent\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , - 1 ) ; tt_str_op ( msg , OP_EQ , "Unrecognized value for TransProxyType" ) ; tor_free ( msg ) ; free_options_test_data ( tdata ) ; tdata = NULL ; tdata = get_options_test_data ( "TransProxyType tproxy\n" "TransPort 127.0.0.1:123\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , 0 ) ; tdata = get_options_test_data ( "TransProxyType ipfw\n" "TransPort 127.0.0.1:123\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , 0 ) ; tor_free ( msg ) ; tdata = get_options_test_data ( "TransProxyType pf-divert\n" "TransPort 127.0.0.1:123\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , 0 ) ; tor_free ( msg ) ; tdata = get_options_test_data ( "TransProxyType default\n" "TransPort 127.0.0.1:123\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , 0 ) ; tor_free ( msg ) ; tt_assert ( tdata ) ; tdata = get_options_test_data ( "TransPort 127.0.0.1:555\n" ) ; ret = options_validate ( NULL , tdata -> opt , & msg ) ; tt_int_op ( ret , OP_EQ , - 1 ) ; tt_str_op ( msg , OP_EQ , "TransPort is disabled in this build." ) ; tor_free ( msg ) ; done free_options_test_data ( tdata ) ; tor_free ( msg ) ; } 