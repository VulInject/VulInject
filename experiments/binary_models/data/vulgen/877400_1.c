int rfapiRibPreloadBi ( struct agg_node * rfd_rib_node , struct prefix * pfx_vn , struct prefix * pfx_un , uint32_t lifetime , struct bgp_path_info * bpi ) { struct rfapi_descriptor * rfd ; struct skiplist * slRibPt = NULL ; struct rfapi_info * ori = NULL ; struct rfapi_rib_key rk ; struct agg_node * trn ; afi_t afi ; const struct prefix * p = agg_node_get_prefix ( rfd_rib_node ) ; if ( ! rfd_rib_node ) { return 0 ; } afi = family2afi ( p -> family ) ; rfd = agg_get_table_info ( agg_get_table ( rfd_rib_node ) ) ; memset ( ( void * ) & rk , 0 , sizeof ( rk ) ) ; rk . vn = * pfx_vn ; rk . rd = bpi -> extra -> vnc . import . rd ; if ( bpi -> extra -> vnc . import . aux_prefix . family ) { rk . aux_prefix = bpi -> extra -> vnc . import . aux_prefix ; } slRibPt = ( skiplist * ) rfd_rib_node -> info ; if ( slRibPt && ! skiplist_search ( slRibPt , & rk , ( void * * ) & ori ) ) { ori -> un = * pfx_un ; rfapiRibBi2Ri ( bpi , ori , lifetime ) ; } else { ori = rfapi_info_new ( ) ; ori -> rk = rk ; ori -> un = * pfx_un ; rfapiRibBi2Ri ( bpi , ori , lifetime ) ; if ( ! slRibPt ) { slRibPt = skiplist_new ( 0 , rfapi_rib_key_cmp , NULL ) ; rfd_rib_node -> info = slRibPt ; agg_lock_node ( rfd_rib_node ) ; RFAPI_RIB_PREFIX_COUNT_INCR ( rfd , rfd -> bgp -> rfapi ) ; } skiplist_insert ( slRibPt , & ori -> rk , ori ) ; } ori -> last_sent_time = monotime ( NULL ) ; RFAPI_RIB_CHECK_COUNTS ( 0 , 0 ) ; rfapiRibStartTimer ( rfd , ori , rfd_rib_node , 0 ) ; RFAPI_RIB_CHECK_COUNTS ( 0 , 0 ) ; trn = agg_node_get ( rfd -> rsp_times [ afi ] , p ) ; trn -> info = ( void * ) ( uintptr_t ) monotime ( NULL ) ; if ( agg_node_get_lock_count ( trn ) > 1 ) { agg_unlock_node ( trn ) ; } return 0 ; } 