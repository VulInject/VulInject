int nwamd_start_childv ( const char * command , char const * const * argv ) { posix_spawnattr_t attr ; sigset_t fullset ; int i , rc , status , n ; pid_t pid ; char vbuf [ 1024 ] ; vbuf [ 0 ] = 0 ; n = sizeof ( vbuf ) ; for ( i = 1 ; argv [ i ] != NULL && n > 2 ; i ++ ) { n -= strlcat ( vbuf , " " , n ) ; n -= strlcat ( vbuf , argv [ i ] , n ) ; } if ( ( rc = posix_spawnattr_init ( & attr ) ) != 0 ) { nlog ( LOG_DEBUG , "posix_spawnattr_init %d %s\n" , rc , strerror ( rc ) ) ; return ( - 1 ) ; } ( void ) sigfillset ( & fullset ) ; if ( ( rc = posix_spawnattr_setsigdefault ( & attr , & fullset ) ) != 0 ) { nlog ( LOG_DEBUG , "setsigdefault %d %s\n" , rc , strerror ( rc ) ) ; return ( - 1 ) ; } if ( ( rc = posix_spawnattr_setsigmask ( & attr , & original_sigmask ) ) != 0 ) { nlog ( LOG_DEBUG , "setsigmask %d %s\n" , rc , strerror ( rc ) ) ; return ( - 1 ) ; } if ( ( rc = posix_spawnattr_setflags ( & attr , POSIX_SPAWN_SETSIGDEF | POSIX_SPAWN_SETSIGMASK ) ) != 0 ) { nlog ( LOG_DEBUG , "setflags %d %s\n" , rc , strerror ( rc ) ) ; return ( - 1 ) ; } if ( ( rc = posix_spawnp ( & pid , command , NULL , & attr , ( char * const * ) argv , environ ) ) > 0 ) { nlog ( LOG_DEBUG , "posix_spawnp failed errno %d" , rc ) ; return ( - 1 ) ; } if ( ( rc = posix_spawnattr_destroy ( & attr ) ) != 0 ) { nlog ( LOG_DEBUG , "posix_spawn_attr_destroy %d %s\n" , rc , strerror ( rc ) ) ; return ( - 1 ) ; } ( void ) waitpid ( pid , & status , 0 ) ; if ( WIFSIGNALED ( status ) || WIFSTOPPED ( status ) ) { i = WIFSIGNALED ( status ) ?WTERMSIG ( status ) : WSTOPSIG ( status ) ; nlog ( LOG_ERR , "'%s%s' %s with signal %d (%s)" , command , vbuf , ( WIFSIGNALED ( status ) ?"terminated" : "stopped" ) , i , strsignal ( i ) ) ; return ( - 2 ) ; } else { nlog ( LOG_INFO , "'%s%s' completed normally: %d" , command , vbuf , WEXITSTATUS ( status ) ) ; return ( WEXITSTATUS ( status ) ) ; } } 