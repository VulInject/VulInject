int hpet_rtc_timer_init ( void ) { unsigned int cfg , cnt , delta ; unsigned long flags ; if ( ! hpet_default_delta ) { uint64_t clc ; clc = ( uint64_t ) hpet_clockevent . mult * NSEC_PER_SEC ; clc >>= hpet_clockevent . shift + DEFAULT_RTC_SHIFT ; hpet_default_delta = clc ; } if ( ! ( hpet_rtc_flags & RTC_PIE ) || hpet_pie_limit ) { delta = hpet_default_delta ; } else { delta = hpet_pie_delta ; } local_irq_save ( flags ) ; cnt = delta + hpet_readl ( HPET_COUNTER ) ; hpet_writel ( cnt , HPET_T1_CMP ) ; hpet_t1_cmp = cnt ; cfg = hpet_readl ( HPET_T1_CFG ) ; cfg &= ~ HPET_TN_PERIODIC ; cfg |= HPET_TN_ENABLE | HPET_TN_32BIT ; hpet_writel ( cfg , HPET_T1_CFG ) ; local_irq_restore ( flags ) ; return 1 ; } 