static void esb2rom_cleanup ( struct esb2rom_window * window ) { struct esb2rom_map_info * map , * scratch ; u8 byte ; pci_read_config_byte ( window -> pdev , BIOS_CNTL , & byte ) ; pci_write_config_byte ( window -> pdev , BIOS_CNTL , byte & ~ BIOS_WRITE_ENABLE ) ; list_for_each_entry_safe ( , , , ) { if ( map -> rsrc . parent ) { release_resource ( & map -> rsrc ) ; } mtd_device_unregister ( map -> mtd ) ; map_destroy ( map -> mtd ) ; list_del ( & map -> list ) ; } if ( window -> rsrc . parent ) { release_resource ( & window -> rsrc ) ; } if ( window -> virt ) { iounmap ( window -> virt ) ; window -> virt = NULL ; window -> phys = 0 ; window -> size = 0 ; } pci_dev_put ( window -> pdev ) ; } 