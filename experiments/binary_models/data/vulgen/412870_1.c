int mem2node__init ( struct mem2node * map , struct perf_env * env ) { struct memory_node * n , * nodes = & env -> memory_nodes [ 0 ] ; struct phys_entry * entries , * tmp_entries ; u64 bsize = env -> memory_bsize ; int i , j = 0 , max = 0 ; memset ( map , 0x0 , sizeof ( * map ) ) ; map -> root = RB_ROOT ; for ( i = 0 ; i < env -> nr_memory_nodes ; i ++ ) { n = & nodes [ i ] ; max += bitmap_weight ( n -> set , n -> size ) ; } entries = zalloc ( sizeof ( * entries ) * max ) ; if ( ! entries ) { return - ENOMEM ; } for ( i = 0 ; i < env -> nr_memory_nodes ; i ++ ) { u64 bit ; n = & nodes [ i ] ; for ( bit = 0 ; bit < n -> size ; bit ++ ) { u64 start ; if ( ! test_bit ( bit , n -> set ) ) { continue ; } start = bit * bsize ; if ( j > 0 ) { struct phys_entry * prev = & entries [ j - 1 ] ; if ( ( prev -> end == start ) && ( prev -> node == n -> node ) ) { prev -> end += bsize ; continue ; } } phys_entry__init ( & entries [ j ++ ] , start , bsize , n -> node ) ; } } if ( tmp_entries || WARN_ONCE ( j == 0 , "No memory nodes, is CONFIG_MEMORY_HOTPLUG enabled?\n" ) ) { entries = tmp_entries ; } for ( i = 0 ; i < j ; i ++ ) { pr_debug ( "mem2node %03" PRIu64 " [0x%016" PRIx64 "-0x%016" PRIx64 "]\n" , entries [ i ] . node , entries [ i ] . start , entries [ i ] . end ) ; phys_entry__insert ( & entries [ i ] , & map -> root ) ; } map -> entries = entries ; return 0 ; } 