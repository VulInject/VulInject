START_TEST ( ) { int res ; const char * symlink_path = "/tmp/prt-scoreboard/symlink" ; res = mkdir ( test_dir , 0775 ) ; ck_assert_msg ( res == 0 , "Failed to create directory '%s': %s" , test_dir , strerror ( errno ) ) ; ck_assert_msg ( res == 0 , "Failed to set perms on '%s': %s" , test_dir , strerror ( errno ) ) ; res = pr_set_scoreboard ( test_file ) ; ck_assert_msg ( res == 0 , "Failed to set scoreboard to '%s': %s" , test_file , strerror ( errno ) ) ; if ( symlink ( symlink_path , test_file ) == 0 ) { res = pr_open_scoreboard ( O_RDWR ) ; if ( res == 0 ) { ( void ) unlink ( symlink_path ) ; ck_abort_msg ( "Unexpectedly opened symlink scoreboard" ) ; } if ( errno != EPERM ) { int xerrno = errno ; ( void ) unlink ( symlink_path ) ; ck_abort_msg ( "Failed to set errno to EPERM (got %d)" , xerrno ) ; } ( void ) unlink ( symlink_path ) ; res = pr_set_scoreboard ( test_file ) ; ck_assert_msg ( res == 0 , "Failed to set scoreboard to '%s': %s" , test_file , strerror ( errno ) ) ; } res = pr_open_scoreboard ( O_RDONLY ) ; ck_assert_msg ( res < 0 , "Unexpectedly opened scoreboard using O_RDONLY" ) ; if ( errno != EINVAL ) { int xerrno = errno ; ( void ) unlink ( symlink_path ) ; ck_abort_msg ( "Failed to set errno to EINVAL (got %d)" , xerrno ) ; } ( void ) unlink ( test_mutex ) ; ( void ) unlink ( test_file ) ; res = pr_open_scoreboard ( O_RDWR ) ; ck_assert_msg ( res == 0 , "Failed to open scoreboard: %s" , strerror ( errno ) ) ; res = pr_open_scoreboard ( O_RDWR ) ; ck_assert_msg ( res == 0 , "Failed to open scoreboard again: %s" , strerror ( errno ) ) ; mark_point ( ) ; pr_close_scoreboard ( FALSE ) ; res = pr_open_scoreboard ( O_RDONLY ) ; ck_assert_msg ( res < 0 , "Unexpectedly opened scoreboard using O_RDONLY" ) ; ck_assert_msg ( errno == EINVAL , "Expected EINVAL (%d), got %s (%d)" , EINVAL , strerror ( errno ) , errno ) ; mark_point ( ) ; res = pr_open_scoreboard ( O_RDWR ) ; ck_assert_msg ( res == 0 , "Failed to open scoreboard: %s" , strerror ( errno ) ) ; res = pr_close_scoreboard ( FALSE ) ; ck_assert_msg ( res == 0 , "Failed to close scoreboard: %s" , strerror ( errno ) ) ; mark_point ( ) ; res = pr_close_scoreboard ( FALSE ) ; ck_assert_msg ( res == 0 , "Failed to close scoreboard: %s" , strerror ( errno ) ) ; ( void ) unlink ( test_mutex ) ; ( void ) unlink ( test_file ) ; ( void ) rmdir ( test_dir ) ; } 