static void * xs_talkv ( struct xenbus_transaction t , enum xsd_sockmsg_type type , const struct kvec * iovec , unsigned int num_vecs , unsigned int * len ) { struct xb_req_data * req ; struct xsd_sockmsg msg ; void * ret = NULL ; unsigned int i ; int err ; req = kmalloc ( sizeof ( * req ) , GFP_NOIO | __GFP_HIGH ) ; if ( ! req ) { return ERR_PTR ( - ENOMEM ) ; } req -> vec = iovec ; req -> num_vecs = num_vecs ; req -> user_req = false ; msg . req_id = 0 ; msg . tx_id = t . id ; msg . type = type ; msg . len = 0 ; for ( i = 0 ; i < num_vecs ; i ++ ) { msg . len += iovec [ i ] . iov_len ; } xs_send ( req , & msg ) ; ret = xs_wait_for_reply ( req , & msg ) ; if ( len ) { * len = msg . len ; } if ( IS_ERR ( ret ) ) { return ret ; } if ( msg . type == XS_ERROR ) { err = get_error ( ret ) ; kfree ( ret ) ; return ERR_PTR ( - err ) ; } if ( msg . type != type ) { pr_warn_ratelimited ( "unexpected type [%d], expected [%d]\n" , msg . type , type ) ; kfree ( ret ) ; return ERR_PTR ( - EINVAL ) ; } return ret ; } 