static struct dns_response * parse_dns_response ( const u_char * answer , int size ) { struct dns_response * resp ; const u_char * cp ; resp = calloc ( 1 , sizeof ( * resp ) ) ; cp = answer ; memcpy ( & resp -> header , cp , HFIXEDSZ ) ; cp += HFIXEDSZ ; resp -> header . qdcount = ntohs ( resp -> header . qdcount ) ; resp -> header . ancount = ntohs ( resp -> header . ancount ) ; resp -> header . nscount = ntohs ( resp -> header . nscount ) ; resp -> header . arcount = ntohs ( resp -> header . arcount ) ; if ( resp -> header . qdcount < 1 ) { free_dns_response ( resp ) ; return ( NULL ) ; } resp -> query = parse_dns_qsection ( answer , size , & cp , resp -> header . qdcount ) ; if ( resp -> header . qdcount && resp -> query == NULL ) { free_dns_response ( resp ) ; return ( NULL ) ; } resp -> answer = parse_dns_rrsection ( answer , size , & cp , resp -> header . ancount ) ; if ( resp -> header . ancount && resp -> answer == NULL ) { free_dns_response ( resp ) ; return ( NULL ) ; } resp -> authority = parse_dns_rrsection ( answer , size , & cp , resp -> header . nscount ) ; if ( resp -> header . nscount && resp -> authority == NULL ) { free_dns_response ( resp ) ; return ( NULL ) ; } resp -> additional = parse_dns_rrsection ( answer , size , & cp , resp -> header . arcount ) ; if ( resp -> header . arcount && resp -> additional == NULL ) { free_dns_response ( resp ) ; return ( NULL ) ; } return ( resp ) ; } 