struct vpf_fh * VPF_Open ( const char * path , mode_t mode , pid_t * pidptr ) { struct vpf_fh * pfh ; struct stat sb ; int fd ; fd = VFL_Open ( path , O_WRONLY | O_CREAT | O_TRUNC | O_CLOEXEC | O_NONBLOCK , mode ) ; if ( fd == - 1 ) { if ( errno == EWOULDBLOCK && pidptr != NULL ) { errno = VPF_Read ( path , pidptr ) ; if ( errno == 0 ) { errno = EEXIST ; } } return ( NULL ) ; } pfh = malloc ( sizeof ( * pfh ) ) ; AN ( pfh ) ; pfh -> pf_path = strdup ( path ) ; AN ( pfh -> pf_path ) ; pfh -> pf_fd = fd ; pfh -> pf_dev = sb . st_dev ; pfh -> pf_ino = sb . st_ino ; return ( pfh ) ; } 