( wm5100_detect ) ; static irqreturn_t wm5100_irq ( int irq , void * data ) { struct wm5100_priv * wm5100 = data ; irqreturn_t status = IRQ_NONE ; unsigned int irq_val , mask_val ; int ret ; ret = regmap_read ( wm5100 -> regmap , WM5100_INTERRUPT_STATUS_3 , & irq_val ) ; if ( ret < 0 ) { dev_err ( wm5100 -> dev , "Failed to read IRQ status 3: %d\n" , ret ) ; irq_val = 0 ; } ret = regmap_read ( wm5100 -> regmap , WM5100_INTERRUPT_STATUS_3_MASK , & mask_val ) ; if ( ret < 0 ) { dev_err ( wm5100 -> dev , "Failed to read IRQ mask 3: %d\n" , ret ) ; mask_val = 0xffff ; } irq_val &= ~ mask_val ; regmap_write ( wm5100 -> regmap , WM5100_INTERRUPT_STATUS_3 , irq_val ) ; wm5100_log_status3 ( wm5100 , irq_val ) ; if ( irq_val & WM5100_FLL1_LOCK_EINT ) { dev_dbg ( wm5100 -> dev , "FLL1 locked\n" ) ; complete ( & wm5100 -> fll [ 0 ] . lock ) ; } if ( irq_val & WM5100_FLL2_LOCK_EINT ) { dev_dbg ( wm5100 -> dev , "FLL2 locked\n" ) ; complete ( & wm5100 -> fll [ 1 ] . lock ) ; } if ( irq_val & WM5100_ACCDET_EINT ) { wm5100_micd_irq ( wm5100 ) ; } ret = regmap_read ( wm5100 -> regmap , WM5100_INTERRUPT_STATUS_4 , & irq_val ) ; if ( ret < 0 ) { dev_err ( wm5100 -> dev , "Failed to read IRQ status 4: %d\n" , ret ) ; irq_val = 0 ; } ret = regmap_read ( wm5100 -> regmap , WM5100_INTERRUPT_STATUS_4_MASK , & mask_val ) ; if ( ret < 0 ) { dev_err ( wm5100 -> dev , "Failed to read IRQ mask 4: %d\n" , ret ) ; mask_val = 0xffff ; } irq_val &= ~ mask_val ; if ( irq_val ) { status = IRQ_HANDLED ; } regmap_write ( wm5100 -> regmap , WM5100_INTERRUPT_STATUS_4 , irq_val ) ; wm5100_log_status4 ( wm5100 , irq_val ) ; return status ; } 