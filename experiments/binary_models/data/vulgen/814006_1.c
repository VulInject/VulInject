static int scc_send_packet ( struct sk_buff * skb , struct net_device * dev ) { struct scc_priv * priv = dev -> ml_priv ; unsigned long flags ; int i ; netif_stop_queue ( dev ) ; i = priv -> tx_head ; skb_copy_from_linear_data_offset ( skb , 1 , priv -> tx_buf [ i ] , skb -> len - 1 ) ; priv -> tx_len [ i ] = skb -> len - 1 ; spin_lock_irqsave ( & priv -> ring_lock , flags ) ; priv -> tx_head = ( i + 1 ) % NUM_TX_BUF ; priv -> tx_count ++ ; if ( priv -> tx_count < NUM_TX_BUF ) { netif_wake_queue ( dev ) ; } if ( priv -> state == IDLE ) { priv -> state = TX_HEAD ; priv -> tx_start = jiffies ; write_scc ( priv , R5 , TxCRC_ENAB | RTS | TxENAB | Tx8 ) ; write_scc ( priv , R15 , 0 ) ; start_timer ( priv , priv -> param . txdelay , 0 ) ; } spin_unlock_irqrestore ( & priv -> ring_lock , flags ) ; dev_kfree_skb ( skb ) ; return NETDEV_TX_OK ; } 