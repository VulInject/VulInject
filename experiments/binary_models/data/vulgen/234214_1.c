static void position_check ( int expected_y , int expected_x , char * legend ) { char buf [ 20 ] ; char * s ; int y , x ; _nc_flush ( ) ; memset ( buf , '\0' , sizeof ( buf ) ) ; putp ( "\033[6n" ) ; _nc_flush ( ) ; * ( s = buf ) = 0 ; { int ask = sizeof ( buf ) - 1 - ( s - buf ) ; int got = read ( 0 , s , ask ) ; if ( got == 0 ) { break ; } s += got ; } strchr ( buf , 'R' ) == 0 ; _tracef ( "probe returned %s" , _nc_visbuf ( buf ) ) ; if ( sscanf ( buf , "\033[%d;%dR" , & y , & x ) != 2 ) { _tracef ( "position probe failed in %s" , legend ) ; } else { if ( expected_x < 0 ) { expected_x = x - 1 ; } if ( expected_y < 0 ) { expected_y = y - 1 ; } if ( y - 1 != expected_y || x - 1 != expected_x ) { beep ( ) ; tputs ( tparm ( "\033[%d;%dH" , expected_y + 1 , expected_x + 1 ) , 1 , _nc_outch ) ; _tracef ( "position seen (%d, %d) doesn't match expected one (%d, %d) in %s" , y - 1 , x - 1 , expected_y , expected_x , legend ) ; } else { _tracef ( "position matches OK in %s" , legend ) ; } } } 