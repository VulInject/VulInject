TEST_IMPL ( ) { RETURN_SKIP ( NO_SELF_CONNECT ) ; uv_loop_t * loop ; char buf [ 1024 ] ; size_t len ; int r ; loop = uv_default_loop ( ) ; ASSERT_NOT_NULL ( loop ) ; r = uv_pipe_init ( loop , & pipe_server , 0 ) ; ASSERT ( r == 0 ) ; len = sizeof buf ; r = uv_pipe_getsockname ( & pipe_server , buf , & len ) ; ASSERT ( r == UV_EBADF ) ; len = sizeof buf ; r = uv_pipe_getpeername ( & pipe_server , buf , & len ) ; ASSERT ( r == UV_EBADF ) ; r = uv_pipe_bind ( & pipe_server , TEST_PIPENAME ) ; ASSERT ( r == 0 ) ; len = sizeof buf ; r = uv_pipe_getsockname ( & pipe_server , buf , & len ) ; ASSERT ( r == 0 ) ; ASSERT ( buf [ len - 1 ] != 0 ) ; ASSERT ( buf [ len ] == '\0' ) ; ASSERT ( memcmp ( buf , TEST_PIPENAME , len ) == 0 ) ; len = sizeof buf ; r = uv_pipe_getpeername ( & pipe_server , buf , & len ) ; ASSERT ( r == UV_ENOTCONN ) ; ASSERT ( r == 0 ) ; r = uv_pipe_init ( loop , & pipe_client , 0 ) ; ASSERT ( r == 0 ) ; len = sizeof buf ; r = uv_pipe_getsockname ( & pipe_client , buf , & len ) ; ASSERT ( r == UV_EBADF ) ; len = sizeof buf ; r = uv_pipe_getpeername ( & pipe_client , buf , & len ) ; ASSERT ( r == UV_EBADF ) ; uv_pipe_connect ( & connect_req , & pipe_client , TEST_PIPENAME , pipe_client_connect_cb ) ; len = sizeof buf ; r = uv_pipe_getsockname ( & pipe_client , buf , & len ) ; ASSERT ( r == 0 && len == 0 ) ; len = sizeof buf ; r = uv_pipe_getpeername ( & pipe_client , buf , & len ) ; ASSERT ( r == 0 ) ; ASSERT ( buf [ len - 1 ] != 0 ) ; ASSERT ( memcmp ( buf , TEST_PIPENAME , len ) == 0 ) ; r = uv_run ( loop , UV_RUN_DEFAULT ) ; ASSERT ( r == 0 ) ; ASSERT ( pipe_client_connect_cb_called == 1 ) ; ASSERT ( pipe_close_cb_called == 2 ) ; MAKE_VALGRIND_HAPPY ( ) ; return 0 ; } 