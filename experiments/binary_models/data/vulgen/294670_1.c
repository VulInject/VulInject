static void server_init_1 ( IRC_SERVER_REC * server ) { IRC_SERVER_CONNECT_REC * conn ; char * cmd ; g_return_if_fail ( server != NULL ) ; conn = server -> connrec ; if ( conn -> proxy != NULL && conn -> proxy_password != NULL && * conn -> proxy_password != '\0' ) { cmd = g_strdup_printf ( "PASS %s" , conn -> proxy_password ) ; irc_send_cmd_now ( server , cmd ) ; g_free ( cmd ) ; } if ( conn -> proxy != NULL && conn -> proxy_string != NULL ) { cmd = g_strdup_printf ( conn -> proxy_string , conn -> address , conn -> port ) ; irc_send_cmd_now ( server , cmd ) ; g_free ( cmd ) ; } if ( conn -> sasl_mechanism != SASL_MECHANISM_NONE ) { irc_cap_toggle ( server , CAP_SASL , TRUE ) ; } irc_cap_toggle ( server , CAP_MULTI_PREFIX , TRUE ) ; irc_cap_toggle ( server , CAP_EXTENDED_JOIN , TRUE ) ; irc_cap_toggle ( server , CAP_SETNAME , TRUE ) ; irc_cap_toggle ( server , CAP_INVITE_NOTIFY , TRUE ) ; irc_cap_toggle ( server , CAP_AWAY_NOTIFY , TRUE ) ; irc_cap_toggle ( server , CAP_CHGHOST , TRUE ) ; irc_cap_toggle ( server , CAP_ACCOUNT_NOTIFY , TRUE ) ; irc_cap_toggle ( server , CAP_SELF_MESSAGE , TRUE ) ; irc_cap_toggle ( server , CAP_SERVER_TIME , TRUE ) ; if ( ! g_hash_table_contains ( server -> isupport , "CHANMODES" ) ) { g_hash_table_insert ( server -> isupport , g_strdup ( "CHANMODES" ) , g_strdup ( "beI,k,l,imnpst" ) ) ; } if ( ! g_hash_table_contains ( server -> isupport , "PREFIX" ) ) { g_hash_table_insert ( server -> isupport , g_strdup ( "PREFIX" ) , g_strdup ( "(ohv)@%+" ) ) ; } server -> cmdcount = 0 ; server -> wait_cmd = g_get_real_time ( ) ; server -> wait_cmd += 120 * G_USEC_PER_SEC ; if ( ! conn -> no_cap ) { signal_emit ( "server waiting cap ls" , 2 , server , CAP_LS_VERSION ) ; irc_send_cmd_now ( server , "CAP LS " CAP_LS_VERSION ) ; irc_send_cmd_now ( server , "JOIN :" ) ; } if ( conn -> starttls ) { irc_server_send_starttls ( server ) ; } if ( conn -> no_cap ) { server_init_2 ( server ) ; } } 