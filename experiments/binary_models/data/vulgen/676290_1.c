static int fill_topology_info ( const struct sseu_dev_info * sseu , struct drm_i915_query_item * query_item , intel_sseu_ss_mask_t subslice_mask ) { struct drm_i915_query_topology_info topo ; u32 slice_length , subslice_length , eu_length , total_length ; int ss_stride = GEN_SSEU_STRIDE ( sseu -> max_subslices ) ; int eu_stride = GEN_SSEU_STRIDE ( sseu -> max_eus_per_subslice ) ; int ret ; BUILD_BUG_ON ( sizeof ( u8 ) != sizeof ( sseu -> slice_mask ) ) ; slice_length = sizeof ( sseu -> slice_mask ) ; subslice_length = sseu -> max_slices * ss_stride ; eu_length = sseu -> max_slices * sseu -> max_subslices * eu_stride ; total_length = sizeof ( topo ) + slice_length + subslice_length + eu_length ; ret = copy_query_item ( & topo , sizeof ( topo ) , total_length , query_item ) ; if ( ret != 0 ) { return ret ; } memset ( & topo , 0 , sizeof ( topo ) ) ; topo . max_slices = sseu -> max_slices ; topo . max_subslices = sseu -> max_subslices ; topo . max_eus_per_subslice = sseu -> max_eus_per_subslice ; topo . subslice_offset = slice_length ; topo . subslice_stride = ss_stride ; topo . eu_offset = slice_length + subslice_length ; topo . eu_stride = eu_stride ; if ( copy_to_user ( u64_to_user_ptr ( query_item -> data_ptr ) , & topo , sizeof ( topo ) ) ) { return - EFAULT ; } if ( copy_to_user ( u64_to_user_ptr ( query_item -> data_ptr + sizeof ( topo ) ) , & sseu -> slice_mask , slice_length ) ) { return - EFAULT ; } if ( intel_sseu_copy_ssmask_to_user ( u64_to_user_ptr ( query_item -> data_ptr + sizeof ( topo ) + slice_length ) , sseu ) ) { return - EFAULT ; } if ( intel_sseu_copy_eumask_to_user ( u64_to_user_ptr ( query_item -> data_ptr + sizeof ( topo ) + slice_length + subslice_length ) , sseu ) ) { return - EFAULT ; } return total_length ; } 