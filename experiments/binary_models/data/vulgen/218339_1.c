( top ) ; ( i = 0 i < top ++ i ) { topvalues [ i ] = values [ i ] totvalues [ i ] = cnt [ i ] * values [ i ] } ; while ( top > max ) { off = fabs ( topvalues [ 0 ] - values [ 1 ] ) ; offpos = 0 ; for ( i = 1 ; i < top - 1 ; ++ i ) { test = fabs ( topvalues [ i ] - values [ i + 1 ] ) ; if ( test < off ) { off = test ; offpos = i ; } } topvalues [ offpos ] = topvalues [ offpos + 1 ] ; cnt [ offpos ] += cnt [ offpos + 1 ] ; totvalues [ offpos ] += totvalues [ offpos + 1 ] ; diff = 1 ; for ( k = offpos + 1 ; k + diff < top ; ++ k ) { values [ k ] = values [ k + diff ] ; topvalues [ k ] = topvalues [ k + diff ] ; cnt [ k ] = cnt [ k + diff ] ; totvalues [ k ] = totvalues [ k + diff ] ; } for ( k = 0 ; k <= maxc ; ++ k ) { if ( index [ k ] > offpos ) { index [ k ] -= diff ; } } top -= diff ; } values [ 0 ] = 0 ; for ( i = 1 ; i < top ; ++ i ) { values [ i ] = totvalues [ i ] / cnt [ i ] ; } if ( maxc > 256 ) { free ( topvalues ) ; free ( totvalues ) ; free ( cnt ) ; } return ( top ) ; 