static void normalization_test ( void ) { FILE * file ; unsigned int unichar ; struct unicode_data * data ; char * s ; char * t ; int ret ; int ignorables ; int tests = 0 ; int failures = 0 ; if ( verbose > 0 ) { printf ( "Parsing %s\n" , test_name ) ; } file = fopen ( test_name , "r" ) ; while ( fgets ( line , LINESIZE , file ) ) { ret = sscanf ( line , "%[^;];%*[^;];%[^;];%*[^;];%*[^;];" , buf0 , buf1 ) ; if ( ret != 2 || * line == '#' ) { continue ; } s = buf0 ; t = buf2 ; while ( * s ) { unichar = strtoul ( s , & s , 16 ) ; t += utf8encode ( t , unichar ) ; } * t = '\0' ; ignorables = 0 ; s = buf1 ; t = buf3 ; while ( * s ) { unichar = strtoul ( s , & s , 16 ) ; data = & unicode_data [ unichar ] ; if ( data -> utf8nfdi && ! * data -> utf8nfdi ) { ignorables = 1 ; } else { t += utf8encode ( t , unichar ) ; } } * t = '\0' ; tests ++ ; if ( normalize_line ( nfdi_tree ) < 0 ) { printf ( "Line %s ->%s" , buf0 , buf1 ) ; if ( ignorables ) { printf ( " (ignorables removed)" ) ; } printf ( " failure\n" ) ; failures ++ ; } } fclose ( file ) ; if ( verbose > 0 ) { printf ( "Ran %d tests with %d failures\n" , tests , failures ) ; } if ( failures ) { file_fail ( test_name ) ; } } 