static unsigned long alloc_iommu ( struct device * dev , int size , unsigned long align_mask ) { unsigned long offset , flags ; unsigned long boundary_size ; unsigned long base_index ; base_index = ALIGN ( iommu_bus_base & dma_get_seg_boundary ( dev ) , PAGE_SIZE ) >> PAGE_SHIFT ; spin_lock_irqsave ( & iommu_bitmap_lock , flags ) ; offset = iommu_area_alloc ( iommu_gart_bitmap , iommu_pages , next_bit , size , base_index , boundary_size , align_mask ) ; if ( offset == - 1 ) { need_flush = true ; offset = iommu_area_alloc ( iommu_gart_bitmap , iommu_pages , 0 , size , base_index , boundary_size , align_mask ) ; } if ( offset != - 1 ) { next_bit = offset + size ; if ( next_bit >= iommu_pages ) { next_bit = 0 ; need_flush = true ; } } if ( iommu_fullflush ) { need_flush = true ; } spin_unlock_irqrestore ( & iommu_bitmap_lock , flags ) ; return offset ; } 