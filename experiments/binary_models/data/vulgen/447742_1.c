static void amdgpu_ttm_tt_unpin_userptr ( struct ttm_tt * ttm ) { struct amdgpu_device * adev = amdgpu_ttm_adev ( ttm -> bdev ) ; struct amdgpu_ttm_tt * gtt = ( void * ) ttm ; struct sg_page_iter sg_iter ; int write = ! ( gtt -> userflags & AMDGPU_GEM_USERPTR_READONLY ) ; enum dma_data_direction direction = write ?DMA_BIDIRECTIONAL : DMA_TO_DEVICE ; dma_unmap_sg ( adev -> dev , ttm -> sg -> sgl , ttm -> sg -> nents , direction ) ; for_each_sg_page ( , , , 0 ) { struct page * page = sg_page_iter_page ( & sg_iter ) ; if ( ! ( gtt -> userflags & AMDGPU_GEM_USERPTR_READONLY ) ) { set_page_dirty ( page ) ; } mark_page_accessed ( page ) ; put_page ( page ) ; } sg_free_table ( ttm -> sg ) ; } 