static void list_group ( ppd_file_t * ppd , ppd_group_t * group ) static void list_options ( cups_dest_t * dest ) static void usage ( void ) _CUPS_NORETURN int main ( int argc , char * argv [ ] ) { int i , j ; int changes ; int num_options ; cups_option_t * options ; int num_dests ; cups_dest_t * dests ; cups_dest_t * dest ; char * opt , * printer , * instance , * option ; _cupsSetLocale ( argv ) ; dest = NULL ; num_dests = 0 ; dests = NULL ; num_options = 0 ; options = NULL ; changes = 0 ; for ( i = 1 ; i < argc ; i ++ ) { if ( ! strcmp ( argv [ i ] , "--help" ) ) { usage ( ) ; } if ( argv [ i ] [ 0 ] == '-' ) { for ( opt = argv [ i ] + 1 ; * opt ; opt ++ ) { switch ( * opt ) { case 'd' : if ( opt [ 1 ] != '\0' ) { printer = opt + 1 ; opt += strlen ( opt ) - 1 ; } else { i ++ ; if ( i >= argc ) { usage ( ) ; } printer = argv [ i ] ; } if ( ( instance = strrchr ( printer , '/' ) ) != NULL ) { * instance ++ = '\0' ; } if ( num_dests == 0 ) { num_dests = cupsGetDests ( & dests ) ; } if ( num_dests == 0 || ! dests || ( dest = cupsGetDest ( printer , instance , num_dests , dests ) ) == NULL ) { _cupsLangPuts ( stderr , _ ( "lpoptions: Unknown printer or class." ) ) ; return ( 1 ) ; } for ( j = 0 ; j < num_dests ; j ++ ) { dests [ j ] . is_default = 0 ; } dest -> is_default = 1 ; cupsSetDests ( num_dests , dests ) ; for ( j = 0 ; j < dest -> num_options ; j ++ ) { if ( cupsGetOption ( dest -> options [ j ] . name , num_options , options ) == NULL ) { num_options = cupsAddOption ( dest -> options [ j ] . name , dest -> options [ j ] . value , num_options , & options ) ; } } break ; case 'h' : if ( opt [ 1 ] != '\0' ) { cupsSetServer ( opt + 1 ) ; opt += strlen ( opt ) - 1 ; } else { i ++ ; if ( i >= argc ) { usage ( ) ; } cupsSetServer ( argv [ i ] ) ; } break ; case 'E' : cupsSetEncryption ( HTTP_ENCRYPT_REQUIRED ) ; break ; case 'l' : if ( dest == NULL ) { if ( num_dests == 0 ) { num_dests = cupsGetDests ( & dests ) ; } if ( ( dest = cupsGetDest ( NULL , NULL , num_dests , dests ) ) == NULL ) { dest = dests ; } } if ( dest == NULL ) { _cupsLangPuts ( stderr , _ ( "lpoptions: No printers." ) ) ; } else { list_options ( dest ) ; } changes = - 1 ; break ; case 'o' : if ( dest == NULL ) { if ( num_dests == 0 ) { num_dests = cupsGetDests ( & dests ) ; } if ( ( dest = cupsGetDest ( NULL , NULL , num_dests , dests ) ) == NULL ) { dest = dests ; } if ( dest == NULL ) { _cupsLangPuts ( stderr , _ ( "lpoptions: No printers." ) ) ; return ( 1 ) ; } for ( j = 0 ; j < dest -> num_options ; j ++ ) { if ( cupsGetOption ( dest -> options [ j ] . name , num_options , options ) == NULL ) { num_options = cupsAddOption ( dest -> options [ j ] . name , dest -> options [ j ] . value , num_options , & options ) ; } } } if ( opt [ 1 ] != '\0' ) { num_options = cupsParseOptions ( opt + 1 , num_options , & options ) ; opt += strlen ( opt ) - 1 ; } else { i ++ ; if ( i >= argc ) { usage ( ) ; } num_options = cupsParseOptions ( argv [ i ] , num_options , & options ) ; } changes = 1 ; break ; case 'p' : if ( opt [ 1 ] != '\0' ) { printer = opt + 1 ; opt += strlen ( opt ) - 1 ; } else { i ++ ; if ( i >= argc ) { usage ( ) ; } printer = argv [ i ] ; } if ( ( instance = strrchr ( printer , '/' ) ) != NULL ) { * instance ++ = '\0' ; } if ( num_dests == 0 ) { num_dests = cupsGetDests ( & dests ) ; } if ( ( dest = cupsGetDest ( printer , instance , num_dests , dests ) ) == NULL ) { num_dests = cupsAddDest ( printer , instance , num_dests , & dests ) ; dest = cupsGetDest ( printer , instance , num_dests , dests ) ; if ( dest == NULL ) { _cupsLangPrintf ( stderr , _ ( "lpoptions: Unable to add printer or instance: %s" ) , strerror ( errno ) ) ; return ( 1 ) ; } } for ( j = 0 ; j < dest -> num_options ; j ++ ) { if ( cupsGetOption ( dest -> options [ j ] . name , num_options , options ) == NULL ) { num_options = cupsAddOption ( dest -> options [ j ] . name , dest -> options [ j ] . value , num_options , & options ) ; } } break ; case 'r' : if ( dest == NULL ) { if ( num_dests == 0 ) { num_dests = cupsGetDests ( & dests ) ; } if ( ( dest = cupsGetDest ( NULL , NULL , num_dests , dests ) ) == NULL ) { dest = dests ; } if ( dest == NULL ) { _cupsLangPuts ( stderr , _ ( "lpoptions: No printers." ) ) ; return ( 1 ) ; } for ( j = 0 ; j < dest -> num_options ; j ++ ) { if ( cupsGetOption ( dest -> options [ j ] . name , num_options , options ) == NULL ) { num_options = cupsAddOption ( dest -> options [ j ] . name , dest -> options [ j ] . value , num_options , & options ) ; } } } if ( opt [ 1 ] != '\0' ) { option = opt + 1 ; opt += strlen ( opt ) - 1 ; } else { i ++ ; if ( i >= argc ) { usage ( ) ; } option = argv [ i ] ; } num_options = cupsRemoveOption ( option , num_options , & options ) ; changes = 1 ; break ; case 'x' : if ( opt [ 1 ] != '\0' ) { printer = opt + 1 ; opt += strlen ( opt ) - 1 ; } else { i ++ ; if ( i >= argc ) { usage ( ) ; } printer = argv [ i ] ; } if ( ( instance = strrchr ( printer , '/' ) ) != NULL ) { * instance ++ = '\0' ; } if ( num_dests == 0 ) { num_dests = cupsGetDests ( & dests ) ; } num_dests = cupsRemoveDest ( printer , instance , num_dests , & dests ) ; cupsSetDests ( num_dests , dests ) ; dest = NULL ; changes = - 1 ; break ; default : usage ( ) ; } } } else { usage ( ) ; } } if ( num_dests == 0 ) { num_dests = cupsGetDests ( & dests ) ; } if ( dest == NULL ) { if ( ( dest = cupsGetDest ( NULL , NULL , num_dests , dests ) ) != NULL ) { for ( j = 0 ; j < dest -> num_options ; j ++ ) { if ( cupsGetOption ( dest -> options [ j ] . name , num_options , options ) == NULL ) { num_options = cupsAddOption ( dest -> options [ j ] . name , dest -> options [ j ] . value , num_options , & options ) ; } } } } if ( changes > 0 ) { cupsFreeOptions ( dest -> num_options , dest -> options ) ; dest -> num_options = num_options ; dest -> options = options ; cupsSetDests ( num_dests , dests ) ; } if ( changes == 0 ) { char buffer [ 10240 ] , * ptr ; num_options = dest -> num_options ; options = dest -> options ; for ( i = 0 , ptr = buffer ; ptr < ( buffer + sizeof ( buffer ) - 1 ) && i < num_options ; i ++ ) { if ( i ) { * ptr ++ = ' ' ; } if ( ! options [ i ] . value [ 0 ] ) { strlcpy ( ptr , options [ i ] . name , sizeof ( buffer ) - ( size_t ) ( ptr - buffer ) ) ; } if ( strchr ( options [ i ] . value , ' ' ) != NULL || strchr ( options [ i ] . value , '\t' ) != NULL ) { snprintf ( ptr , sizeof ( buffer ) - ( size_t ) ( ptr - buffer ) , "%s=\'%s\'" , options [ i ] . name , options [ i ] . value ) ; } else { snprintf ( ptr , sizeof ( buffer ) - ( size_t ) ( ptr - buffer ) , "%s=%s" , options [ i ] . name , options [ i ] . value ) ; } ptr += strlen ( ptr ) ; } _cupsLangPuts ( stdout , buffer ) ; } return ( 0 ) ; } 