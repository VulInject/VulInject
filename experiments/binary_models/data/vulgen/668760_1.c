static void pppoed_recv_PADI ( pppoed_listener * _this , uint8_t shost [ ETHER_ADDR_LEN ] , slist * tag_list ) { int len ; const char * service_name , * ac_name ; u_char bufspace [ 2048 ] ; u_char sn [ 2048 ] , ac_name0 [ 40 ] ; struct pppoe_header pppoe ; struct pppoe_tlv tlv , * tlv_hostuniq , * tlv0 , * tlv_service_name ; bytebuffer * buf ; if ( ( buf = bytebuffer_wrap ( bufspace , sizeof ( bufspace ) ) ) == NULL ) { pppoed_log ( _this -> self , LOG_ERR , "bytebuffer_wrap() failed on %s(): %m" , __func__ ) ; return ; } bytebuffer_clear ( buf ) ; tlv_hostuniq = NULL ; tlv_service_name = NULL ; service_name = "" ; if ( _this -> conf -> service_name != NULL ) { service_name = _this -> conf -> service_name ; } for ( slist_itr_first ( tag_list ) ; slist_itr_has_next ( tag_list ) ; ) { tlv0 = slist_itr_next ( tag_list ) ; if ( tlv0 -> type == PPPOE_TAG_HOST_UNIQ ) { tlv_hostuniq = tlv0 ; } if ( tlv0 -> type == PPPOE_TAG_SERVICE_NAME ) { len = tlv0 -> length ; if ( len >= sizeof ( sn ) ) { fail } memcpy ( sn , tlv0 -> value , len ) ; sn [ len ] = '\0' ; } } if ( tlv_service_name == NULL ) { pppoed_log ( _this -> self , LOG_INFO , "Deny PADI from=%02x:%02x:%02x:%02x:%02x:%02x " "service-name=%s host-uniq=%s if=%s: serviceName is " "not allowed." , shost [ 0 ] , shost [ 1 ] , shost [ 2 ] , shost [ 3 ] , shost [ 4 ] , shost [ 5 ] , sn , tlv_hostuniq ?pppoed_tlv_value_string ( tlv_hostuniq ) : "none" , _this -> listen_ifname ) ; fail } pppoed_log ( _this -> self , LOG_INFO , "RecvPADI from=%02x:%02x:%02x:%02x:%02x:%02x service-name=%s " "host-uniq=%s if=%s" , shost [ 0 ] , shost [ 1 ] , shost [ 2 ] , shost [ 3 ] , shost [ 4 ] , shost [ 5 ] , sn , tlv_hostuniq ?pppoed_tlv_value_string ( tlv_hostuniq ) : "none" , _this -> listen_ifname ) ; memset ( & pppoe , 0 , sizeof ( pppoe ) ) ; pppoe . ver = PPPOE_RFC2516_VER ; pppoe . type = PPPOE_RFC2516_TYPE ; pppoe . code = PPPOE_CODE_PADO ; bytebuffer_put ( buf , & pppoe , sizeof ( pppoe ) ) ; tlv . type = htons ( PPPOE_TAG_SERVICE_NAME ) ; len = strlen ( service_name ) ; tlv . length = htons ( len ) ; bytebuffer_put ( buf , & tlv , sizeof ( tlv ) ) ; if ( len > 0 ) { bytebuffer_put ( buf , service_name , len ) ; } ac_name = _this -> conf -> ac_name ; if ( ac_name == NULL ) { snprintf ( ac_name0 , sizeof ( ac_name0 ) , "%02x:%02x:%02x:%02x:%02x:%02x" , _this -> ether_addr [ 0 ] , _this -> ether_addr [ 1 ] , _this -> ether_addr [ 2 ] , _this -> ether_addr [ 3 ] , _this -> ether_addr [ 4 ] , _this -> ether_addr [ 5 ] ) ; ac_name = ac_name0 ; } tlv . type = htons ( PPPOE_TAG_AC_NAME ) ; len = strlen ( ac_name ) ; tlv . length = htons ( len ) ; bytebuffer_put ( buf , & tlv , sizeof ( tlv ) ) ; bytebuffer_put ( buf , ac_name , len ) ; if ( _this -> self -> acookie_hash != NULL ) { { _this -> self -> acookie_next += 1 ; } hash_lookup ( _this -> self -> acookie_hash , ( void * ) ( intptr_t ) _this -> self -> acookie_next ) != NULL ; tlv . type = htons ( PPPOE_TAG_AC_COOKIE ) ; tlv . length = ntohs ( sizeof ( uint32_t ) ) ; bytebuffer_put ( buf , & tlv , sizeof ( tlv ) ) ; bytebuffer_put ( buf , & _this -> self -> acookie_next , sizeof ( uint32_t ) ) ; } if ( tlv_hostuniq != NULL ) { tlv . type = htons ( PPPOE_TAG_HOST_UNIQ ) ; tlv . length = ntohs ( tlv_hostuniq -> length ) ; bytebuffer_put ( buf , & tlv , sizeof ( tlv ) ) ; bytebuffer_put ( buf , tlv_hostuniq -> value , tlv_hostuniq -> length ) ; } tlv . type = htons ( PPPOE_TAG_END_OF_LIST ) ; tlv . length = ntohs ( 0 ) ; bytebuffer_put ( buf , & tlv , sizeof ( tlv ) ) ; bytebuffer_flip ( buf ) ; if ( pppoed_output ( _this , shost , bytebuffer_pointer ( buf ) , bytebuffer_remaining ( buf ) ) != 0 ) { pppoed_log ( _this -> self , LOG_ERR , "pppoed_output() failed:%m" ) ; } pppoed_log ( _this -> self , LOG_INFO , "SendPADO to=%02x:%02x:%02x:%02x:%02x:%02x serviceName=%s " "acName=%s hostUniq=%s eol if=%s" , shost [ 0 ] , shost [ 1 ] , shost [ 2 ] , shost [ 3 ] , shost [ 4 ] , shost [ 5 ] , service_name , ac_name , tlv_hostuniq ?pppoed_tlv_value_string ( tlv_hostuniq ) : "none" , _this -> listen_ifname ) ; fail bytebuffer_unwrap ( buf ) ; bytebuffer_destroy ( buf ) ; } 