static void hsw_disable_lcpll ( struct drm_i915_private * dev_priv , bool switch_to_fclk , bool allow_power_down ) { u32 val ; assert_can_disable_lcpll ( dev_priv ) ; val = intel_de_read ( dev_priv , LCPLL_CTL ) ; if ( switch_to_fclk ) { val |= LCPLL_CD_SOURCE_FCLK ; intel_de_write ( dev_priv , LCPLL_CTL , val ) ; if ( wait_for_us ( intel_de_read ( dev_priv , LCPLL_CTL ) & LCPLL_CD_SOURCE_FCLK_DONE , 1 ) ) { drm_err ( & dev_priv -> drm , "Switching to FCLK failed\n" ) ; } val = intel_de_read ( dev_priv , LCPLL_CTL ) ; } val |= LCPLL_PLL_DISABLE ; intel_de_write ( dev_priv , LCPLL_CTL , val ) ; if ( intel_de_wait_for_clear ( dev_priv , LCPLL_CTL , LCPLL_PLL_LOCK , 1 ) ) { drm_err ( & dev_priv -> drm , "LCPLL still locked\n" ) ; } val = hsw_read_dcomp ( dev_priv ) ; val |= D_COMP_COMP_DISABLE ; hsw_write_dcomp ( dev_priv , val ) ; ndelay ( 100 ) ; if ( wait_for ( ( hsw_read_dcomp ( dev_priv ) & D_COMP_RCOMP_IN_PROGRESS ) == 0 , 1 ) ) { drm_err ( & dev_priv -> drm , "D_COMP RCOMP still in progress\n" ) ; } if ( allow_power_down ) { val = intel_de_read ( dev_priv , LCPLL_CTL ) ; val |= LCPLL_POWER_DOWN_ALLOW ; intel_de_write ( dev_priv , LCPLL_CTL , val ) ; intel_de_posting_read ( dev_priv , LCPLL_CTL ) ; } } 