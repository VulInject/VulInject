_mongoc_stream_tls_secure_channel_write ( , , ) { mongoc_stream_tls_t * tls = ( mongoc_stream_tls_t * ) stream ; mongoc_stream_tls_secure_channel_t * secure_channel = ( mongoc_stream_tls_secure_channel_t * ) tls -> ctx ; ssize_t written = - 1 ; size_t data_len = 0 ; unsigned char * data = NULL ; SecBuffer outbuf [ 4 ] ; SecBufferDesc outbuf_desc ; SECURITY_STATUS sspi_status = SEC_E_OK ; ENTRY ; BSON_ASSERT ( secure_channel ) ; TRACE ( "The entire buffer is: %zu" , buf_len ) ; if ( secure_channel -> stream_sizes . cbMaximumMessage == 0 ) { sspi_status = QueryContextAttributes ( & secure_channel -> ctxt -> ctxt_handle , SECPKG_ATTR_STREAM_SIZES , & secure_channel -> stream_sizes ) ; if ( sspi_status != SEC_E_OK ) { TRACE ( "failing here: %d" , __LINE__ ) ; return - 1 ; } } data_len = secure_channel -> stream_sizes . cbHeader + buf_len + secure_channel -> stream_sizes . cbTrailer ; data = ( unsigned char * ) bson_malloc ( data_len ) ; _mongoc_secure_channel_init_sec_buffer ( & outbuf [ 0 ] , SECBUFFER_STREAM_HEADER , data , secure_channel -> stream_sizes . cbHeader ) ; _mongoc_secure_channel_init_sec_buffer ( & outbuf [ 1 ] , SECBUFFER_DATA , data + secure_channel -> stream_sizes . cbHeader , ( unsigned long ) ( buf_len & ( size_t ) 0xFFFFFFFFUL ) ) ; _mongoc_secure_channel_init_sec_buffer ( & outbuf [ 2 ] , SECBUFFER_STREAM_TRAILER , data + secure_channel -> stream_sizes . cbHeader + buf_len , secure_channel -> stream_sizes . cbTrailer ) ; _mongoc_secure_channel_init_sec_buffer ( & outbuf [ 3 ] , SECBUFFER_EMPTY , NULL , 0 ) ; _mongoc_secure_channel_init_sec_buffer_desc ( & outbuf_desc , outbuf , 4 ) ; memcpy ( outbuf [ 1 ] . pvBuffer , buf , buf_len ) ; sspi_status = EncryptMessage ( & secure_channel -> ctxt -> ctxt_handle , 0 , & outbuf_desc , 0 ) ; if ( sspi_status == SEC_E_OK ) { written = 0 ; buf_len = outbuf [ 0 ] . cbBuffer + outbuf [ 1 ] . cbBuffer + outbuf [ 2 ] . cbBuffer ; written = mongoc_secure_channel_write ( tls , data , buf_len ) ; } else { written = - 1 ; } bson_free ( data ) ; if ( buf_len == ( size_t ) written ) { written = outbuf [ 1 ] . cbBuffer ; } return written ; } 