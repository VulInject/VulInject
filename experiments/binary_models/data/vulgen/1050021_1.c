void astfb_attach ( struct device * parent , struct device * self , void * aux ) { struct astfb_softc * sc = ( astfb_softc * ) self ; struct pci_attach_args * pa = aux ; struct rasops_info * ri = & sc -> sc_ri ; struct wsemuldisplaydev_attach_args waa ; int node = PCITAG_NODE ( pa -> pa_tag ) ; uint32_t addr [ 5 ] ; int console = 0 ; uint32_t defattr ; if ( OF_getpropintarray ( node , "assigned-addresses" , addr , sizeof ( addr ) ) < sizeof ( addr ) ) { printf ( ": no framebuffer\n" ) ; return ; } sc -> sc_fbaddr = ( bus_addr_t ) addr [ 1 ] << 32 | addr [ 2 ] ; sc -> sc_fbsize = ( bus_size_t ) addr [ 3 ] << 32 | addr [ 4 ] ; sc -> sc_iot = pa -> pa_memt ; if ( bus_space_map ( sc -> sc_iot , sc -> sc_fbaddr , sc -> sc_fbsize , BUS_SPACE_MAP_LINEAR , & sc -> sc_ioh ) ) { printf ( ": can't map framebuffer\n" ) ; return ; } printf ( "\n" ) ; ri -> ri_bits = bus_space_vaddr ( sc -> sc_iot , sc -> sc_ioh ) ; ri -> ri_hw = sc ; ri -> ri_width = OF_getpropint ( node , "width" , 0 ) ; ri -> ri_height = OF_getpropint ( node , "height" , 0 ) ; ri -> ri_depth = OF_getpropint ( node , "depth" , 0 ) ; ri -> ri_stride = ri -> ri_width * ( ( ri -> ri_depth + 7 ) / 8 ) ; ri -> ri_flg = RI_CENTER | RI_CLEAR | RI_FULLCLEAR | RI_WRONLY ; switch ( ri -> ri_depth ) { case 32 : ri -> ri_rnum = 8 ; ri -> ri_rpos = 8 ; ri -> ri_gnum = 8 ; ri -> ri_gpos = 16 ; ri -> ri_bnum = 8 ; ri -> ri_bpos = 24 ; break ; case 16 : ri -> ri_rnum = 5 ; ri -> ri_rpos = 0 ; ri -> ri_gnum = 6 ; ri -> ri_gpos = 6 ; ri -> ri_bnum = 5 ; ri -> ri_bpos = 11 ; break ; } printf ( "%s: %dx%d, %dbpp\n" , sc -> sc_dev . dv_xname , ri -> ri_width , ri -> ri_height , ri -> ri_depth ) ; ri -> ri_flg |= RI_VCONS ; rasops_init ( ri , 160 , 160 ) ; strlcpy ( sc -> sc_wsd . name , "std" , sizeof ( sc -> sc_wsd . name ) ) ; sc -> sc_wsd . capabilities = ri -> ri_caps ; sc -> sc_wsd . nrows = ri -> ri_rows ; sc -> sc_wsd . ncols = ri -> ri_cols ; sc -> sc_wsd . textops = & ri -> ri_ops ; sc -> sc_wsd . fontwidth = ri -> ri_font -> fontwidth ; sc -> sc_wsd . fontheight = ri -> ri_font -> fontheight ; sc -> sc_scrlist [ 0 ] = & sc -> sc_wsd ; sc -> sc_wsl . nscreens = 1 ; sc -> sc_wsl . screens = ( const wsscreen_descr * * ) sc -> sc_scrlist ; if ( console ) { ri -> ri_ops . pack_attr ( ri -> ri_active , 0 , 0 , 0 , & defattr ) ; wsdisplay_cnattach ( & sc -> sc_wsd , ri -> ri_active , 0 , 0 , defattr ) ; } memset ( & waa , 0 , sizeof ( waa ) ) ; waa . scrdata = & sc -> sc_wsl ; waa . accessops = & astfb_accessops ; waa . accesscookie = ri ; waa . console = console ; config_found_sm ( self , & waa , wsemuldisplaydevprint , wsemuldisplaydevsubmatch ) ; } 