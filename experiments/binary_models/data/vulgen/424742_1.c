static int em_gio_irq_set_type ( struct irq_data * d , unsigned int type ) { unsigned char value = em_gio_sense_table [ type & IRQ_TYPE_SENSE_MASK ] ; struct em_gio_priv * p = irq_data_get_irq_chip_data ( d ) ; unsigned int reg , offset , shift ; unsigned long flags ; unsigned long tmp ; offset = irqd_to_hwirq ( d ) ; pr_debug ( "gio: sense irq = %d, mode = %d\n" , offset , value ) ; reg = GIO_IDT ( offset >> 3 ) ; shift = ( offset & 0x07 ) << 4 ; spin_lock_irqsave ( & p -> sense_lock , flags ) ; tmp = em_gio_read ( p , GIO_IIA ) ; tmp &= ~ BIT ( offset ) ; em_gio_write ( p , GIO_IIA , tmp ) ; tmp = em_gio_read ( p , reg ) ; tmp &= ~ ( 0xf << shift ) ; tmp |= value << shift ; em_gio_write ( p , reg , tmp ) ; em_gio_write ( p , GIO_IIR , BIT ( offset ) ) ; tmp = em_gio_read ( p , GIO_IIA ) ; tmp |= BIT ( offset ) ; em_gio_write ( p , GIO_IIA , tmp ) ; spin_unlock_irqrestore ( & p -> sense_lock , flags ) ; return 0 ; } 