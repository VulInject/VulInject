static void mac_onboard_sonic_ethernet_addr ( struct net_device * dev ) { struct sonic_local * lp = netdev_priv ( dev ) ; const int prom_addr = ONBOARD_SONIC_PROM_BASE ; unsigned short val ; u8 addr [ ETH_ALEN ] ; if ( hwreg_present ( ( void * ) prom_addr ) ) { int i ; for ( i = 0 ; i < 6 ; i ++ ) { addr [ i ] = SONIC_READ_PROM ( i ) ; } eth_hw_addr_set ( dev , addr ) ; if ( ! INVALID_MAC ( dev -> dev_addr ) ) { return ; } eth_hw_addr_set ( dev , addr ) ; if ( ! INVALID_MAC ( dev -> dev_addr ) ) { return ; } printk ( KERN_WARNING "macsonic: MAC address in PROM seems " "to be invalid, trying CAM\n" ) ; } else { printk ( KERN_WARNING "macsonic: cannot read MAC address from " "PROM, trying CAM\n" ) ; } SONIC_WRITE ( SONIC_CMD , SONIC_CR_RST ) ; SONIC_WRITE ( SONIC_CEP , 15 ) ; val = SONIC_READ ( SONIC_CAP2 ) ; addr [ 5 ] = val >> 8 ; addr [ 4 ] = val & 0xff ; val = SONIC_READ ( SONIC_CAP1 ) ; addr [ 3 ] = val >> 8 ; addr [ 2 ] = val & 0xff ; val = SONIC_READ ( SONIC_CAP0 ) ; addr [ 1 ] = val >> 8 ; addr [ 0 ] = val & 0xff ; eth_hw_addr_set ( dev , addr ) ; if ( ! INVALID_MAC ( dev -> dev_addr ) ) { return ; } printk ( KERN_WARNING "macsonic: MAC address in CAM entry 15 " "seems invalid, will use a random MAC\n" ) ; eth_hw_addr_random ( dev ) ; } 