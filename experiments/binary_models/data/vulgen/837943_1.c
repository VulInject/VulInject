static void peer_group2peer_config_copy_af ( struct peer_group * group , struct peer * peer , afi_t afi , safi_t safi ) { int in = FILTER_IN ; int out = FILTER_OUT ; uint64_t flags_tmp ; uint64_t pflags_ovrd ; uint8_t * pfilter_ovrd ; struct peer * conf ; conf = group -> conf ; pflags_ovrd = peer -> af_flags_override [ afi ] [ safi ] ; pfilter_ovrd = & peer -> filter_override [ afi ] [ safi ] [ in ] ; flags_tmp = conf -> af_flags [ afi ] [ safi ] & ~ pflags_ovrd ; flags_tmp ^= conf -> af_flags_invert [ afi ] [ safi ] ^ peer -> af_flags_invert [ afi ] [ safi ] ; flags_tmp &= ~ pflags_ovrd ; UNSET_FLAG ( peer -> af_flags [ afi ] [ safi ] , ~ pflags_ovrd ) ; SET_FLAG ( peer -> af_flags [ afi ] [ safi ] , flags_tmp ) ; SET_FLAG ( peer -> af_flags_invert [ afi ] [ safi ] , conf -> af_flags_invert [ afi ] [ safi ] ) ; if ( ! CHECK_FLAG ( pflags_ovrd , PEER_FLAG_MAX_PREFIX ) ) { PEER_ATTR_INHERIT ( peer , group , pmax [ afi ] [ safi ] ) ; PEER_ATTR_INHERIT ( peer , group , pmax_threshold [ afi ] [ safi ] ) ; PEER_ATTR_INHERIT ( peer , group , pmax_restart [ afi ] [ safi ] ) ; } if ( ! CHECK_FLAG ( pflags_ovrd , PEER_FLAG_MAX_PREFIX_OUT ) ) { PEER_ATTR_INHERIT ( peer , group , pmax_out [ afi ] [ safi ] ) ; } if ( ! CHECK_FLAG ( pflags_ovrd , PEER_FLAG_SOO ) ) { PEER_ATTR_INHERIT ( peer , group , soo [ afi ] [ safi ] ) ; } if ( ! CHECK_FLAG ( pflags_ovrd , PEER_FLAG_WEIGHT ) ) { PEER_ATTR_INHERIT ( peer , group , weight [ afi ] [ safi ] ) ; } if ( ! CHECK_FLAG ( pflags_ovrd , PEER_FLAG_DEFAULT_ORIGINATE ) ) { PEER_STR_ATTR_INHERIT ( peer , group , default_rmap [ afi ] [ safi ] . name , MTYPE_ROUTE_MAP_NAME ) ; PEER_ATTR_INHERIT ( peer , group , default_rmap [ afi ] [ safi ] . map ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ in ] , PEER_FT_DISTRIBUTE_LIST ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . dlist [ in ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . dlist [ in ] . alist ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ in ] , PEER_FT_PREFIX_LIST ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . plist [ in ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . plist [ in ] . plist ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ in ] , PEER_FT_FILTER_LIST ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . aslist [ in ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . aslist [ in ] . aslist ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ RMAP_IN ] , PEER_FT_ROUTE_MAP ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . map [ in ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . map [ RMAP_IN ] . map ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ out ] , PEER_FT_DISTRIBUTE_LIST ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . dlist [ out ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . dlist [ out ] . alist ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ out ] , PEER_FT_PREFIX_LIST ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . plist [ out ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . plist [ out ] . plist ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ out ] , PEER_FT_FILTER_LIST ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . aslist [ out ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . aslist [ out ] . aslist ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ RMAP_OUT ] , PEER_FT_ROUTE_MAP ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . map [ RMAP_OUT ] . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . map [ RMAP_OUT ] . map ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ 0 ] , PEER_FT_UNSUPPRESS_MAP ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . usmap . name , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . usmap . map ) ; } if ( ! CHECK_FLAG ( pfilter_ovrd [ RMAP_OUT ] , PEER_FT_ADVERTISE_MAP ) ) { PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . advmap . aname , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . advmap . amap ) ; PEER_STR_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . advmap . cname , MTYPE_BGP_FILTER_NAME ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . advmap . cmap ) ; PEER_ATTR_INHERIT ( peer , group , filter [ afi ] [ safi ] . advmap . condition ) ; } if ( peer -> addpath_type [ afi ] [ safi ] == BGP_ADDPATH_NONE ) { peer -> addpath_type [ afi ] [ safi ] = conf -> addpath_type [ afi ] [ safi ] ; bgp_addpath_type_changed ( conf -> bgp ) ; } } 