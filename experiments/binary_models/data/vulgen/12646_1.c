static struct batadv_bla_backbone_gw * batadv_bla_get_backbone_gw ( struct batadv_priv * bat_priv , u8 * orig , unsigned short vid , bool own_backbone ) { struct batadv_bla_backbone_gw * entry ; struct batadv_orig_node * orig_node ; int hash_added ; entry = batadv_backbone_hash_find ( bat_priv , orig , vid ) ; if ( entry ) { return entry ; } batadv_dbg ( BATADV_DBG_BLA , bat_priv , "bla_get_backbone_gw(): not found (%pM, %d), creating new entry\n" , orig , batadv_print_vid ( vid ) ) ; entry = kzalloc ( sizeof ( * entry ) , GFP_ATOMIC ) ; if ( ! entry ) { return NULL ; } entry -> vid = vid ; entry -> lasttime = jiffies ; entry -> crc = BATADV_BLA_CRC_INIT ; entry -> bat_priv = bat_priv ; spin_lock_init ( & entry -> crc_lock ) ; atomic_set ( & entry -> request_sent , 0 ) ; atomic_set ( & entry -> wait_periods , 0 ) ; ether_addr_copy ( entry -> orig , orig ) ; INIT_WORK ( & entry -> report_work , batadv_bla_loopdetect_report ) ; kref_init ( & entry -> refcount ) ; kref_get ( & entry -> refcount ) ; hash_added = batadv_hash_add ( bat_priv -> bla . backbone_hash , batadv_compare_backbone_gw , batadv_choose_backbone_gw , entry , & entry -> hash_entry ) ; if ( unlikely ( hash_added != 0 ) ) { kfree ( entry ) ; return NULL ; } orig_node = batadv_orig_hash_find ( bat_priv , orig ) ; if ( orig_node ) { batadv_tt_global_del_orig ( bat_priv , orig_node , vid , "became a backbone gateway" ) ; batadv_orig_node_put ( orig_node ) ; } return entry ; } 