static void input_osc_52 ( struct input_ctx * ictx , const char * p ) { struct window_pane * wp = ictx -> wp ; char * end ; const char * buf = NULL ; size_t len = 0 ; u_char * out ; int outlen , state ; struct screen_write_ctx ctx ; struct paste_buffer * pb ; const char * allow = "cpqs01234567" ; char flags [ sizeof ] = "" ; u_int i , j = 0 ; if ( wp == NULL ) { return ; } state = options_get_number ( global_options , "set-clipboard" ) ; if ( state != 2 ) { return ; } if ( ( end = strchr ( p , ';' ) ) == NULL ) { return ; } end ++ ; if ( * end == '\0' ) { return ; } log_debug ( "%s: %s" , __func__ , end ) ; for ( i = 0 ; p + i != end ; i ++ ) { if ( strchr ( allow , p [ i ] ) != NULL && strchr ( flags , p [ i ] ) == NULL ) { flags [ j ++ ] = p [ i ] ; } } log_debug ( "%s: %.*s %s" , __func__ , ( int ) ( end - p - 1 ) , p , flags ) ; if ( strcmp ( end , "?" ) == 0 ) { if ( ( pb = paste_get_top ( NULL ) ) != NULL ) { buf = paste_buffer_data ( pb , & len ) ; } if ( ictx -> input_end == INPUT_END_BEL ) { input_reply_clipboard ( ictx -> event , buf , len , "\007" ) ; } else { input_reply_clipboard ( ictx -> event , buf , len , "\033\\" ) ; } return ; } len = ( strlen ( end ) / 4 ) * 3 ; if ( len == 0 ) { return ; } out = xmalloc ( len ) ; if ( ( outlen = b64_pton ( end , out , len ) ) == - 1 ) { return ; } screen_write_start_pane ( & ctx , wp , NULL ) ; screen_write_setselection ( & ctx , flags , out , outlen ) ; screen_write_stop ( & ctx ) ; notify_pane ( "pane-set-clipboard" , wp ) ; paste_add ( NULL , out , outlen ) ; } 