JsVar * jswrap_json_parse_internal ( ) { switch ( lex -> tk ) { case LEX_R_TRUE : jslGetNextToken ( ) ; return jsvNewFromBool ( true ) ; case LEX_R_FALSE : jslGetNextToken ( ) ; return jsvNewFromBool ( false ) ; case LEX_R_NULL : jslGetNextToken ( ) ; return jsvNewWithFlags ( JSV_NULL ) ; case '-' : { jslGetNextToken ( ) ; if ( lex -> tk != LEX_INT && lex -> tk != LEX_FLOAT ) { return 0 ; } JsVar * v = jswrap_json_parse_internal ( ) ; JsVar * zero = jsvNewFromInteger ( 0 ) ; JsVar * r = jsvMathsOp ( zero , v , '-' ) ; jsvUnLock2 ( v , zero ) ; return r ; } case LEX_INT : { long long v = stringToInt ( jslGetTokenValueAsString ( ) ) ; jslGetNextToken ( ) ; return jsvNewFromLongInteger ( v ) ; } case LEX_FLOAT : { JsVarFloat v = stringToFloat ( jslGetTokenValueAsString ( ) ) ; jslGetNextToken ( ) ; return jsvNewFromFloat ( v ) ; } case LEX_STR : { JsVar * a = jslGetTokenValueAsVar ( ) ; jslGetNextToken ( ) ; return a ; } case '[' : { JsVar * arr = jsvNewEmptyArray ( ) ; if ( ! arr ) { return 0 ; } jslGetNextToken ( ) ; while ( lex -> tk != ']' && ! jspHasError ( ) ) { JsVar * value = jswrap_json_parse_internal ( ) ; if ( ! value || ( lex -> tk != ']' && ! jslMatch ( ',' ) ) ) { jsvUnLock2 ( value , arr ) ; return 0 ; } jsvArrayPush ( arr , value ) ; } if ( ! jslMatch ( ']' ) ) { jsvUnLock ( arr ) ; return 0 ; } return arr ; } case '{' : { JsVar * obj = jsvNewObject ( ) ; if ( ! obj ) { return 0 ; } jslGetNextToken ( ) ; while ( lex -> tk == LEX_STR && ! jspHasError ( ) ) { JsVar * key = jsvAsArrayIndexAndUnLock ( jslGetTokenValueAsVar ( ) ) ; jslGetNextToken ( ) ; JsVar * value = 0 ; if ( ! jslMatch ( ':' ) || ! ( value = jswrap_json_parse_internal ( ) ) || ( lex -> tk != '}' && ! jslMatch ( ',' ) ) ) { jsvUnLock3 ( key , value , obj ) ; return 0 ; } jsvAddName ( obj , jsvMakeIntoVariableName ( key , value ) ) ; jsvUnLock2 ( value , key ) ; } if ( ! jslMatch ( '}' ) ) { jsvUnLock ( obj ) ; return 0 ; } return obj ; } default : { char buf [ 32 ] ; jslTokenAsString ( lex -> tk , buf , 32 ) ; jsExceptionHere ( JSET_SYNTAXERROR , "Expecting a valid value, got %s" , buf ) ; return 0 ; } } } 