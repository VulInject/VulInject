static int chsc_ioctl_conf_comp_list ( void __user * user_ccl ) { struct chsc_comp_list * ccl ; int ret , ccode ; { struct chsc_header request ; u32 ctype 8 ; u32 4 ; u32 fmt 4 ; u32 16 ; u64 64 ; u32 list_parm [ 2 ] ; u64 64 ; struct chsc_header response ; u8 data [ PAGE_SIZE - 36 ] ; } , __attribute__ ( ( packed ) ) * sccl_area { u32 m 1 ; u32 31 ; u32 cssid 8 ; u32 16 ; u32 chpid 8 ; } , __attribute__ ( ( packed ) ) * chpid_parm { u32 f_cssid 8 ; u32 l_cssid 8 ; u32 16 ; u32 res ; } , __attribute__ ( ( packed ) ) * cssids_parm sccl_area = ( void * ) get_zeroed_page ( GFP_KERNEL | GFP_DMA ) ; if ( ! sccl_area ) { return - ENOMEM ; } if ( ! ccl ) { ret = - ENOMEM ; out_free } if ( copy_from_user ( ccl , user_ccl , sizeof ( * ccl ) ) ) { ret = - EFAULT ; out_free } sccl_area -> request . length = 0x0020 ; sccl_area -> request . code = 0x0030 ; sccl_area -> fmt = ccl -> req . fmt ; sccl_area -> ctype = ccl -> req . ctype ; switch ( sccl_area -> ctype ) { case CCL_CU_ON_CHP : case CCL_IOP_CHP : chpid_parm = ( void * ) & sccl_area -> list_parm ; chpid_parm -> m = ccl -> req . chpid . m ; chpid_parm -> cssid = ccl -> req . chpid . chp . cssid ; chpid_parm -> chpid = ccl -> req . chpid . chp . id ; break ; case CCL_CSS_IMG : case CCL_CSS_IMG_CONF_CHAR : cssids_parm = ( void * ) & sccl_area -> list_parm ; cssids_parm -> f_cssid = ccl -> req . cssids . f_cssid ; cssids_parm -> l_cssid = ccl -> req . cssids . l_cssid ; break ; } ccode = chsc ( sccl_area ) ; if ( ccode != 0 ) { ret = - EIO ; out_free } if ( sccl_area -> response . code != 0x0001 ) { ret = - EIO ; CHSC_MSG ( 0 , "sccl: response code=%x\n" , sccl_area -> response . code ) ; out_free } memcpy ( & ccl -> sccl , & sccl_area -> response , sccl_area -> response . length ) ; if ( copy_to_user ( user_ccl , ccl , sizeof ( * ccl ) ) ) { ret = - EFAULT ; } else { ret = 0 ; } out_free kfree ( ccl ) ; free_page ( ( unsigned long ) sccl_area ) ; return ret ; } 