static void tosa_bat_update ( struct tosa_bat * bat ) { int old ; struct power_supply * psy = bat -> psy ; mutex_lock ( & bat -> work_lock ) ; old = bat -> status ; if ( bat -> is_present && ! bat -> is_present ( bat ) ) { printk ( KERN_NOTICE "%s not present\n" , psy -> desc -> name ) ; bat -> status = POWER_SUPPLY_STATUS_UNKNOWN ; bat -> full_chrg = - 1 ; } if ( power_supply_am_i_supplied ( psy ) ) { if ( bat -> status == POWER_SUPPLY_STATUS_DISCHARGING ) { gpio_set_value ( bat -> gpio_charge_off , 0 ) ; mdelay ( 15 ) ; } if ( gpio_get_value ( bat -> gpio_full ) ) { if ( old == POWER_SUPPLY_STATUS_CHARGING || bat -> full_chrg == - 1 ) { bat -> full_chrg = tosa_read_bat ( bat ) ; } gpio_set_value ( bat -> gpio_charge_off , 1 ) ; bat -> status = POWER_SUPPLY_STATUS_FULL ; } else { gpio_set_value ( bat -> gpio_charge_off , 0 ) ; bat -> status = POWER_SUPPLY_STATUS_CHARGING ; } } else { gpio_set_value ( bat -> gpio_charge_off , 1 ) ; bat -> status = POWER_SUPPLY_STATUS_DISCHARGING ; } mutex_unlock ( & bat -> work_lock ) ; } 