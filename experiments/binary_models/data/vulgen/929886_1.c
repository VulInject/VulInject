static s32 atl1_setup_ring_resources ( struct atl1_adapter * adapter ) { struct atl1_tpd_ring * tpd_ring = & adapter -> tpd_ring ; struct atl1_rfd_ring * rfd_ring = & adapter -> rfd_ring ; struct atl1_rrd_ring * rrd_ring = & adapter -> rrd_ring ; struct atl1_ring_header * ring_header = & adapter -> ring_header ; struct pci_dev * pdev = adapter -> pdev ; int size ; u8 offset = 0 ; size = sizeof ( atl1_buffer ) * ( tpd_ring -> count + rfd_ring -> count ) ; tpd_ring -> buffer_info = kzalloc ( size , GFP_KERNEL ) ; if ( unlikely ( ! tpd_ring -> buffer_info ) ) { if ( netif_msg_drv ( adapter ) ) { dev_err ( & pdev -> dev , "kzalloc failed , size = D%d\n" , size ) ; } err_nomem } rfd_ring -> buffer_info = ( tpd_ring -> buffer_info + tpd_ring -> count ) ; ring_header -> size = size = sizeof ( tx_packet_desc ) * tpd_ring -> count + sizeof ( rx_free_desc ) * rfd_ring -> count + sizeof ( rx_return_desc ) * rrd_ring -> count + sizeof ( coals_msg_block ) + sizeof ( stats_msg_block ) + 40 ; ring_header -> desc = pci_alloc_consistent ( pdev , ring_header -> size , & ring_header -> dma ) ; if ( unlikely ( ! ring_header -> desc ) ) { err_nomem } memset ( ring_header -> desc , 0 , ring_header -> size ) ; tpd_ring -> dma = ring_header -> dma ; offset = ( tpd_ring -> dma & 0x7 ) ?( 8 - ( ring_header -> dma & 0x7 ) ) : 0 ; tpd_ring -> dma += offset ; tpd_ring -> desc = ( u8 * ) ring_header -> desc + offset ; tpd_ring -> size = sizeof ( tx_packet_desc ) * tpd_ring -> count ; rfd_ring -> dma = tpd_ring -> dma + tpd_ring -> size ; offset = ( rfd_ring -> dma & 0x7 ) ?( 8 - ( rfd_ring -> dma & 0x7 ) ) : 0 ; rfd_ring -> dma += offset ; rfd_ring -> desc = ( u8 * ) tpd_ring -> desc + ( tpd_ring -> size + offset ) ; rfd_ring -> size = sizeof ( rx_free_desc ) * rfd_ring -> count ; rrd_ring -> dma = rfd_ring -> dma + rfd_ring -> size ; offset = ( rrd_ring -> dma & 0x7 ) ?( 8 - ( rrd_ring -> dma & 0x7 ) ) : 0 ; rrd_ring -> dma += offset ; rrd_ring -> desc = ( u8 * ) rfd_ring -> desc + ( rfd_ring -> size + offset ) ; rrd_ring -> size = sizeof ( rx_return_desc ) * rrd_ring -> count ; adapter -> cmb . dma = rrd_ring -> dma + rrd_ring -> size ; offset = ( adapter -> cmb . dma & 0x7 ) ?( 8 - ( adapter -> cmb . dma & 0x7 ) ) : 0 ; adapter -> cmb . dma += offset ; adapter -> cmb . cmb = ( coals_msg_block * ) ( ( u8 * ) rrd_ring -> desc + ( rrd_ring -> size + offset ) ) ; adapter -> smb . dma = adapter -> cmb . dma + sizeof ( coals_msg_block ) ; offset = ( adapter -> smb . dma & 0x7 ) ?( 8 - ( adapter -> smb . dma & 0x7 ) ) : 0 ; adapter -> smb . dma += offset ; adapter -> smb . smb = ( stats_msg_block * ) ( ( u8 * ) adapter -> cmb . cmb + ( sizeof ( coals_msg_block ) + offset ) ) ; return 0 ; err_nomem kfree ( tpd_ring -> buffer_info ) ; return - ENOMEM ; } 