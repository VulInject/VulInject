size_t luaC_separateudata ( lua_State * L , int all ) { global_State * g = G ( L ) ; size_t deadmem = 0 ; GCObject * * p = & g -> mainthread -> next ; GCObject * curr ; while ( ( curr = * p ) != NULL ) { if ( ! ( iswhite ( curr ) || all ) || isfinalized ( gco2u ( curr ) ) ) { p = & curr -> gch . next ; } if ( fasttm ( L , gco2u ( curr ) -> metatable , TM_GC ) == NULL ) { p = & curr -> gch . next ; } else { deadmem += sizeudata ( gco2u ( curr ) ) ; markfinalized ( gco2u ( curr ) ) ; * p = curr -> gch . next ; if ( g -> tmudata == NULL ) { g -> tmudata = curr -> gch . next = curr ; } else { curr -> gch . next = g -> tmudata -> gch . next ; g -> tmudata -> gch . next = curr ; g -> tmudata = curr ; } } } return deadmem ; } 