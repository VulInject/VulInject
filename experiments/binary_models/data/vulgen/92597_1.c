LDAP_CALL ldap_get_option ( LDAP * ld , int option , void * optdata ) { int rc = 0 ; if ( ! nsldapi_initialized ) { nsldapi_initialize_defaults ( ) ; } if ( NULL == optdata ) { return ( LDAP_PARAM_ERROR ) ; } if ( option == LDAP_OPT_MEMALLOC_FN_PTRS ) { * ( ( ldap_memalloc_fns * ) optdata ) = nsldapi_memalloc_fns ; return ( 0 ) ; } if ( option == LDAP_OPT_API_INFO ) { rc = nsldapi_get_api_info ( ( LDAPAPIInfo * ) optdata ) ; if ( rc != LDAP_SUCCESS ) { return ( - 1 ) ; } return ( 0 ) ; } if ( LDAP_OPT_DEBUG_LEVEL == option ) { * ( ( int * ) optdata ) = ldap_debug ; return ( 0 ) ; } if ( ld == NULL ) { ld = & nsldapi_ld_defaults ; } if ( ! NSLDAPI_VALID_LDAP_POINTER ( ld ) ) { return ( - 1 ) ; } if ( ld != & nsldapi_ld_defaults ) { LDAP_MUTEX_LOCK ( ld , LDAP_OPTION_LOCK ) ; } switch ( option ) { case LDAP_OPT_DNS : * ( ( int * ) optdata ) = LDAP_GET_BITOPT ( ld , LDAP_BITOPT_DNS ) ; break ; case LDAP_OPT_REFERRALS : * ( ( int * ) optdata ) = LDAP_GET_BITOPT ( ld , LDAP_BITOPT_REFERRALS ) ; break ; case LDAP_OPT_SSL : * ( ( int * ) optdata ) = LDAP_GET_BITOPT ( ld , LDAP_BITOPT_SSL ) ; break ; case LDAP_OPT_RESTART : * ( ( int * ) optdata ) = LDAP_GET_BITOPT ( ld , LDAP_BITOPT_RESTART ) ; break ; case LDAP_OPT_RECONNECT : * ( ( int * ) optdata ) = LDAP_GET_BITOPT ( ld , LDAP_BITOPT_RECONNECT ) ; break ; case LDAP_OPT_ASYNC_CONNECT : * ( ( int * ) optdata ) = LDAP_GET_BITOPT ( ld , LDAP_BITOPT_ASYNC ) ; break ; case LDAP_X_OPT_SOCKBUF : * ( ( Sockbuf * * ) optdata ) = ld -> ld_sbp ; break ; case LDAP_OPT_DESC : if ( ber_sockbuf_get_option ( ld -> ld_sbp , LBER_SOCKBUF_OPT_DESC , optdata ) != 0 ) { LDAP_SET_LDERRNO ( ld , LDAP_LOCAL_ERROR , NULL , NULL ) ; rc = - 1 ; } break ; case LDAP_OPT_DEREF : * ( ( int * ) optdata ) = ld -> ld_deref ; break ; case LDAP_OPT_SIZELIMIT : * ( ( int * ) optdata ) = ld -> ld_sizelimit ; break ; case LDAP_OPT_TIMELIMIT : * ( ( int * ) optdata ) = ld -> ld_timelimit ; break ; case LDAP_OPT_REFERRAL_HOP_LIMIT : * ( ( int * ) optdata ) = ld -> ld_refhoplimit ; break ; case LDAP_OPT_PROTOCOL_VERSION : * ( ( int * ) optdata ) = ld -> ld_version ; break ; case LDAP_OPT_SERVER_CONTROLS : case LDAP_OPT_CLIENT_CONTROLS : * ( ( LDAPControl * * * ) optdata ) = NULL ; rc = nsldapi_dup_controls ( ld , ( LDAPControl * * * ) optdata , ( option == LDAP_OPT_SERVER_CONTROLS ) ?ld -> ld_servercontrols : ld -> ld_clientcontrols ) ; break ; case LDAP_OPT_REBIND_FN : * ( ( LDAP_REBINDPROC_CALLBACK * * ) optdata ) = ld -> ld_rebind_fn ; break ; case LDAP_OPT_REBIND_ARG : * ( ( void * * ) optdata ) = ld -> ld_rebind_arg ; break ; case LDAP_OPT_IO_FN_PTRS : if ( ld -> ld_io_fns_ptr == NULL ) { memset ( optdata , 0 , sizeof ( ldap_io_fns ) ) ; } else { * ( ( ldap_io_fns * ) optdata ) = * ( ld -> ld_io_fns_ptr ) ; } break ; case LDAP_X_OPT_EXTIO_FN_PTRS : if ( ( ( ldap_x_ext_io_fns * ) optdata ) -> lextiof_size == LDAP_X_EXTIO_FNS_SIZE_REV0 ) { ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_close = ld -> ld_extclose_fn ; ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_connect = ld -> ld_extconnect_fn ; ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_read = ld -> ld_extread_fn ; ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_write = ld -> ld_extwrite_fn ; ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_poll = ld -> ld_extpoll_fn ; ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_newhandle = ld -> ld_extnewhandle_fn ; ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_disposehandle = ld -> ld_extdisposehandle_fn ; ( ( ldap_x_ext_io_fns_rev0 * ) optdata ) -> lextiof_session_arg = ld -> ld_ext_session_arg ; } if ( ( ( ldap_x_ext_io_fns * ) optdata ) -> lextiof_size == LDAP_X_EXTIO_FNS_SIZE ) { * ( ( ldap_x_ext_io_fns * ) optdata ) = ld -> ld_ext_io_fns ; } else { LDAP_SET_LDERRNO ( ld , LDAP_PARAM_ERROR , NULL , NULL ) ; rc = - 1 ; } break ; case LDAP_OPT_THREAD_FN_PTRS : * ( ( ldap_thread_fns * ) optdata ) = ld -> ld_thread ; break ; case LDAP_OPT_DNS_FN_PTRS : * ( ( ldap_dns_fns * ) optdata ) = ld -> ld_dnsfn ; break ; case LDAP_OPT_CACHE_FN_PTRS : * ( ( ldap_cache_fns * ) optdata ) = ld -> ld_cache ; break ; case LDAP_OPT_CACHE_STRATEGY : * ( ( int * ) optdata ) = ld -> ld_cache_strategy ; break ; case LDAP_OPT_CACHE_ENABLE : * ( ( int * ) optdata ) = ld -> ld_cache_on ; break ; case LDAP_OPT_ERROR_NUMBER : * ( ( int * ) optdata ) = LDAP_GET_LDERRNO ( ld , NULL , NULL ) ; break ; case LDAP_OPT_ERROR_STRING : ( void ) LDAP_GET_LDERRNO ( ld , NULL , ( char * * ) optdata ) ; * ( ( char * * ) optdata ) = nsldapi_strdup ( * ( ( char * * ) optdata ) ) ; break ; case LDAP_OPT_MATCHED_DN : ( void ) LDAP_GET_LDERRNO ( ld , ( char * * ) optdata , NULL ) ; * ( ( char * * ) optdata ) = nsldapi_strdup ( * ( ( char * * ) optdata ) ) ; break ; case LDAP_OPT_PREFERRED_LANGUAGE : if ( NULL != ld -> ld_preferred_language ) { * ( ( char * * ) optdata ) = nsldapi_strdup ( ld -> ld_preferred_language ) ; } else { * ( ( char * * ) optdata ) = NULL ; } break ; case LDAP_OPT_API_FEATURE_INFO : rc = nsldapi_get_feature_info ( ( LDAPAPIFeatureInfo * ) optdata ) ; if ( rc != LDAP_SUCCESS ) { LDAP_SET_LDERRNO ( ld , rc , NULL , NULL ) ; rc = - 1 ; } break ; case LDAP_OPT_HOST_NAME : * ( ( char * * ) optdata ) = nsldapi_strdup ( ld -> ld_defhost ) ; break ; case LDAP_X_OPT_CONNECT_TIMEOUT : * ( ( int * ) optdata ) = ld -> ld_connect_timeout ; break ; case LDAP_OPT_X_SASL_MECH : * ( ( char * * ) optdata ) = nsldapi_strdup ( ld -> ld_def_sasl_mech ) ; break ; case LDAP_OPT_X_SASL_REALM : * ( ( char * * ) optdata ) = nsldapi_strdup ( ld -> ld_def_sasl_realm ) ; break ; case LDAP_OPT_X_SASL_AUTHCID : * ( ( char * * ) optdata ) = nsldapi_strdup ( ld -> ld_def_sasl_authcid ) ; break ; case LDAP_OPT_X_SASL_AUTHZID : * ( ( char * * ) optdata ) = nsldapi_strdup ( ld -> ld_def_sasl_authzid ) ; break ; case LDAP_OPT_X_SASL_SSF : { int sc ; sasl_ssf_t * ssf ; sasl_conn_t * ctx ; if ( ld -> ld_defconn == NULL || ld -> ld_defconn -> lconn_sb == NULL ) { return - 1 ; } ctx = ( sasl_conn_t * ) ( ld -> ld_defconn -> lconn_sb -> sb_sasl_ctx ) ; if ( ctx == NULL ) { return - 1 ; } sc = sasl_getprop ( ctx , SASL_SSF , ( const void * * ) & ssf ) ; if ( sc != SASL_OK ) { return - 1 ; } * ( ( sasl_ssf_t * ) optdata ) = * ssf ; } break ; case LDAP_OPT_X_SASL_SSF_MIN : * ( ( sasl_ssf_t * ) optdata ) = ld -> ld_sasl_secprops . min_ssf ; break ; case LDAP_OPT_X_SASL_SSF_MAX : * ( ( sasl_ssf_t * ) optdata ) = ld -> ld_sasl_secprops . max_ssf ; break ; case LDAP_OPT_X_SASL_MAXBUFSIZE : * ( ( sasl_ssf_t * ) optdata ) = ld -> ld_sasl_secprops . maxbufsize ; break ; case LDAP_OPT_X_SASL_SSF_EXTERNAL : case LDAP_OPT_X_SASL_SECPROPS : LDAP_SET_LDERRNO ( ld , LDAP_PARAM_ERROR , NULL , NULL ) ; rc = - 1 ; break ; default : LDAP_SET_LDERRNO ( ld , LDAP_PARAM_ERROR , NULL , NULL ) ; rc = - 1 ; } if ( ld != & nsldapi_ld_defaults ) { LDAP_MUTEX_UNLOCK ( ld , LDAP_OPTION_LOCK ) ; } return ( rc ) ; } 