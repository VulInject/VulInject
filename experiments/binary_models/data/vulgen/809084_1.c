struct ospf6_lsa * ospf6_create_single_router_lsa ( struct ospf6_area * area , struct ospf6_lsdb * lsdb , uint32_t adv_router ) { struct ospf6_lsa * lsa = NULL ; struct ospf6_lsa * rtr_lsa = NULL ; struct ospf6_lsa_header * lsa_header = NULL ; uint8_t * new_header = NULL ; const struct route_node * end = NULL ; uint16_t lsa_length , total_lsa_length = 0 , num_lsa = 0 ; uint16_t type = 0 ; char ifbuf [ 16 ] ; uint32_t interface_id ; caddr_t lsd ; lsa_length = sizeof ( ospf6_lsa_header ) + sizeof ( ospf6_router_lsa ) ; total_lsa_length = lsa_length ; type = htons ( OSPF6_LSTYPE_ROUTER ) ; lsa = ospf6_lsdb_lookup ( type , htonl ( 0 ) , adv_router , area -> temp_router_lsa_lsdb ) ; if ( lsa ) { return lsa ; } inet_ntop ( AF_INET , & adv_router , ifbuf , sizeof ( ifbuf ) ) ; end = ospf6_lsdb_head ( lsdb , 2 , type , adv_router , & rtr_lsa ) ; while ( rtr_lsa ) { lsa = rtr_lsa ; if ( OSPF6_LSA_IS_MAXAGE ( rtr_lsa ) ) { rtr_lsa = ospf6_lsdb_next ( end , rtr_lsa ) ; continue ; } lsa_header = rtr_lsa -> header ; total_lsa_length += ( ntohs ( lsa_header -> length ) - lsa_length ) ; num_lsa ++ ; rtr_lsa = ospf6_lsdb_next ( end , rtr_lsa ) ; } if ( IS_OSPF6_DEBUG_SPF ( PROCESS ) ) { zlog_debug ( "%s: adv_router %s num_lsa %u to convert." , __func__ , ifbuf , num_lsa ) ; } if ( num_lsa == 1 ) { return lsa ; } lsa = ospf6_lsa_alloc ( total_lsa_length ) ; new_header = ( uint8_t * ) lsa -> header ; lsa -> lsdb = area -> temp_router_lsa_lsdb ; end = ospf6_lsdb_head ( lsdb , 2 , type , adv_router , & rtr_lsa ) ; assert ( rtr_lsa ) ; if ( ! OSPF6_LSA_IS_MAXAGE ( rtr_lsa ) ) { lsa_header = rtr_lsa -> header ; memcpy ( new_header , lsa_header , ntohs ( lsa_header -> length ) ) ; ( ( ospf6_lsa_header * ) new_header ) -> length = htons ( total_lsa_length ) ; new_header += ntohs ( lsa_header -> length ) ; num_lsa -- ; } ospf6_lsa_printbuf ( lsa , lsa -> name , sizeof ( lsa -> name ) ) ; rtr_lsa = ospf6_lsdb_next ( end , rtr_lsa ) ; while ( rtr_lsa ) { if ( OSPF6_LSA_IS_MAXAGE ( rtr_lsa ) ) { rtr_lsa = ospf6_lsdb_next ( end , rtr_lsa ) ; continue ; } if ( IS_OSPF6_DEBUG_SPF ( PROCESS ) ) { lsd = OSPF6_LSA_HEADER_END ( rtr_lsa -> header ) + 4 ; interface_id = ROUTER_LSDESC_GET_IFID ( lsd ) ; inet_ntop ( AF_INET , & interface_id , ifbuf , sizeof ( ifbuf ) ) ; zlog_debug ( "%s: Next Router LSA %s to aggreat with len %u interface_id %s" , __func__ , rtr_lsa -> name , ntohs ( lsa_header -> length ) , ifbuf ) ; } lsa_header = rtr_lsa -> header ; memcpy ( new_header , ( OSPF6_LSA_HEADER_END ( rtr_lsa -> header ) + 4 ) , ( ntohs ( lsa_header -> length ) - lsa_length ) ) ; new_header += ( ntohs ( lsa_header -> length ) - lsa_length ) ; num_lsa -- ; rtr_lsa = ospf6_lsdb_next ( end , rtr_lsa ) ; } ospf6_lsa_age_set ( lsa ) ; ospf6_lsdb_add ( lsa , area -> temp_router_lsa_lsdb ) ; if ( IS_OSPF6_DEBUG_SPF ( PROCESS ) ) { zlog_debug ( "%s: LSA %s id %u type 0%x len %u num_lsa %u" , __func__ , lsa -> name , ntohl ( lsa -> header -> id ) , ntohs ( lsa -> header -> type ) , ntohs ( lsa -> header -> length ) , num_lsa ) ; } return lsa ; } 