static msODBCconn * mssql2008Connect ( const char * connString ) { SQLSMALLINT outConnStringLen ; SQLRETURN rc ; msODBCconn * conn = msSmallMalloc ( sizeof ( msODBCconn ) ) ; char fullConnString [ 1024 ] ; memset ( conn , 0 , sizeof ( * conn ) ) ; SQLAllocHandle ( SQL_HANDLE_ENV , SQL_NULL_HANDLE , & conn -> henv ) ; SQLSetEnvAttr ( conn -> henv , SQL_ATTR_ODBC_VERSION , ( SQLPOINTER ) SQL_OV_ODBC3 , 0 ) ; SQLAllocHandle ( SQL_HANDLE_DBC , conn -> henv , & conn -> hdbc ) ; { wchar_t * decodedConnString = msConvertWideStringFromUTF8 ( connString , "UCS-2LE" ) ; SQLWCHAR outConnString [ 1024 ] ; SQLWCHAR * decodedConnStringSQLWCHAR = convertCwchartToSQLWCHAR ( decodedConnString ) ; rc = SQLDriverConnectW ( conn -> hdbc , NULL , decodedConnStringSQLWCHAR , SQL_NTS , outConnString , 1024 , & outConnStringLen , SQL_DRIVER_NOPROMPT ) ; msFree ( decodedConnString ) ; msFree ( decodedConnStringSQLWCHAR ) ; SQLCHAR outConnString [ 1024 ] ; rc = SQLDriverConnect ( conn -> hdbc , NULL , ( SQLCHAR * ) connString , SQL_NTS , outConnString , 1024 , & outConnStringLen , SQL_DRIVER_NOPROMPT ) ; } if ( rc != SQL_SUCCESS && rc != SQL_SUCCESS_WITH_INFO ) { setConnError ( conn ) ; return conn ; } SQLAllocHandle ( SQL_HANDLE_STMT , conn -> hdbc , & conn -> hstmt ) ; return conn ; } 