int putmsg ( int fdes , struct strbuf * ctl , struct strbuf * data , int flags ) int getpmsg ( int fdes , struct strbuf * ctl , struct strbuf * data , int * prip , int * flagsp ) int putpmsg ( int fdes , struct strbuf * ctl , struct strbuf * data , int pri , int flags ) static int msgio ( int fdes , struct strbuf * ctl , struct strbuf * data , int * rval , int mode , unsigned char * prip , int * flagsp ) int getmsg ( int fdes , struct strbuf * ctl , struct strbuf * data , int * flagsp ) { int error ; int localflags ; int realflags = 0 ; int rv ; int rv = 0 ; if ( copyin ( flagsp , & localflags , sizeof ( * flagsp ) ) ) { return ( set_errno ( EFAULT ) ) ; } switch ( localflags ) { case 0 : realflags = MSG_ANY ; break ; case RS_HIPRI : realflags = MSG_HIPRI ; break ; default : return ( set_errno ( EINVAL ) ) ; } if ( ( error = msgio ( fdes , ctl , data , & rv , FREAD , & pri , & realflags ) ) == 0 ) { if ( realflags == MSG_HIPRI ) { localflags = RS_HIPRI ; } else { localflags = 0 ; } if ( copyout ( & localflags , flagsp , sizeof ( * flagsp ) ) ) { error = EFAULT ; } } if ( error != 0 ) { return ( set_errno ( error ) ) ; } return ( rv ) ; } 