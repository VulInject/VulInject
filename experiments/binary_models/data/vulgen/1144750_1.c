static int start_generic_opal_session ( struct opal_dev * dev , enum opal_uid auth , enum opal_uid sp_type , const char * key , u8 key_len ) { u32 hsn ; int err = 0 ; clear_opal_cmd ( dev ) ; set_comid ( dev , dev -> comid ) ; hsn = GENERIC_HOST_SESSION_NUM ; add_token_u8 ( & err , dev , OPAL_CALL ) ; add_token_bytestring ( & err , dev , opaluid [ OPAL_SMUID_UID ] , OPAL_UID_LENGTH ) ; add_token_bytestring ( & err , dev , opalmethod [ OPAL_STARTSESSION ] , OPAL_UID_LENGTH ) ; add_token_u8 ( & err , dev , OPAL_STARTLIST ) ; add_token_u64 ( & err , dev , hsn ) ; add_token_bytestring ( & err , dev , opaluid [ sp_type ] , OPAL_UID_LENGTH ) ; add_token_u8 ( & err , dev , 1 ) ; switch ( auth ) { case OPAL_ANYBODY_UID : add_token_u8 ( & err , dev , OPAL_ENDLIST ) ; break ; case OPAL_ADMIN1_UID : case OPAL_SID_UID : add_token_u8 ( & err , dev , OPAL_STARTNAME ) ; add_token_u8 ( & err , dev , 0 ) ; add_token_bytestring ( & err , dev , key , key_len ) ; add_token_u8 ( & err , dev , OPAL_ENDNAME ) ; add_token_u8 ( & err , dev , OPAL_STARTNAME ) ; add_token_u8 ( & err , dev , 3 ) ; add_token_bytestring ( & err , dev , opaluid [ auth ] , OPAL_UID_LENGTH ) ; add_token_u8 ( & err , dev , OPAL_ENDNAME ) ; add_token_u8 ( & err , dev , OPAL_ENDLIST ) ; break ; default : pr_debug ( "Cannot start Admin SP session with auth %d\n" , auth ) ; return OPAL_INVAL_PARAM ; } if ( err ) { pr_debug ( "Error building start adminsp session command.\n" ) ; return err ; } return finalize_and_send ( dev , start_opal_session_cont ) ; } 