static struct ehci_tt * find_tt ( struct usb_device * udev ) { struct usb_tt * utt = udev -> tt ; struct ehci_tt * tt , * * tt_index , * * ptt ; unsigned port ; bool allocated_index = false ; if ( ! utt ) { return NULL ; } tt_index = NULL ; if ( utt -> multi ) { tt_index = utt -> hcpriv ; if ( ! tt_index ) { tt_index = kcalloc ( utt -> hub -> maxchild , sizeof ( * tt_index ) , GFP_ATOMIC ) ; if ( ! tt_index ) { return ERR_PTR ( - ENOMEM ) ; } utt -> hcpriv = tt_index ; allocated_index = true ; } port = udev -> ttport - 1 ; ptt = & tt_index [ port ] ; } else { port = 0 ; ptt = ( ehci_tt * * ) & utt -> hcpriv ; } tt = * ptt ; if ( ! tt ) { struct ehci_hcd * ehci = hcd_to_ehci ( bus_to_hcd ( udev -> bus ) ) ; tt = kzalloc ( sizeof ( * tt ) , GFP_ATOMIC ) ; if ( ! tt ) { if ( allocated_index ) { utt -> hcpriv = NULL ; } return ERR_PTR ( - ENOMEM ) ; } list_add_tail ( & tt -> tt_list , & ehci -> tt_list ) ; INIT_LIST_HEAD ( & tt -> ps_list ) ; tt -> usb_tt = utt ; tt -> tt_port = port ; * ptt = tt ; } return tt ; } 