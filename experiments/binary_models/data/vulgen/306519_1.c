static void calculate_scales ( MixContext * s , int nb_samples ) { int i ; for ( i = 0 ; i < s -> nb_inputs ; i ++ ) { if ( s -> input_state [ i ] & INPUT_ON ) { weight_sum += FFABS ( s -> weights [ i ] ) ; } } for ( i = 0 ; i < s -> nb_inputs ; i ++ ) { if ( s -> input_state [ i ] & INPUT_ON ) { if ( s -> scale_norm [ i ] > weight_sum / FFABS ( s -> weights [ i ] ) ) { s -> scale_norm [ i ] -= ( ( s -> weight_sum / FFABS ( s -> weights [ i ] ) ) / s -> nb_inputs ) * nb_samples / ( s -> dropout_transition * s -> sample_rate ) ; s -> scale_norm [ i ] = FFMAX ( s -> scale_norm [ i ] , weight_sum / FFABS ( s -> weights [ i ] ) ) ; } } } for ( i = 0 ; i < s -> nb_inputs ; i ++ ) { if ( s -> input_state [ i ] & INPUT_ON ) { if ( ! s -> normalize ) { s -> input_scale [ i ] = FFABS ( s -> weights [ i ] ) ; } else { s -> input_scale [ i ] = 1.0f / s -> scale_norm [ i ] * FFSIGN ( s -> weights [ i ] ) ; } } else { s -> input_scale [ i ] = 0.0f ; } } } 