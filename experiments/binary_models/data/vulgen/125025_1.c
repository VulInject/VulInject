static int arm_iommu_map_sg ( struct device * dev , struct scatterlist * sg , int nents , enum dma_data_direction dir , unsigned long attrs ) { struct scatterlist * s = sg , * dma = sg , * start = sg ; int i , count = 0 , ret ; unsigned int offset = s -> offset ; unsigned int size = s -> offset + s -> length ; for ( i = 1 ; i < nents ; i ++ ) { s = sg_next ( s ) ; s -> dma_length = 0 ; if ( s -> offset || ( size & ~ PAGE_MASK ) || size + s -> length > max ) { ret = __map_sg_chunk ( dev , start , size , & dma -> dma_address , dir , attrs ) ; if ( ret < 0 ) { bad_mapping } dma -> dma_address += offset ; dma -> dma_length = size - offset ; size = offset = s -> offset ; start = s ; dma = sg_next ( dma ) ; count += 1 ; } size += s -> length ; } ret = __map_sg_chunk ( dev , start , size , & dma -> dma_address , dir , attrs ) ; if ( ret < 0 ) { bad_mapping } dma -> dma_address += offset ; dma -> dma_length = size - offset ; return count + 1 ; bad_mapping for_each_sg ( , , , ) __iommu_remove_mapping ( dev , sg_dma_address ( s ) , sg_dma_len ( s ) ) ; if ( ret == - ENOMEM ) { return ret ; } return - EINVAL ; } 