static parse_status_t scanner_get_token ( INOUT scanner_t * scanner , OUT memptr * token , OUT token_type_t * tok_type ) { char * cursor ; char * null_terminator ; int c ; token_type_t token_type ; int got_end_quote ; assert ( scanner ) ; assert ( token ) ; assert ( tok_type ) ; cursor = scanner -> msg -> buf + scanner -> cursor ; if ( cursor == null_terminator ) { return PARSE_INCOMPLETE ; } c = * cursor ; if ( is_identifier_char ( c ) ) { token -> buf = cursor ++ ; token_type = TT_IDENTIFIER ; while ( cursor < null_terminator && is_identifier_char ( * cursor ) ) { cursor ++ ; } if ( ! scanner -> entire_msg_loaded && cursor == null_terminator ) { return PARSE_INCOMPLETE ; } token -> length = ( size_t ) cursor - ( size_t ) token -> buf ; } if ( c == ' ' || c == '\t' ) { token -> buf = cursor ++ ; token_type = TT_WHITESPACE ; while ( cursor < null_terminator && ( * cursor == ' ' || * cursor == '\t' ) ) { cursor ++ ; } if ( ! scanner -> entire_msg_loaded && cursor == null_terminator ) { return PARSE_INCOMPLETE ; } token -> length = ( size_t ) cursor - ( size_t ) token -> buf ; } if ( c == TOKCHAR_CR ) { token -> buf = cursor ++ ; if ( cursor == null_terminator ) { return PARSE_INCOMPLETE ; } if ( * cursor != TOKCHAR_LF ) { token_type = TT_CTRL ; token -> length = ( size_t ) 1 ; } else { token -> length = ( size_t ) 2 ; token_type = TT_CRLF ; cursor ++ ; } } if ( c == TOKCHAR_LF ) { token -> buf = cursor ++ ; token -> length = ( size_t ) 1 ; token_type = TT_CRLF ; } if ( c == '"' ) { token -> buf = cursor ++ ; token_type = TT_QUOTEDSTRING ; got_end_quote = FALSE ; while ( cursor < null_terminator ) { c = * cursor ++ ; if ( c == '"' ) { got_end_quote = TRUE ; break ; } if ( c == '\\' ) { if ( cursor < null_terminator ) { c = * cursor ++ ; } } if ( is_qdtext_char ( c ) ) { } else { return PARSE_FAILURE ; } } if ( got_end_quote ) { token -> length = ( size_t ) cursor - ( size_t ) token -> buf ; } else { assert ( cursor == null_terminator ) ; return PARSE_INCOMPLETE ; } } if ( is_separator_char ( c ) ) { token -> buf = cursor ++ ; token_type = TT_SEPARATOR ; token -> length = ( size_t ) 1 ; } if ( is_control_char ( c ) ) { token -> buf = cursor ++ ; token_type = TT_CTRL ; token -> length = ( size_t ) 1 ; } else { return PARSE_FAILURE ; } scanner -> cursor += token -> length ; * tok_type = token_type ; return PARSE_OK ; } 