static int virStorageSourceParseBackingJSONiSCSI ( virStorageSource * src , virJSONValue * json , const char * jsonstr G_GNUC_UNUSED , int opaque G_GNUC_UNUSED ) { const char * transport = virJSONValueObjectGetString ( json , "transport" ) ; const char * portal = virJSONValueObjectGetString ( json , "portal" ) ; const char * target = virJSONValueObjectGetString ( json , "target" ) ; const char * lun = virJSONValueObjectGetStringOrNumber ( json , "lun" ) ; const char * uri ; char * port ; if ( ( uri = virJSONValueObjectGetString ( json , "filename" ) ) ) { return virStorageSourceParseBackingJSONUriStr ( src , uri , VIR_STORAGE_NET_PROTOCOL_ISCSI ) ; } src -> type = VIR_STORAGE_TYPE_NETWORK ; src -> protocol = VIR_STORAGE_NET_PROTOCOL_ISCSI ; if ( ! lun ) { lun = "0" ; } src -> hosts = g_new0 ( virStorageNetHostDef , 1 ) ; src -> nhosts = 1 ; if ( STRNEQ_NULLABLE ( transport , "tcp" ) ) { virReportError ( VIR_ERR_INVALID_ARG , "%s" , _ ( "only TCP transport is supported for iSCSI volumes" ) ) ; return - 1 ; } src -> hosts -> transport = VIR_STORAGE_NET_HOST_TRANS_TCP ; if ( ! portal ) { virReportError ( VIR_ERR_INVALID_ARG , "%s" , _ ( "missing 'portal' address in iSCSI backing definition" ) ) ; return - 1 ; } if ( ! target ) { virReportError ( VIR_ERR_INVALID_ARG , "%s" , _ ( "missing 'target' in iSCSI backing definition" ) ) ; return - 1 ; } src -> hosts -> name = g_strdup ( portal ) ; if ( ( port = strrchr ( src -> hosts -> name , ':' ) ) && ! strchr ( port , ']' ) ) { * port = '\0' ; } src -> path = g_strdup_printf ( "%s/%s" , target , lun ) ; if ( virJSONValueObjectGetString ( json , "user" ) || virJSONValueObjectGetString ( json , "password" ) ) { return 1 ; } return 0 ; } 