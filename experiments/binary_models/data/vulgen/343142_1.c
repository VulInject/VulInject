static int consolidate ( struct ubifs_info * c ) { int tot_avail = tot_avail_orphs ( c ) , err = 0 ; spin_lock ( & c -> orphan_lock ) ; dbg_cmt ( "there is space for %d orphans and there are %d" , tot_avail , c -> tot_orphans ) ; if ( c -> tot_orphans - c -> new_orphans <= tot_avail ) { struct ubifs_orphan * orphan , * * last ; int cnt = 0 ; last = & c -> orph_cnext ; list_for_each_entry ( , , ) { if ( orphan -> new ) { continue ; } orphan -> cmt = 1 ; * last = orphan ; last = & orphan -> cnext ; cnt += 1 ; } * last = NULL ; ubifs_assert ( cnt == c -> tot_orphans - c -> new_orphans ) ; c -> ohead_lnum = c -> orph_first ; c -> ohead_offs = 0 ; } else { ubifs_err ( c , "out of space in orphan area" ) ; err = - EINVAL ; } spin_unlock ( & c -> orphan_lock ) ; return err ; } 