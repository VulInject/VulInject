static void nfp_net_bpf_load_and_start ( struct nfp_net * nn , u32 tc_flags , void * code , dma_addr_t dma_addr , unsigned int code_sz , unsigned int n_instr , bool dense_mode ) { u64 bpf_addr = dma_addr ; int err ; nn -> dp . bpf_offload_skip_sw = ! ! ( tc_flags & TCA_CLS_FLAGS_SKIP_SW ) ; if ( dense_mode ) { bpf_addr |= NFP_NET_CFG_BPF_CFG_8CTX ; } nn_writew ( nn , NFP_NET_CFG_BPF_SIZE , n_instr ) ; nn_writeq ( nn , NFP_NET_CFG_BPF_ADDR , bpf_addr ) ; err = nfp_net_reconfig ( nn , NFP_NET_CFG_UPDATE_BPF ) ; if ( err ) { nn_err ( nn , "FW command error while loading BPF: %d\n" , err ) ; } nn -> dp . ctrl |= NFP_NET_CFG_CTRL_BPF ; nn_writel ( nn , NFP_NET_CFG_CTRL , nn -> dp . ctrl ) ; err = nfp_net_reconfig ( nn , NFP_NET_CFG_UPDATE_GEN ) ; if ( err ) { nn_err ( nn , "FW command error while enabling BPF: %d\n" , err ) ; } dma_free_coherent ( nn -> dp . dev , code_sz , code , dma_addr ) ; nfp_net_bpf_stats_reset ( nn ) ; } 