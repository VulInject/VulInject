void nwamd_ncp_handle_enable_event ( nwamd_event_t event ) { char * new_ncp = event -> event_object ; nwam_ncp_handle_t new_ncph ; nwam_error_t err ; if ( new_ncp [ 0 ] == '\0' ) { return ; } ( void ) pthread_mutex_lock ( & active_ncp_mutex ) ; if ( strcmp ( active_ncp , new_ncp ) == 0 && ! initial_ncp_enable ) { nlog ( LOG_DEBUG , "nwamd_ncp_handle_enable_event: " "%s is already active" , new_ncp ) ; ( void ) pthread_mutex_unlock ( & active_ncp_mutex ) ; return ; } ( void ) pthread_mutex_unlock ( & active_ncp_mutex ) ; nlog ( LOG_DEBUG , "nwamd_ncp_handle_enable_event: activating NCP %s" , new_ncp ) ; nwamd_fini_ncus ( ) ; if ( ( err = nwam_ncp_read ( new_ncp , 0 , & new_ncph ) ) == NWAM_ENTITY_NOT_FOUND ) { err = nwam_ncp_create ( new_ncp , 0 , & new_ncph ) ; } if ( err == NWAM_SUCCESS ) { nwamd_object_set_state ( NWAM_OBJECT_TYPE_NCP , new_ncp , NWAM_STATE_ONLINE , NWAM_AUX_STATE_ACTIVE ) ; } if ( initial_ncp_enable ) { nwamd_event_t retry_event = nwamd_event_init_object_action ( NWAM_OBJECT_TYPE_NCP , new_ncp , NULL , NWAM_ACTION_ENABLE ) ; if ( retry_event == NULL ) { nlog ( LOG_ERR , "nwamd_ncp_handle_enable_event: " "could not create retry event to enable %s NCP" , new_ncp ) ; return ; } nlog ( LOG_ERR , "nwamd_ncp_handle_enable_event: " "failed to enable %s NCP, retrying in %d seconds" , new_ncp , NWAMD_READONLY_RETRY_INTERVAL ) ; nwamd_event_enqueue_timed ( retry_event , NWAMD_READONLY_RETRY_INTERVAL ) ; } else { nlog ( LOG_ERR , "nwamd_ncp_handle_enable_event: error %s" , nwam_strerror ( err ) ) ; return ; } } 