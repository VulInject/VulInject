static struct btt * btt_init ( struct nd_btt * nd_btt , unsigned long long rawsize , u32 lbasize , uuid_t * uuid , struct nd_region * nd_region ) { int ret ; struct btt * btt ; struct nd_namespace_io * nsio ; struct device * dev = & nd_btt -> dev ; btt = devm_kzalloc ( dev , sizeof ( btt ) , GFP_KERNEL ) ; if ( ! btt ) { return NULL ; } btt -> nd_btt = nd_btt ; btt -> rawsize = rawsize ; btt -> lbasize = lbasize ; btt -> sector_size = ( ( lbasize >= 4096 ) ?4096 : 512 ) ; INIT_LIST_HEAD ( & btt -> arena_list ) ; btt -> nd_region = nd_region ; nsio = to_nd_namespace_io ( & nd_btt -> ndns -> dev ) ; btt -> phys_bb = & nsio -> bb ; ret = discover_arenas ( btt ) ; if ( ret ) { dev_err ( dev , "init: error in arena_discover: %d\n" , ret ) ; return NULL ; } if ( btt -> init_state != INIT_READY && nd_region -> ro ) { dev_warn ( dev , "%s is read-only, unable to init btt metadata\n" , dev_name ( & nd_region -> dev ) ) ; return NULL ; } if ( btt -> init_state != INIT_READY ) { btt -> num_arenas = ( rawsize / ARENA_MAX_SIZE ) + ( ( rawsize % ARENA_MAX_SIZE ) ?1 : 0 ) ; dev_dbg ( dev , "init: %d arenas for %llu rawsize\n" , btt -> num_arenas , rawsize ) ; ret = create_arenas ( btt ) ; if ( ret ) { dev_info ( dev , "init: create_arenas: %d\n" , ret ) ; return NULL ; } ret = btt_meta_init ( btt ) ; if ( ret ) { dev_err ( dev , "init: error in meta_init: %d\n" , ret ) ; return NULL ; } } ret = btt_blk_init ( btt ) ; if ( ret ) { dev_err ( dev , "init: error in blk_init: %d\n" , ret ) ; return NULL ; } btt_debugfs_init ( btt ) ; return btt ; } 