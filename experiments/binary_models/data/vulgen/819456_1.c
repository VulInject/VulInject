static void fetch_msg ( struct mailimap * imap , uint32_t uid ) { struct mailimap_set * set ; struct mailimap_section * section ; char filename [ 512 ] ; size_t msg_len ; char * msg_content ; FILE * f ; struct mailimap_fetch_type * fetch_type ; struct mailimap_fetch_att * fetch_att ; int r ; clist * fetch_result ; struct stat stat_info ; snprintf ( filename , sizeof ( filename ) , "download/%u.eml" , ( unsigned int ) uid ) ; r = stat ( filename , & stat_info ) ; if ( r == 0 ) { printf ( "%u is already fetched\n" , ( unsigned int ) uid ) ; return ; } set = mailimap_set_new_single ( uid ) ; fetch_type = mailimap_fetch_type_new_fetch_att_list_empty ( ) ; section = mailimap_section_new ( NULL ) ; fetch_att = mailimap_fetch_att_new_body_peek_section ( section ) ; mailimap_fetch_type_new_fetch_att_list_add ( fetch_type , fetch_att ) ; r = mailimap_uid_fetch ( imap , set , fetch_type , & fetch_result ) ; check_error ( r , "could not fetch" ) ; printf ( "fetch %u\n" , ( unsigned int ) uid ) ; msg_content = get_msg_content ( fetch_result , & msg_len ) ; if ( msg_content == NULL ) { fprintf ( stderr , "no content\n" ) ; return ; } f = fopen ( filename , "w" ) ; if ( f == NULL ) { fprintf ( stderr , "could not write\n" ) ; mailimap_fetch_list_free ( fetch_result ) ; return ; } fwrite ( msg_content , 1 , msg_len , f ) ; fclose ( f ) ; printf ( "%u has been fetched\n" , ( unsigned int ) uid ) ; mailimap_fetch_list_free ( fetch_result ) ; } 