ssize_t allegro_encode_config_blob ( u32 * dst , struct create_channel_param * param ) { enum mcu_msg_version version = param -> version ; unsigned int i = 0 ; unsigned int j = 0 ; u32 val ; unsigned int codec = settings_get_mcu_codec ( param ) ; if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> layer_id ; } dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> height ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> width ) ; if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> videomode ; } dst [ i ++ ] = param -> format ; if ( version < MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> colorspace ; } dst [ i ++ ] = param -> src_mode ; if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> src_bit_depth ; } dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 24 ) , codec ) | FIELD_PREP ( GENMASK ( 23 , 8 ) , param -> constraint_set_flags ) | FIELD_PREP ( GENMASK ( 7 , 0 ) , param -> profile ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> tier ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> level ) ; val = 0 ; val |= param -> temporal_mvp_enable ?BIT ( 20 ) : 0 ; val |= FIELD_PREP ( GENMASK ( 7 , 4 ) , param -> log2_max_frame_num ) ; if ( version >= MCU_MSG_VERSION_2019_2 ) { val |= FIELD_PREP ( GENMASK ( 3 , 0 ) , param -> log2_max_poc - 1 ) ; } else { val |= FIELD_PREP ( GENMASK ( 3 , 0 ) , param -> log2_max_poc ) ; } dst [ i ++ ] = val ; val = 0 ; val |= param -> enable_reordering ?BIT ( 0 ) : 0 ; val |= param -> dbf_ovr_en ?BIT ( 2 ) : 0 ; val |= param -> override_lf ?BIT ( 12 ) : 0 ; dst [ i ++ ] = val ; if ( version >= MCU_MSG_VERSION_2019_2 ) { val = 0 ; val |= param -> custom_lda ?BIT ( 2 ) : 0 ; val |= param -> rdo_cost_mode ?BIT ( 20 ) : 0 ; dst [ i ++ ] = val ; val = 0 ; val |= param -> lf ?BIT ( 2 ) : 0 ; val |= param -> lf_x_tile ?BIT ( 3 ) : 0 ; val |= param -> lf_x_slice ?BIT ( 4 ) : 0 ; dst [ i ++ ] = val ; } else { val = 0 ; dst [ i ++ ] = val ; } dst [ i ++ ] = FIELD_PREP ( GENMASK ( 15 , 8 ) , param -> beta_offset ) | FIELD_PREP ( GENMASK ( 7 , 0 ) , param -> tc_offset ) ; dst [ i ++ ] = param -> unknown11 ; dst [ i ++ ] = param -> unknown12 ; dst [ i ++ ] = param -> num_slices ; dst [ i ++ ] = param -> encoder_buffer_offset ; dst [ i ++ ] = param -> encoder_buffer_enabled ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> clip_vrt_range ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> clip_hrz_range ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> me_range [ 1 ] ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> me_range [ 0 ] ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> me_range [ 3 ] ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> me_range [ 2 ] ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 24 ) , param -> min_tu_size ) | FIELD_PREP ( GENMASK ( 23 , 16 ) , param -> max_tu_size ) | FIELD_PREP ( GENMASK ( 15 , 8 ) , param -> min_cu_size ) | FIELD_PREP ( GENMASK ( 8 , 0 ) , param -> max_cu_size ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 15 , 8 ) , param -> max_transfo_depth_intra ) | FIELD_PREP ( GENMASK ( 7 , 0 ) , param -> max_transfo_depth_inter ) ; dst [ i ++ ] = param -> entropy_mode ; dst [ i ++ ] = param -> wp_mode ; dst [ i ++ ] = param -> rate_control_mode ; dst [ i ++ ] = param -> initial_rem_delay ; dst [ i ++ ] = param -> cpb_size ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> clk_ratio ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> framerate ) ; dst [ i ++ ] = param -> target_bitrate ; dst [ i ++ ] = param -> max_bitrate ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> min_qp ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> initial_qp ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> ip_delta ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> max_qp ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> golden_ref ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> pb_delta ) ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> golden_ref_frequency ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> golden_delta ) ; if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> rate_control_option ; } else { dst [ i ++ ] = 0 ; } if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> num_pixel ; dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 16 ) , param -> max_pixel_value ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> max_psnr ) ; for ( j = 0 ; j < 3 ; j ++ ) { dst [ i ++ ] = param -> maxpicturesize [ j ] ; } } if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> gop_ctrl_mode ; } else { dst [ i ++ ] = 0 ; } if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 24 ) , param -> freq_golden_ref ) | FIELD_PREP ( GENMASK ( 23 , 16 ) , param -> num_b ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> gop_length ) ; } dst [ i ++ ] = param -> freq_idr ; if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> enable_lt ; } dst [ i ++ ] = param -> freq_lt ; dst [ i ++ ] = param -> gdr_mode ; if ( version < MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = FIELD_PREP ( GENMASK ( 31 , 24 ) , param -> freq_golden_ref ) | FIELD_PREP ( GENMASK ( 23 , 16 ) , param -> num_b ) | FIELD_PREP ( GENMASK ( 15 , 0 ) , param -> gop_length ) ; } if ( version >= MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> tmpdqp ; } dst [ i ++ ] = param -> subframe_latency ; dst [ i ++ ] = param -> lda_control_mode ; if ( version < MCU_MSG_VERSION_2019_2 ) { dst [ i ++ ] = param -> unknown41 ; } return i * sizeof ( * dst ) ; } 