static int io_mode_to_flags ( mrb_state * mrb , mrb_value mode ) { if ( mrb_nil_p ( mode ) ) { return O_RDONLY ; } if ( mrb_string_p ( mode ) ) { return io_modestr_to_flags ( mrb , RSTRING_CSTR ( mrb , mode ) ) ; } else { int flags = 0 ; mrb_int flags0 = mrb_as_int ( mrb , mode ) ; switch ( flags0 & MRB_O_ACCMODE ) { case MRB_O_RDONLY : flags |= O_RDONLY ; break ; case MRB_O_WRONLY : flags |= O_WRONLY ; break ; case MRB_O_RDWR : flags |= O_RDWR ; break ; default : mrb_raisef ( mrb , E_ARGUMENT_ERROR , "illegal access mode %v" , mode ) ; } if ( flags0 & MRB_O_APPEND ) { flags |= O_APPEND ; } if ( flags0 & MRB_O_CREAT ) { flags |= O_CREAT ; } if ( flags0 & MRB_O_EXCL ) { flags |= O_EXCL ; } if ( flags0 & MRB_O_TRUNC ) { flags |= O_TRUNC ; } if ( flags0 & MRB_O_NONBLOCK ) { flags |= O_NONBLOCK ; } if ( flags0 & MRB_O_NOCTTY ) { flags |= O_NOCTTY ; } if ( flags0 & MRB_O_BINARY ) { flags |= O_BINARY ; } if ( flags0 & MRB_O_SHARE_DELETE ) { flags |= O_SHARE_DELETE ; } if ( flags0 & MRB_O_SYNC ) { flags |= O_SYNC ; } if ( flags0 & MRB_O_DSYNC ) { flags |= O_DSYNC ; } if ( flags0 & MRB_O_RSYNC ) { flags |= O_RSYNC ; } if ( flags0 & MRB_O_NOFOLLOW ) { flags |= O_NOFOLLOW ; } if ( flags0 & MRB_O_NOATIME ) { flags |= O_NOATIME ; } if ( flags0 & MRB_O_DIRECT ) { flags |= O_DIRECT ; } return flags ; } } 