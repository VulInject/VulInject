static int ql_idc_wait ( struct ql_adapter * qdev ) { int status = - ETIMEDOUT ; struct mbox_params * mbcp = & qdev -> idc_mbc ; { wait_time = wait_for_completion_timeout ( & qdev -> ide_completion , wait_time ) ; if ( ! wait_time ) { netif_err ( qdev , drv , qdev -> ndev , "IDC Timeout.\n" ) ; break ; } if ( mbcp -> mbox_out [ 0 ] == AEN_IDC_EXT ) { netif_err ( qdev , drv , qdev -> ndev , "IDC Time Extension from function.\n" ) ; wait_time += ( mbcp -> mbox_out [ 1 ] >> 8 ) & 0x0000000f ; } if ( mbcp -> mbox_out [ 0 ] == AEN_IDC_CMPLT ) { netif_err ( qdev , drv , qdev -> ndev , "IDC Success.\n" ) ; status = 0 ; break ; } else { netif_err ( qdev , drv , qdev -> ndev , "IDC: Invalid State 0x%.04x.\n" , mbcp -> mbox_out [ 0 ] ) ; status = - EIO ; break ; } } wait_time ; return status ; } 