static void pl041_fifo1_transmit ( PL041State * s ) { pl041_channel * channel = & s -> fifo1 ; pl041_fifo * fifo = & s -> fifo1 . tx_fifo ; uint32_t slots = s -> regs . txcr1 & TXSLOT_MASK ; uint32_t written_samples ; if ( ( channel -> tx_enabled ) && ( slots & ( TXSLOT3 | TXSLOT4 ) ) ) { if ( fifo -> level >= ( s -> fifo_depth / 2 ) ) { int i ; DBG_L1 ( "Transfer FIFO level = %i\n" , fifo -> level ) ; for ( i = 0 ; i < ( fifo -> level / 2 ) ; i ++ ) { uint32_t left = fifo -> data [ i * 2 ] ; uint32_t right = fifo -> data [ i * 2 + 1 ] ; if ( lm4549_write_samples ( & s -> codec , left , right ) == 0 ) { DBG_L1 ( "Codec buffer full\n" ) ; break ; } } written_samples = i * 2 ; if ( written_samples > 0 ) { fifo -> level -= written_samples ; for ( i = 0 ; i < fifo -> level ; i ++ ) { fifo -> data [ i ] = fifo -> data [ written_samples + i ] ; } s -> regs . sr1 &= ~ TXFF ; if ( fifo -> level <= ( s -> fifo_depth / 2 ) ) { s -> regs . sr1 |= TXHE ; } } } } } 