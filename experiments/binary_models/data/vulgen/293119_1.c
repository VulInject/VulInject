static enum drm_connector_status radeon_dp_detect ( struct drm_connector * connector , bool force ) { struct drm_device * dev = connector -> dev ; struct radeon_device * rdev = dev -> dev_private ; struct radeon_connector * radeon_connector = to_radeon_connector ( connector ) ; enum drm_connector_status ret = connector_status_disconnected ; struct radeon_connector_atom_dig * radeon_dig_connector = radeon_connector -> con_priv ; struct drm_encoder * encoder = radeon_best_single_encoder ( connector ) ; int r ; if ( radeon_dig_connector -> is_mst ) { return connector_status_disconnected ; } r = pm_runtime_get_sync ( connector -> dev -> dev ) ; if ( r < 0 ) { return connector_status_disconnected ; } if ( ! force && radeon_check_hpd_status_unchanged ( connector ) ) { ret = connector -> status ; out } radeon_connector_free_edid ( connector ) ; if ( ( connector -> connector_type == DRM_MODE_CONNECTOR_eDP ) || ( connector -> connector_type == DRM_MODE_CONNECTOR_LVDS ) ) { if ( encoder ) { struct radeon_encoder * radeon_encoder = to_radeon_encoder ( encoder ) ; struct drm_display_mode * native_mode = & radeon_encoder -> native_mode ; if ( native_mode -> hdisplay >= 320 && native_mode -> vdisplay >= 240 ) { ret = connector_status_connected ; } if ( ( rdev -> flags & RADEON_IS_PX ) && ( radeon_runtime_pm != 0 ) ) { ret = connector_status_disconnected ; } } if ( ! radeon_dig_connector -> edp_on ) { atombios_set_edp_panel_power ( connector , ATOM_TRANSMITTER_ACTION_POWER_ON ) ; } if ( radeon_dp_getdpcd ( radeon_connector ) ) { ret = connector_status_connected ; } if ( ! radeon_dig_connector -> edp_on ) { atombios_set_edp_panel_power ( connector , ATOM_TRANSMITTER_ACTION_POWER_OFF ) ; } } if ( radeon_connector_encoder_get_dp_bridge_encoder_id ( connector ) != ENCODER_OBJECT_ID_NONE ) { radeon_dig_connector -> dp_sink_type = CONNECTOR_OBJECT_ID_DISPLAYPORT ; radeon_dp_getdpcd ( radeon_connector ) ; if ( encoder ) { radeon_atom_ext_encoder_setup_ddc ( encoder ) ; if ( radeon_ddc_probe ( radeon_connector , true ) ) { ret = connector_status_connected ; } if ( radeon_connector -> dac_load_detect ) { const struct drm_encoder_helper_funcs * encoder_funcs = encoder -> helper_private ; ret = encoder_funcs -> detect ( encoder , connector ) ; } } } else { radeon_dig_connector -> dp_sink_type = radeon_dp_getsinktype ( radeon_connector ) ; if ( radeon_hpd_sense ( rdev , radeon_connector -> hpd . hpd ) ) { ret = connector_status_connected ; if ( radeon_dig_connector -> dp_sink_type == CONNECTOR_OBJECT_ID_DISPLAYPORT ) { radeon_dp_getdpcd ( radeon_connector ) ; r = radeon_dp_mst_probe ( radeon_connector ) ; if ( r == 1 ) { ret = connector_status_disconnected ; } } } else { if ( radeon_dig_connector -> dp_sink_type == CONNECTOR_OBJECT_ID_DISPLAYPORT ) { if ( radeon_dp_getdpcd ( radeon_connector ) ) { r = radeon_dp_mst_probe ( radeon_connector ) ; if ( r == 1 ) { ret = connector_status_disconnected ; } else { ret = connector_status_connected ; } } } else { if ( radeon_ddc_probe ( radeon_connector , false ) ) { ret = connector_status_connected ; } } } } radeon_connector_update_scratch_regs ( connector , ret ) ; if ( ( radeon_audio != 0 ) && encoder ) { radeon_connector_get_edid ( connector ) ; radeon_audio_detect ( connector , encoder , ret ) ; } out pm_runtime_mark_last_busy ( connector -> dev -> dev ) ; pm_runtime_put_autosuspend ( connector -> dev -> dev ) ; return ret ; } 