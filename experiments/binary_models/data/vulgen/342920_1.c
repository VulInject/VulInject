static irqreturn_t wbcir_irq_handler ( int irqno , void * cookie ) { struct pnp_dev * device = cookie ; struct wbcir_data * data = pnp_get_drvdata ( device ) ; unsigned long flags ; u8 status ; spin_lock_irqsave ( & data -> spinlock , flags ) ; wbcir_select_bank ( data , WBCIR_BANK_0 ) ; status = inb ( data -> sbase + WBCIR_REG_SP3_EIR ) ; status &= data -> irqmask ; if ( ! status ) { spin_unlock_irqrestore ( & data -> spinlock , flags ) ; return IRQ_NONE ; } if ( status & WBCIR_IRQ_ERR ) { if ( inb ( data -> sbase + WBCIR_REG_SP3_LSR ) & WBCIR_RX_OVERRUN ) { data -> rxstate = WBCIR_RXSTATE_ERROR ; } if ( inb ( data -> sbase + WBCIR_REG_SP3_ASCR ) & WBCIR_TX_UNDERRUN ) { data -> txstate = WBCIR_TXSTATE_ERROR ; } } if ( status & WBCIR_IRQ_RX ) { wbcir_irq_rx ( data , device ) ; } if ( status & ( WBCIR_IRQ_TX_LOW | WBCIR_IRQ_TX_EMPTY ) ) { wbcir_irq_tx ( data ) ; } spin_unlock_irqrestore ( & data -> spinlock , flags ) ; return IRQ_HANDLED ; } 