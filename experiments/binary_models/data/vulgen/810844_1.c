static int efx_vfdi_init_txq ( struct siena_vf * vf ) { struct efx_nic * efx = vf -> efx ; struct vfdi_req * req = vf -> buf . addr ; unsigned vf_txq = req -> u . init_txq . index ; unsigned vf_evq = req -> u . init_txq . evq ; unsigned buf_count = req -> u . init_txq . buf_count ; unsigned buftbl = EFX_BUFTBL_TXQ_BASE ( vf , vf_txq ) ; unsigned label , eth_filt_en ; efx_oword_t reg ; if ( bad_vf_index ( efx , vf_evq ) || bad_vf_index ( efx , vf_txq ) || vf_txq >= vf_max_tx_channels || bad_buf_count ( buf_count , EFX_MAX_DMAQ_SIZE ) ) { return VFDI_RC_EINVAL ; } mutex_lock ( & vf -> txq_lock ) ; if ( __test_and_set_bit ( req -> u . init_txq . index , vf -> txq_mask ) ) { ++ vf -> txq_count ; } mutex_unlock ( & vf -> txq_lock ) ; efx_siena_sriov_bufs ( efx , buftbl , req -> u . init_txq . addr , buf_count ) ; eth_filt_en = vf -> tx_filter_mode == VF_TX_FILTER_ON ; label = req -> u . init_txq . label & EFX_FIELD_MASK ( FRF_AZ_TX_DESCQ_LABEL ) ; EFX_POPULATE_OWORD_8 ( reg , FRF_CZ_TX_DPT_Q_MASK_WIDTH , min ( efx -> vi_scale , 1U ) , FRF_CZ_TX_DPT_ETH_FILT_EN , eth_filt_en , FRF_AZ_TX_DESCQ_EN , 1 , FRF_AZ_TX_DESCQ_BUF_BASE_ID , buftbl , FRF_AZ_TX_DESCQ_EVQ_ID , abs_index ( vf , vf_evq ) , FRF_AZ_TX_DESCQ_LABEL , label , FRF_AZ_TX_DESCQ_SIZE , __ffs ( buf_count ) , FRF_BZ_TX_NON_IP_DROP_DIS , 1 ) ; efx_writeo_table ( efx , & reg , FR_BZ_TX_DESC_PTR_TBL , abs_index ( vf , vf_txq ) ) ; return VFDI_RC_SUCCESS ; } 