static int write_wav_header ( audio_file * aufile ) { unsigned char header [ 44 ] ; unsigned char * p = header ; unsigned int bytes = ( aufile -> bits_per_sample + 7 ) / 8 ; float data_size = ( float ) bytes * aufile -> total_samples ; unsigned long word32 ; * p ++ = 'R' ; * p ++ = 'I' ; * p ++ = 'F' ; * p ++ = 'F' ; word32 = ( data_size + ( 44 - 8 ) < ( float ) MAXWAVESIZE ) ?( unsigned long ) data_size + ( 44 - 8 ) : ( unsigned long ) MAXWAVESIZE ; * p ++ = ( unsigned char ) ( word32 >> 0 ) ; * p ++ = ( unsigned char ) ( word32 >> 8 ) ; * p ++ = ( unsigned char ) ( word32 >> 16 ) ; * p ++ = ( unsigned char ) ( word32 >> 24 ) ; * p ++ = 'W' ; * p ++ = 'A' ; * p ++ = 'V' ; * p ++ = 'E' ; * p ++ = 'f' ; * p ++ = 'm' ; * p ++ = 't' ; * p ++ = ' ' ; * p ++ = 0x10 ; * p ++ = 0x00 ; * p ++ = 0x00 ; * p ++ = 0x00 ; else { * p ++ = 0x01 ; * p ++ = 0x00 ; } * p ++ = ( unsigned char ) ( aufile -> channels >> 0 ) ; * p ++ = ( unsigned char ) ( aufile -> channels >> 8 ) ; word32 = ( unsigned long ) ( aufile -> samplerate + 0.5 ) ; * p ++ = ( unsigned char ) ( word32 >> 0 ) ; * p ++ = ( unsigned char ) ( word32 >> 8 ) ; * p ++ = ( unsigned char ) ( word32 >> 16 ) ; * p ++ = ( unsigned char ) ( word32 >> 24 ) ; word32 = aufile -> samplerate * bytes * aufile -> channels ; * p ++ = ( unsigned char ) ( word32 >> 0 ) ; * p ++ = ( unsigned char ) ( word32 >> 8 ) ; * p ++ = ( unsigned char ) ( word32 >> 16 ) ; * p ++ = ( unsigned char ) ( word32 >> 24 ) ; word32 = bytes * aufile -> channels ; * p ++ = ( unsigned char ) ( word32 >> 0 ) ; * p ++ = ( unsigned char ) ( word32 >> 8 ) ; * p ++ = ( unsigned char ) ( aufile -> bits_per_sample >> 0 ) ; * p ++ = ( unsigned char ) ( aufile -> bits_per_sample >> 8 ) ; * p ++ = 'd' ; * p ++ = 'a' ; * p ++ = 't' ; * p ++ = 'a' ; word32 = data_size < MAXWAVESIZE ?( unsigned long ) data_size : ( unsigned long ) MAXWAVESIZE ; * p ++ = ( unsigned char ) ( word32 >> 0 ) ; * p ++ = ( unsigned char ) ( word32 >> 8 ) ; * p ++ = ( unsigned char ) ( word32 >> 16 ) ; * p ++ = ( unsigned char ) ( word32 >> 24 ) ; return fwrite ( header , sizeof ( header ) , 1 , aufile -> sndfile ) ; } 