insert_aux ( ) { basic_block son ; bool new_stuff = false ; if ( block ) { basic_block dom ; dom = get_immediate_dominator ( CDI_DOMINATORS , block ) ; if ( dom ) { unsigned i ; bitmap_iterator bi ; bitmap_set_t newset = NEW_SETS ( dom ) ; if ( newset ) { EXECUTE_IF_SET_IN_BITMAP ( , 0 , , ) { bitmap_value_replace_in_set ( NEW_SETS ( block ) , ssa_name ( i ) ) ; bitmap_value_replace_in_set ( AVAIL_OUT ( block ) , ssa_name ( i ) ) ; } } if ( ! single_pred_p ( block ) ) { value_set_node_t node ; for ( node = ANTIC_IN ( block ) -> head ; node ; node = node -> next ) { if ( can_PRE_operation ( node -> expr ) && ! AGGREGATE_TYPE_P ( TREE_TYPE ( node -> expr ) ) ) { tree * avail ; tree val ; bool by_some = false ; bool cant_insert = false ; bool all_same = true ; tree first_s = NULL ; edge pred ; basic_block bprime ; tree eprime = NULL_TREE ; edge_iterator ei ; val = get_value_handle ( node -> expr ) ; if ( bitmap_set_contains_value ( PHI_GEN ( block ) , val ) ) { continue ; } if ( bitmap_set_contains_value ( AVAIL_OUT ( dom ) , val ) ) { if ( dump_file && ( dump_flags & TDF_DETAILS ) ) { fprintf ( dump_file , "Found fully redundant value\n" ) ; } continue ; } avail = XCNEWVEC ( tree , last_basic_block ) ; FOR_EACH_EDGE ( , , ) { tree vprime ; tree edoubleprime ; if ( EDGE_CRITICAL_P ( pred ) ) { break ; } bprime = pred -> src ; eprime = phi_translate ( node -> expr , ANTIC_IN ( block ) , bprime , block ) ; if ( eprime == NULL ) { cant_insert = true ; break ; } eprime = fully_constant_expression ( eprime ) ; vprime = get_value_handle ( eprime ) ; gcc_assert ( vprime ) ; edoubleprime = bitmap_find_leader ( AVAIL_OUT ( bprime ) , vprime ) ; if ( edoubleprime == NULL ) { avail [ bprime -> index ] = eprime ; all_same = false ; } else { avail [ bprime -> index ] = edoubleprime ; by_some = true ; if ( first_s == NULL ) { first_s = edoubleprime ; } if ( ! operand_equal_p ( first_s , edoubleprime , 0 ) ) { all_same = false ; } } } if ( ! cant_insert && ! all_same && by_some ) { if ( insert_into_preds_of_block ( block , node , avail ) ) { new_stuff = true ; } } if ( ! cant_insert && all_same && eprime && is_gimple_min_invariant ( eprime ) && ! is_gimple_min_invariant ( val ) ) { value_set_t exprset = VALUE_HANDLE_EXPR_SET ( val ) ; value_set_node_t node ; for ( node = exprset -> head ; node ; node = node -> next ) { if ( TREE_CODE ( node -> expr ) == SSA_NAME ) { vn_add ( node -> expr , eprime ) ; pre_stats . constified ++ ; } } } free ( avail ) ; } } } } } for ( son = first_dom_son ( CDI_DOMINATORS , block ) ; son ; son = next_dom_son ( CDI_DOMINATORS , son ) ) { new_stuff |= insert_aux ( son ) ; } return new_stuff ; } 