static void natsemi_disable ( struct dev * dev ) static void natsemi_irq ( struct nic * nic , irq_action_t action ) static int natsemi_probe ( struct dev * dev , struct pci_device * pci ) { struct nic * nic = ( nic * ) dev ; int i ; int prev_eedata ; u32 tmp ; adjust_pci_device ( pci ) ; nic -> irqno = 0 ; nic -> ioaddr = pci -> ioaddr & ~ 3 ; ioaddr = pci -> ioaddr & ~ 3 ; vendor = pci -> vendor ; dev_id = pci -> dev_id ; nic_name = pci -> name ; pcibios_read_config_dword ( pci -> bus , pci -> devfn , PCIPM , & tmp ) ; if ( tmp & ( 0x03 | 0x100 ) ) { u32 newtmp = tmp & ~ ( 0x03 | 0x100 ) ; pcibios_write_config_dword ( pci -> bus , pci -> devfn , PCIPM , newtmp ) ; } prev_eedata = eeprom_read ( ioaddr , 6 ) ; for ( i = 0 ; i < 3 ; i ++ ) { int eedata = eeprom_read ( ioaddr , i + 7 ) ; nic -> node_addr [ i * 2 ] = ( eedata << 1 ) + ( prev_eedata >> 15 ) ; nic -> node_addr [ i * 2 + 1 ] = eedata >> 7 ; prev_eedata = eedata ; } printf ( "\nnatsemi_probe: MAC addr %! at ioaddr %#hX\n" , nic -> node_addr , ioaddr ) ; printf ( "natsemi_probe: Vendor:%#hX Device:%#hX\n" , vendor , dev_id ) ; outl ( ChipReset , ioaddr + ChipCmd ) ; advertising = mdio_read ( 1 , 4 ) ; { u32 chip_config = inl ( ioaddr + ChipConfig ) ; printf ( "%s: Transceiver default autoneg. %s " "10%s %s duplex.\n" , nic_name , chip_config & 0x2000 ?"enabled, advertise" : "disabled, force" , chip_config & 0x4000 ?"0" : "" , chip_config & 0x8000 ?"full" : "half" ) ; } printf ( "%s: Transceiver status %hX advertising %hX\n" , nic_name , ( int ) inl ( ioaddr + 0x84 ) , advertising ) ; SavedClkRun = inl ( ioaddr + ClkRun ) ; outl ( SavedClkRun & ~ 0x100 , ioaddr + ClkRun ) ; natsemi_init ( nic ) ; dev -> disable = natsemi_disable ; nic -> poll = natsemi_poll ; nic -> transmit = natsemi_transmit ; nic -> irq = natsemi_irq ; return 1 ; } 