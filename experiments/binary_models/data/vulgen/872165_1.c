int vsp1_histogram_init ( struct vsp1_device * vsp1 , struct vsp1_histogram * histo , enum vsp1_entity_type type , const char * name , const struct vsp1_entity_operations * ops , const unsigned int * formats , unsigned int num_formats , size_t data_size , u32 meta_format ) { int ret ; histo -> formats = formats ; histo -> num_formats = num_formats ; histo -> data_size = data_size ; histo -> meta_format = meta_format ; histo -> pad . flags = MEDIA_PAD_FL_SINK ; histo -> video . vfl_dir = VFL_DIR_RX ; spin_lock_init ( & histo -> irqlock ) ; INIT_LIST_HEAD ( & histo -> irqqueue ) ; init_waitqueue_head ( & histo -> wait_queue ) ; histo -> entity . ops = ops ; histo -> entity . type = type ; ret = vsp1_entity_init ( vsp1 , & histo -> entity , name , 2 , & histo_ops , MEDIA_ENT_F_PROC_VIDEO_STATISTICS ) ; if ( ret < 0 ) { return ret ; } ret = media_entity_pads_init ( & histo -> video . entity , 1 , & histo -> pad ) ; if ( ret < 0 ) { return ret ; } histo -> video . v4l2_dev = & vsp1 -> v4l2_dev ; histo -> video . fops = & histo_v4l2_fops ; snprintf ( histo -> video . name , sizeof ( histo -> video . name ) , "%s histo" , histo -> entity . subdev . name ) ; histo -> video . vfl_type = VFL_TYPE_VIDEO ; histo -> video . release = video_device_release_empty ; histo -> video . ioctl_ops = & histo_v4l2_ioctl_ops ; histo -> video . device_caps = V4L2_CAP_META_CAPTURE | V4L2_CAP_STREAMING ; video_set_drvdata ( & histo -> video , histo ) ; histo -> queue . type = V4L2_BUF_TYPE_META_CAPTURE ; histo -> queue . io_modes = VB2_MMAP | VB2_USERPTR | VB2_DMABUF ; histo -> queue . lock = & histo -> lock ; histo -> queue . drv_priv = histo ; histo -> queue . buf_struct_size = sizeof ( vsp1_histogram_buffer ) ; histo -> queue . ops = & histo_video_queue_qops ; histo -> queue . mem_ops = & vb2_vmalloc_memops ; histo -> queue . timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_COPY ; histo -> queue . dev = vsp1 -> dev ; ret = vb2_queue_init ( & histo -> queue ) ; if ( ret < 0 ) { dev_err ( vsp1 -> dev , "failed to initialize vb2 queue\n" ) ; error } histo -> video . queue = & histo -> queue ; ret = video_register_device ( & histo -> video , VFL_TYPE_VIDEO , - 1 ) ; if ( ret < 0 ) { dev_err ( vsp1 -> dev , "failed to register video device\n" ) ; error } return 0 ; error vsp1_histogram_cleanup ( histo ) ; return ret ; } 