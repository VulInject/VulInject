int ACLAppendUserForLoading ( sds * argv , int argc , int * argc_err ) { if ( argc < 2 || strcasecmp ( argv [ 0 ] , "user" ) ) { if ( argc_err ) { * argc_err = 0 ; } return C_ERR ; } if ( listSearchKey ( UsersToLoad , argv [ 1 ] ) ) { if ( argc_err ) { * argc_err = 1 ; } errno = EALREADY ; return C_ERR ; } user * fakeuser = ACLCreateUnlinkedUser ( ) ; int merged_argc ; sds * acl_args = ACLMergeSelectorArguments ( argv + 2 , argc - 2 , & merged_argc , argc_err ) ; if ( ! acl_args ) { return C_ERR ; } for ( int j = 0 ; j < merged_argc ; j ++ ) { if ( ACLSetUser ( fakeuser , acl_args [ j ] , sdslen ( acl_args [ j ] ) ) == C_ERR ) { if ( errno != ENOENT ) { if ( argc_err ) { * argc_err = j ; } for ( int i = 0 ; i < merged_argc ; i ++ ) { sdsfree ( acl_args [ i ] ) ; } zfree ( acl_args ) ; return C_ERR ; } } } sds * copy = zmalloc ( sizeof ( sds ) * ( merged_argc + 2 ) ) ; copy [ 0 ] = sdsdup ( argv [ 1 ] ) ; for ( int j = 0 ; j < merged_argc ; j ++ ) { copy [ j + 1 ] = sdsdup ( acl_args [ j ] ) ; } copy [ merged_argc + 1 ] = NULL ; listAddNodeTail ( UsersToLoad , copy ) ; ACLFreeUser ( fakeuser ) ; for ( int i = 0 ; i < merged_argc ; i ++ ) { sdsfree ( acl_args [ i ] ) ; } zfree ( acl_args ) ; return C_OK ; } 