struct platform_device * of_device_alloc ( struct device_node * np , const char * bus_id , struct device * parent ) { struct platform_device * dev ; int rc , i , num_reg = 0 ; struct resource * res ; dev = platform_device_alloc ( "" , PLATFORM_DEVID_NONE ) ; if ( ! dev ) { return NULL ; } num_reg = of_address_count ( np ) ; if ( num_reg ) { res = kcalloc ( num_reg , sizeof ( * res ) , GFP_KERNEL ) ; if ( ! res ) { return NULL ; } dev -> num_resources = num_reg ; dev -> resource = res ; for ( i = 0 ; i < num_reg ; i ++ , res ++ ) { rc = of_address_to_resource ( np , i , res ) ; WARN_ON ( rc ) ; } } dev -> dev . of_node = of_node_get ( np ) ; dev -> dev . fwnode = & np -> fwnode ; dev -> dev . parent = parent ?: & platform_bus ; if ( bus_id ) { dev_set_name ( & dev -> dev , "%s" , bus_id ) ; } else { of_device_make_bus_id ( & dev -> dev ) ; } return dev ; } 