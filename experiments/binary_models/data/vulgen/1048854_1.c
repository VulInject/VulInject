int usb_serial_generic_write_start ( struct usb_serial_port * port , gfp_t mem_flags ) { struct urb * urb ; int count , result ; unsigned long flags ; int i ; if ( test_and_set_bit_lock ( USB_SERIAL_WRITE_BUSY , & port -> flags ) ) { return 0 ; } retry spin_lock_irqsave ( & port -> lock , flags ) ; if ( ! port -> write_urbs_free || ! kfifo_len ( & port -> write_fifo ) ) { clear_bit_unlock ( USB_SERIAL_WRITE_BUSY , & port -> flags ) ; spin_unlock_irqrestore ( & port -> lock , flags ) ; return 0 ; } i = ( int ) find_first_bit ( & port -> write_urbs_free , ARRAY_SIZE ( port -> write_urbs ) ) ; spin_unlock_irqrestore ( & port -> lock , flags ) ; urb = port -> write_urbs [ i ] ; count = port -> serial -> type -> prepare_write_buffer ( port , urb -> transfer_buffer , port -> bulk_out_size ) ; usb_serial_debug_data ( & port -> dev , __func__ , count , urb -> transfer_buffer ) ; spin_lock_irqsave ( & port -> lock , flags ) ; port -> tx_bytes += count ; spin_unlock_irqrestore ( & port -> lock , flags ) ; clear_bit ( i , & port -> write_urbs_free ) ; result = usb_submit_urb ( urb , mem_flags ) ; if ( result ) { dev_err_console ( port , "%s - error submitting urb: %d\n" , __func__ , result ) ; set_bit ( i , & port -> write_urbs_free ) ; spin_lock_irqsave ( & port -> lock , flags ) ; port -> tx_bytes -= count ; spin_unlock_irqrestore ( & port -> lock , flags ) ; clear_bit_unlock ( USB_SERIAL_WRITE_BUSY , & port -> flags ) ; return result ; } retry } 