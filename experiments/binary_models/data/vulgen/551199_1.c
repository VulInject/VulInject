static int __init integrator_cp_of_init ( struct device_node * np ) { static int init_count = 0 ; void __iomem * base ; int irq , ret = - EINVAL ; struct clk * clk ; base = of_iomap ( np , 0 ) ; if ( ! base ) { pr_err ( "Failed to iomap\n" ) ; return - ENXIO ; } clk = of_clk_get ( np , 0 ) ; if ( IS_ERR ( clk ) ) { pr_err ( "Failed to get clock\n" ) ; return PTR_ERR ( clk ) ; } writel ( 0 , base + arm_sp804_timer . ctrl ) ; if ( init_count == 2 || ! of_device_is_available ( np ) ) { err } sp804_clkevt_init ( & arm_sp804_timer , base ) ; if ( ! init_count ) { ret = sp804_clocksource_and_sched_clock_init ( base , name , clk , 0 ) ; if ( ret ) { err } } else { irq = irq_of_parse_and_map ( np , 0 ) ; if ( irq <= 0 ) { err } ret = sp804_clockevents_init ( base , irq , clk , name ) ; if ( ret ) { err } } init_count ++ ; return 0 ; err iounmap ( base ) ; return ret ; } 