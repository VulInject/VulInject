static irqreturn_t arizona_hpdet_irq ( int irq , void * data ) { struct arizona_priv * info = data ; struct arizona * arizona = info -> arizona ; int id_gpio = arizona -> pdata . hpdet_id_gpio ; int ret , reading , state , report ; bool mic = false ; mutex_lock ( & info -> lock ) ; if ( ! info -> hpdet_active ) { dev_warn ( arizona -> dev , "Spurious HPDET IRQ\n" ) ; return IRQ_NONE ; } state = info -> jack -> status & SND_JACK_MECHANICAL ; if ( ! state ) { dev_dbg ( arizona -> dev , "Ignoring HPDET for removed cable\n" ) ; done } ret = arizona_hpdet_read ( info ) ; if ( ret == - EAGAIN ) { out } if ( ret < 0 ) { done } reading = ret ; regmap_update_bits ( arizona -> regmap , ARIZONA_HEADPHONE_DETECT_1 , ARIZONA_HP_IMPEDANCE_RANGE_MASK | ARIZONA_HP_POLL , 0 ) ; ret = arizona_hpdet_do_id ( info , & reading , & mic ) ; if ( ret == - EAGAIN ) { out } if ( ret < 0 ) { done } if ( reading >= 5000 ) { report = SND_JACK_LINEOUT ; } else { report = SND_JACK_HEADPHONE ; } snd_soc_jack_report ( info -> jack , report , SND_JACK_LINEOUT | SND_JACK_HEADPHONE ) ; done regmap_update_bits ( arizona -> regmap , ARIZONA_HEADPHONE_DETECT_1 , ARIZONA_HP_IMPEDANCE_RANGE_MASK | ARIZONA_HP_POLL , 0 ) ; arizona_extcon_hp_clamp ( info , false ) ; if ( id_gpio ) { gpio_set_value_cansleep ( id_gpio , 0 ) ; } if ( state && ( mic || info -> mic ) ) { arizona_start_mic ( info ) ; } if ( info -> hpdet_active ) { pm_runtime_put_autosuspend ( arizona -> dev ) ; info -> hpdet_active = false ; } if ( state ) { info -> hpdet_done = true ; } out mutex_unlock ( & info -> lock ) ; return IRQ_HANDLED ; } 