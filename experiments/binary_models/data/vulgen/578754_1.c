static void zfs_ereport_start ( nvlist_t * * ereport_out , nvlist_t * * detector_out , const char * subclass , spa_t * spa , vdev_t * vd , zbookmark_phys_t * zb , zio_t * zio , uint64_t stateoroffset , uint64_t size ) { nvlist_t * ereport , * detector ; uint64_t ena ; char class ; if ( spa_load_state ( spa ) != SPA_LOAD_NONE && spa -> spa_last_open_failed ) { return ; } if ( zio != NULL ) { if ( zio -> io_type != ZIO_TYPE_READ && zio -> io_type != ZIO_TYPE_WRITE ) { return ; } if ( vd != NULL ) { if ( zio -> io_vd == vd && ! vdev_accessible ( vd , zio ) ) { return ; } if ( zio -> io_type == ZIO_TYPE_READ && zio -> io_error == ECKSUM && vd -> vdev_ops -> vdev_op_leaf && vdev_dtl_contains ( vd , DTL_MISSING , zio -> io_txg , 1 ) ) { return ; } } } if ( vd != NULL && strcmp ( subclass , FM_EREPORT_ZFS_PROBE_FAILURE ) == 0 && ( vd -> vdev_remove_wanted || vd -> vdev_state == VDEV_STATE_REMOVED ) ) { return ; } if ( ( strcmp ( subclass , FM_EREPORT_ZFS_DELAY ) == 0 ) && ( zio != NULL ) && ( ! zio -> io_timestamp ) ) { return ; } if ( ( ereport = fm_nvlist_create ( NULL ) ) == NULL ) { return ; } if ( ( detector = fm_nvlist_create ( NULL ) ) == NULL ) { fm_nvlist_destroy ( ereport , FM_NVA_FREE ) ; return ; } mutex_enter ( & spa -> spa_errlist_lock ) ; if ( spa_load_state ( spa ) != SPA_LOAD_NONE ) { if ( spa -> spa_ena == 0 ) { spa -> spa_ena = fm_ena_generate ( 0 , FM_ENA_FMT1 ) ; } ena = spa -> spa_ena ; } if ( zio != NULL && zio -> io_logical != NULL ) { if ( zio -> io_logical -> io_ena == 0 ) { zio -> io_logical -> io_ena = fm_ena_generate ( 0 , FM_ENA_FMT1 ) ; } ena = zio -> io_logical -> io_ena ; } else { ena = fm_ena_generate ( 0 , FM_ENA_FMT1 ) ; } ( void ) snprintf ( class , sizeof ( class ) , "%s.%s" , ZFS_ERROR_CLASS , subclass ) ; fm_fmri_zfs_set ( detector , FM_ZFS_SCHEME_VERSION , spa_guid ( spa ) , vd != NULL ?vd -> vdev_guid : 0 ) ; fm_ereport_set ( ereport , FM_EREPORT_VERSION , class , ena , detector , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_POOL , DATA_TYPE_STRING , spa_name ( spa ) , FM_EREPORT_PAYLOAD_ZFS_POOL_GUID , DATA_TYPE_UINT64 , spa_guid ( spa ) , FM_EREPORT_PAYLOAD_ZFS_POOL_STATE , DATA_TYPE_UINT64 , ( uint64_t ) spa_state ( spa ) , FM_EREPORT_PAYLOAD_ZFS_POOL_CONTEXT , DATA_TYPE_INT32 , ( int32_t ) spa_load_state ( spa ) , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_POOL_FAILMODE , DATA_TYPE_STRING , spa_get_failmode ( spa ) == ZIO_FAILURE_MODE_WAIT ?FM_EREPORT_FAILMODE_WAIT : spa_get_failmode ( spa ) == ZIO_FAILURE_MODE_CONTINUE ?FM_EREPORT_FAILMODE_CONTINUE : FM_EREPORT_FAILMODE_PANIC , NULL ) ; if ( vd != NULL ) { vdev_t * pvd = vd -> vdev_parent ; vdev_queue_t * vq = & vd -> vdev_queue ; vdev_stat_t * vs = & vd -> vdev_stat ; vdev_t * spare_vd ; uint64_t * spare_guids ; char * * spare_paths ; int i , spare_count ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_GUID , DATA_TYPE_UINT64 , vd -> vdev_guid , FM_EREPORT_PAYLOAD_ZFS_VDEV_TYPE , DATA_TYPE_STRING , vd -> vdev_ops -> vdev_op_type , NULL ) ; if ( vd -> vdev_path != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_PATH , DATA_TYPE_STRING , vd -> vdev_path , NULL ) ; } if ( vd -> vdev_devid != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_DEVID , DATA_TYPE_STRING , vd -> vdev_devid , NULL ) ; } if ( vd -> vdev_fru != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_FRU , DATA_TYPE_STRING , vd -> vdev_fru , NULL ) ; } if ( vd -> vdev_enc_sysfs_path != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_ENC_SYSFS_PATH , DATA_TYPE_STRING , vd -> vdev_enc_sysfs_path , NULL ) ; } if ( vd -> vdev_ashift ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_ASHIFT , DATA_TYPE_UINT64 , vd -> vdev_ashift , NULL ) ; } if ( vq != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_COMP_TS , DATA_TYPE_UINT64 , vq -> vq_io_complete_ts , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_DELTA_TS , DATA_TYPE_UINT64 , vq -> vq_io_delta_ts , NULL ) ; } if ( vs != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_READ_ERRORS , DATA_TYPE_UINT64 , vs -> vs_read_errors , FM_EREPORT_PAYLOAD_ZFS_VDEV_WRITE_ERRORS , DATA_TYPE_UINT64 , vs -> vs_write_errors , FM_EREPORT_PAYLOAD_ZFS_VDEV_CKSUM_ERRORS , DATA_TYPE_UINT64 , vs -> vs_checksum_errors , NULL ) ; } if ( pvd != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_PARENT_GUID , DATA_TYPE_UINT64 , pvd -> vdev_guid , FM_EREPORT_PAYLOAD_ZFS_PARENT_TYPE , DATA_TYPE_STRING , pvd -> vdev_ops -> vdev_op_type , NULL ) ; if ( pvd -> vdev_path ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_PARENT_PATH , DATA_TYPE_STRING , pvd -> vdev_path , NULL ) ; } if ( pvd -> vdev_devid ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_PARENT_DEVID , DATA_TYPE_STRING , pvd -> vdev_devid , NULL ) ; } } spare_count = spa -> spa_spares . sav_count ; spare_paths = kmem_zalloc ( sizeof ( char * ) * spare_count , KM_SLEEP ) ; spare_guids = kmem_zalloc ( sizeof ( uint64_t ) * spare_count , KM_SLEEP ) ; for ( i = 0 ; i < spare_count ; i ++ ) { spare_vd = spa -> spa_spares . sav_vdevs [ i ] ; if ( spare_vd ) { spare_paths [ i ] = spare_vd -> vdev_path ; spare_guids [ i ] = spare_vd -> vdev_guid ; } } fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_VDEV_SPARE_PATHS , DATA_TYPE_STRING_ARRAY , spare_count , spare_paths , FM_EREPORT_PAYLOAD_ZFS_VDEV_SPARE_GUIDS , DATA_TYPE_UINT64_ARRAY , spare_count , spare_guids , NULL ) ; kmem_free ( spare_guids , sizeof ( uint64_t ) * spare_count ) ; kmem_free ( spare_paths , sizeof ( char * ) * spare_count ) ; } if ( zio != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_ERR , DATA_TYPE_INT32 , zio -> io_error , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_FLAGS , DATA_TYPE_INT32 , zio -> io_flags , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_STAGE , DATA_TYPE_UINT32 , zio -> io_stage , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_PIPELINE , DATA_TYPE_UINT32 , zio -> io_pipeline , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_DELAY , DATA_TYPE_UINT64 , zio -> io_delay , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_TIMESTAMP , DATA_TYPE_UINT64 , zio -> io_timestamp , NULL ) ; fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_DELTA , DATA_TYPE_UINT64 , zio -> io_delta , NULL ) ; if ( vd != NULL ) { if ( size ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_OFFSET , DATA_TYPE_UINT64 , stateoroffset , FM_EREPORT_PAYLOAD_ZFS_ZIO_SIZE , DATA_TYPE_UINT64 , size , NULL ) ; } else { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_OFFSET , DATA_TYPE_UINT64 , zio -> io_offset , FM_EREPORT_PAYLOAD_ZFS_ZIO_SIZE , DATA_TYPE_UINT64 , zio -> io_size , NULL ) ; } } } if ( vd != NULL ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_PREV_STATE , DATA_TYPE_UINT64 , stateoroffset , NULL ) ; } if ( zb != NULL && ( zio == NULL || zio -> io_logical != NULL ) ) { fm_payload_set ( ereport , FM_EREPORT_PAYLOAD_ZFS_ZIO_OBJSET , DATA_TYPE_UINT64 , zb -> zb_objset , FM_EREPORT_PAYLOAD_ZFS_ZIO_OBJECT , DATA_TYPE_UINT64 , zb -> zb_object , FM_EREPORT_PAYLOAD_ZFS_ZIO_LEVEL , DATA_TYPE_INT64 , zb -> zb_level , FM_EREPORT_PAYLOAD_ZFS_ZIO_BLKID , DATA_TYPE_UINT64 , zb -> zb_blkid , NULL ) ; } mutex_exit ( & spa -> spa_errlist_lock ) ; * ereport_out = ereport ; * detector_out = detector ; } zfs_ecksum_info { uint16_t zei_histogram_set [ sizeof ( uint64_t ) * NBBY ] ; uint16_t zei_histogram_cleared [ sizeof ( uint64_t ) * NBBY ] ; uint64_t zei_bits_set [ ZFM_MAX_INLINE ] ; uint64_t zei_bits_cleared [ ZFM_MAX_INLINE ] ; uint32_t zei_range_sets [ MAX_RANGES ] ; uint32_t zei_range_clears [ MAX_RANGES ] ; zei_ranges { uint32_t zr_start ; uint32_t zr_end ; } , zei_ranges [ MAX_RANGES ] size_t zei_range_count ; uint32_t zei_mingap ; uint32_t zei_allowed_mingap ; } zfs_ecksum_info_t 