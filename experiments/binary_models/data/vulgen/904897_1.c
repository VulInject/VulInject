gimp_vectors_import ( , , , , , , , , , ) { GimpXmlParser * xml_parser ; SvgParser parser ; GList * paths ; SvgHandler * base ; gboolean success = TRUE ; parser . stack = g_queue_new ( ) ; parser . image = image ; parser . scale = scale ; parser . svg_depth = 0 ; base = g_slice_new0 ( SvgHandler ) ; base -> name = "image" ; base -> width = gimp_image_get_width ( image ) ; base -> height = gimp_image_get_height ( image ) ; g_queue_push_head ( parser . stack , base ) ; xml_parser = gimp_xml_parser_new ( & markup_parser , & parser ) ; if ( file ) { success = gimp_xml_parser_parse_gfile ( xml_parser , file , error ) ; } else { success = gimp_xml_parser_parse_buffer ( xml_parser , str , len , error ) ; } gimp_xml_parser_free ( xml_parser ) ; if ( success ) { if ( base -> paths ) { GimpVectors * vectors = NULL ; base -> paths = g_list_reverse ( base -> paths ) ; merge = merge && base -> paths -> next ; gimp_image_undo_group_start ( image , GIMP_UNDO_GROUP_VECTORS_IMPORT , _ ( "Import Paths" ) ) ; for ( paths = base -> paths ; paths ; paths = paths -> next ) { SvgPath * path = paths -> data ; GList * list ; if ( ! merge || ! vectors ) { vectors = gimp_vectors_new ( image , ( ( merge || ! path -> id ) ?_ ( "Imported Path" ) : path -> id ) ) ; gimp_image_add_vectors ( image , vectors , parent , position , TRUE ) ; gimp_vectors_freeze ( vectors ) ; if ( position != - 1 ) { position ++ ; } } for ( list = path -> strokes ; list ; list = list -> next ) { gimp_vectors_stroke_add ( vectors , GIMP_STROKE ( list -> data ) ) ; } if ( ! merge ) { gimp_vectors_thaw ( vectors ) ; } g_list_free_full ( path -> strokes , g_object_unref ) ; path -> strokes = NULL ; } if ( merge ) { gimp_vectors_thaw ( vectors ) ; } gimp_image_undo_group_end ( image ) ; } else { if ( file ) { g_set_error ( error , GIMP_ERROR , GIMP_FAILED , _ ( "No paths found in '%s'" ) , gimp_file_get_utf8_name ( file ) ) ; } else { g_set_error_literal ( error , GIMP_ERROR , GIMP_FAILED , _ ( "No paths found in the buffer" ) ) ; } success = FALSE ; } } if ( error && * error && file ) { gchar * msg = ( * error ) -> message ; ( * error ) -> message = g_strdup_printf ( _ ( "Failed to import paths from '%s': %s" ) , gimp_file_get_utf8_name ( file ) , msg ) ; g_free ( msg ) ; } while ( ( base = g_queue_pop_head ( parser . stack ) ) != NULL ) { for ( paths = base -> paths ; paths ; paths = paths -> next ) { SvgPath * path = paths -> data ; GList * list ; g_free ( path -> id ) ; for ( list = path -> strokes ; list ; list = list -> next ) { g_object_unref ( list -> data ) ; } g_list_free ( path -> strokes ) ; g_slice_free ( SvgPath , path ) ; } g_list_free ( base -> paths ) ; g_slice_free ( GimpMatrix3 , base -> transform ) ; g_slice_free ( SvgHandler , base ) ; } g_queue_free ( parser . stack ) ; return success ; } 