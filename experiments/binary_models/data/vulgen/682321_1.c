static char * remote_hostname ( struct ssh * ssh ) { struct sockaddr_storage from ; socklen_t fromlen ; struct addrinfo hints , * ai , * aitop ; char name [ NI_MAXHOST ] , ntop2 [ NI_MAXHOST ] ; const char * ntop = ssh_remote_ipaddr ( ssh ) ; fromlen = sizeof ( from ) ; memset ( & from , 0 , sizeof ( from ) ) ; if ( getpeername ( ssh_packet_get_connection_in ( ssh ) , ( sockaddr * ) & from , & fromlen ) == - 1 ) { debug ( "getpeername failed: %.100s" , strerror ( errno ) ) ; return xstrdup ( ntop ) ; } debug3 ( "Trying to reverse map address %.100s." , ntop ) ; if ( getnameinfo ( ( sockaddr * ) & from , fromlen , name , sizeof ( name ) , NULL , 0 , NI_NAMEREQD ) != 0 ) { return xstrdup ( ntop ) ; } memset ( & hints , 0 , sizeof ( hints ) ) ; hints . ai_socktype = SOCK_DGRAM ; hints . ai_flags = AI_NUMERICHOST ; if ( getaddrinfo ( name , NULL , & hints , & ai ) == 0 ) { logit ( "Nasty PTR record \"%s\" is set up for %s, ignoring" , name , ntop ) ; freeaddrinfo ( ai ) ; return xstrdup ( ntop ) ; } memset ( & hints , 0 , sizeof ( hints ) ) ; hints . ai_family = from . ss_family ; hints . ai_socktype = SOCK_STREAM ; if ( getaddrinfo ( name , NULL , & hints , & aitop ) != 0 ) { logit ( "reverse mapping checking getaddrinfo for %.700s " "[%s] failed." , name , ntop ) ; return xstrdup ( ntop ) ; } for ( ai = aitop ; ai ; ai = ai -> ai_next ) { if ( getnameinfo ( ai -> ai_addr , ai -> ai_addrlen , ntop2 , sizeof ( ntop2 ) , NULL , 0 , NI_NUMERICHOST ) == 0 && ( strcmp ( ntop , ntop2 ) == 0 ) ) { break ; } } freeaddrinfo ( aitop ) ; if ( ai == NULL ) { logit ( "Address %.100s maps to %.600s, but this does not " "map back to the address." , ntop , name ) ; return xstrdup ( ntop ) ; } return xstrdup ( name ) ; } 