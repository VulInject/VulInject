int parse_rr ( unsigned char * pnt , int len , int cont_flag ) { int slen ; int ncount ; int extent ; int cont_extent , cont_offset , cont_size ; int flag1 , flag2 ; unsigned char * pnts ; char symlink [ 1024 ] ; int goof ; symlink [ 0 ] = 0 ; cont_extent = cont_offset = cont_size = 0 ; ncount = 0 ; flag1 = flag2 = 0 ; while ( len >= 4 ) { if ( pnt [ 3 ] != 1 ) { printf ( "**BAD RRVERSION" ) ; return ; } ncount ++ ; if ( pnt [ 0 ] == 'R' && pnt [ 1 ] == 'R' ) { flag1 = pnt [ 4 ] & 0xff ; } if ( strncmp ( pnt , "PX" , 2 ) == 0 ) { flag2 |= 1 ; } if ( strncmp ( pnt , "PN" , 2 ) == 0 ) { flag2 |= 2 ; } if ( strncmp ( pnt , "SL" , 2 ) == 0 ) { flag2 |= 4 ; } if ( strncmp ( pnt , "NM" , 2 ) == 0 ) { flag2 |= 8 ; } if ( strncmp ( pnt , "CL" , 2 ) == 0 ) { flag2 |= 16 ; } if ( strncmp ( pnt , "PL" , 2 ) == 0 ) { flag2 |= 32 ; } if ( strncmp ( pnt , "RE" , 2 ) == 0 ) { flag2 |= 64 ; } if ( strncmp ( pnt , "TF" , 2 ) == 0 ) { flag2 |= 128 ; } if ( strncmp ( pnt , "PX" , 2 ) == 0 ) { fstat_buf . st_mode = isonum_733 ( pnt + 4 ) ; fstat_buf . st_nlink = isonum_733 ( pnt + 12 ) ; fstat_buf . st_uid = isonum_733 ( pnt + 20 ) ; fstat_buf . st_gid = isonum_733 ( pnt + 28 ) ; } if ( strncmp ( pnt , "NM" , 2 ) == 0 ) { strncpy ( name_buf , pnt + 5 , pnt [ 2 ] - 5 ) ; name_buf [ pnt [ 2 ] - 5 ] = 0 ; } if ( strncmp ( pnt , "CE" , 2 ) == 0 ) { cont_extent = isonum_733 ( pnt + 4 ) ; cont_offset = isonum_733 ( pnt + 12 ) ; cont_size = isonum_733 ( pnt + 20 ) ; } if ( strncmp ( pnt , "PL" , 2 ) == 0 || strncmp ( pnt , "CL" , 2 ) == 0 ) { extent = isonum_733 ( pnt + 4 ) ; } if ( strncmp ( pnt , "SL" , 2 ) == 0 ) { int cflag ; cflag = pnt [ 4 ] ; pnts = pnt + 5 ; slen = pnt [ 2 ] - 5 ; while ( slen >= 1 ) { switch ( pnts [ 0 ] & 0xfe ) { case 0 : strncat ( symlink , pnts + 2 , pnts [ 1 ] ) ; break ; case 2 : strcat ( symlink , "." ) ; break ; case 4 : strcat ( symlink , ".." ) ; break ; case 8 : if ( ( pnts [ 0 ] & 1 ) == 0 ) { strcat ( symlink , "/" ) ; } break ; case 16 : strcat ( symlink , "/mnt" ) ; printf ( "Warning - mount point requested" ) ; break ; case 32 : strcat ( symlink , "kafka" ) ; printf ( "Warning - host_name requested" ) ; break ; default : printf ( "Reserved bit setting in symlink" , goof ++ ) ; break ; } if ( ( pnts [ 0 ] & 0xfe ) && pnts [ 1 ] != 0 ) { printf ( "Incorrect length in symlink component" ) ; } if ( ( pnts [ 0 ] & 1 ) == 0 ) { strcat ( symlink , "/" ) ; } slen -= ( pnts [ 1 ] + 2 ) ; pnts += ( pnts [ 1 ] + 2 ) ; strcat ( xname , symlink ) ; } symlink [ 0 ] = 0 ; } len -= pnt [ 2 ] ; pnt += pnt [ 2 ] ; if ( len <= 3 && cont_extent ) { unsigned char sector [ 2048 ] ; lseek ( fileno ( infile ) , ( cont_extent - sector_offset ) << 11 , 0 ) ; read ( fileno ( infile ) , sector , sizeof ( sector ) ) ; flag2 |= parse_rr ( & sector [ cont_offset ] , cont_size , 1 ) ; } } return flag2 ; } 