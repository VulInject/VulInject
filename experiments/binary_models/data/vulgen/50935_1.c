void __iounmap ( void * addr , unsigned long size ) { unsigned long virtaddr = ( unsigned long ) addr ; pgd_t * pgd_dir ; pmd_t * pmd_dir ; pte_t * pte_dir ; while ( ( long ) size > 0 ) { pgd_dir = pgd_offset_k ( virtaddr ) ; if ( pgd_bad ( * pgd_dir ) ) { printk ( "iounmap: bad pgd(%08lx)\n" , pgd_val ( * pgd_dir ) ) ; pgd_clear ( pgd_dir ) ; return ; } pmd_dir = pmd_offset ( pgd_dir , virtaddr ) ; if ( CPU_IS_020_OR_030 ) { int pmd_off = ( virtaddr / PTRTREESIZE ) & 15 ; int pmd_type = pmd_dir -> pmd [ pmd_off ] & _DESCTYPE_MASK ; if ( pmd_type == _PAGE_PRESENT ) { pmd_dir -> pmd [ pmd_off ] = 0 ; virtaddr += PTRTREESIZE ; size -= PTRTREESIZE ; continue ; } if ( pmd_type == 0 ) { continue ; } } if ( pmd_bad ( * pmd_dir ) ) { printk ( "iounmap: bad pmd (%08lx)\n" , pmd_val ( * pmd_dir ) ) ; return ; } pte_dir = pte_offset_kernel ( pmd_dir , virtaddr ) ; pte_val ( * pte_dir ) = 0 ; virtaddr += PAGE_SIZE ; size -= PAGE_SIZE ; } flush_tlb_all ( ) ; } 