static void prepare_auth_info_file ( struct passwd * pw , struct sshbuf * info ) { int fd = - 1 , success = 0 ; if ( ! options . expose_userauth_info || info == NULL ) { return ; } temporarily_use_uid ( pw ) ; if ( ( fd = mkstemp ( auth_info_file ) ) == - 1 ) { error_f ( "mkstemp: %s" , strerror ( errno ) ) ; out } if ( atomicio ( vwrite , fd , sshbuf_mutable_ptr ( info ) , sshbuf_len ( info ) ) != sshbuf_len ( info ) ) { error_f ( "write: %s" , strerror ( errno ) ) ; out } if ( close ( fd ) != 0 ) { error_f ( "close: %s" , strerror ( errno ) ) ; out } success = 1 ; out if ( ! success ) { if ( fd != - 1 ) { close ( fd ) ; } free ( auth_info_file ) ; auth_info_file = NULL ; } restore_uid ( ) ; } 