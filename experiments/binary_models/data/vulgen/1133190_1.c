TEST ( ) { _cleanup_ ( ) sd_bus_error error = SD_BUS_ERROR_NULL , second = SD_BUS_ERROR_NULL ; const sd_bus_error const_error = SD_BUS_ERROR_MAKE_CONST ( SD_BUS_ERROR_FILE_EXISTS , "const error" ) ; const sd_bus_error temporarily_const_error = { . name = SD_BUS_ERROR_ACCESS_DENIED . message = "oh! no" . _need_free = - 1 } ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; assert_se ( sd_bus_error_set ( & error , SD_BUS_ERROR_NOT_SUPPORTED , "xxx" ) == - EOPNOTSUPP ) ; assert_se ( streq ( error . name , SD_BUS_ERROR_NOT_SUPPORTED ) ) ; assert_se ( streq ( error . message , "xxx" ) ) ; assert_se ( sd_bus_error_has_name ( & error , SD_BUS_ERROR_NOT_SUPPORTED ) ) ; assert_se ( sd_bus_error_has_names_sentinel ( & error , SD_BUS_ERROR_NOT_SUPPORTED , NULL ) ) ; assert_se ( sd_bus_error_has_names ( & error , SD_BUS_ERROR_NOT_SUPPORTED ) ) ; assert_se ( sd_bus_error_has_names ( & error , SD_BUS_ERROR_NOT_SUPPORTED , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( sd_bus_error_has_names ( & error , SD_BUS_ERROR_FILE_NOT_FOUND , SD_BUS_ERROR_NOT_SUPPORTED , NULL ) ) ; assert_se ( ! sd_bus_error_has_names ( & error , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( sd_bus_error_get_errno ( & error ) == EOPNOTSUPP ) ; assert_se ( sd_bus_error_is_set ( & error ) ) ; sd_bus_error_free ( & error ) ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; assert_se ( sd_bus_error_setf ( & error , NULL , "yyy %i" , - 1 ) == 0 ) ; assert_se ( error . name == NULL ) ; assert_se ( error . message == NULL ) ; assert_se ( ! sd_bus_error_has_name ( & error , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( ! sd_bus_error_has_names ( & error , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( sd_bus_error_get_errno ( & error ) == 0 ) ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; assert_se ( sd_bus_error_setf ( & error , SD_BUS_ERROR_FILE_NOT_FOUND , "yyy %i" , - 1 ) == - ENOENT ) ; assert_se ( streq ( error . name , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( streq ( error . message , "yyy -1" ) ) ; assert_se ( sd_bus_error_has_name ( & error , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( sd_bus_error_has_names ( & error , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( sd_bus_error_get_errno ( & error ) == ENOENT ) ; assert_se ( sd_bus_error_is_set ( & error ) ) ; assert_se ( ! sd_bus_error_is_set ( & second ) ) ; assert_se ( second . _need_free == 0 ) ; assert_se ( error . _need_free > 0 ) ; assert_se ( sd_bus_error_copy ( & second , & error ) == - ENOENT ) ; assert_se ( second . _need_free > 0 ) ; assert_se ( streq ( error . name , second . name ) ) ; assert_se ( streq ( error . message , second . message ) ) ; assert_se ( sd_bus_error_get_errno ( & second ) == ENOENT ) ; assert_se ( sd_bus_error_has_name ( & second , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( sd_bus_error_has_names ( & second , SD_BUS_ERROR_FILE_NOT_FOUND ) ) ; assert_se ( sd_bus_error_is_set ( & second ) ) ; sd_bus_error_free ( & error ) ; sd_bus_error_free ( & second ) ; assert_se ( ! sd_bus_error_is_set ( & second ) ) ; assert_se ( const_error . _need_free == 0 ) ; assert_se ( sd_bus_error_copy ( & second , & const_error ) == - EEXIST ) ; assert_se ( second . _need_free == 0 ) ; assert_se ( streq ( const_error . name , second . name ) ) ; assert_se ( streq ( const_error . message , second . message ) ) ; assert_se ( sd_bus_error_get_errno ( & second ) == EEXIST ) ; assert_se ( sd_bus_error_has_name ( & second , SD_BUS_ERROR_FILE_EXISTS ) ) ; assert_se ( sd_bus_error_is_set ( & second ) ) ; sd_bus_error_free ( & second ) ; assert_se ( ! sd_bus_error_is_set ( & second ) ) ; assert_se ( temporarily_const_error . _need_free < 0 ) ; assert_se ( sd_bus_error_copy ( & second , & temporarily_const_error ) == - EACCES ) ; assert_se ( second . _need_free > 0 ) ; assert_se ( streq ( temporarily_const_error . name , second . name ) ) ; assert_se ( streq ( temporarily_const_error . message , second . message ) ) ; assert_se ( sd_bus_error_get_errno ( & second ) == EACCES ) ; assert_se ( sd_bus_error_has_name ( & second , SD_BUS_ERROR_ACCESS_DENIED ) ) ; assert_se ( sd_bus_error_is_set ( & second ) ) ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; assert_se ( sd_bus_error_set_const ( & error , "System.Error.EUCLEAN" , "Hallo" ) == - EUCLEAN ) ; assert_se ( streq ( error . name , "System.Error.EUCLEAN" ) ) ; assert_se ( streq ( error . message , "Hallo" ) ) ; assert_se ( sd_bus_error_has_name ( & error , "System.Error.EUCLEAN" ) ) ; assert_se ( sd_bus_error_get_errno ( & error ) == EUCLEAN ) ; assert_se ( sd_bus_error_is_set ( & error ) ) ; sd_bus_error_free ( & error ) ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; assert_se ( sd_bus_error_set_errno ( & error , EBUSY ) == - EBUSY ) ; assert_se ( streq ( error . name , "System.Error.EBUSY" ) ) ; assert_se ( streq ( error . message , STRERROR ( EBUSY ) ) ) ; assert_se ( sd_bus_error_has_name ( & error , "System.Error.EBUSY" ) ) ; assert_se ( sd_bus_error_get_errno ( & error ) == EBUSY ) ; assert_se ( sd_bus_error_is_set ( & error ) ) ; sd_bus_error_free ( & error ) ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; assert_se ( sd_bus_error_set_errnof ( & error , EIO , "Waldi %c" , 'X' ) == - EIO ) ; assert_se ( streq ( error . name , SD_BUS_ERROR_IO_ERROR ) ) ; assert_se ( streq ( error . message , "Waldi X" ) ) ; assert_se ( sd_bus_error_has_name ( & error , SD_BUS_ERROR_IO_ERROR ) ) ; assert_se ( sd_bus_error_get_errno ( & error ) == EIO ) ; assert_se ( sd_bus_error_is_set ( & error ) ) ; sd_bus_error_free ( & error ) ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; assert_se ( sd_bus_error_set_errnof ( & error , 0 , "Waldi %c" , 'X' ) == 0 ) ; assert_se ( error . name == NULL ) ; assert_se ( error . message == NULL ) ; assert_se ( ! sd_bus_error_has_name ( & error , SD_BUS_ERROR_IO_ERROR ) ) ; assert_se ( sd_bus_error_get_errno ( & error ) == 0 ) ; assert_se ( ! sd_bus_error_is_set ( & error ) ) ; } extern const sd_bus_error_map __start_SYSTEMD_BUS_ERROR_MAP [ ] ; extern const sd_bus_error_map __stop_SYSTEMD_BUS_ERROR_MAP [ ] ; static int dump_mapping_table ( void ) { const sd_bus_error_map * m ; printf ( "----- errno mappings ------\n" ) ; m = ALIGN_PTR ( __start_SYSTEMD_BUS_ERROR_MAP ) ; while ( m < __stop_SYSTEMD_BUS_ERROR_MAP ) { printf ( "%s ->%i/%s\n" , strna ( m -> name ) , m -> code , strna ( errno_to_name ( m -> code ) ) ) ; m ++ ; } printf ( "---------------------------\n" ) ; return EXIT_SUCCESS ; } 