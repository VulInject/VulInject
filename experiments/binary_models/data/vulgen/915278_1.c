static int cx23885_dev_setup ( struct cx23885_dev * dev ) { int i ; spin_lock_init ( & dev -> pci_irqmask_lock ) ; spin_lock_init ( & dev -> slock ) ; mutex_init ( & dev -> lock ) ; atomic_inc ( & dev -> refcount ) ; dev -> nr = cx23885_devcount ++ ; sprintf ( dev -> name , "cx23885[%d]" , dev -> nr ) ; if ( dev -> pci -> device == 0x8880 ) { dev -> bridge = CX23885_BRIDGE_887 ; dev -> clk_freq = 25000000 ; dev -> sram_channels = cx23887_sram_channels ; } if ( dev -> pci -> device == 0x8852 ) { dev -> bridge = CX23885_BRIDGE_885 ; dev -> clk_freq = 28000000 ; dev -> sram_channels = cx23885_sram_channels ; } else { BUG ( ) ; } dprintk ( 1 , "%s() Memory configured for PCIe bridge type %d\n" , __func__ , dev -> bridge ) ; dev -> board = UNSET ; if ( card [ dev -> nr ] < cx23885_bcount ) { dev -> board = card [ dev -> nr ] ; } for ( i = 0 ; UNSET == dev -> board && i < cx23885_idcount ; i ++ ) { if ( dev -> pci -> subsystem_vendor == cx23885_subids [ i ] . subvendor && dev -> pci -> subsystem_device == cx23885_subids [ i ] . subdevice ) { dev -> board = cx23885_subids [ i ] . card ; } } if ( UNSET == dev -> board ) { dev -> board = CX23885_BOARD_UNKNOWN ; cx23885_card_list ( dev ) ; } if ( cx23885_boards [ dev -> board ] . clk_freq > 0 ) { dev -> clk_freq = cx23885_boards [ dev -> board ] . clk_freq ; } dev -> pci_bus = dev -> pci -> bus -> number ; dev -> pci_slot = PCI_SLOT ( dev -> pci -> devfn ) ; cx23885_irq_add ( dev , 0x001f00 ) ; dev -> i2c_bus [ 0 ] . nr = 0 ; dev -> i2c_bus [ 0 ] . dev = dev ; dev -> i2c_bus [ 0 ] . reg_stat = I2C1_STAT ; dev -> i2c_bus [ 0 ] . reg_ctrl = I2C1_CTRL ; dev -> i2c_bus [ 0 ] . reg_addr = I2C1_ADDR ; dev -> i2c_bus [ 0 ] . reg_rdata = I2C1_RDATA ; dev -> i2c_bus [ 0 ] . reg_wdata = I2C1_WDATA ; dev -> i2c_bus [ 0 ] . i2c_period = ( 0x9d << 24 ) ; dev -> i2c_bus [ 1 ] . nr = 1 ; dev -> i2c_bus [ 1 ] . dev = dev ; dev -> i2c_bus [ 1 ] . reg_stat = I2C2_STAT ; dev -> i2c_bus [ 1 ] . reg_ctrl = I2C2_CTRL ; dev -> i2c_bus [ 1 ] . reg_addr = I2C2_ADDR ; dev -> i2c_bus [ 1 ] . reg_rdata = I2C2_RDATA ; dev -> i2c_bus [ 1 ] . reg_wdata = I2C2_WDATA ; dev -> i2c_bus [ 1 ] . i2c_period = ( 0x9d << 24 ) ; dev -> i2c_bus [ 2 ] . nr = 2 ; dev -> i2c_bus [ 2 ] . dev = dev ; dev -> i2c_bus [ 2 ] . reg_stat = I2C3_STAT ; dev -> i2c_bus [ 2 ] . reg_ctrl = I2C3_CTRL ; dev -> i2c_bus [ 2 ] . reg_addr = I2C3_ADDR ; dev -> i2c_bus [ 2 ] . reg_rdata = I2C3_RDATA ; dev -> i2c_bus [ 2 ] . reg_wdata = I2C3_WDATA ; dev -> i2c_bus [ 2 ] . i2c_period = ( 0x07 << 24 ) ; if ( ( cx23885_boards [ dev -> board ] . portb == CX23885_MPEG_DVB ) || ( cx23885_boards [ dev -> board ] . portb == CX23885_MPEG_ENCODER ) ) { cx23885_init_tsport ( dev , & dev -> ts1 , 1 ) ; } if ( ( cx23885_boards [ dev -> board ] . portc == CX23885_MPEG_DVB ) || ( cx23885_boards [ dev -> board ] . portc == CX23885_MPEG_ENCODER ) ) { cx23885_init_tsport ( dev , & dev -> ts2 , 2 ) ; } if ( get_resources ( dev ) < 0 ) { pr_err ( "CORE %s No more PCIe resources for subsystem: %04x:%04x\n" , dev -> name , dev -> pci -> subsystem_vendor , dev -> pci -> subsystem_device ) ; cx23885_devcount -- ; return - ENODEV ; } dev -> lmmio = ioremap ( pci_resource_start ( dev -> pci , 0 ) , pci_resource_len ( dev -> pci , 0 ) ) ; dev -> bmmio = ( u8 __iomem * ) dev -> lmmio ; pr_info ( "CORE %s: subsystem: %04x:%04x, board: %s [card=%d,%s]\n" , dev -> name , dev -> pci -> subsystem_vendor , dev -> pci -> subsystem_device , cx23885_boards [ dev -> board ] . name , dev -> board , card [ dev -> nr ] == dev -> board ?"insmod option" : "autodetected" ) ; cx23885_pci_quirks ( dev ) ; dev -> tuner_type = cx23885_boards [ dev -> board ] . tuner_type ; dev -> tuner_addr = cx23885_boards [ dev -> board ] . tuner_addr ; dev -> tuner_bus = cx23885_boards [ dev -> board ] . tuner_bus ; dev -> radio_type = cx23885_boards [ dev -> board ] . radio_type ; dev -> radio_addr = cx23885_boards [ dev -> board ] . radio_addr ; dprintk ( 1 , "%s() tuner_type = 0x%x tuner_addr = 0x%x tuner_bus = %d\n" , __func__ , dev -> tuner_type , dev -> tuner_addr , dev -> tuner_bus ) ; dprintk ( 1 , "%s() radio_type = 0x%x radio_addr = 0x%x\n" , __func__ , dev -> radio_type , dev -> radio_addr ) ; if ( ( cx23885_boards [ dev -> board ] . portb == CX23885_MPEG_ENCODER ) || ( cx23885_boards [ dev -> board ] . portc == CX23885_MPEG_ENCODER ) ) { cx23885_mc417_init ( dev ) ; } cx23885_reset ( dev ) ; cx23885_i2c_register ( & dev -> i2c_bus [ 0 ] ) ; cx23885_i2c_register ( & dev -> i2c_bus [ 1 ] ) ; cx23885_i2c_register ( & dev -> i2c_bus [ 2 ] ) ; cx23885_card_setup ( dev ) ; call_all ( dev , core , s_power , 0 ) ; cx23885_ir_init ( dev ) ; if ( dev -> board == CX23885_BOARD_VIEWCAST_460E ) { cx23885_gpio_enable ( dev , 0x300 , 0 ) ; } if ( cx23885_boards [ dev -> board ] . porta == CX23885_ANALOG_VIDEO ) { if ( cx23885_video_register ( dev ) < 0 ) { pr_err ( "%s() Failed to register analog video adapters on VID_A\n" , __func__ ) ; } } if ( cx23885_boards [ dev -> board ] . portb == CX23885_MPEG_DVB ) { if ( cx23885_boards [ dev -> board ] . num_fds_portb ) { dev -> ts1 . num_frontends = cx23885_boards [ dev -> board ] . num_fds_portb ; } if ( cx23885_dvb_register ( & dev -> ts1 ) < 0 ) { pr_err ( "%s() Failed to register dvb adapters on VID_B\n" , __func__ ) ; } } if ( cx23885_boards [ dev -> board ] . portb == CX23885_MPEG_ENCODER ) { if ( cx23885_417_register ( dev ) < 0 ) { pr_err ( "%s() Failed to register 417 on VID_B\n" , __func__ ) ; } } if ( cx23885_boards [ dev -> board ] . portc == CX23885_MPEG_DVB ) { if ( cx23885_boards [ dev -> board ] . num_fds_portc ) { dev -> ts2 . num_frontends = cx23885_boards [ dev -> board ] . num_fds_portc ; } if ( cx23885_dvb_register ( & dev -> ts2 ) < 0 ) { pr_err ( "%s() Failed to register dvb on VID_C\n" , __func__ ) ; } } if ( cx23885_boards [ dev -> board ] . portc == CX23885_MPEG_ENCODER ) { if ( cx23885_417_register ( dev ) < 0 ) { pr_err ( "%s() Failed to register 417 on VID_C\n" , __func__ ) ; } } cx23885_dev_checkrevision ( dev ) ; if ( cx23885_boards [ dev -> board ] . ci_type > 0 ) { cx_clear ( RDR_RDRCTL1 , 1 << 8 ) ; } switch ( dev -> board ) { case CX23885_BOARD_TEVII_S470 : case CX23885_BOARD_TEVII_S471 : cx_clear ( RDR_RDRCTL1 , 1 << 8 ) ; break ; } return 0 ; } 