static void twl_aen_sync_time ( TW_Device_Extension * tw_dev , int request_id ) { u32 schedulertime ; TW_Command_Full * full_command_packet ; TW_Command * command_packet ; TW_Param_Apache * param ; time64_t local_time ; full_command_packet = tw_dev -> command_packet_virt [ request_id ] ; memset ( full_command_packet , 0 , sizeof ( TW_Command_Full ) ) ; command_packet = & full_command_packet -> command . oldcommand ; command_packet -> opcode__sgloffset = TW_OPSGL_IN ( 2 , TW_OP_SET_PARAM ) ; command_packet -> request_id = request_id ; command_packet -> byte8_offset . param . sgl [ 0 ] . address = TW_CPU_TO_SGL ( tw_dev -> generic_buffer_phys [ request_id ] ) ; command_packet -> byte8_offset . param . sgl [ 0 ] . length = TW_CPU_TO_SGL ( TW_SECTOR_SIZE ) ; command_packet -> size = TW_COMMAND_SIZE ; command_packet -> byte6_offset . parameter_count = cpu_to_le16 ( 1 ) ; param = ( TW_Param_Apache * ) tw_dev -> generic_buffer_virt [ request_id ] ; memset ( param , 0 , TW_SECTOR_SIZE ) ; param -> table_id = cpu_to_le16 ( TW_TIMEKEEP_TABLE | 0x8000 ) ; param -> parameter_id = cpu_to_le16 ( 0x3 ) ; param -> parameter_size_bytes = cpu_to_le16 ( 4 ) ; local_time = ( ktime_get_real_seconds ( ) - ( sys_tz . tz_minuteswest * 60 ) ) ; div_u64_rem ( local_time - ( 3 * 86400 ) , 604800 , & schedulertime ) ; schedulertime = cpu_to_le32 ( schedulertime ) ; memcpy ( param -> data , & schedulertime , sizeof ( u32 ) ) ; tw_dev -> srb [ request_id ] = NULL ; } 