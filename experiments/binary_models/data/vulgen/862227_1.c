static int he_ioctl ( struct atm_dev * atm_dev , unsigned int cmd , void __user * arg ) { unsigned long flags ; struct he_dev * he_dev = HE_DEV ( atm_dev ) ; struct he_ioctl_reg reg ; int err = 0 ; switch ( cmd ) { case HE_GET_REG : if ( copy_from_user ( & reg , arg , sizeof ( he_ioctl_reg ) ) ) { return - EFAULT ; } spin_lock_irqsave ( & he_dev -> global_lock , flags ) ; switch ( reg . type ) { case HE_REGTYPE_PCI : if ( reg . addr >= HE_REGMAP_SIZE ) { err = - EINVAL ; break ; } reg . val = he_readl ( he_dev , reg . addr ) ; break ; case HE_REGTYPE_RCM : reg . val = he_readl_rcm ( he_dev , reg . addr ) ; break ; case HE_REGTYPE_TCM : reg . val = he_readl_tcm ( he_dev , reg . addr ) ; break ; case HE_REGTYPE_MBOX : reg . val = he_readl_mbox ( he_dev , reg . addr ) ; break ; default : err = - EINVAL ; break ; } spin_unlock_irqrestore ( & he_dev -> global_lock , flags ) ; if ( err == 0 ) { if ( copy_to_user ( arg , & reg , sizeof ( he_ioctl_reg ) ) ) { return - EFAULT ; } } break ; default : if ( atm_dev -> phy && atm_dev -> phy -> ioctl ) { err = atm_dev -> phy -> ioctl ( atm_dev , cmd , arg ) ; } err = - EINVAL ; break ; } return err ; } 