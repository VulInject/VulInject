static int __init msi_init ( void ) { int ret ; if ( acpi_disabled ) { return - ENODEV ; } dmi_check_system ( msi_dmi_table ) ; if ( ! quirks ) { quirks = & quirk_load_scm_model ; } if ( force ) { quirks = & quirk_old_ec_model ; } if ( auto_brightness ( 0 || auto_brightness ) 2 ) { return - EINVAL ; } if ( quirks -> old_ec_model && acpi_video_get_backlight_type ( ) == acpi_backlight_vendor ) { struct backlight_properties props ; memset ( & props , 0 , sizeof ( backlight_properties ) ) ; props . type = BACKLIGHT_PLATFORM ; props . max_brightness = MSI_LCD_LEVEL_MAX - 1 ; msibl_device = backlight_device_register ( "msi-laptop-bl" , NULL , NULL , & msibl_ops , & props ) ; if ( IS_ERR ( msibl_device ) ) { return PTR_ERR ( msibl_device ) ; } } ret = platform_driver_register ( & msipf_driver ) ; if ( ret ) { fail_backlight } msipf_device = platform_device_alloc ( "msi-laptop-pf" , PLATFORM_DEVID_NONE ) ; if ( ! msipf_device ) { ret = - ENOMEM ; fail_platform_driver } ret = platform_device_add ( msipf_device ) ; if ( ret ) { fail_device_add } if ( quirks -> load_scm_model && ( load_scm_model_init ( msipf_device ) < 0 ) ) { ret = - EINVAL ; fail_scm_model_init } ret = sysfs_create_group ( & msipf_device -> dev . kobj , & msipf_attribute_group ) ; if ( ret ) { fail_create_group } if ( ! quirks -> old_ec_model ) { if ( threeg_exists ) { ret = device_create_file ( & msipf_device -> dev , & dev_attr_threeg ) ; } if ( ret ) { fail_create_attr } } else { ret = sysfs_create_group ( & msipf_device -> dev . kobj , & msipf_old_attribute_group ) ; if ( ret ) { fail_create_attr } if ( auto_brightness != 2 ) { set_auto_brightness ( auto_brightness ) ; } } return 0 ; fail_create_attr sysfs_remove_group ( & msipf_device -> dev . kobj , & msipf_attribute_group ) ; fail_create_group msi_scm_model_exit ( ) ; fail_scm_model_init platform_device_del ( msipf_device ) ; fail_device_add platform_device_put ( msipf_device ) ; fail_platform_driver platform_driver_unregister ( & msipf_driver ) ; fail_backlight backlight_device_unregister ( msibl_device ) ; return ret ; } 