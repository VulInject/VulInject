int iommufd_ioas_allow_iovas ( struct iommufd_ucmd * ucmd ) { struct iommu_ioas_allow_iovas * cmd = ucmd -> cmd ; struct rb_root_cached allowed_iova = RB_ROOT_CACHED ; struct interval_tree_node * node ; struct iommufd_ioas * ioas ; struct io_pagetable * iopt ; int rc = 0 ; ioas = iommufd_get_ioas ( ucmd , cmd -> ioas_id ) ; if ( IS_ERR ( ioas ) ) { return PTR_ERR ( ioas ) ; } iopt = & ioas -> iopt ; rc = iommufd_ioas_load_iovas ( & allowed_iova , u64_to_user_ptr ( cmd -> allowed_iovas ) , cmd -> num_iovas ) ; if ( rc ) { out_free } rc = iopt_set_allow_iova ( iopt , & allowed_iova ) ; out_free while ( ( node = interval_tree_iter_first ( & allowed_iova , 0 , ULONG_MAX ) ) ) { interval_tree_remove ( node , & allowed_iova ) ; kfree ( container_of ( node , iopt_allowed , node ) ) ; } iommufd_put_object ( & ioas -> obj ) ; return rc ; } 