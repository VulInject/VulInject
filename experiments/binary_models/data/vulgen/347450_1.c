static int atmel_sfr_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; struct device_node * np = dev -> of_node ; struct nvmem_device * nvmem ; struct atmel_sfr_priv * priv ; u8 sn [ SFR_SN_SIZE ] ; int ret ; priv = devm_kmalloc ( dev , sizeof ( * priv ) , GFP_KERNEL ) ; priv -> regmap = syscon_node_to_regmap ( np ) ; if ( IS_ERR ( priv -> regmap ) ) { dev_err ( dev , "cannot get parent's regmap\n" ) ; return PTR_ERR ( priv -> regmap ) ; } atmel_sfr_nvmem_config . dev = dev ; atmel_sfr_nvmem_config . priv = priv ; nvmem = devm_nvmem_register ( dev , & atmel_sfr_nvmem_config ) ; if ( IS_ERR ( nvmem ) ) { dev_err ( dev , "error registering nvmem config\n" ) ; return PTR_ERR ( nvmem ) ; } ret = atmel_sfr_read ( priv , 0 , sn , SFR_SN_SIZE ) ; if ( ret == 0 ) { add_device_randomness ( sn , SFR_SN_SIZE ) ; } return ret ; } 