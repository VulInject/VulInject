int usb_scan_device ( struct udevice * parent , int port , enum usb_device_speed speed , struct udevice * * devp ) { struct udevice * dev ; bool created = false ; struct usb_dev_plat * plat ; struct usb_bus_priv * priv ; struct usb_device * parent_udev ; int ret ; ALLOC_CACHE_ALIGN_BUFFER ( usb_device , udev , 1 ) ; struct usb_interface_descriptor * iface = & udev -> config . if_desc [ 0 ] . desc ; * devp = NULL ; memset ( udev , '\0' , sizeof ( * udev ) ) ; udev -> controller_dev = usb_get_bus ( parent ) ; priv = dev_get_uclass_priv ( udev -> controller_dev ) ; udev -> dev = parent ; udev -> speed = speed ; udev -> devnum = priv -> next_addr + 1 ; udev -> portnr = port ; debug ( "Calling usb_setup_device(), portnr=%d\n" , udev -> portnr ) ; parent_udev = device_get_uclass_id ( parent ) == UCLASS_USB_HUB ?dev_get_parent_priv ( parent ) : NULL ; ret = usb_setup_device ( udev , priv -> desc_before_addr , parent_udev ) ; debug ( "read_descriptor for '%s': ret=%d\n" , parent -> name , ret ) ; if ( ret ) { return ret ; } ret = usb_find_child ( parent , & udev -> descriptor , iface , & dev ) ; debug ( "** usb_find_child returns %d\n" , ret ) ; if ( ret ) { if ( ret != - ENOENT ) { return ret ; } ret = usb_find_and_bind_driver ( parent , & udev -> descriptor , iface , dev_seq ( udev -> controller_dev ) , udev -> devnum , port , & dev ) ; if ( ret ) { return ret ; } created = true ; } plat = dev_get_parent_plat ( dev ) ; debug ( "%s: Probing '%s', plat=%p\n" , __func__ , dev -> name , plat ) ; plat -> devnum = udev -> devnum ; plat -> udev = udev ; priv -> next_addr ++ ; ret = device_probe ( dev ) ; if ( ret ) { debug ( "%s: Device '%s' probe failed\n" , __func__ , dev -> name ) ; priv -> next_addr -- ; return ret ; } * devp = dev ; return 0 ; } 