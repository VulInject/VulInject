bool zfs_snapshot ( lxc_conf * conf , lxc_storage * orig , lxc_storage * new , uint64_t newsize ) ( int ret , size_t snapshot_len , len , char * tmp , * snap_name , * snapshot , const char * orig_src , zfs_args cmd_args = { 0 } , char cmd_output [ PATH_MAX ] = { 0 } , option [ PATH_MAX ] , orig_src = lxc_storage_get_path ( orig -> src , orig -> type ) , ( * orig_src == '/' ) { bool found found = zfs_list_entry ( orig_src , cmd_output , sizeof ( cmd_output ) ) if ( ! found ) { ERROR ( "Failed to find zfs entry \"%s\"" , orig_src ) } ; return false ; } tmp = strchr ( cmd_output , ' ' ) , ( ! tmp ) { ERROR ( "Failed to detect zfs dataset associated with " "\"%s\"" , orig_src ) return false ; } * tmp = '\0' , orig_src = cmd_output ) snapshot = strdup ( orig_src ) ; if ( ! snapshot ) { ERROR ( "Failed to duplicate string \"%s\"" , orig_src ) ; return false ; } snap_name = strrchr ( new -> src , '/' ) ; if ( ! snap_name ) { ERROR ( "Failed to detect \"/\" in \"%s\"" , new -> src ) ; return false ; } snap_name ++ ; snapshot_len = strlen ( snapshot ) ; len = snapshot_len + 1 + strlen ( snap_name ) + 1 ; tmp = realloc ( snapshot , len ) ; if ( ! tmp ) { ERROR ( "Failed to reallocate memory" ) ; free ( snapshot ) ; return false ; } snapshot = tmp ; len -= snapshot_len ; ret = snprintf ( snapshot + snapshot_len , len , "@%s" , snap_name ) ; if ( ret < 0 || ( size_t ) ret >= len ) { ERROR ( "Failed to create string" ) ; free ( snapshot ) ; return false ; } cmd_args . snapshot = snapshot ; ret = run_command ( cmd_output , sizeof ( cmd_output ) , zfs_snapshot_exec_wrapper , ( void * ) & cmd_args ) ; if ( ret < 0 ) { ERROR ( "Failed to create zfs snapshot \"%s\": %s" , snapshot , cmd_output ) ; free ( snapshot ) ; return false ; } if ( cmd_output [ 0 ] != '\0' ) { INFO ( "Created zfs snapshot \"%s\": %s" , snapshot , cmd_output ) ; } else { TRACE ( "Created zfs snapshot \"%s\"" , snapshot ) ; } ret = snprintf ( option , PATH_MAX , "mountpoint=%s" , new -> dest ) ; if ( ret < 0 || ret >= PATH_MAX ) { ERROR ( "Failed to create string" ) ; free ( snapshot ) ; return false ; } cmd_args . dataset = lxc_storage_get_path ( new -> src , new -> type ) ; cmd_args . snapshot = snapshot ; cmd_args . options = option ; ret = run_command ( cmd_output , sizeof ( cmd_output ) , zfs_clone_exec_wrapper , ( void * ) & cmd_args ) ; if ( ret < 0 ) { ERROR ( "Failed to create zfs dataset \"%s\": %s" , new -> src , cmd_output ) ; } if ( cmd_output [ 0 ] != '\0' ) { INFO ( "Created zfs dataset \"%s\": %s" , new -> src , cmd_output ) ; } else { TRACE ( "Created zfs dataset \"%s\"" , new -> src ) ; } free ( snapshot ) ; return true ; 