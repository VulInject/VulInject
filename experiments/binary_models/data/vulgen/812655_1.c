static int cayman_cp_resume ( struct radeon_device * rdev ) { static const int ridx [ ] { RADEON_RING_TYPE_GFX_INDEX CAYMAN_RING_TYPE_CP1_INDEX CAYMAN_RING_TYPE_CP2_INDEX } ; ; static const unsigned cp_rb_cntl [ ] { CP_RB0_CNTL CP_RB1_CNTL CP_RB2_CNTL } ; ; static const unsigned cp_rb_rptr_addr [ ] { CP_RB0_RPTR_ADDR CP_RB1_RPTR_ADDR CP_RB2_RPTR_ADDR } ; ; static const unsigned cp_rb_rptr_addr_hi [ ] { CP_RB0_RPTR_ADDR_HI CP_RB1_RPTR_ADDR_HI CP_RB2_RPTR_ADDR_HI } ; ; static const unsigned cp_rb_base [ ] { CP_RB0_BASE CP_RB1_BASE CP_RB2_BASE } ; ; static const unsigned cp_rb_rptr [ ] { CP_RB0_RPTR CP_RB1_RPTR CP_RB2_RPTR } ; ; static const unsigned cp_rb_wptr [ ] { CP_RB0_WPTR CP_RB1_WPTR CP_RB2_WPTR } ; ; struct radeon_ring * ring ; int i , r ; WREG32 ( GRBM_SOFT_RESET , ( SOFT_RESET_CP | SOFT_RESET_PA | SOFT_RESET_SH | SOFT_RESET_VGT | SOFT_RESET_SPI | SOFT_RESET_SX ) ) ; RREG32 ( GRBM_SOFT_RESET ) ; mdelay ( 15 ) ; WREG32 ( GRBM_SOFT_RESET , 0 ) ; RREG32 ( GRBM_SOFT_RESET ) ; WREG32 ( CP_SEM_WAIT_TIMER , 0x0 ) ; WREG32 ( CP_SEM_INCOMPLETE_TIMER_CNTL , 0x0 ) ; WREG32 ( CP_RB_WPTR_DELAY , 0 ) ; WREG32 ( CP_DEBUG , ( 1 << 27 ) ) ; WREG32 ( SCRATCH_ADDR , ( ( rdev -> wb . gpu_addr + RADEON_WB_SCRATCH_OFFSET ) >> 8 ) & 0xFFFFFFFF ) ; WREG32 ( SCRATCH_UMSK , 0xff ) ; for ( i = 0 ; i < 3 ; ++ i ) { uint32_t rb_cntl ; uint64_t addr ; ring = & rdev -> ring [ ridx [ i ] ] ; rb_cntl = order_base_2 ( ring -> ring_size / 8 ) ; rb_cntl |= order_base_2 ( RADEON_GPU_PAGE_SIZE / 8 ) << 8 ; rb_cntl |= BUF_SWAP_32BIT ; WREG32 ( cp_rb_cntl [ i ] , rb_cntl ) ; addr = rdev -> wb . gpu_addr + RADEON_WB_CP_RPTR_OFFSET ; WREG32 ( cp_rb_rptr_addr [ i ] , addr & 0xFFFFFFFC ) ; WREG32 ( cp_rb_rptr_addr_hi [ i ] , upper_32_bits ( addr ) & 0xFF ) ; } for ( i = 0 ; i < 3 ; ++ i ) { ring = & rdev -> ring [ ridx [ i ] ] ; WREG32 ( cp_rb_base [ i ] , ring -> gpu_addr >> 8 ) ; } for ( i = 0 ; i < 3 ; ++ i ) { ring = & rdev -> ring [ ridx [ i ] ] ; WREG32_P ( cp_rb_cntl [ i ] , RB_RPTR_WR_ENA , ~ RB_RPTR_WR_ENA ) ; ring -> wptr = 0 ; WREG32 ( cp_rb_rptr [ i ] , 0 ) ; WREG32 ( cp_rb_wptr [ i ] , ring -> wptr ) ; mdelay ( 1 ) ; WREG32_P ( cp_rb_cntl [ i ] , 0 , ~ RB_RPTR_WR_ENA ) ; } cayman_cp_start ( rdev ) ; rdev -> ring [ RADEON_RING_TYPE_GFX_INDEX ] . ready = true ; rdev -> ring [ CAYMAN_RING_TYPE_CP1_INDEX ] . ready = false ; rdev -> ring [ CAYMAN_RING_TYPE_CP2_INDEX ] . ready = false ; r = radeon_ring_test ( rdev , RADEON_RING_TYPE_GFX_INDEX , & rdev -> ring [ RADEON_RING_TYPE_GFX_INDEX ] ) ; if ( r ) { rdev -> ring [ RADEON_RING_TYPE_GFX_INDEX ] . ready = false ; rdev -> ring [ CAYMAN_RING_TYPE_CP1_INDEX ] . ready = false ; rdev -> ring [ CAYMAN_RING_TYPE_CP2_INDEX ] . ready = false ; return r ; } return 0 ; } 