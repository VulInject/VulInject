static int gelic_net_set_wol ( struct net_device * netdev , struct ethtool_wolinfo * wol ) { int status ; struct gelic_card * card ; u64 v1 , v2 ; if ( ps3_compare_firmware_version ( 2 , 2 , 0 ) < 0 || ! capable ( CAP_NET_ADMIN ) ) { return - EPERM ; } card = netdev_card ( netdev ) ; if ( wol -> wolopts & WAKE_MAGIC ) { status = lv1_net_control ( bus_id ( card ) , dev_id ( card ) , GELIC_LV1_SET_WOL , GELIC_LV1_WOL_MAGIC_PACKET , 0 , GELIC_LV1_WOL_MP_ENABLE , & v1 , & v2 ) ; if ( status ) { pr_info ( "%s: enabling WOL failed %d\n" , __func__ , status ) ; status = - EIO ; done } status = lv1_net_control ( bus_id ( card ) , dev_id ( card ) , GELIC_LV1_SET_WOL , GELIC_LV1_WOL_ADD_MATCH_ADDR , 0 , GELIC_LV1_WOL_MATCH_ALL , & v1 , & v2 ) ; if ( ! status ) { ps3_sys_manager_set_wol ( 1 ) ; } else { pr_info ( "%s: enabling WOL filter failed %d\n" , __func__ , status ) ; status = - EIO ; } } else { status = lv1_net_control ( bus_id ( card ) , dev_id ( card ) , GELIC_LV1_SET_WOL , GELIC_LV1_WOL_MAGIC_PACKET , 0 , GELIC_LV1_WOL_MP_DISABLE , & v1 , & v2 ) ; if ( status ) { pr_info ( "%s: disabling WOL failed %d\n" , __func__ , status ) ; status = - EIO ; done } status = lv1_net_control ( bus_id ( card ) , dev_id ( card ) , GELIC_LV1_SET_WOL , GELIC_LV1_WOL_DELETE_MATCH_ADDR , 0 , GELIC_LV1_WOL_MATCH_ALL , & v1 , & v2 ) ; if ( ! status ) { ps3_sys_manager_set_wol ( 0 ) ; } else { pr_info ( "%s: removing WOL filter failed %d\n" , __func__ , status ) ; status = - EIO ; } } done return status ; } 