void HTConstructCapabilityElement ( struct rtllib_device * ieee , u8 * posHTCap , u8 * len , u8 IsEncrypt , bool bAssoc ) { struct rt_hi_throughput * pHT = ieee -> pHTInfo ; struct ht_capab_ele * pCapELE = NULL ; if ( ( posHTCap == NULL ) || ( pHT == NULL ) ) { netdev_warn ( ieee -> dev , "%s(): posHTCap and pHTInfo are null\n" , __func__ ) ; return ; } if ( ( bAssoc ) && ( pHT -> ePeerHTSpecVer == HT_SPEC_VER_EWC ) ) { u8 EWC11NHTCap [ ] { 0x00 0x90 0x4c 0x33 } ; ; memcpy ( posHTCap , EWC11NHTCap , sizeof ( EWC11NHTCap ) ) ; pCapELE = ( ht_capab_ele * ) & ( posHTCap [ 4 ] ) ; * len = 30 + 2 ; } else { pCapELE = ( ht_capab_ele * ) posHTCap ; * len = 26 + 2 ; } pCapELE -> AdvCoding = 0 ; if ( ieee -> GetHalfNmodeSupportByAPsHandler ( ieee -> dev ) ) { pCapELE -> ChlWidth = 0 ; } else { pCapELE -> ChlWidth = ( pHT -> bRegBW40MHz ?1 : 0 ) ; } pCapELE -> MimoPwrSave = pHT -> SelfMimoPs ; pCapELE -> GreenField = 0 ; pCapELE -> ShortGI20Mhz = 1 ; pCapELE -> ShortGI40Mhz = 1 ; pCapELE -> TxSTBC = 1 ; pCapELE -> RxSTBC = 0 ; pCapELE -> DelayBA = 0 ; pCapELE -> MaxAMSDUSize = ( MAX_RECEIVE_BUFFER_SIZE >= 7935 ) ?1 : 0 ; pCapELE -> DssCCk = ( ( pHT -> bRegBW40MHz ) ?( pHT -> bRegSuppCCK ?1 : 0 ) else 0 ) ; pCapELE -> PSMP = 0 ; pCapELE -> LSigTxopProtect = 0 ; netdev_dbg ( ieee -> dev , "TX HT cap/info ele BW=%d MaxAMSDUSize:%d DssCCk:%d\n" , pCapELE -> ChlWidth , pCapELE -> MaxAMSDUSize , pCapELE -> DssCCk ) ; if ( IsEncrypt ) { pCapELE -> MPDUDensity = 7 ; pCapELE -> MaxRxAMPDUFactor = 2 ; } else { pCapELE -> MaxRxAMPDUFactor = 3 ; pCapELE -> MPDUDensity = 0 ; } memcpy ( pCapELE -> MCS , ieee -> Regdot11HTOperationalRateSet , 16 ) ; memset ( & pCapELE -> ExtHTCapInfo , 0 , 2 ) ; memset ( pCapELE -> TxBFCap , 0 , 4 ) ; pCapELE -> ASCap = 0 ; if ( bAssoc ) { if ( pHT -> IOTAction & HT_IOT_ACT_DISABLE_MCS15 ) { pCapELE -> MCS [ 1 ] &= 0x7f ; } if ( pHT -> IOTAction & HT_IOT_ACT_DISABLE_MCS14 ) { pCapELE -> MCS [ 1 ] &= 0xbf ; } if ( pHT -> IOTAction & HT_IOT_ACT_DISABLE_ALL_2SS ) { pCapELE -> MCS [ 1 ] &= 0x00 ; } if ( pHT -> IOTAction & HT_IOT_ACT_DISABLE_RX_40MHZ_SHORT_GI ) { pCapELE -> ShortGI40Mhz = 0 ; } if ( ieee -> GetHalfNmodeSupportByAPsHandler ( ieee -> dev ) ) { pCapELE -> ChlWidth = 0 ; pCapELE -> MCS [ 1 ] = 0 ; } } } 