static void titsc_step_config ( struct titsc * ts_dev ) { unsigned int config ; int i , n ; int end_step , first_step , tsc_steps ; u32 stepenable ; config = STEPCONFIG_MODE_HWSYNC | STEPCONFIG_AVG_16 | ts_dev -> bit_xp | STEPCONFIG_INM_ADCREFM ; switch ( ts_dev -> wires ) { case 4 : config |= STEPCONFIG_INP ( ts_dev -> inp_yp ) | ts_dev -> bit_xn ; break ; case 5 : config |= ts_dev -> bit_yn | STEPCONFIG_INP_AN4 | ts_dev -> bit_xn | ts_dev -> bit_yp ; break ; case 8 : config |= STEPCONFIG_INP ( ts_dev -> inp_yp ) | ts_dev -> bit_xn ; break ; } tsc_steps = ts_dev -> coordinate_readouts * 2 + 2 ; first_step = TOTAL_STEPS - tsc_steps ; end_step = first_step + tsc_steps ; n = 0 ; for ( i = end_step - ts_dev -> coordinate_readouts ; i < end_step ; i ++ ) { titsc_writel ( ts_dev , REG_STEPCONFIG ( i ) , config ) ; titsc_writel ( ts_dev , REG_STEPDELAY ( i ) , n ++ == 0 ?STEPCONFIG_OPENDLY : 0 ) ; } config = 0 ; config = STEPCONFIG_MODE_HWSYNC | STEPCONFIG_AVG_16 | ts_dev -> bit_yn | STEPCONFIG_INM_ADCREFM ; switch ( ts_dev -> wires ) { case 4 : config |= ts_dev -> bit_yp | STEPCONFIG_INP ( ts_dev -> inp_xp ) ; break ; case 5 : config |= ts_dev -> bit_xp | STEPCONFIG_INP_AN4 | STEPCONFIG_XNP | STEPCONFIG_YPN ; break ; case 8 : config |= ts_dev -> bit_yp | STEPCONFIG_INP ( ts_dev -> inp_xp ) ; break ; } end_step = first_step + ts_dev -> coordinate_readouts ; n = 0 ; for ( i = first_step ; i < end_step ; i ++ ) { titsc_writel ( ts_dev , REG_STEPCONFIG ( i ) , config ) ; titsc_writel ( ts_dev , REG_STEPDELAY ( i ) , n ++ == 0 ?STEPCONFIG_OPENDLY : 0 ) ; } config = titsc_readl ( ts_dev , REG_IDLECONFIG ) ; titsc_writel ( ts_dev , REG_CHARGECONFIG , config ) ; titsc_writel ( ts_dev , REG_CHARGEDELAY , ts_dev -> charge_delay ) ; config = STEPCONFIG_MODE_HWSYNC | STEPCONFIG_AVG_16 | ts_dev -> bit_yp | ts_dev -> bit_xn | STEPCONFIG_INM_ADCREFM | STEPCONFIG_INP ( ts_dev -> inp_xp ) ; titsc_writel ( ts_dev , REG_STEPCONFIG ( end_step ) , config ) ; titsc_writel ( ts_dev , REG_STEPDELAY ( end_step ) , STEPCONFIG_OPENDLY ) ; end_step ++ ; config = STEPCONFIG_MODE_HWSYNC | STEPCONFIG_AVG_16 | ts_dev -> bit_yp | ts_dev -> bit_xn | STEPCONFIG_INM_ADCREFM | STEPCONFIG_INP ( ts_dev -> inp_yn ) ; titsc_writel ( ts_dev , REG_STEPCONFIG ( end_step ) , config ) ; titsc_writel ( ts_dev , REG_STEPDELAY ( end_step ) , STEPCONFIG_OPENDLY ) ; stepenable = 1 ; for ( i = 0 ; i < tsc_steps ; i ++ ) { stepenable |= 1 << ( first_step + i + 1 ) ; } ts_dev -> step_mask = stepenable ; } 