unsigned long sunxi_dram_init ( void ) { struct sunxi_mctl_com_reg * const mctl_com = ( sunxi_mctl_com_reg * ) SUNXI_DRAM_COM_BASE ; struct sunxi_mctl_ctl_reg * const mctl_ctl = ( sunxi_mctl_ctl_reg * ) SUNXI_DRAM_CTL0_BASE ; struct dram_para para = { . cs1 = 0 . bank = 1 . rank = 2 . rows = 15 . bus_width = 16 . page_size = 2048 } ; mctl_sys_init ( & para ) ; auto_detect_dram_size ( & para ) ; writel ( readl ( & mctl_com -> swonr ) | 0x3ffff , & mctl_com -> swonr ) ; if ( para . rank == 2 ) { writel ( 0x00000303 , & mctl_ctl -> odtmap ) ; } else { writel ( 0x00000201 , & mctl_ctl -> odtmap ) ; } return para . page_size * ( para . bus_width / 8 ) * ( 1 << ( para . bank + para . rank + para . rows ) ) ; } 