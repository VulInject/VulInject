static void omap_mcbsp_dai_shutdown ( struct snd_pcm_substream * substream , struct snd_soc_dai * cpu_dai ) { struct omap_mcbsp * mcbsp = snd_soc_dai_get_drvdata ( cpu_dai ) ; int tx = ( substream -> stream == SNDRV_PCM_STREAM_PLAYBACK ) ; int stream1 = tx ?SNDRV_PCM_STREAM_PLAYBACK : SNDRV_PCM_STREAM_CAPTURE ; int stream2 = tx ?SNDRV_PCM_STREAM_CAPTURE : SNDRV_PCM_STREAM_PLAYBACK ; if ( mcbsp -> latency [ stream2 ] ) { cpu_latency_qos_update_request ( & mcbsp -> pm_qos_req , mcbsp -> latency [ stream2 ] ) ; } if ( mcbsp -> latency [ stream1 ] ) { cpu_latency_qos_remove_request ( & mcbsp -> pm_qos_req ) ; } mcbsp -> latency [ stream1 ] = 0 ; if ( ! snd_soc_dai_active ( cpu_dai ) ) { omap_mcbsp_free ( mcbsp ) ; } } 