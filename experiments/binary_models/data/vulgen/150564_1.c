static bool _rtl8712e_init_mac ( struct ieee80211_hw * hw ) { struct rtl_priv * rtlpriv = rtl_priv ( hw ) ; struct rtl_pci * rtlpci = rtl_pcidev ( rtl_pcipriv ( hw ) ) ; unsigned char bytetmp ; unsigned short wordtmp ; u16 retry = 0 ; u16 tmpu2b ; bool mac_func_enable ; rtl_write_byte ( rtlpriv , REG_RSV_CTRL , 0x00 ) ; bytetmp = rtl_read_byte ( rtlpriv , REG_CR ) ; if ( bytetmp == 0xFF ) { mac_func_enable = true ; } else { mac_func_enable = false ; } bytetmp = rtl_read_byte ( rtlpriv , REG_PCIE_CTRL_REG + 2 ) ; rtl_write_byte ( rtlpriv , REG_PCIE_CTRL_REG + 2 , bytetmp | BIT ( 4 ) ) ; bytetmp = rtl_read_byte ( rtlpriv , 0x369 ) ; rtl_write_byte ( rtlpriv , 0x369 , bytetmp | BIT ( 7 ) ) ; { rtl_write_word ( rtlpriv , 0x358 , 0x5e ) ; udelay ( 100 ) ; rtl_write_word ( rtlpriv , 0x356 , 0xc280 ) ; rtl_write_word ( rtlpriv , 0x354 , 0xc290 ) ; rtl_write_word ( rtlpriv , 0x358 , 0x3e ) ; udelay ( 100 ) ; rtl_write_word ( rtlpriv , 0x358 , 0x5e ) ; udelay ( 100 ) ; tmpu2b = rtl_read_word ( rtlpriv , 0x356 ) ; retry ++ ; } tmpu2b != 0xc290 && retry < 100 ; if ( retry >= 100 ) { rtl_dbg ( rtlpriv , COMP_INIT , DBG_LOUD , "InitMAC(): ePHY configure fail!!!\n" ) ; return false ; } rtl_write_word ( rtlpriv , REG_CR , 0x2ff ) ; rtl_write_word ( rtlpriv , REG_CR + 1 , 0x06 ) ; if ( ! mac_func_enable ) { if ( ! _rtl8723e_llt_table_init ( hw ) ) { return false ; } } rtl_write_dword ( rtlpriv , REG_HISR , 0xffffffff ) ; rtl_write_byte ( rtlpriv , REG_HISRE , 0xff ) ; rtl_write_word ( rtlpriv , REG_TRXFF_BNDY + 2 , 0x27ff ) ; wordtmp = rtl_read_word ( rtlpriv , REG_TRXDMA_CTRL ) ; wordtmp &= 0xf ; wordtmp |= 0xF771 ; rtl_write_word ( rtlpriv , REG_TRXDMA_CTRL , wordtmp ) ; rtl_write_byte ( rtlpriv , REG_FWHW_TXQ_CTRL + 1 , 0x1F ) ; rtl_write_dword ( rtlpriv , REG_RCR , rtlpci -> receive_config ) ; rtl_write_word ( rtlpriv , REG_RXFLTMAP2 , 0xFFFF ) ; rtl_write_dword ( rtlpriv , REG_TCR , rtlpci -> transmit_config ) ; rtl_write_byte ( rtlpriv , 0x4d0 , 0x0 ) ; rtl_write_dword ( rtlpriv , REG_BCNQ_DESA , ( ( u64 ) rtlpci -> tx_ring [ BEACON_QUEUE ] . dma ) & DMA_BIT_MASK ( 32 ) ) ; rtl_write_dword ( rtlpriv , REG_MGQ_DESA , ( u64 ) rtlpci -> tx_ring [ MGNT_QUEUE ] . dma & DMA_BIT_MASK ( 32 ) ) ; rtl_write_dword ( rtlpriv , REG_VOQ_DESA , ( u64 ) rtlpci -> tx_ring [ VO_QUEUE ] . dma & DMA_BIT_MASK ( 32 ) ) ; rtl_write_dword ( rtlpriv , REG_VIQ_DESA , ( u64 ) rtlpci -> tx_ring [ VI_QUEUE ] . dma & DMA_BIT_MASK ( 32 ) ) ; rtl_write_dword ( rtlpriv , REG_BEQ_DESA , ( u64 ) rtlpci -> tx_ring [ BE_QUEUE ] . dma & DMA_BIT_MASK ( 32 ) ) ; rtl_write_dword ( rtlpriv , REG_BKQ_DESA , ( u64 ) rtlpci -> tx_ring [ BK_QUEUE ] . dma & DMA_BIT_MASK ( 32 ) ) ; rtl_write_dword ( rtlpriv , REG_HQ_DESA , ( u64 ) rtlpci -> tx_ring [ HIGH_QUEUE ] . dma & DMA_BIT_MASK ( 32 ) ) ; rtl_write_dword ( rtlpriv , REG_RX_DESA , ( u64 ) rtlpci -> rx_ring [ RX_MPDU_QUEUE ] . dma & DMA_BIT_MASK ( 32 ) ) ; rtl_write_byte ( rtlpriv , REG_PCIE_CTRL_REG + 3 , 0x74 ) ; rtl_write_dword ( rtlpriv , REG_INT_MIG , 0 ) ; bytetmp = rtl_read_byte ( rtlpriv , REG_APSD_CTRL ) ; rtl_write_byte ( rtlpriv , REG_APSD_CTRL , bytetmp & ~ BIT ( 6 ) ) ; { retry ++ ; bytetmp = rtl_read_byte ( rtlpriv , REG_APSD_CTRL ) ; } ( retry < 200 ) && ( bytetmp & BIT ( 7 ) ) ; _rtl8723e_gen_refresh_led_state ( hw ) ; rtl_write_dword ( rtlpriv , REG_MCUTST_1 , 0x0 ) ; return true ; } 