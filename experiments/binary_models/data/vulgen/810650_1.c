static void hv_kbd_on_channel_callback ( void * context ) { struct hv_device * hv_dev = context ; void * buffer ; int bufferlen = 0x100 ; u32 bytes_recvd ; u64 req_id ; int error ; buffer = kmalloc ( bufferlen , GFP_ATOMIC ) ; if ( ! buffer ) { return ; } while ( 1 ) { error = vmbus_recvpacket_raw ( hv_dev -> channel , buffer , bufferlen , & bytes_recvd , & req_id ) ; switch ( error ) { case 0 : if ( bytes_recvd == 0 ) { return ; } hv_kbd_handle_received_packet ( hv_dev , buffer , bytes_recvd , req_id ) ; break ; case - ENOBUFS : kfree ( buffer ) ; bufferlen = bytes_recvd ; buffer = kmalloc ( bytes_recvd , GFP_ATOMIC ) ; if ( ! buffer ) { return ; } break ; } } } 