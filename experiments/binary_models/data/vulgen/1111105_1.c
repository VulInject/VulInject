BOOL StartStopService ( HWND hwndDlg , wchar_t * lpszService , BOOL bStart , DWORD argc , LPCWSTR * argv ) { SC_HANDLE hManager , hService = NULL ; BOOL bOK = FALSE , bRet ; SERVICE_STATUS status = { 0 } ; int x ; DWORD dwExpectedState = bStart ?SERVICE_RUNNING : SERVICE_STOPPED ; hManager = OpenSCManager ( NULL , NULL , SC_MANAGER_ALL_ACCESS ) ; if ( hManager == NULL ) { error } hService = OpenService ( hManager , lpszService , SERVICE_ALL_ACCESS ) ; if ( hService == NULL ) { error } if ( bStart ) { StatusMessageParam ( hwndDlg , "STARTING" , lpszService ) ; } else { StatusMessageParam ( hwndDlg , "STOPPING" , lpszService ) ; } if ( bStart ) { if ( ! StartService ( hService , argc , argv ) && ( GetLastError ( ) != ERROR_SERVICE_ALREADY_RUNNING ) ) { error } } else { ControlService ( hService , SERVICE_CONTROL_STOP , & status ) ; } for ( x = 0 ; x < WAIT_PERIOD ; x ++ ) { bRet = QueryServiceStatus ( hService , & status ) ; if ( bRet != TRUE ) { error } if ( status . dwCurrentState == dwExpectedState ) { break ; } Sleep ( 1000 ) ; } bRet = QueryServiceStatus ( hService , & status ) ; if ( bRet != TRUE ) { error } if ( status . dwCurrentState != dwExpectedState ) { error } bOK = TRUE ; error if ( bOK == FALSE && GetLastError ( ) == ERROR_SERVICE_DOES_NOT_EXIST ) { bOK = TRUE ; } if ( hManager != NULL ) { CloseServiceHandle ( hManager ) ; } return bOK ; } 