HX509_LIB_FUNCTION int HX509_LIB_CALL hx509_verify_hostname ( hx509_context context , const hx509_cert cert , int flags , hx509_hostname_type type , const char * hostname , const struct sockaddr * sa , int sa_size ) { GeneralNames san ; const Name * name ; int ret ; size_t i , j , k ; memset ( & san , 0 , sizeof ( san ) ) ; i = 0 ; { ret = find_extension_subject_alt_name ( cert -> data , & i , & san ) ; if ( ret == HX509_EXTENSION_NOT_FOUND ) { break ; } if ( ret != 0 ) { return HX509_PARSING_NAME_FAILED ; } for ( j = 0 ; j < san . len ; j ++ ) { switch ( san . val [ j ] . element ) { case choice_GeneralName_dNSName : { heim_printable_string hn ; hn . data = rk_UNCONST ( hostname ) ; hn . length = strlen ( hostname ) ; if ( der_printable_string_cmp ( & san . val [ j ] . u . dNSName , & hn ) == 0 ) { free_GeneralNames ( & san ) ; return 0 ; } break ; } default : break ; } } free_GeneralNames ( & san ) ; } 1 ; name = & cert -> data -> tbsCertificate . subject ; for ( ret = 0 , k = name -> u . rdnSequence . len ; ret == 0 && k > 0 ; k -- ) { i = k - 1 ; for ( j = 0 ; ret == 0 && j < name -> u . rdnSequence . val [ i ] . len ; j ++ ) { AttributeTypeAndValue * n = & name -> u . rdnSequence . val [ i ] . val [ j ] ; if ( der_heim_oid_cmp ( & n -> type , & asn1_oid_id_at_commonName ) == 0 ) { DirectoryString * ds = & n -> value ; switch ( ds -> element ) { case choice_DirectoryString_printableString : { heim_printable_string hn ; hn . data = rk_UNCONST ( hostname ) ; hn . length = strlen ( hostname ) ; if ( der_printable_string_cmp ( & ds -> u . printableString , & hn ) == 0 ) { return 0 ; } break ; } case choice_DirectoryString_ia5String : { heim_ia5_string hn ; hn . data = rk_UNCONST ( hostname ) ; hn . length = strlen ( hostname ) ; if ( der_ia5_string_cmp ( & ds -> u . ia5String , & hn ) == 0 ) { return 0 ; } break ; } case choice_DirectoryString_utf8String : if ( strcasecmp ( ds -> u . utf8String , hostname ) == 0 ) { return 0 ; } default : break ; } ret = HX509_NAME_CONSTRAINT_ERROR ; } } } if ( ( flags & HX509_VHN_F_ALLOW_NO_MATCH ) == 0 ) { ret = HX509_NAME_CONSTRAINT_ERROR ; } return ret ; } 