read_restart_marker ( ) { if ( cinfo -> unread_marker == 0 ) { if ( ! next_marker ( cinfo ) ) { return FALSE ; } } if ( cinfo -> unread_marker == ( ( int ) M_RST0 + cinfo -> marker -> next_restart_num ) ) { TRACEMS1 ( cinfo , 3 , JTRC_RST , cinfo -> marker -> next_restart_num ) ; cinfo -> unread_marker = 0 ; } else { if ( ! * cinfo -> src -> resync_to_restart ( cinfo , cinfo -> marker -> next_restart_num ) ) { return FALSE ; } } cinfo -> marker -> next_restart_num = ( cinfo -> marker -> next_restart_num + 1 ) & 7 ; return TRUE ; } GLOBAL ( ) jpeg_resync_to_restart ( , ) { int marker = cinfo -> unread_marker ; int action = 1 ; for ( ; ; ) { if ( marker < ( int ) M_SOF0 ) { action = 2 ; } if ( marker < ( int ) M_RST0 || marker > ( int ) M_RST7 ) { action = 3 ; } else { if ( marker == ( ( int ) M_RST0 + ( ( desired + 1 ) & 7 ) ) || marker == ( ( int ) M_RST0 + ( ( desired + 2 ) & 7 ) ) ) { action = 3 ; } if ( marker == ( ( int ) M_RST0 + ( ( desired - 1 ) & 7 ) ) || marker == ( ( int ) M_RST0 + ( ( desired - 2 ) & 7 ) ) ) { action = 2 ; } else { action = 1 ; } } TRACEMS2 ( cinfo , 4 , JTRC_RECOVERY_ACTION , marker , action ) ; switch ( action ) { case 1 : cinfo -> unread_marker = 0 ; return TRUE ; case 2 : if ( ! next_marker ( cinfo ) ) { return FALSE ; } marker = cinfo -> unread_marker ; break ; case 3 : return TRUE ; } } } 