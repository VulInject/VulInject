void __init detect_intel_iommu ( void ) { int ret ; struct dmar_res_callback validate_drhd_cb = { . cb [ ACPI_DMAR_TYPE_HARDWARE_UNIT ] = & dmar_validate_one_drhd . ignore_unhandled = true } ; down_write ( & dmar_global_lock ) ; ret = dmar_table_detect ( ) ; if ( ! ret ) { ret = dmar_walk_dmar_table ( ( acpi_table_dmar * ) dmar_tbl , & validate_drhd_cb ) ; } if ( ! ret && ! no_iommu && ! iommu_detected && ( ! dmar_disabled || dmar_platform_optin ( ) ) ) { iommu_detected = 1 ; pci_request_acs ( ) ; } if ( ! ret ) { x86_init . iommu . iommu_init = intel_iommu_init ; x86_platform . iommu_shutdown = intel_iommu_shutdown ; } up_write ( & dmar_global_lock ) ; } 