json_keys kz_str_split ( char * a_str , const char a_delim , int * c ) { json_keys result = 0 ; int count = 0 ; char * tmp = a_str ; char * last_comma = 0 ; char delim [ 2 ] ; delim [ 0 ] = a_delim ; delim [ 1 ] = 0 ; int len = 0 ; while ( * tmp ) { if ( a_delim == * tmp ) { count ++ ; last_comma = tmp ; } tmp ++ ; } count += last_comma < ( a_str + strlen ( a_str ) - 1 ) ; * c = count ; LM_DBG ( "COUNT %d\n" , count ) ; result = pkg_malloc ( sizeof ( json_key ) * count ) ; if ( result ) { int idx = 0 ; char * token = strtok ( a_str , delim ) ; while ( token ) { LM_DBG ( "TOKEN %d : %s\n" , idx , token ) ; assert ( idx < count ) ; result [ idx ] = pkg_malloc ( sizeof ( str ) ) ; len = strlen ( token ) ; result [ idx ] -> len = len ; result [ idx ] -> s = pkg_malloc ( ( len + 1 ) * sizeof ( char ) ) ; strncpy ( result [ idx ] -> s , token , len ) ; result [ idx ] -> s [ len ] = '\0' ; int i = 0 ; while ( i < len ) { if ( result [ idx ] -> s [ i ] == kz_json_escape_char ) { result [ idx ] -> s [ i ] = '.' ; } i ++ ; } LM_DBG ( "TOKEN2 %d : %s\n" , idx , result [ idx ] -> s ) ; token = strtok ( 0 , delim ) ; idx ++ ; } assert ( idx == count ) ; } return result ; } 