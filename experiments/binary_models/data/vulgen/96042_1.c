void intel_hfi_process_event ( __u64 pkg_therm_status_msr_val ) { struct hfi_instance * hfi_instance ; int cpu = smp_processor_id ( ) ; struct hfi_cpu_info * info ; u64 new_timestamp , msr , hfi ; info = & per_cpu ( hfi_cpu_info , cpu ) ; if ( ! info ) { return ; } hfi_instance = info -> hfi_instance ; if ( unlikely ( ! hfi_instance ) ) { pr_debug ( "Received event on CPU %d but instance was null" , cpu ) ; return ; } if ( ! raw_spin_trylock ( & hfi_instance -> event_lock ) ) { return ; } rdmsrl ( MSR_IA32_PACKAGE_THERM_STATUS , msr ) ; hfi = msr & PACKAGE_THERM_STATUS_HFI_UPDATED ; if ( ! hfi ) { raw_spin_unlock ( & hfi_instance -> event_lock ) ; return ; } new_timestamp = * ( u64 * ) hfi_instance -> hw_table ; if ( * hfi_instance -> timestamp == new_timestamp ) { thermal_clear_package_intr_status ( PACKAGE_LEVEL , PACKAGE_THERM_STATUS_HFI_UPDATED ) ; raw_spin_unlock ( & hfi_instance -> event_lock ) ; return ; } raw_spin_lock ( & hfi_instance -> table_lock ) ; memcpy ( hfi_instance -> local_table , hfi_instance -> hw_table , hfi_features . nr_table_pages << PAGE_SHIFT ) ; thermal_clear_package_intr_status ( PACKAGE_LEVEL , PACKAGE_THERM_STATUS_HFI_UPDATED ) ; raw_spin_unlock ( & hfi_instance -> table_lock ) ; raw_spin_unlock ( & hfi_instance -> event_lock ) ; queue_delayed_work ( hfi_updates_wq , & hfi_instance -> update_work , HFI_UPDATE_INTERVAL ) ; } 