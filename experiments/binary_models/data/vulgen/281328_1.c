static void dev_dax_kmem_remove ( struct dev_dax * dev_dax ) { int i , success = 0 ; int node = dev_dax -> target_node ; struct device * dev = & dev_dax -> dev ; struct dax_kmem_data * data = dev_get_drvdata ( dev ) ; for ( i = 0 ; i < dev_dax -> nr_range ; i ++ ) { struct range range ; int rc ; rc = dax_kmem_range ( dev_dax , i , & range ) ; if ( rc ) { continue ; } rc = remove_memory ( range . start , range_len ( & range ) ) ; if ( rc == 0 ) { remove_resource ( data -> res [ i ] ) ; kfree ( data -> res [ i ] ) ; data -> res [ i ] = NULL ; success ++ ; continue ; } any_hotremove_failed = true ; dev_err ( dev , "mapping%d: %#llx-%#llx cannot be hotremoved until the next reboot\n" , i , range . start , range . end ) ; } if ( success >= dev_dax -> nr_range ) { memory_group_unregister ( data -> mgid ) ; kfree ( data ) ; dev_set_drvdata ( dev , NULL ) ; clear_node_memory_type ( node , dax_slowmem_type ) ; } } 