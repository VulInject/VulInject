static struct scmi_vio_msg * scmi_virtio_get_free_msg ( struct scmi_vio_channel * vioch ) { unsigned long flags ; struct scmi_vio_msg * msg ; spin_lock_irqsave ( & vioch -> free_lock , flags ) ; if ( list_empty ( & vioch -> free_list ) ) { spin_unlock_irqrestore ( & vioch -> free_lock , flags ) ; return NULL ; } msg = list_first_entry ( & vioch -> free_list , typeof ( * msg ) , list ) ; list_del_init ( & msg -> list ) ; spin_unlock_irqrestore ( & vioch -> free_lock , flags ) ; msg -> poll_status = VIO_MSG_NOT_POLLED ; return msg ; } 