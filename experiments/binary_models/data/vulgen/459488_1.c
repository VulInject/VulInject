int msMSSQL2008LayerGetExtent ( layerObj * layer , rectObj * extent ) { msMSSQL2008LayerInfo * layerinfo ; char * query ; char result_data [ 256 ] ; SQLLEN retLen ; SQLRETURN rc ; if ( layer -> debug ) { msDebug ( "msMSSQL2008LayerGetExtent called\n" ) ; } if ( ! ( layer -> extent . minx == - 1.0 && layer -> extent . miny == - 1.0 && layer -> extent . maxx == - 1.0 && layer -> extent . maxy == - 1.0 ) ) { extent -> minx = layer -> extent . minx ; extent -> miny = layer -> extent . miny ; extent -> maxx = layer -> extent . maxx ; extent -> maxy = layer -> extent . maxy ; } layerinfo = getMSSQL2008LayerInfo ( layer ) ; if ( ! layerinfo ) { msSetError ( MS_QUERYERR , "GetExtent called with layerinfo = NULL" , "msMSSQL2008LayerGetExtent()" ) ; return MS_FAILURE ; } if ( getMSSQLMajorVersion ( layer ) >= 11 ) { if ( strcasecmp ( layerinfo -> geom_column_type , "geography" ) == 0 ) { query = msStringConcatenate ( query , "WITH extent(extentcol) AS (SELECT geometry::EnvelopeAggregate(geometry::STGeomFromWKB(" ) ; query = msStringConcatenate ( query , layerinfo -> geom_column ) ; query = msStringConcatenate ( query , ".STAsBinary(), " ) ; query = msStringConcatenate ( query , layerinfo -> geom_column ) ; query = msStringConcatenate ( query , ".STSrid)" ) ; } else { query = msStringConcatenate ( query , "WITH extent(extentcol) AS (SELECT geometry::EnvelopeAggregate(" ) ; query = msStringConcatenate ( query , layerinfo -> geom_column ) ; } query = msStringConcatenate ( query , ") AS extentcol FROM " ) ; query = msStringConcatenate ( query , layerinfo -> geom_table ) ; addFilter ( layer , & query ) ; query = msStringConcatenate ( query , ") SELECT extentcol.STPointN(1).STX, extentcol.STPointN(1).STY, extentcol.STPointN(3).STX, extentcol.STPointN(3).STY FROM extent" ) ; } else { if ( strcasecmp ( layerinfo -> geom_column_type , "geography" ) == 0 ) { query = msStringConcatenate ( query , "WITH ENVELOPE as (SELECT geometry::STGeomFromWKB(" ) ; query = msStringConcatenate ( query , layerinfo -> geom_column ) ; query = msStringConcatenate ( query , ".STAsBinary(), " ) ; query = msStringConcatenate ( query , layerinfo -> geom_column ) ; query = msStringConcatenate ( query , ".STSrid)" ) ; } else { query = msStringConcatenate ( query , "WITH ENVELOPE as (SELECT " ) ; query = msStringConcatenate ( query , layerinfo -> geom_column ) ; } query = msStringConcatenate ( query , ".STEnvelope() as envelope from " ) ; query = msStringConcatenate ( query , layerinfo -> geom_table ) ; addFilter ( layer , & query ) ; query = msStringConcatenate ( query , "), CORNERS as (SELECT envelope.STPointN(1) as point from ENVELOPE UNION ALL select envelope.STPointN(3) from ENVELOPE) SELECT MIN(point.STX), MIN(point.STY), MAX(point.STX), MAX(point.STY) FROM CORNERS" ) ; } if ( ! executeSQL ( layerinfo -> conn , query ) ) { msFree ( query ) ; return MS_FAILURE ; } msFree ( query ) ; rc = SQLFetch ( layerinfo -> conn -> hstmt ) ; if ( rc != SQL_SUCCESS && rc != SQL_SUCCESS_WITH_INFO ) { if ( layer -> debug ) { msDebug ( "msMSSQL2008LayerGetExtent: No results found.\n" ) ; } return MS_FAILURE ; } rc = SQLGetData ( layerinfo -> conn -> hstmt , 1 , SQL_C_CHAR , result_data , sizeof ( result_data ) , & retLen ) ; if ( rc == SQL_ERROR || retLen < 0 ) { msSetError ( MS_QUERYERR , "Failed to get MinX value" , "msMSSQL2008LayerGetExtent()" ) ; return MS_FAILURE ; } result_data [ retLen ] = 0 ; extent -> minx = atof ( result_data ) ; rc = SQLGetData ( layerinfo -> conn -> hstmt , 2 , SQL_C_CHAR , result_data , sizeof ( result_data ) , & retLen ) ; if ( rc == SQL_ERROR || retLen < 0 ) { msSetError ( MS_QUERYERR , "Failed to get MinY value" , "msMSSQL2008LayerGetExtent()" ) ; return MS_FAILURE ; } result_data [ retLen ] = 0 ; extent -> miny = atof ( result_data ) ; rc = SQLGetData ( layerinfo -> conn -> hstmt , 3 , SQL_C_CHAR , result_data , sizeof ( result_data ) , & retLen ) ; if ( rc == SQL_ERROR || retLen < 0 ) { msSetError ( MS_QUERYERR , "Failed to get MaxX value" , "msMSSQL2008LayerGetExtent()" ) ; return MS_FAILURE ; } result_data [ retLen ] = 0 ; extent -> maxx = atof ( result_data ) ; rc = SQLGetData ( layerinfo -> conn -> hstmt , 4 , SQL_C_CHAR , result_data , sizeof ( result_data ) , & retLen ) ; if ( rc == SQL_ERROR || retLen < 0 ) { msSetError ( MS_QUERYERR , "Failed to get MaxY value" , "msMSSQL2008LayerGetExtent()" ) ; return MS_FAILURE ; } result_data [ retLen ] = 0 ; extent -> maxy = atof ( result_data ) ; return MS_SUCCESS ; } 