netdev_tx_t emac_mac_tx_buf_send ( struct emac_adapter * adpt , struct emac_tx_queue * tx_q , struct sk_buff * skb ) { struct emac_tpd tpd ; u32 prod_idx ; int len ; memset ( & tpd , 0 , sizeof ( tpd ) ) ; if ( emac_tso_csum ( adpt , tx_q , skb , & tpd ) != 0 ) { return NETDEV_TX_OK ; } if ( skb_vlan_tag_present ( skb ) ) { u16 tag ; EMAC_VLAN_TO_TAG ( skb_vlan_tag_get ( skb ) , tag ) ; TPD_CVLAN_TAG_SET ( & tpd , tag ) ; TPD_INSTC_SET ( & tpd , 1 ) ; } if ( skb_network_offset ( skb ) != ETH_HLEN ) { TPD_TYP_SET ( & tpd , 1 ) ; } len = skb -> len ; emac_tx_fill_tpd ( adpt , tx_q , skb , & tpd ) ; netdev_sent_queue ( adpt -> netdev , len ) ; if ( emac_tpd_num_free_descs ( tx_q ) < ( MAX_SKB_FRAGS + 3 ) ) { netif_stop_queue ( adpt -> netdev ) ; } prod_idx = ( tx_q -> tpd . produce_idx << tx_q -> produce_shift ) & tx_q -> produce_mask ; emac_reg_update32 ( adpt -> base + tx_q -> produce_reg , tx_q -> produce_mask , prod_idx ) ; return NETDEV_TX_OK ; } 