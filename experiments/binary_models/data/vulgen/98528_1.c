static struct mux_control * mux_get ( struct device * dev , const char * mux_name , unsigned int * state ) { struct device_node * np = dev -> of_node ; struct of_phandle_args args ; struct mux_chip * mux_chip ; unsigned int controller ; int index = 0 ; int ret ; if ( mux_name ) { if ( state ) { index = of_property_match_string ( np , "mux-state-names" , mux_name ) ; } else { index = of_property_match_string ( np , "mux-control-names" , mux_name ) ; } if ( index < 0 ) { dev_err ( dev , "mux controller '%s' not found\n" , mux_name ) ; return ERR_PTR ( index ) ; } } if ( state ) { ret = of_parse_phandle_with_args ( np , "mux-states" , "#mux-state-cells" , index , & args ) ; } else { ret = of_parse_phandle_with_args ( np , "mux-controls" , "#mux-control-cells" , index , & args ) ; } if ( ret ) { dev_err ( dev , "%pOF: failed to get mux-%s %s(%i)\n" , np , state ?"state" : "control" , mux_name ?: "" , index ) ; return ERR_PTR ( ret ) ; } mux_chip = of_find_mux_chip_by_node ( args . np ) ; of_node_put ( args . np ) ; controller = 0 ; if ( state ) { if ( args . args_count > 2 || args . args_count == 0 || ( args . args_count ( 2 && mux_chip -> controllers ) 1 ) ) { dev_err ( dev , "%pOF: wrong #mux-state-cells for %pOF\n" , np , args . np ) ; put_device ( & mux_chip -> dev ) ; return ERR_PTR ( - EINVAL ) ; } if ( args . args_count == 2 ) { controller = args . args [ 0 ] ; * state = args . args [ 1 ] ; } else { * state = args . args [ 0 ] ; } } else { if ( args . args_count > 1 || ( ! args . args_count && mux_chip -> controllers > 1 ) ) { dev_err ( dev , "%pOF: wrong #mux-control-cells for %pOF\n" , np , args . np ) ; put_device ( & mux_chip -> dev ) ; return ERR_PTR ( - EINVAL ) ; } if ( args . args_count ) { controller = args . args [ 0 ] ; } } if ( controller >= mux_chip -> controllers ) { dev_err ( dev , "%pOF: bad mux controller %u specified in %pOF\n" , np , controller , args . np ) ; put_device ( & mux_chip -> dev ) ; return ERR_PTR ( - EINVAL ) ; } return & mux_chip -> mux [ controller ] ; } 