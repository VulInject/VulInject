int bsd_scsi_mode_sense ( struct scsi_pkt * pkt ) { union scsi_cdb * cdb = ( scsi_cdb * ) pkt -> pkt_cdbp ; int page_control ; int page_code ; int rval = 0 ; switch ( cdb -> scc_cmd ) { case SCMD_MODE_SENSE : page_code = cdb -> cdb_opaque [ 2 ] & 0x3f ; page_control = ( cdb -> cdb_opaque [ 2 ] >> 6 ) & 0x03 ; if ( emul64debug ) { cmn_err ( CE_CONT , "%s: bsd_scsi_mode_sense: " "page=0x%x control=0x%x nbytes=%d\n" , emul64_name , page_code , page_control , GETG0COUNT ( cdb ) ) ; } break ; case SCMD_MODE_SENSE_G1 : page_code = cdb -> cdb_opaque [ 2 ] & 0x3f ; page_control = ( cdb -> cdb_opaque [ 2 ] >> 6 ) & 0x03 ; if ( emul64debug ) { cmn_err ( CE_CONT , "%s: bsd_scsi_mode_sense: " "page=0x%x control=0x%x nbytes=%d\n" , emul64_name , page_code , page_control , GETG1COUNT ( cdb ) ) ; } break ; default : cmn_err ( CE_CONT , "%s: bsd_scsi_mode_sense: " "cmd 0x%x not supported\n" , emul64_name , cdb -> scc_cmd ) ; return ( EIO ) ; } switch ( page_code ) { case DAD_MODE_GEOMETRY : rval = bsd_mode_sense_dad_mode_geometry ( pkt ) ; break ; case DAD_MODE_ERR_RECOV : break ; case MODEPAGE_DISCO_RECO : rval = bsd_mode_sense_modepage_disco_reco ( pkt ) ; break ; case DAD_MODE_FORMAT : rval = bsd_mode_sense_dad_mode_format ( pkt ) ; break ; case DAD_MODE_CACHE : rval = bsd_mode_sense_dad_mode_cache ( pkt ) ; break ; default : cmn_err ( CE_CONT , "%s: bsd_scsi_mode_sense: " "page 0x%x not supported\n" , emul64_name , page_code ) ; rval = EIO ; break ; } return ( rval ) ; } 