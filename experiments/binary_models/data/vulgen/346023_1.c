void cookie_checker_create_payload ( struct cookie_checker * cc , struct cookie_macs * cm , uint8_t nonce [ COOKIE_NONCE_SIZE ] , uint8_t ecookie [ COOKIE_ENCRYPTED_SIZE ] , struct sockaddr * sa ) { uint8_t cookie [ COOKIE_COOKIE_SIZE ] ; cookie_checker_make_cookie ( cc , cookie , sa ) ; arc4random_buf ( nonce , COOKIE_NONCE_SIZE ) ; rw_enter_read ( & cc -> cc_key_lock ) ; xchacha20poly1305_encrypt ( ecookie , cookie , COOKIE_COOKIE_SIZE , cm -> mac1 , COOKIE_MAC_SIZE , nonce , cc -> cc_cookie_key ) ; rw_exit_read ( & cc -> cc_key_lock ) ; } 