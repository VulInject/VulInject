RPC_CALL_FUNC ( ) { json_t * result , * list , * item ; const char * name , * exception_types ; const char * set_by ; const char * error ; char * usermask , * hostmask ; int soft ; TKL * tkl ; const char * reason ; const char * str ; time_t tkl_expire_at ; time_t tkl_set_at = TStime ( ) ; if ( ! server_ban_exception_select_criteria ( client , request , params , 1 , & name , & exception_types , & usermask , & hostmask , & soft ) ) { return ; } REQUIRE_PARAM_STRING ( "reason" , reason ) ; if ( ( str = json_object_get_string ( params , "duration_string" ) ) ) { tkl_expire_at = config_checkval ( str , CFG_TIME ) ; } if ( ( str = json_object_get_string ( params , "expire_at" ) ) ) { tkl_expire_at = server_time_to_unix_time ( str ) ; } else { tkl_expire_at = 0 ; } OPTIONAL_PARAM_STRING ( "set_by" , set_by ) ; if ( ! set_by ) { set_by = client -> name ; } if ( ( tkl_expire_at != 0 ) && ( tkl_expire_at < TStime ( ) ) ) { rpc_error_fmt ( client , request , JSON_RPC_ERROR_INVALID_PARAMS , "Error: the specified expiry time is before current time (before now)" ) ; return ; } if ( find_tkl_banexception ( TKL_EXCEPTION | TKL_GLOBAL , usermask , hostmask , soft ) || find_tkl_banexception ( TKL_EXCEPTION , usermask , hostmask , soft ) ) { rpc_error ( client , request , JSON_RPC_ERROR_ALREADY_EXISTS , "A ban exception with that mask already exists" ) ; return ; } tkl = tkl_add_banexception ( TKL_EXCEPTION | TKL_GLOBAL , usermask , hostmask , NULL , reason , set_by , tkl_expire_at , tkl_set_at , soft , exception_types , 0 ) ; if ( ! tkl ) { rpc_error ( client , request , JSON_RPC_ERROR_INTERNAL_ERROR , "Unable to add item" ) ; return ; } tkl_added ( client , tkl ) ; result = json_object ( ) ; json_expand_tkl ( result , "tkl" , tkl , 1 ) ; rpc_response ( client , request , result ) ; json_decref ( result ) ; } 