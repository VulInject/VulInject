static void read_from_buf ( struct saa6588 * s , struct saa6588_command * a ) { unsigned char __user * buf_ptr = a -> buffer ; unsigned char buf [ 3 ] ; unsigned long flags ; unsigned int rd_blocks ; unsigned int i ; a -> result = 0 ; while ( ! a -> nonblocking && ! s -> data_available_for_read ) { int ret = wait_event_interruptible ( s -> read_queue , s -> data_available_for_read ) ; if ( ret == - ERESTARTSYS ) { a -> result = - EINTR ; return ; } } rd_blocks = a -> block_count ; spin_lock_irqsave ( & s -> lock , flags ) ; if ( rd_blocks > s -> block_count ) { rd_blocks = s -> block_count ; } spin_unlock_irqrestore ( & s -> lock , flags ) ; if ( ! rd_blocks ) { return ; } for ( i = 0 ; i < rd_blocks ; i ++ ) { bool got_block ; spin_lock_irqsave ( & s -> lock , flags ) ; got_block = block_from_buf ( s , buf ) ; spin_unlock_irqrestore ( & s -> lock , flags ) ; if ( ! got_block ) { break ; } if ( copy_to_user ( buf_ptr , buf , 3 ) ) { a -> result = - EFAULT ; return ; } buf_ptr += 3 ; a -> result += 3 ; } spin_lock_irqsave ( & s -> lock , flags ) ; s -> data_available_for_read = ( s -> block_count > 0 ) ; spin_unlock_irqrestore ( & s -> lock , flags ) ; } 