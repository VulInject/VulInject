int iwpm_register_pid ( struct iwpm_dev_data * pm_msg , u8 nl_client ) { struct sk_buff * skb = NULL ; struct iwpm_nlmsg_request * nlmsg_request = NULL ; struct nlmsghdr * nlh ; u32 msg_seq ; const char * err_str = "" ; int ret = - EINVAL ; if ( ! iwpm_valid_client ( nl_client ) ) { err_str = "Invalid port mapper client" ; pid_query_error } skb = iwpm_create_nlmsg ( RDMA_NL_IWPM_REG_PID , & nlh , nl_client ) ; if ( ! skb ) { err_str = "Unable to create a nlmsg" ; pid_query_error } nlh -> nlmsg_seq = iwpm_get_nlmsg_seq ( ) ; nlmsg_request = iwpm_get_nlmsg_request ( nlh -> nlmsg_seq , nl_client , GFP_KERNEL ) ; if ( ! nlmsg_request ) { err_str = "Unable to allocate netlink request" ; pid_query_error } msg_seq = atomic_read ( & echo_nlmsg_seq ) ; err_str = "Unable to put attribute of the nlmsg" ; ret = ibnl_put_attr ( skb , nlh , sizeof ( u32 ) , & msg_seq , IWPM_NLA_REG_PID_SEQ ) ; if ( ret ) { pid_query_error } ret = ibnl_put_attr ( skb , nlh , IFNAMSIZ , pm_msg -> if_name , IWPM_NLA_REG_IF_NAME ) ; if ( ret ) { pid_query_error } ret = ibnl_put_attr ( skb , nlh , IWPM_DEVNAME_SIZE , pm_msg -> dev_name , IWPM_NLA_REG_IBDEV_NAME ) ; if ( ret ) { pid_query_error } ret = ibnl_put_attr ( skb , nlh , IWPM_ULIBNAME_SIZE , ( char * ) iwpm_ulib_name , IWPM_NLA_REG_ULIB_NAME ) ; if ( ret ) { pid_query_error } pr_debug ( "%s: Multicasting a nlmsg (dev = %s ifname = %s iwpm = %s)\n" , __func__ , pm_msg -> dev_name , pm_msg -> if_name , iwpm_ulib_name ) ; ret = ibnl_multicast ( skb , nlh , RDMA_NL_GROUP_IWPM , GFP_KERNEL ) ; if ( ret ) { skb = NULL ; iwpm_user_pid = IWPM_PID_UNAVAILABLE ; err_str = "Unable to send a nlmsg" ; pid_query_error } nlmsg_request -> req_buffer = pm_msg ; ret = iwpm_wait_complete_req ( nlmsg_request ) ; return ret ; pid_query_error pr_info ( "%s: %s (client = %d)\n" , __func__ , err_str , nl_client ) ; if ( skb ) { dev_kfree_skb ( skb ) ; } if ( nlmsg_request ) { iwpm_free_nlmsg_request ( & nlmsg_request -> kref ) ; } return ret ; } 