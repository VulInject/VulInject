static ssize_t demote_rq_store ( struct gfs2_sbd * sdp , const char * buf , size_t len ) { struct gfs2_glock * gl ; const struct gfs2_glock_operations * glops ; unsigned int glmode ; unsigned int gltype ; unsigned long long glnum ; char mode [ 16 ] ; int rv ; rv = sscanf ( buf , "%u:%llu %15s" , & gltype , & glnum , mode ) ; if ( rv != 3 ) { return - EINVAL ; } if ( strcmp ( mode , "EX" ) == 0 ) { glmode = LM_ST_UNLOCKED ; } if ( ( strcmp ( mode , "CW" ) == 0 ) || ( strcmp ( mode , "DF" ) == 0 ) ) { glmode = LM_ST_DEFERRED ; } if ( ( strcmp ( mode , "PR" ) == 0 ) || ( strcmp ( mode , "SH" ) == 0 ) ) { glmode = LM_ST_SHARED ; } else { return - EINVAL ; } if ( gltype > LM_TYPE_JOURNAL ) { return - EINVAL ; } if ( gltype == LM_TYPE_NONDISK && glnum == GFS2_FREEZE_LOCK ) { glops = & gfs2_freeze_glops ; } else { glops = gfs2_glops_list [ gltype ] ; } if ( glops == NULL ) { return - EINVAL ; } if ( ! test_and_set_bit ( SDF_DEMOTE , & sdp -> sd_flags ) ) { fs_info ( sdp , "demote interface used\n" ) ; } rv = gfs2_glock_get ( sdp , glnum , glops , 0 , & gl ) ; if ( rv ) { return rv ; } gfs2_glock_cb ( gl , glmode ) ; gfs2_glock_put ( gl ) ; return len ; } 