static inline size_t lfib_nlmsg_size ( struct mpls_route * rt ) { size_t payload = NLMSG_ALIGN ( sizeof ( rtmsg ) ) + nla_total_size ( 4 ) + nla_total_size ( 1 ) ; if ( rt -> rt_nhn == 1 ) { struct mpls_nh * nh = rt -> rt_nh ; if ( nh -> nh_dev ) { payload += nla_total_size ( 4 ) ; } if ( nh -> nh_via_table != MPLS_NEIGH_TABLE_UNSPEC ) { payload += nla_total_size ( 2 + nh -> nh_via_alen ) ; } if ( nh -> nh_labels ) { payload += nla_total_size ( nh -> nh_labels * 4 ) ; } } else { size_t nhsize = 0 ; for_nexthops ( ) { if ( ! rtnl_dereference ( nh -> nh_dev ) ) { continue ; } nhsize += nla_total_size ( sizeof ( rtnexthop ) ) ; if ( nh -> nh_labels ) { nhsize += nla_total_size ( nh -> nh_labels * 4 ) ; } } endfor_nexthops ( rt ) ; payload += nla_total_size ( nhsize ) ; } return payload ; } 