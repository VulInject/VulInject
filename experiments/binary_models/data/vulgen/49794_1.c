static ssize_t ahci_read_em_buffer ( struct device * dev , struct device_attribute * attr , char * buf ) { struct Scsi_Host * shost = class_to_shost ( dev ) ; struct ata_port * ap = ata_shost_to_port ( shost ) ; struct ahci_host_priv * hpriv = ap -> host -> private_data ; void __iomem * mmio = hpriv -> mmio ; void __iomem * em_mmio = mmio + hpriv -> em_loc ; u32 em_ctl , msg ; unsigned long flags ; size_t count ; int i ; ahci_rpm_get_port ( ap ) ; spin_lock_irqsave ( ap -> lock , flags ) ; em_ctl = readl ( mmio + HOST_EM_CTL ) ; if ( ! ( ap -> flags & ATA_FLAG_EM ) || em_ctl & EM_CTL_XMT || ! ( hpriv -> em_msg_type & EM_MSG_TYPE_SGPIO ) ) { spin_unlock_irqrestore ( ap -> lock , flags ) ; ahci_rpm_put_port ( ap ) ; return - EINVAL ; } if ( ! ( em_ctl & EM_CTL_MR ) ) { spin_unlock_irqrestore ( ap -> lock , flags ) ; ahci_rpm_put_port ( ap ) ; return - EAGAIN ; } if ( ! ( em_ctl & EM_CTL_SMB ) ) { em_mmio += hpriv -> em_buf_sz ; } count = hpriv -> em_buf_sz ; for ( i = 0 ; i < count ; i += 4 ) { msg = readl ( em_mmio + i ) ; buf [ i ] = msg & 0xff ; buf [ i + 1 ] = ( msg >> 8 ) & 0xff ; buf [ i + 2 ] = ( msg >> 16 ) & 0xff ; buf [ i + 3 ] = ( msg >> 24 ) & 0xff ; } spin_unlock_irqrestore ( ap -> lock , flags ) ; ahci_rpm_put_port ( ap ) ; return i ; } 