static void stm32f7_i2c_xfer_msg ( struct stm32f7_i2c_dev * i2c_dev , struct i2c_msg * msg ) { struct stm32f7_i2c_msg * f7_msg = & i2c_dev -> f7_msg ; void __iomem * base = i2c_dev -> base ; u32 cr1 , cr2 ; int ret ; f7_msg -> addr = msg -> addr ; f7_msg -> buf = msg -> buf ; f7_msg -> count = msg -> len ; f7_msg -> result = 0 ; reinit_completion ( & i2c_dev -> complete ) ; cr1 = readl_relaxed ( base + STM32F7_I2C_CR1 ) ; cr2 = readl_relaxed ( base + STM32F7_I2C_CR2 ) ; cr2 &= ~ STM32F7_I2C_CR2_RD_WRN ; if ( msg -> flags & I2C_M_RD ) { cr2 |= STM32F7_I2C_CR2_RD_WRN ; } cr2 &= ~ ( STM32F7_I2C_CR2_HEAD10R | STM32F7_I2C_CR2_ADD10 ) ; if ( msg -> flags & I2C_M_TEN ) { cr2 &= ~ STM32F7_I2C_CR2_SADD10_MASK ; cr2 |= STM32F7_I2C_CR2_SADD10 ( f7_msg -> addr ) ; cr2 |= STM32F7_I2C_CR2_ADD10 ; } else { cr2 &= ~ STM32F7_I2C_CR2_SADD7_MASK ; cr2 |= STM32F7_I2C_CR2_SADD7 ( f7_msg -> addr ) ; } cr2 &= ~ ( STM32F7_I2C_CR2_NBYTES_MASK | STM32F7_I2C_CR2_RELOAD ) ; if ( f7_msg -> count > STM32F7_I2C_MAX_LEN ) { cr2 |= STM32F7_I2C_CR2_NBYTES ( STM32F7_I2C_MAX_LEN ) ; cr2 |= STM32F7_I2C_CR2_RELOAD ; } else { cr2 |= STM32F7_I2C_CR2_NBYTES ( f7_msg -> count ) ; } cr1 |= STM32F7_I2C_CR1_ERRIE | STM32F7_I2C_CR1_TCIE | STM32F7_I2C_CR1_STOPIE | STM32F7_I2C_CR1_NACKIE ; cr1 &= ~ ( STM32F7_I2C_CR1_RXIE | STM32F7_I2C_CR1_TXIE | STM32F7_I2C_CR1_RXDMAEN | STM32F7_I2C_CR1_TXDMAEN ) ; i2c_dev -> use_dma = false ; if ( i2c_dev -> dma && f7_msg -> count >= STM32F7_I2C_DMA_LEN_MIN ) { ret = stm32_i2c_prep_dma_xfer ( i2c_dev -> dev , i2c_dev -> dma , msg -> flags & I2C_M_RD , f7_msg -> count , f7_msg -> buf , stm32f7_i2c_dma_callback , i2c_dev ) ; if ( ! ret ) { i2c_dev -> use_dma = true ; } else { dev_warn ( i2c_dev -> dev , "can't use DMA\n" ) ; } } if ( ! i2c_dev -> use_dma ) { if ( msg -> flags & I2C_M_RD ) { cr1 |= STM32F7_I2C_CR1_RXIE ; } else { cr1 |= STM32F7_I2C_CR1_TXIE ; } } else { if ( msg -> flags & I2C_M_RD ) { cr1 |= STM32F7_I2C_CR1_RXDMAEN ; } else { cr1 |= STM32F7_I2C_CR1_TXDMAEN ; } } cr2 |= STM32F7_I2C_CR2_START ; i2c_dev -> master_mode = true ; writel_relaxed ( cr1 , base + STM32F7_I2C_CR1 ) ; writel_relaxed ( cr2 , base + STM32F7_I2C_CR2 ) ; } 