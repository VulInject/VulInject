void load_hostkeys_command ( struct hostkeys * hostkeys , const char * command_template , const char * invocation , const struct ssh_conn_info * cinfo , const struct sshkey * host_key , const char * hostfile_hostname ) { int r , i , ac = 0 ; char * key_fp = NULL , * keytext = NULL , * tmp ; char * command = NULL , * tag = NULL , * * av = NULL ; FILE * f = NULL ; pid_t pid ; void * osigchld ( int ) xasprintf ( & tag , "KnownHostsCommand-%s" , invocation ) ; if ( host_key != NULL ) { if ( ( key_fp = sshkey_fingerprint ( host_key , options . fingerprint_hash , SSH_FP_DEFAULT ) ) == NULL ) { fatal_f ( "sshkey_fingerprint failed" ) ; } if ( ( r = sshkey_to_base64 ( host_key , & keytext ) ) != 0 ) { fatal_fr ( r , "sshkey_to_base64 failed" ) ; } } osigchld = ssh_signal ( SIGCHLD , SIG_DFL ) ; if ( argv_split ( command_template , & ac , & av , 0 ) != 0 ) { error ( "%s \"%s\" contains invalid quotes" , tag , command_template ) ; out } if ( ac == 0 ) { error ( "%s \"%s\" yielded no arguments" , tag , command_template ) ; out } for ( i = 1 ; i < ac ; i ++ ) { tmp = percent_dollar_expand ( av [ i ] , DEFAULT_CLIENT_PERCENT_EXPAND_ARGS ( cinfo ) , "H" , hostfile_hostname , "I" , invocation , "t" , host_key == NULL ?"NONE" : sshkey_ssh_name ( host_key ) , "f" , key_fp == NULL ?"NONE" : key_fp , "K" , keytext == NULL ?"NONE" : keytext , ( char * ) NULL ) ; if ( tmp == NULL ) { fatal_f ( "percent_expand failed" ) ; } free ( av [ i ] ) ; av [ i ] = tmp ; } command = argv_assemble ( ac , av ) ; if ( ( pid = subprocess ( tag , command , ac , av , & f , SSH_SUBPROCESS_STDOUT_CAPTURE | SSH_SUBPROCESS_UNSAFE_PATH | SSH_SUBPROCESS_PRESERVE_ENV , NULL , NULL , NULL ) ) == 0 ) { out } load_hostkeys_file ( hostkeys , hostfile_hostname , tag , f , 1 ) ; if ( exited_cleanly ( pid , tag , command , 0 ) != 0 ) { fatal ( "KnownHostsCommand failed" ) ; } out ssh_signal ( SIGCHLD , osigchld ) ; for ( i = 0 ; i < ac ; i ++ ) { free ( av [ i ] ) ; } free ( av ) ; free ( tag ) ; free ( command ) ; free ( key_fp ) ; free ( keytext ) ; } 