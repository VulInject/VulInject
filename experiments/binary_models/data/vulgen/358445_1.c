int ul_add_domain_db ( str * d , int t , str * url ) { ul_domain_db_list_t * new_d = NULL ; LM_DBG ( "%.*s, type: %s\n" , d -> len , d -> s , t == DB_TYPE_SINGLE ?"SINGLE" : "CLUSTER" ) ; if ( ( new_d = pkg_malloc ( sizeof ( ul_domain_db_list_t ) ) ) == NULL ) { return - 1 ; } if ( ! d || ! d -> s ) { error } if ( ( new_d -> domain . name . s = pkg_malloc ( d -> len + 1 ) ) == NULL ) { error } if ( t == DB_TYPE_SINGLE ) { if ( url ) { LM_DBG ( "url: %.*s" , url -> len , url -> s ) ; if ( ( new_d -> domain . url . s = pkg_malloc ( url -> len + 1 ) ) == NULL ) { error } strncpy ( new_d -> domain . url . s , url -> s , url -> len ) ; new_d -> domain . url . s [ url -> len ] = '\0' ; new_d -> domain . url . len = url -> len ; } else { if ( ( new_d -> domain . url . s = pkg_malloc ( default_db_url . len + 1 ) ) == NULL ) { error } strcpy ( new_d -> domain . url . s , default_db_url . s ) ; new_d -> domain . url . len = default_db_url . len ; } } strncpy ( new_d -> domain . name . s , d -> s , d -> len ) ; new_d -> domain . name . len = d -> len ; new_d -> domain . dbt = t ; new_d -> next = domain_db_list ; domain_db_list = new_d ; return 1 ; error pkg_free ( new_d ) ; return - 1 ; } 