static void smtp_setup_listener_tls ( struct listener * l ) { static const char * dheparams [ ] { "none" "auto" "legacy" } ; ; struct tls_config * config ; const char * ciphers ; uint32_t protos ; struct pki * pki ; struct ca * ca ; int i ; if ( ( config = tls_config_new ( ) ) == NULL ) { fatal ( "smtpd: tls_config_new" ) ; } ciphers = env -> sc_tls_ciphers ; if ( l -> tls_ciphers ) { ciphers = l -> tls_ciphers ; } if ( ciphers && tls_config_set_ciphers ( config , ciphers ) == - 1 ) { fatal ( "%s" , tls_config_error ( config ) ) ; } if ( l -> tls_protocols ) { if ( tls_config_parse_protocols ( & protos , l -> tls_protocols ) == - 1 ) { fatal ( "failed to parse protocols \"%s\"" , l -> tls_protocols ) ; } if ( tls_config_set_protocols ( config , protos ) == - 1 ) { fatal ( "%s" , tls_config_error ( config ) ) ; } } pki = l -> pki [ 0 ] ; if ( pki == NULL ) { fatal ( "no pki defined" ) ; } if ( tls_config_set_dheparams ( config , dheparams [ pki -> pki_dhe ] ) == - 1 ) { fatal ( "tls_config_set_dheparams" ) ; } tls_config_use_fake_private_key ( config ) ; for ( i = 0 ; i < l -> pkicount ; i ++ ) { pki = l -> pki [ i ] ; if ( i == 0 ) { if ( tls_config_set_keypair_mem ( config , pki -> pki_cert , pki -> pki_cert_len , NULL , 0 ) == - 1 ) { fatal ( "tls_config_set_keypair_mem" ) ; } } else { if ( tls_config_add_keypair_mem ( config , pki -> pki_cert , pki -> pki_cert_len , NULL , 0 ) == - 1 ) { fatal ( "tls_config_add_keypair_mem" ) ; } } } l -> pkicount = 0 ; if ( l -> ca_name [ 0 ] ) { ca = dict_get ( env -> sc_ca_dict , l -> ca_name ) ; if ( tls_config_set_ca_mem ( config , ca -> ca_cert , ca -> ca_cert_len ) == - 1 ) { fatal ( "tls_config_set_ca_mem" ) ; } } if ( tls_config_set_ca_file ( config , tls_default_ca_cert_file ( ) ) == - 1 ) { fatal ( "tls_config_set_ca_file" ) ; } if ( l -> flags & F_TLS_VERIFY ) { tls_config_verify_client ( config ) ; } l -> tls = tls_server ( ) ; if ( l -> tls == NULL ) { fatal ( "tls_server" ) ; } if ( tls_configure ( l -> tls , config ) == - 1 ) { fatal ( "tls_configure: %s" , tls_error ( l -> tls ) ) ; } tls_config_free ( config ) ; } 