static void vsp1_video_stop_streaming ( struct vb2_queue * vq ) { struct vsp1_video * video = vb2_get_drv_priv ( vq ) ; struct vsp1_pipeline * pipe = video -> rwpf -> pipe ; struct vsp1_vb2_buffer * buffer ; unsigned long flags ; int ret ; spin_lock_irqsave ( & video -> irqlock , flags ) ; pipe -> buffers_ready &= ~ ( 1 << video -> pipe_index ) ; spin_unlock_irqrestore ( & video -> irqlock , flags ) ; mutex_lock ( & pipe -> lock ) ; if ( -- pipe -> stream_count == pipe -> num_inputs ) { ret = vsp1_pipeline_stop ( pipe ) ; if ( ret == - ETIMEDOUT ) { dev_err ( video -> vsp1 -> dev , "pipeline stop timeout\n" ) ; } vsp1_dl_list_put ( pipe -> dl ) ; pipe -> dl = NULL ; } mutex_unlock ( & pipe -> lock ) ; media_pipeline_stop ( & video -> video . entity ) ; vsp1_video_pipeline_put ( pipe ) ; spin_lock_irqsave ( & video -> irqlock , flags ) ; list_for_each_entry ( , , ) vb2_buffer_done ( & buffer -> buf . vb2_buf , VB2_BUF_STATE_ERROR ) ; spin_unlock_irqrestore ( & video -> irqlock , flags ) ; } 