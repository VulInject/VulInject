int wg_socket_endpoint_from_skb ( struct endpoint * endpoint , const struct sk_buff * skb ) { if ( skb -> protocol == htons ( ETH_P_IP ) ) { endpoint -> addr4 . sin_family = AF_INET ; endpoint -> addr4 . sin_port = udp_hdr ( skb ) -> source ; endpoint -> addr4 . sin_addr . s_addr = ip_hdr ( skb ) -> saddr ; endpoint -> src4 . s_addr = ip_hdr ( skb ) -> daddr ; endpoint -> src_if4 = skb -> skb_iif ; } if ( IS_ENABLED ( CONFIG_IPV6 ) && skb -> protocol == htons ( ETH_P_IPV6 ) ) { endpoint -> addr6 . sin6_family = AF_INET6 ; endpoint -> addr6 . sin6_port = udp_hdr ( skb ) -> source ; endpoint -> addr6 . sin6_addr = ipv6_hdr ( skb ) -> saddr ; endpoint -> addr6 . sin6_scope_id = ipv6_iface_scope_id ( & ipv6_hdr ( skb ) -> saddr , skb -> skb_iif ) ; endpoint -> src6 = ipv6_hdr ( skb ) -> daddr ; } else { return - EINVAL ; } return 0 ; } 