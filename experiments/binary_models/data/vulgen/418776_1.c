static int qcow2_get_subcluster_range_type ( BlockDriverState * bs , uint64_t l2_entry , uint64_t l2_bitmap , unsigned sc_from , QCow2SubclusterType * type ) { BDRVQcow2State * s = bs -> opaque ; uint32_t val ; * type = qcow2_get_subcluster_type ( bs , l2_entry , l2_bitmap , sc_from ) ; if ( * type == QCOW2_SUBCLUSTER_INVALID ) { return - EINVAL ; } if ( ! has_subclusters ( s ) || * type == QCOW2_SUBCLUSTER_COMPRESSED ) { return s -> subclusters_per_cluster - sc_from ; } switch ( * type ) { case QCOW2_SUBCLUSTER_NORMAL : val = l2_bitmap | QCOW_OFLAG_SUB_ALLOC_RANGE ( 0 , sc_from ) ; return cto32 ( val ) - sc_from ; case QCOW2_SUBCLUSTER_ZERO_PLAIN : case QCOW2_SUBCLUSTER_ZERO_ALLOC : val = ( l2_bitmap | QCOW_OFLAG_SUB_ZERO_RANGE ( 0 , sc_from ) ) >> 32 ; return cto32 ( val ) - sc_from ; case QCOW2_SUBCLUSTER_UNALLOCATED_PLAIN : case QCOW2_SUBCLUSTER_UNALLOCATED_ALLOC : val = ( ( l2_bitmap >> 32 ) | l2_bitmap ) & ~ QCOW_OFLAG_SUB_ALLOC_RANGE ( 0 , sc_from ) ; return ctz32 ( val ) - sc_from ; default : } } 