static void wacom_mode_change_work ( struct work_struct * work ) { struct wacom * wacom = container_of ( work , wacom , mode_change_work ) ; struct wacom_shared * shared = wacom -> wacom_wac . shared ; struct wacom * wacom1 = NULL ; struct wacom * wacom2 = NULL ; bool is_direct = wacom -> wacom_wac . is_direct_mode ; int error = 0 ; if ( shared -> pen ) { wacom1 = hid_get_drvdata ( shared -> pen ) ; wacom_release_resources ( wacom1 ) ; hid_hw_stop ( wacom1 -> hdev ) ; wacom1 -> wacom_wac . has_mode_change = true ; wacom1 -> wacom_wac . is_direct_mode = is_direct ; } if ( shared -> touch ) { wacom2 = hid_get_drvdata ( shared -> touch ) ; wacom_release_resources ( wacom2 ) ; hid_hw_stop ( wacom2 -> hdev ) ; wacom2 -> wacom_wac . has_mode_change = true ; wacom2 -> wacom_wac . is_direct_mode = is_direct ; } if ( wacom1 ) { error = wacom_parse_and_register ( wacom1 , false ) ; if ( error ) { return ; } } return ; } 