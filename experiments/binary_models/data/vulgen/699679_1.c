static int nx842_pseries_compress ( const unsigned char * in , unsigned int inlen , unsigned char * out , unsigned int * outlen , void * wmem ) { struct nx842_devdata * local_devdata ; struct device * dev = NULL ; struct nx842_workmem * workmem ; struct nx842_scatterlist slin , slout ; struct nx_csbcpb * csbcpb ; int ret = 0 , max_sync_size ; unsigned long inbuf , outbuf ; struct vio_pfo_op op = { . done = NULL . handle = 0 . timeout = 0 } ; unsigned long start = get_tb ( ) ; inbuf = ( unsigned long ) in ; if ( check_constraints ( inbuf , & inlen , true ) ) { return - EINVAL ; } outbuf = ( unsigned long ) out ; if ( check_constraints ( outbuf , outlen , false ) ) { return - EINVAL ; } rcu_read_lock ( ) ; local_devdata = rcu_dereference ( devdata ) ; if ( ! local_devdata || ! local_devdata -> dev ) { rcu_read_unlock ( ) ; return - ENODEV ; } max_sync_size = local_devdata -> max_sync_size ; dev = local_devdata -> dev ; workmem = PTR_ALIGN ( wmem , WORKMEM_ALIGN ) ; slin . entries = ( nx842_slentry * ) workmem -> slin ; slout . entries = ( nx842_slentry * ) workmem -> slout ; op . flags = NX842_OP_COMPRESS_CRC ; csbcpb = & workmem -> csbcpb ; op . csbcpb = nx842_get_pa ( csbcpb ) ; if ( ( inbuf & NX842_HW_PAGE_MASK ) == ( ( inbuf + inlen - 1 ) & NX842_HW_PAGE_MASK ) ) { op . in = nx842_get_pa ( ( void * ) inbuf ) ; op . inlen = inlen ; } else { nx842_build_scatterlist ( inbuf , inlen , & slin ) ; op . in = nx842_get_pa ( slin . entries ) ; op . inlen = - nx842_get_scatterlist_size ( & slin ) ; } if ( ( outbuf & NX842_HW_PAGE_MASK ) == ( ( outbuf + * outlen - 1 ) & NX842_HW_PAGE_MASK ) ) { op . out = nx842_get_pa ( ( void * ) outbuf ) ; op . outlen = * outlen ; } else { nx842_build_scatterlist ( outbuf , * outlen , & slout ) ; op . out = nx842_get_pa ( slout . entries ) ; op . outlen = - nx842_get_scatterlist_size ( & slout ) ; } dev_dbg ( dev , "%s: op.in %lx op.inlen %ld op.out %lx op.outlen %ld\n" , __func__ , ( unsigned long ) op . in , ( long ) op . inlen , ( unsigned long ) op . out , ( long ) op . outlen ) ; ret = vio_h_cop_sync ( local_devdata -> vdev , & op ) ; if ( ret ) { dev_dbg ( dev , "%s: vio_h_cop_sync error (ret=%d, hret=%ld)\n" , __func__ , ret , op . hcall_err ) ; ret = - EIO ; unlock } ret = nx842_validate_result ( dev , & csbcpb -> csb ) ; if ( ret ) { unlock } * outlen = be32_to_cpu ( csbcpb -> csb . processed_byte_count ) ; dev_dbg ( dev , "%s: processed_bytes=%d\n" , __func__ , * outlen ) ; unlock if ( ret ) { nx842_inc_comp_failed ( local_devdata ) ; } else { nx842_inc_comp_complete ( local_devdata ) ; ibm_nx842_incr_hist ( local_devdata -> counters -> comp_times , ( get_tb ( ) - start ) / tb_ticks_per_usec ) ; } rcu_read_unlock ( ) ; return ret ; } 