static int qlcnic_sriov_pf_init ( struct qlcnic_adapter * adapter ) { struct qlcnic_hardware_context * ahw = adapter -> ahw ; struct qlcnic_info nic_info , pf_info , vp_info ; int err ; u8 func = ahw -> pci_func ; err = qlcnic_sriov_pf_cfg_vlan_filtering ( adapter , 1 ) ; if ( err ) { return err ; } if ( qlcnic_84xx_check ( adapter ) ) { err = qlcnic_sriov_pf_cfg_flood ( adapter ) ; if ( err ) { disable_vlan_filtering } } err = qlcnic_sriov_pf_cfg_eswitch ( adapter , func , 1 ) ; if ( err ) { disable_vlan_filtering } err = qlcnic_sriov_pf_config_vport ( adapter , 1 , func ) ; if ( err ) { disable_eswitch } err = qlcnic_sriov_get_pf_info ( adapter , & pf_info ) ; if ( err ) { delete_vport } err = qlcnic_get_nic_info ( adapter , & nic_info , func ) ; if ( err ) { delete_vport } err = qlcnic_sriov_pf_cal_res_limit ( adapter , & vp_info , func ) ; if ( err ) { delete_vport } err = qlcnic_sriov_cfg_bc_intr ( adapter , 1 ) ; if ( err ) { delete_vport } ahw -> physical_port = ( u8 ) nic_info . phys_port ; ahw -> switch_mode = nic_info . switch_mode ; ahw -> max_mtu = nic_info . max_mtu ; ahw -> capabilities = nic_info . capabilities ; ahw -> nic_mode = QLC_83XX_SRIOV_MODE ; return err ; delete_vport qlcnic_sriov_pf_config_vport ( adapter , 0 , func ) ; disable_eswitch qlcnic_sriov_pf_cfg_eswitch ( adapter , func , 0 ) ; disable_vlan_filtering qlcnic_sriov_pf_cfg_vlan_filtering ( adapter , 0 ) ; return err ; } 