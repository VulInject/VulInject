char * get_correct_jobname ( const char * jobid ) { char * correct = NULL ; char * dot ; char * work_jobid = strdup ( jobid ) ; char * first_suffix = NULL ; char * second_suffix = NULL ; int server_suffix = TRUE ; int len ; bool display_suffix = true ; char * alias = NULL ; get_svr_attr_b ( SRV_ATR_display_job_server_suffix , & display_suffix ) ; if ( display_suffix == FALSE ) { server_suffix = FALSE ; } if ( ( dot = strchr ( ( char * ) work_jobid , '.' ) ) != NULL ) { first_suffix = dot + 1 ; if ( ( dot = strchr ( first_suffix , '.' ) ) != NULL ) { second_suffix = dot + 1 ; } dot = NULL ; } get_svr_attr_str ( SRV_ATR_job_suffix_alias , & alias ) ; if ( ( alias != NULL ) && ( server_suffix == TRUE ) ) { if ( second_suffix != NULL ) { if ( strcmp ( second_suffix , alias ) == 0 ) { correct = strdup ( jobid ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; } return ( correct ) ; } } if ( first_suffix == NULL ) { len = strlen ( work_jobid ) + strlen ( server_name ) + strlen ( alias ) + 3 ; correct = ( char * ) calloc ( 1 , len ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; free ( work_jobid ) ; return ( NULL ) ; } snprintf ( correct , len , "%s.%s.%s" , work_jobid , server_name , alias ) ; } else { len = strlen ( alias ) + 2 + strlen ( work_jobid ) ; correct = ( char * ) calloc ( 1 , len ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; free ( work_jobid ) ; return ( NULL ) ; } snprintf ( correct , len , "%s.%s" , work_jobid , alias ) ; } } if ( server_suffix == TRUE ) { if ( first_suffix != NULL ) { correct = strdup ( work_jobid ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; free ( work_jobid ) ; return ( NULL ) ; } } else { len = strlen ( work_jobid ) + strlen ( server_name ) + 2 ; correct = ( char * ) calloc ( 1 , len ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; free ( work_jobid ) ; return ( NULL ) ; } snprintf ( correct , len , "%s.%s" , work_jobid , server_name ) ; } } if ( alias != NULL ) { if ( first_suffix == NULL ) { len = strlen ( work_jobid ) + strlen ( alias ) + 2 ; correct = ( char * ) calloc ( 1 , len ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; free ( work_jobid ) ; return ( NULL ) ; } snprintf ( correct , len , "%s.%s" , work_jobid , alias ) ; } else { len = strlen ( alias ) + 2 ; dot = first_suffix - 1 ; * dot = '\0' ; len += strlen ( work_jobid ) ; correct = ( char * ) calloc ( 1 , len ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; free ( work_jobid ) ; return ( NULL ) ; } snprintf ( correct , len , "%s.%s" , work_jobid , alias ) ; * dot = '.' ; } } else { if ( first_suffix != NULL ) { dot = first_suffix - 1 ; * dot = '\0' ; } len = strlen ( work_jobid ) + 1 ; correct = ( char * ) calloc ( 1 , len ) ; if ( correct == NULL ) { log_err ( - 1 , __func__ , "ERROR:    Fatal - Cannot allocate memory\n" ) ; free ( work_jobid ) ; return ( NULL ) ; } snprintf ( correct , len , "%s" , work_jobid ) ; if ( first_suffix != NULL ) { * dot = '.' ; } } free ( work_jobid ) ; return ( correct ) ; } job * find_job_by_array ( all_jobs * aj , const char * job_id , int get_subjob , bool locked ) { job * pj = NULL ; if ( aj == NULL ) { log_err ( PBSE_BAD_PARAMETER , __func__ , "null struct all_jobs pointer fail" ) ; return ( NULL ) ; } if ( job_id == NULL ) { log_err ( PBSE_BAD_PARAMETER , __func__ , "null job_id pointer fail" ) ; return ( NULL ) ; } if ( locked == false ) { aj -> lock ( ) ; } pj = aj -> find ( job_id ) ; if ( locked == false ) { aj -> unlock ( ) ; } if ( pj != NULL ) { lock_ji_mutex ( pj , __func__ , NULL , LOGLEVEL ) ; if ( get_subjob == TRUE ) { if ( pj -> ji_cray_clone != NULL ) { pj = pj -> ji_cray_clone ; unlock_ji_mutex ( pj -> ji_parent_job , __func__ , NULL , LOGLEVEL ) ; lock_ji_mutex ( pj , __func__ , NULL , LOGLEVEL ) ; } } if ( pj -> ji_being_recycled == true ) { unlock_ji_mutex ( pj , __func__ , "1" , LOGLEVEL ) ; pj = NULL ; } } return ( pj ) ; } job * svr_find_job ( const char * jobid , int get_subjob ) { char * at ; char * comp = NULL ; int different = FALSE ; char * dash = NULL ; char * dot = NULL ; char without_dash [ PBS_MAXSVRJOBID + 1 ] ; char work_jobid [ PBS_MAXSVRJOBID + 1 ] ; char * jid_ptr = NULL ; job * pj = NULL ; if ( NULL == jobid ) { log_err ( - 1 , __func__ , "jobid is null" ) ; return NULL ; } if ( LOGLEVEL >= 10 ) { LOG_EVENT ( PBSEVENT_JOB , PBS_EVENTCLASS_JOB , __func__ , jobid ) ; } snprintf ( work_jobid , sizeof ( work_jobid ) , "%s" , jobid ) ; if ( ( at = strchr ( work_jobid , '@' ) ) != NULL ) { * at = '\0' ; } if ( get_subjob == TRUE ) { dot = strchr ( work_jobid , '.' ) ; if ( ( ( dash = strchr ( work_jobid , '-' ) ) != NULL ) && ( dot != NULL ) && ( dash < dot ) ) { * dash = '\0' ; snprintf ( without_dash , sizeof ( without_dash ) , "%s%s" , work_jobid , dash + 2 ) ; jid_ptr = without_dash ; } else { dash = NULL ; jid_ptr = work_jobid ; } } else { jid_ptr = work_jobid ; } if ( ( is_svr_attr_set ( SRV_ATR_display_job_server_suffix ) ) || ( is_svr_attr_set ( SRV_ATR_job_suffix_alias ) ) ) { comp = get_correct_jobname ( jid_ptr ) ; different = TRUE ; if ( comp == NULL ) { return ( NULL ) ; } } else { comp = jid_ptr ; } if ( strstr ( jid_ptr , "[]" ) == NULL ) { pj = find_job_by_array ( & alljobs , comp , ( dash != NULL ) ?FALSE : get_subjob , false ) ; } if ( pj == NULL ) { } } 