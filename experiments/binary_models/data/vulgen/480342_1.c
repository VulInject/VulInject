int delete_unused_tunnels ( ) { int rval , len = 0 ; void * buf = NULL ; rval = ul . get_all_ucontacts ( buf , len , 0 , 0 , 1 ) ; LM_DBG ( "Minimum required size %d\n" , rval ) ; if ( rval < 0 ) { LM_ERR ( "Failed to fetch contacts\n" ) ; return 1 ; } if ( rval > 0 ) { len = rval * 2 ; buf = malloc ( len ) ; if ( buf == NULL ) { LM_ERR ( "Out of memory\n" ) ; return 1 ; } rval = ul . get_all_ucontacts ( buf , len , 0 , 0 , 1 ) ; if ( rval != 0 ) { free ( buf ) ; return 1 ; } } if ( buf == NULL ) { return 1 ; } struct mnl_socket * sock = init_mnl_socket ( ) ; delete_unused_sa ( sock , buf ) ; delete_unused_policy ( sock , buf ) ; close_mnl_socket ( sock ) ; free ( buf ) ; return 0 ; } 