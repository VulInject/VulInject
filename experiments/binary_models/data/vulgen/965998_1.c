static int cxgb4_matchall_alloc_filter ( struct net_device * dev , struct tc_cls_matchall_offload * cls ) { struct cxgb4_tc_port_matchall * tc_port_matchall ; struct port_info * pi = netdev2pinfo ( dev ) ; struct adapter * adap = netdev2adap ( dev ) ; int ret , i ; tc_port_matchall = & adap -> tc_matchall -> port_matchall [ pi -> port_id ] ; ret = cxgb4_matchall_mirror_alloc ( dev , cls ) ; for ( i = 0 ; i < CXGB4_FILTER_TYPE_MAX ; i ++ ) { ret = cxgb4_matchall_add_filter ( dev , cls , i ) ; if ( ret ) { out_free } } tc_port_matchall -> ingress . state = CXGB4_MATCHALL_STATE_ENABLED ; return 0 ; out_free while ( i -- > 0 ) { cxgb4_matchall_del_filter ( dev , i ) ; } cxgb4_matchall_mirror_free ( dev ) ; return ret ; } 