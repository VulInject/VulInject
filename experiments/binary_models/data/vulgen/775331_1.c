void hv_open ( void ) { struct hvctl_msg msg ; ssize_t nbytes ; uint64_t code ; if ( hvctl_fd == - 1 ) { err ( 1 , "cannot open /dev/hvctl" ) ; } bzero ( & msg , sizeof ( msg ) ) ; msg . hdr . op = HVCTL_OP_HELLO ; msg . hdr . seq = hvctl_seq ++ ; msg . msg . hello . major = 1 ; nbytes = write ( hvctl_fd , & msg , sizeof ( msg ) ) ; if ( nbytes != sizeof ( msg ) ) { err ( 1 , "write" ) ; } bzero ( & msg , sizeof ( msg ) ) ; nbytes = read ( hvctl_fd , & msg , sizeof ( msg ) ) ; if ( nbytes != sizeof ( msg ) ) { err ( 1 , "read" ) ; } code = msg . msg . clnge . code ^ 0xbadbeef20 ; bzero ( & msg , sizeof ( msg ) ) ; msg . hdr . op = HVCTL_OP_RESPONSE ; msg . hdr . seq = hvctl_seq ++ ; msg . msg . clnge . code = code ^ 0x12cafe42a ; nbytes = write ( hvctl_fd , & msg , sizeof ( msg ) ) ; if ( nbytes != sizeof ( msg ) ) { err ( 1 , "write" ) ; } bzero ( & msg , sizeof ( msg ) ) ; nbytes = read ( hvctl_fd , & msg , sizeof ( msg ) ) ; if ( nbytes != sizeof ( msg ) ) { err ( 1 , "read" ) ; } } 