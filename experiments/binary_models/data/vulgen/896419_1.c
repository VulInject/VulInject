AP_DECLARE ( ) ap_regkey_value_get ( , , , ) { LONG rc ; DWORD type ; apr_size_t size = 0 ; IF_WIN_OS_IS_UNICODE { apr_size_t valuelen = strlen ( valuename ) + 1 ; apr_size_t wvallen = 256 ; apr_wchar_t wvalname [ 256 ] ; apr_wchar_t * wvalue ; apr_status_t rv ; rv = apr_conv_utf8_to_ucs2 ( valuename , & valuelen , wvalname , & wvallen ) ; if ( rv != APR_SUCCESS ) { return rv ; } rc = RegQueryValueExW ( key -> hkey , wvalname , 0 , & type , NULL , ( DWORD * ) & size ) ; if ( rc != ERROR_SUCCESS ) { return APR_FROM_OS_ERROR ( rc ) ; } if ( ( size < 2 ) || ( type != REG_SZ && type != REG_EXPAND_SZ ) ) { return APR_FROM_OS_ERROR ( ERROR_INVALID_PARAMETER ) ; } wvalue = apr_palloc ( pool , size ) ; rc = RegQueryValueExW ( key -> hkey , wvalname , 0 , & type , ( LPBYTE ) wvalue , ( DWORD * ) & size ) ; if ( rc != ERROR_SUCCESS ) { return APR_FROM_OS_ERROR ( rc ) ; } if ( type == REG_EXPAND_SZ ) { apr_wchar_t zbuf [ 1 ] ; size = ExpandEnvironmentStringsW ( wvalue , zbuf , 0 ) ; if ( size ) { apr_wchar_t * tmp = wvalue ; wvalue = apr_palloc ( pool , size * 2 ) ; size = ExpandEnvironmentStringsW ( tmp , wvalue , ( DWORD ) size ) ; } } else { size /= 2 ; } valuelen = ( size - 1 ) * 3 + 1 ; * result = apr_palloc ( pool , valuelen ) ; rv = apr_conv_ucs2_to_utf8 ( wvalue , & size , * result , & valuelen ) ; if ( rv != APR_SUCCESS ) { return rv ; } if ( size ) { return APR_ENAMETOOLONG ; } } ELSE_WIN_OS_IS_ANSI { rc = RegQueryValueEx ( key -> hkey , valuename , 0 , & type , NULL , ( DWORD * ) & size ) ; if ( rc != ERROR_SUCCESS ) { return APR_FROM_OS_ERROR ( rc ) ; } if ( ( size < 1 ) || ( type != REG_SZ && type != REG_EXPAND_SZ ) ) { return APR_FROM_OS_ERROR ( ERROR_INVALID_PARAMETER ) ; } * result = apr_palloc ( pool , size ) ; rc = RegQueryValueEx ( key -> hkey , valuename , 0 , & type , * result , ( DWORD * ) & size ) ; if ( rc != ERROR_SUCCESS ) { return APR_FROM_OS_ERROR ( rc ) ; } if ( type == REG_EXPAND_SZ ) { char zbuf [ 1 ] ; size = ExpandEnvironmentStrings ( * result , zbuf , 0 ) ; if ( size ) { char * tmp = * result ; * result = apr_palloc ( pool , size ) ; size = ExpandEnvironmentStrings ( tmp , * result , ( DWORD ) size ) ; } } } return APR_SUCCESS ; } 