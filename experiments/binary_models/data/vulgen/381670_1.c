int bfin_twi_do_smbus_xfer ( struct i2c_adapter * adap , u16 addr , unsigned short flags , char read_write , u8 command , int size , union i2c_smbus_data * data ) { struct bfin_twi_iface * iface = adap -> algo_data ; int rc = 0 ; if ( read_MASTER_STAT ( iface ) & BUSBUSY ) { return - EAGAIN ; } iface -> writeNum = 0 ; iface -> readNum = 0 ; switch ( size ) { case I2C_SMBUS_QUICK : iface -> transPtr = NULL ; iface -> cur_mode = TWI_I2C_MODE_STANDARD ; break ; case I2C_SMBUS_BYTE : if ( data == NULL ) { iface -> transPtr = NULL ; } else { if ( read_write == I2C_SMBUS_READ ) { iface -> readNum = 1 ; } else { iface -> writeNum = 1 ; } iface -> transPtr = & data -> byte ; } iface -> cur_mode = TWI_I2C_MODE_STANDARD ; break ; case I2C_SMBUS_BYTE_DATA : if ( read_write == I2C_SMBUS_READ ) { iface -> readNum = 1 ; iface -> cur_mode = TWI_I2C_MODE_COMBINED ; } else { iface -> writeNum = 1 ; iface -> cur_mode = TWI_I2C_MODE_STANDARDSUB ; } iface -> transPtr = & data -> byte ; break ; case I2C_SMBUS_WORD_DATA : if ( read_write == I2C_SMBUS_READ ) { iface -> readNum = 2 ; iface -> cur_mode = TWI_I2C_MODE_COMBINED ; } else { iface -> writeNum = 2 ; iface -> cur_mode = TWI_I2C_MODE_STANDARDSUB ; } iface -> transPtr = ( u8 * ) & data -> word ; break ; case I2C_SMBUS_PROC_CALL : iface -> writeNum = 2 ; iface -> readNum = 2 ; iface -> cur_mode = TWI_I2C_MODE_COMBINED ; iface -> transPtr = ( u8 * ) & data -> word ; break ; case I2C_SMBUS_BLOCK_DATA : if ( read_write == I2C_SMBUS_READ ) { iface -> readNum = 0 ; iface -> cur_mode = TWI_I2C_MODE_COMBINED ; } else { iface -> writeNum = data -> block [ 0 ] + 1 ; iface -> cur_mode = TWI_I2C_MODE_STANDARDSUB ; } iface -> transPtr = data -> block ; break ; case I2C_SMBUS_I2C_BLOCK_DATA : if ( read_write == I2C_SMBUS_READ ) { iface -> readNum = data -> block [ 0 ] ; iface -> cur_mode = TWI_I2C_MODE_COMBINED ; } else { iface -> writeNum = data -> block [ 0 ] ; iface -> cur_mode = TWI_I2C_MODE_STANDARDSUB ; } iface -> transPtr = ( u8 * ) & data -> block [ 1 ] ; break ; default : return - 1 ; } iface -> result = 0 ; iface -> manual_stop = 0 ; iface -> read_write = read_write ; iface -> command = command ; init_completion ( & ( iface -> complete ) ) ; write_FIFO_CTL ( iface , 0x3 ) ; write_FIFO_CTL ( iface , 0 ) ; write_INT_STAT ( iface , MERR | MCOMP | XMTSERV | RCVSERV ) ; write_MASTER_ADDR ( iface , addr ) ; switch ( iface -> cur_mode ) { case TWI_I2C_MODE_STANDARDSUB : write_XMT_DATA8 ( iface , iface -> command ) ; write_INT_MASK ( iface , MCOMP | MERR | ( ( iface -> read_write == I2C_SMBUS_READ ) ?RCVSERV : XMTSERV ) ) ; if ( iface -> writeNum + 1 <= 255 ) { write_MASTER_CTL ( iface , ( iface -> writeNum + 1 ) << 6 ) ; } else { write_MASTER_CTL ( iface , 0xff << 6 ) ; iface -> manual_stop = 1 ; } write_MASTER_CTL ( iface , read_MASTER_CTL ( iface ) | MEN | ( ( CONFIG_I2C_BLACKFIN_TWI_CLK_KHZ > 100 ) ?FAST : 0 ) ) ; break ; case TWI_I2C_MODE_COMBINED : write_XMT_DATA8 ( iface , iface -> command ) ; write_INT_MASK ( iface , MCOMP | MERR | RCVSERV | XMTSERV ) ; if ( iface -> writeNum > 0 ) { write_MASTER_CTL ( iface , ( iface -> writeNum + 1 ) << 6 ) ; } else { write_MASTER_CTL ( iface , 0x1 << 6 ) ; } write_MASTER_CTL ( iface , read_MASTER_CTL ( iface ) | MEN | RSTART | ( ( CONFIG_I2C_BLACKFIN_TWI_CLK_KHZ > 100 ) ?FAST : 0 ) ) ; break ; default : write_MASTER_CTL ( iface , 0 ) ; if ( size != I2C_SMBUS_QUICK ) { if ( iface -> read_write != I2C_SMBUS_READ ) { if ( iface -> writeNum > 0 ) { write_XMT_DATA8 ( iface , * ( iface -> transPtr ++ ) ) ; if ( iface -> writeNum <= 255 ) { write_MASTER_CTL ( iface , iface -> writeNum << 6 ) ; } else { write_MASTER_CTL ( iface , 0xff << 6 ) ; iface -> manual_stop = 1 ; } iface -> writeNum -- ; } else { write_XMT_DATA8 ( iface , iface -> command ) ; write_MASTER_CTL ( iface , 1 << 6 ) ; } } else { if ( iface -> readNum > 0 && iface -> readNum <= 255 ) { write_MASTER_CTL ( iface , iface -> readNum << 6 ) ; } if ( iface -> readNum > 255 ) { write_MASTER_CTL ( iface , 0xff << 6 ) ; iface -> manual_stop = 1 ; } else { break ; } } } write_INT_MASK ( iface , MCOMP | MERR | ( ( iface -> read_write == I2C_SMBUS_READ ) ?RCVSERV : XMTSERV ) ) ; write_MASTER_CTL ( iface , read_MASTER_CTL ( iface ) | MEN | ( ( iface -> read_write == I2C_SMBUS_READ ) ?MDIR : 0 ) | ( ( CONFIG_I2C_BLACKFIN_TWI_CLK_KHZ > 100 ) ?FAST : 0 ) ) ; break ; } while ( ! iface -> result ) { if ( ! wait_for_completion_timeout ( & iface -> complete , adap -> timeout ) ) { iface -> result = - 1 ; dev_err ( & adap -> dev , "smbus transfer timeout\n" ) ; } } rc = ( iface -> result >= 0 ) ?0 : - 1 ; return rc ; } 