static int cal_s_fmt_vid_cap ( struct file * file , void * priv , struct v4l2_format * f ) { struct cal_ctx * ctx = video_drvdata ( file ) ; struct vb2_queue * q = & ctx -> vb_vidq ; const struct cal_fmt * fmt ; struct v4l2_mbus_framefmt mbus_fmt ; int ret ; if ( vb2_is_busy ( q ) ) { ctx_dbg ( 3 , ctx , "%s device busy\n" , __func__ ) ; return - EBUSY ; } ret = cal_try_fmt_vid_cap ( file , priv , f ) ; if ( ret < 0 ) { return ret ; } fmt = find_format_by_pix ( ctx , f -> fmt . pix . pixelformat ) ; v4l2_fill_mbus_format ( & mbus_fmt , & f -> fmt . pix , fmt -> code ) ; ret = __subdev_set_format ( ctx , & mbus_fmt ) ; if ( ret ) { return ret ; } if ( mbus_fmt . code != fmt -> code ) { ctx_dbg ( 3 , ctx , "%s subdev changed format on us, this should not happen\n" , __func__ ) ; return - EINVAL ; } v4l2_fill_pix_format ( & ctx -> v_fmt . fmt . pix , & mbus_fmt ) ; ctx -> v_fmt . type = V4L2_BUF_TYPE_VIDEO_CAPTURE ; ctx -> v_fmt . fmt . pix . pixelformat = fmt -> fourcc ; cal_calc_format_size ( ctx , fmt , & ctx -> v_fmt ) ; ctx -> fmt = fmt ; * f = ctx -> v_fmt ; return 0 ; } 