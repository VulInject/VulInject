static void TestConvertSafeCloneCallback ( ) { UErrorCode err = U_ZERO_ERROR ; TSCCContext from1 , to1 ; TSCCContext * from2 , * from3 , * to2 , * to3 ; TSCCContext * * pfrom2 = & from2 , * * pfrom3 = & from3 , * * pto2 = & to2 , * * pto3 = & to3 ; char hunk [ 8192 ] ; int32_t hunkSize = 8192 ; UConverterFromUCallback junkFrom ; UConverterToUCallback junkTo ; UConverter * conv1 , * conv2 = NULL ; conv1 = ucnv_open ( "iso-8859-3" , & err ) ; if ( U_FAILURE ( err ) ) { log_data_err ( "Err opening iso-8859-3, %s\n" , u_errorName ( err ) ) ; return ; } log_verbose ( "Opened conv1=%p\n" , conv1 ) ; TSCC_init ( & from1 ) ; TSCC_init ( & to1 ) ; TSCC_print_log ( & from1 , "from1" ) ; TSCC_print_log ( & to1 , "to1" ) ; ucnv_setFromUCallBack ( conv1 , TSCC_fromU , & from1 , NULL , NULL , & err ) ; log_verbose ( "Set from1 on conv1\n" ) ; TSCC_print_log ( & from1 , "from1" ) ; ucnv_setToUCallBack ( conv1 , TSCC_toU , & to1 , NULL , NULL , & err ) ; log_verbose ( "Set to1 on conv1\n" ) ; TSCC_print_log ( & to1 , "to1" ) ; conv2 = ucnv_safeClone ( conv1 , hunk , & hunkSize , & err ) ; if ( U_FAILURE ( err ) ) { log_err ( "safeClone failed: %s\n" , u_errorName ( err ) ) ; return ; } log_verbose ( "Cloned to conv2=%p.\n" , conv2 ) ; ucnv_getFromUCallBack ( conv2 , & junkFrom , ( const void * * ) pfrom2 ) ; ucnv_getFromUCallBack ( conv1 , & junkFrom , ( const void * * ) pfrom3 ) ; TSCC_print_log ( from2 , "from2" ) ; TSCC_print_log ( from3 , "from3(==from1)" ) ; if ( from2 == NULL ) { log_err ( "FAIL! from2 is null \n" ) ; return ; } if ( from3 == NULL ) { log_err ( "FAIL! from3 is null \n" ) ; return ; } if ( from3 != ( & from1 ) ) { log_err ( "FAIL! conv1's FROM context changed!\n" ) ; } if ( from2 == ( & from1 ) ) { log_err ( "FAIL! conv1's FROM context is the same as conv2's!\n" ) ; } if ( from1 . wasClosed ) { log_err ( "FAIL! from1 is closed \n" ) ; } if ( from2 -> wasClosed ) { log_err ( "FAIL! from2 was closed\n" ) ; } ucnv_getToUCallBack ( conv2 , & junkTo , ( const void * * ) pto2 ) ; ucnv_getToUCallBack ( conv1 , & junkTo , ( const void * * ) pto3 ) ; TSCC_print_log ( to2 , "to2" ) ; TSCC_print_log ( to3 , "to3(==to1)" ) ; if ( to2 == NULL ) { log_err ( "FAIL! to2 is null \n" ) ; return ; } if ( to3 == NULL ) { log_err ( "FAIL! to3 is null \n" ) ; return ; } if ( to3 != ( & to1 ) ) { log_err ( "FAIL! conv1's TO context changed!\n" ) ; } if ( to2 == ( & to1 ) ) { log_err ( "FAIL! conv1's TO context is the same as conv2's!\n" ) ; } if ( to1 . wasClosed ) { log_err ( "FAIL! to1 is closed \n" ) ; } if ( to2 -> wasClosed ) { log_err ( "FAIL! to2 was closed\n" ) ; } ucnv_close ( conv1 ) ; log_verbose ( "ucnv_closed (conv1)\n" ) ; TSCC_print_log ( & from1 , "from1" ) ; TSCC_print_log ( from2 , "from2" ) ; TSCC_print_log ( & to1 , "to1" ) ; TSCC_print_log ( to2 , "to2" ) ; if ( from1 . wasClosed == false ) { log_err ( "FAIL! from1 is NOT closed \n" ) ; } if ( from2 -> wasClosed ) { log_err ( "FAIL! from2 was closed\n" ) ; } if ( to1 . wasClosed == false ) { log_err ( "FAIL! to1 is NOT closed \n" ) ; } if ( to2 -> wasClosed ) { log_err ( "FAIL! to2 was closed\n" ) ; } ucnv_close ( conv2 ) ; log_verbose ( "ucnv_closed (conv2)\n" ) ; TSCC_print_log ( & from1 , "from1" ) ; TSCC_print_log ( from2 , "from2" ) ; if ( from1 . wasClosed == false ) { log_err ( "FAIL! from1 is NOT closed \n" ) ; } if ( from2 -> wasClosed == false ) { log_err ( "FAIL! from2 was NOT closed\n" ) ; } TSCC_print_log ( & to1 , "to1" ) ; TSCC_print_log ( to2 , "to2" ) ; if ( to1 . wasClosed == false ) { log_err ( "FAIL! to1 is NOT closed \n" ) ; } if ( to2 != ( & to1 ) ) { free ( to2 ) ; } if ( from2 != ( & from1 ) ) { free ( from2 ) ; } } 