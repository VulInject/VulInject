static int e1000_setup_rx_resources ( struct e1000_adapter * adapter , struct e1000_rx_ring * rxdr ) { struct pci_dev * pdev = adapter -> pdev ; int size , desc_len ; size = sizeof ( e1000_rx_buffer ) * rxdr -> count ; rxdr -> buffer_info = vzalloc ( size ) ; if ( ! rxdr -> buffer_info ) { return - ENOMEM ; } desc_len = sizeof ( e1000_rx_desc ) ; rxdr -> size = rxdr -> count * desc_len ; rxdr -> size = ALIGN ( rxdr -> size , 4096 ) ; rxdr -> desc = dma_alloc_coherent ( & pdev -> dev , rxdr -> size , & rxdr -> dma , GFP_KERNEL ) ; if ( ! rxdr -> desc ) { setup_rx_desc_die vfree ( rxdr -> buffer_info ) ; return - ENOMEM ; } if ( ! e1000_check_64k_bound ( adapter , rxdr -> desc , rxdr -> size ) ) { void * olddesc = rxdr -> desc ; dma_addr_t olddma = rxdr -> dma ; e_err ( rx_err , "rxdr align check failed: %u bytes at %p\n" , rxdr -> size , rxdr -> desc ) ; rxdr -> desc = dma_alloc_coherent ( & pdev -> dev , rxdr -> size , & rxdr -> dma , GFP_KERNEL ) ; if ( ! e1000_check_64k_bound ( adapter , rxdr -> desc , rxdr -> size ) ) { dma_free_coherent ( & pdev -> dev , rxdr -> size , rxdr -> desc , rxdr -> dma ) ; dma_free_coherent ( & pdev -> dev , rxdr -> size , olddesc , olddma ) ; e_err ( probe , "Unable to allocate aligned memory for " "the Rx descriptor ring\n" ) ; setup_rx_desc_die } else { dma_free_coherent ( & pdev -> dev , rxdr -> size , olddesc , olddma ) ; } } memset ( rxdr -> desc , 0 , rxdr -> size ) ; rxdr -> next_to_clean = 0 ; rxdr -> next_to_use = 0 ; rxdr -> rx_skb_top = NULL ; return 0 ; } 