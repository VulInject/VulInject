static void test_circuitpadding_token_removal_exact ( void * arg ) { circpad_machine_runtime_t * mi ; ( void ) arg ; MOCK ( monotime_absolute_usec , mock_monotime_absolute_usec ) ; MOCK ( circpad_machine_schedule_padding , circpad_machine_schedule_padding_mock ) ; testing_enable_reproducible_rng ( ) ; client_side = TO_CIRCUIT ( origin_circuit_new ( ) ) ; client_side -> purpose = CIRCUIT_PURPOSE_C_GENERAL ; monotime_enable_test_mocking ( ) ; helper_create_machine_with_big_histogram ( CIRCPAD_TOKEN_REMOVAL_EXACT ) ; client_side -> padding_machine [ 0 ] = & circ_client_machine ; client_side -> padding_info [ 0 ] = circpad_circuit_machineinfo_new ( client_side , 0 ) ; circpad_cell_event_nonpadding_received ( client_side ) ; tt_int_op ( client_side -> padding_info [ 0 ] -> current_state , OP_EQ , CIRCPAD_STATE_BURST ) ; mi = client_side -> padding_info [ 0 ] ; tt_assert ( mi ) ; mi -> padding_scheduled_at_usec = current_time - 57 ; tt_int_op ( mi -> histogram [ 4 ] , OP_EQ , 2 ) ; circpad_cell_event_nonpadding_sent ( client_side ) ; mi -> padding_scheduled_at_usec = current_time - 57 ; tt_int_op ( mi -> histogram [ 4 ] , OP_EQ , 1 ) ; circpad_cell_event_nonpadding_sent ( client_side ) ; tt_int_op ( mi -> histogram [ 4 ] , OP_EQ , 0 ) ; mi -> padding_scheduled_at_usec = current_time - 57 ; circpad_cell_event_nonpadding_sent ( client_side ) ; for ( int i = 0 ; i < BIG_HISTOGRAM_LEN ; i ++ ) { if ( i != 4 ) { tt_int_op ( mi -> histogram [ i ] , OP_EQ , 2 ) ; } } done free_fake_origin_circuit ( TO_ORIGIN_CIRCUIT ( client_side ) ) ; monotime_disable_test_mocking ( ) ; tor_free ( circ_client_machine . states ) ; testing_disable_reproducible_rng ( ) ; } 