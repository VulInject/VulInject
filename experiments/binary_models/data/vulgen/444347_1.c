( xfrm6_protocol_register ) ; int xfrm6_protocol_deregister ( struct xfrm6_protocol * handler , unsigned char protocol ) { struct xfrm6_protocol __rcu * * pprev ; struct xfrm6_protocol * t ; int ret = - ENOENT ; mutex_lock ( & xfrm6_protocol_mutex ) ; for ( pprev = proto_handlers ( protocol ) ; ( t = rcu_dereference_protected ( * pprev , lockdep_is_held ( & xfrm6_protocol_mutex ) ) ) != NULL ; pprev = & t -> next ) { if ( t == handler ) { * pprev = handler -> next ; ret = 0 ; break ; } } if ( ! rcu_dereference_protected ( * proto_handlers ( protocol ) , lockdep_is_held ( & xfrm6_protocol_mutex ) ) ) { if ( inet6_del_protocol ( netproto ( protocol ) , protocol ) < 0 ) { pr_err ( "%s: can't remove protocol\n" , __func__ ) ; ret = - EAGAIN ; } } mutex_unlock ( & xfrm6_protocol_mutex ) ; synchronize_net ( ) ; return ret ; } 