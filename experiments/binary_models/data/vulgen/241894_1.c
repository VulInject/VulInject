static void mpi3mr_dev_rmhs_complete_tm ( struct mpi3mr_ioc * mrioc , struct mpi3mr_drv_cmd * drv_cmd ) { struct mpi3_iounit_control_request iou_ctrl ; u16 cmd_idx = drv_cmd -> host_tag - MPI3MR_HOSTTAG_DEVRMCMD_MIN ; struct mpi3_scsi_task_mgmt_reply * tm_reply = NULL ; int retval ; if ( drv_cmd -> state & MPI3MR_CMD_RESET ) { clear_drv_cmd } if ( drv_cmd -> state & MPI3MR_CMD_REPLY_VALID ) { tm_reply = ( mpi3_scsi_task_mgmt_reply * ) drv_cmd -> reply ; } if ( tm_reply ) { pr_info ( IOCNAME "dev_rmhs_tr_complete:handle(0x%04x), ioc_status(0x%04x), loginfo(0x%08x), term_count(%d)\n" , mrioc -> name , drv_cmd -> dev_handle , drv_cmd -> ioc_status , drv_cmd -> ioc_loginfo , le32_to_cpu ( tm_reply -> termination_count ) ) ; } pr_info ( IOCNAME "Issuing IOU CTL: handle(0x%04x) dev_rmhs idx(%d)\n" , mrioc -> name , drv_cmd -> dev_handle , cmd_idx ) ; drv_cmd -> state = MPI3MR_CMD_PENDING ; drv_cmd -> is_waiting = 0 ; drv_cmd -> callback = mpi3mr_dev_rmhs_complete_iou ; iou_ctrl . operation = drv_cmd -> iou_rc ; iou_ctrl . param16 [ 0 ] = cpu_to_le16 ( drv_cmd -> dev_handle ) ; iou_ctrl . host_tag = cpu_to_le16 ( drv_cmd -> host_tag ) ; iou_ctrl . function = MPI3_FUNCTION_IO_UNIT_CONTROL ; retval = mpi3mr_admin_request_post ( mrioc , & iou_ctrl , sizeof ( iou_ctrl ) , 1 ) ; if ( retval ) { pr_err ( IOCNAME "Issue DevRmHsTMIOUCTL: Admin post failed\n" , mrioc -> name ) ; clear_drv_cmd } return ; clear_drv_cmd drv_cmd -> state = MPI3MR_CMD_NOTUSED ; drv_cmd -> callback = NULL ; drv_cmd -> dev_handle = MPI3MR_INVALID_DEV_HANDLE ; drv_cmd -> retry_count = 0 ; clear_bit ( cmd_idx , mrioc -> devrem_bitmap ) ; } 