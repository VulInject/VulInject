PHP_FUNCTION ( ) { char * lang_tag = NULL ; size_t lang_tag_len = 0 ; const char * loc_range = NULL ; size_t loc_range_len = 0 ; int result = 0 ; char * token = 0 ; char * chrcheck = NULL ; zend_string * can_lang_tag = NULL ; zend_string * can_loc_range = NULL ; char * cur_lang_tag = NULL ; char * cur_loc_range = NULL ; bool boolCanonical = 0 ; UErrorCode status = U_ZERO_ERROR ; intl_error_reset ( NULL ) ; if ( zend_parse_parameters ( ZEND_NUM_ARGS ( ) , "ss|b" , & lang_tag , & lang_tag_len , & loc_range , & loc_range_len , & boolCanonical ) == FAILURE ) { RETURN_THROWS ( ) ; } if ( loc_range_len == 0 ) { loc_range = intl_locale_get_default ( ) ; loc_range_len = strlen ( loc_range ) ; } if ( strcmp ( loc_range , "*" ) == 0 ) { RETURN_TRUE ; } INTL_CHECK_LOCALE_LEN ( loc_range_len ) ; INTL_CHECK_LOCALE_LEN ( lang_tag_len ) ; if ( boolCanonical ) { can_loc_range = get_icu_value_internal ( loc_range , LOC_CANONICALIZE_TAG , & result , 0 ) ; if ( result <= 0 ) { intl_error_set ( NULL , status , "locale_filter_matches : unable to canonicalize loc_range" , 0 ) ; RETURN_FALSE ; } can_lang_tag = get_icu_value_internal ( lang_tag , LOC_CANONICALIZE_TAG , & result , 0 ) ; if ( result <= 0 ) { intl_error_set ( NULL , status , "locale_filter_matches : unable to canonicalize lang_tag" , 0 ) ; RETURN_FALSE ; } cur_lang_tag = ecalloc ( 1 , can_lang_tag -> len + 1 ) ; result = strToMatch ( can_lang_tag -> val , cur_lang_tag ) ; if ( result == 0 ) { efree ( cur_lang_tag ) ; zend_string_release_ex ( can_lang_tag , 0 ) ; RETURN_FALSE ; } cur_loc_range = ecalloc ( 1 , can_loc_range -> len + 1 ) ; result = strToMatch ( can_loc_range -> val , cur_loc_range ) ; if ( result == 0 ) { efree ( cur_lang_tag ) ; zend_string_release_ex ( can_lang_tag , 0 ) ; efree ( cur_loc_range ) ; zend_string_release_ex ( can_loc_range , 0 ) ; RETURN_FALSE ; } token = strstr ( cur_lang_tag , cur_loc_range ) ; if ( token && ( token == cur_lang_tag ) ) { chrcheck = token + ( strlen ( cur_loc_range ) ) ; if ( isIDSeparator ( * chrcheck ) || isKeywordSeparator ( * chrcheck ) || isEndOfTag ( * chrcheck ) ) { efree ( cur_lang_tag ) ; efree ( cur_loc_range ) ; if ( can_lang_tag ) { zend_string_release_ex ( can_lang_tag , 0 ) ; } if ( can_loc_range ) { zend_string_release_ex ( can_loc_range , 0 ) ; } RETURN_TRUE ; } } if ( cur_lang_tag ) { efree ( cur_lang_tag ) ; } if ( cur_loc_range ) { efree ( cur_loc_range ) ; } if ( can_lang_tag ) { zend_string_release_ex ( can_lang_tag , 0 ) ; } if ( can_loc_range ) { zend_string_release_ex ( can_loc_range , 0 ) ; } RETURN_FALSE ; } else { cur_lang_tag = ecalloc ( 1 , strlen ( lang_tag ) + 1 ) ; result = strToMatch ( lang_tag , cur_lang_tag ) ; if ( result == 0 ) { efree ( cur_lang_tag ) ; RETURN_FALSE ; } cur_loc_range = ecalloc ( 1 , strlen ( loc_range ) + 1 ) ; result = strToMatch ( loc_range , cur_loc_range ) ; token = strstr ( cur_lang_tag , cur_loc_range ) ; if ( token && ( token == cur_lang_tag ) ) { chrcheck = token + ( strlen ( cur_loc_range ) ) ; if ( isIDSeparator ( * chrcheck ) || isEndOfTag ( * chrcheck ) ) { efree ( cur_lang_tag ) ; efree ( cur_loc_range ) ; RETURN_TRUE ; } } if ( cur_lang_tag ) { efree ( cur_lang_tag ) ; } if ( cur_loc_range ) { efree ( cur_loc_range ) ; } RETURN_FALSE ; } } 