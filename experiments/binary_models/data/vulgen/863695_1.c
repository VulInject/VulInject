int _init ( void ) { uint16_t w16 ; int rval = 0 ; for ( w16 = 0 ; w16 < sizeof ( utsname . release ) ; w16 ++ ) { if ( utsname . release [ w16 ] == '.' ) { w16 ++ ; break ; } } if ( w16 < sizeof ( utsname . release ) ) { ( void ) ql_bstr_to_dec ( & utsname . release [ w16 ] , & ql_os_release_level , 0 ) ; } else { ql_os_release_level = 0 ; } if ( ql_os_release_level < 6 ) { cmn_err ( CE_WARN , "%s Unsupported OS release level = %d" , QL_NAME , ql_os_release_level ) ; rval = EINVAL ; } if ( ql_os_release_level == 6 ) { ql_32bit_io_dma_attr . dma_attr_count_max = 0x00ffffff ; ql_64bit_io_dma_attr . dma_attr_count_max = 0x00ffffff ; } if ( rval == 0 ) { rval = ddi_soft_state_init ( & ql_state , sizeof ( ql_adapter_state_t ) , 0 ) ; } if ( rval == 0 ) { fc_fca_init ( & ql_devops ) ; mutex_init ( & ql_global_mutex , NULL , MUTEX_DRIVER , NULL ) ; mutex_init ( & ql_global_hw_mutex , NULL , MUTEX_DRIVER , NULL ) ; mutex_init ( & ql_global_el_mutex , NULL , MUTEX_DRIVER , NULL ) ; rval = mod_install ( & modlinkage ) ; if ( rval != 0 ) { mutex_destroy ( & ql_global_hw_mutex ) ; mutex_destroy ( & ql_global_mutex ) ; mutex_destroy ( & ql_global_el_mutex ) ; ddi_soft_state_fini ( & ql_state ) ; } else { ql_32fcsm_cmd_dma_attr = ql_32bit_io_dma_attr ; ql_64fcsm_cmd_dma_attr = ql_64bit_io_dma_attr ; ql_32fcsm_rsp_dma_attr = ql_32bit_io_dma_attr ; ql_64fcsm_rsp_dma_attr = ql_64bit_io_dma_attr ; ql_32fcip_cmd_dma_attr = ql_32bit_io_dma_attr ; ql_64fcip_cmd_dma_attr = ql_64bit_io_dma_attr ; ql_32fcip_rsp_dma_attr = ql_32bit_io_dma_attr ; ql_64fcip_rsp_dma_attr = ql_64bit_io_dma_attr ; ql_32fcp_cmd_dma_attr = ql_32bit_io_dma_attr ; ql_64fcp_cmd_dma_attr = ql_64bit_io_dma_attr ; ql_32fcp_rsp_dma_attr = ql_32bit_io_dma_attr ; ql_64fcp_rsp_dma_attr = ql_64bit_io_dma_attr ; ql_32fcp_data_dma_attr = ql_32bit_io_dma_attr ; ql_64fcp_data_dma_attr = ql_64bit_io_dma_attr ; ql_32fcsm_cmd_dma_attr . dma_attr_sgllen = ql_64fcsm_cmd_dma_attr . dma_attr_sgllen = QL_FCSM_CMD_SGLLEN ; ql_32fcsm_rsp_dma_attr . dma_attr_sgllen = ql_64fcsm_rsp_dma_attr . dma_attr_sgllen = QL_FCSM_RSP_SGLLEN ; ql_32fcip_cmd_dma_attr . dma_attr_sgllen = ql_64fcip_cmd_dma_attr . dma_attr_sgllen = QL_FCIP_CMD_SGLLEN ; ql_32fcip_rsp_dma_attr . dma_attr_sgllen = ql_64fcip_rsp_dma_attr . dma_attr_sgllen = QL_FCIP_RSP_SGLLEN ; ql_32fcp_cmd_dma_attr . dma_attr_sgllen = ql_64fcp_cmd_dma_attr . dma_attr_sgllen = QL_FCP_CMD_SGLLEN ; ql_32fcp_rsp_dma_attr . dma_attr_sgllen = ql_64fcp_rsp_dma_attr . dma_attr_sgllen = QL_FCP_RSP_SGLLEN ; } } return ( rval ) ; } 