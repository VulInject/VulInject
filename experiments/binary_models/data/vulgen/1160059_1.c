* notice , this list of conditions and the following disclaimer in the * documentation and / or other materials provided with the distribution . * 3. Neither the name of the University nor the names of its contributors * may be used to endorse or promote products derived from this software * without specific prior written permission . * * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ` ` AS IS '' AND * ANY EXPRESS OR IMPLIED WARRANTIES , INCLUDING , BUT NOT LIMITED TO , THE * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE * ARE DISCLAIMED . IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE * FOR ANY DIRECT , INDIRECT , INCIDENTAL , SPECIAL , EXEMPLARY , OR CONSEQUENTIAL * DAMAGES ( , , , , ) * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY , WHETHER IN CONTRACT , STRICT * LIABILITY , OR TORT ( ) ARISING IN ANY WAY * OUT OF THE USE OF THIS SOFTWARE , EVEN IF ADVISED OF THE POSSIBILITY OF * SUCH DAMAGE . * / char * calendarFile = "calendar" ; char * calendarHome = ".calendar" ; char * calendarNoMail = "nomail" ; struct passwd * pw ; int doall = 0 ; int daynames = 0 ; time_t f_time = 0 ; int bodun_always = 0 ; int f_dayAfter = 0 ; int f_dayBefore = 0 ; int f_Setday = 0 ; struct specialev spev [ NUMEV ] ; void childsig ( int ) int main ( int argc , char * argv [ ] ) { int ch ; const char * errstr ; char * caldir ; ( void ) setlocale ( LC_ALL , "" ) ; while ( ( ch = getopt ( argc , argv , "abwf:t:A:B:-" ) ) != - 1 ) { switch ( ch ) { case '-' : case 'a' : if ( getuid ( ) ) { errx ( 1 , "%s" , strerror ( EPERM ) ) ; } doall = 1 ; break ; case 'b' : bodun_always = 1 ; break ; case 'f' : calendarFile = optarg ; break ; case 't' : if ( ( f_time = Mktime ( optarg ) ) <= 0 ) { errx ( 1 , "specified date is outside allowed range" ) ; } break ; case 'A' : f_dayAfter = strtonum ( optarg , 0 , INT_MAX , & errstr ) ; if ( errstr ) { errx ( 1 , "-A %s: %s" , optarg , errstr ) ; } f_Setday = 1 ; break ; case 'B' : f_dayBefore = strtonum ( optarg , 0 , INT_MAX , & errstr ) ; if ( errstr ) { errx ( 1 , "-B %s: %s" , optarg , errstr ) ; } if ( f_dayBefore != 0 ) { f_Setday = 1 ; } break ; case 'w' : daynames = 1 ; break ; default : usage ( ) ; } } argc -= optind ; argv += optind ; if ( argc ) { usage ( ) ; } if ( doall ) { if ( pledge ( "stdio rpath tmppath fattr getpw id proc exec" , NULL ) == - 1 ) { err ( 1 , "pledge" ) ; } } else { if ( pledge ( "stdio rpath proc exec" , NULL ) == - 1 ) { err ( 1 , "pledge" ) ; } } if ( f_time <= 0 ) { ( void ) time ( & f_time ) ; } if ( f_dayBefore ) { f_dayAfter += f_dayBefore ; f_time -= SECSPERDAY * f_dayBefore ; f_dayBefore = 0 ; } settime ( & f_time ) ; if ( doall ) { pid_t kid , deadkid ; int kidstat , kidreaped , runningkids ; int acstat ; struct stat sbuf ; time_t t ; unsigned int sleeptime ; signal ( SIGCHLD , childsig ) ; runningkids = 0 ; t = time ( NULL ) ; while ( ( pw = getpwent ( ) ) != NULL ) { acstat = 0 ; if ( chdir ( pw -> pw_dir ) ) { if ( errno == EACCES ) { acstat = 1 ; } else { continue ; } } if ( stat ( calendarFile , & sbuf ) != 0 ) { if ( chdir ( calendarHome ) ) { if ( errno == EACCES ) { acstat = 1 ; } else { continue ; } } if ( stat ( calendarNoMail , & sbuf ) == 0 || stat ( calendarFile , & sbuf ) != 0 ) { continue ; } } sleeptime = USERTIMEOUT ; switch ( ( kid = fork ( ) ) ) { case - 1 : warn ( "fork" ) ; continue ; case 0 : ( void ) setpgid ( getpid ( ) , getpid ( ) ) ; ( void ) setlocale ( LC_ALL , "" ) ; if ( setusercontext ( NULL , pw , pw -> pw_uid , LOGIN_SETALL ^ LOGIN_SETLOGIN ) ) { err ( 1 , "unable to set user context (uid %u)" , pw -> pw_uid ) ; } if ( acstat ) { if ( chdir ( pw -> pw_dir ) || stat ( calendarFile , & sbuf ) != 0 || chdir ( calendarHome ) || stat ( calendarNoMail , & sbuf ) == 0 || stat ( calendarFile , & sbuf ) != 0 ) { exit ( 0 ) ; } } cal ( ) ; exit ( 0 ) ; } runningkids ++ ; kidreaped = 0 ; { sleeptime = sleep ( sleeptime ) ; for ( ; ; ) { deadkid = waitpid ( - 1 , & kidstat , WNOHANG ) ; if ( deadkid <= 0 ) { break ; } runningkids -- ; if ( deadkid == kid ) { kidreaped = 1 ; sleeptime = 0 ; } } } sleeptime ; if ( ! kidreaped ) { if ( getpgid ( kid ) != getpgrp ( ) ) { ( void ) killpg ( getpgid ( kid ) , SIGTERM ) ; } else { ( void ) kill ( kid , SIGTERM ) ; } warnx ( "uid %u did not finish in time" , pw -> pw_uid ) ; } if ( time ( NULL ) - t >= SECSPERDAY ) { errx ( 2 , "'calendar -a' took more than a day; " "stopped at uid %u" , pw -> pw_uid ) ; } } for ( ; ; ) { deadkid = waitpid ( - 1 , & kidstat , WNOHANG ) ; runningkids -- ; } if ( runningkids ) { warnx ( "%d child processes still running when " "'calendar -a' finished" , runningkids ) ; } } if ( ( caldir = getenv ( "CALENDAR_DIR" ) ) != NULL ) { if ( ! chdir ( caldir ) ) { cal ( ) ; } } else { cal ( ) ; } exit ( 0 ) ; } 