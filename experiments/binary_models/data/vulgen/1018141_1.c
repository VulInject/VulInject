static int kcm_unattach_ioctl ( struct socket * sock , struct kcm_unattach * info ) { struct kcm_sock * kcm = kcm_sk ( sock -> sk ) ; struct kcm_mux * mux = kcm -> mux ; struct kcm_psock * psock ; struct socket * csock ; struct sock * csk ; int err ; csock = sockfd_lookup ( info -> fd , & err ) ; if ( ! csock ) { return - ENOENT ; } csk = csock -> sk ; if ( ! csk ) { err = - EINVAL ; out } err = - ENOENT ; spin_lock_bh ( & mux -> lock ) ; list_for_each_entry ( , , ) { if ( psock -> sk != csk ) { continue ; } psock -> unattaching = 1 ; spin_unlock_bh ( & mux -> lock ) ; kcm_unattach ( psock ) ; err = 0 ; out } spin_unlock_bh ( & mux -> lock ) ; out fput ( csock -> file ) ; return err ; } 