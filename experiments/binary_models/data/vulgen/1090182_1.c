static int lm3554_probe ( struct i2c_client * client ) { int err = 0 ; struct lm3554 * flash ; unsigned int i ; flash = kzalloc ( sizeof ( * flash ) , GFP_KERNEL ) ; if ( ! flash ) { return - ENOMEM ; } flash -> pdata = lm3554_platform_data_func ( client ) ; if ( IS_ERR ( flash -> pdata ) ) { err = PTR_ERR ( flash -> pdata ) ; free_flash } v4l2_i2c_subdev_init ( & flash -> sd , client , & lm3554_ops ) ; flash -> sd . internal_ops = & lm3554_internal_ops ; flash -> sd . flags |= V4L2_SUBDEV_FL_HAS_DEVNODE ; flash -> mode = ATOMISP_FLASH_MODE_OFF ; flash -> timeout = LM3554_MAX_TIMEOUT / LM3554_TIMEOUT_STEPSIZE - 1 ; err = v4l2_ctrl_handler_init ( & flash -> ctrl_handler , ARRAY_SIZE ( lm3554_controls ) ) ; if ( err ) { dev_err ( & client -> dev , "error initialize a ctrl_handler.\n" ) ; unregister_subdev } for ( i = 0 ; i < ARRAY_SIZE ( lm3554_controls ) ; i ++ ) { v4l2_ctrl_new_custom ( & flash -> ctrl_handler , & lm3554_controls [ i ] , NULL ) ; } if ( flash -> ctrl_handler . error ) { dev_err ( & client -> dev , "ctrl_handler error.\n" ) ; err = flash -> ctrl_handler . error ; free_handler } flash -> sd . ctrl_handler = & flash -> ctrl_handler ; err = media_entity_pads_init ( & flash -> sd . entity , 0 , NULL ) ; if ( err ) { dev_err ( & client -> dev , "error initialize a media entity.\n" ) ; free_handler } flash -> sd . entity . function = MEDIA_ENT_F_FLASH ; timer_setup ( & flash -> flash_off_delay , lm3554_flash_off_delay , 0 ) ; err = lm3554_gpio_init ( client ) ; if ( err ) { dev_err ( & client -> dev , "gpio request/direction_output fail.\n" ) ; cleanup_media } err = atomisp_register_i2c_module ( & flash -> sd , NULL , LED_FLASH ) ; if ( err ) { dev_err ( & client -> dev , "fail to register atomisp i2c module.\n" ) ; uninit_gpio } return 0 ; uninit_gpio lm3554_gpio_uninit ( client ) ; cleanup_media media_entity_cleanup ( & flash -> sd . entity ) ; free_handler v4l2_ctrl_handler_free ( & flash -> ctrl_handler ) ; unregister_subdev v4l2_device_unregister_subdev ( & flash -> sd ) ; free_flash kfree ( flash ) ; return err ; } 