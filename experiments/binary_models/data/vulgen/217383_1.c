void ahd_send_lstate_events ( struct ahd_softc * ahd , struct ahd_tmode_lstate * lstate ) { struct ccb_hdr * ccbh ; struct ccb_immed_notify * inot ; while ( lstate -> event_r_idx != lstate -> event_w_idx && ( ccbh = SLIST_FIRST ( & lstate -> immed_notifies ) ) != NULL ) { struct ahd_tmode_event * event ; event = & lstate -> event_buffer [ lstate -> event_r_idx ] ; SLIST_REMOVE_HEAD ( & lstate -> immed_notifies , sim_links . sle ) ; inot = ( ccb_immed_notify * ) ccbh ; switch ( event -> event_type ) { case EVENT_TYPE_BUS_RESET : ccbh -> status = CAM_SCSI_BUS_RESET | CAM_DEV_QFRZN ; break ; default : ccbh -> status = CAM_MESSAGE_RECV | CAM_DEV_QFRZN ; inot -> message_args [ 0 ] = event -> event_type ; inot -> message_args [ 1 ] = event -> event_arg ; break ; } inot -> initiator_id = event -> initiator_id ; inot -> sense_len = 0 ; xpt_done ( ( ccb * ) inot ) ; lstate -> event_r_idx ++ ; } } 