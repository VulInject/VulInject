ospf_translated_nssa_refresh ( , , ) { ospf_lsa * new = NULL ; assert ( type7 || type5 ) ; if ( type7 ) { assert ( type7 -> data ) ; } if ( type5 ) { assert ( type5 -> data ) ; } assert ( ospf -> anyNSSA ) ; if ( type7 && type5 == NULL ) { struct as_external_lsa * ext = ( as_external_lsa * ) ( type7 -> data ) ; struct prefix_ipv4 p = { . prefix = type7 -> data -> id . prefixlen = ip_masklen ( ext -> mask ) . family = AF_INET } ; type5 = ospf_external_info_find_lsa ( ospf , & p ) ; } if ( type5 && type7 == NULL ) { struct listnode * ln , * lnn ; struct route_node * rn ; struct ospf_lsa * lsa ; struct ospf_area * area ; for ( ALL_LIST_ELEMENTS ( ospf -> areas , ln , lnn , area ) ; ) { if ( area -> external_routing != OSPF_AREA_NSSA && ! type7 ) { continue ; } LSDB_LOOP ( , , ) { if ( lsa -> data -> id . s_addr == type5 -> data -> id . s_addr ) { type7 = lsa ; break ; } } } } if ( ! type7 ) { if ( IS_DEBUG_OSPF_NSSA ) { zlog_debug ( "ospf_translated_nssa_refresh(): no Type-7 found for " "Type-5 LSA Id %s" , inet_ntoa ( type5 -> data -> id ) ) ; } return NULL ; } if ( type5 == NULL || ! CHECK_FLAG ( type5 -> flags , OSPF_LSA_LOCAL_XLT ) ) { if ( IS_DEBUG_OSPF_NSSA ) { zlog_debug ( "ospf_translated_nssa_refresh(): No translated Type-5 " "found for Type-7 with Id %s" , inet_ntoa ( type7 -> data -> id ) ) ; } return NULL ; } ospf_ls_retransmit_delete_nbr_as ( ospf , type5 ) ; if ( ( new = ospf_lsa_translated_nssa_new ( ospf , type7 ) ) == NULL ) { if ( IS_DEBUG_OSPF_NSSA ) { zlog_debug ( "ospf_translated_nssa_refresh(): Could not translate " "Type-7 for %s to Type-5" , inet_ntoa ( type7 -> data -> id ) ) ; } return NULL ; } if ( ! ( new = ospf_lsa_install ( ospf , NULL , new ) ) ) { if ( IS_DEBUG_OSPF_NSSA ) { zlog_debug ( "ospf_translated_nssa_refresh(): Could not install " "translated LSA, Id %s" , inet_ntoa ( type7 -> data -> id ) ) ; } return NULL ; } ospf_flood_through_as ( ospf , NULL , new ) ; return new ; } 