static u_int get_status ( struct sftp_conn * conn , u_int expected_id ) { struct sshbuf * msg ; u_char type ; u_int id , status ; int r ; if ( ( msg = sshbuf_new ( ) ) == NULL ) { fatal_f ( "sshbuf_new failed" ) ; } get_msg ( conn , msg ) ; if ( ( r = sshbuf_get_u8 ( msg , & type ) ) != 0 || ( r = sshbuf_get_u32 ( msg , & id ) ) != 0 ) { fatal_fr ( r , "compose" ) ; } if ( id != expected_id ) { fatal ( "ID mismatch (%u != %u)" , id , expected_id ) ; } if ( type != SSH2_FXP_STATUS ) { fatal ( "Expected SSH2_FXP_STATUS(%u) packet, got %u" , SSH2_FXP_STATUS , type ) ; } if ( ( r = sshbuf_get_u32 ( msg , & status ) ) != 0 ) { fatal_fr ( r , "parse" ) ; } debug3 ( "SSH2_FXP_STATUS %u" , status ) ; return status ; } 