static void lan8814_ptp_clock_step ( struct phy_device * phydev , s64 time_step_ns ) { u32 nano_seconds_step ; u64 abs_time_step_ns ; u32 unsigned_seconds ; u32 nano_seconds ; u32 remainder ; s32 seconds ; if ( time_step_ns > 15000000000LL ) { lan8814_ptp_clock_get ( phydev , & unsigned_seconds , & nano_seconds ) ; nano_seconds += remainder ; if ( nano_seconds >= 1000000000 ) { unsigned_seconds ++ ; nano_seconds -= 1000000000 ; } lan8814_ptp_clock_set ( phydev , unsigned_seconds , nano_seconds ) ; return ; } if ( time_step_ns < - 15000000000LL ) { time_step_ns = - time_step_ns ; lan8814_ptp_clock_get ( phydev , & unsigned_seconds , & nano_seconds ) ; unsigned_seconds -= div_u64_rem ( time_step_ns , 1000000000LL , & remainder ) ; nano_seconds_step = remainder ; if ( nano_seconds < nano_seconds_step ) { unsigned_seconds -- ; nano_seconds += 1000000000 ; } nano_seconds -= nano_seconds_step ; lan8814_ptp_clock_set ( phydev , unsigned_seconds , nano_seconds ) ; return ; } if ( time_step_ns >= 0 ) { abs_time_step_ns = ( u64 ) time_step_ns ; seconds = ( s32 ) div_u64_rem ( abs_time_step_ns , 1000000000 , & remainder ) ; nano_seconds = remainder ; } else { abs_time_step_ns = ( u64 ) ( - time_step_ns ) ; seconds = - ( ( s32 ) div_u64_rem ( abs_time_step_ns , 1000000000 , & remainder ) ) ; nano_seconds = remainder ; if ( nano_seconds > 0 ) { seconds -- ; nano_seconds = ( 1000000000 - nano_seconds ) ; } } if ( nano_seconds > 0 ) { nano_seconds += 8 ; } if ( nano_seconds >= 1000000000 ) { seconds ++ ; nano_seconds -= 1000000000 ; } while ( seconds ) { if ( seconds > 0 ) { u32 adjustment_value = ( u32 ) seconds ; u16 adjustment_value_lo , adjustment_value_hi ; if ( adjustment_value > 0xF ) { adjustment_value = 0xF ; } adjustment_value_lo = adjustment_value & 0xffff ; adjustment_value_hi = ( adjustment_value >> 16 ) & 0x3fff ; lanphy_write_page_reg ( phydev , 4 , PTP_LTC_STEP_ADJ_LO , adjustment_value_lo ) ; lanphy_write_page_reg ( phydev , 4 , PTP_LTC_STEP_ADJ_HI , PTP_LTC_STEP_ADJ_DIR_ | adjustment_value_hi ) ; seconds -= ( ( s32 ) adjustment_value ) ; } else { u32 adjustment_value = ( u32 ) ( - seconds ) ; u16 adjustment_value_lo , adjustment_value_hi ; if ( adjustment_value > 0xF ) { adjustment_value = 0xF ; } adjustment_value_lo = adjustment_value & 0xffff ; adjustment_value_hi = ( adjustment_value >> 16 ) & 0x3fff ; lanphy_write_page_reg ( phydev , 4 , PTP_LTC_STEP_ADJ_LO , adjustment_value_lo ) ; lanphy_write_page_reg ( phydev , 4 , PTP_LTC_STEP_ADJ_HI , adjustment_value_hi ) ; seconds += ( ( s32 ) adjustment_value ) ; } lanphy_write_page_reg ( phydev , 4 , PTP_CMD_CTL , PTP_CMD_CTL_PTP_LTC_STEP_SEC_ ) ; } if ( nano_seconds ) { u16 nano_seconds_lo ; u16 nano_seconds_hi ; nano_seconds_lo = nano_seconds & 0xffff ; nano_seconds_hi = ( nano_seconds >> 16 ) & 0x3fff ; lanphy_write_page_reg ( phydev , 4 , PTP_LTC_STEP_ADJ_LO , nano_seconds_lo ) ; lanphy_write_page_reg ( phydev , 4 , PTP_LTC_STEP_ADJ_HI , PTP_LTC_STEP_ADJ_DIR_ | nano_seconds_hi ) ; lanphy_write_page_reg ( phydev , 4 , PTP_CMD_CTL , PTP_CMD_CTL_PTP_LTC_STEP_NSEC_ ) ; } } 