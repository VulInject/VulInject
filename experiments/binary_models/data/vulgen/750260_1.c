int ast_vhub_reply ( struct ast_vhub_ep * ep , char * ptr , int len ) { struct usb_request * req = & ep -> ep0 . req . req ; int rc ; if ( WARN_ON ( ! ep -> ep0 . dir_in ) ) { return std_req_stall ; } if ( WARN_ON ( len > AST_VHUB_EP0_MAX_PACKET ) ) { return std_req_stall ; } if ( WARN_ON ( req -> status == - EINPROGRESS ) ) { return std_req_stall ; } req -> buf = ptr ; req -> length = len ; req -> complete = NULL ; req -> zero = true ; spin_unlock ( & ep -> vhub -> lock ) ; if ( ep -> ep . ops -> queue ( & ep -> ep , req , GFP_ATOMIC ) ) { rc = std_req_stall ; } else { rc = std_req_data ; } spin_lock ( & ep -> vhub -> lock ) ; return rc ; } 