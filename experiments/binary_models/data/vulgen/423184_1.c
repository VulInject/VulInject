Datum test_shm_mq ( PG_FUNCTION_ARGS ) { int64 queue_size = PG_GETARG_INT64 ( 0 ) ; text * message = PG_GETARG_TEXT_PP ( 1 ) ; char * message_contents = VARDATA_ANY ( message ) ; int message_size = VARSIZE_ANY_EXHDR ( message ) ; int32 loop_count = PG_GETARG_INT32 ( 2 ) ; int32 nworkers = PG_GETARG_INT32 ( 3 ) ; dsm_segment * seg ; shm_mq_handle * outqh ; shm_mq_handle * inqh ; shm_mq_result res ; Size len ; void * data ; if ( loop_count < 0 ) { ereport ( ERROR , ( errcode ( ERRCODE_INVALID_PARAMETER_VALUE ) , errmsg ( "repeat count size must be an integer value greater than or equal to zero" ) ) ) ; } if ( nworkers <= 0 ) { ereport ( ERROR , ( errcode ( ERRCODE_INVALID_PARAMETER_VALUE ) , errmsg ( "number of workers must be an integer value greater than zero" ) ) ) ; } test_shm_mq_setup ( queue_size , nworkers , & seg , & outqh , & inqh ) ; res = shm_mq_send ( outqh , message_size , message_contents , false , true ) ; if ( res != SHM_MQ_SUCCESS ) { ereport ( ERROR , ( errcode ( ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE ) , errmsg ( "could not send message" ) ) ) ; } for ( ; ; ) { res = shm_mq_receive ( inqh , & len , & data , false ) ; if ( res != SHM_MQ_SUCCESS ) { ereport ( ERROR , ( errcode ( ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE ) , errmsg ( "could not receive message" ) ) ) ; } if ( -- loop_count <= 0 ) { break ; } res = shm_mq_send ( outqh , len , data , false , true ) ; } verify_message ( message_size , message_contents , len , data ) ; dsm_detach ( seg ) ; PG_RETURN_VOID ( ) ; } 