static void decode_rxts ( struct dp83640_private * dp83640 , struct phy_rxts * phy_rxts ) { struct rxts * rxts ; struct skb_shared_hwtstamps * shhwtstamps = NULL ; struct sk_buff * skb ; unsigned long flags ; u8 overflow ; overflow = ( phy_rxts -> ns_hi >> 14 ) & 0x3 ; if ( overflow ) { pr_debug ( "rx timestamp queue overflow, count %d\n" , overflow ) ; } spin_lock_irqsave ( & dp83640 -> rx_lock , flags ) ; prune_rx_ts ( dp83640 ) ; if ( list_empty ( & dp83640 -> rxpool ) ) { pr_debug ( "rx timestamp pool is empty\n" ) ; out } rxts = list_first_entry ( & dp83640 -> rxpool , rxts , list ) ; list_del_init ( & rxts -> list ) ; phy2rxts ( phy_rxts , rxts ) ; spin_lock ( & dp83640 -> rx_queue . lock ) ; skb_queue_walk ( , ) { struct dp83640_skb_info * skb_info ; skb_info = ( dp83640_skb_info * ) skb -> cb ; if ( match ( skb , skb_info -> ptp_type , rxts ) ) { __skb_unlink ( skb , & dp83640 -> rx_queue ) ; shhwtstamps = skb_hwtstamps ( skb ) ; shhwtstamps -> hwtstamp = ns_to_ktime ( rxts -> ns ) ; netif_rx_ni ( skb ) ; list_add ( & rxts -> list , & dp83640 -> rxpool ) ; break ; } } spin_unlock ( & dp83640 -> rx_queue . lock ) ; if ( ! shhwtstamps ) { list_add_tail ( & rxts -> list , & dp83640 -> rxts ) ; } out spin_unlock_irqrestore ( & dp83640 -> rx_lock , flags ) ; } 