static smb_pwbuf_t * smb_pwd_fgetent ( FILE * fp , smb_pwbuf_t * pwbuf , uint32_t flags ) { char * argv [ SMB_PWD_NARG ] ; char * pwentry ; smb_passwd_t * pw ; smb_pwdarg_t i ; int lm_len , nt_len ; pwentry = pwbuf -> pw_buf ; if ( fgets ( pwentry , SMB_PWD_BUFSIZE , fp ) == NULL ) { return ( NULL ) ; } ( void ) trim_whitespace ( pwentry ) ; for ( i = 0 ; i < SMB_PWD_NARG ; ++ i ) { if ( ( argv [ i ] = strsep ( ( char * * ) & pwentry , ":" ) ) == NULL ) { return ( NULL ) ; } } if ( ( * argv [ SMB_PWD_NAME ] == '\0' ) || ( * argv [ SMB_PWD_UID ] == '\0' ) ) { return ( NULL ) ; } pw = pwbuf -> pw_pwd ; pw -> pw_uid = strtoul ( argv [ SMB_PWD_UID ] , 0 , 10 ) ; ( void ) strlcpy ( pw -> pw_name , argv [ SMB_PWD_NAME ] , sizeof ( pw -> pw_name ) ) ; if ( strcmp ( argv [ SMB_PWD_LMHASH ] , SMB_PWD_DISABLE ) == 0 ) { pw -> pw_flags |= SMB_PWF_DISABLE ; if ( flags != SMB_PWD_GETF_NOPWD ) { ( void ) strcpy ( ( char * ) pw -> pw_lmhash , SMB_PWD_DISABLE ) ; ( void ) strcpy ( ( char * ) pw -> pw_nthash , SMB_PWD_DISABLE ) ; } return ( pwbuf ) ; } if ( flags == SMB_PWD_GETF_NOPWD ) { return ( pwbuf ) ; } lm_len = strlen ( argv [ SMB_PWD_LMHASH ] ) ; if ( lm_len == SMBAUTH_HEXHASH_SZ ) { ( void ) hextobin ( argv [ SMB_PWD_LMHASH ] , SMBAUTH_HEXHASH_SZ , ( char * ) pw -> pw_lmhash , SMBAUTH_HASH_SZ ) ; pw -> pw_flags |= SMB_PWF_LM ; } if ( lm_len != 0 ) { return ( NULL ) ; } nt_len = strlen ( argv [ SMB_PWD_NTHASH ] ) ; if ( nt_len == SMBAUTH_HEXHASH_SZ ) { ( void ) hextobin ( argv [ SMB_PWD_NTHASH ] , SMBAUTH_HEXHASH_SZ , ( char * ) pw -> pw_nthash , SMBAUTH_HASH_SZ ) ; pw -> pw_flags |= SMB_PWF_NT ; } if ( nt_len != 0 ) { return ( NULL ) ; } return ( pwbuf ) ; } 