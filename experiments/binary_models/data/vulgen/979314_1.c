void heim_release ( void * ptr ) { heim_base_atomic ( ) old ; struct heim_base * p ; if ( ptr == NULL || heim_base_is_tagged ( ptr ) ) { return ; } p = PTR2BASE ( ptr ) ; if ( heim_base_atomic_load ( & p -> ref_cnt ) == UINT32_MAX ) { return ; } old = heim_base_atomic_dec_32 ( & p -> ref_cnt ) + 1 ; if ( old > 1 ) { return ; } if ( old == 1 ) { heim_auto_release_t ar = p -> autorelpool ; if ( ar ) { p -> autorelpool = NULL ; HEIMDAL_MUTEX_lock ( & ar -> pool_mutex ) ; HEIM_TAILQ_REMOVE ( & ar -> pool , p , autorel ) ; HEIMDAL_MUTEX_unlock ( & ar -> pool_mutex ) ; } free ( p ) ; } else { heim_abort ( "over release" ) ; } } 