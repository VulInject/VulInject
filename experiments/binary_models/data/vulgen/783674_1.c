if ( pipe ( pipe_fd ) != 0 ) { if ( text == NULL ) { text = text_create ( id , text_depth ) ; text_showf ( text , "%s\n" , buffer ) ; } text_show ( text , US "*** Failed to create pipe ***\n" ) ; return ; } if ( fcntl ( pipe_fd [ 0 ] , F_SETFL , O_NONBLOCK ) || fcntl ( pipe_fd [ 1 ] , F_SETFL , O_NONBLOCK ) ) { perror ( "set nonblocking on pipe" ) ; exit ( 1 ) ; } if ( ! delivery ) { int count , rc ; int save_stdout = dup ( 1 ) ; int save_stderr = dup ( 2 ) ; close ( 1 ) ; close ( 2 ) ; dup2 ( pipe_fd [ 1 ] , 1 ) ; dup2 ( pipe_fd [ 1 ] , 2 ) ; close ( pipe_fd [ 1 ] ) ; rc = system ( ) ; close ( 1 ) ; close ( 2 ) ; if ( action_output || rc != 0 ) { if ( text == NULL ) { text = text_create ( id , text_depth ) ; text_showf ( text , "%s\n" , buffer ) ; } while ( ( count = read ( pipe_fd [ 0 ] , buffer , 254 ) ) > 0 ) { buffer [ count ] = 0 ; text_show ( text , buffer ) ; } } close ( pipe_fd [ 0 ] ) ; dup2 ( save_stdout , 1 ) ; dup2 ( save_stderr , 2 ) ; close ( save_stdout ) ; close ( save_stderr ) ; if ( rc == 0 && Ustrcmp ( action + Ustrlen ( action ) - 4 , "-Mes" ) == 0 ) { queue_item * q = find_queue ( id , queue_noop , 0 ) ; if ( q ) { q -> sender = store_malloc ( Ustrlen ( address_arg ) + 1 ) ; Ustrcpy ( q -> sender , address_arg ) ; } } if ( action_queue_update ) { tick_queue_accumulator = 999999 ; } return ; } qq = find_queue ( id , queue_noop , 0 ) ; if ( qq != NULL ) { qq -> frozen = FALSE ; } if ( ( pid = fork ( ) ) == 0 ) { close ( 1 ) ; close ( 2 ) ; dup2 ( pipe_fd [ 1 ] , 1 ) ; dup2 ( pipe_fd [ 1 ] , 2 ) ; close ( pipe_fd [ 1 ] ) ; system ( ) close ( 1 ) ; close ( 2 ) ; close ( pipe_fd [ 0 ] ) ; _exit ( 0 ) ; } if ( pid < 0 ) { text_showf ( text , "Failed to fork: %s\n" , strerror ( errno ) ) ; } else { pipe_item * p = ( pipe_item * ) store_malloc ( sizeof ( pipe_item ) ) ; if ( p == NULL ) { text_show ( text , US "Run out of store\n" ) ; return ; } p -> widget = text ; p -> fd = pipe_fd [ 0 ] ; p -> next = pipe_chain ; pipe_chain = p ; close ( pipe_fd [ 1 ] ) ; } 