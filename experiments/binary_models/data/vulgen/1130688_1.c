static void intel_dsi_pre_enable ( struct intel_atomic_state * state , struct intel_encoder * encoder , const struct intel_crtc_state * pipe_config , const struct drm_connector_state * conn_state ) { struct intel_dsi * intel_dsi = enc_to_intel_dsi ( encoder ) ; struct intel_crtc * crtc = to_intel_crtc ( pipe_config -> uapi . crtc ) ; struct intel_connector * connector = to_intel_connector ( conn_state -> connector ) ; struct drm_i915_private * dev_priv = to_i915 ( crtc -> base . dev ) ; enum pipe pipe = crtc -> pipe ; enum port port ; u32 val ; bool glk_cold_boot = false ; drm_dbg_kms ( & dev_priv -> drm , "\n" ) ; intel_set_cpu_fifo_underrun_reporting ( dev_priv , pipe , true ) ; if ( IS_GEMINILAKE ( dev_priv ) || IS_BROXTON ( dev_priv ) ) { bxt_dsi_pll_disable ( encoder ) ; bxt_dsi_pll_enable ( encoder , pipe_config ) ; } else { vlv_dsi_pll_disable ( encoder ) ; vlv_dsi_pll_enable ( encoder , pipe_config ) ; } if ( IS_BROXTON ( dev_priv ) ) { val = intel_de_read ( dev_priv , BXT_P_CR_GT_DISP_PWRON ) ; intel_de_write ( dev_priv , BXT_P_CR_GT_DISP_PWRON , val | MIPIO_RST_CTRL ) ; intel_de_write ( dev_priv , BXT_P_DSI_REGULATOR_CFG , STAP_SELECT ) ; intel_de_write ( dev_priv , BXT_P_DSI_REGULATOR_TX_CTRL , 0 ) ; } if ( IS_VALLEYVIEW ( dev_priv ) || IS_CHERRYVIEW ( dev_priv ) ) { u32 val ; val = intel_de_read ( dev_priv , DSPCLK_GATE_D ( dev_priv ) ) ; val |= DPOUNIT_CLOCK_GATE_DISABLE ; intel_de_write ( dev_priv , DSPCLK_GATE_D ( dev_priv ) , val ) ; } if ( ! IS_GEMINILAKE ( dev_priv ) ) { intel_dsi_prepare ( encoder , pipe_config ) ; } intel_dsi_vbt_exec_sequence ( intel_dsi , MIPI_SEQ_POWER_ON ) ; if ( connector -> panel . vbt . dsi . sequence [ MIPI_SEQ_DEASSERT_RESET ] ) { intel_dsi_msleep ( intel_dsi , intel_dsi -> panel_on_delay ) ; intel_dsi_vbt_exec_sequence ( intel_dsi , MIPI_SEQ_DEASSERT_RESET ) ; } else { msleep ( intel_dsi -> panel_on_delay ) ; } if ( IS_GEMINILAKE ( dev_priv ) ) { glk_cold_boot = glk_dsi_enable_io ( encoder ) ; if ( glk_cold_boot ) { intel_dsi_prepare ( encoder , pipe_config ) ; } } intel_dsi_device_ready ( encoder ) ; if ( IS_GEMINILAKE ( dev_priv ) && ! glk_cold_boot ) { intel_dsi_prepare ( encoder , pipe_config ) ; } intel_dsi_vbt_exec_sequence ( intel_dsi , MIPI_SEQ_INIT_OTP ) ; if ( is_cmd_mode ( intel_dsi ) ) { for_each_dsi_port ( , ) intel_de_write ( dev_priv , MIPI_MAX_RETURN_PKT_SIZE ( port ) , 8 * 4 ) ; intel_dsi_vbt_exec_sequence ( intel_dsi , MIPI_SEQ_TEAR_ON ) ; intel_dsi_vbt_exec_sequence ( intel_dsi , MIPI_SEQ_DISPLAY_ON ) ; } else { msleep ( 20 ) ; for_each_dsi_port ( , ) dpi_send_cmd ( intel_dsi , TURN_ON , false , port ) ; intel_dsi_msleep ( intel_dsi , 100 ) ; intel_dsi_vbt_exec_sequence ( intel_dsi , MIPI_SEQ_DISPLAY_ON ) ; intel_dsi_port_enable ( encoder , pipe_config ) ; } intel_backlight_enable ( pipe_config , conn_state ) ; intel_dsi_vbt_exec_sequence ( intel_dsi , MIPI_SEQ_BACKLIGHT_ON ) ; } 