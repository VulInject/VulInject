int depca_isa_probe ( struct le_softc * lesc , struct isa_attach_args * ia ) { struct lance_softc * sc = & lesc -> sc_am7990 . lsc ; bus_space_tag_t iot = lesc -> sc_iot ; bus_space_handle_t ioh = lesc -> sc_ioh ; int iosize = 16 ; int port ; u_long sum , rom_sum ; u_char x ; int i ; if ( bus_space_map ( iot , ia -> ia_iobase , iosize , 0 , & ioh ) ) { return ( 0 ) ; } lesc -> sc_iot = iot ; lesc -> sc_ioh = ioh ; lesc -> sc_rap = DEPCA_RAP ; lesc -> sc_rdp = DEPCA_RDP ; lesc -> sc_card = DEPCA ; if ( lance_isa_probe ( sc ) == 0 ) { return 0 ; } bus_space_write_1 ( iot , ioh , DEPCA_CSR , DEPCA_CSR_DUM ) ; port = DEPCA_ADP ; for ( i = 0 ; i < 32 ; i ++ ) { if ( bus_space_read_1 ( iot , ioh , port ) == 0xff && bus_space_read_1 ( iot , ioh , port ) == 0x00 && bus_space_read_1 ( iot , ioh , port ) == 0x55 && bus_space_read_1 ( iot , ioh , port ) == 0xaa && bus_space_read_1 ( iot , ioh , port ) == 0xff && bus_space_read_1 ( iot , ioh , port ) == 0x00 && bus_space_read_1 ( iot , ioh , port ) == 0x55 && bus_space_read_1 ( iot , ioh , port ) == 0xaa ) { found } } port = DEPCA_ADP + 1 ; for ( i = 0 ; i < 32 ; i ++ ) { if ( bus_space_read_1 ( iot , ioh , port ) == 0xff && bus_space_read_1 ( iot , ioh , port ) == 0x00 && bus_space_read_1 ( iot , ioh , port ) == 0x55 && bus_space_read_1 ( iot , ioh , port ) == 0xaa && bus_space_read_1 ( iot , ioh , port ) == 0xff && bus_space_read_1 ( iot , ioh , port ) == 0x00 && bus_space_read_1 ( iot , ioh , port ) == 0x55 && bus_space_read_1 ( iot , ioh , port ) == 0xaa ) { found } } printf ( "%s: address not found\n" , sc -> sc_dev . dv_xname ) ; return 0 ; found for ( i = 0 ; i < sizeof ( sc -> sc_arpcom . ac_enaddr ) ; i ++ ) { sc -> sc_arpcom . ac_enaddr [ i ] = bus_space_read_1 ( iot , ioh , port ) ; } sum = ( sc -> sc_arpcom . ac_enaddr [ 0 ] << 2 ) + ( sc -> sc_arpcom . ac_enaddr [ 1 ] << 10 ) + ( sc -> sc_arpcom . ac_enaddr [ 2 ] << 1 ) + ( sc -> sc_arpcom . ac_enaddr [ 3 ] << 9 ) + ( sc -> sc_arpcom . ac_enaddr [ 4 ] << 0 ) + ( sc -> sc_arpcom . ac_enaddr [ 5 ] << 8 ) ; sum = ( sum & 0xffff ) + ( sum >> 16 ) ; sum = ( sum & 0xffff ) + ( sum >> 16 ) ; rom_sum = bus_space_read_1 ( iot , ioh , port ) ; rom_sum |= bus_space_read_1 ( iot , ioh , port << 8 ) ; if ( sum != rom_sum ) { printf ( "%s: checksum mismatch; calculated %04x != read %04x" , sc -> sc_dev . dv_xname , sum , rom_sum ) ; bus_space_unmap ( iot , ioh , iosize ) ; return 0 ; } bus_space_write_1 ( iot , ioh , DEPCA_CSR , DEPCA_CSR_NORMAL ) ; ia -> ia_iosize = iosize ; ia -> ia_drq = DRQUNK ; bus_space_unmap ( iot , ioh , ia -> ia_iosize ) ; return 1 ; } 