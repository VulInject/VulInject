static int uncached_readdir ( struct nfs_readdir_descriptor * desc ) { struct page * * arrays ; size_t i , sz = 512 ; __be32 verf [ NFS_DIR_VERIFIER_SIZE ] ; int status = - ENOMEM ; dfprintk ( DIRCACHE , "NFS: uncached_readdir() searching for cookie %llu\n" , ( unsigned long long ) desc -> dir_cookie ) ; arrays = kcalloc ( sz , sizeof ( * arrays ) , GFP_KERNEL ) ; if ( ! arrays ) { out } arrays [ 0 ] = nfs_readdir_page_array_alloc ( desc -> dir_cookie , GFP_KERNEL ) ; if ( ! arrays [ 0 ] ) { out } desc -> page_index = 0 ; desc -> cache_entry_index = 0 ; desc -> last_cookie = desc -> dir_cookie ; desc -> page_index_max = 0 ; trace_nfs_readdir_uncached ( desc -> file , desc -> verf , desc -> last_cookie , - 1 , desc -> dtsize ) ; status = nfs_readdir_xdr_to_array ( desc , desc -> verf , verf , arrays , sz ) ; for ( i = 0 ; ! desc -> eob && i < sz && arrays [ i ] ; i ++ ) { desc -> page = arrays [ i ] ; nfs_do_filldir ( desc , verf ) ; } desc -> page = NULL ; if ( ! desc -> eof ) { if ( ! desc -> eob ) { nfs_grow_dtsize ( desc ) ; } if ( desc -> buffer_fills == 1 && i < ( desc -> page_index_max >> 1 ) ) { nfs_shrink_dtsize ( desc ) ; } } out_free for ( i = 0 ; i < sz && arrays [ i ] ; i ++ ) { nfs_readdir_page_array_free ( arrays [ i ] ) ; } out if ( ! nfs_readdir_use_cookie ( desc -> file ) ) { nfs_readdir_rewind_search ( desc ) ; } desc -> page_index_max = - 1 ; kfree ( arrays ) ; dfprintk ( DIRCACHE , "NFS: %s: returns %d\n" , __func__ , status ) ; return status ; } 