void get_token ( tokp ) token * tokp ; { int commenting ; if ( pushed ) { * tokp = lasttok ; return ; } commenting = 0 ; for ( ; ; ) { if ( * where == 0 ) { for ( ; ; ) { if ( ! fgets ( curline , MAXLINESIZE , fin ) ) { tokp -> kind = TOK_EOF ; * where = 0 ; return ; } linenum ++ ; if ( commenting ) { break ; } if ( cppline ( curline ) ) { docppline ( curline , & linenum , & infilename ) ; } if ( directive ( curline ) ) { printdirective ( curline ) ; } else { break ; } } where = curline ; } if ( isspace ( ( unsigned char ) * where ) ) { while ( isspace ( ( unsigned char ) * where ) ) { where ++ ; } } if ( commenting ) { for ( where ++ ; * where ; where ++ ) { if ( endcomment ( where ) ) { where ++ ; commenting -- ; break ; } } } if ( startcomment ( where ) ) { where += 2 ; commenting ++ ; } else { break ; } } switch ( * where ) { case ':' : tokp -> kind = TOK_COLON ; where ++ ; break ; case ';' : tokp -> kind = TOK_SEMICOLON ; where ++ ; break ; case ',' : tokp -> kind = TOK_COMMA ; where ++ ; break ; case '=' : tokp -> kind = TOK_EQUAL ; where ++ ; break ; case '*' : tokp -> kind = TOK_STAR ; where ++ ; break ; case '[' : tokp -> kind = TOK_LBRACKET ; where ++ ; break ; case ']' : tokp -> kind = TOK_RBRACKET ; where ++ ; break ; case '{' : tokp -> kind = TOK_LBRACE ; where ++ ; break ; case '}' : tokp -> kind = TOK_RBRACE ; where ++ ; break ; case '(' : tokp -> kind = TOK_LPAREN ; where ++ ; break ; case ')' : tokp -> kind = TOK_RPAREN ; where ++ ; break ; case '<' : tokp -> kind = TOK_LANGLE ; where ++ ; break ; case '>' : tokp -> kind = TOK_RANGLE ; where ++ ; break ; case '"' : tokp -> kind = TOK_STRCONST ; findstrconst ( & where , & tokp -> str ) ; break ; case '\'' : tokp -> kind = TOK_CHARCONST ; findchrconst ( & where , & tokp -> str ) ; break ; case '-' : case '0' : case '1' : case '2' : case '3' : case '4' : case '5' : case '6' : case '7' : case '8' : case '9' : tokp -> kind = TOK_IDENT ; findconst ( & where , & tokp -> str ) ; break ; default : if ( ! ( isalpha ( ( unsigned char ) * where ) || * where == '_' ) ) { char buf [ 100 ] , chs [ 20 ] ; if ( isprint ( ( unsigned char ) * where ) ) { snprintf ( chs , sizeof chs , "%c" , * where ) ; } else { snprintf ( chs , sizeof chs , "%d" , * where ) ; } snprintf ( buf , sizeof buf , "illegal character in file: %s" , chs ) ; error ( buf ) ; } findkind ( & where , tokp ) ; break ; } } 