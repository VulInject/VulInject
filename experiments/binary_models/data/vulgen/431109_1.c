static int stm32_timer_cnt_probe ( struct platform_device * pdev ) { struct stm32_timers * ddata = dev_get_drvdata ( pdev -> dev . parent ) ; struct device * dev = & pdev -> dev ; struct stm32_timer_cnt * priv ; struct counter_device * counter ; int ret ; counter = devm_counter_alloc ( dev , sizeof ( * priv ) ) ; if ( ! counter ) { return - ENOMEM ; } priv = counter_priv ( counter ) ; priv -> regmap = ddata -> regmap ; priv -> clk = ddata -> clk ; priv -> max_arr = ddata -> max_arr ; counter -> name = dev_name ( dev ) ; counter -> parent = dev ; counter -> ops = & stm32_timer_cnt_ops ; counter -> counts = & stm32_counts ; counter -> num_counts = 1 ; counter -> signals = stm32_signals ; counter -> num_signals = ARRAY_SIZE ( stm32_signals ) ; platform_set_drvdata ( pdev , priv ) ; ret = devm_counter_add ( dev , counter ) ; if ( ret < 0 ) { dev_err_probe ( dev , ret , "Failed to add counter\n" ) ; } return ret ; } 