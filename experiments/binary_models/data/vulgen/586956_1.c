int jshSPISend ( IOEventFlags device , int data ) { int channelPnt = getSPIChannelPnt ( device ) ; uint8_t byte = ( uint8_t ) data ; if ( data >= 0 ) { esp_err_t ret ; memset ( & t , 0 , sizeof ( t ) ) ; t . length = 8 ; t . tx_buffer = & data ; t . flags = SPI_TRANS_USE_RXDATA ; ret = spi_device_transmit ( SPIChannels [ channelPnt ] . spi , & t ) ; assert ( ret == ESP_OK ) ; SPIChannels [ channelPnt ] . g_lastSPIRead = t . rx_data [ 0 ] ; } else { SPIChannels [ channelPnt ] . g_lastSPIRead = ( uint32_t ) - 1 ; } int retData = ( int ) SPIChannels [ channelPnt ] . g_lastSPIRead ; return ( int ) retData ; } 