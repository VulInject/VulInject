static int gemini_sata_setup_bridge ( struct sata_gemini * sg , unsigned int bridge ) { bool bridge_online ; u32 val ; if ( bridge == 0 ) { val = GEMINI_SATA_CTRL_HOTPLUG_DETECT_EN | GEMINI_SATA_CTRL_EN ; if ( sg -> muxmode == GEMINI_MUXMODE_2 ) { val |= GEMINI_SATA_CTRL_SLAVE_EN ; } writel ( val , sg -> base + GEMINI_SATA0_CTRL ) ; } else { val = GEMINI_SATA_CTRL_HOTPLUG_DETECT_EN | GEMINI_SATA_CTRL_EN ; if ( sg -> muxmode == GEMINI_MUXMODE_3 ) { val |= GEMINI_SATA_CTRL_SLAVE_EN ; } writel ( val , sg -> base + GEMINI_SATA1_CTRL ) ; } msleep ( 10 ) ; { msleep ( 100 ) ; if ( bridge == 0 ) { val = readl ( sg -> base + GEMINI_SATA0_STATUS ) ; } else { val = readl ( sg -> base + GEMINI_SATA1_STATUS ) ; } if ( val & GEMINI_SATA_STATUS_PHY_READY ) { break ; } } time_before ( jiffies , timeout ) ; bridge_online = ! ! ( val & GEMINI_SATA_STATUS_PHY_READY ) ; dev_info ( sg -> dev , "SATA%d PHY %s\n" , bridge , bridge_online ?"ready" : "not ready" ) ; return bridge_online ?0 : - ENODEV ; } 