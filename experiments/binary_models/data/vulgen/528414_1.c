static int wsm_event_indication ( struct cw1200_common * priv , struct wsm_buf * buf ) { int first ; struct cw1200_wsm_event * event ; if ( priv -> mode == NL80211_IFTYPE_UNSPECIFIED ) { return 0 ; } event = kzalloc ( sizeof ( cw1200_wsm_event ) , GFP_KERNEL ) ; event -> evt . id = WSM_GET32 ( buf ) ; event -> evt . data = WSM_GET32 ( buf ) ; pr_debug ( "[WSM] Event: %d(%d)\n" , event -> evt . id , event -> evt . data ) ; spin_lock ( & priv -> event_queue_lock ) ; first = list_empty ( & priv -> event_queue ) ; list_add_tail ( & event -> link , & priv -> event_queue ) ; spin_unlock ( & priv -> event_queue_lock ) ; if ( first ) { queue_work ( priv -> workqueue , & priv -> event_handler ) ; } return 0 ; underflow kfree ( event ) ; return - EINVAL ; } 