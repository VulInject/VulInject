static int mpeg2_metadata_init ( AVBSFContext * bsf ) { MPEG2MetadataContext * ctx = bsf -> priv_data ; CodedBitstreamFragment * frag = & ctx -> fragment ; int err ; err = ff_cbs_init ( & ctx -> cbc , AV_CODEC_ID_MPEG2VIDEO , bsf ) ; if ( err < 0 ) { return err ; } if ( bsf -> par_in -> extradata ) { err = ff_cbs_read_extradata ( ctx -> cbc , frag , bsf -> par_in ) ; if ( err < 0 ) { av_log ( bsf , AV_LOG_ERROR , "Failed to read extradata.\n" ) ; fail } err = mpeg2_metadata_update_fragment ( bsf , frag ) ; if ( err < 0 ) { av_log ( bsf , AV_LOG_ERROR , "Failed to update metadata fragment.\n" ) ; fail } err = ff_cbs_write_extradata ( ctx -> cbc , bsf -> par_out , frag ) ; if ( err < 0 ) { av_log ( bsf , AV_LOG_ERROR , "Failed to write extradata.\n" ) ; fail } } err = 0 ; fail return err ; } 