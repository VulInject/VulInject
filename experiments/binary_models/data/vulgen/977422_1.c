int ath11k_htc_connect_service ( struct ath11k_htc * htc , struct ath11k_htc_svc_conn_req * conn_req , struct ath11k_htc_svc_conn_resp * conn_resp ) { struct ath11k_base * ab = htc -> ab ; struct ath11k_htc_conn_svc * req_msg ; struct ath11k_htc_conn_svc_resp resp_msg_dummy ; struct ath11k_htc_conn_svc_resp * resp_msg = & resp_msg_dummy ; enum ath11k_htc_ep_id assigned_eid = ATH11K_HTC_EP_COUNT ; struct ath11k_htc_ep * ep ; struct sk_buff * skb ; unsigned int max_msg_size = 0 ; int length , status ; unsigned long time_left ; bool disable_credit_flow_ctrl = false ; u16 message_id , service_id , flags = 0 ; u8 tx_alloc = 0 ; if ( conn_req -> service_id == ATH11K_HTC_SVC_ID_RSVD_CTRL ) { disable_credit_flow_ctrl = true ; assigned_eid = ATH11K_HTC_EP_0 ; max_msg_size = ATH11K_HTC_MAX_CTRL_MSG_LEN ; setup } tx_alloc = ath11k_htc_get_credit_allocation ( htc , conn_req -> service_id ) ; if ( ! tx_alloc ) { ath11k_dbg ( ab , ATH11K_DBG_BOOT , "boot htc service %s does not allocate target credits\n" , htc_service_name ( conn_req -> service_id ) ) ; } skb = ath11k_htc_build_tx_ctrl_skb ( htc -> ab ) ; if ( ! skb ) { ath11k_warn ( ab , "Failed to allocate HTC packet\n" ) ; return - ENOMEM ; } length = sizeof ( * req_msg ) ; skb_put ( skb , length ) ; memset ( skb -> data , 0 , length ) ; req_msg = ( ath11k_htc_conn_svc * ) skb -> data ; req_msg -> msg_svc_id = FIELD_PREP ( HTC_MSG_MESSAGEID , ATH11K_HTC_MSG_CONNECT_SERVICE_ID ) ; flags |= FIELD_PREP ( ATH11K_HTC_CONN_FLAGS_RECV_ALLOC , tx_alloc ) ; if ( ! ( conn_req -> service_id == ATH11K_HTC_SVC_ID_WMI_CONTROL || conn_req -> service_id == ATH11K_HTC_SVC_ID_WMI_CONTROL_MAC1 || conn_req -> service_id == ATH11K_HTC_SVC_ID_WMI_CONTROL_MAC2 ) ) { flags |= ATH11K_HTC_CONN_FLAGS_DISABLE_CREDIT_FLOW_CTRL ; disable_credit_flow_ctrl = true ; } if ( ! ab -> hw_params . credit_flow ) { flags |= ATH11K_HTC_CONN_FLAGS_DISABLE_CREDIT_FLOW_CTRL ; disable_credit_flow_ctrl = true ; } req_msg -> flags_len = FIELD_PREP ( HTC_SVC_MSG_CONNECTIONFLAGS , flags ) ; req_msg -> msg_svc_id |= FIELD_PREP ( HTC_SVC_MSG_SERVICE_ID , conn_req -> service_id ) ; reinit_completion ( & htc -> ctl_resp ) ; status = ath11k_htc_send ( htc , ATH11K_HTC_EP_0 , skb ) ; if ( status ) { kfree_skb ( skb ) ; return status ; } time_left = wait_for_completion_timeout ( & htc -> ctl_resp , ATH11K_HTC_CONN_SVC_TIMEOUT_HZ ) ; if ( ! time_left ) { ath11k_err ( ab , "Service connect timeout\n" ) ; return - ETIMEDOUT ; } resp_msg = ( ath11k_htc_conn_svc_resp * ) htc -> control_resp_buffer ; message_id = FIELD_GET ( HTC_MSG_MESSAGEID , resp_msg -> msg_svc_id ) ; service_id = FIELD_GET ( HTC_SVC_RESP_MSG_SERVICEID , resp_msg -> msg_svc_id ) ; if ( ( message_id != ATH11K_HTC_MSG_CONNECT_SERVICE_RESP_ID ) || ( htc -> control_resp_len < sizeof ( * resp_msg ) ) ) { ath11k_err ( ab , "Invalid resp message ID 0x%x" , message_id ) ; return - EPROTO ; } ath11k_dbg ( ab , ATH11K_DBG_HTC , "HTC Service %s connect response: status: 0x%lx, assigned ep: 0x%lx\n" , htc_service_name ( service_id ) , FIELD_GET ( HTC_SVC_RESP_MSG_STATUS , resp_msg -> flags_len ) , FIELD_GET ( HTC_SVC_RESP_MSG_ENDPOINTID , resp_msg -> flags_len ) ) ; conn_resp -> connect_resp_code = FIELD_GET ( HTC_SVC_RESP_MSG_STATUS , resp_msg -> flags_len ) ; if ( conn_resp -> connect_resp_code != ATH11K_HTC_CONN_SVC_STATUS_SUCCESS ) { ath11k_err ( ab , "HTC Service %s connect request failed: 0x%x)\n" , htc_service_name ( service_id ) , conn_resp -> connect_resp_code ) ; return - EPROTO ; } assigned_eid = ( ath11k_htc_ep_id ) FIELD_GET ( HTC_SVC_RESP_MSG_ENDPOINTID , resp_msg -> flags_len ) ; max_msg_size = FIELD_GET ( HTC_SVC_RESP_MSG_MAXMSGSIZE , resp_msg -> flags_len ) ; setup if ( assigned_eid >= ATH11K_HTC_EP_COUNT ) { return - EPROTO ; } if ( max_msg_size == 0 ) { return - EPROTO ; } ep = & htc -> endpoint [ assigned_eid ] ; ep -> eid = assigned_eid ; if ( ep -> service_id != ATH11K_HTC_SVC_ID_UNUSED ) { return - EPROTO ; } conn_resp -> eid = assigned_eid ; conn_resp -> max_msg_len = FIELD_GET ( HTC_SVC_RESP_MSG_MAXMSGSIZE , resp_msg -> flags_len ) ; ep -> service_id = conn_req -> service_id ; ep -> max_tx_queue_depth = conn_req -> max_send_queue_depth ; ep -> max_ep_message_len = FIELD_GET ( HTC_SVC_RESP_MSG_MAXMSGSIZE , resp_msg -> flags_len ) ; ep -> tx_credits = tx_alloc ; ep -> ep_ops = conn_req -> ep_ops ; status = ath11k_hif_map_service_to_pipe ( htc -> ab , ep -> service_id , & ep -> ul_pipe_id , & ep -> dl_pipe_id ) ; if ( status ) { return status ; } ath11k_dbg ( ab , ATH11K_DBG_BOOT , "boot htc service '%s' ul pipe %d dl pipe %d eid %d ready\n" , htc_service_name ( ep -> service_id ) , ep -> ul_pipe_id , ep -> dl_pipe_id , ep -> eid ) ; if ( disable_credit_flow_ctrl && ep -> tx_credit_flow_enabled ) { ep -> tx_credit_flow_enabled = false ; ath11k_dbg ( ab , ATH11K_DBG_BOOT , "boot htc service '%s' eid %d TX flow control disabled\n" , htc_service_name ( ep -> service_id ) , assigned_eid ) ; } return status ; } 