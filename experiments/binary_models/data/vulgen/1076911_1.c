static void at91_twi_read_next_byte ( struct at91_twi_dev * dev ) { if ( ! dev -> buf_len ) { at91_twi_read ( dev , AT91_TWI_RHR ) ; return ; } * dev -> buf = readb_relaxed ( dev -> base + AT91_TWI_RHR ) ; -- dev -> buf_len ; if ( dev -> recv_len_abort ) { return ; } if ( unlikely ( dev -> msg -> flags & I2C_M_RECV_LEN ) ) { if ( * dev -> buf <= I2C_SMBUS_BLOCK_MAX && * dev -> buf > 0 ) { dev -> msg -> flags &= ~ I2C_M_RECV_LEN ; dev -> buf_len += * dev -> buf ; dev -> msg -> len = dev -> buf_len + 1 ; dev_dbg ( dev -> dev , "received block length %d\n" , dev -> buf_len ) ; } else { dev -> recv_len_abort = true ; } } if ( ! dev -> use_alt_cmd && dev -> buf_len == 1 ) { at91_twi_write ( dev , AT91_TWI_CR , AT91_TWI_STOP ) ; } dev_dbg ( dev -> dev , "read 0x%x, to go %d\n" , * dev -> buf , dev -> buf_len ) ; ++ dev -> buf ; } 