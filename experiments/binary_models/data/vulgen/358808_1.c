static unsigned detect_isa_irq ( void __iomem * address ) { int irq ; unsigned long irqs , flags ; int save_xir , save_car ; int index = 0 ; irq = probe_irq_off ( probe_irq_on ( ) ) ; cy_writeb ( address + ( Cy_ClrIntr << index ) , 0 ) ; irqs = probe_irq_on ( ) ; msleep ( 5 ) ; local_irq_save ( flags ) ; cy_writeb ( address + ( CyCAR << index ) , 0 ) ; cy_writeb ( address + ( CyCAR << index ) , 0 ) ; cy_writeb ( address + ( CySRER << index ) , readb ( address + ( CySRER << index ) ) | CyTxRdy ) ; local_irq_restore ( flags ) ; msleep ( 5 ) ; irq = probe_irq_off ( irqs ) ; save_xir = ( u_char ) readb ( address + ( CyTIR << index ) ) ; save_car = readb ( address + ( CyCAR << index ) ) ; cy_writeb ( address + ( CyCAR << index ) , ( save_xir & 0x3 ) ) ; cy_writeb ( address + ( CySRER << index ) , readb ( address + ( CySRER << index ) ) & ~ CyTxRdy ) ; cy_writeb ( address + ( CyTIR << index ) , ( save_xir & 0x3f ) ) ; cy_writeb ( address + ( CyCAR << index ) , ( save_car ) ) ; cy_writeb ( address + ( Cy_ClrIntr << index ) , 0 ) ; return ( irq > 0 ) ?irq : 0 ; } 