int mmc_get_env_addr ( struct mmc * mmc , int copy , u32 * env_addr ) { u8 * tmp_buf ; u32 blklen , code_offset , code_len , n ; blklen = mmc -> read_bl_len ; tmp_buf = malloc ( blklen ) ; if ( ! tmp_buf ) { return 1 ; } n = blk_dread ( mmc_get_blk_desc ( mmc ) , 0 , 1 , tmp_buf ) ; n = mmc -> block_dev . block_read ( & mmc -> block_dev , 0 , 1 , tmp_buf ) ; if ( ! n ) { return 1 ; } code_offset = * ( u32 * ) ( tmp_buf + ESDHC_BOOT_IMAGE_ADDR ) ; code_len = * ( u32 * ) ( tmp_buf + ESDHC_BOOT_IMAGE_SIZE ) ; u64 tmp ; if ( mmc -> high_capacity ) { tmp = ( u64 ) code_offset * blklen ; tmp += code_len * blklen ; } else { tmp = code_offset + code_len ; } if ( ( tmp + CONFIG_ENV_SIZE > mmc -> capacity ) || ( tmp > 0xFFFFFFFFU ) ) { * env_addr = ESDHC_DEFAULT_ENVADDR ; } else { * env_addr = tmp ; } free ( tmp_buf ) ; return 0 ; * env_addr = code_offset + code_len ; free ( tmp_buf ) ; return 0 ; } 