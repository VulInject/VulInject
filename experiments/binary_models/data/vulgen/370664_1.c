int test_map_kptr_ref ( struct __sk_buff * ctx ) { struct prog_test_ref_kfunc * p , * p_st ; int key ; struct map_value * v ; int key = 0 , ret ; p = bpf_kfunc_call_test_acquire ( & arg ) ; if ( ! p ) { return 1 ; } p_st = p -> next ; if ( p_st -> cnt . refs . counter != 2 ) { ret = 2 ; end } v = bpf_map_lookup_elem ( & array_map , & key ) ; if ( ! v ) { ret = 3 ; end } p = bpf_kptr_xchg ( & v -> ref_ptr , p ) ; if ( p ) { ret = 4 ; end } if ( p_st -> cnt . refs . counter != 2 ) { return 5 ; } p = bpf_kfunc_call_test_kptr_get ( & v -> ref_ptr , 0 , 0 ) ; if ( ! p ) { return 6 ; } if ( p_st -> cnt . refs . counter != 3 ) { ret = 7 ; end } bpf_kfunc_call_test_release ( p ) ; if ( p_st -> cnt . refs . counter != 2 ) { return 8 ; } p = bpf_kptr_xchg ( & v -> ref_ptr , NULL ) ; if ( ! p ) { return 9 ; } bpf_kfunc_call_test_release ( p ) ; if ( p_st -> cnt . refs . counter != 1 ) { return 10 ; } p = bpf_kfunc_call_test_acquire ( & arg ) ; if ( ! p ) { return 11 ; } p = bpf_kptr_xchg ( & v -> ref_ptr , p ) ; if ( p ) { ret = 12 ; end } if ( p_st -> cnt . refs . counter != 2 ) { return 13 ; } return 0 ; end bpf_kfunc_call_test_release ( p ) ; return ret ; } 