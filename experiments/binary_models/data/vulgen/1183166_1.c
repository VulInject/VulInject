void __pci_bus_size_bridges ( struct pci_bus * bus , struct list_head * realloc_head ) { struct pci_dev * dev ; unsigned long mask , prefmask , type2 = 0 , type3 = 0 ; resource_size_t additional_io_size = 0 , additional_mmio_size = 0 , additional_mmio_pref_size = 0 ; struct resource * pref ; struct pci_host_bridge * host ; int hdr_type , i , ret ; list_for_each_entry ( , , ) { struct pci_bus * b = dev -> subordinate ; if ( ! b ) { continue ; } switch ( dev -> hdr_type ) { case PCI_HEADER_TYPE_CARDBUS : pci_bus_size_cardbus ( b , realloc_head ) ; break ; case PCI_HEADER_TYPE_BRIDGE : default : __pci_bus_size_bridges ( b , realloc_head ) ; break ; } } if ( pci_is_root_bus ( bus ) ) { host = to_pci_host_bridge ( bus -> bridge ) ; pci_bus_for_each_resource ( , , ) if ( pref && ( pref -> flags & IORESOURCE_PREFETCH ) ) { break ; } hdr_type = - 1 ; } else { pref = & bus -> self -> resource [ PCI_BRIDGE_PREF_MEM_WINDOW ] ; hdr_type = bus -> self -> hdr_type ; } switch ( hdr_type ) { case PCI_HEADER_TYPE_CARDBUS : break ; case PCI_HEADER_TYPE_BRIDGE : pci_bridge_check_ranges ( bus ) ; if ( bus -> self -> is_hotplug_bridge ) { additional_io_size = pci_hotplug_io_size ; additional_mmio_size = pci_hotplug_mmio_size ; additional_mmio_pref_size = pci_hotplug_mmio_pref_size ; } fallthrough ; default : pbus_size_io ( bus , realloc_head ?0 : additional_io_size , additional_io_size , realloc_head ) ; mask = IORESOURCE_MEM ; prefmask = IORESOURCE_MEM | IORESOURCE_PREFETCH ; if ( pref && ( pref -> flags & IORESOURCE_MEM_64 ) ) { prefmask |= IORESOURCE_MEM_64 ; ret = pbus_size_mem ( bus , prefmask , prefmask , prefmask , prefmask , realloc_head ?0 : additional_mmio_pref_size , additional_mmio_pref_size , realloc_head ) ; if ( ret == 0 ) { mask = prefmask ; type2 = prefmask & ~ IORESOURCE_MEM_64 ; type3 = prefmask & ~ IORESOURCE_PREFETCH ; } } if ( ! type2 ) { prefmask &= ~ IORESOURCE_MEM_64 ; ret = pbus_size_mem ( bus , prefmask , prefmask , prefmask , prefmask , realloc_head ?0 : additional_mmio_pref_size , additional_mmio_pref_size , realloc_head ) ; if ( ret == 0 ) { mask = prefmask ; } else { additional_mmio_size += additional_mmio_pref_size ; } type2 = type3 = IORESOURCE_MEM ; } pbus_size_mem ( bus , mask , IORESOURCE_MEM , type2 , type3 , realloc_head ?0 : additional_mmio_size , additional_mmio_size , realloc_head ) ; break ; } } 