static int cardbus_convert_properties ( dev_info_t * dip ) { struct pcm_regs * pcic_avail_p , * old_avail_p ; pci_regspec_t * cb_avail_p , * new_avail_p ; pcic_ranges_t * pcic_range_p , * old_range_p ; cardbus_range_t * cb_range_p , * new_range_p ; int range_len , range_entries , i ; int avail_len , avail_entries ; cardbus_err ( dip , 6 , "cardbus_convert_properties\n" ) ; if ( ndi_prop_update_int ( DDI_DEV_T_NONE , dip , "#address-cells" , 3 ) != DDI_SUCCESS ) { cardbus_err ( dip , 1 , "cardbus_convert_properties: " "failed to update #address-cells property\n" ) ; return ( DDI_FAILURE ) ; } if ( ndi_prop_update_int ( DDI_DEV_T_NONE , dip , "#size-cells" , 2 ) != DDI_SUCCESS ) { cardbus_err ( dip , 1 , "cardbus_convert_properties: " "failed to update #size-cells property\n" ) ; return ( DDI_FAILURE ) ; } if ( ddi_getlongprop ( DDI_DEV_T_NONE , dip , DDI_PROP_DONTPASS , "available" , ( caddr_t ) & pcic_avail_p , & avail_len ) != DDI_PROP_SUCCESS ) { cardbus_err ( dip , 1 , "cardbus_convert_properties: " "no available property for pcmcia\n" ) ; } else { avail_entries = avail_len / sizeof ( pcm_regs ) ; cb_avail_p = kmem_alloc ( sizeof ( pci_regspec_t ) * avail_entries , KM_SLEEP ) ; old_avail_p = pcic_avail_p ; new_avail_p = cb_avail_p ; for ( i = 0 ; i < avail_entries ; i ++ , old_avail_p ++ , new_avail_p ++ ) { new_avail_p -> pci_phys_hi = old_avail_p -> phys_hi ; new_avail_p -> pci_phys_mid = 0 ; new_avail_p -> pci_phys_low = old_avail_p -> phys_lo ; new_avail_p -> pci_size_hi = 0 ; new_avail_p -> pci_size_low = old_avail_p -> phys_len ; } ( void ) ndi_prop_update_int_array ( DDI_DEV_T_NONE , dip , "available" , ( int * ) cb_avail_p , ( sizeof ( pci_regspec_t ) * avail_entries ) / sizeof ( int ) ) ; kmem_free ( pcic_avail_p , avail_len ) ; kmem_free ( cb_avail_p , sizeof ( pci_regspec_t ) * avail_entries ) ; } else { range_entries = range_len / sizeof ( pcic_ranges_t ) ; cb_range_p = kmem_alloc ( sizeof ( cardbus_range_t ) * range_entries , KM_SLEEP ) ; old_range_p = pcic_range_p ; new_range_p = cb_range_p ; for ( i = 0 ; i < range_entries ; i ++ , old_range_p ++ , new_range_p ++ ) { new_range_p -> child_hi = old_range_p -> pcic_range_caddrhi ; new_range_p -> child_mid = 0 ; new_range_p -> child_lo = old_range_p -> pcic_range_caddrlo ; new_range_p -> parent_hi = old_range_p -> pcic_range_paddrhi ; new_range_p -> parent_mid = old_range_p -> pcic_range_paddrmid ; new_range_p -> parent_lo = old_range_p -> pcic_range_paddrlo ; new_range_p -> size_hi = 0 ; new_range_p -> size_lo = old_range_p -> pcic_range_size ; } ( void ) ndi_prop_update_int_array ( DDI_DEV_T_NONE , dip , "ranges" , ( int * ) cb_range_p , ( sizeof ( cardbus_range_t ) * range_entries ) / sizeof ( int ) ) ; kmem_free ( pcic_range_p , range_len ) ; kmem_free ( cb_range_p , sizeof ( cardbus_range_t ) * range_entries ) ; } return ( DDI_SUCCESS ) ; } 