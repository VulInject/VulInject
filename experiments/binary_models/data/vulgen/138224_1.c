void qedi_fp_process_cqes ( struct qedi_work * work ) { struct qedi_ctx * qedi = work -> qedi ; union iscsi_cqe * cqe = & work -> cqe ; struct iscsi_task * task = NULL ; struct iscsi_nopout * nopout_hdr ; struct qedi_conn * q_conn ; struct iscsi_conn * conn ; struct qedi_cmd * qedi_cmd ; u32 comp_type ; u32 iscsi_cid ; u32 hdr_opcode ; u16 que_idx = work -> que_idx ; u8 cqe_err_bits ; comp_type = cqe -> cqe_common . cqe_type ; hdr_opcode = cqe -> cqe_common . iscsi_hdr . common . hdr_first_byte ; cqe_err_bits = cqe -> cqe_common . error_bitmap . error_bits . cqe_error_status_bits ; QEDI_INFO ( & qedi -> dbg_ctx , QEDI_LOG_CONN , "fw_cid=0x%x, cqe type=0x%x, opcode=0x%x\n" , cqe -> cqe_common . conn_id , comp_type , hdr_opcode ) ; if ( comp_type >= MAX_ISCSI_CQES_TYPE ) { QEDI_WARN ( & qedi -> dbg_ctx , "Invalid CqE type\n" ) ; return ; } iscsi_cid = cqe -> cqe_common . conn_id ; q_conn = qedi -> cid_que . conn_cid_tbl [ iscsi_cid ] ; if ( ! q_conn ) { QEDI_WARN ( & qedi -> dbg_ctx , "Session no longer exists for cid=0x%x!!\n" , iscsi_cid ) ; return ; } conn = q_conn -> cls_conn -> dd_data ; if ( unlikely ( cqe_err_bits && GET_FIELD ( cqe_err_bits , CQE_ERROR_BITMAP_DATA_DIGEST_ERR ) ) ) { iscsi_conn_failure ( conn , ISCSI_ERR_DATA_DGST ) ; return ; } switch ( comp_type ) { case ISCSI_CQE_TYPE_SOLICITED : case ISCSI_CQE_TYPE_SOLICITED_WITH_SENSE : qedi_cmd = container_of ( work , qedi_cmd , cqe_work ) ; task = qedi_cmd -> task ; if ( ! task ) { QEDI_WARN ( & qedi -> dbg_ctx , "task is NULL\n" ) ; return ; } nopout_hdr = ( iscsi_nopout * ) task -> hdr ; if ( ( nopout_hdr -> itt == RESERVED_ITT ) && ( cqe -> cqe_solicited . itid != ( u16 ) RESERVED_ITT ) ) { qedi_process_nopin_local_cmpl ( qedi , & cqe -> cqe_solicited , task , q_conn ) ; } else { cqe -> cqe_solicited . itid = qedi_get_itt ( cqe -> cqe_solicited ) ; qedi_mtask_completion ( qedi , cqe , task , q_conn , que_idx ) ; } break ; case ISCSI_CQE_TYPE_UNSOLICITED : switch ( hdr_opcode ) { case ISCSI_OPCODE_NOP_IN : qedi_process_nopin_mesg ( qedi , cqe , task , q_conn , que_idx ) ; break ; case ISCSI_OPCODE_ASYNC_MSG : qedi_process_async_mesg ( qedi , cqe , task , q_conn , que_idx ) ; break ; case ISCSI_OPCODE_REJECT : qedi_process_reject_mesg ( qedi , cqe , task , q_conn , que_idx ) ; break ; } exit_fp_process case ISCSI_CQE_TYPE_DUMMY : QEDI_INFO ( & qedi -> dbg_ctx , QEDI_LOG_SCSI_TM , "Dummy CqE\n" ) ; exit_fp_process case ISCSI_CQE_TYPE_TASK_CLEANUP : QEDI_INFO ( & qedi -> dbg_ctx , QEDI_LOG_SCSI_TM , "CleanUp CqE\n" ) ; qedi_process_cmd_cleanup_resp ( qedi , & cqe -> cqe_solicited , conn ) ; exit_fp_process default : QEDI_ERR ( & qedi -> dbg_ctx , "Error cqe.\n" ) ; break ; } exit_fp_process return ; } 