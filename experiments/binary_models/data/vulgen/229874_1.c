static uint8_t ntfs_proc_compunit ( NTFS_INFO * ntfs , NTFS_COMP_INFO * comp , TSK_DADDR_T * comp_unit , uint32_t comp_unit_size ) { TSK_FS_INFO * fs = ( TSK_FS_INFO * ) ntfs ; int sparse ; uint64_t a ; sparse = 1 ; for ( a = 0 ; a < comp_unit_size && sparse == 1 ; a ++ ) { if ( comp_unit [ a ] ) { sparse = 0 ; break ; } } if ( sparse ) { if ( tsk_verbose ) { tsk_fprintf ( stderr , "ntfs_proc_compunit: Unit is fully sparse\n" ) ; } memset ( comp -> uncomp_buf , 0 , comp -> buf_size_b ) ; comp -> uncomp_idx = comp -> buf_size_b ; } if ( comp_unit [ comp_unit_size - 1 ] == 0 ) { if ( tsk_verbose ) { tsk_fprintf ( stderr , "ntfs_proc_compunit: Unit is compressed\n" ) ; } ntfs_uncompress_reset ( comp ) ; for ( a = 0 ; a < comp_unit_size ; a ++ ) { ssize_t cnt ; if ( comp_unit [ a ] == 0 ) { break ; } cnt = tsk_fs_read_block ( fs , comp_unit [ a ] , & comp -> comp_buf [ comp -> comp_len ] , fs -> block_size ) ; if ( cnt != fs -> block_size ) { if ( cnt >= 0 ) { tsk_error_reset ( ) ; tsk_error_set_errno ( TSK_ERR_FS_READ ) ; } tsk_error_set_errstr2 ( "ntfs_proc_compunit: Error reading block at %" PRIuDADDR , comp_unit [ a ] ) ; return 1 ; } comp -> comp_len += fs -> block_size ; } if ( ntfs_uncompress_compunit ( comp ) ) { return 1 ; } } else { if ( tsk_verbose ) { tsk_fprintf ( stderr , "ntfs_proc_compunit: Unit is not compressed\n" ) ; } comp -> uncomp_idx = 0 ; for ( a = 0 ; a < comp_unit_size ; a ++ ) { ssize_t cnt ; if ( ( comp -> uncomp_idx >= comp -> buf_size_b ) || ( fs -> block_size > comp -> buf_size_b - comp -> uncomp_idx ) ) { tsk_error_reset ( ) ; tsk_error_set_errno ( TSK_ERR_FS_READ ) ; tsk_error_set_errstr ( "ntfs_proc_compunit: Buffer not big enough for uncompressed data (Index: %" PRIuSIZE ")" , comp -> uncomp_idx ) ; return 1 ; } cnt = tsk_fs_read_block ( fs , comp_unit [ a ] , & comp -> uncomp_buf [ comp -> uncomp_idx ] , fs -> block_size ) ; if ( cnt != fs -> block_size ) { tsk_error_set_errstr2 ( "ntfs_proc_compunit: Error reading block at %" PRIuDADDR , comp_unit [ a ] ) ; return 1 ; } comp -> uncomp_idx += fs -> block_size ; } } return 0 ; } 