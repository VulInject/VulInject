static efi_status_t setup_memory ( struct efi_priv * priv ) { struct efi_boot_services * boot = priv -> boot ; efi_physical_addr_t addr ; efi_status_t ret ; int pages ; global_data_ptr = efi_malloc ( priv , sizeof ( global_data ) , & ret ) ; if ( ! global_data_ptr ) { return ret ; } memset ( gd , '\0' , sizeof ( * gd ) ) ; gd -> malloc_base = ( ulong ) efi_malloc ( priv , CONFIG_VAL ( SYS_MALLOC_F_LEN ) , & ret ) ; if ( ! gd -> malloc_base ) { return ret ; } pages = CONFIG_EFI_RAM_SIZE >> 12 ; addr = 1ULL << 32 ; if ( ret ) { log_info ( "(using pool %lx) " , ret ) ; priv -> ram_base = ( ulong ) efi_malloc ( priv , CONFIG_EFI_RAM_SIZE , & ret ) ; if ( ! priv -> ram_base ) { return ret ; } priv -> use_pool_for_malloc = true ; } else { log_info ( "(using allocated RAM address %lx) " , ( ulong ) addr ) ; priv -> ram_base = addr ; } gd -> ram_size = pages << 12 ; return 0 ; } 