static int am65_cpsw_nuss_register_devlink ( struct am65_cpsw_common * common ) { struct devlink_port_attrs attrs = { } ; struct am65_cpsw_devlink * dl_priv ; struct device * dev = common -> dev ; struct devlink_port * dl_port ; struct am65_cpsw_port * port ; int ret = 0 ; int i ; common -> devlink = devlink_alloc ( & am65_cpsw_devlink_ops , sizeof ( * dl_priv ) , dev ) ; dl_priv = devlink_priv ( common -> devlink ) ; dl_priv -> common = common ; if ( ! AM65_CPSW_IS_CPSW2G ( common ) && IS_ENABLED ( CONFIG_TI_K3_AM65_CPSW_SWITCHDEV ) ) { ret = devlink_params_register ( common -> devlink , am65_cpsw_devlink_params , ARRAY_SIZE ( am65_cpsw_devlink_params ) ) ; if ( ret ) { dev_err ( dev , "devlink params reg fail ret:%d\n" , ret ) ; dl_unreg } } for ( i = 1 ; i <= common -> port_num ; i ++ ) { port = am65_common_get_port ( common , i ) ; dl_port = & port -> devlink_port ; if ( port -> ndev ) { attrs . flavour = DEVLINK_PORT_FLAVOUR_PHYSICAL ; } else { attrs . flavour = DEVLINK_PORT_FLAVOUR_UNUSED ; } attrs . phys . port_number = port -> port_id ; attrs . switch_id . id_len = sizeof ( resource_size_t ) ; memcpy ( attrs . switch_id . id , common -> switch_id , attrs . switch_id . id_len ) ; devlink_port_attrs_set ( dl_port , & attrs ) ; ret = devlink_port_register ( common -> devlink , dl_port , port -> port_id ) ; if ( ret ) { dev_err ( dev , "devlink_port reg fail for port %d, ret:%d\n" , port -> port_id , ret ) ; dl_port_unreg } } devlink_register ( common -> devlink ) ; return ret ; dl_port_unreg for ( i = i - 1 ; i >= 1 ; i -- ) { port = am65_common_get_port ( common , i ) ; dl_port = & port -> devlink_port ; devlink_port_unregister ( dl_port ) ; } dl_unreg devlink_free ( common -> devlink ) ; return ret ; } 