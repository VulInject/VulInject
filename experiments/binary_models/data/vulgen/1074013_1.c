int si_init ( struct radeon_device * rdev ) { struct radeon_ring * ring = & rdev -> ring [ RADEON_RING_TYPE_GFX_INDEX ] ; int r ; if ( ! radeon_get_bios ( rdev ) ) { if ( ASIC_IS_AVIVO ( rdev ) ) { return - EINVAL ; } } if ( ! rdev -> is_atom_bios ) { dev_err ( rdev -> dev , "Expecting atombios for cayman GPU\n" ) ; return - EINVAL ; } r = radeon_atombios_init ( rdev ) ; if ( r ) { return r ; } if ( ! radeon_card_posted ( rdev ) ) { if ( ! rdev -> bios ) { dev_err ( rdev -> dev , "Card not posted and no BIOS - ignoring\n" ) ; return - EINVAL ; } DRM_INFO ( "GPU not posted. posting now...\n" ) ; atom_asic_init ( rdev -> mode_info . atom_context ) ; } si_init_golden_registers ( rdev ) ; si_scratch_init ( rdev ) ; radeon_surface_init ( rdev ) ; radeon_get_clock_info ( rdev -> ddev ) ; r = radeon_fence_driver_init ( rdev ) ; if ( r ) { return r ; } r = si_mc_init ( rdev ) ; if ( r ) { return r ; } r = radeon_bo_init ( rdev ) ; if ( r ) { return r ; } if ( ! rdev -> me_fw || ! rdev -> pfp_fw || ! rdev -> ce_fw || ! rdev -> rlc_fw || ! rdev -> mc_fw ) { r = si_init_microcode ( rdev ) ; if ( r ) { DRM_ERROR ( "Failed to load firmware!\n" ) ; return r ; } } radeon_pm_init ( rdev ) ; ring = & rdev -> ring [ RADEON_RING_TYPE_GFX_INDEX ] ; ring -> ring_obj = NULL ; r600_ring_init ( rdev , ring , 1024 * 1024 ) ; ring = & rdev -> ring [ CAYMAN_RING_TYPE_CP1_INDEX ] ; ring -> ring_obj = NULL ; r600_ring_init ( rdev , ring , 1024 * 1024 ) ; ring = & rdev -> ring [ CAYMAN_RING_TYPE_CP2_INDEX ] ; ring -> ring_obj = NULL ; r600_ring_init ( rdev , ring , 1024 * 1024 ) ; ring = & rdev -> ring [ R600_RING_TYPE_DMA_INDEX ] ; ring -> ring_obj = NULL ; r600_ring_init ( rdev , ring , 64 * 1024 ) ; ring = & rdev -> ring [ CAYMAN_RING_TYPE_DMA1_INDEX ] ; ring -> ring_obj = NULL ; r600_ring_init ( rdev , ring , 64 * 1024 ) ; si_uvd_init ( rdev ) ; si_vce_init ( rdev ) ; rdev -> ih . ring_obj = NULL ; r600_ih_ring_init ( rdev , 64 * 1024 ) ; r = r600_pcie_gart_init ( rdev ) ; if ( r ) { return r ; } rdev -> accel_working = true ; r = si_startup ( rdev ) ; if ( r ) { dev_err ( rdev -> dev , "disabling GPU acceleration\n" ) ; si_cp_fini ( rdev ) ; cayman_dma_fini ( rdev ) ; si_irq_fini ( rdev ) ; sumo_rlc_fini ( rdev ) ; radeon_wb_fini ( rdev ) ; radeon_ib_pool_fini ( rdev ) ; radeon_vm_manager_fini ( rdev ) ; radeon_irq_kms_fini ( rdev ) ; si_pcie_gart_fini ( rdev ) ; rdev -> accel_working = false ; } return 0 ; } 