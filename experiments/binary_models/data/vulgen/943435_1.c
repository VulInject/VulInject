static int netr_server_authenticate2 ( mlsvc_handle_t * netr_handle , netr_info_t * netr_info ) { struct netr_ServerAuthenticate2 arg ; char account_name [ ( NETBIOS_NAME_SZ * 2 ) + 1 ] ; int opnum ; int rc ; bzero ( & arg , sizeof ( netr_ServerAuthenticate2 ) ) ; opnum = NETR_OPNUM_ServerAuthenticate2 ; ( void ) snprintf ( account_name , sizeof ( account_name ) , "%s$" , netr_info -> hostname ) ; smb_tracef ( "server=[%s] account_name=[%s]hostname=[%s]\n" , netr_info -> server , account_name , netr_info -> hostname ) ; arg . servername = ( unsigned char * ) netr_info -> server ; arg . account_name = ( unsigned char * ) account_name ; arg . account_type = NETR_WKSTA_TRUST_ACCOUNT_TYPE ; arg . hostname = ( unsigned char * ) netr_info -> hostname ; arg . negotiate_flags = netr_server_auth2_flags ; if ( ! netr_global_info . use_secure_rpc ) { arg . negotiate_flags &= ~ NETR_NEGO_SECURE_RPC_FLAG ; } if ( arg . negotiate_flags & NETR_NEGO_STRONGKEY_FLAG ) { if ( netr_gen_skey128 ( netr_info ) != SMBAUTH_SUCCESS ) { return ( - 1 ) ; } } else { if ( netr_gen_skey64 ( netr_info ) != SMBAUTH_SUCCESS ) { return ( - 1 ) ; } } if ( netr_gen_credentials ( netr_info -> session_key . key , & netr_info -> client_challenge , 0 , & netr_info -> client_credential , B_FALSE ) != SMBAUTH_SUCCESS ) { return ( - 1 ) ; } if ( netr_gen_credentials ( netr_info -> session_key . key , & netr_info -> server_challenge , 0 , & netr_info -> server_credential , B_FALSE ) != SMBAUTH_SUCCESS ) { return ( - 1 ) ; } ( void ) memcpy ( & arg . client_credential , & netr_info -> client_credential , sizeof ( netr_credential ) ) ; if ( ndr_rpc_call ( netr_handle , opnum , & arg ) != 0 ) { return ( - 1 ) ; } netr_info -> nego_flags = arg . negotiate_flags ; rc = memcmp ( & netr_info -> server_credential , & arg . server_credential , sizeof ( netr_credential ) ) ; ndr_rpc_release ( netr_handle ) ; return ( rc ) ; } 