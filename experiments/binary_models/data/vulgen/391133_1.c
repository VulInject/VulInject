static int audiopci_init ( audiopci_dev_t * dev ) { dev -> micbias = 1 ; audiopci_init_hw ( dev ) ; for ( int i = 0 ; i <= PORT_MAX ; i ++ ) { audiopci_port_t * port ; unsigned caps ; unsigned dmaflags ; size_t rlen ; ddi_dma_cookie_t c ; unsigned ccnt ; port = & dev -> port [ i ] ; port -> dev = dev ; switch ( i ) { case PORT_SYN : caps = ENGINE_OUTPUT_CAP ; dmaflags = DDI_DMA_WRITE | DDI_DMA_CONSISTENT ; port -> speed = 44100 ; break ; case PORT_DAC : caps = ENGINE_OUTPUT_CAP ; dmaflags = DDI_DMA_WRITE | DDI_DMA_CONSISTENT ; port -> speed = 48000 ; break ; case PORT_ADC : caps = ENGINE_INPUT_CAP ; dmaflags = DDI_DMA_READ | DDI_DMA_CONSISTENT ; port -> speed = 48000 ; break ; } port -> num = i ; if ( ddi_dma_alloc_handle ( dev -> dip , & dma_attr , DDI_DMA_SLEEP , NULL , & port -> dmah ) != DDI_SUCCESS ) { audio_dev_warn ( dev -> adev , "port %d: dma handle allocation failed" , i ) ; return ( DDI_FAILURE ) ; } if ( ddi_dma_mem_alloc ( port -> dmah , AUDIOPCI_BUF_LEN , & buf_attr , DDI_DMA_CONSISTENT , DDI_DMA_SLEEP , NULL , & port -> kaddr , & rlen , & port -> acch ) != DDI_SUCCESS ) { audio_dev_warn ( dev -> adev , "port %d: dma memory allocation failed" , i ) ; return ( DDI_FAILURE ) ; } if ( ddi_dma_addr_bind_handle ( port -> dmah , NULL , port -> kaddr , AUDIOPCI_BUF_LEN , dmaflags , DDI_DMA_SLEEP , NULL , & c , & ccnt ) != DDI_DMA_MAPPED ) { audio_dev_warn ( dev -> adev , "port %d: dma binding failed" , i ) ; return ( DDI_FAILURE ) ; } port -> paddr = c . dmac_address ; port -> engine = audio_engine_alloc ( & audiopci_engine_ops , caps ) ; if ( port -> engine == NULL ) { audio_dev_warn ( dev -> adev , "port %d: audio_engine_alloc failed" , i ) ; return ( DDI_FAILURE ) ; } audio_engine_set_private ( port -> engine , port ) ; audio_dev_add_engine ( dev -> adev , port -> engine ) ; } if ( audiopci_add_controls ( dev ) == DDI_FAILURE ) { return ( DDI_FAILURE ) ; } if ( audio_dev_register ( dev -> adev ) != DDI_SUCCESS ) { audio_dev_warn ( dev -> adev , "unable to register with audio framework" ) ; return ( DDI_FAILURE ) ; } return ( DDI_SUCCESS ) ; } 