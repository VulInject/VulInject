static struct filestore_key * filestore_get_key ( sftp_keystore_t * store , pool * p ) { char * line ; BIO * bio = NULL ; struct filestore_key * key = NULL ; struct filestore_data * store_data = store -> keystore_data ; size_t begin_markerlen = 0 , end_markerlen = 0 ; line = filestore_getline ( store , p ) ; while ( line == NULL && errno == EINVAL ) { pr_signals_handle ( ) ; line = filestore_getline ( store , p ) ; } if ( line == NULL ) { return NULL ; } begin_markerlen = strlen ( SFTP_SSH2_PUBKEY_BEGIN_MARKER ) ; end_markerlen = strlen ( SFTP_SSH2_PUBKEY_END_MARKER ) ; while ( line != NULL ) { pr_signals_handle ( ) ; if ( key == NULL && strncmp ( line , SFTP_SSH2_PUBKEY_BEGIN_MARKER , begin_markerlen + 1 ) == 0 ) { key = pcalloc ( p , sizeof ( filestore_key ) ) ; bio = BIO_new ( BIO_s_mem ( ) ) ; } if ( key != NULL && strncmp ( line , SFTP_SSH2_PUBKEY_END_MARKER , end_markerlen + 1 ) == 0 ) { if ( bio != NULL ) { BIO * b64 = NULL , * bmem = NULL ; char chunk [ 1024 ] , * data = NULL ; int chunklen ; long datalen = 0 ; b64 = BIO_new ( BIO_f_base64 ( ) ) ; BIO_set_flags ( b64 , BIO_FLAGS_BASE64_NO_NL ) ; bio = BIO_push ( b64 , bio ) ; bmem = BIO_new ( BIO_s_mem ( ) ) ; memset ( chunk , '\0' , sizeof ( chunk ) ) ; chunklen = BIO_read ( bio , chunk , sizeof ( chunk ) ) ; if ( chunklen < 0 && ! BIO_should_retry ( bio ) ) { ( void ) pr_log_writefile ( sftp_logfd , MOD_SFTP_VERSION , "unable to base64-decode data in '%s': %s" , store_data -> path , sftp_crypto_get_errors ( ) ) ; BIO_free_all ( bio ) ; BIO_free_all ( bmem ) ; errno = EPERM ; return NULL ; } while ( chunklen > 0 ) { pr_signals_handle ( ) ; if ( BIO_write ( bmem , chunk , chunklen ) < 0 ) { ( void ) pr_log_writefile ( sftp_logfd , MOD_SFTP_VERSION , "error writing to memory BIO: %s" , sftp_crypto_get_errors ( ) ) ; BIO_free_all ( bio ) ; BIO_free_all ( bmem ) ; errno = EPERM ; return NULL ; } memset ( chunk , '\0' , sizeof ( chunk ) ) ; chunklen = BIO_read ( bio , chunk , sizeof ( chunk ) ) ; } datalen = BIO_get_mem_data ( bmem , & data ) ; if ( data != NULL && datalen > 0 ) { key -> key_data = palloc ( p , datalen ) ; key -> key_datalen = datalen ; memcpy ( key -> key_data , data , datalen ) ; } else { ( void ) pr_log_writefile ( sftp_logfd , MOD_SFTP_VERSION , "error base64-decoding key data in '%s'" , store_data -> path ) ; } BIO_free_all ( bio ) ; bio = NULL ; BIO_free_all ( bmem ) ; } break ; } else { } line = filestore_getline ( store , p ) ; while ( line == NULL && errno == EINVAL ) { pr_signals_handle ( ) ; line = filestore_getline ( store , p ) ; } } return key ; } 