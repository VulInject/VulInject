static rsRetVal Add ( nsdsel_t * pNsdsel , nsd_t * pNsd , nsdsel_waitOp_t waitOp ) { DEFiRet ; nsdsel_ossl_t * pThis = ( nsdsel_ossl_t * ) pNsdsel ; nsd_ossl_t * pNsdOSSL = ( nsd_ossl_t * ) pNsd ; ISOBJ_TYPE_assert ( pThis , nsdsel_ossl ) ; ISOBJ_TYPE_assert ( pNsdOSSL , nsd_ossl ) ; DBGPRINTF ( "Add on nsd %p:\n" , pNsdOSSL ) ; if ( pNsdOSSL -> iMode == 1 ) { if ( waitOp == NSDSEL_RD && osslHasRcvInBuffer ( pNsdOSSL ) ) { dbgprintf ( "nsdsel_ossl: data already present in buffer, initiating " "dummy select %p->iBufferRcvReady=%d\n" , pThis , pThis -> iBufferRcvReady ) ; FINALIZE ; } if ( pNsdOSSL -> rtryCall != osslRtry_None ) { if ( pNsdOSSL -> rtryOsslErr == SSL_ERROR_WANT_READ ) { CHKiRet ( nsdsel_ptcp . Add ( pThis -> pTcp , pNsdOSSL -> pTcp , NSDSEL_RD ) ) ; FINALIZE ; } if ( pNsdOSSL -> rtryOsslErr == SSL_ERROR_WANT_WRITE ) { CHKiRet ( nsdsel_ptcp . Add ( pThis -> pTcp , pNsdOSSL -> pTcp , NSDSEL_WR ) ) ; FINALIZE ; } else { dbgprintf ( "nsdsel_ossl: rtryCall=%d, rtryOsslErr=%d, unexpected ... help?! ... \n" , pNsdOSSL -> rtryCall , pNsdOSSL -> rtryOsslErr ) ; ABORT_FINALIZE ( RS_RET_NO_ERRCODE ) ; } } else { dbgprintf ( "nsdsel_ossl: rtryCall=%d, nothing to do ... \n" , pNsdOSSL -> rtryCall ) ; } } dbgprintf ( "nsdsel_ossl: reached end, calling nsdsel_ptcp.Add with waitOp %d... \n" , waitOp ) ; CHKiRet ( nsdsel_ptcp . Add ( pThis -> pTcp , pNsdOSSL -> pTcp , waitOp ) ) ; finalize_it RETiRet ; } 