void odm_DIG ( struct odm_dm_struct * pDM_Odm ) { struct rtw_dig * pDM_DigTable = & pDM_Odm -> DM_DigTable ; struct false_alarm_stats * pFalseAlmCnt = & pDM_Odm -> FalseAlmCnt ; u8 DIG_Dynamic_MIN ; u8 DIG_MaxOfMin ; bool FirstConnect , FirstDisConnect ; u8 dm_dig_max , dm_dig_min ; u8 CurrentIGI = pDM_DigTable -> CurIGValue ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG()==>\n" ) ) ; if ( ( ! ( pDM_Odm -> SupportAbility & ODM_BB_DIG ) ) || ( ! ( pDM_Odm -> SupportAbility & ODM_BB_FA_CNT ) ) ) { ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG() Return: SupportAbility ODM_BB_DIG or ODM_BB_FA_CNT is disabled\n" ) ) ; return ; } if ( * ( pDM_Odm -> pbScanInProcess ) ) { ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG() Return: In Scan Progress\n" ) ) ; return ; } if ( pDM_Odm -> bDMInitialGainEnable == false ) { ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG() Return: PSD is Processing\n" ) ) ; return ; } DIG_Dynamic_MIN = pDM_DigTable -> DIG_Dynamic_MIN_0 ; FirstConnect = ( pDM_Odm -> bLinked ) && ( ! pDM_DigTable -> bMediaConnect_0 ) ; FirstDisConnect = ( ! pDM_Odm -> bLinked ) && ( pDM_DigTable -> bMediaConnect_0 ) ; dm_dig_max = DM_DIG_MAX_NIC ; dm_dig_min = DM_DIG_MIN_NIC ; DIG_MaxOfMin = DM_DIG_MAX_AP ; if ( pDM_Odm -> bLinked ) { if ( ( pDM_Odm -> RSSI_Min + 20 ) > dm_dig_max ) { pDM_DigTable -> rx_gain_range_max = dm_dig_max ; } if ( ( pDM_Odm -> RSSI_Min + 20 ) < dm_dig_min ) { pDM_DigTable -> rx_gain_range_max = dm_dig_min ; } else { pDM_DigTable -> rx_gain_range_max = pDM_Odm -> RSSI_Min + 20 ; } if ( pDM_Odm -> bOneEntryOnly ) { if ( pDM_Odm -> RSSI_Min < dm_dig_min ) { DIG_Dynamic_MIN = dm_dig_min ; } if ( pDM_Odm -> RSSI_Min > DIG_MaxOfMin ) { DIG_Dynamic_MIN = DIG_MaxOfMin ; } else { DIG_Dynamic_MIN = pDM_Odm -> RSSI_Min ; } ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG() : bOneEntryOnly=true,  DIG_Dynamic_MIN=0x%x\n" , DIG_Dynamic_MIN ) ) ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG() : pDM_Odm->RSSI_Min=%d\n" , pDM_Odm -> RSSI_Min ) ) ; } if ( pDM_Odm -> SupportAbility & ODM_BB_ANT_DIV ) { if ( pDM_Odm -> AntDivType == CG_TRX_HW_ANTDIV ) { DIG_Dynamic_MIN = ( u8 ) pDM_DigTable -> AntDiv_RSSI_max ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_ANT_DIV , ODM_DBG_LOUD , ( "odm_DIG(): pDM_DigTable->AntDiv_RSSI_max=%d\n" , pDM_DigTable -> AntDiv_RSSI_max ) ) ; } } else { DIG_Dynamic_MIN = dm_dig_min ; } } else { pDM_DigTable -> rx_gain_range_max = dm_dig_max ; DIG_Dynamic_MIN = dm_dig_min ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG() : No Link\n" ) ) ; } if ( pFalseAlmCnt -> Cnt_all > 10000 ) { ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "dm_DIG(): Abnornally false alarm case.\n" ) ) ; if ( pDM_DigTable -> LargeFAHit != 3 ) { pDM_DigTable -> LargeFAHit ++ ; } if ( pDM_DigTable -> ForbiddenIGI < CurrentIGI ) { pDM_DigTable -> ForbiddenIGI = CurrentIGI ; pDM_DigTable -> LargeFAHit = 1 ; } if ( pDM_DigTable -> LargeFAHit >= 3 ) { if ( ( pDM_DigTable -> ForbiddenIGI + 1 ) > pDM_DigTable -> rx_gain_range_max ) { pDM_DigTable -> rx_gain_range_min = pDM_DigTable -> rx_gain_range_max ; } else { pDM_DigTable -> rx_gain_range_min = ( pDM_DigTable -> ForbiddenIGI + 1 ) ; } pDM_DigTable -> Recover_cnt = 3600 ; } } else { if ( pDM_DigTable -> Recover_cnt != 0 ) { pDM_DigTable -> Recover_cnt -- ; } else { if ( pDM_DigTable -> LargeFAHit < 3 ) { if ( ( pDM_DigTable -> ForbiddenIGI - 1 ) < DIG_Dynamic_MIN ) { pDM_DigTable -> ForbiddenIGI = DIG_Dynamic_MIN ; pDM_DigTable -> rx_gain_range_min = DIG_Dynamic_MIN ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): Normal Case: At Lower Bound\n" ) ) ; } else { pDM_DigTable -> ForbiddenIGI -- ; pDM_DigTable -> rx_gain_range_min = ( pDM_DigTable -> ForbiddenIGI + 1 ) ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): Normal Case: Approach Lower Bound\n" ) ) ; } } else { pDM_DigTable -> LargeFAHit = 0 ; } } } ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): pDM_DigTable->LargeFAHit=%d\n" , pDM_DigTable -> LargeFAHit ) ) ; if ( pDM_Odm -> bLinked ) { ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): DIG AfterLink\n" ) ) ; if ( FirstConnect ) { CurrentIGI = pDM_Odm -> RSSI_Min ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "DIG: First Connect\n" ) ) ; } else { if ( pFalseAlmCnt -> Cnt_all > DM_DIG_FA_TH2 ) { CurrentIGI = CurrentIGI + 4 ; } if ( pFalseAlmCnt -> Cnt_all > DM_DIG_FA_TH1 ) { CurrentIGI = CurrentIGI + 2 ; } if ( pFalseAlmCnt -> Cnt_all < DM_DIG_FA_TH0 ) { CurrentIGI = CurrentIGI - 2 ; } } } else { ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): DIG BeforeLink\n" ) ) ; if ( FirstDisConnect ) { CurrentIGI = pDM_DigTable -> rx_gain_range_min ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): First DisConnect\n" ) ) ; } else { if ( pFalseAlmCnt -> Cnt_all > 10000 ) { CurrentIGI = CurrentIGI + 2 ; } if ( pFalseAlmCnt -> Cnt_all > 8000 ) { CurrentIGI = CurrentIGI + 1 ; } if ( pFalseAlmCnt -> Cnt_all < 500 ) { CurrentIGI = CurrentIGI - 1 ; } ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): England DIG\n" ) ) ; } } ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): DIG End Adjust IGI\n" ) ) ; if ( CurrentIGI > pDM_DigTable -> rx_gain_range_max ) { CurrentIGI = pDM_DigTable -> rx_gain_range_max ; } ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): rx_gain_range_max=0x%x, rx_gain_range_min=0x%x\n" , pDM_DigTable -> rx_gain_range_max , pDM_DigTable -> rx_gain_range_min ) ) ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): TotalFA=%d\n" , pFalseAlmCnt -> Cnt_all ) ) ; ODM_RT_TRACE ( pDM_Odm , ODM_COMP_DIG , ODM_DBG_LOUD , ( "odm_DIG(): CurIGValue=0x%x\n" , CurrentIGI ) ) ; ODM_Write_DIG ( pDM_Odm , CurrentIGI ) ; pDM_DigTable -> bMediaConnect_0 = pDM_Odm -> bLinked ; pDM_DigTable -> DIG_Dynamic_MIN_0 = DIG_Dynamic_MIN ; } 