static int vsp1_rwpf_set_format ( struct v4l2_subdev * subdev , struct v4l2_subdev_pad_config * cfg , struct v4l2_subdev_format * fmt ) { struct vsp1_rwpf * rwpf = to_rwpf ( subdev ) ; struct v4l2_subdev_pad_config * config ; struct v4l2_mbus_framefmt * format ; int ret = 0 ; mutex_lock ( & rwpf -> entity . lock ) ; config = vsp1_entity_get_pad_config ( & rwpf -> entity , cfg , fmt -> which ) ; if ( ! config ) { done } if ( fmt -> format . code != MEDIA_BUS_FMT_ARGB8888_1X32 && fmt -> format . code != MEDIA_BUS_FMT_AHSV8888_1X32 && fmt -> format . code != MEDIA_BUS_FMT_AYUV8_1X32 ) { fmt -> format . code = MEDIA_BUS_FMT_AYUV8_1X32 ; } format = vsp1_entity_get_pad_format ( & rwpf -> entity , config , fmt -> pad ) ; if ( fmt -> pad == RWPF_PAD_SOURCE ) { format -> code = fmt -> format . code ; fmt -> format = * format ; done } format -> code = fmt -> format . code ; format -> width = clamp_t ( , , , ) ; format -> height = clamp_t ( , , , ) ; format -> field = V4L2_FIELD_NONE ; format -> colorspace = V4L2_COLORSPACE_SRGB ; fmt -> format = * format ; if ( rwpf -> entity . type == VSP1_ENTITY_RPF ) { struct v4l2_rect * crop ; crop = vsp1_rwpf_get_crop ( rwpf , config ) ; crop -> left = 0 ; crop -> top = 0 ; crop -> width = fmt -> format . width ; crop -> height = fmt -> format . height ; } format = vsp1_entity_get_pad_format ( & rwpf -> entity , config , RWPF_PAD_SOURCE ) ; * format = fmt -> format ; if ( rwpf -> flip . rotate ) { format -> width = fmt -> format . height ; format -> height = fmt -> format . width ; } done mutex_unlock ( & rwpf -> entity . lock ) ; return ret ; } 