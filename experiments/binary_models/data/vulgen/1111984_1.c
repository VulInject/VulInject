struct outside_network * outside_network_create ( struct comm_base * base , size_t bufsize , size_t num_ports , char * * ifs , int num_ifs , int do_ip4 , int do_ip6 , size_t num_tcp , int dscp , struct infra_cache * infra , struct ub_randstate * rnd , int use_caps_for_id , int * availports , int numavailports , size_t unwanted_threshold , int tcp_mss , void * unwanted_action ( void * ) , void * unwanted_param , int do_udp , void * sslctx , int delayclose , int tls_use_sni , struct dt_env * dtenv , int udp_connect , int max_reuse_tcp_queries , int tcp_reuse_timeout , int tcp_auth_query_timeout ) { struct outside_network * outnet = ( outside_network * ) calloc ( 1 , sizeof ( outside_network ) ) ; size_t k ; if ( ! outnet ) { log_err ( "malloc failed" ) ; return NULL ; } comm_base_timept ( base , & outnet -> now_secs , & outnet -> now_tv ) ; outnet -> base = base ; outnet -> num_tcp = num_tcp ; outnet -> max_reuse_tcp_queries = max_reuse_tcp_queries ; outnet -> tcp_reuse_timeout = tcp_reuse_timeout ; outnet -> tcp_auth_query_timeout = tcp_auth_query_timeout ; outnet -> num_tcp_outgoing = 0 ; outnet -> num_udp_outgoing = 0 ; outnet -> infra = infra ; outnet -> rnd = rnd ; outnet -> sslctx = sslctx ; outnet -> tls_use_sni = tls_use_sni ; outnet -> dtenv = dtenv ; ( void ) dtenv ; outnet -> svcd_overhead = 0 ; outnet -> want_to_quit = 0 ; outnet -> unwanted_threshold = unwanted_threshold ; outnet -> unwanted_action = unwanted_action ; outnet -> unwanted_param = unwanted_param ; outnet -> use_caps_for_id = use_caps_for_id ; outnet -> do_udp = do_udp ; outnet -> tcp_mss = tcp_mss ; outnet -> ip_dscp = dscp ; if ( delayclose ) { outnet -> delayclose = 1 ; outnet -> delay_tv . tv_sec = delayclose / 1000 ; outnet -> delay_tv . tv_usec = ( delayclose % 1000 ) * 1000 ; } if ( udp_connect ) { outnet -> udp_connect = 1 ; } if ( numavailports == 0 || num_ports == 0 ) { log_err ( "no outgoing ports available" ) ; outside_network_delete ( outnet ) ; return NULL ; } do_ip6 = 0 ; calc_num46 ( ifs , num_ifs , do_ip4 , do_ip6 , & outnet -> num_ip4 , & outnet -> num_ip6 ) ; if ( outnet -> num_ip4 != 0 ) { if ( ! ( outnet -> ip4_ifs = ( port_if * ) calloc ( ( size_t ) outnet -> num_ip4 , sizeof ( port_if ) ) ) ) { log_err ( "malloc failed" ) ; outside_network_delete ( outnet ) ; return NULL ; } } if ( ! ( outnet -> udp_buff = sldns_buffer_new ( bufsize ) ) || ! ( outnet -> pending = rbtree_create ( pending_cmp ) ) || ! ( outnet -> serviced = rbtree_create ( serviced_cmp ) ) || ! create_pending_tcp ( outnet , bufsize ) ) { log_err ( "malloc failed" ) ; outside_network_delete ( outnet ) ; return NULL ; } rbtree_init ( & outnet -> tcp_reuse , reuse_cmp ) ; outnet -> tcp_reuse_max = num_tcp ; for ( k = 0 ; k < num_ports ; k ++ ) { struct port_comm * pc ; pc = ( port_comm * ) calloc ( 1 , sizeof ( * pc ) ) ; if ( ! pc ) { log_err ( "malloc failed" ) ; outside_network_delete ( outnet ) ; return NULL ; } pc -> cp = comm_point_create_udp ( outnet -> base , - 1 , outnet -> udp_buff , 0 , outnet_udp_cb , outnet , NULL ) ; if ( ! pc -> cp ) { log_err ( "malloc failed" ) ; free ( pc ) ; outside_network_delete ( outnet ) ; return NULL ; } pc -> next = outnet -> unused_fds ; outnet -> unused_fds = pc ; } if ( num_ifs == 0 ) { if ( do_ip4 && ! setup_if ( & outnet -> ip4_ifs [ 0 ] , "0.0.0.0" , availports , numavailports , num_ports ) ) { log_err ( "malloc failed" ) ; outside_network_delete ( outnet ) ; return NULL ; } if ( do_ip6 && ! setup_if ( & outnet -> ip6_ifs [ 0 ] , "::" , availports , numavailports , num_ports ) ) { log_err ( "malloc failed" ) ; outside_network_delete ( outnet ) ; return NULL ; } } else { size_t done_4 = 0 , done_6 = 0 ; int i ; for ( i = 0 ; i < num_ifs ; i ++ ) { if ( str_is_ip6 ( ifs [ i ] ) && do_ip6 ) { if ( ! setup_if ( & outnet -> ip6_ifs [ done_6 ] , ifs [ i ] , availports , numavailports , num_ports ) ) { log_err ( "malloc failed" ) ; outside_network_delete ( outnet ) ; return NULL ; } done_6 ++ ; } if ( ! str_is_ip6 ( ifs [ i ] ) && do_ip4 ) { if ( ! setup_if ( & outnet -> ip4_ifs [ done_4 ] , ifs [ i ] , availports , numavailports , num_ports ) ) { log_err ( "malloc failed" ) ; outside_network_delete ( outnet ) ; return NULL ; } done_4 ++ ; } } } return outnet ; } 