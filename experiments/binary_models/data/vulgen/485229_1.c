bool tsc_store_and_check_tsc_adjust ( bool bootcpu ) { struct tsc_adjust * ref , * cur = this_cpu_ptr ( & tsc_adjust ) ; unsigned int refcpu , cpu = smp_processor_id ( ) ; struct cpumask * mask ; s64 bootval ; rdmsrl ( MSR_IA32_TSC_ADJUST , bootval ) ; cur -> bootval = bootval ; cur -> nextcheck = jiffies + HZ ; cur -> warned = false ; mask = topology_core_cpumask ( cpu ) ; refcpu = mask ?cpumask_any_but ( mask , cpu ) : nr_cpu_ids ; if ( refcpu >= nr_cpu_ids ) { tsc_sanitize_first_cpu ( cur , bootval , smp_processor_id ( ) , bootcpu ) ; return false ; } ref = per_cpu_ptr ( & tsc_adjust , refcpu ) ; if ( bootval != ref -> bootval ) { pr_warn ( FW_BUG "TSC ADJUST differs: Reference CPU%u: %lld CPU%u: %lld\n" , refcpu , ref -> bootval , cpu , bootval ) ; } if ( bootval != ref -> adjusted ) { pr_warn ( "TSC ADJUST synchronize: Reference CPU%u: %lld CPU%u: %lld\n" , refcpu , ref -> adjusted , cpu , bootval ) ; cur -> adjusted = ref -> adjusted ; wrmsrl ( MSR_IA32_TSC_ADJUST , ref -> adjusted ) ; } return true ; } static atomic_t start_count ; static atomic_t stop_count ; static atomic_t skip_test ; static atomic_t test_runs ; static arch_spinlock_t sync_lock = __ARCH_SPIN_LOCK_UNLOCKED ; static cycles_t last_tsc ; static cycles_t max_warp ; static int nr_warps ; static int random_warps ; static cycles_t check_tsc_warp ( unsigned int timeout ) { cycles_t start , now , prev , end , cur_max_warp = 0 ; int i , cur_warps = 0 ; start = rdtsc_ordered ( ) ; end = start + ( cycles_t ) tsc_khz * timeout ; now = start ; for ( i = 0 ; ; i ++ ) { arch_spin_lock ( & sync_lock ) ; prev = last_tsc ; now = rdtsc_ordered ( ) ; last_tsc = now ; arch_spin_unlock ( & sync_lock ) ; if ( unlikely ( ! ( i & 7 ) ) ) { if ( now > end || i > 10000000 ) { break ; } cpu_relax ( ) ; touch_nmi_watchdog ( ) ; } if ( unlikely ( prev > now ) ) { arch_spin_lock ( & sync_lock ) ; max_warp = max ( max_warp , prev - now ) ; cur_max_warp = max_warp ; if ( cur_warps != nr_warps ) { random_warps ++ ; } nr_warps ++ ; cur_warps = nr_warps ; arch_spin_unlock ( & sync_lock ) ; } } WARN ( ! ( now - start ) , "Warning: zero tsc calibration delta: %Ld [max: %Ld]\n" , now - start , end - start ) ; return cur_max_warp ; } 