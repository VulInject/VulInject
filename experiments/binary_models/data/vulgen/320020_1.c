TEST_IMPL ( ) { int r ; struct passwd * pw ; char uidstr [ 10 ] ; char gidstr [ 10 ] ; uv_uid_t uid = getuid ( ) ; if ( uid != 0 ) { RETURN_SKIP ( "It should be run as root user" ) ; } init_process_options ( "spawn_helper_setuid_setgid" , exit_cb ) ; pw = getpwnam ( "nobody" ) ; ASSERT_NOT_NULL ( pw ) ; options . uid = pw -> pw_uid ; options . gid = pw -> pw_gid ; snprintf ( uidstr , sizeof ( uidstr ) , "%d" , pw -> pw_uid ) ; snprintf ( gidstr , sizeof ( gidstr ) , "%d" , pw -> pw_gid ) ; options . args [ 2 ] = uidstr ; options . args [ 3 ] = gidstr ; options . flags = UV_PROCESS_SETUID | UV_PROCESS_SETGID ; r = uv_spawn ( uv_default_loop ( ) , & process , & options ) ; ASSERT ( r == 0 ) ; r = uv_run ( uv_default_loop ( ) , UV_RUN_DEFAULT ) ; ASSERT ( r == 0 ) ; ASSERT ( exit_cb_called == 1 ) ; ASSERT ( close_cb_called == 1 ) ; MAKE_VALGRIND_HAPPY ( ) ; return 0 ; } 