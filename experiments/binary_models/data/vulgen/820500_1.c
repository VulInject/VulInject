QDict * qmp_fd_receive ( int fd ) { QMPResponseParser qmp ; bool log = getenv ( "QTEST_LOG" ) != NULL ; qmp . response = NULL ; json_message_parser_init ( & qmp . parser , qmp_response , & qmp , NULL ) ; while ( ! qmp . response ) { ssize_t len ; char c ; if ( len == - 1 && errno == EINTR ) { continue ; } if ( len == - 1 || len == 0 ) { fprintf ( stderr , "Broken pipe\n" ) ; abort ( ) ; } if ( log ) { len = write ( 2 , & c , 1 ) ; } json_message_parser_feed ( & qmp . parser , & c , 1 ) ; } json_message_parser_destroy ( & qmp . parser ) ; return qmp . response ; } 