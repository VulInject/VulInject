void mrsas_tbolt_prepare_cdb ( struct mrsas_instance * instance , U8 cdb [ ] , struct IO_REQUEST_INFO * io_info , Mpi2RaidSCSIIORequest_t * scsi_io_request , U32 ref_tag ) { uint16_t EEDPFlags ; uint32_t Control ; ddi_acc_handle_t acc_handle = instance -> mpi2_frame_pool_dma_obj . acc_handle ; con_log ( CL_ANN , ( CE_NOTE , "Prepare DIF CDB" ) ) ; bzero ( cdb , 32 ) ; cdb [ 0 ] = MRSAS_SCSI_VARIABLE_LENGTH_CMD ; cdb [ 7 ] = MRSAS_SCSI_ADDL_CDB_LEN ; if ( io_info -> isRead ) { cdb [ 9 ] = MRSAS_SCSI_SERVICE_ACTION_READ32 ; } else { cdb [ 9 ] = MRSAS_SCSI_SERVICE_ACTION_WRITE32 ; } cdb [ 10 ] = MRSAS_RD_WR_PROTECT ; cdb [ 12 ] = ( U8 ) ( ( ( io_info -> pdBlock ) >> 56 ) & 0xff ) ; cdb [ 13 ] = ( U8 ) ( ( ( io_info -> pdBlock ) >> 48 ) & 0xff ) ; cdb [ 14 ] = ( U8 ) ( ( ( io_info -> pdBlock ) >> 40 ) & 0xff ) ; cdb [ 15 ] = ( U8 ) ( ( ( io_info -> pdBlock ) >> 32 ) & 0xff ) ; cdb [ 16 ] = ( U8 ) ( ( ( io_info -> pdBlock ) >> 24 ) & 0xff ) ; cdb [ 17 ] = ( U8 ) ( ( ( io_info -> pdBlock ) >> 16 ) & 0xff ) ; cdb [ 18 ] = ( U8 ) ( ( ( io_info -> pdBlock ) >> 8 ) & 0xff ) ; cdb [ 19 ] = ( U8 ) ( ( io_info -> pdBlock ) & 0xff ) ; ddi_put32 ( acc_handle , & scsi_io_request -> CDB . EEDP32 . PrimaryReferenceTag , BE_32 ( ref_tag ) ) ; ddi_put16 ( acc_handle , & scsi_io_request -> CDB . EEDP32 . PrimaryApplicationTagMask , 0xffff ) ; ddi_put32 ( acc_handle , & scsi_io_request -> DataLength , ( ( io_info -> numBlocks ) * 512 ) ) ; ddi_put16 ( acc_handle , & scsi_io_request -> IoFlags , 32 ) ; cdb [ 28 ] = ( U8 ) ( ( ( io_info -> numBlocks ) >> 24 ) & 0xff ) ; cdb [ 29 ] = ( U8 ) ( ( ( io_info -> numBlocks ) >> 16 ) & 0xff ) ; cdb [ 30 ] = ( U8 ) ( ( ( io_info -> numBlocks ) >> 8 ) & 0xff ) ; cdb [ 31 ] = ( U8 ) ( ( io_info -> numBlocks ) & 0xff ) ; EEDPFlags = ddi_get16 ( acc_handle , & scsi_io_request -> EEDPFlags ) ; Control = ddi_get32 ( acc_handle , & scsi_io_request -> Control ) ; if ( io_info -> isRead ) { EEDPFlags = MPI2_SCSIIO_EEDPFLAGS_INC_PRI_REFTAG | MPI2_SCSIIO_EEDPFLAGS_CHECK_REFTAG | MPI2_SCSIIO_EEDPFLAGS_CHECK_REMOVE_OP | MPI2_SCSIIO_EEDPFLAGS_CHECK_APPTAG | MPI2_SCSIIO_EEDPFLAGS_CHECK_GUARD ; } else { EEDPFlags = MPI2_SCSIIO_EEDPFLAGS_INC_PRI_REFTAG | MPI2_SCSIIO_EEDPFLAGS_INSERT_OP ; } Control |= ( 0x4 << 26 ) ; ddi_put16 ( acc_handle , & scsi_io_request -> EEDPFlags , EEDPFlags ) ; ddi_put32 ( acc_handle , & scsi_io_request -> Control , Control ) ; } 