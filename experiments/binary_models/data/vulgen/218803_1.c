static void uhci_build_interrupt_lattice ( uhci_state_t * uhcip ) { int half_list = NUM_INTR_QH_LISTS / 2 ; uint16_t i , j , k ; uhci_td_t * sof_td , * isoc_td ; uintptr_t addr ; queue_head_t * list_array = uhcip -> uhci_qh_pool_addr ; queue_head_t * tmp_qh ; frame_lst_table_t * frame_lst_tablep = uhcip -> uhci_frame_lst_tablep ; USB_DPRINTF_L4 ( PRINT_MASK_ATTA , uhcip -> uhci_log_hdl , "uhci_build_interrupt_lattice:" ) ; for ( i = 0 ; i < NUM_INTR_QH_LISTS ; i ++ ) { SetQH32 ( uhcip , list_array [ i ] . link_ptr , HC_END_OF_LIST ) ; SetQH32 ( uhcip , list_array [ i ] . element_ptr , HC_END_OF_LIST ) ; list_array [ i ] . qh_flag = QUEUE_HEAD_FLAG_STATIC ; list_array [ i ] . node = i ; } for ( i = 0 ; i < half_list - 1 ; i ++ ) { addr = QH_PADDR ( & list_array [ i ] ) | HC_QUEUE_HEAD ; SetQH32 ( uhcip , list_array [ 2 * i + 1 ] . link_ptr , addr ) ; SetQH32 ( uhcip , list_array [ 2 * i + 2 ] . link_ptr , addr ) ; } for ( i = 0 , j = 0 ; i < pow_2 ( TREE_HEIGHT ) ; i ++ ) { addr = QH_PADDR ( & list_array [ half_list + i - 1 ] ) ; for ( k = 0 ; k < pow_2 ( VIRTUAL_TREE_HEIGHT ) ; k ++ ) { SetFL32 ( uhcip , frame_lst_tablep [ uhci_tree_bottom_nodes [ j ++ ] ] , addr | HC_QUEUE_HEAD ) ; } } uhcip -> uhci_ctrl_xfers_q_head = uhci_alloc_queue_head ( uhcip ) ; tmp_qh = uhcip -> uhci_ctrl_xfers_q_tail = uhcip -> uhci_ctrl_xfers_q_head ; SetQH32 ( uhcip , list_array [ 0 ] . link_ptr , ( QH_PADDR ( tmp_qh ) | HC_QUEUE_HEAD ) ) ; uhcip -> uhci_bulk_xfers_q_head = uhci_alloc_queue_head ( uhcip ) ; uhcip -> uhci_bulk_xfers_q_tail = uhcip -> uhci_bulk_xfers_q_head ; SetQH32 ( uhcip , tmp_qh -> link_ptr , ( QH_PADDR ( uhcip -> uhci_bulk_xfers_q_head ) | HC_QUEUE_HEAD ) ) ; SetQH32 ( uhcip , uhcip -> uhci_bulk_xfers_q_head -> link_ptr , HC_END_OF_LIST ) ; sof_td = uhci_allocate_td_from_pool ( uhcip ) ; SetQH32 ( uhcip , list_array [ 0 ] . element_ptr , TD_PADDR ( sof_td ) | HC_TD_HEAD ) ; SetTD32 ( uhcip , sof_td -> link_ptr , HC_END_OF_LIST ) ; uhcip -> uhci_sof_td = sof_td ; isoc_td = uhci_allocate_td_from_pool ( uhcip ) ; SetTD32 ( uhcip , isoc_td -> link_ptr , HC_END_OF_LIST ) ; uhcip -> uhci_isoc_td = isoc_td ; uhcip -> uhci_isoc_qh = uhci_alloc_queue_head ( uhcip ) ; SetQH32 ( uhcip , uhcip -> uhci_isoc_qh -> link_ptr , GetFL32 ( uhcip , uhcip -> uhci_frame_lst_tablep [ MAX_FRAME_NUM ] ) ) ; SetQH32 ( uhcip , uhcip -> uhci_isoc_qh -> element_ptr , TD_PADDR ( isoc_td ) ) ; } 