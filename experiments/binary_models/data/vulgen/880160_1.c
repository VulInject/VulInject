static int __init make_uml_dir ( void ) { char dir [ 512 ] { '\0' } ; ; int len , err ; if ( * uml_dir == '~' ) { char * home = getenv ( "HOME" ) ; err = - ENOENT ; if ( home == NULL ) { printk ( UM_KERN_ERR "%s: no value in environment for $HOME\n" , __func__ ) ; err } strlcpy ( dir , home , sizeof ( dir ) ) ; uml_dir ++ ; } strlcat ( dir , uml_dir , sizeof ( dir ) ) ; len = strlen ( dir ) ; if ( len > 0 && dir [ len - 1 ] != '/' ) { strlcat ( dir , "/" , sizeof ( dir ) ) ; } err = - ENOMEM ; if ( uml_dir == NULL ) { printk ( UM_KERN_ERR "%s : malloc failed, errno = %d\n" , __func__ , errno ) ; err } strcpy ( uml_dir , dir ) ; if ( ( mkdir ( uml_dir , 0777 ) < 0 ) && ( errno != EEXIST ) ) { printk ( UM_KERN_ERR "Failed to mkdir '%s': %s\n" , uml_dir , strerror ( errno ) ) ; err = - errno ; err_free } return 0 ; err_free free ( uml_dir ) ; err uml_dir = NULL ; return err ; } 