static Fixed snd_compute_gain ( Fixed min_b , Fixed min_f , Fixed max_b , Fixed max_f , SFVec3f pos ) { Fixed sqpos_x , sqpos_z ; Fixed y_pos , x_pos , dist_ellip , viewp_dist , dist_from_foci_min , dist_from_foci_max , d_min , d_max , sqb_min , sqb_max ; Fixed a_in = ( min_f + min_b ) / 2 ; Fixed b_in = gf_sqrt ( gf_mulfix ( min_b , min_f ) ) ; Fixed alpha_min = ( min_f - min_b ) / 2 ; Fixed dist_foci_min = ( min_f - min_b ) ; Fixed a_out = ( max_f + max_b ) / 2 ; Fixed b_out = gf_sqrt ( gf_mulfix ( max_b , max_f ) ) ; Fixed alpha_max = ( max_f - max_b ) / 2 ; Fixed dist_foci_max = ( max_f - max_b ) ; Fixed x_min = 0 ; Fixed x_max = 0 ; Fixed y_min = 0 ; Fixed y_max = 0 ; Fixed k = ( ABS ( pos . z ) >= FIX_EPSILON ) ?gf_divfix ( pos . x , pos . z ) : 0 ; sqpos_x = gf_mulfix ( pos . x , pos . x ) ; sqpos_z = gf_mulfix ( pos . z , pos . z ) ; dist_from_foci_min = gf_sqrt ( sqpos_z + sqpos_x ) + gf_sqrt ( gf_mulfix ( pos . z - dist_foci_min , pos . z - dist_foci_min ) + sqpos_x ) ; dist_from_foci_max = gf_sqrt ( sqpos_z + sqpos_x ) + gf_sqrt ( gf_mulfix ( pos . z - dist_foci_max , pos . z - dist_foci_max ) + sqpos_x ) ; d_min = min_f + min_b ; d_max = max_f + max_b ; if ( dist_from_foci_max > d_max ) { return 0 ; } sqb_min = gf_mulfix ( b_in , b_in ) ; sqb_max = gf_mulfix ( b_out , b_out ) ; if ( ABS ( pos . z ) > FIX_ONE / 10000 ) { s32 sign = ( pos . z > 0 ) ?1 : - 1 ; Fixed a_in_k_sq , a_out_k_sq ; a_in_k_sq = gf_mulfix ( a_in , k ) ; a_in_k_sq = gf_mulfix ( a_in_k_sq , a_in_k_sq ) ; x_min = gf_mulfix ( alpha_min , sqb_min ) + sign * gf_mulfix ( gf_mulfix ( a_in , b_in ) , gf_sqrt ( a_in_k_sq + sqb_min - gf_mulfix ( gf_mulfix ( alpha_min , k ) , gf_mulfix ( alpha_min , k ) ) ) ) ; x_min = gf_divfix ( x_min , sqb_min + a_in_k_sq ) ; y_min = gf_mulfix ( k , x_min ) ; a_out_k_sq = gf_mulfix ( a_out , k ) ; a_out_k_sq = gf_mulfix ( a_out_k_sq , a_out_k_sq ) ; x_max = gf_mulfix ( alpha_max , sqb_max ) + sign * gf_mulfix ( gf_mulfix ( a_out , b_out ) , gf_sqrt ( a_out_k_sq + sqb_max - gf_mulfix ( gf_mulfix ( alpha_max , k ) , gf_mulfix ( alpha_max , k ) ) ) ) ; x_max = gf_divfix ( x_max , sqb_max + a_out_k_sq ) ; y_max = gf_mulfix ( k , x_max ) ; } else { x_min = x_max = 0 ; y_min = gf_mulfix ( b_in , gf_sqrt ( FIX_ONE - gf_mulfix ( gf_divfix ( alpha_min , a_in ) , gf_divfix ( alpha_min , a_in ) ) ) ) ; y_max = gf_mulfix ( b_out , gf_sqrt ( FIX_ONE - gf_mulfix ( gf_divfix ( alpha_max , a_out ) , gf_divfix ( alpha_max , a_out ) ) ) ) ; } y_pos = gf_sqrt ( sqpos_x ) - y_min ; x_pos = pos . z - x_min ; x_max -= x_min ; y_max -= y_min ; dist_ellip = gf_sqrt ( gf_mulfix ( y_max , y_max ) + gf_mulfix ( x_max , x_max ) ) ; viewp_dist = gf_sqrt ( gf_mulfix ( y_pos , y_pos ) + gf_mulfix ( x_pos , x_pos ) ) ; viewp_dist = gf_divfix ( viewp_dist , dist_ellip ) ; return FLT2FIX ( ( Float ) pow ( 10.0 , - FIX2FLT ( viewp_dist ) ) ) ; } { GF_SoundInterface snd_ifce ; GF_Matrix mx ; SFVec3f last_pos ; Bool identity ; Fixed intensity ; Fixed lgain rgain ; } SoundStack 