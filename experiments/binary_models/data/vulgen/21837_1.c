void client_session2_setup ( struct ssh * ssh , int id , int want_tty , int want_subsystem , const char * term , struct termios * tiop , int in_fd , struct sshbuf * cmd , char * * env ) { size_t i , j , len ; int matched , r ; char * name , * val ; Channel * c = NULL ; debug2_f ( "id %d" , id ) ; if ( ( c = channel_lookup ( ssh , id ) ) == NULL ) { fatal_f ( "channel %d: unknown channel" , id ) ; } ssh_packet_set_interactive ( ssh , want_tty , options . ip_qos_interactive , options . ip_qos_bulk ) ; if ( want_tty ) { struct winsize ws ; if ( ioctl ( in_fd , TIOCGWINSZ , & ws ) == - 1 ) { memset ( & ws , 0 , sizeof ( ws ) ) ; } channel_request_start ( ssh , id , "pty-req" , 1 ) ; client_expect_confirm ( ssh , id , "PTY allocation" , CONFIRM_TTY ) ; if ( ( r = sshpkt_put_cstring ( ssh , term != NULL ?term : "" ) ) != 0 || ( r = sshpkt_put_u32 ( ssh , ( u_int ) ws . ws_col ) ) != 0 || ( r = sshpkt_put_u32 ( ssh , ( u_int ) ws . ws_row ) ) != 0 || ( r = sshpkt_put_u32 ( ssh , ( u_int ) ws . ws_xpixel ) ) != 0 || ( r = sshpkt_put_u32 ( ssh , ( u_int ) ws . ws_ypixel ) ) != 0 ) { fatal_fr ( r , "build pty-req" ) ; } if ( tiop == NULL ) { tiop = get_saved_tio ( ) ; } ssh_tty_make_modes ( ssh , - 1 , tiop ) ; if ( ( r = sshpkt_send ( ssh ) ) != 0 ) { fatal_fr ( r , "send pty-req" ) ; } c -> client_tty = 1 ; } if ( options . num_send_env != 0 && env != NULL ) { debug ( "Sending environment." ) ; for ( i = 0 ; env [ i ] != NULL ; i ++ ) { name = xstrdup ( env [ i ] ) ; if ( ( val = strchr ( name , '=' ) ) == NULL ) { free ( name ) ; continue ; } * val ++ = '\0' ; matched = 0 ; for ( j = 0 ; j < options . num_send_env ; j ++ ) { if ( match_pattern ( name , options . send_env [ j ] ) ) { matched = 1 ; break ; } } if ( ! matched ) { debug3 ( "Ignored env %s" , name ) ; free ( name ) ; continue ; } client_send_env ( ssh , id , name , val ) ; free ( name ) ; } } for ( i = 0 ; i < options . num_setenv ; i ++ ) { name = xstrdup ( options . setenv [ i ] ) ; if ( ( val = strchr ( name , '=' ) ) == NULL ) { free ( name ) ; continue ; } * val ++ = '\0' ; client_send_env ( ssh , id , name , val ) ; free ( name ) ; } len = sshbuf_len ( cmd ) ; if ( len > 0 ) { if ( want_subsystem ) { debug ( "Sending subsystem: %.*s" , ( int ) len , ( const u_char * ) sshbuf_ptr ( cmd ) ) ; channel_request_start ( ssh , id , "subsystem" , 1 ) ; client_expect_confirm ( ssh , id , "subsystem" , CONFIRM_CLOSE ) ; } else { debug ( "Sending command: %.*s" , ( int ) len , ( const u_char * ) sshbuf_ptr ( cmd ) ) ; channel_request_start ( ssh , id , "exec" , 1 ) ; client_expect_confirm ( ssh , id , "exec" , CONFIRM_CLOSE ) ; } if ( ( r = sshpkt_put_stringb ( ssh , cmd ) ) != 0 || ( r = sshpkt_send ( ssh ) ) != 0 ) { fatal_fr ( r , "send command" ) ; } } else { channel_request_start ( ssh , id , "shell" , 1 ) ; client_expect_confirm ( ssh , id , "shell" , CONFIRM_CLOSE ) ; if ( ( r = sshpkt_send ( ssh ) ) != 0 ) { fatal_fr ( r , "send shell" ) ; } } session_setup_complete = 1 ; client_repledge ( ) ; } 