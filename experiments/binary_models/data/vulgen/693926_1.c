void vte_stop ( struct vte_softc * sc ) { struct ifnet * ifp = & sc -> sc_arpcom . ac_if ; struct vte_txdesc * txd ; struct vte_rxdesc * rxd ; int i ; ifp -> if_flags &= ~ IFF_RUNNING ; ifp -> if_timer = 0 ; sc -> vte_flags &= ~ VTE_FLAG_LINK ; timeout_del ( & sc -> vte_tick_ch ) ; vte_stats_update ( sc ) ; CSR_WRITE_2 ( sc , VTE_MIER , 0 ) ; CSR_WRITE_2 ( sc , VTE_MECIER , 0 ) ; vte_stop_mac ( sc ) ; CSR_READ_2 ( sc , VTE_MISR ) ; for ( i = 0 ; i < VTE_RX_RING_CNT ; i ++ ) { rxd = & sc -> vte_cdata . vte_rxdesc [ i ] ; if ( rxd -> rx_m != NULL ) { bus_dmamap_unload ( sc -> sc_dmat , rxd -> rx_dmamap ) ; m_freem ( rxd -> rx_m ) ; rxd -> rx_m = NULL ; } } for ( i = 0 ; i < VTE_TX_RING_CNT ; i ++ ) { txd = & sc -> vte_cdata . vte_txdesc [ i ] ; if ( txd -> tx_m != NULL ) { bus_dmamap_unload ( sc -> sc_dmat , txd -> tx_dmamap ) ; if ( ( txd -> tx_flags & VTE_TXMBUF ) == 0 ) { m_freem ( txd -> tx_m ) ; } txd -> tx_m = NULL ; txd -> tx_flags &= ~ VTE_TXMBUF ; } } for ( i = 0 ; i < VTE_TX_RING_CNT ; i ++ ) { if ( sc -> vte_cdata . vte_txmbufs [ i ] != NULL ) { m_freem ( sc -> vte_cdata . vte_txmbufs [ i ] ) ; sc -> vte_cdata . vte_txmbufs [ i ] = NULL ; } } } 