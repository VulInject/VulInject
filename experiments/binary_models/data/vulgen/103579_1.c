void time_now ( struct timespec * tv ) { LARGE_INTEGER t ; FILETIME f ; double microseconds ; static LARGE_INTEGER offset ; static double frequencyToMicroseconds ; static int initialized = 0 ; static BOOL usePerformanceCounter = 0 ; if ( usePerformanceCounter ) { QueryPerformanceCounter ( & t ) ; } else { GetSystemTimeAsFileTime ( & f ) ; t . QuadPart = f . dwHighDateTime ; t . QuadPart <<= 32 ; t . QuadPart |= f . dwLowDateTime ; } t . QuadPart -= offset . QuadPart ; microseconds = ( double ) t . QuadPart / frequencyToMicroseconds ; t . QuadPart = microseconds ; tv -> tv_sec = t . QuadPart / 1000000 ; tv -> tv_nsec = t . QuadPart % 1000000 * 1000 ; } 