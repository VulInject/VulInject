static void _set_freq ( bitstr_t * gpus , char * gpu_freq ) { bool verbose_flag = false ; int gpu_len = 0 ; int i = - 1 , count = 0 , count_set = 0 ; unsigned int gpu_freq_num = 0 , mem_freq_num = 0 ; bool freq_set = false , freq_logged = false ; char * tmp = NULL ; bool task_cgroup = false ; bool constrained_devices = false ; bool cgroups_active = false ; debug2 ( "_parse_gpu_freq(%s)" , gpu_freq ) ; gpu_common_parse_gpu_freq ( gpu_freq , & gpu_freq_num , & mem_freq_num , & verbose_flag ) ; if ( verbose_flag ) { debug2 ( "verbose_flag ON" ) ; } tmp = gpu_common_freq_value_to_string ( mem_freq_num ) ; debug2 ( "Requested GPU memory frequency: %s" , tmp ) ; tmp = gpu_common_freq_value_to_string ( gpu_freq_num ) ; debug2 ( "Requested GPU graphics frequency: %s" , tmp ) ; xfree ( tmp ) ; if ( ! mem_freq_num || ! gpu_freq_num ) { debug2 ( "%s: No frequencies to set" , __func__ ) ; return ; } cgroup_conf_init ( ) ; if ( slurm_cgroup_conf . constrain_devices ) { constrained_devices = true ; } if ( xstrstr ( slurm_conf . task_plugin , "cgroup" ) ) { task_cgroup = true ; } if ( constrained_devices && task_cgroup ) { cgroups_active = true ; gpu_len = bit_set_count ( gpus ) ; debug2 ( "%s: cgroups are configured. Using LOCAL GPU IDs" , __func__ ) ; } else { gpu_len = bit_size ( gpus ) ; debug2 ( "%s: cgroups are NOT configured. Assuming GLOBAL GPU IDs" , __func__ ) ; } for ( i = 0 ; i < gpu_len ; i ++ ) { char * sep = "" ; nvmlDevice_t device ; unsigned int gpu_freq = gpu_freq_num , mem_freq = mem_freq_num ; if ( ! cgroups_active && ! bit_test ( gpus , i ) ) { debug2 ( "Passing over NVML device %u" , i ) ; continue ; } count ++ ; if ( ! _nvml_get_handle ( i , & device ) ) { continue ; } debug2 ( "Setting frequency of NVML device %u" , i ) ; _nvml_get_nearest_freqs ( & device , & mem_freq , & gpu_freq ) ; debug2 ( "Memory frequency before set: %u" , _nvml_get_mem_freq ( & device ) ) ; debug2 ( "Graphics frequency before set: %u" , _nvml_get_gfx_freq ( & device ) ) ; freq_set = _nvml_set_freqs ( & device , mem_freq , gpu_freq ) ; debug2 ( "Memory frequency after set: %u" , _nvml_get_mem_freq ( & device ) ) ; debug2 ( "Graphics frequency after set: %u" , _nvml_get_gfx_freq ( & device ) ) ; if ( mem_freq ) { xstrfmtcat ( tmp , "%smemory_freq:%u" , sep , mem_freq ) ; sep = "," ; } if ( gpu_freq ) { xstrfmtcat ( tmp , "%sgraphics_freq:%u" , sep , gpu_freq ) ; } if ( freq_set ) { log_flag ( GRES , "Successfully set GPU[%d] %s" , i , tmp ) ; count_set ++ ; } else { log_flag ( GRES , "Failed to set GPU[%d] %s" , i , tmp ) ; } if ( verbose_flag && ! freq_logged ) { fprintf ( stderr , "GpuFreq=%s\n" , tmp ) ; freq_logged = true ; } xfree ( tmp ) ; } if ( count_set != count ) { log_flag ( GRES , "%s: Could not set frequencies for all GPUs. Set %d/%d total GPUs" , __func__ , count_set , count ) ; fprintf ( stderr , "Could not set frequencies for all GPUs. " "Set %d/%d total GPUs\n" , count_set , count ) ; } } 