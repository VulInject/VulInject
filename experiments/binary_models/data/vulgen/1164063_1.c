static void __init kvm_patch_ins_mtmsrd ( u32 * inst , u32 rt ) { u32 * p ; int distance_start ; int distance_end ; ulong next_inst ; p = kvm_alloc ( kvm_emulate_mtmsrd_len * 4 ) ; if ( ! p ) { return ; } distance_start = ( ulong ) p - ( ulong ) inst ; next_inst = ( ( ulong ) inst + 4 ) ; distance_end = next_inst - ( ulong ) & p [ kvm_emulate_mtmsrd_branch_offs ] ; if ( distance_start > KVM_INST_B_MAX ) { return ; } memcpy ( p , kvm_emulate_mtmsrd , kvm_emulate_mtmsrd_len * 4 ) ; p [ kvm_emulate_mtmsrd_branch_offs ] |= distance_end & KVM_INST_B_MASK ; switch ( get_rt ( rt ) ) { case 30 : kvm_patch_ins_ll ( & p [ kvm_emulate_mtmsrd_reg_offs ] , magic_var ( scratch2 ) , KVM_RT_30 ) ; break ; case 31 : kvm_patch_ins_ll ( & p [ kvm_emulate_mtmsrd_reg_offs ] , magic_var ( scratch1 ) , KVM_RT_30 ) ; break ; default : p [ kvm_emulate_mtmsrd_reg_offs ] |= rt ; break ; } p [ kvm_emulate_mtmsrd_orig_ins_offs ] = * inst ; flush_icache_range ( ( ulong ) p , ( ulong ) p + kvm_emulate_mtmsrd_len * 4 ) ; kvm_patch_ins_b ( inst , distance_start ) ; } 