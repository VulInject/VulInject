static void nvme_remove ( struct pci_dev * pdev ) { struct nvme_dev * dev = pci_get_drvdata ( pdev ) ; nvme_change_ctrl_state ( & dev -> ctrl , NVME_CTRL_DELETING ) ; pci_set_drvdata ( pdev , NULL ) ; if ( ! pci_device_is_present ( pdev ) ) { nvme_change_ctrl_state ( & dev -> ctrl , NVME_CTRL_DEAD ) ; nvme_dev_disable ( dev , true ) ; } flush_work ( & dev -> ctrl . reset_work ) ; nvme_stop_ctrl ( & dev -> ctrl ) ; nvme_remove_namespaces ( & dev -> ctrl ) ; nvme_dev_disable ( dev , true ) ; nvme_free_host_mem ( dev ) ; nvme_dev_remove_admin ( dev ) ; nvme_dbbuf_dma_free ( dev ) ; mempool_destroy ( dev -> iod_mempool ) ; nvme_release_prp_pools ( dev ) ; nvme_dev_unmap ( dev ) ; nvme_uninit_ctrl ( & dev -> ctrl ) ; } 