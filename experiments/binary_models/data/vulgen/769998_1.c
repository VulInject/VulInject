static int bcm2835_i2s_probe ( struct platform_device * pdev ) { struct bcm2835_i2s_dev * dev ; int ret ; struct resource * mem ; void __iomem * base ; const __be32 * addr ; dma_addr_t dma_base ; dev = devm_kzalloc ( & pdev -> dev , sizeof ( * dev ) , GFP_KERNEL ) ; if ( ! dev ) { return - ENOMEM ; } dev -> clk_prepared = false ; dev -> clk = devm_clk_get ( & pdev -> dev , NULL ) ; if ( IS_ERR ( dev -> clk ) ) { dev_err ( & pdev -> dev , "could not get clk: %ld\n" , PTR_ERR ( dev -> clk ) ) ; return PTR_ERR ( dev -> clk ) ; } mem = platform_get_resource ( pdev , IORESOURCE_MEM , 0 ) ; base = devm_ioremap_resource ( & pdev -> dev , mem ) ; if ( IS_ERR ( base ) ) { return PTR_ERR ( base ) ; } dev -> i2s_regmap = devm_regmap_init_mmio ( & pdev -> dev , base , & bcm2835_regmap_config ) ; if ( IS_ERR ( dev -> i2s_regmap ) ) { return PTR_ERR ( dev -> i2s_regmap ) ; } addr = of_get_address ( pdev -> dev . of_node , 0 , NULL , NULL ) ; if ( ! addr ) { dev_err ( & pdev -> dev , "could not get DMA-register address\n" ) ; return - EINVAL ; } dma_base = be32_to_cpup ( addr ) ; dev -> dma_data [ SNDRV_PCM_STREAM_PLAYBACK ] . addr = dma_base + BCM2835_I2S_FIFO_A_REG ; dev -> dma_data [ SNDRV_PCM_STREAM_CAPTURE ] . addr = dma_base + BCM2835_I2S_FIFO_A_REG ; dev -> dma_data [ SNDRV_PCM_STREAM_PLAYBACK ] . addr_width = DMA_SLAVE_BUSWIDTH_4_BYTES ; dev -> dma_data [ SNDRV_PCM_STREAM_CAPTURE ] . addr_width = DMA_SLAVE_BUSWIDTH_4_BYTES ; dev -> dma_data [ SNDRV_PCM_STREAM_PLAYBACK ] . maxburst = 2 ; dev -> dma_data [ SNDRV_PCM_STREAM_CAPTURE ] . maxburst = 2 ; dev -> dma_data [ SNDRV_PCM_STREAM_PLAYBACK ] . flags = SND_DMAENGINE_PCM_DAI_FLAG_PACK ; dev -> dma_data [ SNDRV_PCM_STREAM_CAPTURE ] . flags = SND_DMAENGINE_PCM_DAI_FLAG_PACK ; dev -> bclk_ratio = 0 ; dev -> dev = & pdev -> dev ; dev_set_drvdata ( & pdev -> dev , dev ) ; ret = devm_snd_soc_register_component ( & pdev -> dev , & bcm2835_i2s_component , & bcm2835_i2s_dai , 1 ) ; if ( ret ) { dev_err ( & pdev -> dev , "Could not register DAI: %d\n" , ret ) ; return ret ; } ret = devm_snd_dmaengine_pcm_register ( & pdev -> dev , NULL , 0 ) ; return 0 ; } 