static void dissect_msgpack_string ( tvbuff_t * tvb , packet_info * pinfo , proto_tree * tree , int type , void * data , int * offset , char * * value ) { guint32 len = 0 ; guint32 lensize = 0 ; char * label ; proto_item * ti ; proto_tree * subtree ; char * lvalue ; if ( type >> 5 == 0x5 ) { len = type & 0x1F ; lensize = 0 ; } if ( type == 0xd9 ) { len = tvb_get_guint8 ( tvb , * offset + 1 ) ; lensize = 1 ; } if ( type == 0xda ) { len = tvb_get_ntohs ( tvb , * offset + 1 ) ; lensize = 2 ; } lvalue = ( char * ) tvb_get_string_enc ( pinfo -> pool , tvb , * offset + 1 + lensize , len , ENC_NA ) ; label = ( data ?( char * ) data : "MsgPack String" ) ; ti = proto_tree_add_string_format ( tree , hf_msgpack_string , tvb , * offset , 1 + lensize + len , lvalue , "%s: %s" , label , lvalue ) ; subtree = proto_item_add_subtree ( ti , ett_msgpack_string ) ; if ( lensize == 0 ) { proto_tree_add_uint_format ( subtree , hf_msgpack_type , tvb , * offset , 1 , type , "Type: String" ) ; proto_tree_add_uint_format ( subtree , hf_msgpack_string_len , tvb , * offset , 1 , lensize , "Length: 1" ) ; proto_tree_add_item ( subtree , hf_msgpack_string , tvb , * offset + 1 + lensize , len , ENC_ASCII ) ; } else { proto_tree_add_item ( subtree , hf_msgpack_type , tvb , * offset , 1 , ENC_NA ) ; proto_tree_add_item ( subtree , hf_msgpack_string_len , tvb , * offset + 1 , lensize , ENC_BIG_ENDIAN ) ; proto_tree_add_item ( subtree , hf_msgpack_string , tvb , * offset + 1 + lensize , len , ENC_ASCII ) ; } * offset += 1 + lensize + len ; if ( value ) { * value = lvalue ; } } 