int configure_pf ( struct cidr * blacklists ) { char * argv [ 9 ] { "pfctl" "-q" "-t" "spamd" "-T" "replace" "-f" "-" NULL } ; ; static FILE * pf = NULL ; int pdes [ 2 ] ; if ( pf == NULL ) { if ( pipe ( pdes ) != 0 ) { return ( - 1 ) ; } switch ( fork ( ) ) { case - 1 : close ( pdes [ 0 ] ) ; close ( pdes [ 1 ] ) ; return ( - 1 ) ; case 0 : close ( pdes [ 1 ] ) ; if ( pdes [ 0 ] != STDIN_FILENO ) { dup2 ( pdes [ 0 ] , STDIN_FILENO ) ; close ( pdes [ 0 ] ) ; } execvp ( PATH_PFCTL , argv ) ; _exit ( 1 ) ; } close ( pdes [ 0 ] ) ; pf = fdopen ( pdes [ 1 ] , "w" ) ; if ( pf == NULL ) { close ( pdes [ 1 ] ) ; return ( - 1 ) ; } } while ( blacklists -> addr != 0 ) { fprintf ( pf , "%s/%u\n" , atop ( blacklists -> addr ) , blacklists -> bits ) ; blacklists ++ ; } return ( 0 ) ; } 