void ichiic_attach ( struct device * parent , struct device * self , void * aux ) { struct ichiic_softc * sc = ( ichiic_softc * ) self ; struct pci_attach_args * pa = aux ; struct i2cbus_attach_args iba ; pcireg_t conf ; bus_size_t iosize ; pci_intr_handle_t ih ; const char * intrstr = NULL ; conf = pci_conf_read ( pa -> pa_pc , pa -> pa_tag , ICH_SMB_HOSTC ) ; DPRINTF ( ( ": conf 0x%08x" , conf ) ) ; if ( ( conf & ICH_SMB_HOSTC_HSTEN ) == 0 ) { printf ( ": SMBus disabled\n" ) ; return ; } if ( pci_mapreg_map ( pa , ICH_SMB_BASE , PCI_MAPREG_TYPE_IO , 0 , & sc -> sc_iot , & sc -> sc_ioh , NULL , & iosize , 0 ) ) { printf ( ": can't map i/o space\n" ) ; return ; } sc -> sc_poll = 1 ; if ( conf & ICH_SMB_HOSTC_SMIEN ) { printf ( ": SMI" ) ; } else { if ( pci_intr_map ( pa , & ih ) == 0 ) { intrstr = pci_intr_string ( pa -> pa_pc , ih ) ; sc -> sc_ih = pci_intr_establish ( pa -> pa_pc , ih , IPL_BIO , ichiic_intr , sc , sc -> sc_dev . dv_xname ) ; } if ( sc -> sc_poll ) { printf ( ": polling" ) ; } } printf ( "\n" ) ; rw_init ( & sc -> sc_i2c_lock , "iiclk" ) ; sc -> sc_i2c_tag . ic_cookie = sc ; sc -> sc_i2c_tag . ic_acquire_bus = ichiic_i2c_acquire_bus ; sc -> sc_i2c_tag . ic_release_bus = ichiic_i2c_release_bus ; sc -> sc_i2c_tag . ic_exec = ichiic_i2c_exec ; bzero ( & iba , sizeof ( iba ) ) ; iba . iba_name = "iic" ; iba . iba_tag = & sc -> sc_i2c_tag ; config_found ( self , & iba , iicbus_print ) ; return ; } 