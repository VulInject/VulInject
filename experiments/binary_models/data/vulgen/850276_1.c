int _sftype ( mode , oflagsp , fflagsp , uflagp ) reg char * mode ; int * oflagsp ; int * fflagsp ; int * uflagp ; { reg int sflags , oflags , fflags , uflag ; sflags = oflags = fflags = uflag = 0 ; while ( 1 ) { switch ( * mode ++ ) { case 'a' : sflags |= SF_WRITE | SF_APPENDWR ; oflags |= O_WRONLY | O_APPEND | O_CREAT ; continue ; case 'b' : oflags |= O_BINARY ; continue ; case 'e' : oflags |= O_cloexec ; fflags |= SF_FD_CLOEXEC ; continue ; case 'm' : sflags |= SF_MTSAFE ; uflag = 0 ; continue ; case 'r' : sflags |= SF_READ ; oflags |= O_RDONLY ; continue ; case 's' : sflags |= SF_STRING ; continue ; case 't' : oflags |= O_TEXT ; continue ; case 'u' : sflags &= ~ SF_MTSAFE ; uflag = 1 ; continue ; case 'w' : sflags |= SF_WRITE ; oflags |= O_WRONLY | O_CREAT ; if ( ! ( sflags & SF_READ ) ) { oflags |= O_TRUNC ; } continue ; case 'x' : oflags |= O_EXCL ; continue ; case 'F' : continue ; case 'W' : sflags |= SF_WCWIDTH ; uflag = 0 ; continue ; case '+' : if ( sflags ) { sflags |= SF_READ | SF_WRITE ; } continue ; default : if ( ! ( oflags & O_CREAT ) ) { oflags &= ~ O_EXCL ; } if ( ! ( oflags & ( O_BINARY | O_TEXT ) ) ) { oflags |= O_BINARY ; } if ( ( sflags & SF_RDWR ) == SF_RDWR ) { oflags = ( oflags & ~ O_ACCMODE ) | O_RDWR ; } if ( oflagsp ) { * oflagsp = oflags ; } if ( fflagsp ) { * fflagsp = fflags ; } if ( uflagp ) { * uflagp = uflag ; } if ( ( sflags & ( SF_STRING | SF_RDWR ) ) == SF_STRING ) { sflags |= SF_READ ; } return sflags ; } } } 