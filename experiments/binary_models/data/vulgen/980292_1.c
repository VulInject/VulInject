void rsync_finish ( unsigned int id , int ok ) { struct rsyncrepo * rr ; struct tarepo * tr ; tr = ta_find ( id ) ; if ( tr != NULL ) { if ( tr -> state != REPO_LOADING ) { return ; } if ( ok ) { logx ( "ta/%s: loaded from network" , tr -> descr ) ; stats . rsync_repos ++ ; tr -> state = REPO_DONE ; repo_done ( tr , 1 ) ; } else { warnx ( "ta/%s: load from network failed" , tr -> descr ) ; stats . rsync_fails ++ ; tr -> uriidx ++ ; ta_fetch ( tr ) ; } return ; } rr = rsync_find ( id ) ; if ( rr == NULL ) { errx ( 1 , "unknown rsync repo %u" , id ) ; } if ( ok ) { logx ( "%s: loaded from network" , rr -> basedir ) ; stats . rsync_repos ++ ; rr -> state = REPO_DONE ; } else { warnx ( "%s: load from network failed, fallback to cache" , rr -> basedir ) ; stats . rsync_fails ++ ; rr -> state = REPO_FAILED ; remove_contents ( rr -> basedir ) ; } repo_done ( rr , ok ) ; } 