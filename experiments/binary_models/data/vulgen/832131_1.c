static int ccdc_config ( struct isp_ccdc_device * ccdc , struct omap3isp_ccdc_update_config * ccdc_struct ) { struct isp_device * isp = to_isp_device ( ccdc ) ; unsigned long flags ; spin_lock_irqsave ( & ccdc -> lock , flags ) ; ccdc -> shadow_update = 1 ; spin_unlock_irqrestore ( & ccdc -> lock , flags ) ; if ( OMAP3ISP_CCDC_ALAW & ccdc_struct -> update ) { ccdc -> alaw = ! ! ( OMAP3ISP_CCDC_ALAW & ccdc_struct -> flag ) ; ccdc -> update |= OMAP3ISP_CCDC_ALAW ; } if ( OMAP3ISP_CCDC_LPF & ccdc_struct -> update ) { ccdc -> lpf = ! ! ( OMAP3ISP_CCDC_LPF & ccdc_struct -> flag ) ; ccdc -> update |= OMAP3ISP_CCDC_LPF ; } if ( OMAP3ISP_CCDC_BLCLAMP & ccdc_struct -> update ) { if ( copy_from_user ( & ccdc -> clamp , ccdc_struct -> bclamp , sizeof ( ccdc -> clamp ) ) ) { ccdc -> shadow_update = 0 ; return - EFAULT ; } ccdc -> update |= OMAP3ISP_CCDC_BLCLAMP ; } if ( OMAP3ISP_CCDC_BCOMP & ccdc_struct -> update ) { if ( copy_from_user ( & ccdc -> blcomp , ccdc_struct -> blcomp , sizeof ( ccdc -> blcomp ) ) ) { ccdc -> shadow_update = 0 ; return - EFAULT ; } ccdc -> update |= OMAP3ISP_CCDC_BCOMP ; } ccdc -> shadow_update = 0 ; if ( OMAP3ISP_CCDC_FPC & ccdc_struct -> update ) { struct omap3isp_ccdc_fpc fpc ; struct ispccdc_fpc fpc_old = { . addr = NULL } ; struct ispccdc_fpc fpc_new ; u32 size ; if ( ccdc -> state != ISP_PIPELINE_STREAM_STOPPED ) { return - EBUSY ; } ccdc -> fpc_en = ! ! ( OMAP3ISP_CCDC_FPC & ccdc_struct -> flag ) ; if ( ccdc -> fpc_en ) { if ( copy_from_user ( & fpc , ccdc_struct -> fpc , sizeof ( fpc ) ) ) { return - EFAULT ; } size = fpc . fpnum * 4 ; fpc_new . fpnum = fpc . fpnum ; fpc_new . addr = dma_alloc_coherent ( isp -> dev , size , & fpc_new . dma , GFP_KERNEL ) ; if ( fpc_new . addr == NULL ) { return - ENOMEM ; } if ( copy_from_user ( fpc_new . addr , ( __force void __user * ) ( long ) fpc . fpcaddr , size ) ) { dma_free_coherent ( isp -> dev , size , fpc_new . addr , fpc_new . dma ) ; return - EFAULT ; } fpc_old = ccdc -> fpc ; ccdc -> fpc = fpc_new ; } ccdc_configure_fpc ( ccdc ) ; if ( fpc_old . addr != NULL ) { dma_free_coherent ( isp -> dev , fpc_old . fpnum * 4 , fpc_old . addr , fpc_old . dma ) ; } } return ccdc_lsc_config ( ccdc , ccdc_struct ) ; } 