static void fcoei_process_sol_fcp_resp ( fcoe_frame_t * frm ) { uint16_t sol_oxid ; uint32_t actual_size ; fcoei_exchange_t * xch = NULL ; fc_packet_t * fpkt = NULL ; mod_hash_val_t val ; uint32_t i_fcp_status ; sol_oxid = FRM_OXID ( frm ) ; if ( mod_hash_find ( FRM2SS ( frm ) -> ss_sol_oxid_hash , FMHK ( sol_oxid ) , ( mod_hash_val_t * ) & xch ) != 0 ) { PRT_FRM_HDR ( __FUNCTION__ , frm ) ; FCOEI_LOG ( __FUNCTION__ , "can't find the corresponding xch: " "oxid/%x %lu - %lu" , sol_oxid , CURRENT_CLOCK , frm -> frm_clock ) ; return ; } else { fpkt = xch -> xch_fpkt ; } actual_size = fpkt -> pkt_rsplen ; if ( actual_size > frm -> frm_payload_size ) { actual_size = frm -> frm_payload_size ; } ( void ) mod_hash_remove ( FRM2SS ( frm ) -> ss_sol_oxid_hash , FMHK ( xch -> xch_oxid ) , & val ) ; ASSERT ( ( fcoei_exchange_t * ) val == xch ) ; xch -> xch_flags &= ~ XCH_FLAG_IN_SOL_HASH ; FCOEI_FRM2FHDR ( frm , & fpkt -> pkt_resp_fhdr ) ; fpkt -> pkt_state = FC_PKT_SUCCESS ; fpkt -> pkt_reason = 0 ; i_fcp_status = BE_IN32 ( frm -> frm_payload + 8 ) ; if ( i_fcp_status != 0 ) { fcoei_fill_fcp_resp ( frm -> frm_payload , ( uint8_t * ) xch -> xch_fpkt -> pkt_resp , actual_size ) ; } fpkt -> pkt_data_resid = xch -> xch_resid ; if ( ( xch -> xch_resid != 0 ) && ( ( xch -> xch_resid % 0x200 ) == 0 ) && ( ( xch -> xch_fpkt -> pkt_datalen % 0x200 ) == 0 ) && ( i_fcp_status == 0 ) ) { FCOEI_LOG ( __FUNCTION__ , "frame lost no pause ? %x/%x" , xch -> xch_resid , xch -> xch_fpkt -> pkt_datalen ) ; fpkt -> pkt_state = FC_PKT_LOCAL_RJT ; fpkt -> pkt_reason = FC_REASON_UNDERRUN ; } if ( fpkt -> pkt_tran_flags & FC_TRAN_NO_INTR ) { FCOEI_LOG ( __FUNCTION__ , "BEFORE WAKEUP: %p-%p" , fpkt , xch ) ; sema_v ( & xch -> xch_sema ) ; FCOEI_LOG ( __FUNCTION__ , "AFTERE WAKEUP: %p-%p" , fpkt , xch ) ; } else { xch -> xch_fpkt -> pkt_comp ( xch -> xch_fpkt ) ; } } 