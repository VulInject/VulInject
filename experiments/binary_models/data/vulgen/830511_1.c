static void test_nosync ( PGconn * conn ) { int numqueries = 10 ; int results = 0 ; int sock = PQsocket ( conn ) ; fprintf ( stderr , "nosync... " ) ; if ( sock < 0 ) { pg_fatal ( "invalid socket" ) ; } if ( PQenterPipelineMode ( conn ) != 1 ) { pg_fatal ( "could not enter pipeline mode" ) ; } for ( int i = 0 ; i < numqueries ; i ++ ) { fd_set input_mask ; struct timeval tv ; if ( PQsendQueryParams ( conn , "SELECT repeat('xyzxz', 12)" , 0 , NULL , NULL , NULL , NULL , 0 ) != 1 ) { pg_fatal ( "error sending select: %s" , PQerrorMessage ( conn ) ) ; } PQflush ( conn ) ; FD_ZERO ( & input_mask ) ; FD_SET ( sock , & input_mask ) ; tv . tv_sec = 0 ; tv . tv_usec = 0 ; if ( select ( sock + 1 , & input_mask , NULL , NULL , & tv ) < 0 ) { fprintf ( stderr , "select() failed: %s\n" , strerror ( errno ) ) ; exit_nicely ( conn ) ; } if ( FD_ISSET ( sock , & input_mask ) && PQconsumeInput ( conn ) != 1 ) { pg_fatal ( "failed to read from server: %s" , PQerrorMessage ( conn ) ) ; } } if ( PQsendFlushRequest ( conn ) != 1 ) { pg_fatal ( "failed to send flush request" ) ; } PQflush ( conn ) ; for ( ; ; ) { PGresult * res ; res = PQgetResult ( conn ) ; if ( res == NULL ) { pg_fatal ( "got unexpected NULL result after %d results" , results ) ; } if ( PQresultStatus ( res ) == PGRES_TUPLES_OK ) { PGresult * res2 ; res2 = PQgetResult ( conn ) ; if ( res2 != NULL ) { pg_fatal ( "expected NULL, got %s" , PQresStatus ( PQresultStatus ( res2 ) ) ) ; } PQclear ( res ) ; results ++ ; continue ; } pg_fatal ( "got unexpected %s\n" , PQresStatus ( PQresultStatus ( res ) ) ) ; } fprintf ( stderr , "ok\n" ) ; } 