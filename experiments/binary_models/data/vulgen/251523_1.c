static ssize_t mtrr_write ( struct file * file , const char __user * buf , size_t len , loff_t * ppos ) { int i , err ; unsigned long reg ; unsigned long long base , size ; char * ptr ; char line [ LINE_SIZE ] ; int length ; size_t linelen ; if ( ! capable ( CAP_SYS_ADMIN ) ) { return - EPERM ; } length = len ; length -- ; if ( length > LINE_SIZE - 1 ) { length = LINE_SIZE - 1 ; } if ( length < 0 ) { return - EINVAL ; } if ( copy_from_user ( line , buf , length ) ) { return - EFAULT ; } linelen = strlen ( line ) ; ptr = line + linelen - 1 ; if ( linelen && * ptr == '\n' ) { * ptr = '\0' ; } if ( ! strncmp ( line , "disable=" , 8 ) ) { reg = simple_strtoul ( line + 8 , & ptr , 0 ) ; err = mtrr_del_page ( reg , 0 , 0 ) ; if ( err < 0 ) { return err ; } return len ; } if ( strncmp ( line , "base=" , 5 ) ) { return - EINVAL ; } base = simple_strtoull ( line + 5 , & ptr , 0 ) ; ptr = skip_spaces ( ptr ) ; if ( strncmp ( ptr , "size=" , 5 ) ) { return - EINVAL ; } size = simple_strtoull ( ptr + 5 , & ptr , 0 ) ; if ( ( base & 0xfff ) || ( size & 0xfff ) ) { return - EINVAL ; } ptr = skip_spaces ( ptr ) ; if ( strncmp ( ptr , "type=" , 5 ) ) { return - EINVAL ; } ptr = skip_spaces ( ptr + 5 ) ; for ( i = 0 ; i < MTRR_NUM_TYPES ; ++ i ) { if ( strcmp ( ptr , mtrr_strings [ i ] ) ) { continue ; } base >>= PAGE_SHIFT ; size >>= PAGE_SHIFT ; err = mtrr_add_page ( ( unsigned long ) base , ( unsigned long ) size , i , true ) ; if ( err < 0 ) { return err ; } return len ; } return - EINVAL ; } 