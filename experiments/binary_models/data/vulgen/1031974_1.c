static int qla4xxx_config_nvram ( struct scsi_qla_host * ha ) { unsigned long flags ; union external_hw_config_reg extHwConfig ; DEBUG2 ( printk ( "scsi%ld: %s: Get EEProm parameters \n" , ha -> host_no , __func__ ) ) ; if ( ql4xxx_lock_flash ( ha ) != QLA_SUCCESS ) { return QLA_ERROR ; } if ( ql4xxx_lock_nvram ( ha ) != QLA_SUCCESS ) { ql4xxx_unlock_flash ( ha ) ; return QLA_ERROR ; } ql4_printk ( KERN_INFO , ha , "Configuring NVRAM ...\n" ) ; else { ql4_printk ( KERN_WARNING , ha , "scsi%ld: %s: EEProm checksum invalid.  " "Please update your EEPROM\n" , ha -> host_no , __func__ ) ; if ( is_qla4010 ( ha ) ) { extHwConfig . Asuint32_t = 0x1912 ; } if ( is_qla4022 ( ha ) | is_qla4032 ( ha ) ) { extHwConfig . Asuint32_t = 0x0023 ; } else { return QLA_ERROR ; } } if ( is_qla4022 ( ha ) || is_qla4032 ( ha ) ) { qla4xxx_set_model_info ( ha ) ; } else { strcpy ( ha -> model_name , "QLA4010" ) ; } DEBUG ( printk ( "scsi%ld: %s: Setting extHwConfig to 0xFFFF%04x\n" , ha -> host_no , __func__ , extHwConfig . Asuint32_t ) ) ; spin_lock_irqsave ( & ha -> hardware_lock , flags ) ; writel ( ( 0xFFFF << 16 ) | extHwConfig . Asuint32_t , isp_ext_hw_conf ( ha ) ) ; readl ( isp_ext_hw_conf ( ha ) ) ; spin_unlock_irqrestore ( & ha -> hardware_lock , flags ) ; ql4xxx_unlock_nvram ( ha ) ; ql4xxx_unlock_flash ( ha ) ; return QLA_SUCCESS ; } 