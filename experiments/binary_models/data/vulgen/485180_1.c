void rtw_createbss_cmd_callback ( struct adapter * padapter , struct cmd_obj * pcmd ) { struct sta_info * psta = NULL ; struct wlan_network * pwlan = NULL ; struct mlme_priv * pmlmepriv = & padapter -> mlmepriv ; struct wlan_bssid_ex * pnetwork = ( wlan_bssid_ex * ) pcmd -> parmbuf ; struct wlan_network * tgt_network = & pmlmepriv -> cur_network ; if ( ! pcmd -> parmbuf ) { exit } del_timer_sync ( & pmlmepriv -> assoc_timer ) ; spin_lock_bh ( & pmlmepriv -> lock ) ; if ( check_fwstate ( pmlmepriv , WIFI_AP_STATE ) ) { psta = rtw_get_stainfo ( & padapter -> stapriv , pnetwork -> mac_address ) ; if ( ! psta ) { psta = rtw_alloc_stainfo ( & padapter -> stapriv , pnetwork -> mac_address ) ; if ( ! psta ) { createbss_cmd_fail } } rtw_indicate_connect ( padapter ) ; } else { pwlan = rtw_alloc_network ( pmlmepriv ) ; spin_lock_bh ( & pmlmepriv -> scanned_queue . lock ) ; if ( ! pwlan ) { pwlan = rtw_get_oldest_wlan_network ( & pmlmepriv -> scanned_queue ) ; if ( ! pwlan ) { spin_unlock_bh ( & pmlmepriv -> scanned_queue . lock ) ; createbss_cmd_fail } pwlan -> last_scanned = jiffies ; } else { list_add_tail ( & pwlan -> list , & pmlmepriv -> scanned_queue . queue ) ; } pnetwork -> length = get_wlan_bssid_ex_sz ( pnetwork ) ; memcpy ( & pwlan -> network , pnetwork , pnetwork -> length ) ; memcpy ( & tgt_network -> network , pnetwork , ( get_wlan_bssid_ex_sz ( pnetwork ) ) ) ; _clr_fwstate_ ( pmlmepriv , _FW_UNDER_LINKING ) ; spin_unlock_bh ( & pmlmepriv -> scanned_queue . lock ) ; } createbss_cmd_fail spin_unlock_bh ( & pmlmepriv -> lock ) ; exit rtw_free_cmd_obj ( pcmd ) ; } 