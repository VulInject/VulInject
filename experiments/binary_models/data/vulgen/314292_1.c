int32_t psvc_fsp_device_fault_check_policy_0 ( psvc_opaque_t hdlp , char * id ) { int32_t status ; int32_t i ; int32_t device_count = 0 ; char * device_id ; int32_t failed_count = 0 ; static int32_t led_on = 0 ; int retry ; status = psvc_get_attr ( hdlp , id , PSVC_ASSOC_MATCHES_ATTR , & device_count , PSVC_DEV_FAULT_SENSOR ) ; if ( status != PSVC_SUCCESS ) { return ( status ) ; } for ( i = 0 ; i < device_count ; i ++ ) { status = psvc_get_attr ( hdlp , id , PSVC_ASSOC_ID_ATTR , & device_id , PSVC_DEV_FAULT_SENSOR , i ) ; if ( status != PSVC_SUCCESS ) { return ( status ) ; } retry = 0 ; { if ( retry ) { ( void ) sleep ( retry_sleep_fsp_fault ) ; } status = psvc_get_attr ( hdlp , device_id , PSVC_STATE_ATTR , device_state ) ; if ( status != PSVC_SUCCESS ) { return ( status ) ; } if ( strcmp ( device_state , PSVC_OK ) != 0 && strcmp ( device_state , PSVC_HOTPLUGGED ) != 0 && strcmp ( device_state , "NO AC POWER" ) != 0 && strlen ( device_state ) != 0 ) { failed_count ++ ; } retry ++ ; } ( retry < n_retry_fsp_fault ) && ( failed_count ) ; } if ( failed_count == 0 && led_on ) { syslog ( LOG_ERR , gettext ( "%s has turned OFF" ) , id ) ; status = psvc_set_attr ( hdlp , id , PSVC_LED_STATE_ATTR , PSVC_LED_OFF ) ; led_on = 0 ; } if ( failed_count > 0 && ! led_on ) { syslog ( LOG_ERR , gettext ( "%s has turned ON" ) , id ) ; status = psvc_set_attr ( hdlp , id , PSVC_LED_STATE_ATTR , PSVC_LED_ON ) ; led_on = 1 ; } return ( PSVC_SUCCESS ) ; } 