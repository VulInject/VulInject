static void md_common_write ( PCMCIACardState * card , uint32_t at , uint16_t value ) { MicroDriveState * s = MICRODRIVE ( card ) ; at -= s -> io_base ; switch ( s -> opt & OPT_MODE ) { case OPT_MODE_MMAP : if ( ( at & ~ 0x3ff ) == 0x400 ) { at = 0 ; } break ; case OPT_MODE_IOMAP16 : at &= 0xf ; break ; case OPT_MODE_IOMAP1 : if ( ( at & ~ 0xf ) == 0x3f0 ) { at -= 0x3e8 ; } if ( ( at & ~ 0xf ) == 0x1f0 ) { at -= 0x1f0 ; } break ; case OPT_MODE_IOMAP2 : if ( ( at & ~ 0xf ) == 0x370 ) { at -= 0x368 ; } if ( ( at & ~ 0xf ) == 0x170 ) { at -= 0x170 ; } } switch ( at ) { case 0x0 : case 0x8 : ide_data_writew ( & s -> bus , 0 , value ) ; break ; if ( s -> cycle ) { ide_data_writew ( & s -> bus , 0 , s -> io | ( value << 8 ) ) ; } else { s -> io = value & 0xff ; } s -> cycle = ! s -> cycle ; break ; case 0x9 : s -> io = value & 0xff ; s -> cycle = ! s -> cycle ; break ; case 0xd : ide_ioport_write ( & s -> bus , 0x1 , value ) ; break ; case 0xe : s -> ctrl = value ; if ( value & CTRL_SRST ) { device_legacy_reset ( DEVICE ( s ) ) ; } md_interrupt_update ( s ) ; break ; default : if ( s -> stat & STAT_PWRDWN ) { s -> stat &= ~ STAT_PWRDWN ; } ide_ioport_write ( & s -> bus , at , value ) ; } } 