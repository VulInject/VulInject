static void altera_pcie_retrain ( struct altera_pcie * pcie ) { u16 linkcap , linkstat , linkctl ; altera_read_cap_word ( pcie , pcie -> root_bus_nr , RP_DEVFN , PCI_EXP_LNKCAP , & linkcap ) ; if ( ( linkcap & PCI_EXP_LNKCAP_SLS ) <= PCI_EXP_LNKCAP_SLS_2_5GB ) { return ; } altera_read_cap_word ( pcie , pcie -> root_bus_nr , RP_DEVFN , PCI_EXP_LNKSTA , & linkstat ) ; if ( ( linkstat & PCI_EXP_LNKSTA_CLS ) == PCI_EXP_LNKSTA_CLS_2_5GB ) { altera_read_cap_word ( pcie , pcie -> root_bus_nr , RP_DEVFN , PCI_EXP_LNKCTL , & linkctl ) ; linkctl |= PCI_EXP_LNKCTL_RL ; altera_write_cap_word ( pcie , pcie -> root_bus_nr , RP_DEVFN , PCI_EXP_LNKCTL , linkctl ) ; altera_wait_link_retrain ( pcie ) ; } } 