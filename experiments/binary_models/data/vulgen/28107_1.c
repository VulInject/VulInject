static void jmb38x_ms_remove ( struct pci_dev * dev ) { struct jmb38x_ms * jm = pci_get_drvdata ( dev ) ; struct jmb38x_ms_host * host ; int cnt ; unsigned long flags ; for ( cnt = 0 ; cnt < jm -> host_cnt ; ++ cnt ) { if ( ! jm -> hosts [ cnt ] ) { break ; } host = memstick_priv ( jm -> hosts [ cnt ] ) ; jm -> hosts [ cnt ] -> request = jmb38x_ms_dummy_submit ; tasklet_kill ( & host -> notify ) ; writel ( 0 , host -> addr + INT_SIGNAL_ENABLE ) ; writel ( 0 , host -> addr + INT_STATUS_ENABLE ) ; mmiowb ( ) ; dev_dbg ( & jm -> pdev -> dev , "interrupts off\n" ) ; spin_lock_irqsave ( & host -> lock , flags ) ; if ( host -> req ) { host -> req -> error = - ETIME ; jmb38x_ms_complete_cmd ( jm -> hosts [ cnt ] , 1 ) ; } spin_unlock_irqrestore ( & host -> lock , flags ) ; memstick_remove_host ( jm -> hosts [ cnt ] ) ; dev_dbg ( & jm -> pdev -> dev , "host removed\n" ) ; jmb38x_ms_free_host ( jm -> hosts [ cnt ] ) ; } pci_set_drvdata ( dev , NULL ) ; pci_release_regions ( dev ) ; pci_disable_device ( dev ) ; kfree ( jm ) ; } 