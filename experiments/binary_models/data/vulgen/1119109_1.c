_cairo_svg_surface_emit_radial_pattern ( , , , , ) { cairo_svg_document_t * document = surface -> document ; cairo_matrix_t p2u ; cairo_extend_t extend ; double x0 , y0 , x1 , y1 , r0 , r1 ; double fx , fy ; cairo_bool_t reverse_stops ; cairo_status_t status ; cairo_circle_double_t * c0 , * c1 ; extend = pattern -> base . base . extend ; if ( pattern -> cd1 . radius < pattern -> cd2 . radius ) { c0 = & pattern -> cd1 ; c1 = & pattern -> cd2 ; reverse_stops = FALSE ; } else { c0 = & pattern -> cd2 ; c1 = & pattern -> cd1 ; reverse_stops = TRUE ; } x0 = c0 -> center . x ; y0 = c0 -> center . y ; r0 = c0 -> radius ; x1 = c1 -> center . x ; y1 = c1 -> center . y ; r1 = c1 -> radius ; p2u = pattern -> base . base . matrix ; status = cairo_matrix_invert ( & p2u ) ; assert ( status == CAIRO_STATUS_SUCCESS ) ; if ( r0 == r1 ) { unsigned int n_stops = pattern -> base . n_stops ; _cairo_output_stream_printf ( document -> xml_node_defs , "<radialGradient id=\"radial%d\" " "gradientUnits=\"userSpaceOnUse\" " "cx=\"%f\" cy=\"%f\" " "fx=\"%f\" fy=\"%f\" r=\"%f\" " , document -> radial_pattern_id , x1 , y1 , x1 , y1 , r1 ) ; _cairo_output_stream_printf ( document -> xml_node_defs , ">\n" ) ; if ( extend == CAIRO_EXTEND_NONE || n_stops < 1 ) { _cairo_output_stream_printf ( document -> xml_node_defs , "<stop offset=\"0\" style=\"" "stop-color:rgb(0%%,0%%,0%%);" "stop-opacity:0;\"/>\n" ) ; } else { _cairo_output_stream_printf ( document -> xml_node_defs , "<stop offset=\"0\" style=\"" "stop-color:rgb(%f%%,%f%%,%f%%);" "stop-opacity %f;\"/>\n" , pattern -> base . stops [ 0 ] . color . red * 100.0 , pattern -> base . stops [ 0 ] . color . green * 100.0 , pattern -> base . stops [ 0 ] . color . blue * 100.0 , pattern -> base . stops [ 0 ] . color . alpha ) ; if ( n_stops > 1 ) { _cairo_output_stream_printf ( document -> xml_node_defs , "<stop offset=\"0\" style=\"" "stop-color:rgb(%f%%,%f%%,%f%%);" "stop-opacity:%f;\"/>\n" , pattern -> base . stops [ n_stops - 1 ] . color . red * 100.0 , pattern -> base . stops [ n_stops - 1 ] . color . green * 100.0 , pattern -> base . stops [ n_stops - 1 ] . color . blue * 100.0 , pattern -> base . stops [ n_stops - 1 ] . color . alpha ) ; } } } else { double offset , r , x , y ; cairo_bool_t emulate_reflect = FALSE ; fx = ( r1 * x0 - r0 * x1 ) / ( r1 - r0 ) ; fy = ( r1 * y0 - r0 * y1 ) / ( r1 - r0 ) ; if ( ( extend == CAIRO_EXTEND_REFLECT || extend == CAIRO_EXTEND_REPEAT ) && r0 > 0.0 ) { double r_org = r1 ; if ( extend == CAIRO_EXTEND_REFLECT ) { r1 = 2 * r1 - r0 ; emulate_reflect = TRUE ; } offset = fmod ( r1 , r1 - r0 ) / ( r1 - r0 ) - 1.0 ; r = r1 - r0 ; x = r * ( x1 - fx ) / r_org + fx ; y = r * ( y1 - fy ) / r_org + fy ; x1 = x ; y1 = y ; r1 = r ; r0 = 0.0 ; } else { offset = r0 / r1 ; } _cairo_output_stream_printf ( document -> xml_node_defs , "<radialGradient id=\"radial%d\" " "gradientUnits=\"userSpaceOnUse\" " "cx=\"%f\" cy=\"%f\" " "fx=\"%f\" fy=\"%f\" r=\"%f\" " , document -> radial_pattern_id , x1 , y1 , fx , fy , r1 ) ; if ( emulate_reflect ) { _cairo_output_stream_printf ( document -> xml_node_defs , "spreadMethod=\"repeat\" " ) ; } else { _cairo_svg_surface_emit_pattern_extend ( document -> xml_node_defs , & pattern -> base . base ) ; } _cairo_svg_surface_emit_transform ( document -> xml_node_defs , "gradientTransform" , & p2u , parent_matrix ) ; _cairo_output_stream_printf ( document -> xml_node_defs , ">\n" ) ; if ( extend == CAIRO_EXTEND_NONE ) { _cairo_output_stream_printf ( document -> xml_node_defs , "<stop offset=\"0\" style=\"" "stop-color:rgb(0%%,0%%,0%%);" "stop-opacity:0;\"/>\n" ) ; if ( r0 != 0.0 ) { _cairo_output_stream_printf ( document -> xml_node_defs , "<stop offset=\"%f\" style=\"" "stop-color:rgb(0%%,0%%,0%%);" "stop-opacity:0;\"/>\n" , r0 / r1 ) ; } } status = _cairo_svg_surface_emit_pattern_stops ( document -> xml_node_defs , & pattern -> base , offset , reverse_stops , emulate_reflect ) ; if ( unlikely ( status ) ) { return status ; } if ( pattern -> base . base . extend == CAIRO_EXTEND_NONE ) { _cairo_output_stream_printf ( document -> xml_node_defs , "<stop offset=\"1.0\" style=\"" "stop-color:rgb(0%%,0%%,0%%);" "stop-opacity:0;\"/>\n" ) ; } } _cairo_output_stream_printf ( document -> xml_node_defs , "</radialGradient>\n" ) ; _cairo_output_stream_printf ( style , "%s:url(#radial%d);" , is_stroke ?"stroke" : "fill" , document -> radial_pattern_id ) ; document -> radial_pattern_id ++ ; return CAIRO_STATUS_SUCCESS ; } 