static int process_db_write ( dlmgmt_db_req_t * req , FILE * fp , FILE * nfp ) { boolean_t done = B_FALSE ; int err = 0 ; dlmgmt_link_t link_in_file , * linkp = NULL , * dblinkp ; boolean_t persist = ( req -> ls_flags == DLMGMT_PERSIST ) ; boolean_t writeall , rename , attr_renamed ; char buf [ MAXLINELEN ] ; writeall = ( req -> ls_linkid == DATALINK_ALL_LINKID ) ; if ( req -> ls_op == DLMGMT_DB_OP_WRITE && ! writeall ) { linkp = link_by_id ( req -> ls_linkid , req -> ls_zoneid ) ; if ( linkp == NULL || ( linkp -> ll_flags & req -> ls_flags ) == 0 ) { return ( 0 ) ; } rename = ( strcmp ( req -> ls_link , linkp -> ll_link ) != 0 ) ; } if ( fp == NULL ) { write } while ( err == 0 && fgets ( buf , sizeof ( buf ) , fp ) != NULL && process_link_line ( buf , & link_in_file ) ) { linkattr_destroy ( & link_in_file ) ; if ( link_in_file . ll_link [ 0 ] == '\0' || done ) { if ( fputs ( buf , nfp ) == EOF ) { err = errno ; } continue ; } switch ( req -> ls_op ) { case DLMGMT_DB_OP_WRITE : if ( writeall ) { linkp = link_by_name ( link_in_file . ll_link , req -> ls_zoneid ) ; } if ( writeall || strcmp ( req -> ls_link , link_in_file . ll_link ) == 0 ) { generate_link_line ( linkp , persist , buf ) ; if ( ! writeall && ! rename ) { done = B_TRUE ; } } if ( rename && persist ) { dblinkp = link_by_name ( link_in_file . ll_link , req -> ls_zoneid ) ; err = dlmgmt_attr_rename ( dblinkp , req -> ls_link , linkp -> ll_link , & attr_renamed ) ; if ( attr_renamed ) { generate_link_line ( dblinkp , persist , buf ) ; } } if ( fputs ( buf , nfp ) == EOF ) { err = errno ; } break ; case DLMGMT_DB_OP_DELETE : if ( strcmp ( req -> ls_link , link_in_file . ll_link ) != 0 ) { if ( fputs ( buf , nfp ) == EOF ) { err = errno ; } } else { done = B_TRUE ; } break ; case DLMGMT_DB_OP_READ : default : err = EINVAL ; break ; } } write if ( req -> ls_op == DLMGMT_DB_OP_WRITE && ! writeall && ! rename && ! done ) { generate_link_line ( linkp , persist , buf ) ; done = B_TRUE ; if ( fputs ( buf , nfp ) == EOF ) { err = errno ; } } return ( err ) ; } 