int gdsc_register ( struct gdsc_desc * desc , struct reset_controller_dev * rcdev , struct regmap * regmap ) { int i , ret ; struct genpd_onecell_data * data ; struct device * dev = desc -> dev ; struct gdsc * * scs = desc -> scs ; size_t num = desc -> num ; data = devm_kzalloc ( dev , sizeof ( * data ) , GFP_KERNEL ) ; if ( ! data ) { return - ENOMEM ; } if ( ! data -> domains ) { return - ENOMEM ; } for ( i = 0 ; i < num ; i ++ ) { if ( ! scs [ i ] || ! scs [ i ] -> supply ) { continue ; } scs [ i ] -> rsupply = devm_regulator_get ( dev , scs [ i ] -> supply ) ; if ( IS_ERR ( scs [ i ] -> rsupply ) ) { return PTR_ERR ( scs [ i ] -> rsupply ) ; } } data -> num_domains = num ; for ( i = 0 ; i < num ; i ++ ) { if ( ! scs [ i ] ) { continue ; } scs [ i ] -> regmap = regmap ; scs [ i ] -> rcdev = rcdev ; ret = gdsc_init ( scs [ i ] ) ; if ( ret ) { return ret ; } data -> domains [ i ] = & scs [ i ] -> pd ; } for ( i = 0 ; i < num ; i ++ ) { if ( ! scs [ i ] ) { continue ; } if ( scs [ i ] -> parent ) { pm_genpd_add_subdomain ( scs [ i ] -> parent , & scs [ i ] -> pd ) ; } if ( ! IS_ERR_OR_NULL ( dev -> pm_domain ) ) { pm_genpd_add_subdomain ( pd_to_genpd ( dev -> pm_domain ) , & scs [ i ] -> pd ) ; } } return of_genpd_add_provider_onecell ( dev -> of_node , data ) ; } 