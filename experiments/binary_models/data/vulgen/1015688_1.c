static void imx_uart_dma_tx_callback ( void * data ) { struct imx_port * sport = data ; struct scatterlist * sgl = & sport -> tx_sgl [ 0 ] ; struct circ_buf * xmit = & sport -> port . state -> xmit ; unsigned long flags ; u32 ucr1 ; spin_lock_irqsave ( & sport -> port . lock , flags ) ; dma_unmap_sg ( sport -> port . dev , sgl , sport -> dma_tx_nents , DMA_TO_DEVICE ) ; ucr1 = imx_uart_readl ( sport , UCR1 ) ; ucr1 &= ~ UCR1_TXDMAEN ; imx_uart_writel ( sport , ucr1 , UCR1 ) ; uart_xmit_advance ( & sport -> port , sport -> tx_bytes ) ; dev_dbg ( sport -> port . dev , "we finish the TX DMA.\n" ) ; sport -> dma_is_txing = 0 ; if ( uart_circ_chars_pending ( xmit ) < WAKEUP_CHARS ) { uart_write_wakeup ( & sport -> port ) ; } if ( ! uart_circ_empty ( xmit ) && ! uart_tx_stopped ( & sport -> port ) ) { imx_uart_dma_tx ( sport ) ; } spin_unlock_irqrestore ( & sport -> port . lock , flags ) ; } 