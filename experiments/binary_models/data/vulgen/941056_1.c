static struct sdsi_dev * sdsi_create_dev ( char * dev_no ) { int dev_name_len = sizeof ( SDSI_DEV ) + strlen ( dev_no ) + 1 ; struct sdsi_dev * s ; int guid ; DIR * dir ; s = ( sdsi_dev * ) malloc ( sizeof ( * s ) ) ; if ( ! s ) { perror ( "malloc" ) ; return NULL ; } s -> dev_name = ( char * ) malloc ( sizeof ( SDSI_DEV ) + strlen ( dev_no ) + 1 ) ; if ( ! s -> dev_name ) { perror ( "malloc" ) ; return NULL ; } snprintf ( s -> dev_name , dev_name_len , "%s.%s" , SDSI_DEV , dev_no ) ; s -> dev_path = ( char * ) malloc ( sizeof ( AUX_DEV_PATH ) + dev_name_len ) ; if ( ! s -> dev_path ) { perror ( "malloc" ) ; free ( s -> dev_name ) ; free ( s ) ; return NULL ; } snprintf ( s -> dev_path , sizeof ( AUX_DEV_PATH ) + dev_name_len , "%s%s" , AUX_DEV_PATH , s -> dev_name ) ; dir = opendir ( s -> dev_path ) ; if ( ! dir ) { fprintf ( stderr , "Could not open directory '%s': %s\n" , s -> dev_path , strerror ( errno ) ) ; free ( s -> dev_path ) ; free ( s -> dev_name ) ; free ( s ) ; return NULL ; } if ( chdir ( s -> dev_path ) == - 1 ) { perror ( "chdir" ) ; free ( s -> dev_path ) ; free ( s -> dev_name ) ; free ( s ) ; return NULL ; } if ( read_sysfs_data ( "guid" , & guid ) ) { free ( s -> dev_path ) ; free ( s -> dev_name ) ; free ( s ) ; return NULL ; } s -> guid = guid ; return s ; } 