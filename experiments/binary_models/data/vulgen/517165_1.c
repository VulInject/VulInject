int FPU_store_bcd ( FPU_REG * st0_ptr , u_char st0_tag , u_char __user * d ) { FPU_REG t ; unsigned long long ll ; u_char b ; int i , precision_loss ; u_char sign = ( getsign ( st0_ptr ) == SIGN_NEG ) ?0x80 : 0 ; if ( st0_tag == TAG_Empty ) { EXCEPTION ( EX_StackUnder ) ; invalid_operand } if ( st0_tag == TAG_Special ) { st0_tag = FPU_Special ( st0_ptr ) ; if ( ( st0_tag == TW_Infinity ) || ( st0_tag == TW_NaN ) ) { EXCEPTION ( EX_Invalid ) ; invalid_operand } } reg_copy ( st0_ptr , & t ) ; precision_loss = FPU_round_to_int ( & t , st0_tag ) ; ll = significand ( & t ) ; if ( ( t . sigh > 0x0de0b6b3 ) || ( ( t . sigh == 0x0de0b6b3 ) && ( t . sigl > 0xa763ffff ) ) ) { EXCEPTION ( EX_Invalid ) ; invalid_operand else { return 0 ; } } if ( precision_loss ) { set_precision_flag ( precision_loss ) ; } RE_ENTRANT_CHECK_OFF ; FPU_access_ok ( d , 10 ) ; RE_ENTRANT_CHECK_ON ; for ( i = 0 ; i < 9 ; i ++ ) { b = FPU_div_small ( & ll , 10 ) ; b |= ( FPU_div_small ( & ll , 10 ) ) << 4 ; RE_ENTRANT_CHECK_OFF ; FPU_put_user ( b , d + i ) ; RE_ENTRANT_CHECK_ON ; } RE_ENTRANT_CHECK_OFF ; FPU_put_user ( sign , d + 9 ) ; RE_ENTRANT_CHECK_ON ; return 1 ; } 