efi_get_pal_addr ( ) { void * efi_map_start , * efi_map_end , * p ; efi_memory_desc_t * md ; u64 efi_desc_size ; int pal_code_count = 0 ; u64 vaddr , mask ; efi_map_start = __va ( ia64_boot_param -> efi_memmap ) ; efi_map_end = efi_map_start + ia64_boot_param -> efi_memmap_size ; efi_desc_size = ia64_boot_param -> efi_memdesc_size ; for ( p = efi_map_start ; p < efi_map_end ; p += efi_desc_size ) { md = p ; if ( ++ pal_code_count > 1 ) { printk ( KERN_ERR "Too many EFI Pal Code memory ranges, " "dropped @ %llx\n" , md -> phys_addr ) ; continue ; } mask = ~ ( ( 1 << KERNEL_TR_PAGE_SHIFT ) - 1 ) ; vaddr = PAGE_OFFSET + md -> phys_addr ; if ( ( vaddr & mask ) == ( KERNEL_START & mask ) ) { printk ( KERN_INFO "%s: no need to install ITR for PAL code\n" , __func__ ) ; continue ; } if ( efi_md_size ( md ) > IA64_GRANULE_SIZE ) { panic ( "Whoa!  PAL code size bigger than a granule!" ) ; } mask = ~ ( ( 1 << IA64_GRANULE_SHIFT ) - 1 ) ; printk ( KERN_INFO "CPU %d: mapping PAL code " "[0x%llx-0x%llx) into [0x%llx-0x%llx)\n" , smp_processor_id ( ) , md -> phys_addr , md -> phys_addr + efi_md_size ( md ) , vaddr & mask , ( vaddr & mask ) + IA64_GRANULE_SIZE ) ; return __va ( md -> phys_addr ) ; } printk ( KERN_WARNING "%s: no PAL-code memory-descriptor found\n" , __func__ ) ; return NULL ; } 