static void __init * memory_less_node_alloc ( int nid , unsigned long pernodesize ) { void * ptr = NULL ; int bestnode = NUMA_NO_NODE , node , anynode = 0 ; for_each_online_node ( ) { if ( node_isset ( node , memory_less_mask ) ) { continue ; } if ( node_distance ( nid , node ) < best ) { best = node_distance ( nid , node ) ; bestnode = node ; } anynode = node ; } if ( bestnode == NUMA_NO_NODE ) { bestnode = anynode ; } ptr = memblock_alloc_try_nid ( pernodesize , PERCPU_PAGE_SIZE , __pa ( MAX_DMA_ADDRESS ) , MEMBLOCK_ALLOC_ACCESSIBLE , bestnode ) ; if ( ! ptr ) { panic ( "%s: Failed to allocate %lu bytes align=0x%lx nid=%d from=%lx\n" , __func__ , pernodesize , PERCPU_PAGE_SIZE , bestnode , __pa ( MAX_DMA_ADDRESS ) ) ; } return ptr ; } 