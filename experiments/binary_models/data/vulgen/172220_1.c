struct dma_buf_attachment * dma_buf_attach ( struct dma_buf * dmabuf , struct device * dev ) { struct dma_buf_attachment * attach ; int ret ; attach = kzalloc ( sizeof ( dma_buf_attachment ) , GFP_KERNEL ) ; if ( attach == NULL ) { return ERR_PTR ( - ENOMEM ) ; } attach -> dev = dev ; attach -> dmabuf = dmabuf ; mutex_lock ( & dmabuf -> lock ) ; if ( dmabuf -> ops -> attach ) { ret = dmabuf -> ops -> attach ( dmabuf , dev , attach ) ; if ( ret ) { err_attach } } list_add ( & attach -> node , & dmabuf -> attachments ) ; mutex_unlock ( & dmabuf -> lock ) ; return attach ; err_attach kfree ( attach ) ; mutex_unlock ( & dmabuf -> lock ) ; return ERR_PTR ( ret ) ; } 