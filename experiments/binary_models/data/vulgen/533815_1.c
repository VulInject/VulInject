static struct dn_dev * dn_dev_create ( struct net_device * dev , int * err ) { int i ; struct dn_dev_parms * p = dn_dev_list ; struct dn_dev * dn_db ; for ( i = 0 ; i < DN_DEV_LIST_SIZE ; i ++ , p ++ ) { if ( p -> type == dev -> type ) { break ; } } * err = - ENODEV ; * err = - ENOBUFS ; if ( ( dn_db = kzalloc ( sizeof ( dn_dev ) , GFP_ATOMIC ) ) == NULL ) { return NULL ; } memcpy ( & dn_db -> parms , p , sizeof ( dn_dev_parms ) ) ; rcu_assign_pointer ( dev -> dn_ptr , dn_db ) ; dn_db -> dev = dev ; init_timer ( & dn_db -> timer ) ; dn_db -> uptime = jiffies ; dn_db -> neigh_parms = neigh_parms_alloc ( dev , & dn_neigh_table ) ; if ( ! dn_db -> neigh_parms ) { RCU_INIT_POINTER ( dev -> dn_ptr , NULL ) ; kfree ( dn_db ) ; return NULL ; } if ( dn_db -> parms . up ) { if ( dn_db -> parms . up ( dev ) < 0 ) { neigh_parms_release ( & dn_neigh_table , dn_db -> neigh_parms ) ; dev -> dn_ptr = NULL ; kfree ( dn_db ) ; return NULL ; } } dn_dev_sysctl_register ( dev , & dn_db -> parms ) ; dn_dev_set_timer ( dev ) ; * err = 0 ; return dn_db ; } 