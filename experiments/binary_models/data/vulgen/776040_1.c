static int fido_dev_open_rx ( fido_dev_t * dev , int * ms ) { fido_cbor_info_t * info = NULL ; int reply_len ; int r ; if ( ( reply_len = fido_rx ( dev , CTAP_CMD_INIT , & dev -> attr , sizeof ( dev -> attr ) , ms ) ) < 0 ) { fido_log_debug ( "%s: fido_rx" , __func__ ) ; r = FIDO_ERR_RX ; fail } dev -> attr . nonce = dev -> nonce ; if ( ( size_t ) reply_len != sizeof ( dev -> attr ) || dev -> attr . nonce != dev -> nonce ) { fido_log_debug ( "%s: invalid nonce" , __func__ ) ; r = FIDO_ERR_RX ; fail } dev -> cid = dev -> attr . cid ; if ( fido_dev_is_fido2 ( dev ) ) { if ( ( info = fido_cbor_info_new ( ) ) == NULL ) { fido_log_debug ( "%s: fido_cbor_info_new" , __func__ ) ; r = FIDO_ERR_INTERNAL ; fail } if ( ( r = fido_dev_get_cbor_info_wait ( dev , info , ms ) ) != FIDO_OK ) { fido_log_debug ( "%s: fido_dev_cbor_info_wait: %d" , __func__ , r ) ; if ( disable_u2f_fallback ) { fail } fido_log_debug ( "%s: falling back to u2f" , __func__ ) ; fido_dev_force_u2f ( dev ) ; } else { fido_dev_set_flags ( dev , info ) ; } } if ( fido_dev_is_fido2 ( dev ) && info != NULL ) { dev -> maxmsgsize = fido_cbor_info_maxmsgsiz ( info ) ; fido_log_debug ( "%s: FIDO_MAXMSG=%d, maxmsgsiz=%lu" , __func__ , FIDO_MAXMSG , ( unsigned long ) dev -> maxmsgsize ) ; } r = FIDO_OK ; fail fido_cbor_info_free ( & info ) ; if ( r != FIDO_OK ) { dev -> io . close ( dev -> io_handle ) ; dev -> io_handle = NULL ; } return ( r ) ; } 