static int __drc_pmem_query_health ( struct papr_scm_priv * p ) { unsigned long ret [ PLPAR_HCALL_BUFSIZE ] ; u64 bitmap ; long rc ; rc = plpar_hcall ( H_SCM_HEALTH , ret , p -> drc_index ) ; if ( rc == H_SUCCESS ) { bitmap = ret [ 0 ] & ret [ 1 ] ; } if ( rc == H_FUNCTION ) { dev_info_once ( & p -> pdev -> dev , "Hcall H_SCM_HEALTH not implemented, assuming empty health bitmap" ) ; } else { dev_err ( & p -> pdev -> dev , "Failed to query health information, Err:%ld\n" , rc ) ; return - ENXIO ; } p -> lasthealth_jiffies = jiffies ; if ( p -> health_bitmap_inject_mask ) { bitmap = ( bitmap & ~ p -> health_bitmap_inject_mask ) | p -> health_bitmap_inject_mask ; } WRITE_ONCE ( p -> health_bitmap , bitmap ) ; dev_dbg ( & p -> pdev -> dev , "Queried dimm health info. Bitmap:0x%016lx Mask:0x%016lx\n" , ret [ 0 ] , ret [ 1 ] ) ; return 0 ; } 