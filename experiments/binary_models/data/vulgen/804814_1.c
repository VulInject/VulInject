static void bdx_rx_alloc_skbs ( struct bdx_priv * priv , struct rxf_fifo * f ) { struct sk_buff * skb ; struct rxf_desc * rxfd ; struct rx_map * dm ; int dno , delta , idx ; struct rxdb * db = priv -> rxdb ; ENTER ; dno = bdx_rxdb_available ( db ) - 1 ; while ( dno > 0 ) { skb = netdev_alloc_skb ( priv -> ndev , f -> m . pktsz + NET_IP_ALIGN ) ; skb_reserve ( skb , NET_IP_ALIGN ) ; idx = bdx_rxdb_alloc_elem ( db ) ; dm = bdx_rxdb_addr_elem ( db , idx ) ; dm -> dma = pci_map_single ( priv -> pdev , skb -> data , f -> m . pktsz , PCI_DMA_FROMDEVICE ) ; dm -> skb = skb ; rxfd = ( rxf_desc * ) ( f -> m . va + f -> m . wptr ) ; rxfd -> info = CPU_CHIP_SWAP32 ( 0x10003 ) ; rxfd -> va_lo = idx ; rxfd -> pa_lo = CPU_CHIP_SWAP32 ( L32_64 ( dm -> dma ) ) ; rxfd -> pa_hi = CPU_CHIP_SWAP32 ( H32_64 ( dm -> dma ) ) ; rxfd -> len = CPU_CHIP_SWAP32 ( f -> m . pktsz ) ; print_rxfd ( rxfd ) ; f -> m . wptr += sizeof ( rxf_desc ) ; delta = f -> m . wptr - f -> m . memsz ; if ( unlikely ( delta >= 0 ) ) { f -> m . wptr = delta ; if ( delta > 0 ) { memcpy ( f -> m . va , f -> m . va + f -> m . memsz , delta ) ; DBG ( "wrapped descriptor\n" ) ; } } dno -- ; } WRITE_REG ( priv , f -> m . reg_WPTR , f -> m . wptr & TXF_WPTR_WR_PTR ) ; RET ( ) ; } 