static u_int ether_common_print ( netdissect_options * ndo , const u_char * p , u_int length , u_int caplen , void * print_switch_tag ( netdissect_options * ndo , const u_char * ) , u_int switch_tag_len , void * print_encap_header ( netdissect_options * ndo , const u_char * ) , const u_char * encap_header_arg ) { const struct ether_header * ehp ; u_int orig_length ; u_int hdrlen ; u_short length_type ; int printed_length ; int llc_hdrlen ; struct lladdr_info src , dst ; if ( length < caplen ) { ND_PRINT ( "[length %u<caplen %u]" , length , caplen ) ; nd_print_invalid ( ndo ) ; return length ; } if ( caplen < ETHER_HDRLEN + switch_tag_len ) { nd_print_trunc ( ndo ) ; return caplen ; } if ( print_encap_header != NULL ) { * print_encap_header ( ndo , encap_header_arg ) ; } orig_length = length ; ehp = ( const ether_header * ) p ; src . addr = ehp -> ether_shost ; src . addr_string = etheraddr_string ; dst . addr = ehp -> ether_dhost ; dst . addr_string = etheraddr_string ; length -= 2 * MAC_ADDR_LEN ; caplen -= 2 * MAC_ADDR_LEN ; p += 2 * MAC_ADDR_LEN ; hdrlen = 2 * MAC_ADDR_LEN ; if ( ndo -> ndo_eflag ) { ether_addresses_print ( ndo , src . addr , dst . addr ) ; } if ( print_switch_tag != NULL ) { * print_switch_tag ( ndo , p ) ; } length -= switch_tag_len ; caplen -= switch_tag_len ; p += switch_tag_len ; hdrlen += switch_tag_len ; recurse length_type = GET_BE_U_2 ( p ) ; length -= 2 ; caplen -= 2 ; p += 2 ; hdrlen += 2 ; printed_length = 0 ; if ( length_type == ETHERTYPE_MACSEC ) { if ( ndo -> ndo_eflag ) { ether_type_print ( ndo , length_type ) ; ND_PRINT ( ", length %u: " , orig_length ) ; printed_length = 1 ; } int ret = macsec_print ( ndo , & p , & length , & caplen , & hdrlen , & src , & dst ) ; if ( ret == 0 ) { if ( ! ndo -> ndo_suppress_default_print ) { ND_DEFAULTPRINT ( p , caplen ) ; } return hdrlen ; } if ( ret > 0 ) { return ret ; } else { length_type = GET_BE_U_2 ( p ) ; ND_ICHECK_U ( caplen , < , 2 ) ; length -= 2 ; caplen -= 2 ; p += 2 ; hdrlen += 2 ; } } while ( length_type == ETHERTYPE_8021Q || length_type == ETHERTYPE_8021Q9100 || length_type == ETHERTYPE_8021Q9200 || length_type == ETHERTYPE_8021QinQ ) { if ( caplen < 4 ) { ndo -> ndo_protocol = "vlan" ; nd_print_trunc ( ndo ) ; return hdrlen + caplen ; } if ( length < 4 ) { ndo -> ndo_protocol = "vlan" ; nd_print_trunc ( ndo ) ; return hdrlen + length ; } if ( ndo -> ndo_eflag ) { uint16_t tag = GET_BE_U_2 ( p ) ; ether_type_print ( ndo , length_type ) ; if ( ! printed_length ) { ND_PRINT ( ", length %u: " , orig_length ) ; printed_length = 1 ; } else { ND_PRINT ( ", " ) ; } ND_PRINT ( "%s, " , ieee8021q_tci_string ( tag ) ) ; } length_type = GET_BE_U_2 ( p + 2 ) ; p += 4 ; length -= 4 ; caplen -= 4 ; hdrlen += 4 ; } if ( length_type <= MAX_ETHERNET_LENGTH_VAL ) { if ( length_type < length ) { length = length_type ; if ( caplen > length ) { caplen = length ; } } if ( ! nd_push_snaplen ( ndo , p , length ) ) { * ndo -> ndo_error ( ndo , S_ERR_ND_MEM_ALLOC , "%s: can't push snaplen on buffer stack" , __func__ ) ; } if ( ndo -> ndo_eflag ) { ND_PRINT ( "802.3" ) ; if ( ! printed_length ) { ND_PRINT ( ", length %u: " , length ) ; } } llc_hdrlen = llc_print ( ndo , p , length , caplen , & src , & dst ) ; if ( llc_hdrlen < 0 ) { if ( ! ndo -> ndo_suppress_default_print ) { ND_DEFAULTPRINT ( p , caplen ) ; } llc_hdrlen = - llc_hdrlen ; } hdrlen += llc_hdrlen ; nd_pop_packet_info ( ndo ) ; } if ( length_type == ETHERTYPE_JUMBO ) { llc_hdrlen = llc_print ( ndo , p , length , caplen , & src , & dst ) ; if ( llc_hdrlen < 0 ) { if ( ! ndo -> ndo_suppress_default_print ) { ND_DEFAULTPRINT ( p , caplen ) ; } llc_hdrlen = - llc_hdrlen ; } hdrlen += llc_hdrlen ; } if ( length_type == ETHERTYPE_ARISTA ) { if ( caplen < 2 ) { ND_PRINT ( "[|arista]" ) ; return hdrlen + caplen ; } ether_type_print ( ndo , length_type ) ; ND_PRINT ( ", length %u: " , orig_length ) ; int bytesConsumed = arista_ethertype_print ( ndo , p , length ) ; if ( bytesConsumed > 0 ) { p += bytesConsumed ; length -= bytesConsumed ; caplen -= bytesConsumed ; hdrlen += bytesConsumed ; recurse } else { if ( ! ndo -> ndo_eflag && length_type > MAX_ETHERNET_LENGTH_VAL ) { ether_addresses_print ( ndo , src . addr , dst . addr ) ; ether_type_print ( ndo , length_type ) ; ND_PRINT ( ", length %u: " , orig_length ) ; } if ( ! ndo -> ndo_suppress_default_print ) { ND_DEFAULTPRINT ( p , caplen ) ; } } } else { if ( ndo -> ndo_eflag ) { ether_type_print ( ndo , length_type ) ; if ( ! printed_length ) { ND_PRINT ( ", length %u: " , orig_length ) ; } else { ND_PRINT ( ", " ) ; } } if ( ethertype_print ( ndo , length_type , p , length , caplen , & src , & dst ) == 0 ) { if ( ! ndo -> ndo_eflag ) { ether_addresses_print ( ndo , src . addr , dst . addr ) ; ether_type_print ( ndo , length_type ) ; ND_PRINT ( ", length %u: " , orig_length ) ; } if ( ! ndo -> ndo_suppress_default_print ) { ND_DEFAULTPRINT ( p , caplen ) ; } } } invalid return hdrlen ; } 