void arpreply ( struct ifnet * ifp , struct mbuf * m , struct in_addr * sip , uint8_t * eaddr , unsigned int rdomain ) { struct ether_header * eh ; struct ether_arp * ea ; struct sockaddr sa ; m_resethdr ( m ) ; m -> m_pkthdr . ph_rtableid = rdomain ; ea = mtod ( m , ether_arp * ) ; ea -> arp_op = htons ( ARPOP_REPLY ) ; ea -> arp_pro = htons ( ETHERTYPE_IP ) ; memcpy ( ea -> arp_tha , ea -> arp_sha , sizeof ( ea -> arp_sha ) ) ; memcpy ( ea -> arp_tpa , ea -> arp_spa , sizeof ( ea -> arp_spa ) ) ; memcpy ( ea -> arp_sha , eaddr , sizeof ( ea -> arp_sha ) ) ; memcpy ( ea -> arp_spa , sip , sizeof ( ea -> arp_spa ) ) ; eh = ( ether_header * ) sa . sa_data ; memcpy ( eh -> ether_dhost , ea -> arp_tha , sizeof ( eh -> ether_dhost ) ) ; memcpy ( eh -> ether_shost , eaddr , sizeof ( eh -> ether_shost ) ) ; eh -> ether_type = htons ( ETHERTYPE_ARP ) ; sa . sa_family = pseudo_AF_HDRCMPLT ; sa . sa_len = sizeof ( sa ) ; } 