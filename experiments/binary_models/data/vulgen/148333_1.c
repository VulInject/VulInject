static int drm_minor_alloc ( struct drm_device * dev , unsigned int type ) { struct drm_minor * minor ; unsigned long flags ; int r ; minor = drmm_kzalloc ( dev , sizeof ( * minor ) , GFP_KERNEL ) ; if ( ! minor ) { return - ENOMEM ; } minor -> type = type ; minor -> dev = dev ; idr_preload ( GFP_KERNEL ) ; spin_lock_irqsave ( & drm_minor_lock , flags ) ; r = idr_alloc ( & drm_minors_idr , NULL , 64 * type , 64 * ( type + 1 ) , GFP_NOWAIT ) ; spin_unlock_irqrestore ( & drm_minor_lock , flags ) ; idr_preload_end ( ) ; if ( r < 0 ) { return r ; } minor -> index = r ; r = drmm_add_action_or_reset ( dev , drm_minor_alloc_release , minor ) ; if { return r ; } minor -> kdev = drm_sysfs_minor_alloc ( minor ) ; if ( IS_ERR ( minor -> kdev ) ) { return PTR_ERR ( minor -> kdev ) ; } * drm_minor_get_slot ( dev , type ) = minor ; return 0 ; } 