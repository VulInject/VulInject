static void atmci_write_data_pio ( struct atmel_mci * host ) { struct scatterlist * sg = host -> sg ; void * buf = sg_virt ( sg ) ; unsigned int offset = host -> pio_offset ; struct mmc_data * data = host -> data ; u32 value ; u32 status ; unsigned int nbytes ; { if ( likely ( offset + 4 <= sg -> length ) ) { value = get_unaligned ( ( u32 * ) ( buf + offset ) ) ; atmci_writel ( host , ATMCI_TDR , value ) ; offset += 4 ; nbytes += 4 ; if ( offset == sg -> length ) { host -> sg = sg = sg_next ( sg ) ; host -> sg_len -- ; if ( ! sg || ! host -> sg_len ) { done } offset = 0 ; buf = sg_virt ( sg ) ; } } else { unsigned int remaining = sg -> length - offset ; value = 0 ; memcpy ( & value , buf + offset , remaining ) ; nbytes += remaining ; host -> sg = sg = sg_next ( sg ) ; host -> sg_len -- ; if ( ! sg || ! host -> sg_len ) { atmci_writel ( host , ATMCI_TDR , value ) ; done } offset = 4 - remaining ; buf = sg_virt ( sg ) ; memcpy ( ( u8 * ) & value + remaining , buf , offset ) ; atmci_writel ( host , ATMCI_TDR , value ) ; nbytes += offset ; } status = atmci_readl ( host , ATMCI_SR ) ; if ( status & ATMCI_DATA_ERROR_FLAGS ) { atmci_writel ( host , ATMCI_IDR , ( ATMCI_NOTBUSY | ATMCI_TXRDY | ATMCI_DATA_ERROR_FLAGS ) ) ; host -> data_status = status ; data -> bytes_xfered += nbytes ; return ; } } status & ATMCI_TXRDY ; host -> pio_offset = offset ; data -> bytes_xfered += nbytes ; return ; done atmci_writel ( host , ATMCI_IDR , ATMCI_TXRDY ) ; atmci_writel ( host , ATMCI_IER , ATMCI_NOTBUSY ) ; data -> bytes_xfered += nbytes ; smp_wmb ( ) ; atmci_set_pending ( host , EVENT_XFER_COMPLETE ) ; } 