static int xdb_open_device ( xdb_t * vdp ) { dev_info_t * dip = vdp -> xs_dip ; uint64_t devsize ; int blksize ; char * nodepath ; char * xsname ; char * str ; int err ; ASSERT ( MUTEX_HELD ( & vdp -> xs_cbmutex ) ) ; if ( strlen ( vdp -> xs_params_path ) == 0 ) { ASSERT ( XDB_IS_FE_CD ( vdp ) ) ; ASSERT ( vdp -> xs_sectors == 0 ) ; ASSERT ( vdp -> xs_ldi_li == NULL ) ; ASSERT ( vdp -> xs_ldi_hdl == NULL ) ; return ( DDI_SUCCESS ) ; } xsname = xvdi_get_xsname ( dip ) ; err = xenbus_read_str ( xsname , "dynamic-device-path" , & str ) ; if ( err == 0 ) { strfree ( vdp -> xs_params_path ) ; vdp -> xs_params_path = str ; } if ( ldi_ident_from_dip ( dip , & vdp -> xs_ldi_li ) != 0 ) { return ( DDI_FAILURE ) ; } nodepath = kmem_zalloc ( MAXPATHLEN , KM_SLEEP ) ; if ( xdb_setup_node ( vdp , nodepath ) != DDI_SUCCESS ) { xvdi_dev_error ( dip , ENXIO , "Getting device path of backend device" ) ; kmem_free ( nodepath , MAXPATHLEN ) ; return ( DDI_FAILURE ) ; } if ( ldi_open_by_name ( nodepath , FREAD | ( XDB_IS_RO ( vdp ) ?0 : FWRITE ) , kcred , & vdp -> xs_ldi_hdl , vdp -> xs_ldi_li ) != 0 ) { xdb_teardown_node ( vdp ) ; ldi_ident_release ( vdp -> xs_ldi_li ) ; cmn_err ( CE_WARN , "xdb@%s: Failed to open: %s" , ddi_get_name_addr ( dip ) , nodepath ) ; kmem_free ( nodepath , MAXPATHLEN ) ; return ( DDI_FAILURE ) ; } if ( ldi_get_size ( vdp -> xs_ldi_hdl , & devsize ) != DDI_SUCCESS ) { ( void ) ldi_close ( vdp -> xs_ldi_hdl , FREAD | ( XDB_IS_RO ( vdp ) ?0 : FWRITE ) , kcred ) ; xdb_teardown_node ( vdp ) ; ldi_ident_release ( vdp -> xs_ldi_li ) ; kmem_free ( nodepath , MAXPATHLEN ) ; return ( DDI_FAILURE ) ; } blksize = ldi_prop_get_int64 ( vdp -> xs_ldi_hdl , DDI_PROP_DONTPASS | DDI_PROP_NOTPROM , "blksize" , DEV_BSIZE ) ; if ( blksize == DEV_BSIZE ) { blksize = ldi_prop_get_int ( vdp -> xs_ldi_hdl , LDI_DEV_T_ANY | DDI_PROP_DONTPASS | DDI_PROP_NOTPROM , "device-blksize" , DEV_BSIZE ) ; } vdp -> xs_sec_size = blksize ; vdp -> xs_sectors = devsize / blksize ; if ( ldi_prop_get_int ( vdp -> xs_ldi_hdl , LDI_DEV_T_ANY | DDI_PROP_DONTPASS , INQUIRY_DEVICE_TYPE , DTYPE_DIRECT ) == DTYPE_RODIRECT ) { vdp -> xs_type |= XDB_DEV_BE_CD ; } if ( ldi_prop_exists ( vdp -> xs_ldi_hdl , LDI_DEV_T_ANY | DDI_PROP_DONTPASS | DDI_PROP_NOTPROM , "removable-media" ) ) { vdp -> xs_type |= XDB_DEV_BE_RMB ; } kmem_free ( nodepath , MAXPATHLEN ) ; return ( DDI_SUCCESS ) ; } 