static blk_status_t null_zone_write ( struct nullb_cmd * cmd , sector_t sector , unsigned int nr_sectors , bool append ) { struct nullb_device * dev = cmd -> nq -> dev ; unsigned int zno = null_zone_no ( dev , sector ) ; struct nullb_zone * zone = & dev -> zones [ zno ] ; blk_status_t ret ; trace_nullb_zone_op ( cmd , zno , zone -> cond ) ; if ( zone -> type == BLK_ZONE_TYPE_CONVENTIONAL ) { if ( append ) { return BLK_STS_IOERR ; } return null_process_cmd ( cmd , REQ_OP_WRITE , sector , nr_sectors ) ; } null_lock_zone ( dev , zone ) ; if ( zone -> cond == BLK_ZONE_COND_FULL || zone -> cond == BLK_ZONE_COND_READONLY || zone -> cond == BLK_ZONE_COND_OFFLINE ) { ret = BLK_STS_IOERR ; unlock } if ( append ) { sector = zone -> wp ; else { cmd -> bio -> bi_iter . bi_sector = sector ; } } if ( sector != zone -> wp ) { ret = BLK_STS_IOERR ; unlock } if ( zone -> wp + nr_sectors > zone -> start + zone -> capacity ) { ret = BLK_STS_IOERR ; unlock } if ( zone -> cond == BLK_ZONE_COND_CLOSED || zone -> cond == BLK_ZONE_COND_EMPTY ) { null_lock_zone_res ( dev ) ; ret = null_check_zone_resources ( dev , zone ) ; if ( ret != BLK_STS_OK ) { null_unlock_zone_res ( dev ) ; unlock } if ( zone -> cond == BLK_ZONE_COND_CLOSED ) { dev -> nr_zones_closed -- ; dev -> nr_zones_imp_open ++ ; } if ( zone -> cond == BLK_ZONE_COND_EMPTY ) { dev -> nr_zones_imp_open ++ ; } if ( zone -> cond != BLK_ZONE_COND_EXP_OPEN ) { zone -> cond = BLK_ZONE_COND_IMP_OPEN ; } null_unlock_zone_res ( dev ) ; } ret = null_process_cmd ( cmd , REQ_OP_WRITE , sector , nr_sectors ) ; if ( ret != BLK_STS_OK ) { unlock } zone -> wp += nr_sectors ; if ( zone -> wp == zone -> start + zone -> capacity ) { null_lock_zone_res ( dev ) ; if ( zone -> cond == BLK_ZONE_COND_EXP_OPEN ) { dev -> nr_zones_exp_open -- ; } if ( zone -> cond == BLK_ZONE_COND_IMP_OPEN ) { dev -> nr_zones_imp_open -- ; } zone -> cond = BLK_ZONE_COND_FULL ; null_unlock_zone_res ( dev ) ; } ret = BLK_STS_OK ; unlock null_unlock_zone ( dev , zone ) ; return ret ; } 