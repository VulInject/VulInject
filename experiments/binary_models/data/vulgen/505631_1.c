ZEND_RESULT_CODE php_http_querystring_update ( zval * qarray , zval * params , zval * outstring ) { if ( Z_TYPE_P ( qarray ) != IS_ARRAY ) { convert_to_array ( qarray ) ; } if ( ! params ) { zend_hash_apply ( Z_ARRVAL_P ( qarray ) , apply_querystring_filter ) ; } else { HashTable * ht ; php_http_arrkey_t key ; zval zv , * params_entry , * qarray_entry ; ZVAL_NULL ( & zv ) ; if ( Z_TYPE_P ( params ) == IS_OBJECT && instanceof_function ( Z_OBJCE_P ( params ) , php_http_querystring_class_entry ) ) { zval qa_tmp , * qa = zend_read_property ( php_http_querystring_class_entry , Z_OBJ_P ( params ) , ZEND_STRL ( "queryArray" ) , 0 , & qa_tmp ) ; ZVAL_DEREF ( qa ) ; convert_to_array ( qa ) ; ht = Z_ARRVAL_P ( qa ) ; } if ( Z_TYPE_P ( params ) == IS_OBJECT || Z_TYPE_P ( params ) == IS_ARRAY ) { ht = HASH_OF ( params ) ; } else { zend_string * zs = zval_get_string ( params ) ; array_init ( & zv ) ; php_http_querystring_parse ( Z_ARRVAL ( zv ) , zs -> val , zs -> len ) ; ht = Z_ARRVAL ( zv ) ; } ZEND_HASH_FOREACH_KEY_VAL_IND ( , , , ) { if ( ! key . key || * key . key -> val ) { if ( Z_TYPE_P ( params_entry ) == IS_NULL ) { if ( key . key ) { zend_hash_del ( Z_ARRVAL_P ( qarray ) , key . key ) ; } else { zend_hash_index_del ( Z_ARRVAL_P ( qarray ) , key . h ) ; } } if ( ( ( key . key ) && ( qarray_entry = zend_hash_find ( Z_ARRVAL_P ( qarray ) , key . key ) ) ) || ( ( ! key . key ) && ( qarray_entry = zend_hash_index_find ( Z_ARRVAL_P ( qarray ) , key . h ) ) ) ) { zval equal , tmp , * entry = NULL ; ZVAL_UNDEF ( & tmp ) ; if ( Z_TYPE_P ( params_entry ) == IS_ARRAY || Z_TYPE_P ( params_entry ) == IS_OBJECT ) { ZVAL_DUP ( & tmp , qarray_entry ) ; convert_to_array ( & tmp ) ; php_http_querystring_update ( & tmp , params_entry , NULL ) ; entry = & tmp ; } if ( ( FAILURE == is_identical_function ( & equal , qarray_entry , params_entry ) ) || Z_TYPE ( equal ) != IS_TRUE ) { Z_TRY_ADDREF_P ( params_entry ) ; entry = params_entry ; } if ( key . key ) { zend_hash_update ( Z_ARRVAL_P ( qarray ) , key . key , entry ?entry : & tmp ) ; } else { zend_hash_index_update ( Z_ARRVAL_P ( qarray ) , key . h , entry ?entry : & tmp ) ; } } else { zval entry , * entry_ptr = & entry ; if ( Z_TYPE_P ( params_entry ) == IS_OBJECT ) { array_init ( & entry ) ; php_http_querystring_update ( & entry , params_entry , NULL ) ; } else { Z_TRY_ADDREF_P ( params_entry ) ; entry_ptr = params_entry ; } if ( key . key ) { add_assoc_zval_ex ( qarray , key . key -> val , key . key -> len , entry_ptr ) ; } else { add_index_zval ( qarray , key . h , entry_ptr ) ; } } } } ZEND_HASH_FOREACH_END ( ) ; zval_dtor ( & zv ) ; } if ( outstring ) { char * s ; size_t l ; if ( SUCCESS == php_http_url_encode_hash ( Z_ARRVAL_P ( qarray ) , NULL , 0 , & s , & l ) ) { zval_dtor ( outstring ) ; ZVAL_STR ( outstring , php_http_cs2zs ( s , l ) ) ; } else { php_error_docref ( NULL , E_WARNING , "Failed to encode query string" ) ; return FAILURE ; } } return SUCCESS ; } 