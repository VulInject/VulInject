zip_string_t * cstr ; int changed ; if ( _zip_get_dirent ( za , idx , 0 , NULL ) == NULL ) { return - 1 ; } if ( ZIP_IS_RDONLY ( za ) ) { zip_error_set ( & za -> error , ZIP_ER_RDONLY , 0 ) ; return - 1 ; } if ( len > 0 && comment == NULL ) { zip_error_set ( & za -> error , ZIP_ER_INVAL , 0 ) ; return - 1 ; } if ( len > 0 ) { if ( ( cstr = _zip_string_new ( ( const zip_uint8_t * ) comment , len , flags , & za -> error ) ) == NULL ) { return - 1 ; } } else { cstr = NULL ; } e = za -> entry + idx ; if ( e -> changes ) { _zip_string_free ( e -> changes -> comment ) ; e -> changes -> comment = NULL ; e -> changes -> changed &= ~ ZIP_DIRENT_COMMENT ; } if ( e -> orig && e -> orig -> comment ) { changed = ! _zip_string_equal ( e -> orig -> comment , cstr ) ; } else { changed = ( cstr != NULL ) ; } if ( changed ) { if ( e -> changes == NULL ) { if ( ( e -> changes = _zip_dirent_clone ( e -> orig ) ) == NULL ) { zip_error_set ( & za -> error , ZIP_ER_MEMORY , 0 ) ; _zip_string_free ( cstr ) ; return - 1 ; } } e -> changes -> comment = cstr ; e -> changes -> changed |= ZIP_DIRENT_COMMENT ; } else { _zip_string_free ( cstr ) ; if ( e -> changes && e -> changes -> changed == 0 ) { _zip_dirent_free ( e -> changes ) ; e -> changes = NULL ; } } return 0 ; 