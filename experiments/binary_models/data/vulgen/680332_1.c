u32 __kprobes aarch64_insn_encode_immediate ( enum aarch64_insn_imm_type type , u32 insn , u64 imm ) { u32 immlo , immhi , mask ; int shift ; switch ( type ) { case AARCH64_INSN_IMM_ADR : shift = 0 ; immlo = ( imm & ADR_IMM_LOMASK ) << ADR_IMM_LOSHIFT ; imm >>= ADR_IMM_HILOSPLIT ; immhi = ( imm & ADR_IMM_HIMASK ) << ADR_IMM_HISHIFT ; imm = immlo | immhi ; mask = ( ( ADR_IMM_LOMASK << ADR_IMM_LOSHIFT ) | ( ADR_IMM_HIMASK << ADR_IMM_HISHIFT ) ) ; break ; default : if ( aarch64_get_imm_shift_mask ( type , & mask , & shift ) < 0 ) { pr_err ( "%s: unknown immediate encoding %d\n" , __func__ , type ) ; return AARCH64_BREAK_FAULT ; } } insn &= ~ ( mask << shift ) ; insn |= ( imm & mask ) << shift ; return insn ; } 