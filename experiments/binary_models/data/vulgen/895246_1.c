static void g5_smu_switch_volt ( int speed_mode ) { struct smu_simple_cmd cmd ; DECLARE_COMPLETION_ONSTACK ( comp ) ; smu_queue_simple ( & cmd , SMU_CMD_POWER_COMMAND , 8 , smu_done_complete , & comp , 'V' , 'S' , 'L' , 'E' , 'W' , 0xff , g5_fvt_cur + 1 , speed_mode ) ; wait_for_completion ( & comp ) ; } static struct pmf_function * pfunc_set_vdnap0 ; static struct pmf_function * pfunc_vdnap0_complete ; static void g5_vdnap_switch_volt ( int speed_mode ) { struct pmf_args args ; u32 slew , done ; unsigned long timeout ; slew = ( speed_mode == CPUFREQ_LOW ) ?1 : 0 ; args . count = 1 ; args . u [ 0 ] . p = & slew ; pmf_call_one ( pfunc_set_vdnap0 , & args ) ; timeout = jiffies + HZ / 10 ; while ( ! time_after ( jiffies , timeout ) ) { args . count = 1 ; args . u [ 0 ] . p = & done ; pmf_call_one ( pfunc_vdnap0_complete , & args ) ; if ( done ) { break ; } usleep_range ( 1000 , 1000 ) ; } if ( done == 0 ) { pr_warn ( "Timeout in clock slewing !\n" ) ; } } 