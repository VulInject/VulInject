static void handle_establish_intro_cell_dos_extension ( const trn_extension_field_t * field , or_circuit_t * circ ) { ssize_t ret ; uint64_t intro2_rate_per_sec = 0 , intro2_burst_per_sec = 0 ; trn_cell_extension_dos_t * dos = NULL ; tor_assert ( field ) ; tor_assert ( circ ) ; ret = trn_cell_extension_dos_parse ( & dos , trn_extension_field_getconstarray_field ( field ) , trn_extension_field_getlen_field ( field ) ) ; for ( size_t i = 0 ; i < trn_cell_extension_dos_get_n_params ( dos ) ; i ++ ) { const trn_cell_extension_dos_param_t * param = trn_cell_extension_dos_getconst_params ( dos , i ) ; if ( BUG ( param == NULL ) ) { end } switch ( trn_cell_extension_dos_param_get_type ( param ) ) { case TRUNNEL_DOS_PARAM_TYPE_INTRO2_RATE_PER_SEC : intro2_rate_per_sec = trn_cell_extension_dos_param_get_value ( param ) ; break ; case TRUNNEL_DOS_PARAM_TYPE_INTRO2_BURST_PER_SEC : intro2_burst_per_sec = trn_cell_extension_dos_param_get_value ( param ) ; break ; default : end } } circ -> introduce2_dos_defense_explicit = 1 ; if ( intro2_rate_per_sec == 0 || intro2_burst_per_sec == 0 ) { log_info ( LD_REND , "Intro point DoS defenses parameter set to 0. " "Disabling INTRO2 DoS defenses on circuit id %u" , circ -> p_circ_id ) ; circ -> introduce2_dos_defense_enabled = 0 ; end } if ( ! cell_dos_extension_parameters_are_valid ( intro2_rate_per_sec , intro2_burst_per_sec ) ) { circ -> introduce2_dos_defense_enabled = 0 ; log_info ( LD_REND , "Disabling INTRO2 DoS defenses on circuit id %u" , circ -> p_circ_id ) ; end } circ -> introduce2_dos_defense_enabled = 1 ; token_bucket_ctr_init ( & circ -> introduce2_bucket , ( uint32_t ) intro2_rate_per_sec , ( uint32_t ) intro2_burst_per_sec , ( uint32_t ) approx_time ( ) ) ; log_info ( LD_REND , "Intro point DoS defenses enabled. Rate is %" PRIu64 " and Burst is %" PRIu64 , intro2_rate_per_sec , intro2_burst_per_sec ) ; end trn_cell_extension_dos_free ( dos ) ; return ; } 