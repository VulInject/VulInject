int mbedtls_x509write_crt_set_ext_key_usage ( mbedtls_x509write_cert * ctx , const mbedtls_asn1_sequence * exts ) { unsigned char buf [ 256 ] ; unsigned char * c = buf + sizeof ( buf ) ; int ret ; size_t len = 0 ; const mbedtls_asn1_sequence * last_ext = NULL ; const mbedtls_asn1_sequence * ext ; if ( exts == NULL ) { return MBEDTLS_ERR_X509_BAD_INPUT_DATA ; } while ( last_ext != exts ) { for ( ext = exts ; ext -> next != last_ext ; ext = ext -> next ) { } if ( ext -> buf . tag != MBEDTLS_ASN1_OID ) { return MBEDTLS_ERR_X509_BAD_INPUT_DATA ; } MBEDTLS_ASN1_CHK_ADD ( len , mbedtls_asn1_write_raw_buffer ( & c , buf , ext -> buf . p , ext -> buf . len ) ) ; MBEDTLS_ASN1_CHK_ADD ( len , mbedtls_asn1_write_len ( & c , buf , ext -> buf . len ) ) ; MBEDTLS_ASN1_CHK_ADD ( len , mbedtls_asn1_write_tag ( & c , buf , MBEDTLS_ASN1_OID ) ) ; last_ext = ext ; } MBEDTLS_ASN1_CHK_ADD ( len , mbedtls_asn1_write_len ( & c , buf , len ) ) ; MBEDTLS_ASN1_CHK_ADD ( len , mbedtls_asn1_write_tag ( & c , buf , MBEDTLS_ASN1_CONSTRUCTED | MBEDTLS_ASN1_SEQUENCE ) ) ; return mbedtls_x509write_crt_set_extension ( ctx , MBEDTLS_OID_EXTENDED_KEY_USAGE , MBEDTLS_OID_SIZE ( MBEDTLS_OID_EXTENDED_KEY_USAGE ) , 1 , c , len ) ; } 