test_sdam_monitoring_cb ( ) { mongoc_client_t * client ; mongoc_topology_t * topology ; bson_t phase ; bson_t phases ; bson_t outcome ; bson_iter_t phase_iter ; bson_iter_t phase_field_iter ; bson_iter_t outcome_iter ; bson_iter_t iter ; bson_t events_expected ; context_t context ; bool first_phase ; BSON_ASSERT ( bson_iter_init_find ( & iter , test , "uri" ) ) ; client = test_framework_client_new ( bson_iter_utf8 ( & iter , NULL ) , NULL ) ; topology = client -> topology ; context_init ( & context ) ; client_set_topology_event_callbacks ( client , & context ) ; BSON_ASSERT ( bson_iter_init_find ( & iter , test , "phases" ) ) ; bson_iter_bson ( & iter , & phases ) ; bson_iter_init ( & phase_iter , & phases ) ; first_phase = true ; while ( bson_iter_next ( & phase_iter ) ) { bson_iter_bson ( & phase_iter , & phase ) ; if ( first_phase ) { mc_tpld_modification tdmod = mc_tpld_modify_begin ( topology ) ; mc_tpld_modify_commit ( tdmod ) ; first_phase = false ; } else { bson_reinit ( & context . events ) ; context . n_events = 0 ; } process_sdam_test_hello_responses ( & phase , client -> topology ) ; BSON_ASSERT ( bson_iter_init_find ( & phase_field_iter , & phase , "outcome" ) ) ; bson_iter_bson ( & phase_field_iter , & outcome ) ; bson_iter_init ( & outcome_iter , & outcome ) ; while ( bson_iter_next ( & outcome_iter ) ) { if ( strcmp ( "events" , bson_iter_key ( & outcome_iter ) ) == 0 ) { bson_iter_bson ( & outcome_iter , & events_expected ) ; check_json_sdam_events ( & context . events , & events_expected ) ; } else { fprintf ( stderr , "ERROR: unparsed test field %s\n" , bson_iter_key ( & outcome_iter ) ) ; BSON_ASSERT ( false ) ; } } } mongoc_client_destroy ( client ) ; context_destroy ( & context ) ; } 