void init_virtual_ip ( const char * private_list , struct logger * logger ) { free_virtual_ip ( ) ; int bad = 0 ; for ( const char * str = private_list ; str != NULL ; ) { const char * next = strchr ( str , ',' ) ; if ( next == NULL ) { next = str + strlen ( str ) ; } bool incl = false ; ip_subnet sub ; if ( read_subnet ( shunk2 ( str , next - str ) , & sub , & incl ) == NULL ) { if ( incl ) { private_net_incl_len ++ ; } else { private_net_excl_len ++ ; } } else { bad ++ ; } str = * next != '\0' ?next + 1 : NULL ; } if ( bad == 0 ) { if ( private_net_incl_len != 0 ) { private_net_incl = ( ip_subnet * ) alloc_bytes ( ( private_net_incl_len * sizeof ( ip_subnet ) ) , "private_net_incl subnets" ) ; } if ( private_net_excl_len != 0 ) { private_net_excl = ( ip_subnet * ) alloc_bytes ( ( private_net_excl_len * sizeof ( ip_subnet ) ) , "private_net_excl subnets" ) ; } int i_incl = 0 ; int i_excl = 0 ; for ( const char * str = private_list ; str != NULL ; ) { const char * next = strchr ( str , ',' ) ; bool incl = false ; ip_subnet sub ; if ( read_subnet ( shunk2 ( str , next - str ) , & sub , & incl ) == NULL ) { if ( incl ) { private_net_incl [ i_incl ++ ] = sub ; } else { private_net_excl [ i_excl ++ ] = sub ; } } str = * next != '\0' ?next + 1 : NULL ; } } else { llog ( RC_LOG_SERIOUS , logger , "%d bad entries in virtual-private - none loaded" , bad ) ; pfreeany ( private_net_incl ) ; private_net_incl = NULL ; } } 