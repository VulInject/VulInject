boolean_t tcp_newconn_notify ( tcp_t * tcp , ip_recv_attr_t * ira ) { tcp_t * listener = tcp -> tcp_listener ; conn_t * lconnp = listener -> tcp_connp ; conn_t * econnp = tcp -> tcp_connp ; tcp_t * tail ; ipaddr_t * addr_cache ; sock_upper_handle_t upper ; struct sock_proto_props sopp ; mutex_enter ( & listener -> tcp_eager_lock ) ; MAKE_UNDROPPABLE ( tcp ) ; ASSERT ( listener -> tcp_conn_req_cnt_q0 > 0 ) ; listener -> tcp_conn_req_cnt_q0 -- ; listener -> tcp_conn_req_cnt_q ++ ; tcp -> tcp_eager_next_q0 -> tcp_eager_prev_q0 = tcp -> tcp_eager_prev_q0 ; tcp -> tcp_eager_prev_q0 -> tcp_eager_next_q0 = tcp -> tcp_eager_next_q0 ; tcp -> tcp_eager_prev_q0 = NULL ; tcp -> tcp_eager_next_q0 = NULL ; tail = listener -> tcp_eager_last_q ; if ( tail != NULL ) { tail -> tcp_eager_next_q = tcp ; } else { listener -> tcp_eager_next_q = tcp ; } listener -> tcp_eager_last_q = tcp ; tcp -> tcp_eager_next_q = NULL ; if ( tcp -> tcp_syn_rcvd_timeout != 0 ) { tcp -> tcp_syn_rcvd_timeout = 0 ; listener -> tcp_syn_rcvd_timeout -- ; if ( listener -> tcp_syn_defense && listener -> tcp_syn_rcvd_timeout <= ( listener -> tcp_tcps -> tcps_conn_req_max_q0 >> 5 ) && 10 * MINUTES < TICK_TO_MSEC ( ddi_get_lbolt64 ( ) - listener -> tcp_last_rcv_lbolt ) ) { listener -> tcp_syn_defense = B_FALSE ; if ( listener -> tcp_ip_addr_cache ) { kmem_free ( ( void * ) listener -> tcp_ip_addr_cache , IP_ADDR_CACHE_SIZE * sizeof ( ipaddr_t ) ) ; listener -> tcp_ip_addr_cache = NULL ; } } } addr_cache = ( ipaddr_t * ) ( listener -> tcp_ip_addr_cache ) ; mutex_exit ( & listener -> tcp_eager_lock ) ; if ( ( upper = * lconnp -> conn_upcalls -> su_newconn ( lconnp -> conn_upper_handle , ( sock_lower_handle_t ) econnp , & sock_tcp_downcalls , ira -> ira_cred , ira -> ira_cpid , & econnp -> conn_upcalls ) ) == NULL ) { return ( B_FALSE ) ; } econnp -> conn_upper_handle = upper ; tcp -> tcp_detached = B_FALSE ; tcp -> tcp_hard_binding = B_FALSE ; tcp -> tcp_tconnind_started = B_TRUE ; if ( econnp -> conn_keepalive ) { tcp -> tcp_ka_last_intrvl = 0 ; tcp -> tcp_ka_tid = TCP_TIMER ( tcp , tcp_keepalive_timer , tcp -> tcp_ka_interval ) ; } tcp_get_proto_props ( tcp , & sopp ) ; * econnp -> conn_upcalls -> su_set_proto_props ( econnp -> conn_upper_handle , & sopp ) ; return ( B_TRUE ) ; } 