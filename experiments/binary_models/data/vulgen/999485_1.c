static void __set_filter ( int fd , int off_proto , uint8_t proto , int off_dport ) { struct sock_filter filter [ ] { BPF_STMT ( BPF_LD + BPF_B + BPF_ABS , SKF_AD_OFF + SKF_AD_PKTTYPE ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , PACKET_HOST , 0 , 4 ) BPF_STMT ( BPF_LD + BPF_B + BPF_ABS , off_proto ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , proto , 0 , 2 ) BPF_STMT ( BPF_LD + BPF_H + BPF_ABS , off_dport ) BPF_JUMP ( BPF_JMP + BPF_JEQ + BPF_K , cfg_dport , 1 , 0 ) BPF_STMT ( BPF_RET + BPF_K , 0 ) BPF_STMT ( BPF_RET + BPF_K , 0xFFFF ) } ; ; prog . filter = filter ; prog . len = ARRAY_SIZE ( filter ) ; if ( setsockopt ( fd , SOL_SOCKET , SO_ATTACH_FILTER , & prog , sizeof ( prog ) ) ) { error ( 1 , errno , "setsockopt filter" ) ; } } 