bool hashbusterusb_spi_txrx ( struct spi_port * const port ) { struct lowl_usb_endpoint * const h = port -> userp ; const uint8_t * wrbuf = spi_gettxbuf ( port ) ; uint8_t * rdbuf = spi_getrxbuf ( port ) ; size_t bufsz = spi_getbufsz ( port ) ; hashbusterusb_spi_reset ( h , 0x10 ) ; hashbusterusb_spi_config ( h , port -> mode , 0 , port -> speed ) ; while ( bufsz >= HASHBUSTER_MAX_BYTES_PER_SPI_TRANSFER ) { if ( ! hashbusterusb_spi_transfer ( h , rdbuf , wrbuf , HASHBUSTER_MAX_BYTES_PER_SPI_TRANSFER ) ) { return false ; } rdbuf += HASHBUSTER_MAX_BYTES_PER_SPI_TRANSFER ; wrbuf += HASHBUSTER_MAX_BYTES_PER_SPI_TRANSFER ; bufsz -= HASHBUSTER_MAX_BYTES_PER_SPI_TRANSFER ; } if ( bufsz > 0 ) { if ( ! hashbusterusb_spi_transfer ( h , rdbuf , wrbuf , bufsz ) ) { return false ; } } return true ; } 