int loopcxt_next ( struct loopdev_cxt * lc ) { struct loopdev_iter * iter ; if ( ! lc ) { return - EINVAL ; } iter = & lc -> iter ; DBG ( ITER , ul_debugobj ( iter , "next" ) ) ; if ( iter -> flags & LOOPITER_FL_USED ) { int rc ; if ( loopcxt_sysfs_available ( lc ) ) { rc = loopcxt_next_from_sysfs ( lc ) ; } else { rc = loopcxt_next_from_proc ( lc ) ; } if ( rc == 0 ) { return 0 ; } done } if ( iter -> default_check ) { DBG ( ITER , ul_debugobj ( iter , "next: default check" ) ) ; for ( ++ iter -> ncur ; iter -> ncur < LOOPDEV_DEFAULT_NNODES ; iter -> ncur ++ ) { char name [ 16 ] ; snprintf ( name , sizeof ( name ) , "loop%d" , iter -> ncur ) ; if ( loopiter_set_device ( lc , name ) == 0 ) { return 0 ; } } iter -> default_check = 0 ; } if ( ! iter -> minors ) { DBG ( ITER , ul_debugobj ( iter , "next: scanning /dev" ) ) ; iter -> nminors = ( lc -> flags & LOOPDEV_FL_DEVSUBDIR ) ?loop_scandir ( _PATH_DEV_LOOP , & iter -> minors , 0 ) : loop_scandir ( _PATH_DEV , & iter -> minors , 1 ) ; iter -> ncur = - 1 ; } for ( ++ iter -> ncur ; iter -> ncur < iter -> nminors ; iter -> ncur ++ ) { char name [ 16 ] ; snprintf ( name , sizeof ( name ) , "loop%d" , iter -> minors [ iter -> ncur ] ) ; if ( loopiter_set_device ( lc , name ) == 0 ) { return 0 ; } } done loopcxt_deinit_iterator ( lc ) ; return 1 ; } 