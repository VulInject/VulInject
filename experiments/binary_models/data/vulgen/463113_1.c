static int flex_pin_cmd ( sc_card_t * card , struct sc_pin_cmd_data * data , int * tries_left ) { sc_apdu_t apdu ; int r ; int old_cla = - 1 ; data -> flags |= SC_PIN_CMD_NEED_PADDING ; flex_init_pin_info ( & data -> pin1 , 0 ) ; flex_init_pin_info ( & data -> pin2 , 1 ) ; if ( data -> cmd == SC_PIN_CMD_VERIFY ) { r = flex_build_verify_apdu ( card , & apdu , data ) ; if ( r < 0 ) { return r ; } data -> apdu = & apdu ; } if ( data -> cmd == SC_PIN_CMD_CHANGE || data -> cmd == SC_PIN_CMD_UNBLOCK ) { if ( data -> pin_type != SC_AC_CHV ) { return SC_ERROR_INVALID_ARGUMENTS ; } old_cla = card -> cla ; } r = iso_ops -> pin_cmd ( card , data , NULL ) ; if ( old_cla != - 1 ) { card -> cla = old_cla ; } data -> apdu = NULL ; return r ; } 