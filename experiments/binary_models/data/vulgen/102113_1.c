static int sis900_probe ( struct dev * dev , struct pci_device * pci ) { struct nic * nic = ( nic * ) dev ; int i ; int found = 0 ; int phy_addr ; u8 revision ; int ret ; nic -> irqno = 0 ; nic -> ioaddr = pci -> ioaddr & ~ 3 ; ioaddr = pci -> ioaddr & ~ 3 ; vendor = pci -> vendor ; dev_id = pci -> dev_id ; pcibios_write_config_dword ( pci -> bus , pci -> devfn , 0x40 , 0x00000000 ) ; adjust_pci_device ( pci ) ; ret = 0 ; pcibios_read_config_byte ( pci -> bus , pci -> devfn , PCI_REVISION , & revision ) ; pci_revision = revision ; if ( revision == SIS630E_900_REV ) { ret = sis630e_get_mac_addr ( pci , nic ) ; } if ( ( revision > 0x81 ) && ( revision <= 0x90 ) ) { ret = sis635_get_mac_addr ( pci , nic ) ; } if ( revision == SIS96x_900_REV ) { ret = sis96x_get_mac_addr ( pci , nic ) ; } else { ret = sis900_get_mac_addr ( pci , nic ) ; } if ( ret == 0 ) { printf ( "sis900_probe: Error MAC address not found\n" ) ; return 0 ; } if ( revision == SIS630ET_900_REV ) { outl ( ACCESSMODE | inl ( ioaddr + cr ) , ioaddr + cr ) ; } printf ( "\nsis900_probe: MAC addr %! at ioaddr %#hX\n" , nic -> node_addr , ioaddr ) ; printf ( "sis900_probe: Vendor:%#hX Device:%#hX\n" , vendor , dev_id ) ; found = 0 ; for ( phy_addr = 0 ; phy_addr < 32 ; phy_addr ++ ) { u16 mii_status ; u16 phy_id0 , phy_id1 ; mii_status = sis900_mdio_read ( phy_addr , MII_STATUS ) ; if ( mii_status == 0xffff || mii_status == 0x0000 ) { continue ; } phy_id0 = sis900_mdio_read ( phy_addr , MII_PHY_ID0 ) ; phy_id1 = sis900_mdio_read ( phy_addr , MII_PHY_ID1 ) ; for ( i = 0 ; mii_chip_table [ i ] . phy_id1 ; i ++ ) { if ( phy_id0 == mii_chip_table [ i ] . phy_id0 ) { printf ( "sis900_probe: %s transceiver found at address %d.\n" , mii_chip_table [ i ] . name , phy_addr ) ; mii . chip_info = & mii_chip_table [ i ] ; mii . phy_addr = phy_addr ; mii . status = sis900_mdio_read ( phy_addr , MII_STATUS ) ; mii . next = NULL ; found = 1 ; break ; } } } if ( found == 0 ) { printf ( "sis900_probe: No MII transceivers found!\n" ) ; return 0 ; } cur_phy = mii . phy_addr ; printf ( "sis900_probe: Using %s as default\n" , mii . chip_info -> name ) ; sis900_init ( nic ) ; dev -> disable = sis900_disable ; nic -> poll = sis900_poll ; nic -> transmit = sis900_transmit ; nic -> irq = sis900_irq ; return 1 ; } 