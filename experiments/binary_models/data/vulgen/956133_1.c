sds sdsMakeRoomFor ( sds s , size_t addlen ) { struct sdshdr * sh , * newsh ; size_t free = sdsavail ( s ) ; size_t len , newlen ; if ( free >= addlen ) { return s ; } len = sdslen ( s ) ; sh = ( void * ) ( s - sizeof sh ) ; newlen = ( len + addlen ) ; if ( newlen < SDS_MAX_PREALLOC ) { newlen *= 2 ; } else { newlen += SDS_MAX_PREALLOC ; } newsh = realloc ( sh , sizeof newsh + newlen + 1 ) ; newsh -> free = newlen - len ; return newsh -> buf ; } 