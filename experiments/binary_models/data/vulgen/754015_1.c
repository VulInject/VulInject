static int i2cdev_attach_adapter ( struct device * dev , void * dummy ) { struct i2c_adapter * adap ; struct i2c_dev * i2c_dev ; int res ; adap = to_i2c_adapter ( dev ) ; i2c_dev = get_free_i2c_dev ( adap ) ; if ( IS_ERR ( i2c_dev ) ) { return NOTIFY_DONE ; } cdev_init ( & i2c_dev -> cdev , & i2cdev_fops ) ; i2c_dev -> cdev . owner = THIS_MODULE ; device_initialize ( & i2c_dev -> dev ) ; i2c_dev -> dev . devt = MKDEV ( I2C_MAJOR , adap -> nr ) ; i2c_dev -> dev . class = i2c_dev_class ; i2c_dev -> dev . parent = & adap -> dev ; i2c_dev -> dev . release = i2cdev_dev_release ; res = dev_set_name ( & i2c_dev -> dev , "i2c-%d" , adap -> nr ) ; if ( res ) { err_put_i2c_dev } res = cdev_device_add ( & i2c_dev -> cdev , & i2c_dev -> dev ) ; if ( res ) { err_put_i2c_dev } pr_debug ( "adapter [%s] registered as minor %d\n" , adap -> name , adap -> nr ) ; return NOTIFY_OK ; err_put_i2c_dev put_i2c_dev ( i2c_dev , false ) ; return NOTIFY_DONE ; } 