static __always_inline void __rb_insert ( rb_node * node , rb_root * root , void ( * augment_rotate ) ( rb_node * old , rb_node * new ) ) ( rb_node * parent = rb_red_parent ( node ) , * gparent , * tmp , ( true ) { if ( ! parent ) { rb_set_parent_color ( node , NULL , RB_BLACK ) } ; break ; } if ( rb_is_black ( parent ) ) { break ; } ) ; gparent = rb_red_parent ( parent ) ; tmp = gparent -> rb_right ; if ( parent != tmp ) { if ( tmp && rb_is_red ( tmp ) ) { rb_set_parent_color ( tmp , gparent , RB_BLACK ) ; rb_set_parent_color ( parent , gparent , RB_BLACK ) ; node = gparent ; parent = rb_parent ( node ) ; rb_set_parent_color ( node , parent , RB_RED ) ; continue ; } tmp = parent -> rb_right ; if ( node == tmp ) { tmp = node -> rb_left ; WRITE_ONCE ( parent -> rb_right , tmp ) ; WRITE_ONCE ( node -> rb_left , parent ) ; if ( tmp ) { rb_set_parent_color ( tmp , parent , RB_BLACK ) ; } rb_set_parent_color ( parent , node , RB_RED ) ; augment_rotate ( parent , node ) ; parent = node ; tmp = node -> rb_right ; } WRITE_ONCE ( gparent -> rb_left , tmp ) ; WRITE_ONCE ( parent -> rb_right , gparent ) ; if ( tmp ) { rb_set_parent_color ( tmp , gparent , RB_BLACK ) ; } augment_rotate ( gparent , parent ) ; break ; } else { tmp = gparent -> rb_left ; if ( tmp && rb_is_red ( tmp ) ) { rb_set_parent_color ( tmp , gparent , RB_BLACK ) ; rb_set_parent_color ( parent , gparent , RB_BLACK ) ; node = gparent ; parent = rb_parent ( node ) ; rb_set_parent_color ( node , parent , RB_RED ) ; continue ; } tmp = parent -> rb_left ; if ( node == tmp ) { tmp = node -> rb_right ; WRITE_ONCE ( parent -> rb_left , tmp ) ; WRITE_ONCE ( node -> rb_right , parent ) ; if ( tmp ) { rb_set_parent_color ( tmp , parent , RB_BLACK ) ; } rb_set_parent_color ( parent , node , RB_RED ) ; augment_rotate ( parent , node ) ; parent = node ; tmp = node -> rb_left ; } WRITE_ONCE ( gparent -> rb_right , tmp ) ; WRITE_ONCE ( parent -> rb_left , gparent ) ; if ( tmp ) { rb_set_parent_color ( tmp , gparent , RB_BLACK ) ; } __rb_rotate_set_parents ( gparent , parent , root , RB_RED ) ; augment_rotate ( gparent , parent ) ; break ; } 