int test_add_free_space_entry ( struct btrfs_block_group_cache * cache , u64 offset , u64 bytes , bool bitmap ) { struct btrfs_free_space_ctl * ctl = cache -> free_space_ctl ; struct btrfs_free_space * info = NULL , * bitmap_info ; void * map = NULL ; u64 bytes_added ; int ret ; again if ( ! info ) { info = kmem_cache_zalloc ( btrfs_free_space_cachep , GFP_NOFS ) ; if ( ! info ) { return - ENOMEM ; } } if ( ! bitmap ) { spin_lock ( & ctl -> tree_lock ) ; info -> offset = offset ; info -> bytes = bytes ; ret = link_free_space ( ctl , info ) ; spin_unlock ( & ctl -> tree_lock ) ; if ( ret ) { kmem_cache_free ( btrfs_free_space_cachep , info ) ; } return ret ; } if ( ! map ) { map = kzalloc ( PAGE_SIZE , GFP_NOFS ) ; if ( ! map ) { kmem_cache_free ( btrfs_free_space_cachep , info ) ; return - ENOMEM ; } } spin_lock ( & ctl -> tree_lock ) ; bitmap_info = tree_search_offset ( ctl , offset_to_bitmap ( ctl , offset ) , 1 , 0 ) ; if ( ! bitmap_info ) { info -> bitmap = map ; map = NULL ; add_new_bitmap ( ctl , info , offset ) ; bitmap_info = info ; info = NULL ; } bytes_added = add_bytes_to_bitmap ( ctl , bitmap_info , offset , bytes ) ; bytes -= bytes_added ; offset += bytes_added ; spin_unlock ( & ctl -> tree_lock ) ; if ( bytes ) { again } if ( info ) { kmem_cache_free ( btrfs_free_space_cachep , info ) ; } if ( map ) { kfree ( map ) ; } return 0 ; } 