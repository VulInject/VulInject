static int xsdfec_probe ( struct platform_device * pdev ) { struct xsdfec_dev * xsdfec ; struct device * dev ; struct resource * res ; int err ; bool irq_enabled = true ; xsdfec = devm_kzalloc ( & pdev -> dev , sizeof ( * xsdfec ) , GFP_KERNEL ) ; if ( ! xsdfec ) { return - ENOMEM ; } xsdfec -> dev = & pdev -> dev ; err = xsdfec_clk_init ( pdev , & xsdfec -> clks ) ; if ( err ) { return err ; } dev = xsdfec -> dev ; res = platform_get_resource ( pdev , IORESOURCE_MEM , 0 ) ; xsdfec -> regs = devm_ioremap_resource ( dev , res ) ; if ( IS_ERR ( xsdfec -> regs ) ) { err = PTR_ERR ( xsdfec -> regs ) ; err_xsdfec_dev } xsdfec -> irq = platform_get_irq ( pdev , 0 ) ; if ( xsdfec -> irq < 0 ) { dev_dbg ( dev , "platform_get_irq failed" ) ; irq_enabled = false ; } err = xsdfec_parse_of ( xsdfec ) ; if ( err < 0 ) { err_xsdfec_dev } update_config_from_hw ( xsdfec ) ; platform_set_drvdata ( pdev , xsdfec ) ; if ( irq_enabled ) { init_waitqueue_head ( & xsdfec -> waitq ) ; err = devm_request_threaded_irq ( dev , xsdfec -> irq , NULL , xsdfec_irq_thread , IRQF_ONESHOT , "xilinx-sdfec16" , xsdfec ) ; if ( err < 0 ) { dev_err ( dev , "unable to request IRQ%d" , xsdfec -> irq ) ; err_xsdfec_dev } } err = ida_alloc ( & dev_nrs , GFP_KERNEL ) ; if ( err < 0 ) { err_xsdfec_dev } xsdfec -> dev_id = err ; snprintf ( xsdfec -> dev_name , DEV_NAME_LEN , "xsdfec%d" , xsdfec -> dev_id ) ; xsdfec -> miscdev . minor = MISC_DYNAMIC_MINOR ; xsdfec -> miscdev . name = xsdfec -> dev_name ; xsdfec -> miscdev . fops = & xsdfec_fops ; xsdfec -> miscdev . parent = dev ; err = misc_register ( & xsdfec -> miscdev ) ; if ( err ) { dev_err ( dev , "error:%d. Unable to register device" , err ) ; err_xsdfec_ida } return 0 ; err_xsdfec_ida ida_free ( & dev_nrs , xsdfec -> dev_id ) ; err_xsdfec_dev xsdfec_disable_all_clks ( & xsdfec -> clks ) ; return err ; } 