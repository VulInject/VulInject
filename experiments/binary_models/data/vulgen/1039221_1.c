static TmEcode LogHttpLogIPWrapper ( ThreadVars * tv , void * data , const Packet * p , Flow * f , HtpState * htp_state , htp_tx_t * tx , uint64_t tx_id , int ipproto ) { SCEnter ( ) ; LogHttpLogThread * aft = ( LogHttpLogThread * ) data ; LogHttpFileCtx * hlog = aft -> httplog_ctx ; char timebuf [ 64 ] ; CreateTimeString ( p -> ts , timebuf , sizeof ( timebuf ) ) ; char srcip [ 46 ] , dstip [ 46 ] ; Port sp , dp ; if ( ( PKT_IS_TOSERVER ( p ) ) ) { switch ( ipproto ) { case AF_INET : PrintInet ( AF_INET , ( const void * ) GET_IPV4_SRC_ADDR_PTR ( p ) , srcip , sizeof ( srcip ) ) ; PrintInet ( AF_INET , ( const void * ) GET_IPV4_DST_ADDR_PTR ( p ) , dstip , sizeof ( dstip ) ) ; break ; case AF_INET6 : PrintInet ( AF_INET6 , ( const void * ) GET_IPV6_SRC_ADDR ( p ) , srcip , sizeof ( srcip ) ) ; PrintInet ( AF_INET6 , ( const void * ) GET_IPV6_DST_ADDR ( p ) , dstip , sizeof ( dstip ) ) ; break ; default : end } dp = p -> dp ; } else { switch ( ipproto ) { case AF_INET : PrintInet ( AF_INET , ( const void * ) GET_IPV4_DST_ADDR_PTR ( p ) , srcip , sizeof ( srcip ) ) ; PrintInet ( AF_INET , ( const void * ) GET_IPV4_SRC_ADDR_PTR ( p ) , dstip , sizeof ( dstip ) ) ; break ; case AF_INET6 : PrintInet ( AF_INET6 , ( const void * ) GET_IPV6_DST_ADDR ( p ) , srcip , sizeof ( srcip ) ) ; PrintInet ( AF_INET6 , ( const void * ) GET_IPV6_SRC_ADDR ( p ) , dstip , sizeof ( dstip ) ) ; break ; default : end } sp = p -> dp ; dp = p -> sp ; } SCLogDebug ( "got a HTTP request and now logging !!" ) ; MemBufferReset ( aft -> buffer ) ; if ( hlog -> flags & LOG_HTTP_CUSTOM ) { LogHttpLogCustom ( aft , tx , p -> ts , srcip , sp , dstip , dp ) ; } else { MemBufferWriteString ( aft -> buffer , "%s " , timebuf ) ; if ( tx -> request_hostname != NULL ) { PrintRawUriBuf ( ( char * ) aft -> buffer -> buffer , & aft -> buffer -> offset , aft -> buffer -> size , ( uint8_t * ) bstr_ptr ( tx -> request_hostname ) , bstr_len ( tx -> request_hostname ) ) ; } else { MemBufferWriteString ( aft -> buffer , "<hostname unknown>" ) ; } LOG_CF_WRITE_STAR_SEPATATOR ( aft -> buffer ) ; if ( tx -> request_uri != NULL ) { PrintRawUriBuf ( ( char * ) aft -> buffer -> buffer , & aft -> buffer -> offset , aft -> buffer -> size , ( uint8_t * ) bstr_ptr ( tx -> request_uri ) , bstr_len ( tx -> request_uri ) ) ; } LOG_CF_WRITE_STAR_SEPATATOR ( aft -> buffer ) ; htp_header_t * h_user_agent = NULL ; if ( tx -> request_headers != NULL ) { h_user_agent = htp_table_get_c ( tx -> request_headers , "user-agent" ) ; } if ( h_user_agent != NULL ) { PrintRawUriBuf ( ( char * ) aft -> buffer -> buffer , & aft -> buffer -> offset , aft -> buffer -> size , ( uint8_t * ) bstr_ptr ( h_user_agent -> value ) , bstr_len ( h_user_agent -> value ) ) ; } else { MemBufferWriteString ( aft -> buffer , "<useragent unknown>" ) ; } if ( hlog -> flags & LOG_HTTP_EXTENDED ) { LogHttpLogExtended ( aft , tx ) ; } LOG_CF_WRITE_STAR_SEPATATOR ( aft -> buffer ) ; MemBufferWriteString ( aft -> buffer , "%s:%" PRIu16 " ->%s:%" PRIu16 "\n" , srcip , sp , dstip , dp ) ; } aft -> uri_cnt ++ ; hlog -> file_ctx -> Write ( ( const char * ) MEMBUFFER_BUFFER ( aft -> buffer ) , MEMBUFFER_OFFSET ( aft -> buffer ) , hlog -> file_ctx ) ; end SCReturnInt ( 0 ) ; } 