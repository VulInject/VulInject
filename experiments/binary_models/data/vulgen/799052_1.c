static int igb_alloc_tcb_lists ( igb_tx_ring_t * tx_ring ) { int i ; int ret ; tx_control_block_t * tcb ; dma_buffer_t * tx_buf ; igb_t * igb = tx_ring -> igb ; dev_info_t * devinfo = igb -> dip ; tx_ring -> work_list = kmem_zalloc ( sizeof ( tx_control_block_t * ) * tx_ring -> ring_size , KM_NOSLEEP ) ; if ( tx_ring -> work_list == NULL ) { igb_log ( igb , IGB_LOG_ERROR , "Cound not allocate memory for tx work list" ) ; return ( IGB_FAILURE ) ; } tx_ring -> free_list = kmem_zalloc ( sizeof ( tx_control_block_t * ) * tx_ring -> free_list_size , KM_NOSLEEP ) ; if ( tx_ring -> free_list == NULL ) { kmem_free ( tx_ring -> work_list , sizeof ( tx_control_block_t * ) * tx_ring -> ring_size ) ; tx_ring -> work_list = NULL ; igb_log ( igb , IGB_LOG_ERROR , "Cound not allocate memory for tx free list" ) ; return ( IGB_FAILURE ) ; } tx_ring -> tcb_area = kmem_zalloc ( sizeof ( tx_control_block_t ) * tx_ring -> free_list_size , KM_NOSLEEP ) ; if ( tx_ring -> tcb_area == NULL ) { kmem_free ( tx_ring -> work_list , sizeof ( tx_control_block_t * ) * tx_ring -> ring_size ) ; tx_ring -> work_list = NULL ; tx_ring -> free_list = NULL ; igb_log ( igb , IGB_LOG_ERROR , "Cound not allocate memory for tx control blocks" ) ; return ( IGB_FAILURE ) ; } tcb = tx_ring -> tcb_area ; for ( i = 0 ; i < tx_ring -> free_list_size ; i ++ , tcb ++ ) { ASSERT ( tcb != NULL ) ; tx_ring -> free_list [ i ] = tcb ; ret = ddi_dma_alloc_handle ( devinfo , & igb_tx_dma_attr , DDI_DMA_DONTWAIT , NULL , & tcb -> tx_dma_handle ) ; if ( ret != DDI_SUCCESS ) { tcb -> tx_dma_handle = NULL ; igb_log ( igb , IGB_LOG_ERROR , "Could not allocate tx dma handle: %x" , ret ) ; alloc_tcb_lists_fail } tx_buf = & tcb -> tx_buf ; ret = igb_alloc_dma_buffer ( igb , tx_buf , igb -> tx_buf_size ) ; if ( ret != IGB_SUCCESS ) { ASSERT ( tcb -> tx_dma_handle != NULL ) ; ddi_dma_free_handle ( & tcb -> tx_dma_handle ) ; tcb -> tx_dma_handle = NULL ; igb_log ( igb , IGB_LOG_ERROR , "Allocate tx dma buffer failed" ) ; alloc_tcb_lists_fail } tcb -> last_index = MAX_TX_RING_SIZE ; } return ( IGB_SUCCESS ) ; alloc_tcb_lists_fail igb_free_tcb_lists ( tx_ring ) ; return ( IGB_FAILURE ) ; } 