void oplmsu_conf_stream ( uinst_t * msu_uinst ) { ldi_ident_t msu_li = NULL ; ldi_handle_t msu_lh = NULL ; struct msu_path * mpath ; struct msu_dev * mdev ; ser_devl_t * ser_dl = NULL , * next_ser_dl ; int * plink_id ; int size ; int i ; int param ; int connected = 0 ; int devcnt = 0 ; int rval ; DBG_PRINT ( ( CE_NOTE , "oplmsu: conf-stream: stream configuration start!" ) ) ; devcnt = oplmsu_find_serial ( & ser_dl ) ; if ( ( devcnt == 0 ) || ( ser_dl == NULL ) ) { cmn_err ( CE_WARN , "oplmsu: conf-stream: " "Discovered serial device = %d" , devcnt ) ; return ; } rval = oplmsu_open_msu ( msu_uinst -> msu_dip , & msu_li , & msu_lh ) ; if ( rval != 0 ) { cmn_err ( CE_WARN , "oplmsu: conf-stream: " "msu open failed. errno = %d" , rval ) ; return ; } size = ( sizeof ( msu_path ) + ( sizeof ( msu_dev ) * devcnt ) ) ; mpath = ( msu_path * ) kmem_zalloc ( ( size_t ) size , KM_SLEEP ) ; plink_id = ( int * ) kmem_zalloc ( ( sizeof ( int ) * devcnt ) , KM_SLEEP ) ; mdev = ( msu_dev * ) ( mpath + 1 ) ; for ( i = 0 ; i < devcnt ; i ++ ) { rval = oplmsu_plink_serial ( ser_dl -> dip , msu_lh , & plink_id [ i ] ) ; if ( rval != 0 ) { cmn_err ( CE_WARN , "oplmsu: conf-stream: " "i_plink failed. errno = %d" , rval ) ; next_ser_dl = ser_dl -> next ; kmem_free ( ser_dl , sizeof ( ser_devl_t ) ) ; ser_dl = next_ser_dl ; continue ; } rval = oplmsu_set_lpathnum ( plink_id [ i ] , ddi_get_instance ( ser_dl -> dip ) ) ; if ( rval != 0 ) { cmn_err ( CE_WARN , "oplmsu: conf-stream: " "Link id %d is not found" , plink_id [ i ] ) ; ( void ) ldi_ioctl ( msu_lh , I_PUNLINK , ( intptr_t ) plink_id [ i ] , FKIOCTL , kcred , & param ) ; next_ser_dl = ser_dl -> next ; kmem_free ( ser_dl , sizeof ( ser_devl_t ) ) ; ser_dl = next_ser_dl ; continue ; } mdev -> dip = ser_dl -> dip ; next_ser_dl = ser_dl -> next ; kmem_free ( ser_dl , sizeof ( ser_devl_t ) ) ; ser_dl = next_ser_dl ; mdev ++ ; connected ++ ; } if ( connected == 0 ) { cmn_err ( CE_WARN , "oplmsu: conf-stream: " "Connected paths = %d" , connected ) ; ( void ) ldi_close ( msu_lh , ( FREAD | FWRITE ) , kcred ) ; ldi_ident_release ( msu_li ) ; kmem_free ( plink_id , ( sizeof ( int ) * devcnt ) ) ; kmem_free ( mpath , size ) ; return ; } mpath -> num = connected ; rval = oplmsu_config_new ( mpath ) ; if ( rval != 0 ) { cmn_err ( CE_WARN , "oplmsu: conf-stream: " "Failed to create all paths. errno = %d" , rval ) ; oplmsu_unlinks ( msu_lh , plink_id , devcnt ) ; ( void ) ldi_close ( msu_lh , ( FREAD | FWRITE ) , kcred ) ; ldi_ident_release ( msu_li ) ; kmem_free ( plink_id , ( sizeof ( int ) * devcnt ) ) ; kmem_free ( mpath , size ) ; return ; } rval = oplmsu_config_start ( MSU_PATH_ALL ) ; if ( rval != 0 ) { cmn_err ( CE_WARN , "oplmsu: conf-stream: " "Failed to start all paths. errno = %d" , rval ) ; rval = oplmsu_config_del ( mpath ) ; } ( void ) ldi_close ( msu_lh , ( FREAD | FWRITE ) , kcred ) ; ldi_ident_release ( msu_li ) ; kmem_free ( plink_id , ( sizeof ( int ) * devcnt ) ) ; kmem_free ( mpath , size ) ; DBG_PRINT ( ( CE_NOTE , "oplmsu: conf-stream: stream configuration end!" ) ) ; } 