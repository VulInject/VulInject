static int do_cleanup ( void ) { const char * basedir = prometheus_stats_dir ( ) ; DIR * dh ; struct dirent * dirent ; dh = opendir ( basedir ) ; if ( ! dh ) { if ( errno == ENOENT ) { return 0 ; } syslog ( LOG_ERR , "IOERROR: opendir(%s): %m" , basedir ) ; return EX_IOERR ; } while ( ( dirent = readdir ( dh ) ) ) { char path [ PATH_MAX ] ; int r ; if ( dirent -> d_name [ 0 ] == '.' ) { continue ; } r = snprintf ( path , sizeof ( path ) , "%s%s" , basedir , dirent -> d_name ) ; if ( r < 0 || ( size_t ) r >= sizeof ( path ) ) { syslog ( LOG_ERR , "IOERROR: path too long: %s%s" , basedir , dirent -> d_name ) ; continue ; } xunlink ( path ) ; } return 0 ; } promdir_foreach_mode { PROMDIR_FOREACH_PIDS , PROMDIR_FOREACH_DONEPROCS } 