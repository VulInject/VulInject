static __init void of_unittest_overlay_high_level ( void ) { struct device_node * last_sibling ; struct device_node * np ; struct device_node * of_symbols ; struct device_node * overlay_base_symbols ; struct device_node * * pprev ; struct property * prop ; int ret ; if ( ! overlay_base_root ) { unittest ( 0 , "overlay_base_root not initialized\n" ) ; return ; } of_resolve_phandles ( overlay_base_root ) ; pprev = & overlay_base_root -> child ; for ( np = overlay_base_root -> child ; np ; np = np -> sibling ) { if ( ! of_node_cmp ( np -> name , "__local_fixups__" ) ) { * pprev = np -> sibling ; break ; } pprev = & np -> sibling ; } of_symbols = of_get_child_by_name ( of_root , "__symbols__" ) ; if ( of_symbols ) { pprev = & overlay_base_root -> child ; for ( np = overlay_base_root -> child ; np ; np = np -> sibling ) { if ( ! of_node_cmp ( np -> name , "__symbols__" ) ) { overlay_base_symbols = np ; * pprev = np -> sibling ; break ; } pprev = & np -> sibling ; } } for ( np = overlay_base_root -> child ; np ; np = np -> sibling ) { if ( of_get_child_by_name ( of_root , np -> name ) ) { unittest ( 0 , "illegal node name in overlay_base %s" , np -> name ) ; return ; } } for ( np = overlay_base_root -> child ; np ; np = np -> sibling ) { np -> parent = of_root ; } for ( last_sibling = np = of_root -> child ; np ; np = np -> sibling ) { last_sibling = np ; } if ( last_sibling ) { last_sibling -> sibling = overlay_base_root -> child ; } else { of_root -> child = overlay_base_root -> child ; } for_each_of_allnodes_from ( , ) __of_attach_node_sysfs ( np ) ; if ( of_symbols ) { for_each_property_of_node ( , ) { ret = __of_add_property ( of_symbols , prop ) ; if ( ret ) { unittest ( 0 , "duplicate property '%s' in overlay_base node __symbols__" , prop -> name ) ; err_unlock } ret = __of_add_property_sysfs ( of_symbols , prop ) ; if ( ret ) { unittest ( 0 , "unable to add property '%s' in overlay_base node __symbols__ to sysfs" , prop -> name ) ; err_unlock } } } mutex_unlock ( & of_mutex ) ; unittest ( overlay_data_add ( 1 ) , "Adding overlay 'overlay' failed\n" ) ; unittest ( overlay_data_add ( 2 ) , "Adding overlay 'overlay_bad_phandle' failed\n" ) ; return ; err_unlock mutex_unlock ( & of_mutex ) ; } 