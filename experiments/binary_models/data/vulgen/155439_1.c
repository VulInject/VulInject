int dirserv_read_measured_bandwidths ( const char * from_file , smartlist_t * routerstatuses , smartlist_t * bw_file_headers , uint8_t * digest_out ) { FILE * fp = tor_fopen_cloexec ( from_file , "r" ) ; int applied_lines = 0 ; time_t file_time , now ; int ok ; int line_is_after_headers = 0 ; int rv = - 1 ; char * line = NULL ; size_t n = 0 ; crypto_digest_t * digest = crypto_digest256_new ( DIGEST_SHA256 ) ; if ( tor_getline ( & line , & n , fp ) <= 0 ) { log_warn ( LD_DIRSERV , "Empty bandwidth file" ) ; err } crypto_digest_add_bytes ( digest , ( const char * ) line , strlen ( line ) ) ; if ( ! strlen ( line ) || line [ strlen ( line ) - 1 ] != '\n' ) { log_warn ( LD_DIRSERV , "Long or truncated time in bandwidth file: %s" , escaped ( line ) ) ; continue_digest } line [ strlen ( line ) - 1 ] = '\0' ; file_time = ( time_t ) tor_parse_ulong ( line , 10 , 0 , ULONG_MAX , & ok , NULL ) ; if ( ! ok ) { log_warn ( LD_DIRSERV , "Non-integer time in bandwidth file: %s" , escaped ( line ) ) ; continue_digest } now = approx_time ( ) ; if ( ( now - file_time ) > MAX_MEASUREMENT_AGE ) { log_warn ( LD_DIRSERV , "Bandwidth measurement file stale. Age: %u" , ( unsigned ) ( time ( NULL ) - file_time ) ) ; continue_digest } if ( bw_file_headers ) { smartlist_add_asprintf ( bw_file_headers , "timestamp=%lu" , ( unsigned long ) file_time ) ; } if ( routerstatuses ) { smartlist_sort ( routerstatuses , compare_vote_routerstatus_entries ) ; } while ( ! feof ( fp ) ) { measured_bw_line_t parsed_line ; if ( tor_getline ( & line , & n , fp ) >= 0 ) { crypto_digest_add_bytes ( digest , ( const char * ) line , strlen ( line ) ) ; if ( measured_bw_line_parse ( & parsed_line , line , line_is_after_headers ) != - 1 ) { line_is_after_headers = 1 ; dirserv_cache_measured_bw ( & parsed_line , file_time ) ; if ( measured_bw_line_apply ( & parsed_line , routerstatuses ) > 0 ) { applied_lines ++ ; } } if ( strcmp ( line , BW_FILE_HEADERS_TERMINATOR ) == 0 ) { line_is_after_headers = 1 ; } if ( bw_file_headers && ( line_is_after_headers == 0 ) && string_is_key_value ( LOG_DEBUG , line ) && ! strchr ( line , ' ' ) && ( smartlist_len ( bw_file_headers ) < MAX_BW_FILE_HEADER_COUNT_IN_VOTE ) ) { line [ strlen ( line ) - 1 ] = '\0' ; smartlist_add_strdup ( bw_file_headers , line ) ; } } } dirserv_expire_measured_bw_cache ( now ) ; log_info ( LD_DIRSERV , "Bandwidth measurement file successfully read. " "Applied %d measurements." , applied_lines ) ; rv = 0 ; continue_digest while ( ! feof ( fp ) ) { if ( tor_getline ( & line , & n , fp ) >= 0 ) { crypto_digest_add_bytes ( digest , ( const char * ) line , strlen ( line ) ) ; } } err if ( line ) { raw_free ( line ) ; } if ( fp ) { fclose ( fp ) ; } if ( digest_out ) { crypto_digest_get_digest ( digest , ( char * ) digest_out , DIGEST256_LEN ) ; } crypto_digest_free ( digest ) ; return rv ; } 