static struct tegra_fb * tegra_fb_alloc ( struct drm_device * drm , const struct drm_mode_fb_cmd2 * mode_cmd , struct tegra_bo * * planes , unsigned int num_planes ) { struct tegra_fb * fb ; unsigned int i ; int err ; fb = kzalloc ( sizeof ( * fb ) , GFP_KERNEL ) ; if ( ! fb ) { return ERR_PTR ( - ENOMEM ) ; } fb -> planes = kzalloc ( num_planes * sizeof ( * planes ) , GFP_KERNEL ) ; if ( ! fb -> planes ) { return ERR_PTR ( - ENOMEM ) ; } fb -> num_planes = num_planes ; drm_helper_mode_fill_fb_struct ( drm , & fb -> base , mode_cmd ) ; for ( i = 0 ; i < fb -> num_planes ; i ++ ) { fb -> planes [ i ] = planes [ i ] ; } err = drm_framebuffer_init ( drm , & fb -> base , & tegra_fb_funcs ) ; if ( err < 0 ) { dev_err ( drm -> dev , "failed to initialize framebuffer: %d\n" , err ) ; kfree ( fb -> planes ) ; kfree ( fb ) ; return ERR_PTR ( err ) ; } return fb ; } 