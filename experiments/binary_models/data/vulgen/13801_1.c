TEST_IMPL ( ) { struct sockaddr_in addr ; static char buffer [ 64 * 1024 ] ; uv_buf_t buf ; int r ; ASSERT ( 0 == uv_ip4_addr ( "0.0.0.0" , TEST_PORT , & addr ) ) ; r = uv_udp_init ( uv_default_loop ( ) , & server ) ; ASSERT ( r == 0 ) ; r = uv_udp_bind ( & server , ( const sockaddr * ) & addr , 0 ) ; ASSERT ( r == 0 ) ; r = uv_udp_recv_start ( & server , alloc_cb , sv_recv_cb ) ; ASSERT ( r == 0 ) ; ASSERT ( 0 == uv_ip4_addr ( "127.0.0.1" , TEST_PORT , & addr ) ) ; r = uv_udp_init ( uv_default_loop ( ) , & client ) ; ASSERT ( r == 0 ) ; buf = uv_buf_init ( buffer , sizeof ( buffer ) ) ; r = uv_udp_try_send ( & client , & buf , 1 , ( const sockaddr * ) & addr ) ; ASSERT ( r == UV_EMSGSIZE ) ; r = uv_udp_try_send ( & client , & buf , 1 , ( const sockaddr * ) & addr ) ; ASSERT ( r == 4 ) ; uv_run ( uv_default_loop ( ) , UV_RUN_DEFAULT ) ; ASSERT ( close_cb_called == 2 ) ; ASSERT ( sv_recv_cb_called == 1 ) ; ASSERT ( client . send_queue_size == 0 ) ; ASSERT ( server . send_queue_size == 0 ) ; MAKE_VALGRIND_HAPPY ( ) ; return 0 ; } 