poly1305mac_setkey ( , , ) { struct poly1305mac_context_s * mac_ctx = h -> u . poly1305mac . ctx ; gcry_err_code_t err ; memset ( & mac_ctx -> ctx , 0 , sizeof ( mac_ctx -> ctx ) ) ; memset ( & mac_ctx -> tag , 0 , sizeof ( mac_ctx -> tag ) ) ; mac_ctx -> marks . key_set = 0 ; mac_ctx -> marks . nonce_set = 0 ; mac_ctx -> marks . tag = 0 ; if ( h -> spec -> algo != GCRY_MAC_POLY1305 ) { err = poly1305mac_prepare_key ( h , key , keylen ) ; if ( err ) { return err ; } mac_ctx -> marks . key_set = 1 ; mac_ctx -> marks . nonce_set = 0 ; } else { if ( keylen != POLY1305_KEYLEN ) { return GPG_ERR_INV_KEYLEN ; } memcpy ( mac_ctx -> key , key , keylen ) ; err = _gcry_poly1305_init ( & mac_ctx -> ctx , mac_ctx -> key , POLY1305_KEYLEN ) ; if ( err ) { memset ( & mac_ctx -> key , 0 , sizeof ( mac_ctx -> key ) ) ; return err ; } mac_ctx -> marks . key_set = 1 ; mac_ctx -> marks . nonce_set = 1 ; } return 0 ; } 