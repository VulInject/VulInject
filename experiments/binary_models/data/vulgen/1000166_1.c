static gboolean infd_directory_handle_add_node ( InfdDirectory * directory , InfXmlConnection * connection , const xmlNodePtr xml , GError * * error ) { InfdDirectoryPrivate * priv ; InfdDirectoryNode * parent ; InfBrowserIter parent_iter ; InfdDirectoryNode * node ; GError * local_error ; InfAclSheetSet * sheet_set ; InfAclMask perms ; InfdNotePlugin * plugin ; InfdRequest * request ; xmlChar * name ; xmlChar * type ; gchar * seq ; xmlNodePtr child ; gboolean perform_sync_in ; gboolean subscribe_sync_conn ; gboolean is_subdirectory ; gboolean node_added ; priv = INFD_DIRECTORY_PRIVATE ( directory ) ; parent = infd_directory_get_node_from_xml_typed ( directory , xml , "parent" , INFD_DIRECTORY_NODE_SUBDIRECTORY , error ) ; local_error = NULL ; sheet_set = infd_directory_sheet_set_from_xml ( directory , xml , & local_error ) ; if ( local_error != NULL ) { g_propagate_error ( error , local_error ) ; return FALSE ; } type = inf_xml_util_get_attribute_required ( xml , "type" , error ) ; if ( type == NULL ) { if ( sheet_set != NULL ) { inf_acl_sheet_set_free ( sheet_set ) ; } return FALSE ; } if ( strcmp ( ( const gchar * ) type , "InfSubdirectory" ) == 0 ) { is_subdirectory = TRUE ; } else { is_subdirectory = FALSE ; } perform_sync_in = subscribe_sync_conn = FALSE ; for ( child = xml -> children ; child != NULL ; child = child -> next ) { if ( strcmp ( ( const char * ) child -> name , "sync-in" ) == 0 ) { perform_sync_in = TRUE ; } if ( strcmp ( ( const char * ) child -> name , "subscribe" ) == 0 ) { subscribe_sync_conn = TRUE ; } } infd_directory_get_add_node_permissions ( directory , & perms , is_subdirectory , subscribe_sync_conn , perform_sync_in , sheet_set ) ; if ( ! infd_directory_check_auth ( directory , parent , connection , & perms , error ) ) { if ( sheet_set != NULL ) { inf_acl_sheet_set_free ( sheet_set ) ; } xmlFree ( type ) ; return FALSE ; } if ( is_subdirectory == TRUE ) { plugin = NULL ; xmlFree ( type ) ; } else { plugin = g_hash_table_lookup ( priv -> plugins , ( const gchar * ) type ) ; xmlFree ( type ) ; if ( plugin == NULL ) { if ( sheet_set != NULL ) { inf_acl_sheet_set_free ( sheet_set ) ; } g_set_error_literal ( error , inf_directory_error_quark ( ) , INF_DIRECTORY_ERROR_TYPE_UNKNOWN , inf_directory_strerror ( INF_DIRECTORY_ERROR_TYPE_UNKNOWN ) ) ; return FALSE ; } } if ( ! infd_directory_make_seq ( directory , connection , xml , & seq , error ) ) { if ( sheet_set != NULL ) { inf_acl_sheet_set_free ( sheet_set ) ; } return FALSE ; } name = inf_xml_util_get_attribute_required ( xml , "name" , error ) ; if ( name == NULL ) { if ( sheet_set != NULL ) { inf_acl_sheet_set_free ( sheet_set ) ; } g_free ( seq ) ; return FALSE ; } request = INFD_REQUEST ( g_object_new ( INFD_TYPE_REQUEST , "type" , "add-node" , "node-id" , parent -> id , "requestor" , connection , NULL ) ) ; parent_iter . node_id = parent -> id ; parent_iter . node = parent ; inf_browser_begin_request ( INF_BROWSER ( directory ) , & parent_iter , INF_REQUEST ( request ) ) ; if ( plugin == NULL ) { node = infd_directory_node_add_subdirectory ( directory , parent , request , ( const gchar * ) name , sheet_set , connection , seq , error ) ; if ( node == NULL ) { node_added = FALSE ; } else { node_added = TRUE ; } } else { if ( perform_sync_in == FALSE ) { node_added = infd_directory_node_add_note ( directory , parent , request , ( const gchar * ) name , sheet_set , plugin , NULL , connection , subscribe_sync_conn , seq , error ) ; } else { node_added = infd_directory_node_add_sync_in ( directory , parent , request , ( const char * ) name , sheet_set , plugin , connection , subscribe_sync_conn , seq , error ) ; } } g_object_unref ( request ) ; if ( sheet_set != NULL ) { inf_acl_sheet_set_free ( sheet_set ) ; } xmlFree ( name ) ; g_free ( seq ) ; return node_added ; } 