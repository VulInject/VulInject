extern asmlinkage void ret_from_fork ( void ) extern asmlinkage void ret_from_kernel_thread ( void ) int copy_thread ( unsigned long clone_flags , unsigned long usp , unsigned long arg , struct task_struct * p ) { struct pt_regs * childregs = task_pt_regs ( p ) ; struct switch_stack * swstack = ( ( switch_stack * ) childregs ) - 1 ; * childregs = * current_pt_regs ( ) ; childregs -> r10 = 0 ; if ( p -> mm && ( clone_flags & CLONE_SETTLS ) ) { task_thread_info ( p ) -> tls = childregs -> mof ; } swstack -> r9 = 0 ; swstack -> return_ip = ( unsigned long ) ret_from_fork ; p -> thread . usp = usp ?: rdusp ( ) ; p -> thread . ksp = ( unsigned long ) swstack ; return 0 ; } 