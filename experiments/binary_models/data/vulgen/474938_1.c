static int processMessageQueues ( bzrtpContext_t * aliceContext , uint32_t aliceSSRC , bzrtpContext_t * bobContext , uint32_t bobSSRC , int alice_channel_status , int bob_channel_status ) { int retval = 0 ; uint64_t initialTime = 0 ; uint64_t lastPacketSentTime = 0 ; initialTime = getSimulatedTime ( ) ; while ( ( bzrtp_getChannelStatus ( aliceContext , aliceSSRC ) != alice_channel_status || bzrtp_getChannelStatus ( bobContext , bobSSRC ) != bob_channel_status ) && ( getSimulatedTime ( ) - initialTime < timeOutLimit ) ) { int i ; for ( i = 0 ; i < aliceQueueIndex ; i ++ ) { retval = bzrtp_processMessage ( aliceContext , aliceQueue [ i ] . destSSRC , aliceQueue [ i ] . packetString , aliceQueue [ i ] . packetLength ) ; bzrtp_message ( "%ld Alice processed a %.8s and returns %x\n" , ( long ) msSTC , ( aliceQueue [ i ] . packetString ) + 16 , retval ) ; memset ( aliceQueue [ i ] . packetString , 0 , MAX_PACKET_LENGTH ) ; } aliceQueueIndex = 0 ; for ( i = 0 ; i < bobQueueIndex ; i ++ ) { retval = bzrtp_processMessage ( bobContext , bobQueue [ i ] . destSSRC , bobQueue [ i ] . packetString , bobQueue [ i ] . packetLength ) ; bzrtp_message ( "%ld Bob processed a %.8s and returns %x\n" , ( long ) msSTC , ( bobQueue [ i ] . packetString ) + 16 , retval ) ; memset ( bobQueue [ i ] . packetString , 0 , MAX_PACKET_LENGTH ) ; } bobQueueIndex = 0 ; for ( int i = 0 ; i < MAX_NUM_CHANNEL ; i ++ ) { if ( aliceContext -> channelContext [ i ] != NULL ) { retval = bzrtp_iterate ( aliceContext , aliceContext -> channelContext [ i ] -> selfSSRC , getSimulatedTime ( ) ) ; } } STC_sleep ( 10 ) ; if ( getSimulatedTime ( ) - lastPacketSentTime > 1250 ) { retval = bzrtp_resetRetransmissionTimer ( aliceContext , aliceSSRC ) ; retval += bzrtp_resetRetransmissionTimer ( bobContext , bobSSRC ) ; lastPacketSentTime = getSimulatedTime ( ) ; } } if ( getSimulatedTime ( ) - initialTime >= timeOutLimit ) { return 1 ; } return retval ; } 