int fastcopy ( char * from , char * to , struct stat * sbp ) { struct timespec ts [ 2 ] ; static u_int32_t blen ; static char * bp ; int nread , from_fd , to_fd ; int badchown = 0 , serrno = 0 ; if ( ! blen ) { blen = sbp -> st_blksize ; if ( ( bp = malloc ( blen ) ) == NULL ) { warn ( NULL ) ; return ( 1 ) ; } } if ( ( from_fd = open ( from , O_RDONLY ) ) == - 1 ) { warn ( "%s" , from ) ; return ( 1 ) ; } if ( ( to_fd = open ( to , O_CREAT | O_TRUNC | O_WRONLY , 0600 ) ) == - 1 ) { warn ( "%s" , to ) ; ( void ) close ( from_fd ) ; return ( 1 ) ; } if ( fchown ( to_fd , sbp -> st_uid , sbp -> st_gid ) ) { serrno = errno ; badchown = 1 ; } ( void ) fchmod ( to_fd , sbp -> st_mode & ~ ( S_ISUID | S_ISGID ) ) ; while ( ( nread = read ( from_fd , bp , blen ) ) > 0 ) { if ( write ( to_fd , bp , nread ) != nread ) { warn ( "%s" , to ) ; err } } if ( nread == - 1 ) { warn ( "%s" , from ) ; err if ( unlink ( to ) ) { warn ( "%s: remove" , to ) ; } ( void ) close ( from_fd ) ; ( void ) close ( to_fd ) ; return ( 1 ) ; } ( void ) close ( from_fd ) ; if ( badchown ) { if ( ( sbp -> st_mode & ( S_ISUID | S_ISGID ) ) ) { warnc ( serrno , "%s: set owner/group; not setting setuid/setgid" , to ) ; sbp -> st_mode &= ~ ( S_ISUID | S_ISGID ) ; } if ( ! fflg ) { warnc ( serrno , "%s: set owner/group" , to ) ; } } if ( fchmod ( to_fd , sbp -> st_mode ) ) { warn ( "%s: set mode" , to ) ; } errno = 0 ; if ( fchflags ( to_fd , sbp -> st_flags ) ) { if ( errno != EOPNOTSUPP || sbp -> st_flags != 0 ) { warn ( "%s: set flags" , to ) ; } } ts [ 0 ] = sbp -> st_atim ; ts [ 1 ] = sbp -> st_mtim ; if ( futimens ( to_fd , ts ) ) { warn ( "%s: set times" , to ) ; } if ( close ( to_fd ) ) { warn ( "%s" , to ) ; return ( 1 ) ; } if ( unlink ( from ) ) { warn ( "%s: remove" , from ) ; return ( 1 ) ; } if ( vflg ) { ( void ) fprintf ( stdout , "%s ->%s\n" , from , to ) ; } return ( 0 ) ; } 