static int mlx5e_rq_alloc_mpwqe_info ( struct mlx5e_rq * rq , struct mlx5e_channel * c ) { int wq_sz = mlx5_wq_ll_get_size ( & rq -> wq ) ; int mtt_sz = mlx5e_get_wqe_mtt_sz ( ) ; int mtt_alloc = mtt_sz + MLX5_UMR_ALIGN - 1 ; int i ; rq -> mpwqe . info = kzalloc_node ( wq_sz * sizeof ( * rq -> mpwqe . info ) , GFP_KERNEL , cpu_to_node ( c -> cpu ) ) ; if ( ! rq -> mpwqe . info ) { err_out } rq -> mpwqe . mtt_no_align = kzalloc_node ( mtt_alloc * wq_sz , GFP_KERNEL , cpu_to_node ( c -> cpu ) ) ; if ( unlikely ( ! rq -> mpwqe . mtt_no_align ) ) { err_free_wqe_info } for ( i = 0 ; i < wq_sz ; i ++ ) { struct mlx5e_mpw_info * wi = & rq -> mpwqe . info [ i ] ; wi -> umr . mtt = PTR_ALIGN ( rq -> mpwqe . mtt_no_align + i * mtt_alloc , MLX5_UMR_ALIGN ) ; wi -> umr . mtt_addr = dma_map_single ( c -> pdev , wi -> umr . mtt , mtt_sz , PCI_DMA_TODEVICE ) ; mlx5e_build_umr_wqe ( rq , & c -> icosq , & wi -> umr . wqe , i ) ; } return 0 ; err_unmap_mtts while ( -- i >= 0 ) { struct mlx5e_mpw_info * wi = & rq -> mpwqe . info [ i ] ; dma_unmap_single ( c -> pdev , wi -> umr . mtt_addr , mtt_sz , PCI_DMA_TODEVICE ) ; } kfree ( rq -> mpwqe . mtt_no_align ) ; err_free_wqe_info kfree ( rq -> mpwqe . info ) ; err_out return - ENOMEM ; } 