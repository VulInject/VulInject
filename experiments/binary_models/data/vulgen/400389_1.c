int mo_zline ( struct Client * cptr , struct Client * sptr , int parc , char * parv [ ] ) { struct Client * acptr = 0 ; struct Zline * azline = 0 ; unsigned int flags = 0 ; enum ZlineAction action = ZLINE_MODIFY ; time_t expire = 0 ; char * mask = parv [ 1 ] , * target = 0 , * reason = 0 , * end ; if ( parc < 2 ) { return zline_list ( sptr , 0 ) ; } if ( * mask == '!' ) { mask ++ ; if ( HasPriv ( sptr , PRIV_WIDE_ZLINE ) ) { flags |= ZLINE_OPERFORCE ; } } switch ( * mask ) { case '+' : action = ZLINE_ACTIVATE ; mask ++ ; break ; case '-' : action = ZLINE_DEACTIVATE ; mask ++ ; break ; case '>' : action = ZLINE_LOCAL_ACTIVATE ; mask ++ ; break ; case '<' : action = ZLINE_LOCAL_DEACTIVATE ; mask ++ ; break ; } switch ( action ) { case ZLINE_MODIFY : if ( parc == 2 ) { return zline_list ( sptr , mask ) ; } target = parv [ 2 ] ; if ( is_timestamp ( parv [ 3 ] ) ) { expire = strtol ( parv [ 3 ] , & end , 10 ) + TStime ( ) ; if ( * end != '\0' ) { return send_reply ( sptr , SND_EXPLICIT | ERR_BADEXPIRE , "%s :Bad expire time" , parv [ 3 ] ) ; } } else { expire = ParseInterval ( parv [ 3 ] ) + TStime ( ) ; } flags |= ZLINE_EXPIRE ; if ( parc > 4 ) { reason = parv [ parc - 1 ] ; flags |= ZLINE_REASON ; } if ( target [ 0 ] != '*' || target [ 1 ] != '\0' ) { if ( ! reason ) { return need_more_params ( sptr , "ZLINE" ) ; } action = ZLINE_ACTIVATE ; } break ; case ZLINE_LOCAL_ACTIVATE : case ZLINE_LOCAL_DEACTIVATE : if ( parc > 2 ) { target = parv [ 2 ] ; if ( target [ 0 ] == '*' && target [ 1 ] == '\0' ) { return send_reply ( sptr , ERR_NOSUCHSERVER , target ) ; } } break ; case ZLINE_ACTIVATE : case ZLINE_DEACTIVATE : if ( parc < 3 ) { return need_more_params ( sptr , "ZLINE" ) ; } if ( parc > 3 ) { reason = parv [ parc - 1 ] ; if ( is_timestamp ( parv [ parc - 2 ] ) ) { expire = strtol ( parv [ parc - 2 ] , & end , 10 ) + TStime ( ) ; if ( * end != '\0' ) { return send_reply ( sptr , SND_EXPLICIT | ERR_BADEXPIRE , "%s :Bad expire time" , parv [ parc - 2 ] ) ; } } else { expire = ParseInterval ( parv [ parc - 2 ] ) + TStime ( ) ; } flags |= ZLINE_EXPIRE | ZLINE_REASON ; if ( parc > 4 ) { target = parv [ 2 ] ; } } else { target = parv [ 2 ] ; if ( target [ 0 ] != '*' || target [ 1 ] != '\0' ) { return need_more_params ( sptr , "ZLINE" ) ; } } break ; } if ( mask [ 0 ] == '\0' ) { return need_more_params ( sptr , "ZLINE" ) ; } if ( ! target ) { acptr = & me ; } if ( ( target [ 0 ] != '*' || target [ 1 ] != '\0' ) && ! ( acptr = find_match_server ( target ) ) ) { return send_reply ( sptr , ERR_NOSUCHSERVER , target ) ; } sendcmdto_one ( & me , CMD_NOTICE , sptr , "%C :Use of Z-line is deprecated. " " Please use G-line instead." , sptr ) ; if ( action == ZLINE_LOCAL_ACTIVATE || action == ZLINE_LOCAL_DEACTIVATE || ! acptr ) { flags |= ZLINE_GLOBAL ; } else { flags |= ZLINE_LOCAL ; } if ( ( action == ZLINE_LOCAL_ACTIVATE || action == ZLINE_LOCAL_DEACTIVATE ) && ! IsMe ( acptr ) ) { if ( ! feature_bool ( FEAT_CONFIG_OPERCMDS ) ) { return send_reply ( sptr , ERR_DISABLED , "ZLINE" ) ; } if ( ! HasPriv ( sptr , PRIV_ZLINE ) ) { return send_reply ( sptr , ERR_NOPRIVILEGES ) ; } Debug ( ( DEBUG_DEBUG , "I am forwarding a local change to a global zline " "to a remote server; target %s, mask %s, operforce %s, action %c" , cli_name ( acptr ) , mask , flags & ZLINE_OPERFORCE ?"YES" : "NO" , action == ZLINE_LOCAL_ACTIVATE ?'>' : '<' ) ) ; sendcmdto_one ( sptr , CMD_ZLINE , acptr , "%C %s%c%s" , acptr , flags & ZLINE_OPERFORCE ?"!" : "" , action == ZLINE_LOCAL_ACTIVATE ?'>' : '<' , mask ) ; return 0 ; } if ( ( flags & ZLINE_GLOBAL ) || IsMe ( acptr ) ) { azline = zline_find ( mask , flags | ZLINE_ANY | ZLINE_EXACT ) ; } if ( flags & ZLINE_LOCAL ) { assert ( acptr ) ; if ( action == ZLINE_LOCAL_ACTIVATE || action == ZLINE_MODIFY ) { action = ZLINE_ACTIVATE ; } if ( action == ZLINE_LOCAL_DEACTIVATE ) { action = ZLINE_DEACTIVATE ; } if ( ! IsMe ( acptr ) ) { if ( ! feature_bool ( FEAT_CONFIG_OPERCMDS ) ) { return send_reply ( sptr , ERR_DISABLED , "ZLINE" ) ; } if ( ! HasPriv ( sptr , PRIV_ZLINE ) ) { return send_reply ( sptr , ERR_NOPRIVILEGES ) ; } Debug ( ( DEBUG_DEBUG , "I am forwarding a local Z-line to a remote " "server; target %s, mask %s, operforce %s, action %c, " "expire %Tu, reason %s" , target , mask , flags & ZLINE_OPERFORCE ?"YES" : "NO" , action == ZLINE_ACTIVATE ?'+' : '-' , expire , reason ) ) ; sendcmdto_one ( sptr , CMD_ZLINE , acptr , "%C %s%c%s %Tu %Tu :%s" , acptr , flags & ZLINE_OPERFORCE ?"!" : "" , action == ZLINE_ACTIVATE ?'+' : '-' , mask , expire - TStime ( ) , TStime ( ) , reason ) ; return 0 ; } if ( ! HasPriv ( sptr , PRIV_LOCAL_ZLINE ) ) { return send_reply ( sptr , ERR_NOPRIVILEGES ) ; } if ( action == ZLINE_ACTIVATE ) { if ( azline ) { return 0 ; } Debug ( ( DEBUG_DEBUG , "I am creating a local Z-line here; target %s, " "mask %s, operforce %s, action  %s, expire %Tu, reason: %s" , target , mask , flags & ZLINE_OPERFORCE ?"YES" : "NO" , action == ZLINE_ACTIVATE ?"+" : "-" , expire , reason ) ) ; return zline_add ( cptr , sptr , mask , reason , expire , 0 , 0 , flags | ZLINE_ACTIVE ) ; } else { if ( ! azline ) { return send_reply ( sptr , ERR_NOSUCHZLINE , mask ) ; } Debug ( ( DEBUG_DEBUG , "I am destroying a local Z-line here; target %s, " "mask %s, operforce %s, action %s" , target , mask , flags & ZLINE_OPERFORCE ?"YES" : "NO" , action == ZLINE_ACTIVATE ?"+" : "-" ) ) ; return zline_destroy ( cptr , sptr , azline ) ; } } if ( ! azline && ( action == ZLINE_MODIFY || action == ZLINE_LOCAL_ACTIVATE || action == ZLINE_LOCAL_DEACTIVATE || ! reason || ! expire ) ) { return send_reply ( sptr , ERR_NOSUCHZLINE , mask ) ; } if ( action == ZLINE_LOCAL_ACTIVATE || action == ZLINE_LOCAL_DEACTIVATE ) { if ( ! HasPriv ( sptr , PRIV_LOCAL_ZLINE ) ) { return send_reply ( sptr , ERR_NOPRIVILEGES ) ; } } else { if ( ! feature_bool ( FEAT_CONFIG_OPERCMDS ) ) { return send_reply ( sptr , ERR_DISABLED , "ZLINE" ) ; } if ( ! HasPriv ( sptr , PRIV_ZLINE ) ) { return send_reply ( sptr , ERR_NOPRIVILEGES ) ; } } Debug ( ( DEBUG_DEBUG , "I have a global Z-line I am acting upon now; " "target %s, mask %s, operforce %s, action %s, expire %Tu, " "reason: %s; zline %s!  (fields present: %s %s)" , target , mask , flags & ZLINE_OPERFORCE ?"YES" : "NO" , action == ZLINE_ACTIVATE ?"+" : ( action == ZLINE_DEACTIVATE ?"-" : ( action == ZLINE_LOCAL_ACTIVATE ?">" : ( action == ZLINE_LOCAL_DEACTIVATE ?"<" : "(MODIFY)" ) ) ) , expire , reason , azline ?"EXISTS" : "does not exist" , flags & ZLINE_EXPIRE ?"expire" : "" , flags & ZLINE_REASON ?"reason" : "" ) ) ; if ( azline ) { return zline_modify ( cptr , sptr , azline , action , reason , expire , TStime ( ) , 0 , flags ) ; } assert ( action != ZLINE_LOCAL_ACTIVATE ) ; assert ( action != ZLINE_LOCAL_DEACTIVATE ) ; assert ( action != ZLINE_MODIFY ) ; return zline_add ( cptr , sptr , mask , reason , expire , TStime ( ) , 0 , flags | ( ( action == ZLINE_ACTIVATE ) ?ZLINE_ACTIVE : 0 ) ) ; } 