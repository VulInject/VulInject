char * usbd_get_string ( struct usbd_device * dev , int si , char * buf , size_t buflen ) { int swap = dev -> quirks -> uq_flags & UQ_SWAP_UNICODE ; usb_string_descriptor_t us ; char * s ; int i , n ; u_int16_t c ; usbd_status err ; int size ; if ( dev -> quirks -> uq_flags & UQ_NO_STRINGS ) { return ( 0 ) ; } if ( dev -> langid == USBD_NOLANG ) { err = usbd_get_string_desc ( dev , USB_LANGUAGE_TABLE , 0 , & us , & size ) ; if ( err || size < 4 ) { dev -> langid = 0 ; } else { dev -> langid = UGETW ( us . bString [ 0 ] ) ; } } err = usbd_get_string_desc ( dev , si , dev -> langid , & us , & size ) ; if ( err ) { return ( 0 ) ; } s = buf ; n = size / 2 - 1 ; for ( i = 0 ; i < n && i < buflen ; i ++ ) { c = UGETW ( us . bString [ i ] ) ; if ( ( c & 0xff00 ) == 0 ) { * s ++ = c ; } if ( ( c & 0x00ff ) == 0 && swap ) { * s ++ = c >> 8 ; } else { * s ++ = '?' ; } } if ( buflen > 0 ) { * s ++ = 0 ; } return ( buf ) ; } 