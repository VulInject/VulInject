static netdev_tx_t ip6_tnl_start_xmit ( struct sk_buff * skb , struct net_device * dev ) { struct ip6_tnl * t = netdev_priv ( dev ) ; u8 ipproto ; int ret ; if ( ! pskb_inet_may_pull ( skb ) ) { tx_err } switch ( skb -> protocol ) { case htons ( ETH_P_IP ) : ipproto = IPPROTO_IPIP ; break ; case htons ( ETH_P_IPV6 ) : if ( ip6_tnl_addr_conflict ( t , ipv6_hdr ( skb ) ) ) { tx_err } ipproto = IPPROTO_IPV6 ; break ; case htons ( ETH_P_MPLS_UC ) : ipproto = IPPROTO_MPLS ; break ; default : tx_err } ret = ipxip6_tnl_xmit ( skb , dev , ipproto ) ; return NETDEV_TX_OK ; tx_err DEV_STATS_INC ( dev , tx_errors ) ; DEV_STATS_INC ( dev , tx_dropped ) ; kfree_skb ( skb ) ; return NETDEV_TX_OK ; } 