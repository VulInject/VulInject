static int rootnex_sgllen_window_boundary ( ddi_dma_impl_t * hp , rootnex_dma_t * dma , rootnex_window_t * * windowp , ddi_dma_cookie_t * cookie , ddi_dma_attr_t * attr , off_t cur_offset ) { off_t new_offset ; size_t trim_sz ; off_t coffset ; if ( ! dma -> dp_trim_required ) { ( * windowp ) ++ ; rootnex_init_win ( hp , dma , * windowp , cookie , cur_offset ) ; ( * windowp ) -> wd_cookie_cnt ++ ; ( * windowp ) -> wd_size = cookie -> dmac_size ; return ( DDI_SUCCESS ) ; } ASSERT ( attr -> dma_attr_granular != 0 ) ; if ( dma -> dp_granularity_power_2 ) { trim_sz = ( * windowp ) -> wd_size & ( attr -> dma_attr_granular - 1 ) ; } else { trim_sz = ( * windowp ) -> wd_size % attr -> dma_attr_granular ; } if ( trim_sz == 0 ) { ( * windowp ) ++ ; rootnex_init_win ( hp , dma , * windowp , cookie , cur_offset ) ; ( * windowp ) -> wd_cookie_cnt ++ ; ( * windowp ) -> wd_size = cookie -> dmac_size ; return ( DDI_SUCCESS ) ; } if ( attr -> dma_attr_sgllen == 1 ) { return ( DDI_DMA_NOMAPPING ) ; } cookie -- ; ( * windowp ) -> wd_trim . tr_trim_last = B_TRUE ; ( * windowp ) -> wd_trim . tr_last_cookie = cookie ; ( * windowp ) -> wd_trim . tr_last_paddr = cookie -> dmac_laddress ; ASSERT ( cookie -> dmac_size > trim_sz ) ; ( * windowp ) -> wd_trim . tr_last_size = cookie -> dmac_size - trim_sz ; ( * windowp ) -> wd_size -= trim_sz ; coffset = cookie -> dmac_size - trim_sz ; new_offset = ( * windowp ) -> wd_offset + ( * windowp ) -> wd_size ; cookie -> dmac_size = ( * windowp ) -> wd_trim . tr_last_size ; ( * windowp ) ++ ; rootnex_init_win ( hp , dma , * windowp , cookie , new_offset ) ; ( * windowp ) -> wd_cookie_cnt ++ ; ( * windowp ) -> wd_trim . tr_trim_first = B_TRUE ; ( * windowp ) -> wd_trim . tr_first_paddr = cookie -> dmac_laddress + coffset ; ( * windowp ) -> wd_trim . tr_first_size = trim_sz ; if ( cookie -> dmac_type & ROOTNEX_USES_COPYBUF ) { ( * windowp ) -> wd_dosync = B_TRUE ; } cookie ++ ; ( * windowp ) -> wd_cookie_cnt ++ ; ( * windowp ) -> wd_size = trim_sz + cookie -> dmac_size ; return ( DDI_SUCCESS ) ; } 