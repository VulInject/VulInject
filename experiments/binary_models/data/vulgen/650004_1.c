static int afpCheckReservedLock ( sqlite3_file * id , int * pResOut ) { int rc = SQLITE_OK ; int reserved = 0 ; unixFile * pFile = ( unixFile * ) id ; afpLockingContext * context ; SimulateIOError ( ) assert ( pFile ) ; context = ( afpLockingContext * ) pFile -> lockingContext ; if ( context -> reserved ) { * pResOut = 1 ; return SQLITE_OK ; } unixEnterMutex ( ) ; if ( ! reserved ) { int lrc = afpSetLock ( context -> dbPath , pFile , RESERVED_BYTE , 1 , 1 ) ; if ( SQLITE_OK == lrc ) { lrc = afpSetLock ( context -> dbPath , pFile , RESERVED_BYTE , 1 , 0 ) ; } else { reserved = 1 ; } if ( IS_LOCK_ERROR ( lrc ) ) { rc = lrc ; } } unixLeaveMutex ( ) ; OSTRACE ( ( "TEST WR-LOCK %d %d %d (afp)\n" , pFile -> h , rc , reserved ) ) ; * pResOut = reserved ; return rc ; } 