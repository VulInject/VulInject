static DEFINE_SPINLOCK ( eeh_eventlist_lock ) ; static struct semaphore eeh_eventlist_sem ; static LIST_HEAD ( eeh_eventlist ) ; static int eeh_event_handler ( void * dummy ) { unsigned long flags ; struct eeh_event * event ; struct eeh_pe * pe ; while ( ! kthread_should_stop ( ) ) { spin_lock_irqsave ( & eeh_eventlist_lock , flags ) ; event = NULL ; if ( ! list_empty ( & eeh_eventlist ) ) { event = list_entry ( eeh_eventlist . next , eeh_event , list ) ; list_del ( & event -> list ) ; } spin_unlock_irqrestore ( & eeh_eventlist_lock , flags ) ; if ( ! event ) { continue ; } pe = event -> pe ; if ( pe ) { eeh_pe_state_mark ( pe , EEH_PE_RECOVERING ) ; if ( pe -> type & EEH_PE_PHB ) { pr_info ( "EEH: Detected error on PHB#%x\n" , pe -> phb -> global_number ) ; } else { pr_info ( "EEH: Detected PCI bus error on " "PHB#%x-PE#%x\n" , pe -> phb -> global_number , pe -> addr ) ; } eeh_handle_event ( pe ) ; eeh_pe_state_clear ( pe , EEH_PE_RECOVERING ) ; } else { eeh_handle_event ( NULL ) ; } kfree ( event ) ; } return 0 ; } 