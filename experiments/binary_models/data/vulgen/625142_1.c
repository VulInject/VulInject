void logit ( int data_type , int display , const char * fmt , ... ) { va_list ap ; char * buffer = NULL ; va_start ( ap , fmt ) ; if ( vasprintf ( & buffer , fmt , ap ) > 0 ) { write_to_logs_and_console ( buffer , data_type , display ) ; free ( buffer ) ; } va_end ( ap ) ; } int write_to_all_logs ( char * buffer , unsigned long data_type ) { write_to_syslog ( buffer , data_type ) ; write_to_log ( buffer , data_type , NULL ) ; return OK ; } static void write_to_all_logs_with_timestamp ( char * buffer , unsigned long data_type , time_t * timestamp ) { write_to_syslog ( buffer , data_type ) ; write_to_log ( buffer , data_type , timestamp ) ; } static FILE * open_log_file ( void ) { int fh ; struct stat st ; if ( log_fp ) { return log_fp ; } if ( ( fh = open ( log_file , O_RDWR | O_APPEND | O_CREAT | O_NOFOLLOW , S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH ) ) == - 1 ) { if ( daemon_mode == FALSE ) { printf ( "Warning: Cannot open log file '%s' for writing\n" , log_file ) ; } return NULL ; } log_fp = fdopen ( fh , "a+" ) ; if ( log_fp == NULL ) { if ( daemon_mode == FALSE ) { printf ( "Warning: Cannot open log file '%s' for writing\n" , log_file ) ; } return NULL ; } if ( ( fstat ( fh , & st ) ) == - 1 ) { close ( fh ) ; if ( daemon_mode == FALSE ) { printf ( "Warning: Cannot fstat log file '%s'\n" , log_file ) ; } return NULL ; } if ( st . st_nlink != 1 || ( st . st_mode & S_IFMT ) != S_IFREG ) { log_fp = NULL ; close ( fh ) ; if ( daemon_mode == FALSE ) { printf ( "Warning: log file '%s' has an invalid mode\n" , log_file ) ; } return NULL ; } ( void ) fcntl ( fileno ( log_fp ) , F_SETFD , FD_CLOEXEC ) ; return log_fp ; } 