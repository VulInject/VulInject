int ed_virt_to_phys ( Edit_t * ep , genchar * virt , genchar * phys , int cur , int voff , int poff ) { register genchar * sp = virt ; register genchar * dp = phys ; register int c ; genchar * curp = sp + cur ; genchar * dpmax = phys + MAXLINE ; int d , r ; sp += voff ; dp += poff ; for ( r = poff ; c = * sp ; sp ++ ) { if ( curp == sp ) { r = dp - phys ; } if ( d == 1 && is_cntrl ( c ) ) { d = - 1 ; } if ( d > 1 ) { * dp ++ = c ; while ( -- d > 0 ) { * dp ++ = MARKER ; } if ( dp >= dpmax ) { break ; } continue ; } else { d = ( is_cntrl ( c ) ?- 1 : 1 ) ; } if ( d < 0 ) { if ( c == '\t' ) { c = dp - phys ; if ( sh_isoption ( SH_VI ) ) { c += ep -> e_plen ; } c = TABSIZE - c % TABSIZE ; while ( -- c > 0 ) { * dp ++ = ' ' ; } c = ' ' ; } else { * dp ++ = '^' ; c = printchar ( c ) ; } if ( curp == sp && sh_isoption ( SH_VI ) ) { r = dp - phys ; } } * dp ++ = c ; if ( dp >= dpmax ) { break ; } } * dp = 0 ; ep -> e_peol = dp - phys ; return ( r ) ; } 