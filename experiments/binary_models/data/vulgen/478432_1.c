int trace_sys_connect ( struct pt_regs * ctx ) { struct sockaddr_in6 * in6 ; u16 test_case , port , dst6 [ 8 ] ; int addrlen , ret , inline_ret , ret_key = 0 ; u32 port_key ; void * outer_map , * inner_map ; bool inline_hash = false ; in6 = ( sockaddr_in6 * ) PT_REGS_PARM2_CORE ( ctx ) ; addrlen = ( int ) PT_REGS_PARM3_CORE ( ctx ) ; ret = bpf_probe_read_user ( dst6 , sizeof ( dst6 ) , & in6 -> sin6_addr ) ; if ( ret ) { inline_ret = ret ; done } if ( dst6 [ 0 ] != 0xdead || dst6 [ 1 ] != 0xbeef ) { return 0 ; } test_case = dst6 [ 7 ] ; ret = bpf_probe_read_user ( & port , sizeof ( port ) , & in6 -> sin6_port ) ; if ( ret ) { inline_ret = ret ; done } port_key = port ; ret = - ENOENT ; if ( test_case == 0 ) { outer_map = & a_of_port_a ; } if ( test_case == 1 ) { outer_map = & h_of_port_a ; } if ( test_case == 2 ) { outer_map = & h_of_port_h ; } else { ret = __LINE__ ; inline_ret = ret ; done } inner_map = bpf_map_lookup_elem ( outer_map , & port_key ) ; if ( ! inner_map ) { ret = __LINE__ ; inline_ret = ret ; done } ret = do_reg_lookup ( inner_map , port_key ) ; if ( test_case == 0 || test_case == 1 ) { inline_ret = do_inline_array_lookup ( inner_map , port_key ) ; } else { inline_ret = do_inline_hash_lookup ( inner_map , port_key ) ; } done bpf_map_update_elem ( & reg_result_h , & ret_key , & ret , BPF_ANY ) ; bpf_map_update_elem ( & inline_result_h , & ret_key , & inline_ret , BPF_ANY ) ; return 0 ; } 