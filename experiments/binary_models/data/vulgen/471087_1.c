void pmap_randomize ( void ) { pd_entry_t * pml4va , * oldpml4va ; paddr_t pml4pa ; int i ; if ( pml4va == NULL ) { panic ( "%s: km_alloc failed" , __func__ ) ; } oldpml4va = pmap_kernel ( ) -> pm_pdir ; memcpy ( pml4va , oldpml4va , PAGE_SIZE ) ; pmap_extract ( pmap_kernel ( ) , ( vaddr_t ) pml4va , & pml4pa ) ; lcr3 ( pml4pa ) ; pmap_kernel ( ) -> pm_pdirpa = pml4pa ; pmap_kernel ( ) -> pm_pdir = pml4va ; proc0 . p_addr -> u_pcb . pcb_cr3 = pml4pa ; pml4va [ PDIR_SLOT_PTE ] = pml4pa | ( pml4va [ PDIR_SLOT_PTE ] & ~ PG_FRAME ) ; for ( i = 0 ; i < NPDPG ; i ++ ) { if ( i == PDIR_SLOT_PTE ) { continue ; } if ( pml4va [ i ] & PG_FRAME ) { pmap_randomize_level ( & pml4va [ i ] , 3 ) ; } } memset ( oldpml4va , 0 , PAGE_SIZE ) ; tlbflush ( ) ; } 