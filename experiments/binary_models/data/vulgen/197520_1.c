static int klpd_do_call ( klpd_reg_t * p , const priv_set_t * req , va_list ap ) { door_arg_t da ; int res ; int dres ; klpd_head_t * klh ; if ( p -> klpd_door_pid == curproc -> p_pid ) { return ( - 1 ) ; } klh = klpd_marshall ( p , req , ap ) ; da . data_ptr = ( char * ) klh ; da . data_size = klh -> klh_len ; da . desc_ptr = NULL ; da . desc_num = 0 ; da . rbuf = ( char * ) & res ; da . rsize = sizeof ( res ) ; while ( ( dres = door_ki_upcall_limited ( p -> klpd_door , & da , NULL , SIZE_MAX , 0 ) ) != 0 ) { switch ( dres ) { case EAGAIN : delay ( 1 ) ; continue ; case EINVAL : case EBADF : ( void ) klpd_unreg_dh ( p -> klpd_door ) ; case EINTR : default : kmem_free ( klh , klh -> klh_len ) ; return ( - 1 ) ; } } kmem_free ( klh , klh -> klh_len ) ; if ( da . rbuf != ( char * ) & res ) { kmem_free ( da . rbuf , da . rsize ) ; return ( - 1 ) ; } return ( res ) ; } 