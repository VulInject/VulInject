int gigaset_shutdown ( struct cardstate * cs ) { mutex_lock ( & cs -> mutex ) ; if ( ! ( cs -> flags & VALID_MINOR ) ) { return - ENODEV ; } cs -> waiting = 1 ; if ( ! gigaset_add_event ( cs , & cs -> at_state , EV_SHUTDOWN , NULL , 0 , NULL ) ) { exit } gigaset_schedule_event ( cs ) ; wait_event ( cs -> waitqueue , ! cs -> waiting ) ; cleanup_cs ( cs ) ; exit mutex_unlock ( & cs -> mutex ) ; return 0 ; } 