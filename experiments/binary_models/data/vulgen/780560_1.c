void ilg_delete_all ( conn_t * connp ) { ilg_t * ilg , * next_ilg , * held_ilg ; ilm_t * ilm ; ill_t * ill ; boolean_t need_refrele ; mutex_enter ( & connp -> conn_lock ) ; ASSERT ( connp -> conn_state_flags & CONN_CLOSING ) ; while ( connp -> conn_state_flags & CONN_UPDATE_ILL ) { cv_wait ( & connp -> conn_cv , & connp -> conn_lock ) ; } mutex_exit ( & connp -> conn_lock ) ; rw_enter ( & connp -> conn_ilg_lock , RW_WRITER ) ; ilg = connp -> conn_ilg ; held_ilg = NULL ; while ( ilg != NULL ) { if ( ilg -> ilg_condemned ) { ilg = ilg -> ilg_next ; continue ; } if ( ilg -> ilg_ilm == NULL ) { next_ilg = ilg -> ilg_next ; ilg_delete ( connp , ilg , NULL ) ; ilg = next_ilg ; continue ; } ill = ilg -> ilg_ilm -> ilm_ill ; need_refrele = B_FALSE ; if ( ! mutex_tryenter ( & ill -> ill_mcast_serializer ) ) { ill_refhold ( ill ) ; need_refrele = B_TRUE ; ilg_refhold ( ilg ) ; held_ilg = ilg ; rw_exit ( & connp -> conn_ilg_lock ) ; mutex_enter ( & ill -> ill_mcast_serializer ) ; rw_enter ( & connp -> conn_ilg_lock , RW_WRITER ) ; if ( ilg -> ilg_condemned ) { ilg = ilg -> ilg_next ; next } } ilm = ilg -> ilg_ilm ; ilg -> ilg_ilm = NULL ; next_ilg = ilg -> ilg_next ; ilg_delete ( connp , ilg , NULL ) ; ilg = next_ilg ; rw_exit ( & connp -> conn_ilg_lock ) ; if ( ilm != NULL ) { ( void ) ip_delmulti_serial ( ilm , B_FALSE , B_TRUE ) ; } next mutex_exit ( & ill -> ill_mcast_serializer ) ; ill_mcast_send_queued ( ill ) ; ill_dlpi_send_queued ( ill ) ; if ( need_refrele ) { ill_refrele ( ill ) ; } rw_enter ( & connp -> conn_ilg_lock , RW_WRITER ) ; } if ( held_ilg != NULL ) { ilg_refrele ( held_ilg ) ; } rw_exit ( & connp -> conn_ilg_lock ) ; } 