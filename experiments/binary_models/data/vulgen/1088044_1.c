static void zfsctl_snapshot_inactive ( vnode_t * vp , cred_t * cr , caller_context_t * ct ) { zfsctl_snapdir_t * sdp ; zfs_snapentry_t * sep , * next ; vnode_t * dvp ; VERIFY ( gfs_dir_lookup ( vp , ".." , & dvp , cr , 0 , NULL , NULL ) == 0 ) ; sdp = dvp -> v_data ; mutex_enter ( & sdp -> sd_lock ) ; mutex_enter ( & vp -> v_lock ) ; if ( vp -> v_count > 1 ) { VN_RELE_LOCKED ( vp ) ; mutex_exit ( & vp -> v_lock ) ; mutex_exit ( & sdp -> sd_lock ) ; VN_RELE ( dvp ) ; return ; } mutex_exit ( & vp -> v_lock ) ; sep = avl_first ( & sdp -> sd_snaps ) ; while ( sep != NULL ) { next = AVL_NEXT ( & sdp -> sd_snaps , sep ) ; if ( sep -> se_root == vp ) { avl_remove ( & sdp -> sd_snaps , sep ) ; kmem_free ( sep -> se_name , strlen ( sep -> se_name ) + 1 ) ; kmem_free ( sep , sizeof ( zfs_snapentry_t ) ) ; break ; } sep = next ; } ASSERT ( sep != NULL ) ; mutex_exit ( & sdp -> sd_lock ) ; VN_RELE ( dvp ) ; gfs_vop_inactive ( vp , cr , ct ) ; } 