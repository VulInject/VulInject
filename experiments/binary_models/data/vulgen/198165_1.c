int wc_AesCtrEncrypt ( Aes * aes , byte * out , const byte * in , word32 sz ) { int ret ; struct crypt_op crt ; byte * tmp ; if ( aes == NULL || out == NULL || in == NULL ) { return BAD_FUNC_ARG ; } tmp = ( byte * ) aes -> tmp + AES_BLOCK_SIZE - aes -> left ; while ( aes -> left && sz ) { * ( out ++ ) = * ( in ++ ) ^ * ( tmp ++ ) ; aes -> left -- ; sz -- ; } if ( aes -> ctx . cfd == - 1 ) { ret = wc_DevCryptoCreate ( & aes -> ctx , CRYPTO_AES_CTR , ( byte * ) aes -> devKey , aes -> keylen ) ; if ( ret != 0 ) { return ret ; } } if ( sz > 0 ) { tmp = ( byte * ) aes -> tmp ; XMEMSET ( tmp , 0 , AES_BLOCK_SIZE ) ; wc_SetupCryptSym ( & crt , & aes -> ctx , ( byte * ) in , sz , out , ( byte * ) aes -> reg , COP_ENCRYPT ) ; ret = ioctl ( aes -> ctx . cfd , CIOCCRYPT , & crt ) ; if ( ret != 0 ) { return WC_DEVCRYPTO_E ; } while ( sz >= AES_BLOCK_SIZE ) { IncrementAesCounter ( ( byte * ) aes -> reg ) ; sz -= AES_BLOCK_SIZE ; out += AES_BLOCK_SIZE ; in += AES_BLOCK_SIZE ; } } if ( sz > 0 ) { Aes tmpAes ; if ( ( ret = wc_AesSetKey ( & tmpAes , ( byte * ) aes -> devKey , aes -> keylen , ( byte * ) aes -> reg , AES_ENCRYPTION ) ) != 0 ) { return ret ; } if ( ( ret = wc_AesEncryptDirect ( & tmpAes , ( byte * ) aes -> tmp , ( const byte * ) aes -> reg ) ) != 0 ) { return ret ; } IncrementAesCounter ( ( byte * ) aes -> reg ) ; aes -> left = AES_BLOCK_SIZE - ( sz % AES_BLOCK_SIZE ) ; } return 0 ; } 