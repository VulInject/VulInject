static void mb_wchar_to_sjismac ( uint32_t * in , size_t len , mb_convert_buf * buf , bool end ) { unsigned char * out , * limit ; MB_CONVERT_BUF_LOAD ( buf , out , limit ) ; MB_CONVERT_BUF_ENSURE ( buf , out , limit , len ) ; uint32_t w ; if ( buf -> state ) { w = buf -> state & 0xFFFF ; if ( buf -> state & 0xFF000000L ) { resume_transcoding_hint } else { buf -> state = 0 ; process_codepoint } } while ( len -- ) { w = * in ++ ; process_codepoint unsigned int s ; if ( w >= ucs_a1_jis_table_min && w < ucs_a1_jis_table_max ) { if ( w == 0x5C ) { s = 0x80 ; } if ( w == 0xA9 ) { s = 0xFD ; } else { s = ucs_a1_jis_table [ w - ucs_a1_jis_table_min ] ; } } if ( w >= ucs_a2_jis_table_min && w < ucs_a2_jis_table_max ) { if ( w == 0x2122 ) { s = 0xFE ; } if ( w == 0x2014 ) { s = 0x213D ; } if ( w == 0x2116 ) { s = 0x2C1D ; } else { s = ucs_a2_jis_table [ w - ucs_a2_jis_table_min ] ; } } if ( w >= ucs_i_jis_table_min && w < ucs_i_jis_table_max ) { s = ucs_i_jis_table [ w - ucs_i_jis_table_min ] ; } if ( w >= ucs_r_jis_table_min && w < ucs_r_jis_table_max ) { s = ucs_r_jis_table [ w - ucs_r_jis_table_min ] ; } if ( w >= 0x2000 ) { for ( int i = 0 ; i < s_form_tbl_len ; i ++ ) { if ( w == s_form_tbl [ i ] ) { if ( ! len ) { if ( end ) { s = s_form_sjis_fallback_tbl [ i ] ; if ( s ) { MB_CONVERT_BUF_ENSURE ( buf , out , limit , 2 ) ; out = mb_convert_buf_add2 ( out , ( s >> 8 ) & 0xFF , s & 0xFF ) ; } else { MB_CONVERT_ERROR ( buf , out , limit , w , mb_wchar_to_sjismac ) ; } } else { buf -> state = w ; } MB_CONVERT_BUF_STORE ( buf , out , limit ) ; return ; } uint32_t w2 = * in ++ ; len -- ; if ( ! process_s_form ( w , w2 , & s ) ) { in -- ; len ++ ; for ( int i = 0 ; i < s_form_tbl_len ; i ++ ) { if ( w == s_form_tbl [ i ] ) { s = s_form_sjis_fallback_tbl [ i ] ; break ; } } } if ( s <= 0xFF ) { out = mb_convert_buf_add ( out , s ) ; } else { MB_CONVERT_BUF_ENSURE ( buf , out , limit , len + 2 ) ; out = mb_convert_buf_add2 ( out , ( s >> 8 ) & 0xFF , s & 0xFF ) ; } next_iteration } } if ( w == 0xF860 || w == 0xF861 || w == 0xF862 ) { if ( ! len ) { if ( end ) { MB_CONVERT_ERROR ( buf , out , limit , w , mb_wchar_to_sjismac ) ; } else { buf -> state = w ; } MB_CONVERT_BUF_STORE ( buf , out , limit ) ; return ; } uint32_t w2 = * in ++ ; len -- ; for ( int i = 0 ; i < code_tbl_m_len ; i ++ ) { if ( w == code_tbl_m [ i ] [ 1 ] && w2 == code_tbl_m [ i ] [ 2 ] ) { int index = 3 ; resume_transcoding_hint if ( buf -> state ) { i = buf -> state >> 24 ; index = ( buf -> state >> 16 ) & 0xFF ; buf -> state = 0 ; } int expected = transcoding_hint_cp_width [ w - 0xF860 ] ; while ( index <= expected ) { if ( ! len ) { if ( end ) { for ( int j = 1 ; j < index ; j ++ ) { MB_CONVERT_ERROR ( buf , out , limit , code_tbl_m [ i ] [ j ] , mb_wchar_to_sjismac ) ; } } else { buf -> state = ( i << 24 ) | ( index << 16 ) | ( w & 0xFFFF ) ; } MB_CONVERT_BUF_STORE ( buf , out , limit ) ; return ; } w2 = * in ++ ; len -- ; if ( w2 != code_tbl_m [ i ] [ index ] ) { for ( int j = 1 ; j < index ; j ++ ) { MB_CONVERT_ERROR ( buf , out , limit , code_tbl_m [ i ] [ j ] , mb_wchar_to_sjismac ) ; } MB_CONVERT_ERROR ( buf , out , limit , w2 , mb_wchar_to_sjismac ) ; MB_CONVERT_BUF_ENSURE ( buf , out , limit , len ) ; next_iteration } index ++ ; } s = code_tbl_m [ i ] [ 0 ] ; unsigned int c1 = ( s / 94 ) + 0x21 , c2 = ( s % 94 ) + 0x21 , s1 , s2 ; SJIS_ENCODE ( c1 , c2 , s1 , s2 ) ; MB_CONVERT_BUF_ENSURE ( buf , out , limit , len + 2 ) ; out = mb_convert_buf_add2 ( out , s1 , s2 ) ; next_iteration } } in -- ; len ++ ; MB_CONVERT_ERROR ( buf , out , limit , w , mb_wchar_to_sjismac ) ; MB_CONVERT_BUF_ENSURE ( buf , out , limit , len ) ; continue ; } } if ( ! s ) { if ( w == 0xA0 ) { s = 0xA0 ; } if ( w == 0xA5 ) { s = 0x5C ; } if ( w == 0xFF3C ) { s = 0x2140 ; } else { for ( int i = 0 ; i < wchar2sjis_mac_r_tbl_len ; i ++ ) { if ( w >= wchar2sjis_mac_r_tbl [ i ] [ 0 ] && w <= wchar2sjis_mac_r_tbl [ i ] [ 1 ] ) { s = w - wchar2sjis_mac_r_tbl [ i ] [ 0 ] + wchar2sjis_mac_r_tbl [ i ] [ 2 ] ; s = ( ( ( s / 94 ) + 0x21 ) << 8 ) | ( ( s % 94 ) + 0x21 ) ; found_kuten_code } } for ( int i = 0 ; i < wchar2sjis_mac_r_map_len ; i ++ ) { if ( w >= wchar2sjis_mac_r_map [ i ] [ 0 ] && w <= wchar2sjis_mac_r_map [ i ] [ 1 ] ) { s = wchar2sjis_mac_code_map [ i ] [ w - wchar2sjis_mac_r_map [ i ] [ 0 ] ] ; if ( s ) { s = ( ( ( s / 94 ) + 0x21 ) << 8 ) | ( ( s % 94 ) + 0x21 ) ; found_kuten_code } } } for ( int i = 0 ; i < wchar2sjis_mac_wchar_tbl_len ; i ++ ) { if ( w == wchar2sjis_mac_wchar_tbl [ i ] [ 0 ] ) { s = wchar2sjis_mac_wchar_tbl [ i ] [ 1 ] ; s = ( ( ( s / 94 ) + 0x21 ) << 8 ) | ( ( s % 94 ) + 0x21 ) ; found_kuten_code } } } } found_kuten_code if ( ( ! s && w ) || s >= 0x8080 ) { MB_CONVERT_ERROR ( buf , out , limit , w , mb_wchar_to_sjismac ) ; MB_CONVERT_BUF_ENSURE ( buf , out , limit , len ) ; } if ( s <= 0xFF ) { out = mb_convert_buf_add ( out , s ) ; } else { unsigned int c1 = ( s >> 8 ) & 0xFF , c2 = s & 0xFF , s1 , s2 ; SJIS_ENCODE ( c1 , c2 , s1 , s2 ) ; MB_CONVERT_BUF_ENSURE ( buf , out , limit , len + 2 ) ; out = mb_convert_buf_add2 ( out , s1 , s2 ) ; } next_iteration } MB_CONVERT_BUF_STORE ( buf , out , limit ) ; } 