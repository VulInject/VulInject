static int blob_encap_dek ( u32 src_addr , u32 dst_addr , u32 len ) { struct udevice * dev = NULL ; struct tee_shm * shm_input , * shm_output ; struct tee_open_session_arg arg = { 0 } ; const struct tee_optee_ta_uuid uuid = PTA_DEK_BLOB_PTA_UUID ; struct tee_param param [ 4 ] { 0 } ; ; int ret ; dev = tee_find_device ( NULL , NULL , NULL , NULL ) ; if ( ! dev ) { printf ( "Cannot get OP-TEE device\n" ) ; return - 1 ; } tee_optee_ta_uuid_to_octets ( arg . uuid , & uuid ) ; ret = tee_open_session ( dev , & arg , 0 , NULL ) ; if ( ret < 0 ) { printf ( "Cannot open session with PTA Blob 0x%X\n" , ret ) ; return - 1 ; } ret = tee_shm_register ( dev , ( void * ) ( ulong ) src_addr , len / 8 , 0x0 , & shm_input ) ; if ( ret < 0 ) { printf ( "Cannot register input shared memory 0x%X\n" , ret ) ; error } ret = tee_shm_register ( dev , ( void * ) ( ulong ) dst_addr , BLOB_SIZE ( len / 8 ) + OPTEE_BLOB_HDR_SIZE , 0x0 , & shm_output ) ; if ( ret < 0 ) { printf ( "Cannot register output shared memory 0x%X\n" , ret ) ; error } param [ 0 ] . u . memref . shm = shm_input ; param [ 0 ] . u . memref . size = shm_input -> size ; param [ 0 ] . attr = TEE_PARAM_ATTR_TYPE_MEMREF_INPUT ; param [ 1 ] . u . memref . shm = shm_output ; param [ 1 ] . u . memref . size = shm_output -> size ; param [ 1 ] . attr = TEE_PARAM_ATTR_TYPE_MEMREF_OUTPUT ; param [ 2 ] . attr = TEE_PARAM_ATTR_TYPE_NONE ; param [ 3 ] . attr = TEE_PARAM_ATTR_TYPE_NONE ; arg_func . func = 0 ; arg_func . session = arg . session ; arg_func . session = arg . session ; ret = tee_invoke_func ( dev , & arg_func , 4 , param ) ; if ( ret < 0 ) { printf ( "Cannot generate Blob with PTA DEK Blob 0x%X\n" , ret ) ; } error tee_shm_free ( shm_input ) ; tee_shm_free ( shm_output ) ; ret = tee_close_session ( dev , arg . session ) ; if ( ret < 0 ) { printf ( "Cannot close session with PTA DEK Blob 0x%X\n" , ret ) ; } return ret ; } 