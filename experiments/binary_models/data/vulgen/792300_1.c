int ubi_ensure_anchor_pebs ( struct ubi_device * ubi ) { struct ubi_work * wrk ; struct ubi_wl_entry * anchor ; if ( ubi -> fm_anchor ) { spin_unlock ( & ubi -> wl_lock ) ; return 0 ; } anchor = ubi_wl_get_fm_peb ( ubi , 1 ) ; if ( anchor ) { ubi -> fm_anchor = anchor ; spin_unlock ( & ubi -> wl_lock ) ; return 0 ; } ubi -> fm_do_produce_anchor = 1 ; if ( ubi -> wl_scheduled ) { spin_unlock ( & ubi -> wl_lock ) ; return 0 ; } ubi -> wl_scheduled = 1 ; spin_unlock ( & ubi -> wl_lock ) ; wrk = kmalloc ( sizeof ( ubi_work ) , GFP_NOFS ) ; if ( ! wrk ) { spin_lock ( & ubi -> wl_lock ) ; ubi -> wl_scheduled = 0 ; spin_unlock ( & ubi -> wl_lock ) ; return - ENOMEM ; } wrk -> func = & wear_leveling_worker ; __schedule_ubi_work ( ubi , wrk ) ; return 0 ; } 