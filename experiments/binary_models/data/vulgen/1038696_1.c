void __iomem * __ref ioremap ( phys_addr_t addr , unsigned long size ) { phys_addr_t p ; unsigned long v ; unsigned long offset , last_addr ; struct vm_struct * area = NULL ; last_addr = addr + size - 1 ; offset = addr & ~ PAGE_MASK ; p = addr & PAGE_MASK ; size = PAGE_ALIGN ( last_addr + 1 ) - p ; if ( likely ( mem_init_done ) ) { area = get_vm_area ( size , VM_IOREMAP ) ; if ( ! area ) { return NULL ; } v = ( unsigned long ) area -> addr ; } else { if ( ( fixmaps_used + ( size >> PAGE_SHIFT ) ) > FIX_N_IOREMAPS ) { return NULL ; } v = fix_to_virt ( FIX_IOREMAP_BEGIN + fixmaps_used ) ; fixmaps_used += ( size >> PAGE_SHIFT ) ; } if ( ioremap_page_range ( v , v + size , p , __pgprot ( pgprot_val ( PAGE_KERNEL ) | _PAGE_CI ) ) ) { if ( likely ( mem_init_done ) ) { vfree ( area -> addr ) ; } else { fixmaps_used -= ( size >> PAGE_SHIFT ) ; } return NULL ; } return ( void __iomem * ) ( offset + ( char * ) v ) ; } 