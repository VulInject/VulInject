static uint16_t get_prio_for_tc_flower ( struct tc_flower * flower ) { static struct hmap prios = HMAP_INITIALIZER ( & prios ) ; static struct ovs_mutex prios_lock = OVS_MUTEX_INITIALIZER ; size_t key_len = sizeof ( tc_flower_key ) ; size_t hash = hash_int ( ( OVS_FORCE uint32_t ) flower -> key . eth_type , 0 ) ; struct prio_map_data * data ; struct prio_map_data * new_data ; uint16_t prio ; if ( ! multi_mask_per_prio ) { hash = hash_bytes ( & flower -> mask , key_len , hash ) ; } ovs_mutex_lock ( & prios_lock ) ; HMAP_FOR_EACH_WITH_HASH ( , , , ) { if ( ( multi_mask_per_prio || ! memcmp ( & flower -> mask , & data -> mask , key_len ) ) && data -> protocol == flower -> key . eth_type ) { ovs_mutex_unlock ( & prios_lock ) ; return data -> prio ; } } prio = get_next_available_prio ( flower -> key . eth_type ) ; new_data = xzalloc ( sizeof new_data ) ; memcpy ( & new_data -> mask , & flower -> mask , key_len ) ; new_data -> prio = prio ; new_data -> protocol = flower -> key . eth_type ; hmap_insert ( & prios , & new_data -> node , hash ) ; ovs_mutex_unlock ( & prios_lock ) ; return prio ; } 