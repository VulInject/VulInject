static int pci_epf_test_copy ( struct pci_epf_test * epf_test ) { int ret ; void __iomem * src_addr ; void __iomem * dst_addr ; phys_addr_t src_phys_addr ; phys_addr_t dst_phys_addr ; struct pci_epf * epf = epf_test -> epf ; struct device * dev = & epf -> dev ; struct pci_epc * epc = epf -> epc ; struct pci_epf_test_reg * reg = epf_test -> reg [ 0 ] ; src_addr = pci_epc_mem_alloc_addr ( epc , & src_phys_addr , reg -> size ) ; if ( ! src_addr ) { dev_err ( dev , "failed to allocate source address\n" ) ; reg -> status = STATUS_SRC_ADDR_INVALID ; ret = - ENOMEM ; err } ret = pci_epc_map_addr ( epc , src_phys_addr , reg -> src_addr , reg -> size ) ; if ( ret ) { dev_err ( dev , "failed to map source address\n" ) ; reg -> status = STATUS_SRC_ADDR_INVALID ; err_src_addr } dst_addr = pci_epc_mem_alloc_addr ( epc , & dst_phys_addr , reg -> size ) ; if ( ! dst_addr ) { dev_err ( dev , "failed to allocate destination address\n" ) ; reg -> status = STATUS_DST_ADDR_INVALID ; ret = - ENOMEM ; err_src_map_addr } ret = pci_epc_map_addr ( epc , dst_phys_addr , reg -> dst_addr , reg -> size ) ; if ( ret ) { dev_err ( dev , "failed to map destination address\n" ) ; reg -> status = STATUS_DST_ADDR_INVALID ; err_dst_addr } memcpy ( dst_addr , src_addr , reg -> size ) ; err_dst_addr pci_epc_mem_free_addr ( epc , dst_phys_addr , dst_addr , reg -> size ) ; err_src_map_addr pci_epc_unmap_addr ( epc , src_phys_addr ) ; err_src_addr pci_epc_mem_free_addr ( epc , src_phys_addr , src_addr , reg -> size ) ; err return ret ; } 