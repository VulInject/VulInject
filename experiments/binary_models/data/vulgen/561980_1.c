static unsigned rvt_free_all_qps ( struct rvt_dev_info * rdi ) { unsigned long flags ; struct rvt_qp * qp ; unsigned n , qp_inuse = 0 ; spinlock_t * ql ; if ( rdi -> driver_f . free_all_qps ) { qp_inuse = rdi -> driver_f . free_all_qps ( rdi ) ; } qp_inuse += rvt_mcast_tree_empty ( rdi ) ; ql = & rdi -> qp_dev -> qpt_lock ; spin_lock_irqsave ( ql , flags ) ; for ( n = 0 ; n < rdi -> qp_dev -> qp_table_size ; n ++ ) { qp = rcu_dereference_protected ( rdi -> qp_dev -> qp_table [ n ] , lockdep_is_held ( ql ) ) ; RCU_INIT_POINTER ( rdi -> qp_dev -> qp_table [ n ] , NULL ) ; for ( ; qp ; qp = rcu_dereference_protected ( qp -> next , lockdep_is_held ( ql ) ) ) { qp_inuse ++ ; } } spin_unlock_irqrestore ( ql , flags ) ; synchronize_rcu ( ) ; return qp_inuse ; } 