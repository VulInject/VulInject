struct l2_packet_data * l2_packet_init ( const char * ifname , unsigned short protocol , void * rx_callback ( void * , unsigned char * , unsigned char * , size_t ) , void * rx_callback_ctx ) { int retval ; struct l2_packet_data * l2 ; l2 = calloc ( 1 , sizeof ( l2_packet_data ) ) ; ( void ) strlcpy ( l2 -> ifname , ifname , sizeof ( l2 -> ifname ) ) ; l2 -> rx_callback = rx_callback ; l2 -> rx_callback_ctx = rx_callback_ctx ; retval = dlpi_open ( l2 -> ifname , & l2 -> dh , DLPI_RAW ) ; if ( retval != DLPI_SUCCESS ) { wpa_printf ( MSG_ERROR , "unable to open DLPI link %s: %s" , l2 -> ifname , dlpi_strerror ( retval ) ) ; free ( l2 ) ; return ( NULL ) ; } if ( link_init ( l2 ) < 0 ) { dlpi_close ( l2 -> dh ) ; free ( l2 ) ; return ( NULL ) ; } ( void ) eloop_register_read_sock ( dlpi_fd ( l2 -> dh ) , l2_packet_receive , l2 , NULL ) ; return ( l2 ) ; } 