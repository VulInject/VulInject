void cupsdSaveAllSubscriptions ( void ) { int i ; cups_file_t * fp ; char filename [ 1024 ] ; cupsd_subscription_t * sub ; unsigned mask ; const char * name ; int hex ; snprintf ( filename , sizeof ( filename ) , "%s/subscriptions.conf" , ServerRoot ) ; if ( ( fp = cupsdCreateConfFile ( filename , ConfigFilePerm ) ) == NULL ) { return ; } cupsdLogMessage ( CUPSD_LOG_INFO , "Saving subscriptions.conf..." ) ; cupsFilePuts ( fp , "# Subscription configuration file for " CUPS_SVERSION "\n" ) ; cupsFilePrintf ( fp , "# Written by cupsd\n" ) ; cupsFilePrintf ( fp , "NextSubscriptionId %d\n" , NextSubscriptionId ) ; for ( sub = ( cupsd_subscription_t * ) cupsArrayFirst ( Subscriptions ) ; sub ; sub = ( cupsd_subscription_t * ) cupsArrayNext ( Subscriptions ) ) { cupsFilePrintf ( fp , "<Subscription %d>\n" , sub -> id ) ; if ( ( name = cupsdEventName ( ( cupsd_eventmask_t ) sub -> mask ) ) != NULL ) { cupsFilePrintf ( fp , "Events %s\n" , name ) ; } else { for ( mask = 1 ; mask < CUPSD_EVENT_ALL ; mask <<= 1 ) { if ( sub -> mask & mask ) { cupsFilePrintf ( fp , " %s" , cupsdEventName ( ( cupsd_eventmask_t ) mask ) ) ; } } cupsFilePuts ( fp , "\n" ) ; } if ( sub -> owner ) { cupsFilePrintf ( fp , "Owner %s\n" , sub -> owner ) ; } if ( sub -> recipient ) { cupsFilePrintf ( fp , "Recipient %s\n" , sub -> recipient ) ; } if ( sub -> job ) { cupsFilePrintf ( fp , "JobId %d\n" , sub -> job -> id ) ; } if ( sub -> dest ) { cupsFilePrintf ( fp , "PrinterName %s\n" , sub -> dest -> name ) ; } if ( sub -> user_data_len > 0 ) { cupsFilePuts ( fp , "UserData " ) ; for ( i = 0 , hex = 0 ; i < sub -> user_data_len ; i ++ ) { if ( sub -> user_data [ i ] < ' ' || sub -> user_data [ i ] > 0x7f || sub -> user_data [ i ] == '<' ) { if ( ! hex ) { cupsFilePrintf ( fp , "<%02X" , sub -> user_data [ i ] ) ; hex = 1 ; } else { cupsFilePrintf ( fp , "%02X" , sub -> user_data [ i ] ) ; } } else { if ( hex ) { cupsFilePrintf ( fp , ">%c" , sub -> user_data [ i ] ) ; hex = 0 ; } else { cupsFilePutChar ( fp , sub -> user_data [ i ] ) ; } } } if ( hex ) { cupsFilePuts ( fp , ">\n" ) ; } else { cupsFilePutChar ( fp , '\n' ) ; } } cupsFilePrintf ( fp , "LeaseDuration %d\n" , sub -> lease ) ; cupsFilePrintf ( fp , "Interval %d\n" , sub -> interval ) ; cupsFilePrintf ( fp , "ExpirationTime %ld\n" , ( long ) sub -> expire ) ; cupsFilePrintf ( fp , "NextEventId %d\n" , sub -> next_event_id ) ; cupsFilePuts ( fp , "</Subscription>\n" ) ; } cupsdCloseCreatedConfFile ( fp , filename ) ; } 