static l_int32 pixCorrelationBestShift ( PIX * pix1 , PIX * pix2 , NUMA * nasum1 , NUMA * namoment1 , l_int32 area2 , l_int32 ycent2 , l_int32 maxyshift , l_int32 * tab8 , l_int32 * pdelx , l_int32 * pdely , l_float32 * pscore , l_int32 debugflag ) { l_int32 w1 , w2 , h1 , h2 , i , j , nx , shifty , delx , dely ; l_int32 sum , moment , count ; l_int32 * tab , * area1 , * arraysum , * arraymoment ; l_float32 maxscore , score ; l_float32 * ycent1 ; FPIX * fpix ; PIX * pixt , * pixt1 , * pixt2 ; if ( pdelx ) { * pdelx = 0 ; } if ( pdely ) { * pdely = 0 ; } if ( pscore ) { * pscore = 0.0 ; } if ( ! pix1 || pixGetDepth ( pix1 ) != 1 ) { return ERROR_INT ( "pix1 not defined or not 1 bpp" , __func__ , 1 ) ; } if ( ! pix2 || pixGetDepth ( pix2 ) != 1 ) { return ERROR_INT ( "pix2 not defined or not 1 bpp" , __func__ , 1 ) ; } if ( ! nasum1 || ! namoment1 ) { return ERROR_INT ( "nasum1 and namoment1 not both defined" , __func__ , 1 ) ; } if ( area2 <= 0 || ycent2 <= 0 ) { return ERROR_INT ( "area2 and ycent2 must be>0" , __func__ , 1 ) ; } pixGetDimensions ( pix1 , & w1 , & h1 , NULL ) ; pixGetDimensions ( pix2 , & w2 , & h2 , NULL ) ; if ( w1 < w2 ) { if ( debugflag > 0 ) { L_INFO ( "skipping match with w1 = %d and w2 = %d\n" , __func__ , w1 , w2 ) ; } return 0 ; } nx = w1 - w2 + 1 ; if ( debugflag > 0 ) { fpix = fpixCreate ( nx , 2 * maxyshift + 1 ) ; } if ( ! tab8 ) { tab = makePixelSumTab8 ( ) ; } else { tab = tab8 ; } area1 = ( l_int32 * ) LEPT_CALLOC ( nx , sizeof ( l_int32 ) ) ; ycent1 = ( l_float32 * ) LEPT_CALLOC ( nx , sizeof ( l_int32 ) ) ; arraysum = numaGetIArray ( nasum1 ) ; arraymoment = numaGetIArray ( namoment1 ) ; for ( i = 0 , sum = 0 , moment = 0 ; i < w2 ; i ++ ) { sum += arraysum [ i ] ; moment += arraymoment [ i ] ; } for ( i = 0 ; i < nx - 1 ; i ++ ) { area1 [ i ] = sum ; ycent1 [ i ] = ( sum == 0 ) ?ycent2 : ( l_float32 ) moment / ( l_float32 ) sum ; sum += arraysum [ w2 + i ] - arraysum [ i ] ; moment += arraymoment [ w2 + i ] - arraymoment [ i ] ; } area1 [ nx - 1 ] = sum ; ycent1 [ nx - 1 ] = ( sum == 0 ) ?ycent2 : ( l_float32 ) moment / ( l_float32 ) sum ; pixt = pixCreate ( w2 , h1 , 1 ) ; maxscore = 0 ; delx = 0 ; dely = 0 ; for ( i = 0 ; i < nx ; i ++ ) { shifty = ( l_int32 ) ( ycent1 [ i ] - ycent2 + 0.5 ) ; for ( j = - maxyshift ; j <= maxyshift ; j ++ ) { pixClearAll ( pixt ) ; pixRasterop ( pixt , 0 , shifty + j , w2 , h2 , PIX_SRC , pix2 , 0 , 0 ) ; pixRasterop ( pixt , 0 , 0 , w2 , h1 , PIX_SRC & PIX_DST , pix1 , i , 0 ) ; pixCountPixels ( pixt , & count , tab ) ; score = ( l_float32 ) count * ( l_float32 ) count / ( ( l_float32 ) area1 [ i ] * ( l_float32 ) area2 ) ; if ( score > maxscore ) { maxscore = score ; delx = i ; dely = shifty + j ; } if ( debugflag > 0 ) { fpixSetPixel ( fpix , i , maxyshift + j , 1000.0 * score ) ; } } } if ( pdelx ) { * pdelx = delx ; } if ( pdely ) { * pdely = dely ; } if ( pscore ) { * pscore = maxscore ; } if ( ! tab8 ) { LEPT_FREE ( tab ) ; } LEPT_FREE ( area1 ) ; LEPT_FREE ( ycent1 ) ; LEPT_FREE ( arraysum ) ; LEPT_FREE ( arraymoment ) ; pixDestroy ( & pixt ) ; return 0 ; } 