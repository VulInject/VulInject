static void vips_rank_generate_uchar ( VipsRegion * or , VipsRankSequence * seq , VipsRank * rank , int y ) ( VipsImage * in = seq -> ir -> im , VipsRect * r = & or -> valid , const int bands = in -> Bands , const int last = bands * ( rank -> width - 1 ) , VipsPel * restrict p = VIPS_REGION_ADDR ( seq -> ir , r -> left , r -> top + y ) , VipsPel * restrict q = VIPS_REGION_ADDR ( or , r -> left , r -> top + y ) , VipsPel * restrict p1 , int lsk , int x , i , j , b , lsk = VIPS_REGION_LSKIP ( seq -> ir ) , ( b = 0 b < bands b ++ ) memset ( seq -> hist [ b ] , 0 , 256 * ( unsigned int ) ) , p1 = p , ( j = 0 j < rank -> height j ++ ) { for ( i = 0 , x = 0 ; x < rank -> width ; x ++ ) { for ( b = 0 ; b < bands ; b ++ , i ++ ) { seq -> hist [ b ] [ p1 [ i ] ] += 1 ; } } p1 += lsk } ) ( x = 0 , x < r -> width , x ++ ) ( ( b = 0 b < bands b ++ ) { unsigned int * restrict hist = seq -> hist [ b ] int sum int i sum = 0 for ( i = 0 ; i < 256 ; i ++ ) { sum += hist [ i ] } q [ b ] = i ; p1 = p + b } , ( j = 0 j < rank -> height j ++ ) { hist [ p1 [ 0 ] ] -= 1 hist [ p1 [ last ] ] += 1 p1 += lsk } ) p bands ; q += bands ; 