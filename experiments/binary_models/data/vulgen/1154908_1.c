int s2s_router_mio_callback ( mio_t m , mio_action_t a , mio_fd_t fd , void * data , void * arg ) { s2s_t s2s = ( s2s_t ) arg ; int nbytes ; switch ( a ) { case action_READ : log_debug ( ZONE , "read action on fd %d" , fd -> fd ) ; ioctl ( fd -> fd , FIONREAD , & nbytes ) ; if ( nbytes == 0 ) { sx_kill ( s2s -> router ) ; return 0 ; } return sx_can_read ( s2s -> router ) ; case action_WRITE : log_debug ( ZONE , "write action on fd %d" , fd -> fd ) ; return sx_can_write ( s2s -> router ) ; case action_CLOSE : log_debug ( ZONE , "close action on fd %d" , fd -> fd ) ; log_write ( s2s -> log , LOG_NOTICE , "connection to router closed" ) ; s2s -> online = 0 ; break ; case action_ACCEPT : break ; } return 0 ; } 