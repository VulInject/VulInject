void libxsmm_x86_instruction_open_stream_gemm ( libxsmm_generated_code * io_generated_code , const libxsmm_gp_reg_mapping * i_gp_reg_mapping , const unsigned int skip_callee_save , unsigned int i_prefetch ) { if ( io_generated_code -> code_type > 1 ) { unsigned char * l_code_buffer = ( unsigned char * ) io_generated_code -> generated_code ; unsigned int l_code_size = io_generated_code -> code_size ; unsigned int l_max_size = io_generated_code -> buffer_size ; if ( NULL == l_code_buffer || l_max_size < ( l_code_size + 9 ) ) { return ; } if ( skip_callee_save == 0 ) { l_code_buffer [ l_code_size ++ ] = 0x53 ; l_code_buffer [ l_code_size ++ ] = 0x41 ; l_code_buffer [ l_code_size ++ ] = 0x54 ; l_code_buffer [ l_code_size ++ ] = 0x41 ; l_code_buffer [ l_code_size ++ ] = 0x55 ; l_code_buffer [ l_code_size ++ ] = 0x41 ; l_code_buffer [ l_code_size ++ ] = 0x56 ; l_code_buffer [ l_code_size ++ ] = 0x41 ; l_code_buffer [ l_code_size ++ ] = 0x57 ; io_generated_code -> code_size = l_code_size ; io_generated_code -> sf_size += 40 ; } } if ( io_generated_code -> code_type == 1 ) { char l_new_code [ 512 ] ; int l_max_code_length = 511 ; int l_code_length = 0 ; if ( skip_callee_save == 0 ) { l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       pushq %%rbx\n" ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       pushq %%r12\n" ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       pushq %%r13\n" ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       pushq %%r14\n" ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       pushq %%r15\n" ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; io_generated_code -> sf_size += 40 ; } l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       retq\n" ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; } else { char l_new_code [ 512 ] ; int l_max_code_length = 511 ; int l_code_length = 0 ; char l_gp_reg_name [ 4 ] ; libxsmm_get_x86_gp_reg_name ( i_gp_reg_mapping -> gp_reg_a , l_gp_reg_name , 3 ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "  __asm__ __volatile__(\"movq %%0, %%%%%s\\n\\t\"\n" , l_gp_reg_name ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; libxsmm_get_x86_gp_reg_name ( i_gp_reg_mapping -> gp_reg_b , l_gp_reg_name , 3 ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       \"movq %%1, %%%%%s\\n\\t\"\n" , l_gp_reg_name ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; libxsmm_get_x86_gp_reg_name ( i_gp_reg_mapping -> gp_reg_c , l_gp_reg_name , 3 ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       \"movq %%2, %%%%%s\\n\\t\"\n" , l_gp_reg_name ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; if ( i_prefetch == LIBXSMM_GEMM_PREFETCH_BL2_VIA_C || i_prefetch == LIBXSMM_GEMM_PREFETCH_AL2BL2_VIA_C_AHEAD ) { libxsmm_get_x86_gp_reg_name ( i_gp_reg_mapping -> gp_reg_b_prefetch , l_gp_reg_name , 3 ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       \"movq %%3, %%%%%s\\n\\t\"\n" , l_gp_reg_name ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; } if ( i_prefetch == LIBXSMM_GEMM_PREFETCH_AL2 ) { libxsmm_get_x86_gp_reg_name ( i_gp_reg_mapping -> gp_reg_a_prefetch , l_gp_reg_name , 3 ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       \"movq %%3, %%%%%s\\n\\t\"\n" , l_gp_reg_name ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; } if ( i_prefetch == LIBXSMM_GEMM_PREFETCH_AL2BL2_VIA_C ) { libxsmm_get_x86_gp_reg_name ( i_gp_reg_mapping -> gp_reg_a_prefetch , l_gp_reg_name , 3 ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       \"movq %%3, %%%%%s\\n\\t\"\n" , l_gp_reg_name ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; libxsmm_get_x86_gp_reg_name ( i_gp_reg_mapping -> gp_reg_b_prefetch , l_gp_reg_name , 3 ) ; l_code_length = LIBXSMM_SNPRINTF ( l_new_code , l_max_code_length , "                       \"movq %%4, %%%%%s\\n\\t\"\n" , l_gp_reg_name ) ; libxsmm_append_code_as_string ( io_generated_code , l_new_code , l_code_length ) ; } else { } } } 