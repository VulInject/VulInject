static void ntb_complete_rxc ( struct ntb_transport_qp * qp ) { struct ntb_queue_entry * entry ; void * cb_data ; unsigned int len ; unsigned long irqflags ; spin_lock_irqsave ( & qp -> ntb_rx_q_lock , irqflags ) ; while ( ! list_empty ( & qp -> rx_post_q ) ) { entry = list_first_entry ( & qp -> rx_post_q , ntb_queue_entry , entry ) ; entry -> rx_hdr -> flags = 0 ; iowrite32 ( entry -> rx_index , & qp -> rx_info -> entry ) ; cb_data = entry -> cb_data ; len = entry -> len ; list_move_tail ( & entry -> entry , & qp -> rx_free_q ) ; spin_unlock_irqrestore ( & qp -> ntb_rx_q_lock , irqflags ) ; if ( qp -> rx_handler && qp -> client_ready ) { qp -> rx_handler ( qp , qp -> cb_data , cb_data , len ) ; } spin_lock_irqsave ( & qp -> ntb_rx_q_lock , irqflags ) ; } spin_unlock_irqrestore ( & qp -> ntb_rx_q_lock , irqflags ) ; } 