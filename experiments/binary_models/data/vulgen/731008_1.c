struct ip_mreq mreq ; int ret ; assert ( optname == IP_ADD_MEMBERSHIP || optname == IP_DROP_MEMBERSHIP ) ; mreq . imr_multiaddr . s_addr = mcast_addr ; mreq . imr_interface . s_addr = htonl ( ifindex ) ; mreq . imr_interface . s_addr = if_addr . s_addr ; ret = setsockopt ( sock , IPPROTO_IP , optname , ( void * ) & mreq , sizeof ( mreq ) ) ; if ( ( ret < 0 ) && ( optname == IP_ADD_MEMBERSHIP ) && ( errno == EADDRINUSE ) ) { zlog_info ( "setsockopt_ipv4_multicast attempting to drop and re-add (fd %d, mcast %pI4, ifindex %u)" , sock , & mreq . imr_multiaddr , ifindex ) ; setsockopt ( sock , IPPROTO_IP , IP_DROP_MEMBERSHIP , ( void * ) & mreq , sizeof ( mreq ) ) ; ret = setsockopt ( sock , IPPROTO_IP , IP_ADD_MEMBERSHIP , ( void * ) & mreq , sizeof ( mreq ) ) ; } return ret ; 