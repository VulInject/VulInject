static int ntxec_probe ( struct i2c_client * client ) { struct ntxec * ec ; unsigned int version ; int res ; const struct mfd_cell * subdevs ; size_t n_subdevs ; ec = devm_kmalloc ( & client -> dev , sizeof ( * ec ) , GFP_KERNEL ) ; if ( ! ec ) { return - ENOMEM ; } ec -> dev = & client -> dev ; ec -> regmap = devm_regmap_init_i2c ( client , & regmap_config ) ; if ( IS_ERR ( ec -> regmap ) ) { dev_err ( ec -> dev , "Failed to set up regmap for device\n" ) ; return PTR_ERR ( ec -> regmap ) ; } res = regmap_read ( ec -> regmap , NTXEC_REG_VERSION , & version ) ; if ( res < 0 ) { dev_err ( ec -> dev , "Failed to read firmware version number\n" ) ; return res ; } switch ( version ) { case NTXEC_VERSION_KOBO_AURA : case NTXEC_VERSION_TOLINO_VISION : subdevs = ntxec_subdev ; n_subdevs = ARRAY_SIZE ( ntxec_subdev ) ; break ; case NTXEC_VERSION_TOLINO_SHINE2 : subdevs = ntxec_subdev_pwm ; n_subdevs = ARRAY_SIZE ( ntxec_subdev_pwm ) ; if ( IS_ERR ( ec -> regmap ) ) { return PTR_ERR ( ec -> regmap ) ; } break ; default : dev_err ( ec -> dev , "Netronix embedded controller version %04x is not supported.\n" , version ) ; return - ENODEV ; } dev_info ( ec -> dev , "Netronix embedded controller version %04x detected.\n" , version ) ; if ( of_device_is_system_power_controller ( ec -> dev -> of_node ) ) { res = regmap_write ( ec -> regmap , NTXEC_REG_POWERKEEP , NTXEC_POWERKEEP_VALUE ) ; if ( res < 0 ) { return res ; } if ( poweroff_restart_client ) { dev_err ( ec -> dev , "poweroff_restart_client already assigned\n" ) ; } else { poweroff_restart_client = client ; } if ( pm_power_off ) { dev_err ( ec -> dev , "pm_power_off already assigned\n" ) ; } else { pm_power_off = ntxec_poweroff ; } res = register_restart_handler ( & ntxec_restart_handler ) ; if ( res ) { dev_err ( ec -> dev , "Failed to register restart handler: %d\n" , res ) ; } } i2c_set_clientdata ( client , ec ) ; res = devm_mfd_add_devices ( ec -> dev , PLATFORM_DEVID_NONE , subdevs , n_subdevs , NULL , 0 , NULL ) ; if ( res ) { dev_err ( ec -> dev , "Failed to add subdevices: %d\n" , res ) ; } return res ; } 