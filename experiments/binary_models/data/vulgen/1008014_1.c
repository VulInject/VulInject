ibt_status_t ibt_flush_qp ( ibt_qp_hdl_t ibt_qp ) { ibt_qp_info_t modify_attr ; ibt_status_t retval ; IBTF_DPRINTF_L3 ( ibtf_qp , "ibt_flush_qp(%p)" , ibt_qp ) ; if ( ibt_qp -> ch_qp . qp_type == IBT_RC_SRV ) { mutex_enter ( & ibtl_free_qp_mutex ) ; if ( ( ibt_qp -> ch_transport . rc . rc_free_flags & ( IBTL_RC_QP_CONNECTED | IBTL_RC_QP_CLOSING ) ) == IBTL_RC_QP_CONNECTED ) { mutex_exit ( & ibtl_free_qp_mutex ) ; IBTF_DPRINTF_L2 ( ibtf_qp , "ibt_flush_qp(%p): " "called with a connected RC QP" , ibt_qp ) ; return ( IBT_CHAN_STATE_INVALID ) ; } mutex_exit ( & ibtl_free_qp_mutex ) ; } modify_attr . qp_state = IBT_STATE_ERROR ; modify_attr . qp_trans = ibt_qp -> ch_qp . qp_type ; retval = ibt_modify_qp ( ibt_qp , IBT_CEP_SET_STATE , & modify_attr , NULL ) ; if ( retval != IBT_SUCCESS ) { IBTF_DPRINTF_L2 ( ibtf_qp , "ibt_flush_qp: " "failed on chan %p: %d" , ibt_qp , retval ) ; } return ( retval ) ; } 