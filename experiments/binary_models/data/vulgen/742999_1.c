int dynsec_clients__process_modify ( cJSON * j_responses , struct mosquitto * context , cJSON * command , char * correlation_data ) { char * username ; char * clientid = NULL ; char * password = NULL ; char * text_name = NULL , * text_description = NULL ; bool have_clientid = false , have_text_name = false , have_text_description = false , have_rolelist = false , have_password = false ; struct dynsec__client * client ; struct dynsec__group * group ; struct dynsec__rolelist * rolelist = NULL ; char * str ; int rc ; int priority ; cJSON * j_group , * j_groups , * jtmp ; const char * admin_clientid , * admin_username ; if ( json_get_string ( command , "username" , & username , false ) != MOSQ_ERR_SUCCESS ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "Invalid/missing username" , correlation_data ) ; return MOSQ_ERR_INVAL ; } if ( mosquitto_validate_utf8 ( username , ( int ) strlen ( username ) ) != MOSQ_ERR_SUCCESS ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "Username not valid UTF-8" , correlation_data ) ; return MOSQ_ERR_INVAL ; } client = dynsec_clients__find ( username ) ; if ( client == NULL ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "Client not found" , correlation_data ) ; return MOSQ_ERR_INVAL ; } if ( json_get_string ( command , "clientid" , & str , false ) == MOSQ_ERR_SUCCESS ) { have_clientid = true ; if ( str && strlen ( str ) > 0 ) { clientid = mosquitto_strdup ( str ) ; if ( clientid == NULL ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "Internal error" , correlation_data ) ; rc = MOSQ_ERR_NOMEM ; error } } else { clientid = NULL ; } } if ( json_get_string ( command , "password" , & password , false ) == MOSQ_ERR_SUCCESS ) { if ( strlen ( password ) > 0 ) { have_password = true ; } } if ( json_get_string ( command , "textname" , & str , false ) == MOSQ_ERR_SUCCESS ) { have_text_name = true ; text_name = mosquitto_strdup ( str ) ; if ( text_name == NULL ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "Internal error" , correlation_data ) ; rc = MOSQ_ERR_NOMEM ; error } } if ( json_get_string ( command , "textdescription" , & str , false ) == MOSQ_ERR_SUCCESS ) { have_text_description = true ; text_description = mosquitto_strdup ( str ) ; if ( text_description == NULL ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "Internal error" , correlation_data ) ; rc = MOSQ_ERR_NOMEM ; error } } rc = dynsec_rolelist__load_from_json ( command , & rolelist ) ; if ( rc == MOSQ_ERR_SUCCESS ) { have_rolelist = true ; } if ( rc == ERR_LIST_NOT_FOUND ) { } if ( rc == MOSQ_ERR_NOT_FOUND ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "Role not found" , correlation_data ) ; rc = MOSQ_ERR_INVAL ; error } else { if ( rc == MOSQ_ERR_INVAL ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "'roles' not an array or missing/invalid rolename" , correlation_data ) ; } else { dynsec__command_reply ( j_responses , context , "modifyClient" , "Internal error" , correlation_data ) ; } rc = MOSQ_ERR_INVAL ; error } j_groups = cJSON_GetObjectItem ( command , "groups" ) ; if ( j_groups && cJSON_IsArray ( j_groups ) ) { cJSON_ArrayForEach ( , ) { if ( cJSON_IsObject ( j_group ) ) { jtmp = cJSON_GetObjectItem ( j_group , "groupname" ) ; if ( jtmp && cJSON_IsString ( jtmp ) ) { group = dynsec_groups__find ( jtmp -> valuestring ) ; if ( group == NULL ) { dynsec__command_reply ( j_responses , context , "modifyClient" , "'groups' contains an object with a 'groupname' that does not exist" , correlation_data ) ; rc = MOSQ_ERR_INVAL ; error } } else { dynsec__command_reply ( j_responses , context , "modifyClient" , "'groups' contains an object with an invalid 'groupname'" , correlation_data ) ; rc = MOSQ_ERR_INVAL ; error } } } dynsec__remove_client_from_all_groups ( username ) ; cJSON_ArrayForEach ( , ) { if ( cJSON_IsObject ( j_group ) ) { jtmp = cJSON_GetObjectItem ( j_group , "groupname" ) ; if ( jtmp && cJSON_IsString ( jtmp ) ) { json_get_int ( j_group , "priority" , & priority , true , - 1 ) ; dynsec_groups__add_client ( username , jtmp -> valuestring , priority , false ) ; } } } } if ( have_password ) { rc = client__set_password ( client , password ) ; } if ( have_clientid ) { mosquitto_free ( client -> clientid ) ; client -> clientid = clientid ; } if ( have_text_name ) { mosquitto_free ( client -> text_name ) ; client -> text_name = text_name ; } if ( have_text_description ) { mosquitto_free ( client -> text_description ) ; client -> text_description = text_description ; } if ( have_rolelist ) { client__remove_all_roles ( client ) ; client__add_new_roles ( client , rolelist ) ; dynsec_rolelist__cleanup ( & rolelist ) ; } dynsec__config_save ( ) ; dynsec__command_reply ( j_responses , context , "modifyClient" , NULL , correlation_data ) ; mosquitto_kick_client_by_username ( username , false ) ; admin_clientid = mosquitto_client_id ( context ) ; admin_username = mosquitto_client_username ( context ) ; mosquitto_log_printf ( MOSQ_LOG_INFO , "dynsec: %s/%s | modifyClient | username=%s" , admin_clientid , admin_username , username ) ; return MOSQ_ERR_SUCCESS ; error mosquitto_free ( clientid ) ; mosquitto_free ( text_name ) ; mosquitto_free ( text_description ) ; dynsec_rolelist__cleanup ( & rolelist ) ; return rc ; } 