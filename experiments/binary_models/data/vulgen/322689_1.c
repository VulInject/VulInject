static void waveform_ai_timer ( unsigned long arg ) { struct comedi_device * dev = ( comedi_device * ) arg ; struct waveform_private * devpriv = dev -> private ; struct comedi_subdevice * s = dev -> read_subdev ; struct comedi_async * async = s -> async ; struct comedi_cmd * cmd = & async -> cmd ; u64 now ; unsigned int nsamples ; unsigned int time_increment ; now = ktime_to_us ( ktime_get ( ) ) ; nsamples = comedi_nsamples_left ( s , UINT_MAX ) ; while ( nsamples && devpriv -> ai_convert_time < now ) { unsigned short sample ; sample = fake_waveform ( dev , CR_CHAN ( chanspec ) , CR_RANGE ( chanspec ) , devpriv -> wf_current ) ; if ( comedi_buf_write_samples ( s , & sample , 1 ) == 0 ) { overrun } time_increment = devpriv -> ai_convert_period ; if ( async -> scan_progress == 0 ) { time_increment += devpriv -> ai_scan_period - devpriv -> ai_convert_period * cmd -> scan_end_arg ; } devpriv -> wf_current += time_increment ; if ( devpriv -> wf_current >= devpriv -> wf_period ) { devpriv -> wf_current %= devpriv -> wf_period ; } devpriv -> ai_convert_time += time_increment ; nsamples -- ; } if ( cmd -> stop_src == TRIG_COUNT && async -> scans_done >= cmd -> stop_arg ) { async -> events |= COMEDI_CB_EOA ; } else { if ( devpriv -> ai_convert_time > now ) { time_increment = devpriv -> ai_convert_time - now ; } else { time_increment = 1 ; } mod_timer ( & devpriv -> ai_timer , jiffies + usecs_to_jiffies ( time_increment ) ) ; } overrun comedi_handle_events ( dev , s ) ; } 