static void srp_ib_cm_rej_handler ( struct ib_cm_id * cm_id , const struct ib_cm_event * event , struct srp_rdma_ch * ch ) { struct srp_target_port * target = ch -> target ; struct Scsi_Host * shost = target -> scsi_host ; struct ib_class_port_info * cpi ; int opcode ; u16 dlid ; switch ( event -> param . rej_rcvd . reason ) { case IB_CM_REJ_PORT_CM_REDIRECT : cpi = event -> param . rej_rcvd . ari ; dlid = be16_to_cpu ( cpi -> redirect_lid ) ; sa_path_set_dlid ( & ch -> ib_cm . path , dlid ) ; ch -> ib_cm . path . pkey = cpi -> redirect_pkey ; memcpy ( ch -> ib_cm . path . dgid . raw , cpi -> redirect_gid , 16 ) ; ch -> status = dlid ?SRP_DLID_REDIRECT : SRP_PORT_REDIRECT ; break ; case IB_CM_REJ_PORT_REDIRECT : if ( srp_target_is_topspin ( target ) ) { union ib_gid * dgid = & ch -> ib_cm . path . dgid ; memcpy ( dgid -> raw , event -> param . rej_rcvd . ari , 16 ) ; shost_printk ( KERN_DEBUG , shost , PFX "Topspin/Cisco redirect to target port GID %016llx%016llx\n" , be64_to_cpu ( dgid -> global . subnet_prefix ) , be64_to_cpu ( dgid -> global . interface_id ) ) ; ch -> status = SRP_PORT_REDIRECT ; } else { shost_printk ( KERN_WARNING , shost , "  REJ reason: IB_CM_REJ_PORT_REDIRECT\n" ) ; ch -> status = - ECONNRESET ; } break ; case IB_CM_REJ_DUPLICATE_LOCAL_COMM_ID : shost_printk ( KERN_WARNING , shost , "  REJ reason: IB_CM_REJ_DUPLICATE_LOCAL_COMM_ID\n" ) ; ch -> status = - ECONNRESET ; break ; case IB_CM_REJ_CONSUMER_DEFINED : opcode = * ( u8 * ) event -> private_data ; if ( opcode == SRP_LOGIN_REJ ) { struct srp_login_rej * rej = event -> private_data ; u32 reason = be32_to_cpu ( rej -> reason ) ; if ( reason == SRP_LOGIN_REJ_REQ_IT_IU_LENGTH_TOO_LARGE ) { shost_printk ( KERN_WARNING , shost , PFX "SRP_LOGIN_REJ: requested max_it_iu_len too large\n" ) ; } else { shost_printk ( KERN_WARNING , shost , PFX "SRP LOGIN from %pI6 to %pI6 REJECTED, reason 0x%08x\n" , target -> sgid . raw , target -> ib_cm . orig_dgid . raw , reason ) ; } } else { shost_printk ( KERN_WARNING , shost , "  REJ reason: IB_CM_REJ_CONSUMER_DEFINED," " opcode 0x%02x\n" , opcode ) ; } ch -> status = - ECONNRESET ; break ; case IB_CM_REJ_STALE_CONN : shost_printk ( KERN_WARNING , shost , "  REJ reason: stale connection\n" ) ; ch -> status = SRP_STALE_CONN ; break ; default : shost_printk ( KERN_WARNING , shost , "  REJ reason 0x%x\n" , event -> param . rej_rcvd . reason ) ; ch -> status = - ECONNRESET ; } } 