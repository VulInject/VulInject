void jabber_cache_add ( struct im_connection * ic , struct xt_node * node , jabber_cache_event func ) { struct jabber_data * jd = ic -> proto_data ; struct jabber_cache_entry * entry = g_new0 ( jabber_cache_entry , 1 ) ; GChecksum * id_hash ; gsize digest_len = MD5_HASH_SIZE ; guint8 id_sum [ MD5_HASH_SIZE ] ; char * id , * asc_hash ; next_id ++ ; id_hash = jd -> cached_id_prefix ; g_checksum_update ( id_hash , ( guint8 * ) & next_id , sizeof ( next_id ) ) ; g_checksum_get_digest ( id_hash , id_sum , & digest_len ) ; g_checksum_free ( id_hash ) ; asc_hash = base64_encode ( id_sum , 12 ) ; id = g_strdup_printf ( "%s%s" , JABBER_CACHED_ID , asc_hash ) ; xt_add_attr ( node , "id" , id ) ; g_free ( id ) ; g_free ( asc_hash ) ; entry -> node = node ; entry -> func = func ; entry -> saved_at = time ( NULL ) ; } 