int vmw_irq_install ( struct vmw_private * dev_priv ) { struct pci_dev * pdev = to_pci_dev ( dev_priv -> drm . dev ) ; struct drm_device * dev = & dev_priv -> drm ; int ret ; int nvec ; int i = 0 ; BUILD_BUG_ON ( ( SVGA_IRQFLAG_MAX >> VMWGFX_MAX_NUM_IRQS ) != 1 ) ; BUG_ON ( VMWGFX_MAX_NUM_IRQS != get_count_order ( SVGA_IRQFLAG_MAX ) ) ; nvec = pci_alloc_irq_vectors ( pdev , 1 , VMWGFX_MAX_NUM_IRQS , PCI_IRQ_ALL_TYPES ) ; if ( nvec <= 0 ) { drm_err ( & dev_priv -> drm , "IRQ's are unavailable, nvec: %d\n" , nvec ) ; ret = nvec ; done } vmw_irq_preinstall ( dev ) ; for ( i = 0 ; i < nvec ; ++ i ) { ret = pci_irq_vector ( pdev , i ) ; if ( ret < 0 ) { drm_err ( & dev_priv -> drm , "failed getting irq vector: %d\n" , ret ) ; done } dev_priv -> irqs [ i ] = ret ; ret = request_threaded_irq ( dev_priv -> irqs [ i ] , vmw_irq_handler , vmw_thread_fn , IRQF_SHARED , VMWGFX_DRIVER_NAME , dev ) ; if ( ret != 0 ) { drm_err ( & dev_priv -> drm , "Failed installing irq(%d): %d\n" , dev_priv -> irqs [ i ] , ret ) ; done } } done return ret ; } 