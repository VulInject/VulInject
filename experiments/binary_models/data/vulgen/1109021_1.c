static void usnic_ib_handle_usdev_event ( struct usnic_ib_dev * us_ibdev , unsigned long event ) { struct net_device * netdev ; struct ib_event ib_event ; mutex_lock ( & us_ibdev -> usdev_lock ) ; netdev = us_ibdev -> netdev ; switch ( event ) { case NETDEV_REBOOT : usnic_info ( "PF Reset on %s\n" , dev_name ( & us_ibdev -> ib_dev . dev ) ) ; usnic_ib_qp_grp_modify_active_to_err ( us_ibdev ) ; ib_event . event = IB_EVENT_PORT_ERR ; ib_event . device = & us_ibdev -> ib_dev ; ib_event . element . port_num = 1 ; ib_dispatch_event ( & ib_event ) ; break ; case NETDEV_UP : case NETDEV_DOWN : case NETDEV_CHANGE : if ( ! us_ibdev -> ufdev -> link_up && netif_carrier_ok ( netdev ) ) { usnic_fwd_carrier_up ( us_ibdev -> ufdev ) ; usnic_info ( "Link UP on %s\n" , dev_name ( & us_ibdev -> ib_dev . dev ) ) ; ib_event . event = IB_EVENT_PORT_ACTIVE ; ib_event . device = & us_ibdev -> ib_dev ; ib_event . element . port_num = 1 ; ib_dispatch_event ( & ib_event ) ; } if ( us_ibdev -> ufdev -> link_up && ! netif_carrier_ok ( netdev ) ) { usnic_fwd_carrier_down ( us_ibdev -> ufdev ) ; usnic_info ( "Link DOWN on %s\n" , dev_name ( & us_ibdev -> ib_dev . dev ) ) ; usnic_ib_qp_grp_modify_active_to_err ( us_ibdev ) ; ib_event . event = IB_EVENT_PORT_ERR ; ib_event . device = & us_ibdev -> ib_dev ; ib_event . element . port_num = 1 ; ib_dispatch_event ( & ib_event ) ; } else { usnic_dbg ( "Ignoring %s on %s\n" , netdev_cmd_to_name ( event ) , dev_name ( & us_ibdev -> ib_dev . dev ) ) ; } break ; case NETDEV_CHANGEADDR : if ( ! memcmp ( us_ibdev -> ufdev -> mac , netdev -> dev_addr , sizeof ( us_ibdev -> ufdev -> mac ) ) ) { usnic_dbg ( "Ignoring addr change on %s\n" , dev_name ( & us_ibdev -> ib_dev . dev ) ) ; } else { usnic_info ( " %s old mac: %pM new mac: %pM\n" , dev_name ( & us_ibdev -> ib_dev . dev ) , us_ibdev -> ufdev -> mac , netdev -> dev_addr ) ; usnic_fwd_set_mac ( us_ibdev -> ufdev , netdev -> dev_addr ) ; usnic_ib_qp_grp_modify_active_to_err ( us_ibdev ) ; ib_event . event = IB_EVENT_GID_CHANGE ; ib_event . device = & us_ibdev -> ib_dev ; ib_event . element . port_num = 1 ; ib_dispatch_event ( & ib_event ) ; } break ; case NETDEV_CHANGEMTU : if ( us_ibdev -> ufdev -> mtu != netdev -> mtu ) { usnic_info ( "MTU Change on %s old: %u new: %u\n" , dev_name ( & us_ibdev -> ib_dev . dev ) , us_ibdev -> ufdev -> mtu , netdev -> mtu ) ; usnic_fwd_set_mtu ( us_ibdev -> ufdev , netdev -> mtu ) ; usnic_ib_qp_grp_modify_active_to_err ( us_ibdev ) ; } else { usnic_dbg ( "Ignoring MTU change on %s\n" , dev_name ( & us_ibdev -> ib_dev . dev ) ) ; } break ; default : usnic_dbg ( "Ignoring event %s on %s" , netdev_cmd_to_name ( event ) , dev_name ( & us_ibdev -> ib_dev . dev ) ) ; } mutex_unlock ( & us_ibdev -> usdev_lock ) ; } 