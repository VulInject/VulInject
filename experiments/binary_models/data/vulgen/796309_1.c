main ( ) { static enum iconv_ilseq_handler handlers [ ] { iconveh_error iconveh_question_mark iconveh_escape_sequence } ; ; size_t h ; size_t o ; size_t i ; for ( h = 0 ; h < SIZEOF ( handlers ) ; h ++ ) { enum iconv_ilseq_handler handler = handlers [ h ] ; static const uint32_t input [ ] { 0xC4 'r' 'g' 'e' 'r' ' ' 'm' 'i' 't' ' ' 'b' 0xF6 's' 'e' 'n' ' ' 'B' 0xFC 'b' 'c' 'h' 'e' 'n' ' ' 'o' 'h' 'n' 'e' ' ' 'A' 'u' 'g' 'e' 'n' 'm' 'a' 0xDF } ; ; static const char expected [ ] "\304rger mit b\366sen B\374bchen ohne Augenma\337" ; ; for ( o = 0 ; o < 2 ; o ++ ) { size_t * offsets = ( o ?new_offsets ( SIZEOF ( input ) ) : NULL ) ; size_t length ; char * result = u32_conv_to_encoding ( "ISO-8859-1" , handler , input , SIZEOF ( input ) , offsets , NULL , & length ) ; ASSERT ( result != NULL ) ; ASSERT ( length == strlen ( expected ) ) ; ASSERT ( memcmp ( result , expected , length ) == 0 ) ; if ( o ) { for ( i = 0 ; i < 37 ; i ++ ) { ASSERT ( offsets [ i ] == i ) ; } ASSERT ( offsets [ 37 ] == MAGIC ) ; free ( offsets ) ; } free ( result ) ; } } for ( h = 0 ; h < SIZEOF ( handlers ) ; h ++ ) { enum iconv_ilseq_handler handler = handlers [ h ] ; static const uint32_t input [ ] { 'R' 'a' 'f' 'a' 0x0142 ' ' 'M' 'a' 's' 'z' 'k' 'o' 'w' 's' 'k' 'i' } ; ; for ( o = 0 ; o < 2 ; o ++ ) { size_t * offsets = ( o ?new_offsets ( SIZEOF ( input ) ) : NULL ) ; size_t length = 0xdead ; char * result = u32_conv_to_encoding ( "ISO-8859-1" , handler , input , SIZEOF ( input ) , offsets , NULL , & length ) ; switch ( handler ) { case iconveh_error : ASSERT ( result == NULL ) ; ASSERT ( errno == EILSEQ ) ; ASSERT ( length == 0xdead ) ; if ( o ) { free ( offsets ) ; } break ; case iconveh_question_mark : { static const char expected [ ] "Rafa? Maszkowski" ; ; static const char expected_translit [ ] "Rafal Maszkowski" ; ; ASSERT ( result != NULL ) ; ASSERT ( length == strlen ( expected ) ) ; ASSERT ( memcmp ( result , expected , length ) == 0 || memcmp ( result , expected_translit , length ) == 0 ) ; if ( o ) { for ( i = 0 ; i < 16 ; i ++ ) { ASSERT ( offsets [ i ] == i ) ; } ASSERT ( offsets [ 16 ] == MAGIC ) ; free ( offsets ) ; } free ( result ) ; } break ; case iconveh_escape_sequence : { static const char expected [ ] "Rafa\\u0142 Maszkowski" ; ; ASSERT ( result != NULL ) ; ASSERT ( length == strlen ( expected ) ) ; ASSERT ( memcmp ( result , expected , length ) == 0 ) ; free ( result ) ; } break ; } } } return 0 ; } 