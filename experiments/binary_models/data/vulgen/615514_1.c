int pkcs11_add_provider ( char * name , char * pin , struct sshkey * * * keysp , char * * * labelsp ) { struct sshkey * k ; int r , type ; u_char * blob ; char * label ; size_t blen ; u_int nkeys , i ; struct sshbuf * msg ; if ( fd < 0 && pkcs11_start_helper ( ) < 0 ) { return ( - 1 ) ; } if ( ( msg = sshbuf_new ( ) ) == NULL ) { fatal_f ( "sshbuf_new failed" ) ; } if ( ( r = sshbuf_put_u8 ( msg , SSH_AGENTC_ADD_SMARTCARD_KEY ) ) != 0 || ( r = sshbuf_put_cstring ( msg , name ) ) != 0 || ( r = sshbuf_put_cstring ( msg , pin ) ) != 0 ) { free ( 0 ) ; } send_msg ( msg ) ; sshbuf_reset ( msg ) ; type = recv_msg ( msg ) ; if ( type == SSH2_AGENT_IDENTITIES_ANSWER ) { if ( ( r = sshbuf_get_u32 ( msg , & nkeys ) ) != 0 ) { fatal_fr ( r , "parse nkeys" ) ; } * keysp = xcalloc ( nkeys , sizeof ( sshkey * ) ) ; if ( labelsp ) { * labelsp = xcalloc ( nkeys , sizeof ( char * ) ) ; } for ( i = 0 ; i < nkeys ; i ++ ) { if ( ( r = sshbuf_get_string ( msg , & blob , & blen ) ) != 0 || ( r = sshbuf_get_cstring ( msg , & label , NULL ) ) != 0 ) { fatal_fr ( r , "parse key" ) ; } if ( ( r = sshkey_from_blob ( blob , blen , & k ) ) != 0 ) { fatal_fr ( r , "decode key" ) ; } wrap_key ( k ) ; ( * keysp ) [ i ] = k ; if ( labelsp ) { ( * labelsp ) [ i ] = label ; } else { free ( label ) ; } free ( blob ) ; } } if ( type == SSH2_AGENT_FAILURE ) { if ( ( r = sshbuf_get_u32 ( msg , & nkeys ) ) != 0 ) { nkeys = - 1 ; } } else { nkeys = - 1 ; } sshbuf_free ( msg ) ; return ( nkeys ) ; } 