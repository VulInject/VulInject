static int __init smsg_init ( void ) { int rc ; if ( ! MACHINE_IS_VM ) { rc = - EPROTONOSUPPORT ; out } rc = driver_register ( & smsg_driver ) ; rc = iucv_register ( & smsg_handler , 1 ) ; if ( rc ) { out_driver } smsg_path = iucv_path_alloc ( 255 , 0 , GFP_KERNEL ) ; if ( ! smsg_path ) { rc = - ENOMEM ; out_register } rc = iucv_path_connect ( smsg_path , & smsg_handler , "*MSG    " , NULL , NULL , NULL ) ; if ( rc ) { out_free_path } else { iucv_path_connected = 1 ; } smsg_dev = kzalloc ( sizeof ( device ) , GFP_KERNEL ) ; if ( ! smsg_dev ) { rc = - ENOMEM ; out_free_path } dev_set_name ( smsg_dev , "smsg_iucv" ) ; smsg_dev -> bus = & iucv_bus ; smsg_dev -> parent = iucv_root ; smsg_dev -> release = ( void ( * ) ( device * ) ) kfree ; smsg_dev -> driver = & smsg_driver ; rc = device_register ( smsg_dev ) ; if ( rc ) { out_put } cpcmd ( "SET SMSG IUCV" , NULL , 0 , NULL ) ; return 0 ; out_put put_device ( smsg_dev ) ; out_free_path iucv_path_free ( smsg_path ) ; smsg_path = NULL ; out_register iucv_unregister ( & smsg_handler , 1 ) ; out_driver driver_unregister ( & smsg_driver ) ; out return rc ; } 