void test_verify_pkcs7_sig ( void ) { libbpf_print_fn_t old_print_cb ; char tmp_dir_template [ ] "/tmp/verify_sigXXXXXX" ; ; char * tmp_dir ; struct test_verify_pkcs7_sig * skel = NULL ; struct bpf_map * map ; struct data data ; int ret , zero = 0 ; syscall ( __NR_request_key , "keyring" , "_uid.0" , NULL , KEY_SPEC_SESSION_KEYRING ) ; tmp_dir = mkdtemp ( tmp_dir_template ) ; if ( ! ASSERT_OK_PTR ( tmp_dir , "mkdtemp" ) ) { return ; } ret = _run_setup_process ( tmp_dir , "setup" ) ; if ( ! ASSERT_OK ( ret , "_run_setup_process" ) ) { close_prog } skel = test_verify_pkcs7_sig__open ( ) ; if ( ! ASSERT_OK_PTR ( skel , "test_verify_pkcs7_sig__open" ) ) { close_prog } old_print_cb = libbpf_set_print ( libbpf_print_cb ) ; ret = test_verify_pkcs7_sig__load ( skel ) ; libbpf_set_print ( old_print_cb ) ; if ( ret < 0 && kfunc_not_supported ) { printf ( "%s:SKIP:bpf_verify_pkcs7_signature() kfunc not supported\n" , __func__ ) ; test__skip ( ) ; close_prog } if ( ! ASSERT_OK ( ret , "test_verify_pkcs7_sig__load" ) ) { close_prog } ret = test_verify_pkcs7_sig__attach ( skel ) ; if ( ! ASSERT_OK ( ret , "test_verify_pkcs7_sig__attach" ) ) { close_prog } map = bpf_object__find_map_by_name ( skel -> obj , "data_input" ) ; if ( ! ASSERT_OK_PTR ( map , "data_input not found" ) ) { close_prog } skel -> bss -> monitored_pid = getpid ( ) ; skel -> bss -> user_keyring_serial = KEY_SPEC_SESSION_KEYRING ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; if ( ! ASSERT_LT ( ret , 0 , "bpf_map_update_elem data_input" ) ) { close_prog } ret = populate_data_item_str ( tmp_dir , & data ) ; if ( ! ASSERT_OK ( ret , "populate_data_item_str" ) ) { close_prog } ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; if ( ! ASSERT_OK ( ret , "bpf_map_update_elem data_input" ) ) { close_prog } skel -> bss -> user_keyring_serial = syscall ( __NR_request_key , "keyring" , "ebpf_testing_keyring" , NULL , KEY_SPEC_SESSION_KEYRING ) ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; if ( ! ASSERT_OK ( ret , "bpf_map_update_elem data_input" ) ) { close_prog } syscall ( __NR_keyctl , KEYCTL_SETPERM , skel -> bss -> user_keyring_serial , 0x37373737 ) ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; if ( ! ASSERT_LT ( ret , 0 , "bpf_map_update_elem data_input" ) ) { close_prog } syscall ( __NR_keyctl , KEYCTL_SETPERM , skel -> bss -> user_keyring_serial , 0x3f3f3f3f ) ; syscall ( __NR_keyctl , KEYCTL_SET_TIMEOUT , skel -> bss -> user_keyring_serial , 1 ) ; sleep ( 1 ) ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; if ( ! ASSERT_LT ( ret , 0 , "bpf_map_update_elem data_input" ) ) { close_prog } skel -> bss -> user_keyring_serial = KEY_SPEC_SESSION_KEYRING ; data . data [ 0 ] = 'a' ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; if ( ! ASSERT_LT ( ret , 0 , "bpf_map_update_elem data_input" ) ) { close_prog } ret = populate_data_item_mod ( & data ) ; if ( ! ASSERT_OK ( ret , "populate_data_item_mod" ) ) { close_prog } if ( data . data_len ) { skel -> bss -> user_keyring_serial = 0 ; skel -> bss -> system_keyring_id = 0 ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; skel -> bss -> system_keyring_id = VERIFY_USE_SECONDARY_KEYRING ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; if ( ! ASSERT_OK ( ret , "bpf_map_update_elem data_input" ) ) { close_prog } skel -> bss -> system_keyring_id = VERIFY_USE_PLATFORM_KEYRING ; ret = bpf_map_update_elem ( bpf_map__fd ( map ) , & zero , & data , BPF_ANY ) ; ASSERT_LT ( ret , 0 , "bpf_map_update_elem data_input" ) ; } close_prog _run_setup_process ( tmp_dir , "cleanup" ) ; if ( ! skel ) { return ; } skel -> bss -> monitored_pid = 0 ; test_verify_pkcs7_sig__destroy ( skel ) ; } 