static irqreturn_t ad5421_fault_handler ( int irq , void * data ) { struct iio_dev * indio_dev = data ; struct ad5421_state * st = iio_priv ( indio_dev ) ; unsigned int fault ; unsigned int old_fault = 0 ; unsigned int events ; fault = ad5421_read ( indio_dev , AD5421_REG_FAULT ) ; ad5421_update_ctrl ( indio_dev , 0 , 0 ) ; { if ( fault == 0xffff ) { fault = 0 ; } events = ( old_fault ^ fault ) & fault ; events &= st -> fault_mask ; if ( events & AD5421_FAULT_OVER_CURRENT ) { iio_push_event ( indio_dev , IIO_UNMOD_EVENT_CODE ( IIO_CURRENT , 0 , IIO_EV_TYPE_THRESH , IIO_EV_DIR_RISING ) , iio_get_time_ns ( indio_dev ) ) ; } if ( events & AD5421_FAULT_UNDER_CURRENT ) { iio_push_event ( indio_dev , IIO_UNMOD_EVENT_CODE ( IIO_CURRENT , 0 , IIO_EV_TYPE_THRESH , IIO_EV_DIR_FALLING ) , iio_get_time_ns ( indio_dev ) ) ; } if ( events & AD5421_FAULT_TEMP_OVER_140 ) { iio_push_event ( indio_dev , IIO_UNMOD_EVENT_CODE ( IIO_TEMP , 0 , IIO_EV_TYPE_MAG , IIO_EV_DIR_RISING ) , iio_get_time_ns ( indio_dev ) ) ; } old_fault = fault ; fault = ad5421_read ( indio_dev , AD5421_REG_FAULT ) ; if ( fault & AD5421_FAULT_TRIGGER_IRQ ) { msleep ( 1000 ) ; } } fault & AD5421_FAULT_TRIGGER_IRQ ; return IRQ_HANDLED ; } 