int msDrawBarChartLayer ( mapObj * map , layerObj * layer , imageObj * image ) { shapeObj shape ; int status = MS_SUCCESS ; const char * chartSizeProcessingKey = msLayerGetProcessingKey ( layer , "CHART_SIZE" ) ; const char * barMax = msLayerGetProcessingKey ( layer , "CHART_BAR_MAXVAL" ) ; const char * barMin = msLayerGetProcessingKey ( layer , "CHART_BAR_MINVAL" ) ; double width , height ; double barWidth ; double * values ; styleObj * * styles ; pointObj center ; double barMaxVal = 0.0 , barMinVal = 0.0 ; int numvalues = layer -> numclasses ; int numvalues_for_shape ; if ( chartSizeProcessingKey == NULL ) { width = height = 20 ; } else { switch ( sscanf ( chartSizeProcessingKey , "%lf %lf" , & width , & height ) ) { case 2 : break ; case 1 : height = width ; break ; default : msSetError ( MS_MISCERR , "msDrawChart format error for processing key \"CHART_SIZE\"" , "msDrawBarChartLayer()" ) ; return MS_FAILURE ; } } if ( barMax ) { if ( sscanf ( barMax , "%lf" , & barMaxVal ) != 1 ) { msSetError ( MS_MISCERR , "Error reading value for processing key \"CHART_BAR_MAXVAL\"" , "msDrawBarChartLayer()" ) ; return MS_FAILURE ; } } if ( barMin ) { if ( sscanf ( barMin , "%lf" , & barMinVal ) != 1 ) { msSetError ( MS_MISCERR , "Error reading value for processing key \"CHART_BAR_MINVAL\"" , "msDrawBarChartLayer()" ) ; return MS_FAILURE ; } } if ( barMin && barMax && barMinVal >= barMaxVal ) { msSetError ( MS_MISCERR , "\"CHART_BAR_MINVAL\" must be less than \"CHART_BAR_MAXVAL\"" , "msDrawBarChartLayer()" ) ; return MS_FAILURE ; } barWidth = ( double ) width / ( double ) layer -> numclasses ; if ( ! barWidth ) { msSetError ( MS_MISCERR , "Specified width of chart too small to fit given number of classes" , "msDrawBarChartLayer()" ) ; return MS_FAILURE ; } msInitShape ( & shape ) ; values = ( double * ) calloc ( numvalues , sizeof ( double ) ) ; MS_CHECK_ALLOC ( values , numvalues * sizeof ( double ) , MS_FAILURE ) ; styles = ( styleObj * * ) malloc ( numvalues * sizeof ( styleObj * ) ) ; if ( styles == NULL ) { msSetError ( MS_MEMERR , "%s: %d: Out of memory allocating %u bytes.\n" , "msDrawBarChartLayer()" , __FILE__ , __LINE__ , ( unsigned int ) ( numvalues * sizeof ( styleObj * ) ) ) ; free ( values ) ; return MS_FAILURE ; } while ( MS_SUCCESS == getNextShape ( map , layer , values , & numvalues_for_shape , styles , & shape ) ) { msDrawStartShape ( map , layer , image , & shape ) ; if ( findChartPoint ( map , & shape , width , height , & center ) == MS_SUCCESS ) { status = msDrawBarChart ( map , image , & center , values , styles , numvalues_for_shape , width , height , ( barMax != NULL ) ?& barMaxVal : NULL , ( barMin != NULL ) ?& barMinVal : NULL , barWidth ) ; } msDrawEndShape ( map , layer , image , & shape ) ; msFreeShape ( & shape ) ; } free ( values ) ; free ( styles ) ; return status ; } 