static void cirrusfb_fillrect ( struct fb_info * info , const struct fb_fillrect * region ) { struct fb_fillrect modded ; int vxres , vyres ; struct cirrusfb_info * cinfo = info -> par ; int m = info -> var . bits_per_pixel ; u32 color = ( info -> fix . visual == FB_VISUAL_TRUECOLOR ) ?cinfo -> pseudo_palette [ region -> color ] : region -> color ; if ( info -> state != FBINFO_STATE_RUNNING ) { return ; } vxres = info -> var . xres_virtual ; vyres = info -> var . yres_virtual ; memcpy ( & modded , region , sizeof ( fb_fillrect ) ) ; if ( ! modded . width || ! modded . height || modded . dx >= vxres || modded . dy >= vyres ) { return ; } if ( modded . dx + modded . width > vxres ) { modded . width = vxres - modded . dx ; } if ( modded . dy + modded . height > vyres ) { modded . height = vyres - modded . dy ; } cirrusfb_RectFill ( cinfo -> regbase , info -> var . bits_per_pixel , ( region -> dx * m ) / 8 , region -> dy , ( region -> width * m ) / 8 , region -> height , color , color , info -> fix . line_length , 0x40 ) ; } 