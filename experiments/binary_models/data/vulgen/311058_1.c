static int bio_mem_small_io_test ( void ) { uint8_t buf [ 2 ] ; int i , j , ret ; BIO * bio ; int failed = 1 ; if ( ( bio = BIO_new ( BIO_s_mem ( ) ) ) == NULL ) { fprintf ( stderr , "FAIL: BIO_new() returned NULL\n" ) ; failure } for ( i = 0 ; i < 100 ; i ++ ) { if ( ! BIO_reset ( bio ) ) { fprintf ( stderr , "FAIL: BIO_reset() failed\n" ) ; failure } for ( j = 0 ; j < 25000 ; j ++ ) { ret = BIO_write ( bio , buf , sizeof ( buf ) ) ; if ( ret != sizeof ( buf ) ) { fprintf ( stderr , "FAIL: BIO_write() = %d, " "want %zu\n" , ret , sizeof ( buf ) ) ; failure } } for ( j = 0 ; j < 25000 ; j ++ ) { ret = BIO_read ( bio , buf , sizeof ( buf ) ) ; if ( ret != sizeof ( buf ) ) { fprintf ( stderr , "FAIL: BIO_read() = %d, " "want %zu\n" , ret , sizeof ( buf ) ) ; failure } ret = BIO_write ( bio , buf , sizeof ( buf ) ) ; if ( ret != sizeof ( buf ) ) { fprintf ( stderr , "FAIL: BIO_write() = %d, " "want %zu\n" , ret , sizeof ( buf ) ) ; failure } } for ( j = 0 ; j < 25000 ; j ++ ) { ret = BIO_read ( bio , buf , sizeof ( buf ) ) ; if ( ret != sizeof ( buf ) ) { fprintf ( stderr , "FAIL: BIO_read() = %d, " "want %zu\n" , ret , sizeof ( buf ) ) ; failure } } if ( ! BIO_eof ( bio ) ) { fprintf ( stderr , "FAIL: BIO not EOF\n" ) ; failure } } if ( buf [ 0 ] != 0xdb || buf [ 1 ] != 0xdb ) { fprintf ( stderr , "FAIL: buf = {0x%x, 0x%x}, want {0xdb, 0xdb}\n" , buf [ 0 ] , buf [ 1 ] ) ; failure } failed = 0 ; failure BIO_free ( bio ) ; return failed ; } 