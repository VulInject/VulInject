static inline void smc911x_rcv ( struct net_device * dev ) { struct smc911x_local * lp = netdev_priv ( dev ) ; unsigned int pkt_len , status ; struct sk_buff * skb ; unsigned char * data ; DBG ( SMC_DEBUG_FUNC | SMC_DEBUG_RX , dev , "-->%s\n" , __func__ ) ; status = SMC_GET_RX_STS_FIFO ( lp ) ; DBG ( SMC_DEBUG_RX , dev , "Rx pkt len %d status 0x%08x\n" , ( status & 0x3fff0000 ) >> 16 , status & 0xc000ffff ) ; pkt_len = ( status & RX_STS_PKT_LEN_ ) >> 16 ; if ( status & RX_STS_ES_ ) { dev -> stats . rx_errors ++ ; if ( status & RX_STS_CRC_ERR_ ) { dev -> stats . rx_crc_errors ++ ; } else { if ( status & RX_STS_LEN_ERR_ ) { dev -> stats . rx_length_errors ++ ; } if ( status & RX_STS_MCAST_ ) { dev -> stats . multicast ++ ; } } smc911x_drop_pkt ( dev ) ; } else { skb = netdev_alloc_skb ( dev , pkt_len + 32 ) ; if ( unlikely ( skb == NULL ) ) { PRINTK ( dev , "Low memory, rcvd packet dropped.\n" ) ; dev -> stats . rx_dropped ++ ; smc911x_drop_pkt ( dev ) ; return ; } data = skb -> data ; skb_reserve ( skb , 2 ) ; skb_put ( skb , pkt_len - 4 ) ; { unsigned int fifo ; fifo = SMC_GET_FIFO_INT ( lp ) ; DBG ( SMC_DEBUG_RX , dev , "Setting RX stat FIFO threshold to %d\n" , fifo & 0xff ) ; SMC_SET_FIFO_INT ( lp , fifo ) ; SMC_SET_RX_CFG ( lp , RX_CFG_RX_END_ALGN16_ | ( ( 2 << 8 ) & RX_CFG_RXDOFF_ ) ) ; lp -> rxdma_active = 1 ; lp -> current_rx_skb = skb ; SMC_PULL_DATA ( lp , data , ( pkt_len + 2 + 15 ) & ~ 15 ) ; } SMC_SET_RX_CFG ( lp , RX_CFG_RX_END_ALGN4_ | ( ( 2 << 8 ) & RX_CFG_RXDOFF_ ) ) ; SMC_PULL_DATA ( lp , data , pkt_len + 2 + 3 ) ; DBG ( SMC_DEBUG_PKTS , dev , "Received packet\n" ) ; PRINT_PKT ( data , ( ( pkt_len - 4 ) <= 64 ) ?pkt_len - 4 : 64 ) ; skb -> protocol = eth_type_trans ( skb , dev ) ; netif_rx ( skb ) ; dev -> stats . rx_packets ++ ; dev -> stats . rx_bytes += pkt_len - 4 ; } } 