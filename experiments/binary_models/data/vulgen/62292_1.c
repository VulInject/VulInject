int hci1394_ohci_init ( hci1394_state_t * soft_state , hci1394_drvinfo_t * drvinfo , hci1394_ohci_handle_t * ohci_hdl ) { int status ; uint32_t version ; hci1394_ohci_t * ohci ; uint16_t cmdreg ; ASSERT ( ohci_hdl != NULL ) ; ohci = kmem_alloc ( sizeof ( hci1394_ohci_t ) , KM_SLEEP ) ; * ohci_hdl = ohci ; ohci -> ohci_bustime_enabled = B_FALSE ; ohci -> ohci_bustime_count = 0 ; ohci -> ohci_set_root_holdoff = B_FALSE ; ohci -> ohci_set_gap_count = B_FALSE ; ohci -> ohci_gap_count = 0 ; mutex_init ( & ohci -> ohci_mutex , NULL , MUTEX_DRIVER , drvinfo -> di_iblock_cookie ) ; status = ddi_regs_map_setup ( drvinfo -> di_dip , OHCI_REG_SET , ( caddr_t * ) & ohci -> ohci_regs , 0 , 0 , & drvinfo -> di_reg_attr , & ohci -> ohci_reg_handle ) ; if ( status != DDI_SUCCESS ) { mutex_destroy ( & ohci -> ohci_mutex ) ; kmem_free ( ohci , sizeof ( hci1394_ohci_t ) ) ; * ohci_hdl = NULL ; return ( DDI_FAILURE ) ; } ohci -> soft_state = soft_state ; ohci -> ohci_drvinfo = drvinfo ; cmdreg = pci_config_get16 ( soft_state -> pci_config , PCI_CONF_COMM ) ; if ( ( cmdreg & ( PCI_COMM_MAE | PCI_COMM_ME ) ) != ( PCI_COMM_MAE | PCI_COMM_ME ) ) { cmdreg |= PCI_COMM_MAE | PCI_COMM_ME ; pci_config_put16 ( soft_state -> pci_config , PCI_CONF_COMM , cmdreg ) ; } status = hci1394_ohci_chip_init ( ohci ) ; if ( status != DDI_SUCCESS ) { ddi_regs_map_free ( & ohci -> ohci_reg_handle ) ; mutex_destroy ( & ohci -> ohci_mutex ) ; kmem_free ( ohci , sizeof ( hci1394_ohci_t ) ) ; * ohci_hdl = NULL ; return ( DDI_FAILURE ) ; } status = hci1394_ohci_phy_init ( ohci ) ; if ( status != DDI_SUCCESS ) { ( void ) hci1394_ohci_soft_reset ( ohci ) ; ddi_regs_map_free ( & ohci -> ohci_reg_handle ) ; mutex_destroy ( & ohci -> ohci_mutex ) ; kmem_free ( ohci , sizeof ( hci1394_ohci_t ) ) ; * ohci_hdl = NULL ; return ( DDI_FAILURE ) ; } if ( ohci -> ohci_phy == H1394_PHY_1394A ) { status = hci1394_ohci_1394a_init ( ohci ) ; if ( status != DDI_SUCCESS ) { ( void ) hci1394_ohci_soft_reset ( ohci ) ; ddi_regs_map_free ( & ohci -> ohci_reg_handle ) ; mutex_destroy ( & ohci -> ohci_mutex ) ; kmem_free ( ohci , sizeof ( hci1394_ohci_t ) ) ; * ohci_hdl = NULL ; return ( DDI_FAILURE ) ; } } soft_state -> halinfo . guid = hci1394_ohci_guid ( ohci ) ; soft_state -> halinfo . phy = ohci -> ohci_phy ; soft_state -> vendor_info . ohci_vendor_id = ddi_get32 ( ohci -> ohci_reg_handle , & ohci -> ohci_regs -> vendor_id ) ; version = ddi_get32 ( ohci -> ohci_reg_handle , & ohci -> ohci_regs -> version ) ; soft_state -> vendor_info . ohci_version = version ; if ( OHCI_VERSION ( version ) == 0 ) { cmn_err ( CE_NOTE , "hci1394(%d): OpenHCI version %x.%x is not supported" , drvinfo -> di_instance , OHCI_VERSION ( version ) , OHCI_REVISION ( version ) ) ; ( void ) hci1394_ohci_soft_reset ( ohci ) ; ddi_regs_map_free ( & ohci -> ohci_reg_handle ) ; mutex_destroy ( & ohci -> ohci_mutex ) ; kmem_free ( ohci , sizeof ( hci1394_ohci_t ) ) ; * ohci_hdl = NULL ; return ( DDI_FAILURE ) ; } status = hci1394_ohci_selfid_init ( ohci ) ; if ( status != DDI_SUCCESS ) { ( void ) hci1394_ohci_soft_reset ( ohci ) ; ddi_regs_map_free ( & ohci -> ohci_reg_handle ) ; mutex_destroy ( & ohci -> ohci_mutex ) ; kmem_free ( ohci , sizeof ( hci1394_ohci_t ) ) ; * ohci_hdl = NULL ; return ( DDI_FAILURE ) ; } status = hci1394_ohci_cfgrom_init ( ohci ) ; return ( DDI_SUCCESS ) ; } 