int msProjTransformer ( void * pCBData , int nPoints , double * x , double * y , int * panSuccess ) { int i ; msProjTransformInfo * psPTInfo = ( msProjTransformInfo * ) pCBData ; double x_out ; for ( i = 0 ; i < nPoints ; i ++ ) { x_out = psPTInfo -> adfDstGeoTransform [ 0 ] + psPTInfo -> adfDstGeoTransform [ 1 ] * x [ i ] + psPTInfo -> adfDstGeoTransform [ 2 ] * y [ i ] ; y [ i ] = psPTInfo -> adfDstGeoTransform [ 3 ] + psPTInfo -> adfDstGeoTransform [ 4 ] * x [ i ] + psPTInfo -> adfDstGeoTransform [ 5 ] * y [ i ] ; x [ i ] = x_out ; panSuccess [ i ] = 1 ; } if ( psPTInfo -> bUseProj ) { if ( msProjectTransformPoints ( psPTInfo -> pReprojectionDstToSrc , nPoints , x , y ) != MS_SUCCESS ) { for ( i = 0 ; i < nPoints ; i ++ ) { panSuccess [ i ] = 0 ; } return MS_FALSE ; } for ( i = 0 ; i < nPoints ; i ++ ) { if ( x [ i ] == HUGE_VAL || y [ i ] == HUGE_VAL ) { panSuccess [ i ] = 0 ; } } } if ( psPTInfo -> bDstIsGeographic ) { for ( i = 0 ; i < nPoints ; i ++ ) { x [ i ] = x [ i ] * DEG_TO_RAD ; y [ i ] = y [ i ] * DEG_TO_RAD ; } } if ( psPTInfo -> bUseProj ) { double * z ; int tr_result ; z = ( double * ) msSmallCalloc ( sizeof ( double ) , nPoints ) ; msAcquireLock ( TLOCK_PROJ ) ; tr_result = pj_transform ( psPTInfo -> psDstProjObj -> proj , psPTInfo -> psSrcProjObj -> proj , nPoints , 1 , x , y , z ) ; msReleaseLock ( TLOCK_PROJ ) ; if ( tr_result != 0 ) { for ( i = 0 ; i < nPoints ; i ++ ) { panSuccess [ i ] = 0 ; } return MS_FALSE ; } free ( z ) ; for ( i = 0 ; i < nPoints ; i ++ ) { if ( x [ i ] == HUGE_VAL || y [ i ] == HUGE_VAL ) { panSuccess [ i ] = 0 ; } } } if ( psPTInfo -> bSrcIsGeographic ) { for ( i = 0 ; i < nPoints ; i ++ ) { if ( panSuccess [ i ] ) { x [ i ] = x [ i ] * RAD_TO_DEG ; y [ i ] = y [ i ] * RAD_TO_DEG ; } } } for ( i = 0 ; i < nPoints ; i ++ ) { if ( panSuccess [ i ] ) { x_out = psPTInfo -> adfInvSrcGeoTransform [ 0 ] + psPTInfo -> adfInvSrcGeoTransform [ 1 ] * x [ i ] + psPTInfo -> adfInvSrcGeoTransform [ 2 ] * y [ i ] ; y [ i ] = psPTInfo -> adfInvSrcGeoTransform [ 3 ] + psPTInfo -> adfInvSrcGeoTransform [ 4 ] * x [ i ] + psPTInfo -> adfInvSrcGeoTransform [ 5 ] * y [ i ] ; x [ i ] = x_out ; } else { x [ i ] = - 1 ; y [ i ] = - 1 ; } } return 1 ; } 