usbd_status uvideo_vs_open ( struct uvideo_softc * sc ) { usb_endpoint_descriptor_t * ed ; usbd_status error ; uint32_t dwMaxVideoFrameSize ; DPRINTF ( 1 , "%s: %s\n" , DEVNAME ( sc ) , __func__ ) ; if ( sc -> sc_negotiated_flag == 0 ) { error = uvideo_vs_negotiation ( sc , 1 ) ; if ( error != USBD_NORMAL_COMPLETION ) { return ( error ) ; } } error = uvideo_vs_set_alt ( sc , sc -> sc_vs_cur -> ifaceh , UGETDW ( sc -> sc_desc_probe . dwMaxPayloadTransferSize ) ) ; if ( error != USBD_NORMAL_COMPLETION ) { printf ( "%s: could not set alternate interface!\n" , DEVNAME ( sc ) ) ; return ( error ) ; } ed = usbd_get_endpoint_descriptor ( sc -> sc_vs_cur -> ifaceh , sc -> sc_vs_cur -> endpoint ) ; if ( ed == NULL ) { printf ( "%s: no endpoint descriptor for VS iface\n" , DEVNAME ( sc ) ) ; return ( USBD_INVAL ) ; } DPRINTF ( 1 , "%s: open pipe for bEndpointAddress=0x%02x\n" , DEVNAME ( sc ) , sc -> sc_vs_cur -> endpoint ) ; error = usbd_open_pipe ( sc -> sc_vs_cur -> ifaceh , sc -> sc_vs_cur -> endpoint , USBD_EXCLUSIVE_USE , & sc -> sc_vs_cur -> pipeh ) ; if ( error != USBD_NORMAL_COMPLETION ) { printf ( "%s: could not open VS pipe: %s\n" , DEVNAME ( sc ) , usbd_errstr ( error ) ) ; return ( error ) ; } if ( strcmp ( sc -> sc_udev -> bus -> bdev . dv_cfdata -> cf_driver -> cd_name , "ohci" ) == 0 ) { sc -> sc_nframes = 8 ; } else { dwMaxVideoFrameSize = UGETDW ( sc -> sc_desc_probe . dwMaxVideoFrameSize ) ; sc -> sc_nframes = ( dwMaxVideoFrameSize + sc -> sc_vs_cur -> psize - 1 ) / sc -> sc_vs_cur -> psize ; } DPRINTF ( 1 , "%s: nframes=%d\n" , DEVNAME ( sc ) , sc -> sc_nframes ) ; return ( USBD_NORMAL_COMPLETION ) ; } 