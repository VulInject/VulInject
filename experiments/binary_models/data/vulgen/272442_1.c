static int vnt_int_report_rate ( struct vnt_private * priv , struct vnt_td_info * context , u8 tsr0 , u8 tsr1 ) { struct vnt_tx_fifo_head * fifo_head ; struct ieee80211_tx_info * info ; struct ieee80211_rate * rate ; u16 fb_option ; u8 tx_retry = ( tsr0 & TSR0_NCR ) ; s8 idx ; if ( ! context ) { return - ENOMEM ; } fifo_head = ( vnt_tx_fifo_head * ) context -> buf ; fb_option = ( le16_to_cpu ( fifo_head -> fifo_ctl ) & ( FIFOCTL_AUTO_FB_0 | FIFOCTL_AUTO_FB_1 ) ) ; info = IEEE80211_SKB_CB ( context -> skb ) ; idx = info -> control . rates [ 0 ] . idx ; if ( fb_option && ! ( tsr1 & TSR1_TERR ) ) { u8 tx_rate ; u8 retry = tx_retry ; rate = ieee80211_get_tx_rate ( priv -> hw , info ) ; tx_rate = rate -> hw_value - RATE_18M ; if ( retry > 4 ) { retry = 4 ; } if ( fb_option & FIFOCTL_AUTO_FB_0 ) { tx_rate = fallback_rate0 [ tx_rate ] [ retry ] ; } if ( fb_option & FIFOCTL_AUTO_FB_1 ) { tx_rate = fallback_rate1 [ tx_rate ] [ retry ] ; } if ( info -> band == NL80211_BAND_5GHZ ) { idx = tx_rate - RATE_6M ; } else { idx = tx_rate ; } } ieee80211_tx_info_clear_status ( info ) ; info -> status . rates [ 0 ] . count = tx_retry ; if ( ! ( tsr1 & TSR1_TERR ) ) { info -> status . rates [ 0 ] . idx = idx ; if ( info -> flags & IEEE80211_TX_CTL_NO_ACK ) { info -> flags |= IEEE80211_TX_STAT_NOACK_TRANSMITTED ; } else { info -> flags |= IEEE80211_TX_STAT_ACK ; } } return 0 ; } 