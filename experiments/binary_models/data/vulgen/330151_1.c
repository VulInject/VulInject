int mlx5e_htb_leaf_to_inner ( struct mlx5e_htb * htb , u16 classid , u16 child_classid , u64 rate , u64 ceil , struct netlink_ext_ack * extack ) { struct mlx5e_qos_node * node , * child ; struct mlx5e_priv * priv = htb -> priv ; int err , tmp_err ; u32 new_hw_id ; u16 qid ; qos_dbg ( htb -> mdev , "TC_HTB_LEAF_TO_INNER classid %04x, upcoming child %04x, rate %llu, ceil %llu\n" , classid , child_classid , rate , ceil ) ; node = mlx5e_htb_node_find ( htb , classid ) ; err = mlx5_qos_create_inner_node ( htb -> mdev , node -> parent -> hw_id , node -> bw_share , node -> max_average_bw , & new_hw_id ) ; if ( err ) { NL_SET_ERR_MSG_MOD ( extack , "Firmware error when creating an inner node." ) ; qos_err ( htb -> mdev , "Failed to create an inner node (class %04x), err = %d\n" , classid , err ) ; return err ; } child = mlx5e_htb_node_create_leaf ( htb , child_classid , node -> qid , node ) ; if ( IS_ERR ( child ) ) { err = PTR_ERR ( child ) ; err_destroy_hw_node } child -> rate = rate ; mlx5e_htb_convert_rate ( htb , rate , node , & child -> bw_share ) ; mlx5e_htb_convert_ceil ( htb , ceil , & child -> max_average_bw ) ; err = mlx5_qos_create_leaf_node ( htb -> mdev , new_hw_id , child -> bw_share , child -> max_average_bw , & child -> hw_id ) ; if ( err ) { NL_SET_ERR_MSG_MOD ( extack , "Firmware error when creating a leaf node." ) ; qos_err ( htb -> mdev , "Failed to create a leaf node (class %04x), err = %d\n" , classid , err ) ; err_delete_sw_node } qid = node -> qid ; WRITE_ONCE ( node -> qid , MLX5E_QOS_QID_INNER ) ; if ( test_bit ( MLX5E_STATE_OPENED , & priv -> state ) ) { mlx5e_deactivate_qos_sq ( priv , qid ) ; mlx5e_close_qos_sq ( priv , qid ) ; } err = mlx5_qos_destroy_node ( htb -> mdev , node -> hw_id ) ; if ( err ) { qos_warn ( htb -> mdev , "Failed to destroy leaf node %u (class %04x), err = %d\n" , node -> hw_id , classid , err ) ; } node -> hw_id = new_hw_id ; if ( test_bit ( MLX5E_STATE_OPENED , & priv -> state ) ) { err = mlx5e_open_qos_sq ( priv , & priv -> channels , child -> qid , child -> hw_id ) ; if ( err ) { NL_SET_ERR_MSG_MOD ( extack , "Error creating an SQ." ) ; qos_warn ( htb -> mdev , "Failed to create a QoS SQ (class %04x), err = %d\n" , classid , err ) ; } else { mlx5e_activate_qos_sq ( priv , child -> qid , child -> hw_id ) ; } } return 0 ; err_delete_sw_node child -> qid = MLX5E_QOS_QID_INNER ; mlx5e_htb_node_delete ( htb , child ) ; err_destroy_hw_node tmp_err = mlx5_qos_destroy_node ( htb -> mdev , new_hw_id ) ; if ( tmp_err ) { qos_warn ( htb -> mdev , "Failed to roll back creation of an inner node %u (class %04x), err = %d\n" , new_hw_id , classid , tmp_err ) ; } return err ; } 