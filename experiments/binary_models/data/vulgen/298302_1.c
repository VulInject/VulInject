void sendf ( APPL * appl , word command , dword Id , word Number , byte * format , ... ) { word i , j ; word length = 12 , dlength = 0 ; byte * write ; CAPI_MSG msg ; byte * string = NULL ; va_list ap ; diva_os_message_buffer_s * dmb ; diva_card * card = NULL ; dword tmp ; DBG_PRV1 ( "sendf(a=%d,cmd=%x,format=%s)" ) PUT_WORD ( & msg . header . appl_id , appl -> Id ) ; PUT_WORD ( & msg . header . command , command ) ; if ( ( byte ) ( command >> 8 ) == 0x82 ) { Number = appl -> Number ++ ; } PUT_WORD ( & msg . header . number , Number ) ; PUT_DWORD ( & msg . header . controller , Id ) ; write = ( byte * ) & msg ; write += 12 ; va_start ( ap , format ) ; for ( i = 0 ; format [ i ] ; i ++ ) { switch ( format [ i ] ) { case 'b' : tmp = va_arg ( ap , dword ) ; * ( byte * ) write = ( byte ) ( tmp & 0xff ) ; write += 1 ; length += 1 ; break ; case 'w' : tmp = va_arg ( ap , dword ) ; PUT_WORD ( write , ( tmp & 0xffff ) ) ; write += 2 ; length += 2 ; break ; case 'd' : tmp = va_arg ( ap , dword ) ; PUT_DWORD ( write , tmp ) ; write += 4 ; length += 4 ; break ; case 's' : case 'S' : string = va_arg ( ap , byte * ) ; length += string [ 0 ] + 1 ; for ( j = 0 ; j <= string [ 0 ] ; j ++ ) { * write ++ = string [ j ] ; } break ; } } va_end ( ap ) ; PUT_WORD ( & msg . header . length , length ) ; msg . header . controller = UnMapController ( msg . header . controller ) ; if ( command == _DATA_B3_I ) { dlength = GET_WORD ( ( ( byte * ) & msg . info . data_b3_ind . Data_Length ) ) ; } if ( ! ( dmb = diva_os_alloc_message_buffer ( length + dlength , ( void * * ) & write ) ) ) { DBG_ERR ( "sendf: alloc_message_buffer failed, incoming msg dropped." ) return ; } memcpy ( write , ( byte * ) & msg , length ) ; if ( command == _DATA_B3_I ) { dword data = GET_DWORD ( & msg . info . data_b3_ind . Data ) ; memcpy ( write + length , ( void * ) ( long ) data , dlength ) ; } if ( myDriverDebugHandle . dbgMask & DL_XLOG ) { switch ( command ) { default : xlog ( "\x00\x02" , & msg , 0x81 , length ) ; break ; case _DATA_B3_R | CONFIRM : if ( myDriverDebugHandle . dbgMask & DL_BLK ) { xlog ( "\x00\x02" , & msg , 0x81 , length ) ; } break ; case _DATA_B3_I : if ( myDriverDebugHandle . dbgMask & DL_BLK ) { xlog ( "\x00\x02" , & msg , 0x81 , length ) ; for ( i = 0 ; i < dlength ; i += 256 ) { DBG_BLK ( 256 256 ) if ( ! ( myDriverDebugHandle . dbgMask & DL_PRV0 ) ) { break ; } } } break ; } } if ( ! ( card = find_card_by_ctrl ( write [ 8 ] & 0x7f ) ) ) { DBG_ERR ( "sendf - controller %d not found, incoming msg dropped" 8 0x7f ) diva_os_free_message_buffer ( dmb ) ; return ; } capi_ctr_handle_message ( & card -> capi_ctrl , appl -> Id , dmb ) ; } 