static int idma64_probe ( struct idma64_chip * chip ) { struct idma64 * idma64 ; unsigned short nr_chan = IDMA64_NR_CHAN ; unsigned short i ; int ret ; idma64 = devm_kzalloc ( chip -> dev , sizeof ( * idma64 ) , GFP_KERNEL ) ; if ( ! idma64 ) { return - ENOMEM ; } idma64 -> regs = chip -> regs ; chip -> idma64 = idma64 ; if ( ! idma64 -> chan ) { return - ENOMEM ; } idma64 -> all_chan_mask = ( 1 << nr_chan ) - 1 ; idma64_off ( idma64 ) ; ret = devm_request_irq ( chip -> dev , chip -> irq , idma64_irq , IRQF_SHARED , dev_name ( chip -> dev ) , idma64 ) ; if ( ret ) { return ret ; } INIT_LIST_HEAD ( & idma64 -> dma . channels ) ; for ( i = 0 ; i < nr_chan ; i ++ ) { struct idma64_chan * idma64c = & idma64 -> chan [ i ] ; idma64c -> vchan . desc_free = idma64_vdesc_free ; vchan_init ( & idma64c -> vchan , & idma64 -> dma ) ; idma64c -> regs = idma64 -> regs + i * IDMA64_CH_LENGTH ; idma64c -> mask = BIT ( i ) ; } dma_cap_set ( DMA_SLAVE , idma64 -> dma . cap_mask ) ; dma_cap_set ( DMA_PRIVATE , idma64 -> dma . cap_mask ) ; idma64 -> dma . device_alloc_chan_resources = idma64_alloc_chan_resources ; idma64 -> dma . device_free_chan_resources = idma64_free_chan_resources ; idma64 -> dma . device_prep_slave_sg = idma64_prep_slave_sg ; idma64 -> dma . device_issue_pending = idma64_issue_pending ; idma64 -> dma . device_tx_status = idma64_tx_status ; idma64 -> dma . device_config = idma64_slave_config ; idma64 -> dma . device_pause = idma64_pause ; idma64 -> dma . device_resume = idma64_resume ; idma64 -> dma . device_terminate_all = idma64_terminate_all ; idma64 -> dma . src_addr_widths = IDMA64_BUSWIDTHS ; idma64 -> dma . dst_addr_widths = IDMA64_BUSWIDTHS ; idma64 -> dma . directions = BIT ( DMA_DEV_TO_MEM ) | BIT ( DMA_MEM_TO_DEV ) ; idma64 -> dma . residue_granularity = DMA_RESIDUE_GRANULARITY_BURST ; idma64 -> dma . dev = chip -> dev ; dma_set_max_seg_size ( idma64 -> dma . dev , IDMA64C_CTLH_BLOCK_TS_MASK ) ; ret = dma_async_device_register ( & idma64 -> dma ) ; if ( ret ) { return ret ; } dev_info ( chip -> dev , "Found Intel integrated DMA 64-bit\n" ) ; return 0 ; } 