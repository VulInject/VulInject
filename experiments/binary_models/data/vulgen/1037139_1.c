static int UVERBS_HANDLER MLX5_IB_METHOD_CREATE_FLOW ( struct uverbs_attr_bundle * attrs ) { struct mlx5_flow_context flow_context = { . flow_tag = MLX5_FS_DEFAULT_FLOW_TAG } ; u32 * offset_attr , offset = 0 , counter_id = 0 ; int dest_id , dest_type = - 1 , inlen , len , ret , i ; struct mlx5_ib_flow_handler * flow_handler ; struct mlx5_ib_flow_matcher * fs_matcher ; struct ib_uobject * * arr_flow_actions ; struct ib_uflow_resources * uflow_res ; struct mlx5_flow_act flow_act = { } ; struct ib_qp * qp = NULL ; void * devx_obj , * cmd_in ; struct ib_uobject * uobj ; struct mlx5_ib_dev * dev ; u32 flags ; fs_matcher = uverbs_attr_get_obj ( attrs , MLX5_IB_ATTR_CREATE_FLOW_MATCHER ) ; uobj = uverbs_attr_get_uobject ( attrs , MLX5_IB_ATTR_CREATE_FLOW_HANDLE ) ; dev = mlx5_udata_to_mdev ( & attrs -> driver_udata ) ; if ( get_dests ( attrs , fs_matcher , & dest_id , & dest_type , & qp , & flags ) ) { return - EINVAL ; } if ( flags & MLX5_IB_ATTR_CREATE_FLOW_FLAGS_DEFAULT_MISS ) { flow_act . action |= MLX5_FLOW_CONTEXT_ACTION_FWD_NEXT_NS ; } if ( flags & MLX5_IB_ATTR_CREATE_FLOW_FLAGS_DROP ) { flow_act . action |= MLX5_FLOW_CONTEXT_ACTION_DROP ; } len = uverbs_attr_get_uobjs_arr ( attrs , MLX5_IB_ATTR_CREATE_FLOW_ARR_COUNTERS_DEVX , & arr_flow_actions ) ; if ( len ) { devx_obj = arr_flow_actions [ 0 ] -> object ; if ( uverbs_attr_is_valid ( attrs , MLX5_IB_ATTR_CREATE_FLOW_ARR_COUNTERS_DEVX_OFFSET ) ) { int num_offsets = uverbs_attr_ptr_get_array_size ( attrs , MLX5_IB_ATTR_CREATE_FLOW_ARR_COUNTERS_DEVX_OFFSET , sizeof ( u32 ) ) ; if ( num_offsets != 1 ) { return - EINVAL ; } offset_attr = uverbs_attr_get_alloced_ptr ( attrs , MLX5_IB_ATTR_CREATE_FLOW_ARR_COUNTERS_DEVX_OFFSET ) ; offset = * offset_attr ; } if ( ! is_flow_counter ( devx_obj , offset , & counter_id ) ) { return - EINVAL ; } flow_act . action |= MLX5_FLOW_CONTEXT_ACTION_COUNT ; } cmd_in = uverbs_attr_get_alloced_ptr ( attrs , MLX5_IB_ATTR_CREATE_FLOW_MATCH_VALUE ) ; inlen = uverbs_attr_get_len ( attrs , MLX5_IB_ATTR_CREATE_FLOW_MATCH_VALUE ) ; uflow_res = flow_resources_alloc ( MLX5_IB_CREATE_FLOW_MAX_FLOW_ACTIONS ) ; if ( ! uflow_res ) { return - ENOMEM ; } len = uverbs_attr_get_uobjs_arr ( attrs , MLX5_IB_ATTR_CREATE_FLOW_ARR_FLOW_ACTIONS , & arr_flow_actions ) ; for ( i = 0 ; i < len ; i ++ ) { struct mlx5_ib_flow_action * maction = to_mflow_act ( arr_flow_actions [ i ] -> object ) ; ret = parse_flow_flow_action ( maction , false , & flow_act ) ; if ( ret ) { err_out } flow_resources_add ( uflow_res , IB_FLOW_SPEC_ACTION_HANDLE , arr_flow_actions [ i ] -> object ) ; } ret = uverbs_copy_from ( & flow_context . flow_tag , attrs , MLX5_IB_ATTR_CREATE_FLOW_TAG ) ; if ( ! ret ) { if ( flow_context . flow_tag >= BIT ( 24 ) ) { ret = - EINVAL ; err_out } flow_context . flags |= FLOW_CONTEXT_HAS_TAG ; } flow_handler = raw_fs_rule_add ( dev , fs_matcher , & flow_context , & flow_act , counter_id , cmd_in , inlen , dest_id , dest_type ) ; if ( IS_ERR ( flow_handler ) ) { ret = PTR_ERR ( flow_handler ) ; err_out } ib_set_flow ( uobj , & flow_handler -> ibflow , qp , & dev -> ib_dev , uflow_res ) ; return 0 ; err_out ib_uverbs_flow_resources_free ( uflow_res ) ; return ret ; } 