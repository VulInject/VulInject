sip_header_t sip_add_param ( sip_header_t sip_header , char * param , int * error ) { _sip_header_t * _sip_header ; _sip_header_t * new_header ; int hdrlen ; _sip_msg_t * _sip_msg ; int param_len ; char * tmp_ptr ; if ( error != NULL ) { * error = 0 ; } if ( param == NULL || sip_header == NULL ) { if ( error != NULL ) { * error = EINVAL ; } return ( NULL ) ; } _sip_header = ( _sip_header_t * ) sip_header ; ( void ) pthread_mutex_lock ( & _sip_header -> sip_hdr_sipmsg -> sip_msg_mutex ) ; if ( _sip_header -> sip_hdr_sipmsg -> sip_msg_cannot_be_modified ) { if ( error != NULL ) { * error = EPERM ; } ( void ) pthread_mutex_unlock ( & _sip_header -> sip_hdr_sipmsg -> sip_msg_mutex ) ; return ( NULL ) ; } if ( _sip_header -> sip_header_state == SIP_HEADER_DELETED ) { if ( error != NULL ) { * error = EINVAL ; } ( void ) pthread_mutex_unlock ( & _sip_header -> sip_hdr_sipmsg -> sip_msg_mutex ) ; return ( NULL ) ; } param_len = SIP_SPACE_LEN + sizeof ( char ) + SIP_SPACE_LEN + strlen ( param ) ; hdrlen = _sip_header -> sip_hdr_end - _sip_header -> sip_hdr_start ; new_header = sip_new_header ( hdrlen + param_len ) ; if ( new_header == NULL ) { if ( error != NULL ) { * error = ENOMEM ; } ( void ) pthread_mutex_unlock ( & _sip_header -> sip_hdr_sipmsg -> sip_msg_mutex ) ; return ( NULL ) ; } new_header -> sip_hdr_end = new_header -> sip_hdr_start + hdrlen ; hdrlen = param_len + 1 ; tmp_ptr = new_header -> sip_hdr_end ; while ( * tmp_ptr -- != '\n' ) { hdrlen ++ ; if ( tmp_ptr == new_header -> sip_hdr_start ) { sip_free_header ( new_header ) ; if ( error != NULL ) { * error = EINVAL ; } ( void ) pthread_mutex_unlock ( & _sip_header -> sip_hdr_sipmsg -> sip_msg_mutex ) ; return ( NULL ) ; } } ( void ) snprintf ( tmp_ptr , hdrlen + 1 , " %c %s%s" , SIP_SEMI , param , SIP_CRLF ) ; new_header -> sip_hdr_end += param_len ; new_header -> sip_header_functions = _sip_header -> sip_header_functions ; _sip_msg = _sip_header -> sip_hdr_sipmsg ; _sip_add_header ( _sip_msg , new_header , B_TRUE , B_FALSE , NULL ) ; if ( _sip_header -> sip_hdr_sipmsg -> sip_msg_buf != NULL ) { _sip_header -> sip_hdr_sipmsg -> sip_msg_modified = B_TRUE ; } ( void ) pthread_mutex_unlock ( & new_header -> sip_hdr_sipmsg -> sip_msg_mutex ) ; ( void ) sip_delete_header ( sip_header ) ; return ( ( sip_header_t ) new_header ) ; } 