void spa_sync_close_syncing_log_sm ( spa_t * spa ) { ASSERT ( spa_feature_is_active ( spa , SPA_FEATURE_LOG_SPACEMAP ) ) ; spa_log_sm_t * sls = avl_last ( & spa -> spa_sm_logs_by_txg ) ; ASSERT3U ( sls -> sls_txg , == , spa_syncing_txg ( spa ) ) ; sls -> sls_nblocks = space_map_nblocks ( spa_syncing_log_sm ( spa ) ) ; spa -> spa_unflushed_stats . sus_nblocks += sls -> sls_nblocks ; ASSERT ( sls -> sls_nblocks != 0 ) ; spa_log_summary_add_incoming_blocks ( spa , sls -> sls_nblocks ) ; spa_log_summary_verify_counts ( spa ) ; space_map_close ( spa -> spa_syncing_log_sm ) ; spa -> spa_syncing_log_sm = NULL ; if ( spa_flush_all_logs_requested ( spa ) ) { ASSERT3S ( spa_state ( spa ) , == , POOL_STATE_EXPORTED ) ; spa -> spa_log_flushall_txg = 0 ; } } 