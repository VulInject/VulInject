struct page * balloon_page_dequeue ( struct balloon_dev_info * b_dev_info ) { struct page * page , * tmp ; unsigned long flags ; bool dequeued_page ; dequeued_page = false ; spin_lock_irqsave ( & b_dev_info -> pages_lock , flags ) ; list_for_each_entry_safe ( , , , ) { if ( trylock_page ( page ) ) { if ( PageIsolated ( page ) ) { unlock_page ( page ) ; continue ; } balloon_page_delete ( page ) ; __count_vm_event ( BALLOON_DEFLATE ) ; unlock_page ( page ) ; dequeued_page = true ; break ; } } spin_unlock_irqrestore ( & b_dev_info -> pages_lock , flags ) ; if ( ! dequeued_page ) { spin_lock_irqsave ( & b_dev_info -> pages_lock , flags ) ; spin_unlock_irqrestore ( & b_dev_info -> pages_lock , flags ) ; page = NULL ; } return page ; } 