static void processGuestPanicEvent ( virQEMUDriver * driver , virDomainObj * vm , int action , qemuMonitorEventPanicInfo * info ) { qemuDomainObjPrivate * priv = vm -> privateData ; virObjectEvent * event = NULL ; bool removeInactive = false ; unsigned int flags = VIR_DUMP_MEMORY_ONLY ; if ( virDomainObjBeginAsyncJob ( vm , VIR_ASYNC_JOB_DUMP , VIR_DOMAIN_JOB_OPERATION_DUMP , flags ) < 0 ) { return ; } if ( ! virDomainObjIsActive ( vm ) ) { VIR_DEBUG ( "Ignoring GUEST_PANICKED event from inactive domain %s" , vm -> def -> name ) ; endjob } if ( info ) { qemuProcessGuestPanicEventInfo ( driver , vm , info ) ; } virDomainObjSetState ( vm , VIR_DOMAIN_CRASHED , VIR_DOMAIN_CRASHED_PANICKED ) ; event = virDomainEventLifecycleNewFromObj ( vm , VIR_DOMAIN_EVENT_CRASHED , VIR_DOMAIN_EVENT_CRASHED_PANICKED ) ; virObjectEventStateQueue ( driver -> domainEventState , event ) ; qemuDomainSaveStatus ( vm ) ; if ( virDomainLockProcessPause ( driver -> lockManager , vm , & priv -> lockState ) < 0 ) { VIR_WARN ( "Unable to release lease on %s" , vm -> def -> name ) ; } VIR_DEBUG ( "Preserving lock state '%s'" , NULLSTR ( priv -> lockState ) ) ; switch ( action ) { case VIR_DOMAIN_LIFECYCLE_ACTION_COREDUMP_DESTROY : G_GNUC_FALLTHROUGH ; case VIR_DOMAIN_LIFECYCLE_ACTION_DESTROY : qemuProcessStop ( driver , vm , VIR_DOMAIN_SHUTOFF_CRASHED , VIR_ASYNC_JOB_DUMP , 0 ) ; event = virDomainEventLifecycleNewFromObj ( vm , VIR_DOMAIN_EVENT_STOPPED , VIR_DOMAIN_EVENT_STOPPED_CRASHED ) ; virObjectEventStateQueue ( driver -> domainEventState , event ) ; virDomainAuditStop ( vm , "destroyed" ) ; removeInactive = true ; break ; case VIR_DOMAIN_LIFECYCLE_ACTION_COREDUMP_RESTART : if ( doCoreDumpToAutoDumpPath ( driver , vm , flags ) < 0 ) { endjob } G_GNUC_FALLTHROUGH ; case VIR_DOMAIN_LIFECYCLE_ACTION_RESTART : qemuDomainSetFakeReboot ( vm , true ) ; qemuProcessShutdownOrReboot ( vm ) ; break ; case VIR_DOMAIN_LIFECYCLE_ACTION_PRESERVE : break ; default : break ; } endjob virDomainObjEndAsyncJob ( vm ) ; if ( removeInactive ) { qemuDomainRemoveInactive ( driver , vm , 0 , false ) ; } } 