static int dispatch_ioctl ( struct client * client , unsigned int cmd , void __user * arg ) { union ioctl_arg buffer ; int ret ; if ( fw_device_is_shutdown ( client -> device ) ) { return - ENODEV ; } if ( _IOC_TYPE ( cmd ) != '#' || _IOC_NR ( cmd ) >= ARRAY_SIZE ( ioctl_handlers ) || _IOC_SIZE ( cmd ) > sizeof ( buffer ) ) { return - ENOTTY ; } if ( _IOC_DIR ( cmd ) & _IOC_WRITE ) { if ( copy_from_user ( & buffer , arg , _IOC_SIZE ( cmd ) ) ) { return - EFAULT ; } } ret = ioctl_handlers [ _IOC_NR ( cmd ) ] ( client , & buffer ) ; if ( ret < 0 ) { return ret ; } if ( _IOC_DIR ( cmd ) & _IOC_READ ) { if ( copy_to_user ( arg , & buffer , _IOC_SIZE ( cmd ) ) ) { return - EFAULT ; } } return ret ; } 