static TEE_Result split_vm_region ( struct user_mode_ctx * uctx , struct vm_region * r , vaddr_t va ) { struct vm_region * r2 = NULL ; size_t diff = va - r -> va ; assert ( diff && diff < r -> size ) ; r2 = calloc ( 1 , sizeof ( * r2 ) ) ; if ( ! r2 ) { return TEE_ERROR_OUT_OF_MEMORY ; } if ( mobj_is_paged ( r -> mobj ) ) { TEE_Result res = tee_pager_split_um_region ( uctx , va ) ; if ( res ) { return res ; } } r2 -> mobj = mobj_get ( r -> mobj ) ; r2 -> offset = r -> offset + diff ; r2 -> va = va ; r2 -> size = r -> size - diff ; r2 -> attr = r -> attr ; r2 -> flags = r -> flags ; r -> size = diff ; TAILQ_INSERT_AFTER ( & uctx -> vm_info . regions , r , r2 , link ) ; return TEE_SUCCESS ; } 