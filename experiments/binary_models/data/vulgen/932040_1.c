static int cat_impl ( zip_uint64_t idx , zip_uint64_t start , zip_uint64_t len ) { zip_error_t error ; zip_source_t * src ; zip_int64_t n ; char buf [ 8192 ] ; setmode ( fileno ( stdout ) , _O_BINARY ) ; zip_error_init ( & error ) ; if ( len == 0 ) { struct zip_stat sb ; if ( zip_stat_index ( za , idx , stat_flags , & sb ) < 0 ) { fprintf ( stderr , "zip_stat_index failed on '%" PRIu64 "' failed: %s\n" , idx , zip_strerror ( za ) ) ; return - 1 ; } if ( ! ( sb . valid & ZIP_STAT_SIZE ) ) { fprintf ( stderr , "can't cat file at index '%" PRIu64 "' with unknown size\n" , idx ) ; return - 1 ; } len = sb . size ; } if ( ( src = zip_source_zip_file_create ( za , idx , 0 , start , len , NULL , & error ) ) == NULL ) { fprintf ( stderr , "can't open file at index '%" PRIu64 "': %s\n" , idx , zip_error_strerror ( & error ) ) ; zip_error_fini ( & error ) ; return - 1 ; } zip_error_fini ( & error ) ; if ( zip_source_open ( src ) < 0 ) { fprintf ( stderr , "can't open file at index '%" PRIu64 "': %s\n" , idx , zip_error_strerror ( zip_source_error ( src ) ) ) ; return - 1 ; } while ( ( n = zip_source_read ( src , buf , sizeof ( buf ) ) ) > 0 ) { if ( fwrite ( buf , ( size_t ) n , 1 , stdout ) != 1 ) { fprintf ( stderr , "can't write file contents to stdout: %s\n" , strerror ( errno ) ) ; zip_source_free ( src ) ; return - 1 ; } } if ( n == - 1 ) { fprintf ( stderr , "can't read file at index '%" PRIu64 "': %s\n" , idx , zip_error_strerror ( zip_source_error ( src ) ) ) ; zip_source_free ( src ) ; return - 1 ; } if ( zip_source_close ( src ) < 0 ) { fprintf ( stderr , "can't close file at index '%" PRIu64 "': %s\n" , idx , zip_error_strerror ( zip_source_error ( src ) ) ) ; zip_source_free ( src ) ; return - 1 ; } zip_source_free ( src ) ; return 0 ; } 