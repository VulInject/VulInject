static void parse_manifest_file ( char * manifest_path , manifest_files_hash * * ht_p , manifest_wal_range * * first_wal_range_p ) { int fd ; struct stat statbuf ; off_t estimate ; uint32 initial_size ; manifest_files_hash * ht ; char * buffer ; int rc ; parser_context private_context ; JsonManifestParseContext context ; if ( ( fd = open ( manifest_path , O_RDONLY | PG_BINARY , 0 ) ) < 0 ) { report_fatal_error ( "could not open file \"%s\": %m" , manifest_path ) ; } if ( fstat ( fd , & statbuf ) != 0 ) { report_fatal_error ( "could not stat file \"%s\": %m" , manifest_path ) ; } estimate = statbuf . st_size / ESTIMATED_BYTES_PER_MANIFEST_LINE ; initial_size = Min ( PG_UINT32_MAX , Max ( estimate , 256 ) ) ; ht = manifest_files_create ( initial_size , NULL ) ; buffer = pg_malloc ( statbuf . st_size ) ; rc = read ( fd , buffer , statbuf . st_size ) ; if ( rc != statbuf . st_size ) { if ( rc < 0 ) { report_fatal_error ( "could not read file \"%s\": %m" , manifest_path ) ; } else { report_fatal_error ( "could not read file \"%s\": read %d of %lld" , manifest_path , rc , ( long long int ) statbuf . st_size ) ; } } close ( fd ) ; private_context . ht = ht ; private_context . first_wal_range = NULL ; private_context . last_wal_range = NULL ; context . private_data = & private_context ; context . perfile_cb = record_manifest_details_for_file ; context . perwalrange_cb = record_manifest_details_for_wal_range ; context . error_cb = report_manifest_error ; json_parse_manifest ( & context , buffer , statbuf . st_size ) ; * ht_p = ht ; * first_wal_range_p = private_context . first_wal_range ; } 