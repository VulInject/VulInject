static int qcow_open ( struct tcmu_device * dev , bool reopen ) { struct bdev * bdev ; char * config ; int ret ; if ( ! bdev ) { return - 1 ; } tcmur_dev_set_private ( dev , bdev ) ; bdev -> block_size = tcmu_dev_get_block_size ( dev ) ; bdev -> size = tcmu_cfgfs_dev_get_info_u64 ( dev , "Size" , & ret ) ; if ( ret < 0 ) { tcmu_err ( "Could not get device size\n" ) ; err } config = strchr ( tcmu_dev_get_cfgstring ( dev ) , '/' ) ; if ( ! config ) { tcmu_err ( "no configuration found in cfgstring\n" ) ; err } config += 1 ; tcmu_dbg ( "%s\n" , tcmu_dev_get_cfgstring ( dev ) ) ; tcmu_dbg ( "%s\n" , config ) ; tcmu_dev_set_write_cache_enabled ( dev , 1 ) ; if ( bdev_open ( bdev , AT_FDCWD , config , O_RDWR ) == - 1 ) { err } return 0 ; err free ( bdev ) ; return - 1 ; } 