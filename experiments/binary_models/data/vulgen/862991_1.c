void scsi_watch_suspend ( opaque_t token ) { struct scsi_watch_request * swr = ( scsi_watch_request * ) NULL ; SW_DEBUG ( 0 , sw_label , SCSI_DEBUG , "scsi_watch_suspend:\n" ) ; mutex_enter ( & sw . sw_mutex ) ; if ( ! sw . sw_head ) { exit } for ( swr = sw . sw_head ; swr ; swr = swr -> swr_next ) { if ( swr == ( scsi_watch_request * ) token ) { break ; } } if ( swr == ( scsi_watch_request * ) NULL ) { exit } for ( ; ; ) { if ( swr -> swr_busy ) { swr -> swr_what = SWR_SUSPEND_REQUESTED ; ( void ) cv_reltimedwait ( & sw . sw_cv , & sw . sw_mutex , halfsec_delay , TR_CLOCK_TICK ) ; } else { swr -> swr_what = SWR_SUSPENDED ; break ; } } for ( swr = sw . sw_head ; swr ; swr = swr -> swr_next ) { if ( swr -> swr_what != SWR_SUSPENDED ) { exit } } sw . sw_state = SW_SUSPENDED ; exit mutex_exit ( & sw . sw_mutex ) ; } 