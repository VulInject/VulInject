static int expire_conversations ( const mbentry_t * mbentry , void * rock ) { struct conversations_rock * crock = ( conversations_rock * ) rock ; struct conversations_state * state = NULL ; unsigned int nseen = 0 , ndeleted ; char * filename = NULL ; signals_poll ( ) ; if ( mbentry -> mbtype & MBTYPE_DELETED ) { done } if ( mbentry -> mbtype & MBTYPE_REMOTE ) { done } if ( mboxname_isdeletedmailbox ( mbentry -> name , NULL ) ) { done } filename = conversations_getmboxpath ( mbentry -> name ) ; if ( ! filename ) { done } if ( hash_lookup ( filename , & crock -> seen ) ) { done } verbosep ( "Pruning conversations from db %s" , filename ) ; if ( ! conversations_open_mbox ( mbentry -> name , 0 , & state ) ) { conversations_prune ( state , crock -> expire_mark , & nseen , & ndeleted ) ; conversations_commit ( & state ) ; libcyrus_run_delayed ( ) ; } hash_insert ( filename , ( void * ) 1 , & crock -> seen ) ; crock -> databases_seen ++ ; crock -> msgids_seen += nseen ; crock -> msgids_expired += ndeleted ; done free ( filename ) ; return 0 ; } 