static struct ali_drw_pmu_irq * __ali_drw_pmu_init_irq ( struct platform_device * pdev , int irq_num ) { int ret ; struct ali_drw_pmu_irq * irq ; list_for_each_entry ( , , ) { if ( irq -> irq_num == irq_num && refcount_inc_not_zero ( & irq -> refcount ) ) { return irq ; } } irq = kzalloc ( sizeof ( * irq ) , GFP_KERNEL ) ; if ( ! irq ) { return ERR_PTR ( - ENOMEM ) ; } irq -> cpu = smp_processor_id ( ) ; refcount_set ( & irq -> refcount , 1 ) ; ret = devm_request_irq ( & pdev -> dev , irq_num , ali_drw_pmu_isr , IRQF_SHARED , dev_name ( & pdev -> dev ) , irq ) ; if ( ret < 0 ) { dev_err ( & pdev -> dev , "Fail to request IRQ:%d ret:%d\n" , irq_num , ret ) ; out_free } ret = irq_set_affinity_hint ( irq_num , cpumask_of ( irq -> cpu ) ) ; if ( ret ) { out_free } ret = cpuhp_state_add_instance_nocalls ( ali_drw_cpuhp_state_num , & irq -> node ) ; if ( ret ) { out_free } irq -> irq_num = irq_num ; list_add ( & irq -> irqs_node , & ali_drw_pmu_irqs ) ; return irq ; out_free kfree ( irq ) ; return ERR_PTR ( ret ) ; } 