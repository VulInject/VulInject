static int max1027_probe ( struct spi_device * spi ) { int ret ; struct iio_dev * indio_dev ; struct max1027_state * st ; indio_dev = devm_iio_device_alloc ( & spi -> dev , sizeof ( * st ) ) ; if ( ! indio_dev ) { pr_err ( "Can't allocate iio device\n" ) ; return - ENOMEM ; } st = iio_priv ( indio_dev ) ; st -> spi = spi ; st -> info = & max1027_chip_info_tbl [ spi_get_device_id ( spi ) -> driver_data ] ; mutex_init ( & st -> lock ) ; init_completion ( & st -> complete ) ; indio_dev -> name = spi_get_device_id ( spi ) -> name ; indio_dev -> info = & max1027_info ; indio_dev -> modes = INDIO_DIRECT_MODE ; indio_dev -> num_channels = st -> info -> num_channels ; indio_dev -> available_scan_masks = st -> info -> available_scan_masks ; st -> buffer = devm_kmalloc_array ( & indio_dev -> dev , indio_dev -> num_channels , 2 , GFP_KERNEL ) ; if ( ! st -> buffer ) { return - ENOMEM ; } ret = devm_iio_triggered_buffer_setup ( & spi -> dev , indio_dev , & iio_pollfunc_store_time , & max1027_trigger_handler , NULL ) ; if ( ret < 0 ) { dev_err ( & indio_dev -> dev , "Failed to setup buffer\n" ) ; return ret ; } if ( spi -> irq ) { st -> trig = devm_iio_trigger_alloc ( & spi -> dev , "%s-trigger" , indio_dev -> name ) ; if ( ! st -> trig ) { ret = - ENOMEM ; dev_err ( & indio_dev -> dev , "Failed to allocate iio trigger\n" ) ; return ret ; } st -> trig -> ops = & max1027_trigger_ops ; iio_trigger_set_drvdata ( st -> trig , indio_dev ) ; ret = devm_iio_trigger_register ( & indio_dev -> dev , st -> trig ) ; if ( ret < 0 ) { dev_err ( & indio_dev -> dev , "Failed to register iio trigger\n" ) ; return ret ; } ret = devm_request_irq ( & spi -> dev , spi -> irq , max1027_handler , IRQF_TRIGGER_FALLING , spi -> dev . driver -> name , indio_dev ) ; if ( ret < 0 ) { dev_err ( & indio_dev -> dev , "Failed to allocate IRQ.\n" ) ; return ret ; } } st -> reg = MAX1027_RST_REG ; ret = spi_write ( st -> spi , & st -> reg , 1 ) ; if ( ret < 0 ) { dev_err ( & indio_dev -> dev , "Failed to reset the ADC\n" ) ; return ret ; } st -> reg = MAX1027_AVG_REG ; ret = spi_write ( st -> spi , & st -> reg , 1 ) ; if ( ret < 0 ) { dev_err ( & indio_dev -> dev , "Failed to configure averaging register\n" ) ; return ret ; } ret = max1027_enable_trigger ( indio_dev , false ) ; if ( ret ) { return ret ; } return devm_iio_device_register ( & spi -> dev , indio_dev ) ; } 