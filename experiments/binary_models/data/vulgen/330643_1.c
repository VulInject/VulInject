void AlterSetting ( Oid databaseid , Oid roleid , VariableSetStmt * setstmt ) { char * valuestr ; HeapTuple tuple ; Relation rel ; ScanKeyData scankey [ 2 ] ; SysScanDesc scan ; valuestr = ExtractSetVariableArgs ( setstmt ) ; rel = table_open ( DbRoleSettingRelationId , RowExclusiveLock ) ; ScanKeyInit ( & scankey [ 0 ] , Anum_pg_db_role_setting_setdatabase , BTEqualStrategyNumber , F_OIDEQ , ObjectIdGetDatum ( databaseid ) ) ; ScanKeyInit ( & scankey [ 1 ] , Anum_pg_db_role_setting_setrole , BTEqualStrategyNumber , F_OIDEQ , ObjectIdGetDatum ( roleid ) ) ; scan = systable_beginscan ( rel , DbRoleSettingDatidRolidIndexId , true , NULL , 2 , scankey ) ; tuple = systable_getnext ( scan ) ; if ( HeapTupleIsValid ( tuple ) ) { Datum repl_val [ Natts_pg_db_role_setting ] ; bool repl_null [ Natts_pg_db_role_setting ] ; bool repl_repl [ Natts_pg_db_role_setting ] ; HeapTuple newtuple ; Datum datum ; Datum usersetDatum ; bool isnull ; bool usersetIsnull ; ArrayType * a ; ArrayType * usersetArray ; memset ( repl_repl , false , sizeof ( repl_repl ) ) ; repl_repl [ Anum_pg_db_role_setting_setconfig - 1 ] = true ; repl_null [ Anum_pg_db_role_setting_setconfig - 1 ] = false ; repl_repl [ Anum_pg_db_role_setting_setuser - 1 ] = true ; repl_null [ Anum_pg_db_role_setting_setuser - 1 ] = false ; datum = heap_getattr ( tuple , Anum_pg_db_role_setting_setconfig , RelationGetDescr ( rel ) , & isnull ) ; a = isnull ?NULL : DatumGetArrayTypeP ( datum ) ; usersetDatum = heap_getattr ( tuple , Anum_pg_db_role_setting_setuser , RelationGetDescr ( rel ) , & usersetIsnull ) ; usersetArray = usersetIsnull ?NULL : DatumGetArrayTypeP ( usersetDatum ) ; if ( valuestr ) { a = GUCArrayAdd ( a , & usersetArray , setstmt -> name , valuestr , setstmt -> user_set ) ; } else { a = GUCArrayDelete ( a , & usersetArray , setstmt -> name ) ; } if ( a ) { repl_val [ Anum_pg_db_role_setting_setconfig - 1 ] = PointerGetDatum ( a ) ; repl_val [ Anum_pg_db_role_setting_setuser - 1 ] = PointerGetDatum ( usersetArray ) ; newtuple = heap_modify_tuple ( tuple , RelationGetDescr ( rel ) , repl_val , repl_null , repl_repl ) ; CatalogTupleUpdate ( rel , & tuple -> t_self , newtuple ) ; } else { CatalogTupleDelete ( rel , & tuple -> t_self ) ; } } if ( valuestr ) { HeapTuple newtuple ; Datum values [ Natts_pg_db_role_setting ] ; bool nulls [ Natts_pg_db_role_setting ] ; ArrayType * a , * usersetArray ; memset ( nulls , false , sizeof ( nulls ) ) ; a = GUCArrayAdd ( NULL , & usersetArray , setstmt -> name , valuestr , setstmt -> user_set ) ; values [ Anum_pg_db_role_setting_setdatabase - 1 ] = ObjectIdGetDatum ( databaseid ) ; values [ Anum_pg_db_role_setting_setrole - 1 ] = ObjectIdGetDatum ( roleid ) ; values [ Anum_pg_db_role_setting_setconfig - 1 ] = PointerGetDatum ( a ) ; values [ Anum_pg_db_role_setting_setuser - 1 ] = PointerGetDatum ( usersetArray ) ; newtuple = heap_form_tuple ( RelationGetDescr ( rel ) , values , nulls ) ; CatalogTupleInsert ( rel , newtuple ) ; } InvokeObjectPostAlterHookArg ( DbRoleSettingRelationId , databaseid , 0 , roleid , false ) ; systable_endscan ( scan ) ; table_close ( rel , NoLock ) ; } 