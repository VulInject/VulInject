void pmcs_scsa_cq_run ( void * arg ) { pmcs_cq_thr_info_t * cqti = ( pmcs_cq_thr_info_t * ) arg ; pmcs_hw_t * pwp = cqti -> cq_pwp ; pmcs_cmd_t * sp , * nxt ; struct scsi_pkt * pkt ; pmcs_xscsi_t * tgt ; pmcs_iocomp_cb_t * ioccb , * ioccb_next ; pmcs_cb_t callback ; DTRACE_PROBE1 ( pmcs__scsa__cq__run__start , pmcs_cq_thr_info_t * , cqti ) ; mutex_enter ( & pwp -> cq_lock ) ; while ( ! pwp -> cq_info . cq_stop ) { ioccb = pwp -> iocomp_cb_head ; pwp -> iocomp_cb_head = NULL ; pwp -> iocomp_cb_tail = NULL ; mutex_exit ( & pwp -> cq_lock ) ; while ( ioccb ) { mutex_enter ( & ioccb -> pwrk -> lock ) ; ioccb_next = ioccb -> next ; callback = ( pmcs_cb_t ) ioccb -> pwrk -> ptr ; * callback ( pwp , ioccb -> pwrk , ( uint32_t * ) ( ( void * ) ioccb -> iomb ) ) ; ioccb = ioccb_next ; } mutex_enter ( & pwp -> cq_lock ) ; sp = STAILQ_FIRST ( & pwp -> cq ) ; STAILQ_INIT ( & pwp -> cq ) ; mutex_exit ( & pwp -> cq_lock ) ; DTRACE_PROBE1 ( pmcs__scsa__cq__run__start__loop , pmcs_cq_thr_info_t * , cqti ) ; if ( sp && pmcs_check_acc_dma_handle ( pwp ) ) { ddi_fm_service_impact ( pwp -> dip , DDI_SERVICE_UNAFFECTED ) ; } while ( sp ) { nxt = STAILQ_NEXT ( sp , cmd_next ) ; pkt = CMD2PKT ( sp ) ; tgt = sp -> cmd_target ; pmcs_prt ( pwp , PMCS_PRT_DEBUG3 , NULL , tgt , "%s: calling completion on %p for tgt %p" , __func__ , ( void * ) sp , ( void * ) tgt ) ; if ( tgt ) { mutex_enter ( & tgt -> statlock ) ; ASSERT ( tgt -> actv_pkts != 0 ) ; tgt -> actv_pkts -- ; mutex_exit ( & tgt -> statlock ) ; } scsi_hba_pkt_comp ( pkt ) ; sp = nxt ; } DTRACE_PROBE1 ( pmcs__scsa__cq__run__end__loop , pmcs_cq_thr_info_t * , cqti ) ; mutex_enter ( & pwp -> cq_lock ) ; if ( ( pwp -> iocomp_cb_head == NULL ) && STAILQ_EMPTY ( & pwp -> cq ) && ! pwp -> cq_info . cq_stop ) { mutex_exit ( & pwp -> cq_lock ) ; mutex_enter ( & cqti -> cq_thr_lock ) ; cv_wait ( & cqti -> cq_cv , & cqti -> cq_thr_lock ) ; mutex_exit ( & cqti -> cq_thr_lock ) ; mutex_enter ( & pwp -> cq_lock ) ; } } mutex_exit ( & pwp -> cq_lock ) ; DTRACE_PROBE1 ( pmcs__scsa__cq__run__stop , pmcs_cq_thr_info_t * , cqti ) ; thread_exit ( ) ; } 