static GF_Err BD_DecIndexInsert ( GF_BifsDecoder * codec , GF_BitStream * bs ) { GF_Err e ; u32 NodeID ; u32 NumBits , ind , field_ind ; u8 type ; s32 pos ; GF_Node * def ; GF_FieldInfo field , sffield ; NodeID = 1 + gf_bs_read_int ( bs , codec -> info -> config . NodeIDBits ) ; def = gf_sg_find_node ( codec -> current_graph , NodeID ) ; if ( ! def ) { return GF_NON_COMPLIANT_BITSTREAM ; } NumBits = gf_get_bit_size ( gf_node_get_num_fields_in_mode ( def , GF_SG_FIELD_CODING_IN ) - 1 ) ; ind = gf_bs_read_int ( bs , NumBits ) ; e = gf_bifs_get_field_index ( def , ind , GF_SG_FIELD_CODING_IN , & field_ind ) ; if ( e ) { return e ; } type = gf_bs_read_int ( bs , 2 ) ; switch ( type ) { case 0 : pos = gf_bs_read_int ( bs , 16 ) ; break ; case 2 : pos = 0 ; break ; case 3 : pos = - 1 ; break ; default : return GF_NON_COMPLIANT_BITSTREAM ; } e = gf_node_get_field ( def , field_ind , & field ) ; if ( e ) { return e ; } if ( gf_sg_vrml_is_sf_field ( field . fieldType ) ) { return GF_NON_COMPLIANT_BITSTREAM ; } memcpy ( & sffield , & field , sizeof ( GF_FieldInfo ) ) ; sffield . fieldType = gf_sg_vrml_get_sf_type ( field . fieldType ) ; if ( field . fieldType == GF_SG_VRML_MFNODE ) { GF_Node * node = gf_bifs_dec_node ( codec , bs , field . NDTtype ) ; e = gf_node_register ( node , def ) ; if ( e ) { return e ; } if ( pos == - 1 ) { e = gf_node_list_add_child ( ( GF_ChildNodeItem * * ) field . far_ptr , node ) ; } else { e = gf_node_list_insert_child ( ( GF_ChildNodeItem * * ) field . far_ptr , node , pos ) ; } if ( ! e ) { gf_bifs_check_field_change ( def , & field ) ; } } else { if ( pos == - 1 ) { e = gf_sg_vrml_mf_append ( field . far_ptr , field . fieldType , & sffield . far_ptr ) ; } else { e = gf_sg_vrml_mf_insert ( field . far_ptr , field . fieldType , & sffield . far_ptr , pos ) ; } if ( e ) { return e ; } e = gf_bifs_dec_sf_field ( codec , bs , def , & sffield , GF_FALSE ) ; if ( ! e ) { gf_bifs_check_field_change ( def , & field ) ; } } return e ; } 