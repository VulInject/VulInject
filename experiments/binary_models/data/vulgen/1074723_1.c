gimp_extension_load ( , ) { AsApp * app ; GPtrArray * extends ; GPtrArray * requires ; AsRelease * release ; gchar * appdata_name ; gchar * path ; gboolean success = FALSE ; gboolean has_require = FALSE ; g_clear_object ( & extension -> p -> app ) ; appdata_name = g_strdup_printf ( "%s.metainfo.xml" , gimp_object_get_name ( GIMP_OBJECT ( extension ) ) ) ; path = g_build_filename ( extension -> p -> path , appdata_name , NULL ) ; app = as_app_new ( ) ; success = as_app_parse_file ( app , path , AS_APP_PARSE_FLAG_USE_HEURISTICS , error ) ; if ( success && as_app_get_kind ( app ) != AS_APP_KIND_ADDON ) { if ( error && * error == NULL ) { * error = g_error_new ( GIMP_EXTENSION_ERROR , GIMP_EXTENSION_BAD_APPDATA , _ ( "Extension AppData must be of type \"addon\", found \"%s\" instead." ) , as_app_kind_to_string ( as_app_get_kind ( app ) ) ) ; } success = FALSE ; } extends = as_app_get_extends ( app ) ; if ( success && ! g_ptr_array_find_with_equal_func ( extends , "org.gimp.GIMP" , g_str_equal , NULL ) ) { if ( error && * error == NULL ) { * error = g_error_new ( GIMP_EXTENSION_ERROR , GIMP_EXTENSION_BAD_APPDATA , _ ( "Extension AppData must extend \"org.gimp.GIMP\"." ) ) ; } success = FALSE ; } if ( success && g_strcmp0 ( as_app_get_id ( app ) , gimp_object_get_name ( extension ) ) != 0 ) { if ( error && * error == NULL ) { * error = g_error_new ( GIMP_EXTENSION_ERROR , GIMP_EXTENSION_FAILED , _ ( "Extension AppData id (\"%s\") and directory (\"%s\") must be the same." ) , as_app_get_id ( app ) , gimp_object_get_name ( extension ) ) ; } success = FALSE ; } release = as_app_get_release_default ( app ) ; if ( success && ( ! release || ! as_release_get_version ( release ) ) ) { if ( error && * error == NULL ) { * error = g_error_new ( GIMP_EXTENSION_ERROR , GIMP_EXTENSION_NO_VERSION , _ ( "Extension AppData must advertise a version in a<release>tag." ) ) ; } success = FALSE ; } requires = as_app_get_requires ( app ) ; if ( success && requires ) { gint i ; for ( i = 0 ; i < requires -> len ; i ++ ) { AsRequire * require = g_ptr_array_index ( requires , i ) ; if ( as_require_get_kind ( require ) == AS_REQUIRE_KIND_ID && g_strcmp0 ( as_require_get_value ( require ) , "org.gimp.GIMP" ) == 0 ) { has_require = TRUE ; if ( ! as_require_version_compare ( require , GIMP_VERSION , error ) ) { success = FALSE ; break ; } } if ( error && * error == NULL ) { * error = g_error_new ( GIMP_EXTENSION_ERROR , GIMP_EXTENSION_FAILED , _ ( "Unsupported<requires>\"%s\" (type %s)." ) , as_require_get_value ( require ) , as_require_kind_to_string ( as_require_get_kind ( require ) ) ) ; success = FALSE ; break ; } } } if ( ! has_require ) { success = FALSE ; if ( error && * error == NULL ) { * error = g_error_new ( GIMP_EXTENSION_ERROR , GIMP_EXTENSION_FAILED , _ ( "<requires><id>org.gimp.GIMP</id></requires>for version comparison is mandatory." ) ) ; } } if ( success ) { extension -> p -> app = app ; } else { g_object_unref ( app ) ; } return success ; } 