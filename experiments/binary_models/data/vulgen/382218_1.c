unsigned int cm_get_qspi_controller_clk_hz ( void ) { u32 reg , clock ; reg = readl ( socfpga_get_clkmgr_addr ( ) + CLKMGR_GEN5_PERPLL_SRC ) ; reg = ( reg & CLKMGR_PERPLLGRP_SRC_QSPI_MASK ) >> CLKMGR_PERPLLGRP_SRC_QSPI_OFFSET ; if ( reg == CLKMGR_QSPI_CLK_SRC_F2S ) { clock = cm_get_f2s_per_ref_clk_hz ( ) ; } if ( reg == CLKMGR_QSPI_CLK_SRC_MAIN ) { clock = cm_get_main_vco_clk_hz ( ) ; reg = readl ( socfpga_get_clkmgr_addr ( ) + CLKMGR_GEN5_MAINPLL_MAINQSPICLK ) ; clock /= ( reg + 1 ) ; } if ( reg == CLKMGR_QSPI_CLK_SRC_PER ) { clock = cm_get_per_vco_clk_hz ( ) ; reg = readl ( socfpga_get_clkmgr_addr ( ) + CLKMGR_GEN5_PERPLL_PERQSPICLK ) ; clock /= ( reg + 1 ) ; } return clock ; } 