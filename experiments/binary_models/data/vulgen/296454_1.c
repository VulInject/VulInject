static int octeon_bootcmd_getc ( struct udevice * dev ) { struct octeon_bootcmd_priv * priv = dev_get_priv ( dev ) ; char c ; if ( priv -> eol ) { priv -> eol = false ; return '\n' ; } while ( ! octeon_bootcmd_pending ( dev , true ) ) { schedule ( ) ; udelay ( 100 ) ; } c = priv -> buf -> data [ priv -> copy_offset ] ; priv -> buf -> data [ priv -> copy_offset ++ ] = '\0' ; if ( priv -> copy_offset >= min_t ( int , CONFIG_SYS_CBSIZE - 1 , BOOTLOADER_PCI_READ_BUFFER_STR_LEN - 1 ) || ( priv -> buf -> data [ priv -> copy_offset ] == '\0' ) ) { priv -> copy_offset = 0 ; priv -> buf -> len = 0 ; priv -> buf -> owner = OCTEON_PCI_IO_BUF_OWNER_HOST ; priv -> eol = true ; } return c ; } static const struct dm_serial_ops octeon_bootcmd_ops = { . getc = octeon_bootcmd_getc . pending = octeon_bootcmd_pending } ; 