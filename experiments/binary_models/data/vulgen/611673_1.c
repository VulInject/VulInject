int setup_purgatory ( struct kimage * image , const void * slave_code , const void * fdt , unsigned long kernel_load_addr , unsigned long fdt_load_addr ) { unsigned int * slave_code_buf , master_entry ; int ret ; slave_code_buf = kmalloc ( SLAVE_CODE_SIZE , GFP_KERNEL ) ; if ( ! slave_code_buf ) { return - ENOMEM ; } ret = kexec_purgatory_get_set_symbol ( image , "purgatory_start" , slave_code_buf , SLAVE_CODE_SIZE , true ) ; if ( ret ) { return ret ; } master_entry = slave_code_buf [ 0 ] ; memcpy ( slave_code_buf , slave_code , SLAVE_CODE_SIZE ) ; slave_code_buf [ 0 ] = master_entry ; ret = kexec_purgatory_get_set_symbol ( image , "purgatory_start" , slave_code_buf , SLAVE_CODE_SIZE , false ) ; kfree ( slave_code_buf ) ; ret = kexec_purgatory_get_set_symbol ( image , "kernel" , & kernel_load_addr , sizeof ( kernel_load_addr ) , false ) ; if ( ret ) { return ret ; } ret = kexec_purgatory_get_set_symbol ( image , "dt_offset" , & fdt_load_addr , sizeof ( fdt_load_addr ) , false ) ; if ( ret ) { return ret ; } return 0 ; } 