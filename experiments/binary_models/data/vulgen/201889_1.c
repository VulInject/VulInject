static void c_can_do_tx ( struct net_device * dev ) { struct c_can_priv * priv = netdev_priv ( dev ) ; struct c_can_tx_ring * tx_ring = & priv -> tx ; struct net_device_stats * stats = & dev -> stats ; u32 idx , obj , pkts = 0 , bytes = 0 , pend ; u8 tail ; if ( priv -> msg_obj_tx_last > 32 ) { pend = priv -> read_reg32 ( priv , C_CAN_INTPND3_REG ) ; } else { pend = priv -> read_reg ( priv , C_CAN_INTPND2_REG ) ; } while ( ( idx = ffs ( pend ) ) ) { idx -- ; pend &= ~ BIT ( idx ) ; obj = idx + priv -> msg_obj_tx_first ; c_can_inval_tx_object ( dev , IF_NAPI , obj ) ; bytes += can_get_echo_skb ( dev , idx , NULL ) ; pkts ++ ; } tx_ring -> tail += pkts ; if ( c_can_get_tx_free ( priv , tx_ring ) ) { smp_mb ( ) ; netif_wake_queue ( priv -> dev ) ; } stats -> tx_bytes += bytes ; stats -> tx_packets += pkts ; tail = c_can_get_tx_tail ( tx_ring ) ; if ( priv -> type == BOSCH_D_CAN && tail == 0 ) { u8 head = c_can_get_tx_head ( tx_ring ) ; for ( idx = tail ; idx < head ; idx ++ ) { obj = idx + priv -> msg_obj_tx_first ; c_can_object_put ( dev , IF_NAPI , obj , IF_COMM_TXRQST ) ; } } } 