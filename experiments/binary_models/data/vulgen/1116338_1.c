static ssize_t hycon_hy46xx_setting_show ( struct device * dev , struct device_attribute * dattr , char * buf ) { struct i2c_client * client = to_i2c_client ( dev ) ; struct hycon_hy46xx_data * tsdata = i2c_get_clientdata ( client ) ; struct hycon_hy46xx_attribute * attr = container_of ( dattr , hycon_hy46xx_attribute , dattr ) ; u8 * field = ( u8 * ) tsdata + attr -> field_offset ; int error ; int error = 0 ; int val ; mutex_lock ( & tsdata -> mutex ) ; error = regmap_read ( tsdata -> regmap , attr -> address , & val ) ; if ( error < 0 ) { dev_err ( & tsdata -> client -> dev , "Failed to fetch attribute %s, error %d\n" , dattr -> attr . name , error ) ; out } if ( val != * field ) { dev_warn ( & tsdata -> client -> dev , "%s: read (%d) and stored value (%d) differ\n" , dattr -> attr . name , val , * field ) ; * field = val ; } count = scnprintf ( buf , PAGE_SIZE , "%d\n" , val ) ; out mutex_unlock ( & tsdata -> mutex ) ; return error ?: count ; } 