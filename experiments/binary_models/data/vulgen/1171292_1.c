static struct mpic * __init pmac_setup_one_mpic ( struct device_node * np , int master ) { const char * name = master ?" MPIC 1   " : " MPIC 2   " ; struct mpic * mpic ; unsigned int flags = master ?0 : MPIC_SECONDARY ; pmac_call_feature ( PMAC_FTR_ENABLE_MPIC , np , 0 , 0 ) ; if ( of_get_property ( np , "big-endian" , NULL ) ) { flags |= MPIC_BIG_ENDIAN ; } if ( master && ( flags & MPIC_BIG_ENDIAN ) ) { flags |= MPIC_U3_HT_IRQS ; } mpic = mpic_alloc ( np , 0 , flags , 0 , 0 , name ) ; if ( mpic == NULL ) { return NULL ; } mpic_init ( mpic ) ; return mpic ; } static int __init pmac_pic_probe_mpic ( void ) { struct mpic * mpic1 , * mpic2 ; struct device_node * np , * master = NULL , * slave = NULL ; for ( np = NULL ; ( np = of_find_node_by_type ( np , "open-pic" ) ) != NULL ; ) { if ( master == NULL && of_get_property ( np , "interrupts" , NULL ) == NULL ) { master = of_node_get ( np ) ; } if ( slave == NULL ) { slave = of_node_get ( np ) ; } if ( master && slave ) { break ; } } if ( master == NULL && slave != NULL ) { master = slave ; slave = NULL ; } ppc_md . get_irq = mpic_get_irq ; mpic1 = pmac_setup_one_mpic ( master , 1 ) ; BUG_ON ( mpic1 == NULL ) ; pmac_pic_setup_mpic_nmi ( mpic1 ) ; of_node_put ( master ) ; if ( slave ) { mpic2 = pmac_setup_one_mpic ( slave , 0 ) ; if ( mpic2 == NULL ) { printk ( KERN_ERR "Failed to setup slave MPIC\n" ) ; } of_node_put ( slave ) ; } return 0 ; } 