static void ipmi_po_smi_gone ( int if_num ) { if ( ipmi_ifnum != if_num ) { return ; } ready = 0 ; ipmi_destroy_user ( ipmi_user ) ; pm_power_off = old_poweroff_func ; } static struct ipmi_smi_watcher smi_watcher = { . owner = THIS_MODULE . new_smi = ipmi_po_new_smi . smi_gone = ipmi_po_smi_gone } ; static struct ctl_table ipmi_table [ ] { { . procname = "poweroff_powercycle" . data = & poweroff_powercycle . maxlen = sizeof ( poweroff_powercycle ) . mode = 0644 . proc_handler = proc_dointvec } { } } ; ; static struct ctl_table ipmi_dir_table [ ] { { . procname = "ipmi" . mode = 0555 . child = ipmi_table } { } } ; ; static struct ctl_table ipmi_root_table [ ] { { . procname = "dev" . mode = 0555 . child = ipmi_dir_table } { } } ; ; static struct ctl_table_header * ipmi_table_header ; static int __init ipmi_poweroff_init ( void ) { int rv ; pr_info ( "Copyright (C) 2004 MontaVista Software - IPMI Powerdown via sys_reboot\n" ) ; if ( poweroff_powercycle ) { pr_info ( "Power cycle is enabled\n" ) ; } ipmi_table_header = register_sysctl_table ( ipmi_root_table ) ; if ( ! ipmi_table_header ) { pr_err ( "Unable to register powercycle sysctl\n" ) ; rv = - ENOMEM ; out_err } rv = ipmi_smi_watcher_register ( & smi_watcher ) ; if ( rv ) { unregister_sysctl_table ( ipmi_table_header ) ; pr_err ( "Unable to register SMI watcher: %d\n" , rv ) ; out_err } out_err return rv ; } 