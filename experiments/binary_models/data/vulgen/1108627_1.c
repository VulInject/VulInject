int aac_hba_send ( u8 command , struct fib * fibptr , fib_callback callback , void * callback_data ) { struct aac_dev * dev = fibptr -> dev ; int wait ; unsigned long flags = 0 ; unsigned long mflags = 0 ; fibptr -> flags = ( FIB_CONTEXT_FLAG | FIB_CONTEXT_FLAG_NATIVE_HBA ) ; if ( callback ) { wait = 0 ; fibptr -> callback = callback ; fibptr -> callback_data = callback_data ; } else { wait = 1 ; } if ( command == HBA_IU_TYPE_SCSI_CMD_REQ ) { struct aac_hba_cmd_req * hbacmd = ( aac_hba_cmd_req * ) fibptr -> hw_fib_va ; hbacmd -> iu_type = command ; hbacmd -> request_id = cpu_to_le32 ( ( ( ( u32 ) ( fibptr - dev -> fibs ) ) << 2 ) + 1 ) ; } else { return - EINVAL ; } if ( wait ) { spin_lock_irqsave ( & dev -> manage_lock , mflags ) ; if ( dev -> management_fib_count >= AAC_NUM_MGT_FIB ) { spin_unlock_irqrestore ( & dev -> manage_lock , mflags ) ; return - EBUSY ; } dev -> management_fib_count ++ ; spin_unlock_irqrestore ( & dev -> manage_lock , mflags ) ; spin_lock_irqsave ( & fibptr -> event_lock , flags ) ; } if ( aac_adapter_deliver ( fibptr ) != 0 ) { if ( wait ) { spin_lock_irqsave ( & dev -> manage_lock , mflags ) ; dev -> management_fib_count -- ; spin_unlock_irqrestore ( & dev -> manage_lock , mflags ) ; } return - EBUSY ; } FIB_COUNTER_INCREMENT ( aac_config . NativeSent ) ; if ( wait ) { spin_unlock_irqrestore ( & fibptr -> event_lock , flags ) ; if ( aac_check_eeh_failure ( dev ) ) { return - EFAULT ; } if ( down_interruptible ( & fibptr -> event_wait ) ) { fibptr -> done = 2 ; up ( & fibptr -> event_wait ) ; } spin_lock_irqsave ( & fibptr -> event_lock , flags ) ; if ( ( fibptr -> done == 0 ) || ( fibptr -> done == 2 ) ) { fibptr -> done = 2 ; spin_unlock_irqrestore ( & fibptr -> event_lock , flags ) ; return - ERESTARTSYS ; } spin_unlock_irqrestore ( & fibptr -> event_lock , flags ) ; WARN_ON ( fibptr -> done == 0 ) ; if ( unlikely ( fibptr -> flags & FIB_CONTEXT_FLAG_TIMED_OUT ) ) { return - ETIMEDOUT ; } return 0 ; } return - EINPROGRESS ; } 