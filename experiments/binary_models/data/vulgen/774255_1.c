static void check_utmpx ( struct utmpx * entryx ) { char buf [ BUF_SIZE ] ; char * line = buf ; struct passwd * pwd ; int uid ; int hostlen ; char * user ; uid_t ruid = getuid ( ) ; ( void ) memset ( buf , 0 , BUF_SIZE ) ; user = malloc ( sizeof ( entryx -> ut_user ) + 1 ) ; user [ sizeof ( entryx -> ut_user ) ] = '\0' ; pwd = getpwnam ( user ) ; ( void ) free ( user ) ; ( void ) strlcat ( strcpy ( buf , "/dev/" ) , entryx -> ut_line , sizeof ( buf ) ) ; if ( pwd != ( passwd * ) NULL ) { uid = pwd -> pw_uid ; if ( ruid != uid ) { dprintf3 ( "Bad uid: user %s  = %d uid = %d \n" , entryx -> ut_user , uid , getuid ( ) ) ; exit ( ILLEGAL_ARGUMENT ) ; } } if ( entryx -> ut_type != DEAD_PROCESS ) { dprintf ( "Bad user name: %s \n" , entryx -> ut_user ) ; exit ( ILLEGAL_ARGUMENT ) ; } if ( ! ( entryx -> ut_type == USER_PROCESS || entryx -> ut_type == DEAD_PROCESS ) ) { dprintf ( "Bad type type = %d\n" , entryx -> ut_type ) ; exit ( ILLEGAL_ARGUMENT ) ; } if ( entryx -> ut_type == USER_PROCESS && entryx -> ut_pid != getppid ( ) ) { dprintf ( "Bad pid = %d\n" , entryx -> ut_pid ) ; exit ( ILLEGAL_ARGUMENT ) ; } if ( bad_line ( line ) == 1 ) { dprintf ( "Bad line = %s\n" , line ) ; exit ( ILLEGAL_ARGUMENT ) ; } hostlen = strlen ( entryx -> ut_host ) + 1 ; if ( entryx -> ut_syslen != hostlen ) { dprintf3 ( "Bad syslen of \"%s\" = %d - correcting to %d\n" , entryx -> ut_host , entryx -> ut_syslen , hostlen ) ; entryx -> ut_syslen = hostlen ; } if ( bad_hostname ( entryx -> ut_host , entryx -> ut_syslen ) == 1 ) { dprintf ( "Bad hostname name = %s\n" , entryx -> ut_host ) ; exit ( ILLEGAL_ARGUMENT ) ; } check_id ( entryx -> ut_id , entryx -> ut_line ) ; } 