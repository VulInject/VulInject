ssize_t tomoyo_read_control ( struct tomoyo_io_buffer * head , char __user * buffer , const int buffer_len ) { int len ; int idx ; if ( ! head -> read ) { return - ENOSYS ; } head -> read_user_buf = buffer ; head -> read_user_buf_avail = buffer_len ; idx = tomoyo_read_lock ( ) ; if ( tomoyo_flush ( head ) ) { { tomoyo_set_namespace_cursor ( head ) ; head -> read ( head ) ; } tomoyo_flush ( head ) && tomoyo_has_more_namespace ( head ) ; } tomoyo_read_unlock ( idx ) ; len = head -> read_user_buf - buffer ; mutex_unlock ( & head -> io_sem ) ; return len ; } 