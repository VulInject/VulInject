static int dm_crypt_integrity_io_alloc ( struct dm_crypt_io * io , struct bio * bio ) { struct bio_integrity_payload * bip ; unsigned int tag_len ; int ret ; bip = bio_integrity_alloc ( bio , GFP_NOIO , 1 ) ; if ( IS_ERR ( bip ) ) { return PTR_ERR ( bip ) ; } tag_len = io -> cc -> on_disk_tag_size * bio_sectors ( bio ) ; bip -> bip_iter . bi_size = tag_len ; bip -> bip_iter . bi_sector = io -> cc -> start + io -> sector ; bip -> bip_flags &= ~ BIP_BLOCK_INTEGRITY ; ret = bio_integrity_add_page ( bio , virt_to_page ( io -> integrity_metadata ) , tag_len , offset_in_page ( io -> integrity_metadata ) ) ; if ( unlikely ( ret != tag_len ) ) { return - ENOMEM ; } return 0 ; } 