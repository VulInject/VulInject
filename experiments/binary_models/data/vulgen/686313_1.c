void kmem_setup ( void ) { kvm_t * kd_kern ; char errbuf [ _POSIX2_LINE_MAX ] ; int i , hdrsz ; kd_kern = kvm_openfiles ( NULL , NULL , NULL , O_RDONLY , errbuf ) ; if ( kd_kern == NULL ) { syslog ( LOG_ERR , "%s: kvm_openfiles: %s" , _PATH_UNIX , errbuf ) ; exit ( 1 ) ; } if ( kvm_nlist ( kd_kern , current_nl ) == - 1 ) { syslog ( LOG_ERR , "%s: kvm_nlist: %s" , _PATH_UNIX , kvm_geterr ( kd_kern ) ) ; } for ( i = 0 ; cursyms [ i ] != - 1 ; i ++ ) { if ( current_nl [ cursyms [ i ] ] . n_value == 0 ) { syslog ( LOG_ERR , "%s: %s not in namelist" , _PATH_UNIX , current_nl [ cursyms [ i ] ] . n_name ) ; exit ( 1 ) ; } } ( void ) KREAD ( kd_kern , current_nl [ X_DUMPDEV ] . n_value , & dumpdev ) ; if ( dumpdev == NODEV ) { syslog ( LOG_WARNING , "no core dump (no dumpdev)" ) ; exit ( 1 ) ; } ( void ) KREAD ( kd_kern , current_nl [ X_DUMPLO ] . n_value , & dumplo ) ; dumpoff = ( off_t ) dumplo * DEV_BSIZE ; if ( verbose ) { ( void ) printf ( "dumpoff = %lld (%ld * %d)\n" , ( long long ) dumpoff , dumplo , DEV_BSIZE ) ; } ( void ) KREAD ( kd_kern , current_nl [ X_DUMPMAG ] . n_value , & dumpmag ) ; if ( kernel == NULL ) { if ( kvm_read ( kd_kern , current_nl [ X_VERSION ] . n_value , vers , sizeof ( vers ) ) == - 1 ) { syslog ( LOG_ERR , "%s: kvm_read: version misread" , _PATH_UNIX ) ; exit ( 1 ) ; } vers [ sizeof ( vers ) - 1 ] = '\0' ; } ddname = find_dev ( dumpdev , S_IFBLK ) ; dumpfd = open ( ddname , O_RDWR ) ; if ( dumpfd == - 1 ) { syslog ( LOG_ERR , "%s: %m" , ddname ) ; exit ( 1 ) ; } dump_sys = kernel ?kernel : _PATH_UNIX ; kd_dump = kvm_openfiles ( kernel , ddname , NULL , O_RDWR , errbuf ) ; if ( kvm_nlist ( kd_dump , dump_nl ) == - 1 ) { syslog ( LOG_ERR , "%s: kvm_nlist: %s" , dump_sys , kvm_geterr ( kd_dump ) ) ; } for ( i = 0 ; dumpsyms [ i ] != - 1 ; i ++ ) { if ( dump_nl [ dumpsyms [ i ] ] . n_value == 0 ) { syslog ( LOG_ERR , "%s: %s not in namelist" , dump_sys , dump_nl [ dumpsyms [ i ] ] . n_name ) ; exit ( 1 ) ; } } hdrsz = kvm_dump_mkheader ( kd_dump , dumpoff ) ; if ( hdrsz == - 1 ) { if ( verbose ) { syslog ( LOG_ERR , "%s: kvm_dump_mkheader: %s" , dump_sys , kvm_geterr ( kd_dump ) ) ; } syslog ( LOG_WARNING , "no core dump" ) ; exit ( 1 ) ; } dumpoff += hdrsz ; kvm_close ( kd_kern ) ; } 