void bnx2fc_init_task ( struct bnx2fc_cmd * io_req , struct fcoe_task_ctx_entry * task ) { u8 task_type ; struct scsi_cmnd * sc_cmd = io_req -> sc_cmd ; struct io_bdt * bd_tbl = io_req -> bd_tbl ; struct bnx2fc_rport * tgt = io_req -> tgt ; struct fcoe_cached_sge_ctx * cached_sge ; struct fcoe_ext_mul_sges_ctx * sgl ; int dev_type = tgt -> dev_type ; u64 * fcp_cmnd ; u64 tmp_fcp_cmnd [ 4 ] ; u32 context_id ; int cnt , i ; int bd_count ; memset ( task , 0 , sizeof ( fcoe_task_ctx_entry ) ) ; io_req -> task = task ; if ( sc_cmd -> sc_data_direction == DMA_TO_DEVICE ) { task_type = FCOE_TASK_TYPE_WRITE ; } else { task_type = FCOE_TASK_TYPE_READ ; } bd_count = bd_tbl -> bd_valid ; cached_sge = & task -> rxwr_only . union_ctx . read_info . sgl_ctx . cached_sge ; if ( task_type == FCOE_TASK_TYPE_WRITE ) { if ( ( dev_type == TYPE_DISK ) && ( bd_count == 1 ) ) { struct fcoe_bd_ctx * fcoe_bd_tbl = bd_tbl -> bd_tbl ; task -> txwr_only . sgl_ctx . cached_sge . cur_buf_addr . lo = cached_sge -> cur_buf_addr . lo = fcoe_bd_tbl -> buf_addr_lo ; task -> txwr_only . sgl_ctx . cached_sge . cur_buf_addr . hi = cached_sge -> cur_buf_addr . hi = fcoe_bd_tbl -> buf_addr_hi ; task -> txwr_only . sgl_ctx . cached_sge . cur_buf_rem = cached_sge -> cur_buf_rem = fcoe_bd_tbl -> buf_len ; task -> txwr_rxrd . const_ctx . init_flags |= 1 << FCOE_TCE_TX_WR_RX_RD_CONST_CACHED_SGE_SHIFT ; } else { task -> txwr_only . sgl_ctx . sgl . mul_sgl . cur_sge_addr . lo = ( u32 ) bd_tbl -> bd_tbl_dma ; task -> txwr_only . sgl_ctx . sgl . mul_sgl . cur_sge_addr . hi = ( u32 ) ( ( u64 ) bd_tbl -> bd_tbl_dma >> 32 ) ; task -> txwr_only . sgl_ctx . sgl . mul_sgl . sgl_size = bd_tbl -> bd_valid ; } } task -> txwr_rxrd . const_ctx . init_flags |= task_type << FCOE_TCE_TX_WR_RX_RD_CONST_TASK_TYPE_SHIFT ; if ( dev_type == TYPE_TAPE ) { task -> txwr_rxrd . const_ctx . init_flags |= FCOE_TASK_DEV_TYPE_TAPE << FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT ; io_req -> rec_retry = 0 ; io_req -> rec_retry = 0 ; } else { task -> txwr_rxrd . const_ctx . init_flags |= FCOE_TASK_DEV_TYPE_DISK << FCOE_TCE_TX_WR_RX_RD_CONST_DEV_TYPE_SHIFT ; } task -> txwr_rxrd . const_ctx . init_flags |= FCOE_TASK_CLASS_TYPE_3 << FCOE_TCE_TX_WR_RX_RD_CONST_CLASS_TYPE_SHIFT ; task -> txwr_rxrd . const_ctx . tx_flags = FCOE_TASK_TX_STATE_NORMAL << FCOE_TCE_TX_WR_RX_RD_CONST_TX_STATE_SHIFT ; task -> txwr_rxrd . union_ctx . tx_seq . ctx . seq_cnt = 1 ; fcp_cmnd = ( u64 * ) task -> txwr_rxrd . union_ctx . fcp_cmd . opaque ; bnx2fc_build_fcp_cmnd ( io_req , ( fcp_cmnd * ) & tmp_fcp_cmnd ) ; cnt = sizeof ( fcp_cmnd ) / sizeof ( u64 ) ; for ( i = 0 ; i < cnt ; i ++ ) { * fcp_cmnd = cpu_to_be64 ( tmp_fcp_cmnd [ i ] ) ; fcp_cmnd ++ ; } task -> rxwr_txrd . const_ctx . data_2_trns = io_req -> data_xfer_len ; context_id = tgt -> context_id ; task -> rxwr_txrd . const_ctx . init_flags = context_id << FCOE_TCE_RX_WR_TX_RD_CONST_CID_SHIFT ; task -> rxwr_txrd . var_ctx . rx_flags |= 1 << FCOE_TCE_RX_WR_TX_RD_VAR_EXP_FIRST_FRAME_SHIFT ; task -> rxwr_txrd . var_ctx . rx_id = 0xffff ; sgl = & task -> rxwr_only . union_ctx . read_info . sgl_ctx . sgl ; bd_count = bd_tbl -> bd_valid ; if ( dev_type == TYPE_DISK ) { if ( bd_count == 1 ) { struct fcoe_bd_ctx * fcoe_bd_tbl = bd_tbl -> bd_tbl ; cached_sge -> cur_buf_addr . lo = fcoe_bd_tbl -> buf_addr_lo ; cached_sge -> cur_buf_addr . hi = fcoe_bd_tbl -> buf_addr_hi ; cached_sge -> cur_buf_rem = fcoe_bd_tbl -> buf_len ; task -> txwr_rxrd . const_ctx . init_flags |= 1 << FCOE_TCE_TX_WR_RX_RD_CONST_CACHED_SGE_SHIFT ; } if ( bd_count == 2 ) { struct fcoe_bd_ctx * fcoe_bd_tbl = bd_tbl -> bd_tbl ; cached_sge -> cur_buf_addr . lo = fcoe_bd_tbl -> buf_addr_lo ; cached_sge -> cur_buf_addr . hi = fcoe_bd_tbl -> buf_addr_hi ; cached_sge -> cur_buf_rem = fcoe_bd_tbl -> buf_len ; fcoe_bd_tbl ++ ; cached_sge -> second_buf_addr . lo = fcoe_bd_tbl -> buf_addr_lo ; cached_sge -> second_buf_addr . hi = fcoe_bd_tbl -> buf_addr_hi ; cached_sge -> second_buf_rem = fcoe_bd_tbl -> buf_len ; task -> txwr_rxrd . const_ctx . init_flags |= 1 << FCOE_TCE_TX_WR_RX_RD_CONST_CACHED_SGE_SHIFT ; } else { sgl -> mul_sgl . cur_sge_addr . lo = ( u32 ) bd_tbl -> bd_tbl_dma ; sgl -> mul_sgl . cur_sge_addr . hi = ( u32 ) ( ( u64 ) bd_tbl -> bd_tbl_dma >> 32 ) ; sgl -> mul_sgl . sgl_size = bd_count ; } } else { sgl -> mul_sgl . cur_sge_addr . lo = ( u32 ) bd_tbl -> bd_tbl_dma ; sgl -> mul_sgl . cur_sge_addr . hi = ( u32 ) ( ( u64 ) bd_tbl -> bd_tbl_dma >> 32 ) ; sgl -> mul_sgl . sgl_size = bd_count ; } } 