static int cobalt_rx_bytes ( struct cobalt_i2c_regs __iomem * regs , struct i2c_adapter * adap , bool start , bool stop , u8 * data , u16 len ) { unsigned long start_time ; int status ; int cmd ; int i ; for ( i = 0 ; i < len ; i ++ ) { if ( i == 0 && start ) { cmd = M00018_CR_BITMAP_RD_MSK | M00018_CR_BITMAP_STA_MSK ; } if ( i == len - 1 && stop ) { cmd = M00018_CR_BITMAP_RD_MSK | M00018_CR_BITMAP_STO_MSK ; } else { cmd = M00018_CR_BITMAP_RD_MSK ; } iowrite8 ( cmd , & regs -> cr_sr ) ; start_time = jiffies ; status = ioread8 ( & regs -> cr_sr ) ; while ( status & M00018_SR_BITMAP_TIP_MSK ) { if ( time_after ( jiffies , start_time + adap -> timeout ) ) { return - ETIMEDOUT ; } cond_resched ( ) ; status = ioread8 ( & regs -> cr_sr ) ; } if ( status & M00018_SR_BITMAP_AL_MSK ) { return - EIO ; } data [ i ] = ioread8 ( & regs -> txr_rxr ) ; } return 0 ; } 