static int zsh_setmode ( struct zscom * zs , struct syncline * zss , struct scc_mode * sm ) { int n = ZSH_MAX_RSTANDBY ; while ( -- n >= 0 ) { if ( zss -> sl_rstandby [ n ] == NULL ) { if ( ( zss -> sl_rstandby [ n ] = allocb ( zss -> sl_mru , BPRI_MED ) ) == NULL ) { if ( zss -> sl_bufcid == 0 ) { mutex_enter ( zs -> zs_excl_hi ) ; if ( zss -> sl_txstate != TX_OFF ) { mutex_exit ( zs -> zs_excl_hi ) ; break ; } else { mutex_exit ( zs -> zs_excl_hi ) ; } } } allocbcount -- ; } } } { int n = ZSH_MAX_RSTANDBY ; mp = NULL ; while ( -- n >= 0 ) { if ( ( mp = zss -> sl_rstandby [ n ] ) != NULL ) { zss -> sl_rstandby [ n ] = NULL ; break ; } } } { int wptr , rptr ; wptr = zss -> sl_rdone_wptr ; rptr = zss -> sl_rdone_rptr ; zss -> sl_rdone [ wptr ] = mp ; if ( ( wptr ) + 1 == ZSH_RDONE_MAX ) { zss -> sl_rdone_wptr = wptr = 0 ; } else { zss -> sl_rdone_wptr = ++ wptr ; } if ( wptr == rptr ) { SCC_BIC ( 1 , ZSWR1_INIT ) ; zss -> sl_m_error = ENOSR ; ZSSETSOFT ( zs ) ; } } 