static int libjxl_init_jxl_encoder ( AVCodecContext * avctx ) { LibJxlEncodeContext * ctx = avctx -> priv_data ; JxlEncoderReset ( ctx -> encoder ) ; if ( ! ctx -> options ) { av_log ( avctx , AV_LOG_ERROR , "Failed to create JxlEncoderOptions\n" ) ; return AVERROR_EXTERNAL ; } if ( JxlEncoderSetParallelRunner ( ctx -> encoder , JxlThreadParallelRunner , ctx -> runner ) != JXL_ENC_SUCCESS ) { av_log ( avctx , AV_LOG_ERROR , "Failed to set JxlThreadParallelRunner\n" ) ; return AVERROR_EXTERNAL ; } if ( JxlEncoderFrameSettingsSetOption ( ctx -> options , JXL_ENC_FRAME_SETTING_EFFORT , ctx -> effort ) != JXL_ENC_SUCCESS ) { av_log ( avctx , AV_LOG_ERROR , "Failed to set effort to: %d\n" , ctx -> effort ) ; return AVERROR_EXTERNAL ; } if ( ctx -> distance < 0.0 ) { if ( avctx -> flags & AV_CODEC_FLAG_QSCALE ) { ctx -> distance = quality_to_distance ( ( float ) avctx -> global_quality / FF_QP2LAMBDA ) ; } else { ctx -> distance = 1.0 ; } } if ( ctx -> distance > 0.0 && ctx -> distance < 0.01 ) { ctx -> distance = 0.01 ; } if ( JxlEncoderSetFrameDistance ( ctx -> options , ctx -> distance ) != JXL_ENC_SUCCESS ) { av_log ( avctx , AV_LOG_ERROR , "Failed to set distance: %f\n" , ctx -> distance ) ; return AVERROR_EXTERNAL ; } if ( JxlEncoderFrameSettingsSetOption ( ctx -> options , JXL_ENC_FRAME_SETTING_MODULAR , ctx -> modular || ctx -> distance <= 0.0 ?1 : - 1 ) != JXL_ENC_SUCCESS ) { av_log ( avctx , AV_LOG_ERROR , "Failed to set modular\n" ) ; return AVERROR_EXTERNAL ; } return 0 ; } 