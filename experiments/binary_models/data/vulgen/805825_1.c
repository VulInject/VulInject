TmEcode UnixSocketHostbitList ( json_t * cmd , json_t * answer , void * data_unused ) { json_t * jarg = json_object_get ( cmd , "ipaddress" ) ; if ( ! json_is_string ( jarg ) ) { json_object_set_new ( answer , "message" , json_string ( "ipaddress is not an string" ) ) ; return TM_ECODE_FAILED ; } const char * ipaddress = json_string_value ( jarg ) ; Address a ; struct in_addr in ; memset ( & in , 0 , sizeof ( in ) ) ; if ( inet_pton ( AF_INET , ipaddress , & in ) != 1 ) { memset ( & in6 , 0 , sizeof ( in6 ) ) ; if ( inet_pton ( AF_INET6 , ipaddress , & in ) != 1 ) { json_object_set_new ( answer , "message" , json_string ( "invalid address string" ) ) ; return TM_ECODE_FAILED ; } else { a . family = AF_INET6 ; a . addr_data32 [ 0 ] = in6 [ 0 ] ; a . addr_data32 [ 1 ] = in6 [ 1 ] ; a . addr_data32 [ 2 ] = in6 [ 2 ] ; a . addr_data32 [ 3 ] = in6 [ 3 ] ; } } else { a . family = AF_INET ; a . addr_data32 [ 0 ] = in . s_addr ; a . addr_data32 [ 1 ] = 0 ; a . addr_data32 [ 2 ] = 0 ; a . addr_data32 [ 3 ] = 0 ; } SCLogInfo ( "list-hostbit: %s" , ipaddress ) ; SCTime_t ts = TimeGet ( ) ; Bit { uint32_t id ; uint32_t expire ; } , bits [ 256 ] memset ( & bits , 0 , sizeof ( bits ) ) ; int i = 0 , use = 0 ; Host * host = HostLookupHostFromHash ( & a ) ; if ( ! host ) { json_object_set_new ( answer , "message" , json_string ( "host not found" ) ) ; return TM_ECODE_FAILED ; } XBit * iter = NULL ; while ( use < 256 && HostBitList ( host , & iter ) == 1 ) { bits [ use ] . id = iter -> idx ; bits [ use ] . expire = iter -> expire ; use ++ ; } HostUnlock ( host ) ; json_t * jdata = json_object ( ) ; json_t * jarray = json_array ( ) ; if ( jarray == NULL || jdata == NULL ) { if ( jdata != NULL ) { json_decref ( jdata ) ; } if ( jarray != NULL ) { json_decref ( jarray ) ; } json_object_set_new ( answer , "message" , json_string ( "internal error at json object creation" ) ) ; return TM_ECODE_FAILED ; } for ( i = 0 ; i < use ; i ++ ) { json_t * bitobject = json_object ( ) ; if ( bitobject == NULL ) { continue ; } uint32_t expire = 0 ; if ( ( uint32_t ) SCTIME_SECS ( ts ) < bits [ i ] . expire ) { expire = bits [ i ] . expire - ( uint32_t ) SCTIME_SECS ( ts ) ; } const char * name = VarNameStoreLookupById ( bits [ i ] . id , VAR_TYPE_HOST_BIT ) ; if ( name == NULL ) { continue ; } json_object_set_new ( bitobject , "name" , json_string ( name ) ) ; SCLogDebug ( "xbit %s expire %u" , name , expire ) ; json_object_set_new ( bitobject , "expire" , json_integer ( expire ) ) ; json_array_append_new ( jarray , bitobject ) ; } json_object_set_new ( jdata , "count" , json_integer ( i ) ) ; json_object_set_new ( jdata , "hostbits" , jarray ) ; json_object_set_new ( answer , "message" , jdata ) ; return TM_ECODE_OK ; } 