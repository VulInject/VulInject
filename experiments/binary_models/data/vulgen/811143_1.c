void klist_invalidate ( struct klist * list ) { struct knote * kn ; struct kqueue * kq ; struct proc * p = curproc ; int ls ; NET_ASSERT_UNLOCKED ( ) ; ls = klist_lock ( list ) ; while ( ( kn = SLIST_FIRST ( & list -> kl_list ) ) != NULL ) { kq = kn -> kn_kq ; mtx_enter ( & kq -> kq_lock ) ; if ( ! knote_acquire ( kn , list , ls ) ) { ls = klist_lock ( list ) ; continue ; } mtx_leave ( & kq -> kq_lock ) ; klist_unlock ( list , ls ) ; filter_detach ( kn ) ; if ( kn -> kn_fop -> f_flags & FILTEROP_ISFD ) { kn -> kn_fop = & dead_filtops ; filter_event ( kn , 0 ) ; mtx_enter ( & kq -> kq_lock ) ; knote_activate ( kn ) ; knote_release ( kn ) ; mtx_leave ( & kq -> kq_lock ) ; } else { knote_drop ( kn , 0 ) ; } ls = klist_lock ( list ) ; } klist_unlock ( list , ls ) ; } 