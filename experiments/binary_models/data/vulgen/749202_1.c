static int inia100_probe_one ( struct pci_dev * pdev , const struct pci_device_id * id ) { struct Scsi_Host * shost ; struct orc_host * host ; unsigned long port , bios ; int error = - ENODEV ; u32 sz ; if ( pci_enable_device ( pdev ) ) { out } if ( dma_set_mask ( & pdev -> dev , DMA_BIT_MASK ( 32 ) ) ) { printk ( KERN_WARNING "Unable to set 32bit DMA " "on inia100 adapter, ignoring.\n" ) ; out_disable_device } pci_set_master ( pdev ) ; port = pci_resource_start ( pdev , 0 ) ; if ( ! request_region ( port , 256 , "inia100" ) ) { printk ( KERN_WARNING "inia100: io port 0x%lx, is busy.\n" , port ) ; out_disable_device } bios = inw ( port + 0x50 ) ; shost = scsi_host_alloc ( & inia100_template , sizeof ( orc_host ) ) ; if ( ! shost ) { out_release_region } host = ( orc_host * ) shost -> hostdata ; host -> pdev = pdev ; host -> base = port ; host -> BIOScfg = bios ; sz = ORC_MAXQUEUE * sizeof ( orc_scb ) ; host -> scb_virt = dma_alloc_coherent ( & pdev -> dev , sz , & host -> scb_phys , GFP_KERNEL ) ; if ( ! host -> scb_virt ) { printk ( "inia100: SCB memory allocation error\n" ) ; out_host_put } sz = ORC_MAXQUEUE * sizeof ( orc_extended_scb ) ; host -> escb_virt = dma_alloc_coherent ( & pdev -> dev , sz , & host -> escb_phys , GFP_KERNEL ) ; if ( ! host -> escb_virt ) { printk ( "inia100: ESCB memory allocation error\n" ) ; out_free_scb_array } if ( init_orchid ( host ) ) { printk ( "inia100: initial orchid fail!!\n" ) ; out_free_escb_array } shost -> io_port = host -> base ; shost -> n_io_port = 0xff ; shost -> can_queue = ORC_MAXQUEUE ; shost -> unique_id = shost -> io_port ; shost -> max_id = host -> max_targets ; shost -> max_lun = 16 ; shost -> irq = pdev -> irq ; shost -> this_id = host -> scsi_id ; shost -> sg_tablesize = TOTAL_SG_ENTRY ; error = request_irq ( pdev -> irq , inia100_intr , IRQF_SHARED , "inia100" , shost ) ; if ( error < 0 ) { printk ( KERN_WARNING "inia100: unable to get irq %d\n" , pdev -> irq ) ; out_free_escb_array } pci_set_drvdata ( pdev , shost ) ; error = scsi_add_host ( shost , & pdev -> dev ) ; if ( error ) { out_free_irq } scsi_scan_host ( shost ) ; return 0 ; out_free_irq free_irq ( shost -> irq , shost ) ; out_free_escb_array dma_free_coherent ( & pdev -> dev , ORC_MAXQUEUE * sizeof ( orc_extended_scb ) , host -> escb_virt , host -> escb_phys ) ; out_free_scb_array dma_free_coherent ( & pdev -> dev , ORC_MAXQUEUE * sizeof ( orc_scb ) , host -> scb_virt , host -> scb_phys ) ; out_host_put scsi_host_put ( shost ) ; out_release_region release_region ( port , 256 ) ; out_disable_device pci_disable_device ( pdev ) ; out return error ; } 