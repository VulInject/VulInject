void hrm_sensor_on ( HrmCallback callback ) { hrmCallback = callback ; jshDelayMicroseconds ( 1000 ) ; unsigned int deviceId = vc31_r ( 0 ) ; if ( deviceId == 17 ) { vcType = VC31_DEVICE ; } if ( deviceId == 33 ) { vcType = VC31B_DEVICE ; } else { jsiConsolePrintf ( "VC31 WHO_AM_I failed (%d)" , deviceId ) ; } memset ( & vcInfo , 0 , sizeof ( vcInfo ) ) ; vcInfo . isWearing = true ; vcInfo . unWearCnt = VC31A_UNWEAR_CNT ; vcInfo . isWearCnt = VC31A_ISWEAR_CNT ; vcInfo . ppgOffset = 0 ; if ( vcType == VC31_DEVICE ) { vcaInfo . adjustInfo . step = 307200 ; vcaInfo . adjustInfo . direction = AdjustDirection_Null ; vcaInfo . adjustInfo . directionLast = AdjustDirection_Null ; vc31_w ( VC31A_GREEN_WAIT , 0xb4 ) ; vc31_w ( VC31A_TIA_WAIT , 0x54 ) ; vc31_w ( VC31A_PS_DIV , 0x09 ) ; vc31_w ( VC31A_IR_WAIT , 0x5F ) ; vc31_w ( VC31A_GREEN_IR_GAP , 0x20 ) ; vc31_w ( VC31A_AMP_WAIT , 0x14 ) ; uint16_t div ; if ( hrmPollInterval < 2 ) { div = VC31A_PPG_DIV_1000_HZ ; } if ( hrmPollInterval <= 10 ) { div = 160 ; } if ( hrmPollInterval <= 20 ) { div = VC31A_PPG_DIV_100_HZ ; } if ( hrmPollInterval <= 40 ) { div = VC31A_PPG_DIV_50_HZ ; } if ( hrmPollInterval <= 80 ) { div = VC31A_PPG_DIV_25_HZ ; } if ( hrmPollInterval <= 160 ) { div = VC31A_PPG_DIV_12_5_HZ ; } else { div = VC31A_PPG_DIV_10_HZ ; } vc31_w16 ( VC31A_PPG_DIV , div ) ; vcaInfo . ctrl = VC31A_CTRL_OPA_GAIN_25 | VC31A_CTRL_ENABLE_PPG | VC31A_CTRL_ENABLE_PRE | VC31A_CTRL_WORK_MODE | VC31A_CTRL_INT_DIR_RISING ; vc31_w ( VC31A_CTRL , vcaInfo . ctrl ) ; } vc31_watch_on ( ) ; } 