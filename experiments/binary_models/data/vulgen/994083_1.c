static void cpuhp_thread_fun ( unsigned int cpu ) { struct cpuhp_cpu_state * st = this_cpu_ptr ( & cpuhp_state ) ; int ret = 0 ; smp_mb ( ) ; st -> should_run = false ; if ( st -> single ) { if ( st -> cb_state < CPUHP_AP_ONLINE ) { local_irq_disable ( ) ; ret = cpuhp_invoke_callback ( cpu , st -> cb_state , st -> bringup , st -> node ) ; local_irq_enable ( ) ; } else { ret = cpuhp_invoke_callback ( cpu , st -> cb_state , st -> bringup , st -> node ) ; } } if ( st -> rollback ) { BUG_ON ( st -> state < CPUHP_AP_ONLINE_IDLE ) ; undo_cpu_down ( cpu , st ) ; st -> rollback = false ; } else { BUG_ON ( st -> state < CPUHP_AP_ONLINE_IDLE ) ; if ( st -> state < st -> target ) { ret = cpuhp_ap_online ( cpu , st ) ; } if ( st -> state > st -> target ) { ret = cpuhp_ap_offline ( cpu , st ) ; } } st -> result = ret ; complete ( & st -> done ) ; } 