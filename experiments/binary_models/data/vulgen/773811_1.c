static void dwc2_hsotg_init_fifo ( struct dwc2_hsotg * hsotg ) { unsigned int ep ; unsigned int addr ; int timeout ; u32 val ; u32 * txfsz = hsotg -> params . g_tx_fifo_size ; WARN_ON ( hsotg -> fifo_map ) ; hsotg -> fifo_map = 0 ; dwc2_writel ( hsotg , hsotg -> params . g_rx_fifo_size , GRXFSIZ ) ; dwc2_writel ( hsotg , ( hsotg -> params . g_rx_fifo_size << FIFOSIZE_STARTADDR_SHIFT ) | ( hsotg -> params . g_np_tx_fifo_size << FIFOSIZE_DEPTH_SHIFT ) , GNPTXFSIZ ) ; addr = hsotg -> params . g_rx_fifo_size + hsotg -> params . g_np_tx_fifo_size ; for ( ep = 1 ; ep < MAX_EPS_CHANNELS ; ep ++ ) { val = addr ; val |= txfsz [ ep ] << FIFOSIZE_DEPTH_SHIFT ; WARN_ONCE ( addr + txfsz [ ep ] > hsotg -> fifo_mem , "insufficient fifo memory" ) ; addr += txfsz [ ep ] ; dwc2_writel ( hsotg , val , DPTXFSIZN ( ep ) ) ; val = dwc2_readl ( hsotg , DPTXFSIZN ( ep ) ) ; } dwc2_writel ( hsotg , hsotg -> hw_params . total_fifo_size | addr << GDFIFOCFG_EPINFOBASE_SHIFT , GDFIFOCFG ) ; dwc2_writel ( hsotg , GRSTCTL_TXFNUM ( 0x10 ) | GRSTCTL_TXFFLSH | GRSTCTL_RXFFLSH , GRSTCTL ) ; timeout = 100 ; while ( 1 ) { val = dwc2_readl ( hsotg , GRSTCTL ) ; if ( ( val & ( GRSTCTL_TXFFLSH | GRSTCTL_RXFFLSH ) ) == 0 ) { break ; } if ( -- timeout == 0 ) { dev_err ( hsotg -> dev , "%s: timeout flushing fifos (GRSTCTL=%08x)\n" , __func__ , val ) ; break ; } udelay ( 1 ) ; } dev_dbg ( hsotg -> dev , "FIFOs reset, timeout at %d\n" , timeout ) ; } 