static KMF_RETURN update_policyfile ( xmlDocPtr doc , char * filename ) { KMF_RETURN ret = KMF_OK ; FILE * pfile , * tmpfile ; char tmpfilename [ MAXPATHLEN ] ; char * p ; int prefix_len , tmpfd ; mode_t old_mode ; if ( ( pfile = fopen ( filename , "r+" ) ) == NULL && errno == ENOENT ) { pfile = fopen ( filename , "w+" ) ; } if ( pfile == NULL ) { return ( KMF_ERR_POLICY_DB_FILE ) ; } if ( lockf ( fileno ( pfile ) , F_TLOCK , 0 ) == - 1 ) { ( void ) fclose ( pfile ) ; return ( KMF_ERR_POLICY_DB_FILE ) ; } ( void ) memset ( tmpfilename , 0 , sizeof ( tmpfilename ) ) ; p = ( char * ) strrchr ( filename , '/' ) ; if ( p == NULL ) { if ( strlcpy ( tmpfilename , TMPFILE_TEMPLATE , sizeof ( tmpfilename ) ) >= sizeof ( tmpfilename ) ) { return ( KMF_ERR_INTERNAL ) ; } } else { prefix_len = p - filename ; ( void ) strncpy ( tmpfilename , filename , prefix_len ) ; ( void ) strncat ( tmpfilename , "/" , 1 ) ; ( void ) strncat ( tmpfilename , TMPFILE_TEMPLATE , sizeof ( TMPFILE_TEMPLATE ) ) ; } old_mode = umask ( 077 ) ; tmpfd = mkstemp ( tmpfilename ) ; ( void ) umask ( old_mode ) ; if ( tmpfd == - 1 ) { return ( KMF_ERR_POLICY_DB_FILE ) ; } if ( ( tmpfile = fdopen ( tmpfd , "w" ) ) == NULL ) { ( void ) close ( tmpfd ) ; ( void ) unlink ( tmpfilename ) ; ( void ) fclose ( pfile ) ; return ( KMF_ERR_POLICY_DB_FILE ) ; } if ( xmlDocFormatDump ( tmpfile , doc , 1 ) == - 1 ) { ( void ) fclose ( pfile ) ; ( void ) fclose ( tmpfile ) ; ( void ) unlink ( tmpfilename ) ; return ( KMF_ERR_POLICY_ENGINE ) ; } ( void ) fclose ( pfile ) ; if ( fchmod ( tmpfd , S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH ) == - 1 ) { ( void ) close ( tmpfd ) ; ( void ) unlink ( tmpfilename ) ; return ( KMF_ERR_POLICY_DB_FILE ) ; } if ( fclose ( tmpfile ) != 0 ) { return ( KMF_ERR_POLICY_DB_FILE ) ; } if ( rename ( tmpfilename , filename ) == - 1 ) { ret = KMF_ERR_POLICY_DB_FILE ; } return ( ret ) ; } 