static bool page_table_walk_refill ( CPUMIPSState * env , vaddr address , int mmu_idx ) { int gdw = ( env -> CP0_PWSize >> CP0PS_GDW ) & 0x3F ; int udw = ( env -> CP0_PWSize >> CP0PS_UDW ) & 0x3F ; int mdw = ( env -> CP0_PWSize >> CP0PS_MDW ) & 0x3F ; int ptw = ( env -> CP0_PWSize >> CP0PS_PTW ) & 0x3F ; int ptew = ( env -> CP0_PWSize >> CP0PS_PTEW ) & 0x3F ; bool huge_page = false ; bool hgpg_bdhit = false ; bool hgpg_gdhit = false ; bool hgpg_udhit = false ; bool hgpg_mdhit = false ; uint64_t pw_entrylo1 ; target_ulong pw_entryhi = 0 ; uint64_t pw_entrylo0 = 0 ; uint64_t pw_entrylo1 = 0 ; int native_shift = ( ( ( env -> CP0_PWSize >> CP0PS_PS ) & 1 ) == 0 ) ?2 : 3 ; int pf_gdw = ( env -> CP0_PWField >> CP0PF_GDW ) & 0x3F ; int pf_udw = ( env -> CP0_PWField >> CP0PF_UDW ) & 0x3F ; int pf_mdw = ( env -> CP0_PWField >> CP0PF_MDW ) & 0x3F ; int pf_ptw = ( env -> CP0_PWField >> CP0PF_PTW ) & 0x3F ; int pf_ptew = ( env -> CP0_PWField >> CP0PF_PTEW ) & 0x3F ; int gindex = ( address >> pf_gdw ) & ( ( 1 << gdw ) - 1 ) ; int uindex = ( address >> pf_udw ) & ( ( 1 << udw ) - 1 ) ; int mindex = ( address >> pf_mdw ) & ( ( 1 << mdw ) - 1 ) ; int ptindex = ( address >> pf_ptw ) & ( ( 1 << ptw ) - 1 ) ; int hugepg = ( env -> CP0_PWCtl >> CP0PC_HUGEPG ) & 0x1 ; int directory_shift = ( ptew > 1 ) ?- 1 : ( hugepg && ( ptew == 1 ) ) ?native_shift + 1 : native_shift ; int leaf_shift = ( ptew > 1 ) ?- 1 : ( ptew == 1 ) ?native_shift + 1 : native_shift ; int goffset = gindex << directory_shift ; int uoffset = uindex << directory_shift ; int moffset = mindex << directory_shift ; int ptoffset0 = ( ptindex >> 1 ) << ( leaf_shift + 1 ) ; int ptoffset1 = ptoffset0 | ( 1 << ( leaf_shift ) ) ; uint32_t leafentry_size = 1 << ( leaf_shift + 3 ) ; uint64_t vaddr = env -> CP0_PWBase ; uint64_t dir_entry ; uint64_t paddr ; int prot ; int m ; if ( ! ( env -> CP0_Config3 & ( 1 << CP0C3_PW ) ) ) { return false ; } if ( ! ( env -> CP0_PWCtl & ( 1 << CP0PC_PWEN ) ) ) { return false ; } if ( ! ( gdw > 0 || udw > 0 || mdw > 0 ) ) { return false ; } if ( ( directory_shift == - 1 ) || ( leaf_shift == - 1 ) ) { return false ; } if ( gdw > 0 ) { vaddr |= goffset ; switch ( walk_directory ( env , & vaddr , pf_gdw , & huge_page , & hgpg_gdhit , & pw_entrylo0 , & pw_entrylo1 ) ) { case 0 : return false ; case 1 : refill case 2 : default : break ; } } if ( udw > 0 ) { vaddr |= uoffset ; switch ( walk_directory ( env , & vaddr , pf_udw , & huge_page , & hgpg_udhit , & pw_entrylo0 , & pw_entrylo1 ) ) { case 0 : return false ; case 1 : refill case 2 : default : break ; } } if ( mdw > 0 ) { vaddr |= moffset ; switch ( walk_directory ( env , & vaddr , pf_mdw , & huge_page , & hgpg_mdhit , & pw_entrylo0 , & pw_entrylo1 ) ) { case 0 : return false ; case 1 : refill case 2 : default : break ; } } vaddr |= ptoffset0 ; if ( get_physical_address ( env , & paddr , & prot , vaddr , MMU_DATA_LOAD , cpu_mmu_index ( env , false ) ) != TLBRET_MATCH ) { return false ; } if ( ! get_pte ( env , vaddr , leafentry_size , & dir_entry ) ) { return false ; } dir_entry = get_tlb_entry_layout ( env , dir_entry , leafentry_size , pf_ptew ) ; pw_entrylo0 = dir_entry ; vaddr |= ptoffset1 ; if ( get_physical_address ( env , & paddr , & prot , vaddr , MMU_DATA_LOAD , cpu_mmu_index ( env , false ) ) != TLBRET_MATCH ) { return false ; } if ( ! get_pte ( env , vaddr , leafentry_size , & dir_entry ) ) { return false ; } dir_entry = get_tlb_entry_layout ( env , dir_entry , leafentry_size , pf_ptew ) ; pw_entrylo1 = dir_entry ; refill m = ( 1 << pf_ptw ) - 1 ; if ( huge_page ) { switch ( hgpg_bdhit << 3 | hgpg_gdhit << 2 | hgpg_udhit << 1 | hgpg_mdhit ) { case 4 : m = ( 1 << pf_gdw ) - 1 ; if ( pf_gdw & 1 ) { m >>= 1 ; } break ; case 2 : m = ( 1 << pf_udw ) - 1 ; if ( pf_udw & 1 ) { m >>= 1 ; } break ; case 1 : m = ( 1 << pf_mdw ) - 1 ; if ( pf_mdw & 1 ) { m >>= 1 ; } break ; } } pw_pagemask = m >> TARGET_PAGE_BITS_MIN ; update_pagemask ( env , pw_pagemask << CP0PM_MASK , & pw_pagemask ) ; pw_entryhi = ( address & ~ 0x1fff ) | ( env -> CP0_EntryHi & 0xFF ) ; { target_ulong tmp_entryhi = env -> CP0_EntryHi ; int32_t tmp_pagemask = env -> CP0_PageMask ; uint64_t tmp_entrylo0 = env -> CP0_EntryLo0 ; uint64_t tmp_entrylo1 = env -> CP0_EntryLo1 ; env -> CP0_EntryHi = pw_entryhi ; env -> CP0_PageMask = pw_pagemask ; env -> CP0_EntryLo0 = pw_entrylo0 ; env -> CP0_EntryLo1 = pw_entrylo1 ; r4k_helper_tlbwr ( env ) ; env -> CP0_EntryHi = tmp_entryhi ; env -> CP0_PageMask = tmp_pagemask ; env -> CP0_EntryLo0 = tmp_entrylo0 ; env -> CP0_EntryLo1 = tmp_entrylo1 ; } return true ; } 