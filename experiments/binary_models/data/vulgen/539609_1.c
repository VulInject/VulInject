static TEE_Result crypto_aes_gcm_dec_final ( struct crypto_authenc_ctx * aectx , const uint8_t * src_data , size_t len , uint8_t * dst_data , const uint8_t * tag , size_t tag_len ) { TEE_Result res = TEE_ERROR_BAD_STATE ; struct tee_gcm_state * gcm = to_tee_gcm_state ( aectx ) ; int ltc_res = 0 ; uint8_t dst_tag [ TEE_GCM_TAG_MAX_LENGTH ] { 0 } ; ; unsigned long ltc_tag_len = tag_len ; if ( tag_len == 0 ) { return TEE_ERROR_SHORT_BUFFER ; } if ( tag_len > TEE_GCM_TAG_MAX_LENGTH ) { return TEE_ERROR_BAD_STATE ; } res = crypto_aes_gcm_update_payload ( aectx , TEE_MODE_DECRYPT , src_data , len , dst_data ) ; if ( res != TEE_SUCCESS ) { return res ; } ltc_res = gcm_done ( & gcm -> ctx , dst_tag , & ltc_tag_len ) ; if ( consttime_memcmp ( dst_tag , tag , tag_len ) != 0 ) { res = TEE_ERROR_MAC_INVALID ; } else { res = TEE_SUCCESS ; } return res ; } 