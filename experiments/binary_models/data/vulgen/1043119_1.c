qboolean G_RadiusDamage ( vec3_t origin , gentity_t * attacker , float damage , float radius , gentity_t * ignore , int mod ) { float points , dist ; gentity_t * ent ; int entityList [ MAX_GENTITIES ] ; int numListedEntities ; vec3_t mins , maxs ; vec3_t v ; vec3_t dir ; int i , e ; qboolean hitClient = qfalse ; float boxradius ; vec3_t dest ; trace_t tr ; vec3_t midpoint ; if ( radius < 1 ) { radius = 1 ; } boxradius = 1.41421356 * radius ; for ( i = 0 ; i < 3 ; i ++ ) { mins [ i ] = origin [ i ] - boxradius ; maxs [ i ] = origin [ i ] + boxradius ; } numListedEntities = trap_EntitiesInBox ( mins , maxs , entityList , MAX_GENTITIES ) ; for ( e = 0 ; e < numListedEntities ; e ++ ) { ent = & g_entities [ entityList [ e ] ] ; if ( ent == ignore ) { continue ; } if ( ! ent -> takedamage ) { continue ; } if ( ! ent -> r . bmodel ) { VectorSubtract ( ent -> r . currentOrigin , origin , v ) ; } else { for ( i = 0 ; i < 3 ; i ++ ) { if ( origin [ i ] < ent -> r . absmin [ i ] ) { v [ i ] = ent -> r . absmin [ i ] - origin [ i ] ; } if ( origin [ i ] > ent -> r . absmax [ i ] ) { v [ i ] = origin [ i ] - ent -> r . absmax [ i ] ; } else { v [ i ] = 0 ; } } } dist = VectorLength ( v ) ; if ( dist >= radius ) { continue ; } points = damage * ( 1.0 - dist / radius ) ; if ( CanDamage ( ent , origin ) ) { if ( LogAccuracyHit ( ent , attacker ) ) { hitClient = qtrue ; } VectorSubtract ( ent -> r . currentOrigin , origin , dir ) ; G_Damage ( ent , NULL , attacker , dir , origin , ( int ) points , DAMAGE_RADIUS , mod ) ; } else { if ( g_gametype . integer != GT_SINGLE_PLAYER ) { VectorAdd ( ent -> r . absmin , ent -> r . absmax , midpoint ) ; VectorScale ( midpoint , 0.5 , midpoint ) ; VectorCopy ( midpoint , dest ) ; trap_Trace ( & tr , origin , vec3_origin , vec3_origin , dest , ENTITYNUM_NONE , MASK_SOLID ) ; if ( tr . fraction < 1.0 ) { VectorSubtract ( dest , origin , dest ) ; dist = VectorLength ( dest ) ; if ( dist < radius * 0.2f ) { if ( LogAccuracyHit ( ent , attacker ) ) { hitClient = qtrue ; } VectorSubtract ( ent -> r . currentOrigin , origin , dir ) ; dir [ 2 ] += 24 ; G_Damage ( ent , NULL , attacker , dir , origin , ( int ) ( points * 0.1f ) , DAMAGE_RADIUS , mod ) ; } } } } } return hitClient ; } 