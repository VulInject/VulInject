static void asd_clear_nexus_timedout ( unsigned long data ) { struct asd_ascb * ascb = ( void * ) data ; struct tasklet_completion_status * tcs = ascb -> uldd_task ; ASD_DPRINTK ( "%s: here\n" , __func__ ) ; tcs -> dl_opcode = TMF_RESP_FUNC_FAILED ; complete ( ascb -> completion ) ; } struct asd_ascb * ascb ; struct scb * scb ; int res ; DECLARE_TCS ( tcs ) ; ASD_DPRINTK ( "%s: PRE\n" , __func__ ) ; res = 1 ; ascb = asd_ascb_alloc_list ( asd_ha , & res , GFP_KERNEL ) ; if ( ! ascb ) { return - ENOMEM ; } ascb -> completion = & completion ; ascb -> uldd_task = & tcs ; scb = ascb -> scb ; scb -> header . opcode = CLEAR_NEXUS ASD_DPRINTK ( "%s: POST\n" , __func__ ) ; res = asd_enqueue_internal ( ascb , asd_clear_nexus_tasklet_complete , asd_clear_nexus_timedout ) ; if ( res ) { out_err } ASD_DPRINTK ( "%s: clear nexus posted, waiting...\n" , __func__ ) ; wait_for_completion ( & completion ) ; res = tcs . dl_opcode ; if ( res == TC_NO_ERROR ) { res = TMF_RESP_FUNC_COMPLETE ; } return res ; out_err asd_ascb_free ( ascb ) ; return res int asd_clear_nexus_ha ( ) { asd_ha_struct * asd_ha = sas_ha -> lldd_ha CLEAR_NEXUS_PRE scb -> clear_nexus . nexus = NEXUS_ADAPTER CLEAR_NEXUS_POST } ; 