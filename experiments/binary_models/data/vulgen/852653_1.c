FT_BASE_DEF ( ) FT_Raccess_Get_HeaderInfo ( , , , , ) { FT_Error error ; unsigned char head [ 16 ] , head2 [ 16 ] ; FT_Long map_pos , map_len , rdata_len ; int allzeros , allmatch , i ; FT_Long type_list ; FT_UNUSED ( library ) ; error = FT_Stream_Seek ( stream , ( FT_ULong ) rfork_offset ) ; if { return error ; } error = FT_Stream_Read ( stream , ( FT_Byte * ) head , 16 ) ; if ( error ) { return error ; } if ( head [ 0 ] >= 0x80 || head [ 4 ] >= 0x80 || head [ 8 ] >= 0x80 || head [ 12 ] >= 0x80 ) { return FT_THROW ( Unknown_File_Format ) ; } * rdata_pos = ( head [ 0 ] << 24 ) | ( head [ 1 ] << 16 ) | ( head [ 2 ] << 8 ) | head [ 3 ] ; map_pos = ( head [ 4 ] << 24 ) | ( head [ 5 ] << 16 ) | ( head [ 6 ] << 8 ) | head [ 7 ] ; rdata_len = ( head [ 8 ] << 24 ) | ( head [ 9 ] << 16 ) | ( head [ 10 ] << 8 ) | head [ 11 ] ; map_len = ( head [ 12 ] << 24 ) | ( head [ 13 ] << 16 ) | ( head [ 14 ] << 8 ) | head [ 15 ] ; if ( ! map_pos ) { return FT_THROW ( Unknown_File_Format ) ; } if ( * rdata_pos < map_pos ) { if ( * rdata_pos > map_pos - rdata_len ) { return FT_THROW ( Unknown_File_Format ) ; } } else { if ( map_pos > * rdata_pos - map_len ) { return FT_THROW ( Unknown_File_Format ) ; } } if ( FT_LONG_MAX - rdata_len ( * rdata_pos || FT_LONG_MAX - map_len ( map_pos || FT_LONG_MAX - ( * rdata_pos + rdata_len ) < rfork_offset || FT_LONG_MAX - ( map_pos + map_len ) < rfork_offset || ( FT_ULong ) ( rfork_offset + * rdata_pos + rdata_len ) ) stream -> size || ( FT_ULong ) ( rfork_offset + map_pos + map_len ) ) stream -> size ) { return FT_THROW ( Unknown_File_Format ) ; } * rdata_pos += rfork_offset ; map_pos += rfork_offset ; error = FT_Stream_Seek ( stream , ( FT_ULong ) map_pos ) ; if ( error ) { return error ; } head2 [ 15 ] = ( FT_Byte ) ( head [ 15 ] + 1 ) ; error = FT_Stream_Read ( stream , ( FT_Byte * ) head2 , 16 ) ; if ( error ) { return error ; } allzeros = 1 ; allmatch = 1 ; for ( i = 0 ; i < 16 ; i ++ ) { if ( head2 [ i ] != 0 ) { allzeros = 0 ; } if ( head2 [ i ] != head [ i ] ) { allmatch = 0 ; } } if ( ! allzeros && ! allmatch ) { return FT_THROW ( Unknown_File_Format ) ; } ( void ) FT_STREAM_SKIP ( 4 + 2 + 2 ) ; if ( FT_READ_SHORT ( type_list ) ) { return error ; } if ( type_list < 0 ) { return FT_THROW ( Unknown_File_Format ) ; } error = FT_Stream_Seek ( stream , ( FT_ULong ) ( map_pos + type_list ) ) ; if ( error ) { return error ; } * map_offset = map_pos + type_list ; return FT_Err_Ok ; } static int ft_raccess_sort_ref_by_id ( FT_RFork_Ref * a , FT_RFork_Ref * b ) { if ( a -> res_id < b -> res_id ) { return - 1 ; } if ( a -> res_id > b -> res_id ) { return 1 ; } else { return 0 ; } } FT_BASE_DEF ( ) FT_Raccess_Get_DataOffsets ( , , , , , , , ) { FT_Error error ; int i , j , cnt , subcnt ; FT_Long tag_internal , rpos ; FT_Memory memory = library -> memory ; FT_Long temp ; FT_Long * offsets_internal = NULL ; FT_RFork_Ref * ref = NULL ; FT_TRACE3 ( ( "\n" ) ) ; error = FT_Stream_Seek ( stream , ( FT_ULong ) map_offset ) ; if ( error ) { } } 