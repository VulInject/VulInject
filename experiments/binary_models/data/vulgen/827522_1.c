static krb5_error_code open_lmdb_env ( krb5_context context , klmdb_context * dbc , krb5_boolean is_lockout , krb5_boolean readonly , MDB_env * * env_out ) { krb5_error_code ret ; const char * path = is_lockout ?dbc -> lockout_path : dbc -> path ; unsigned int flags ; MDB_env * env = NULL ; int err ; * env_out = NULL ; err = mdb_env_create ( & env ) ; if ( err ) { lmdb_error } flags = MDB_NOSUBDIR ; if ( ! is_lockout ) { flags |= MDB_NOTLS ; } if ( readonly ) { flags |= MDB_RDONLY ; } if ( is_lockout || dbc -> nosync ) { flags |= MDB_NOSYNC ; } err = mdb_env_set_maxdbs ( env , is_lockout ?1 : 2 ) ; if ( err ) { lmdb_error } if ( dbc -> mapsize ) { err = mdb_env_set_mapsize ( env , dbc -> mapsize ) ; if ( err ) { lmdb_error } } if ( dbc -> maxreaders ) { err = mdb_env_set_maxreaders ( env , dbc -> maxreaders ) ; if ( err ) { lmdb_error } } err = mdb_env_open ( env , path , flags , S_IRUSR | S_IWUSR ) ; if ( err ) { lmdb_error } return 0 ; lmdb_error ret = klerr ( context , err , _ ( "LMDB environment open failure" ) ) ; mdb_env_close ( env ) ; return ret ; } 