void pio_copy ( struct hfi1_devdata * dd , struct pio_buf * pbuf , u64 pbc , const void * from , size_t count ) { void __iomem * dest = pbuf -> start + SOP_DISTANCE ; void __iomem * send = dest + PIO_BLOCK_SIZE ; void __iomem * dend ; writeq ( pbc , dest ) ; dest += sizeof ( u64 ) ; if ( dend < send ) { while ( dest < dend ) { writeq ( * ( u64 * ) from , dest ) ; from += sizeof ( u64 ) ; dest += sizeof ( u64 ) ; } } else { while ( dest < send ) { writeq ( * ( u64 * ) from , dest ) ; from += sizeof ( u64 ) ; dest += sizeof ( u64 ) ; } dest -= SOP_DISTANCE ; dend -= SOP_DISTANCE ; if ( pbuf -> end <= dend ) { while ( dest < pbuf -> end ) { writeq ( * ( u64 * ) from , dest ) ; from += sizeof ( u64 ) ; dest += sizeof ( u64 ) ; } dest -= pbuf -> sc -> size ; dend -= pbuf -> sc -> size ; } while ( dest < dend ) { writeq ( * ( u64 * ) from , dest ) ; from += sizeof ( u64 ) ; dest += sizeof ( u64 ) ; } } if ( count & 1 ) { union mix val ; val . val64 = 0 ; val . val32 [ 0 ] = * ( u32 * ) from ; writeq ( val . val64 , dest ) ; dest += sizeof ( u64 ) ; } while ( ( ( unsigned long ) dest & PIO_BLOCK_MASK ) != 0 ) { writeq ( 0 , dest ) ; dest += sizeof ( u64 ) ; } this_cpu_dec ( * pbuf -> sc -> buffers_allocated ) ; preempt_enable ( ) ; } 