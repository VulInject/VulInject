static void ibmf_saa_impl_prepare_response ( ibmf_handle_t ibmf_handle , ibmf_msg_t * msgp , boolean_t ignore_data , int * status , void * * result , size_t * length , boolean_t sleep_flag ) { ibmf_msg_bufs_t * resp_buf ; uint16_t attr_id ; uint8_t method ; boolean_t is_get_resp ; uint16_t mad_status ; uint16_t attr_offset ; ib_sa_hdr_t * sa_hdr ; IBMF_TRACE_0 ( IBMF_TNF_DEBUG , DPRINT_L4 , ibmf_saa_impl_prepare_response_start , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response() enter\n" ) ; _NOTE ( ASSUMING_PROTECTED ( * msgp ) ) * result = NULL ; * length = 0 ; sa_hdr = NULL ; resp_buf = & msgp -> im_msgbufs_recv ; _NOTE ( ) if ( msgp -> im_msg_status != IBMF_SUCCESS ) { IBMF_TRACE_2 ( IBMF_TNF_DEBUG , DPRINT_L2 , ibmf_saa_impl_prepare_response , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response: %s, msg_status = %d\n" , tnf_string , msg , "Bad ibmf status" , tnf_int , msg_status , msgp -> im_msg_status ) ; * status = msgp -> im_msg_status ; exit } if ( resp_buf -> im_bufs_mad_hdr == NULL ) { IBMF_TRACE_1 ( IBMF_TNF_DEBUG , DPRINT_L3 , ibmf_saa_impl_prepare_response , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response: %s\n" , tnf_string , msg , "Unsequenced transaction callback" ) ; exit } if ( ( mad_status = b2h16 ( resp_buf -> im_bufs_mad_hdr -> Status ) ) != MAD_STATUS_NO_INVALID_FIELDS ) { switch ( mad_status ) { case SA_STATUS_ERR_NO_RESOURCES : * status = IBMF_NO_RESOURCES ; break ; case SA_STATUS_ERR_REQ_INVALID : * status = IBMF_REQ_INVALID ; break ; case SA_STATUS_ERR_NO_RECORDS : * status = IBMF_NO_RECORDS ; break ; case SA_STATUS_ERR_TOO_MANY_RECORDS : * status = IBMF_TOO_MANY_RECORDS ; break ; case SA_STATUS_ERR_REQ_INVALID_GID : * status = IBMF_INVALID_GID ; break ; case SA_STATUS_ERR_REQ_INSUFFICIENT_COMPONENTS : * status = IBMF_INSUFF_COMPS ; break ; case MAD_STATUS_UNSUPP_METHOD : * status = IBMF_UNSUPP_METHOD ; break ; case MAD_STATUS_UNSUPP_METHOD_ATTR : * status = IBMF_UNSUPP_METHOD_ATTR ; break ; case MAD_STATUS_INVALID_FIELD : * status = IBMF_INVALID_FIELD ; break ; default : * status = IBMF_REQ_INVALID ; break ; } IBMF_TRACE_2 ( IBMF_TNF_DEBUG , DPRINT_L2 , ibmf_saa_impl_prepare_response , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response: %s, mad_status = %x\n" , tnf_string , msg , "Bad MAD status" , tnf_int , mad_status , mad_status ) ; exit } attr_id = b2h16 ( resp_buf -> im_bufs_mad_hdr -> AttributeID ) ; method = resp_buf -> im_bufs_mad_hdr -> R_Method ; IBMF_TRACE_2 ( IBMF_TNF_DEBUG , DPRINT_L3 , ibmf_saa_impl_prepare_response , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response: attr_id = 0x%x, method = " "0x%x\n" , tnf_opaque , attr_id , attr_id , tnf_opaque , method , method ) ; if ( method == SA_SUBN_ADM_DELETE_RESP ) { IBMF_TRACE_1 ( IBMF_TNF_DEBUG , DPRINT_L3 , ibmf_saa_impl_prepare_response , IBMF_TNF_TRACE , "" , "impf_saa_impl_prepare_response: %s\n" , tnf_string , msg , "DeleteResp or NoticeResp returned.  " "Ignoring response data" ) ; * status = IBMF_SUCCESS ; * length = 0 ; * result = NULL ; exit } if ( attr_id == SA_MULTIPATHRECORD_ATTRID ) { IBMF_TRACE_1 ( IBMF_TNF_NODEBUG , DPRINT_L1 , ibmf_saa_impl_prepare_response_err , IBMF_TNF_ERROR , "" , "ibmf_saa_impl_prepare_response: %s\n" , tnf_string , msg , "SA returned getmulti record" ) ; * status = IBMF_REQ_INVALID ; exit } if ( ignore_data == B_TRUE ) { * status = IBMF_SUCCESS ; exit } is_get_resp = resp_buf -> im_bufs_mad_hdr -> R_Method == SA_SUBN_ADM_GET_RESP ?B_TRUE : B_FALSE ; * status = ibmf_saa_utils_unpack_sa_hdr ( resp_buf -> im_bufs_cl_hdr , resp_buf -> im_bufs_cl_hdr_len , & sa_hdr , sleep_flag ) ; if ( * status != IBMF_SUCCESS ) { IBMF_TRACE_2 ( IBMF_TNF_DEBUG , DPRINT_L1 , ibmf_saa_impl_prepare_response_err , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response: %s," " ibmf_status = %d\n" , tnf_string , msg , "Could not unpack sa hdr" , tnf_int , ibmf_status , * status ) ; exit } attr_offset = sa_hdr -> AttributeOffset ; * status = ibmf_saa_utils_unpack_payload ( resp_buf -> im_bufs_cl_data , resp_buf -> im_bufs_cl_data_len , attr_id , result , length , attr_offset , is_get_resp , sleep_flag ) ; if ( * status == IBMF_SUCCESS ) { IBMF_TRACE_4 ( IBMF_TNF_DEBUG , DPRINT_L3 , ibmf_saa_impl_prepare_response , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response: attr_id = " "0x%x, attr_offset = %d, packed_payload_len = %d, " "unpacked_payload_len = %d\n" , tnf_opaque , attr_id , attr_id , tnf_opaque , attr_offset , attr_offset , tnf_opaque , packed_payload_len , resp_buf -> im_bufs_cl_data_len , tnf_opaque , unpacked_payload_len , * length ) ; } else { IBMF_TRACE_5 ( IBMF_TNF_DEBUG , DPRINT_L1 , ibmf_saa_impl_prepare_response_err , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response: %s," "attr_id = 0x%x, attr_offset = %d, packed_payload_len = %d," "status = %d\n" , tnf_string , msg , "Could not unpack payload" , tnf_opaque , attr_id , attr_id , tnf_int , attr_offset , attr_offset , tnf_int , packed_payload_len , resp_buf -> im_bufs_cl_data_len , tnf_int , status , * status ) ; } exit ibmf_saa_impl_free_msg ( ibmf_handle , msgp ) ; IBMF_TRACE_1 ( IBMF_TNF_DEBUG , DPRINT_L3 , ibmf_saa_impl_prepare_response_end , IBMF_TNF_TRACE , "" , "ibmf_saa_impl_prepare_response() exit," " status = 0x%d\n" , tnf_int , status , * status ) ; } 