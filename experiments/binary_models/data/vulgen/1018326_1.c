unsigned int install_e820_map ( unsigned int max_entries , struct e820_entry * entries ) { unsigned int num_entries = 0 ; const struct hob_header * hdr ; struct hob_res_desc * res_desc ; const fdt64_t * prop ; int size ; hdr = gd -> arch . hob_list ; while ( ! end_of_hob ( hdr ) ) { if ( hdr -> type == HOB_TYPE_RES_DESC ) { res_desc = ( hob_res_desc * ) hdr ; entries [ num_entries ] . addr = res_desc -> phys_start ; entries [ num_entries ] . size = res_desc -> len ; if ( res_desc -> type == RES_SYS_MEM ) { entries [ num_entries ] . type = E820_RAM ; } if ( res_desc -> type == RES_MEM_RESERVED ) { entries [ num_entries ] . type = E820_RESERVED ; } num_entries ++ ; } hdr = get_next_hob ( hdr ) ; } entries [ num_entries ] . addr = CONFIG_PCIE_ECAM_BASE ; entries [ num_entries ] . size = CONFIG_PCIE_ECAM_SIZE ; entries [ num_entries ] . type = E820_RESERVED ; num_entries ++ ; if ( IS_ENABLED ( CONFIG_HAVE_ACPI_RESUME ) ) { ulong stack_size ; stack_size = CONFIG_IS_ENABLED ( HAVE_ACPI_RESUME , ( CONFIG_STACK_SIZE_RESUME ) , ( 0 ) ) ; entries [ num_entries ] . addr = gd -> start_addr_sp - stack_size ; entries [ num_entries ] . size = gd -> ram_top - gd -> start_addr_sp + stack_size ; entries [ num_entries ] . type = E820_RESERVED ; num_entries ++ ; } prop = ofnode_read_chosen_prop ( "e820-entries" , & size ) ; if ( prop ) { int count = size / ( sizeof ( u64 ) * 3 ) ; int i ; for ( i = 0 ; i < count ; i ++ , num_entries ++ , prop += 3 ) { entries [ num_entries ] . addr = fdt64_to_cpu ( prop [ 0 ] ) ; entries [ num_entries ] . size = fdt64_to_cpu ( prop [ 1 ] ) ; entries [ num_entries ] . type = fdt64_to_cpu ( prop [ 2 ] ) ; } } return num_entries ; } 