static void mrpc_cmd_submit ( struct switchtec_dev * stdev ) { struct switchtec_user * stuser ; if ( stdev -> mrpc_busy ) { return ; } if ( list_empty ( & stdev -> mrpc_queue ) ) { return ; } stuser = list_entry ( stdev -> mrpc_queue . next , switchtec_user , list ) ; if ( stdev -> dma_mrpc ) { stdev -> dma_mrpc -> status = SWITCHTEC_MRPC_STATUS_INPROGRESS ; memset ( stdev -> dma_mrpc -> data , 0xFF , SWITCHTEC_MRPC_PAYLOAD_SIZE ) ; } stuser_set_state ( stuser , MRPC_RUNNING ) ; stdev -> mrpc_busy = 1 ; memcpy_toio ( & stdev -> mmio_mrpc -> input_data , stuser -> data , stuser -> data_len ) ; iowrite32 ( stuser -> cmd , & stdev -> mmio_mrpc -> cmd ) ; schedule_delayed_work ( & stdev -> mrpc_timeout , msecs_to_jiffies ( 500 ) ) ; } 