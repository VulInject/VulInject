static void gk104_fifo_recover_work ( struct work_struct * w ) { struct gk104_fifo * fifo = container_of ( w , typeof ( * fifo ) , recover . work ) ; struct nvkm_device * device = fifo -> base . engine . subdev . device ; struct nvkm_engine * engine ; unsigned long flags ; u32 engm , runm , todo ; int engn , runl ; spin_lock_irqsave ( & fifo -> base . lock , flags ) ; runm = fifo -> recover . runm ; engm = fifo -> recover . engm ; fifo -> recover . engm = 0 ; fifo -> recover . runm = 0 ; spin_unlock_irqrestore ( & fifo -> base . lock , flags ) ; nvkm_mask ( device , 0x002630 , runm , runm ) ; for ( todo = engm ; engn = __ffs ( todo ) , todo ; todo &= ~ BIT ( engn ) ) { if ( ( engine = fifo -> engine [ engn ] . engine ) ) { WARN_ON ( nvkm_subdev_init ( & engine -> subdev ) ) ; } } for ( todo = runm ; runl = __ffs ( todo ) , todo ; todo &= ~ BIT ( runl ) ) { gk104_fifo_runlist_commit ( fifo , runl ) ; } nvkm_wr32 ( device , 0x00262c , runm ) ; nvkm_mask ( device , 0x002630 , runm , 0x00000000 ) ; } 