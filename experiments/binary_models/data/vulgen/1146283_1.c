void kvmppc_giveup_ext ( struct kvm_vcpu * vcpu , ulong msr ) { struct thread_struct * t = & current -> thread ; if ( msr & MSR_VSX ) { msr |= MSR_FP | MSR_VEC ; } msr &= vcpu -> arch . guest_owned_ext ; if ( ! msr ) { return ; } printk ( KERN_INFO "Giving up ext 0x%lx\n" , msr ) ; if ( msr & MSR_FP ) { if ( t -> regs -> msr & MSR_FP ) { giveup_fpu ( current ) ; } t -> fp_save_area = NULL ; } if ( msr & MSR_VEC ) { if ( current -> thread . regs -> msr & MSR_VEC ) { giveup_altivec ( 0 ) ; } t -> vr_save_area = NULL ; } vcpu -> arch . guest_owned_ext &= ~ ( msr | MSR_VSX ) ; kvmppc_recalc_shadow_msr ( vcpu ) ; } 