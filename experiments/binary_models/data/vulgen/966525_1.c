int rarp_getipaddress ( int sock ) { struct iodesc * d ; struct ether_arp * ap ; void * pkt ; { u_char header [ ETHER_SIZE ] ; { struct ether_arp arp ; u_char pad [ 18 ] ; } , data } , wbuf if ( debug ) { printf ( "rarp: socket=%d\n" , sock ) ; } if ( ! ( d = socktodesc ( sock ) ) ) { printf ( "rarp: bad socket. %d\n" , sock ) ; return ( - 1 ) ; } if ( debug ) { printf ( "rarp: d=%x\n" , ( u_int ) d ) ; } bzero ( ( char * ) & wbuf . data , sizeof ( wbuf . data ) ) ; ap = & wbuf . data . arp ; ap -> arp_hrd = htons ( ARPHRD_ETHER ) ; ap -> arp_pro = htons ( ETHERTYPE_IP ) ; ap -> arp_hln = sizeof ( ap -> arp_sha ) ; ap -> arp_pln = sizeof ( ap -> arp_spa ) ; ap -> arp_op = htons ( ARPOP_REVREQUEST ) ; bcopy ( d -> myea , ap -> arp_sha , 6 ) ; bcopy ( d -> myea , ap -> arp_tha , 6 ) ; pkt = NULL ; if ( sendrecv ( d , rarpsend , & wbuf . data , sizeof ( wbuf . data ) , rarprecv , & pkt , ( void * ) & ap , NULL ) < 0 ) { printf ( "No response for RARP request\n" ) ; return ( - 1 ) ; } bcopy ( ap -> arp_tpa , ( char * ) & myip , sizeof ( myip ) ) ; bcopy ( ap -> arp_spa , ( char * ) & rootip , sizeof ( rootip ) ) ; if ( IN_CLASSA ( myip . s_addr ) ) { netmask = IN_CLASSA_NET ; } if ( IN_CLASSB ( myip . s_addr ) ) { netmask = IN_CLASSB_NET ; } else { netmask = IN_CLASSC_NET ; } d -> myip = myip ; return ( 0 ) ; } 