static int imx_icc_node_set ( struct icc_node * node ) { struct device * dev = node -> provider -> dev ; struct imx_icc_node * node_data = node -> data ; void __iomem * base ; u32 prio ; u64 freq ; if ( node_data -> setting && node -> peak_bw ) { base = node_data -> setting -> reg + node_data -> imx_provider -> noc_base ; if ( node_data -> setting -> mode == IMX_NOC_MODE_FIXED ) { prio = node_data -> setting -> prio_level ; prio = PRIORITY_COMP_MARK | ( prio << 8 ) | prio ; writel ( prio , base + IMX_NOC_PRIO_REG ) ; writel ( node_data -> setting -> mode , base + IMX_NOC_MODE_REG ) ; writel ( node_data -> setting -> ext_control , base + IMX_NOC_EXT_CTL_REG ) ; dev_dbg ( dev , "%s: mode: 0x%x, prio: 0x%x, ext_control: 0x%x\n" , node_data -> desc -> name , node_data -> setting -> mode , prio , node_data -> setting -> ext_control ) ; } if ( node_data -> setting -> mode == IMX_NOC_MODE_UNCONFIGURED ) { dev_dbg ( dev , "%s: mode not unconfigured\n" , node_data -> desc -> name ) ; } else { dev_info ( dev , "%s: mode: %d not supported\n" , node_data -> desc -> name , node_data -> setting -> mode ) ; return - EOPNOTSUPP ; } } freq = ( node -> avg_bw + node -> peak_bw ) * node_data -> desc -> adj -> bw_mul ; do_div ( freq , node_data -> desc -> adj -> bw_div ) ; dev_dbg ( dev , "node %s device %s avg_bw %ukBps peak_bw %ukBps min_freq %llukHz\n" , node -> name , dev_name ( node_data -> qos_dev ) , node -> avg_bw , node -> peak_bw , freq ) ; if ( freq > S32_MAX ) { dev_err ( dev , "%s can't request more than S32_MAX freq\n" , node -> name ) ; return - ERANGE ; } dev_pm_qos_update_request ( & node_data -> qos_req , freq ) ; return 0 ; } 