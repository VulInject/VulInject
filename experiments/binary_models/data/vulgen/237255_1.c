int uwb_drp_ie_update ( struct uwb_rsv * rsv ) { struct uwb_ie_drp * drp_ie ; struct uwb_rsv_move * mv ; int unsafe ; if ( rsv -> state == UWB_RSV_STATE_NONE ) { rsv -> drp_ie = NULL ; return 0 ; } unsafe = rsv -> mas . unsafe ?1 : 0 ; if ( rsv -> drp_ie == NULL ) { rsv -> drp_ie = uwb_drp_ie_alloc ( ) ; if ( rsv -> drp_ie == NULL ) { return - ENOMEM ; } } drp_ie = rsv -> drp_ie ; uwb_ie_drp_set_unsafe ( drp_ie , unsafe ) ; uwb_ie_drp_set_tiebreaker ( drp_ie , rsv -> tiebreaker ) ; uwb_ie_drp_set_owner ( drp_ie , uwb_rsv_is_owner ( rsv ) ) ; uwb_ie_drp_set_status ( drp_ie , uwb_rsv_status ( rsv ) ) ; uwb_ie_drp_set_reason_code ( drp_ie , uwb_rsv_reason_code ( rsv ) ) ; uwb_ie_drp_set_stream_index ( drp_ie , rsv -> stream ) ; uwb_ie_drp_set_type ( drp_ie , rsv -> type ) ; if ( uwb_rsv_is_owner ( rsv ) ) { switch ( rsv -> target . type ) { case UWB_RSV_TARGET_DEV : drp_ie -> dev_addr = rsv -> target . dev -> dev_addr ; break ; case UWB_RSV_TARGET_DEVADDR : drp_ie -> dev_addr = rsv -> target . devaddr ; break ; } } else { drp_ie -> dev_addr = rsv -> owner -> dev_addr ; } uwb_drp_ie_from_bm ( drp_ie , & rsv -> mas ) ; if ( uwb_rsv_has_two_drp_ies ( rsv ) ) { mv = & rsv -> mv ; if ( mv -> companion_drp_ie == NULL ) { mv -> companion_drp_ie = uwb_drp_ie_alloc ( ) ; if ( mv -> companion_drp_ie == NULL ) { return - ENOMEM ; } } drp_ie = mv -> companion_drp_ie ; memcpy ( drp_ie , rsv -> drp_ie , sizeof ( uwb_ie_drp ) ) ; uwb_ie_drp_set_unsafe ( drp_ie , 1 ) ; uwb_ie_drp_set_status ( drp_ie , uwb_rsv_companion_status ( rsv ) ) ; uwb_ie_drp_set_reason_code ( drp_ie , uwb_rsv_companion_reason_code ( rsv ) ) ; uwb_drp_ie_from_bm ( drp_ie , & mv -> companion_mas ) ; } rsv -> ie_valid = true ; return 0 ; } 