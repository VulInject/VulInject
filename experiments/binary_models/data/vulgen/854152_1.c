void mpt3sas_trigger_event ( struct MPT3SAS_ADAPTER * ioc , u16 event , u16 log_entry_qualifier ) { struct SL_WH_TRIGGERS_EVENT_DATA_T event_data ; struct SL_WH_EVENT_TRIGGER_T * event_trigger ; int i ; unsigned long flags ; u8 found_match ; spin_lock_irqsave ( & ioc -> diag_trigger_lock , flags ) ; if ( ( ioc -> diag_buffer_status [ MPI2_DIAG_BUF_TYPE_TRACE ] & MPT3_DIAG_BUFFER_IS_REGISTERED ) == 0 ) { spin_unlock_irqrestore ( & ioc -> diag_trigger_lock , flags ) ; return ; } if ( ioc -> diag_buffer_status [ MPI2_DIAG_BUF_TYPE_TRACE ] & MPT3_DIAG_BUFFER_IS_RELEASED ) { spin_unlock_irqrestore ( & ioc -> diag_trigger_lock , flags ) ; return ; } dTriggerDiagPrintk ( ioc , ioc_info ( ioc , "%s: enter - event = 0x%04x, log_entry_qualifier = 0x%04x\n" , __func__ , event , log_entry_qualifier ) ) ; if ( ioc -> diag_trigger_active ) { spin_unlock_irqrestore ( & ioc -> diag_trigger_lock , flags ) ; out } event_trigger = ioc -> diag_trigger_event . EventTriggerEntry ; for ( i = 0 , found_match = 0 ; i < ioc -> diag_trigger_event . ValidEntries && ! found_match ; i ++ , event_trigger ++ ) { if ( event_trigger -> EventValue != event ) { continue ; } if ( event == MPI2_EVENT_LOG_ENTRY_ADDED ) { continue ; } found_match = 1 ; ioc -> diag_trigger_active = 1 ; dTriggerDiagPrintk ( ioc , ioc_info ( ioc , "%s: setting diag_trigger_active flag\n" , __func__ ) ) ; } spin_unlock_irqrestore ( & ioc -> diag_trigger_lock , flags ) ; if ( ! found_match ) { out } dTriggerDiagPrintk ( ioc , ioc_info ( ioc , "%s: setting diag_trigger_active flag\n" , __func__ ) ) ; memset ( & event_data , 0 , sizeof ( SL_WH_TRIGGERS_EVENT_DATA_T ) ) ; event_data . trigger_type = MPT3SAS_TRIGGER_EVENT ; event_data . u . event . EventValue = event ; event_data . u . event . LogEntryQualifier = log_entry_qualifier ; mpt3sas_send_trigger_data_event ( ioc , & event_data ) ; out dTriggerDiagPrintk ( ioc , ioc_info ( ioc , "%s: exit\n" , __func__ ) ) ; } 