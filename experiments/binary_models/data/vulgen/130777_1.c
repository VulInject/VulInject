static int snd_sb_csp_stop ( struct snd_sb_csp * p ) { int result ; unsigned char mixL , mixR ; unsigned long flags ; if ( ! ( p -> running & SNDRV_SB_CSP_ST_RUNNING ) ) { return 0 ; } spin_lock_irqsave ( & p -> chip -> mixer_lock , flags ) ; mixL = snd_sbmixer_read ( p -> chip , SB_DSP4_PCM_DEV ) ; mixR = snd_sbmixer_read ( p -> chip , SB_DSP4_PCM_DEV + 1 ) ; snd_sbmixer_write ( p -> chip , SB_DSP4_PCM_DEV , mixL & 0x7 ) ; snd_sbmixer_write ( p -> chip , SB_DSP4_PCM_DEV + 1 , mixR & 0x7 ) ; spin_unlock_irqrestore ( & p -> chip -> mixer_lock , flags ) ; spin_lock ( & p -> chip -> reg_lock ) ; result = set_mode_register ( p -> chip , 0xc0 ) ; spin_unlock ( & p -> chip -> reg_lock ) ; spin_lock_irqsave ( & p -> chip -> mixer_lock , flags ) ; snd_sbmixer_write ( p -> chip , SB_DSP4_PCM_DEV , mixL ) ; snd_sbmixer_write ( p -> chip , SB_DSP4_PCM_DEV + 1 , mixR ) ; spin_unlock_irqrestore ( & p -> chip -> mixer_lock , flags ) ; if ( ! ( result ) ) { p -> running &= ~ ( SNDRV_SB_CSP_ST_PAUSED | SNDRV_SB_CSP_ST_RUNNING ) ; } return result ; } 