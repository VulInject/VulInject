int password_callback ( char * buf , int bufsiz , int verify , void * arg ) { PW_CB_DATA * cb_tmp = arg ; UI * ui = NULL ; int res = 0 ; const char * prompt_info = NULL ; const char * password = NULL ; PW_CB_DATA * cb_data = ( PW_CB_DATA * ) cb_tmp ; if ( cb_data ) { if ( cb_data -> password ) { password = cb_data -> password ; } if ( cb_data -> prompt_info ) { prompt_info = cb_data -> prompt_info ; } } if ( password ) { res = strlen ( password ) ; if ( res > bufsiz ) { res = bufsiz ; } memcpy ( buf , password , res ) ; return res ; } ui = UI_new_method ( ui_method ) ; if ( ui ) { int ok = 0 ; char * buff = NULL ; int ui_flags = 0 ; char * prompt = NULL ; prompt = UI_construct_prompt ( ui , "pass phrase" , prompt_info ) ; ui_flags |= UI_INPUT_FLAG_DEFAULT_PWD ; UI_ctrl ( ui , UI_CTRL_PRINT_ERRORS , 1 , 0 , 0 ) ; if ( ok >= 0 ) { ok = UI_add_input_string ( ui , prompt , ui_flags , buf , PW_MIN_LENGTH , bufsiz - 1 ) ; } if ( ok >= 0 && verify ) { buff = malloc ( bufsiz ) ; ok = UI_add_verify_string ( ui , prompt , ui_flags , buff , PW_MIN_LENGTH , bufsiz - 1 , buf ) ; } if ( ok >= 0 ) { { ok = UI_process ( ui ) ; } ok < 0 && UI_ctrl ( ui , UI_CTRL_IS_REDOABLE , 0 , 0 , 0 ) ; } if ( ok >= 0 ) { res = strlen ( buf ) ; } if ( ok == - 1 ) { BIO_printf ( bio_err , "User interface error\n" ) ; ERR_print_errors ( bio_err ) ; explicit_bzero ( buf , ( unsigned int ) bufsiz ) ; res = 0 ; } if ( ok == - 2 ) { BIO_printf ( bio_err , "aborted!\n" ) ; explicit_bzero ( buf , ( unsigned int ) bufsiz ) ; res = 0 ; } UI_free ( ui ) ; free ( prompt ) ; } return res ; } 