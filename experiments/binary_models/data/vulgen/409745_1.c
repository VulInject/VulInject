static int calcsb ( calcsb_t style , caddr_t dev , int devfd , struct fs * fs ) { int child_pipe [ 2 ] ; caddr_t mkfsline [ ] { "" "-o" "calcbinsb,N" NULL NULL NULL } ; ; caddr_t newfsline [ ] { "" "-B" "-N" NULL NULL } ; ; int pending , transferred ; caddr_t * cmdline ; caddr_t target ; caddr_t sizestr = NULL ; caddr_t path_old , path_new , mkfs_dir , mkfs_path , newfs_path ; caddr_t slash ; diskaddr_t size ; int devnull ; switch ( style ) { case MKFS_STYLE : if ( debug ) { ( void ) printf ( "calcsb() going with style MKFS\n" ) ; } cmdline = mkfsline ; break ; case NEWFS_STYLE : if ( debug ) { ( void ) printf ( "calcsb() going with style NEWFS\n" ) ; } cmdline = newfsline ; break ; default : if ( debug ) { ( void ) printf ( "calcsb() doesn't undestand style %d\n" , style ) ; } return ( 0 ) ; } cmdline [ DEV_IDX ] = dev ; mkfs_path = getenv ( "MKFS_PATH" ) ; if ( ! debug || ( mkfs_path == NULL ) ) { mkfs_path = MKFS_PATH ; } newfs_path = getenv ( "NEWFS_PATH" ) ; if ( ! debug || ( newfs_path == NULL ) ) { newfs_path = NEWFS_PATH ; } if ( style == MKFS_STYLE ) { cmdline [ CMD_IDX ] = mkfs_path ; size = getdisksize ( dev , devfd ) ; if ( size == 0 ) { return ( 0 ) ; } cmdline [ SIZE_IDX ] = sizestr ; } if ( style == NEWFS_STYLE ) { cmdline [ CMD_IDX ] = newfs_path ; path_old = getenv ( "PATH" ) ; mkfs_dir = strdup ( mkfs_path ) ; if ( mkfs_dir == NULL ) { return ( 0 ) ; } slash = strrchr ( mkfs_dir , '/' ) ; if ( slash != NULL ) { * slash = '\0' ; ( void ) fsck_asprintf ( & path_new , "PATH=%s:%s" , mkfs_dir , path_old ) ; if ( putenv ( path_new ) != 0 ) { free ( mkfs_dir ) ; free ( path_new ) ; return ( 0 ) ; } } free ( mkfs_dir ) ; } else { if ( debug ) { ( void ) printf ( "calcsb: got bad style number %d\n" , ( int ) style ) ; } return ( 0 ) ; } if ( pipe ( child_pipe ) < 0 ) { pfatal ( "calcsb: could not create pipe: %s\n" , strerror ( errno ) ) ; if ( sizestr != NULL ) { free ( sizestr ) ; } return ( 0 ) ; } switch ( fork ( ) ) { case - 1 : pfatal ( "calcsb: fork failed: %s\n" , strerror ( errno ) ) ; if ( sizestr != NULL ) { free ( sizestr ) ; } return ( 0 ) ; case 0 : if ( dup2 ( child_pipe [ TO_FSCK ] , fileno ( stdout ) ) < 0 ) { ( void ) printf ( "calcsb: could not rename file descriptor: %s\n" , strerror ( errno ) ) ; exit ( EXBADPARM ) ; } devnull = open ( "/dev/null" , O_WRONLY ) ; if ( devnull == - 1 ) { ( void ) printf ( "calcsb: could not open /dev/null: %s\n" , strerror ( errno ) ) ; exit ( EXBADPARM ) ; } if ( dup2 ( devnull , fileno ( stderr ) ) < 0 ) { ( void ) printf ( "calcsb: could not rename file descriptor: %s\n" , strerror ( errno ) ) ; exit ( EXBADPARM ) ; } ( void ) close ( child_pipe [ FROM_CHILD ] ) ; ( void ) execv ( cmdline [ CMD_IDX ] , cmdline ) ; ( void ) printf ( "calcsb: could not exec %s: %s\n" , cmdline [ CMD_IDX ] , strerror ( errno ) ) ; exit ( EXBADPARM ) ; default : break ; } ( void ) close ( child_pipe [ TO_FSCK ] ) ; if ( sizestr != NULL ) { free ( sizestr ) ; } pending = sizeof ( fs ) ; target = ( caddr_t ) fs ; { transferred = read ( child_pipe [ FROM_CHILD ] , target , pending ) ; pending -= transferred ; target += transferred ; } ( pending > 0 ) && ( transferred > 0 ) ; if ( pending > 0 ) { if ( transferred < 0 ) { pfatal ( "calcsb: binary read of superblock from %s failed: %s\n" , ( style == MKFS_STYLE ) ?"mkfs" : "newfs" , ( transferred < 0 ) ?strerror ( errno ) : "" ) ; } else { pfatal ( "calcsb: short read of superblock from %s\n" , ( style == MKFS_STYLE ) ?"mkfs" : "newfs" ) ; } return ( 0 ) ; } ( void ) close ( child_pipe [ FROM_CHILD ] ) ; ( void ) wait ( NULL ) ; if ( ( fs -> fs_magic != FS_MAGIC ) && ( fs -> fs_magic != MTB_UFS_MAGIC ) ) { return ( 0 ) ; } return ( 1 ) ; } 