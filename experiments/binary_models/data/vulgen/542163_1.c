void bpf_jit_build_prologue ( struct rv_jit_context * ctx ) { int i , stack_adjust = 0 , store_offset , bpf_stack_adjust ; bpf_stack_adjust = round_up ( ctx -> prog -> aux -> stack_depth , 16 ) ; if ( bpf_stack_adjust ) { mark_fp ( ctx ) ; } if ( seen_reg ( RV_REG_RA , ctx ) ) { stack_adjust += 8 ; } stack_adjust += 8 ; if ( seen_reg ( RV_REG_S1 , ctx ) ) { stack_adjust += 8 ; } if ( seen_reg ( RV_REG_S2 , ctx ) ) { stack_adjust += 8 ; } if ( seen_reg ( RV_REG_S3 , ctx ) ) { stack_adjust += 8 ; } if ( seen_reg ( RV_REG_S4 , ctx ) ) { stack_adjust += 8 ; } if ( seen_reg ( RV_REG_S5 , ctx ) ) { stack_adjust += 8 ; } if ( seen_reg ( RV_REG_S6 , ctx ) ) { stack_adjust += 8 ; } stack_adjust = round_up ( stack_adjust , 16 ) ; stack_adjust += bpf_stack_adjust ; store_offset = stack_adjust - 8 ; for ( i = 0 ; i < 4 ; i ++ ) { emit ( rv_nop ( ) , ctx ) ; } emit ( rv_addi ( RV_REG_TCC , RV_REG_ZERO , MAX_TAIL_CALL_CNT ) , ctx ) ; emit_addi ( RV_REG_SP , RV_REG_SP , - stack_adjust , ctx ) ; if ( seen_reg ( RV_REG_RA , ctx ) ) { emit_sd ( RV_REG_SP , store_offset , RV_REG_RA , ctx ) ; store_offset -= 8 ; } store_offset -= 8 ; if ( seen_reg ( RV_REG_S1 , ctx ) ) { emit_sd ( RV_REG_SP , store_offset , RV_REG_S1 , ctx ) ; store_offset -= 8 ; } if ( seen_reg ( RV_REG_S2 , ctx ) ) { emit_sd ( RV_REG_SP , store_offset , RV_REG_S2 , ctx ) ; store_offset -= 8 ; } if ( seen_reg ( RV_REG_S3 , ctx ) ) { emit_sd ( RV_REG_SP , store_offset , RV_REG_S3 , ctx ) ; store_offset -= 8 ; } if ( seen_reg ( RV_REG_S4 , ctx ) ) { emit_sd ( RV_REG_SP , store_offset , RV_REG_S4 , ctx ) ; store_offset -= 8 ; } if ( seen_reg ( RV_REG_S5 , ctx ) ) { emit_sd ( RV_REG_SP , store_offset , RV_REG_S5 , ctx ) ; store_offset -= 8 ; } if ( seen_reg ( RV_REG_S6 , ctx ) ) { emit_sd ( RV_REG_SP , store_offset , RV_REG_S6 , ctx ) ; store_offset -= 8 ; } emit_addi ( RV_REG_FP , RV_REG_SP , stack_adjust , ctx ) ; if ( bpf_stack_adjust ) { emit_addi ( RV_REG_S5 , RV_REG_SP , bpf_stack_adjust , ctx ) ; } if ( seen_tail_call ( ctx ) && seen_call ( ctx ) ) { emit_mv ( RV_REG_TCC_SAVED , RV_REG_TCC , ctx ) ; } ctx -> stack_size = stack_adjust ; } 