static void hantro_g1_mpeg2_dec_set_buffers ( struct hantro_dev * vpu , struct hantro_ctx * ctx , struct vb2_buffer * src_buf , struct vb2_buffer * dst_buf , const struct v4l2_ctrl_mpeg2_sequence * seq , const struct v4l2_ctrl_mpeg2_picture * pic ) { dma_addr_t forward_addr = 0 , backward_addr = 0 ; dma_addr_t current_addr , addr ; switch ( pic -> picture_coding_type ) { case V4L2_MPEG2_PIC_CODING_TYPE_B : backward_addr = hantro_get_ref ( ctx , pic -> backward_ref_ts ) ; fallthrough ; case V4L2_MPEG2_PIC_CODING_TYPE_P : forward_addr = hantro_get_ref ( ctx , pic -> forward_ref_ts ) ; } addr = vb2_dma_contig_plane_dma_addr ( src_buf , 0 ) ; vdpu_write_relaxed ( vpu , addr , G1_REG_RLC_VLC_BASE ) ; addr = hantro_get_dec_buf_addr ( ctx , dst_buf ) ; current_addr = addr ; if ( pic -> picture_structure == V4L2_MPEG2_PIC_BOTTOM_FIELD ) { addr += ALIGN ( ctx -> dst_fmt . width , 16 ) ; } vdpu_write_relaxed ( vpu , addr , G1_REG_DEC_OUT_BASE ) ; if ( ! backward_addr ) { backward_addr = current_addr ; } if ( pic -> picture_structure == V4L2_MPEG2_PIC_FRAME || pic -> picture_coding_type == V4L2_MPEG2_PIC_CODING_TYPE_B || ( pic -> picture_structure == V4L2_MPEG2_PIC_TOP_FIELD && pic -> flags & V4L2_MPEG2_PIC_FLAG_TOP_FIELD_FIRST ) || ( pic -> picture_structure == V4L2_MPEG2_PIC_BOTTOM_FIELD && ! ( pic -> flags & V4L2_MPEG2_PIC_FLAG_TOP_FIELD_FIRST ) ) ) { vdpu_write_relaxed ( vpu , forward_addr , G1_REG_REFER0_BASE ) ; vdpu_write_relaxed ( vpu , forward_addr , G1_REG_REFER1_BASE ) ; } if ( pic -> picture_structure == V4L2_MPEG2_PIC_TOP_FIELD ) { vdpu_write_relaxed ( vpu , forward_addr , G1_REG_REFER0_BASE ) ; vdpu_write_relaxed ( vpu , current_addr , G1_REG_REFER1_BASE ) ; } if ( pic -> picture_structure == V4L2_MPEG2_PIC_BOTTOM_FIELD ) { vdpu_write_relaxed ( vpu , current_addr , G1_REG_REFER0_BASE ) ; vdpu_write_relaxed ( vpu , forward_addr , G1_REG_REFER1_BASE ) ; } vdpu_write_relaxed ( vpu , backward_addr , G1_REG_REFER2_BASE ) ; vdpu_write_relaxed ( vpu , backward_addr , G1_REG_REFER3_BASE ) ; } 