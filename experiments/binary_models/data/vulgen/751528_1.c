irqreturn_t snd_sb16dsp_interrupt ( int irq , void * dev_id ) { struct snd_sb * chip = dev_id ; unsigned char status ; int ok ; spin_lock ( & chip -> mixer_lock ) ; status = snd_sbmixer_read ( chip , SB_DSP4_IRQSTATUS ) ; spin_unlock ( & chip -> mixer_lock ) ; if ( status & SB_IRQTYPE_8BIT ) { ok = 0 ; if ( chip -> mode & SB_MODE_PLAYBACK_8 ) { snd_pcm_period_elapsed ( chip -> playback_substream ) ; snd_sb16_csp_update ( chip ) ; ok ++ ; } if ( chip -> mode & SB_MODE_CAPTURE_8 ) { snd_pcm_period_elapsed ( chip -> capture_substream ) ; ok ++ ; } spin_lock ( & chip -> reg_lock ) ; if ( ! ok ) { snd_sbdsp_command ( chip , SB_DSP_DMA8_OFF ) ; } snd_sb_ack_8bit ( chip ) ; spin_unlock ( & chip -> reg_lock ) ; } if ( status & SB_IRQTYPE_16BIT ) { ok = 0 ; if ( chip -> mode & SB_MODE_PLAYBACK_16 ) { snd_pcm_period_elapsed ( chip -> playback_substream ) ; snd_sb16_csp_update ( chip ) ; ok ++ ; } if ( chip -> mode & SB_MODE_CAPTURE_16 ) { snd_pcm_period_elapsed ( chip -> capture_substream ) ; ok ++ ; } spin_lock ( & chip -> reg_lock ) ; if ( ! ok ) { snd_sbdsp_command ( chip , SB_DSP_DMA16_OFF ) ; } snd_sb_ack_16bit ( chip ) ; spin_unlock ( & chip -> reg_lock ) ; } return IRQ_HANDLED ; } 