URIHANDLER_FUNC ( ) { plugin_data * const p = p_d ; struct burl_parts_t burl ; pcre_keyvalue_ctx ctx ; handler_t rc ; mod_redirect_patch_config ( r , p ) ; if ( ! p -> conf . redirect || ! p -> conf . redirect -> used ) { return HANDLER_GO_ON ; } ctx . cache = NULL ; if ( p -> conf . redirect -> x0 ) { ctx . cache = r -> cond_match [ p -> conf . redirect -> x0 - 1 ] ; } ctx . burl = & burl ; burl . scheme = & r -> uri . scheme ; burl . authority = & r -> uri . authority ; burl . port = sock_addr_get_port ( & r -> con -> srv_socket -> addr ) ; burl . path = & r -> target ; burl . query = & r -> uri . query ; if ( buffer_is_blank ( burl . authority ) ) { burl . authority = r -> server_name ; } buffer * const tb = r -> tmp_buf ; rc = pcre_keyvalue_buffer_process ( p -> conf . redirect , & ctx , & r -> target , tb ) ; if ( HANDLER_FINISHED == rc ) { http_header_response_set ( r , HTTP_HEADER_LOCATION , CONST_STR_LEN ( "Location" ) , BUF_PTR_LEN ( tb ) ) ; r -> http_status = p -> conf . redirect_code ; r -> handler_module = NULL ; r -> resp_body_finished = 1 ; } return rc ; } 