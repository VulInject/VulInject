int ipxrtr_route_packet ( struct sock * sk , struct sockaddr_ipx * usipx , struct msghdr * msg , size_t len , int noblock ) { struct sk_buff * skb ; struct ipx_sock * ipxs = ipx_sk ( sk ) ; struct ipx_interface * intrfc ; struct ipxhdr * ipx ; size_t size ; int ipx_offset ; struct ipx_route * rt = NULL ; int rc ; if ( ! usipx -> sipx_network && ipx_primary_net ) { usipx -> sipx_network = ipx_primary_net -> if_netnum ; intrfc = ipx_primary_net ; } else { rt = ipxrtr_lookup ( usipx -> sipx_network ) ; rc = - ENETUNREACH ; intrfc = rt -> ir_intrfc ; } ipxitf_hold ( intrfc ) ; ipx_offset = intrfc -> if_ipx_offset ; size = sizeof ( ipxhdr ) + len + ipx_offset ; skb = sock_alloc_send_skb ( sk , size , noblock , & rc ) ; if ( ! skb ) { out_put } skb_reserve ( skb , ipx_offset ) ; skb -> sk = sk ; skb_reset_network_header ( skb ) ; skb_reset_transport_header ( skb ) ; skb_put ( skb , sizeof ( ipxhdr ) ) ; ipx = ipx_hdr ( skb ) ; ipx -> ipx_pktsize = htons ( len + sizeof ( ipxhdr ) ) ; IPX_SKB_CB ( skb ) -> ipx_tctrl = 0 ; ipx -> ipx_type = usipx -> sipx_type ; IPX_SKB_CB ( skb ) -> last_hop . index = - 1 ; IPX_SKB_CB ( skb ) -> ipx_source_net = ipxs -> intrfc -> if_netnum ; memcpy ( ipx -> ipx_source . node , ipxs -> node , IPX_NODE_LEN ) ; rc = ntohs ( ipxs -> port ) ; if ( rc == 0x453 || rc == 0x452 ) { IPX_SKB_CB ( skb ) -> ipx_source_net = intrfc -> if_netnum ; memcpy ( ipx -> ipx_source . node , intrfc -> if_node , IPX_NODE_LEN ) ; } else { IPX_SKB_CB ( skb ) -> ipx_source_net = ipxs -> intrfc -> if_netnum ; memcpy ( ipx -> ipx_source . node , ipxs -> intrfc -> if_node , IPX_NODE_LEN ) ; } ipx -> ipx_source . sock = ipxs -> port ; IPX_SKB_CB ( skb ) -> ipx_dest_net = usipx -> sipx_network ; memcpy ( ipx -> ipx_dest . node , usipx -> sipx_node , IPX_NODE_LEN ) ; ipx -> ipx_dest . sock = usipx -> sipx_port ; rc = memcpy_from_msg ( skb_put ( skb , len ) , msg , len ) ; if ( rc ) { kfree_skb ( skb ) ; out_put } if ( sk -> sk_no_check_tx || intrfc -> if_dlink_type == htons ( IPX_FRAME_8023 ) ) { ipx -> ipx_checksum = htons ( 0xFFFF ) ; } else { ipx -> ipx_checksum = ipx_cksum ( ipx , len + sizeof ( ipxhdr ) ) ; } rc = ipxitf_send ( intrfc , skb , ( rt && rt -> ir_routed ) ?rt -> ir_router_node : ipx -> ipx_dest . node ) ; out_put ipxitf_put ( intrfc ) ; if ( rt ) { ipxrtr_put ( rt ) ; } out return rc ; } 