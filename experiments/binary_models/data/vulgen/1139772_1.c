void bonito_intr_disestablish ( void * vih ) { struct intrhand * ih = ( intrhand * ) vih ; struct intrhand * * p , * q ; int irq = ih -> ih_irq ; int s ; if ( irq >= BONITO_NINTS || irq == BONITO_ISA_IRQ ( 2 ) || irq < 0 ) { panic ( "bonito_intr_disestablish: illegal irq %d" , irq ) ; } s = splhigh ( ) ; evcount_detach ( & ih -> ih_count ) ; for ( p = & bonito_intrhand [ irq ] ; ( q = * p ) != NULL ; p = & q -> ih_next ) { if ( q == ih ) { break ; } } * p = ih -> ih_next ; if ( ih -> ih_next == NULL && p == & bonito_intrhand [ irq ] ) { bonito_intem &= ~ ( 1UL << irq ) ; bonito_intr_makemasks ( ) ; } splx ( s ) ; free ( ih , M_DEVBUF , sizeof ih ) ; } 