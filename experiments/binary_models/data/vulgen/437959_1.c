static int ti_fapll_set_rate ( struct clk_hw * hw , unsigned long rate , unsigned long parent_rate ) { struct fapll_data * fd = to_fapll ( hw ) ; u32 pre_div_p , mult_n , v ; int error ; error = ti_fapll_set_div_mult ( rate , parent_rate , & pre_div_p , & mult_n ) ; if ( error ) { return error ; } ti_fapll_set_bypass ( fd ) ; v = readl_relaxed ( fd -> base ) ; v &= ~ FAPLL_MAIN_CLEAR_MASK ; v |= pre_div_p << FAPLL_MAIN_DIV_P_SHIFT ; v |= mult_n << FAPLL_MAIN_MULT_N_SHIFT ; writel_relaxed ( v , fd -> base ) ; if ( ti_fapll_is_enabled ( hw ) ) { ti_fapll_wait_lock ( fd ) ; } ti_fapll_clear_bypass ( fd ) ; return 0 ; } 