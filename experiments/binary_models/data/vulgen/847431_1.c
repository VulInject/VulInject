static int __mlx5_lag_dev_add_mdev ( struct mlx5_core_dev * dev ) { struct mlx5_lag * ldev = NULL ; struct mlx5_core_dev * tmp_dev ; tmp_dev = mlx5_get_next_phys_dev_lag ( dev ) ; if ( tmp_dev ) { ldev = mlx5_lag_dev ( tmp_dev ) ; } if ( ! ldev ) { ldev = mlx5_lag_dev_alloc ( dev ) ; if ( ! ldev ) { mlx5_core_err ( dev , "Failed to alloc lag dev\n" ) ; return 0 ; } mlx5_ldev_add_mdev ( ldev , dev ) ; return 0 ; } mutex_lock ( & ldev -> lock ) ; if ( ldev -> mode_changes_in_progress ) { return - EAGAIN ; } mlx5_ldev_get ( ldev ) ; mlx5_ldev_add_mdev ( ldev , dev ) ; mutex_unlock ( & ldev -> lock ) ; return 0 ; } 