int ThreadPoolAddPersistent ( ThreadPool * tp , ThreadPoolJob * job , int * jobId ) { int ret = 0 ; int tempId = - 1 ; ThreadPoolJob * temp = NULL ; if ( ! jobId ) { jobId = & tempId ; } * jobId = INVALID_JOB_ID ; ithread_mutex_lock ( & tp -> mutex ) ; if ( tp -> totalThreads < tp -> attr . maxThreads ) { CreateWorker ( tp ) ; } else { if ( tp -> totalThreads - tp -> persistentThreads - 1 == 0 ) { ret = EMAXTHREADS ; exit_function } } temp = CreateThreadPoolJob ( job , tp -> lastJobId , tp ) ; if ( ! temp ) { ret = EOUTOFMEM ; exit_function } tp -> persistentJob = temp ; ithread_cond_signal ( & tp -> condition ) ; while ( tp -> persistentJob ) { ithread_cond_wait ( & tp -> start_and_shutdown , & tp -> mutex ) ; } * jobId = tp -> lastJobId ++ ; exit_function ithread_mutex_unlock ( & tp -> mutex ) ; return ret ; } 