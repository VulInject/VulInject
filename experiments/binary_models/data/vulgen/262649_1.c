static int atmel_aes_crypt ( struct ablkcipher_request * req , unsigned long mode ) { struct atmel_aes_base_ctx * ctx ; struct atmel_aes_reqctx * rctx ; struct atmel_aes_dev * dd ; ctx = crypto_ablkcipher_ctx ( crypto_ablkcipher_reqtfm ( req ) ) ; switch ( mode & AES_FLAGS_OPMODE_MASK ) { case AES_FLAGS_CFB8 : ctx -> block_size = CFB8_BLOCK_SIZE ; break ; case AES_FLAGS_CFB16 : ctx -> block_size = CFB16_BLOCK_SIZE ; break ; case AES_FLAGS_CFB32 : ctx -> block_size = CFB32_BLOCK_SIZE ; break ; case AES_FLAGS_CFB64 : ctx -> block_size = CFB64_BLOCK_SIZE ; break ; default : ctx -> block_size = AES_BLOCK_SIZE ; break ; } dd = atmel_aes_find_dev ( ctx ) ; rctx = ablkcipher_request_ctx ( req ) ; rctx -> mode = mode ; return atmel_aes_handle_queue ( dd , & req -> base ) ; } 