int nsock_pcap_open ( nsock_pool nsp , nsock_iod nsiod , const char * pcap_device , int snaplen , int promisc , const char * bpf_fmt , ... ) { struct niod * nsi = ( niod * ) nsiod ; struct npool * ms = ( npool * ) nsp ; mspcap * mp = ( mspcap * ) nsi -> pcap ; char errbuf [ PCAP_ERRBUF_SIZE ] ; char bpf [ 4096 ] ; va_list ap ; int failed , datalink ; int rc ; int to_ms = 357913941 ; int to_ms = 200 ; int to_ms = 1 ; gettimeofday ( & nsock_tod , NULL ) ; mp = ( mspcap * ) safe_zalloc ( sizeof ( mspcap ) ) ; nsi -> pcap = ( void * ) mp ; va_start ( ap , bpf_fmt ) ; rc = Vsnprintf ( bpf , sizeof ( bpf ) , bpf_fmt , ap ) ; va_end ( ap ) ; if ( rc >= ( int ) sizeof ( bpf ) ) { nsock_log_error ( "Too-large bpf filter argument" ) ; return - 1 ; } nsock_log_info ( "PCAP requested on device '%s' with berkeley filter '%s' " "(promisc=%i snaplen=%i to_ms=%i) (IOD #%li)" , pcap_device , bpf , promisc , snaplen , to_ms , nsi -> id ) ; mp -> pt = pcap_open_live ( pcap_device , snaplen , promisc , to_ms , errbuf ) ; if ( ! mp -> pt ) { nsock_log_error ( "pcap_open_live(%s, %d, %d, %d) failed with error: %s" , pcap_device , snaplen , promisc , to_ms , errbuf ) ; nsock_log_error ( PCAP_FAILURE_EXPL_MESSAGE ) ; nsock_log_error ( "Can't open pcap! Are you root?" ) ; return - 1 ; } mp -> pt = pcap_create ( pcap_device , errbuf ) ; if ( ! mp -> pt ) { nsock_log_error ( "pcap_create(%s) failed with error: %s" , pcap_device , errbuf ) ; nsock_log_error ( PCAP_FAILURE_EXPL_MESSAGE ) ; nsock_log_error ( "Can't open pcap! Are you root?" ) ; return - 1 ; } failed = func ( p_t , val ) ; if ( failed ) { nsock_log_error ( # func "(%d) FAILED: %d." , val , failed ) ; pcap_close ( p_t ) ; return - 1 ; } } while ( 0 ) { } 