static void vhost_dev_sync_region ( struct vhost_dev * dev , MemoryRegionSection * section , uint64_t mfirst , uint64_t mlast , uint64_t rfirst , uint64_t rlast ) { vhost_log_chunk_t * log = dev -> log -> log ; uint64_t start = MAX ( mfirst , rfirst ) ; uint64_t end = MIN ( mlast , rlast ) ; vhost_log_chunk_t * from = log + start / VHOST_LOG_CHUNK ; vhost_log_chunk_t * to = log + end / VHOST_LOG_CHUNK + 1 ; uint64_t addr = QEMU_ALIGN_DOWN ( start , VHOST_LOG_CHUNK ) ; if ( end < start ) { return ; } assert ( end / VHOST_LOG_CHUNK < dev -> log_size ) ; assert ( start / VHOST_LOG_CHUNK < dev -> log_size ) ; for ( ; from < to ; ++ from ) { vhost_log_chunk_t log ; if ( ! * from ) { addr += VHOST_LOG_CHUNK ; continue ; } log = qatomic_xchg ( from , 0 ) ; while ( log ) { int bit = ctzl ( log ) ; hwaddr page_addr ; hwaddr section_offset ; hwaddr mr_offset ; page_addr = addr + bit * VHOST_LOG_PAGE ; section_offset = page_addr - section -> offset_within_address_space ; mr_offset = section_offset + section -> offset_within_region ; memory_region_set_dirty ( section -> mr , mr_offset , VHOST_LOG_PAGE ) ; } addr += VHOST_LOG_CHUNK ; } } 