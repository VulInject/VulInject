void check_calls_by_money ( unsigned int ticks , void * param ) { struct str_hash_entry * h_entry = NULL , * tmp = NULL ; call_t * tmp_call = NULL ; int i ; cnxcc_lock ( _data . money . lock ) ; if ( _data . money . credit_data_by_client -> table ) { for ( i = 0 ; i < _data . money . credit_data_by_client -> size ; i ++ ) { clist_foreach_safe ( , , , ) { credit_data_t * credit_data = ( credit_data_t * ) h_entry -> u . p ; call_t * call = NULL ; double total_consumed_money = 0 , consumption_diff = 0 ; cnxcc_lock ( credit_data -> lock ) ; clist_foreach_safe ( , , , ) { int consumed_time = 0 ; if ( ! call -> confirmed ) { continue ; } consumed_time = get_current_timestamp ( ) - call -> start_timestamp ; if ( consumed_time > call -> money_based . initial_pulse ) { call -> consumed_amount = call -> money_based . connect_cost + ( call -> money_based . cost_per_second * call -> money_based . initial_pulse ) + call -> money_based . cost_per_second * ( ( consumed_time - call -> money_based . initial_pulse ) / call -> money_based . final_pulse + 1 ) * call -> money_based . final_pulse ; } total_consumed_money += call -> consumed_amount ; if ( call -> consumed_amount > call -> max_amount ) { LM_ALERT ( "[%.*s] call has exhausted its credit. " "Breaking the loop\n" , call -> sip_data . callid . len , call -> sip_data . callid . s ) ; break ; } LM_DBG ( "CID [%.*s], start_timestamp [%d], seconds alive " "[%d], consumed credit [%f]\n" , call -> sip_data . callid . len , call -> sip_data . callid . s , call -> start_timestamp , consumed_time , call -> consumed_amount ) ; } if ( credit_data -> concurrent_calls == 0 ) { cnxcc_unlock ( credit_data -> lock ) ; continue ; } if ( _data . redis ) { LM_DBG ( "ec=%f, ca=%f, ca2=%f" , credit_data -> ended_calls_consumed_amount , total_consumed_money , credit_data -> consumed_amount ) ; consumption_diff = credit_data -> ended_calls_consumed_amount + total_consumed_money - credit_data -> consumed_amount ; if ( consumption_diff > 0 ) { redis_incr_by_double ( credit_data , "consumed_amount" , consumption_diff ) ; } } credit_data -> consumed_amount = credit_data -> ended_calls_consumed_amount + total_consumed_money ; LM_DBG ( "Client [%.*s] | Ended-Calls-Credit-Spent: %f  " "TotalCredit/MaxCredit: %f/%f\n" , credit_data -> call_list -> client_id . len , credit_data -> call_list -> client_id . s , credit_data -> ended_calls_consumed_amount , credit_data -> consumed_amount , credit_data -> max_amount ) ; cnxcc_unlock ( credit_data -> lock ) ; } } } cnxcc_unlock ( _data . money . lock ) ; } 