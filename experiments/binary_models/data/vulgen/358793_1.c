static void fw_dnld_rx_work ( struct work_struct * work ) { int ret ; struct sk_buff * skb ; struct nfcmrvl_fw_dnld * fw_dnld = container_of ( work , nfcmrvl_fw_dnld , rx_work ) ; struct nfcmrvl_private * priv = container_of ( fw_dnld , nfcmrvl_private , fw_dnld ) ; while ( ( skb = skb_dequeue ( & fw_dnld -> rx_q ) ) ) { nfc_send_to_raw_sock ( priv -> ndev -> nfc_dev , skb , RAW_PAYLOAD_NCI , NFC_DIRECTION_RX ) ; switch ( fw_dnld -> state ) { case STATE_RESET : ret = process_state_reset ( priv , skb ) ; break ; case STATE_INIT : ret = process_state_init ( priv , skb ) ; break ; case STATE_SET_REF_CLOCK : ret = process_state_set_ref_clock ( priv , skb ) ; break ; case STATE_SET_HI_CONFIG : ret = process_state_set_hi_config ( priv , skb ) ; break ; case STATE_OPEN_LC : ret = process_state_open_lc ( priv , skb ) ; break ; case STATE_FW_DNLD : ret = process_state_fw_dnld ( priv , skb ) ; break ; case STATE_CLOSE_LC : ret = process_state_close_lc ( priv , skb ) ; break ; case STATE_BOOT : ret = process_state_boot ( priv , skb ) ; break ; default : ret = - EFAULT ; } if ( ret != 0 ) { nfc_err ( priv -> dev , "FW loading error" ) ; fw_dnld_over ( priv , ret ) ; break ; } } } 