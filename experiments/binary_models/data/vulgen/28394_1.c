void snmpd_backend ( struct snmpd * env ) { DIR * dir ; struct dirent * file ; int pair [ 2 ] ; char * argv [ 8 ] ; char execpath [ PATH_MAX ] ; size_t i = 0 ; if ( ( dir = opendir ( SNMPD_BACKEND ) ) == NULL ) { fatal ( "opendir \"%s\"" , SNMPD_BACKEND ) ; } argv [ i ++ ] = execpath ; if ( env -> sc_rtfilter ) { argv [ i ++ ] = "-C" ; argv [ i ++ ] = "filter-routes" ; } if ( env -> sc_flags & SNMPD_F_VERBOSE ) { argv [ i ++ ] = "-vv" ; } if ( env -> sc_flags & SNMPD_F_DEBUG ) { argv [ i ++ ] = "-d" ; argv [ i ++ ] = "-x" ; argv [ i ++ ] = "3" ; } else { argv [ i ++ ] = "-x" ; argv [ i ++ ] = "0" ; } argv [ i ] = NULL ; while ( ( file = readdir ( dir ) ) != NULL ) { if ( file -> d_name [ 0 ] == '.' ) { continue ; } if ( socketpair ( AF_UNIX , SOCK_STREAM , 0 , pair ) == - 1 ) { fatal ( "socketpair" ) ; } switch ( fork ( ) ) { case - 1 : fatal ( "fork" ) ; case 0 : close ( pair [ 1 ] ) ; if ( dup2 ( pair [ 0 ] , env -> sc_flags & SNMPD_F_DEBUG ?3 : 0 ) == - 1 ) { fatal ( "dup2" ) ; } if ( closefrom ( env -> sc_flags & SNMPD_F_DEBUG ?4 : 1 ) == - 1 ) { fatal ( 0 ) ; } ( void ) snprintf ( execpath , sizeof ( execpath ) , "%s/%s" , SNMPD_BACKEND , file -> d_name ) ; execv ( argv [ 0 ] , argv ) ; fatal ( "execv" ) ; default : close ( pair [ 0 ] ) ; if ( proc_compose_imsg ( & env -> sc_ps , PROC_SNMPE , - 1 , IMSG_AX_FD , - 1 , pair [ 1 ] , NULL , 0 ) == - 1 ) { fatal ( "proc_compose_imsg" ) ; } continue ; } } } 