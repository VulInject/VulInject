InfAdoptedRequest * inf_adopted_request_transform ( InfAdoptedRequest * request , InfAdoptedRequest * against , InfAdoptedRequest * request_lcs , InfAdoptedRequest * against_lcs ) { InfAdoptedRequestPrivate * request_priv ; InfAdoptedRequestPrivate * against_priv ; InfAdoptedRequestPrivate * request_lcs_priv ; InfAdoptedRequestPrivate * against_lcs_priv ; InfAdoptedRequestPrivate * new_priv ; InfAdoptedOperation * new_operation ; InfAdoptedStateVector * new_vector ; InfAdoptedRequest * new_request ; g_return_val_if_fail ( INF_ADOPTED_IS_REQUEST ( request ) , NULL ) ; g_return_val_if_fail ( INF_ADOPTED_IS_REQUEST ( against ) , NULL ) ; request_priv = INF_ADOPTED_REQUEST_PRIVATE ( request ) ; against_priv = INF_ADOPTED_REQUEST_PRIVATE ( against ) ; if ( request_lcs != NULL ) { request_lcs_priv = INF_ADOPTED_REQUEST_PRIVATE ( request_lcs ) ; } if ( against_lcs != NULL ) { against_lcs_priv = INF_ADOPTED_REQUEST_PRIVATE ( against_lcs ) ; } g_return_val_if_fail ( request_priv -> type == INF_ADOPTED_REQUEST_DO , NULL ) ; g_return_val_if_fail ( against_priv -> type == INF_ADOPTED_REQUEST_DO , NULL ) ; g_return_val_if_fail ( against_lcs == NULL || against_lcs_priv -> type == INF_ADOPTED_REQUEST_DO , NULL ) ; g_return_val_if_fail ( request_priv -> user_id != against_priv -> user_id , NULL ) ; g_return_val_if_fail ( request_lcs == NULL || request_priv -> user_id == request_lcs_priv -> user_id , NULL ) ; g_return_val_if_fail ( against_lcs == NULL || against_priv -> user_id == against_lcs_priv -> user_id , NULL ) ; g_return_val_if_fail ( request_lcs == NULL || inf_adopted_state_vector_causally_before ( request_lcs_priv -> vector , request_priv -> vector ) , NULL ) ; g_return_val_if_fail ( against_lcs == NULL || inf_adopted_state_vector_causally_before ( against_lcs_priv -> vector , against_priv -> vector ) , NULL ) ; g_return_val_if_fail ( inf_adopted_state_vector_compare ( request_priv -> vector , against_priv -> vector ) == 0 , NULL ) ; g_return_val_if_fail ( inf_adopted_operation_need_concurrency_id ( request_priv -> operation , against_priv -> operation ) == FALSE || ( request_lcs != NULL && against_lcs != NULL ) , NULL ) ; if ( request_priv -> user_id > against_priv -> user_id ) { new_operation = inf_adopted_operation_transform ( request_priv -> operation , against_priv -> operation , request_lcs == NULL ?NULL : request_lcs_priv -> operation , against_lcs == NULL ?NULL : against_lcs_priv -> operation , INF_ADOPTED_CONCURRENCY_OTHER ) ; } else { new_operation = inf_adopted_operation_transform ( request_priv -> operation , against_priv -> operation , request_lcs == NULL ?NULL : request_lcs_priv -> operation , against_lcs == NULL ?NULL : against_lcs_priv -> operation , INF_ADOPTED_CONCURRENCY_SELF ) ; } new_vector = inf_adopted_state_vector_copy ( request_priv -> vector ) ; inf_adopted_state_vector_add ( new_vector , against_priv -> user_id , 1 ) ; new_request = inf_adopted_request_new_do ( new_vector , request_priv -> user_id , new_operation , request_priv -> received ) ; new_priv = INF_ADOPTED_REQUEST_PRIVATE ( new_request ) ; new_priv -> executed = request_priv -> executed ; g_object_unref ( new_operation ) ; inf_adopted_state_vector_free ( new_vector ) ; return new_request ; } 