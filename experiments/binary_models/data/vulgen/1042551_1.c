copy_sections ( , , ) { static bfd_size_type secsecoff = 0 ; bfd * outbfd = ( bfd * ) data_ptr ; const char * inname ; asection * outsec ; bfd_size_type size ; void * contents ; long reloc_size ; bfd_byte buf [ 4 ] ; bfd_size_type add ; inname = bfd_section_name ( inbfd , insec ) ; outsec = insec -> output_section ; assert ( outsec != NULL ) ; size = bfd_get_section_size_before_reloc ( insec ) ; insec -> _cooked_size = insec -> _raw_size ; insec -> reloc_done = TRUE ; if ( ( bfd_get_section_flags ( inbfd , insec ) & SEC_HAS_CONTENTS ) == 0 ) { contents = NULL ; } else { if ( ! bfd_get_section_contents ( inbfd , insec , contents , ( file_ptr ) 0 , size ) ) { bfd_fatal ( bfd_get_filename ( inbfd ) ) ; } } reloc_size = bfd_get_reloc_upper_bound ( inbfd , insec ) ; if ( reloc_size < 0 ) { bfd_fatal ( bfd_get_filename ( inbfd ) ) ; } if ( reloc_size != 0 ) { arelent * * relocs ; long reloc_count ; relocs = ( arelent * * ) xmalloc ( reloc_size ) ; reloc_count = bfd_canonicalize_reloc ( inbfd , insec , relocs , symbols ) ; if ( reloc_count < 0 ) { bfd_fatal ( bfd_get_filename ( inbfd ) ) ; } mangle_relocs ( outbfd , insec , & relocs , & reloc_count , ( char * ) contents , size ) ; if ( outsec -> orelocation != ( arelent * * ) NULL ) { bfd_size_type total_count ; arelent * * combined ; total_count = reloc_count + outsec -> reloc_count ; combined = ( arelent * * ) xmalloc ( total_count * sizeof ( arelent * ) ) ; memcpy ( combined , outsec -> orelocation , outsec -> reloc_count * sizeof ( arelent * ) ) ; memcpy ( combined + outsec -> reloc_count , relocs , ( size_t ) ( reloc_count * sizeof ( arelent * ) ) ) ; free ( outsec -> orelocation ) ; reloc_count = total_count ; relocs = combined ; } bfd_set_reloc ( outbfd , outsec , relocs , reloc_count ) ; } if ( contents != NULL ) { if ( ! bfd_set_section_contents ( outbfd , outsec , contents , insec -> output_offset , size ) ) { bfd_fatal ( bfd_get_filename ( outbfd ) ) ; } free ( contents ) ; } if ( ! bfd_set_section_contents ( outbfd , secsec , ( void * ) inname , secsecoff , strlen ( inname ) + 1 ) ) { bfd_fatal ( _ ( "set .nlmsection contents" ) ) ; } secsecoff += strlen ( inname ) + 1 ; add = ( ( secsecoff + 3 ) & ~ 3 ) - secsecoff ; if ( add != 0 ) { bfd_h_put_32 ( outbfd , ( bfd_vma ) 0 , buf ) ; if ( ! bfd_set_section_contents ( outbfd , secsec , buf , secsecoff , add ) ) { bfd_fatal ( _ ( "set .nlmsection contents" ) ) ; } secsecoff += add ; } if ( contents != NULL ) { bfd_h_put_32 ( outbfd , ( bfd_vma ) outsec -> filepos , buf ) ; } else { bfd_h_put_32 ( outbfd , ( bfd_vma ) 0 , buf ) ; } if ( ! bfd_set_section_contents ( outbfd , secsec , buf , secsecoff , 4 ) ) { bfd_fatal ( _ ( "set .nlmsection contents" ) ) ; } secsecoff += 4 ; bfd_h_put_32 ( outbfd , ( bfd_vma ) size , buf ) ; if ( ! bfd_set_section_contents ( outbfd , secsec , buf , secsecoff , 4 ) ) { bfd_fatal ( _ ( "set .nlmsection contents" ) ) ; } secsecoff += 4 ; } 