static struct net_device * __init mvme147lance_probe ( void ) { struct net_device * dev ; static int called ; static const char name [ ] "MVME147 LANCE" ; ; struct m147lance_private * lp ; u8 macaddr [ ETH_ALEN ] ; u_long * addr ; u_long address ; int err ; if ( ! MACH_IS_MVME147 || called ) { return ERR_PTR ( - ENODEV ) ; } called ++ ; dev = alloc_etherdev ( sizeof ( m147lance_private ) ) ; if ( ! dev ) { return ERR_PTR ( - ENOMEM ) ; } dev -> base_addr = ( unsigned long ) MVME147_LANCE_BASE ; dev -> netdev_ops = & lance_netdev_ops ; dev -> dma = 0 ; addr = ( u_long * ) ETHERNET_ADDRESS ; address = * addr ; macaddr [ 0 ] = 0x08 ; macaddr [ 1 ] = 0x00 ; macaddr [ 2 ] = 0x3e ; address = address >> 8 ; macaddr [ 5 ] = address & 0xff ; address = address >> 8 ; macaddr [ 4 ] = address & 0xff ; address = address >> 8 ; macaddr [ 3 ] = address & 0xff ; eth_hw_addr_set ( dev , macaddr ) ; printk ( "%s: MVME147 at 0x%08lx, irq %d, Hardware Address %pM\n" , dev -> name , dev -> base_addr , MVME147_LANCE_IRQ , dev -> dev_addr ) ; lp = netdev_priv ( dev ) ; lp -> ram = __get_dma_pages ( GFP_ATOMIC , 3 ) ; if ( ! lp -> ram ) { printk ( "%s: No memory for LANCE buffers\n" , dev -> name ) ; return ERR_PTR ( - ENOMEM ) ; } lp -> lance . name = name ; lp -> lance . base = dev -> base_addr ; lp -> lance . init_block = ( lance_init_block * ) ( lp -> ram ) ; lp -> lance . lance_init_block = ( lance_init_block * ) ( lp -> ram ) ; lp -> lance . busmaster_regval = LE_C3_BSWP ; lp -> lance . irq = MVME147_LANCE_IRQ ; lp -> lance . writerap = ( writerap_t ) m147lance_writerap ; lp -> lance . writerdp = ( writerdp_t ) m147lance_writerdp ; lp -> lance . readrdp = ( readrdp_t ) m147lance_readrdp ; lp -> lance . lance_log_rx_bufs = LANCE_LOG_RX_BUFFERS ; lp -> lance . lance_log_tx_bufs = LANCE_LOG_TX_BUFFERS ; lp -> lance . rx_ring_mod_mask = RX_RING_MOD_MASK ; lp -> lance . tx_ring_mod_mask = TX_RING_MOD_MASK ; err = register_netdev ( dev ) ; if ( err ) { free_pages ( lp -> ram , 3 ) ; free_netdev ( dev ) ; return ERR_PTR ( err ) ; } return dev ; } 