static int get_cache_folder ( mailsession * session , char * * result ) { mailsession * imap_session ; mailimap * imap ; char * mb ; char * cache_dir ; char * dirname ; char * quoted_mb ; int res ; int r ; char key [ PATH_MAX ] ; struct imap_session_state_data * imap_data ; struct imap_cached_session_state_data * cached_data ; imap_session = get_ancestor ( session ) ; imap_data = imap_session -> data ; imap = imap_data -> session ; imap = get_imap_session ( session ) ; mb = get_ancestor_data ( session ) -> imap_mailbox ; cache_dir = get_cached_data ( session ) -> imap_cache_directory ; if ( imap -> imap_state != MAILIMAP_STATE_SELECTED ) { return MAIL_ERROR_BAD_STATE ; } if ( imap -> imap_selection_info == NULL ) { return MAIL_ERROR_BAD_STATE ; } quoted_mb = maildriver_quote_mailbox ( mb ) ; if ( quoted_mb == NULL ) { res = MAIL_ERROR_MEMORY ; err } snprintf ( key , PATH_MAX , "%s/%s" , cache_dir , quoted_mb ) ; dirname = strdup ( key ) ; if ( dirname == NULL ) { res = MAIL_ERROR_MEMORY ; free_mb } r = generic_cache_create_dir ( dirname ) ; if ( r != MAIL_NO_ERROR ) { res = r ; free_dirname } free ( quoted_mb ) ; * result = dirname ; return MAIL_NO_ERROR ; free_dirname free_mb free ( quoted_mb ) ; err return res ; } 