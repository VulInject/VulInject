static int reset_ms ( struct rtsx_chip * chip ) { struct ms_info * ms_card = & chip -> ms_card ; int retval ; u16 i , reg_addr , block_size ; u8 val , extra [ MS_EXTRA_SIZE ] , j , * ptr ; u16 eblock_cnt ; retval = ms_prepare_reset ( chip ) ; if ( retval != STATUS_SUCCESS ) { rtsx_trace ( chip ) ; return STATUS_FAIL ; } ms_card -> ms_type |= TYPE_MS ; retval = ms_send_cmd ( chip , MS_RESET , NO_WAIT_INT ) ; if ( retval != STATUS_SUCCESS ) { rtsx_trace ( chip ) ; return STATUS_FAIL ; } retval = ms_read_status_reg ( chip ) ; if ( retval != STATUS_SUCCESS ) { rtsx_trace ( chip ) ; return STATUS_FAIL ; } retval = rtsx_read_register ( chip , PPBUF_BASE2 , & val ) ; if ( retval ) { rtsx_trace ( chip ) ; return retval ; } if ( val & WRT_PRTCT ) { chip -> card_wp |= MS_CARD ; } else { chip -> card_wp &= ~ MS_CARD ; } i = 0 ; RE_SEARCH while ( i < ( MAX_DEFECTIVE_BLOCK + 2 ) ) { if ( detect_card_cd ( chip , MS_CARD ) != STATUS_SUCCESS ) { ms_set_err_code ( chip , MS_NO_CARD ) ; rtsx_trace ( chip ) ; return STATUS_FAIL ; } retval = ms_read_extra_data ( chip , i , 0 , extra , MS_EXTRA_SIZE ) ; if ( retval != STATUS_SUCCESS ) { i ++ ; continue ; } if ( extra [ 0 ] & BLOCK_OK ) { if ( ! ( extra [ 1 ] & NOT_BOOT_BLOCK ) ) { ms_card -> boot_block = i ; break ; } } i ++ ; } if ( i == ( MAX_DEFECTIVE_BLOCK + 2 ) ) { dev_dbg ( rtsx_dev ( chip ) , "No boot block found!" ) ; rtsx_trace ( chip ) ; return STATUS_FAIL ; } for ( j = 0 ; j < 3 ; j ++ ) { retval = ms_read_page ( chip , ms_card -> boot_block , j ) ; if ( retval != STATUS_SUCCESS ) { if ( ms_check_err_code ( chip , MS_FLASH_WRITE_ERROR ) ) { i = ms_card -> boot_block + 1 ; ms_set_err_code ( chip , MS_NO_ERROR ) ; RE_SEARCH } } } retval = ms_read_page ( chip , ms_card -> boot_block , 0 ) ; if ( retval != STATUS_SUCCESS ) { rtsx_trace ( chip ) ; return STATUS_FAIL ; } rtsx_init_cmd ( chip ) ; for ( i = 0 ; i < 96 ; i ++ ) { rtsx_add_cmd ( chip , READ_REG_CMD , PPBUF_BASE2 + 0x1A0 + i , 0 , 0 ) ; } retval = rtsx_send_cmd ( chip , MS_CARD , 100 ) ; if ( retval < 0 ) { rtsx_trace ( chip ) ; return STATUS_FAIL ; } ptr = rtsx_get_cmd_data ( chip ) ; memcpy ( ms_card -> raw_sys_info , ptr , 96 ) ; rtsx_init_cmd ( chip ) ; rtsx_add_cmd ( chip , READ_REG_CMD , HEADER_ID0 , 0 , 0 ) ; rtsx_add_cmd ( chip , READ_REG_CMD , HEADER_ID1 , 0 , 0 ) ; for ( reg_addr = DISABLED_BLOCK0 ; reg_addr <= DISABLED_BLOCK3 ; reg_addr ++ ) { rtsx_add_cmd ( chip , READ_REG_CMD , reg_addr , 0 , 0 ) ; } for ( reg_addr = BLOCK_SIZE_0 ; reg_addr <= PAGE_SIZE_1 ; reg_addr ++ ) { rtsx_add_cmd ( chip , READ_REG_CMD , reg_addr , 0 , 0 ) ; } rtsx_add_cmd ( chip , READ_REG_CMD , MS_Device_Type , 0 , 0 ) ; rtsx_add_cmd ( chip , READ_REG_CMD , MS_4bit_Support , 0 , 0 ) ; retval = rtsx_send_cmd ( chip , MS_CARD , 100 ) ; if ( retval < 0 ) { rtsx_trace ( chip ) ; return STATUS_FAIL ; } ptr = rtsx_get_cmd_data ( chip ) ; dev_dbg ( rtsx_dev ( chip ) , "Boot block data:\n" ) ; dev_dbg ( rtsx_dev ( chip ) , "%*ph\n" , 16 , ptr ) ; if ( ptr [ 0 ] != 0x00 || ptr [ 1 ] != 0x01 ) { i = ms_card -> boot_block + 1 ; RE_SEARCH } if ( ptr [ 12 ] != 0x02 || ptr [ 13 ] != 0x00 ) { i = ms_card -> boot_block + 1 ; RE_SEARCH } if ( ( ptr [ 14 ] == 1 ) || ( ptr [ 14 ] == 3 ) ) { chip -> card_wp |= MS_CARD ; } block_size = ( ( u16 ) ptr [ 6 ] << 8 ) | ptr [ 7 ] ; if ( block_size == 0x0010 ) { ms_card -> block_shift = 5 ; ms_card -> page_off = 0x1F ; } if ( block_size == 0x0008 ) { ms_card -> block_shift = 4 ; ms_card -> page_off = 0x0F ; } ms_card -> total_block = ( ( u16 ) ptr [ 8 ] << 8 ) | ptr [ 9 ] ; j = ptr [ 10 ] ; if ( ms_card -> block_shift == 4 ) { if ( j < 2 ) { ms_card -> capacity = 0x1EE0 ; } else { ms_card -> capacity = 0x3DE0 ; } } else { if ( j < 5 ) { ms_card -> capacity = 0x7BC0 ; } if ( j < 0xA ) { ms_card -> capacity = 0xF7C0 ; } if ( j < 0x11 ) { ms_card -> capacity = 0x1EF80 ; } else { ms_card -> capacity = 0x3DF00 ; } } eblock_cnt = ( ( u16 ) ptr [ 10 ] << 8 ) | ptr [ 11 ] ; ms_card -> capacity = ( ( u32 ) eblock_cnt - 2 ) << ms_card -> block_shift ; chip -> capacity [ chip -> card2lun [ MS_CARD ] ] = ms_card -> capacity ; if ( ptr [ 15 ] ) { retval = ms_set_rw_reg_addr ( chip , 0 , 0 , SystemParm , 1 ) ; if ( retval != STATUS_SUCCESS ) { rtsx_trace ( chip ) ; return STATUS_FAIL ; } retval = rtsx_write_register ( chip , PPBUF_BASE2 , 0xFF , 0x88 ) ; if ( retval ) { rtsx_trace ( chip ) ; return retval ; } retval = rtsx_write_register ( chip , PPBUF_BASE2 + 1 , 0xFF , 0 ) ; if ( retval ) { rtsx_trace ( chip ) ; return retval ; } retval = ms_transfer_tpc ( chip , MS_TM_WRITE_BYTES , WRITE_REG , 1 , NO_WAIT_INT ) ; retval = rtsx_write_register ( chip , MS_CFG , 0x58 | MS_NO_CHECK_INT , MS_BUS_WIDTH_4 | PUSH_TIME_ODD | MS_NO_CHECK_INT ) ; if ( retval ) { rtsx_trace ( chip ) ; return retval ; } ms_card -> ms_type |= MS_4BIT ; } if ( CHK_MS4BIT ( ms_card ) ) { chip -> card_bus_width [ chip -> card2lun [ MS_CARD ] ] = 4 ; } else { chip -> card_bus_width [ chip -> card2lun [ MS_CARD ] ] = 1 ; } return STATUS_SUCCESS ; } 