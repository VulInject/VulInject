static void usb_serial_handle_data ( USBDevice * dev , USBPacket * p ) { USBSerialState * s = USB_SERIAL ( dev ) ; USBBus * bus = usb_bus_from_device ( dev ) ; uint8_t devep = p -> ep -> nr ; struct iovec * iov ; int i ; switch ( p -> pid ) { case USB_TOKEN_OUT : if ( devep != 2 ) { fail } for ( i = 0 ; i < p -> iov . niov ; i ++ ) { iov = p -> iov . iov + i ; } p -> actual_length = p -> iov . size ; break ; case USB_TOKEN_IN : if ( devep != 1 ) { fail } usb_serial_token_in ( s , p ) ; break ; default : trace_usb_serial_bad_token ( bus -> busnr , dev -> addr ) ; fail p -> status = USB_RET_STALL ; break ; } } 