void vivid_meta_cap_fillbuff ( struct vivid_dev * dev , struct vivid_buffer * buf , u64 soe ) { struct vivid_uvc_meta_buf * meta = vb2_plane_vaddr ( & buf -> vb . vb2_buf , 0 ) ; int buf_off = 0 ; buf -> vb . sequence = dev -> meta_cap_seq_count ; memset ( meta , 1 , vb2_plane_size ( & buf -> vb . vb2_buf , 0 ) ) ; meta -> ns = ktime_get_ns ( ) ; meta -> sof = buf -> vb . sequence * 30 ; meta -> length = sizeof ( * meta ) - offsetof ( vivid_uvc_meta_buf , length ) ; meta -> flags = UVC_STREAM_EOH | UVC_STREAM_EOF ; if ( ( buf -> vb . sequence % 2 ) == 0 ) { meta -> flags |= UVC_STREAM_FID ; } dprintk ( dev , 2 , "%s ns:%llu sof:%4d len:%u flags: 0x%02x" , __func__ , meta -> ns , meta -> sof , meta -> length , meta -> flags ) ; if ( dev -> meta_pts ) { meta -> flags |= UVC_STREAM_PTS ; meta -> buf [ 0 ] = div_u64 ( soe , VIVID_META_CLOCK_UNIT ) ; buf_off = 4 ; dprintk ( dev , 2 , " pts: %u\n" , * ( __u32 * ) ( meta -> buf ) ) ; } if ( dev -> meta_scr ) { meta -> flags |= UVC_STREAM_SCR ; meta -> buf [ buf_off ] = div_u64 ( ( soe + dev -> cap_frame_eof_offset ) , VIVID_META_CLOCK_UNIT ) ; meta -> buf [ buf_off + 4 ] = ( buf -> vb . sequence * 30 ) % 1000 ; dprintk ( dev , 2 , " stc: %u, sof counter: %u\n" , * ( __u32 * ) ( meta -> buf + buf_off ) , * ( __u16 * ) ( meta -> buf + buf_off + 4 ) ) ; } dprintk ( dev , 2 , "\n" ) ; } 