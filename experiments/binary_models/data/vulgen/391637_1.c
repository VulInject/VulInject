static int nfs4_trigger_domount_args_create ( vnode_t * vp , cred_t * cr , domount_args_t * * dmap ) { int nointr ; char * hostlist ; servinfo4_t * svp ; struct nfs_args * nargs , * nargs_head ; enum clnt_stat status ; ephemeral_servinfo_t * esi , * esi_first ; domount_args_t * dma ; mntinfo4_t * mi = VTOMI4 ( vp ) ; nointr = ! ( mi -> mi_flags & MI4_INT ) ; hostlist = kmem_zalloc ( MAXPATHLEN , KM_SLEEP ) ; svp = mi -> mi_curr_serv ; status = nfs4_trigger_ping_server ( svp , nointr ) ; if ( status == RPC_SUCCESS ) { esi_first = nfs4_trigger_esi_create ( vp , svp , cr ) ; if ( esi_first == NULL ) { return ( EINVAL ) ; } ( void ) strlcpy ( hostlist , esi_first -> esi_hostname , MAXPATHLEN ) ; nargs_head = nfs4_trigger_nargs_create ( mi , svp , esi_first ) ; } else { esi_first = NULL ; nargs_head = NULL ; } nargs = nargs_head ; { for ( svp = mi -> mi_servers ; svp != NULL ; svp = svp -> sv_next ) { struct nfs_args * next ; if ( svp == mi -> mi_curr_serv && esi_first != NULL ) { continue ; } ( void ) nfs_rw_enter_sig ( & svp -> sv_lock , RW_READER , 0 ) ; if ( svp -> sv_flags & SV4_NOTINUSE ) { nfs_rw_exit ( & svp -> sv_lock ) ; continue ; } nfs_rw_exit ( & svp -> sv_lock ) ; status = nfs4_trigger_ping_server ( svp , nointr ) ; if ( status == RPC_INTR ) { kmem_free ( hostlist , MAXPATHLEN ) ; nfs4_trigger_esi_destroy ( esi_first , vp ) ; nargs = nargs_head ; while ( nargs != NULL ) { next = nargs -> nfs_ext_u . nfs_extB . next ; nfs4_trigger_nargs_destroy ( nargs ) ; nargs = next ; } return ( EINTR ) ; } if ( status != RPC_SUCCESS ) { continue ; } esi = nfs4_trigger_esi_create ( vp , svp , cr ) ; if ( esi == NULL ) { continue ; } next = nfs4_trigger_nargs_create ( mi , svp , esi ) ; if ( esi_first == NULL ) { ASSERT ( nargs == NULL ) ; ASSERT ( nargs_head == NULL ) ; nargs_head = next ; esi_first = esi ; ( void ) strlcpy ( hostlist , esi_first -> esi_hostname , MAXPATHLEN ) ; } else { ASSERT ( nargs_head != NULL ) ; nargs -> nfs_ext_u . nfs_extB . next = next ; ( void ) strlcat ( hostlist , "," , MAXPATHLEN ) ; ( void ) strlcat ( hostlist , esi -> esi_hostname , MAXPATHLEN ) ; nfs4_trigger_esi_destroy ( esi , vp ) ; } nargs = next ; } if ( esi_first == NULL ) { delay ( drv_usectohz ( 1000000 ) ) ; } } esi_first == NULL ; ASSERT ( nargs_head != NULL ) ; dma = kmem_zalloc ( sizeof ( domount_args_t ) , KM_SLEEP ) ; dma -> dma_esi = esi_first ; dma -> dma_hostlist = hostlist ; dma -> dma_nargs = nargs_head ; * dmap = dma ; return ( 0 ) ; } 