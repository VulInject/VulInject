static void log_info ( struct packet_object * po ) static pthread_mutex_t log_mutex = PTHREAD_MUTEX_INITIALIZER ; int set_loglevel ( int level , char * filename ) { char eci [ strlen ( filename ) + 5 ] ; char ecp [ strlen ( filename ) + 5 ] ; log_stop ( ) ; DEBUG_MSG ( "set_loglevel(%d, %s)" , level , filename ) ; if ( EC_GBL_OPTIONS -> read ) { USER_MSG ( "*********************************************************\n" ) ; USER_MSG ( "WARNING: while reading form file we cannot determine     \n" ) ; USER_MSG ( "if an host is local or not because the ip address of     \n" ) ; USER_MSG ( "the NIC may have been changed from the time of the dump. \n" ) ; USER_MSG ( "*********************************************************\n\n" ) ; } snprintf ( eci , strlen ( filename ) + 5 , "%s.eci" , filename ) ; snprintf ( ecp , strlen ( filename ) + 5 , "%s.ecp" , filename ) ; memset ( & fdp , 0 , sizeof ( log_fd ) ) ; memset ( & fdi , 0 , sizeof ( log_fd ) ) ; switch ( level ) { case LOG_PACKET : if ( EC_GBL_OPTIONS -> compress ) { fdp . type = LOG_COMPRESSED ; } else { fdp . type = LOG_UNCOMPRESSED ; } if ( log_open ( & fdp , ecp ) != E_SUCCESS ) { return - E_FATAL ; } log_write_header ( & fdp , LOG_PACKET ) ; hook_add ( HOOK_DISPATCHER , & log_packet ) ; case LOG_INFO : if ( EC_GBL_OPTIONS -> compress ) { fdi . type = LOG_COMPRESSED ; } else { fdi . type = LOG_UNCOMPRESSED ; } if ( log_open ( & fdi , eci ) != E_SUCCESS ) { return - E_FATAL ; } log_write_header ( & fdi , LOG_INFO ) ; hook_add ( HOOK_DISPATCHER , & log_info ) ; hook_add ( HOOK_PACKET_ARP , & log_info ) ; hook_add ( HOOK_PACKET_ICMP , & log_info ) ; hook_add ( HOOK_PROTO_DHCP_PROFILE , & log_info ) ; break ; } atexit ( log_stop ) ; return E_SUCCESS ; } 