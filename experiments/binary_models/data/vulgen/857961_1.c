static int ohci_take_control ( ohci_state_t * ohcip ) { uint32_t hcr_control_val ; uint32_t hcr_cmd_status_val ; int wait ; USB_DPRINTF_L4 ( PRINT_MASK_ATTA , ohcip -> ohci_log_hdl , "ohci_take_control:" ) ; hcr_control_val = Get_OpReg ( hcr_control ) ; if ( ( hcr_control_val & HCR_CONTROL_IR ) == 0 ) { USB_DPRINTF_L4 ( PRINT_MASK_ATTA , ohcip -> ohci_log_hdl , "ohci_take_control: InterruptRouting off\n" ) ; return ( DDI_SUCCESS ) ; } hcr_cmd_status_val = Get_OpReg ( hcr_cmd_status ) ; USB_DPRINTF_L3 ( PRINT_MASK_ATTA , ohcip -> ohci_log_hdl , "ohci_take_control: hcr_cmd_status: 0x%x\n" , hcr_cmd_status_val ) ; hcr_cmd_status_val |= HCR_STATUS_OCR ; Set_OpReg ( hcr_cmd_status , hcr_cmd_status_val ) ; mutex_exit ( & ohcip -> ohci_int_mutex ) ; for ( wait = 0 ; wait < 5000 ; wait ++ ) { if ( ( Get_OpReg ( hcr_control ) & HCR_CONTROL_IR ) == 0 ) { break ; } } mutex_enter ( & ohcip -> ohci_int_mutex ) ; if ( wait >= 5000 ) { USB_DPRINTF_L2 ( PRINT_MASK_ATTA , ohcip -> ohci_log_hdl , "ohci_take_control: couldn't take control from BIOS\n" ) ; return ( DDI_FAILURE ) ; } if ( Get_OpReg ( hcr_control ) & HCR_CONTROL_IR ) { USB_DPRINTF_L2 ( PRINT_MASK_ATTA , ohcip -> ohci_log_hdl , "ohci_take_control: Routing bit set" ) ; return ( DDI_FAILURE ) ; } USB_DPRINTF_L4 ( PRINT_MASK_ATTA , ohcip -> ohci_log_hdl , "ohci_take_control: End" ) ; return ( DDI_SUCCESS ) ; } 