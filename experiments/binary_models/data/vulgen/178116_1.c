int crypt_get_keys ( struct Email * e , char * * keylist , bool oppenc_mode ) { if ( ! WithCrypto ) { return 0 ; } struct AddressList addrlist = TAILQ_HEAD_INITIALIZER ( addrlist ) ; const char * fqdn = mutt_fqdn ( true , NeoMutt -> sub ) ; const char * self_encrypt = NULL ; * keylist = NULL ; if ( ! oppenc_mode && ( e -> security & SEC_AUTOCRYPT ) ) { if ( mutt_autocrypt_ui_recommendation ( e , keylist ) <= AUTOCRYPT_REC_NO ) { return - 1 ; } return 0 ; } if ( WithCrypto & APPLICATION_PGP ) { OptPgpCheckTrust = true ; } mutt_addrlist_copy ( & addrlist , & e -> env -> to , false ) ; mutt_addrlist_copy ( & addrlist , & e -> env -> cc , false ) ; mutt_addrlist_copy ( & addrlist , & e -> env -> bcc , false ) ; mutt_addrlist_qualify ( & addrlist , fqdn ) ; mutt_addrlist_dedupe ( & addrlist ) ; if ( oppenc_mode || ( e -> security & SEC_ENCRYPT ) ) { if ( ( ( WithCrypto & APPLICATION_PGP ) != 0 ) && ( e -> security & APPLICATION_PGP ) ) { * keylist = crypt_pgp_find_keys ( & addrlist , oppenc_mode ) ; if ( ! * keylist ) { mutt_addrlist_clear ( & addrlist ) ; return - 1 ; } OptPgpCheckTrust = false ; const bool c_pgp_self_encrypt = cs_subset_bool ( NeoMutt -> sub , "pgp_self_encrypt" ) ; const enum QuadOption c_pgp_encrypt_self = cs_subset_quad ( NeoMutt -> sub , "pgp_encrypt_self" ) ; if ( c_pgp_self_encrypt || ( c_pgp_encrypt_self == MUTT_YES ) ) { self_encrypt = c_pgp_default_key ; } } if ( ( ( WithCrypto & APPLICATION_SMIME ) != 0 ) && ( e -> security & APPLICATION_SMIME ) ) { * keylist = crypt_smime_find_keys ( & addrlist , oppenc_mode ) ; if ( ! * keylist ) { mutt_addrlist_clear ( & addrlist ) ; return - 1 ; } const bool c_smime_self_encrypt = cs_subset_bool ( NeoMutt -> sub , "smime_self_encrypt" ) ; const char * const c_smime_default_key = cs_subset_string ( NeoMutt -> sub , "smime_default_key" ) ; const enum QuadOption c_smime_encrypt_self = cs_subset_quad ( NeoMutt -> sub , "smime_encrypt_self" ) ; if ( c_smime_self_encrypt || ( c_smime_encrypt_self == MUTT_YES ) ) { self_encrypt = c_smime_default_key ; } } } if ( ! oppenc_mode && self_encrypt ) { const size_t keylist_size = mutt_str_len ( * keylist ) ; mutt_mem_realloc ( keylist , keylist_size + mutt_str_len ( self_encrypt ) + 2 ) ; sprintf ( * keylist + keylist_size , " %s" , self_encrypt ) ; } mutt_addrlist_clear ( & addrlist ) ; return 0 ; } 