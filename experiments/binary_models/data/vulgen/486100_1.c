int key_matrix_decode ( struct key_matrix * config , struct key_matrix_key keys [ ] , int num_keys , int keycode [ ] , int max_keycodes ) { const u8 * keymap ; int valid , upto ; int pos ; debug ( "%s: num_keys = %d\n" , __func__ , num_keys ) ; keymap = config -> plain_keycode ; for ( valid = upto = 0 ; upto < num_keys ; upto ++ ) { struct key_matrix_key * key = & keys [ upto ] ; debug ( "  valid=%d, row=%d, col=%d\n" , key -> valid , key -> row , key -> col ) ; pos = key -> row * config -> num_cols + key -> col ; if ( config -> fn_keycode && pos == config -> fn_pos ) { keymap = config -> fn_keycode ; } if ( valid < max_keycodes ) { keycode [ valid ++ ] = keymap [ pos ] ; } debug ( "    keycode=%d\n" , keymap [ pos ] ) ; } if ( has_ghosting ( config , keys , valid ) ) { valid = 0 ; debug ( "    ghosting detected!\n" ) ; } debug ( "  %d valid keycodes found\n" , valid ) ; return valid ; } 