PK11SlotInfo * lsw_nss_get_authenticated_slot ( struct logger * logger ) { PK11SlotInfo * slot = PK11_GetInternalKeySlot ( ) ; if ( slot == NULL ) { llog ( RC_LOG_SERIOUS | ERROR_STREAM , logger , "no internal key slot" ) ; return NULL ; } if ( PK11_IsFIPS ( ) || PK11_NeedLogin ( slot ) ) { SECStatus status = PK11_Authenticate ( slot , PR_FALSE , lsw_nss_get_password_context ( logger ) ) ; if ( status != SECSuccess ) { const char * token = PK11_GetTokenName ( slot ) ; llog ( RC_LOG_SERIOUS | ERROR_STREAM , logger , "authentication of \"%s\" failed" , token ) ; return NULL ; } } return slot ; } 