int board_fix_fdt ( void * blob ) { enum fdt_status status_pcie , status_eth1 ; u8 topology [ MAX_MOX_MODULES ] ; int i , size , ret ; bool eth1_sgmii ; clrbits_le32 ( ARMADA_37XX_NB_GPIO_SEL , BIT ( 12 ) ) ; writel ( 0x10df , ARMADA_37XX_SPI_CFG ) ; mdelay ( 1 ) ; setbits_le32 ( ARMADA_37XX_SPI_CTRL , BIT ( 17 ) ) ; while ( ! ( readl ( ARMADA_37XX_SPI_CTRL ) & 0x2 ) ) { udelay ( 1 ) ; } status_pcie = FDT_STATUS_DISABLED ; status_eth1 = FDT_STATUS_DISABLED ; eth1_sgmii = false ; for ( i = 0 ; i < MAX_MOX_MODULES ; ++ i ) { writel ( 0x0 , ARMADA_37XX_SPI_DOUT ) ; while ( ! ( readl ( ARMADA_37XX_SPI_CTRL ) & 0x2 ) ) { udelay ( 1 ) ; } topology [ i ] = readl ( ARMADA_37XX_SPI_DIN ) & 0xff ; if ( topology [ i ] == 0xff ) { break ; } topology [ i ] &= 0xf ; if ( topology [ i ] == MOX_MODULE_SFP && status_pcie == FDT_STATUS_DISABLED ) { eth1_sgmii = true ; } if ( topology [ i ] == MOX_MODULE_SFP || topology [ i ] == MOX_MODULE_TOPAZ || topology [ i ] == MOX_MODULE_PERIDOT ) { status_eth1 = FDT_STATUS_OKAY ; } } size = i ; clrbits_le32 ( ARMADA_37XX_SPI_CTRL , BIT ( 17 ) ) ; ret = fdt_set_status_by_alias ( blob , "ethernet1" , status_eth1 ) ; if ( ret < 0 ) { printf ( "Cannot set status for eth1 in U-Boot's device tree: %s!\n" , fdt_strerror ( ret ) ) ; } if ( eth1_sgmii ) { ret = fdt_path_offset ( blob , "ethernet1" ) ; if ( ret >= 0 ) { ret = fdt_setprop_string ( blob , ret , "phy-mode" , "sgmii" ) ; } if ( ret < 0 ) { printf ( "Cannot set phy-mode for eth1 to sgmii in U-Boot device tree: %s!\n" , fdt_strerror ( ret ) ) ; } } if ( size > 1 && ( topology [ 1 ] == MOX_MODULE_PCI || topology [ 1 ] == MOX_MODULE_USB3 || topology [ 1 ] == MOX_MODULE_PASSPCI ) ) { status_pcie = FDT_STATUS_OKAY ; } ret = fdt_set_status_by_compatible ( blob , "marvell,armada-3700-pcie" , status_pcie ) ; if ( a3700_fdt_fix_pcie_regions ( blob ) < 0 ) { printf ( "Cannot fix PCIe regions in U-Boot's device tree!\n" ) ; return 0 ; } return 0 ; } 