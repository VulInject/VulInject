static int drxk_get_stats ( struct dvb_frontend * fe ) { struct dtv_frontend_properties * c = & fe -> dtv_property_cache ; struct drxk_state * state = fe -> demodulator_priv ; int status ; u32 stat ; u16 reg16 ; u32 post_bit_count ; u32 post_bit_err_count ; u32 post_bit_error_scale ; u32 pre_bit_err_count ; u32 pre_bit_count ; u32 pkt_count ; u32 pkt_error_count ; s32 cnr ; if ( state -> m_drxk_state == DRXK_NO_DEV ) { return - ENODEV ; } state -> fe_status = 0 ; get_lock_status ( state , & stat ) ; if ( stat == MPEG_LOCK ) { state -> fe_status |= 0x1f ; } if ( stat == FEC_LOCK ) { state -> fe_status |= 0x0f ; } if ( stat == DEMOD_LOCK ) { state -> fe_status |= 0x07 ; } get_strength ( state , & c -> strength . stat [ 0 ] . uvalue ) ; c -> strength . stat [ 0 ] . scale = FE_SCALE_RELATIVE ; if ( stat >= DEMOD_LOCK ) { get_signal_to_noise ( state , & cnr ) ; c -> cnr . stat [ 0 ] . svalue = cnr * 100 ; c -> cnr . stat [ 0 ] . scale = FE_SCALE_DECIBEL ; } else { c -> cnr . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; } if ( stat < FEC_LOCK ) { c -> block_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> block_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> pre_bit_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> pre_bit_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> post_bit_error . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; c -> post_bit_count . stat [ 0 ] . scale = FE_SCALE_NOT_AVAILABLE ; return 0 ; } status = read16 ( state , OFDM_EC_VD_ERR_BIT_CNT__A , & reg16 ) ; if ( status < 0 ) { error } pre_bit_err_count = reg16 ; status = read16 ( state , OFDM_EC_VD_IN_BIT_CNT__A , & reg16 ) ; if ( status < 0 ) { error } pre_bit_count = reg16 ; status = read16 ( state , FEC_RS_NR_BIT_ERRORS__A , & reg16 ) ; if ( status < 0 ) { error } post_bit_err_count = reg16 ; status = read16 ( state , FEC_RS_MEASUREMENT_PRESCALE__A , & reg16 ) ; if ( status < 0 ) { error } post_bit_error_scale = reg16 ; status = read16 ( state , FEC_RS_MEASUREMENT_PERIOD__A , & reg16 ) ; if ( status < 0 ) { error } pkt_count = reg16 ; status = read16 ( state , SCU_RAM_FEC_ACCUM_PKT_FAILURES__A , & reg16 ) ; if ( status < 0 ) { error } pkt_error_count = reg16 ; write16 ( state , SCU_RAM_FEC_ACCUM_PKT_FAILURES__A , 0 ) ; post_bit_err_count *= post_bit_error_scale ; post_bit_count = pkt_count * 204 * 8 ; c -> block_error . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> block_error . stat [ 0 ] . uvalue += pkt_error_count ; c -> block_count . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> block_count . stat [ 0 ] . uvalue += pkt_count ; c -> pre_bit_error . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> pre_bit_error . stat [ 0 ] . uvalue += pre_bit_err_count ; c -> pre_bit_count . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> pre_bit_count . stat [ 0 ] . uvalue += pre_bit_count ; c -> post_bit_error . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> post_bit_error . stat [ 0 ] . uvalue += post_bit_err_count ; c -> post_bit_count . stat [ 0 ] . scale = FE_SCALE_COUNTER ; c -> post_bit_count . stat [ 0 ] . uvalue += post_bit_count ; error return status ; } 