static void process_deferred_bios ( struct era * era ) { int r ; struct bio_list deferred_bios , marked_bios ; struct bio * bio ; bool commit_needed = false ; bool failed = false ; bio_list_init ( & deferred_bios ) ; bio_list_init ( & marked_bios ) ; spin_lock ( & era -> deferred_lock ) ; bio_list_merge ( & deferred_bios , & era -> deferred_bios ) ; bio_list_init ( & era -> deferred_bios ) ; spin_unlock ( & era -> deferred_lock ) ; while ( ( bio = bio_list_pop ( & deferred_bios ) ) ) { r = writeset_test_and_set ( & era -> md -> bitset_info , era -> md -> current_writeset , get_block ( era , bio ) ) ; if ( r < 0 ) { failed = true ; } bio_list_add ( & marked_bios , bio ) ; } if ( commit_needed ) { r = metadata_commit ( era -> md ) ; if ( r ) { failed = true ; } } if ( failed ) { while ( ( bio = bio_list_pop ( & marked_bios ) ) ) { bio_io_error ( bio ) ; } } else { while ( ( bio = bio_list_pop ( & marked_bios ) ) ) { generic_make_request ( bio ) ; } } } 