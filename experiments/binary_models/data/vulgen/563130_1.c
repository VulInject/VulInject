static void mptspi_setTargetNegoParms ( MPT_SCSI_HOST * hd , VirtTarget * target , struct scsi_device * sdev ) { MPT_ADAPTER * ioc = hd -> ioc ; SpiCfgData * pspi_data = & ioc -> spi_data ; int id = ( int ) target -> id ; int nvram ; u8 width = MPT_NARROW ; u8 factor = MPT_ASYNC ; u8 offset = 0 ; u8 nfactor ; u8 noQas = 1 ; target -> negoFlags = pspi_data -> noQas ; if ( sdev -> scsi_level < SCSI_2 ) { width = 0 ; factor = MPT_ULTRA2 ; offset = pspi_data -> maxSyncOffset ; target -> tflags &= ~ MPT_TARGET_FLAGS_Q_YES ; } else { if ( scsi_device_wide ( sdev ) ) { width = 1 ; } if ( scsi_device_sync ( sdev ) ) { factor = pspi_data -> minSyncFactor ; if ( ! scsi_device_dt ( sdev ) ) { factor = MPT_ULTRA2 ; } else { if ( ! scsi_device_ius ( sdev ) && ! scsi_device_qas ( sdev ) ) { factor = MPT_ULTRA160 ; } else { factor = MPT_ULTRA320 ; if ( scsi_device_qas ( sdev ) ) { ddvprintk ( ioc , printk ( MYIOC_s_DEBUG_FMT "Enabling QAS due to " "byte56=%02x on id=%d!\n" , ioc -> name , scsi_device_qas ( sdev ) , id ) ) ; } if ( sdev -> type == TYPE_TAPE && scsi_device_ius ( sdev ) ) { target -> negoFlags |= MPT_TAPE_NEGO_IDP ; } } } offset = pspi_data -> maxSyncOffset ; if ( target -> raidVolume == 1 ) { noQas = 0 ; } } else { factor = MPT_ASYNC ; offset = 0 ; } } if ( ! sdev -> tagged_supported ) { target -> tflags &= ~ MPT_TARGET_FLAGS_Q_YES ; } if ( pspi_data -> nvram && ( pspi_data -> nvram [ id ] != MPT_HOST_NVRAM_INVALID ) ) { nvram = pspi_data -> nvram [ id ] ; nfactor = ( nvram & MPT_NVRAM_SYNC_MASK ) >> 8 ; if ( width ) { width = nvram & MPT_NVRAM_WIDE_DISABLE ?0 : 1 ; } if ( offset > 0 ) { if ( nfactor ) { if ( nfactor < pspi_data -> minSyncFactor ) { nfactor = pspi_data -> minSyncFactor ; } factor = max ( factor , nfactor ) ; if ( factor == MPT_ASYNC ) { offset = 0 ; } } else { offset = 0 ; factor = MPT_ASYNC ; } } else { factor = MPT_ASYNC ; } } if ( ( ! width ) && ( factor < MPT_ULTRA2 ) ) { factor = MPT_ULTRA2 ; } target -> minSyncFactor = factor ; target -> maxOffset = offset ; target -> maxWidth = width ; spi_min_period ( scsi_target ( sdev ) ) = factor ; spi_max_offset ( scsi_target ( sdev ) ) = offset ; spi_max_width ( scsi_target ( sdev ) ) = width ; target -> tflags |= MPT_TARGET_FLAGS_VALID_NEGO ; if ( ! width ) { target -> negoFlags |= MPT_TARGET_NO_NEGO_WIDE ; } if ( ! offset ) { target -> negoFlags |= MPT_TARGET_NO_NEGO_SYNC ; } if ( factor > MPT_ULTRA320 ) { noQas = 0 ; } if ( noQas && ( pspi_data -> noQas == 0 ) ) { pspi_data -> noQas |= MPT_TARGET_NO_NEGO_QAS ; target -> negoFlags |= MPT_TARGET_NO_NEGO_QAS ; ddvprintk ( ioc , printk ( MYIOC_s_DEBUG_FMT "Disabling QAS due to noQas=%02x on id=%d!\n" , ioc -> name , noQas , id ) ) ; } } 