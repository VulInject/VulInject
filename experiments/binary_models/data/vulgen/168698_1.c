static void dwc2_config_fifos ( struct dwc2_hsotg * hsotg ) { struct dwc2_core_params * params = & hsotg -> params ; u32 nptxfsiz , hptxfsiz , dfifocfg , grxfsiz ; dwc2_calculate_dynamic_fifo ( hsotg ) ; grxfsiz = dwc2_readl ( hsotg -> regs + GRXFSIZ ) ; dev_dbg ( hsotg -> dev , "initial grxfsiz=%08x\n" , grxfsiz ) ; grxfsiz &= ~ GRXFSIZ_DEPTH_MASK ; grxfsiz |= params -> host_rx_fifo_size << GRXFSIZ_DEPTH_SHIFT & GRXFSIZ_DEPTH_MASK ; dwc2_writel ( grxfsiz , hsotg -> regs + GRXFSIZ ) ; dev_dbg ( hsotg -> dev , "new grxfsiz=%08x\n" , dwc2_readl ( hsotg -> regs + GRXFSIZ ) ) ; dev_dbg ( hsotg -> dev , "initial gnptxfsiz=%08x\n" , dwc2_readl ( hsotg -> regs + GNPTXFSIZ ) ) ; nptxfsiz = params -> host_nperio_tx_fifo_size << FIFOSIZE_DEPTH_SHIFT & FIFOSIZE_DEPTH_MASK ; nptxfsiz |= params -> host_rx_fifo_size << FIFOSIZE_STARTADDR_SHIFT & FIFOSIZE_STARTADDR_MASK ; dwc2_writel ( nptxfsiz , hsotg -> regs + GNPTXFSIZ ) ; dev_dbg ( hsotg -> dev , "new gnptxfsiz=%08x\n" , dwc2_readl ( hsotg -> regs + GNPTXFSIZ ) ) ; dev_dbg ( hsotg -> dev , "initial hptxfsiz=%08x\n" , dwc2_readl ( hsotg -> regs + HPTXFSIZ ) ) ; hptxfsiz = params -> host_perio_tx_fifo_size << FIFOSIZE_DEPTH_SHIFT & FIFOSIZE_DEPTH_MASK ; hptxfsiz |= ( params -> host_rx_fifo_size + params -> host_nperio_tx_fifo_size ) << FIFOSIZE_STARTADDR_SHIFT & FIFOSIZE_STARTADDR_MASK ; dwc2_writel ( hptxfsiz , hsotg -> regs + HPTXFSIZ ) ; dev_dbg ( hsotg -> dev , "new hptxfsiz=%08x\n" , dwc2_readl ( hsotg -> regs + HPTXFSIZ ) ) ; if ( hsotg -> params . en_multiple_tx_fifo && hsotg -> hw_params . snpsid >= DWC2_CORE_REV_2_91a ) { dfifocfg = dwc2_readl ( hsotg -> regs + GDFIFOCFG ) ; dfifocfg &= ~ GDFIFOCFG_EPINFOBASE_MASK ; dfifocfg |= ( params -> host_rx_fifo_size + params -> host_nperio_tx_fifo_size + params -> host_perio_tx_fifo_size ) << GDFIFOCFG_EPINFOBASE_SHIFT & GDFIFOCFG_EPINFOBASE_MASK ; dwc2_writel ( dfifocfg , hsotg -> regs + GDFIFOCFG ) ; } } 