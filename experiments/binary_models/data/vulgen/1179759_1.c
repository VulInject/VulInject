static int netvsc_vf_changed ( struct net_device * vf_netdev , unsigned long event ) { struct net_device_context * net_device_ctx ; struct netvsc_device * netvsc_dev ; struct net_device * ndev ; bool vf_is_up = false ; int ret ; ndev = get_netvsc_byref ( vf_netdev ) ; if ( ! ndev ) { return NOTIFY_DONE ; } net_device_ctx = netdev_priv ( ndev ) ; netvsc_dev = rtnl_dereference ( net_device_ctx -> nvdev ) ; if ( ! netvsc_dev ) { return NOTIFY_DONE ; } if ( net_device_ctx -> data_path_is_vf == vf_is_up ) { return NOTIFY_OK ; } if ( vf_is_up && ! net_device_ctx -> vf_alloc ) { netdev_info ( ndev , "Waiting for the VF association from host\n" ) ; wait_for_completion ( & net_device_ctx -> vf_add ) ; } ret = netvsc_switch_datapath ( ndev , vf_is_up ) ; if ( ret ) { netdev_err ( ndev , "Data path failed to switch %s VF: %s, err: %d\n" , vf_is_up ?"to" : "from" , vf_netdev -> name , ret ) ; return NOTIFY_DONE ; } else { netdev_info ( ndev , "Data path switched %s VF: %s\n" , vf_is_up ?"to" : "from" , vf_netdev -> name ) ; } return NOTIFY_OK ; } 