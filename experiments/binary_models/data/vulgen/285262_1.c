static void intel_fbc_update_state ( struct intel_atomic_state * state , struct intel_crtc * crtc , struct intel_plane * plane ) { struct drm_i915_private * i915 = to_i915 ( state -> base . dev ) ; const struct intel_crtc_state * crtc_state = intel_atomic_get_new_crtc_state ( state , crtc ) ; const struct intel_plane_state * plane_state = intel_atomic_get_new_plane_state ( state , plane ) ; struct intel_fbc * fbc = plane -> fbc ; struct intel_fbc_state * fbc_state = & fbc -> state ; WARN_ON ( fbc_state -> plane && fbc_state -> plane != plane ) ; fbc_state -> plane = plane ; fbc_state -> interval = drm_mode_vrefresh ( & crtc_state -> hw . adjusted_mode ) ; fbc_state -> fence_y_offset = intel_plane_fence_y_offset ( plane_state ) ; drm_WARN_ON ( & i915 -> drm , plane_state -> flags & PLANE_HAS_FENCE && ! plane_state -> ggtt_vma -> fence ) ; if ( plane_state -> flags & PLANE_HAS_FENCE && plane_state -> ggtt_vma -> fence ) { fbc_state -> fence_id = plane_state -> ggtt_vma -> fence -> id ; } else { fbc_state -> fence_id = - 1 ; } fbc_state -> cfb_stride = intel_fbc_cfb_stride ( plane_state ) ; fbc_state -> cfb_size = intel_fbc_cfb_size ( plane_state ) ; fbc_state -> override_cfb_stride = intel_fbc_override_cfb_stride ( plane_state ) ; } 