static void lbs_scan_worker ( struct work_struct * work ) { struct lbs_private * priv = container_of ( work , lbs_private , scan_work . work ) ; struct cmd_ds_802_11_scan * scan_cmd ; u8 * tlv ; int last_channel ; int running , carrier ; lbs_deb_enter ( LBS_DEB_SCAN ) ; scan_cmd = kzalloc ( LBS_SCAN_MAX_CMD_SIZE , GFP_KERNEL ) ; if ( scan_cmd == NULL ) { out_no_scan_cmd } running = ! netif_queue_stopped ( priv -> dev ) ; carrier = netif_carrier_ok ( priv -> dev ) ; if ( running ) { netif_stop_queue ( priv -> dev ) ; } if ( carrier ) { netif_carrier_off ( priv -> dev ) ; } tlv = scan_cmd -> tlvbuffer ; if ( priv -> scan_req -> n_ssids && priv -> scan_req -> ssids [ 0 ] . ssid_len > 0 ) { tlv += lbs_add_ssid_tlv ( tlv , priv -> scan_req -> ssids [ 0 ] . ssid , priv -> scan_req -> ssids [ 0 ] . ssid_len ) ; } last_channel = priv -> scan_channel + LBS_SCAN_BEFORE_NAP ; if ( last_channel > priv -> scan_req -> n_channels ) { last_channel = priv -> scan_req -> n_channels ; } tlv += lbs_add_channel_list_tlv ( priv , tlv , last_channel , priv -> scan_req -> n_ssids ) ; tlv += lbs_add_supported_rates_tlv ( tlv ) ; if ( priv -> scan_channel < priv -> scan_req -> n_channels ) { cancel_delayed_work ( & priv -> scan_work ) ; if ( netif_running ( priv -> dev ) ) { queue_delayed_work ( priv -> work_thread , & priv -> scan_work , msecs_to_jiffies ( 300 ) ) ; } } scan_cmd -> hdr . size = cpu_to_le16 ( tlv - ( u8 * ) scan_cmd ) ; lbs_deb_hex ( LBS_DEB_SCAN , "SCAN_CMD" , ( void * ) scan_cmd , sizeof ( * scan_cmd ) ) ; lbs_deb_hex ( LBS_DEB_SCAN , "SCAN_TLV" , scan_cmd -> tlvbuffer , tlv - scan_cmd -> tlvbuffer ) ; __lbs_cmd ( priv , CMD_802_11_SCAN , & scan_cmd -> hdr , le16_to_cpu ( scan_cmd -> hdr . size ) , lbs_ret_scan , 0 ) ; if ( priv -> scan_channel >= priv -> scan_req -> n_channels ) { cancel_delayed_work ( & priv -> scan_work ) ; lbs_scan_done ( priv ) ; } if ( carrier ) { netif_carrier_on ( priv -> dev ) ; } if ( running && ! priv -> tx_pending_len ) { netif_wake_queue ( priv -> dev ) ; } kfree ( scan_cmd ) ; if ( priv -> scan_req == NULL ) { lbs_deb_scan ( "scan: waking up waiters\n" ) ; wake_up_all ( & priv -> scan_q ) ; } out_no_scan_cmd lbs_deb_leave ( LBS_DEB_SCAN ) ; } 