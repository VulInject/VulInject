OMGT_STATUS_T omgt_sa_register_trap ( struct omgt_port * port , uint16_t trap_num , void * context ) { OMGT_STATUS_T status ; int ret ; omgt_sa_registration_t * reg ; if ( port -> is_oob_enabled ) { OMGT_OUTPUT_ERROR ( port , "Port in Out-of-Band Mode, Trap registration not Supported\n" ) ; return OMGT_STATUS_INVALID_STATE ; } reg = ( omgt_sa_registration_t * ) calloc ( 1 , sizeof reg ) ; if ( reg == NULL ) { OMGT_OUTPUT_ERROR ( port , "failed to allocate reg structure\n" ) ; return OMGT_STATUS_ERROR ; } status = FTIMEOUT ; if ( omgt_lock_sem ( & port -> lock ) ) { OMGT_OUTPUT_ERROR ( port , "failed to acquire lock (status: %d)\n" , status ) ; return OMGT_STATUS_ERROR ; } if ( omgt_sa_find_reg ( port , trap_num ) ) { omgt_unlock_sem ( & port -> lock ) ; free ( reg ) ; return OMGT_STATUS_SUCCESS ; } if ( ( ret = create_sa_qp ( port ) ) != 0 ) { omgt_unlock_sem ( & port -> lock ) ; OMGT_OUTPUT_ERROR ( port , "failed to create notice QP for trap (%u) registration (status: %d)\n" , trap_num , ret ) ; } if ( ( ret = userspace_register ( port , trap_num , reg ) ) != 0 ) { omgt_unlock_sem ( & port -> lock ) ; OMGT_OUTPUT_ERROR ( port , "failed to register for trap (%u) (status: %d)\n" , trap_num , ret ) ; } if ( ret ) { free ( reg ) ; return OMGT_STATUS_ERROR ; } reg -> user_context = context ; reg -> trap_num = trap_num ; omgt_sa_add_reg_unsafe ( port , reg ) ; omgt_unlock_sem ( & port -> lock ) ; return OMGT_STATUS_SUCCESS ; } 