int cvm_oct_common_open ( struct net_device * dev , void * link_poll ( struct net_device * ) ) { union cvmx_gmxx_prtx_cfg gmx_cfg ; struct octeon_ethernet * priv = netdev_priv ( dev ) ; int interface = INTERFACE ( priv -> port ) ; int index = INDEX ( priv -> port ) ; union cvmx_helper_link_info link_info ; int rv ; rv = cvm_oct_phy_setup_device ( dev ) ; if ( rv ) { return rv ; } gmx_cfg . u64 = cvmx_read_csr ( CVMX_GMXX_PRTX_CFG ( index , interface ) ) ; gmx_cfg . s . en = 1 ; if ( octeon_has_feature ( OCTEON_FEATURE_PKND ) ) { gmx_cfg . s . pknd = priv -> port ; } cvmx_write_csr ( CVMX_GMXX_PRTX_CFG ( index , interface ) , gmx_cfg . u64 ) ; if ( octeon_is_simulation ( ) ) { return 0 ; } if ( dev -> phydev ) { int r = phy_read_status ( dev -> phydev ) ; if ( r == 0 && dev -> phydev -> link == 0 ) { netif_carrier_off ( 0 ) ; } cvm_oct_adjust_link ( dev ) ; } else { link_info = cvmx_helper_link_get ( priv -> port ) ; if ( ! link_info . s . link_up ) { netif_carrier_off ( dev ) ; } priv -> poll = link_poll ; link_poll ( dev ) ; } return 0 ; } 