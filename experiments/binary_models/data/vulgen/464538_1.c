static void pch_spi_request_dma ( struct pch_spi_data * data , int bpw ) { dma_cap_mask_t mask ; struct dma_chan * chan ; struct pci_dev * dma_dev ; struct pch_dma_slave * param ; struct pch_spi_dma_ctrl * dma ; unsigned int width ; if ( bpw == 8 ) { width = PCH_DMA_WIDTH_1_BYTE ; } else { width = PCH_DMA_WIDTH_2_BYTES ; } dma = & data -> dma ; dma_cap_zero ( mask ) ; dma_cap_set ( DMA_SLAVE , mask ) ; dma_dev = pci_get_slot ( data -> board_dat -> pdev -> bus , PCI_DEVFN ( PCI_SLOT ( data -> board_dat -> pdev -> devfn ) , 0 ) ) ; param = & dma -> param_tx ; param -> dma_dev = & dma_dev -> dev ; param -> chan_id = data -> ch * 2 ; param -> tx_reg = data -> io_base_addr + PCH_SPDWR ; param -> width = width ; chan = dma_request_channel ( mask , pch_spi_filter , param ) ; if ( ! chan ) { dev_err ( & data -> master -> dev , "ERROR: dma_request_channel FAILS(Tx)\n" ) ; data -> use_dma = 0 ; return ; } dma -> chan_tx = chan ; param = & dma -> param_rx ; param -> dma_dev = & dma_dev -> dev ; param -> chan_id = data -> ch * 2 + 1 ; param -> rx_reg = data -> io_base_addr + PCH_SPDRR ; param -> width = width ; chan = dma_request_channel ( mask , pch_spi_filter , param ) ; if ( ! chan ) { dev_err ( & data -> master -> dev , "ERROR: dma_request_channel FAILS(Rx)\n" ) ; dma -> chan_tx = NULL ; data -> use_dma = 0 ; return ; } dma -> chan_rx = chan ; } 