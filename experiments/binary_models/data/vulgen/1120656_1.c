static int kfd_process_init_cwsr_apu ( struct kfd_process * p , struct file * filep ) { unsigned long offset ; int i ; for ( i = 0 ; i < p -> n_pdds ; i ++ ) { struct kfd_dev * dev = p -> pdds [ i ] -> dev ; struct qcm_process_device * qpd = & p -> pdds [ i ] -> qpd ; if ( ! dev -> cwsr_enabled || qpd -> cwsr_kaddr || qpd -> cwsr_base ) { continue ; } offset = KFD_MMAP_TYPE_RESERVED_MEM | KFD_MMAP_GPU_ID ( dev -> id ) ; qpd -> tba_addr = ( int64_t ) vm_mmap ( filep , 0 , KFD_CWSR_TBA_TMA_SIZE , PROT_READ | PROT_EXEC , MAP_SHARED , offset ) ; if ( IS_ERR_VALUE ( qpd -> tba_addr ) ) { int err = qpd -> tba_addr ; pr_err ( "Failure to set tba address. error %d.\n" , err ) ; qpd -> tba_addr = 0 ; return err ; } memcpy ( qpd -> cwsr_kaddr , dev -> cwsr_isa , dev -> cwsr_isa_size ) ; qpd -> tma_addr = qpd -> tba_addr + KFD_CWSR_TMA_OFFSET ; pr_debug ( "set tba :0x%llx, tma:0x%llx, cwsr_kaddr:%p for pqm.\n" , qpd -> tba_addr , qpd -> tma_addr , qpd -> cwsr_kaddr ) ; } return 0 ; } 