int uhidev_set_report ( struct uhidev_softc * sc , int type , int id , void * data , int len ) { usb_device_request_t req ; char * buf = data ; int actlen = len ; if ( id > 0 ) { len ++ ; buf = malloc ( len , M_TEMP , M_WAITOK ) ; buf [ 0 ] = id ; memcpy ( buf + 1 , data , len - 1 ) ; } if ( sc -> sc_opipe != NULL ) { usbd_setup_xfer ( sc -> sc_owxfer , sc -> sc_opipe , 0 , buf , len , USBD_SYNCHRONOUS | USBD_CATCH , 0 , NULL ) ; if ( usbd_transfer ( sc -> sc_owxfer ) ) { usbd_clear_endpoint_stall ( sc -> sc_opipe ) ; actlen = - 1 ; } } else { req . bmRequestType = UT_WRITE_CLASS_INTERFACE ; req . bRequest = UR_SET_REPORT ; USETW2 ( req . wValue , type , id ) ; USETW ( req . wIndex , sc -> sc_ifaceno ) ; USETW ( req . wLength , len ) ; if ( usbd_do_request ( sc -> sc_udev , & req , buf ) ) { actlen = - 1 ; } } return ( actlen ) ; } 