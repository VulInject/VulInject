static int mcpe_dissect_batch ( tvbuff_t * tvb , packet_info * pinfo , proto_tree * tree , void * data ) { if ( tree ) { guint32 item_size ; guint32 offset = 1 ; proto_item * ti ; guint32 comp_length ; tvbuff_t * batch_tvb ; item_size = 4 ; proto_tree_add_item_ret_uint ( tree , hf_mcpe_batch_length , tvb , offset , item_size , ENC_BIG_ENDIAN , & comp_length ) ; offset += item_size ; item_size = comp_length ; ti = proto_tree_add_item ( tree , hf_mcpe_batch_body , tvb , offset , item_size , ENC_NA ) ; batch_tvb = tvb_child_uncompress ( tvb , tvb , offset , comp_length ) ; if ( batch_tvb ) { guint32 decomp_length ; proto_tree * batch_tree ; add_new_data_source ( pinfo , batch_tvb , "MCPE Decompressed batch" ) ; offset = 0 ; item_size = decomp_length ; ti = proto_tree_add_item ( tree , hf_mcpe_batch_records , batch_tvb , offset , item_size , ENC_NA ) ; batch_tree = proto_item_add_subtree ( ti , ett_mcpe_batch ) ; proto_item_append_text ( ti , " (%u octets)" , decomp_length ) ; proto_item_set_generated ( ti ) ; col_append_str ( pinfo -> cinfo , COL_INFO , " [" ) ; while ( TRUE ) { guint32 record_length ; tvbuff_t * record_tvb ; proto_tree * record_tree ; guint32 packet_id ; gint dissected ; item_size = 4 ; proto_tree_add_item_ret_uint ( batch_tree , hf_mcpe_batch_record_length , batch_tvb , offset , item_size , ENC_BIG_ENDIAN , & record_length ) ; offset += item_size ; record_tvb = tvb_new_subset_length ( batch_tvb , offset , record_length ) ; offset += record_length ; ti = proto_tree_add_item ( batch_tree , hf_mcpe_batch_record , record_tvb , 0 , - 1 , ENC_NA ) ; record_tree = proto_item_add_subtree ( ti , ett_mcpe_batch_record ) ; proto_tree_add_item_ret_uint ( record_tree , hf_mcpe_packet_id , record_tvb , 0 , 1 , ENC_NA , & packet_id ) ; proto_item_append_text ( ti , " (%s)" , val_to_str ( packet_id , mcpe_packet_names , "Unknown ID: %#x" ) ) ; col_append_str ( pinfo -> cinfo , COL_INFO , val_to_str ( packet_id , mcpe_packet_names , "Unknown packet ID: %#x" ) ) ; dissected = dissector_try_uint_new ( mcpe_packet_dissectors , packet_id , record_tvb , pinfo , record_tree , TRUE , data ) ; if ( ! dissected ) { expert_add_info ( pinfo , ti , & ei_mcpe_unknown_packet_id ) ; } if ( offset < decomp_length ) { col_append_str ( pinfo -> cinfo , COL_INFO , ", " ) ; } else { break ; } } col_append_str ( pinfo -> cinfo , COL_INFO , "]" ) ; } else { expert_add_info ( pinfo , ti , & ei_mcpe_decompression_failed ) ; } } return tvb_reported_length ( tvb ) ; } 