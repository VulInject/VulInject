TEST ( ) { const char16_t utf16 [ ] { htole16 ( 'a' ) htole16 ( 0xd800 ) htole16 ( 'b' ) htole16 ( 0xdc00 ) htole16 ( 'c' ) htole16 ( 0xd801 ) htole16 ( 0xdc37 ) } ; ; static const char utf8 [ ] { 'a' 'b' 'c' 0xf0 0x90 0x90 0xb7 } ; ; _cleanup_free_ char16_t * b = NULL ; _cleanup_free_ char * a = NULL ; a = utf16_to_utf8 ( utf16 , sizeof ( utf16 ) ) ; assert_se ( a ) ; assert_se ( memcmp ( a , utf8 , sizeof ( utf8 ) ) == 0 ) ; b = utf8_to_utf16 ( utf8 , sizeof ( utf8 ) ) ; assert_se ( b ) ; a = utf16_to_utf8 ( b , char16_strlen ( b ) * 2 ) ; assert_se ( a ) ; assert_se ( strlen ( a ) == sizeof ( utf8 ) ) ; assert_se ( memcmp ( a , utf8 , sizeof ( utf8 ) ) == 0 ) ; } 