static void set_file_environment ( const gchar * filename , const gchar * dirname ) { const char * path ; lua_newtable ( L ) ; lua_pushstring ( L , filename ) ; lua_setfield ( L , - 2 , FILE_NAME_KEY ) ; lua_pushstring ( L , dirname ) ; lua_setfield ( L , - 2 , DIR_NAME_KEY ) ; lua_pushstring ( L , G_DIR_SEPARATOR_S ) ; lua_setfield ( L , - 2 , DIR_SEP_NAME_KEY ) ; lua_newtable ( L ) ; lua_pushglobaltable ( L ) ; lua_pushvalue ( L , LUA_GLOBALSINDEX ) ; lua_getfield ( L , - 1 , "package" ) ; lua_getfield ( L , - 1 , "path" ) ; lua_pop ( L , 1 ) ; lua_pushfstring ( L , "%s" G_DIR_SEPARATOR_S "?.lua;%s" G_DIR_SEPARATOR_S "?.lua;%s" G_DIR_SEPARATOR_S "?.lua;%s" , dirname , get_plugins_pers_dir ( ) , get_plugins_dir ( ) , path ) ; lua_setfield ( L , - 2 , "path" ) ; lua_setfield ( L , - 2 , "package" ) ; lua_setfield ( L , - 2 , "__index" ) ; lua_setmetatable ( L , - 2 ) ; lua_setupvalue ( L , - 2 , 1 ) ; lua_setfenv ( L , - 2 ) ; } 