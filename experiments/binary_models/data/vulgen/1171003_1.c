static void probe_devices ( int bus ) { struct usbdevfs_ctrltransfer ctrl ; struct dirent * data ; int ret = 0 ; char busdevpath [ sizeof ( "/dev/bus/usb/000/" ) + NAME_MAX ] ; DIR * dir ; uint8_t descriptor [ USB_DEVICE_DESCRIPTOR_SIZE ] ; uint8_t configdesc [ USB_CONFIG_DESCRIPTOR_SIZE ] ; snprintf ( busdevpath , sizeof ( busdevpath ) , "/dev/bus/usb/%03d" , bus ) ; dir = opendir ( busdevpath ) ; if ( ! dir ) { return ; } while ( ( ret >= 0 ) && ( ( data = readdir ( dir ) ) != 0 ) ) { int fd ; char * name = data -> d_name ; if ( name [ 0 ] == '.' ) { continue ; } snprintf ( busdevpath , sizeof ( busdevpath ) , "/dev/bus/usb/%03d/%s" , bus , data -> d_name ) ; if ( fd == - 1 ) { continue ; } ctrl . bRequestType = USB_DIR_IN | USB_TYPE_STANDARD | USB_RECIP_DEVICE ; ctrl . bRequest = USB_REQ_GET_DESCRIPTOR ; ctrl . wValue = USB_DT_DEVICE << 8 ; ctrl . wIndex = 0 ; ctrl . wLength = sizeof ( descriptor ) ; ctrl . requesttype = USB_DIR_IN | USB_TYPE_STANDARD | USB_RECIP_DEVICE ; ctrl . request = USB_REQ_GET_DESCRIPTOR ; ctrl . value = USB_DT_DEVICE << 8 ; ctrl . index = 0 ; ctrl . length = sizeof ( descriptor ) ; ctrl . data = descriptor ; ctrl . timeout = CTRL_TIMEOUT ; ret = ioctl ( fd , USBDEVFS_CONTROL , & ctrl ) ; ctrl . wValue = USB_DT_CONFIG << 8 ; ctrl . wLength = sizeof ( configdesc ) ; ctrl . value = USB_DT_CONFIG << 8 ; ctrl . length = sizeof ( configdesc ) ; ctrl . data = configdesc ; ret = ioctl ( fd , USBDEVFS_CONTROL , & ctrl ) ; if ( ret >= 0 ) { uint16_t wtotallength ; wtotallength = EXTRACT_LE_U_2 ( & configdesc [ 2 ] ) ; ctrl . wLength = wtotallength ; ctrl . length = wtotallength ; ctrl . data = malloc ( wtotallength ) ; if ( ctrl . data ) { ret = ioctl ( fd , USBDEVFS_CONTROL , & ctrl ) ; free ( ctrl . data ) ; } } close ( fd ) ; } closedir ( dir ) ; } 