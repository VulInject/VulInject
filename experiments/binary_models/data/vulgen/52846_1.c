int xfrm_dev_policy_add ( struct net * net , struct xfrm_policy * xp , struct xfrm_user_offload * xuo , u8 dir , struct netlink_ext_ack * extack ) { struct xfrm_dev_offload * xdo = & xp -> xdo ; struct net_device * dev ; int err ; if ( ! xuo -> flags || xuo -> flags & ~ XFRM_OFFLOAD_PACKET ) { NL_SET_ERR_MSG ( extack , "Unrecognized flags in offload request" ) ; return - EINVAL ; } dev = dev_get_by_index ( net , xuo -> ifindex ) ; if ( ! dev ) { return - EINVAL ; } if ( ! dev -> xfrmdev_ops || ! dev -> xfrmdev_ops -> xdo_dev_policy_add ) { dev_put ( dev ) ; NL_SET_ERR_MSG ( extack , "Policy offload is not supported" ) ; return - EINVAL ; } xdo -> dev = dev ; netdev_tracker_alloc ( dev , & xdo -> dev_tracker , GFP_ATOMIC ) ; xdo -> real_dev = dev ; xdo -> type = XFRM_DEV_OFFLOAD_PACKET ; switch ( dir ) { case XFRM_POLICY_IN : xdo -> dir = XFRM_DEV_OFFLOAD_IN ; break ; case XFRM_POLICY_OUT : xdo -> dir = XFRM_DEV_OFFLOAD_OUT ; break ; case XFRM_POLICY_FWD : xdo -> dir = XFRM_DEV_OFFLOAD_FWD ; break ; default : xdo -> dev = NULL ; dev_put ( dev ) ; NL_SET_ERR_MSG ( extack , "Unrecognized offload direction" ) ; return - EINVAL ; } err = dev -> xfrmdev_ops -> xdo_dev_policy_add ( xp , extack ) ; if ( err ) { xdo -> dev = NULL ; xdo -> real_dev = NULL ; xdo -> type = XFRM_DEV_OFFLOAD_UNSPECIFIED ; xdo -> dir = 0 ; netdev_put ( dev , & xdo -> dev_tracker ) ; NL_SET_ERR_MSG_WEAK ( extack , "Device failed to offload this policy" ) ; return err ; } return 0 ; } 