static ulong rk3368_spi_set_clk ( struct rk3368_cru * cru , ulong clk_id , uint hz ) { const struct spi_clkreg * spiclk = NULL ; int src_clk_div ; src_clk_div = DIV_ROUND_UP ( GPLL_HZ , hz ) ; switch ( clk_id ) { case SCLK_SPI0 ... SCLK_SPI2 : spiclk = & spi_clkregs [ clk_id - SCLK_SPI0 ] ; break ; default : pr_err ( "%s: SPI clk-id %ld not supported\n" , __func__ , clk_id ) ; return - EINVAL ; } rk_clrsetreg ( & cru -> clksel_con [ spiclk -> reg ] , ( ( 0x7f << spiclk -> div_shift ) | ( 0x1 << spiclk -> sel_shift ) ) , ( ( src_clk_div << spiclk -> div_shift ) | ( 1 << spiclk -> sel_shift ) ) ) ; return rk3368_spi_get_clk ( cru , clk_id ) ; } 