static fruenvseg_t * get_fru_envsegs ( void ) { fruenvseg_t * fruenvsegs ; envseg_layout_t * envsegp ; void * envsegbufp ; int fd , envseglen , hdrlen ; char path [ PATH_MAX ] ; fruenvsegs = NULL ; fruenvsegs = malloc ( sizeof ( * fruenvsegs ) ) ; if ( fruenvsegs == NULL ) { return ( NULL ) ; } fd = open ( path , O_RDONLY ) ; if ( fd == - 1 ) { envd_log ( LOG_ERR , ENV_FRU_OPEN_FAIL , errno , path ) ; free ( fruenvsegs ) ; return ( NULL ) ; } if ( get_envseg ( fd , & envsegbufp , & envseglen ) != 0 ) { envd_log ( LOG_ERR , ENV_FRU_BAD_ENVSEG , path ) ; free ( fruenvsegs ) ; ( void ) close ( fd ) ; return ( NULL ) ; } envsegp = ( envseg_layout_t * ) envsegbufp ; hdrlen = sizeof ( envseg_layout_t ) - sizeof ( envseg_sensor_t ) + ( envsegp -> sensor_count ) * sizeof ( envseg_sensor_t ) ; if ( envsegp -> version != ENVSEG_VERSION || envseglen < hdrlen ) { envd_log ( LOG_CRIT , ENV_FRU_BAD_ENVSEG , path ) ; if ( envsegbufp != NULL ) { ( void ) free ( envsegbufp ) ; } free ( fruenvsegs ) ; ( void ) close ( fd ) ; return ( NULL ) ; } fruenvsegs -> envseglen = envseglen ; fruenvsegs -> envsegbufp = envsegbufp ; ( void ) close ( fd ) ; return ( fruenvsegs ) ; } 