static void virtio_transport_loopback_work ( struct work_struct * work ) { struct virtio_vsock * vsock = container_of ( work , virtio_vsock , loopback_work ) ; LIST_HEAD ( pkts ) ; spin_lock_bh ( & vsock -> loopback_list_lock ) ; list_splice_init ( & vsock -> loopback_list , & pkts ) ; spin_unlock_bh ( & vsock -> loopback_list_lock ) ; mutex_lock ( & vsock -> rx_lock ) ; while ( ! list_empty ( & pkts ) ) { struct virtio_vsock_pkt * pkt ; pkt = list_first_entry ( & pkts , virtio_vsock_pkt , list ) ; list_del_init ( & pkt -> list ) ; virtio_transport_recv_pkt ( pkt ) ; } } 