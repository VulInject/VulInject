static bool vc4_crtc_get_scanout_position ( struct drm_crtc * crtc , bool in_vblank_irq , int * vpos , int * hpos , ktime_t * stime , ktime_t * etime , const struct drm_display_mode * mode ) { struct drm_device * dev = crtc -> dev ; struct vc4_dev * vc4 = to_vc4_dev ( dev ) ; struct vc4_hvs * hvs = vc4 -> hvs ; struct vc4_crtc * vc4_crtc = to_vc4_crtc ( crtc ) ; struct vc4_crtc_state * vc4_crtc_state = to_vc4_crtc_state ( crtc -> state ) ; unsigned int cob_size ; u32 val ; int fifo_lines ; int vblank_lines ; bool ret = false ; if ( stime ) { * stime = ktime_get ( ) ; } val = HVS_READ ( SCALER_DISPSTATX ( vc4_crtc_state -> assigned_channel ) ) ; if ( etime ) { * etime = ktime_get ( ) ; } * vpos = VC4_GET_FIELD ( val , SCALER_DISPSTATX_LINE ) ; * hpos = 0 ; if ( mode -> flags & DRM_MODE_FLAG_INTERLACE ) { * vpos /= 2 ; if ( vc4_hvs_get_fifo_frame_count ( hvs , vc4_crtc_state -> assigned_channel ) % 2 ) { * hpos += mode -> crtc_htotal / 2 ; } } cob_size = vc4_crtc_get_cob_allocation ( vc4 , vc4_crtc_state -> assigned_channel ) ; fifo_lines = cob_size / mode -> crtc_hdisplay ; if ( fifo_lines > 0 ) { ret = true ; } if ( * vpos > fifo_lines ) { return ret ; } vblank_lines = mode -> vtotal - mode -> vdisplay ; if ( in_vblank_irq ) { * vpos = - vblank_lines ; if ( stime ) { * stime = vc4_crtc -> t_vblank ; } if ( etime ) { * etime = vc4_crtc -> t_vblank ; } } else { * vpos = 0 ; } return ret ; } 