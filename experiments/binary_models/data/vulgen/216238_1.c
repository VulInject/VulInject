static int create_hyp_pmd_mappings ( pud_t * pud , unsigned long start , unsigned long end , unsigned long pfn , pgprot_t prot ) { pmd_t * pmd ; pte_t * pte ; unsigned long addr , next ; addr = start ; { pmd = pmd_offset ( pud , addr ) ; BUG_ON ( pmd_sect ( * pmd ) ) ; if ( pmd_none ( * pmd ) ) { pte = pte_alloc_one_kernel ( NULL , addr ) ; if ( ! pte ) { kvm_err ( "Cannot allocate Hyp pte\n" ) ; return - ENOMEM ; } pmd_populate_kernel ( NULL , pmd , pte ) ; get_page ( virt_to_page ( pmd ) ) ; } next = pmd_addr_end ( addr , end ) ; create_hyp_pte_mappings ( pmd , addr , next , pfn , prot ) ; pfn += ( next - addr ) >> PAGE_SHIFT ; } addr = next , addr != end ; return 0 ; } 