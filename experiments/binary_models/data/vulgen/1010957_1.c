static int zforce_read_packet ( struct zforce_ts * ts , u8 * buf ) { struct i2c_client * client = ts -> client ; int ret ; mutex_lock ( & ts -> access_mutex ) ; ret = i2c_master_recv ( client , buf , 2 ) ; if ( ret < 0 ) { dev_err ( & client -> dev , "error reading header: %d\n" , ret ) ; unlock } if ( buf [ PAYLOAD_HEADER ] != FRAME_START ) { dev_err ( & client -> dev , "invalid frame start: %d\n" , buf [ 0 ] ) ; ret = - EIO ; unlock } if ( buf [ PAYLOAD_LENGTH ] == 0 ) { dev_err ( & client -> dev , "invalid payload length: %d\n" , buf [ PAYLOAD_LENGTH ] ) ; ret = - EIO ; unlock } ret = i2c_master_recv ( client , & buf [ PAYLOAD_BODY ] , buf [ PAYLOAD_LENGTH ] ) ; if ( ret < 0 ) { dev_err ( & client -> dev , "error reading payload: %d\n" , ret ) ; unlock } dev_dbg ( & client -> dev , "read %d bytes for response command 0x%x\n" , buf [ PAYLOAD_LENGTH ] , buf [ PAYLOAD_BODY ] ) ; unlock return ret ; } 