int tomoyo_mount_permission ( const char * dev_name , const struct path * path , const char * type , unsigned long flags , void * data_page ) { struct tomoyo_request_info r ; int error ; int idx ; if ( tomoyo_init_request_info ( & r , NULL , TOMOYO_MAC_FILE_MOUNT ) == TOMOYO_CONFIG_DISABLED ) { return 0 ; } if ( flags & MS_REMOUNT ) { type = tomoyo_mounts [ TOMOYO_MOUNT_REMOUNT ] ; flags &= ~ MS_REMOUNT ; } if ( flags & MS_BIND ) { type = tomoyo_mounts [ TOMOYO_MOUNT_BIND ] ; flags &= ~ MS_BIND ; } if ( flags & MS_SHARED ) { if ( flags & ( MS_PRIVATE | MS_SLAVE | MS_UNBINDABLE ) ) { return - EINVAL ; } type = tomoyo_mounts [ TOMOYO_MOUNT_MAKE_SHARED ] ; flags &= ~ MS_SHARED ; } if ( flags & MS_PRIVATE ) { if ( flags & ( MS_SHARED | MS_SLAVE | MS_UNBINDABLE ) ) { return - EINVAL ; } type = tomoyo_mounts [ TOMOYO_MOUNT_MAKE_PRIVATE ] ; flags &= ~ MS_PRIVATE ; } if ( flags & MS_SLAVE ) { if ( flags & ( MS_SHARED | MS_PRIVATE | MS_UNBINDABLE ) ) { return - EINVAL ; } type = tomoyo_mounts [ TOMOYO_MOUNT_MAKE_SLAVE ] ; flags &= ~ MS_SLAVE ; } if ( flags & MS_UNBINDABLE ) { if ( flags & ( MS_SHARED | MS_PRIVATE | MS_SLAVE ) ) { return - EINVAL ; } type = tomoyo_mounts [ TOMOYO_MOUNT_MAKE_UNBINDABLE ] ; flags &= ~ MS_UNBINDABLE ; } if ( flags & MS_MOVE ) { type = tomoyo_mounts [ TOMOYO_MOUNT_MOVE ] ; flags &= ~ MS_MOVE ; } if ( ! type ) { type = "<NULL>" ; } idx = tomoyo_read_lock ( ) ; error = tomoyo_mount_acl ( & r , dev_name , path , type , flags ) ; tomoyo_read_unlock ( idx ) ; return error ; } 