void sm_dbsync_addSm ( Node_t * nodep , Port_t * portp , STL_SMINFO_RECORD * sminforec ) { SmRecKeyp smreckeyp ; SmRecp smrecp ; uint8_t * path ; IB_ENTER ( __func__ , nodep , portp , sminforec , 0 ) ; if ( dbsync_main_exit ) { return ; } if ( vs_lock ( & smRecords . smLock ) != VSTATUS_OK ) { IB_LOG_INFINI_INFO0 ( "Can't lock SM Record table" ) ; return ; } smreckeyp = ( SmRecKeyp ) malloc ( sizeof ( SmRecKey_t ) ) ; if ( smreckeyp == NULL ) { ( void ) vs_unlock ( & smRecords . smLock ) ; IB_LOG_ERRORLX ( "Can't allocate SM table entry key smguid:" , sminforec -> SMInfo . PortGUID ) ; return ; } * smreckeyp = sminforec -> SMInfo . PortGUID ; if ( NULL == ( smrecp = ( SmRecp ) cs_hashtable_search ( smRecords . smMap , smreckeyp ) ) ) { if ( ( smrecp = ( SmRecp ) malloc ( sizeof ( SmRec_t ) ) ) == NULL ) { ( void ) vs_unlock ( & smRecords . smLock ) ; free ( smreckeyp ) ; IB_FATAL_ERROR_NODUMP ( "sm_dbsync_addSm: Can't allocate SM Record table entry" ) ; IB_EXIT ( __func__ , VSTATUS_NOMEM ) ; return ; } memset ( ( void * ) smrecp , 0 , sizeof ( SmRec_t ) ) ; smrecp -> portguid = sminforec -> SMInfo . PortGUID ; smrecp -> lid = sminforec -> RID . LID ; smrecp -> portNumber = portp -> index ; if ( nodep == sm_newTopology . node_head ) { smrecp -> isEmbedded = 1 ; smrecp -> isEmbedded = 0 ; } else { smrecp -> isEmbedded = portp -> index ?0 : 1 ; } if ( nodep == sm_newTopology . node_head ) { sm_dbsync_initSmRec ( smrecp ) ; } smrecp -> smInfoRec = * sminforec ; memcpy ( smrecp -> nodeDescString , nodep -> nodeDesc . NodeString , STL_NODE_DESCRIPTION_ARRAY_SIZE ) ; smrecp -> nodeDescString [ NODE_DESCRIPTION_ARRAY_SIZE - 1 ] = '\0' ; path = PathToPort ( nodep , portp ) ; memcpy ( smrecp -> path , path , 64 ) ; if ( ! cs_hashtable_insert ( smRecords . smMap , smreckeyp , smrecp ) ) { ( void ) vs_unlock ( & smRecords . smLock ) ; IB_LOG_ERROR_FMT ( __func__ , "Failed to ADD SM record at portGuid " FMT_U64 ", lid 0x%.8X to SM record table" , * smreckeyp , sminforec -> RID . LID ) ; free ( smrecp ) ; free ( smreckeyp ) ; IB_EXIT ( __func__ , VSTATUS_BAD ) ; return ; } else { IB_LOG_INFO_FMT ( __func__ , "added SM node at Lid 0x%x, portGuid " FMT_U64 " to SM table" , sminforec -> RID . LID , * smreckeyp ) ; } } else { smrecp -> lid = sminforec -> RID . LID ; smrecp -> smInfoRec = * sminforec ; memcpy ( smrecp -> nodeDescString , nodep -> nodeDesc . NodeString , STL_NODE_DESCRIPTION_ARRAY_SIZE ) ; smrecp -> nodeDescString [ NODE_DESCRIPTION_ARRAY_SIZE - 1 ] = '\0' ; path = PathToPort ( nodep , portp ) ; memcpy ( smrecp -> path , path , 64 ) ; IB_LOG_INFO_FMT ( __func__ , "Updated SM node at Lid 0x%x, portGuid " FMT_U64 " in SM table" , sminforec -> RID . LID , * smreckeyp ) ; free ( smreckeyp ) ; } ( void ) vs_unlock ( & smRecords . smLock ) ; IB_EXIT ( __func__ , VSTATUS_OK ) ; return ; } 