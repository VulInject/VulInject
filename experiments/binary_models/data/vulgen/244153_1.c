static int xfs_xattr_iomap_begin ( struct inode * inode , loff_t offset , loff_t length , unsigned flags , struct iomap * iomap , struct iomap * srcmap ) { struct xfs_inode * ip = XFS_I ( inode ) ; struct xfs_mount * mp = ip -> i_mount ; xfs_fileoff_t offset_fsb = XFS_B_TO_FSBT ( mp , offset ) ; xfs_fileoff_t end_fsb = XFS_B_TO_FSB ( mp , offset + length ) ; struct xfs_bmbt_irec imap ; int nimaps = 1 , error = 0 ; unsigned lockmode ; int seq ; lockmode = xfs_ilock_attr_map_shared ( ip ) ; if ( ! xfs_inode_has_attr_fork ( ip ) || ! ip -> i_af . if_nextents ) { error = - ENOENT ; out_unlock } ASSERT ( ip -> i_af . if_format != XFS_DINODE_FMT_LOCAL ) ; error = xfs_bmapi_read ( ip , offset_fsb , end_fsb - offset_fsb , & imap , & nimaps , XFS_BMAPI_ATTRFORK ) ; out_unlock seq = xfs_iomap_inode_sequence ( ip , IOMAP_F_XATTR ) ; xfs_iunlock ( ip , lockmode ) ; if ( error ) { return error ; } ASSERT ( nimaps ) ; return xfs_bmbt_to_iomap ( ip , iomap , & imap , flags , IOMAP_F_XATTR , seq ) ; } 