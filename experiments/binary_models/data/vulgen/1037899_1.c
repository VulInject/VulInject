sense_reason_t spc_emulate_report_luns ( struct se_cmd * cmd ) { struct se_dev_entry * deve ; struct se_session * sess = cmd -> se_sess ; struct se_node_acl * nacl ; struct scsi_lun slun ; unsigned char * buf ; u32 lun_count = 0 , offset = 8 ; __be32 len ; buf = transport_kmap_data_sg ( cmd ) ; if ( ! sess ) { done } nacl = sess -> se_node_acl ; rcu_read_lock ( ) ; hlist_for_each_entry_rcu ( , , ) { lun_count ++ ; if ( offset >= cmd -> data_length ) { continue ; } int_to_scsilun ( deve -> mapped_lun , & slun ) ; memcpy ( buf + offset , & slun , min ( 8u , cmd -> data_length - offset ) ) ; offset += 8 ; } rcu_read_unlock ( ) ; done if ( lun_count == 0 ) { int_to_scsilun ( 0 , & slun ) ; if ( cmd -> data_length > 8 ) { memcpy ( buf + offset , & slun , min ( 8u , cmd -> data_length - offset ) ) ; } lun_count = 1 ; } if ( buf ) { len = cpu_to_be32 ( lun_count * 8 ) ; memcpy ( buf , & len , min_t ( int , sizeof len , cmd -> data_length ) ) ; transport_kunmap_data_sg ( cmd ) ; } target_complete_cmd_with_length ( cmd , GOOD , 8 + lun_count * 8 ) ; return 0 ; } 