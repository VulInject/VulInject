static void spy_dump_mechanism_in ( const char * name , CK_MECHANISM_PTR pMechanism ) { char param_name [ 64 ] ; const char * mec_name ; if ( ! pMechanism ) { fprintf ( spy_output , "[in] %s = NULL\n" , name ) ; return ; } mec_name = lookup_enum ( MEC_T , pMechanism -> mechanism ) ; if ( mec_name ) { fprintf ( spy_output , "[in] %s->type = %s\n" , name , mec_name ) ; } else { char * buffer = malloc ( needed ) ; if ( buffer ) { sprintf ( buffer , "0x%08lX" , pMechanism -> mechanism ) ; fprintf ( spy_output , "[in] %s->type = %s\n" , name , buffer ) ; free ( buffer ) ; } } switch ( pMechanism -> mechanism ) { case CKM_AES_GCM : if ( pMechanism -> pParameter != NULL ) { CK_GCM_PARAMS * param = ( CK_GCM_PARAMS * ) pMechanism -> pParameter ; snprintf ( param_name , sizeof ( param_name ) , "%s->pParameter->pIv[ulIvLen]" , name ) ; spy_dump_string_in ( param_name , param -> pIv , param -> ulIvLen ) ; snprintf ( param_name , sizeof ( param_name ) , "%s->pParameter->ulIvBits" , name ) ; spy_dump_ulong_in ( param_name , param -> ulIvBits ) ; snprintf ( param_name , sizeof ( param_name ) , "%s->pParameter->pAAD[ulAADLen]" , name ) ; spy_dump_string_in ( param_name , param -> pAAD , param -> ulAADLen ) ; fprintf ( spy_output , "[in] %s->pParameter->ulTagBits = %lu\n" , name , param -> ulTagBits ) ; } else { fprintf ( spy_output , "[in] %s->pParameter = NULL\n" , name ) ; break ; } break ; case CKM_ECDH1_DERIVE : case CKM_ECDH1_COFACTOR_DERIVE : if ( pMechanism -> pParameter != NULL ) { CK_ECDH1_DERIVE_PARAMS * param = ( CK_ECDH1_DERIVE_PARAMS * ) pMechanism -> pParameter ; fprintf ( spy_output , "[in] %s->pParameter->kdf = %s\n" , name , lookup_enum ( CKD_T , param -> kdf ) ) ; fprintf ( spy_output , "[in] %s->pParameter->pSharedData[ulSharedDataLen] = " , name ) ; print_generic ( spy_output , 0 , param -> pSharedData , param -> ulSharedDataLen , NULL ) ; fprintf ( spy_output , "[in] %s->pParameter->pPublicData[ulPublicDataLen] = " , name ) ; print_generic ( spy_output , 0 , param -> pPublicData , param -> ulPublicDataLen , NULL ) ; } else { fprintf ( spy_output , "[in] %s->pParameter = NULL\n" , name ) ; break ; } break ; case CKM_ECMQV_DERIVE : if ( pMechanism -> pParameter != NULL ) { CK_ECMQV_DERIVE_PARAMS * param = ( CK_ECMQV_DERIVE_PARAMS * ) pMechanism -> pParameter ; fprintf ( spy_output , "[in] %s->pParameter->kdf = %s\n" , name , lookup_enum ( CKD_T , param -> kdf ) ) ; fprintf ( spy_output , "%s->pParameter->pSharedData[ulSharedDataLen] = " , name ) ; print_generic ( spy_output , 0 , param -> pSharedData , param -> ulSharedDataLen , NULL ) ; fprintf ( spy_output , "%s->pParameter->pPublicData[ulPublicDataLen] = " , name ) ; print_generic ( spy_output , 0 , param -> pPublicData , param -> ulPublicDataLen , NULL ) ; fprintf ( spy_output , "%s->pParameter->ulPrivateDataLen = %lu" , name , param -> ulPrivateDataLen ) ; fprintf ( spy_output , "%s->pParameter->hPrivateData = %lu" , name , param -> hPrivateData ) ; fprintf ( spy_output , "%s->pParameter->pPublicData2[ulPublicDataLen2] = " , name ) ; print_generic ( spy_output , 0 , param -> pPublicData2 , param -> ulPublicDataLen2 , NULL ) ; fprintf ( spy_output , "%s->pParameter->publicKey = %lu" , name , param -> publicKey ) ; } else { fprintf ( spy_output , "[in] %s->pParameter = NULL\n" , name ) ; break ; } break ; case CKM_RSA_PKCS_OAEP : if ( pMechanism -> pParameter != NULL ) { CK_RSA_PKCS_OAEP_PARAMS * param = ( CK_RSA_PKCS_OAEP_PARAMS * ) pMechanism -> pParameter ; fprintf ( spy_output , "[in] %s->pParameter->hashAlg = %s\n" , name , lookup_enum ( MEC_T , param -> hashAlg ) ) ; fprintf ( spy_output , "[in] %s->pParameter->mgf = %s\n" , name , lookup_enum ( MGF_T , param -> mgf ) ) ; fprintf ( spy_output , "[in] %s->pParameter->source = %lu\n" , name , param -> source ) ; snprintf ( param_name , sizeof ( param_name ) , "%s->pParameter->pSourceData[ulSourceDalaLen]" , name ) ; spy_dump_string_in ( param_name , param -> pSourceData , param -> ulSourceDataLen ) ; } else { fprintf ( spy_output , "[in] %s->pParameter = NULL\n" , name ) ; break ; } break ; case CKM_RSA_PKCS_PSS : case CKM_SHA1_RSA_PKCS_PSS : case CKM_SHA256_RSA_PKCS_PSS : case CKM_SHA384_RSA_PKCS_PSS : case CKM_SHA512_RSA_PKCS_PSS : if ( pMechanism -> pParameter != NULL ) { CK_RSA_PKCS_PSS_PARAMS * param = ( CK_RSA_PKCS_PSS_PARAMS * ) pMechanism -> pParameter ; fprintf ( spy_output , "[in] %s->pParameter->hashAlg = %s\n" , name , lookup_enum ( MEC_T , param -> hashAlg ) ) ; fprintf ( spy_output , "[in] %s->pParameter->mgf = %s\n" , name , lookup_enum ( MGF_T , param -> mgf ) ) ; fprintf ( spy_output , "[in] %s->pParameter->sLen = %lu\n" , name , param -> sLen ) ; } else { fprintf ( spy_output , "[in] %s->pParameter = NULL\n" , name ) ; break ; } break ; default : snprintf ( param_name , sizeof ( param_name ) , "%s->pParameter[ulParameterLen]" , name ) ; spy_dump_string_in ( param_name , pMechanism -> pParameter , pMechanism -> ulParameterLen ) ; break ; } } 