u_char __user * fldenv ( fpu_addr_modes addr_modes , u_char __user * s ) { unsigned short tag_word = 0 ; u_char tag ; int i ; if ( ( addr_modes . default_mode == VM86 ) || ( ( addr_modes . default_mode == PM16 ) ^ ( addr_modes . override . operand_size == OP_SIZE_PREFIX ) ) ) { RE_ENTRANT_CHECK_OFF ; FPU_access_ok ( s , 0x0e ) ; FPU_get_user ( control_word , ( unsigned short __user * ) s ) ; FPU_get_user ( partial_status , ( unsigned short __user * ) ( s + 2 ) ) ; FPU_get_user ( tag_word , ( unsigned short __user * ) ( s + 4 ) ) ; FPU_get_user ( instruction_address . offset , ( unsigned short __user * ) ( s + 6 ) ) ; FPU_get_user ( instruction_address . selector , ( unsigned short __user * ) ( s + 8 ) ) ; FPU_get_user ( operand_address . offset , ( unsigned short __user * ) ( s + 0x0a ) ) ; FPU_get_user ( operand_address . selector , ( unsigned short __user * ) ( s + 0x0c ) ) ; RE_ENTRANT_CHECK_ON ; s += 0x0e ; } else { RE_ENTRANT_CHECK_OFF ; FPU_access_ok ( s , 0x1c ) ; FPU_get_user ( control_word , ( unsigned short __user * ) s ) ; FPU_get_user ( partial_status , ( unsigned short __user * ) ( s + 4 ) ) ; FPU_get_user ( tag_word , ( unsigned short __user * ) ( s + 8 ) ) ; FPU_get_user ( instruction_address . offset , ( unsigned long __user * ) ( s + 0x0c ) ) ; FPU_get_user ( instruction_address . selector , ( unsigned short __user * ) ( s + 0x10 ) ) ; FPU_get_user ( instruction_address . opcode , ( unsigned short __user * ) ( s + 0x12 ) ) ; FPU_get_user ( operand_address . offset , ( unsigned long __user * ) ( s + 0x14 ) ) ; FPU_get_user ( operand_address . selector , ( unsigned long __user * ) ( s + 0x18 ) ) ; RE_ENTRANT_CHECK_ON ; s += 0x1c ; } control_word &= ~ 0xe080 ; top = ( partial_status >> SW_Top_Shift ) & 7 ; if ( partial_status & ~ control_word & CW_Exceptions ) { partial_status |= ( SW_Summary | SW_Backward ) ; } else { partial_status &= ~ ( SW_Summary | SW_Backward ) ; } for ( i = 0 ; i < 8 ; i ++ ) { tag = tag_word & 3 ; tag_word >>= 2 ; if ( tag == TAG_Empty ) { FPU_settag ( i , TAG_Empty ) ; } if ( FPU_gettag ( i ) == TAG_Empty ) { if ( exponent ( & fpu_register ( i ) ) == - EXTENDED_Ebias ) { if ( ! ( fpu_register ( i ) . sigl | fpu_register ( i ) . sigh ) ) { FPU_settag ( i , TAG_Zero ) ; } else { FPU_settag ( i , TAG_Special ) ; } } if ( exponent ( & fpu_register ( i ) ) == 0x7fff - EXTENDED_Ebias ) { FPU_settag ( i , TAG_Special ) ; } if ( fpu_register ( i ) . sigh & 0x80000000 ) { FPU_settag ( i , TAG_Valid ) ; } else { FPU_settag ( i , TAG_Special ) ; } } } return s ; } 