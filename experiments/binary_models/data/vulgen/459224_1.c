static xdata_field_t _xdata_field_parse ( xdata_t xd , nad_t nad , int root ) { xdata_field_t xdf ; int attr , elem , eval ; xdf = pmalloco ( xd -> p , sizeof ( _xdata_field_st ) ) ; xdf -> p = xd -> p ; attr = nad_find_attr ( nad , root , - 1 , "var" , NULL ) ; if ( attr >= 0 ) { xdf -> var = pstrdupx ( xdf -> p , NAD_AVAL ( nad , attr ) , NAD_AVAL_L ( nad , attr ) ) ; } attr = nad_find_attr ( nad , root , - 1 , "label" , NULL ) ; if ( attr >= 0 ) { xdf -> label = pstrdupx ( xdf -> p , NAD_AVAL ( nad , attr ) , NAD_AVAL_L ( nad , attr ) ) ; } attr = nad_find_attr ( nad , root , - 1 , "desc" , NULL ) ; if ( attr >= 0 ) { xdf -> desc = pstrdupx ( xdf -> p , NAD_AVAL ( nad , attr ) , NAD_AVAL_L ( nad , attr ) ) ; } attr = nad_find_attr ( nad , root , - 1 , "type" , NULL ) ; if ( attr >= 0 ) { if ( NAD_AVAL_L ( nad , attr ) == 7 && strncmp ( "boolean" , NAD_AVAL ( nad , attr ) , 7 ) == 0 ) { xdf -> type = xd_field_BOOLEAN ; } if ( NAD_AVAL_L ( nad , attr ) == 5 && strncmp ( "fixed" , NAD_AVAL ( nad , attr ) , 5 ) == 0 ) { xdf -> type = xd_field_FIXED ; } if ( NAD_AVAL_L ( nad , attr ) == 6 && strncmp ( "hidden" , NAD_AVAL ( nad , attr ) , 6 ) == 0 ) { xdf -> type = xd_field_HIDDEN ; } if ( NAD_AVAL_L ( nad , attr ) == 9 && strncmp ( "jid-multi" , NAD_AVAL ( nad , attr ) , 9 ) == 0 ) { xdf -> type = xd_field_JID_MULTI ; } if ( NAD_AVAL_L ( nad , attr ) == 10 && strncmp ( "jid-single" , NAD_AVAL ( nad , attr ) , 10 ) == 0 ) { xdf -> type = xd_field_JID_SINGLE ; } if ( NAD_AVAL_L ( nad , attr ) == 10 && strncmp ( "list-multi" , NAD_AVAL ( nad , attr ) , 10 ) == 0 ) { xdf -> type = xd_field_LIST_MULTI ; } if ( NAD_AVAL_L ( nad , attr ) == 11 && strncmp ( "list-single" , NAD_AVAL ( nad , attr ) , 11 ) == 0 ) { xdf -> type = xd_field_LIST_SINGLE ; } if ( NAD_AVAL_L ( nad , attr ) == 10 && strncmp ( "text-multi" , NAD_AVAL ( nad , attr ) , 10 ) == 0 ) { xdf -> type = xd_field_TEXT_MULTI ; } if ( NAD_AVAL_L ( nad , attr ) == 12 && strncmp ( "text-private" , NAD_AVAL ( nad , attr ) , 12 ) == 0 ) { xdf -> type = xd_field_TEXT_PRIVATE ; } if ( NAD_AVAL_L ( nad , attr ) == 11 && strncmp ( "text-single" , NAD_AVAL ( nad , attr ) , 11 ) == 0 ) { xdf -> type = xd_field_TEXT_SINGLE ; } else { log_debug ( ZONE , "unknown field type '%.*s'" , NAD_AVAL_L ( nad , attr ) , NAD_AVAL ( nad , attr ) ) ; return NULL ; } } elem = nad_find_elem ( nad , root , NAD_ENS ( nad , root ) , "value" , 1 ) ; while ( elem >= 0 ) { if ( NAD_CDATA_L ( nad , elem ) <= 0 ) { log_debug ( ZONE , "value element requires cdata" ) ; return NULL ; } xdata_add_value ( xdf , NAD_CDATA ( nad , elem ) , NAD_CDATA_L ( nad , elem ) ) ; elem = nad_find_elem ( nad , elem , NAD_ENS ( nad , elem ) , "value" , 0 ) ; } elem = nad_find_elem ( nad , root , NAD_ENS ( nad , root ) , "options" , 1 ) ; while ( elem >= 0 ) { eval = nad_find_elem ( nad , elem , NAD_ENS ( nad , elem ) , "value" , 1 ) ; if ( eval < 0 ) { log_debug ( ZONE , "option requires value subelement" ) ; return NULL ; } if ( NAD_CDATA_L ( nad , eval ) <= 0 ) { log_debug ( ZONE , "value element requires cdata" ) ; return NULL ; } attr = nad_find_attr ( nad , elem , - 1 , "label" , NULL ) ; if ( attr < 0 ) { xdata_option_new ( xdf , NAD_CDATA ( nad , eval ) , NAD_CDATA_L ( nad , eval ) , NAD_AVAL ( nad , eval ) , NAD_AVAL_L ( nad , eval ) ) ; } else { xdata_option_new ( xdf , NAD_CDATA ( nad , eval ) , NAD_CDATA_L ( nad , eval ) , NULL , 0 ) ; } elem = nad_find_elem ( nad , elem , NAD_ENS ( nad , elem ) , "options" , 0 ) ; } return xdf ; } 