int amdgpu_vm_clear_invalids ( struct amdgpu_device * adev , struct amdgpu_vm * vm , struct amdgpu_sync * sync ) { struct amdgpu_bo_va * bo_va = NULL ; int r ; spin_lock ( & vm -> status_lock ) ; while ( ! list_empty ( & vm -> invalidated ) ) { bo_va = list_first_entry ( & vm -> invalidated , amdgpu_bo_va , vm_status ) ; spin_unlock ( & vm -> status_lock ) ; r = amdgpu_vm_bo_update ( adev , bo_va , true ) ; if ( r ) { return r ; } spin_lock ( & vm -> status_lock ) ; } spin_unlock ( & vm -> status_lock ) ; if ( bo_va ) { r = amdgpu_sync_fence ( adev , sync , bo_va -> last_pt_update ) ; } return r ; } 