static void intel_hdmi_prepare ( struct intel_encoder * encoder , const struct intel_crtc_state * crtc_state ) { struct drm_device * dev = encoder -> base . dev ; struct drm_i915_private * dev_priv = to_i915 ( dev ) ; struct intel_crtc * crtc = to_intel_crtc ( crtc_state -> uapi . crtc ) ; struct intel_hdmi * intel_hdmi = enc_to_intel_hdmi ( encoder ) ; const struct drm_display_mode * adjusted_mode = & crtc_state -> hw . adjusted_mode ; u32 hdmi_val ; hdmi_val = SDVO_ENCODING_HDMI ; if ( ! HAS_PCH_SPLIT ( dev_priv ) && crtc_state -> limited_color_range ) { hdmi_val |= HDMI_COLOR_RANGE_16_235 ; } if ( adjusted_mode -> flags & DRM_MODE_FLAG_PVSYNC ) { hdmi_val |= SDVO_VSYNC_ACTIVE_HIGH ; } if ( adjusted_mode -> flags & DRM_MODE_FLAG_PHSYNC ) { hdmi_val |= SDVO_HSYNC_ACTIVE_HIGH ; } if ( crtc_state -> pipe_bpp > 24 ) { hdmi_val |= HDMI_COLOR_FORMAT_12bpc ; } else { hdmi_val |= SDVO_COLOR_FORMAT_8bpc ; } if ( crtc_state -> has_hdmi_sink ) { hdmi_val |= HDMI_MODE_SELECT_HDMI ; } if ( HAS_PCH_CPT ( dev_priv ) ) { hdmi_val |= SDVO_PIPE_SEL_CPT ( crtc -> pipe ) ; } if ( IS_CHERRYVIEW ( dev_priv ) ) { hdmi_val |= SDVO_PIPE_SEL_CHV ( crtc -> pipe ) ; } else { hdmi_val |= SDVO_PIPE_SEL ( crtc -> pipe ) ; } intel_de_write ( dev_priv , intel_hdmi -> hdmi_reg , hdmi_val ) ; intel_de_posting_read ( dev_priv , intel_hdmi -> hdmi_reg ) ; } 