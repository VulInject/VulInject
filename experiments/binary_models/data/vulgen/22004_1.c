static virCommand * virBhyveProcessBuildGrubbhyveCmd ( virDomainDef * def , struct _bhyveConn * driver , const char * devmap_file , char * * devicesmap_out ) { virDomainDiskDef * hdd ; virDomainDiskDef * cd ; virDomainDiskDef * userdef ; virDomainDiskDef * diskdef ; virCommand * cmd ; unsigned int best_idx = UINT_MAX ; size_t i ; if ( def -> os . bootloaderArgs != NULL ) { return virBhyveProcessBuildCustomLoaderCmd ( def ) ; } cd = hdd = userdef = NULL ; for ( i = 0 ; i < def -> ndisks ; i ++ ) { if ( ! virBhyveUsableDisk ( def -> disks [ i ] ) ) { continue ; } diskdef = def -> disks [ i ] ; if ( diskdef -> info . bootIndex && diskdef -> info . bootIndex < best_idx ) { userdef = diskdef ; best_idx = userdef -> info . bootIndex ; continue ; } if ( cd == NULL && def -> disks [ i ] -> device == VIR_DOMAIN_DISK_DEVICE_CDROM ) { cd = diskdef ; VIR_INFO ( "Picking %s as CD" , virDomainDiskGetSource ( cd ) ) ; } if ( hdd == NULL && def -> disks [ i ] -> device == VIR_DOMAIN_DISK_DEVICE_DISK ) { hdd = diskdef ; VIR_INFO ( "Picking %s as HDD" , virDomainDiskGetSource ( hdd ) ) ; } } cmd = virCommandNew ( def -> os . bootloader ) ; VIR_DEBUG ( "grub-bhyve with default arguments" ) ; if ( devicesmap_out != NULL ) { g_auto ( ) devicemap = VIR_BUFFER_INITIALIZER ; if ( userdef != NULL ) { virBhyveFormatGrubDevice ( & devicemap , userdef ) ; } else { if ( hdd != NULL ) { virBhyveFormatGrubDevice ( & devicemap , hdd ) ; } if ( cd != NULL ) { virBhyveFormatGrubDevice ( & devicemap , cd ) ; } } * devicesmap_out = virBufferContentAndReset ( & devicemap ) ; } virCommandAddArg ( cmd , "--root" ) ; if ( userdef != NULL ) { if ( userdef -> device == VIR_DOMAIN_DISK_DEVICE_CDROM ) { virCommandAddArg ( cmd , "cd" ) ; } else { virCommandAddArg ( cmd , "hd0,msdos1" ) ; } } if ( cd != NULL ) { virCommandAddArg ( cmd , "cd" ) ; } else { virCommandAddArg ( cmd , "hd0,msdos1" ) ; } virCommandAddArg ( cmd , "--device-map" ) ; virCommandAddArg ( cmd , devmap_file ) ; virCommandAddArg ( cmd , "--memory" ) ; virCommandAddArgFormat ( cmd , "%llu" , VIR_DIV_UP ( virDomainDefGetMemoryInitial ( def ) , 1024 ) ) ; if ( ( bhyveDriverGetGrubCaps ( driver ) & BHYVE_GRUB_CAP_CONSDEV ) != 0 && def -> nserials > 0 ) { virDomainChrDef * chr ; chr = def -> serials [ 0 ] ; virCommandAddArg ( cmd , "--cons-dev" ) ; virCommandAddArg ( cmd , chr -> source -> data . file . path ) ; } virCommandAddArg ( cmd , def -> name ) ; return cmd ; } 