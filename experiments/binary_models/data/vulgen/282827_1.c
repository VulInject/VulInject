static int vidioc_reqbufs ( struct file * file , void * priv , struct v4l2_requestbuffers * reqbufs ) { struct s5p_mfc_dev * dev = video_drvdata ( file ) ; struct s5p_mfc_ctx * ctx = fh_to_ctx ( priv ) ; int ret = 0 ; if ( ( reqbufs -> memory != V4L2_MEMORY_MMAP ) && ( reqbufs -> memory != V4L2_MEMORY_USERPTR ) ) { return - EINVAL ; } if ( reqbufs -> type == V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE ) { if ( reqbufs -> count == 0 ) { mfc_debug ( 2 , "Freeing buffers\n" ) ; ret = vb2_reqbufs ( & ctx -> vq_dst , reqbufs ) ; s5p_mfc_hw_call ( dev -> mfc_ops , release_codec_buffers , ctx ) ; ctx -> capture_state = QUEUE_FREE ; return ret ; } if ( ctx -> capture_state != QUEUE_FREE ) { mfc_err ( "invalid capture state: %d\n" , ctx -> capture_state ) ; return - EINVAL ; } ret = vb2_reqbufs ( & ctx -> vq_dst , reqbufs ) ; if ( ret != 0 ) { mfc_err ( "error in vb2_reqbufs() for E(D)\n" ) ; return ret ; } ctx -> capture_state = QUEUE_BUFS_REQUESTED ; ret = s5p_mfc_hw_call ( ctx -> dev -> mfc_ops , alloc_codec_buffers , ctx ) ; if ( ret ) { mfc_err ( "Failed to allocate encoding buffers\n" ) ; reqbufs -> count = 0 ; ret = vb2_reqbufs ( & ctx -> vq_dst , reqbufs ) ; return - ENOMEM ; } } if ( reqbufs -> type == V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE ) { if ( reqbufs -> count == 0 ) { mfc_debug ( 2 , "Freeing buffers\n" ) ; ret = vb2_reqbufs ( & ctx -> vq_src , reqbufs ) ; s5p_mfc_hw_call ( dev -> mfc_ops , release_codec_buffers , ctx ) ; ctx -> output_state = QUEUE_FREE ; return ret ; } if ( ctx -> output_state != QUEUE_FREE ) { mfc_err ( "invalid output state: %d\n" , ctx -> output_state ) ; return - EINVAL ; } if ( IS_MFCV6_PLUS ( dev ) ) { if ( ctx -> pb_count && ( reqbufs -> count < ctx -> pb_count ) ) { reqbufs -> count = ctx -> pb_count ; mfc_debug ( 2 , "Minimum %d output buffers needed\n" , ctx -> pb_count ) ; } else { ctx -> pb_count = reqbufs -> count ; } } ret = vb2_reqbufs ( & ctx -> vq_src , reqbufs ) ; ctx -> output_state = QUEUE_BUFS_REQUESTED ; } else { mfc_err ( "invalid buf type\n" ) ; return - EINVAL ; } return ret ; } 