static void deepen ( struct upload_pack_data * data , int depth ) { if ( depth == INFINITE_DEPTH && ! is_repository_shallow ( the_repository ) ) { int i ; for ( i = 0 ; i < data -> shallows . nr ; i ++ ) { struct object * object = data -> shallows . objects [ i ] . item ; object -> flags |= NOT_SHALLOW ; } } if ( data -> deepen_relative ) { struct object_array reachable_shallows = OBJECT_ARRAY_INIT ; struct commit_list * result ; head_ref_namespaced ( check_ref , data ) ; for_each_namespaced_ref ( check_ref , data ) ; get_reachable_list ( data , & reachable_shallows ) ; result = get_shallow_commits ( & reachable_shallows , depth + 1 , SHALLOW , NOT_SHALLOW ) ; send_shallow ( data , result ) ; object_array_clear ( & reachable_shallows ) ; } else { struct commit_list * result ; result = get_shallow_commits ( & data -> want_obj , depth , SHALLOW , NOT_SHALLOW ) ; send_shallow ( data , result ) ; free_commit_list ( result ) ; } send_unshallow ( data ) ; } 