static void sprd_complete_tx_dma ( void * data ) { struct uart_port * port = ( uart_port * ) data ; struct sprd_uart_port * sp = container_of ( port , sprd_uart_port , port ) ; struct circ_buf * xmit = & port -> state -> xmit ; unsigned long flags ; spin_lock_irqsave ( & port -> lock , flags ) ; dma_unmap_single ( port -> dev , sp -> tx_dma . phys_addr , sp -> tx_dma . trans_len , DMA_TO_DEVICE ) ; uart_xmit_advance ( port , sp -> tx_dma . trans_len ) ; if ( uart_circ_empty ( xmit ) || sprd_tx_buf_remap ( port ) || sprd_tx_dma_config ( port ) ) { sp -> tx_dma . trans_len = 0 ; } spin_unlock_irqrestore ( & port -> lock , flags ) ; } 