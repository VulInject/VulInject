"C" extern int munmap ( char * addr , int len ) FT_CALLBACK_DEF ( ) ft_alloc ( , ) { FT_UNUSED ( memory ) ; return malloc ( size ) ; } FT_CALLBACK_DEF ( ) ft_realloc ( , , , ) { FT_UNUSED ( memory ) ; FT_UNUSED ( cur_size ) ; return realloc ( block , new_size ) ; } FT_CALLBACK_DEF ( ) ft_free ( , ) { FT_UNUSED ( memory ) ; free ( block ) ; } FT_CALLBACK_DEF ( ) ft_close_stream ( ) { munmap ( ( MUNMAP_ARG_CAST ) stream -> descriptor . pointer , stream -> size ) ; stream -> descriptor . pointer = NULL ; stream -> size = 0 ; stream -> base = NULL ; } FT_BASE_DEF ( ) FT_Stream_Open ( , ) { int file ; struct stat stat_buf ; if ( ! stream ) { return FT_THROW ( Invalid_Stream_Handle ) ; } file = open ( filepathname , O_RDONLY ) ; if ( file < 0 ) { FT_ERROR ( ( "FT_Stream_Open:" ) ) ; FT_ERROR ( ( " could not open `%s'\n" , filepathname ) ) ; return FT_THROW ( Cannot_Open_Resource ) ; } if ( fstat ( file , & stat_buf ) < 0 ) { FT_ERROR ( ( "FT_Stream_Open:" ) ) ; FT_ERROR ( ( " could not `fstat' file `%s'\n" , filepathname ) ) ; Fail_Map } stream -> size = stat_buf . st_size ; if ( ! stream -> size ) { FT_ERROR ( ( "FT_Stream_Open:" ) ) ; FT_ERROR ( ( " opened `%s' but zero-sized\n" , filepathname ) ) ; Fail_Map } stream -> pos = 0 ; stream -> base = ( unsigned char * ) mmap ( NULL , stream -> size , PROT_READ , MAP_FILE | MAP_PRIVATE , file , 0 ) ; close ( file ) ; stream -> descriptor . pointer = stream -> base ; stream -> pathname . pointer = ( char * ) filepathname ; stream -> close = ft_close_stream ; stream -> read = NULL ; FT_TRACE1 ( ( "FT_Stream_Open:" ) ) ; FT_TRACE1 ( ( " opened `%s' (%d bytes) successfully\n" , filepathname , stream -> size ) ) ; return FT_Err_Ok ; Fail_Map close ( file ) ; stream -> base = NULL ; stream -> size = 0 ; stream -> pos = 0 ; return FT_THROW ( Cannot_Open_Stream ) ; } extern FT_Int ft_mem_debug_init ( FT_Memory memory ) extern void ft_mem_debug_done ( FT_Memory memory ) FT_BASE_DEF ( ) FT_New_Memory ( ) { FT_Memory memory ; memory = ( FT_Memory ) malloc ( sizeof ( * memory ) ) ; if ( memory ) { memory -> user = NULL ; memory -> alloc = ft_alloc ; memory -> realloc = ft_realloc ; memory -> free = ft_free ; } } 