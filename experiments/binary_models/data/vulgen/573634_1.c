static int max3421_probe ( struct spi_device * spi ) { struct max3421_hcd * max3421_hcd ; struct usb_hcd * hcd = NULL ; int retval = - ENOMEM ; if ( spi_setup ( spi ) < 0 ) { dev_err ( & spi -> dev , "Unable to setup SPI bus" ) ; return - EFAULT ; } hcd = usb_create_hcd ( & max3421_hcd_desc , & spi -> dev , dev_name ( & spi -> dev ) ) ; if ( ! hcd ) { dev_err ( & spi -> dev , "failed to create HCD structure\n" ) ; error } set_bit ( HCD_FLAG_POLL_RH , & hcd -> flags ) ; max3421_hcd = hcd_to_max3421 ( hcd ) ; max3421_hcd -> next = max3421_hcd_list ; max3421_hcd_list = max3421_hcd ; INIT_LIST_HEAD ( & max3421_hcd -> ep_list ) ; max3421_hcd -> tx = kmalloc ( sizeof ( * max3421_hcd -> tx ) , GFP_KERNEL ) ; if ( ! max3421_hcd -> tx ) { error } max3421_hcd -> rx = kmalloc ( sizeof ( * max3421_hcd -> rx ) , GFP_KERNEL ) ; if ( ! max3421_hcd -> rx ) { error } if ( max3421_hcd -> spi_thread == ERR_PTR ( - ENOMEM ) ) { dev_err ( & spi -> dev , "failed to create SPI thread (out of memory)\n" ) ; error } retval = usb_add_hcd ( hcd , 0 , 0 ) ; if ( retval ) { dev_err ( & spi -> dev , "failed to add HCD\n" ) ; error } retval = request_irq ( spi -> irq , max3421_irq_handler , IRQF_TRIGGER_LOW , "max3421" , hcd ) ; if ( retval < 0 ) { dev_err ( & spi -> dev , "failed to request irq %d\n" , spi -> irq ) ; error } return 0 ; error if ( hcd ) { kfree ( max3421_hcd -> tx ) ; kfree ( max3421_hcd -> rx ) ; if ( max3421_hcd -> spi_thread ) { kthread_stop ( max3421_hcd -> spi_thread ) ; } usb_put_hcd ( hcd ) ; } return retval ; } 