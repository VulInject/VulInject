STATIC int xfs_dquot_disk_alloc ( struct xfs_dquot * dqp , struct xfs_buf * * bpp ) { struct xfs_bmbt_irec map ; struct xfs_trans * tp ; struct xfs_mount * mp = dqp -> q_mount ; struct xfs_buf * bp ; xfs_dqtype_t qtype = xfs_dquot_type ( dqp ) ; struct xfs_inode * quotip = xfs_quota_inode ( mp , qtype ) ; int nmaps = 1 ; int error ; trace_xfs_dqalloc ( dqp ) ; error = xfs_trans_alloc ( mp , & M_RES ( mp ) -> tr_qm_dqalloc , XFS_QM_DQALLOC_SPACE_RES ( mp ) , 0 , 0 , & tp ) ; if ( error ) { return error ; } xfs_ilock ( quotip , XFS_ILOCK_EXCL ) ; xfs_trans_ijoin ( tp , quotip , 0 ) ; if ( ! xfs_this_quota_on ( dqp -> q_mount , qtype ) ) { error = - ESRCH ; err_cancel } error = xfs_iext_count_may_overflow ( quotip , XFS_DATA_FORK , XFS_IEXT_ADD_NOSPLIT_CNT ) ; if ( error == - EFBIG ) { error = xfs_iext_count_upgrade ( tp , quotip , XFS_IEXT_ADD_NOSPLIT_CNT ) ; } if ( error ) { err_cancel } error = xfs_bmapi_write ( tp , quotip , dqp -> q_fileoffset , XFS_DQUOT_CLUSTER_SIZE_FSB , XFS_BMAPI_METADATA , 0 , & map , & nmaps ) ; if ( error ) { err_cancel } ASSERT ( map . br_blockcount == XFS_DQUOT_CLUSTER_SIZE_FSB ) ; ASSERT ( nmaps == 1 ) ; ASSERT ( ( map . br_startblock != DELAYSTARTBLOCK ) && ( map . br_startblock != HOLESTARTBLOCK ) ) ; dqp -> q_blkno = XFS_FSB_TO_DADDR ( mp , map . br_startblock ) ; error = xfs_trans_get_buf ( tp , mp -> m_ddev_targp , dqp -> q_blkno , mp -> m_quotainfo -> qi_dqchunklen , 0 , & bp ) ; if ( error ) { err_cancel } bp -> b_ops = & xfs_dquot_buf_ops ; xfs_qm_init_dquot_blk ( tp , mp , dqp -> q_id , qtype , bp ) ; xfs_buf_set_ref ( bp , XFS_DQUOT_REF ) ; xfs_trans_bhold ( tp , bp ) ; error = xfs_trans_commit ( tp ) ; if ( error ) { xfs_buf_relse ( bp ) ; return error ; } * bpp = bp ; return 0 ; err_cancel xfs_trans_cancel ( tp ) ; xfs_iunlock ( quotip , XFS_ILOCK_EXCL ) ; return error ; } 