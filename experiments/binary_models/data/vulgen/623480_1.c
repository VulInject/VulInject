static int arm_trbe_device_probe ( struct platform_device * pdev ) { struct coresight_platform_data * pdata ; struct trbe_drvdata * drvdata ; struct device * dev = & pdev -> dev ; int ret ; if ( arm64_kernel_unmapped_at_el0 ( ) ) { pr_err ( "TRBE wouldn't work if kernel gets unmapped at EL0\n" ) ; return - EOPNOTSUPP ; } drvdata = devm_kzalloc ( dev , sizeof ( * drvdata ) , GFP_KERNEL ) ; if ( ! drvdata ) { return - ENOMEM ; } pdata = coresight_get_platform_data ( dev ) ; if ( IS_ERR ( pdata ) ) { return PTR_ERR ( pdata ) ; } dev_set_drvdata ( dev , drvdata ) ; dev -> platform_data = pdata ; ret = arm_trbe_probe_irq ( pdev , drvdata ) ; if ( ret ) { return ret ; } ret = arm_trbe_probe_coresight ( drvdata ) ; if ( ret ) { probe_failed } ret = arm_trbe_probe_cpuhp ( drvdata ) ; if ( ret ) { cpuhp_failed } return 0 ; cpuhp_failed arm_trbe_remove_coresight ( drvdata ) ; probe_failed arm_trbe_remove_irq ( drvdata ) ; return ret ; } 