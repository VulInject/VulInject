static void CloseSock ( SOCKET_t ) int fe_net_init ( int port , NetError * err , void * Callback ( NetConnection * ) ) { struct sockaddr_in6 addr ; int opt ; int rc = NET_OK ; WORD wVersionRequested ; WSADATA wsaData ; IB_ENTER ( __func__ , port , 0 , 0 , 0 ) ; if ( G_initted_ ) { IB_EXIT ( __func__ , err ) ; return ( NET_OK ) ; } wVersionRequested = MAKEWORD ( 2 , 0 ) ; if ( WSAStartup ( wVersionRequested , & wsaData ) ) { SET_ERROR ( err , NET_INTERNAL_ERR ) ; IB_LOG_ERROR ( "init error err:" , err ) ; fprintf ( stderr , "fe_net_init error%d\n" , ( int ) * err ) ; IB_EXIT ( __func__ , err ) ; return ( NET_FAILED ) ; } if ( Callback ) { DisconnectCallBack = Callback ; } else { DisconnectCallBack = NULL ; } if ( port ) { G_listenSock_ = SOCKET ( AF_INET6 , SOCK_STREAM , 0 ) ; if ( G_listenSock_ == INVALID_SOCKET ) { SET_ERROR ( err , NET_INTERNAL_ERR ) ; IB_LOG_ERROR ( "init error err:" , ( int ) * err ) ; fprintf ( stderr , "fe_net_init error%d\n" , ( int ) * err ) ; IB_EXIT ( __func__ , err ) ; return ( NET_FAILED ) ; } opt = 1 ; if ( setsockopt ( G_listenSock_ , SOL_SOCKET , SO_REUSEADDR , ( char * ) & opt , sizeof ( int ) ) ) { SET_ERROR ( err , NET_INTERNAL_ERR ) ; CloseSock ( G_listenSock_ ) ; G_listenSock_ = INVALID_SOCKET ; IB_LOG_ERROR ( "setsockopt error err:" , ( int ) * err ) ; fprintf ( stderr , "fe_net_init setsockopt error%d\n" , ( int ) * err ) ; IB_EXIT ( __func__ , err ) ; return ( NET_FAILED ) ; } addr . sin6_family = AF_INET6 ; addr . sin6_flowinfo = 0 ; addr . sin6_port = htons ( ( short ) port ) ; addr . sin6_addr = in6addr_any ; if ( BIND ( G_listenSock_ , ( sockaddr * ) & addr , sizeof ( addr ) ) ) { SET_ERROR ( err , NET_INTERNAL_ERR ) ; CloseSock ( G_listenSock_ ) ; G_listenSock_ = INVALID_SOCKET ; IB_LOG_ERROR ( "error binding socket err:" , ( int ) * err ) ; fprintf ( stderr , "\nNetInit error binding socket %d\n" , ( int ) * err ) ; IB_EXIT ( __func__ , err ) ; return ( NET_FAILED ) ; } if ( LISTEN ( G_listenSock_ , CONNECTION_BACKLOG ) ) { SET_ERROR ( err , NET_INTERNAL_ERR ) ; CloseSock ( G_listenSock_ ) ; G_listenSock_ = INVALID_SOCKET ; fprintf ( stderr , "\nNetInit error listening on socket %d\n" , ( int ) * err ) ; IB_LOG_ERROR ( "error listening on socket err:" , ( int ) * err ) ; IB_EXIT ( __func__ , err ) ; return ( NET_FAILED ) ; } if ( fe_config . SslSecurityEnabled ) { if ( ! fe_is_thread ( ) ) { if ( if3_ssl_init ( NULL ) ) { SET_ERROR ( err , NET_INTERNAL_ERR ) ; CloseSock ( G_listenSock_ ) ; G_listenSock_ = INVALID_SOCKET ; fprintf ( stderr , "\nfe_net_init error setting SSL/TLS on socket %d\n" , ( int ) * err ) ; IB_LOG_ERROR ( "error setting SSL/TLS on socket err:" , ( int ) * err ) ; IB_EXIT ( __func__ , err ) ; return ( NET_FAILED ) ; } } if ( ! ( G_sslContext_ = if3_ssl_srvr_open ( fe_config . SslSecurityDir , fe_config . SslSecurityFmCertificate , fe_config . SslSecurityFmPrivateKey , fe_config . SslSecurityFmCaCertificate , fe_config . SslSecurityFmCertChainDepth , fe_config . SslSecurityFmDHParameters , fe_config . SslSecurityFmCaCRLEnabled , fe_config . SslSecurityFmCaCRL ) ) ) { SET_ERROR ( err , NET_INTERNAL_ERR ) ; CloseSock ( G_listenSock_ ) ; G_listenSock_ = INVALID_SOCKET ; fprintf ( stderr , "\nfe_net_init error getting SSL/TLS context on socket %d\n" , ( int ) * err ) ; IB_LOG_ERROR ( "error getting SSL/TLS context on socket err:" , ( int ) * err ) ; IB_EXIT ( __func__ , err ) ; return ( NET_FAILED ) ; } } } else { G_listenSock_ = INVALID_SOCKET ; } G_numConnections_ = 0 ; G_connections_ = NULL ; G_initted_ = 1 ; IB_LOG_VERBOSE0 ( "Net initialized" ) ; IB_EXIT ( __func__ , err ) ; return rc ; } 