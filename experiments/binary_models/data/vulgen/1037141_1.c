int __init of_parse_thermal_zones ( void ) { struct device_node * np , * child ; struct __thermal_zone * tz ; struct thermal_zone_device_ops * ops ; np = of_find_node_by_name ( NULL , "thermal-zones" ) ; if ( ! np ) { pr_debug ( "unable to find thermal zones\n" ) ; return 0 ; } for_each_available_child_of_node ( , ) { struct thermal_zone_device * zone ; struct thermal_zone_params * tzp ; int i , mask = 0 ; u32 prop ; tz = thermal_of_build_thermal_zone ( child ) ; if ( IS_ERR ( tz ) ) { pr_err ( "failed to build thermal zone %s: %ld\n" , child -> name , PTR_ERR ( tz ) ) ; continue ; } ops = kmemdup ( & of_thermal_ops , sizeof ( * ops ) , GFP_KERNEL ) ; if ( ! ops ) { exit_free } tzp = kzalloc ( sizeof ( * tzp ) , GFP_KERNEL ) ; if ( ! tzp ) { exit_free } tzp -> no_hwmon = true ; if ( ! of_property_read_u32 ( child , "sustainable-power" , & prop ) ) { tzp -> sustainable_power = prop ; } for ( i = 0 ; i < tz -> ntrips ; i ++ ) { mask |= 1 << i ; } tzp -> slope = tz -> slope ; tzp -> offset = tz -> offset ; zone = thermal_zone_device_register ( child -> name , tz -> ntrips , mask , tz , ops , tzp , tz -> passive_delay , tz -> polling_delay ) ; if ( IS_ERR ( zone ) ) { pr_err ( "Failed to build %s zone %ld\n" , child -> name , PTR_ERR ( zone ) ) ; kfree ( tzp ) ; kfree ( ops ) ; of_thermal_free_zone ( tz ) ; } } of_node_put ( np ) ; return 0 ; exit_free of_node_put ( child ) ; of_node_put ( np ) ; of_thermal_free_zone ( tz ) ; of_thermal_destroy_zones ( ) ; return - ENOMEM ; } 