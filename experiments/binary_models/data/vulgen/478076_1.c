int ippr_ftp_process ( fin , nat , ftp , rv , ifsftp ) fr_info_t * fin ; nat_t * nat ; ftpinfo_t * ftp ; int rv ; ifs_ftppxy_t * ifsftp ; { int mlen , len , off , inc , i , sel , sel2 , ok , ackoff , seqoff ; char * rptr , * wptr , * s ; u_32_t thseq , thack ; ap_session_t * aps ; ftpside_t * f , * t ; tcphdr_t * tcp ; ip_t * ip ; mb_t * m ; m = fin -> fin_m ; ip = fin -> fin_ip ; tcp = ( tcphdr_t * ) fin -> fin_dp ; off = ( char * ) tcp - ( char * ) ip + ( TCP_OFF ( tcp ) << 2 ) + fin -> fin_ipoff ; f = & ftp -> ftp_side [ rv ] ; t = & ftp -> ftp_side [ 1 - rv ] ; thseq = ntohl ( tcp -> th_seq ) ; thack = ntohl ( tcp -> th_ack ) ; mlen = fin -> fin_plen - off ; mlen = MSGDSIZE ( m ) - off ; if ( ifsftp -> ippr_ftp_debug > 4 ) { printf ( "ippr_ftp_process: mlen %d\n" , mlen ) ; } if ( mlen <= 0 ) { if ( ( tcp -> th_flags & TH_OPENING ) == TH_OPENING ) { f -> ftps_seq [ 0 ] = thseq + 1 ; t -> ftps_seq [ 0 ] = thack ; } return 0 ; } aps = nat -> nat_aps ; sel = aps -> aps_sel [ 1 - rv ] ; sel2 = aps -> aps_sel [ rv ] ; if ( rv == 0 ) { seqoff = aps -> aps_seqoff [ sel ] ; if ( aps -> aps_seqmin [ sel ] > seqoff + thseq ) { seqoff = aps -> aps_seqoff [ ! sel ] ; } ackoff = aps -> aps_ackoff [ sel2 ] ; if ( aps -> aps_ackmin [ sel2 ] > ackoff + thack ) { ackoff = aps -> aps_ackoff [ ! sel2 ] ; } } else { seqoff = aps -> aps_ackoff [ sel ] ; if ( ifsftp -> ippr_ftp_debug > 2 ) { printf ( "seqoff %d thseq %x ackmin %x\n" , seqoff , thseq , aps -> aps_ackmin [ sel ] ) ; } if ( aps -> aps_ackmin [ sel ] > seqoff + thseq ) { seqoff = aps -> aps_ackoff [ ! sel ] ; } ackoff = aps -> aps_seqoff [ sel2 ] ; if ( ifsftp -> ippr_ftp_debug > 2 ) { printf ( "ackoff %d thack %x seqmin %x\n" , ackoff , thack , aps -> aps_seqmin [ sel2 ] ) ; } if ( ackoff > 0 ) { if ( aps -> aps_seqmin [ sel2 ] > ackoff + thack ) { ackoff = aps -> aps_seqoff [ ! sel2 ] ; } } else { if ( aps -> aps_seqmin [ sel2 ] > thack ) { ackoff = aps -> aps_seqoff [ ! sel2 ] ; } } } if ( ifsftp -> ippr_ftp_debug > 2 ) { printf ( "%s: %x seq %x/%d ack %x/%d len %d/%d off %d\n" , rv ?"IN" : "OUT" , tcp -> th_flags , thseq , seqoff , thack , ackoff , mlen , fin -> fin_plen , off ) ; printf ( "sel %d seqmin %x/%x offset %d/%d\n" , sel , aps -> aps_seqmin [ sel ] , aps -> aps_seqmin [ sel2 ] , aps -> aps_seqoff [ sel ] , aps -> aps_seqoff [ sel2 ] ) ; printf ( "sel %d ackmin %x/%x offset %d/%d\n" , sel2 , aps -> aps_ackmin [ sel ] , aps -> aps_ackmin [ sel2 ] , aps -> aps_ackoff [ sel ] , aps -> aps_ackoff [ sel2 ] ) ; } if ( ifsftp -> ippr_ftp_debug > 2 ) { printf ( "rv %d t:seq[0] %x seq[1]%x %d/%d\n" , rv , t -> ftps_seq [ 0 ] , t -> ftps_seq [ 1 ] , seqoff , ackoff ) ; } ok = 0 ; if ( t -> ftps_seq [ 0 ] == 0 ) { t -> ftps_seq [ 0 ] = thack ; ok = 1 ; } else { if ( ackoff == 0 ) { if ( t -> ftps_seq [ 0 ] == thack ) { ok = 1 ; } if ( t -> ftps_seq [ 1 ] == thack ) { t -> ftps_seq [ 0 ] = thack ; ok = 1 ; } } else { if ( t -> ftps_seq [ 0 ] + ackoff == thack ) { ok = 1 ; } if ( t -> ftps_seq [ 0 ] == thack + ackoff ) { ok = 1 ; } if ( t -> ftps_seq [ 1 ] + ackoff == thack ) { t -> ftps_seq [ 0 ] = thack - ackoff ; ok = 1 ; } if ( t -> ftps_seq [ 1 ] == thack + ackoff ) { t -> ftps_seq [ 0 ] = thack - ackoff ; ok = 1 ; } } } if ( ifsftp -> ippr_ftp_debug > 2 ) { if ( ! ok ) { printf ( "%s ok\n" , "not" ) ; } } if ( ! mlen ) { if ( t -> ftps_seq [ 0 ] + ackoff != thack ) { if ( ifsftp -> ippr_ftp_debug > 1 ) { printf ( "%s:seq[0](%x) + (%x) != (%x)\n" , "ippr_ftp_process" , t -> ftps_seq [ 0 ] , ackoff , thack ) ; } return APR_ERR ( 1 ) ; } if ( ifsftp -> ippr_ftp_debug > 2 ) { printf ( "ippr_ftp_process:f:seq[0] %x seq[1]%x\n" , f -> ftps_seq [ 0 ] , f -> ftps_seq [ 1 ] ) ; } if ( tcp -> th_flags & TH_FIN ) { if ( thseq == f -> ftps_seq [ 1 ] ) { f -> ftps_seq [ 0 ] = f -> ftps_seq [ 1 ] - seqoff ; f -> ftps_seq [ 1 ] = thseq + 1 - seqoff ; } else { if ( ifsftp -> ippr_ftp_debug > 1 ) { printf ( "FIN: thseq %x seqoff %d ftps_seq %x\n" , thseq , seqoff , f -> ftps_seq [ 0 ] ) ; } return APR_ERR ( 1 ) ; } } f -> ftps_len = 0 ; return 0 ; } ok = 0 ; if ( ( thseq == f -> ftps_seq [ 0 ] ) || ( thseq == f -> ftps_seq [ 1 ] ) ) { ok = 1 ; } if ( ( thseq + mlen == f -> ftps_seq [ 0 ] ) || ( thseq + mlen == f -> ftps_seq [ 1 ] ) ) { ok = 1 ; } if ( ok == 0 ) { inc = thseq - f -> ftps_seq [ 0 ] ; if ( ifsftp -> ippr_ftp_debug > 1 ) { printf ( "inc %d sel %d rv %d\n" , inc , sel , rv ) ; printf ( "th_seq %x ftps_seq %x/%x\n" , thseq , f -> ftps_seq [ 0 ] , f -> ftps_seq [ 1 ] ) ; printf ( "ackmin %x ackoff %d\n" , aps -> aps_ackmin [ sel ] , aps -> aps_ackoff [ sel ] ) ; printf ( "seqmin %x seqoff %d\n" , aps -> aps_seqmin [ sel ] , aps -> aps_seqoff [ sel ] ) ; } return APR_ERR ( 1 ) ; } inc = 0 ; rptr = f -> ftps_rptr ; wptr = f -> ftps_wptr ; f -> ftps_seq [ 0 ] = thseq ; f -> ftps_seq [ 1 ] = f -> ftps_seq [ 0 ] + mlen ; f -> ftps_len = mlen ; while ( mlen > 0 ) { len = MIN ( mlen , sizeof ( f -> ftps_buf ) - ( wptr - rptr ) ) ; COPYDATA ( m , off , len , wptr ) ; mlen -= len ; off += len ; wptr += len ; if ( ifsftp -> ippr_ftp_debug > 3 ) { printf ( "%s:len %d/%d off %d wptr %lx junk %d [%*s]\n" , "ippr_ftp_process" , len , mlen , off , ( u_long ) wptr , f -> ftps_junk , len , rptr ) ; } f -> ftps_wptr = wptr ; if ( f -> ftps_junk != 0 ) { i = f -> ftps_junk ; f -> ftps_junk = ippr_ftp_valid ( ftp , rv , rptr , wptr - rptr , ifsftp ) ; if ( ifsftp -> ippr_ftp_debug > 5 ) { printf ( "%s:junk %d ->%d\n" , "ippr_ftp_process" , i , f -> ftps_junk ) ; } if ( f -> ftps_junk != 0 ) { if ( wptr - rptr == sizeof ( f -> ftps_buf ) ) { if ( ifsftp -> ippr_ftp_debug > 4 ) { printf ( "%s:full buffer\n" , "ippr_ftp_process" ) ; } f -> ftps_rptr = f -> ftps_buf ; f -> ftps_wptr = f -> ftps_buf ; rptr = f -> ftps_rptr ; wptr = f -> ftps_wptr ; f -> ftps_junk = 1 ; continue ; } } } while ( ( f -> ftps_junk == 0 ) && ( wptr > rptr ) ) { len = wptr - rptr ; f -> ftps_junk = ippr_ftp_valid ( ftp , rv , rptr , len , ifsftp ) ; if ( ifsftp -> ippr_ftp_debug > 3 ) { printf ( "%s=%d len %d rv %d ptr %lx/%lx " , "ippr_ftp_valid" , f -> ftps_junk , len , rv , ( u_long ) rptr , ( u_long ) wptr ) ; printf ( "buf [%*s]\n" , len , rptr ) ; } if ( f -> ftps_junk == 0 ) { f -> ftps_rptr = rptr ; if ( rv ) { inc += ippr_ftp_server ( fin , ip , nat , ftp , len , ifsftp ) ; } else { inc += ippr_ftp_client ( fin , ip , nat , ftp , len , ifsftp ) ; } rptr = f -> ftps_rptr ; wptr = f -> ftps_wptr ; } } if ( ( f -> ftps_cmds == 0 ) && ( f -> ftps_junk == 1 ) ) { if ( ifsftp -> ippr_ftp_debug > 1 ) { printf ( "%s:cmds == 0 junk == 1\n" , "ippr_ftp_process" ) ; } return APR_ERR ( 2 ) ; } if ( ( f -> ftps_junk != 0 ) && ( rptr < wptr ) ) { for ( s = rptr ; s < wptr ; s ++ ) { if ( ( * s == '\r' ) && ( s + 1 < wptr ) && ( * ( s + 1 ) == '\n' ) ) { rptr = s + 2 ; f -> ftps_junk = 0 ; break ; } } } if ( rptr == wptr ) { rptr = wptr = f -> ftps_buf ; } else { if ( rptr > f -> ftps_buf ) { bcopy ( rptr , f -> ftps_buf , len ) ; wptr -= rptr - f -> ftps_buf ; rptr = f -> ftps_buf ; } } f -> ftps_rptr = rptr ; f -> ftps_wptr = wptr ; } if ( tcp -> th_flags & TH_FIN ) { f -> ftps_seq [ 1 ] ++ ; } f -> ftps_rptr = rptr ; f -> ftps_wptr = wptr ; return APR_INC ( inc ) ; } 