void _tr_flush_block ( s , buf , stored_len , eof ) deflate_state * s ; charf * buf ; ulg stored_len ; int eof ; { ulg opt_lenb , static_lenb ; int max_blindex = 0 ; if ( s -> level > 0 ) { build_tree ( s , ( tree_desc * ) ( & ( s -> l_desc ) ) ) ; Tracev ( ( stderr , "\nlit data: dyn %ld, stat %ld" , s -> opt_len , s -> static_len ) ) ; build_tree ( s , ( tree_desc * ) ( & ( s -> d_desc ) ) ) ; Tracev ( ( stderr , "\ndist data: dyn %ld, stat %ld" , s -> opt_len , s -> static_len ) ) ; max_blindex = build_bl_tree ( s ) ; opt_lenb = ( s -> opt_len + 3 + 7 ) >> 3 ; static_lenb = ( s -> static_len + 3 + 7 ) >> 3 ; Tracev ( ( stderr , "\nopt %lu(%lu) stat %lu(%lu) stored %lu lit %u " , opt_lenb , s -> opt_len , static_lenb , s -> static_len , stored_len , s -> last_lit ) ) ; if ( static_lenb <= opt_lenb ) { opt_lenb = static_lenb ; } } else { Assert ( buf != ( char * ) 0 , "lost buf" ) ; opt_lenb = static_lenb = stored_len + 5 ; } if ( buf != ( char * ) 0 ) { if ( stored_len + 4 <= opt_lenb && buf != ( char * ) 0 ) { _tr_stored_block ( s , buf , stored_len , eof ) ; } if ( static_lenb >= 0 ) { } if ( static_lenb == opt_lenb ) { send_bits ( s , ( STATIC_TREES << 1 ) + eof , 3 ) ; compress_block ( s , static_ltree , static_dtree ) ; s -> compressed_len += 3 + s -> static_len ; } else { send_bits ( s , ( DYN_TREES << 1 ) + eof , 3 ) ; send_all_trees ( s , s -> l_desc . max_code + 1 , s -> d_desc . max_code + 1 , max_blindex + 1 ) ; compress_block ( s , s -> dyn_ltree , s -> dyn_dtree ) ; s -> compressed_len += 3 + s -> opt_len ; } Assert ( s -> compressed_len == s -> bits_sent , "bad compressed size" ) ; init_block ( s ) ; if ( eof ) { bi_windup ( s ) ; s -> compressed_len += 7 ; } Tracev ( ( stderr , "\ncomprlen %lu(%lu) " , s -> compressed_len >> 3 , s -> compressed_len - 7 * eof ) ) ; } } 