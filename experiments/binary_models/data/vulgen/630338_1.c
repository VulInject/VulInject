int createdelete_virtual ( int createdelete , char * virtname ) { int vifnum ; struct sadb_ext * extensions [ K_SADB_EXT_MAX + 1 ] ; struct sadb_msg * pfkey_msg ; int error ; int io_error , pfkey_sock ; if ( sscanf ( virtname , "ipsec%d" , & vifnum ) == 1 ) { vifnum += IPSECDEV_OFFSET ; } else { return 5 ; } pfkey_extensions_init ( extensions ) ; if ( ( error = pfkey_msg_hdr_build ( & extensions [ 0 ] , createdelete , 0 , 0 , ++ pfkey_seq , getpid ( ) ) ) ) { fprintf ( stderr , "%s: Trouble building message header, error=%d.\n" , progname , error ) ; pfkey_extensions_free ( extensions ) ; exit ( 1 ) ; } if ( ( error = pfkey_outif_build ( & extensions [ SADB_X_EXT_PLUMBIF ] , vifnum ) ) ) { fprintf ( stderr , "%s: Trouble building outif extension, error=%d.\n" , progname , error ) ; pfkey_extensions_free ( extensions ) ; exit ( 1 ) ; } if ( ( error = pfkey_msg_build ( & pfkey_msg , extensions , EXT_BITS_IN ) ) ) { fprintf ( stderr , "%s: Trouble building pfkey message, error=%d.\n" , progname , error ) ; pfkey_extensions_free ( extensions ) ; pfkey_msg_free ( & pfkey_msg ) ; exit ( 1 ) ; } pfkey_sock = pfkey_open_sock_with_error ( ) ; if ( pfkey_sock < 0 ) { exit ( 1 ) ; } io_error = write ( pfkey_sock , pfkey_msg , pfkey_msg -> sadb_msg_len * IPSEC_PFKEYv2_ALIGN ) ; if ( io_error != ( pfkey_msg -> sadb_msg_len * IPSEC_PFKEYv2_ALIGN ) ) { perror ( "pfkey write" ) ; exit ( 2 ) ; } return 0 ; } 