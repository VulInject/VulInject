void sleep_setup ( struct sleep_state * sls , const volatile void * ident , int prio , const char * wmesg , int timo ) { struct proc * p = curproc ; if ( p -> p_flag & P_CANTSLEEP ) { panic ( "sleep: %s failed insomnia" , p -> p_p -> ps_comm ) ; } if ( ident == NULL ) { panic ( "tsleep: no ident" ) ; } if ( p -> p_stat != SONPROC ) { panic ( "tsleep: not SONPROC" ) ; } sls -> sls_catch = prio & PCATCH ; sls -> sls_timeout = 0 ; SCHED_LOCK ( sls -> sls_s ) ; TRACEPOINT ( sched , sleep , NULL ) ; p -> p_wchan = ident ; p -> p_wmesg = wmesg ; p -> p_slptime = 0 ; p -> p_slppri = prio & PRIMASK ; TAILQ_INSERT_TAIL ( & slpque [ LOOKUP ( ident ) ] , p , p_runq ) ; if ( timo ) { sls -> sls_timeout = 1 ; timeout_add ( & p -> p_sleep_to , timo ) ; } } 