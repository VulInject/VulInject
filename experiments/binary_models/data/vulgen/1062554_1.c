ssize_t i915_gpu_coredump_copy_to_buffer ( struct i915_gpu_coredump * error , char * buf , loff_t off , size_t rem ) { struct scatterlist * sg ; size_t count ; loff_t pos ; int err ; if ( ! error || ! rem ) { return 0 ; } err = err_print_to_sgl ( error ) ; if ( err ) { return err ; } sg = READ_ONCE ( error -> fit ) ; if ( ! sg || off < sg -> dma_address ) { sg = error -> sgl ; } if ( ! sg ) { return 0 ; } pos = sg -> dma_address ; count = 0 ; { size_t len , start ; if ( sg_is_chain ( sg ) ) { sg = sg_chain_ptr ( sg ) ; GEM_BUG_ON ( sg_is_chain ( sg ) ) ; } len = sg -> length ; if ( pos + len <= off ) { pos += len ; continue ; } start = sg -> offset ; if ( pos < off ) { GEM_BUG_ON ( off - pos > len ) ; len -= off - pos ; start += off - pos ; pos = off ; } len = min ( len , rem ) ; memcpy ( buf , page_address ( sg_page ( sg ) ) + start , len ) ; count += len ; pos += len ; buf += len ; rem -= len ; if ( ! rem ) { WRITE_ONCE ( error -> fit , sg ) ; break ; } } ! sg_is_last ( sg ++ ) ; return count ; } 