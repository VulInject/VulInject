static int ohci_hcd_tilegx_drv_probe ( struct platform_device * pdev ) { struct usb_hcd * hcd ; struct tilegx_usb_platform_data * pdata = dev_get_platdata ( & pdev -> dev ) ; pte_t pte = { 0 } ; int my_cpu = smp_processor_id ( ) ; int ret ; if ( usb_disabled ( ) ) { return - ENODEV ; } if ( gxio_usb_host_init ( & pdata -> usb_ctx , pdata -> dev_index , 0 ) != 0 ) { return - ENXIO ; } hcd = usb_create_hcd ( & ohci_tilegx_hc_driver , & pdev -> dev , dev_name ( & pdev -> dev ) ) ; if ( ! hcd ) { ret = - ENOMEM ; err_hcd } hcd -> rsrc_start = ( ulong ) gxio_usb_host_get_reg_start ( & pdata -> usb_ctx ) ; hcd -> rsrc_len = gxio_usb_host_get_reg_len ( & pdata -> usb_ctx ) ; hcd -> regs = gxio_usb_host_get_reg_start ( & pdata -> usb_ctx ) ; tilegx_start_ohc ( ) ; pdata -> irq = irq_alloc_hwirq ( - 1 ) ; if ( ! pdata -> irq ) { ret = - ENXIO ; err_no_irq } tile_irq_activate ( pdata -> irq , TILE_IRQ_PERCPU ) ; ret = gxio_usb_host_cfg_interrupt ( & pdata -> usb_ctx , cpu_x ( my_cpu ) , cpu_y ( my_cpu ) , KERNEL_PL , pdata -> irq ) ; if ( ret ) { ret = - ENXIO ; err_have_irq } pte = pte_set_home ( pte , PAGE_HOME_HASH ) ; ret = gxio_usb_host_register_client_memory ( & pdata -> usb_ctx , pte , 0 ) ; if ( ret ) { ret = - ENXIO ; err_have_irq } ohci_hcd_init ( hcd_to_ohci ( hcd ) ) ; ret = usb_add_hcd ( hcd , pdata -> irq , IRQF_SHARED ) ; err_have_irq irq_free_hwirq ( pdata -> irq ) ; err_no_irq tilegx_stop_ohc ( ) ; usb_put_hcd ( hcd ) ; err_hcd gxio_usb_host_destroy ( & pdata -> usb_ctx ) ; return ret ; } 