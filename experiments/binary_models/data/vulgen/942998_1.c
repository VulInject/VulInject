int con_get_unimap ( struct vc_data * vc , ushort ct , ushort __user * uct , struct unipair __user * list ) { ushort ect ; struct uni_pagedict * dict ; struct unipair * unilist ; unsigned int d , r , g ; int ret = 0 ; unilist = kvmalloc_array ( ct , sizeof ( * unilist ) , GFP_KERNEL ) ; if ( ! unilist ) { return - ENOMEM ; } console_lock ( ) ; ect = 0 ; dict = * vc -> uni_pagedict_loc ; if ( ! dict ) { unlock } for ( d = 0 ; d < UNI_DIRS ; d ++ ) { u16 * * dir = dict -> uni_pgdir [ d ] ; if ( ! dir ) { continue ; } for ( r = 0 ; r < UNI_DIR_ROWS ; r ++ ) { u16 * row = dir [ r ] ; if ( ! row ) { continue ; } for ( g = 0 ; g < UNI_ROW_GLYPHS ; g ++ , row ++ ) { if ( * row >= MAX_GLYPH ) { continue ; } ect ++ ; } } } unlock console_unlock ( ) ; if ( copy_to_user ( list , unilist , min ( ect , ct ) * sizeof ( * unilist ) ) ) { ret = - EFAULT ; } if ( put_user ( ect , uct ) ) { ret = - EFAULT ; } kvfree ( unilist ) ; return ret ?ret : ( ect <= ct ) ?0 : - ENOMEM ; } 