BOOLEAN RhelGetSerialNumber ( IN PVOID DeviceExtension , IN PSRB_TYPE Srb ) { ULONG QueueNumber = 0 ; ULONG OldIrql = 0 ; ULONG MessageId = 1 ; STOR_LOCK_HANDLE LockHandle = { 0 } ; struct virtqueue * vq = NULL ; PADAPTER_EXTENSION adaptExt = ( PADAPTER_EXTENSION ) DeviceExtension ; PSRB_EXTENSION srbExt = SRB_EXTENSION ( Srb ) ; ULONG status = STOR_STATUS_SUCCESS ; PVOID va = NULL ; ULONGLONG pa = 0ULL ; BOOLEAN result = FALSE ; BOOLEAN notify = FALSE ; ULONG fragLen = 0UL ; PREQUEST_LIST element ; SET_VA_PA ( ) ; RhelDbgPrint ( TRACE_LEVEL_INFORMATION , " srbExt %p.\n" , srbExt ) ; if ( adaptExt -> reset_in_progress ) { CompleteRequestWithStatus ( DeviceExtension , Srb , SRB_STATUS_BUS_RESET ) ; return TRUE ; } vq = adaptExt -> vq [ QueueNumber ] ; srbExt -> MessageID = MessageId ; vq = adaptExt -> vq [ QueueNumber ] ; srbExt -> vbr . out_hdr . sector = 0 ; srbExt -> vbr . out_hdr . ioprio = 0 ; srbExt -> vbr . req = ( request * ) Srb ; srbExt -> vbr . out_hdr . type = VIRTIO_BLK_T_GET_ID | VIRTIO_BLK_T_IN ; srbExt -> out = 1 ; srbExt -> in = 2 ; srbExt -> sg [ 0 ] . physAddr = StorPortGetPhysicalAddress ( DeviceExtension , NULL , & srbExt -> vbr . out_hdr , & fragLen ) ; srbExt -> sg [ 0 ] . length = sizeof ( srbExt -> vbr . out_hdr ) ; srbExt -> sg [ 1 ] . physAddr = StorPortGetPhysicalAddress ( DeviceExtension , NULL , & adaptExt -> sn [ 0 ] , & fragLen ) ; srbExt -> sg [ 1 ] . length = sizeof ( adaptExt -> sn ) ; srbExt -> sg [ 2 ] . physAddr = StorPortGetPhysicalAddress ( DeviceExtension , NULL , & srbExt -> vbr . status , & fragLen ) ; srbExt -> sg [ 2 ] . length = sizeof ( srbExt -> vbr . status ) ; element = & adaptExt -> processing_srbs [ QueueNumber ] ; VioStorVQLock ( DeviceExtension , MessageId , & LockHandle , FALSE ) ; if ( virtqueue_add_buf ( vq , & srbExt -> sg [ 0 ] , srbExt -> out , srbExt -> in , & srbExt -> vbr , va , pa ) >= 0 ) { notify = virtqueue_kick_prepare ( vq ) ; InsertTailList ( & element -> srb_list , & srbExt -> vbr . list_entry ) ; element -> srb_cnt ++ ; VioStorVQUnlock ( DeviceExtension , MessageId , & LockHandle , FALSE ) ; result = TRUE ; InterlockedIncrement ( ( LONG volatile * ) & adaptExt -> inqueue_cnt ) ; } else { VioStorVQUnlock ( DeviceExtension , MessageId , & LockHandle , FALSE ) ; RhelDbgPrint ( TRACE_LEVEL_ERROR , " Can not add packet to queue %d.\n" , QueueNumber ) ; StorPortBusy ( DeviceExtension , 2 ) ; } if ( notify ) { virtqueue_notify ( vq ) ; } return result ; } 