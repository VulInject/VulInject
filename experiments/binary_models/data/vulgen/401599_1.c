static void rtsx_pci_remove ( struct pci_dev * pcidev ) { struct pcr_handle * handle = pci_get_drvdata ( pcidev ) ; struct rtsx_pcr * pcr = handle -> pcr ; pcr -> remove_pci = true ; pm_runtime_get_sync ( & pcidev -> dev ) ; pm_runtime_forbid ( & pcidev -> dev ) ; spin_lock_irq ( & pcr -> lock ) ; rtsx_pci_writel ( pcr , RTSX_BIER , 0 ) ; pcr -> bier = 0 ; spin_unlock_irq ( & pcr -> lock ) ; cancel_delayed_work_sync ( & pcr -> carddet_work ) ; mfd_remove_devices ( & pcidev -> dev ) ; dma_free_coherent ( & ( pcr -> pci -> dev ) , RTSX_RESV_BUF_LEN , pcr -> rtsx_resv_buf , pcr -> rtsx_resv_buf_addr ) ; free_irq ( pcr -> irq , ( void * ) pcr ) ; if ( pcr -> msi_en ) { pci_disable_msi ( pcr -> pci ) ; } iounmap ( pcr -> remap_addr ) ; pci_disable_device ( pcidev ) ; spin_lock ( & rtsx_pci_lock ) ; idr_remove ( & rtsx_pci_idr , pcr -> id ) ; spin_unlock ( & rtsx_pci_lock ) ; kfree ( pcr -> slots ) ; kfree ( pcr ) ; kfree ( handle ) ; dev_dbg ( & ( pcidev -> dev ) , ": Realtek PCI-E Card Reader at %s [%04x:%04x] has been removed\n" , pci_name ( pcidev ) , ( int ) pcidev -> vendor , ( int ) pcidev -> device ) ; } 