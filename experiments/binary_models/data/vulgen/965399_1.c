static void test_hs_control_add_auth_onion_service ( void * arg ) { control_connection_t conn ; char * args = NULL , * cp1 = NULL ; size_t sz ; ( void ) arg ; hs_init ( ) ; memset ( & conn , 0 , sizeof ( control_connection_t ) ) ; TO_CONN ( & conn ) -> outbuf = buf_new ( ) ; conn . current_cmd = tor_strdup ( "ADD_ONION" ) ; args = tor_strdup ( "ED25519-V3:KLMQ4CLKwlDCHuMPn8j3od33cU5LhnrLNoZh7CWChl3VkY" "pNAkeP5dGW8xeKR9HxQBWQ/w7Kr12lA/U8Pd/oxw== " "ClientAuthV3=dz4q5xqlb4ldnbs72iarrml4ephk3du4i7o2cgiva5lwr6wkquja " "Flags=V3Auth Port=9735,127.0.0.1" ) ; handle_control_command ( & conn , ( uint32_t ) strlen ( args ) , args ) ; cp1 = buf_get_contents ( TO_CONN ( & conn ) -> outbuf , & sz ) ; tt_str_op ( cp1 , OP_EQ , "250-ServiceID=n35etu3yjxrqjpntmfziom5sjwspoydchmelc4xleoy4jk2u4lziz2yd\r\n" "250-ClientAuthV3=dz4q5xqlb4ldnbs72iarrml4ephk3du4i7o2cgiva5lwr6wkquja\r\n" "250 OK\r\n" ) ; tor_free ( cp1 ) ; args = tor_strdup ( "ED25519-V3:iIU8EBi71qE7G6UTsROU1kWN0JMrRP/YukC0Xk5WLGyil3" "gm4u3wEBXr+/TaCpXS+65Pcdqz+PG+4+oWHLN05A== " "ClientAuthV3=dummy Flags=V3Auth Port=9735,127.0.0.1" ) ; handle_control_command ( & conn , ( uint32_t ) strlen ( args ) , args ) ; cp1 = buf_get_contents ( TO_CONN ( & conn ) -> outbuf , & sz ) ; tt_str_op ( cp1 , OP_EQ , "512 Cannot decode v3 client auth key\r\n" ) ; done tor_free ( args ) ; tor_free ( cp1 ) ; tor_free ( conn . current_cmd ) ; buf_free ( TO_CONN ( & conn ) -> outbuf ) ; SMARTLIST_FOREACH ( conn . ephemeral_onion_services , char * , service , tor_free ( service ) ) ; smartlist_free ( conn . ephemeral_onion_services ) ; hs_client_free_all ( ) ; } 