int tegra_asoc_machine_probe ( struct platform_device * pdev ) { struct device_node * np_codec , * np_i2s , * np_ac97 ; const struct tegra_asoc_data * asoc ; struct device * dev = & pdev -> dev ; struct tegra_machine * machine ; struct snd_soc_card * card ; struct gpio_desc * gpiod ; int err ; machine = devm_kzalloc ( dev , sizeof ( * machine ) , GFP_KERNEL ) ; asoc = of_device_get_match_data ( dev ) ; card = asoc -> card ; card -> dev = dev ; machine -> asoc = asoc ; machine -> mic_jack = & tegra_machine_mic_jack ; machine -> hp_jack_gpio = & tegra_machine_hp_jack_gpio ; snd_soc_card_set_drvdata ( card , machine ) ; gpiod = devm_gpiod_get_optional ( dev , "nvidia,hp-mute" , GPIOD_OUT_HIGH ) ; machine -> gpiod_hp_mute = gpiod ; if ( IS_ERR ( gpiod ) ) { return PTR_ERR ( gpiod ) ; } gpiod = devm_gpiod_get_optional ( dev , "nvidia,hp-det" , GPIOD_IN ) ; machine -> gpiod_hp_det = gpiod ; if ( IS_ERR ( gpiod ) ) { return PTR_ERR ( gpiod ) ; } gpiod = devm_gpiod_get_optional ( dev , "nvidia,mic-det" , GPIOD_IN ) ; machine -> gpiod_mic_det = gpiod ; if ( IS_ERR ( gpiod ) ) { return PTR_ERR ( gpiod ) ; } gpiod = devm_gpiod_get_optional ( dev , "nvidia,spkr-en" , GPIOD_OUT_LOW ) ; machine -> gpiod_spkr_en = gpiod ; if ( IS_ERR ( gpiod ) ) { return PTR_ERR ( gpiod ) ; } gpiod = devm_gpiod_get_optional ( dev , "nvidia,int-mic-en" , GPIOD_OUT_LOW ) ; machine -> gpiod_int_mic_en = gpiod ; if ( IS_ERR ( gpiod ) ) { return PTR_ERR ( gpiod ) ; } gpiod = devm_gpiod_get_optional ( dev , "nvidia,ext-mic-en" , GPIOD_OUT_LOW ) ; machine -> gpiod_ext_mic_en = gpiod ; if ( IS_ERR ( gpiod ) ) { return PTR_ERR ( gpiod ) ; } err = snd_soc_of_parse_card_name ( card , "nvidia,model" ) ; if ( err ) { return err ; } if ( ! card -> dapm_routes ) { err = snd_soc_of_parse_audio_routing ( card , "nvidia,audio-routing" ) ; if ( err ) { return err ; } } if ( asoc -> set_ac97 ) { err = tegra_machine_register_codec ( dev , asoc -> codec_dev_name ) ; if ( err ) { return err ; } np_ac97 = tegra_machine_parse_phandle ( dev , "nvidia,ac97-controller" ) ; if ( IS_ERR ( np_ac97 ) ) { return PTR_ERR ( np_ac97 ) ; } card -> dai_link -> cpus -> of_node = np_ac97 ; card -> dai_link -> platforms -> of_node = np_ac97 ; } else { np_codec = tegra_machine_parse_phandle ( dev , "nvidia,audio-codec" ) ; if ( IS_ERR ( np_codec ) ) { return PTR_ERR ( np_codec ) ; } np_i2s = tegra_machine_parse_phandle ( dev , "nvidia,i2s-controller" ) ; if ( IS_ERR ( np_i2s ) ) { return PTR_ERR ( np_i2s ) ; } card -> dai_link -> cpus -> of_node = np_i2s ; card -> dai_link -> codecs -> of_node = np_codec ; card -> dai_link -> platforms -> of_node = np_i2s ; } if ( asoc -> add_common_controls ) { card -> controls = tegra_machine_controls ; card -> num_controls = ARRAY_SIZE ( tegra_machine_controls ) ; } if ( asoc -> add_common_dapm_widgets ) { card -> dapm_widgets = tegra_machine_dapm_widgets ; card -> num_dapm_widgets = ARRAY_SIZE ( tegra_machine_dapm_widgets ) ; } if ( asoc -> add_common_snd_ops ) { card -> dai_link -> ops = & tegra_machine_snd_ops ; } if ( ! card -> owner ) { card -> owner = THIS_MODULE ; } if ( ! card -> driver_name ) { card -> driver_name = "tegra" ; } machine -> clk_pll_a = devm_clk_get ( dev , "pll_a" ) ; if ( IS_ERR ( machine -> clk_pll_a ) ) { dev_err ( dev , "Can't retrieve clk pll_a\n" ) ; return PTR_ERR ( machine -> clk_pll_a ) ; } machine -> clk_pll_a_out0 = devm_clk_get ( dev , "pll_a_out0" ) ; if ( IS_ERR ( machine -> clk_pll_a_out0 ) ) { dev_err ( dev , "Can't retrieve clk pll_a_out0\n" ) ; return PTR_ERR ( machine -> clk_pll_a_out0 ) ; } machine -> clk_cdev1 = devm_clk_get ( dev , "mclk" ) ; if ( IS_ERR ( machine -> clk_cdev1 ) ) { dev_err ( dev , "Can't retrieve clk cdev1\n" ) ; return PTR_ERR ( machine -> clk_cdev1 ) ; } if ( ! of_find_property ( dev -> of_node , "assigned-clock-parents" , NULL ) && ! of_machine_is_compatible ( "nvidia,tegra20" ) ) { struct clk * clk_out_1 , * clk_extern1 ; dev_warn ( dev , "Configuring clocks for a legacy device-tree\n" ) ; dev_warn ( dev , "Please update DT to use assigned-clock-parents\n" ) ; clk_extern1 = devm_clk_get ( dev , "extern1" ) ; if ( IS_ERR ( clk_extern1 ) ) { dev_err ( dev , "Can't retrieve clk extern1\n" ) ; return PTR_ERR ( clk_extern1 ) ; } err = clk_set_parent ( clk_extern1 , machine -> clk_pll_a_out0 ) ; if ( err < 0 ) { dev_err ( dev , "Set parent failed for clk extern1\n" ) ; return err ; } clk_out_1 = devm_clk_get ( dev , "pmc_clk_out_1" ) ; if ( IS_ERR ( clk_out_1 ) ) { dev_err ( dev , "Can't retrieve pmc_clk_out_1\n" ) ; return PTR_ERR ( clk_out_1 ) ; } err = clk_set_parent ( clk_out_1 , clk_extern1 ) ; if ( err < 0 ) { dev_err ( dev , "Set parent failed for pmc_clk_out_1\n" ) ; return err ; } machine -> clk_cdev1 = clk_out_1 ; } if ( asoc -> set_ac97 ) { err = clk_set_rate ( machine -> clk_pll_a , 73728000 ) ; if ( err ) { dev_err ( dev , "Can't set pll_a rate: %d\n" , err ) ; return err ; } err = clk_set_rate ( machine -> clk_pll_a_out0 , 24576000 ) ; if ( err ) { dev_err ( dev , "Can't set pll_a_out0 rate: %d\n" , err ) ; return err ; } machine -> set_baseclock = 73728000 ; machine -> set_mclk = 24576000 ; } err = clk_prepare_enable ( machine -> clk_cdev1 ) ; if ( err ) { dev_err ( dev , "Can't enable cdev1: %d\n" , err ) ; return err ; } err = devm_snd_soc_register_card ( dev , card ) ; if ( err ) { return err ; } return 0 ; } 