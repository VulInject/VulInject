static __be16 efx_tso_check_protocol ( struct sk_buff * skb ) { __be16 protocol = skb -> protocol ; EFX_WARN_ON_ONCE_PARANOID ( ( ( ethhdr * ) skb -> data ) -> h_proto != protocol ) ; if ( protocol == htons ( ETH_P_8021Q ) ) { struct vlan_ethhdr * veh = ( vlan_ethhdr * ) skb -> data ; protocol = veh -> h_vlan_encapsulated_proto ; } if ( protocol == htons ( ETH_P_IP ) ) { EFX_WARN_ON_ONCE_PARANOID ( ip_hdr ( skb ) -> protocol != IPPROTO_TCP ) ; } else { EFX_WARN_ON_ONCE_PARANOID ( protocol != htons ( ETH_P_IPV6 ) ) ; } EFX_WARN_ON_ONCE_PARANOID ( ( PTR_DIFF ( tcp_hdr ( skb ) , skb -> data ) + ( tcp_hdr ( skb ) -> doff << 2u ) ) > skb_headlen ( skb ) ) ; return protocol ; } 