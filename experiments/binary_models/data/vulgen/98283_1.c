static int set_agaw ( immu_t * immu ) { int mgaw , magaw , agaw ; uint_t bitpos ; int max_sagaw_mask , sagaw_mask , mask ; int nlevels ; mgaw = IMMU_CAP_MGAW ( immu -> immu_regs_cap ) ; sagaw_mask = IMMU_CAP_SAGAW ( immu -> immu_regs_cap ) ; magaw = gaw2agaw ( mgaw ) ; max_sagaw_mask = ( ( 1 << 5 ) - 1 ) ; if ( sagaw_mask > max_sagaw_mask ) { ddi_err ( DER_WARN , NULL , "%s: SAGAW bitmask (%x) " "is larger than maximu SAGAW bitmask " "(%x) specified by Intel Vt-d spec" , immu -> immu_name , sagaw_mask , max_sagaw_mask ) ; return ( DDI_FAILURE ) ; } mask = 1 ; nlevels = 0 ; agaw = 0 ; for ( mask = 1 , bitpos = 0 ; bitpos < 5 ; bitpos ++ , mask <<= 1 ) { if ( mask & sagaw_mask ) { nlevels = bitpos + 2 ; } } agaw = ( agaw > 64 ) ?64 : agaw ; if ( agaw ( 30 || agaw ) magaw ) { ddi_err ( DER_WARN , NULL , "%s: Calculated AGAW (%d) " "is outside valid limits [30,%d] specified by Vt-d spec " "and magaw" , immu -> immu_name , agaw , magaw ) ; return ( DDI_FAILURE ) ; } if ( nlevels ( 2 || nlevels ) 6 ) { ddi_err ( DER_WARN , NULL , "%s: Calculated pagetable " "level (%d) is outside valid limits [2,6]" , immu -> immu_name , nlevels ) ; return ( DDI_FAILURE ) ; } ddi_err ( DER_LOG , NULL , "Calculated pagetable " "level (%d), agaw = %d" , nlevels , agaw ) ; immu -> immu_dvma_nlevels = nlevels ; immu -> immu_dvma_agaw = agaw ; return ( DDI_SUCCESS ) ; } 