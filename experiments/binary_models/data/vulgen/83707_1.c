static int pmc_core_probe ( struct platform_device * pdev ) { static bool device_initialized ; struct pmc_dev * pmcdev ; const struct x86_cpu_id * cpu_id ; void * core_init ( struct pmc_dev * pmcdev ) u64 slp_s0_addr ; if ( device_initialized ) { return - ENODEV ; } pmcdev = devm_kzalloc ( & pdev -> dev , sizeof ( * pmcdev ) , GFP_KERNEL ) ; if ( ! pmcdev ) { return - ENOMEM ; } platform_set_drvdata ( pdev , pmcdev ) ; pmcdev -> pdev = pdev ; cpu_id = x86_match_cpu ( intel_pmc_core_ids ) ; if ( ! cpu_id ) { return - ENODEV ; } core_init = ( void ( * ) ( pmc_dev * ) ) cpu_id -> driver_data ; if ( core_init == spt_core_init && ! pci_dev_present ( pmc_pci_ids ) ) { core_init = cnp_core_init ; } core_init ( pmcdev ) ; if ( lpit_read_residency_count_address ( & slp_s0_addr ) ) { pmcdev -> base_addr = PMC_BASE_ADDR_DEFAULT ; if ( page_is_ram ( PHYS_PFN ( pmcdev -> base_addr ) ) ) { return - ENODEV ; } } else { pmcdev -> base_addr = slp_s0_addr - pmcdev -> map -> slp_s0_offset ; } pmcdev -> regbase = ioremap ( pmcdev -> base_addr , pmcdev -> map -> regmap_length ) ; if ( ! pmcdev -> regbase ) { return - ENOMEM ; } if ( pmcdev -> core_configure ) { pmcdev -> core_configure ( pmcdev ) ; } pmcdev -> pmc_xram_read_bit = pmc_core_check_read_lock_bit ( pmcdev ) ; pmc_core_get_low_power_modes ( pdev ) ; pmc_core_do_dmi_quirks ( pmcdev ) ; pmc_core_dbgfs_register ( pmcdev ) ; device_initialized = true ; dev_info ( & pdev -> dev , " initialized\n" ) ; return 0 ; } 