papi_status_t papiJobSubmit ( papi_service_t handle , char * printer , papi_attribute_t * * job_attributes , papi_job_ticket_t * job_ticket , char * * files , papi_job_t * job ) { papi_status_t status ; service_t * svc = handle ; struct stat statbuf ; job_t * j ; int file_no ; char * request_id = NULL ; REQUEST * request ; int i ; char * c ; char * tmp = NULL ; char lpfile [ BUFSIZ ] ; if ( ( svc == NULL ) || ( printer == NULL ) || ( files == NULL ) || ( job == NULL ) ) { return ( PAPI_BAD_ARGUMENT ) ; } if ( job_ticket != NULL ) { return ( PAPI_OPERATION_NOT_SUPPORTED ) ; } if ( files != NULL ) { for ( file_no = 0 ; files [ file_no ] != NULL ; file_no ++ ) { if ( access ( files [ file_no ] , R_OK ) < 0 ) { detailed_error ( svc , gettext ( "Cannot access file: %s: %s" ) , files [ file_no ] , strerror ( errno ) ) ; return ( PAPI_BAD_ARGUMENT ) ; } if ( stat ( files [ file_no ] , & statbuf ) < 0 ) { detailed_error ( svc , gettext ( "Cannot access file: %s: %s" ) , files [ file_no ] , strerror ( errno ) ) ; return ( PAPI_DOCUMENT_ACCESS_ERROR ) ; } if ( statbuf . st_size == 0 ) { detailed_error ( svc , gettext ( "Zero byte (empty) file: %s" ) , files [ file_no ] ) ; return ( PAPI_BAD_ARGUMENT ) ; } } } status = lpsched_alloc_files ( svc , file_no + 1 , & request_id ) ; if ( status != PAPI_OK ) { return ( status ) ; } request = create_request ( svc , ( char * ) printer , ( papi_attribute_t * * ) job_attributes ) ; for ( i = 0 ; files [ i ] != NULL ; i ++ ) { papi_status_t status ; snprintf ( lpfile , sizeof ( lpfile ) , "%s%s-%d" , "/var/spool/lp/temp/" , request_id , i + 1 ) ; status = copy_file ( files [ i ] , lpfile ) ; if ( status != PAPI_OK ) { detailed_error ( svc , gettext ( "unable to copy: %s ->%s: %s" ) , files [ i ] , lpfile , strerror ( errno ) ) ; freerequest ( request ) ; return ( PAPI_DEVICE_ERROR ) ; } addlist ( & ( request -> file_list ) , lpfile ) ; } snprintf ( lpfile , sizeof ( lpfile ) , "%s%s-%s" , "/var/spool/lp/temp/" , request_id , LP_PAPIATTRNAME ) ; status = psm_copy_attrsToFile ( job_attributes , lpfile ) ; if ( status != PAPI_OK ) { detailed_error ( svc , "unable to copy attributes to file: %s: %s" , lpfile , strerror ( errno ) ) ; return ( PAPI_DEVICE_ERROR ) ; } snprintf ( lpfile , sizeof ( lpfile ) , "%s-0" , request_id ) ; if ( putrequest ( lpfile , request ) < 0 ) { detailed_error ( svc , gettext ( "unable to save request: %s: %s" ) , lpfile , strerror ( errno ) ) ; freerequest ( request ) ; return ( PAPI_DEVICE_ERROR ) ; } status = lpsched_commit_job ( svc , lpfile , & tmp ) ; if ( status != PAPI_OK ) { unlink ( lpfile ) ; freerequest ( request ) ; return ( status ) ; } lpsched_request_to_job_attributes ( request , j ) ; freerequest ( request ) ; if ( ( c = strrchr ( tmp , '-' ) ) != NULL ) { c ++ ; } papiAttributeListAddInteger ( & j -> attributes , PAPI_ATTR_REPLACE , "job-id" , atoi ( c ) ) ; papiAttributeListAddString ( & j -> attributes , PAPI_ATTR_REPLACE , "job-uri" , tmp ) ; return ( PAPI_OK ) ; } 