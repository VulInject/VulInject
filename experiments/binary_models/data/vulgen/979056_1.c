static BOOL tsmf_gstreamer_decodeEx ( ITSMFDecoder * decoder , const BYTE * data , UINT32 data_size , UINT32 extensions , UINT64 start_time , UINT64 end_time , UINT64 duration ) { GstBuffer * gst_buf ; TSMFGstreamerDecoder * mdecoder = ( TSMFGstreamerDecoder * ) decoder ; UINT64 sample_time = tsmf_gstreamer_timestamp_ms_to_gst ( start_time ) ; BOOL useTimestamps = TRUE ; if ( ! mdecoder ) { WLog_ERR ( TAG , "Decoder not initialized!" ) ; return FALSE ; } DEBUG_TSMF ( "%s. Start:(%" PRIu64 ") End:(%" PRIu64 ") Duration:(%" PRIu64 ") Last Start:(%" PRIu64 ")" , get_type ( mdecoder ) , start_time , end_time , duration , mdecoder -> last_sample_start_time ) ; if ( mdecoder -> shutdown ) { WLog_ERR ( TAG , "decodeEx called on shutdown decoder" ) ; return TRUE ; } if ( mdecoder -> gst_caps == NULL ) { WLog_ERR ( TAG , "tsmf_gstreamer_set_format not called or invalid format." ) ; return FALSE ; } if ( ! mdecoder -> src ) { WLog_ERR ( TAG , "failed to construct pipeline correctly. Unable to push buffer to source element." ) ; return FALSE ; } gst_buf = tsmf_get_buffer_from_data ( data , data_size ) ; if ( gst_buf == NULL ) { WLog_ERR ( TAG , "tsmf_get_buffer_from_data(%p, %" PRIu32 ") failed." , ( void * ) data , data_size ) ; return FALSE ; } if ( extensions & 0x00000080 ) { DEBUG_TSMF ( "Ignoring the timestamps - relative - bit 8" ) ; useTimestamps = FALSE ; } if ( extensions & 0x00000040 ) { DEBUG_TSMF ( "Ignoring the timestamps - none - bit 7" ) ; useTimestamps = FALSE ; } if ( mdecoder -> seeking ) { mdecoder -> seeking = FALSE ; tsmf_gstreamer_pipeline_set_state ( mdecoder , GST_STATE_PAUSED ) ; mdecoder -> pipeline_start_time_valid = 0 ; } if ( mdecoder -> pipeline_start_time_valid ) { DEBUG_TSMF ( "%s start time %" PRIu64 "" , get_type ( mdecoder ) , start_time ) ; UINT64 minTime = mdecoder -> last_sample_start_time - ( UINT64 ) SEEK_TOLERANCE ; UINT64 maxTime = mdecoder -> last_sample_start_time + ( UINT64 ) SEEK_TOLERANCE ; if ( mdecoder -> last_sample_start_time < ( UINT64 ) SEEK_TOLERANCE ) { minTime = 0 ; } if ( ( ( start_time > maxTime ) || ( start_time < minTime ) ) && useTimestamps ) { DEBUG_TSMF ( "tsmf_gstreamer_decodeEx: start_time=[%" PRIu64 "]>last_sample_start_time=[%" PRIu64 "] OR " , start_time , mdecoder -> last_sample_start_time ) ; DEBUG_TSMF ( "tsmf_gstreamer_decodeEx: start_time=[%" PRIu64 "]<last_sample_start_time=[%" PRIu64 "] with" , start_time , mdecoder -> last_sample_start_time ) ; DEBUG_TSMF ( "tsmf_gstreamer_decodeEX: a tolerance of more than [%lu] from the last sample" , SEEK_TOLERANCE ) ; DEBUG_TSMF ( "tsmf_gstreamer_decodeEX: minTime=[%" PRIu64 "] maxTime=[%" PRIu64 "]" , minTime , maxTime ) ; mdecoder -> seeking = TRUE ; mdecoder -> seek_offset = start_time ; } } else { DEBUG_TSMF ( "%s start time %" PRIu64 "" , get_type ( mdecoder ) , start_time ) ; gst_element_set_base_time ( mdecoder -> pipe , tsmf_gstreamer_timestamp_ms_to_gst ( 0 ) ) ; gst_element_set_start_time ( mdecoder -> pipe , tsmf_gstreamer_timestamp_ms_to_gst ( 0 ) ) ; mdecoder -> pipeline_start_time_valid = 1 ; if ( useTimestamps ) { mdecoder -> seek_offset = start_time ; } if ( ! gst_element_seek ( mdecoder -> pipe , 1.0 , GST_FORMAT_TIME , GST_SEEK_FLAG_FLUSH , GST_SEEK_TYPE_SET , 0 , GST_SEEK_TYPE_NONE , GST_CLOCK_TIME_NONE ) ) { WLog_ERR ( TAG , "seek failed" ) ; } } if ( useTimestamps ) { GST_BUFFER_PTS ( gst_buf ) = sample_time - tsmf_gstreamer_timestamp_ms_to_gst ( mdecoder -> seek_offset ) ; } else { GST_BUFFER_PTS ( gst_buf ) = GST_CLOCK_TIME_NONE ; } if ( useTimestamps ) { GST_BUFFER_TIMESTAMP ( gst_buf ) = sample_time - tsmf_gstreamer_timestamp_ms_to_gst ( mdecoder -> seek_offset ) ; } else { GST_BUFFER_TIMESTAMP ( gst_buf ) = GST_CLOCK_TIME_NONE ; } GST_BUFFER_DURATION ( gst_buf ) = GST_CLOCK_TIME_NONE ; GST_BUFFER_OFFSET ( gst_buf ) = GST_BUFFER_OFFSET_NONE ; gst_buffer_set_caps ( gst_buf , mdecoder -> gst_caps ) ; gst_app_src_push_buffer ( GST_APP_SRC ( mdecoder -> src ) , gst_buf ) ; if ( useTimestamps ) { mdecoder -> last_sample_start_time = start_time ; mdecoder -> last_sample_end_time = end_time ; } if ( mdecoder -> pipe && ( GST_STATE ( mdecoder -> pipe ) != GST_STATE_PLAYING ) ) { DEBUG_TSMF ( "%s: state=%s" , get_type ( mdecoder ) , gst_element_state_get_name ( GST_STATE ( mdecoder -> pipe ) ) ) ; DEBUG_TSMF ( "%s Paused: %" PRIi32 "   Shutdown: %i   Ready: %" PRIi32 "" , get_type ( mdecoder ) , mdecoder -> paused , mdecoder -> shutdown , mdecoder -> ready ) ; if ( ! mdecoder -> paused && ! mdecoder -> shutdown && mdecoder -> ready ) { tsmf_gstreamer_pipeline_set_state ( mdecoder , GST_STATE_PLAYING ) ; } } return TRUE ; } 