static TEE_Result read_rb_idx ( uint32_t pt , TEE_Param params [ TEE_NUM_PARAMS ] ) { size_t slot_offset ; uint64_t idx ; size_t count ; TEE_Result res ; TEE_ObjectHandle h ; if ( pt != exp_pt ) { return TEE_ERROR_BAD_PARAMETERS ; } res = get_slot_offset ( params [ 0 ] . value . a , & slot_offset ) ; if ( res ) { return res ; } res = open_rb_state ( DEFAULT_LOCK_STATE , & h ) ; if ( res ) { return res ; } res = TEE_SeekObjectData ( h , slot_offset , TEE_DATA_SEEK_SET ) ; if ( res ) { out } res = TEE_ReadObjectData ( h , & idx , sizeof ( idx ) , & count ) ; if ( res ) { out } if ( count != sizeof ( idx ) ) { idx = 0 ; if ( count ) { res = TEE_SeekObjectData ( h , slot_offset , TEE_DATA_SEEK_SET ) ; if ( res ) { out } res = TEE_WriteObjectData ( h , & idx , sizeof ( idx ) ) ; if ( res ) { out } } } params [ 1 ] . value . a = idx >> 32 ; params [ 1 ] . value . b = idx ; out TEE_CloseObject ( h ) ; return res ; } 