void virtio_input_send ( VirtIOInput * vinput , virtio_input_event * event ) { VirtQueueElement * elem ; int i , len ; if ( ! vinput -> active ) { return ; } vinput -> queue [ vinput -> qindex ++ ] . event = * event ; if ( event -> type != cpu_to_le16 ( EV_SYN ) || event -> code != cpu_to_le16 ( SYN_REPORT ) ) { return ; } for ( i = 0 ; i < vinput -> qindex ; i ++ ) { elem = virtqueue_pop ( vinput -> evt , sizeof ( VirtQueueElement ) ) ; if ( ! elem ) { while ( -- i >= 0 ) { virtqueue_unpop ( vinput -> evt , vinput -> queue [ i ] . elem , 0 ) ; } vinput -> qindex = 0 ; trace_virtio_input_queue_full ( ) ; return ; } vinput -> queue [ i ] . elem = elem ; } for ( i = 0 ; i < vinput -> qindex ; i ++ ) { elem = vinput -> queue [ i ] . elem ; len = iov_from_buf ( elem -> in_sg , elem -> in_num , 0 , & vinput -> queue [ i ] . event , sizeof ( virtio_input_event ) ) ; virtqueue_push ( vinput -> evt , elem , len ) ; g_free ( elem ) ; } virtio_notify ( VIRTIO_DEVICE ( vinput ) , vinput -> evt ) ; vinput -> qindex = 0 ; } 