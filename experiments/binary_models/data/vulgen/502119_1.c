void pfr_commit_ktable ( struct pfr_ktable * kt , time_t tzero ) { struct pfr_ktable * shadow = kt -> pfrkt_shadow ; int nflags ; if ( shadow -> pfrkt_cnt == NO_ADDRESSES ) { if ( ! ( kt -> pfrkt_flags & PFR_TFLAG_ACTIVE ) ) { SWAP ( radix_node_head * , kt -> pfrkt_ip4 , 0 ) ; SWAP ( radix_node_head * , kt -> pfrkt_ip6 , shadow -> pfrkt_ip6 ) ; SWAP ( int , kt -> pfrkt_cnt , shadow -> pfrkt_cnt ) ; pfr_clstats_ktable ( kt , tzero , 1 ) ; } } if ( kt -> pfrkt_flags & PFR_TFLAG_ACTIVE ) { struct pfr_kentryworkq addrq , addq , changeq , delq , garbageq ; struct pfr_kentry * p , * q ; struct pfr_addr ad ; pfr_enqueue_addrs ( shadow , & addrq , NULL , 0 ) ; pfr_mark_addrs ( kt ) ; SLIST_INIT ( & addq ) ; SLIST_INIT ( & changeq ) ; SLIST_INIT ( & delq ) ; SLIST_INIT ( & garbageq ) ; pfr_clean_node_mask ( shadow , & addrq ) ; while ( ( p = SLIST_FIRST ( & addrq ) ) != NULL ) { SLIST_REMOVE_HEAD ( & addrq , pfrke_workq ) ; pfr_copyout_addr ( & ad , p ) ; q = pfr_lookup_addr ( kt , & ad , 1 ) ; if ( q != NULL ) { if ( ( q -> pfrke_flags & PFRKE_FLAG_NOT ) != ( p -> pfrke_flags & PFRKE_FLAG_NOT ) ) { SLIST_INSERT_HEAD ( & changeq , q , pfrke_workq ) ; } q -> pfrke_flags |= PFRKE_FLAG_MARK ; SLIST_INSERT_HEAD ( & garbageq , p , pfrke_workq ) ; } else { p -> pfrke_tzero = tzero ; SLIST_INSERT_HEAD ( & addq , p , pfrke_workq ) ; } } pfr_enqueue_addrs ( kt , & delq , NULL , ENQUEUE_UNMARKED_ONLY ) ; pfr_insert_kentries ( kt , & addq , tzero ) ; pfr_remove_kentries ( kt , & delq ) ; pfr_clstats_kentries ( & changeq , tzero , INVERT_NEG_FLAG ) ; pfr_destroy_kentries ( & garbageq ) ; } else { SWAP ( radix_node_head * , kt -> pfrkt_ip4 , shadow -> pfrkt_ip4 ) ; SWAP ( radix_node_head * , kt -> pfrkt_ip6 , shadow -> pfrkt_ip6 ) ; SWAP ( int , kt -> pfrkt_cnt , shadow -> pfrkt_cnt ) ; pfr_clstats_ktable ( kt , tzero , 1 ) ; } nflags = ( ( shadow -> pfrkt_flags & PFR_TFLAG_USRMASK ) | ( kt -> pfrkt_flags & PFR_TFLAG_SETMASK ) | PFR_TFLAG_ACTIVE ) & ~ PFR_TFLAG_INACTIVE ; pfr_destroy_ktable ( shadow , 0 ) ; kt -> pfrkt_shadow = NULL ; pfr_setflags_ktable ( kt , nflags ) ; } 