static int read_sensor ( struct device * dev , int chan , enum lochnagar_measure_mode mode , int nsamples , unsigned int precision , long * val ) { struct lochnagar_hwmon * priv = dev_get_drvdata ( dev ) ; struct regmap * regmap = priv -> regmap ; u32 data ; int ret ; mutex_lock ( & priv -> sensor_lock ) ; ret = do_measurement ( regmap , chan , mode , nsamples ) ; if ( ret < 0 ) { dev_err ( dev , "Failed to perform measurement: %d\n" , ret ) ; error } ret = request_data ( regmap , chan , & data ) ; if ( ret < 0 ) { dev_err ( dev , "Failed to read measurement: %d\n" , ret ) ; error } error mutex_unlock ( & priv -> sensor_lock ) ; return ret ; } 