REGISTRY_PERSON * registry_person_allocate ( const char * person_guid , time_t when ) { debug ( D_REGISTRY , "Registry: registry_person_allocate('%s'): allocating new person, sizeof(PERSON)=%zu" , ( person_guid ) ?person_guid : "" , sizeof ( REGISTRY_PERSON ) ) ; REGISTRY_PERSON * p = mallocz ( sizeof ( REGISTRY_PERSON ) ) ; if ( ! person_guid ) { for ( ; ; ) { uuid_t uuid ; uuid_generate ( uuid ) ; uuid_unparse_lower ( uuid , p -> guid ) ; debug ( D_REGISTRY , "Registry: Checking if the generated person guid '%s' is unique" , p -> guid ) ; if ( ! dictionary_get ( registry . persons , p -> guid ) ) { debug ( D_REGISTRY , "Registry: generated person guid '%s' is unique" , p -> guid ) ; break ; } else { info ( "Registry: generated person guid '%s' found in the registry. Retrying..." , p -> guid ) ; } } } else { strncpyz ( p -> guid , person_guid , 0 ) ; } debug ( D_REGISTRY , "Registry: registry_person_allocate('%s'): creating dictionary of urls" , p -> guid ) ; avl_init ( & p -> person_urls , person_url_compare ) ; p -> first_t = p -> last_t = ( uint32_t ) when ; p -> usages = 0 ; registry . persons_memory += sizeof ( REGISTRY_PERSON ) ; registry . persons_count ++ ; dictionary_set ( registry . persons , p -> guid , p , sizeof ( REGISTRY_PERSON ) ) ; return p ; } 