static int esteid_pin_cmd ( sc_card_t * card , struct sc_pin_cmd_data * data , int * tries_left ) { int r ; struct sc_pin_cmd_data tmp ; LOG_FUNC_CALLED ( card -> ctx ) ; sc_log ( card -> ctx , "PIN CMD is %d" , data -> cmd ) ; if ( data -> cmd == SC_PIN_CMD_GET_INFO ) { sc_log ( card -> ctx , "SC_PIN_CMD_GET_INFO for %d" , data -> pin_reference ) ; r = esteid_get_pin_remaining_tries ( card , data -> pin_reference ) ; LOG_TEST_RET ( card -> ctx , r , "GET DATA(pin info) failed" ) ; data -> pin1 . tries_left = r ; data -> pin1 . max_tries = - 1 ; data -> pin1 . logged_in = SC_PIN_STATE_UNKNOWN ; LOG_FUNC_RETURN ( card -> ctx , SC_SUCCESS ) ; } if ( data -> cmd == SC_PIN_CMD_UNBLOCK ) { memcpy ( & tmp , data , sizeof ( sc_pin_cmd_data ) ) ; tmp . cmd = SC_PIN_CMD_VERIFY ; tmp . pin_reference = PUK_REF ; tmp . pin2 . len = 0 ; r = iso_ops -> pin_cmd ( card , & tmp , tries_left ) ; LOG_TEST_RET ( card -> ctx , r , "VERIFY during unblock failed" ) ; tmp = * data ; tmp . cmd = SC_PIN_CMD_UNBLOCK ; tmp . pin1 . len = 0 ; r = iso_ops -> pin_cmd ( card , & tmp , tries_left ) ; sc_mem_clear ( & tmp , sizeof ( tmp ) ) ; LOG_FUNC_RETURN ( card -> ctx , r ) ; } LOG_FUNC_RETURN ( card -> ctx , iso_ops -> pin_cmd ( card , data , tries_left ) ) ; } 