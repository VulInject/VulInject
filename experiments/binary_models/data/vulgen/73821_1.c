static void zfs_fm_recv ( fmd_hdl_t * hdl , fmd_event_t * ep , nvlist_t * nvl , const char * class ) { zfs_case_t * zcp , * dcp ; libzfs_handle_t * zhdl ; zpool_handle_t * zhp ; int32_t pool_state ; uint64_t ena , pool_guid , vdev_guid ; er_timeval_t pool_load ; er_timeval_t er_when ; nvlist_t * detector ; boolean_t pool_found = B_FALSE ; boolean_t isresource ; boolean_t is_inactive_spare , islog , iscache ; nvlist_t * vd_nvl = NULL ; char * fru , * type , * vdg ; find_cbdata_t cb ; if ( fmd_nvl_class_match ( hdl , nvl , "resource.sysevent.EC_zfs.*" ) ) { zfs_stats . resource_drops . fmds_value . ui64 ++ ; return ; } isresource = fmd_nvl_class_match ( hdl , nvl , "resource.fs.zfs.*" ) ; if ( isresource ) { if ( nvlist_lookup_uint64 ( nvl , FM_EREPORT_PAYLOAD_ZFS_VDEV_GUID , & vdev_guid ) != 0 ) { pool_state = SPA_LOAD_OPEN ; } else { pool_state = SPA_LOAD_NONE ; } detector = NULL ; } else { ( void ) nvlist_lookup_nvlist ( nvl , FM_EREPORT_DETECTOR , & detector ) ; ( void ) nvlist_lookup_int32 ( nvl , FM_EREPORT_PAYLOAD_ZFS_POOL_CONTEXT , & pool_state ) ; } if ( pool_state == SPA_LOAD_IMPORT ) { zfs_stats . import_drops . fmds_value . ui64 ++ ; return ; } if ( pool_state == SPA_LOAD_OPEN && ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_CHECKSUM ) ) || fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_IO ) ) || fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_PROBE_FAILURE ) ) ) ) { zfs_stats . dev_drops . fmds_value . ui64 ++ ; return ; } if ( nvlist_lookup_string ( nvl , FM_EREPORT_PAYLOAD_ZFS_VDEV_TYPE , & type ) == 0 ) { if ( strcmp ( type , VDEV_TYPE_DISK ) != 0 && strcmp ( type , VDEV_TYPE_FILE ) != 0 ) { zfs_stats . vdev_drops . fmds_value . ui64 ++ ; return ; } } ( void ) nvlist_lookup_uint64 ( nvl , FM_EREPORT_PAYLOAD_ZFS_POOL_GUID , & pool_guid ) ; if ( nvlist_lookup_uint64 ( nvl , FM_EREPORT_PAYLOAD_ZFS_VDEV_GUID , & vdev_guid ) != 0 ) { vdev_guid = 0 ; } if ( nvlist_lookup_uint64 ( nvl , FM_EREPORT_ENA , & ena ) != 0 ) { ena = 0 ; } zfs_ereport_when ( hdl , nvl , & er_when ) ; for ( zcp = uu_list_first ( zfs_cases ) ; zcp != NULL ; zcp = uu_list_next ( zfs_cases , zcp ) ) { if ( zcp -> zc_data . zc_pool_guid == pool_guid ) { pool_found = B_TRUE ; pool_load = zcp -> zc_when ; } if ( zcp -> zc_data . zc_vdev_guid == vdev_guid && zcp -> zc_data . zc_pool_guid == pool_guid ) { break ; } } if ( pool_found ) { fmd_hdl_debug ( hdl , "pool %llx, " "ereport time %lld.%lld, pool load time = %lld.%lld\n" , pool_guid , er_when . ertv_sec , er_when . ertv_nsec , pool_load . ertv_sec , pool_load . ertv_nsec ) ; } if ( pool_found && timeval_earlier ( & er_when , & pool_load ) ) { zfs_stats . old_drops . fmds_value . ui64 ++ ; return ; } if ( ! pool_found ) { libzfs_handle_t * zhdl = fmd_hdl_getspecific ( hdl ) ; struct load_time_arg la ; la . lt_guid = pool_guid ; la . lt_time = & pool_load ; la . lt_found = B_FALSE ; if ( zhdl != NULL && zpool_iter ( zhdl , zpool_find_load_time , & la ) == 0 && la . lt_found == B_TRUE ) { pool_found = B_TRUE ; fmd_hdl_debug ( hdl , "pool %llx, " "ereport time %lld.%lld, " "pool load time = %lld.%lld\n" , pool_guid , er_when . ertv_sec , er_when . ertv_nsec , pool_load . ertv_sec , pool_load . ertv_nsec ) ; if ( timeval_earlier ( & er_when , & pool_load ) ) { zfs_stats . old_drops . fmds_value . ui64 ++ ; return ; } } } if ( zcp == NULL ) { fmd_case_t * cs ; zfs_case_data_t data = { 0 } ; if ( isresource ) { zfs_stats . resource_drops . fmds_value . ui64 ++ ; return ; } cs = fmd_case_open ( hdl , NULL ) ; fmd_buf_create ( hdl , cs , CASE_DATA , sizeof ( zfs_case_data_t ) ) ; data . zc_version = CASE_DATA_VERSION_SERD ; data . zc_ena = ena ; data . zc_pool_guid = pool_guid ; data . zc_vdev_guid = vdev_guid ; data . zc_pool_state = ( int ) pool_state ; fmd_buf_write ( hdl , cs , CASE_DATA , & data , sizeof ( data ) ) ; zcp = zfs_case_unserialize ( hdl , cs ) ; assert ( zcp != NULL ) ; if ( pool_found ) { zcp -> zc_when = pool_load ; } } if ( nvlist_lookup_string ( nvl , FM_EREPORT_PAYLOAD_ZFS_VDEV_FRU , & fru ) == 0 ) { topo_hdl_t * thp = fmd_hdl_topo_hold ( hdl , TOPO_VERSION ) ; if ( zcp -> zc_fru == NULL || ! topo_fmri_strcmp ( thp , zcp -> zc_fru , fru ) ) { if ( zcp -> zc_fru != NULL ) { fmd_hdl_strfree ( hdl , zcp -> zc_fru ) ; fmd_buf_destroy ( hdl , zcp -> zc_case , CASE_FRU ) ; } zcp -> zc_fru = fmd_hdl_strdup ( hdl , fru , FMD_SLEEP ) ; zfs_case_serialize ( hdl , zcp ) ; } fmd_hdl_topo_rele ( hdl , thp ) ; } if ( isresource ) { if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_RSRC ( FM_RESOURCE_AUTOREPLACE ) ) ) { fmd_case_close ( hdl , zcp -> zc_case ) ; } if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_RSRC ( FM_RESOURCE_REMOVED ) ) ) { if ( zcp -> zc_data . zc_has_remove_timer ) { fmd_timer_remove ( hdl , zcp -> zc_remove_timer ) ; zcp -> zc_data . zc_has_remove_timer = 0 ; zfs_case_serialize ( hdl , zcp ) ; } if ( zcp -> zc_data . zc_serd_io [ 0 ] != '\0' ) { fmd_serd_reset ( hdl , zcp -> zc_data . zc_serd_io ) ; } if ( zcp -> zc_data . zc_serd_checksum [ 0 ] != '\0' ) { fmd_serd_reset ( hdl , zcp -> zc_data . zc_serd_checksum ) ; } if ( zcp -> zc_data . zc_serd_probe [ 0 ] != '\0' ) { fmd_serd_reset ( hdl , zcp -> zc_data . zc_serd_probe ) ; } } zfs_stats . resource_drops . fmds_value . ui64 ++ ; return ; } fmd_case_add_ereport ( hdl , zcp -> zc_case , ep ) ; if ( fmd_case_solved ( hdl , zcp -> zc_case ) ) { return ; } zhdl = fmd_hdl_getspecific ( hdl ) ; cb . cb_guid = pool_guid ; cb . cb_zhp = NULL ; if ( zhdl != NULL && zpool_iter ( zhdl , find_pool , & cb ) != 0 ) { zfs_stats . pool_drops . fmds_value . ui64 ++ ; return ; } zhp = cb . cb_zhp ; if ( zhp != NULL ) { vdg = fmd_hdl_zalloc ( hdl , MAX_ULL_STR , FMD_SLEEP ) ; ( void ) snprintf ( vdg , MAX_ULL_STR , "%" PRIx64 , vdev_guid ) ; if ( ( vd_nvl = zpool_find_vdev ( zhp , vdg , & is_inactive_spare , & islog , & iscache ) ) != NULL ) { nvlist_free ( vd_nvl ) ; } fmd_hdl_free ( hdl , vdg , MAX_ULL_STR ) ; } if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_POOL ) ) ) { for ( dcp = uu_list_first ( zfs_cases ) ; dcp != NULL ; dcp = uu_list_next ( zfs_cases , dcp ) ) { if ( dcp -> zc_data . zc_pool_guid == zcp -> zc_data . zc_pool_guid && dcp -> zc_data . zc_vdev_guid != 0 ) { fmd_case_close ( hdl , dcp -> zc_case ) ; } } zfs_case_solve ( hdl , zcp , "fault.fs.zfs.pool" , B_TRUE ) ; } if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_LOG_REPLAY ) ) ) { zfs_case_solve ( hdl , zcp , "fault.fs.zfs.log_replay" , B_TRUE ) ; } if ( fmd_nvl_class_match ( hdl , nvl , "ereport.fs.zfs.vdev.*" ) ) { zfs_case_solve ( hdl , zcp , "fault.fs.zfs.device" , B_TRUE ) ; } if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_IO ) ) || fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_CHECKSUM ) ) || fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_IO_FAILURE ) ) || fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_PROBE_FAILURE ) ) ) { char * failmode = NULL ; boolean_t checkremove = B_FALSE ; if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_IO ) ) ) { if ( zcp -> zc_data . zc_serd_io [ 0 ] == '\0' ) { zfs_serd_name ( zcp -> zc_data . zc_serd_io , pool_guid , vdev_guid , "io" ) ; fmd_serd_create ( hdl , zcp -> zc_data . zc_serd_io , fmd_prop_get_int32 ( hdl , "io_N" ) , fmd_prop_get_int64 ( hdl , "io_T" ) ) ; zfs_case_serialize ( hdl , zcp ) ; } if ( fmd_serd_record ( hdl , zcp -> zc_data . zc_serd_io , ep ) ) { checkremove = B_TRUE ; } } if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_CHECKSUM ) ) ) { if ( zcp -> zc_data . zc_serd_checksum [ 0 ] == '\0' ) { zfs_serd_name ( zcp -> zc_data . zc_serd_checksum , pool_guid , vdev_guid , "checksum" ) ; fmd_serd_create ( hdl , zcp -> zc_data . zc_serd_checksum , fmd_prop_get_int32 ( hdl , "checksum_N" ) , fmd_prop_get_int64 ( hdl , "checksum_T" ) ) ; zfs_case_serialize ( hdl , zcp ) ; } if ( fmd_serd_record ( hdl , zcp -> zc_data . zc_serd_checksum , ep ) ) { zfs_case_solve ( hdl , zcp , "fault.fs.zfs.vdev.checksum" , B_FALSE ) ; } } if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_IO_FAILURE ) ) && ( nvlist_lookup_string ( nvl , FM_EREPORT_PAYLOAD_ZFS_POOL_FAILMODE , & failmode ) == 0 ) && failmode != NULL ) { if ( strncmp ( failmode , FM_EREPORT_FAILMODE_CONTINUE , strlen ( FM_EREPORT_FAILMODE_CONTINUE ) ) == 0 ) { zfs_case_solve ( hdl , zcp , "fault.fs.zfs.io_failure_continue" , B_FALSE ) ; } if ( strncmp ( failmode , FM_EREPORT_FAILMODE_WAIT , strlen ( FM_EREPORT_FAILMODE_WAIT ) ) == 0 ) { zfs_case_solve ( hdl , zcp , "fault.fs.zfs.io_failure_wait" , B_FALSE ) ; } } if ( fmd_nvl_class_match ( hdl , nvl , ZFS_MAKE_EREPORT ( FM_EREPORT_ZFS_PROBE_FAILURE ) ) ) { if ( zcp -> zc_data . zc_serd_probe [ 0 ] == '\0' ) { zfs_serd_name ( zcp -> zc_data . zc_serd_probe , pool_guid , vdev_guid , "probe" ) ; fmd_serd_create ( hdl , zcp -> zc_data . zc_serd_probe , fmd_prop_get_int32 ( hdl , "probe_N" ) , fmd_prop_get_int64 ( hdl , "probe_T" ) ) ; zfs_case_serialize ( hdl , zcp ) ; } if ( ! is_inactive_spare || fmd_serd_record ( hdl , zcp -> zc_data . zc_serd_probe , ep ) ) { checkremove = B_TRUE ; } } if ( checkremove ) { if ( zcp -> zc_data . zc_has_remove_timer ) { fmd_timer_remove ( hdl , zcp -> zc_remove_timer ) ; } zcp -> zc_remove_timer = fmd_timer_install ( hdl , zcp , NULL , zfs_remove_timeout ) ; if ( ! zcp -> zc_data . zc_has_remove_timer ) { zcp -> zc_data . zc_has_remove_timer = 1 ; zfs_case_serialize ( hdl , zcp ) ; } } } } 