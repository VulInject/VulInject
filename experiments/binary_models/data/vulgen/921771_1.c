int appldata_register_ops ( struct appldata_ops * ops ) { ops -> ctl_table = kcalloc ( 4 , sizeof ( ctl_table ) , GFP_KERNEL ) ; if ( ! ops -> ctl_table ) { return - ENOMEM ; } mutex_lock ( & appldata_ops_mutex ) ; list_add ( & ops -> list , & appldata_ops_list ) ; mutex_unlock ( & appldata_ops_mutex ) ; ops -> ctl_table [ 0 ] . procname = appldata_proc_name ; ops -> ctl_table [ 0 ] . maxlen = 0 ; ops -> ctl_table [ 0 ] . mode = S_IRUGO | S_IXUGO ; ops -> ctl_table [ 0 ] . child = & ops -> ctl_table [ 2 ] ; ops -> ctl_table [ 2 ] . procname = ops -> name ; ops -> ctl_table [ 2 ] . mode = S_IRUGO | S_IWUSR ; ops -> ctl_table [ 2 ] . proc_handler = appldata_generic_handler ; ops -> ctl_table [ 2 ] . data = ops ; ops -> sysctl_header = register_sysctl_table ( ops -> ctl_table ) ; if ( ! ops -> sysctl_header ) { out } return 0 ; out mutex_lock ( & appldata_ops_mutex ) ; list_del ( & ops -> list ) ; mutex_unlock ( & appldata_ops_mutex ) ; kfree ( ops -> ctl_table ) ; return - ENOMEM ; } 