static void set_legacy_service ( scf_propertygroup_t * pg , const char * script , ino_t inode ) { scf_handle_t * h ; const char * func ; char * suffix ; scf_transaction_t * tx ; struct timeval tstamp ; ctid_t ctid ; char * svc_name = NULL ; int ret ; h = scf_pg_handle ( pg ) ; if ( h == NULL ) { func = "scf_pg_handle()" ; scferr } ret = gettimeofday ( & tstamp , NULL ) ; assert ( ret == 0 ) ; if ( errno = contract_latest ( & ctid ) ) { uu_warn ( gettext ( "Could not get contract" ) ) ; err } tx = scf_transaction_create ( h ) ; if ( tx == NULL ) { func = "scf_transaction_create()" ; scferr } if ( scf_transaction_start ( tx , pg ) != 0 ) { func = "scf_transaction_start()" ; scferr } svc_name = path_to_svc_name ( script ) ; if ( add_new_property ( h , tx , SCF_LEGACY_PROPERTY_NAME , SCF_TYPE_ASTRING , ( void * ) ( svc_name ?svc_name : script ) ) != 0 ) { err } if ( add_new_property ( h , tx , SCF_PROPERTY_STATE_TIMESTAMP , SCF_TYPE_TIME , & tstamp ) != 0 ) { err } if ( add_new_property ( h , tx , SCF_LEGACY_PROPERTY_INODE , SCF_TYPE_COUNT , ( void * ) inode ) != 0 ) { err } if ( ( suffix = script_suffix ( script ) ) != NULL ) { if ( add_new_property ( h , tx , SCF_LEGACY_PROPERTY_SUFFIX , SCF_TYPE_ASTRING , ( void * ) suffix ) != 0 ) { err } } if ( add_new_property ( h , tx , SCF_PROPERTY_CONTRACT , SCF_TYPE_COUNT , ( void * ) ctid ) != 0 ) { err } for ( ; ; ) { switch ( scf_transaction_commit ( tx ) ) { case 1 : free ( svc_name ) ; return ; case 0 : if ( scf_pg_update ( pg ) == - 1 ) { func = "scf_pg_update()" ; scferr } continue ; case - 1 : func = "scf_transaction_commit()" ; scferr default : assert ( 0 ) ; abort ( ) ; } } scferr uu_warn ( gettext ( "%s failed (%s).\n" ) , func , scf_strerror ( scf_error ( ) ) ) ; err uu_die ( gettext ( "Could not commit property values to repository.\n" ) ) ; } 