DUK_LOCAL void duk__add_fileline ( duk_hthread * thr , duk_hthread * thr_callstack , const char * c_filename , duk_int_t c_line , duk_bool_t noblame_fileline ) { duk_context * ctx ; duk_int_t entry_top ; ctx = ( duk_context * ) thr ; entry_top = duk_get_top ( ctx ) ; if ( thr -> compile_ctx != NULL && thr -> compile_ctx -> h_filename != NULL ) { duk_push_uint ( ctx , ( duk_uint_t ) thr -> compile_ctx -> curr_token . start_line ) ; duk_push_hstring ( ctx , thr -> compile_ctx -> h_filename ) ; } if ( c_filename && ! noblame_fileline ) { duk_push_int ( ctx , c_line ) ; duk_push_string ( ctx , c_filename ) ; } else { duk_small_uint_t depth ; duk_int_t i , i_min ; duk_uint32_t ecma_line ; depth = DUK_USE_TRACEBACK_DEPTH ; i_min = ( thr_callstack -> callstack_top > ( duk_size_t ) depth ?( duk_int_t ) ( thr_callstack -> callstack_top - depth ) : 0 ) ; DUK_ASSERT ( i_min >= 0 ) ; DUK_ASSERT ( thr_callstack -> callstack_top <= DUK_INT_MAX ) ; for ( i = ( duk_int_t ) ( thr_callstack -> callstack_top - 1 ) ; i >= i_min ; i -- ) { duk_activation * act ; duk_hobject * func ; duk_uint32_t pc ; DUK_UNREF ( pc ) ; act = thr_callstack -> callstack + i ; DUK_ASSERT ( act >= thr_callstack -> callstack && act < thr_callstack -> callstack + thr_callstack -> callstack_size ) ; func = DUK_ACT_GET_FUNC ( act ) ; pc = duk_hthread_get_act_prev_pc ( thr , act ) ; DUK_ASSERT_DISABLE ( pc >= 0 ) ; DUK_ASSERT ( ( duk_double_t ) pc < DUK_DOUBLE_2TO32 ) ; act = NULL ; duk_push_hobject ( ctx , func ) ; duk_get_prop_stridx ( ctx , - 1 , DUK_STRIDX_FILE_NAME ) ; if ( ! duk_is_string ( ctx , - 1 ) ) { duk_pop_2 ( ctx ) ; continue ; } ecma_line = 0 ; if ( DUK_HOBJECT_IS_COMPILEDFUNCTION ( func ) ) { ecma_line = duk_hobject_pc2line_query ( ctx , - 2 , ( duk_uint_fast32_t ) pc ) ; } else { } duk_push_u32 ( ctx , ecma_line ) ; duk_replace ( ctx , - 3 ) ; define_props } duk_push_undefined ( ctx ) ; duk_push_undefined ( ctx ) ; } define_props DUK_ASSERT ( duk_get_top ( ctx ) == entry_top + 2 ) ; duk_xdef_prop_stridx ( ctx , - 3 , DUK_STRIDX_FILE_NAME , DUK_PROPDESC_FLAGS_WC | DUK_PROPDESC_FLAG_NO_OVERWRITE ) ; duk_xdef_prop_stridx ( ctx , - 2 , DUK_STRIDX_LINE_NUMBER , DUK_PROPDESC_FLAGS_WC | DUK_PROPDESC_FLAG_NO_OVERWRITE ) ; } 