vms_object_p ( ) { int err = 0 ; int prev_type ; const bfd_arch_info_type * arch = NULL ; void * tdata_save = abfd -> tdata . any ; bfd_vma saddr_save = bfd_get_start_address ( abfd ) ; vms_debug ( 1 , "vms_object_p (%p)\n" , abfd ) ; if ( ! vms_initialize ( abfd ) ) { error_ret } if ( bfd_seek ( abfd , ( file_ptr ) 0 , SEEK_SET ) ) { err_wrong_format } prev_type = - 1 ; { vms_debug ( 7 , "reading at %08lx\n" , bfd_tell ( abfd ) ) ; if ( _bfd_vms_next_record ( abfd ) < 0 ) { vms_debug ( 2 , "next_record failed\n" ) ; err_wrong_format } if ( ( prev_type == EOBJ_S_C_EGSD ) && ( PRIV ( rec_type ) != EOBJ_S_C_EGSD ) ) { if ( ! vms_fixup_sections ( abfd ) ) { vms_debug ( 2 , "vms_fixup_sections failed\n" ) ; err_wrong_format } } prev_type = PRIV ( rec_type ) ; if ( target_vector == NULL ) { if ( prev_type <= OBJ_S_C_MAXRECTYP ) { target_vector = & vms_vax_vec ; } else { target_vector = & vms_alpha_vec ; } } switch ( prev_type ) { case OBJ_S_C_HDR : case EOBJ_S_C_EMH : err = _bfd_vms_slurp_hdr ( abfd , prev_type ) ; break ; case OBJ_S_C_EOM : case OBJ_S_C_EOMW : case EOBJ_S_C_EEOM : err = _bfd_vms_slurp_eom ( abfd , prev_type ) ; break ; case OBJ_S_C_GSD : case EOBJ_S_C_EGSD : err = _bfd_vms_slurp_gsd ( abfd , prev_type ) ; break ; case OBJ_S_C_TIR : case EOBJ_S_C_ETIR : err = _bfd_vms_slurp_tir ( abfd , prev_type ) ; break ; case OBJ_S_C_DBG : case EOBJ_S_C_EDBG : err = _bfd_vms_slurp_dbg ( abfd , prev_type ) ; break ; case OBJ_S_C_TBT : case EOBJ_S_C_ETBT : err = _bfd_vms_slurp_tbt ( abfd , prev_type ) ; break ; case OBJ_S_C_LNK : err = _bfd_vms_slurp_lnk ( abfd , prev_type ) ; break ; default : err = - 1 ; } if ( err != 0 ) { vms_debug ( 2 , "slurp type %d failed with %d\n" , prev_type , err ) ; err_wrong_format } } ( prev_type != EOBJ_S_C_EEOM ) && ( prev_type != OBJ_S_C_EOM ) && ( prev_type != OBJ_S_C_EOMW ) ; if ( target_vector == & vms_vax_vec ) { if ( ! vms_fixup_sections ( abfd ) ) { vms_debug ( 2 , "vms_fixup_sections failed\n" ) ; err_wrong_format } arch = bfd_scan_arch ( "vax" ) ; PRIV ( is_vax ) = TRUE ; vms_debug ( 2 , "arch is vax\n" ) ; } if ( target_vector == & vms_alpha_vec ) { arch = bfd_scan_arch ( "alpha" ) ; PRIV ( is_vax ) = FALSE ; vms_debug ( 2 , "arch is alpha\n" ) ; } if ( arch == NULL ) { vms_debug ( 2 , "arch not found\n" ) ; err_wrong_format } abfd -> arch_info = arch ; return target_vector ; err_wrong_format bfd_set_error ( bfd_error_wrong_format ) ; error_ret if ( abfd -> tdata . any != tdata_save && abfd -> tdata . any != NULL ) { bfd_release ( abfd , abfd -> tdata . any ) ; } abfd -> tdata . any = tdata_save ; bfd_set_start_address ( abfd , saddr_save ) ; return NULL ; } 