static void plx_dma_process_desc ( struct plx_dma_dev * plxdev ) { struct dmaengine_result res ; struct plx_dma_desc * desc ; u32 flags ; spin_lock ( & plxdev -> ring_lock ) ; while ( plxdev -> tail != plxdev -> head ) { desc = plx_dma_get_desc ( plxdev , plxdev -> tail ) ; flags = le32_to_cpu ( READ_ONCE ( desc -> hw -> flags_and_size ) ) ; if ( flags & PLX_DESC_FLAG_VALID ) { break ; } res . residue = desc -> orig_size - ( flags & PLX_DESC_SIZE_MASK ) ; if ( flags & PLX_DESC_WB_SUCCESS ) { res . result = DMA_TRANS_NOERROR ; } if ( flags & PLX_DESC_WB_WR_FAIL ) { res . result = DMA_TRANS_WRITE_FAILED ; } else { res . result = DMA_TRANS_READ_FAILED ; } dma_cookie_complete ( & desc -> txd ) ; dmaengine_desc_get_callback_invoke ( & desc -> txd , & res ) ; desc -> txd . callback = NULL ; desc -> txd . callback_result = NULL ; plxdev -> tail ++ ; } spin_unlock ( & plxdev -> ring_lock ) ; } 