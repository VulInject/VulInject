static noinline_for_stack int ethtool_get_rxfh ( struct net_device * dev , void __user * useraddr ) { int ret ; const struct ethtool_ops * ops = dev -> ethtool_ops ; u32 user_indir_size , user_key_size ; u32 dev_indir_size = 0 , dev_key_size = 0 ; struct ethtool_rxfh rxfh ; u32 total_size ; u32 indir_bytes ; u32 * indir = NULL ; u8 dev_hfunc = 0 ; u8 * hkey = NULL ; u8 * rss_config ; if ( ops -> get_rxfh_indir_size ) { dev_indir_size = ops -> get_rxfh_indir_size ( dev ) ; } if ( ops -> get_rxfh_key_size ) { dev_key_size = ops -> get_rxfh_key_size ( dev ) ; } if ( copy_from_user ( & rxfh , useraddr , sizeof ( rxfh ) ) ) { return - EFAULT ; } user_indir_size = rxfh . indir_size ; user_key_size = rxfh . key_size ; if ( rxfh . rss_context || rxfh . rsvd8 [ 0 ] || rxfh . rsvd8 [ 1 ] || rxfh . rsvd8 [ 2 ] || rxfh . rsvd32 ) { return - EINVAL ; } rxfh . indir_size = dev_indir_size ; rxfh . key_size = dev_key_size ; if ( copy_to_user ( useraddr , & rxfh , sizeof ( rxfh ) ) ) { return - EFAULT ; } if ( ( user_indir_size && ( user_indir_size != dev_indir_size ) ) || ( user_key_size && ( user_key_size != dev_key_size ) ) ) { return - EINVAL ; } indir_bytes = user_indir_size * sizeof ( indir [ 0 ] ) ; total_size = indir_bytes + user_key_size ; rss_config = kzalloc ( total_size , GFP_USER ) ; if ( ! rss_config ) { return - ENOMEM ; } if ( user_indir_size ) { indir = ( u32 * ) rss_config ; } if ( user_key_size ) { hkey = rss_config + indir_bytes ; } ret = dev -> ethtool_ops -> get_rxfh ( dev , indir , hkey , & dev_hfunc ) ; if ( ret ) { out } if ( copy_to_user ( useraddr + offsetof ( ethtool_rxfh , hfunc ) , & dev_hfunc , sizeof ( rxfh . hfunc ) ) ) { ret = - EFAULT ; } if ( copy_to_user ( useraddr + offsetof ( ethtool_rxfh , rss_config [ 0 ] ) , rss_config , total_size ) ) { ret = - EFAULT ; } out kfree ( rss_config ) ; return ret ; } 