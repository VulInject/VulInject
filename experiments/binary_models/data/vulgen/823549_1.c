static DEFINE_SPINLOCK ( sid_lock ) ; unsigned long alloc_sid ( void ) { unsigned long index ; spin_lock ( & sid_lock ) ; if ( free_space_ids == 0 ) { if ( dirty_space_ids != 0 ) { spin_unlock ( & sid_lock ) ; spin_lock ( & sid_lock ) ; } BUG_ON ( free_space_ids == 0 ) ; } free_space_ids -- ; index = find_next_zero_bit ( space_id , NR_SPACE_IDS , space_id_index ) ; space_id [ index >> SHIFT_PER_LONG ] |= ( 1L << ( index & ( BITS_PER_LONG - 1 ) ) ) ; space_id_index = index ; spin_unlock ( & sid_lock ) ; return index << SPACEID_SHIFT ; } 