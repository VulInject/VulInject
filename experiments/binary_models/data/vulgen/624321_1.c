extern char * concat ( char * , char * ) static int compile ( char * , char * ) static void compose ( char * [ ] , List , List , List ) static void error ( char * , char * ) static char * exists ( char * ) static char * first ( char * ) static int filename ( char * , char * ) static List find ( char * , List ) static void help ( void ) static void initinputs ( void ) static void interrupt ( int ) static void opt ( char * ) static List path2list ( const char * ) extern int main ( int , char * [ ] ) extern char * replace ( const char * , int , int ) static void rm ( List ) extern char * strsave ( const char * ) extern char * stringf ( const char * , ... ) extern int suffix ( char * , char * [ ] , int ) extern char * tempname ( char * ) extern int getpid ( void ) extern char * cpp [ ] , * include [ ] , * com [ ] , * as [ ] , * ld [ ] , inputs [ ] , * suffixes [ ] ; extern int option ( char * ) static int errcnt ; static int Eflag ; static int Sflag = 1 ; static int cflag ; static int verbose ; static List llist [ 2 ] ; static List alist ; static List clist ; static List plist ; static List ilist ; static List rmlist ; static char * outfile ; static int ac ; static char * * av ; char * tempdir = TEMPDIR ; static char * progname ; static List lccinputs ; extern void UpdatePaths ( const char * lccBinary ) int main ( int argc , char * argv [ ] ) { int i , j , nf ; progname = argv [ 0 ] ; UpdatePaths ( progname ) ; ac = argc + 50 ; av = alloc ( ac * sizeof ( char * ) ) ; if ( signal ( SIGINT , SIG_IGN ) != SIG_IGN ) { signal ( SIGINT , interrupt ) ; } if ( signal ( SIGTERM , SIG_IGN ) != SIG_IGN ) { signal ( SIGTERM , interrupt ) ; } if ( signal ( SIGHUP , SIG_IGN ) != SIG_IGN ) { signal ( SIGHUP , interrupt ) ; } if ( getenv ( "TEMP" ) ) { tempdir = getenv ( "TEMP" ) ; } if ( getenv ( "TMPDIR" ) ) { tempdir = getenv ( "TMPDIR" ) ; } assert ( tempdir ) ; i = strlen ( tempdir ) ; for ( ; ( i > 0 && tempdir [ i - 1 ] == '/' ) || tempdir [ i - 1 ] == '\\' ; i -- ) { tempdir [ i - 1 ] = '\0' ; } if ( argc <= 1 ) { help ( ) ; exit ( 0 ) ; } plist = append ( "-D__LCC__" , 0 ) ; initinputs ( ) ; if ( getenv ( "LCCDIR" ) ) { option ( stringf ( "-lccdir=%s" , getenv ( "LCCDIR" ) ) ) ; } for ( nf = 0 , i = j = 1 ; i < argc ; i ++ ) { if ( strcmp ( argv [ i ] , "-o" ) == 0 ) { if ( ++ i < argc ) { if ( suffix ( argv [ i ] , suffixes , 2 ) >= 0 ) { error ( "-o would overwrite %s" , argv [ i ] ) ; exit ( 8 ) ; } outfile = argv [ i ] ; continue ; } else { error ( "unrecognized option `%s'" , argv [ i - 1 ] ) ; exit ( 8 ) ; } } if ( strcmp ( argv [ i ] , "-target" ) == 0 ) { if ( argv [ i + 1 ] && * argv [ i + 1 ] != '-' ) { i ++ ; } continue ; } if ( * argv [ i ] == '-' && argv [ i ] [ 1 ] != 'l' ) { opt ( argv [ i ] ) ; continue ; } if ( * argv [ i ] != '-' && suffix ( argv [ i ] , suffixes , 3 ) >= 0 ) { nf ++ ; } argv [ j ++ ] = argv [ i ] ; } if ( ( cflag || Sflag ) && outfile && nf != 1 ) { fprintf ( stderr , "%s: -o %s ignored\n" , progname , outfile ) ; outfile = 0 ; } argv [ j ] = 0 ; for ( i = 0 ; include [ i ] ; i ++ ) { plist = append ( include [ i ] , plist ) ; } if ( ilist ) { List b = ilist ; { b = b -> link ; plist = append ( b -> str , plist ) ; } b != ilist ; } ilist = 0 ; for ( i = 1 ; argv [ i ] ; i ++ ) { if ( * argv [ i ] == '-' ) { opt ( argv [ i ] ) ; } else { char * name = exists ( argv [ i ] ) ; if ( name ) { if ( strcmp ( name , argv [ i ] ) != 0 || ( nf > 1 && suffix ( name , suffixes , 3 ) >= 0 ) ) { fprintf ( stderr , "%s:\n" , name ) ; } filename ( name , 0 ) ; } else { error ( "can't find `%s'" , argv [ i ] ) ; } } } if ( errcnt == 0 && ! Eflag && ! Sflag && ! cflag && llist [ 1 ] ) { compose ( ld , llist [ 0 ] , llist [ 1 ] , append ( outfile ?outfile : concat ( "a" , first ( suffixes [ 4 ] ) ) , 0 ) ) ; if ( callsys ( av ) ) { errcnt ++ ; } } rm ( rmlist ) ; return errcnt ?EXIT_FAILURE : EXIT_SUCCESS ; } 