int xfs_dir2_block_to_leaf ( xfs_da_args_t * args , struct xfs_buf * dbp ) { __be16 * bestsp ; xfs_dablk_t blkno ; xfs_dir2_data_hdr_t * hdr ; xfs_dir2_leaf_entry_t * blp ; xfs_dir2_block_tail_t * btp ; xfs_inode_t * dp ; int error ; struct xfs_buf * lbp ; xfs_dir2_db_t ldb ; xfs_dir2_leaf_t * leaf ; xfs_dir2_leaf_tail_t * ltp ; int needlog ; int needscan ; xfs_trans_t * tp ; struct xfs_dir2_data_free * bf ; struct xfs_dir2_leaf_entry * ents ; struct xfs_dir3_icleaf_hdr leafhdr ; trace_xfs_dir2_block_to_leaf ( args ) ; dp = args -> dp ; tp = args -> trans ; ldb = xfs_dir2_da_to_db ( args -> geo , blkno ) ; ASSERT ( ldb == xfs_dir2_byte_to_db ( args -> geo , XFS_DIR2_LEAF_OFFSET ) ) ; error = xfs_dir3_leaf_get_buf ( args , ldb , & lbp , XFS_DIR2_LEAF1_MAGIC ) ; if ( error ) { return error ; } leaf = lbp -> b_addr ; hdr = dbp -> b_addr ; xfs_dir3_data_check ( dp , dbp ) ; btp = xfs_dir2_block_tail_p ( args -> geo , hdr ) ; blp = xfs_dir2_block_leaf_p ( btp ) ; bf = dp -> d_ops -> data_bestfree_p ( hdr ) ; ents = dp -> d_ops -> leaf_ents_p ( leaf ) ; dp -> d_ops -> leaf_hdr_from_disk ( & leafhdr , leaf ) ; leafhdr . count = be32_to_cpu ( btp -> count ) ; leafhdr . stale = be32_to_cpu ( btp -> stale ) ; dp -> d_ops -> leaf_hdr_to_disk ( leaf , & leafhdr ) ; xfs_dir3_leaf_log_header ( args , lbp ) ; memcpy ( ents , blp , be32_to_cpu ( btp -> count ) * sizeof ( xfs_dir2_leaf_entry_t ) ) ; xfs_dir3_leaf_log_ents ( args , lbp , 0 , leafhdr . count - 1 ) ; needscan = 0 ; needlog = 1 ; xfs_dir2_data_make_free ( args , dbp , ( xfs_dir2_data_aoff_t ) ( ( char * ) blp - ( char * ) hdr ) , ( xfs_dir2_data_aoff_t ) ( ( char * ) hdr + args -> geo -> blksize - ( char * ) blp ) , & needlog , & needscan ) ; dbp -> b_ops = & xfs_dir3_data_buf_ops ; xfs_trans_buf_set_type ( tp , dbp , XFS_BLFT_DIR_DATA_BUF ) ; if ( hdr -> magic == cpu_to_be32 ( XFS_DIR2_BLOCK_MAGIC ) ) { hdr -> magic = cpu_to_be32 ( XFS_DIR2_DATA_MAGIC ) ; } else { hdr -> magic = cpu_to_be32 ( XFS_DIR3_DATA_MAGIC ) ; } if ( needscan ) { xfs_dir2_data_freescan ( dp , hdr , & needlog ) ; } ltp = xfs_dir2_leaf_tail_p ( args -> geo , leaf ) ; ltp -> bestcount = cpu_to_be32 ( 1 ) ; bestsp = xfs_dir2_leaf_bests_p ( ltp ) ; bestsp [ 0 ] = bf [ 0 ] . length ; if ( needlog ) { xfs_dir2_data_log_header ( args , dbp ) ; } xfs_dir3_leaf_check ( dp , lbp ) ; xfs_dir3_data_check ( dp , dbp ) ; xfs_dir3_leaf_log_bests ( args , lbp , 0 , 0 ) ; return 0 ; } 