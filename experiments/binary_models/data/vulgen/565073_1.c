run_command ( , , ) { char commandLine [ 1024 ] ; char buffer [ 4096 ] ; DWORD dwRead = 0 ; DWORD dwLeft = 0 ; DWORD dwAvail = 0 ; time_t start ; double timeElapsed ; char * token ; char * context = NULL ; int announce = 0 ; HANDLE readPipe ; HANDLE writePipe ; STARTUPINFO sInfo ; PROCESS_INFORMATION pInfo ; SECURITY_ATTRIBUTES secattr ; ZeroMemory ( & secattr , sizeof ( secattr ) ) ; secattr . nLength = sizeof ( secattr ) ; secattr . bInheritHandle = TRUE ; timeElapsed = 0.0 ; if ( strlen ( word [ 2 ] ) > 0 ) { strcpy ( commandLine , "cmd.exe /c " ) ; if ( ! stricmp ( "-O" , word [ 2 ] ) ) { strcat ( commandLine , word_eol [ 3 ] ) ; announce = 1 ; } else { strcat ( commandLine , word_eol [ 2 ] ) ; } CreatePipe ( & readPipe , & writePipe , & secattr , 0 ) ; ZeroMemory ( & sInfo , sizeof ( sInfo ) ) ; ZeroMemory ( & pInfo , sizeof ( pInfo ) ) ; sInfo . cb = sizeof ( sInfo ) ; sInfo . dwFlags = STARTF_USESTDHANDLES ; sInfo . hStdInput = NULL ; sInfo . hStdOutput = writePipe ; sInfo . hStdError = writePipe ; CreateProcess ( 0 , commandLine , 0 , 0 , TRUE , NORMAL_PRIORITY_CLASS | CREATE_NO_WINDOW , 0 , 0 , & sInfo , & pInfo ) ; CloseHandle ( writePipe ) ; start = time ( 0 ) ; while ( PeekNamedPipe ( readPipe , buffer , 1 , & dwRead , & dwAvail , & dwLeft ) && timeElapsed < 10 ) { if ( dwRead ) { if ( ReadFile ( readPipe , buffer , sizeof ( buffer ) - 1 , & dwRead , NULL ) && dwRead != 0 ) { buffer [ dwRead ] = '\0' ; if ( announce ) { token = strtok_s ( buffer , "\n" , & context ) ; while ( token != NULL ) { hexchat_commandf ( ph , "SAY %s" , token ) ; token = strtok_s ( NULL , "\n" , & context ) ; } } else { hexchat_printf ( ph , "%s" , buffer ) ; } } } else { SleepEx ( 100 , TRUE ) ; } timeElapsed = difftime ( time ( 0 ) , start ) ; } if ( ! announce ) { hexchat_printf ( ph , "\n" ) ; } CloseHandle ( readPipe ) ; CloseHandle ( pInfo . hProcess ) ; CloseHandle ( pInfo . hThread ) ; } else { hexchat_command ( ph , "help exec" ) ; } return HEXCHAT_EAT_HEXCHAT ; } 