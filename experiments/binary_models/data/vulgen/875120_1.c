static BOOL freerdp_dsp_encode_ima_adpcm ( FREERDP_DSP_CONTEXT * context , const BYTE * src , size_t size , wStream * out ) { int i ; INT16 sample ; BYTE encoded ; size_t align ; align = ( context -> format . nChannels > 1 ) ?32 : 4 ; while ( size >= align ) { if ( Stream_GetPosition ( context -> buffer ) % context -> format . nBlockAlign == 0 ) { Stream_Write_UINT8 ( context -> buffer , context -> adpcm . ima . last_sample [ 0 ] & 0xFF ) ; Stream_Write_UINT8 ( context -> buffer , ( context -> adpcm . ima . last_sample [ 0 ] >> 8 ) & 0xFF ) ; Stream_Write_UINT8 ( context -> buffer , ( BYTE ) context -> adpcm . ima . last_step [ 0 ] ) ; Stream_Write_UINT8 ( context -> buffer , 0 ) ; if ( context -> format . nChannels > 1 ) { Stream_Write_UINT8 ( context -> buffer , context -> adpcm . ima . last_sample [ 1 ] & 0xFF ) ; Stream_Write_UINT8 ( context -> buffer , ( context -> adpcm . ima . last_sample [ 1 ] >> 8 ) & 0xFF ) ; Stream_Write_UINT8 ( context -> buffer , ( BYTE ) context -> adpcm . ima . last_step [ 1 ] ) ; Stream_Write_UINT8 ( context -> buffer , 0 ) ; } } if ( context -> format . nChannels > 1 ) { BYTE * dst = Stream_Pointer ( context -> buffer ) ; ZeroMemory ( dst , 8 ) ; for ( i = 0 ; i < 16 ; i ++ ) { sample = ( INT16 ) ( ( ( UINT16 ) ( * src ) ) | ( ( ( UINT16 ) ( * ( src + 1 ) ) ) << 8 ) ) ; src += 2 ; encoded = dsp_encode_ima_adpcm_sample ( & context -> adpcm , i % 2 , sample ) ; dst [ ima_stereo_encode_map [ i ] . byte_num ] |= encoded << ima_stereo_encode_map [ i ] . byte_shift ; } if ( ! Stream_SafeSeek ( context -> buffer , 8 ) ) { return FALSE ; } size -= 32 ; } else { sample = ( INT16 ) ( ( ( UINT16 ) ( * src ) ) | ( ( ( UINT16 ) ( * ( src + 1 ) ) ) << 8 ) ) ; src += 2 ; encoded = dsp_encode_ima_adpcm_sample ( & context -> adpcm , 0 , sample ) ; sample = ( INT16 ) ( ( ( UINT16 ) ( * src ) ) | ( ( ( UINT16 ) ( * ( src + 1 ) ) ) << 8 ) ) ; src += 2 ; encoded |= dsp_encode_ima_adpcm_sample ( & context -> adpcm , 0 , sample ) << 4 ; Stream_Write_UINT8 ( context -> buffer , encoded ) ; size -= 4 ; } if ( Stream_GetPosition ( context -> buffer ) >= context -> adpcm . ima . packet_size ) { BYTE * bsrc = Stream_Buffer ( context -> buffer ) ; Stream_Write ( out , bsrc , context -> adpcm . ima . packet_size ) ; Stream_SetPosition ( context -> buffer , 0 ) ; } } return TRUE ; } 