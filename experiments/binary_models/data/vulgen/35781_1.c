static void ti_hecc_start ( struct net_device * ndev ) { struct ti_hecc_priv * priv = netdev_priv ( ndev ) ; u32 cnt , mbxno , mbx_mask ; ti_hecc_reset ( ndev ) ; priv -> tx_head = HECC_TX_MASK ; priv -> tx_tail = HECC_TX_MASK ; hecc_write ( priv , HECC_CANGAM , HECC_SET_REG ) ; for ( cnt = 0 ; cnt < HECC_MAX_RX_MBOX ; cnt ++ ) { mbxno = HECC_MAX_MAILBOXES - 1 - cnt ; mbx_mask = BIT ( mbxno ) ; hecc_clear_bit ( priv , HECC_CANME , mbx_mask ) ; hecc_write_mbx ( priv , mbxno , HECC_CANMID , HECC_CANMID_AME ) ; hecc_write_lam ( priv , mbxno , HECC_SET_REG ) ; hecc_set_bit ( priv , HECC_CANMD , mbx_mask ) ; hecc_set_bit ( priv , HECC_CANME , mbx_mask ) ; hecc_set_bit ( priv , HECC_CANMIM , mbx_mask ) ; } hecc_set_bit ( priv , HECC_CANMIM , BIT ( HECC_MAX_TX_MBOX ) - 1 ) ; mbx_mask = ~ BIT ( HECC_RX_LAST_MBOX ) ; if ( priv -> use_hecc1int ) { hecc_write ( priv , HECC_CANMIL , HECC_SET_REG ) ; hecc_write ( priv , HECC_CANGIM , HECC_CANGIM_DEF_MASK | HECC_CANGIM_I1EN | HECC_CANGIM_SIL ) ; } else { hecc_write ( priv , HECC_CANMIL , 0 ) ; hecc_write ( priv , HECC_CANGIM , HECC_CANGIM_DEF_MASK | HECC_CANGIM_I0EN ) ; } priv -> can . state = CAN_STATE_ERROR_ACTIVE ; } 