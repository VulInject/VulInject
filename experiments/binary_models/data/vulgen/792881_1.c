static void magic_add_result ( struct magic_state * ms , struct magic_line * ml , const char * fmt , ... ) { va_list ap ; int separate ; char * s , * tmp , * add ; va_start ( ap , fmt ) ; if ( ml -> stringify ) { if ( vasprintf ( & s , fmt , ap ) == - 1 ) { va_end ( ap ) ; return ; } va_end ( ap ) ; if ( asprintf ( & tmp , ml -> result , s ) == - 1 ) { free ( s ) ; return ; } free ( s ) ; } else { if ( vasprintf ( & tmp , ml -> result , ap ) == - 1 ) { va_end ( ap ) ; return ; } va_end ( ap ) ; } separate = 1 ; if ( tmp [ 0 ] == '\\' && tmp [ 1 ] == 'b' ) { separate = 0 ; add = tmp + 2 ; } else { add = tmp ; } if ( separate && * ms -> out != '\0' ) { strlcat ( ms -> out , " " , sizeof ms -> out ) ; } strlcat ( ms -> out , add , sizeof ms -> out ) ; } 