static int of_platform_notify ( struct notifier_block * nb , unsigned long action , void * arg ) { struct of_reconfig_data * rd = arg ; struct platform_device * pdev_parent , * pdev ; bool children_left ; switch ( of_reconfig_get_state_change ( action , rd ) ) { case OF_RECONFIG_CHANGE_ADD : if ( ! of_node_check_flag ( rd -> dn -> parent , OF_POPULATED_BUS ) ) { return NOTIFY_OK ; } if ( of_node_check_flag ( rd -> dn , OF_POPULATED ) ) { return NOTIFY_OK ; } pdev_parent = of_find_device_by_node ( rd -> dn -> parent ) ; pdev = of_platform_device_create ( rd -> dn , NULL , pdev_parent ?& pdev_parent -> dev : NULL ) ; of_dev_put ( pdev_parent ) ; if ( pdev == NULL ) { pr_err ( "%s: failed to create for '%s'\n" , __func__ , rd -> dn -> full_name ) ; return notifier_from_errno ( - EINVAL ) ; } break ; case OF_RECONFIG_CHANGE_REMOVE : if ( ! of_node_check_flag ( rd -> dn , OF_POPULATED ) ) { return NOTIFY_OK ; } pdev = of_find_device_by_node ( rd -> dn ) ; if ( pdev == NULL ) { return NOTIFY_OK ; } of_dev_put ( pdev ) ; break ; } return NOTIFY_OK ; } 