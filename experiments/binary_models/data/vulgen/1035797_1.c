USBD_Status USBD_StdEPReq ( USB_OTG_CORE_HANDLE * pdev , USB_SETUP_REQ * req ) { uint8_t ep_addr ; USBD_Status ret = USBD_OK ; ep_addr = LOBYTE ( req -> wIndex ) ; switch ( req -> bRequest ) { case USB_REQ_SET_FEATURE : switch ( pdev -> dev . device_status ) { case USB_OTG_ADDRESSED : if ( ( ep_addr != 0x00 ) && ( ep_addr != 0x80 ) ) { DCD_EP_Stall ( pdev , ep_addr ) ; } break ; case USB_OTG_CONFIGURED : if ( req -> wValue == USB_FEATURE_EP_HALT ) { if ( ( ep_addr != 0x00 ) && ( ep_addr != 0x80 ) ) { DCD_EP_Stall ( pdev , ep_addr ) ; } } pdev -> dev . class_cb -> Setup ( pdev , req ) ; USBD_CtlSendStatus ( pdev ) ; break ; default : USBD_CtlError ( pdev , req ) ; break ; } break ; case USB_REQ_CLEAR_FEATURE : switch ( pdev -> dev . device_status ) { case USB_OTG_ADDRESSED : if ( ( ep_addr != 0x00 ) && ( ep_addr != 0x80 ) ) { DCD_EP_Stall ( pdev , ep_addr ) ; } break ; case USB_OTG_CONFIGURED : if ( req -> wValue == USB_FEATURE_EP_HALT ) { if ( ( ep_addr != 0x00 ) && ( ep_addr != 0x80 ) ) { pdev -> dev . class_cb -> Setup ( pdev , req ) ; } USBD_CtlSendStatus ( pdev ) ; } break ; default : USBD_CtlError ( pdev , req ) ; break ; } break ; case USB_REQ_GET_STATUS : switch ( pdev -> dev . device_status ) { case USB_OTG_ADDRESSED : if ( ( ep_addr != 0x00 ) && ( ep_addr != 0x80 ) ) { DCD_EP_Stall ( pdev , ep_addr ) ; } break ; case USB_OTG_CONFIGURED : if ( ( ep_addr & 0x80 ) == 0x80 ) { if ( pdev -> dev . in_ep [ ep_addr & 0x7F ] . is_stall ) { USBD_ep_status = 0x0001 ; } else { USBD_ep_status = 0x0000 ; } } if ( ( ep_addr & 0x80 ) == 0x00 ) { if ( pdev -> dev . out_ep [ ep_addr ] . is_stall ) { USBD_ep_status = 0x0001 ; } else { USBD_ep_status = 0x0000 ; } } USBD_CtlSendData ( pdev , ( uint8_t * ) & USBD_ep_status , 2 ) ; break ; default : USBD_CtlError ( pdev , req ) ; break ; } break ; default : break ; } return ret ; } 