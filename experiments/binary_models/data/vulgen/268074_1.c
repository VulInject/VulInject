static int ecryptfs_link ( struct dentry * old_dentry , struct inode * dir , struct dentry * new_dentry ) { struct dentry * lower_old_dentry ; struct dentry * lower_new_dentry ; struct inode * lower_dir ; u64 file_size_save ; int rc ; file_size_save = i_size_read ( d_inode ( old_dentry ) ) ; lower_old_dentry = ecryptfs_dentry_to_lower ( old_dentry ) ; if ( ! rc ) { rc = vfs_link ( lower_old_dentry , & nop_mnt_idmap , lower_dir , lower_new_dentry , NULL ) ; } if ( rc || d_really_is_negative ( lower_new_dentry ) ) { out_lock } rc = ecryptfs_interpose ( lower_new_dentry , new_dentry , dir -> i_sb ) ; if ( rc ) { out_lock } fsstack_copy_attr_times ( dir , lower_dir ) ; fsstack_copy_inode_size ( dir , lower_dir ) ; set_nlink ( d_inode ( old_dentry ) , ecryptfs_inode_to_lower ( d_inode ( old_dentry ) ) -> i_nlink ) ; i_size_write ( d_inode ( new_dentry ) , file_size_save ) ; out_lock inode_unlock ( lower_dir ) ; return rc ; } 