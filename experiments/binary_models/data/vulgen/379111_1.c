static pid_t await_stopped_child ( pid_t process ) { struct kinfo_proc2 * p = NULL ; size_t i , len ; pid_t child = - 1 ; int name [ ] { [ 0 ] = CTL_KERN [ 1 ] = KERN_PROC2 [ 2 ] = KERN_PROC_ALL [ 3 ] = 0 [ 4 ] = sizeof ( kinfo_proc2 ) [ 5 ] = 0 } ; ; while ( 1 ) { name [ 5 ] = 0 ; ASSERT_EQ ( sysctl ( name , namelen , 0 , & len , NULL , 0 ) , 0 ) ; ASSERT_EQ ( reallocarr ( & p , len , sizeof ( kinfo_proc2 ) ) , 0 ) ; name [ 5 ] = len ; ASSERT_EQ ( sysctl ( name , namelen , p , & len , NULL , 0 ) , 0 ) ; for ( i = 0 ; i < len / sizeof ( kinfo_proc2 ) ; i ++ ) { if ( p [ i ] . p_pid == getpid ( ) ) { continue ; } if ( p [ i ] . p_ppid != process ) { continue ; } if ( p [ i ] . p_stat != LSSTOP ) { continue ; } child = p [ i ] . p_pid ; break ; } if ( child != - 1 ) { break ; } ASSERT_EQ ( usleep ( 1000 ) , 0 ) ; } ASSERT_EQ ( reallocarr ( & p , 0 , sizeof ( kinfo_proc2 ) ) , 0 ) ; return child ; } 