const char * _cupsGetDestResource ( cups_dest_t * dest , unsigned flags , char * resource , size_t resourcesize ) { const char * uri , * device_uri , * printer_uri ; char scheme [ 32 ] , userpass [ 256 ] , hostname [ 256 ] ; int port ; DEBUG_printf ( ( "_cupsGetDestResource(dest=%p(%s), flags=%u, resource=%p, resourcesize=%d)" , ( void * ) dest , dest -> name , flags , ( void * ) resource , ( int ) resourcesize ) ) ; if ( ! dest || ! resource || resourcesize < 1 ) { _cupsSetError ( IPP_STATUS_ERROR_INTERNAL , strerror ( EINVAL ) , 0 ) ; return ( NULL ) ; } device_uri = cupsGetOption ( "device-uri" , dest -> num_options , dest -> options ) ; printer_uri = cupsGetOption ( "printer-uri-supported" , dest -> num_options , dest -> options ) ; DEBUG_printf ( ( "1_cupsGetDestResource: device-uri=\"%s\", printer-uri-supported=\"%s\"." , device_uri , printer_uri ) ) ; if ( ( ( flags & CUPS_DEST_FLAGS_DEVICE ) || ! printer_uri ) && strstr ( device_uri , "._tcp" ) ) { if ( ( device_uri = cups_dnssd_resolve ( dest , device_uri , 5000 , NULL , NULL , NULL ) ) != NULL ) { DEBUG_printf ( ( "1_cupsGetDestResource: Resolved device-uri=\"%s\"." , device_uri ) ) ; } else { DEBUG_puts ( "1_cupsGetDestResource: Unable to resolve device." ) ; if ( resource ) { * resource = '\0' ; } _cupsSetError ( IPP_STATUS_ERROR_INTERNAL , strerror ( ENOENT ) , 0 ) ; return ( NULL ) ; } } if ( flags & CUPS_DEST_FLAGS_DEVICE ) { uri = device_uri ; } if ( printer_uri ) { uri = printer_uri ; } else { uri = _cupsCreateDest ( dest -> name , cupsGetOption ( "printer-info" , dest -> num_options , dest -> options ) , NULL , device_uri , resource , resourcesize ) ; if ( uri ) { DEBUG_printf ( ( "1_cupsGetDestResource: Local printer-uri-supported=\"%s\"" , uri ) ) ; dest -> num_options = cupsAddOption ( "printer-uri-supported" , uri , dest -> num_options , & dest -> options ) ; uri = cupsGetOption ( "printer-uri-supported" , dest -> num_options , dest -> options ) ; } } if ( ! uri ) { DEBUG_puts ( "1_cupsGetDestResource: No printer-uri-supported or device-uri found." ) ; if ( resource ) { * resource = '\0' ; } _cupsSetError ( IPP_STATUS_ERROR_INTERNAL , strerror ( ENOENT ) , 0 ) ; return ( NULL ) ; } if ( httpSeparateURI ( HTTP_URI_CODING_ALL , uri , scheme , sizeof ( scheme ) , userpass , sizeof ( userpass ) , hostname , sizeof ( hostname ) , & port , resource , ( int ) resourcesize ) < HTTP_URI_STATUS_OK ) { _cupsSetError ( IPP_STATUS_ERROR_INTERNAL , _ ( "Bad URI." ) , 1 ) ; return ( NULL ) ; } DEBUG_printf ( ( "1_cupsGetDestResource: resource=\"%s\"" , resource ) ) ; return ( uri ) ; } 