static int vhost_user_set_mem_table ( struct vhost_dev * dev , struct vhost_memory * mem ) { struct vhost_user * u = dev -> opaque ; int fds [ VHOST_MEMORY_BASELINE_NREGIONS ] ; size_t fd_num = 0 ; bool do_postcopy = u -> postcopy_listen && u -> postcopy_fd . handler ; bool reply_supported = virtio_has_feature ( dev -> protocol_features , VHOST_USER_PROTOCOL_F_REPLY_ACK ) ; bool config_mem_slots = virtio_has_feature ( dev -> protocol_features , VHOST_USER_PROTOCOL_F_CONFIGURE_MEM_SLOTS ) ; int ret ; if ( do_postcopy ) { return vhost_user_set_mem_table_postcopy ( dev , mem , reply_supported , config_mem_slots ) ; } VhostUserMsg msg = { . hdr . flags = VHOST_USER_VERSION } ; if ( reply_supported ) { msg . hdr . flags |= VHOST_USER_NEED_REPLY_MASK ; } if ( config_mem_slots ) { ret = vhost_user_add_remove_regions ( dev , & msg , reply_supported , false ) ; if ( ret < 0 ) { return ret ; } } else { ret = vhost_user_fill_set_mem_table_msg ( u , dev , & msg , fds , & fd_num , false ) ; if ( ret < 0 ) { return ret ; } ret = vhost_user_write ( dev , & msg , fds , fd_num ) ; if ( reply_supported ) { return process_message_reply ( dev , & msg ) ; } } return 0 ; } 