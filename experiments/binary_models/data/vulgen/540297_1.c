static icmp_transaction_t * transaction_start ( packet_info * pinfo , proto_tree * tree , guint32 * key ) { conversation_t * conversation ; icmp_conv_info_t * icmp_info ; icmp_transaction_t * icmp_trans ; wmem_tree_key_t icmp_key [ 3 ] ; proto_item * it ; conversation = _find_or_create_conversation ( pinfo ) ; icmp_info = ( icmp_conv_info_t * ) conversation_get_proto_data ( conversation , proto_icmp ) ; if ( icmp_info == NULL ) { icmp_info = wmem_new ( wmem_file_scope ( ) , icmp_conv_info_t ) ; icmp_info -> unmatched_pdus = wmem_tree_new ( wmem_file_scope ( ) ) ; icmp_info -> matched_pdus = wmem_tree_new ( wmem_file_scope ( ) ) ; conversation_add_proto_data ( conversation , proto_icmp , icmp_info ) ; } if ( ! PINFO_FD_VISITED ( pinfo ) ) { icmp_key [ 0 ] . length = 3 ; icmp_key [ 0 ] . key = key ; icmp_key [ 1 ] . length = 0 ; icmp_key [ 1 ] . key = NULL ; icmp_trans = wmem_new ( wmem_file_scope ( ) , icmp_transaction_t ) ; icmp_trans -> rqst_frame = pinfo -> num ; icmp_trans -> resp_frame = 0 ; icmp_trans -> rqst_time = pinfo -> abs_ts ; wmem_tree_insert32_array ( icmp_info -> unmatched_pdus , icmp_key , ( void * ) icmp_trans ) ; } else { guint32 frame_num = pinfo -> num ; icmp_key [ 0 ] . length = 3 ; icmp_key [ 0 ] . key = key ; icmp_key [ 1 ] . length = 1 ; icmp_key [ 1 ] . key = & frame_num ; icmp_key [ 2 ] . length = 0 ; icmp_key [ 2 ] . key = NULL ; icmp_trans = ( icmp_transaction_t * ) wmem_tree_lookup32_array ( icmp_info -> matched_pdus , icmp_key ) ; } if ( icmp_trans == NULL ) { if ( ADDR_IS_NOT_UNICAST ( & pinfo -> dst ) ) { col_append_str ( pinfo -> cinfo , COL_INFO , ADDR_IS_BROADCAST ( & pinfo -> dst ) ?" (broadcast)" : " (multicast)" ) ; } if ( PINFO_FD_VISITED ( pinfo ) ) { it = proto_tree_add_item ( tree , hf_icmp_no_resp , NULL , 0 , 0 , ENC_NA ) ; proto_item_set_generated ( it ) ; col_append_fstr ( pinfo -> cinfo , COL_INFO , " (no response found!)" ) ; expert_add_info_format ( pinfo , it , & ei_icmp_resp_not_found , "No response seen to ICMP request" ) ; } return NULL ; } if ( icmp_trans -> resp_frame ) { it = proto_tree_add_uint ( tree , hf_icmp_resp_in , NULL , 0 , 0 , icmp_trans -> resp_frame ) ; proto_item_set_generated ( it ) ; col_append_frame_number ( pinfo , COL_INFO , " (reply in %u)" , icmp_trans -> resp_frame ) ; } return icmp_trans ; } 