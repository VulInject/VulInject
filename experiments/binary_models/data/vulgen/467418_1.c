static netdev_tx_t vxcan_xmit ( struct sk_buff * skb , struct net_device * dev ) { struct vxcan_priv * priv = netdev_priv ( dev ) ; struct net_device * peer ; struct canfd_frame * cfd = ( canfd_frame * ) skb -> data ; struct net_device_stats * peerstats , * srcstats = & dev -> stats ; if ( can_dropped_invalid_skb ( dev , skb ) ) { return NETDEV_TX_OK ; } rcu_read_lock ( ) ; peer = rcu_dereference ( priv -> peer ) ; if ( unlikely ( ! peer ) ) { kfree_skb ( skb ) ; dev -> stats . tx_dropped ++ ; out_unlock } skb = can_create_echo_skb ( skb ) ; if ( ! skb ) { out_unlock } skb -> csum_start = 0 ; skb -> pkt_type = PACKET_BROADCAST ; skb -> dev = peer ; skb -> ip_summed = CHECKSUM_UNNECESSARY ; if ( netif_rx_ni ( skb ) == NET_RX_SUCCESS ) { srcstats -> tx_packets ++ ; srcstats -> tx_bytes += cfd -> len ; peerstats -> rx_packets ++ ; peerstats -> rx_bytes += cfd -> len ; } out_unlock rcu_read_unlock ( ) ; return NETDEV_TX_OK ; } 