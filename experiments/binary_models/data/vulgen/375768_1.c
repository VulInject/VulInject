ds_ht_t * ds_ht_init ( unsigned int htsize , int expire , int initexpire ) { int i ; ds_ht_t * dsht = NULL ; dsht = ( ds_ht_t * ) shm_malloc ( sizeof ( ds_ht_t ) ) ; if ( dsht == NULL ) { LM_ERR ( "no more shm\n" ) ; return NULL ; } memset ( dsht , 0 , sizeof ( ds_ht_t ) ) ; dsht -> htsize = htsize ; dsht -> htexpire = expire ; dsht -> htinitexpire = initexpire ; dsht -> entries = ( ds_entry_t * ) shm_malloc ( dsht -> htsize * sizeof ( ds_entry_t ) ) ; if ( dsht -> entries == NULL ) { LM_ERR ( "no more shm.\n" ) ; dsht = NULL ; return NULL ; } memset ( dsht -> entries , 0 , dsht -> htsize * sizeof ( ds_entry_t ) ) ; for ( i = 0 ; i < dsht -> htsize ; i ++ ) { if ( lock_init ( & dsht -> entries [ i ] . lock ) == 0 ) { LM_ERR ( "cannot initialize lock[%d]\n" , i ) ; i -- ; while ( i >= 0 ) { lock_destroy ( & dsht -> entries [ i ] . lock ) ; i -- ; } shm_free ( dsht -> entries ) ; shm_free ( dsht ) ; dsht = NULL ; return NULL ; } } return dsht ; } 