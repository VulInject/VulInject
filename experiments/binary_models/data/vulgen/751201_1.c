PHP_METHOD ( , ) { php_sxe_object * sxe ; zval value ; char * query ; size_t query_len ; int i ; int nsnbr = 0 ; xmlNsPtr * ns = NULL ; xmlXPathObjectPtr retval ; xmlNodeSetPtr result ; xmlNodePtr nodeptr ; sxe = Z_SXEOBJ_P ( ZEND_THIS ) ; if ( sxe -> iter . type == SXE_ITER_ATTRLIST ) { return ; } GET_NODE ( sxe , nodeptr ) ; nodeptr = php_sxe_get_first_node ( sxe , nodeptr ) ; if ( ! nodeptr ) { return ; } if ( ! sxe -> xpath ) { sxe -> xpath = xmlXPathNewContext ( ( xmlDocPtr ) sxe -> document -> ptr ) ; } sxe -> xpath -> node = nodeptr ; ns = xmlGetNsList ( ( xmlDocPtr ) sxe -> document -> ptr , nodeptr ) ; if ( ns != NULL ) { while ( ns [ nsnbr ] != NULL ) { nsnbr ++ ; } } sxe -> xpath -> namespaces = ns ; sxe -> xpath -> nsNr = nsnbr ; retval = xmlXPathEval ( ( xmlChar * ) query , sxe -> xpath ) ; if ( ns != NULL ) { xmlFree ( ns ) ; sxe -> xpath -> namespaces = NULL ; sxe -> xpath -> nsNr = 0 ; } if ( ! retval ) { RETURN_FALSE ; } result = retval -> nodesetval ; if ( result != NULL ) { array_init ( return_value ) ; for ( i = 0 ; i < result -> nodeNr ; ++ i ) { nodeptr = result -> nodeTab [ i ] ; if ( nodeptr -> type == XML_TEXT_NODE || nodeptr -> type == XML_ELEMENT_NODE || nodeptr -> type == XML_ATTRIBUTE_NODE ) { if ( nodeptr -> type == XML_TEXT_NODE ) { _node_as_zval ( sxe , nodeptr -> parent , & value , SXE_ITER_NONE , NULL , NULL , 0 ) ; } if ( nodeptr -> type == XML_ATTRIBUTE_NODE ) { _node_as_zval ( sxe , nodeptr -> parent , & value , SXE_ITER_ATTRLIST , ( char * ) nodeptr -> name , nodeptr -> ns ?( xmlChar * ) nodeptr -> ns -> href : NULL , 0 ) ; } else { _node_as_zval ( sxe , nodeptr , & value , SXE_ITER_NONE , NULL , NULL , 0 ) ; } add_next_index_zval ( return_value , & value ) ; } } } else { RETVAL_EMPTY_ARRAY ( ) ; } xmlXPathFreeObject ( retval ) ; } 