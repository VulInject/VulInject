suc_code update_map_if_required ( map_ctrl * map , bool_t wait ) { thread_t tid ; map_ctrl * new_map ; suc_code res ; long flags ; if ( wait ) { unlock_map_ctrl ( map ) ; res = lock_map_update ( map ) ; lock_map_ctrl ( map ) ; if ( SUCCESS != res ) { logmsg ( MSG_NOTIMECHECK , LOG_ERR , "Could not lock map %s for update" , map -> map_name ) ; return ( FAILURE ) ; } } else { switch ( try_lock_map_update ( map ) ) { case 0 : break ; case EBUSY : return ( SUCCESS ) ; default : return ( FAILURE ) ; } } if ( ! has_map_expired ( map ) ) { unlock_map_update ( map ) ; return ( SUCCESS ) ; } new_map = dup_map_ctrl ( map ) ; if ( NULL == new_map ) { unlock_map_update ( map ) ; return ( FAILURE ) ; } unlock_map_ctrl ( map ) ; flags = THR_BOUND | THR_NEW_LWP ; if ( ! wait && ( getpid ( ) == parent_pid ) ) { flags |= THR_DETACHED ; } if ( 0 != thr_create ( NULL , NULL , update_thread , new_map , flags , & tid ) ) { logmsg ( MSG_NOTIMECHECK , LOG_ERR , "Could not create NIS update thread" ) ; unlock_map_update ( map ) ; if ( SUCCESS != lock_map_ctrl ( map ) ) { logmsg ( MSG_NOTIMECHECK , LOG_ERR , "Could not acquire update lock for %s" , map -> map_name ) ; } return ( FAILURE ) ; } if ( wait ) { thr_join ( tid , NULL , NULL ) ; } if ( 1 != lock_map_ctrl ( map ) ) { logmsg ( MSG_NOTIMECHECK , LOG_ERR , "Could not re-acquire lock for %s" , map -> map_name ) ; return ( FAILURE ) ; } return ( SUCCESS ) ; } 