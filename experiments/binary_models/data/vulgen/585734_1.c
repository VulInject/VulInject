static void do_gen_all_hostkeys ( struct passwd * pw ) { { char * key_type ; char * key_type_display ; char * path ; } , key_types [ ] { { "rsa" "RSA" _PATH_HOST_RSA_KEY_FILE } { "ecdsa" "ECDSA" _PATH_HOST_ECDSA_KEY_FILE } { "ed25519" "ED25519" _PATH_HOST_ED25519_KEY_FILE } { "xmss" "XMSS" _PATH_HOST_XMSS_KEY_FILE } { NULL NULL NULL } } ; u_int32_t bits = 0 ; int first = 0 ; struct stat st ; struct sshkey * , * ; char comment [ 1024 ] , * prv_tmp , * pub_tmp , * prv_file , * pub_file ; int i , type , fd , r ; for ( i = 0 ; key_types [ i ] . key_type ; i ++ ) { public = private = NULL ; prv_tmp = pub_tmp = prv_file = pub_file = NULL ; xasprintf ( & prv_file , "%s%s" , identity_file , key_types [ i ] . path ) ; if ( stat ( prv_file , & st ) == 0 ) { if ( st . st_size != 0 ) { next } } if ( errno != ENOENT ) { error ( "Could not stat %s: %s" , key_types [ i ] . path , strerror ( errno ) ) ; failnext } xasprintf ( & prv_tmp , "%s%s.XXXXXXXXXX" , identity_file , key_types [ i ] . path ) ; xasprintf ( & pub_tmp , "%s%s.pub.XXXXXXXXXX" , identity_file , key_types [ i ] . path ) ; xasprintf ( & pub_file , "%s%s.pub" , identity_file , key_types [ i ] . path ) ; if ( first == 0 ) { first = 1 ; printf ( "%s: generating new host keys: " , __progname ) ; } printf ( "%s " , key_types [ i ] . key_type_display ) ; fflush ( stdout ) ; type = sshkey_type_from_name ( key_types [ i ] . key_type ) ; if ( ( fd = mkstemp ( prv_tmp ) ) == - 1 ) { error ( "Could not save your private key in %s: %s" , prv_tmp , strerror ( errno ) ) ; failnext } ( void ) close ( fd ) ; bits = 0 ; type_bits_valid ( type , NULL , & bits ) ; if ( ( r = sshkey_generate ( type , bits , & private ) ) != 0 ) { error_r ( r , "sshkey_generate failed" ) ; failnext } if ( ( r = sshkey_from_private ( private , & public ) ) != 0 ) { fatal_fr ( r , "sshkey_from_private" ) ; } snprintf ( comment , sizeof comment , "%s@%s" , pw -> pw_name , hostname ) ; if ( ( r = sshkey_save_private ( private , prv_tmp , "" , comment , private_key_format , openssh_format_cipher , rounds ) ) != 0 ) { error_r ( r , "Saving key \"%s\" failed" , prv_tmp ) ; failnext } if ( ( fd = mkstemp ( pub_tmp ) ) == - 1 ) { error ( "Could not save your public key in %s: %s" , pub_tmp , strerror ( errno ) ) ; failnext } ( void ) fchmod ( fd , 0644 ) ; ( void ) close ( fd ) ; if ( ( r = sshkey_save_public ( public , pub_tmp , comment ) ) != 0 ) { error_r ( r , "Unable to save public key to %s" , identity_file ) ; failnext } if ( rename ( pub_tmp , pub_file ) != 0 ) { error ( "Unable to move %s into position: %s" , pub_file , strerror ( errno ) ) ; failnext } if ( rename ( prv_tmp , prv_file ) != 0 ) { error ( "Unable to move %s into position: %s" , key_types [ i ] . path , strerror ( errno ) ) ; failnext first = 0 ; next } next sshkey_free ( private ) ; sshkey_free ( public ) ; free ( prv_tmp ) ; free ( pub_tmp ) ; free ( prv_file ) ; free ( pub_file ) ; } } 