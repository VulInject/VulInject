static int __init brightness_init ( struct ibm_init_struct * iibm ) { struct backlight_properties props ; int b ; unsigned long quirks ; vdbg_printk ( TPACPI_DBG_INIT , "initializing brightness subdriver\n" ) ; quirks = tpacpi_check_quirks ( brightness_quirk_table , ARRAY_SIZE ( brightness_quirk_table ) ) ; if ( tp_features . bright_unkfw ) { return 1 ; } if ( ! brightness_enable ) { dbg_printk ( TPACPI_DBG_INIT | TPACPI_DBG_BRGHT , "brightness support disabled by " "module parameter\n" ) ; return 1 ; } if ( acpi_video_get_backlight_type ( ) != acpi_backlight_vendor ) { if ( brightness_enable > 1 ) { pr_info ( "Standard ACPI backlight interface " "available, not loading native one\n" ) ; return 1 ; } if ( brightness_enable == 1 ) { pr_warn ( "Cannot enable backlight brightness support, " "ACPI is already handling it.  Refer to the " "acpi_backlight kernel parameter.\n" ) ; return 1 ; } } if ( tp_features . bright_acpimode && brightness_enable > 1 ) { pr_notice ( "Standard ACPI backlight interface not " "available, thinkpad_acpi native " "brightness control enabled\n" ) ; } if ( brightness_mode > TPACPI_BRGHT_MODE_MAX ) { return - EINVAL ; } if ( brightness_mode == TPACPI_BRGHT_MODE_AUTO || brightness_mode == TPACPI_BRGHT_MODE_MAX ) { if ( quirks & TPACPI_BRGHT_Q_EC ) { brightness_mode = TPACPI_BRGHT_MODE_ECNVRAM ; } else { brightness_mode = TPACPI_BRGHT_MODE_UCMS_STEP ; } dbg_printk ( TPACPI_DBG_BRGHT , "driver auto-selected brightness_mode=%d\n" , brightness_mode ) ; } if ( ! tpacpi_is_ibm ( ) && ( brightness_mode == TPACPI_BRGHT_MODE_ECNVRAM || brightness_mode == TPACPI_BRGHT_MODE_EC ) ) { return - EINVAL ; } if ( tpacpi_brightness_get_raw ( & b ) < 0 ) { return 1 ; } memset ( & props , 0 , sizeof ( backlight_properties ) ) ; props . type = BACKLIGHT_PLATFORM ; props . max_brightness = bright_maxlvl ; props . brightness = b & TP_EC_BACKLIGHT_LVLMSK ; ibm_backlight_device = backlight_device_register ( TPACPI_BACKLIGHT_DEV_NAME , NULL , NULL , & ibm_backlight_data , & props ) ; if ( IS_ERR ( ibm_backlight_device ) ) { int rc = PTR_ERR ( ibm_backlight_device ) ; ibm_backlight_device = NULL ; pr_err ( "Could not register backlight device\n" ) ; return rc ; } vdbg_printk ( TPACPI_DBG_INIT | TPACPI_DBG_BRGHT , "brightness is supported\n" ) ; if ( quirks & TPACPI_BRGHT_Q_ASK ) { pr_notice ( "brightness: will use unverified default: " "brightness_mode=%d\n" , brightness_mode ) ; pr_notice ( "brightness: please report to %s whether it works well " "or not on your ThinkPad\n" , TPACPI_MAIL ) ; } backlight_update_status ( ibm_backlight_device ) ; vdbg_printk ( TPACPI_DBG_INIT | TPACPI_DBG_BRGHT , "brightness: registering brightness hotkeys " "as change notification\n" ) ; tpacpi_hotkey_driver_mask_set ( hotkey_driver_mask | TP_ACPI_HKEY_BRGHTUP_MASK | TP_ACPI_HKEY_BRGHTDWN_MASK ) ; return 0 ; } 