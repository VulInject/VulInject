uint64_t uwsgi_ruby_rpc ( void * func , uint8_t argc , char * * argv , uint16_t argvs [ ] , char * * buffer ) { uint8_t i ; VALUE rb_args = rb_ary_new2 ( 2 ) ; VALUE rb_rpc_args = rb_ary_new2 ( argc ) ; VALUE ret ; int error = 0 ; char * rv ; size_t rl ; rb_ary_store ( rb_args , 0 , ( VALUE ) func ) ; for ( i = 0 ; i < argc ; i ++ ) { rb_ary_store ( rb_rpc_args , i , rb_str_new ( argv [ i ] , argvs [ i ] ) ) ; } rb_ary_store ( rb_args , 1 , rb_rpc_args ) ; ret = rb_protect ( rack_call_rpc_handler , rb_args , & error ) ; if ( error ) { uwsgi_ruby_exception_log ( NULL ) ; return 0 ; } if ( TYPE ( ret ) == T_STRING ) { rv = RSTRING_PTR ( ret ) ; rl = RSTRING_LEN ( ret ) ; if ( rl > 0 ) { memcpy ( * buffer , rv , rl ) ; return rl ; } } return 0 ; } 