static int lis3lv02d_selftest ( struct lis3lv02d * lis3 , s16 results [ 3 ] ) { u8 ctlreg , reg ; s16 x , y , z ; u8 selftest ; int ret ; u8 ctrl_reg_data ; unsigned char irq_cfg ; mutex_lock ( & lis3 -> mutex ) ; irq_cfg = lis3 -> irq_cfg ; if ( lis3 -> whoami == WAI_8B ) { lis3 -> data_ready_count [ IRQ_LINE0 ] = 0 ; lis3 -> data_ready_count [ IRQ_LINE1 ] = 0 ; lis3 -> irq_cfg = LIS3_IRQ1_DATA_READY | LIS3_IRQ2_DATA_READY ; lis3 -> read ( lis3 , CTRL_REG3 , & ctrl_reg_data ) ; lis3 -> write ( lis3 , CTRL_REG3 , ( ctrl_reg_data & ~ ( LIS3_IRQ1_MASK | LIS3_IRQ2_MASK ) ) | ( LIS3_IRQ1_DATA_READY | LIS3_IRQ2_DATA_READY ) ) ; } if ( ( lis3 -> whoami == WAI_3DC ) || ( lis3 -> whoami == WAI_3DLH ) ) { ctlreg = CTRL_REG4 ; selftest = CTRL4_ST0 ; } else { ctlreg = CTRL_REG1 ; if ( lis3 -> whoami == WAI_12B ) { selftest = CTRL1_ST ; } else { selftest = CTRL1_STP ; } } lis3 -> read ( lis3 , ctlreg , & reg ) ; lis3 -> write ( lis3 , ctlreg , ( reg | selftest ) ) ; ret = lis3lv02d_get_pwron_wait ( lis3 ) ; if ( ret ) { fail } x = lis3 -> read_data ( lis3 , OUTX ) ; y = lis3 -> read_data ( lis3 , OUTY ) ; z = lis3 -> read_data ( lis3 , OUTZ ) ; lis3 -> write ( lis3 , ctlreg , reg ) ; ret = lis3lv02d_get_pwron_wait ( lis3 ) ; if ( ret ) { fail } results [ 0 ] = x - lis3 -> read_data ( lis3 , OUTX ) ; results [ 1 ] = y - lis3 -> read_data ( lis3 , OUTY ) ; results [ 2 ] = z - lis3 -> read_data ( lis3 , OUTZ ) ; ret = 0 ; if ( lis3 -> whoami == WAI_8B ) { atomic_dec ( & lis3 -> wake_thread ) ; lis3 -> write ( lis3 , CTRL_REG3 , ctrl_reg_data ) ; lis3 -> irq_cfg = irq_cfg ; if ( ( irq_cfg & LIS3_IRQ1_MASK ) && lis3 -> data_ready_count [ IRQ_LINE0 ] < 2 ) { ret = SELFTEST_IRQ ; fail } if ( ( irq_cfg & LIS3_IRQ2_MASK ) && lis3 -> data_ready_count [ IRQ_LINE1 ] < 2 ) { ret = SELFTEST_IRQ ; fail } } if ( lis3 -> pdata ) { int i ; for ( i = 0 ; i < 3 ; i ++ ) { if ( ( results [ i ] < lis3 -> pdata -> st_min_limits [ i ] ) || ( results [ i ] > lis3 -> pdata -> st_max_limits [ i ] ) ) { ret = SELFTEST_FAIL ; fail } } } fail mutex_unlock ( & lis3 -> mutex ) ; return ret ; } 