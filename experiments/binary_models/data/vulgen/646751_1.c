static void unreserve_psock ( struct kcm_sock * kcm ) { struct kcm_psock * psock ; struct kcm_mux * mux = kcm -> mux ; spin_lock_bh ( & mux -> lock ) ; psock = kcm -> tx_psock ; if ( WARN_ON ( ! psock ) ) { spin_unlock_bh ( & mux -> lock ) ; return ; } smp_rmb ( ) ; kcm_update_tx_mux_stats ( mux , psock ) ; WARN_ON ( kcm -> tx_wait ) ; kcm -> tx_psock = NULL ; psock -> tx_kcm = NULL ; KCM_STATS_INCR ( psock -> stats . unreserved ) ; if ( unlikely ( psock -> tx_stopped ) ) { if ( psock -> done ) { list_del ( & psock -> psock_list ) ; mux -> psocks_cnt -- ; sock_put ( psock -> sk ) ; fput ( psock -> sk -> sk_socket -> file ) ; } spin_unlock_bh ( & mux -> lock ) ; return ; } psock_now_avail ( psock ) ; spin_unlock_bh ( & mux -> lock ) ; } 