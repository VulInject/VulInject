void run_misc_host_check_tests ( ) { time_t now = 0L ; int result = 0 ; int tmp1 = 0 ; int check_type = CHECK_TYPE_ACTIVE ; time ( & now ) ; ok ( handle_async_host_check_result ( NULL , NULL ) == ERROR , "handle check result is ERROR when objects are null" ) ; ok ( run_async_host_check ( NULL , 0 , 0 , 0 , 0 , & tmp1 , & now ) == ERROR , "run host check is ERROR when object is null" ) ; ok ( get_host_check_return_code ( NULL , NULL ) == STATE_UNREACHABLE , "host check return code is STATE_UNREACHABLE when objects are null" ) ; ok ( get_service_check_return_code ( NULL , NULL ) == STATE_UNKNOWN , "service check return code is STATE_UNKNOWN when objects are null" ) ; create_objects ( STATE_UP , HARD_STATE , "host up" , STATE_OK , HARD_STATE , "service up" ) ; create_check_result ( check_type , STATE_DOWN , "host down" ) ; chk_result -> early_timeout = TRUE ; chk_result -> latency = 42 ; chk_result -> start_time . tv_sec = now ; chk_result -> finish_time . tv_sec = now + 42L ; handle_hst1 ( ) ; ok ( strstr ( hst1 -> plugin_output , "after 42.00 seconds" ) != NULL , "found appropriate early timeout message, [%s]" , hst1 -> plugin_output ) ; create_check_result ( check_type , STATE_DOWN , "host down" ) ; handle_hst1 ( ) ; ok ( strstr ( hst1 -> plugin_output , "did not exit properly" ) != NULL , "found appropriate exited ok message, [%s]" , hst1 -> plugin_output ) ; create_check_result ( check_type , 126 , "host down" ) ; handle_hst1 ( ) ; ok ( strstr ( hst1 -> plugin_output , "126 is out of bounds" ) != NULL , "found appropriate non executable message, [%s]" , hst1 -> plugin_output ) ; create_check_result ( check_type , 127 , "host down" ) ; handle_hst1 ( ) ; ok ( strstr ( hst1 -> plugin_output , "127 is out of bounds" ) != NULL , "found appropriate non existent message, [%s]" , hst1 -> plugin_output ) ; create_check_result ( check_type , - 1 , "host down" ) ; handle_hst1 ( ) ; ok ( strstr ( hst1 -> plugin_output , "code of -1" ) != NULL , "found appropriate lower bound message, [%s]" , hst1 -> plugin_output ) ; ok ( hst1 -> current_state == STATE_DOWN , "-1 is STATE_DOWN, %d" , result ) ; create_check_result ( check_type , 4 , "host down" ) ; handle_hst1 ( ) ; ok ( strstr ( hst1 -> plugin_output , "code of 4" ) != NULL , "found appropriate lower bound message, [%s]" , hst1 -> plugin_output ) ; ok ( hst1 -> current_state == STATE_DOWN , "4 is STATE_DOWN, %d" , result ) ; create_check_result ( check_type , STATE_DOWN , "host down" ) ; my_free ( hst1 -> check_command ) ; hst1 -> check_command = NULL ; handle_hst1 ( ) ; ok ( hst1 -> current_state == STATE_UP , "null check command is always alright" ) ; log_passive_checks = TRUE ; result = handle_async_host_check_result ( hst1 , NULL ) ; ok ( result == ERROR , "handle_async_host_check_result is ERROR when hst1 is valid, but check result is null" ) ; accept_passive_host_checks = FALSE ; create_check_result ( CHECK_TYPE_PASSIVE , HOST_UP , "host up" ) ; result = handle_async_host_check_result ( hst1 , chk_result ) ; ok ( result == ERROR , "when accept_passive_host_checks is false, can't handle passive check result" ) ; accept_passive_host_checks = TRUE ; create_check_result ( CHECK_TYPE_PASSIVE , HOST_UP , "host up" ) ; hst1 -> accept_passive_checks = FALSE ; result = handle_async_host_check_result ( hst1 , chk_result ) ; ok ( result == ERROR , "when hst->accept_passive_checks is false, can't handle passive check result" ) ; create_check_result ( check_type , HOST_UP , "host up" ) ; hst1 -> is_being_freshened = TRUE ; chk_result -> check_options |= CHECK_OPTION_FRESHNESS_CHECK ; handle_hst1 ( ) ; ok ( hst1 -> is_being_freshened == FALSE , "freshening flag was reset" ) ; hst1 -> accept_passive_checks = TRUE ; hst1 -> check_command = strdup ( "SOME COMMAND" ) ; create_check_result ( check_type , HOST_UP , "host up" ) ; my_free ( chk_result -> output ) ; my_free ( hst1 -> plugin_output ) ; handle_hst1 ( ) ; ok ( strstr ( hst1 -> plugin_output , "No output returned" ) != NULL , "If there was no plugin output, tell us [%s]" , hst1 -> plugin_output ) ; create_check_result ( check_type , HOST_UP , "host up" ) ; chk_result -> finish_time . tv_sec = ORIG_FINISH_TIME - 100L ; handle_hst1 ( ) ; ok ( hst1 -> execution_time == 0.0 , "execution time gets fixed when finish time is before start time" ) ; create_check_result ( check_type , HOST_UP , "host up" ) ; free_all ( ) ; } 