static void _scsih_sas_host_add ( struct MPT3SAS_ADAPTER * ioc ) { int i ; Mpi2ConfigReply_t mpi_reply ; Mpi2SasIOUnitPage0_t * sas_iounit_pg0 = NULL ; Mpi2SasIOUnitPage1_t * sas_iounit_pg1 = NULL ; Mpi2SasPhyPage0_t phy_pg0 ; Mpi2SasDevicePage0_t sas_device_pg0 ; Mpi2SasEnclosurePage0_t enclosure_pg0 ; u16 ioc_status ; u16 sz ; u8 device_missing_delay ; u8 num_phys ; mpt3sas_config_get_number_hba_phys ( ioc , & num_phys ) ; if ( ! num_phys ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; return ; } ioc -> sas_hba . phy = kcalloc ( num_phys , sizeof ( _sas_phy ) , GFP_KERNEL ) ; if ( ! ioc -> sas_hba . phy ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } ioc -> sas_hba . num_phys = num_phys ; sz = offsetof ( Mpi2SasIOUnitPage0_t , PhyData ) + ( ioc -> sas_hba . num_phys * sizeof ( Mpi2SasIOUnit0PhyData_t ) ) ; sas_iounit_pg0 = kzalloc ( sz , GFP_KERNEL ) ; if ( ! sas_iounit_pg0 ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; return ; } if ( ( mpt3sas_config_get_sas_iounit_pg0 ( ioc , & mpi_reply , sas_iounit_pg0 , sz ) ) ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } ioc_status = le16_to_cpu ( mpi_reply . IOCStatus ) & MPI2_IOCSTATUS_MASK ; if ( ioc_status != MPI2_IOCSTATUS_SUCCESS ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } sz = offsetof ( Mpi2SasIOUnitPage1_t , PhyData ) + ( ioc -> sas_hba . num_phys * sizeof ( Mpi2SasIOUnit1PhyData_t ) ) ; sas_iounit_pg1 = kzalloc ( sz , GFP_KERNEL ) ; if ( ! sas_iounit_pg1 ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } if ( ( mpt3sas_config_get_sas_iounit_pg1 ( ioc , & mpi_reply , sas_iounit_pg1 , sz ) ) ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } ioc_status = le16_to_cpu ( mpi_reply . IOCStatus ) & MPI2_IOCSTATUS_MASK ; if ( ioc_status != MPI2_IOCSTATUS_SUCCESS ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } ioc -> io_missing_delay = sas_iounit_pg1 -> IODeviceMissingDelay ; device_missing_delay = sas_iounit_pg1 -> ReportDeviceMissingDelay ; if ( device_missing_delay & MPI2_SASIOUNIT1_REPORT_MISSING_UNIT_16 ) { ioc -> device_missing_delay = ( device_missing_delay & MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK ) * 16 ; } else { ioc -> device_missing_delay = device_missing_delay & MPI2_SASIOUNIT1_REPORT_MISSING_TIMEOUT_MASK ; } ioc -> sas_hba . parent_dev = & ioc -> shost -> shost_gendev ; for ( i = 0 ; i < ioc -> sas_hba . num_phys ; i ++ ) { if ( ( mpt3sas_config_get_phy_pg0 ( ioc , & mpi_reply , & phy_pg0 , i ) ) ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } ioc_status = le16_to_cpu ( mpi_reply . IOCStatus ) & MPI2_IOCSTATUS_MASK ; if ( ioc_status != MPI2_IOCSTATUS_SUCCESS ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } ioc -> sas_hba . phy [ i ] . handle = ioc -> sas_hba . handle ; ioc -> sas_hba . phy [ i ] . phy_id = i ; mpt3sas_transport_add_host_phy ( ioc , & ioc -> sas_hba . phy [ i ] , phy_pg0 , ioc -> sas_hba . parent_dev ) ; } if ( ( mpt3sas_config_get_sas_device_pg0 ( ioc , & mpi_reply , & sas_device_pg0 , MPI2_SAS_DEVICE_PGAD_FORM_HANDLE , ioc -> sas_hba . handle ) ) ) { pr_err ( MPT3SAS_FMT "failure at %s:%d/%s()!\n" , ioc -> name , __FILE__ , __LINE__ , __func__ ) ; out } ioc -> sas_hba . enclosure_handle = le16_to_cpu ( sas_device_pg0 . EnclosureHandle ) ; ioc -> sas_hba . sas_address = le64_to_cpu ( sas_device_pg0 . SASAddress ) ; pr_info ( MPT3SAS_FMT "host_add: handle(0x%04x), sas_addr(0x%016llx), phys(%d)\n" , ioc -> name , ioc -> sas_hba . handle , ( unsigned long long ) ioc -> sas_hba . sas_address , ioc -> sas_hba . num_phys ) ; if ( ioc -> sas_hba . enclosure_handle ) { if ( ! ( mpt3sas_config_get_enclosure_pg0 ( ioc , & mpi_reply , & enclosure_pg0 , MPI2_SAS_ENCLOS_PGAD_FORM_HANDLE , ioc -> sas_hba . enclosure_handle ) ) ) { ioc -> sas_hba . enclosure_logical_id = le64_to_cpu ( enclosure_pg0 . EnclosureLogicalID ) ; } } out kfree ( sas_iounit_pg1 ) ; kfree ( sas_iounit_pg0 ) ; } 