static int bio_zlib_read ( BIO * b , char * out , int outl ) { BIO_ZLIB_CTX * ctx ; int ret ; z_stream * zin ; if ( ! out || ! outl ) { return 0 ; } ctx = ( BIO_ZLIB_CTX * ) b -> ptr ; zin = & ctx -> zin ; BIO_clear_retry_flags ( b ) ; if ( ! ctx -> ibuf ) { ctx -> ibuf = malloc ( ctx -> ibufsize ) ; if ( ! ctx -> ibuf ) { COMPerror ( ERR_R_MALLOC_FAILURE ) ; return 0 ; } inflateInit ( zin ) ; zin -> next_in = ctx -> ibuf ; zin -> avail_in = 0 ; } zin -> next_out = ( unsigned char * ) out ; zin -> avail_out = ( unsigned int ) outl ; for ( ; ; ) { while ( zin -> avail_in ) { ret = inflate ( zin , 0 ) ; if ( ( ret != Z_OK ) && ( ret != Z_STREAM_END ) ) { COMPerror ( COMP_R_ZLIB_INFLATE_ERROR ) ; ERR_asprintf_error_data ( "zlib error:%s" , zError ( ret ) ) ; return 0 ; } } ret = BIO_read ( b -> next_bio , ctx -> ibuf , ctx -> ibufsize ) ; if ( ret <= 0 ) { int tot = outl - zin -> avail_out ; BIO_copy_next_retry ( b ) ; if ( ret < 0 ) { return ( tot > 0 ) ?tot : ret ; } return tot ; } zin -> avail_in = ret ; zin -> next_in = ctx -> ibuf ; } } 