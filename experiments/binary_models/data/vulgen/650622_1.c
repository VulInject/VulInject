static int __init intel_cqm_init ( void ) { char * str = NULL , scale [ 20 ] ; int cpu , ret ; if ( x86_match_cpu ( intel_cqm_match ) ) { cqm_enabled = true ; } if ( x86_match_cpu ( intel_mbm_local_match ) && x86_match_cpu ( intel_mbm_total_match ) ) { mbm_enabled = true ; } if ( ! cqm_enabled && ! mbm_enabled ) { return - ENODEV ; } cqm_l3_scale = boot_cpu_data . x86_cache_occ_scale ; get_online_cpus ( ) ; for_each_online_cpu ( ) { struct cpuinfo_x86 * c = & cpu_data ( cpu ) ; if ( c -> x86_cache_max_rmid < cqm_max_rmid ) { cqm_max_rmid = c -> x86_cache_max_rmid ; } } __intel_cqm_max_threshold = boot_cpu_data . x86_cache_size * 1024 / ( cqm_max_rmid + 1 ) ; snprintf ( scale , sizeof ( scale ) , "%u" , cqm_l3_scale ) ; str = kstrdup ( scale , GFP_KERNEL ) ; if ( ! str ) { ret = - ENOMEM ; out } event_attr_intel_cqm_llc_scale . event_str = str ; ret = intel_cqm_setup_rmid_cache ( ) ; if ( ret ) { out } if ( mbm_enabled ) { ret = intel_mbm_init ( ) ; } if ( ret && ! cqm_enabled ) { out } if ( cqm_enabled && mbm_enabled ) { intel_cqm_events_group . attrs = intel_cmt_mbm_events_attr ; } if ( ! cqm_enabled && mbm_enabled ) { intel_cqm_events_group . attrs = intel_mbm_events_attr ; } if ( cqm_enabled && ! mbm_enabled ) { intel_cqm_events_group . attrs = intel_cqm_events_attr ; } ret = perf_pmu_register ( & intel_cqm_pmu , "intel_cqm" , - 1 ) ; if ( ret ) { pr_err ( "Intel CQM perf registration failed: %d\n" , ret ) ; out } if ( cqm_enabled ) { pr_info ( "Intel CQM monitoring enabled\n" ) ; } if ( mbm_enabled ) { pr_info ( "Intel MBM enabled\n" ) ; } cpuhp_setup_state ( CPUHP_AP_PERF_X86_CQM_STARTING , "perf/x86/cqm:starting" , intel_cqm_cpu_starting , NULL ) ; cpuhp_setup_state ( CPUHP_AP_PERF_X86_CQM_ONLINE , "perf/x86/cqm:online" , NULL , intel_cqm_cpu_exit ) ; out put_online_cpus ( ) ; if ( ret ) { kfree ( str ) ; cqm_cleanup ( ) ; mbm_cleanup ( ) ; } return ret ; } 