int qib_twsi_reset ( struct qib_devdata * dd ) { int clock_cycles_left = 9 ; int was_high = 0 ; u32 pins , mask ; dd -> f_gpio_mod ( dd , 0 , 0 , mask ) ; while ( clock_cycles_left -- ) { scl_out ( dd , 0 ) ; scl_out ( dd , 1 ) ; was_high |= sda_in ( dd , 0 ) ; } if ( was_high ) { pins = dd -> f_gpio_mod ( dd , 0 , 0 , 0 ) ; if ( ( pins & mask ) != mask ) { qib_dev_err ( dd , "GPIO pins not at rest: %d\n" , pins & mask ) ; } udelay ( 1 ) ; sda_out ( dd , 0 ) ; udelay ( 1 ) ; sda_out ( dd , 1 ) ; udelay ( TWSI_BUF_WAIT_USEC ) ; } return ! was_high ; } 