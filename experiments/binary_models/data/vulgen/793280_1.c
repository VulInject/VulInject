static void test_tortls_log_one_error ( void * ignored ) { ( void ) ignored ; tor_tls_t * tls ; SSL_CTX * ctx ; SSL * ssl = NULL ; library_init ( ) ; ctx = SSL_CTX_new ( SSLv23_method ( ) ) ; tls = tor_malloc_zero ( sizeof ( tor_tls_t ) ) ; setup_capture_of_logs ( LOG_INFO ) ; tor_tls_log_one_error ( NULL , 0 , LOG_WARN , 0 , "something" ) ; expect_log_msg ( "TLS error while something: " "(null) (in (null):(null):---)\n" ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , 0 , LOG_WARN , 0 , NULL ) ; expect_log_msg ( "TLS error: (null) " "(in (null):(null):---)\n" ) ; mock_clean_saved_logs ( ) ; tls -> address = tor_strdup ( "127.hello" ) ; tor_tls_log_one_error ( tls , 0 , LOG_WARN , 0 , NULL ) ; expect_log_msg ( "TLS error with 127.hello: " "(null) (in (null):(null):---)\n" ) ; mock_clean_saved_logs ( ) ; tls -> address = tor_strdup ( "127.hello" ) ; tor_tls_log_one_error ( tls , 0 , LOG_WARN , 0 , "blarg" ) ; expect_log_msg ( "TLS error while blarg with " "127.hello: (null) (in (null):(null):---)\n" ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , ERR_PACK ( 1 , 2 , 3 ) , LOG_WARN , 0 , NULL ) ; expect_log_msg_containing ( "TLS error with 127.hello" ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , ERR_PACK ( 1 , 2 , SSL_R_HTTP_REQUEST ) , LOG_WARN , 0 , NULL ) ; expect_log_severity ( LOG_INFO ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , ERR_PACK ( 1 , 2 , SSL_R_HTTPS_PROXY_REQUEST ) , LOG_WARN , 0 , NULL ) ; expect_log_severity ( LOG_INFO ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , ERR_PACK ( 1 , 2 , SSL_R_RECORD_LENGTH_MISMATCH ) , LOG_WARN , 0 , NULL ) ; expect_log_severity ( LOG_INFO ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , ERR_PACK ( 1 , 2 , SSL_R_RECORD_TOO_LARGE ) , LOG_WARN , 0 , NULL ) ; expect_log_severity ( LOG_INFO ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , ERR_PACK ( 1 , 2 , SSL_R_UNKNOWN_PROTOCOL ) , LOG_WARN , 0 , NULL ) ; expect_log_severity ( LOG_INFO ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , ERR_PACK ( 1 , 2 , SSL_R_UNSUPPORTED_PROTOCOL ) , LOG_WARN , 0 , NULL ) ; expect_log_severity ( LOG_INFO ) ; tls -> ssl = SSL_new ( ctx ) ; mock_clean_saved_logs ( ) ; tor_tls_log_one_error ( tls , 0 , LOG_WARN , 0 , NULL ) ; expect_log_msg ( "TLS error with 127.hello: (null)" " (in (null):(null):" SSL_STATE_STR ")\n" ) ; done teardown_capture_of_logs ( ) ; SSL_free ( ssl ) ; SSL_CTX_free ( ctx ) ; if ( tls && tls -> ssl ) { SSL_free ( tls -> ssl ) ; } if ( tls ) { tor_free ( tls -> address ) ; } tor_free ( tls ) ; } 