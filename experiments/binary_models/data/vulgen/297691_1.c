static void gb_loopback_disconnect ( struct gb_bundle * bundle ) { struct gb_loopback * gb = greybus_get_drvdata ( bundle ) ; unsigned long flags ; int ret ; ret = gb_pm_runtime_get_sync ( bundle ) ; if ( ret ) { gb_pm_runtime_get_noresume ( bundle ) ; } gb_connection_disable ( gb -> connection ) ; if ( ! IS_ERR_OR_NULL ( gb -> task ) ) { kthread_stop ( gb -> task ) ; } kfifo_free ( & gb -> kfifo_lat ) ; gb_connection_latency_tag_disable ( gb -> connection ) ; debugfs_remove ( gb -> file ) ; gb_loopback_async_wait_all ( gb ) ; spin_lock_irqsave ( & gb_dev . lock , flags ) ; gb_dev . count -- ; spin_unlock_irqrestore ( & gb_dev . lock , flags ) ; device_unregister ( gb -> dev ) ; ida_simple_remove ( & loopback_ida , gb -> id ) ; gb_connection_destroy ( gb -> connection ) ; } 