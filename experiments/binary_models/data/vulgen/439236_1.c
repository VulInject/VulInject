static int at91_gpio_of_irq_setup ( struct platform_device * pdev , struct at91_gpio_chip * at91_gpio ) { struct gpio_chip * gpiochip_prev = NULL ; struct at91_gpio_chip * prev = NULL ; struct irq_data * d = irq_get_irq_data ( at91_gpio -> pioc_virq ) ; int ret , i ; at91_gpio -> pioc_hwirq = irqd_to_hwirq ( d ) ; gpio_irqchip . irq_set_type = at91_gpio -> ops -> irq_type ; writel_relaxed ( ~ 0 , at91_gpio -> regbase + PIO_IDR ) ; ret = gpiochip_irqchip_add ( & at91_gpio -> chip , & gpio_irqchip , 0 , handle_edge_irq , IRQ_TYPE_NONE ) ; gpiochip_prev = irq_get_handler_data ( at91_gpio -> pioc_virq ) ; if ( ! gpiochip_prev ) { gpiochip_set_chained_irqchip ( & at91_gpio -> chip , & gpio_irqchip , at91_gpio -> pioc_virq , gpio_irq_handler ) ; return 0 ; } prev = gpiochip_get_data ( gpiochip_prev ) ; for ( i = 0 ; i < 2 ; i ++ ) { if ( prev -> next ) { prev = prev -> next ; } else { prev -> next = at91_gpio ; return 0 ; } } return - EINVAL ; } 