ospf_zebra_add ( , ) { u_char message ; u_char distance ; u_char flags ; int psize ; struct stream * s ; struct ospf_path * path ; struct listnode * node ; if ( vrf_bitmap_check ( zclient -> redist [ ZEBRA_ROUTE_OSPF ] , VRF_DEFAULT ) ) { message = 0 ; flags = 0 ; SET_FLAG ( message , ZAPI_MESSAGE_NEXTHOP ) ; SET_FLAG ( message , ZAPI_MESSAGE_METRIC ) ; distance = ospf_distance_apply ( p , or ) ; if ( distance ) { SET_FLAG ( message , ZAPI_MESSAGE_DISTANCE ) ; } if ( ( ( or -> path_type == OSPF_PATH_TYPE1_EXTERNAL ) || ( or -> path_type == OSPF_PATH_TYPE2_EXTERNAL ) ) && ( or -> u . ext . tag > 0 ) && ( or -> u . ext . tag <= ROUTE_TAG_MAX ) ) { SET_FLAG ( message , ZAPI_MESSAGE_TAG ) ; } s = zclient -> obuf ; stream_reset ( s ) ; zclient_create_header ( s , ZEBRA_IPV4_ROUTE_ADD , VRF_DEFAULT ) ; stream_putc ( s , ZEBRA_ROUTE_OSPF ) ; stream_putc ( s , flags ) ; stream_putc ( s , message ) ; stream_putw ( s , SAFI_UNICAST ) ; psize = PSIZE ( p -> prefixlen ) ; stream_putc ( s , p -> prefixlen ) ; stream_write ( s , ( u_char * ) & p -> prefix , psize ) ; stream_putc ( s , or -> paths -> count ) ; for ( ALL_LIST_ELEMENTS_RO ( or -> paths , node , path ) ; ) { if ( path -> nexthop . s_addr != INADDR_ANY && path -> ifindex != 0 ) { stream_put_in_addr ( s , & path -> nexthop ) ; stream_putl ( s , path -> ifindex ) ; } if ( path -> nexthop . s_addr != INADDR_ANY ) { stream_putc ( s , ZEBRA_NEXTHOP_IPV4 ) ; stream_put_in_addr ( s , & path -> nexthop ) ; } else { stream_putc ( s , ZEBRA_NEXTHOP_IFINDEX ) ; if ( path -> ifindex ) { stream_putl ( s , path -> ifindex ) ; } else { stream_putl ( s , 0 ) ; } } if ( IS_DEBUG_OSPF ( zebra , ZEBRA_REDISTRIBUTE ) ) { char buf [ 2 ] [ INET_ADDRSTRLEN ] ; zlog_debug ( "Zebra: Route add %s/%d nexthop %s" , inet_ntop ( AF_INET , & p -> prefix , buf [ 0 ] , sizeof ( buf [ 0 ] ) ) , p -> prefixlen , inet_ntop ( AF_INET , & path -> nexthop , buf [ 1 ] , sizeof ( buf [ 1 ] ) ) ) ; } } if ( CHECK_FLAG ( message , ZAPI_MESSAGE_DISTANCE ) ) { stream_putc ( s , distance ) ; } if ( CHECK_FLAG ( message , ZAPI_MESSAGE_METRIC ) ) { if ( or -> path_type == OSPF_PATH_TYPE1_EXTERNAL ) { stream_putl ( s , or -> cost + or -> u . ext . type2_cost ) ; } if ( or -> path_type == OSPF_PATH_TYPE2_EXTERNAL ) { stream_putl ( s , or -> u . ext . type2_cost ) ; } else { stream_putl ( s , or -> cost ) ; } } if ( CHECK_FLAG ( message , ZAPI_MESSAGE_TAG ) ) { stream_putl ( s , or -> u . ext . tag ) ; } stream_putw_at ( s , 0 , stream_get_endp ( s ) ) ; zclient_send_message ( zclient ) ; } } 