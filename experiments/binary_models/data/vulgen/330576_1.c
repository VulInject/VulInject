static void populate_subvp_cmd_drr_info ( struct dc * dc , struct pipe_ctx * subvp_pipe , struct pipe_ctx * vblank_pipe , struct dmub_cmd_fw_assisted_mclk_switch_pipe_data_v2 * pipe_data ) { struct dc_crtc_timing * main_timing = & subvp_pipe -> stream -> timing ; struct dc_crtc_timing * phantom_timing = & subvp_pipe -> stream -> mall_stream_config . paired_stream -> timing ; struct dc_crtc_timing * drr_timing = & vblank_pipe -> stream -> timing ; uint16_t drr_frame_us = 0 ; uint16_t min_drr_supported_us = 0 ; uint16_t max_drr_supported_us = 0 ; uint16_t max_drr_vblank_us = 0 ; uint16_t max_drr_mallregion_us = 0 ; uint16_t mall_region_us = 0 ; uint16_t prefetch_us = 0 ; uint16_t subvp_active_us = 0 ; uint16_t drr_active_us = 0 ; uint16_t min_vtotal_supported = 0 ; uint16_t max_vtotal_supported = 0 ; pipe_data -> pipe_config . vblank_data . drr_info . drr_in_use = true ; pipe_data -> pipe_config . vblank_data . drr_info . use_ramping = false ; pipe_data -> pipe_config . vblank_data . drr_info . drr_window_size_ms = 4 ; drr_frame_us = div64_u64 ( ( ( uint64_t ) drr_timing -> v_total * drr_timing -> h_total * 1000000 ) , ( ( ( uint64_t ) drr_timing -> pix_clk_100hz * 100 ) ) ) ; mall_region_us = div64_u64 ( ( ( uint64_t ) phantom_timing -> v_addressable * phantom_timing -> h_total * 1000000 ) , ( ( ( uint64_t ) phantom_timing -> pix_clk_100hz * 100 ) ) ) ; min_drr_supported_us = drr_frame_us + mall_region_us + SUBVP_DRR_MARGIN_US ; min_vtotal_supported = div64_u64 ( ( ( uint64_t ) drr_timing -> pix_clk_100hz * 100 * min_drr_supported_us ) , ( ( ( uint64_t ) drr_timing -> h_total * 1000000 ) ) ) ; prefetch_us = div64_u64 ( ( ( uint64_t ) ( phantom_timing -> v_total - phantom_timing -> v_front_porch ) * phantom_timing -> h_total * 1000000 ) , ( ( ( uint64_t ) phantom_timing -> pix_clk_100hz * 100 ) + dc -> caps . subvp_prefetch_end_to_mall_start_us ) ) ; subvp_active_us = div64_u64 ( ( ( uint64_t ) main_timing -> v_addressable * main_timing -> h_total * 1000000 ) , ( ( ( uint64_t ) main_timing -> pix_clk_100hz * 100 ) ) ) ; drr_active_us = div64_u64 ( ( ( uint64_t ) drr_timing -> v_addressable * drr_timing -> h_total * 1000000 ) , ( ( ( uint64_t ) drr_timing -> pix_clk_100hz * 100 ) ) ) ; max_drr_vblank_us = div64_u64 ( ( subvp_active_us - prefetch_us - drr_active_us ) , 2 ) + drr_active_us ; max_drr_mallregion_us = subvp_active_us - prefetch_us - mall_region_us ; max_drr_supported_us = max_drr_vblank_us > max_drr_mallregion_us ?max_drr_vblank_us : max_drr_mallregion_us ; max_vtotal_supported = div64_u64 ( ( ( uint64_t ) drr_timing -> pix_clk_100hz * 100 * max_drr_supported_us ) , ( ( ( uint64_t ) drr_timing -> h_total * 1000000 ) ) ) ; pipe_data -> pipe_config . vblank_data . drr_info . min_vtotal_supported = min_vtotal_supported ; } 