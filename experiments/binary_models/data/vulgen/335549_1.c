static ssize_t pkey_ccacipher_aes_attr_read ( enum pkey_key_size keybits , bool is_xts , char * buf , loff_t off , size_t count ) { int i , rc , card , dom ; u32 nr_apqns , * apqns = NULL ; size_t keysize = CCACIPHERTOKENSIZE ; if ( off != 0 || count < CCACIPHERTOKENSIZE ) { return - EINVAL ; } if ( is_xts ) { if ( count < 2 * CCACIPHERTOKENSIZE ) { return - EINVAL ; } } rc = cca_findcard2 ( & apqns , & nr_apqns , 0xFFFF , 0xFFFF , ZCRYPT_CEX6 , 0 , 0 , 0 , 0 ) ; if ( rc ) { return rc ; } memset ( buf , 0 , is_xts ?2 * keysize : keysize ) ; for ( i = 0 , rc = - ENODEV ; i < nr_apqns ; i ++ ) { card = apqns [ i ] >> 16 ; dom = apqns [ i ] & 0xFFFF ; rc = cca_gencipherkey ( card , dom , keybits , 0 , buf , & keysize ) ; if ( rc == 0 ) { break ; } } if ( rc ) { return rc ; } if ( is_xts ) { keysize = CCACIPHERTOKENSIZE ; buf += CCACIPHERTOKENSIZE ; rc = cca_gencipherkey ( card , dom , keybits , 0 , buf , & keysize ) ; } return CCACIPHERTOKENSIZE ; } 