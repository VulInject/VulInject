static int ipoib_cm_tx_handler ( struct ib_cm_id * cm_id , struct ib_cm_event * event ) { struct ipoib_cm_tx * tx = cm_id -> context ; struct ipoib_dev_priv * priv = ipoib_priv ( tx -> dev ) ; struct net_device * dev = priv -> dev ; struct ipoib_neigh * neigh ; unsigned long flags ; int ret ; switch ( event -> event ) { case IB_CM_DREQ_RECEIVED : ipoib_dbg ( priv , "DREQ received.\n" ) ; ib_send_cm_drep ( cm_id , NULL , 0 ) ; break ; case IB_CM_REP_RECEIVED : ipoib_dbg ( priv , "REP received.\n" ) ; ret = ipoib_cm_rep_handler ( cm_id , event ) ; break ; case IB_CM_REQ_ERROR : case IB_CM_REJ_RECEIVED : case IB_CM_TIMEWAIT_EXIT : ipoib_dbg ( priv , "CM error %d.\n" , event -> event ) ; netif_tx_lock_bh ( dev ) ; spin_lock_irqsave ( & priv -> lock , flags ) ; neigh = tx -> neigh ; if ( neigh ) { neigh -> cm = NULL ; ipoib_neigh_free ( neigh ) ; tx -> neigh = NULL ; } if ( test_and_clear_bit ( IPOIB_FLAG_INITIALIZED , & tx -> flags ) ) { list_move ( & tx -> list , & priv -> cm . reap_list ) ; queue_work ( priv -> wq , & priv -> cm . reap_task ) ; } spin_unlock_irqrestore ( & priv -> lock , flags ) ; netif_tx_unlock_bh ( dev ) ; break ; default : break ; } return 0 ; } 