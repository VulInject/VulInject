struct mtk_ppe * mtk_ppe_init ( struct mtk_eth * eth , void __iomem * base , int version , int index ) { const struct mtk_soc_data * soc = eth -> soc ; struct device * dev = eth -> dev ; struct mtk_ppe * ppe ; u32 foe_flow_size ; void * foe ; ppe = devm_kzalloc ( dev , sizeof ( * ppe ) , GFP_KERNEL ) ; rhashtable_init ( & ppe -> l2_flows , & mtk_flow_l2_ht_params ) ; ppe -> base = base ; ppe -> eth = eth ; ppe -> dev = dev ; ppe -> version = version ; foe = dmam_alloc_coherent ( ppe -> dev , MTK_PPE_ENTRIES * soc -> foe_entry_size , & ppe -> foe_phys , GFP_KERNEL ) ; if ( ! foe ) { err_free_l2_flows } ppe -> foe_table = foe ; foe_flow_size = ( MTK_PPE_ENTRIES / soc -> hash_offset ) * sizeof ( * ppe -> foe_flow ) ; ppe -> foe_flow = devm_kzalloc ( dev , foe_flow_size , GFP_KERNEL ) ; if ( ! ppe -> foe_flow ) { err_free_l2_flows } mtk_ppe_debugfs_init ( ppe , index ) ; return ppe ; err_free_l2_flows rhashtable_destroy ( & ppe -> l2_flows ) ; return NULL ; } 