FSTATUS ResMapAllocate ( IN RESOURCE_MAP * const pResMap , OUT uint32 * pNumber ) { uint32 Size ; uint32 Number ; FSTATUS Status ; ASSERT ( pResMap ) ; Size = BitVectorGetSize ( & pResMap -> m_ResList ) ; Number = BitVectorFindFromIndex ( & pResMap -> m_ResList , FALSE , pResMap -> m_NextFree ) ; if ( Number < Size ) { Status = BitVectorSet ( & pResMap -> m_ResList , Number , 1 ) ; if ( Status != FSUCCESS ) { return Status ; } found } if ( pResMap -> m_FirstFree < pResMap -> m_NextFree ) { Number = BitVectorFindRange ( & pResMap -> m_ResList , FALSE , pResMap -> m_FirstFree , pResMap -> m_NextFree ) ; if ( Number == pResMap -> m_NextFree ) { Number = Size ; } } else { Number = Size ; } Status = BitVectorSet ( & pResMap -> m_ResList , Number , 1 ) ; if ( Status != FSUCCESS ) { return Status ; } pResMap -> m_FirstFree = Number + 1 ; found pResMap -> m_NextFree = Number + 1 ; ++ ( pResMap -> m_NumAllocated ) ; * pNumber = Number ; return FSUCCESS ; } 