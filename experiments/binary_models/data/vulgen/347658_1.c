void xive_hvi ( struct trapframe * frame ) { struct xive_softc * sc = xive_sc ; struct cpu_info * ci = curcpu ( ) ; struct intrhand * ih ; struct xive_eq * eq ; uint32_t * event ; uint32_t lirq ; int old ; uint16_t ack , he ; uint8_t cppr ; old = ci -> ci_cpl ; while ( 1 ) { ack = xive_read_2 ( sc , XIVE_TM_SPC_ACK_HV ) ; he = ( ack & XIVE_TM_SPC_ACK_HE_MASK ) ; if ( he == XIVE_TM_SPC_ACK_HE_NONE ) { break ; } KASSERT ( he == XIVE_TM_SPC_ACK_HE_PHYS ) ; eieio ( ) ; cppr = ack ; new = xive_ipl ( cppr ) ; if ( new <= old ) { spurious } ci -> ci_cpl = new ; KASSERT ( cppr < XIVE_NUM_PRIORITIES ) ; eq = & sc -> sc_eq [ ci -> ci_cpuid ] [ cppr ] ; event = XIVE_DMA_KVA ( eq -> eq_queue ) ; while ( ( event [ eq -> eq_idx ] & XIVE_EQ_GEN_MASK ) == eq -> eq_gen ) { lirq = event [ eq -> eq_idx ] & ~ XIVE_EQ_GEN_MASK ; KASSERT ( lirq < XIVE_NUM_IRQS ) ; ih = sc -> sc_handler [ lirq ] ; if ( ih != NULL ) { intr_enable ( ) ; xive_run_handler ( ih ) ; intr_disable ( ) ; xive_eoi ( sc , ih ) ; } eq -> eq_idx = ( eq -> eq_idx + 1 ) & XIVE_EQ_IDX_MASK ; } ci -> ci_cpl = old ; spurious xive_write_1 ( sc , XIVE_TM_CPPR_HV , xive_prio ( old ) ) ; eieio ( ) ; } } 