int of_irq_parse_raw ( const __be32 * addr , struct of_phandle_args * out_irq ) { struct device_node * ipar , * tnode , * old = NULL , * newpar = NULL ; __be32 initial_match_array [ MAX_PHANDLE_ARGS ] ; const __be32 * match_array = initial_match_array ; const __be32 * tmp , * imap , * imask , dummy_imask [ ] { [ 0 ... MAX_PHANDLE_ARGS ] = cpu_to_be32 ( 0 ) } ; ; u32 intsize = 1 , addrsize , newintsize = 0 , newaddrsize = 0 ; int imaplen , match , i , rc = - EINVAL ; of_print_phandle_args ( "of_irq_parse_raw: " , out_irq ) ; ipar = of_node_get ( out_irq -> np ) ; { tmp = of_get_property ( ipar , "#interrupt-cells" , NULL ) ; if ( tmp != NULL ) { intsize = be32_to_cpu ( * tmp ) ; break ; } tnode = ipar ; ipar = of_irq_find_parent ( ipar ) ; of_node_put ( tnode ) ; } if ( ipar == NULL ) { pr_debug ( " ->no parent found !\n" ) ; fail } pr_debug ( "of_irq_parse_raw: ipar=%s, size=%d\n" , of_node_full_name ( ipar ) , intsize ) ; if ( out_irq -> args_count != intsize ) { fail } old = of_node_get ( ipar ) ; { tmp = of_get_property ( old , "#address-cells" , NULL ) ; tnode = of_get_parent ( old ) ; of_node_put ( old ) ; old = tnode ; } old && tmp == NULL ; of_node_put ( old ) ; old = NULL ; addrsize = ( tmp == NULL ) ?2 : be32_to_cpu ( * tmp ) ; pr_debug ( " ->addrsize=%d\n" , addrsize ) ; if ( WARN_ON ( addrsize + intsize > MAX_PHANDLE_ARGS ) ) { rc = - EFAULT ; fail } for ( i = 0 ; i < addrsize ; i ++ ) { initial_match_array [ i ] = addr ?addr [ i ] : 0 ; } for ( i = 0 ; i < intsize ; i ++ ) { initial_match_array [ addrsize + i ] = cpu_to_be32 ( out_irq -> args [ i ] ) ; } while ( ipar != NULL ) { if ( of_get_property ( ipar , "interrupt-controller" , NULL ) != NULL ) { pr_debug ( " ->got it !\n" ) ; return 0 ; } if ( addrsize && ! addr ) { pr_debug ( " ->no reg passed in when needed !\n" ) ; fail } imap = of_get_property ( ipar , "interrupt-map" , & imaplen ) ; if ( imap == NULL ) { pr_debug ( " ->no map, getting parent\n" ) ; newpar = of_irq_find_parent ( ipar ) ; skiplevel } imaplen /= sizeof ( u32 ) ; imask = of_get_property ( ipar , "interrupt-map-mask" , NULL ) ; if ( ! imask ) { imask = dummy_imask ; } match = 0 ; while ( imaplen > ( addrsize + intsize + 1 ) && ! match ) { match = 1 ; for ( i = 0 ; i < ( addrsize + intsize ) ; i ++ , imaplen -- ) { match &= ! ( ( match_array [ i ] ^ * imap ++ ) & imask [ i ] ) ; } pr_debug ( " ->match=%d (imaplen=%d)\n" , match , imaplen ) ; if ( of_irq_workarounds & OF_IMAP_NO_PHANDLE ) { newpar = of_node_get ( of_irq_dflt_pic ) ; } else { newpar = of_find_node_by_phandle ( be32_to_cpup ( imap ) ) ; } imap ++ ; -- imaplen ; if ( newpar == NULL ) { pr_debug ( " ->imap parent not found !\n" ) ; fail } if ( ! of_device_is_available ( newpar ) ) { match = 0 ; } tmp = of_get_property ( newpar , "#interrupt-cells" , NULL ) ; if ( tmp == NULL ) { pr_debug ( " ->parent lacks #interrupt-cells!\n" ) ; fail } newintsize = be32_to_cpu ( * tmp ) ; tmp = of_get_property ( newpar , "#address-cells" , NULL ) ; newaddrsize = ( tmp == NULL ) ?0 : be32_to_cpu ( * tmp ) ; pr_debug ( " ->newintsize=%d, newaddrsize=%d\n" , newintsize , newaddrsize ) ; if ( WARN_ON ( newaddrsize + newintsize > MAX_PHANDLE_ARGS ) || ( imaplen < ( newaddrsize + newintsize ) ) ) { rc = - EFAULT ; fail } imap += newaddrsize + newintsize ; imaplen -= newaddrsize + newintsize ; pr_debug ( " ->imaplen=%d\n" , imaplen ) ; } if ( ! match ) { fail } match_array = imap - newaddrsize - newintsize ; for ( i = 0 ; i < newintsize ; i ++ ) { out_irq -> args [ i ] = be32_to_cpup ( imap - newintsize + i ) ; } out_irq -> args_count = intsize = newintsize ; addrsize = newaddrsize ; skiplevel out_irq -> np = newpar ; pr_debug ( " ->new parent: %s\n" , of_node_full_name ( newpar ) ) ; of_node_put ( ipar ) ; ipar = newpar ; newpar = NULL ; } rc = - ENOENT ; fail of_node_put ( ipar ) ; of_node_put ( newpar ) ; return rc ; } 