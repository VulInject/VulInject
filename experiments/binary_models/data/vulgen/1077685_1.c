int db_redis_append_command_argv ( km_redis_con_t * con , redis_key_t * query , int queue ) { char * * argv = NULL ; int ret , argc ; print_query ( query ) ; if ( queue > 0 && db_redis_push_query ( con , query ) != 0 ) { LM_ERR ( "Failed to queue redis command\n" ) ; return - 1 ; } argc = db_redis_key_list2arr ( query , & argv ) ; if ( argc < 0 ) { LM_ERR ( "Failed to allocate memory for query array\n" ) ; return - 1 ; } LM_DBG ( "query has %d args\n" , argc ) ; ret = redisAppendCommandArgv ( con -> con , argc , ( const char * * ) argv , NULL ) ; if ( con -> con -> err != REDIS_OK ) { LM_DBG ( "redis connection is gone, try reconnect. (%d:%s)\n" , con -> con -> err , con -> con -> errstr ) ; if ( db_redis_connect ( con ) != 0 ) { LM_ERR ( "Failed to reconnect to redis db\n" ) ; if ( con -> con ) { redisFree ( con -> con ) ; con -> con = NULL ; } return ret ; } ret = redisAppendCommandArgv ( con -> con , argc , ( const char * * ) argv , NULL ) ; } pkg_free ( argv ) ; if ( ! con -> con -> err ) { con -> append_counter ++ ; } return ret ; } 