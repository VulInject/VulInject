void mediabay_kthread ( void * v ) { struct mediabay_softc * sc = v ; u_int x , fcr ; sleep tsleep_nsec ( & sc -> sc_kthread , PRIBIO , "mbayev" , INFSLP ) ; tsleep_nsec ( mediabay_kthread , PRIBIO , "mbayev" , MSEC_TO_NSEC ( 250 ) ) ; DPRINTF ( "%s: " , sc -> sc_dev . dv_xname ) ; x = in32rb ( sc -> sc_addr ) ; switch ( MEDIABAY_ID ( x ) ) { case MEDIABAY_ID_NONE : DPRINTF ( "removed\n" ) ; if ( sc -> sc_content != NULL ) { config_detach ( sc -> sc_content , DETACH_FORCE ) ; DPRINTF ( "%s: detach done\n" , sc -> sc_dev . dv_xname ) ; sc -> sc_content = NULL ; fcr = in32rb ( sc -> sc_fcr ) ; fcr &= ~ ( FCR_MEDIABAY_ENABLE | FCR_MEDIABAY_IDE_ENABLE | FCR_MEDIABAY_CD_POWER | FCR_MEDIABAY_FD_ENABLE ) ; out32rb ( sc -> sc_fcr , fcr ) ; } break ; case MEDIABAY_ID_FD : DPRINTF ( "FD inserted\n" ) ; break ; case MEDIABAY_ID_CD : DPRINTF ( "CD inserted\n" ) ; break ; default : printf ( "unknown event (0x%x)\n" , x ) ; } sleep } 