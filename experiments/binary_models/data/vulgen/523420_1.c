void fusbtc_toggle_change ( struct fusbtc_softc * sc ) { uint8_t cc , reg ; uint8_t status ; int pol ; status = fusbtc_read_reg ( sc , FUSB_STATUS1A ) ; status &= FUSB_STATUS1A_TOGSS_MASK ; if ( FUSB_STATUS1A_TOGSS_CC1 ( status ) ) { pol = TYPEC_POLARITY_CC1 ; } else { pol = TYPEC_POLARITY_CC2 ; } if ( status == FUSB_STATUS1A_TOGSS_SRC1 || status == FUSB_STATUS1A_TOGSS_SRC2 ) { DPRINTF ( ( "%s: attached (source)\n" , sc -> sc_dev . dv_xname ) ) ; fusbtc_set_cc_pull ( sc , pol , 1 , 0 ) ; fusbtc_set_polarity ( sc , pol ) ; fusbtc_write_reg ( sc , FUSB_MEASURE , fusbtc_rd_mda [ SRC_CURRENT_DEFAULT ] ) ; delay ( 100 ) ; reg = fusbtc_read_reg ( sc , FUSB_STATUS0 ) ; cc = TYPEC_CC_OPEN ; if ( ( reg & FUSB_STATUS0_COMP ) == 0 ) { fusbtc_write_reg ( sc , FUSB_MEASURE , fusbtc_ra_mda [ SRC_CURRENT_DEFAULT ] ) ; delay ( 100 ) ; reg = fusbtc_read_reg ( sc , FUSB_STATUS0 ) ; if ( ( reg & FUSB_STATUS0_COMP ) == 0 ) { cc = TYPEC_CC_RA ; } } if ( cc == TYPEC_CC_OPEN ) { fusbtc_toggle ( sc , 1 ) ; return ; } fusbtc_toggle ( sc , 0 ) ; fusbtc_write_reg ( sc , FUSB_MEASURE , fusbtc_rd_mda [ SRC_CURRENT_DEFAULT ] ) ; fusbtc_clr_reg ( sc , FUSB_MASK , FUSB_MASK_COMP_CHNG ) ; fusbtc_set_roles ( sc , TYPEC_HOST , TYPEC_SOURCE ) ; fusbtc_set_vbus ( sc , 1 , 0 ) ; sc -> sc_attached = 1 ; } if ( status == FUSB_STATUS1A_TOGSS_SNK1 || status == FUSB_STATUS1A_TOGSS_SNK2 ) { DPRINTF ( ( "%s: attached (sink)\n" , sc -> sc_dev . dv_xname ) ) ; fusbtc_set_cc_pull ( sc , pol , 0 , 1 ) ; fusbtc_set_polarity ( sc , pol ) ; reg = fusbtc_read_reg ( sc , FUSB_STATUS0 ) ; reg &= FUSB_STATUS0_BC_LVL_MASK ; if ( fusbtc_bclvl_to_typec ( reg ) == TYPEC_CC_OPEN ) { fusbtc_toggle ( sc , 1 ) ; return ; } fusbtc_toggle ( sc , 0 ) ; fusbtc_clr_reg ( sc , FUSB_MASK , FUSB_MASK_BC_LVL ) ; fusbtc_set_roles ( sc , TYPEC_DEVICE , TYPEC_SINK ) ; fusbtc_set_vbus ( sc , 0 , 0 ) ; sc -> sc_attached = 1 ; } else { panic ( "%s: unknown combination %x" , sc -> sc_dev . dv_xname , status ) ; } } 