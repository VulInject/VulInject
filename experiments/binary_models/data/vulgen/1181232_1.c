static void infra_test ( void ) { struct sockaddr_storage one ; socklen_t onelen ; uint8_t * zone = ( uint8_t * ) "\007example\003com\000" ; size_t zonelen = 13 ; struct infra_cache * slab ; struct config_file * cfg = config_create ( ) ; time_t now = 0 ; uint8_t edns_lame ; int vs , to ; struct infra_key * k ; struct infra_data * d ; int init = 376 ; unit_show_feature ( "infra cache" ) ; unit_assert ( ipstrtoaddr ( "127.0.0.1" , 53 , & one , & onelen ) ) ; slab = infra_create ( cfg ) ; unit_assert ( infra_host ( slab , & one , onelen , zone , zonelen , now , & vs , & edns_lame , & to ) ) ; unit_assert ( vs == 0 && to == init && edns_lame == 0 ) ; unit_assert ( infra_rtt_update ( slab , & one , onelen , zone , zonelen , LDNS_RR_TYPE_A , - 1 , init , now ) ) ; unit_assert ( infra_host ( slab , & one , onelen , zone , zonelen , now , & vs , & edns_lame , & to ) ) ; unit_assert ( vs == 0 && to == init * 2 && edns_lame == 0 ) ; unit_assert ( infra_edns_update ( slab , & one , onelen , zone , zonelen , - 1 , now ) ) ; unit_assert ( infra_host ( slab , & one , onelen , zone , zonelen , now , & vs , & edns_lame , & to ) ) ; unit_assert ( vs == - 1 && to == init * 2 && edns_lame == 1 ) ; now += cfg -> host_ttl + 10 ; unit_assert ( infra_host ( slab , & one , onelen , zone , zonelen , now , & vs , & edns_lame , & to ) ) ; unit_assert ( vs == 0 && to == init && edns_lame == 0 ) ; unit_assert ( infra_set_lame ( slab , & one , onelen , zone , zonelen , now , 0 , 0 , LDNS_RR_TYPE_A ) ) ; unit_assert ( ( d = infra_lookup_host ( slab , & one , onelen , zone , zonelen , 0 , now , & k ) ) ) ; unit_assert ( d -> ttl == now + cfg -> host_ttl ) ; unit_assert ( d -> edns_version == 0 ) ; unit_assert ( ! d -> isdnsseclame && ! d -> rec_lame && d -> lame_type_A && ! d -> lame_other ) ; lock_rw_unlock ( & k -> entry . lock ) ; unit_assert ( infra_set_lame ( slab , & one , onelen , zone , zonelen , now , 0 , 0 , LDNS_RR_TYPE_AAAA ) ) ; unit_assert ( ( d = infra_lookup_host ( slab , & one , onelen , zone , zonelen , 0 , now , & k ) ) ) ; unit_assert ( ! d -> isdnsseclame && ! d -> rec_lame && d -> lame_type_A && d -> lame_other ) ; lock_rw_unlock ( & k -> entry . lock ) ; now += cfg -> host_ttl + 10 ; unit_assert ( infra_host ( slab , & one , onelen , zone , zonelen , now , & vs , & edns_lame , & to ) ) ; unit_assert ( vs == 0 && to == init && edns_lame == 0 ) ; unit_assert ( infra_edns_update ( slab , & one , onelen , zone , zonelen , 0 , now ) ) ; unit_assert ( infra_host ( slab , & one , onelen , zone , zonelen , now , & vs , & edns_lame , & to ) ) ; unit_assert ( vs == 0 && to == init && edns_lame == 1 ) ; unit_assert ( infra_edns_update ( slab , & one , onelen , zone , zonelen , - 1 , now ) ) ; unit_assert ( infra_host ( slab , & one , onelen , zone , zonelen , now , & vs , & edns_lame , & to ) ) ; unit_assert ( vs == 0 && to == init && edns_lame == 1 ) ; infra_delete ( slab ) ; } 