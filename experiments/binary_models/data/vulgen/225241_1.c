static time_t get_switching_time ( int to_dst , time_t t_ref ) { time_t t , t1 ; struct tm tmp , tmp1 ; int hints [ ] { 60 120 30 90 0 } ; ; int i ; ( void ) localtime_r ( & t_ref , & tmp ) ; tmp1 = tmp ; tmp1 . tm_sec = 0 ; tmp1 . tm_min = 0 ; if ( ( t = xmktime ( & tmp1 ) ) == ( time_t ) - 1 ) { return ( ( time_t ) - 1 ) ; } for ( i = 0 ; hints [ i ] != 0 ; i ++ ) { t1 = t + hints [ i ] * 60 ; ( void ) localtime_r ( & t1 , & tmp1 ) ; if ( tmp1 . tm_isdst == to_dst ) { t1 -- ; ( void ) localtime_r ( & t1 , & tmp1 ) ; if ( tmp1 . tm_isdst != to_dst ) { return ( t1 + 1 ) ; } } } tmp1 = tmp ; tmp1 . tm_sec = 0 ; if ( ( t = xmktime ( & tmp1 ) ) == ( time_t ) - 1 ) { return ( ( time_t ) - 1 ) ; } while ( t < ( t_ref + 6 * 60 * 60 ) ) { t += 60 ; ( void ) localtime_r ( & t , & tmp ) ; } return ( ( time_t ) - 1 ) ; } 