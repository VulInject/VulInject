int spi_test_execute_msg ( struct spi_device * spi , struct spi_test * test , void * tx , void * rx ) { struct spi_message * msg = & test -> msg ; int ret = 0 ; int i ; if ( ! simulate_only ) { ktime_t start ; if ( dump_messages == 3 ) { spi_test_dump_message ( spi , msg , true ) ; } start = ktime_get ( ) ; ret = spi_sync ( spi , msg ) ; if ( ret == - ETIMEDOUT ) { dev_info ( & spi -> dev , "spi-message timed out - rerunning...\n" ) ; for ( i = 0 ; i < 16 ; i ++ ) { schedule ( ) ; } ret = spi_sync ( spi , msg ) ; } if ( ret ) { dev_err ( & spi -> dev , "Failed to execute spi_message: %i\n" , ret ) ; exit } if ( msg -> frame_length != msg -> actual_length ) { dev_err ( & spi -> dev , "actual length differs from expected\n" ) ; ret = - EIO ; exit } ret = spi_test_check_loopback_result ( spi , msg , tx , rx ) ; if ( ret ) { exit } ret = spi_test_check_elapsed_time ( spi , test ) ; } exit if ( dump_messages || ret ) { spi_test_dump_message ( spi , msg , ( dump_messages >= 2 ) || ( ret ) ) ; } return ret ; } 