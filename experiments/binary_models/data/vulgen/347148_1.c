void wil_vif_remove ( struct wil6210_priv * wil , u8 mid ) { struct wil6210_vif * vif ; struct net_device * ndev ; ASSERT_RTNL ( ) ; if ( mid >= GET_MAX_VIFS ( wil ) ) { wil_err ( wil , "invalid MID: %d\n" , mid ) ; return ; } vif = wil -> vifs [ mid ] ; if ( ! vif ) { wil_err ( wil , "MID %d not registered\n" , mid ) ; return ; } mutex_lock ( & wil -> mutex ) ; wil6210_disconnect ( vif , NULL , WLAN_REASON_DEAUTH_LEAVING ) ; mutex_unlock ( & wil -> mutex ) ; ndev = vif_to_ndev ( vif ) ; cfg80211_unregister_netdevice ( ndev ) ; if ( any_active && vif -> mid != 0 ) { wmi_port_delete ( wil , vif -> mid ) ; } mutex_lock ( & wil -> vif_mutex ) ; wil -> vifs [ mid ] = NULL ; wmb ( ) ; if ( test_bit ( wil_status_napi_en , wil -> status ) ) { napi_synchronize ( & wil -> napi_rx ) ; napi_synchronize ( & wil -> napi_tx ) ; } mutex_unlock ( & wil -> vif_mutex ) ; flush_work ( & wil -> wmi_event_worker ) ; del_timer_sync ( & vif -> connect_timer ) ; cancel_work_sync ( & vif -> disconnect_worker ) ; wil_probe_client_flush ( vif ) ; cancel_work_sync ( & vif -> probe_client_worker ) ; cancel_work_sync ( & vif -> enable_tx_key_worker ) ; } 