static void fsl_imx31_realize ( DeviceState * dev , Error * * errp ) { FslIMX31State * s = FSL_IMX31 ( dev ) ; uint16_t i ; Error * err = NULL ; if ( ! qdev_realize ( DEVICE ( & s -> cpu ) , NULL , errp ) ) { return ; } if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> avic ) , errp ) ) { return ; } sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> avic ) , 0 , FSL_IMX31_AVIC_ADDR ) ; sysbus_connect_irq ( SYS_BUS_DEVICE ( & s -> avic ) , 0 , qdev_get_gpio_in ( DEVICE ( & s -> cpu ) , ARM_CPU_IRQ ) ) ; sysbus_connect_irq ( SYS_BUS_DEVICE ( & s -> avic ) , 1 , qdev_get_gpio_in ( DEVICE ( & s -> cpu ) , ARM_CPU_FIQ ) ) ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> ccm ) , errp ) ) { return ; } sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> ccm ) , 0 , FSL_IMX31_CCM_ADDR ) ; for ( i = 0 ; i < FSL_IMX31_NUM_UARTS ; i ++ ) { static const { hwaddr addr ; unsigned int irq ; } , serial_table [ FSL_IMX31_NUM_UARTS ] { { FSL_IMX31_UART1_ADDR FSL_IMX31_UART1_IRQ } { FSL_IMX31_UART2_ADDR FSL_IMX31_UART2_IRQ } } ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> uart [ i ] ) , errp ) ) { return ; } sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> uart [ i ] ) , 0 , serial_table [ i ] . addr ) ; sysbus_connect_irq ( SYS_BUS_DEVICE ( & s -> uart [ i ] ) , 0 , qdev_get_gpio_in ( DEVICE ( & s -> avic ) , serial_table [ i ] . irq ) ) ; } s -> gpt . ccm = IMX_CCM ( & s -> ccm ) ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> gpt ) , errp ) ) { return ; } sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> gpt ) , 0 , FSL_IMX31_GPT_ADDR ) ; sysbus_connect_irq ( SYS_BUS_DEVICE ( & s -> gpt ) , 0 , qdev_get_gpio_in ( DEVICE ( & s -> avic ) , FSL_IMX31_GPT_IRQ ) ) ; for ( i = 0 ; i < FSL_IMX31_NUM_EPITS ; i ++ ) { static const { hwaddr addr ; unsigned int irq ; } , epit_table [ FSL_IMX31_NUM_EPITS ] { { FSL_IMX31_EPIT1_ADDR FSL_IMX31_EPIT1_IRQ } { FSL_IMX31_EPIT2_ADDR FSL_IMX31_EPIT2_IRQ } } ; s -> epit [ i ] . ccm = IMX_CCM ( & s -> ccm ) ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> epit [ i ] ) , errp ) ) { return ; } sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> epit [ i ] ) , 0 , epit_table [ i ] . addr ) ; sysbus_connect_irq ( SYS_BUS_DEVICE ( & s -> epit [ i ] ) , 0 , qdev_get_gpio_in ( DEVICE ( & s -> avic ) , epit_table [ i ] . irq ) ) ; } for ( i = 0 ; i < FSL_IMX31_NUM_I2CS ; i ++ ) { static const { hwaddr addr ; unsigned int irq ; } , i2c_table [ FSL_IMX31_NUM_I2CS ] { { FSL_IMX31_I2C1_ADDR FSL_IMX31_I2C1_IRQ } { FSL_IMX31_I2C2_ADDR FSL_IMX31_I2C2_IRQ } { FSL_IMX31_I2C3_ADDR FSL_IMX31_I2C3_IRQ } } ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> i2c [ i ] ) , errp ) ) { return ; } sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> i2c [ i ] ) , 0 , i2c_table [ i ] . addr ) ; sysbus_connect_irq ( SYS_BUS_DEVICE ( & s -> i2c [ i ] ) , 0 , qdev_get_gpio_in ( DEVICE ( & s -> avic ) , i2c_table [ i ] . irq ) ) ; } for ( i = 0 ; i < FSL_IMX31_NUM_GPIOS ; i ++ ) { static const { hwaddr addr ; unsigned int irq ; } , gpio_table [ FSL_IMX31_NUM_GPIOS ] { { FSL_IMX31_GPIO1_ADDR FSL_IMX31_GPIO1_IRQ } { FSL_IMX31_GPIO2_ADDR FSL_IMX31_GPIO2_IRQ } { FSL_IMX31_GPIO3_ADDR FSL_IMX31_GPIO3_IRQ } } ; object_property_set_bool ( OBJECT ( & s -> gpio [ i ] ) , "has-edge-sel" , false , & error_abort ) ; if ( ! sysbus_realize ( SYS_BUS_DEVICE ( & s -> gpio [ i ] ) , errp ) ) { return ; } sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> gpio [ i ] ) , 0 , gpio_table [ i ] . addr ) ; sysbus_connect_irq ( SYS_BUS_DEVICE ( & s -> gpio [ i ] ) , 0 , qdev_get_gpio_in ( DEVICE ( & s -> avic ) , gpio_table [ i ] . irq ) ) ; } sysbus_realize ( SYS_BUS_DEVICE ( & s -> wdt ) , & error_abort ) ; sysbus_mmio_map ( SYS_BUS_DEVICE ( & s -> wdt ) , 0 , FSL_IMX31_WDT_ADDR ) ; memory_region_init_rom ( & s -> secure_rom , OBJECT ( dev ) , "imx31.secure_rom" , FSL_IMX31_SECURE_ROM_SIZE , & err ) ; if ( err ) { error_propagate ( errp , err ) ; return ; } memory_region_add_subregion ( get_system_memory ( ) , FSL_IMX31_SECURE_ROM_ADDR , & s -> secure_rom ) ; memory_region_init_rom ( & s -> rom , OBJECT ( dev ) , "imx31.rom" , FSL_IMX31_ROM_SIZE , & err ) ; if ( err ) { error_propagate ( errp , err ) ; return ; } memory_region_add_subregion ( get_system_memory ( ) , FSL_IMX31_ROM_ADDR , & s -> rom ) ; memory_region_init_ram ( & s -> iram , NULL , "imx31.iram" , FSL_IMX31_IRAM_SIZE , & err ) ; if ( err ) { error_propagate ( errp , err ) ; return ; } memory_region_add_subregion ( get_system_memory ( ) , FSL_IMX31_IRAM_ADDR , & s -> iram ) ; memory_region_init_alias ( & s -> iram_alias , OBJECT ( dev ) , "imx31.iram_alias" , & s -> iram , 0 , FSL_IMX31_IRAM_ALIAS_SIZE ) ; memory_region_add_subregion ( get_system_memory ( ) , FSL_IMX31_IRAM_ALIAS_ADDR , & s -> iram_alias ) ; } 