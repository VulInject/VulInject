void dwqe_tx_proc ( struct dwqe_softc * sc ) { struct ifnet * ifp = & sc -> sc_ac . ac_if ; struct dwqe_desc * txd ; struct dwqe_buf * txb ; int idx , txfree ; bus_dmamap_sync ( sc -> sc_dmat , DWQE_DMA_MAP ( sc -> sc_txring ) , 0 , DWQE_DMA_LEN ( sc -> sc_txring ) , BUS_DMASYNC_POSTREAD | BUS_DMASYNC_POSTWRITE ) ; txfree = 0 ; while ( sc -> sc_tx_cons != sc -> sc_tx_prod ) { idx = sc -> sc_tx_cons ; KASSERT ( idx < DWQE_NTXDESC ) ; txd = & sc -> sc_txdesc [ idx ] ; txb = & sc -> sc_txbuf [ idx ] ; if ( txb -> tb_m ) { bus_dmamap_sync ( sc -> sc_dmat , txb -> tb_map , 0 , txb -> tb_map -> dm_mapsize , BUS_DMASYNC_POSTWRITE ) ; bus_dmamap_unload ( sc -> sc_dmat , txb -> tb_map ) ; m_freem ( txb -> tb_m ) ; txb -> tb_m = NULL ; } txfree ++ ; if ( sc -> sc_tx_cons == ( DWQE_NTXDESC - 1 ) ) { sc -> sc_tx_cons = 0 ; } else { sc -> sc_tx_cons ++ ; } txd -> sd_tdes3 = 0 ; } if ( sc -> sc_tx_cons == sc -> sc_tx_prod ) { ifp -> if_timer = 0 ; } if ( txfree ) { if ( ifq_is_oactive ( & ifp -> if_snd ) ) { ifq_restart ( & ifp -> if_snd ) ; } } } 