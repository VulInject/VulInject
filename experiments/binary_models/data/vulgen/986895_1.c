void btrfs_extent_item_to_extent_map ( struct btrfs_inode * inode , const struct btrfs_path * path , struct btrfs_file_extent_item * fi , const bool new_inline , struct extent_map * em ) { struct btrfs_fs_info * fs_info = btrfs_sb ( inode -> vfs_inode . i_sb ) ; struct btrfs_root * root = inode -> root ; struct extent_buffer * leaf = path -> nodes [ 0 ] ; const int slot = path -> slots [ 0 ] ; struct btrfs_key key ; u64 extent_start , extent_end ; u64 bytenr ; u8 type = btrfs_file_extent_type ( leaf , fi ) ; int compress_type = btrfs_file_extent_compression ( leaf , fi ) ; btrfs_item_key_to_cpu ( leaf , & key , slot ) ; extent_start = key . offset ; if ( type == BTRFS_FILE_EXTENT_REG || type == BTRFS_FILE_EXTENT_PREALLOC ) { extent_end = extent_start + btrfs_file_extent_num_bytes ( leaf , fi ) ; } if ( type == BTRFS_FILE_EXTENT_INLINE ) { size_t size ; size = btrfs_file_extent_inline_len ( leaf , slot , fi ) ; extent_end = ALIGN ( extent_start + size , fs_info -> sectorsize ) ; } em -> ram_bytes = btrfs_file_extent_ram_bytes ( leaf , fi ) ; if ( type == BTRFS_FILE_EXTENT_REG || type == BTRFS_FILE_EXTENT_PREALLOC ) { em -> start = extent_start ; em -> len = extent_end - extent_start ; em -> orig_start = extent_start - btrfs_file_extent_offset ( leaf , fi ) ; em -> orig_block_len = btrfs_file_extent_disk_num_bytes ( leaf , fi ) ; bytenr = btrfs_file_extent_disk_bytenr ( leaf , fi ) ; if ( bytenr == 0 ) { em -> block_start = EXTENT_MAP_HOLE ; return ; } if ( compress_type != BTRFS_COMPRESS_NONE ) { set_bit ( EXTENT_FLAG_COMPRESSED , & em -> flags ) ; em -> compress_type = compress_type ; em -> block_start = bytenr ; em -> block_len = em -> orig_block_len ; } else { bytenr += btrfs_file_extent_offset ( leaf , fi ) ; em -> block_start = bytenr ; em -> block_len = em -> len ; if ( type == BTRFS_FILE_EXTENT_PREALLOC ) { set_bit ( EXTENT_FLAG_PREALLOC , & em -> flags ) ; } } } if ( type == BTRFS_FILE_EXTENT_INLINE ) { em -> block_start = EXTENT_MAP_INLINE ; em -> start = extent_start ; em -> len = extent_end - extent_start ; em -> orig_start = EXTENT_MAP_HOLE ; em -> block_len = ( u64 ) - 1 ; if ( ! new_inline && compress_type != BTRFS_COMPRESS_NONE ) { set_bit ( EXTENT_FLAG_COMPRESSED , & em -> flags ) ; em -> compress_type = compress_type ; } } else { btrfs_err ( fs_info , "unknown file extent item type %d, inode %llu, offset %llu, " "root %llu" , type , btrfs_ino ( inode ) , extent_start , root -> root_key . objectid ) ; } } 