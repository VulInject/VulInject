static int fill_frameinfo_by_link ( mfxFrameInfo * frameinfo , AVFilterLink * link ) { enum AVPixelFormat pix_fmt ; AVHWFramesContext * frames_ctx ; AVQSVFramesContext * frames_hwctx ; const AVPixFmtDescriptor * desc ; if ( link -> format == AV_PIX_FMT_QSV ) { if ( ! link -> hw_frames_ctx ) { return AVERROR ( EINVAL ) ; } frames_ctx = ( AVHWFramesContext * ) link -> hw_frames_ctx -> data ; frames_hwctx = frames_ctx -> hwctx ; * frameinfo = frames_hwctx -> surfaces [ 0 ] . Info ; } else { pix_fmt = link -> format ; desc = av_pix_fmt_desc_get ( pix_fmt ) ; frameinfo -> CropX = 0 ; frameinfo -> CropY = 0 ; frameinfo -> Width = FFALIGN ( link -> w , 32 ) ; frameinfo -> Height = FFALIGN ( link -> h , 32 ) ; frameinfo -> PicStruct = MFX_PICSTRUCT_PROGRESSIVE ; frameinfo -> FourCC = pix_fmt_to_mfx_fourcc ( pix_fmt ) ; frameinfo -> BitDepthLuma = desc -> comp [ 0 ] . depth ; frameinfo -> BitDepthChroma = desc -> comp [ 0 ] . depth ; frameinfo -> Shift = desc -> comp [ 0 ] . depth > 8 ; if ( desc -> log2_chroma_w && desc -> log2_chroma_h ) { frameinfo -> ChromaFormat = MFX_CHROMAFORMAT_YUV420 ; } if ( desc -> log2_chroma_w ) { frameinfo -> ChromaFormat = MFX_CHROMAFORMAT_YUV422 ; } else { frameinfo -> ChromaFormat = MFX_CHROMAFORMAT_YUV444 ; } } frameinfo -> CropW = link -> w ; frameinfo -> CropH = link -> h ; frameinfo -> FrameRateExtN = link -> frame_rate . num ; frameinfo -> FrameRateExtD = link -> frame_rate . den ; if ( frameinfo -> FrameRateExtD == 0 || frameinfo -> FrameRateExtN == 0 ) { frameinfo -> FrameRateExtN = 25 ; frameinfo -> FrameRateExtD = 1 ; } frameinfo -> AspectRatioW = link -> sample_aspect_ratio . num ?link -> sample_aspect_ratio . num : 1 ; frameinfo -> AspectRatioH = link -> sample_aspect_ratio . den ?link -> sample_aspect_ratio . den : 1 ; return 0 ; } 