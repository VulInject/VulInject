static u32 netxen_md_cntrl ( struct netxen_adapter * adapter , struct netxen_minidump_template_hdr * template_hdr , struct netxen_minidump_entry_crb * crtEntry ) { int loop_cnt , i , rv = 0 , timeout_flag ; u32 op_count , stride ; u32 opcode , read_value , addr ; unsigned long timeout , timeout_jiffies ; addr = crtEntry -> addr ; op_count = crtEntry -> op_count ; stride = crtEntry -> addr_stride ; for ( loop_cnt = 0 ; loop_cnt < op_count ; loop_cnt ++ ) { for ( i = 0 ; i < sizeof ( crtEntry -> opcode ) * 8 ; i ++ ) { opcode = ( crtEntry -> opcode & ( 0x1 << i ) ) ; if ( opcode ) { switch ( opcode ) { case NX_DUMP_WCRB : NX_WR_DUMP_REG ( addr , adapter -> ahw . pci_base0 , crtEntry -> value_1 ) ; break ; case NX_DUMP_RWCRB : NX_RD_DUMP_REG ( addr , adapter -> ahw . pci_base0 , & read_value ) ; NX_WR_DUMP_REG ( addr , adapter -> ahw . pci_base0 , read_value ) ; break ; case NX_DUMP_ANDCRB : NX_RD_DUMP_REG ( addr , adapter -> ahw . pci_base0 , & read_value ) ; read_value &= crtEntry -> value_2 ; NX_WR_DUMP_REG ( addr , adapter -> ahw . pci_base0 , read_value ) ; break ; case NX_DUMP_ORCRB : NX_RD_DUMP_REG ( addr , adapter -> ahw . pci_base0 , & read_value ) ; read_value |= crtEntry -> value_3 ; NX_WR_DUMP_REG ( addr , adapter -> ahw . pci_base0 , read_value ) ; break ; case NX_DUMP_POLLCRB : timeout = crtEntry -> poll_timeout ; NX_RD_DUMP_REG ( addr , adapter -> ahw . pci_base0 , & read_value ) ; timeout_jiffies = msecs_to_jiffies ( timeout ) + jiffies ; for ( timeout_flag = 0 ; ! timeout_flag && ( ( read_value & crtEntry -> value_2 ) != crtEntry -> value_1 ) ; ) { NX_RD_DUMP_REG ( addr , adapter -> ahw . pci_base0 , & read_value ) ; } if ( timeout_flag ) { dev_err ( & adapter -> pdev -> dev , "%s : " "Timeout in poll_crb control operation.\n" , __func__ ) ; return - 1 ; } break ; case NX_DUMP_RD_SAVE : if ( crtEntry -> state_index_a ) { addr = template_hdr -> saved_state_array [ crtEntry -> state_index_a ] ; } NX_RD_DUMP_REG ( addr , adapter -> ahw . pci_base0 , & read_value ) ; template_hdr -> saved_state_array [ crtEntry -> state_index_v ] = read_value ; break ; case NX_DUMP_WRT_SAVED : if ( crtEntry -> state_index_v ) { read_value = template_hdr -> saved_state_array [ crtEntry -> state_index_v ] ; } else { read_value = crtEntry -> value_1 ; } if ( crtEntry -> state_index_a ) { addr = template_hdr -> saved_state_array [ crtEntry -> state_index_a ] ; } NX_WR_DUMP_REG ( addr , adapter -> ahw . pci_base0 , read_value ) ; break ; case NX_DUMP_MOD_SAVE_ST : read_value = template_hdr -> saved_state_array [ crtEntry -> state_index_v ] ; read_value <<= crtEntry -> shl ; read_value >>= crtEntry -> shr ; if ( crtEntry -> value_2 ) { read_value &= crtEntry -> value_2 ; } read_value |= crtEntry -> value_3 ; read_value += crtEntry -> value_1 ; template_hdr -> saved_state_array [ crtEntry -> state_index_v ] = read_value ; break ; default : rv = 1 ; break ; } } } addr = addr + stride ; } return rv ; } 