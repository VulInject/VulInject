void SV_SpawnServer ( char * server , qboolean killBots ) { int i ; int checksum ; qboolean isBot ; char systemInfo [ 16384 ] ; const char * p ; SV_ShutdownGameProgs ( ) ; Com_Printf ( "------ Server Initialization ------\n" ) ; Com_Printf ( "Server: %s\n" , server ) ; CL_MapLoading ( ) ; CL_ShutdownAll ( qfalse ) ; Hunk_Clear ( ) ; CM_ClearMap ( ) ; if ( ! Cvar_VariableValue ( "sv_running" ) ) { SV_Startup ( ) ; } else { if ( sv_maxclients -> modified ) { SV_ChangeMaxClients ( ) ; } } FS_ClearPakReferences ( 0 ) ; svs . snapshotEntities = Hunk_Alloc ( sizeof ( entityState_t ) * svs . numSnapshotEntities , h_high ) ; svs . nextSnapshotEntities = 0 ; svs . snapFlagServerBit ^= SNAPFLAG_SERVERCOUNT ; Cvar_Set ( "nextmap" , "map_restart 0" ) ; for ( i = 0 ; i < sv_maxclients -> integer ; i ++ ) { if ( svs . clients [ i ] . state >= CS_CONNECTED ) { svs . clients [ i ] . oldServerTime = sv . time ; } } SV_ClearServer ( ) ; Z_LogHeap ( ) ; for ( i = 0 ; i < MAX_CONFIGSTRINGS ; i ++ ) { sv . configstrings [ i ] = CopyString ( "" ) ; } if ( sv_gametype -> integer == GT_SINGLE_PLAYER || sv_gametype -> integer >= GT_WOLF ) { CL_StartHunkUsers ( 0 ) ; } else { Cvar_Set ( "com_expectedhunkusage" , "-1" ) ; } Cvar_Set ( "cl_paused" , "0" ) ; sv . checksumFeed = ( ( ( unsigned int ) rand ( ) << 16 ) ^ ( unsigned int ) rand ( ) ) ^ Com_Milliseconds ( ) ; FS_Restart ( sv . checksumFeed ) ; Cbuf_ExecuteText ( EXEC_NOW , va ( "exec mapcfgs/%s.cfg\n" , server ) ) ; CM_LoadMap ( va ( "maps/%s.bsp" , server ) , qfalse , & checksum ) ; Cvar_Set ( "mapname" , server ) ; Cvar_Set ( "sv_mapChecksum" , va ( "%i" , checksum ) ) ; sv . serverId = com_frameTime ; sv . restartedServerId = sv . serverId ; sv . checksumFeedServerId = sv . serverId ; Cvar_Set ( "sv_serverid" , va ( "%i" , sv . serverId ) ) ; SV_ClearWorld ( ) ; sv . state = SS_LOADING ; Cvar_Set ( "sv_serverRestarting" , "1" ) ; SV_InitGameProgs ( ) ; sv_gametype -> modified = qfalse ; for ( i = 0 ; i < 3 ; i ++ ) { VM_Call ( gvm , GAME_RUN_FRAME , sv . time ) ; SV_BotFrame ( sv . time ) ; sv . time += 100 ; svs . time += 100 ; } SV_CreateBaseline ( ) ; for ( i = 0 ; i < sv_maxclients -> integer ; i ++ ) { if ( svs . clients [ i ] . state >= CS_CONNECTED ) { char * denied ; if ( svs . clients [ i ] . netchan . remoteAddress . type == NA_BOT ) { if ( killBots || Cvar_VariableValue ( "g_gametype" ) == GT_SINGLE_PLAYER ) { SV_DropClient ( & svs . clients [ i ] , "" ) ; continue ; } isBot = qtrue ; } else { isBot = qfalse ; } denied = VM_ExplicitArgPtr ( gvm , VM_Call ( gvm , GAME_CLIENT_CONNECT , i , qfalse , isBot ) ) ; if ( denied ) { SV_DropClient ( & svs . clients [ i ] , denied ) ; } else { if ( ! isBot ) { svs . clients [ i ] . state = CS_CONNECTED ; } else { client_t * client ; sharedEntity_t * ent ; client = & svs . clients [ i ] ; client -> state = CS_ACTIVE ; ent = SV_GentityNum ( i ) ; ent -> s . number = i ; client -> gentity = ent ; client -> deltaMessage = - 1 ; client -> lastSnapshotTime = 0 ; VM_Call ( gvm , GAME_CLIENT_BEGIN , i ) ; } } } } VM_Call ( gvm , GAME_RUN_FRAME , sv . time ) ; SV_BotFrame ( sv . time ) ; sv . time += 100 ; svs . time += 100 ; if ( sv_pure -> integer ) { p = FS_LoadedPakChecksums ( ) ; Cvar_Set ( "sv_paks" , p ) ; if ( strlen ( p ) == 0 ) { Com_Printf ( "WARNING: sv_pure set but no PK3 files loaded\n" ) ; } p = FS_LoadedPakNames ( ) ; Cvar_Set ( "sv_pakNames" , p ) ; SV_TouchFile ( "cgame_mp_x86.dll" ) ; SV_TouchFile ( "ui_mp_x86.dll" ) ; } else { Cvar_Set ( "sv_paks" , "" ) ; Cvar_Set ( "sv_pakNames" , "" ) ; } p = FS_ReferencedPakChecksums ( ) ; Cvar_Set ( "sv_referencedPaks" , p ) ; p = FS_ReferencedPakNames ( ) ; Cvar_Set ( "sv_referencedPakNames" , p ) ; Q_strncpyz ( systemInfo , Cvar_InfoString_Big ( CVAR_SYSTEMINFO ) , sizeof ( systemInfo ) ) ; cvar_modifiedFlags &= ~ CVAR_SYSTEMINFO ; SV_SetConfigstring ( CS_SYSTEMINFO , systemInfo ) ; SV_SetConfigstring ( CS_SERVERINFO , Cvar_InfoString ( CVAR_SERVERINFO ) ) ; cvar_modifiedFlags &= ~ CVAR_SERVERINFO ; SV_SetConfigstring ( CS_WOLFINFO , Cvar_InfoString ( CVAR_WOLFINFO ) ) ; cvar_modifiedFlags &= ~ CVAR_WOLFINFO ; sv . state = SS_GAME ; SV_Heartbeat_f ( ) ; Hunk_SetMark ( ) ; if ( com_dedicated -> integer ) { CL_StartHunkUsers ( qtrue ) ; } Cvar_Set ( "sv_serverRestarting" , "0" ) ; Com_Printf ( "-----------------------------------\n" ) ; } 