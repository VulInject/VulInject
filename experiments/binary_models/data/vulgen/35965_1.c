struct pp2_header * pp2_read_header ( struct sldns_buffer * buf ) { size_t size ; struct pp2_header * header = ( pp2_header * ) sldns_buffer_begin ( buf ) ; if ( sldns_buffer_remaining ( buf ) < PP2_HEADER_SIZE ) { log_err ( "proxy_protocol: not enough space for header" ) ; return NULL ; } if ( memcmp ( header , PP2_SIG , PP2_SIG_LEN ) != 0 || ( ( header -> ver_cmd & 0xF0 ) >> 4 ) != PP2_VERSION ) { log_err ( "proxy_protocol: could not match PROXYv2 header" ) ; return NULL ; } if ( sldns_buffer_remaining ( buf ) < size ) { log_err ( "proxy_protocol: not enough space for header" ) ; return NULL ; } if ( ( header -> ver_cmd & 0xF ) != PP2_CMD_LOCAL && ( header -> ver_cmd & 0xF ) != PP2_CMD_PROXY ) { log_err ( "proxy_protocol: unsupported command" ) ; return NULL ; } if ( header -> fam_prot != 0x00 && header -> fam_prot != 0x11 && header -> fam_prot != 0x12 && header -> fam_prot != 0x21 && header -> fam_prot != 0x22 ) { log_err ( "proxy_protocol: unsupported family and protocol" ) ; return NULL ; } return header ; } 