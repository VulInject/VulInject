calculate_line_starts ( ) { register int i , hpos ; char * * line_starts = NULL ; int line_starts_index = 0 , line_starts_slots = 0 ; int bump_index ; NODE * node ; window -> line_starts = NULL ; window -> line_count = 0 ; node = window -> node ; i = 0 ; hpos = 0 ; bump_index = 0 ; while ( i < node -> nodelen ) { char * line = node -> contents + i ; unsigned int cwidth , c ; add_pointer_to_array ( line , line_starts_index , line_starts , line_starts_slots , 100 , char * ) ; if ( bump_index ) { i ++ ; bump_index = 0 ; } while ( 1 ) { c = ( unsigned char ) node -> contents [ i ] ; if ( raw_escapes_p && c == '\033' && node -> contents [ i + 1 ] == '[' && isdigit ( node -> contents [ i + 2 ] ) ) { if ( node -> contents [ i + 3 ] == 'm' ) { i += 3 ; cwidth = 0 ; } if ( isdigit ( node -> contents [ i + 3 ] ) && node -> contents [ i + 4 ] == 'm' ) { i += 4 ; cwidth = 0 ; } else { cwidth = character_width ( c , hpos ) ; } } else { cwidth = character_width ( c , hpos ) ; } if ( ( hpos + cwidth ) < ( unsigned int ) window -> width ) { i ++ ; hpos += cwidth ; continue ; } else { if ( c == '\n' || c == '\r' || c == '\t' ) { i ++ ; hpos = 0 ; break ; } else { if ( window -> flags & W_NoWrap ) { hpos = 0 ; while ( i < node -> nodelen && node -> contents [ i ] != '\n' ) { i ++ ; } if ( node -> contents [ i ] == '\n' ) { i ++ ; } } else { hpos = the_screen -> width - hpos ; bump_index ++ ; } break ; } } } } window -> line_starts = line_starts ; window -> line_count = line_starts_index ; } 