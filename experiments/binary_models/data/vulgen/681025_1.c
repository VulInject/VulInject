STREAM tcp_tls_get_server_pubkey ( ) { int ret ; unsigned int list_size ; const gnutls_datum_t * cert_list ; gnutls_x509_crt_t cert ; unsigned int algo , bits ; gnutls_datum_t m , e ; int pk_size ; STREAM s = NULL ; cert_list = gnutls_certificate_get_peers ( g_tls_session , & list_size ) ; if ( ! cert_list ) { logger ( Core , Error , "%s:%s:%d Failed to get peer's certs' list\n" , __FILE__ , __func__ , __LINE__ ) ; out } if ( ( ret = gnutls_x509_crt_init ( & cert ) ) != GNUTLS_E_SUCCESS ) { logger ( Core , Error , "%s:%s:%d Failed to init certificate structure. GnuTLS error: %s\n" , __FILE__ , __func__ , __LINE__ , gnutls_strerror ( ret ) ) ; out } if ( ( ret = gnutls_x509_crt_import ( cert , & cert_list [ 0 ] , GNUTLS_X509_FMT_DER ) ) != GNUTLS_E_SUCCESS ) { logger ( Core , Error , "%s:%s:%d Failed to import DER certificate. GnuTLS error:%s\n" , __FILE__ , __func__ , __LINE__ , gnutls_strerror ( ret ) ) ; out } algo = gnutls_x509_crt_get_pk_algorithm ( cert , & bits ) ; if ( algo == GNUTLS_PK_RSA ) { if ( ( ret = gnutls_x509_crt_get_pk_rsa_raw ( cert , & m , & e ) ) != GNUTLS_E_SUCCESS ) { logger ( Core , Error , "%s:%s:%d Failed to get RSA public key parameters from certificate. GnuTLS error:%s\n" , __FILE__ , __func__ , __LINE__ , gnutls_strerror ( ret ) ) ; out } } else { logger ( Core , Error , "%s:%s:%d Peer's certificate public key algorithm is not RSA. GnuTLS error:%s\n" , __FILE__ , __func__ , __LINE__ , gnutls_strerror ( algo ) ) ; out } pk_size = sizeof ( pk_data ) ; if ( ( ret = write_pkcs1_der_pubkey ( & m , & e , pk_data , & pk_size ) ) != 0 ) { logger ( Core , Error , "%s:%s:%d Failed to encode RSA public key to PKCS#1 DER\n" , __FILE__ , __func__ , __LINE__ ) ; out } s = s_alloc ( pk_size ) ; out_uint8a ( s , pk_data , pk_size ) ; s_mark_end ( s ) ; s_seek ( s , 0 ) ; out if ( ( e . size != 0 ) && ( e . data ) ) { free ( e . data ) ; } if ( ( m . size != 0 ) && ( m . data ) ) { free ( m . data ) ; } return s ; } 