test_setup_initial_data ( , ) { test_runner_t * test_runner = NULL ; test_file_t * test_file = NULL ; bson_iter_t initial_data_iter ; test_file = test -> test_file ; test_runner = test_file -> test_runner ; BSON_FOREACH ( , ) { bson_parser_t * parser = NULL ; bson_t collection_data ; char * collection_name = NULL ; char * database_name = NULL ; bson_t * documents = NULL ; mongoc_database_t * db = NULL ; mongoc_collection_t * coll = NULL ; mongoc_bulk_operation_t * bulk_insert = NULL ; mongoc_write_concern_t * wc = NULL ; bson_t * bulk_opts = NULL ; bson_t * drop_opts = NULL ; bson_t * create_opts = NULL ; bool ret = false ; bson_iter_bson ( & initial_data_iter , & collection_data ) ; parser = bson_parser_new ( ) ; bson_parser_utf8 ( parser , "databaseName" , & database_name ) ; bson_parser_utf8 ( parser , "collectionName" , & collection_name ) ; bson_parser_array ( parser , "documents" , & documents ) ; if ( ! bson_parser_parse ( parser , & collection_data , error ) ) { loopexit } wc = mongoc_write_concern_new ( ) ; mongoc_write_concern_set_w ( wc , MONGOC_WRITE_CONCERN_W_MAJORITY ) ; bulk_opts = bson_new ( ) ; mongoc_write_concern_append ( wc , bulk_opts ) ; if ( semver_cmp_str ( & test_runner -> server_version , "3.4" ) >= 0 ) { drop_opts = bson_new ( ) ; mongoc_write_concern_append ( wc , drop_opts ) ; create_opts = bson_new ( ) ; mongoc_write_concern_append ( wc , create_opts ) ; } coll = mongoc_client_get_collection ( test_runner -> internal_client , database_name , collection_name ) ; if ( ! mongoc_collection_drop_with_opts ( coll , drop_opts , error ) ) { if ( error -> code != 26 && ( NULL == strstr ( error -> message , "ns not found" ) ) ) { loopexit } memset ( error , 0 , sizeof ( bson_error_t ) ) ; } if ( bson_count_keys ( documents ) > 0 ) { bson_iter_t documents_iter ; bulk_insert = mongoc_collection_create_bulk_operation_with_opts ( coll , bulk_opts ) ; BSON_FOREACH ( , ) { bson_t document ; bson_iter_bson ( & documents_iter , & document ) ; mongoc_bulk_operation_insert ( bulk_insert , & document ) ; } if ( ! mongoc_bulk_operation_execute ( bulk_insert , NULL , error ) ) { loopexit } } else { mongoc_collection_t * new_coll = NULL ; db = mongoc_client_get_database ( test_runner -> internal_client , database_name ) ; new_coll = mongoc_database_create_collection ( db , collection_name , create_opts , error ) ; if ( ! new_coll ) { loopexit } mongoc_collection_destroy ( new_coll ) ; } ret = true ; loopexit mongoc_bulk_operation_destroy ( bulk_insert ) ; bson_destroy ( bulk_opts ) ; bson_destroy ( drop_opts ) ; bson_destroy ( create_opts ) ; bson_destroy ( documents ) ; mongoc_write_concern_destroy ( wc ) ; mongoc_collection_destroy ( coll ) ; bson_free ( database_name ) ; bson_free ( collection_name ) ; bson_parser_destroy ( parser ) ; mongoc_database_destroy ( db ) ; if ( ! ret ) { return false ; } } return true ; } 