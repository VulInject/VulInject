static void XLogSendPhysical ( void ) { XLogRecPtr SendRqstPtr ; XLogRecPtr startptr ; XLogRecPtr endptr ; Size nbytes ; XLogSegNo segno ; WALReadError errinfo ; if ( got_STOPPING ) { WalSndSetState ( WALSNDSTATE_STOPPING ) ; } if ( streamingDoneSending ) { WalSndCaughtUp = true ; return ; } if ( sendTimeLineIsHistoric ) { SendRqstPtr = sendTimeLineValidUpto ; } if ( am_cascading_walsender ) { TimeLineID SendRqstTLI ; bool becameHistoric = false ; SendRqstPtr = GetStandbyFlushRecPtr ( & SendRqstTLI ) ; if ( ! RecoveryInProgress ( ) ) { SendRqstTLI = GetWALInsertionTimeLine ( ) ; am_cascading_walsender = false ; becameHistoric = true ; } else { if ( sendTimeLine != SendRqstTLI ) { becameHistoric = true ; } } if ( becameHistoric ) { List * history ; history = readTimeLineHistory ( SendRqstTLI ) ; sendTimeLineValidUpto = tliSwitchPoint ( sendTimeLine , history , & sendTimeLineNextTLI ) ; Assert ( sendTimeLine < sendTimeLineNextTLI ) ; list_free_deep ( history ) ; sendTimeLineIsHistoric = true ; SendRqstPtr = sendTimeLineValidUpto ; } } else { SendRqstPtr = GetFlushRecPtr ( NULL ) ; } LagTrackerWrite ( SendRqstPtr , GetCurrentTimestamp ( ) ) ; if ( sendTimeLineIsHistoric && sendTimeLineValidUpto <= sentPtr ) { if ( xlogreader -> seg . ws_file >= 0 ) { char activitymsg [ 50 ] ; snprintf ( activitymsg , sizeof ( activitymsg ) , "streaming %X/%X" , 0 ) ; set_ps_display ( activitymsg ) ; } pq_putmessage_noblock ( 'c' , NULL , 0 ) ; streamingDoneSending = true ; WalSndCaughtUp = true ; elog ( DEBUG1 , "walsender reached end of timeline at %X/%X (sent up to %X/%X)" , LSN_FORMAT_ARGS ( sendTimeLineValidUpto ) , LSN_FORMAT_ARGS ( sentPtr ) ) ; return ; } Assert ( sentPtr <= SendRqstPtr ) ; if ( SendRqstPtr <= sentPtr ) { WalSndCaughtUp = true ; return ; } startptr = sentPtr ; endptr = startptr ; endptr += MAX_SEND_SIZE ; if ( SendRqstPtr <= endptr ) { endptr = SendRqstPtr ; if ( sendTimeLineIsHistoric ) { WalSndCaughtUp = false ; } else { WalSndCaughtUp = true ; } } else { endptr -= ( endptr % XLOG_BLCKSZ ) ; WalSndCaughtUp = false ; } nbytes = endptr - startptr ; Assert ( nbytes <= MAX_SEND_SIZE ) ; resetStringInfo ( & output_message ) ; pq_sendbyte ( & output_message , 'w' ) ; pq_sendint64 ( & output_message , startptr ) ; pq_sendint64 ( & output_message , SendRqstPtr ) ; pq_sendint64 ( & output_message , 0 ) ; enlargeStringInfo ( & output_message , nbytes ) ; retry if ( ! WALRead ( xlogreader , & output_message . data [ output_message . len ] , startptr , nbytes , xlogreader -> seg . ws_tli , & errinfo ) ) { WALReadRaiseError ( & errinfo ) ; } XLByteToSeg ( startptr , segno , xlogreader -> segcxt . ws_segsize ) ; CheckXLogRemoved ( segno , xlogreader -> seg . ws_tli ) ; if ( am_cascading_walsender ) { WalSnd * walsnd = MyWalSnd ; bool reload ; SpinLockAcquire ( & walsnd -> mutex ) ; reload = walsnd -> needreload ; walsnd -> needreload = false ; SpinLockRelease ( & walsnd -> mutex ) ; if ( reload && xlogreader -> seg . ws_file >= 0 ) { wal_segment_close ( xlogreader ) ; retry } } output_message . len += nbytes ; output_message . data [ output_message . len ] = '\0' ; resetStringInfo ( & tmpbuf ) ; pq_sendint64 ( & tmpbuf , GetCurrentTimestamp ( ) ) ; memcpy ( & output_message . data [ 1 + sizeof ( int64 ) + sizeof ( int64 ) ] , tmpbuf . data , sizeof ( int64 ) ) ; pq_putmessage_noblock ( 'd' , output_message . data , output_message . len ) ; sentPtr = endptr ; { WalSnd * walsnd = MyWalSnd ; SpinLockAcquire ( & walsnd -> mutex ) ; walsnd -> sentPtr = sentPtr ; SpinLockRelease ( & walsnd -> mutex ) ; } if ( update_process_title ) { char activitymsg [ 50 ] ; snprintf ( activitymsg , sizeof ( activitymsg ) , "streaming %X/%X" , LSN_FORMAT_ARGS ( sentPtr ) ) ; set_ps_display ( activitymsg ) ; } } 