void raptor_sax2_start_element ( void * user_data , const unsigned char * name , const unsigned char * * atts ) { raptor_sax2 * sax2 = ( raptor_sax2 * ) user_data ; raptor_qname * el_name ; unsigned char * * xml_atts_copy = NULL ; size_t xml_atts_size = 0 ; int all_atts_count = 0 ; int ns_attributes_count = 0 ; raptor_qname * * named_attrs = NULL ; raptor_xml_element * xml_element = NULL ; unsigned char * xml_language = NULL ; raptor_uri * xml_base = NULL ; if ( sax2 -> failed || ! sax2 -> enabled ) { return ; } if ( atts ) { int i ; for ( i = 0 ; atts [ i ] ; i += 2 ) { unsigned char * value = ( unsigned char * ) atts [ i + 1 ] ; unsigned char * src = value ; unsigned char * dst = xmlStrdup ( value ) ; if ( ! dst ) { raptor_log_error ( sax2 -> world , RAPTOR_LOG_LEVEL_FATAL , sax2 -> locator , "Out of memory" ) ; return ; } atts [ i + 1 ] = dst ; while ( * src == 0x20 || * src == 0x0d || * src == 0x0a || * src == 0x09 ) { src ++ ; } while ( * src ) { if ( * src == 0x20 || * src == 0x0d || * src == 0x0a || * src == 0x09 ) { while ( * src == 0x20 || * src == 0x0d || * src == 0x0a || * src == 0x09 ) { src ++ ; } if ( * src ) { * dst ++ = 0x20 ; } } else { * dst ++ = * src ++ ; } } * dst = '\0' ; xmlFree ( value ) ; } } if ( atts ) { int i ; for ( i = 0 ; atts [ i ] ; i ++ ) { } xml_atts_size = ( unsigned char * ) * i ; if ( xml_atts_size ) { xml_atts_copy = RAPTOR_MALLOC ( , ) ; if ( ! xml_atts_copy ) { fail } memcpy ( xml_atts_copy , atts , xml_atts_size ) ; } for ( i = 0 ; atts [ i ] ; i += 2 ) { all_atts_count ++ ; if ( strncmp ( ( char * ) atts [ i ] , "xml" , 3 ) ) { ns_attributes_count ++ ; continue ; } if ( ! memcmp ( ( const char * ) atts [ i ] , "xmlns" , 5 ) ) { const unsigned char * prefix = atts [ i ] [ 5 ] ?& atts [ i ] [ 6 ] : NULL ; const unsigned char * namespace_name = atts [ i + 1 ] ; raptor_namespace * nspace ; nspace = raptor_new_namespace ( & sax2 -> namespaces , prefix , namespace_name , raptor_sax2_get_depth ( sax2 ) ) ; if ( nspace ) { raptor_namespaces_start_namespace ( & sax2 -> namespaces , nspace ) ; if ( sax2 -> namespace_handler ) { * sax2 -> namespace_handler ( sax2 -> user_data , nspace ) ; } } } if ( ! strcmp ( ( char * ) atts [ i ] , "xml:lang" ) ) { size_t lang_len = strlen ( ( char * ) atts [ i + 1 ] ) ; xml_language = RAPTOR_MALLOC ( , 1 ) ; if ( ! xml_language ) { raptor_log_error ( sax2 -> world , RAPTOR_LOG_LEVEL_FATAL , sax2 -> locator , "Out of memory" ) ; fail } if ( RAPTOR_OPTIONS_GET_NUMERIC ( sax2 , RAPTOR_OPTION_NORMALIZE_LANGUAGE ) ) { unsigned char * from = ( unsigned char * ) atts [ i + 1 ] ; unsigned char * to = xml_language ; while ( * from ) { if ( isupper ( * from ) ) { * to ++ = RAPTOR_GOOD_CAST ( , ) ; } else { * to ++ = * from ++ ; } } * to = '\0' ; } else { memcpy ( xml_language , atts [ i + 1 ] , lang_len + 1 ) ; } } if ( ! strcmp ( ( char * ) atts [ i ] , "xml:base" ) ) { raptor_uri * base_uri ; raptor_uri * xuri ; base_uri = raptor_sax2_inscope_base_uri ( sax2 ) ; xuri = raptor_new_uri_relative_to_base ( sax2 -> world , base_uri , atts [ i + 1 ] ) ; xml_base = raptor_new_uri_for_xmlbase ( xuri ) ; raptor_free_uri ( xuri ) ; } atts [ i ] = NULL ; } } el_name = raptor_new_qname ( & sax2 -> namespaces , name , NULL ) ; if ( ! el_name ) { fail } if ( xml_language ) { free ( xml_language ) ; xml_language = NULL ; } if ( xml_base ) { raptor_free_uri ( xml_base ) ; xml_base = NULL ; } xml_element = raptor_new_xml_element ( el_name , xml_language , xml_base ) ; if ( ! xml_element ) { raptor_free_qname ( el_name ) ; fail } xml_language = NULL ; xml_base = NULL ; if ( ns_attributes_count ) { int i ; int offset = 0 ; named_attrs = RAPTOR_CALLOC ( raptor_qname * * , ns_attributes_count , sizeof ( raptor_qname * ) ) ; if ( ! named_attrs ) { raptor_log_error ( sax2 -> world , RAPTOR_LOG_LEVEL_FATAL , sax2 -> locator , "Out of memory" ) ; fail } for ( i = 0 ; i < all_atts_count ; i ++ ) { raptor_qname * attr ; if ( ! atts [ i << 1 ] ) { continue ; } attr = raptor_new_qname ( & sax2 -> namespaces , atts [ i << 1 ] , atts [ ( i << 1 ) + 1 ] ) ; if ( ! attr ) { int j ; for ( j = 0 ; j < i ; j ++ ) { RAPTOR_FREE ( raptor_qname , named_attrs [ j ] ) ; } RAPTOR_FREE ( raptor_qname_array , named_attrs ) ; fail } named_attrs [ offset ++ ] = attr ; } } if ( named_attrs ) { raptor_xml_element_set_attributes ( xml_element , named_attrs , ns_attributes_count ) ; } raptor_xml_element_push ( sax2 , xml_element ) ; if ( sax2 -> start_element_handler ) { sax2 -> start_element_handler ( sax2 -> user_data , xml_element ) ; } if ( xml_atts_copy ) { memcpy ( ( void * ) atts , xml_atts_copy , xml_atts_size ) ; RAPTOR_FREE ( cstringpointer , xml_atts_copy ) ; } return ; fail if ( xml_atts_copy ) { RAPTOR_FREE ( cstringpointer , xml_atts_copy ) ; } if ( xml_base ) { raptor_free_uri ( xml_base ) ; } if ( xml_language ) { RAPTOR_FREE ( char * , xml_language ) ; } if ( xml_element ) { raptor_free_xml_element ( xml_element ) ; } } 