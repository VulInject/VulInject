static long mpi3mr_bsg_pel_enable ( struct mpi3mr_ioc * mrioc , struct bsg_job * job ) { long rval = - EINVAL ; struct mpi3mr_bsg_out_pel_enable pel_enable ; u8 issue_pel_wait ; u8 tmp_class ; u16 tmp_locale ; if ( job -> request_payload . payload_len != sizeof ( pel_enable ) ) { dprint_bsg_err ( mrioc , "%s: invalid size argument\n" , __func__ ) ; return rval ; } sg_copy_to_buffer ( job -> request_payload . sg_list , job -> request_payload . sg_cnt , & pel_enable , sizeof ( pel_enable ) ) ; if ( pel_enable . pel_class > MPI3_PEL_CLASS_FAULT ) { dprint_bsg_err ( mrioc , "%s: out of range class %d sent\n" , __func__ , pel_enable . pel_class ) ; rval = 0 ; out } if ( ! mrioc -> pel_enabled ) { issue_pel_wait = 1 ; } else { if ( ( mrioc -> pel_class <= pel_enable . pel_class ) && ! ( ( mrioc -> pel_locale & pel_enable . pel_locale ) ^ pel_enable . pel_locale ) ) { issue_pel_wait = 0 ; rval = 0 ; } else { pel_enable . pel_locale |= mrioc -> pel_locale ; if ( mrioc -> pel_class < pel_enable . pel_class ) { pel_enable . pel_class = mrioc -> pel_class ; } if ( rval ) { dprint_bsg_err ( mrioc , "%s: pel_abort failed, status(%ld)\n" , __func__ , rval ) ; out } issue_pel_wait = 1 ; } } if ( issue_pel_wait ) { tmp_class = mrioc -> pel_class ; tmp_locale = mrioc -> pel_locale ; mrioc -> pel_class = pel_enable . pel_class ; mrioc -> pel_locale = pel_enable . pel_locale ; mrioc -> pel_enabled = 1 ; rval = mpi3mr_pel_get_seqnum_post ( mrioc , NULL ) ; if ( rval ) { mrioc -> pel_class = tmp_class ; mrioc -> pel_locale = tmp_locale ; mrioc -> pel_enabled = 0 ; dprint_bsg_err ( mrioc , "%s: pel get sequence number failed, status(%ld)\n" , __func__ , rval ) ; } } out return rval ; } 