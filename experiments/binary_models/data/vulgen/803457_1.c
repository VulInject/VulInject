static void __sh_mobile_lcdc_start ( struct sh_mobile_lcdc_priv * priv ) { struct sh_mobile_lcdc_chan * ch ; unsigned long tmp ; int k , m ; lcdc_write ( priv , _LDCNT2R , priv -> ch [ 0 ] . enabled | priv -> ch [ 1 ] . enabled ) ; sh_mobile_lcdc_start_stop ( priv , 0 ) ; lcdc_write ( priv , _LDINTR , 0 ) ; tmp = priv -> lddckr ; for ( k = 0 ; k < ARRAY_SIZE ( priv -> ch ) ; k ++ ) { ch = & priv -> ch [ k ] ; if ( ! ch -> enabled ) { continue ; } lcdc_write_chan ( ch , LDPMR , 0 ) ; m = ch -> cfg -> clock_divider ; if ( ! m ) { continue ; } lcdc_write_chan ( ch , LDDCKPAT1R , 0 ) ; lcdc_write_chan ( ch , LDDCKPAT2R , ( 1 << ( m / 2 ) ) - 1 ) ; tmp |= m << ( lcdc_chan_is_sublcd ( ch ) ?8 : 0 ) ; } lcdc_write ( priv , _LDDCKR , tmp ) ; lcdc_write ( priv , _LDDCKSTPR , 0 ) ; lcdc_wait_bit ( priv , _LDDCKSTPR , ~ 0 , 0 ) ; for ( k = 0 ; k < ARRAY_SIZE ( priv -> ch ) ; k ++ ) { ch = & priv -> ch [ k ] ; if ( ! ch -> enabled ) { continue ; } sh_mobile_lcdc_geometry ( ch ) ; tmp = ch -> format -> lddfr ; if ( ch -> format -> yuv ) { switch ( ch -> colorspace ) { case V4L2_COLORSPACE_REC709 : tmp |= LDDFR_CF1 ; break ; case V4L2_COLORSPACE_JPEG : tmp |= LDDFR_CF0 ; break ; } } lcdc_write_chan ( ch , LDDFR , tmp ) ; lcdc_write_chan ( ch , LDMLSR , ch -> line_size ) ; lcdc_write_chan ( ch , LDSA1R , ch -> base_addr_y ) ; if ( ch -> format -> yuv ) { lcdc_write_chan ( ch , LDSA2R , ch -> base_addr_c ) ; } if ( ch -> ldmt1r_value & LDMT1R_IFM && ch -> cfg -> sys_bus_cfg . deferred_io_msec ) { lcdc_write_chan ( ch , LDSM1R , LDSM1R_OS ) ; lcdc_write ( priv , _LDINTR , LDINTR_FE ) ; } else { lcdc_write_chan ( ch , LDSM1R , 0 ) ; } } switch ( priv -> ch [ 0 ] . format -> fourcc ) { case V4L2_PIX_FMT_RGB565 : case V4L2_PIX_FMT_NV21 : case V4L2_PIX_FMT_NV61 : case V4L2_PIX_FMT_NV42 : tmp = LDDDSR_LS | LDDDSR_WS ; break ; case V4L2_PIX_FMT_BGR24 : case V4L2_PIX_FMT_NV12 : case V4L2_PIX_FMT_NV16 : case V4L2_PIX_FMT_NV24 : tmp = LDDDSR_LS | LDDDSR_WS | LDDDSR_BS ; break ; case V4L2_PIX_FMT_BGR32 : default : tmp = LDDDSR_LS ; break ; } lcdc_write ( priv , _LDDDSR , tmp ) ; lcdc_write ( priv , _LDCNT1R , LDCNT1R_DE ) ; sh_mobile_lcdc_start_stop ( priv , 1 ) ; priv -> started = 1 ; } 