int net_verify_hardware_address ( const char * ifname , bool is_static , uint16_t iftype , const struct hw_addr_data * ib_hw_addr , struct hw_addr_data * new_hw_addr ) { Link link = { . ifname = ifname } ; assert ( new_hw_addr ) ; if ( new_hw_addr -> length == 0 ) { return 0 ; } if ( new_hw_addr -> length != arphrd_to_hw_addr_len ( iftype ) ) { if ( is_static ) { log_link_warning ( & link , "Specified MAC address with invalid length (%zu, expected %zu), refusing." , new_hw_addr -> length , arphrd_to_hw_addr_len ( iftype ) ) ; } return - EINVAL ; } switch ( iftype ) { case ARPHRD_ETHER : if ( ether_addr_is_null ( & new_hw_addr -> ether ) ) { if ( is_static ) { log_link_warning ( & link , "Specified MAC address is null, refusing." ) ; } return - EINVAL ; } if ( ether_addr_is_broadcast ( & new_hw_addr -> ether ) ) { if ( is_static ) { log_link_warning ( & link , "Specified MAC address is broadcast, refusing." ) ; } return - EINVAL ; } if ( ether_addr_is_multicast ( & new_hw_addr -> ether ) ) { if ( is_static ) { log_link_warning ( & link , "Specified MAC address has the multicast bit set, clearing the bit." ) ; } new_hw_addr -> bytes [ 0 ] &= 0xfe ; } if ( ! is_static && ! ether_addr_is_local ( & new_hw_addr -> ether ) ) { new_hw_addr -> bytes [ 0 ] |= 0x02 ; } break ; case ARPHRD_INFINIBAND : assert ( ib_hw_addr -> length == INFINIBAND_ALEN ) ; if ( is_static && ( ! memeqzero ( new_hw_addr -> bytes , INFINIBAND_ALEN - 8 ) || memcmp ( new_hw_addr -> bytes , ib_hw_addr -> bytes , INFINIBAND_ALEN - 8 ) != 0 ) ) { log_link_warning ( & link , "Only the last 8 bytes of the InifniBand MAC address can be changed, ignoring the first 12 bytes." ) ; } if ( memeqzero ( new_hw_addr -> bytes + INFINIBAND_ALEN - 8 , 8 ) ) { if ( is_static ) { log_link_warning ( & link , "The last 8 bytes of the InfiniBand MAC address cannot be null, refusing." ) ; } return - EINVAL ; } memcpy ( new_hw_addr -> bytes , ib_hw_addr -> bytes , INFINIBAND_ALEN - 8 ) ; break ; default : if ( is_static ) { log_link_warning ( & link , "Unsupported interface type %s%u to set MAC address, refusing." , strna ( arphrd_to_name ( iftype ) ) , iftype ) ; } return - EINVAL ; } return 0 ; } 