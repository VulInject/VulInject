static bool parse_scram_secret ( const char * secret , int * iterations , char * * salt , uint8_t * stored_key , uint8_t * server_key ) { char * s ; char * p ; char * scheme_str ; char * salt_str ; char * iterations_str ; char * storedkey_str ; char * serverkey_str ; int decoded_len ; char * decoded_salt_buf ; char * decoded_stored_buf = NULL ; char * decoded_server_buf = NULL ; s = strdup ( secret ) ; if ( ! s ) { invalid_secret } if ( ( scheme_str = strtok ( s , "$" ) ) == NULL ) { invalid_secret } if ( ( iterations_str = strtok ( NULL , ":" ) ) == NULL ) { invalid_secret } if ( ( salt_str = strtok ( NULL , "$" ) ) == NULL ) { invalid_secret } if ( ( storedkey_str = strtok ( NULL , ":" ) ) == NULL ) { invalid_secret } if ( ( serverkey_str = strtok ( NULL , "" ) ) == NULL ) { invalid_secret } if ( strcmp ( scheme_str , "SCRAM-SHA-256" ) != 0 ) { invalid_secret } errno = 0 ; * iterations = strtol ( iterations_str , & p , 10 ) ; if ( * p || errno != 0 ) { invalid_secret } decoded_len = pg_b64_dec_len ( strlen ( salt_str ) ) ; decoded_salt_buf = malloc ( decoded_len ) ; if ( ! decoded_salt_buf ) { invalid_secret } decoded_len = pg_b64_decode ( salt_str , strlen ( salt_str ) , decoded_salt_buf , decoded_len ) ; free ( decoded_salt_buf ) ; if ( decoded_len < 0 ) { invalid_secret } * salt = strdup ( salt_str ) ; if ( ! * salt ) { invalid_secret } decoded_len = pg_b64_dec_len ( strlen ( storedkey_str ) ) ; decoded_stored_buf = malloc ( decoded_len ) ; if ( ! decoded_stored_buf ) { invalid_secret } decoded_len = pg_b64_decode ( storedkey_str , strlen ( storedkey_str ) , decoded_stored_buf , decoded_len ) ; if ( decoded_len != SCRAM_KEY_LEN ) { invalid_secret } memcpy ( stored_key , decoded_stored_buf , SCRAM_KEY_LEN ) ; decoded_len = pg_b64_dec_len ( strlen ( serverkey_str ) ) ; decoded_server_buf = malloc ( decoded_len ) ; decoded_len = pg_b64_decode ( serverkey_str , strlen ( serverkey_str ) , decoded_server_buf , decoded_len ) ; if ( decoded_len != SCRAM_KEY_LEN ) { invalid_secret } memcpy ( server_key , decoded_server_buf , SCRAM_KEY_LEN ) ; free ( decoded_stored_buf ) ; free ( s ) ; return true ; invalid_secret free ( decoded_stored_buf ) ; free ( decoded_server_buf ) ; free ( s ) ; free ( * salt ) ; * salt = NULL ; return false ; } 