int __init mpc834x_usb_cfg ( void ) { unsigned long sccr , sicrl , sicrh ; void __iomem * immap ; struct device_node * np = NULL ; int port0_is_dr = 0 , port1_is_dr = 0 ; const void * prop , * dr_mode ; immap = ioremap ( get_immrbase ( ) , 0x1000 ) ; sccr = in_be32 ( immap + MPC83XX_SCCR_OFFS ) & ~ MPC83XX_SCCR_USB_MASK ; sicrl = in_be32 ( immap + MPC83XX_SICRL_OFFS ) & ~ MPC834X_SICRL_USB_MASK ; sicrh = in_be32 ( immap + MPC83XX_SICRH_OFFS ) & ~ MPC834X_SICRH_USB_UTMI ; np = of_find_compatible_node ( NULL , NULL , "fsl-usb2-dr" ) ; if ( np ) { sccr |= MPC83XX_SCCR_USB_DRCM_11 ; prop = of_get_property ( np , "phy_type" , NULL ) ; port1_is_dr = 1 ; if ( prop && ( ! strcmp ( prop , "utmi" ) || ! strcmp ( prop , "utmi_wide" ) ) ) { sicrl |= MPC834X_SICRL_USB0 | MPC834X_SICRL_USB1 ; sicrh |= MPC834X_SICRH_USB_UTMI ; port0_is_dr = 1 ; } if ( prop && ! strcmp ( prop , "serial" ) ) { dr_mode = of_get_property ( np , "dr_mode" , NULL ) ; if ( dr_mode && ! strcmp ( dr_mode , "otg" ) ) { sicrl |= MPC834X_SICRL_USB0 | MPC834X_SICRL_USB1 ; port0_is_dr = 1 ; } else { sicrl |= MPC834X_SICRL_USB1 ; } } if ( prop && ! strcmp ( prop , "ulpi" ) ) { sicrl |= MPC834X_SICRL_USB1 ; } else { printk ( KERN_WARNING "834x USB PHY type not supported\n" ) ; } of_node_put ( np ) ; } np = of_find_compatible_node ( NULL , NULL , "fsl-usb2-mph" ) ; if ( np ) { sccr |= MPC83XX_SCCR_USB_MPHCM_11 ; prop = of_get_property ( np , "port0" , NULL ) ; if ( prop ) { if ( port0_is_dr ) { printk ( KERN_WARNING "834x USB port0 can't be used by both DR and MPH!\n" ) ; } sicrl &= ~ MPC834X_SICRL_USB0 ; } prop = of_get_property ( np , "port1" , NULL ) ; if ( prop ) { if ( port1_is_dr ) { printk ( KERN_WARNING "834x USB port1 can't be used by both DR and MPH!\n" ) ; } sicrl &= ~ MPC834X_SICRL_USB1 ; } of_node_put ( np ) ; } out_be32 ( immap + MPC83XX_SCCR_OFFS , sccr ) ; out_be32 ( immap + MPC83XX_SICRL_OFFS , sicrl ) ; out_be32 ( immap + MPC83XX_SICRH_OFFS , sicrh ) ; iounmap ( immap ) ; return 0 ; } 