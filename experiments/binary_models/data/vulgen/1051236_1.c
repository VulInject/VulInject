void test_pack_midx__writer ( void ) { git_repository * repo ; git_midx_writer * w = NULL ; git_buf midx = GIT_BUF_INIT ; git_str expected_midx = GIT_STR_INIT , path = GIT_STR_INIT ; cl_git_pass ( git_repository_open ( & repo , cl_fixture ( "testrepo.git" ) ) ) ; cl_git_pass ( git_str_joinpath ( & path , git_repository_path ( repo ) , "objects/pack" ) ) ; cl_git_pass ( git_midx_writer_new ( & w , git_str_cstr ( & path ) ) ) ; cl_git_pass ( git_midx_writer_add ( w , "pack-d7c6adf9f61318f041845b01440d09aa7a91e1b5.idx" ) ) ; cl_git_pass ( git_midx_writer_add ( w , "pack-d85f5d483273108c9d8dd0e4728ccf0b2982423a.idx" ) ) ; cl_git_pass ( git_midx_writer_add ( w , "pack-a81e489679b7d3418f9ab594bda8ceb37dd4c695.idx" ) ) ; cl_git_pass ( git_midx_writer_dump ( & midx , w ) ) ; cl_git_pass ( git_str_joinpath ( & path , git_repository_path ( repo ) , "objects/pack/multi-pack-index" ) ) ; cl_git_pass ( git_futils_readbuffer ( & expected_midx , git_str_cstr ( & path ) ) ) ; cl_assert_equal_i ( midx . size , git_str_len ( & expected_midx ) ) ; cl_assert_equal_strn ( midx . ptr , git_str_cstr ( & expected_midx ) , midx . size ) ; git_buf_dispose ( & midx ) ; git_str_dispose ( & expected_midx ) ; git_str_dispose ( & path ) ; git_midx_writer_free ( w ) ; } 