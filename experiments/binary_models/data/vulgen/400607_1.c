static int tcp_ioctl ( sock_lower_handle_t proto_handle , int cmd , intptr_t arg , int mode , int32_t * rvalp , cred_t * cr ) { conn_t * connp = ( conn_t * ) proto_handle ; int error ; ASSERT ( connp -> conn_upper_handle != NULL ) ; ASSERT ( cr != NULL ) ; if ( connp -> conn_helper_info == NULL ) { tcp_stack_t * tcps = connp -> conn_tcp -> tcp_tcps ; error = ip_create_helper_stream ( connp , tcps -> tcps_ldi_ident ) ; if ( error != 0 ) { ip0dbg ( ( "tcp_ioctl: create of IP helper stream " "failed %d\n" , error ) ) ; return ( error ) ; } } switch ( cmd ) { case ND_SET : case ND_GET : case _SIOCSOCKFALLBACK : case TCP_IOC_ABORT_CONN : case TI_GETPEERNAME : case TI_GETMYNAME : ip1dbg ( ( "tcp_ioctl: cmd 0x%x on non streams socket" , cmd ) ) ; error = EINVAL ; break ; default : mutex_enter ( & connp -> conn_lock ) ; if ( connp -> conn_state_flags & ( CONN_CLOSING ) ) { mutex_exit ( & connp -> conn_lock ) ; error = EINVAL ; break ; } CONN_INC_IOCTLREF_LOCKED ( connp ) ; CONN_DEC_IOCTLREF ( connp ) ; break ; } return ( error ) ; } 