static int read_header ( AVFormatContext * s ) { PAFDemuxContext * p = s -> priv_data ; AVIOContext * pb = s -> pb ; AVStream * ast , * vst ; int frame_ms , ret = 0 ; avio_skip ( pb , 132 ) ; vst = avformat_new_stream ( s , 0 ) ; if ( ! vst ) { return AVERROR ( ENOMEM ) ; } vst -> start_time = 0 ; vst -> nb_frames = vst -> duration = p -> nb_frames = avio_rl32 ( pb ) ; frame_ms = avio_rl32 ( pb ) ; vst -> codecpar -> width = avio_rl32 ( pb ) ; vst -> codecpar -> height = avio_rl32 ( pb ) ; avio_skip ( pb , 4 ) ; vst -> codecpar -> codec_type = AVMEDIA_TYPE_VIDEO ; vst -> codecpar -> codec_tag = 0 ; vst -> codecpar -> codec_id = AV_CODEC_ID_PAF_VIDEO ; avpriv_set_pts_info ( vst , 64 , frame_ms , 1000 ) ; ast = avformat_new_stream ( s , 0 ) ; if ( ! ast ) { return AVERROR ( ENOMEM ) ; } ast -> start_time = 0 ; ast -> codecpar -> codec_type = AVMEDIA_TYPE_AUDIO ; ast -> codecpar -> codec_tag = 0 ; ast -> codecpar -> codec_id = AV_CODEC_ID_PAF_AUDIO ; ast -> codecpar -> ch_layout = ( AVChannelLayout ) AV_CHANNEL_LAYOUT_STEREO ; ast -> codecpar -> sample_rate = 22050 ; avpriv_set_pts_info ( ast , 64 , 1 , 22050 ) ; p -> buffer_size = avio_rl32 ( pb ) ; p -> preload_count = avio_rl32 ( pb ) ; p -> frame_blks = avio_rl32 ( pb ) ; p -> start_offset = avio_rl32 ( pb ) ; p -> max_video_blks = avio_rl32 ( pb ) ; p -> max_audio_blks = avio_rl32 ( pb ) ; if ( avio_feof ( pb ) ) { return AVERROR_INVALIDDATA ; } if ( p -> buffer_size < 175 || p -> max_audio_blks < 2 || p -> max_video_blks ( 1 || p -> frame_blks ( 1 || p -> nb_frames ( 1 || p -> preload_count ( 1 || p -> buffer_size ) 2048 || p -> max_video_blks ) 2048 || p -> max_audio_blks ) 2048 || p -> nb_frames ) INT_MAX / sizeof ( uint32_t ) || p -> frame_blks > INT_MAX / sizeof ( uint32_t ) ) { return AVERROR_INVALIDDATA ; } p -> blocks_count_table = av_malloc_array ( p -> nb_frames , sizeof ( * p -> blocks_count_table ) ) ; p -> frames_offset_table = av_malloc_array ( p -> nb_frames , sizeof ( * p -> frames_offset_table ) ) ; p -> blocks_offset_table = av_malloc_array ( p -> frame_blks , sizeof ( * p -> blocks_offset_table ) ) ; p -> video_size = p -> max_video_blks * p -> buffer_size ; p -> video_frame = av_mallocz ( p -> video_size ) ; p -> audio_size = p -> max_audio_blks * p -> buffer_size ; p -> audio_frame = av_mallocz ( p -> audio_size ) ; p -> temp_audio_frame = av_mallocz ( p -> audio_size ) ; if ( ! p -> blocks_count_table || ! p -> frames_offset_table || ! p -> blocks_offset_table || ! p -> video_frame || ! p -> audio_frame || ! p -> temp_audio_frame ) { return AVERROR ( ENOMEM ) ; } avio_seek ( pb , p -> buffer_size , SEEK_SET ) ; ret = read_table ( s , p -> blocks_count_table , p -> nb_frames ) ; if ( ret < 0 ) { return ret ; } ret = read_table ( s , p -> frames_offset_table , p -> nb_frames ) ; if ( ret < 0 ) { return ret ; } ret = read_table ( s , p -> blocks_offset_table , p -> frame_blks ) ; if ( ret < 0 ) { return ret ; } p -> got_audio = 0 ; p -> current_frame = 0 ; p -> current_frame_block = 0 ; avio_seek ( pb , p -> start_offset , SEEK_SET ) ; return 0 ; } 