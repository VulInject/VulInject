static LPTSTR lpszPipeNameSt = _T ( "\\\\.\\pipe\\winpr_test_pipe_st" ) ; static BOOL testFailed = FALSE ; static DWORD WINAPI named_pipe_client_thread ( LPVOID arg ) { HANDLE hNamedPipe = NULL ; BYTE * lpReadBuffer = NULL ; BYTE * lpWriteBuffer = NULL ; BOOL fSuccess = FALSE ; DWORD nNumberOfBytesToRead ; DWORD nNumberOfBytesToWrite ; DWORD lpNumberOfBytesRead ; DWORD lpNumberOfBytesWritten ; WaitForSingleObject ( ReadyEvent , INFINITE ) ; hNamedPipe = CreateFile ( lpszPipeNameMt , GENERIC_READ | GENERIC_WRITE , 0 , NULL , OPEN_EXISTING , 0 , NULL ) ; if ( hNamedPipe == INVALID_HANDLE_VALUE ) { printf ( "%s: Named Pipe CreateFile failure: INVALID_HANDLE_VALUE\n" , __FUNCTION__ ) ; out } if ( ! ( lpReadBuffer = ( BYTE * ) malloc ( PIPE_BUFFER_SIZE ) ) ) { printf ( "%s: Error allocating read buffer\n" , __FUNCTION__ ) ; out } if ( ! ( lpWriteBuffer = ( BYTE * ) malloc ( PIPE_BUFFER_SIZE ) ) ) { printf ( "%s: Error allocating write buffer\n" , __FUNCTION__ ) ; out } lpNumberOfBytesWritten = 0 ; nNumberOfBytesToWrite = PIPE_BUFFER_SIZE ; FillMemory ( lpWriteBuffer , PIPE_BUFFER_SIZE , 0x59 ) ; if ( ! WriteFile ( hNamedPipe , lpWriteBuffer , nNumberOfBytesToWrite , & lpNumberOfBytesWritten , NULL ) || lpNumberOfBytesWritten != nNumberOfBytesToWrite ) { printf ( "%s: Client NamedPipe WriteFile failure\n" , __FUNCTION__ ) ; out } lpNumberOfBytesRead = 0 ; nNumberOfBytesToRead = PIPE_BUFFER_SIZE ; ZeroMemory ( lpReadBuffer , PIPE_BUFFER_SIZE ) ; if ( ! ReadFile ( hNamedPipe , lpReadBuffer , nNumberOfBytesToRead , & lpNumberOfBytesRead , NULL ) || lpNumberOfBytesRead != nNumberOfBytesToRead ) { printf ( "%s: Client NamedPipe ReadFile failure\n" , __FUNCTION__ ) ; out } printf ( "Client ReadFile: %" PRIu32 " bytes\n" , lpNumberOfBytesRead ) ; winpr_HexDump ( "pipe.test" , WLOG_DEBUG , lpReadBuffer , lpNumberOfBytesRead ) ; fSuccess = TRUE ; out free ( lpWriteBuffer ) ; CloseHandle ( hNamedPipe ) ; if ( ! fSuccess ) { testFailed = TRUE ; } ExitThread ( 0 ) ; return 0 ; } 