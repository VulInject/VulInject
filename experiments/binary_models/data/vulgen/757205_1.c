void ll_rw_stats_tally ( struct ll_sb_info * sbi , pid_t pid , struct ll_file_data * file , loff_t pos , size_t count , int rw ) { int i , cur = - 1 ; struct ll_rw_process_info * process ; struct ll_rw_process_info * offset ; int * off_count = & sbi -> ll_rw_offset_entry_count ; int * process_count = & sbi -> ll_offset_process_count ; struct ll_rw_extents_info * io_extents = & sbi -> ll_rw_extents_info ; if ( ! sbi -> ll_rw_stats_on ) { return ; } process = sbi -> ll_rw_process_info ; offset = sbi -> ll_rw_offset_info ; spin_lock ( & sbi -> ll_pp_extent_lock ) ; for ( i = 0 ; i < LL_PROCESS_HIST_MAX ; i ++ ) { if ( io_extents -> pp_extents [ i ] . pid == pid ) { cur = i ; break ; } } if ( cur == - 1 ) { sbi -> ll_extent_process_count = ( sbi -> ll_extent_process_count + 1 ) % LL_PROCESS_HIST_MAX ; cur = sbi -> ll_extent_process_count ; io_extents -> pp_extents [ cur ] . pid = pid ; lprocfs_oh_clear ( & io_extents -> pp_extents [ cur ] . pp_r_hist ) ; lprocfs_oh_clear ( & io_extents -> pp_extents [ cur ] . pp_w_hist ) ; } for ( i = 0 ; ( count >= ( 1 << LL_HIST_START << i ) ) && ( i < ( LL_HIST_MAX - 1 ) ) ; i ++ ) { } if ( rw == 0 ) { io_extents -> pp_extents [ cur ] . pp_r_hist . oh_buckets [ i ] ++ ; io_extents -> pp_extents [ LL_PROCESS_HIST_MAX ] . pp_r_hist . oh_buckets [ i ] ++ ; } else { io_extents -> pp_extents [ cur ] . pp_w_hist . oh_buckets [ i ] ++ ; io_extents -> pp_extents [ LL_PROCESS_HIST_MAX ] . pp_w_hist . oh_buckets [ i ] ++ ; } spin_lock ( & sbi -> ll_process_lock ) ; for ( i = 0 ; i < LL_PROCESS_HIST_MAX ; i ++ ) { if ( process [ i ] . rw_pid == pid ) { if ( process [ i ] . rw_last_file != file ) { process [ i ] . rw_range_start = pos ; process [ i ] . rw_last_file_pos = pos + count ; process [ i ] . rw_smallest_extent = count ; process [ i ] . rw_largest_extent = count ; process [ i ] . rw_offset = 0 ; process [ i ] . rw_last_file = file ; spin_unlock ( & sbi -> ll_process_lock ) ; return ; } if ( process [ i ] . rw_last_file_pos != pos ) { * off_count = ( * off_count + 1 ) % LL_OFFSET_HIST_MAX ; offset [ * off_count ] . rw_op = process [ i ] . rw_op ; offset [ * off_count ] . rw_pid = pid ; offset [ * off_count ] . rw_range_start = process [ i ] . rw_range_start ; offset [ * off_count ] . rw_range_end = process [ i ] . rw_last_file_pos ; offset [ * off_count ] . rw_smallest_extent = process [ i ] . rw_smallest_extent ; offset [ * off_count ] . rw_largest_extent = process [ i ] . rw_largest_extent ; offset [ * off_count ] . rw_offset = process [ i ] . rw_offset ; process [ i ] . rw_op = rw ; process [ i ] . rw_range_start = pos ; process [ i ] . rw_smallest_extent = count ; process [ i ] . rw_largest_extent = count ; process [ i ] . rw_offset = pos - process [ i ] . rw_last_file_pos ; } if ( process [ i ] . rw_smallest_extent > count ) { process [ i ] . rw_smallest_extent = count ; } if ( process [ i ] . rw_largest_extent < count ) { process [ i ] . rw_largest_extent = count ; } process [ i ] . rw_last_file_pos = pos + count ; spin_unlock ( & sbi -> ll_process_lock ) ; return ; } } * process_count = ( * process_count + 1 ) % LL_PROCESS_HIST_MAX ; process [ * process_count ] . rw_pid = pid ; process [ * process_count ] . rw_op = rw ; process [ * process_count ] . rw_range_start = pos ; process [ * process_count ] . rw_last_file_pos = pos + count ; process [ * process_count ] . rw_smallest_extent = count ; process [ * process_count ] . rw_largest_extent = count ; process [ * process_count ] . rw_offset = 0 ; process [ * process_count ] . rw_last_file = file ; spin_unlock ( & sbi -> ll_process_lock ) ; } 