static int ipmi_find_entity ( topo_mod_t * mod , tnode_t * tn , ipmi_handle_t * * ihpp , ipmi_entity_t * * epp , char * * namep , ipmi_sdr_t * * sdrpp ) { ipmi_handle_t * ihp ; ipmi_entity_t * ep ; int err ; char * name = NULL , * * names ; ipmi_sdr_t * sdrp = NULL ; uint_t nelems , i ; * ihpp = NULL ; * epp = NULL ; * namep = NULL ; * sdrpp = NULL ; ep = topo_node_getspecific ( tn ) ; if ( ep != NULL ) { * ihpp = ihp ; * epp = ep ; return ( 0 ) ; } if ( topo_prop_get_string ( tn , TOPO_PGROUP_IPMI , TOPO_PROP_IPMI_ENTITY_PRESENT , & name , & err ) == 0 ) { sdrp = ipmi_sdr_lookup ( ihp , name ) ; } else { if ( topo_prop_get_string_array ( tn , TOPO_PGROUP_IPMI , TOPO_PROP_IPMI_ENTITY_REF , & names , & nelems , & err ) != 0 ) { topo_mod_ipmi_rele ( mod ) ; return ( topo_mod_seterrno ( mod , ETOPO_METHOD_NOTSUP ) ) ; } for ( i = 0 ; i < nelems ; i ++ ) { if ( ( ep = ipmi_entity_lookup_sdr ( ihp , names [ i ] ) ) != NULL ) { name = names [ i ] ; names [ i ] = NULL ; break ; } } for ( i = 0 ; i < nelems ; i ++ ) { topo_mod_strfree ( mod , names [ i ] ) ; } topo_mod_free ( mod , names , ( nelems * sizeof ( char * ) ) ) ; if ( ep == NULL ) { topo_mod_dprintf ( mod , "Failed to get present state of %s=%d\n" , topo_node_name ( tn ) , topo_node_instance ( tn ) ) ; topo_mod_ipmi_rele ( mod ) ; return ( - 1 ) ; } topo_node_setspecific ( tn , ep ) ; } * ihpp = ihp ; * namep = name ; * sdrpp = sdrp ; return ( 0 ) ; } 