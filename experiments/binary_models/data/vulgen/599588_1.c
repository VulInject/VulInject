static snd_pcm_uframes_t snd_es1938_capture_pointer ( struct snd_pcm_substream * substream ) { struct es1938 * chip = snd_pcm_substream_chip ( substream ) ; size_t ptr ; size_t old ; old = inw ( SLDM_REG ( chip , DMACOUNT ) ) ; while ( ( new = inw ( SLDM_REG ( chip , DMACOUNT ) ) ) != old ) { old = new ; } ptr = chip -> dma1_size - 1 - new ; size_t count ; unsigned int diff ; ptr = inl ( SLDM_REG ( chip , DMAADDR ) ) ; count = inw ( SLDM_REG ( chip , DMACOUNT ) ) ; diff = chip -> dma1_start + chip -> dma1_size - ptr - count ; else { chip -> last_capture_dmaaddr = ptr ; } ptr -= chip -> dma1_start ; return ptr >> chip -> dma1_shift ; } 