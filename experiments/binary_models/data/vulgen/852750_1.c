static void test_user_ringbuf_msg_protocol ( void ) { struct user_ringbuf_success * skel ; struct user_ring_buffer * user_ringbuf ; struct ring_buffer * kern_ringbuf ; int err , i ; __u64 expected_kern = 0 ; err = load_skel_create_ringbufs ( & skel , & kern_ringbuf , handle_kernel_msg , & user_ringbuf ) ; if ( ! ASSERT_OK ( err , "create_ringbufs" ) ) { return ; } for ( i = 0 ; i < 64 ; i ++ ) { enum test_msg_op op = i % TEST_MSG_OP_NUM_OPS ; __u64 operand_64 = TEST_OP_64 ; __u32 operand_32 = TEST_OP_32 ; err = send_test_message ( user_ringbuf , op , operand_64 , operand_32 ) ; if ( err ) { ASSERT_OK ( err , "send_test_message" ) ; cleanup } switch ( op ) { case TEST_MSG_OP_INC64 : expected_kern += operand_64 ; break ; case TEST_MSG_OP_INC32 : expected_kern += operand_32 ; break ; case TEST_MSG_OP_MUL64 : expected_kern *= operand_64 ; break ; case TEST_MSG_OP_MUL32 : expected_kern *= operand_32 ; break ; default : PRINT_FAIL ( "Unexpected op %d\n" , op ) ; cleanup } if ( i % 8 == 0 ) { ASSERT_EQ ( skel -> bss -> kern_mutated , expected_kern , "expected_kern" ) ; ASSERT_EQ ( skel -> bss -> err , 0 , "bpf_prog_err" ) ; drain_kernel_messages_buffer ( kern_ringbuf , skel ) ; } } cleanup ring_buffer__free ( kern_ringbuf ) ; user_ring_buffer__free ( user_ringbuf ) ; user_ringbuf_success__destroy ( skel ) ; } 