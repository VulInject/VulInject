static int pppol2tp_sendmsg ( struct socket * sock , struct msghdr * m , size_t total_len ) { struct sock * sk = sock -> sk ; struct sk_buff * skb ; int error ; struct l2tp_session * session ; struct l2tp_tunnel * tunnel ; int uhlen ; error = - ENOTCONN ; if ( sock_flag ( sk , SOCK_DEAD ) || ! ( sk -> sk_state & PPPOX_CONNECTED ) ) { error } error = - EBADF ; session = pppol2tp_sock_to_session ( sk ) ; if ( ! session ) { error } tunnel = session -> tunnel ; uhlen = ( tunnel -> encap == L2TP_ENCAPTYPE_UDP ) ?sizeof ( udphdr ) : 0 ; error = - ENOMEM ; skb = sock_wmalloc ( sk , NET_SKB_PAD + sizeof ( iphdr ) + uhlen + session -> hdr_len + 2 + total_len , 0 , GFP_KERNEL ) ; if ( ! skb ) { error_put_sess } skb_reserve ( skb , NET_SKB_PAD ) ; skb_reset_network_header ( skb ) ; skb_reserve ( skb , sizeof ( iphdr ) ) ; skb_reset_transport_header ( skb ) ; skb_reserve ( skb , uhlen ) ; skb -> data [ 0 ] = PPP_ALLSTATIONS ; skb -> data [ 1 ] = PPP_UI ; skb_put ( skb , 2 ) ; error = memcpy_from_msg ( skb_put ( skb , total_len ) , m , total_len ) ; if ( error < 0 ) { error_put_sess } local_bh_disable ( ) ; l2tp_xmit_skb ( session , skb ) ; local_bh_enable ( ) ; sock_put ( sk ) ; return total_len ; error_put_sess sock_put ( sk ) ; error return error ; } 