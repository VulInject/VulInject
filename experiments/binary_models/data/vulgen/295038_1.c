NUMA * pixGetLocalSkewAngles ( PIX * pixs , l_int32 nslices , l_int32 redsweep , l_int32 redsearch , l_float32 sweeprange , l_float32 sweepdelta , l_float32 minbsdelta , l_float32 * pa , l_float32 * pb , l_int32 debug ) { l_int32 w , h , hs , i , ystart , yend , ovlap , npts ; l_float32 angle , conf , ycenter , a , b ; BOX * box ; GPLOT * gplot ; NUMA * naskew , * nax , * nay ; PIX * pix ; PTA * pta ; if ( ! pixs || pixGetDepth ( pixs ) != 1 ) { return ( NUMA * ) ERROR_PTR ( "pixs undefined or not 1 bpp" , __func__ , NULL ) ; } if ( nslices ( 2 || nslices ) 20 ) { nslices = DefaultSlices ; } if ( redsweep ( 1 || redsweep ) 8 ) { redsweep = DefaultSweepReduction ; } if ( redsearch ( 1 || redsearch ) redsweep ) { redsearch = DefaultBsReduction ; } if ( sweeprange == 0.0 ) { sweeprange = DefaultSweepRange ; } if ( sweepdelta == 0.0 ) { sweepdelta = DefaultSweepDelta ; } if ( minbsdelta == 0.0 ) { minbsdelta = DefaultMinbsDelta ; } pixGetDimensions ( pixs , & w , & h , NULL ) ; hs = h / nslices ; ovlap = ( l_int32 ) ( OverlapFraction * hs ) ; pta = ptaCreate ( nslices ) ; for ( i = 0 ; i < nslices ; i ++ ) { ystart = L_MAX ( 0 , hs * i - ovlap ) ; yend = L_MIN ( h - 1 , hs * ( i + 1 ) + ovlap ) ; ycenter = ( l_float32 ) ( ystart + yend ) / 2 ; box = boxCreate ( 0 , ystart , w , yend - ystart + 1 ) ; pix = pixClipRectangle ( pixs , box , NULL ) ; pixFindSkewSweepAndSearch ( pix , & angle , & conf , redsweep , redsearch , sweeprange , sweepdelta , minbsdelta ) ; pixDestroy ( & pix ) ; boxDestroy ( & box ) ; } if ( ( npts = ptaGetCount ( pta ) ) < 2 ) { ptaDestroy ( & pta ) ; return ( NUMA * ) ERROR_PTR ( "can't fit skew" , __func__ , NULL ) ; } ptaGetLinearLSF ( pta , & a , & b , NULL ) ; if ( pa ) { * pa = a ; } if ( pb ) { * pb = b ; } naskew = numaCreate ( h ) ; for ( i = 0 ; i < h ; i ++ ) { angle = a * i + b ; numaAddNumber ( naskew , angle ) ; } if ( debug ) { lept_mkdir ( "lept/baseline" ) ; ptaGetArrays ( pta , & nax , & nay ) ; gplot = gplotCreate ( "/tmp/lept/baseline/skew" , GPLOT_PNG , "skew as fctn of y" , "y (in raster lines from top)" , "angle (in degrees)" ) ; gplotAddPlot ( gplot , NULL , naskew , GPLOT_POINTS , "linear lsf" ) ; gplotAddPlot ( gplot , nax , nay , GPLOT_POINTS , "actual data pts" ) ; gplotMakeOutput ( gplot ) ; gplotDestroy ( & gplot ) ; numaDestroy ( & nax ) ; numaDestroy ( & nay ) ; } ptaDestroy ( & pta ) ; return naskew ; } 