static Boolean pkopen ( register fontdesctype * fd ) { register char * d , * n ; const char * name_ret ; int dpi_ret ; int vdpi ; d = fd -> area ; n = fd -> name ; if ( * d == 0 ) { d = pkpath ; } if ( * ( fd -> area ) == 0 ) { int del ; for ( del = 0 ; del <= RES_TOLERANCE ( fd -> dpi ) ; del = del > 0 ?- del : - del + 1 ) { if ( ( pkfile = flisearch ( n , fd -> dpi + del ) ) != ( FILE * ) NULL ) { return ( 1 ) ; } } } { char * this_name = concat ( d , n ) ; pkfile = pksearch ( this_name , READBIN , fd -> dpi , & name_ret , & dpi_ret ) ; if ( ! pkfile || ! FILESTRCASEEQ ( this_name , name_ret ) ) { char * msg = concatn ( "PK font " , fd -> area , n , " not found; " , NULL ) ; if ( ! pkfile ) { msg = concat ( msg , "characters will be left blank." ) ; } else { msg = concat3 ( msg , "using " , name_ret ) ; } dontmakefont = 1 ; error ( msg ) ; } if ( ! kpse_bitmap_tolerance ( ( double ) dpi_ret , ( double ) fd -> dpi ) ) { fd -> loadeddpi = dpi_ret ; fd -> alreadyscaled = 0 ; sprintf ( errbuf , "Font %s at %d not found; scaling %d instead." , n , fd -> dpi , dpi_ret ) ; error ( errbuf ) ; lectureuser ( ) ; } if ( this_name != name_ret ) { fd -> loadeddpi = lastresortsizes [ j ] ; fd -> alreadyscaled = 0 ; sprintf ( errbuf , "Font %s at %d dpi not found; scaling %d instead." , name , fd -> dpi , 0 ) ; error ( errbuf ) ; lectureuser ( ) ; return 1 ; } return pkfile != NULL ; } int del ; for ( del = 0 ; del <= RES_TOLERANCE ( fd -> dpi ) ; del = del > 0 ?- del : - del + 1 ) { if ( actualdpi == vactualdpi ) { vdpi = 0 ; } else { vdpi = ( 2 * ( ( long ) vactualdpi ) * ( fd -> dpi + del ) + actualdpi ) / ( 2 * actualdpi ) ; } sprintf ( name , "pk%d(%s)" , fd -> dpi + del , n ) ; sprintf ( name , "%s.%dpk" , n , fd -> dpi + del ) ; if ( 0 != ( pkfile = pksearch ( d , name , READBIN , n , fd -> dpi + del , vdpi ) ) ) { return ( 1 ) ; } } } if ( d == pkpath ) { if ( actualdpi == vactualdpi ) { vdpi = 0 ; } else { vdpi = ( 2 * ( ( long ) vactualdpi ) * fd -> dpi + actualdpi ) / ( 2 * actualdpi ) ; } sprintf ( name , "pk%d(%s)" , fd -> dpi , n ) ; sprintf ( name , "%s.%dpk" , n , fd -> dpi ) ; makefont ( n , ( int ) fd -> dpi , DPI ) ; if ( dontmakefont == 0 && ( pkfile = pksearch ( d , name , READBIN , n , fd -> dpi , vdpi ) ) ) { return ( 1 ) ; } if ( _osmode == OS2_MODE ) { dontmakefont = 1 ; } dontmakefont = 1 ; } { int i , j ; if ( lastresortsizes [ 0 ] && fd -> dpi < 30000 ) { for ( i = 0 ; lastresortsizes [ i ] < fd -> dpi ; i ++ ) { } for ( j = i - 1 ; j >= 0 ; j -- ) { if ( actualdpi == vactualdpi ) { vdpi = 0 ; } else { vdpi = ( 2 * ( ( long ) vactualdpi ) * lastresortsizes [ j ] + actualdpi ) / ( 2 * actualdpi ) ; } sprintf ( name , "pk%d(%s)" , lastresortsizes [ j ] , n ) ; sprintf ( name , "%s.%dpk" , n , lastresortsizes [ j ] ) ; if ( 0 != ( pkfile = flisearch ( n , ( halfword ) lastresortsizes [ j ] ) ) || 0 != ( pkfile = pksearch ( d , name , READBIN , n , ( halfword ) lastresortsizes [ j ] , vdpi ) ) ) { if ( 0 != ( pkfile = pksearch ( d , name , READBIN , n , ( halfword ) lastresortsizes [ j ] , vdpi ) ) ) { fd -> loadeddpi = lastresortsizes [ j ] ; fd -> alreadyscaled = 0 ; sprintf ( errbuf , "Font %s at %d dpi not found; scaling %d instead." , n , fd -> dpi , lastresortsizes [ j ] ) ; error ( errbuf ) ; lectureuser ( ) ; return 1 ; } } for ( j = i ; lastresortsizes [ j ] < 30000 ; j ++ ) { if ( actualdpi == vactualdpi ) { vdpi = 0 ; } else { vdpi = ( 2 * ( ( long ) vactualdpi ) * lastresortsizes [ j ] + actualdpi ) / ( 2 * actualdpi ) ; } sprintf ( name , "%s.%dpk" , n , lastresortsizes [ j ] ) ; if ( 0 != ( pkfile = flisearch ( n , ( halfword ) lastresortsizes [ j ] ) ) || 0 != ( pkfile = pksearch ( d , name , READBIN , n , ( halfword ) lastresortsizes [ j ] , vdpi ) ) ) { if ( 0 != ( pkfile = pksearch ( d , name , READBIN , n , ( halfword ) lastresortsizes [ j ] , vdpi ) ) ) { fd -> loadeddpi = lastresortsizes [ j ] ; fd -> alreadyscaled = 0 ; sprintf ( errbuf , "Font %s at %d dpi not found; scaling %d instead." , name , fd -> dpi , lastresortsizes [ j ] ) ; error ( errbuf ) ; lectureuser ( ) ; return 1 ; } } } } sprintf ( name , "%s.pk%d" , n , fd -> dpi ) ; sprintf ( name , "%s.%dpk" , n , fd -> dpi ) ; sprintf ( errbuf , "Font %s%s not found, characters will be left blank." , fd -> area , name ) ; error ( errbuf ) ; return ( 0 ) ; } } 