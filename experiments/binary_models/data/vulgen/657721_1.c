int msTiledSHPNextShape ( layerObj * layer , shapeObj * shape ) { int i , status , filter_passed = MS_FALSE ; const char * filename ; char tilename [ MS_MAXPATHLEN ] ; char tiFileAbsDir [ MS_MAXPATHLEN ] ; msTiledSHPLayerInfo * tSHP = NULL ; if ( msCheckParentPointer ( layer -> map , "map" ) == MS_FAILURE ) { return MS_FAILURE ; } tSHP = layer -> layerinfo ; if ( ! tSHP ) { msSetError ( MS_SHPERR , "Tiled shapefile layer has not been opened." , "msTiledSHPNextShape()" ) ; return ( MS_FAILURE ) ; } msTileIndexAbsoluteDir ( tiFileAbsDir , layer ) ; { i = tSHP -> shpfile -> lastshape + 1 ; while ( i < tSHP -> shpfile -> numshapes && ! msGetBit ( tSHP -> shpfile -> status , i ) ) { i ++ ; } if ( i == tSHP -> shpfile -> numshapes ) { msShapefileClose ( tSHP -> shpfile ) ; if ( tSHP -> tilelayerindex != - 1 ) { layerObj * tlp ; shapeObj tshape ; int try_open ; tlp = ( GET_LAYER ( layer -> map , tSHP -> tilelayerindex ) ) ; msInitShape ( & tshape ) ; while ( ( status = msLayerNextShape ( tlp , & tshape ) ) == MS_SUCCESS ) { rectObj rectTile = tSHP -> searchrect ; filename = msTiledSHPLoadEntry ( layer , tshape . index , tilename , sizeof ( tilename ) ) ; try_open = msTiledSHPTryOpen ( tSHP -> shpfile , layer , tiFileAbsDir , filename ) ; if ( try_open == MS_DONE ) { continue ; } if ( try_open == MS_FAILURE ) { return ( MS_FAILURE ) ; } if ( tSHP -> sTileProj . numargs > 0 ) { msProjectRect ( & ( layer -> projection ) , & ( tSHP -> sTileProj ) , & rectTile ) ; } status = msShapefileWhichShapes ( tSHP -> shpfile , rectTile , layer -> debug ) ; if ( status == MS_DONE ) { msShapefileClose ( tSHP -> shpfile ) ; continue ; } if ( status != MS_SUCCESS ) { msShapefileClose ( tSHP -> shpfile ) ; tSHP -> tileshpfile -> lastshape = - 1 ; return ( MS_FAILURE ) ; } break ; } if ( status == MS_DONE ) { tSHP -> tileshpfile -> lastshape = - 1 ; return ( MS_DONE ) ; } else { msFreeShape ( & tshape ) ; continue ; } } else { for ( i = ( tSHP -> tileshpfile -> lastshape + 1 ) ; i < tSHP -> tileshpfile -> numshapes ; i ++ ) { if ( msGetBit ( tSHP -> tileshpfile -> status , i ) ) { rectObj rectTile = tSHP -> searchrect ; int try_open ; filename = msTiledSHPLoadEntry ( layer , i , tilename , sizeof ( tilename ) ) ; if ( strlen ( filename ) == 0 ) { continue ; } try_open = msTiledSHPTryOpen ( tSHP -> shpfile , layer , tiFileAbsDir , filename ) ; if ( try_open == MS_DONE ) { continue ; } if ( try_open == MS_FAILURE ) { return ( MS_FAILURE ) ; } if ( tSHP -> sTileProj . numargs > 0 ) { msProjectRect ( & ( layer -> projection ) , & ( tSHP -> sTileProj ) , & rectTile ) ; } status = msShapefileWhichShapes ( tSHP -> shpfile , rectTile , layer -> debug ) ; if ( status == MS_DONE ) { msShapefileClose ( tSHP -> shpfile ) ; continue ; } if ( status != MS_SUCCESS ) { msShapefileClose ( tSHP -> shpfile ) ; tSHP -> tileshpfile -> lastshape = - 1 ; return ( MS_FAILURE ) ; } tSHP -> tileshpfile -> lastshape = i ; break ; } } if ( i == tSHP -> tileshpfile -> numshapes ) { tSHP -> tileshpfile -> lastshape = - 1 ; return ( MS_DONE ) ; } else { continue ; } } } tSHP -> shpfile -> lastshape = i ; msSHPReadShape ( tSHP -> shpfile -> hSHP , i , shape ) ; if ( shape -> type == MS_SHAPE_NULL ) { msFreeShape ( shape ) ; continue ; } if ( tSHP -> sTileProj . numargs > 0 ) { if ( tSHP -> reprojectorFromTileProjToLayerProj == NULL ) { tSHP -> reprojectorFromTileProjToLayerProj = msProjectCreateReprojector ( & ( tSHP -> sTileProj ) , & ( layer -> projection ) ) ; } if ( tSHP -> reprojectorFromTileProjToLayerProj ) { msProjectShapeEx ( tSHP -> reprojectorFromTileProjToLayerProj , shape ) ; } } shape -> tileindex = tSHP -> tileshpfile -> lastshape ; shape -> numvalues = layer -> numitems ; shape -> values = msDBFGetValueList ( tSHP -> shpfile -> hDBF , i , layer -> iteminfo , layer -> numitems ) ; if ( ! shape -> values ) { shape -> numvalues = 0 ; } filter_passed = MS_TRUE ; if ( layer -> numitems > 0 && layer -> iteminfo ) { filter_passed = msEvalExpression ( layer , shape , & ( layer -> filter ) , layer -> filteritemindex ) ; } if ( ! filter_passed ) { msFreeShape ( shape ) ; } } ! filter_passed ; return ( MS_SUCCESS ) ; } 