static int get_ether_addr ( u_int32_t ipaddr , struct sockaddr * hwaddr , char * name , int namelen ) { struct ifreq * ifr , * ifend ; u_int32_t ina , mask ; char * aliasp ; struct ifreq ifreq , bestifreq ; struct ifconf ifc ; struct ifreq ifs [ MAX_IFS ] ; u_int32_t bestmask = 0 ; int found_interface = 0 ; ifc . ifc_len = sizeof ( ifs ) ; ifc . ifc_req = ifs ; if ( ioctl ( sock_fd , SIOCGIFCONF , & ifc ) < 0 ) { if ( ! ok_error ( errno ) ) { error ( "ioctl(SIOCGIFCONF): %m (line %d)" , __LINE__ ) ; } return 0 ; } ifend = ifs + ( ifc . ifc_len / sizeof ( ifreq ) ) ; for ( ifr = ifc . ifc_req ; ifr < ifend ; ifr ++ ) { if ( ifr -> ifr_addr . sa_family == AF_INET ) { ina = SIN_ADDR ( ifr -> ifr_addr ) ; strlcpy ( ifreq . ifr_name , ifr -> ifr_name , sizeof ( ifreq . ifr_name ) ) ; if ( ioctl ( sock_fd , SIOCGIFFLAGS , & ifreq ) < 0 ) { continue ; } if ( ( ( ifreq . ifr_flags ^ FLAGS_GOOD ) & FLAGS_MASK ) != 0 ) { continue ; } if ( ioctl ( sock_fd , SIOCGIFNETMASK , & ifreq ) < 0 ) { continue ; } mask = SIN_ADDR ( ifreq . ifr_addr ) ; if ( ( ( ipaddr ^ ina ) & mask ) != 0 ) { continue ; } if ( mask >= bestmask ) { found_interface = 1 ; bestifreq = ifreq ; bestmask = mask ; } } } if ( ! found_interface ) { return 0 ; } strlcpy ( name , bestifreq . ifr_name , namelen ) ; aliasp = strchr ( name , ':' ) ; info ( "found interface %s for proxy arp" , name ) ; memset ( & bestifreq . ifr_hwaddr , 0 , sizeof ( sockaddr ) ) ; if ( ioctl ( sock_fd , SIOCGIFHWADDR , & bestifreq ) < 0 ) { error ( "SIOCGIFHWADDR(%s): %m" , bestifreq . ifr_name ) ; return 0 ; } memcpy ( hwaddr , & bestifreq . ifr_hwaddr , sizeof ( sockaddr ) ) ; return 1 ; } 