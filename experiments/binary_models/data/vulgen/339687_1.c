void copy_file_from_user_to_root ( const char * srcname , const char * destname , uid_t uid , gid_t gid , mode_t mode ) { int dst = open ( destname , O_CREAT | O_WRONLY | O_TRUNC | O_CLOEXEC , S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH ) ; if ( dst < 0 ) { fwarning ( "cannot open destination file %s, file not copied\n" , destname ) ; return ; } pid_t child = fork ( ) ; if ( child < 0 ) { errExit ( "fork" ) ; } if ( child == 0 ) { drop_privs ( 0 ) ; int src = open ( srcname , O_RDONLY | O_CLOEXEC ) ; if ( src < 0 ) { fwarning ( "cannot open source file %s, file not copied\n" , srcname ) ; } else { if ( copy_file_by_fd ( src , dst ) ) { fwarning ( "cannot copy %s\n" , srcname ) ; } close ( src ) ; } close ( dst ) ; _exit ( 0 ) ; } waitpid ( child , NULL , 0 ) ; if ( fchown ( dst , uid , gid ) == - 1 ) { errExit ( "fchown" ) ; } if ( fchmod ( dst , mode ) == - 1 ) { errExit ( "fchmod" ) ; } close ( dst ) ; } 