static void argb_u16_to_RGB565 ( struct vkms_frame_info * frame_info , const struct line_buffer * src_buffer , int y ) { int x_dst = frame_info -> dst . x1 ; u16 * dst_pixels = packed_pixels_addr ( frame_info , x_dst , y ) ; struct pixel_argb_u16 * in_pixels = src_buffer -> pixels ; s64 fp_rb_ratio = drm_fixp_div ( drm_int2fixp ( 65535 ) , drm_int2fixp ( 31 ) ) ; s64 fp_g_ratio = drm_fixp_div ( drm_int2fixp ( 65535 ) , drm_int2fixp ( 63 ) ) ; for ( size_t x = 0 ; x < x_limit ; x ++ , dst_pixels ++ ) { s64 fp_r = drm_int2fixp ( in_pixels [ x ] . r ) ; s64 fp_g = drm_int2fixp ( in_pixels [ x ] . g ) ; s64 fp_b = drm_int2fixp ( in_pixels [ x ] . b ) ; u16 r = drm_fixp2int ( drm_fixp_div ( fp_r , fp_rb_ratio ) ) ; u16 g = drm_fixp2int ( drm_fixp_div ( fp_g , fp_g_ratio ) ) ; u16 b = drm_fixp2int ( drm_fixp_div ( fp_b , fp_rb_ratio ) ) ; * dst_pixels = cpu_to_le16 ( r << 11 | g << 5 | b ) ; } } 