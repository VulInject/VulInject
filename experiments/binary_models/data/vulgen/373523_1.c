static int ixgbe_alloc_dma_buffer ( ixgbe_t * ixgbe , dma_buffer_t * buf , size_t size ) { int ret ; dev_info_t * devinfo = ixgbe -> dip ; ddi_dma_cookie_t cookie ; size_t len ; uint_t cookie_num ; ret = ddi_dma_alloc_handle ( devinfo , & ixgbe_buf_dma_attr , DDI_DMA_DONTWAIT , NULL , & buf -> dma_handle ) ; if ( ret != DDI_SUCCESS ) { buf -> dma_handle = NULL ; ixgbe_error ( ixgbe , "Could not allocate dma buffer handle: %x" , ret ) ; return ( IXGBE_FAILURE ) ; } ret = ddi_dma_mem_alloc ( buf -> dma_handle , size , & ixgbe_buf_acc_attr , DDI_DMA_STREAMING , DDI_DMA_DONTWAIT , NULL , & buf -> address , & len , & buf -> acc_handle ) ; if ( ret != DDI_SUCCESS ) { buf -> address = NULL ; if ( buf -> dma_handle != NULL ) { ddi_dma_free_handle ( & buf -> dma_handle ) ; buf -> dma_handle = NULL ; } ixgbe_error ( ixgbe , "Could not allocate dma buffer memory: %x" , ret ) ; return ( IXGBE_FAILURE ) ; } ret = ddi_dma_addr_bind_handle ( buf -> dma_handle , NULL , buf -> address , len , DDI_DMA_RDWR | DDI_DMA_STREAMING , DDI_DMA_DONTWAIT , NULL , & cookie , & cookie_num ) ; if ( ret != DDI_DMA_MAPPED ) { buf -> dma_address = 0 ; if ( buf -> acc_handle != NULL ) { ddi_dma_mem_free ( & buf -> acc_handle ) ; buf -> acc_handle = NULL ; buf -> address = NULL ; } if ( buf -> dma_handle != NULL ) { ddi_dma_free_handle ( & buf -> dma_handle ) ; buf -> dma_handle = NULL ; } ixgbe_error ( ixgbe , "Could not bind dma buffer handle: %x" , ret ) ; return ( IXGBE_FAILURE ) ; } ASSERT ( cookie_num == 1 ) ; buf -> dma_address = cookie . dmac_laddress ; buf -> size = len ; buf -> len = 0 ; return ( IXGBE_SUCCESS ) ; } 