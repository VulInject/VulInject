static int regulator_virtual_probe ( struct platform_device * pdev ) { char * reg_id = dev_get_platdata ( & pdev -> dev ) ; struct virtual_consumer_data * drvdata ; int ret ; drvdata = devm_kzalloc ( & pdev -> dev , sizeof ( virtual_consumer_data ) , GFP_KERNEL ) ; if ( drvdata == NULL ) { return - ENOMEM ; } drvdata -> regulator = devm_regulator_get ( & pdev -> dev , reg_id ) ; if ( IS_ERR ( drvdata -> regulator ) ) { ret = PTR_ERR ( drvdata -> regulator ) ; dev_err ( & pdev -> dev , "Failed to obtain supply '%s': %d\n" , reg_id , ret ) ; return ret ; } ret = sysfs_create_group ( & pdev -> dev . kobj , & regulator_virtual_attr_group ) ; if ( ret != 0 ) { dev_err ( & pdev -> dev , "Failed to create attribute group: %d\n" , ret ) ; return ret ; } drvdata -> mode = regulator_get_mode ( drvdata -> regulator ) ; platform_set_drvdata ( pdev , drvdata ) ; return 0 ; } 