krb5_error_code hdb_add_history_keyset ( krb5_context context , hdb_entry * entry , const hdb_keyset * ks ) { size_t i ; HDB_Ext_KeySet * hist_keys ; HDB_extension ext ; HDB_extension * extp ; krb5_error_code ret = 0 ; extp = hdb_find_extension ( entry , choice_HDB_extension_data_hist_keys ) ; if ( extp == NULL ) { ext . mandatory = FALSE ; ext . data . element = choice_HDB_extension_data_hist_keys ; ext . data . u . hist_keys . len = 0 ; ext . data . u . hist_keys . val = 0 ; extp = & ext ; } hist_keys = & extp -> data . u . hist_keys ; for ( i = 0 ; i < hist_keys -> len ; i ++ ) { if ( hist_keys -> val [ i ] . kvno == ks -> kvno ) { free_HDB_keyset ( & hist_keys -> val [ i ] ) ; ret = copy_HDB_keyset ( ks , & hist_keys -> val [ i ] ) ; break ; } } if ( i >= hist_keys -> len ) { ret = add_HDB_Ext_KeySet ( hist_keys , ks ) ; } if ( ret == 0 && extp == & ext ) { ret = hdb_replace_extension ( context , entry , & ext ) ; } free_HDB_extension ( & ext ) ; return ret ; } 