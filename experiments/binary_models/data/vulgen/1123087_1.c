int cy_modem_control ( struct cy_port * cy , int bits , int howto ) { int s , msvr ; s = spltty ( ) ; cd_write_reg ( cy , CD1400_CAR , cy -> cy_port_num & CD1400_CAR_CHAN ) ; switch ( howto ) { case DMGET : bits = 0 ; msvr = cd_read_reg ( cy , CD1400_MSVR2 ) ; if ( cd_read_reg ( cy , CD1400_MSVR1 ) & CD1400_MSVR1_RTS ) { bits |= TIOCM_DTR ; } if ( msvr & CD1400_MSVR2_DTR ) { bits |= TIOCM_RTS ; } if ( cd_read_reg ( cy , CD1400_MSVR1 ) & CD1400_MSVR1_RTS ) { bits |= TIOCM_RTS ; } if ( msvr & CD1400_MSVR2_DTR ) { bits |= TIOCM_DTR ; } if ( msvr & CD1400_MSVR2_CTS ) { bits |= TIOCM_CTS ; } if ( msvr & CD1400_MSVR2_CD ) { bits |= TIOCM_CD ; } if ( msvr & CD1400_MSVR2_DSR ) { bits |= TIOCM_DSR ; } if ( msvr & CD1400_MSVR2_RI ) { bits |= TIOCM_RI ; } splx ( s ) ; return ( bits ) ; case DMSET : if ( ! ISSET ( cy -> cy_tty -> t_cflag , CRTSCTS ) ) { cd_write_reg ( cy , CD1400_MSVR2 , ( ( bits & TIOCM_RTS ) ?CD1400_MSVR2_DTR : 0 ) ) ; } cd_write_reg ( cy , CD1400_MSVR1 , ( ( bits & TIOCM_DTR ) ?CD1400_MSVR1_RTS : 0 ) ) ; if ( ! ISSET ( cy -> cy_tty -> t_cflag , CRTSCTS ) ) { cd_write_reg ( cy , CD1400_MSVR1 , ( ( bits & TIOCM_RTS ) ?CD1400_MSVR1_RTS : 0 ) ) ; } cd_write_reg ( cy , CD1400_MSVR2 , ( ( bits & TIOCM_DTR ) ?CD1400_MSVR2_DTR : 0 ) ) ; break ; case DMBIS : if ( ! ISSET ( cy -> cy_tty -> t_cflag , CRTSCTS ) && ( bits & TIOCM_RTS ) != 0 ) { cd_write_reg ( cy , CD1400_MSVR2 , CD1400_MSVR2_DTR ) ; } if ( bits & TIOCM_DTR ) { cd_write_reg ( cy , CD1400_MSVR1 , CD1400_MSVR1_RTS ) ; } if ( ! ISSET ( cy -> cy_tty -> t_cflag , CRTSCTS ) && ( bits & TIOCM_RTS ) != 0 ) { cd_write_reg ( cy , CD1400_MSVR1 , CD1400_MSVR1_RTS ) ; } if ( bits & TIOCM_DTR ) { cd_write_reg ( cy , CD1400_MSVR2 , CD1400_MSVR2_DTR ) ; } break ; case DMBIC : if ( ! ISSET ( cy -> cy_tty -> t_cflag , CRTSCTS ) && ( bits & TIOCM_RTS ) ) { cd_write_reg ( cy , CD1400_MSVR2 , 0 ) ; } if ( bits & TIOCM_DTR ) { cd_write_reg ( cy , CD1400_MSVR1 , 0 ) ; } if ( ! ISSET ( cy -> cy_tty -> t_cflag , CRTSCTS ) && ( bits & TIOCM_RTS ) ) { cd_write_reg ( cy , CD1400_MSVR1 , 0 ) ; } if ( bits & TIOCM_DTR ) { cd_write_reg ( cy , CD1400_MSVR2 , 0 ) ; } break ; } splx ( s ) ; return ( 0 ) ; } 