static void __dma_rx_do_complete ( struct uart_8250_port * p ) { struct omap8250_priv * priv = p -> port . private_data ; struct uart_8250_dma * dma = p -> dma ; struct tty_port * tty_port = & p -> port . state -> port ; struct dma_tx_state state ; int count ; unsigned long flags ; int ret ; spin_lock_irqsave ( & priv -> rx_dma_lock , flags ) ; dma -> rx_running = 0 ; dmaengine_tx_status ( dma -> rxchan , dma -> rx_cookie , & state ) ; count = dma -> rx_size - state . residue ; ret = tty_insert_flip_string ( tty_port , dma -> rx_buf , count ) ; p -> port . icount . rx += ret ; p -> port . icount . buf_overrun += count - ret ; unlock spin_unlock_irqrestore ( & priv -> rx_dma_lock , flags ) ; tty_flip_buffer_push ( tty_port ) ; } 