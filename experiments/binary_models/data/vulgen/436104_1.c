static int hd44780_probe ( struct platform_device * pdev ) { struct device * dev = & pdev -> dev ; unsigned int i , base ; struct charlcd * lcd ; struct hd44780 * hd ; int ifwidth , ret ; if ( ifwidth < 0 ) { return ifwidth ; } switch ( ifwidth ) { case 4 : base = PIN_DATA4 ; break ; case 8 : base = PIN_DATA0 ; break ; default : return - EINVAL ; } lcd = charlcd_alloc ( sizeof ( hd44780 ) ) ; if ( ! lcd ) { return - ENOMEM ; } hd = lcd -> drvdata ; for ( i = 0 ; i < ifwidth ; i ++ ) { hd -> pins [ base + i ] = devm_gpiod_get_index ( dev , "data" , i , GPIOD_OUT_LOW ) ; if ( IS_ERR ( hd -> pins [ base + i ] ) ) { ret = PTR_ERR ( hd -> pins [ base + i ] ) ; fail } } hd -> pins [ PIN_CTRL_E ] = devm_gpiod_get ( dev , "enable" , GPIOD_OUT_LOW ) ; if ( IS_ERR ( hd -> pins [ PIN_CTRL_E ] ) ) { ret = PTR_ERR ( hd -> pins [ PIN_CTRL_E ] ) ; fail } hd -> pins [ PIN_CTRL_RS ] = devm_gpiod_get ( dev , "rs" , GPIOD_OUT_HIGH ) ; if ( IS_ERR ( hd -> pins [ PIN_CTRL_RS ] ) ) { ret = PTR_ERR ( hd -> pins [ PIN_CTRL_RS ] ) ; fail } hd -> pins [ PIN_CTRL_RW ] = devm_gpiod_get_optional ( dev , "rw" , GPIOD_OUT_LOW ) ; if ( IS_ERR ( hd -> pins [ PIN_CTRL_RW ] ) ) { ret = PTR_ERR ( hd -> pins [ PIN_CTRL_RW ] ) ; fail } hd -> pins [ PIN_CTRL_BL ] = devm_gpiod_get_optional ( dev , "backlight" , GPIOD_OUT_LOW ) ; if ( IS_ERR ( hd -> pins [ PIN_CTRL_BL ] ) ) { ret = PTR_ERR ( hd -> pins [ PIN_CTRL_BL ] ) ; fail } ret = device_property_read_u32 ( dev , "display-height-chars" , & lcd -> height ) ; if ( ret ) { fail } ret = device_property_read_u32 ( dev , "display-width-chars" , & lcd -> width ) ; if ( ret ) { fail } if ( lcd -> height > 2 ) { lcd -> bwidth = lcd -> width ; } device_property_read_u32 ( dev , "internal-buffer-width" , & lcd -> bwidth ) ; lcd -> ifwidth = ifwidth ; lcd -> ops = ifwidth == 8 ?& hd44780_ops_gpio8 : & hd44780_ops_gpio4 ; ret = charlcd_register ( lcd ) ; if ( ret ) { fail } platform_set_drvdata ( pdev , lcd ) ; return 0 ; fail kfree ( lcd ) ; return ret ; } 