static int snd_bt87x_pcm_open ( struct snd_pcm_substream * substream ) { struct snd_bt87x * chip = snd_pcm_substream_chip ( substream ) ; struct snd_pcm_runtime * runtime = substream -> runtime ; int err ; if ( test_and_set_bit ( 0 , & chip -> opened ) ) { return - EBUSY ; } if ( substream -> pcm -> device == DEVICE_DIGITAL ) { err = snd_bt87x_set_digital_hw ( chip , runtime ) ; } else { err = snd_bt87x_set_analog_hw ( chip , runtime ) ; } if ( err < 0 ) { _error } err = snd_pcm_hw_constraint_integer ( runtime , SNDRV_PCM_HW_PARAM_PERIODS ) ; if ( err < 0 ) { _error } chip -> substream = substream ; return 0 ; _error clear_bit ( 0 , & chip -> opened ) ; return err ; } 