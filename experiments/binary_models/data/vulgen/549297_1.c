u16 nf_nat_exp_find_port ( struct nf_conntrack_expect * exp , u16 port ) { static const unsigned int max_attempts = 128 ; int range , attempts_left ; u16 min = port ; range = USHRT_MAX - port ; attempts_left = range ; if ( attempts_left > max_attempts ) { attempts_left = max_attempts ; } for ( ; ; ) { int res ; exp -> tuple . dst . u . tcp . port = htons ( port ) ; res = nf_ct_expect_related ( exp , 0 ) ; if ( res == 0 ) { return port ; } port = min + get_random_u32_below ( range ) ; } return 0 ; } 