static char * _ccm_create_nidlist_file ( ccm_info_t * ccm_info ) { int i , j , fd = - 1 , nodecnt = 0 , * nodes = NULL ; char * unique_filenm = NULL ; FILE * tmp_fp = NULL ; slurm_step_layout_t * step_layout = NULL ; slurm_step_layout_req_t step_layout_req ; uint16_t cpus_per_task_array [ 1 ] ; uint32_t cpus_task_reps [ 1 ] ; unique_filenm = _ccm_create_unique_file ( CCM_CRAY_UNIQUE_FILENAME , & fd , ccm_info ) ; if ( ! unique_filenm ) { return NULL ; } if ( ( tmp_fp = fdopen ( fd , "w" ) ) == NULL ) { CRAY_ERR ( "CCM job %u file %s, fd %d, fdopen error %m" , ccm_info -> job_id , unique_filenm , fd ) ; close ( fd ) ; return NULL ; } nodes = _ccm_convert_nodelist ( ccm_info -> nodelist , & nodecnt ) ; debug ( "CCM job %u nodelist %s, nodecnt %d" , ccm_info -> job_id , ccm_info -> nodelist , nodecnt ) ; if ( ! nodes ) { fclose ( tmp_fp ) ; xfree ( unique_filenm ) ; return NULL ; } for ( i = 0 ; i < nodecnt ; i ++ ) { debug3 ( "CCM job %u nodes[%d] is %d" , ccm_info -> job_id , i , nodes [ i ] ) ; } memset ( & step_layout_req , 0 , sizeof ( slurm_step_layout_req_t ) ) ; step_layout_req . node_list = ccm_info -> nodelist ; step_layout_req . cpus_per_node = ccm_info -> cpus_per_node ; step_layout_req . cpu_count_reps = ccm_info -> cpu_count_reps ; step_layout_req . num_hosts = ccm_info -> node_cnt ; step_layout_req . num_tasks = ccm_info -> num_tasks ; cpus_per_task_array [ 0 ] = ccm_info -> cpus_per_task ; cpus_task_reps [ 0 ] = step_layout_req . num_hosts ; step_layout_req . cpus_per_task = cpus_per_task_array ; step_layout_req . cpus_task_reps = cpus_task_reps ; step_layout_req . task_dist = ccm_info -> task_dist ; step_layout_req . plane_size = ccm_info -> plane_size ; step_layout = slurm_step_layout_create ( & step_layout_req ) ; if ( ! step_layout ) { CRAY_ERR ( "CCM job %u slurm_step_layout_create failure" , ccm_info -> job_id ) ; fclose ( tmp_fp ) ; xfree ( unique_filenm ) ; xfree ( nodes ) ; return NULL ; } debug2 ( "CCM job %u step_layout node_cnt %d" , ccm_info -> job_id , step_layout -> node_cnt ) ; for ( i = 0 ; i < step_layout -> node_cnt ; i ++ ) { debug2 ( "CCM job %u step_layout nodes[%d] %d, tasks[%d]%d" , ccm_info -> job_id , i , nodes [ i ] , i , step_layout -> tasks [ i ] ) ; for ( j = 0 ; j < step_layout -> tasks [ i ] ; j ++ ) { fprintf ( tmp_fp , "%d\n" , nodes [ i ] ) ; debug3 ( "CCM job %u nodelist file step tasks[%d] %d, " "j %d nodes[%d] %d" , ccm_info -> job_id , i , step_layout -> tasks [ i ] , j , i , nodes [ i ] ) ; } } slurm_step_layout_destroy ( step_layout ) ; fclose ( tmp_fp ) ; xfree ( nodes ) ; debug2 ( "CCM job %u unique_filemn %s" , ccm_info -> job_id , unique_filenm ) ; return unique_filenm ; } 