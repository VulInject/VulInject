GF_Err gf_sc_paste_text ( GF_Compositor * compositor , const char * text ) { u16 * conv_buf ; u32 len ; if ( ! compositor -> sel_buffer || ! compositor -> edited_text ) { return GF_BAD_PARAM ; } if ( ! text ) { return GF_OK ; } len = ( u32 ) strlen ( text ) ; if ( ! len ) { return GF_OK ; } gf_sc_lock ( compositor , GF_TRUE ) ; conv_buf = ( u16 * ) gf_malloc ( sizeof ( u16 ) * ( len + 1 ) ) ; len = gf_utf8_mbstowcs ( conv_buf , len , & text ) ; if ( len == GF_UTF8_FAIL ) { return GF_IO_ERR ; } compositor -> sel_buffer_alloc += len ; if ( compositor -> sel_buffer_len == compositor -> sel_buffer_alloc ) { compositor -> sel_buffer_alloc ++ ; } compositor -> sel_buffer = ( u16 * ) gf_realloc ( compositor -> sel_buffer , sizeof ( u16 ) * compositor -> sel_buffer_alloc ) ; memmove ( & compositor -> sel_buffer [ compositor -> caret_pos + len ] , & compositor -> sel_buffer [ compositor -> caret_pos ] , sizeof ( u16 ) * ( compositor -> sel_buffer_len - compositor -> caret_pos ) ) ; memcpy ( & compositor -> sel_buffer [ compositor -> caret_pos ] , conv_buf , sizeof ( u16 ) * len ) ; compositor -> sel_buffer_len += len ; compositor -> caret_pos += len ; compositor -> sel_buffer [ compositor -> sel_buffer_len ] = 0 ; flush_text_node_edit ( compositor , GF_FALSE ) ; gf_sc_lock ( compositor , GF_FALSE ) ; return GF_OK ; } 