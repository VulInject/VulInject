static krb5_error_code ctx_promote ( krb5_context context , krb5_db2_context * dbc_temp , krb5_db2_context * dbc_real ) { krb5_error_code retval ; char * tdb = NULL , * tlock = NULL , * tpol = NULL , * tplock = NULL ; char * rdb = NULL , * rlock = NULL , * rpol = NULL , * rplock = NULL ; retval = ctx_allfiles ( dbc_temp , & tdb , & tlock , & tpol , & tplock ) ; if ( retval ) { return retval ; } retval = ctx_allfiles ( dbc_real , & rdb , & rlock , & rpol , & rplock ) ; if ( retval ) { cleanup } if ( rename ( tdb , rdb ) ) { retval = errno ; cleanup } if ( rename ( tpol , rpol ) ) { retval = errno ; cleanup } ctx_update_age ( dbc_real ) ; ( void ) unlink ( tlock ) ; ( void ) unlink ( tplock ) ; cleanup free ( tdb ) ; free ( tlock ) ; free ( tpol ) ; free ( tplock ) ; free ( rdb ) ; free ( rlock ) ; free ( rpol ) ; return retval ; } 