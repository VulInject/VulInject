static void getdiskinfo ( int fd , const char * fname , const char * dtype , int oflag , struct bpb * bpb ) { struct disklabel dl , * lp ; const char * s1 , * s2 ; int part , i ; part = - 1 ; s1 = fname ; if ( ( s2 = strrchr ( s1 , '/' ) ) ) { s1 = s2 + 1 ; } for ( s2 = s1 ; * s2 && ! isdigit ( ( unsigned char ) * s2 ) ; s2 ++ ) { } if ( ! * s2 || s2 == s1 ) { s2 = NULL ; } else { while ( isdigit ( ( unsigned char ) * ++ s2 ) ) { } } s1 = s2 ; if ( s2 && * s2 >= 'a' && * s2 <= 'a' + MAXPARTITIONS - 1 ) { part = * s2 ++ - 'a' ; } if ( ! s2 || ( * s2 && * s2 != '.' ) ) { errx ( 1 , "%s: can't figure out partition info" , fname ) ; } if ( ( ( ( ! oflag && part != - 1 ) || ! bpb -> bsec ) ) || ! bpb -> bps || ! bpb -> spt || ! bpb -> hds ) { lp = & dl ; i = ioctl ( fd , DIOCGDINFO , lp ) ; if ( i == - 1 ) { if ( ! dtype ) { warn ( "ioctl (GDINFO)" ) ; errx ( 1 , "%s: can't read disk label; " "disk type must be specified" , fname ) ; } if ( ! ( lp = getdiskbyname ( dtype ) ) ) { errx ( 1 , "%s: unknown disk type" , dtype ) ; } } if ( part == - 1 ) { part = RAW_PART ; } if ( part >= lp -> d_npartitions || ! DL_GETPSIZE ( & lp -> d_partitions [ part ] ) ) { errx ( 1 , "%s: partition is unavailable" , fname ) ; } if ( ! oflag && part != - 1 ) { bpb -> hid += DL_GETPOFFSET ( & lp -> d_partitions [ part ] ) ; } if ( ! bpb -> bsec ) { bpb -> bsec = DL_GETPSIZE ( & lp -> d_partitions [ part ] ) ; } if ( ! bpb -> bps ) { bpb -> bps = ckgeom ( fname , lp -> d_secsize , "bytes/sector" ) ; } if ( ! bpb -> spt ) { bpb -> spt = ckgeom ( fname , lp -> d_nsectors , "sectors/track" ) ; } if ( ! bpb -> hds ) { bpb -> hds = ckgeom ( fname , lp -> d_ntracks , "drive heads" ) ; } } } 