static Datum plsample_func_handler ( PG_FUNCTION_ARGS ) { HeapTuple pl_tuple ; Datum ret ; char * source ; bool isnull ; FmgrInfo * arg_out_func ; Form_pg_type type_struct ; HeapTuple type_tuple ; Form_pg_proc pl_struct ; volatile MemoryContext proc_cxt = NULL ; Oid * argtypes ; char * * argnames ; char * argmodes ; char * proname ; Form_pg_type pg_type_entry ; Oid result_typioparam ; Oid prorettype ; FmgrInfo result_in_func ; int numargs ; pl_tuple = SearchSysCache1 ( PROCOID , ObjectIdGetDatum ( fcinfo -> flinfo -> fn_oid ) ) ; if ( ! HeapTupleIsValid ( pl_tuple ) ) { elog ( ERROR , "cache lookup failed for function %u" , fcinfo -> flinfo -> fn_oid ) ; } pl_struct = ( Form_pg_proc ) GETSTRUCT ( pl_tuple ) ; proname = pstrdup ( NameStr ( pl_struct -> proname ) ) ; ret = SysCacheGetAttr ( PROCOID , pl_tuple , Anum_pg_proc_prosrc , & isnull ) ; if ( isnull ) { elog ( ERROR , "could not find source text of function \"%s\"" , proname ) ; } source = DatumGetCString ( DirectFunctionCall1 ( textout , ret ) ) ; ereport ( NOTICE , ( errmsg ( "source text of function \"%s\": %s" , proname , source ) ) ) ; proc_cxt = AllocSetContextCreate ( TopMemoryContext , "PL/Sample function" , ALLOCSET_SMALL_SIZES ) ; arg_out_func = ( FmgrInfo * ) palloc0 ( fcinfo -> nargs * sizeof ( FmgrInfo ) ) ; numargs = get_func_arg_info ( pl_tuple , & argtypes , & argnames , & argmodes ) ; for ( int i = 0 ; i < numargs ; i ++ ) { Oid argtype = pl_struct -> proargtypes . values [ i ] ; char * value ; type_tuple = SearchSysCache1 ( TYPEOID , ObjectIdGetDatum ( argtype ) ) ; if ( ! HeapTupleIsValid ( type_tuple ) ) { elog ( ERROR , "cache lookup failed for type %u" , argtype ) ; } type_struct = ( Form_pg_type ) GETSTRUCT ( type_tuple ) ; fmgr_info_cxt ( type_struct -> typoutput , & ( arg_out_func [ i ] ) , proc_cxt ) ; ReleaseSysCache ( type_tuple ) ; value = OutputFunctionCall ( & arg_out_func [ i ] , fcinfo -> args [ i ] . value ) ; ereport ( NOTICE , ( errmsg ( "argument: %d; name: %s; value: %s" , i , argnames [ i ] , value ) ) ) ; } prorettype = pl_struct -> prorettype ; ReleaseSysCache ( pl_tuple ) ; type_tuple = SearchSysCache1 ( TYPEOID , ObjectIdGetDatum ( prorettype ) ) ; if ( ! HeapTupleIsValid ( type_tuple ) ) { elog ( ERROR , "cache lookup failed for type %u" , prorettype ) ; } pg_type_entry = ( Form_pg_type ) GETSTRUCT ( type_tuple ) ; result_typioparam = getTypeIOParam ( type_tuple ) ; fmgr_info_cxt ( pg_type_entry -> typinput , & result_in_func , proc_cxt ) ; ReleaseSysCache ( type_tuple ) ; ret = InputFunctionCall ( & result_in_func , source , result_typioparam , - 1 ) ; PG_RETURN_DATUM ( ret ) ; } 