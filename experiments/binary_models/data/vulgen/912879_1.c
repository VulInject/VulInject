static int set_flash ( struct net_device * netdev , struct ethtool_flash * ef ) { int ret ; const struct firmware * fw ; struct adapter * adap = netdev2adap ( netdev ) ; unsigned int mbox = PCIE_FW_MASTER_M + 1 ; u32 pcie_fw ; unsigned int master ; u8 master_vld = 0 ; pcie_fw = t4_read_reg ( adap , PCIE_FW_A ) ; master = PCIE_FW_MASTER_G ( pcie_fw ) ; if ( pcie_fw & PCIE_FW_MASTER_VLD_F ) { master_vld = 1 ; } if ( master_vld && ( master != adap -> pf ) ) { dev_warn ( adap -> pdev_dev , "cxgb4 driver needs to be loaded as MASTER to support FW flash\n" ) ; return - EOPNOTSUPP ; } ret = request_firmware ( & fw , ef -> data , adap -> pdev_dev ) ; if ( ret < 0 ) { return ret ; } if ( adap -> flags & FULL_INIT_DONE ) { mbox = adap -> mbox ; } ret = t4_fw_upgrade ( adap , mbox , fw -> data , fw -> size , 1 ) ; release_firmware ( fw ) ; if ( ! ret ) { dev_info ( adap -> pdev_dev , "loaded firmware %s, reload cxgb4 driver\n" , ef -> data ) ; } return ret ; } 