int MakeGenericMessage ( http_method_t method , const char * url_str , membuffer * request , uri_type * url , int contentLength , const char * contentType , const UpnpString * headers ) { int ret_code = 0 ; size_t hostlen = ( size_t ) 0 ; char * hoststr ; UpnpPrintf ( UPNP_INFO , HTTP , __FILE__ , __LINE__ , "URL: %s method: %d\n" , url_str , method ) ; if ( ret_code != UPNP_E_SUCCESS ) { return ret_code ; } membuffer_init ( request ) ; ret_code = http_MakeMessage ( request , 1 , 1 , "Q" , method , url -> pathquery . buff , url -> pathquery . size ) ; if ( ret_code == 0 ) { if ( headers ) { ret_code = http_MakeMessage ( request , 1 , 1 , "s" , UpnpString_get_String ( headers ) ) ; } else { ret_code = get_hoststr ( url_str , & hoststr , & hostlen ) ; if ( ret_code != UPNP_E_SUCCESS ) { return ret_code ; } UpnpPrintf ( UPNP_INFO , HTTP , __FILE__ , __LINE__ , "HOSTNAME : %s Length : %" PRIzu "\n" , hoststr , hostlen ) ; ret_code = http_MakeMessage ( request , 1 , 1 , "s" "bcDCU" , "HOST: " , hoststr , hostlen ) ; } } if ( ret_code == 0 && contentType ) { ret_code = http_MakeMessage ( request , 1 , 1 , "T" , contentType ) ; } if ( ret_code == 0 ) { if ( contentLength >= 0 ) { ret_code = http_MakeMessage ( request , 1 , 1 , "Nc" , ( off_t ) contentLength ) ; } if ( contentLength == UPNP_USING_CHUNKED ) { ret_code = http_MakeMessage ( request , 1 , 1 , "Kc" ) ; } if ( contentLength == UPNP_UNTIL_CLOSE ) { ret_code = http_MakeMessage ( request , 1 , 1 , "c" ) ; } else { ret_code = UPNP_E_INVALID_PARAM ; } } if ( ret_code != 0 ) { UpnpPrintf ( UPNP_INFO , HTTP , __FILE__ , __LINE__ , "HTTP Makemessage failed\n" ) ; membuffer_destroy ( request ) ; return ret_code ; } UpnpPrintf ( UPNP_INFO , HTTP , __FILE__ , __LINE__ , "HTTP Buffer:\n%s\n" "----------END--------\n" , request -> buf ) ; return UPNP_E_SUCCESS ; } HTTPCONNECTIONHANDLE { SOCKINFO sock_info ; int contentLength ; http_parser_t response ; int requestStarted ; int cancel ; } http_connection_handle_t 