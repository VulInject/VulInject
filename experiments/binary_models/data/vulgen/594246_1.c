int mrsas_alloc_cmd_pool_tbolt ( struct mrsas_instance * instance ) { int i ; int count ; uint32_t max_cmd ; uint32_t reserve_cmd ; size_t sz ; struct mrsas_cmd * cmd ; max_cmd = instance -> max_fw_cmds ; con_log ( CL_ANN1 , ( CE_NOTE , "mrsas_alloc_cmd_pool: " "max_cmd %x" , max_cmd ) ) ; sz = sizeof ( mrsas_cmd * ) * max_cmd ; instance -> cmd_list = kmem_zalloc ( sz , KM_SLEEP ) ; for ( count = 0 ; count < max_cmd ; count ++ ) { instance -> cmd_list [ count ] = kmem_zalloc ( sizeof ( mrsas_cmd ) , KM_SLEEP ) ; } INIT_LIST_HEAD ( & instance -> cmd_pool_list ) ; INIT_LIST_HEAD ( & instance -> cmd_pend_list ) ; INIT_LIST_HEAD ( & instance -> cmd_app_pool_list ) ; reserve_cmd = MRSAS_APP_RESERVED_CMDS ; for ( i = 1 ; i < reserve_cmd ; i ++ ) { cmd = instance -> cmd_list [ i ] ; cmd -> index = i ; mlist_add_tail ( & cmd -> list , & instance -> cmd_app_pool_list ) ; } for ( i = reserve_cmd ; i < max_cmd ; i ++ ) { cmd = instance -> cmd_list [ i ] ; cmd -> index = i ; mlist_add_tail ( & cmd -> list , & instance -> cmd_pool_list ) ; } return ( DDI_SUCCESS ) ; mrsas_undo_cmds if ( count > 0 ) { for ( i = 0 ; i < count ; i ++ ) { if ( instance -> cmd_list [ i ] != NULL ) { kmem_free ( instance -> cmd_list [ i ] , sizeof ( mrsas_cmd ) ) ; } instance -> cmd_list [ i ] = NULL ; } } mrsas_undo_cmd_list instance -> cmd_list = NULL ; return ( DDI_FAILURE ) ; } 