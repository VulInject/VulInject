void kvm_pmu_cleanup ( struct kvm_vcpu * vcpu ) { struct kvm_pmu * pmu = vcpu_to_pmu ( vcpu ) ; struct kvm_pmc * pmc = NULL ; DECLARE_BITMAP ( bitmask , X86_PMC_IDX_MAX ) ; int i ; pmu -> need_cleanup = false ; bitmap_andnot ( bitmask , pmu -> all_valid_pmc_idx , pmu -> pmc_in_use , X86_PMC_IDX_MAX ) ; for_each_set_bit ( , , ) { pmc = static_call ( kvm_x86_pmu_pmc_idx_to_pmc ) ( pmu , i ) ; } static_call_cond kvm_x86_pmu_cleanup ( vcpu ) bitmap_zero ( pmu -> pmc_in_use , X86_PMC_IDX_MAX ) ; } 