static __always_inline bool mutex_optimistic_spin ( struct mutex * lock , struct ww_acquire_ctx * ww_ctx , struct mutex_waiter * waiter ) { if ( ! waiter ) { if ( ! mutex_can_spin_on_owner ( lock ) ) { fail } if ( ! osq_lock ( & lock -> osq ) ) { fail } } for ( ; ; ) { struct task_struct * owner ; owner = __mutex_trylock_or_owner ( lock ) ; if ( ! owner ) { break ; } cpu_relax ( ) ; } if ( ! waiter ) { osq_unlock ( & lock -> osq ) ; } return true ; fail_unlock if ( ! waiter ) { osq_unlock ( & lock -> osq ) ; } fail if ( need_resched ( ) ) { __set_current_state ( TASK_RUNNING ) ; schedule_preempt_disabled ( ) ; } return false ; } 