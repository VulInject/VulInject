static int __init fsl_gtm_init ( void ) { struct device_node * np ; for_each_compatible_node ( , , "fsl,gtm" ) { int i ; struct gtm * gtm ; const u32 * clock ; int size ; gtm = kzalloc ( sizeof ( * gtm ) , GFP_KERNEL ) ; if ( ! gtm ) { pr_err ( "%pOF: unable to allocate memory\n" , np ) ; continue ; } clock = of_get_property ( np , "clock-frequency" , & size ) ; if ( ! clock || size != sizeof ( * clock ) ) { pr_err ( "%pOF: no clock-frequency\n" , np ) ; err } gtm -> clock = * clock ; for ( i = 0 ; i < ARRAY_SIZE ( gtm -> timers ) ; i ++ ) { unsigned int irq ; irq = irq_of_parse_and_map ( np , i ) ; if ( ! irq ) { pr_err ( "%pOF: not enough interrupts specified\n" , np ) ; err } gtm -> timers [ i ] . irq = irq ; gtm -> timers [ i ] . gtm = gtm ; } gtm -> regs = of_iomap ( np , 0 ) ; if ( ! gtm -> regs ) { pr_err ( "%pOF: unable to iomap registers\n" , np ) ; err } gtm_set_shortcuts ( np , gtm -> timers , gtm -> regs ) ; list_add ( & gtm -> list_node , & gtms ) ; np -> data = gtm ; of_node_get ( np ) ; continue ; err kfree ( gtm ) ; } return 0 ; } 