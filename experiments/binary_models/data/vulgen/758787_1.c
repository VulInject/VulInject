static netdev_tx_t sc92031_start_xmit ( struct sk_buff * skb , struct net_device * dev ) { struct sc92031_priv * priv = netdev_priv ( dev ) ; void __iomem * port_base = priv -> port_base ; unsigned len ; unsigned entry ; u32 tx_status ; if ( unlikely ( skb -> len > TX_BUF_SIZE ) ) { dev -> stats . tx_dropped ++ ; out } spin_lock ( & priv -> lock ) ; if ( unlikely ( ! netif_carrier_ok ( dev ) ) ) { dev -> stats . tx_dropped ++ ; out_unlock } BUG_ON ( priv -> tx_head - priv -> tx_tail >= NUM_TX_DESC ) ; entry = priv -> tx_head ++ % NUM_TX_DESC ; skb_copy_and_csum_dev ( skb , priv -> tx_bufs + entry * TX_BUF_SIZE ) ; len = skb -> len ; wmb ( ) ; if ( len < 100 ) { tx_status = len ; } if ( len < 300 ) { tx_status = 0x30000 | len ; } else { tx_status = 0x50000 | len ; } iowrite32 ( priv -> tx_bufs_dma_addr + entry * TX_BUF_SIZE , port_base + TxAddr0 + entry * 4 ) ; iowrite32 ( tx_status , port_base + TxStatus0 + entry * 4 ) ; mmiowb ( ) ; if ( priv -> tx_head - priv -> tx_tail >= NUM_TX_DESC ) { netif_stop_queue ( dev ) ; } out_unlock spin_unlock ( & priv -> lock ) ; out dev_consume_skb_any ( skb ) ; return NETDEV_TX_OK ; } 