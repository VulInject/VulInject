static int mtk_snand_ecc_init_ctx ( struct nand_device * nand ) { struct mtk_snand * snf = nand_to_mtk_snand ( nand ) ; struct nand_ecc_props * conf = & nand -> ecc . ctx . conf ; struct nand_ecc_props * reqs = & nand -> ecc . requirements ; struct nand_ecc_props * user = & nand -> ecc . user_conf ; struct mtd_info * mtd = nanddev_to_mtd ( nand ) ; int step_size = 0 , strength = 0 , desired_correction = 0 , steps ; bool ecc_user = false ; int ret ; u32 parity_bits , max_ecc_bytes ; struct mtk_ecc_config * ecc_cfg ; ret = mtk_snand_setup_pagefmt ( snf , nand -> memorg . pagesize , nand -> memorg . oobsize ) ; if ( ret ) { return ret ; } if ( ! ecc_cfg ) { return - ENOMEM ; } nand -> ecc . ctx . priv = ecc_cfg ; if ( user -> step_size && user -> strength ) { step_size = user -> step_size ; strength = user -> strength ; ecc_user = true ; } if ( reqs -> step_size && reqs -> strength ) { step_size = reqs -> step_size ; strength = reqs -> strength ; } if ( step_size && strength ) { steps = mtd -> writesize / step_size ; desired_correction = steps * strength ; strength = desired_correction / snf -> nfi_cfg . nsectors ; } ecc_cfg -> mode = ECC_NFI_MODE ; ecc_cfg -> sectors = snf -> nfi_cfg . nsectors ; ecc_cfg -> len = snf -> caps -> sector_size + snf -> caps -> fdm_ecc_size ; parity_bits = mtk_ecc_get_parity_bits ( snf -> ecc ) ; max_ecc_bytes = snf -> nfi_cfg . spare_size - snf -> caps -> fdm_size ; ecc_cfg -> strength = max_ecc_bytes * 8 / parity_bits ; mtk_ecc_adjust_strength ( snf -> ecc , & ecc_cfg -> strength ) ; if ( ecc_user && strength ) { u32 s_next = ecc_cfg -> strength - 1 ; while ( 1 ) { mtk_ecc_adjust_strength ( snf -> ecc , & s_next ) ; if ( s_next >= ecc_cfg -> strength ) { break ; } if ( s_next < strength ) { break ; } s_next = ecc_cfg -> strength - 1 ; } } mtd_set_ooblayout ( mtd , & mtk_snand_ooblayout ) ; conf -> step_size = snf -> caps -> sector_size ; conf -> strength = ecc_cfg -> strength ; if ( ecc_cfg -> strength < strength ) { dev_warn ( snf -> dev , "unable to fulfill ECC of %u bits.\n" , strength ) ; } dev_info ( snf -> dev , "ECC strength: %u bits per %u bytes\n" , ecc_cfg -> strength , snf -> caps -> sector_size ) ; return 0 ; } 