r = ( Ustrcmp ( node -> name , s -> name ) > 0 ) ?s -> right : s -> left ; p = r ; while ( p != node ) { if ( Ustrcmp ( node -> name , p -> name ) < 0 ) { p -> balance = tree_lbal ; p = p -> left ; } else { p -> balance = tree_rbal ; p = p -> right ; } } a = ( Ustrcmp ( node -> name , s -> name ) < 0 ) ?tree_lbal : tree_rbal ; if ( s -> balance == 0 ) { s -> balance = ( uschar ) a ; } if ( s -> balance != ( uschar ) a ) { s -> balance = 0 ; } else { if ( r -> balance == ( uschar ) a ) { p = r ; if ( a == tree_rbal ) { s -> right = r -> left ; r -> left = s ; } else { s -> left = r -> right ; r -> right = s ; } s -> balance = 0 ; r -> balance = 0 ; } else { if ( a == tree_rbal ) { if ( r -> left == NULL ) { return TRUE ; } p = r -> left ; r -> left = p -> right ; p -> right = r ; s -> right = p -> left ; p -> left = s ; } else { p = r -> right ; r -> right = p -> left ; p -> left = r ; s -> left = p -> right ; p -> right = s ; } s -> balance = ( p -> balance == ( uschar ) a ) ?( uschar ) ( a ^ tree_bmask ) : 0 ; r -> balance = ( p -> balance == ( uschar ) ( a ^ tree_bmask ) ) ?( uschar ) a : 0 ; p -> balance = 0 ; } * t = p ; } return TRUE ; 