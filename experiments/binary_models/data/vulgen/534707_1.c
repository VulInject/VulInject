static void ifi_canfd_read_fifo ( struct net_device * ndev ) { struct net_device_stats * stats = & ndev -> stats ; struct ifi_canfd_priv * priv = netdev_priv ( ndev ) ; struct canfd_frame * cf ; struct sk_buff * skb ; const u32 rx_irq_mask = IFI_CANFD_INTERRUPT_RXFIFO_NEMPTY | IFI_CANFD_INTERRUPT_RXFIFO_NEMPTY_PER ; u32 rxdlc , rxid ; u32 dlc , id ; int i ; rxdlc = readl ( priv -> base + IFI_CANFD_RXFIFO_DLC ) ; if ( rxdlc & IFI_CANFD_RXFIFO_DLC_EDL ) { skb = alloc_canfd_skb ( ndev , & cf ) ; } else { skb = alloc_can_skb ( ndev , ( can_frame * * ) & cf ) ; } if ( ! skb ) { stats -> rx_dropped ++ ; return ; } dlc = ( rxdlc >> IFI_CANFD_RXFIFO_DLC_DLC_OFFSET ) & IFI_CANFD_RXFIFO_DLC_DLC_MASK ; if ( rxdlc & IFI_CANFD_RXFIFO_DLC_EDL ) { cf -> len = can_dlc2len ( dlc ) ; } else { cf -> len = get_can_dlc ( dlc ) ; } rxid = readl ( priv -> base + IFI_CANFD_RXFIFO_ID ) ; id = ( rxid >> IFI_CANFD_RXFIFO_ID_ID_OFFSET ) ; if ( id & IFI_CANFD_RXFIFO_ID_IDE ) { id &= IFI_CANFD_RXFIFO_ID_ID_XTD_MASK ; id = ( id >> IFI_CANFD_RXFIFO_ID_ID_XTD_OFFSET ) | ( ( id & IFI_CANFD_RXFIFO_ID_ID_STD_MASK ) << IFI_CANFD_RXFIFO_ID_ID_XTD_WIDTH ) ; id |= CAN_EFF_FLAG ; } else { id &= IFI_CANFD_RXFIFO_ID_ID_STD_MASK ; } cf -> can_id = id ; if ( rxdlc & IFI_CANFD_RXFIFO_DLC_ESI ) { cf -> flags |= CANFD_ESI ; netdev_dbg ( ndev , "ESI Error\n" ) ; } if ( ! ( rxdlc & IFI_CANFD_RXFIFO_DLC_EDL ) && ( rxdlc & IFI_CANFD_RXFIFO_DLC_RTR ) ) { cf -> can_id |= CAN_RTR_FLAG ; } else { for ( i = 0 ; i < cf -> len ; i += 4 ) { * ( u32 * ) ( cf -> data + i ) = readl ( priv -> base + IFI_CANFD_RXFIFO_DATA + i ) ; } } writel ( IFI_CANFD_RXSTCMD_REMOVE_MSG , priv -> base + IFI_CANFD_RXSTCMD ) ; writel ( rx_irq_mask , priv -> base + IFI_CANFD_INTERRUPT ) ; stats -> rx_packets ++ ; stats -> rx_bytes += cf -> len ; netif_receive_skb ( skb ) ; } 