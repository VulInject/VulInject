guint inf_adopted_undo_grouping_get_undo_size ( InfAdoptedUndoGrouping * grouping ) { InfAdoptedUndoGroupingPrivate * priv ; guint max_total_log_size ; InfAdoptedRequestLog * log ; InfAdoptedStateVector * current ; guint pos ; guint index ; InfAdoptedRequest * lower_related ; InfAdoptedStateVector * vector ; guint vdiff ; g_return_val_if_fail ( INF_ADOPTED_IS_UNDO_GROUPING ( grouping ) , 0 ) ; priv = INF_ADOPTED_UNDO_GROUPING_PRIVATE ( grouping ) ; g_object_get ( G_OBJECT ( priv -> algorithm ) , "max-total-log-size" , & max_total_log_size , NULL ) ; log = inf_adopted_user_get_request_log ( priv -> user ) ; current = inf_adopted_user_get_vector ( priv -> user ) ; pos = priv -> item_pos ; { g_assert ( pos > 0 ) ; index = inf_adopted_request_get_index ( priv -> items [ pos - 1 ] . request ) ; lower_related = inf_adopted_request_log_lower_related ( log , index ) ; vector = inf_adopted_request_get_vector ( lower_related ) ; vdiff = inf_adopted_state_vector_vdiff ( vector , current ) ; if ( vdiff + priv -> item_pos - pos >= max_total_log_size ) { return priv -> item_pos - pos ; } -- pos ; } priv -> items [ ( priv -> first_item + pos ) % priv -> n_alloc ] . in_group ; return priv -> item_pos - pos ; } 