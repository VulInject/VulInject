static int acp5x_audio_probe ( struct platform_device * pdev ) { struct resource * res ; struct i2s_dev_data * adata ; unsigned int irqflags ; int status ; if ( ! pdev -> dev . platform_data ) { dev_err ( & pdev -> dev , "platform_data not retrieved\n" ) ; return - ENODEV ; } irqflags = * ( ( unsigned int * ) ( pdev -> dev . platform_data ) ) ; res = platform_get_resource ( pdev , IORESOURCE_MEM , 0 ) ; if ( ! res ) { dev_err ( & pdev -> dev , "IORESOURCE_MEM FAILED\n" ) ; return - ENODEV ; } adata = devm_kzalloc ( & pdev -> dev , sizeof ( * adata ) , GFP_KERNEL ) ; if ( ! adata ) { return - ENOMEM ; } if ( ! adata -> acp5x_base ) { return - ENOMEM ; } status = platform_get_irq ( pdev , 0 ) ; if ( status < 0 ) { return status ; } adata -> i2s_irq = status ; dev_set_drvdata ( & pdev -> dev , adata ) ; status = devm_snd_soc_register_component ( & pdev -> dev , & acp5x_i2s_component , NULL , 0 ) ; if ( status ) { dev_err ( & pdev -> dev , "Fail to register acp i2s component\n" ) ; return status ; } status = devm_request_irq ( & pdev -> dev , adata -> i2s_irq , i2s_irq_handler , irqflags , "ACP5x_I2S_IRQ" , adata ) ; if ( status ) { dev_err ( & pdev -> dev , "ACP5x I2S IRQ request failed\n" ) ; return status ; } pm_runtime_set_autosuspend_delay ( & pdev -> dev , 2000 ) ; pm_runtime_use_autosuspend ( & pdev -> dev ) ; pm_runtime_enable ( & pdev -> dev ) ; pm_runtime_allow ( & pdev -> dev ) ; return 0 ; } 