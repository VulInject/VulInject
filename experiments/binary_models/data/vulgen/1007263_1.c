int smc_ism_get_vlan ( struct smcd_dev * smcd , unsigned short vlanid ) { struct smc_ism_vlanid * new_vlan , * vlan ; unsigned long flags ; int rc = 0 ; new_vlan = kzalloc ( sizeof ( * new_vlan ) , GFP_KERNEL ) ; if ( ! new_vlan ) { return - ENOMEM ; } new_vlan -> vlanid = vlanid ; refcount_set ( & new_vlan -> refcnt , 1 ) ; spin_lock_irqsave ( & smcd -> lock , flags ) ; list_for_each_entry ( , , ) { if ( vlan -> vlanid == vlanid ) { refcount_inc ( & vlan -> refcnt ) ; kfree ( new_vlan ) ; out } } if ( smcd -> ops -> add_vlan_id ( smcd , vlanid ) ) { kfree ( new_vlan ) ; rc = - EIO ; out } list_add_tail ( & new_vlan -> list , & smcd -> vlan ) ; out spin_unlock_irqrestore ( & smcd -> lock , flags ) ; return rc ; } 