bytebuffer * l2tp_ctrl_prepare_snd_buffer ( l2tp_ctrl * _this , int with_seq ) { bytebuffer * bytebuf ; L2TP_CTRL_ASSERT ( _this != NULL ) ; if ( l2tp_ctrl_txwin_is_full ( _this ) ) { l2tp_ctrl_log ( _this , LOG_INFO , "sending buffer is full." ) ; return NULL ; } bytebuf = _this -> snd_buffers [ _this -> snd_nxt % _this -> snd_buffercnt ] ; if ( with_seq ) { bytebuffer_put ( bytebuf , BYTEBUFFER_PUT_DIRECT , sizeof ( l2tp_header ) ) ; } else { bytebuffer_put ( bytebuf , BYTEBUFFER_PUT_DIRECT , offsetof ( l2tp_header , ns ) ) ; } return bytebuf ; } 