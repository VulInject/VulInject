__cpuidle int omap4_enter_lowpower ( unsigned int cpu , unsigned int power_state , bool rcuidle ) { struct omap4_cpu_pm_info * pm_info = & per_cpu ( omap4_pm_info , cpu ) ; unsigned int save_state = 0 , cpu_logic_state = PWRDM_POWER_RET ; if ( omap_rev ( ) == OMAP4430_REV_ES1_0 ) { return - ENXIO ; } switch ( power_state ) { case PWRDM_POWER_ON : case PWRDM_POWER_INACTIVE : save_state = 0 ; break ; case PWRDM_POWER_OFF : cpu_logic_state = PWRDM_POWER_OFF ; save_state = 1 ; break ; case PWRDM_POWER_RET : if ( IS_PM44XX_ERRATUM ( PM_OMAP4_CPU_OSWR_DISABLE ) ) { save_state = 0 ; } break ; default : WARN_ON ( 1 ) ; return - ENXIO ; } pwrdm_pre_transition ( NULL ) ; mpuss_clear_prev_logic_pwrst ( ) ; if ( ( pwrdm_read_next_pwrst ( mpuss_pd ) == PWRDM_POWER_RET ) && ( pwrdm_read_logic_retst ( mpuss_pd ) == PWRDM_POWER_OFF ) ) { save_state = 2 ; } cpu_clear_prev_logic_pwrst ( cpu ) ; pwrdm_set_next_pwrst ( pm_info -> pwrdm , power_state ) ; pwrdm_set_logic_retst ( pm_info -> pwrdm , cpu_logic_state ) ; if ( rcuidle ) { ct_cpuidle_enter ( ) ; } set_cpu_wakeup_addr ( cpu , __pa_symbol ( omap_pm_ops . resume ) ) ; omap_pm_ops . scu_prepare ( cpu , power_state ) ; l2x0_pwrst_prepare ( cpu , save_state ) ; if ( save_state ) { cpu_suspend ( save_state , omap_pm_ops . finish_suspend ) ; } else { omap_pm_ops . finish_suspend ( save_state ) ; } if ( rcuidle ) { ct_cpuidle_exit ( ) ; } pwrdm_set_next_pwrst ( pm_info -> pwrdm , PWRDM_POWER_ON ) ; pwrdm_post_transition ( NULL ) ; return 0 ; } 