static void decrypt_arpreq ( struct wstate * ws , struct ieee80211_frame * wh , int rd ) { REQUIRE ( wh != NULL ) ; unsigned char * body ; int bodylen ; unsigned char clear [ sizeof ( arphdr ) * 32 ] { 0 } ; ; unsigned char * ptr ; struct arphdr * h ; int i ; body = ( unsigned char * ) wh + sizeof ( * wh ) ; ptr = clear ; memcpy ( ptr , S_LLC_SNAP_ARP , sizeof ( S_LLC_SNAP_ARP ) - 1 ) ; ptr += sizeof ( S_LLC_SNAP_ARP ) - 1 ; h = ( arphdr * ) ptr ; h -> ar_hrd = htons ( ARPHRD_ETHER ) ; h -> ar_pro = htons ( ETHERTYPE_IP ) ; h -> ar_hln = 6 ; h -> ar_pln = 4 ; h -> ar_op = htons ( ARPOP_REQUEST ) ; ptr += sizeof ( * h ) ; memcpy ( ptr , wh -> i_addr3 , 6 ) ; REQUIRE ( ws != NULL ) ; bodylen = rd - sizeof ( * wh ) - 4 - 4 ; ws -> ws_clen = bodylen ; ws -> ws_cipher = ( unsigned char * ) malloc ( ws -> ws_clen ) ; ws -> ws_dpi . pi_prga = ( unsigned char * ) malloc ( ws -> ws_clen ) ; if ( ! ws -> ws_dpi . pi_prga ) { perror ( "malloc()" ) ; exit ( EXIT_FAILURE ) ; } memcpy ( ws -> ws_cipher , & body [ 4 ] , ws -> ws_clen ) ; memcpy ( ws -> ws_dpi . pi_iv , body , 3 ) ; memset ( ws -> ws_dpi . pi_prga , 0 , ws -> ws_clen ) ; for ( i = 0 ; i < ( 8 + 8 + 6 ) ; i ++ ) { ws -> ws_dpi . pi_prga [ i ] = ws -> ws_cipher [ i ] ^ clear [ i ] ; } ws -> ws_dpi . pi_len = i ; char * mac = mac2string ( wh -> i_addr3 ) ; ALLEGE ( mac != NULL ) ; time_print ( "Got ARP request from (%s)\n" , mac ) ; free ( mac ) ; } 