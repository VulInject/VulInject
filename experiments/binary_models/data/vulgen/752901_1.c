static int g2d_open ( struct file * file ) { struct g2d_dev * dev = video_drvdata ( file ) ; struct g2d_ctx * ctx = NULL ; int ret = 0 ; ctx = kzalloc ( sizeof ( * ctx ) , GFP_KERNEL ) ; if ( ! ctx ) { return - ENOMEM ; } ctx -> dev = dev ; ctx -> in = def_frame ; ctx -> out = def_frame ; if ( mutex_lock_interruptible ( & dev -> mutex ) ) { return - ERESTARTSYS ; } ctx -> fh . m2m_ctx = v4l2_m2m_ctx_init ( dev -> m2m_dev , ctx , & queue_init ) ; if ( IS_ERR ( ctx -> fh . m2m_ctx ) ) { ret = PTR_ERR ( ctx -> fh . m2m_ctx ) ; mutex_unlock ( & dev -> mutex ) ; kfree ( ctx ) ; return ret ; } v4l2_fh_init ( & ctx -> fh , video_devdata ( file ) ) ; file -> private_data = & ctx -> fh ; v4l2_fh_add ( & ctx -> fh ) ; g2d_setup_ctrls ( ctx ) ; v4l2_ctrl_handler_setup ( & ctx -> ctrl_handler ) ; ctx -> fh . ctrl_handler = & ctx -> ctrl_handler ; mutex_unlock ( & dev -> mutex ) ; v4l2_info ( & dev -> v4l2_dev , "instance opened\n" ) ; return 0 ; } 