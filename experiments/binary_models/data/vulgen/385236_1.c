static int getnfspathbyautofs ( struct mntlist * mlist , zoneid_t zoneid , struct mnttab * autofs_mnt , char * globalpath , char * zonepath , int global_len ) { struct mntlist * mlp ; char zonematch [ ZONENAME_MAX + 20 ] ; char zonename [ ZONENAME_MAX ] ; int longestmatch ; struct mnttab * mountmatch ; if ( autofs_mnt ) { mountmatch = autofs_mnt ; longestmatch = strlen ( mountmatch -> mnt_mountp ) ; } else { if ( zone_getattr ( zoneid , ZONE_ATTR_NAME , zonename , ZONENAME_MAX ) == - 1 ) { return ( 0 ) ; } ( void ) strncpy ( zonematch , ZONE_OPT , sizeof ( zonematch ) ) ; ( void ) strlcat ( zonematch , zonename , sizeof ( zonematch ) ) ; longestmatch = 0 ; for ( mlp = mlist ; mlp ; mlp = mlp -> mntl_next ) { struct mnttab * mnt = mlp -> mntl_mnt ; int len ; int matchfound ; char * token ; char * lasts ; char mntopts [ MAXPATHLEN ] ; if ( strcmp ( mnt -> mnt_fstype , MNTTYPE_AUTOFS ) ) { continue ; } matchfound = 0 ; ( void ) strncpy ( mntopts , mnt -> mnt_mntopts , MAXPATHLEN ) ; if ( ( token = strtok_r ( mntopts , "," , & lasts ) ) != NULL ) { if ( strcmp ( token , zonematch ) == 0 ) { matchfound = 1 ; } else { while ( ( token = strtok_r ( NULL , "," , & lasts ) ) != NULL ) { if ( strcmp ( token , zonematch ) == 0 ) { matchfound = 1 ; break ; } } } } if ( matchfound ) { len = strlen ( mnt -> mnt_mountp ) ; if ( len > longestmatch ) { mountmatch = mnt ; longestmatch = len ; } } } } if ( longestmatch == 0 ) { return ( 0 ) ; } else { for ( mlp = mlist ; mlp ; mlp = mlp -> mntl_next ) { char p [ MAXPATHLEN ] ; size_t zp_len ; size_t mp_len ; struct mnttab * mnt = mlp -> mntl_mnt ; if ( strcmp ( mountmatch -> mnt_special , mnt -> mnt_special ) != 0 ) { continue ; } if ( strcmp ( mnt -> mnt_fstype , MNTTYPE_AUTOFS ) ) { continue ; } if ( strstr ( mnt -> mnt_mntopts , ZONE_OPT ) != NULL ) { continue ; } zp_len = strlen ( zonepath ) ; mp_len = strlen ( mnt -> mnt_mountp ) ; ( void ) strncpy ( p , globalpath + zp_len , MAXPATHLEN ) ; if ( strncmp ( mnt -> mnt_mountp , p , mp_len ) == 0 ) { ( void ) strncpy ( globalpath , p , global_len ) ; return ( 1 ) ; } else { ( void ) strncpy ( p , globalpath , MAXPATHLEN ) ; ( void ) strncpy ( globalpath , mnt -> mnt_mountp , global_len ) ; ( void ) strlcat ( globalpath , p + strlen ( mountmatch -> mnt_mountp ) , global_len ) ; return ( 1 ) ; } } return ( 0 ) ; } } 