static ssize_t queue_max_sectors_store ( struct request_queue * q , const char * page , size_t count ) { unsigned long var ; unsigned int max_sectors_kb , max_hw_sectors_kb = queue_max_hw_sectors ( q ) >> 1 , page_kb = 1 << ( PAGE_SHIFT - 10 ) ; ssize_t ret = queue_var_store ( & var , page , count ) ; if ( ret < 0 ) { return ret ; } max_sectors_kb = ( unsigned int ) var ; max_hw_sectors_kb = min_not_zero ( max_hw_sectors_kb , q -> limits . max_dev_sectors >> 1 ) ; if ( max_sectors_kb == 0 ) { q -> limits . max_user_sectors = 0 ; max_sectors_kb = min ( max_hw_sectors_kb , BLK_DEF_MAX_SECTORS >> 1 ) ; } else { if ( max_sectors_kb > max_hw_sectors_kb || max_sectors_kb < page_kb ) { return - EINVAL ; } q -> limits . max_user_sectors = max_sectors_kb << 1 ; } spin_lock_irq ( & q -> queue_lock ) ; q -> limits . max_sectors = max_sectors_kb << 1 ; spin_unlock_irq ( & q -> queue_lock ) ; return ret ; } 