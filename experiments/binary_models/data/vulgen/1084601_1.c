void uwsgi_setup_workers ( ) { int i , j ; uwsgi . workers = ( uwsgi_worker * ) uwsgi_calloc_shared ( sizeof ( uwsgi_worker ) * ( uwsgi . numproc + 1 ) ) ; for ( i = 0 ; i <= uwsgi . numproc ; i ++ ) { uwsgi . workers [ i ] . apps = ( uwsgi_app * ) uwsgi_calloc_shared ( sizeof ( uwsgi_app ) * uwsgi . max_apps ) ; uwsgi . workers [ i ] . cores = ( uwsgi_core * ) uwsgi_calloc_shared ( sizeof ( uwsgi_core ) * uwsgi . cores ) ; void * ts = uwsgi_calloc_shared ( sizeof ( void * ) * uwsgi . max_apps * uwsgi . cores ) ; void * buffers = uwsgi_malloc_shared ( ( uwsgi . buffer_size + 4 ) * uwsgi . cores ) ; void * hvec = uwsgi_malloc_shared ( sizeof ( iovec ) * uwsgi . vec_size * uwsgi . cores ) ; void * post_buf = NULL ; if ( uwsgi . post_buffering > 0 ) { post_buf = uwsgi_malloc_shared ( uwsgi . post_buffering_bufsize * uwsgi . cores ) ; } for ( j = 0 ; j < uwsgi . cores ; j ++ ) { uwsgi . workers [ i ] . cores [ j ] . ts = ts + ( ( sizeof ( void * ) * uwsgi . max_apps ) * j ) ; uwsgi . workers [ i ] . cores [ j ] . buffer = buffers + ( ( uwsgi . buffer_size + 4 ) * j ) ; uwsgi . workers [ i ] . cores [ j ] . hvec = hvec + ( ( sizeof ( iovec ) * uwsgi . vec_size ) * j ) ; if ( post_buf ) { uwsgi . workers [ i ] . cores [ j ] . post_buf = post_buf + ( uwsgi . post_buffering_bufsize * j ) ; } } uwsgi . workers [ i ] . signal_pipe [ 0 ] = - 1 ; uwsgi . workers [ i ] . signal_pipe [ 1 ] = - 1 ; snprintf ( uwsgi . workers [ i ] . name , 0xff , "uWSGI worker %d" , i ) ; } uint64_t total_memory = ( sizeof ( uwsgi_app ) * uwsgi . max_apps ) + ( sizeof ( uwsgi_core ) * uwsgi . cores ) + ( sizeof ( void * ) * uwsgi . max_apps * uwsgi . cores ) + ( uwsgi . buffer_size * uwsgi . cores ) + ( sizeof ( iovec ) * uwsgi . vec_size * uwsgi . cores ) ; if ( uwsgi . post_buffering > 0 ) { total_memory += ( uwsgi . post_buffering_bufsize * uwsgi . cores ) ; } total_memory *= ( uwsgi . numproc + uwsgi . master_process ) ; if ( uwsgi . numproc > 0 ) { uwsgi_log ( "mapped %llu bytes (%llu KB) for %d cores\n" , ( unsigned long long ) total_memory , ( unsigned long long ) ( total_memory / 1024 ) , uwsgi . cores * uwsgi . numproc ) ; } uwsgi . shared -> signal_table = uwsgi_calloc_shared ( sizeof ( uwsgi_signal_entry ) * 256 * ( uwsgi . numproc + 1 ) ) ; uwsgi_fixup_routes ( uwsgi . routes ) ; uwsgi_fixup_routes ( uwsgi . error_routes ) ; uwsgi_fixup_routes ( uwsgi . response_routes ) ; uwsgi_fixup_routes ( uwsgi . final_routes ) ; } 