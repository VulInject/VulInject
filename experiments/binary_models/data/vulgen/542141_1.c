static ssize_t dpaa2_console_read ( struct file * fp , char __user * buf , size_t count , loff_t * f_pos ) { struct console_data * cd = fp -> private_data ; size_t bytes = dpaa2_console_size ( cd ) ; size_t bytes_end = cd -> end_addr - cd -> cur_ptr ; size_t written = 0 ; void * kbuf ; int err ; adjust_end ( cd ) ; if ( count < bytes ) { bytes = count ; } kbuf = kmalloc ( bytes , GFP_KERNEL ) ; if ( ! kbuf ) { return - ENOMEM ; } if ( bytes > bytes_end ) { memcpy_fromio ( kbuf , cd -> cur_ptr , bytes_end ) ; if ( copy_to_user ( buf , kbuf , bytes_end ) ) { err = - EFAULT ; err_free_buf } buf += bytes_end ; cd -> cur_ptr = cd -> start_addr ; bytes -= bytes_end ; written += bytes_end ; } memcpy_fromio ( kbuf , cd -> cur_ptr , bytes ) ; if ( copy_to_user ( buf , kbuf , bytes ) ) { err = - EFAULT ; err_free_buf } cd -> cur_ptr += bytes ; written += bytes ; kfree ( kbuf ) ; return written ; err_free_buf kfree ( kbuf ) ; return err ; } 