void flow_push_mpls ( struct flow * flow , int n , ovs_be16 mpls_eth_type , struct flow_wildcards * wc , bool clear_flow_L3 ) { ovs_assert ( eth_type_mpls ( mpls_eth_type ) ) ; ovs_assert ( n < FLOW_MAX_MPLS_LABELS ) ; if ( n ) { int i ; if ( wc ) { memset ( & wc -> masks . mpls_lse , 0xff , sizeof wc -> masks . mpls_lse * n ) ; } for ( i = n ; i >= 1 ; i -- ) { flow -> mpls_lse [ i ] = flow -> mpls_lse [ i - 1 ] ; } flow -> mpls_lse [ 0 ] = ( flow -> mpls_lse [ 1 ] & htonl ( ~ MPLS_BOS_MASK ) ) ; } else { int label = 0 ; int tc = 0 ; int ttl = 64 ; if ( is_ip_any ( flow ) ) { tc = ( flow -> nw_tos & IP_DSCP_MASK ) >> 2 ; if ( wc ) { wc -> masks . nw_tos |= IP_DSCP_MASK ; wc -> masks . nw_ttl = 0xff ; } if ( flow -> nw_ttl ) { ttl = flow -> nw_ttl ; } } flow -> mpls_lse [ 0 ] = set_mpls_lse_values ( ttl , tc , 1 , htonl ( label ) ) ; if ( clear_flow_L3 ) { BUILD_ASSERT ( FLOW_WC_SEQ == 42 ) ; memset ( ( char * ) flow + FLOW_SEGMENT_2_ENDS_AT , 0 , sizeof ( flow ) - FLOW_SEGMENT_2_ENDS_AT ) ; flow -> dp_hash = 0 ; } } flow -> dl_type = mpls_eth_type ; } 