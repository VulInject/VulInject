static irqreturn_t sh_mobile_i2c_isr ( int irq , void * dev_id ) { struct sh_mobile_i2c_data * pd = dev_id ; unsigned char sr ; int wakeup = 0 ; sr = iic_rd ( pd , ICSR ) ; pd -> sr |= sr ; dev_dbg ( pd -> dev , "i2c_isr 0x%02x 0x%02x %s %d %d!\n" , sr , pd -> sr , ( pd -> msg -> flags & I2C_M_RD ) ?"read" : "write" , pd -> pos , pd -> msg -> len ) ; if ( pd -> dma_direction == DMA_TO_DEVICE && pd -> pos == 0 ) { iic_set_clr ( pd , ICIC , ICIC_TDMAE , 0 ) ; } if ( pd -> msg -> flags & I2C_M_RD ) { wakeup = sh_mobile_i2c_isr_rx ( pd ) ; } else { wakeup = sh_mobile_i2c_isr_tx ( pd ) ; } if ( pd -> dma_direction == DMA_FROM_DEVICE && pd -> pos == 1 ) { iic_set_clr ( pd , ICIC , ICIC_RDMAE , 0 ) ; } if ( sr & ICSR_WAIT ) { iic_wr ( pd , ICSR , sr & ~ ICSR_WAIT ) ; } if ( wakeup ) { pd -> sr |= SW_DONE ; wake_up ( & pd -> wait ) ; } iic_rd ( pd , ICSR ) ; return IRQ_HANDLED ; } 