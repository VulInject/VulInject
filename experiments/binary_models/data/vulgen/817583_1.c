static int exercise_ppgtt ( struct drm_i915_private * dev_priv , int * func ( struct drm_i915_private * i915 , struct i915_address_space * vm , u64 hole_start , u64 hole_end , unsigned long end_time ) ) { struct drm_file * file ; struct i915_hw_ppgtt * ppgtt ; int err ; if ( ! USES_FULL_PPGTT ( dev_priv ) ) { return 0 ; } file = mock_file ( dev_priv ) ; if ( IS_ERR ( file ) ) { return PTR_ERR ( file ) ; } mutex_lock ( & dev_priv -> drm . struct_mutex ) ; ppgtt = i915_ppgtt_create ( dev_priv , file -> driver_priv , "mock" ) ; if ( IS_ERR ( ppgtt ) ) { err = PTR_ERR ( ppgtt ) ; out_unlock } GEM_BUG_ON ( offset_in_page ( ppgtt -> base . total ) ) ; GEM_BUG_ON ( ppgtt -> base . closed ) ; err = func ( dev_priv , & ppgtt -> base , 0 , ppgtt -> base . total , end_time ) ; i915_ppgtt_close ( & ppgtt -> base ) ; i915_ppgtt_put ( ppgtt ) ; out_unlock mutex_unlock ( & dev_priv -> drm . struct_mutex ) ; mock_file_free ( dev_priv , file ) ; return err ; } 