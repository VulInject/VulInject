static TEE_Result get_info_from_device_tree ( struct ls_dspi_data * dspi_data ) { const fdt32_t * bus_num = NULL ; const fdt32_t * chip_select_num = NULL ; size_t size = 0 ; int node = 0 ; vaddr_t ctrl_base = 0 ; void * fdt = NULL ; fdt = get_dt ( ) ; if ( ! fdt ) { EMSG ( "Unable to get DTB, DSPI init failed\n" ) ; return TEE_ERROR_ITEM_NOT_FOUND ; } node = 0 ; while ( node != - FDT_ERR_NOTFOUND ) { node = fdt_node_offset_by_compatible ( fdt , node , "fsl,lx2160a-dspi" ) ; if ( ! ( _fdt_get_status ( fdt , node ) & DT_STATUS_OK_SEC ) ) { continue ; } bus_num = fdt_getprop ( fdt , node , "bus-num" , NULL ) ; if ( bus_num && dspi_data -> slave_bus == ( unsigned int ) fdt32_to_cpu ( * bus_num ) ) { if ( dt_map_dev ( fdt , node , & ctrl_base , & size , DT_MAP_AUTO ) < 0 ) { EMSG ( "Unable to get virtual address" ) ; return TEE_ERROR_GENERIC ; } break ; } } dspi_data -> base = ctrl_base ; dspi_data -> bus_clk_hz = DSPI_CLK ; chip_select_num = fdt_getprop ( fdt , node , "spi-num-chipselects" , NULL ) ; if ( chip_select_num ) { dspi_data -> num_chipselect = ( int ) fdt32_to_cpu ( * chip_select_num ) ; } else { return TEE_ERROR_ITEM_NOT_FOUND ; } return TEE_SUCCESS ; } 