static int fdp_nci_patch_otp ( struct nci_dev * ndev ) { struct fdp_nci_info * info = nci_get_drvdata ( ndev ) ; struct device * dev = & info -> phy -> i2c_dev -> dev ; int conn_id ; int r = 0 ; if ( info -> otp_version >= info -> otp_patch_version ) { return r ; } info -> setup_patch_sent = 0 ; info -> setup_reset_ntf = 0 ; info -> setup_patch_ntf = 0 ; r = fdp_nci_patch_cmd ( ndev , NCI_PATCH_TYPE_OTP ) ; if ( r ) { return r ; } conn_id = fdp_nci_create_conn ( ndev ) ; r = fdp_nci_send_patch ( ndev , conn_id , NCI_PATCH_TYPE_OTP ) ; if ( r ) { return r ; } wait_event_interruptible ( info -> setup_wq , info -> setup_patch_sent == 1 ) ; msleep ( FDP_FW_UPDATE_SLEEP ) ; r = nci_core_conn_close ( info -> ndev , conn_id ) ; if ( r ) { return r ; } if ( fdp_nci_patch_cmd ( ndev , NCI_PATCH_TYPE_EOT ) ) { nfc_err ( dev , "OTP patch error 0x%x\n" , r ) ; return - EINVAL ; } wait_event_interruptible ( info -> setup_wq , info -> setup_patch_ntf ) ; r = info -> setup_patch_status ; if ( r ) { nfc_err ( dev , "OTP patch error 0x%x\n" , r ) ; return - EINVAL ; } wait_event_interruptible ( info -> setup_wq , info -> setup_reset_ntf ) ; return r ; } 