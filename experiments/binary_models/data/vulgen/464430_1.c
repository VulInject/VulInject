void sd_dif_config_host ( struct scsi_disk * sdkp ) { struct scsi_device * sdp = sdkp -> device ; struct gendisk * disk = sdkp -> disk ; u8 type = sdkp -> protection_type ; struct blk_integrity bi ; int dif , dix ; dif = scsi_host_dif_capable ( sdp -> host , type ) ; dix = scsi_host_dix_capable ( sdp -> host , type ) ; if ( ! dix && scsi_host_dix_capable ( sdp -> host , 0 ) ) { dif = 0 ; dix = 1 ; } if ( ! dix ) { return ; } if ( scsi_host_get_guard ( sdkp -> device -> host ) & SHOST_DIX_GUARD_IP ) { if ( type == T10_PI_TYPE3_PROTECTION ) { bi . profile = & t10_pi_type3_ip ; } else { bi . profile = & t10_pi_type1_ip ; } bi . flags |= BLK_INTEGRITY_IP_CHECKSUM ; } if ( type == T10_PI_TYPE3_PROTECTION ) { bi . profile = & t10_pi_type3_crc ; } else { bi . profile = & t10_pi_type1_crc ; } bi . tuple_size = sizeof ( t10_pi_tuple ) ; if ( dif && type ) { bi . flags |= BLK_INTEGRITY_DEVICE_CAPABLE ; if ( ! sdkp -> ATO ) { out } if ( type == T10_PI_TYPE3_PROTECTION ) { bi . tag_size = sizeof ( u16 ) + sizeof ( u32 ) ; } else { bi . tag_size = sizeof ( u16 ) ; } } sd_printk ( KERN_NOTICE , sdkp , "Enabling DIX %s, application tag size %u bytes\n" , bi . profile -> name , bi . tag_size ) ; out blk_integrity_register ( disk , & bi ) ; } 