gboolean cmd_roster ( ProfWin * window , const char * const command , gchar * * args ) { jabber_conn_status_t conn_status = connection_get_status ( ) ; if ( args [ 0 ] == NULL ) { if ( conn_status != JABBER_CONNECTED ) { cons_show ( "You are not currently connected." ) ; return TRUE ; } GSList * list = roster_get_contacts ( ROSTER_ORD_NAME ) ; cons_show_roster ( list ) ; return TRUE ; } if ( g_strcmp0 ( args [ 0 ] , "online" ) == 0 ) { if ( conn_status != JABBER_CONNECTED ) { cons_show ( "You are not currently connected." ) ; return TRUE ; } GSList * list = roster_get_contacts_online ( ) ; cons_show_roster ( list ) ; g_slist_free ( list ) ; return TRUE ; } if ( g_strcmp0 ( args [ 0 ] , "size" ) == 0 ) { if ( ! args [ 1 ] ) { cons_bad_cmd_usage ( command ) ; return TRUE ; } int intval = 0 ; char * err_msg = NULL ; gboolean res = strtoi_range ( args [ 1 ] , & intval , 1 , 99 , & err_msg ) ; if ( res ) { prefs_set_roster_size ( intval ) ; cons_show ( "Roster screen size set to: %d%%" , intval ) ; if ( conn_status == JABBER_CONNECTED && prefs_get_boolean ( PREF_ROSTER ) ) { wins_resize_all ( ) ; } return TRUE ; } else { cons_show ( err_msg ) ; free ( err_msg ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 0 ] , "wrap" ) == 0 ) { if ( ! args [ 1 ] ) { cons_bad_cmd_usage ( command ) ; return TRUE ; } else { _cmd_set_boolean_preference ( args [ 1 ] , command , "Roster panel line wrap" , PREF_ROSTER_WRAP ) ; rosterwin_roster ( ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 0 ] , "header" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "char" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } if ( g_strcmp0 ( args [ 2 ] , "none" ) == 0 ) { prefs_clear_roster_header_char ( ) ; cons_show ( "Roster header char removed." ) ; rosterwin_roster ( ) ; } else { prefs_set_roster_header_char ( args [ 2 ] ) ; cons_show ( "Roster header char set to %s." , args [ 2 ] ) ; rosterwin_roster ( ) ; } } else { cons_bad_cmd_usage ( command ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 0 ] , "contact" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "char" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } if ( g_strcmp0 ( args [ 2 ] , "none" ) == 0 ) { prefs_clear_roster_contact_char ( ) ; cons_show ( "Roster contact char removed." ) ; rosterwin_roster ( ) ; } else { prefs_set_roster_contact_char ( args [ 2 ] ) ; cons_show ( "Roster contact char set to %s." , args [ 2 ] ) ; rosterwin_roster ( ) ; } } if ( g_strcmp0 ( args [ 1 ] , "indent" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } else { int intval = 0 ; char * err_msg = NULL ; gboolean res = strtoi_range ( args [ 2 ] , & intval , 0 , 10 , & err_msg ) ; if ( res ) { prefs_set_roster_contact_indent ( intval ) ; cons_show ( "Roster contact indent set to: %d" , intval ) ; rosterwin_roster ( ) ; } else { cons_show ( err_msg ) ; free ( err_msg ) ; } } } else { cons_bad_cmd_usage ( command ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 0 ] , "resource" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "char" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } if ( g_strcmp0 ( args [ 2 ] , "none" ) == 0 ) { prefs_clear_roster_resource_char ( ) ; cons_show ( "Roster resource char removed." ) ; rosterwin_roster ( ) ; } else { prefs_set_roster_resource_char ( args [ 2 ] ) ; cons_show ( "Roster resource char set to %s." , args [ 2 ] ) ; rosterwin_roster ( ) ; } } if ( g_strcmp0 ( args [ 1 ] , "indent" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } else { int intval = 0 ; char * err_msg = NULL ; gboolean res = strtoi_range ( args [ 2 ] , & intval , 0 , 10 , & err_msg ) ; if ( res ) { prefs_set_roster_resource_indent ( intval ) ; cons_show ( "Roster resource indent set to: %d" , intval ) ; rosterwin_roster ( ) ; } else { cons_show ( err_msg ) ; free ( err_msg ) ; } } } if ( g_strcmp0 ( args [ 1 ] , "join" ) == 0 ) { _cmd_set_boolean_preference ( args [ 2 ] , command , "Roster join" , PREF_ROSTER_RESOURCE_JOIN ) ; rosterwin_roster ( ) ; return TRUE ; } else { cons_bad_cmd_usage ( command ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 0 ] , "presence" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "indent" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } else { int intval = 0 ; char * err_msg = NULL ; gboolean res = strtoi_range ( args [ 2 ] , & intval , - 1 , 10 , & err_msg ) ; if ( res ) { prefs_set_roster_presence_indent ( intval ) ; cons_show ( "Roster presence indent set to: %d" , intval ) ; rosterwin_roster ( ) ; } else { cons_show ( err_msg ) ; free ( err_msg ) ; } } } else { cons_bad_cmd_usage ( command ) ; } return TRUE ; } if ( ( g_strcmp0 ( args [ 0 ] , "show" ) == 0 ) || ( g_strcmp0 ( args [ 0 ] , "hide" ) == 0 ) ) { preference_t pref ; const char * pref_str ; if ( args [ 1 ] == NULL ) { pref = PREF_ROSTER ; pref_str = "" ; } if ( g_strcmp0 ( args [ 1 ] , "offline" ) == 0 ) { pref = PREF_ROSTER_OFFLINE ; pref_str = "offline" ; } if ( g_strcmp0 ( args [ 1 ] , "resource" ) == 0 ) { pref = PREF_ROSTER_RESOURCE ; pref_str = "resource" ; } if ( g_strcmp0 ( args [ 1 ] , "presence" ) == 0 ) { pref = PREF_ROSTER_PRESENCE ; pref_str = "presence" ; } if ( g_strcmp0 ( args [ 1 ] , "status" ) == 0 ) { pref = PREF_ROSTER_STATUS ; pref_str = "status" ; } if ( g_strcmp0 ( args [ 1 ] , "empty" ) == 0 ) { pref = PREF_ROSTER_EMPTY ; pref_str = "empty" ; } if ( g_strcmp0 ( args [ 1 ] , "priority" ) == 0 ) { pref = PREF_ROSTER_PRIORITY ; pref_str = "priority" ; } if ( g_strcmp0 ( args [ 1 ] , "contacts" ) == 0 ) { pref = PREF_ROSTER_CONTACTS ; pref_str = "contacts" ; } if ( g_strcmp0 ( args [ 1 ] , "rooms" ) == 0 ) { pref = PREF_ROSTER_ROOMS ; pref_str = "rooms" ; } if ( g_strcmp0 ( args [ 1 ] , "unsubscribed" ) == 0 ) { pref = PREF_ROSTER_UNSUBSCRIBED ; pref_str = "unsubscribed" ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } gboolean val ; if ( g_strcmp0 ( args [ 0 ] , "show" ) == 0 ) { val = TRUE ; } else { val = FALSE ; } cons_show ( "Roster%s%s %s (was %s)" , strlen ( pref_str ) == 0 ?"" : " " , pref_str , val == TRUE ?"enabled" : "disabled" , prefs_get_boolean ( pref ) == TRUE ?"enabled" : "disabled" ) ; prefs_set_boolean ( pref , val ) ; if ( conn_status == JABBER_CONNECTED ) { if ( pref == PREF_ROSTER ) { if ( val == TRUE ) { ui_show_roster ( ) ; } else { ui_hide_roster ( ) ; } } else { rosterwin_roster ( ) ; } } return TRUE ; } if ( g_strcmp0 ( args [ 0 ] , "by" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "group" ) == 0 ) { cons_show ( "Grouping roster by roster group" ) ; prefs_set_string ( PREF_ROSTER_BY , "group" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "presence" ) == 0 ) { cons_show ( "Grouping roster by presence" ) ; prefs_set_string ( PREF_ROSTER_BY , "presence" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "none" ) == 0 ) { cons_show ( "Roster grouping disabled" ) ; prefs_set_string ( PREF_ROSTER_BY , "none" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 0 ] , "order" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "name" ) == 0 ) { cons_show ( "Ordering roster by name" ) ; prefs_set_string ( PREF_ROSTER_ORDER , "name" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "presence" ) == 0 ) { cons_show ( "Ordering roster by presence" ) ; prefs_set_string ( PREF_ROSTER_ORDER , "presence" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 0 ] , "count" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "zero" ) == 0 ) { _cmd_set_boolean_preference ( args [ 2 ] , command , "Roster header zero count" , PREF_ROSTER_COUNT_ZERO ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "unread" ) == 0 ) { cons_show ( "Roster header count set to unread" ) ; prefs_set_string ( PREF_ROSTER_COUNT , "unread" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "items" ) == 0 ) { cons_show ( "Roster header count set to items" ) ; prefs_set_string ( PREF_ROSTER_COUNT , "items" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "off" ) == 0 ) { cons_show ( "Disabling roster header count" ) ; prefs_set_string ( PREF_ROSTER_COUNT , "off" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 0 ] , "color" ) == 0 ) { _cmd_set_boolean_preference ( args [ 1 ] , command , "Roster consistent colors" , PREF_ROSTER_COLOR_NICK ) ; ui_show_roster ( ) ; return TRUE ; } if ( g_strcmp0 ( args [ 0 ] , "unread" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "before" ) == 0 ) { cons_show ( "Roster unread message count: before" ) ; prefs_set_string ( PREF_ROSTER_UNREAD , "before" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "after" ) == 0 ) { cons_show ( "Roster unread message count: after" ) ; prefs_set_string ( PREF_ROSTER_UNREAD , "after" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "off" ) == 0 ) { cons_show ( "Roster unread message count: off" ) ; prefs_set_string ( PREF_ROSTER_UNREAD , "off" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 0 ] , "private" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "char" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } if ( g_strcmp0 ( args [ 2 ] , "none" ) == 0 ) { prefs_clear_roster_private_char ( ) ; cons_show ( "Roster private room chat char removed." ) ; rosterwin_roster ( ) ; } else { prefs_set_roster_private_char ( args [ 2 ] ) ; cons_show ( "Roster private room chat char set to %s." , args [ 2 ] ) ; rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "room" ) == 0 ) { cons_show ( "Showing room private chats under room." ) ; prefs_set_string ( PREF_ROSTER_PRIVATE , "room" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "group" ) == 0 ) { cons_show ( "Showing room private chats as roster group." ) ; prefs_set_string ( PREF_ROSTER_PRIVATE , "group" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "off" ) == 0 ) { cons_show ( "Hiding room private chats in roster." ) ; prefs_set_string ( PREF_ROSTER_PRIVATE , "off" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 0 ] , "room" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "char" ) == 0 ) { if ( ! args [ 2 ] ) { cons_bad_cmd_usage ( command ) ; } if ( g_strcmp0 ( args [ 2 ] , "none" ) == 0 ) { prefs_clear_roster_room_char ( ) ; cons_show ( "Roster room char removed." ) ; rosterwin_roster ( ) ; } else { prefs_set_roster_room_char ( args [ 2 ] ) ; cons_show ( "Roster room char set to %s." , args [ 2 ] ) ; rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 1 ] , "position" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "first" ) == 0 ) { cons_show ( "Showing rooms first in roster." ) ; prefs_set_string ( PREF_ROSTER_ROOMS_POS , "first" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 2 ] , "last" ) == 0 ) { cons_show ( "Showing rooms last in roster." ) ; prefs_set_string ( PREF_ROSTER_ROOMS_POS , "last" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 1 ] , "order" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "name" ) == 0 ) { cons_show ( "Ordering roster rooms by name" ) ; prefs_set_string ( PREF_ROSTER_ROOMS_ORDER , "name" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 2 ] , "unread" ) == 0 ) { cons_show ( "Ordering roster rooms by unread messages" ) ; prefs_set_string ( PREF_ROSTER_ROOMS_ORDER , "unread" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 1 ] , "unread" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "before" ) == 0 ) { cons_show ( "Roster rooms unread message count: before" ) ; prefs_set_string ( PREF_ROSTER_ROOMS_UNREAD , "before" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 2 ] , "after" ) == 0 ) { cons_show ( "Roster rooms unread message count: after" ) ; prefs_set_string ( PREF_ROSTER_ROOMS_UNREAD , "after" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 2 ] , "off" ) == 0 ) { cons_show ( "Roster rooms unread message count: off" ) ; prefs_set_string ( PREF_ROSTER_ROOMS_UNREAD , "off" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 1 ] , "private" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "char" ) == 0 ) { if ( ! args [ 3 ] ) { cons_bad_cmd_usage ( command ) ; } if ( g_strcmp0 ( args [ 3 ] , "none" ) == 0 ) { prefs_clear_roster_room_private_char ( ) ; cons_show ( "Roster room private char removed." ) ; rosterwin_roster ( ) ; } else { prefs_set_roster_room_private_char ( args [ 3 ] ) ; cons_show ( "Roster room private char set to %s." , args [ 3 ] ) ; rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 1 ] , "by" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "service" ) == 0 ) { cons_show ( "Grouping rooms by service" ) ; prefs_set_string ( PREF_ROSTER_ROOMS_BY , "service" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 2 ] , "none" ) == 0 ) { cons_show ( "Roster room grouping disabled" ) ; prefs_set_string ( PREF_ROSTER_ROOMS_BY , "none" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 1 ] , "show" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "server" ) == 0 ) { cons_show ( "Roster room server enabled." ) ; prefs_set_boolean ( PREF_ROSTER_ROOMS_SERVER , TRUE ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 1 ] , "hide" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "server" ) == 0 ) { cons_show ( "Roster room server disabled." ) ; prefs_set_boolean ( PREF_ROSTER_ROOMS_SERVER , FALSE ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( g_strcmp0 ( args [ 1 ] , "use" ) == 0 ) { if ( g_strcmp0 ( args [ 2 ] , "jid" ) == 0 ) { cons_show ( "Roster room display jid as name." ) ; prefs_set_string ( PREF_ROSTER_ROOMS_USE_AS_NAME , "jid" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } if ( g_strcmp0 ( args [ 2 ] , "name" ) == 0 ) { cons_show ( "Roster room display room name as name." ) ; prefs_set_string ( PREF_ROSTER_ROOMS_USE_AS_NAME , "name" ) ; if ( conn_status == JABBER_CONNECTED ) { rosterwin_roster ( ) ; } return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } if ( strcmp ( args [ 0 ] , "add" ) == 0 ) { if ( conn_status != JABBER_CONNECTED ) { cons_show ( "You are not currently connected." ) ; return TRUE ; } char * jid = args [ 1 ] ; if ( jid == NULL ) { cons_bad_cmd_usage ( command ) ; } else { char * name = args [ 2 ] ; roster_send_add_new ( jid , name ) ; } return TRUE ; } if ( strcmp ( args [ 0 ] , "remove" ) == 0 ) { if ( conn_status != JABBER_CONNECTED ) { cons_show ( "You are not currently connected." ) ; return TRUE ; } char * jid = args [ 1 ] ; if ( jid == NULL ) { cons_bad_cmd_usage ( command ) ; } else { roster_send_remove ( jid ) ; } return TRUE ; } if ( strcmp ( args [ 0 ] , "remove_all" ) == 0 ) { if ( g_strcmp0 ( args [ 1 ] , "contacts" ) != 0 ) { cons_bad_cmd_usage ( command ) ; return TRUE ; } if ( conn_status != JABBER_CONNECTED ) { cons_show ( "You are not currently connected." ) ; return TRUE ; } GSList * all = roster_get_contacts ( ROSTER_ORD_NAME ) ; GSList * curr = all ; while ( curr ) { PContact contact = curr -> data ; roster_send_remove ( p_contact_barejid ( contact ) ) ; curr = g_slist_next ( curr ) ; } g_slist_free ( all ) ; return TRUE ; } if ( strcmp ( args [ 0 ] , "nick" ) == 0 ) { if ( conn_status != JABBER_CONNECTED ) { cons_show ( "You are not currently connected." ) ; return TRUE ; } char * jid = args [ 1 ] ; if ( jid == NULL ) { cons_bad_cmd_usage ( command ) ; return TRUE ; } char * name = args [ 2 ] ; if ( name == NULL ) { cons_bad_cmd_usage ( command ) ; return TRUE ; } PContact contact = roster_get_contact ( jid ) ; if ( contact == NULL ) { cons_show ( "Contact not found in roster: %s" , jid ) ; return TRUE ; } const char * barejid = p_contact_barejid ( contact ) ; const char * oldnick = p_contact_name ( contact ) ; wins_change_nick ( barejid , oldnick , name ) ; roster_change_name ( contact , name ) ; GSList * groups = p_contact_groups ( contact ) ; roster_send_name_change ( barejid , name , groups ) ; cons_show ( "Nickname for %s set to: %s." , jid , name ) ; return TRUE ; } if ( strcmp ( args [ 0 ] , "clearnick" ) == 0 ) { if ( conn_status != JABBER_CONNECTED ) { cons_show ( "You are not currently connected." ) ; return TRUE ; } char * jid = args [ 1 ] ; if ( jid == NULL ) { cons_bad_cmd_usage ( command ) ; return TRUE ; } PContact contact = roster_get_contact ( jid ) ; if ( contact == NULL ) { cons_show ( "Contact not found in roster: %s" , jid ) ; return TRUE ; } const char * barejid = p_contact_barejid ( contact ) ; const char * oldnick = p_contact_name ( contact ) ; wins_remove_nick ( barejid , oldnick ) ; roster_change_name ( contact , NULL ) ; GSList * groups = p_contact_groups ( contact ) ; roster_send_name_change ( barejid , NULL , groups ) ; cons_show ( "Nickname for %s removed." , jid ) ; return TRUE ; } else { cons_bad_cmd_usage ( command ) ; return TRUE ; } } 