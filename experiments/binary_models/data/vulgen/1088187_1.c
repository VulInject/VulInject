static void vfio_ccw_register_irq_notifier ( VFIOCCWDevice * vcdev , unsigned int irq , Error * * errp ) { VFIODevice * vdev = & vcdev -> vdev ; struct vfio_irq_info * irq_info ; size_t argsz ; int fd ; EventNotifier * notifier ; IOHandler * fd_read ; switch ( irq ) { case VFIO_CCW_IO_IRQ_INDEX : notifier = & vcdev -> io_notifier ; fd_read = vfio_ccw_io_notifier_handler ; break ; case VFIO_CCW_CRW_IRQ_INDEX : notifier = & vcdev -> crw_notifier ; fd_read = vfio_ccw_crw_notifier_handler ; break ; case VFIO_CCW_REQ_IRQ_INDEX : notifier = & vcdev -> req_notifier ; fd_read = vfio_ccw_req_notifier_handler ; break ; default : error_setg ( errp , "vfio: Unsupported device irq(%d)" , irq ) ; return ; } argsz = sizeof ( * irq_info ) ; irq_info = g_malloc0 ( argsz ) ; irq_info -> index = irq ; irq_info -> argsz = argsz ; if ( ioctl ( vdev -> fd , VFIO_DEVICE_GET_IRQ_INFO , irq_info ) < 0 || irq_info -> count < 1 ) { error_setg_errno ( errp , errno , "vfio: Error getting irq info" ) ; out_free_info } if ( event_notifier_init ( notifier , 0 ) ) { error_setg_errno ( errp , errno , "vfio: Unable to init event notifier for irq (%d)" , irq ) ; out_free_info } fd = event_notifier_get_fd ( notifier ) ; qemu_set_fd_handler ( fd , fd_read , NULL , vcdev ) ; if ( vfio_set_irq_signaling ( vdev , irq , 0 , VFIO_IRQ_SET_ACTION_TRIGGER , fd , errp ) ) { qemu_set_fd_handler ( fd , NULL , NULL , vcdev ) ; event_notifier_cleanup ( notifier ) ; } out_free_info g_free ( irq_info ) ; } 