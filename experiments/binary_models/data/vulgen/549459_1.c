static void mlx5_fc_pool_release_counter ( struct mlx5_fc_pool * fc_pool , struct mlx5_fc * fc ) { struct mlx5_core_dev * dev = fc_pool -> dev ; struct mlx5_fc_bulk * bulk = fc -> bulk ; int bulk_free_fcs_amount ; mutex_lock ( & fc_pool -> pool_lock ) ; if ( mlx5_fc_bulk_release_fc ( bulk , fc ) ) { mlx5_core_warn ( dev , "Attempted to release a counter which is not acquired\n" ) ; unlock } fc_pool -> available_fcs ++ ; fc_pool -> used_fcs -- ; bulk_free_fcs_amount = mlx5_fc_bulk_get_free_fcs_amount ( bulk ) ; if ( bulk_free_fcs_amount == 1 ) { list_move_tail ( & bulk -> pool_list , & fc_pool -> partially_used ) ; } if ( bulk_free_fcs_amount == bulk -> bulk_len ) { list_del ( & bulk -> pool_list ) ; else { list_add ( & bulk -> pool_list , & fc_pool -> unused ) ; } } unlock mutex_unlock ( & fc_pool -> pool_lock ) ; } 