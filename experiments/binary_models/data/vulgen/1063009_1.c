help_index_t * helpLoadIndex ( const char * hifile , const char * directory ) { help_index_t * hi ; cups_file_t * fp ; char line [ 2048 ] , * ptr , * filename , * anchor , * sectptr , section [ 1024 ] , * text ; time_t mtime ; off_t offset ; size_t length ; int update ; help_node_t * node ; help_word_t * word ; if ( ( hi = ( help_index_t * ) calloc ( 1 , sizeof ( help_index_t ) ) ) == NULL ) { return ( NULL ) ; } hi -> nodes = cupsArrayNew ( ( cups_array_func_t ) help_sort_by_name , NULL ) ; hi -> sorted = cupsArrayNew ( ( cups_array_func_t ) help_sort_by_score , NULL ) ; if ( ! hi -> nodes || ! hi -> sorted ) { cupsArrayDelete ( hi -> nodes ) ; cupsArrayDelete ( hi -> sorted ) ; return ( NULL ) ; } if ( ( fp = cupsFileOpen ( hifile , "r" ) ) != NULL ) { cupsFileLock ( fp , 1 ) ; if ( cupsFileGets ( fp , line , sizeof ( line ) ) && ! strcmp ( line , "HELPV2" ) ) { node = NULL ; while ( cupsFileGets ( fp , line , sizeof ( line ) ) ) { if ( line [ 0 ] == ' ' ) { if ( ! node || ( ptr = strrchr ( line , ' ' ) ) == NULL ) { continue ; } if ( ( word = help_add_word ( node , ptr + 1 ) ) != NULL ) { word -> count = atoi ( line + 1 ) ; } } else { filename = line ; if ( ( ptr = strchr ( line , ' ' ) ) == NULL ) { break ; } while ( isspace ( * ptr & 255 ) ) { * ptr ++ = '\0' ; } if ( ( anchor = strrchr ( filename , '#' ) ) != NULL ) { * anchor ++ = '\0' ; mtime = 0 ; } else { mtime = strtol ( ptr , & ptr , 10 ) ; } offset = strtoll ( ptr , & ptr , 10 ) ; length = ( size_t ) strtoll ( ptr , & ptr , 10 ) ; while ( isspace ( * ptr & 255 ) ) { ptr ++ ; } if ( ! anchor ) { if ( * ptr != '\"' ) { break ; } ptr ++ ; sectptr = ptr ; while ( * ptr && * ptr != '\"' ) { ptr ++ ; } if ( * ptr != '\"' ) { break ; } * ptr ++ = '\0' ; strlcpy ( section , sectptr , sizeof ( section ) ) ; while ( isspace ( * ptr & 255 ) ) { ptr ++ ; } } else { section [ 0 ] = '\0' ; } if ( * ptr != '\"' ) { break ; } ptr ++ ; text = ptr ; while ( * ptr && * ptr != '\"' ) { ptr ++ ; } if ( * ptr != '\"' ) { break ; } * ptr ++ = '\0' ; if ( ( node = help_new_node ( filename , anchor , section , text , mtime , offset , length ) ) == NULL ) { break ; } node -> score = - 1 ; cupsArrayAdd ( hi -> nodes , node ) ; } } } cupsFileClose ( fp ) ; } update = help_load_directory ( hi , directory , NULL ) ; for ( node = ( help_node_t * ) cupsArrayFirst ( hi -> nodes ) ; node ; node = ( help_node_t * ) cupsArrayNext ( hi -> nodes ) ) { if ( node -> score < 0 ) { cupsArrayRemove ( hi -> nodes , node ) ; help_delete_node ( node ) ; } } for ( node = ( help_node_t * ) cupsArrayFirst ( hi -> nodes ) ; node ; node = ( help_node_t * ) cupsArrayNext ( hi -> nodes ) ) { cupsArrayAdd ( hi -> sorted , node ) ; } if ( update ) { helpSaveIndex ( hi , hifile ) ; } return ( hi ) ; } 