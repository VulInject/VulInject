static bool bsg_prepare_job ( struct device * dev , struct request * req ) { struct bsg_job * job = blk_mq_rq_to_pdu ( req ) ; int ret ; job -> timeout = req -> timeout ; if ( job -> bidi_rq ) { ret = bsg_map_buffer ( & job -> reply_payload , job -> bidi_rq ) ; if ( ret ) { failjob_rls_rqst_payload } } job -> dev = dev ; get_device ( job -> dev ) ; kref_init ( & job -> kref ) ; return true ; failjob_rls_rqst_payload kfree ( job -> request_payload . sg_list ) ; failjob_rls_job job -> result = - ENOMEM ; return false ; } 