static inline void steal_tags ( struct percpu_ida * pool , struct percpu_ida_cpu * tags ) { unsigned cpus_have_tags , cpu = pool -> cpu_last_stolen ; struct percpu_ida_cpu * remote ; for ( cpus_have_tags = cpumask_weight ( & pool -> cpus_have_tags ) ; cpus_have_tags ; cpus_have_tags -- ) { cpu = cpumask_next ( cpu , & pool -> cpus_have_tags ) ; if ( cpu >= nr_cpu_ids ) { cpu = cpumask_first ( & pool -> cpus_have_tags ) ; if ( cpu >= nr_cpu_ids ) { BUG ( ) ; } } pool -> cpu_last_stolen = cpu ; remote = per_cpu_ptr ( pool -> tag_cpu , cpu ) ; cpumask_clear_cpu ( cpu , & pool -> cpus_have_tags ) ; spin_lock ( & remote -> lock ) ; if ( remote -> nr_free ) { memcpy ( tags -> freelist , remote -> freelist , sizeof ( unsigned ) * remote -> nr_free ) ; tags -> nr_free = remote -> nr_free ; remote -> nr_free = 0 ; } spin_unlock ( & remote -> lock ) ; if ( tags -> nr_free ) { break ; } } } 