static int mcp795_set_time ( struct device * dev , struct rtc_time * tim ) { int ret ; u8 data [ 7 ] ; bool extosc ; ret = mcp795_stop_oscillator ( dev , & extosc ) ; if ( ret ) { return ret ; } ret = mcp795_rtcc_read ( dev , MCP795_REG_SECONDS , data , sizeof ( data ) ) ; if ( ret ) { return ret ; } data [ 0 ] = ( data [ 0 ] & 0x80 ) | bin2bcd ( tim -> tm_sec ) ; data [ 1 ] = ( data [ 1 ] & 0x80 ) | bin2bcd ( tim -> tm_min ) ; data [ 2 ] = bin2bcd ( tim -> tm_hour ) ; data [ 3 ] = ( data [ 3 ] & 0xF8 ) | bin2bcd ( tim -> tm_wday + 1 ) ; data [ 4 ] = bin2bcd ( tim -> tm_mday ) ; data [ 5 ] = ( data [ 5 ] & MCP795_LP_BIT ) | bin2bcd ( tim -> tm_mon + 1 ) ; if ( tim -> tm_year > 100 ) { tim -> tm_year -= 100 ; } data [ 6 ] = bin2bcd ( tim -> tm_year ) ; ret = mcp795_rtcc_write ( dev , MCP795_REG_SECONDS , data , 5 ) ; if ( ret ) { return ret ; } if ( ret ) { return ret ; } ret = mcp795_start_oscillator ( dev , extosc ?& extosc : NULL ) ; if ( ret ) { return ret ; } dev_dbg ( dev , "Set mcp795: %04d-%02d-%02d(%d) %02d:%02d:%02d\n" , tim -> tm_year + 1900 , tim -> tm_mon , tim -> tm_mday , tim -> tm_wday , tim -> tm_hour , tim -> tm_min , tim -> tm_sec ) ; return 0 ; } 