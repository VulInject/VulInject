static virDomainControllerDef * qemuDomainFindOrCreateSCSIDiskController ( virDomainObj * vm , int controller ) { size_t i ; qemuDomainObjPrivate * priv = vm -> privateData ; int model = - 1 ; for ( i = 0 ; i < vm -> def -> ncontrollers ; i ++ ) { cont = vm -> def -> controllers [ i ] ; if ( cont -> type != VIR_DOMAIN_CONTROLLER_TYPE_SCSI ) { continue ; } if ( cont -> idx == controller ) { return cont ; } model = cont -> model ; } cont = g_new0 ( virDomainControllerDef , 1 ) ; cont -> type = VIR_DOMAIN_CONTROLLER_TYPE_SCSI ; cont -> idx = controller ; if ( model == VIR_DOMAIN_CONTROLLER_MODEL_SCSI_DEFAULT ) { cont -> model = qemuDomainGetSCSIControllerModel ( vm -> def , cont , priv -> qemuCaps ) ; } else { cont -> model = model ; } VIR_INFO ( "No SCSI controller present, hotplugging one model=%s" , virDomainControllerModelSCSITypeToString ( cont -> model ) ) ; if ( qemuDomainAttachControllerDevice ( vm , cont ) < 0 ) { VIR_FREE ( cont ) ; return NULL ; } if ( ! virDomainObjIsActive ( vm ) ) { virReportError ( VIR_ERR_INTERNAL_ERROR , "%s" , _ ( "guest unexpectedly quit" ) ) ; return NULL ; } return cont ; } 