void rdsv3_ib_remove_one ( struct ib_device * device ) { struct rdsv3_ib_device * rds_ibdev ; struct rdsv3_ib_ipaddr * i_ipaddr , * i_next ; RDSV3_DPRINTF2 ( "rdsv3_ib_remove_one" , "device: %p" , device ) ; rds_ibdev = ib_get_client_data ( device , & rdsv3_ib_client ) ; if ( ! rds_ibdev ) { return ; } RDSV3_FOR_EACH_LIST_NODE_SAFE ( , , , ) { list_remove_node ( & i_ipaddr -> list ) ; kmem_free ( i_ipaddr , sizeof ( * i_ipaddr ) ) ; } rdsv3_ib_destroy_conns ( rds_ibdev ) ; if ( rds_ibdev -> fmr_soft_cq ) { rdsv3_af_thr_destroy ( rds_ibdev -> fmr_soft_cq ) ; } if ( rds_ibdev -> inc_soft_cq ) { rdsv3_af_thr_destroy ( rds_ibdev -> inc_soft_cq ) ; } rdsv3_ib_destroy_mr_pool ( rds_ibdev ) ; rdsv3_ib_destroy_inc_pool ( rds_ibdev ) ; rdsv3_af_grp_destroy ( rds_ibdev -> aft_hcagp ) ; while ( ib_dealloc_pd ( rds_ibdev -> pd ) ) { RDSV3_DPRINTF5 ( "rdsv3_ib_remove_one" , "%s-%d Failed to dealloc pd %p" , __func__ , __LINE__ , rds_ibdev -> pd ) ; delay ( drv_usectohz ( 1000 ) ) ; } if ( ib_dealloc_pd ( rds_ibdev -> pd ) ) { RDSV3_DPRINTF2 ( "rdsv3_ib_remove_one" , "Failed to dealloc pd %p\n" , rds_ibdev -> pd ) ; } list_destroy ( & rds_ibdev -> ipaddr_list ) ; list_destroy ( & rds_ibdev -> conn_list ) ; list_remove_node ( & rds_ibdev -> list ) ; mutex_destroy ( & rds_ibdev -> spinlock ) ; rw_destroy ( & rds_ibdev -> rwlock ) ; kmem_free ( rds_ibdev , sizeof ( * rds_ibdev ) ) ; RDSV3_DPRINTF2 ( "rdsv3_ib_remove_one" , "Return: device: %p" , device ) ; } struct ib_client rdsv3_ib_client = { . name = "rdsv3_ib" . add = rdsv3_ib_add_one . remove = rdsv3_ib_remove_one . clnt_hdl = NULL . state = IB_CLNT_UNINITIALIZED } ; 