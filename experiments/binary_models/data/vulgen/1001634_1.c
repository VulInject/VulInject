static int alauda_init_media ( struct us_data * us ) { unsigned char * data = us -> iobuf ; int ready = 0 ; struct alauda_card_info * media_info ; unsigned int num_zones ; while ( ready == 0 ) { msleep ( 20 ) ; if ( alauda_get_media_status ( us , data ) != USB_STOR_XFER_GOOD ) { return USB_STOR_TRANSPORT_ERROR ; } if ( data [ 0 ] & 0x10 ) { ready = 1 ; } } usb_stor_dbg ( us , "We are ready for action!\n" ) ; if ( alauda_ack_media ( us ) != USB_STOR_XFER_GOOD ) { return USB_STOR_TRANSPORT_ERROR ; } msleep ( 10 ) ; if ( alauda_get_media_status ( us , data ) != USB_STOR_XFER_GOOD ) { return USB_STOR_TRANSPORT_ERROR ; } if ( data [ 0 ] != 0x14 ) { usb_stor_dbg ( us , "Media not ready after ack\n" ) ; return USB_STOR_TRANSPORT_ERROR ; } if ( alauda_get_media_signature ( us , data ) != USB_STOR_XFER_GOOD ) { return USB_STOR_TRANSPORT_ERROR ; } usb_stor_dbg ( us , "Media signature: %4ph\n" , data ) ; media_info = alauda_card_find_id ( data [ 1 ] ) ; MEDIA_INFO ( us ) . capacity = 1 << media_info -> chipshift ; usb_stor_dbg ( us , "Found media with capacity: %ldMB\n" , MEDIA_INFO ( us ) . capacity >> 20 ) ; MEDIA_INFO ( us ) . pageshift = media_info -> pageshift ; MEDIA_INFO ( us ) . blockshift = media_info -> blockshift ; MEDIA_INFO ( us ) . zoneshift = media_info -> zoneshift ; MEDIA_INFO ( us ) . pagesize = 1 << media_info -> pageshift ; MEDIA_INFO ( us ) . blocksize = 1 << media_info -> blockshift ; MEDIA_INFO ( us ) . zonesize = 1 << media_info -> zoneshift ; MEDIA_INFO ( us ) . uzonesize = ( ( 1 << media_info -> zoneshift ) / 128 ) * 125 ; MEDIA_INFO ( us ) . blockmask = MEDIA_INFO ( us ) . blocksize - 1 ; num_zones = MEDIA_INFO ( us ) . capacity >> ( MEDIA_INFO ( us ) . zoneshift + MEDIA_INFO ( us ) . blockshift + MEDIA_INFO ( us ) . pageshift ) ; MEDIA_INFO ( us ) . pba_to_lba = kcalloc ( num_zones , sizeof ( u16 * ) , GFP_NOIO ) ; MEDIA_INFO ( us ) . lba_to_pba = kcalloc ( num_zones , sizeof ( u16 * ) , GFP_NOIO ) ; if ( alauda_reset_media ( us ) != USB_STOR_XFER_GOOD ) { return USB_STOR_TRANSPORT_ERROR ; } return USB_STOR_TRANSPORT_GOOD ; } 