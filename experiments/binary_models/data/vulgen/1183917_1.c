void s1394_CSR_topology_map_update ( s1394_hal_t * hal ) { s1394_selfid_pkt_t * selfid_packet ; uint32_t * tm_ptr ; uint32_t * data_ptr ; uint32_t node_count ; uint32_t self_id_count ; uint_t CRC ; uint32_t length ; int i , j , c ; ASSERT ( MUTEX_HELD ( & hal -> topology_tree_mutex ) ) ; tm_ptr = ( uint32_t * ) hal -> CSR_topology_map ; data_ptr = ( uint32_t * ) & ( tm_ptr [ 3 ] ) ; c = 0 ; for ( i = 0 ; i < hal -> number_of_nodes ; i ++ ) { j = - 1 ; selfid_packet = hal -> selfid_ptrs [ i ] ; { j ++ ; data_ptr [ c ++ ] = selfid_packet [ j ] . spkt_data ; } IEEE1394_SELFID_ISMORE ( & selfid_packet [ j ] ) ; } tm_ptr [ 1 ] = tm_ptr [ 1 ] + 1 ; node_count = ( i & IEEE1394_TOP_MAP_LEN_MASK ) ; self_id_count = ( c & IEEE1394_TOP_MAP_LEN_MASK ) ; length = self_id_count + 2 ; CRC = s1394_CRC16 ( & ( tm_ptr [ 1 ] ) , length ) ; tm_ptr [ 0 ] = ( length << IEEE1394_TOP_MAP_LEN_SHIFT ) | CRC ; } 