static bitstr_t * _build_numa_bitmap ( uint16_t mem_bind_type , char * mem_bind , uint16_t cpu_bind_type , char * cpu_bind , int task_cnt_on_node ) { bitstr_t * cpu_bitmap = NULL , * numa_bitmap = NULL ; char * tmp_str , * tok , * save_ptr = NULL ; int numa_id ; if ( mem_bind_type & MEM_BIND_NONE ) { } if ( ( mem_bind_type & MEM_BIND_RANK ) && ( task_cnt_on_node > 0 ) ) { numa_bitmap = bit_alloc ( MAX_NUMA_CNT ) ; if ( task_cnt_on_node >= MAX_NUMA_CNT ) { task_cnt_on_node = MAX_NUMA_CNT ; } for ( numa_id = 0 ; numa_id < task_cnt_on_node ; numa_id ++ ) { bit_set ( numa_bitmap , numa_id ) ; } } if ( mem_bind_type & MEM_BIND_MAP ) { numa_bitmap = bit_alloc ( MAX_NUMA_CNT ) ; tmp_str = xstrdup ( mem_bind ) ; tok = strtok_r ( tmp_str , "," , & save_ptr ) ; while ( tok ) { if ( ! xstrncmp ( tok , "0x" , 2 ) ) { numa_id = strtoul ( tok + 2 , NULL , 16 ) ; } else { numa_id = strtoul ( tok , NULL , 10 ) ; } if ( numa_id < MAX_NUMA_CNT ) { bit_set ( numa_bitmap , numa_id ) ; } tok = strtok_r ( NULL , "," , & save_ptr ) ; } } if ( mem_bind_type & MEM_BIND_MASK ) { numa_bitmap = bit_alloc ( MAX_NUMA_CNT ) ; tmp_str = xstrdup ( mem_bind ) ; tok = strtok_r ( tmp_str , "," , & save_ptr ) ; while ( tok ) { if ( ! xstrncmp ( tok , "0x" , 2 ) ) { tok += 2 ; } ( void ) _str_to_memset ( numa_bitmap , tok ) ; tok = strtok_r ( NULL , "," , & save_ptr ) ; } xfree ( tmp_str ) ; } if ( mem_bind_type & MEM_BIND_LOCAL ) { cpu_bitmap = _build_cpu_bitmap ( cpu_bind_type , cpu_bind , task_cnt_on_node ) ; if ( cpu_bitmap ) { numa_bitmap = _xlate_cpu_to_numa_bitmap ( cpu_bitmap ) ; FREE_NULL_BITMAP ( cpu_bitmap ) ; } } return numa_bitmap ; } 