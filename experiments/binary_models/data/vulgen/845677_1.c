static int storageVolResize ( virStorageVolPtr vol , unsigned long long capacity , unsigned int flags ) { virStorageBackend * backend ; virStoragePoolObj * obj = NULL ; virStoragePoolDef * def ; virStorageVolDef * voldef = NULL ; unsigned long long abs_capacity , delta = 0 ; int ret = - 1 ; virCheckFlags ( VIR_STORAGE_VOL_RESIZE_ALLOCATE | VIR_STORAGE_VOL_RESIZE_DELTA | VIR_STORAGE_VOL_RESIZE_SHRINK , - 1 ) ; if ( ! ( voldef = virStorageVolDefFromVol ( vol , & obj , & backend ) ) ) { return - 1 ; } def = virStoragePoolObjGetDef ( obj ) ; if ( virStorageVolResizeEnsureACL ( vol -> conn , def , voldef ) < 0 ) { cleanup } if ( voldef -> in_use ) { virReportError ( VIR_ERR_OPERATION_INVALID , _ ( "volume '%s' is still in use." ) , voldef -> name ) ; cleanup } if ( voldef -> building ) { virReportError ( VIR_ERR_OPERATION_INVALID , _ ( "volume '%s' is still being allocated." ) , voldef -> name ) ; cleanup } if ( flags & VIR_STORAGE_VOL_RESIZE_DELTA ) { if ( flags & VIR_STORAGE_VOL_RESIZE_SHRINK ) { abs_capacity = voldef -> target . capacity - MIN ( capacity , voldef -> target . capacity ) ; } else { abs_capacity = voldef -> target . capacity + capacity ; } flags &= ~ VIR_STORAGE_VOL_RESIZE_DELTA ; } else { abs_capacity = capacity ; } if ( abs_capacity < voldef -> target . allocation ) { virReportError ( VIR_ERR_INVALID_ARG , "%s" , _ ( "can't shrink capacity below " "existing allocation" ) ) ; cleanup } if ( abs_capacity < voldef -> target . capacity && ! ( flags & VIR_STORAGE_VOL_RESIZE_SHRINK ) ) { virReportError ( VIR_ERR_INVALID_ARG , "%s" , _ ( "Can't shrink capacity below current " "capacity unless shrink flag explicitly specified" ) ) ; cleanup } if ( flags & VIR_STORAGE_VOL_RESIZE_ALLOCATE ) { delta = abs_capacity - voldef -> target . allocation ; } if ( delta > def -> available ) { virReportError ( VIR_ERR_OPERATION_FAILED , "%s" , _ ( "Not enough space left in storage pool" ) ) ; cleanup } if ( ! backend -> resizeVol ) { virReportError ( VIR_ERR_NO_SUPPORT , "%s" , _ ( "storage pool does not support changing of " "volume capacity" ) ) ; cleanup } if ( backend -> resizeVol ( obj , voldef , abs_capacity , flags ) < 0 ) { cleanup } voldef -> target . capacity = abs_capacity ; ret = 0 ; cleanup virStoragePoolObjEndAPI ( & obj ) ; return ret ; } 