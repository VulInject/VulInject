static int __init ppc4xx_add_gpiochips ( void ) { struct device_node * np ; for_each_compatible_node ( , , "ibm,ppc4xx-gpio" ) { int ret ; struct ppc4xx_gpio_chip * ppc4xx_gc ; struct of_mm_gpio_chip * mm_gc ; struct gpio_chip * gc ; ppc4xx_gc = kzalloc ( sizeof ( * ppc4xx_gc ) , GFP_KERNEL ) ; if ( ! ppc4xx_gc ) { ret = - ENOMEM ; err } mm_gc = & ppc4xx_gc -> mm_gc ; gc = & mm_gc -> gc ; gc -> ngpio = 32 ; gc -> direction_input = ppc4xx_gpio_dir_in ; gc -> direction_output = ppc4xx_gpio_dir_out ; gc -> get = ppc4xx_gpio_get ; gc -> set = ppc4xx_gpio_set ; ret = of_mm_gpiochip_add_data ( np , mm_gc , ppc4xx_gc ) ; if ( ret ) { err } continue ; err pr_err ( "%pOF: registration failed with status %d\n" , np , ret ) ; kfree ( ppc4xx_gc ) ; } return 0 ; } 