int register_lines ( struct line_driver * line_driver , const struct tty_operations * ops , struct line * lines , int nlines ) { struct tty_driver * driver = alloc_tty_driver ( nlines ) ; int err ; int i ; if ( ! driver ) { return - ENOMEM ; } driver -> driver_name = line_driver -> name ; driver -> name = line_driver -> device_name ; driver -> major = line_driver -> major ; driver -> minor_start = line_driver -> minor_start ; driver -> type = line_driver -> type ; driver -> subtype = line_driver -> subtype ; driver -> flags = TTY_DRIVER_REAL_RAW | TTY_DRIVER_DYNAMIC_DEV ; driver -> init_termios = tty_std_termios ; for ( i = 0 ; i < nlines ; i ++ ) { tty_port_init ( & lines [ i ] . port ) ; lines [ i ] . port . ops = & line_port_ops ; spin_lock_init ( & lines [ i ] . lock ) ; lines [ i ] . driver = line_driver ; INIT_LIST_HEAD ( & lines [ i ] . chan_list ) ; } tty_set_operations ( driver , ops ) ; err = tty_register_driver ( driver ) ; if ( err ) { printk ( KERN_ERR "register_lines : can't register %s driver\n" , line_driver -> name ) ; for ( i = 0 ; i < nlines ; i ++ ) { tty_port_destroy ( & lines [ i ] . port ) ; } return err ; } line_driver -> driver = driver ; mconsole_register_dev ( & line_driver -> mc ) ; return 0 ; } 