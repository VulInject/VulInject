void ad1848_attach ( struct ad1848_softc * sc ) { int i ; struct ad1848_volume vol_mid = { 220 220 } ; struct ad1848_volume vol_0 = { 0 0 } ; struct audio_params pparams , rparams ; int timeout ; sc -> sc_playrun = 0 ; sc -> sc_recrun = 0 ; if ( sc -> sc_drq != - 1 ) { if ( isa_dmamap_create ( sc -> sc_isa , sc -> sc_drq , MAX_ISADMA , BUS_DMA_NOWAIT | BUS_DMA_ALLOCNOW ) ) { printf ( "ad1848_attach: can't create map for drq %d\n" , sc -> sc_drq ) ; return ; } } if ( sc -> sc_recdrq != - 1 && sc -> sc_recdrq != sc -> sc_drq ) { if ( isa_dmamap_create ( sc -> sc_isa , sc -> sc_recdrq , MAX_ISADMA , BUS_DMA_NOWAIT | BUS_DMA_ALLOCNOW ) ) { printf ( "ad1848_attach: can't create map for second drq %d\n" , sc -> sc_recdrq ) ; return ; } } for ( i = 0 ; i < 0x10 ; i ++ ) { ad_write ( sc , i , ad1848_init_values [ i ] ) ; timeout = AD1848_TIMO ; while ( timeout > 0 && ADREAD ( sc , AD1848_IADDR ) & SP_IN_INIT ) { timeout -- ; } } if ( ( sc -> mode == 2 ) && ( ( sc -> sc_recdrq == - 1 ) || ( sc -> sc_recdrq == sc -> sc_drq ) ) ) { ad_write ( sc , SP_MISC_INFO , ad_read ( sc , SP_MISC_INFO ) & ~ MODE2 ) ; } if ( sc -> mode == 2 ) { ad_write ( sc , SP_INTERFACE_CONFIG , 0 ) ; for ( i = 0x10 ; i < 0x20 ; i ++ ) { if ( ad1848_init_values [ i ] != 0 ) { ad_write ( sc , i , ad1848_init_values [ i ] ) ; timeout = AD1848_TIMO ; while ( timeout > 0 && ADREAD ( sc , AD1848_IADDR ) & SP_IN_INIT ) { timeout -- ; } } } } ad1848_reset ( sc ) ; pparams = ad1848_audio_default ; rparams = ad1848_audio_default ; ( void ) ad1848_set_params ( sc , AUMODE_RECORD | AUMODE_PLAY , 0 , & pparams , & rparams ) ; ( void ) ad1848_set_rec_gain ( sc , & vol_mid ) ; ( void ) ad1848_set_channel_gain ( sc , AD1848_DAC_CHANNEL , & vol_mid ) ; ( void ) ad1848_set_channel_gain ( sc , AD1848_MONITOR_CHANNEL , & vol_0 ) ; ( void ) ad1848_set_channel_gain ( sc , AD1848_AUX1_CHANNEL , & vol_mid ) ; if ( sc -> mode == 2 ) { ( void ) ad1848_set_channel_gain ( sc , AD1848_AUX2_CHANNEL , & vol_mid ) ; ( void ) ad1848_set_channel_gain ( sc , AD1848_LINE_CHANNEL , & vol_mid ) ; ( void ) ad1848_set_channel_gain ( sc , AD1848_MONO_CHANNEL , & vol_0 ) ; sc -> mute [ AD1848_MONO_CHANNEL ] = MUTE_ALL ; } else { ( void ) ad1848_set_channel_gain ( sc , AD1848_AUX2_CHANNEL , & vol_0 ) ; } ( void ) ad1848_set_rec_port ( sc , MIC_IN_PORT ) ; if ( sc -> chip_name ) { printf ( ": %s" , sc -> chip_name ) ; } } 