static int stm32_adc_selfcalib ( struct udevice * dev ) { struct stm32_adc * adc = dev_get_priv ( dev ) ; int ret ; u32 val ; clrbits_le32 ( adc -> regs + STM32H7_ADC_CR , STM32H7_ADCALDIF | STM32H7_ADCALLIN ) ; setbits_le32 ( adc -> regs + STM32H7_ADC_CR , STM32H7_ADCAL ) ; ret = readl_poll_sleep_timeout ( adc -> regs + STM32H7_ADC_CR , val , ! ( val & STM32H7_ADCAL ) , 100 , STM32H7_ADC_CALIB_TIMEOUT_US ) ; setbits_le32 ( adc -> regs + STM32H7_ADC_CR , STM32H7_ADCALDIF | STM32H7_ADCALLIN ) ; setbits_le32 ( adc -> regs + STM32H7_ADC_CR , STM32H7_ADCAL ) ; ret = readl_poll_sleep_timeout ( adc -> regs + STM32H7_ADC_CR , val , ! ( val & STM32H7_ADCAL ) , 100 , STM32H7_ADC_CALIB_TIMEOUT_US ) ; if ( ret ) { dev_err ( dev , "calibration failed\n" ) ; } out clrbits_le32 ( adc -> regs + STM32H7_ADC_CR , STM32H7_ADCALDIF | STM32H7_ADCALLIN ) ; return ret ; } 