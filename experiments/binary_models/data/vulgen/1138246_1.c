config_file_new_option ( , , , , , , , , , , , , , , , , , , , ) { struct t_config_option * new_option ; int var_type , int_value , argc , i , index_value ; long number ; char * error , * pos , * option_name , * parent_name ; new_option = NULL ; option_name = NULL ; parent_name = NULL ; if ( ! name || ! type ) { error } pos = strstr ( name , "<<" ) ; if ( pos ) { parent_name = strdup ( pos + 4 ) ; } else { option_name = strdup ( name ) ; } if ( config_file && section && config_file_search_option ( config_file , section , option_name ) ) { error } var_type = - 1 ; for ( i = 0 ; i < CONFIG_NUM_OPTION_TYPES ; i ++ ) { if ( strcmp ( type , config_option_type_string [ i ] ) == 0 ) { var_type = i ; break ; } } if ( var_type < 0 ) { gui_chat_printf ( NULL , "%sUnknown option type \"%s\"" , gui_chat_prefix [ GUI_CHAT_PREFIX_ERROR ] , type ) ; error } if ( ! null_value_allowed ) { if ( default_value && ! value ) { value = default_value ; } if ( ! default_value && value ) { default_value = value ; } if ( ! default_value || ! value ) { error } } new_option = config_file_option_malloc ( ) ; if ( new_option ) { new_option -> config_file = config_file ; new_option -> section = section ; new_option -> name = strdup ( option_name ) ; if ( ! new_option -> name ) { error } new_option -> parent_name = ( parent_name ) ?strdup ( parent_name ) : NULL ; new_option -> type = var_type ; if ( description ) { new_option -> description = strdup ( description ) ; if ( ! new_option -> description ) { error } } argc = 0 ; switch ( var_type ) { case CONFIG_OPTION_TYPE_BOOLEAN : new_option -> min = CONFIG_BOOLEAN_FALSE ; new_option -> max = CONFIG_BOOLEAN_TRUE ; if ( default_value ) { int_value = config_file_string_to_boolean ( default_value ) ; new_option -> default_value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> default_value ) { error } CONFIG_INTEGER_DEFAULT ( new_option ) = int_value ; } if ( value ) { int_value = config_file_string_to_boolean ( value ) ; new_option -> value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> value ) { error } CONFIG_INTEGER ( new_option ) = int_value ; } break ; case CONFIG_OPTION_TYPE_INTEGER : if ( string_values && string_values [ 0 ] ) { new_option -> string_values = string_split ( string_values , "|" , NULL , WEECHAT_STRING_SPLIT_STRIP_LEFT | WEECHAT_STRING_SPLIT_STRIP_RIGHT | WEECHAT_STRING_SPLIT_COLLAPSE_SEPS , 0 , & argc ) ; if ( ! new_option -> string_values ) { error } } if ( new_option -> string_values ) { new_option -> min = 0 ; new_option -> max = ( argc == 0 ) ?0 : argc - 1 ; if ( default_value ) { index_value = 0 ; for ( i = 0 ; i < argc ; i ++ ) { if ( strcmp ( new_option -> string_values [ i ] , default_value ) == 0 ) { index_value = i ; break ; } } new_option -> default_value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> default_value ) { error } CONFIG_INTEGER_DEFAULT ( new_option ) = index_value ; } if ( value ) { index_value = 0 ; for ( i = 0 ; i < argc ; i ++ ) { if ( strcmp ( new_option -> string_values [ i ] , value ) == 0 ) { index_value = i ; break ; } } new_option -> value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> value ) { error } CONFIG_INTEGER ( new_option ) = index_value ; } } else { new_option -> min = min ; new_option -> max = max ; if ( default_value ) { error = NULL ; number = strtol ( default_value , & error , 10 ) ; if ( ! error || error [ 0 ] ) { number = 0 ; } if ( number < min ) { number = min ; } if ( number > max ) { number = max ; } new_option -> default_value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> default_value ) { error } CONFIG_INTEGER_DEFAULT ( new_option ) = number ; } if ( value ) { error = NULL ; number = strtol ( value , & error , 10 ) ; if ( ! error || error [ 0 ] ) { number = 0 ; } if ( number < min ) { number = min ; } if ( number > max ) { number = max ; } new_option -> value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> value ) { error } CONFIG_INTEGER ( new_option ) = number ; } } break ; case CONFIG_OPTION_TYPE_STRING : new_option -> min = min ; new_option -> max = max ; if ( default_value ) { new_option -> default_value = strdup ( default_value ) ; if ( ! new_option -> default_value ) { error } } if ( value ) { new_option -> value = strdup ( value ) ; if ( ! new_option -> value ) { error } } break ; case CONFIG_OPTION_TYPE_COLOR : new_option -> min = min ; new_option -> max = gui_color_get_weechat_colors_number ( ) - 1 ; if ( default_value ) { new_option -> default_value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> default_value ) { error } if ( ! gui_color_assign ( new_option -> default_value , default_value ) ) { CONFIG_INTEGER_DEFAULT ( new_option ) = 0 ; } } if ( value ) { new_option -> value = malloc ( sizeof ( int ) ) ; if ( ! new_option -> value ) { error } if ( ! gui_color_assign ( new_option -> value , value ) ) { CONFIG_INTEGER ( new_option ) = 0 ; } } break ; case CONFIG_NUM_OPTION_TYPES : break ; } new_option -> null_value_allowed = null_value_allowed ; new_option -> callback_check_value = callback_check_value ; new_option -> callback_check_value_pointer = callback_check_value_pointer ; new_option -> callback_check_value_data = callback_check_value_data ; new_option -> callback_change = callback_change ; new_option -> callback_change_pointer = callback_change_pointer ; new_option -> callback_change_data = callback_change_data ; new_option -> callback_delete = callback_delete ; new_option -> callback_delete_pointer = callback_delete_pointer ; new_option -> callback_delete_data = callback_delete_data ; new_option -> loaded = 1 ; if ( section ) { config_file_option_insert_in_section ( new_option ) ; } else { new_option -> prev_option = NULL ; new_option -> next_option = NULL ; } if ( new_option -> config_file && new_option -> section ) { config_file_hook_config_exec ( new_option ) ; } } end error if ( new_option ) { config_file_option_free_data ( new_option ) ; free ( new_option ) ; new_option = NULL ; } end if ( option_name ) { free ( option_name ) ; } if ( parent_name ) { free ( parent_name ) ; } return new_option ; } 