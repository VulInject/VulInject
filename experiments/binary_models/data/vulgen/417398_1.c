void assemble_udp_ip_header ( struct interface_info * interface , unsigned char * buf , int * bufix , u_int32_t from , u_int32_t to , unsigned int port , unsigned char * data , int len ) { struct ip ip ; struct udphdr udp ; ip . ip_v = 4 ; ip . ip_hl = 5 ; ip . ip_tos = IPTOS_LOWDELAY ; ip . ip_len = htons ( sizeof ( ip ) + sizeof ( udp ) + len ) ; ip . ip_id = 0 ; ip . ip_off = 0 ; ip . ip_ttl = 16 ; ip . ip_p = IPPROTO_UDP ; ip . ip_sum = 0 ; ip . ip_src . s_addr = from ; ip . ip_dst . s_addr = to ; ip . ip_sum = wrapsum ( checksum ( ( unsigned char * ) & ip , sizeof ( ip ) , 0 ) ) ; memcpy ( & buf [ * bufix ] , & ip , sizeof ( ip ) ) ; * bufix += sizeof ( ip ) ; udp . uh_sport = server_port ; udp . uh_dport = port ; udp . uh_ulen = htons ( sizeof ( udp ) + len ) ; memset ( & udp . uh_sum , 0 , sizeof ( udp . uh_sum ) ) ; udp . uh_sum = wrapsum ( checksum ( ( unsigned char * ) & udp , sizeof ( udp ) , checksum ( data , len , checksum ( ( unsigned char * ) & ip . ip_src , 2 * sizeof ( ip . ip_src ) , IPPROTO_UDP + ( u_int32_t ) ntohs ( udp . uh_ulen ) ) ) ) ) ; * bufix += sizeof ( udp ) ; } 