static void mptsas_send_raid_event ( struct fw_event_work * fw_event ) { MPT_ADAPTER * ioc ; EVENT_DATA_RAID * raid_event_data ; struct mptsas_hotplug_event hot_plug_info ; int status ; int state ; struct scsi_device * sdev = NULL ; VirtDevice * vdevice = NULL ; RaidPhysDiskPage0_t phys_disk ; ioc = fw_event -> ioc ; raid_event_data = ( EVENT_DATA_RAID * ) fw_event -> event_data ; status = le32_to_cpu ( raid_event_data -> SettingsStatus ) ; state = ( status >> 8 ) & 0xff ; memset ( & hot_plug_info , 0 , sizeof ( mptsas_hotplug_event ) ) ; hot_plug_info . id = raid_event_data -> VolumeID ; hot_plug_info . channel = raid_event_data -> VolumeBus ; hot_plug_info . phys_disk_num = raid_event_data -> PhysDiskNum ; if ( raid_event_data -> ReasonCode == MPI_EVENT_RAID_RC_VOLUME_DELETED || raid_event_data -> ReasonCode == MPI_EVENT_RAID_RC_VOLUME_CREATED || raid_event_data -> ReasonCode == MPI_EVENT_RAID_RC_VOLUME_STATUS_CHANGED ) { sdev = scsi_device_lookup ( ioc -> sh , MPTSAS_RAID_CHANNEL , hot_plug_info . id , 0 ) ; hot_plug_info . sdev = sdev ; if ( sdev ) { vdevice = sdev -> hostdata ; } } devtprintk ( ioc , printk ( MYIOC_s_DEBUG_FMT "Entering %s: " "ReasonCode=%02x\n" , ioc -> name , __func__ , raid_event_data -> ReasonCode ) ) ; switch ( raid_event_data -> ReasonCode ) { case MPI_EVENT_RAID_RC_PHYSDISK_DELETED : hot_plug_info . event_type = MPTSAS_DEL_PHYSDISK_REPROBE ; break ; case MPI_EVENT_RAID_RC_PHYSDISK_CREATED : hot_plug_info . event_type = MPTSAS_ADD_PHYSDISK_REPROBE ; break ; case MPI_EVENT_RAID_RC_PHYSDISK_STATUS_CHANGED : switch ( state ) { case MPI_PD_STATE_ONLINE : case MPI_PD_STATE_NOT_COMPATIBLE : mpt_raid_phys_disk_pg0 ( ioc , raid_event_data -> PhysDiskNum , & phys_disk ) ; hot_plug_info . id = phys_disk . PhysDiskID ; hot_plug_info . channel = phys_disk . PhysDiskBus ; hot_plug_info . event_type = MPTSAS_ADD_PHYSDISK ; break ; case MPI_PD_STATE_FAILED : case MPI_PD_STATE_MISSING : case MPI_PD_STATE_OFFLINE_AT_HOST_REQUEST : case MPI_PD_STATE_FAILED_AT_HOST_REQUEST : case MPI_PD_STATE_OFFLINE_FOR_ANOTHER_REASON : hot_plug_info . event_type = MPTSAS_DEL_PHYSDISK ; break ; default : break ; } break ; case MPI_EVENT_RAID_RC_VOLUME_DELETED : if ( ! sdev ) { break ; } vdevice -> vtarget -> deleted = 1 ; hot_plug_info . event_type = MPTSAS_DEL_RAID ; break ; case MPI_EVENT_RAID_RC_VOLUME_CREATED : if ( sdev ) { scsi_device_put ( sdev ) ; break ; } hot_plug_info . event_type = MPTSAS_ADD_RAID ; break ; case MPI_EVENT_RAID_RC_VOLUME_STATUS_CHANGED : if ( ! ( status & MPI_RAIDVOL0_STATUS_FLAG_ENABLED ) ) { if ( ! sdev ) { break ; } vdevice -> vtarget -> deleted = 1 ; hot_plug_info . event_type = MPTSAS_DEL_RAID ; break ; } switch ( state ) { case MPI_RAIDVOL0_STATUS_STATE_FAILED : case MPI_RAIDVOL0_STATUS_STATE_MISSING : if ( ! sdev ) { break ; } vdevice -> vtarget -> deleted = 1 ; hot_plug_info . event_type = MPTSAS_DEL_RAID ; break ; case MPI_RAIDVOL0_STATUS_STATE_OPTIMAL : case MPI_RAIDVOL0_STATUS_STATE_DEGRADED : if ( sdev ) { scsi_device_put ( sdev ) ; break ; } hot_plug_info . event_type = MPTSAS_ADD_RAID ; break ; default : break ; } break ; default : break ; } else { mptsas_free_fw_event ( ioc , fw_event ) ; } } 