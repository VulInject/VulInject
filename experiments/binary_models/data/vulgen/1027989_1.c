static void w5500_txn ( struct mg_tcpip_spi * s , uint8_t block , uint16_t addr , bool wr , void * buf , size_t len ) { uint8_t * p = ( uint8_t * ) buf ; uint8_t cmd [ ] { ( uint8_t ) ( addr >> 8 ) ( uint8_t ) ( addr & 255 ) ( uint8_t ) ( ( block << 3 ) | ( wr ? 4 : 0 ) ) } ; ; s -> begin ( s -> spi ) ; for ( size_t i = 0 ; i < sizeof ( cmd ) ; i ++ ) { s -> txn ( s -> spi , cmd [ i ] ) ; } for ( size_t i = 0 ; i < len ; i ++ ) { uint8_t r = s -> txn ( s -> spi , p [ i ] ) ; } s -> end ( s -> spi ) ; } 