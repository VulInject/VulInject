static int do_spi_xfer ( int bus , int cs ) { struct spi_slave * slave ; int ret = 0 ; char name [ 30 ] , * str ; struct udevice * dev ; snprintf ( name , sizeof ( name ) , "generic_%d:%d" , bus , cs ) ; str = strdup ( name ) ; ret = _spi_get_bus_and_cs ( bus , cs , freq , mode , "spi_generic_drv" , str , & dev , & slave ) ; if ( ret ) { return ret ; } slave = spi_setup_slave ( bus , cs , freq , mode ) ; if ( ! slave ) { printf ( "Invalid device %d:%d\n" , bus , cs ) ; return - EINVAL ; } ret = spi_claim_bus ( slave ) ; if ( ret ) { done } ret = spi_xfer ( slave , bitlen , dout , din , SPI_XFER_BEGIN | SPI_XFER_END ) ; if ( ret ) { ret = - EIO ; } if ( ret ) { printf ( "Error %d during SPI transaction\n" , ret ) ; } else { int j ; for ( j = 0 ; j < ( ( bitlen + 7 ) / 8 ) ; j ++ ) { printf ( "%02X" , din [ j ] ) ; } printf ( "\n" ) ; } done spi_release_bus ( slave ) ; spi_free_slave ( slave ) ; return ret ; } 