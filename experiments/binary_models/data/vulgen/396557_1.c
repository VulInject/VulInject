static irqreturn_t icn8318_irq ( int irq , void * dev_id ) { struct icn8318_data * data = dev_id ; struct device * dev = & data -> client -> dev ; struct icn8318_touch_data touch_data ; int i , ret ; ret = icn8318_read_touch_data ( data -> client , & touch_data ) ; if ( ret < 0 ) { dev_err ( dev , "Error reading touch data: %d\n" , ret ) ; return IRQ_HANDLED ; } if ( touch_data . softbutton ) { return IRQ_HANDLED ; } if ( touch_data . touch_count > ICN8318_MAX_TOUCHES ) { dev_warn ( dev , "Too much touches %d>%d\n" , touch_data . touch_count , ICN8318_MAX_TOUCHES ) ; touch_data . touch_count = ICN8318_MAX_TOUCHES ; } for ( i = 0 ; i < touch_data . touch_count ; i ++ ) { struct icn8318_touch * touch = & touch_data . touches [ i ] ; bool act = icn8318_touch_active ( touch -> event ) ; input_mt_slot ( data -> input , touch -> slot ) ; input_mt_report_slot_state ( data -> input , MT_TOOL_FINGER , act ) ; if ( ! act ) { continue ; } } input_mt_sync_frame ( data -> input ) ; input_sync ( data -> input ) ; return IRQ_HANDLED ; } 