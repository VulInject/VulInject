static void ccdc_configure ( struct isp_ccdc_device * ccdc ) { struct isp_device * isp = to_isp_device ( ccdc ) ; struct isp_parallel_cfg * parcfg = NULL ; struct v4l2_subdev * sensor ; struct v4l2_mbus_framefmt * format ; const struct v4l2_rect * crop ; const struct isp_format_info * fmt_info ; struct v4l2_subdev_format fmt_src ; unsigned int depth_out ; unsigned int depth_in = 0 ; struct media_pad * pad ; unsigned long flags ; unsigned int bridge ; unsigned int shift ; unsigned int nph ; unsigned int sph ; u32 syn_mode ; u32 ccdc_pattern ; ccdc -> bt656 = false ; ccdc -> fields = 0 ; pad = media_pad_remote_pad_first ( & ccdc -> pads [ CCDC_PAD_SINK ] ) ; sensor = media_entity_to_v4l2_subdev ( pad -> entity ) ; if ( ccdc -> input == CCDC_INPUT_PARALLEL ) { struct v4l2_subdev * sd = to_isp_pipeline ( & ccdc -> subdev . entity ) -> external ; parcfg = & v4l2_subdev_to_bus_cfg ( sd ) -> bus . parallel ; ccdc -> bt656 = parcfg -> bt656 ; } format = & ccdc -> formats [ CCDC_PAD_SINK ] ; fmt_src . pad = pad -> index ; fmt_src . which = V4L2_SUBDEV_FORMAT_ACTIVE ; if ( ! v4l2_subdev_call ( sensor , pad , get_fmt , NULL , & fmt_src ) ) { fmt_info = omap3isp_video_format_info ( fmt_src . format . code ) ; depth_in = fmt_info -> width ; } fmt_info = omap3isp_video_format_info ( format -> code ) ; depth_out = fmt_info -> width ; shift = depth_in - depth_out ; if ( ccdc -> bt656 ) { bridge = ISPCTRL_PAR_BRIDGE_DISABLE ; } if ( fmt_info -> code == MEDIA_BUS_FMT_YUYV8_2X8 ) { bridge = ISPCTRL_PAR_BRIDGE_LENDIAN ; } if ( fmt_info -> code == MEDIA_BUS_FMT_UYVY8_2X8 ) { bridge = ISPCTRL_PAR_BRIDGE_BENDIAN ; } else { bridge = ISPCTRL_PAR_BRIDGE_DISABLE ; } omap3isp_configure_bridge ( isp , ccdc -> input , parcfg , shift , bridge ) ; ccdc_config_sync_if ( ccdc , parcfg , depth_out ) ; syn_mode = isp_reg_readl ( isp , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_SYN_MODE ) ; syn_mode &= ~ ISPCCDC_SYN_MODE_VP2SDR ; if ( ccdc -> output & CCDC_OUTPUT_MEMORY ) { syn_mode |= ISPCCDC_SYN_MODE_WEN ; } else { syn_mode &= ~ ISPCCDC_SYN_MODE_WEN ; } if ( ccdc -> output & CCDC_OUTPUT_RESIZER ) { syn_mode |= ISPCCDC_SYN_MODE_SDR2RSZ ; } else { syn_mode &= ~ ISPCCDC_SYN_MODE_SDR2RSZ ; } switch ( format -> code ) { case MEDIA_BUS_FMT_SRGGB10_1X10 : case MEDIA_BUS_FMT_SRGGB12_1X12 : ccdc_pattern = ccdc_srggb_pattern ; break ; case MEDIA_BUS_FMT_SBGGR10_1X10 : case MEDIA_BUS_FMT_SBGGR12_1X12 : ccdc_pattern = ccdc_sbggr_pattern ; break ; case MEDIA_BUS_FMT_SGBRG10_1X10 : case MEDIA_BUS_FMT_SGBRG12_1X12 : ccdc_pattern = ccdc_sgbrg_pattern ; break ; default : ccdc_pattern = ccdc_sgrbg_pattern ; break ; } ccdc_config_imgattr ( ccdc , ccdc_pattern ) ; isp_reg_writel ( isp , ( ( format -> height - 2 ) << ISPCCDC_VDINT_0_SHIFT ) | ( ( format -> height * 2 / 3 ) << ISPCCDC_VDINT_1_SHIFT ) , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_VDINT ) ; format = & ccdc -> formats [ CCDC_PAD_SOURCE_OF ] ; crop = & ccdc -> crop ; if ( ccdc -> bt656 ) { sph = crop -> left * 2 ; nph = crop -> width * 2 - 1 ; } else { sph = crop -> left ; nph = crop -> width - 1 ; } isp_reg_writel ( isp , ( sph << ISPCCDC_HORZ_INFO_SPH_SHIFT ) | ( nph << ISPCCDC_HORZ_INFO_NPH_SHIFT ) , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_HORZ_INFO ) ; isp_reg_writel ( isp , ( crop -> top << ISPCCDC_VERT_START_SLV0_SHIFT ) | ( crop -> top << ISPCCDC_VERT_START_SLV1_SHIFT ) , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_VERT_START ) ; isp_reg_writel ( isp , ( crop -> height - 1 ) << ISPCCDC_VERT_LINES_NLV_SHIFT , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_VERT_LINES ) ; ccdc_config_outlineoffset ( ccdc , ccdc -> video_out . bpl_value , format -> field ) ; if ( ccdc -> formats [ CCDC_PAD_SINK ] . field == V4L2_FIELD_ALTERNATE && ( format -> field == V4L2_FIELD_INTERLACED_TB || format -> field == V4L2_FIELD_INTERLACED_BT ) ) { syn_mode |= ISPCCDC_SYN_MODE_FLDMODE ; } if ( format -> code == MEDIA_BUS_FMT_YUYV8_1X16 ) { isp_reg_set ( isp , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_CFG , ISPCCDC_CFG_BSWD ) ; } else { isp_reg_clr ( isp , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_CFG , ISPCCDC_CFG_BSWD ) ; } if ( omap3isp_video_format_info ( format -> code ) -> width <= 8 || ccdc -> bt656 ) { syn_mode |= ISPCCDC_SYN_MODE_PACK8 ; } else { syn_mode &= ~ ISPCCDC_SYN_MODE_PACK8 ; } isp_reg_writel ( isp , syn_mode , OMAP3_ISP_IOMEM_CCDC , ISPCCDC_SYN_MODE ) ; ccdc_config_vp ( ccdc ) ; spin_lock_irqsave ( & ccdc -> lsc . req_lock , flags ) ; WARN_ON ( ccdc -> lsc . active ) ; if ( ccdc -> lsc . active == NULL && __ccdc_lsc_configure ( ccdc , ccdc -> lsc . request ) == 0 ) { ccdc -> lsc . active = ccdc -> lsc . request ; } else { list_add_tail ( & ccdc -> lsc . request -> list , & ccdc -> lsc . free_queue ) ; schedule_work ( & ccdc -> lsc . table_work ) ; } ccdc -> lsc . request = NULL ; unlock spin_unlock_irqrestore ( & ccdc -> lsc . req_lock , flags ) ; ccdc_apply_controls ( ccdc ) ; } 