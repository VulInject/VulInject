__dead void boot ( int howto ) { u_long wait_mask ; int i ; if ( ( howto & RB_RESET ) != 0 ) { doreset } if ( cold ) { if ( ( howto & RB_USERREQ ) == 0 ) { howto |= RB_HALT ; } haltsys } if ( ( boothowto & RB_HALT ) != 0 ) { howto |= RB_HALT ; } boothowto = howto ; if ( ( howto & RB_NOSYNC ) == 0 && waittime < 0 ) { waittime = 0 ; vfs_shutdown ( curproc ) ; if ( ( howto & RB_TIMEBAD ) == 0 ) { resettodr ( ) ; } else { printf ( "WARNING: not updating battery clock\n" ) ; } } if_downall ( ) ; uvm_shutdown ( ) ; splhigh ( ) ; cold = 1 ; wait_mask = ( 1UL << hwrpb -> rpb_primary_cpu_id ) ; alpha_broadcast_ipi ( ALPHA_IPI_HALT ) ; cpus_paused = 0 ; for ( i = 0 ; i < 10000 ; i ++ ) { alpha_mb ( ) ; if ( cpus_running == wait_mask ) { break ; } delay ( 1000 ) ; } alpha_mb ( ) ; if ( cpus_running != wait_mask ) { printf ( "WARNING: Unable to halt secondary CPUs (0x%lx)\n" , cpus_running ) ; } haltsys config_suspend_all ( DVACT_POWERDOWN ) ; printf ( "hit any key to %s...\n" , ( howto & RB_HALT ) != 0 ?"halt" : "reboot" ) ; cnpollc ( 1 ) ; cngetc ( ) ; cnpollc ( 0 ) ; printf ( "\n" ) ; if ( ( howto & RB_POWERDOWN ) != 0 && platform . powerdown != NULL ) { * platform . powerdown ( ) ; printf ( "WARNING: powerdown failed!\n" ) ; } doreset printf ( "%s\n\n" , ( howto & RB_HALT ) != 0 ?"halted." : "rebooting..." ) ; prom_halt ( ( howto & RB_HALT ) != 0 ) ; for ( ; ; ) { continue ; } } 