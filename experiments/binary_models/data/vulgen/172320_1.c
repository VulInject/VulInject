static int __init pnv_parse_cpuidle_dt ( void ) { struct device_node * np ; int nr_idle_states , i ; int rc = 0 ; u32 * temp_u32 ; u64 * temp_u64 ; const char * * temp_string ; np = of_find_node_by_path ( "/ibm,opal/power-mgt" ) ; if ( ! np ) { pr_warn ( "opal: PowerMgmt Node not found\n" ) ; return - ENODEV ; } nr_idle_states = of_property_count_u32_elems ( np , "ibm,cpu-idle-state-flags" ) ; pnv_idle_states = kcalloc ( nr_idle_states , sizeof ( * pnv_idle_states ) , GFP_KERNEL ) ; temp_u32 = kcalloc ( nr_idle_states , sizeof ( u32 ) , GFP_KERNEL ) ; temp_u64 = kcalloc ( nr_idle_states , sizeof ( u64 ) , GFP_KERNEL ) ; temp_string = kcalloc ( nr_idle_states , sizeof ( char * ) , GFP_KERNEL ) ; if ( ! ( pnv_idle_states && temp_u32 && temp_u64 && temp_string ) ) { pr_err ( "Could not allocate memory for dt parsing\n" ) ; rc = - ENOMEM ; out } if ( of_property_read_u32_array ( np , "ibm,cpu-idle-state-flags" , temp_u32 , nr_idle_states ) ) { pr_warn ( "cpuidle-powernv: missing ibm,cpu-idle-state-flags in DT\n" ) ; rc = - EINVAL ; out } for ( i = 0 ; i < nr_idle_states ; i ++ ) { pnv_idle_states [ i ] . flags = temp_u32 [ i ] ; } if ( of_property_read_u32_array ( np , "ibm,cpu-idle-state-latencies-ns" , temp_u32 , nr_idle_states ) ) { pr_warn ( "cpuidle-powernv: missing ibm,cpu-idle-state-latencies-ns in DT\n" ) ; rc = - EINVAL ; out } for ( i = 0 ; i < nr_idle_states ; i ++ ) { pnv_idle_states [ i ] . latency_ns = temp_u32 [ i ] ; } if ( of_property_read_u32_array ( np , "ibm,cpu-idle-state-residency-ns" , temp_u32 , nr_idle_states ) ) { pr_warn ( "cpuidle-powernv: missing ibm,cpu-idle-state-residency-ns in DT\n" ) ; rc = - EINVAL ; out } for ( i = 0 ; i < nr_idle_states ; i ++ ) { pnv_idle_states [ i ] . residency_ns = temp_u32 [ i ] ; } if ( cpu_has_feature ( CPU_FTR_ARCH_300 ) ) { if ( of_property_read_u64_array ( np , "ibm,cpu-idle-state-psscr" , temp_u64 , nr_idle_states ) ) { pr_warn ( "cpuidle-powernv: missing ibm,cpu-idle-state-psscr in DT\n" ) ; rc = - EINVAL ; out } for ( i = 0 ; i < nr_idle_states ; i ++ ) { pnv_idle_states [ i ] . psscr_val = temp_u64 [ i ] ; } for ( i = 0 ; i < nr_idle_states ; i ++ ) { pnv_idle_states [ i ] . psscr_mask = temp_u64 [ i ] ; } } if ( of_property_read_string_array ( np , "ibm,cpu-idle-state-names" , temp_string , nr_idle_states ) < 0 ) { pr_warn ( "cpuidle-powernv: missing ibm,cpu-idle-state-names in DT\n" ) ; rc = - EINVAL ; out } for ( i = 0 ; i < nr_idle_states ; i ++ ) { strscpy ( pnv_idle_states [ i ] . name , temp_string [ i ] , PNV_IDLE_NAME_LEN ) ; } nr_pnv_idle_states = nr_idle_states ; rc = 0 ; out kfree ( temp_u32 ) ; kfree ( temp_u64 ) ; kfree ( temp_string ) ; of_node_put ( np ) ; return rc ; } 