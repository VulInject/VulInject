void hidms_input ( struct hidms * ms , uint8_t * data , u_int len ) { int dx , dy , dz , dw ; u_int32_t buttons = 0 ; int i , s ; DPRINTFN ( 5 , ( "hidms_input: len=%d\n" , len ) ) ; if ( ms -> sc_flags & HIDMS_LEADINGBYTE ) { if ( * data ++ == 0x02 ) { return ; } } if ( ms -> sc_flags & HIDMS_SPUR_BUT_UP ) { if ( * data == 0x14 || * data == 0x15 ) { return ; } } dx = hid_get_data ( data , len , & ms -> sc_loc_x ) ; dy = - hid_get_data ( data , len , & ms -> sc_loc_y ) ; dz = hid_get_data ( data , len , & ms -> sc_loc_z ) ; dw = hid_get_data ( data , len , & ms -> sc_loc_w ) ; if ( ms -> sc_flags & HIDMS_ABSY ) { dy = - dy ; } if ( ms -> sc_flags & HIDMS_REVZ ) { dz = - dz ; } if ( ms -> sc_flags & HIDMS_REVW ) { dw = - dw ; } if ( ms -> sc_tsscale . swapxy && ! ms -> sc_rawmode ) { int tmp = dx ; dx = dy ; dy = tmp ; } if ( ! ms -> sc_rawmode && ( ms -> sc_tsscale . maxx - ms -> sc_tsscale . minx ) != 0 && ( ms -> sc_tsscale . maxy - ms -> sc_tsscale . miny ) != 0 ) { dx = ( ( dx - ms -> sc_tsscale . minx ) * ms -> sc_tsscale . resx ) / ( ms -> sc_tsscale . maxx - ms -> sc_tsscale . minx ) ; dy = ( ( dy - ms -> sc_tsscale . miny ) * ms -> sc_tsscale . resy ) / ( ms -> sc_tsscale . maxy - ms -> sc_tsscale . miny ) ; } for ( i = 0 ; i < ms -> sc_num_buttons ; i ++ ) { if ( hid_get_data ( data , len , & ms -> sc_loc_btn [ i ] ) ) { buttons |= ( 1 << HIDMS_BUT ( i ) ) ; } } if ( dx != 0 || dy != 0 || dz != 0 || dw != 0 || buttons != ms -> sc_buttons ) { DPRINTFN ( 10 , ( "hidms_input: x:%d y:%d z:%d w:%d buttons:0x%x\n" , dx , dy , dz , dw , buttons ) ) ; ms -> sc_buttons = buttons ; if ( ms -> sc_wsmousedev != NULL ) { s = spltty ( ) ; if ( ms -> sc_flags & HIDMS_ABSX ) { wsmouse_set ( ms -> sc_wsmousedev , WSMOUSE_ABS_X , dx , 0 ) ; dx = 0 ; } WSMOUSE_INPUT ( ms -> sc_wsmousedev , buttons , dx , dy , dz , dw ) ; splx ( s ) ; } } } 