static int dlm_match_nodes ( struct dlm_ctxt * dlm , struct dlm_query_nodeinfo * qn ) { struct o2nm_node * local ; struct dlm_node_info * remote ; int i , j ; int status = 0 ; for ( j = 0 ; j < qn -> qn_numnodes ; ++ j ) { mlog ( 0 , "Node %3d, %pI4:%u\n" , qn -> qn_nodes [ j ] . ni_nodenum , & ( qn -> qn_nodes [ j ] . ni_ipv4_address ) , ntohs ( qn -> qn_nodes [ j ] . ni_ipv4_port ) ) ; } for ( i = 0 ; i < O2NM_MAX_NODES && ! status ; ++ i ) { local = o2nm_get_node_by_num ( i ) ; remote = NULL ; for ( j = 0 ; j < qn -> qn_numnodes ; ++ j ) { if ( qn -> qn_nodes [ j ] . ni_nodenum == i ) { remote = & ( qn -> qn_nodes [ j ] ) ; break ; } } if ( ! local && ! remote ) { continue ; } if ( ( local && ! remote ) || ( ! local && remote ) ) { status = - EINVAL ; } if ( ! status && ( ( remote -> ni_nodenum != local -> nd_num ) || ( remote -> ni_ipv4_port != local -> nd_ipv4_port ) || ( remote -> ni_ipv4_address != local -> nd_ipv4_address ) ) ) { status = - EINVAL ; } if ( status ) { if ( remote && ! local ) { mlog ( ML_ERROR , "Domain %s: Node %d (%pI4:%u) " "registered in joining node %d but not in " "local node %d\n" , qn -> qn_domain , remote -> ni_nodenum , & ( remote -> ni_ipv4_address ) , ntohs ( remote -> ni_ipv4_port ) , qn -> qn_nodenum , dlm -> node_num ) ; } BUG_ON ( ( ! local && ! remote ) ) ; } if ( local ) { o2nm_node_put ( local ) ; } } return status ; } 