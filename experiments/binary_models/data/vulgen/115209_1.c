void touchAllWatchedKeysInDb ( redisDb * emptied , redisDb * replaced_with ) { listIter li ; listNode * ln ; dictEntry * de ; dictIterator * di = dictGetSafeIterator ( emptied -> watched_keys ) ; while ( ( de = dictNext ( di ) ) != NULL ) { robj * key = dictGetKey ( de ) ; int exists_in_emptied = dictFind ( emptied -> dict , key -> ptr ) != NULL ; if ( exists_in_emptied || ( replaced_with && dictFind ( replaced_with -> dict , key -> ptr ) ) ) { list * clients = dictGetVal ( de ) ; if ( ! clients ) { continue ; } listRewind ( clients , & li ) ; while ( ( ln = listNext ( & li ) ) ) { watchedKey * wk = redis_member2struct ( watchedKey , node , ln ) ; if ( wk -> expired ) { if ( ! replaced_with || ! dictFind ( replaced_with -> dict , key -> ptr ) ) { wk -> expired = 0 ; continue ; } if ( keyIsExpired ( replaced_with , key ) ) { continue ; } } if ( ! exists_in_emptied && keyIsExpired ( replaced_with , key ) ) { wk -> expired = 1 ; continue ; } client * c = wk -> client ; c -> flags |= CLIENT_DIRTY_CAS ; unwatchAllKeys ( c ) ; } } } dictReleaseIterator ( di ) ; } 