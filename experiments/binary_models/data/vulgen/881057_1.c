static void mvneta_percpu_elect ( struct mvneta_port * pp ) { int elected_cpu = 0 , max_cpu , cpu , i = 0 ; if ( cpu_online ( pp -> rxq_def ) ) { elected_cpu = pp -> rxq_def ; } max_cpu = num_present_cpus ( ) ; for_each_online_cpu ( ) { int rxq_map = 0 , txq_map = 0 ; int rxq ; for ( rxq = 0 ; rxq < rxq_number ; rxq ++ ) { if ( ( rxq % max_cpu ) == cpu ) { rxq_map |= MVNETA_CPU_RXQ_ACCESS ( rxq ) ; } } if ( cpu == elected_cpu ) { rxq_map |= MVNETA_CPU_RXQ_ACCESS ( pp -> rxq_def ) ; } if ( txq_number == 1 ) { txq_map = ( cpu == elected_cpu ) ?MVNETA_CPU_TXQ_ACCESS ( 1 ) : 0 ; } else { txq_map = mvreg_read ( pp , MVNETA_CPU_MAP ( cpu ) ) & MVNETA_CPU_TXQ_ACCESS_ALL_MASK ; } mvreg_write ( pp , MVNETA_CPU_MAP ( cpu ) , rxq_map | txq_map ) ; i ++ ; } } 