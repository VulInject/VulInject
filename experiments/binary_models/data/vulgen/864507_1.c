static struct locdata * locdata_get_cache ( int category , const char * locname ) { struct locdata * loc ; lmutex_lock ( & cache_lock ) ; loc = cache_data [ category ] ; if ( ( loc != NULL ) && ( strcmp ( loc -> l_lname , locname ) == 0 ) ) { lmutex_unlock ( & cache_lock ) ; return ( loc ) ; } for ( loc = cat_data [ category ] ; loc != NULL ; loc = loc -> l_next ) { if ( strcmp ( locname , loc -> l_lname ) == 0 ) { break ; } } if ( loc == NULL ) { lmutex_unlock ( & cache_lock ) ; loc = * loaders [ category ] ( locname ) ; lmutex_lock ( & cache_lock ) ; if ( loc != NULL ) { ( void ) strlcpy ( loc -> l_lname , locname , sizeof ( loc -> l_lname ) ) ; } } if ( loc != NULL ) { cache_data [ category ] = loc ; if ( ! loc -> l_cached ) { loc -> l_cached = 1 ; loc -> l_next = cat_data [ category ] ; cat_data [ category ] = loc ; } } lmutex_unlock ( & cache_lock ) ; return ( loc ) ; } 