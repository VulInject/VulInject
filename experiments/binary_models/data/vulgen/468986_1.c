static void test_evbuffer_peek ( void * info ) { struct evbuffer * buf = NULL , * tmp_buf = NULL ; int i ; struct evbuffer_iovec v [ 20 ] ; struct evbuffer_ptr ptr ; tt_int_op ( ( v ) -> iov_len , == , strlen ( s ) ) ; tt_assert ( ) buf = evbuffer_new ( ) ; tmp_buf = evbuffer_new ( ) ; for ( i = 0 ; i < 16 ; ++ i ) { evbuffer_add_printf ( tmp_buf , "Contents of chunk [%d]\n" , i ) ; evbuffer_add_buffer ( buf , tmp_buf ) ; } i = evbuffer_peek ( buf , - 1 , NULL , NULL , 0 ) ; tt_int_op ( i , == , 16 ) ; i = evbuffer_peek ( buf , - 1 , NULL , v , 20 ) ; tt_int_op ( i , == , 16 ) ; tt_iov_eq ( & v [ 0 ] , "Contents of chunk [0]\n" ) ; tt_iov_eq ( & v [ 3 ] , "Contents of chunk [3]\n" ) ; tt_iov_eq ( & v [ 12 ] , "Contents of chunk [12]\n" ) ; tt_iov_eq ( & v [ 15 ] , "Contents of chunk [15]\n" ) ; memset ( v , 0 , sizeof ( v ) ) ; i = evbuffer_peek ( buf , - 1 , NULL , v , 1 ) ; tt_int_op ( i , == , 1 ) ; tt_iov_eq ( & v [ 0 ] , "Contents of chunk [0]\n" ) ; tt_assert ( v [ 1 ] . iov_base == NULL ) ; memset ( v , 0 , sizeof ( v ) ) ; i = evbuffer_peek ( buf , 40 , NULL , v , 16 ) ; tt_int_op ( i , == , 2 ) ; tt_iov_eq ( & v [ 0 ] , "Contents of chunk [0]\n" ) ; tt_iov_eq ( & v [ 1 ] , "Contents of chunk [1]\n" ) ; tt_assert ( v [ 2 ] . iov_base == NULL ) ; memset ( v , 0 , sizeof ( v ) ) ; i = evbuffer_peek ( buf , 100 , NULL , NULL , 0 ) ; tt_int_op ( i , == , 5 ) ; tt_assert ( v [ 0 ] . iov_base == NULL ) ; memset ( v , 0 , sizeof ( v ) ) ; i = evbuffer_peek ( buf , 60 , NULL , v , 1 ) ; tt_int_op ( i , == , 3 ) ; tt_iov_eq ( & v [ 0 ] , "Contents of chunk [0]\n" ) ; tt_assert ( v [ 1 ] . iov_base == NULL ) ; memset ( v , 0 , sizeof ( v ) ) ; i = evbuffer_peek ( buf , 65536 , NULL , v , 20 ) ; tt_int_op ( i , == , 16 ) ; tt_iov_eq ( & v [ 0 ] , "Contents of chunk [0]\n" ) ; tt_iov_eq ( & v [ 3 ] , "Contents of chunk [3]\n" ) ; tt_iov_eq ( & v [ 12 ] , "Contents of chunk [12]\n" ) ; tt_iov_eq ( & v [ 15 ] , "Contents of chunk [15]\n" ) ; tt_assert ( v [ 16 ] . iov_base == NULL ) ; memset ( v , 0 , sizeof ( v ) ) ; i = evbuffer_peek ( tmp_buf , - 1 , NULL , v , 20 ) ; tt_int_op ( i , == , 0 ) ; tt_assert ( v [ 0 ] . iov_base == NULL ) ; memset ( v , 0 , sizeof ( v ) ) ; i = evbuffer_peek ( tmp_buf , 50 , NULL , v , 20 ) ; tt_int_op ( i , == , 0 ) ; tt_assert ( v [ 0 ] . iov_base == NULL ) ; memset ( v , 0 , sizeof ( v ) ) ; evbuffer_ptr_set ( buf , & ptr , 30 , EVBUFFER_PTR_SET ) ; i = evbuffer_peek ( buf , 50 , & ptr , v , 20 ) ; tt_int_op ( i , == , 3 ) ; tt_iov_eq ( & v [ 0 ] , " of chunk [1]\n" ) ; tt_iov_eq ( & v [ 1 ] , "Contents of chunk [2]\n" ) ; tt_iov_eq ( & v [ 2 ] , "Contents of chunk [3]\n" ) ; memset ( v , 0 , sizeof ( v ) ) ; evbuffer_ptr_set ( buf , & ptr , 14 , EVBUFFER_PTR_ADD ) ; i = evbuffer_peek ( buf , 44 , & ptr , v , 20 ) ; tt_int_op ( i , == , 2 ) ; tt_iov_eq ( & v [ 0 ] , "Contents of chunk [2]\n" ) ; tt_iov_eq ( & v [ 1 ] , "Contents of chunk [3]\n" ) ; memset ( v , 0 , sizeof ( v ) ) ; tt_assert ( evbuffer_ptr_set ( buf , & ptr , evbuffer_get_length ( buf ) , EVBUFFER_PTR_SET ) == 0 ) ; i = evbuffer_peek ( buf , 44 , & ptr , v , 20 ) ; tt_int_op ( i , == , 0 ) ; tt_assert ( v [ 0 ] . iov_base == NULL ) ; end if ( tmp_buf ) { evbuffer_free ( tmp_buf ) ; } } 