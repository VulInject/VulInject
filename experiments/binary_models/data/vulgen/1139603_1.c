static int vmk80xx_ai_insn_read ( struct comedi_device * dev , struct comedi_subdevice * s , struct comedi_insn * insn , unsigned int * data ) { struct vmk80xx_private * devpriv = dev -> private ; int chan ; int reg [ 2 ] ; int n ; down ( & devpriv -> limit_sem ) ; chan = CR_CHAN ( insn -> chanspec ) ; switch ( devpriv -> model ) { case VMK8055_MODEL : if ( ! chan ) { reg [ 0 ] = VMK8055_AI1_REG ; } else { reg [ 0 ] = VMK8055_AI2_REG ; } break ; case VMK8061_MODEL : default : reg [ 0 ] = VMK8061_AI_REG1 ; reg [ 1 ] = VMK8061_AI_REG2 ; devpriv -> usb_tx_buf [ 0 ] = VMK8061_CMD_RD_AI ; devpriv -> usb_tx_buf [ VMK8061_CH_REG ] = chan ; break ; } for ( n = 0 ; n < insn -> n ; n ++ ) { if ( vmk80xx_read_packet ( dev ) ) { break ; } data [ n ] = devpriv -> usb_rx_buf [ reg [ 0 ] ] + 256 * devpriv -> usb_rx_buf [ reg [ 1 ] ] ; } up ( & devpriv -> limit_sem ) ; return n ; } 