static struct bgp * bgpL3vpnVrfRt_lookup ( struct variable * v , oid name [ ] , size_t * length , char * vrf_name , uint32_t * rt_index , uint8_t * rt_type , int exact ) { uint32_t type_index_size ; struct bgp * l3vpn_bgp ; size_t namelen = v ?v -> namelen : VRFRTTAB_NAMELEN ; int vrf_name_len , len ; type_index_size = sizeof ( uint32_t ) + sizeof ( uint8_t ) ; if ( * length - namelen != 0 && * length - namelen >= type_index_size ) { vrf_name_len = * length - ( namelen + type_index_size ) ; oid2string ( name + namelen , vrf_name_len , vrf_name ) ; oid2int ( name + namelen + vrf_name_len , ( int * ) rt_index ) ; * rt_type = name [ namelen + vrf_name_len + sizeof ( uint32_t ) ] ; } if ( * rt_index > AFI_IP6 ) { return NULL ; } if ( exact ) { l3vpn_bgp = bgp_lookup_by_name ( vrf_name ) ; if ( l3vpn_bgp && ! is_bgp_vrf_mplsvpn ( l3vpn_bgp ) ) { return NULL ; } if ( ! l3vpn_bgp ) { return NULL ; } if ( ( * rt_index != AFI_IP ) && ( * rt_index != AFI_IP6 ) ) { return NULL ; } if ( ! ( l3vpn_bgp -> vpn_policy [ * rt_index ] . rtlist [ BGP_VPN_POLICY_DIR_FROMVPN ] || l3vpn_bgp -> vpn_policy [ * rt_index ] . rtlist [ BGP_VPN_POLICY_DIR_TOVPN ] ) ) { return NULL ; } return l3vpn_bgp ; } if ( strnlen ( vrf_name , VRF_NAMSIZ ) == 0 ) { l3vpn_bgp = bgp_lookup_by_name_next ( vrf_name ) ; } else { l3vpn_bgp = bgp_lookup_by_name ( vrf_name ) ; } while ( l3vpn_bgp ) { switch ( * rt_index ) { case 0 : * rt_index = AFI_IP ; break ; case AFI_IP : * rt_index = AFI_IP6 ; break ; case AFI_IP6 : * rt_index = 0 ; continue ; } if ( * rt_index ) { switch ( * rt_type ) { case 0 : * rt_type = MPLSVPNVRFRTTYPEIMPORT ; break ; case MPLSVPNVRFRTTYPEIMPORT : * rt_type = MPLSVPNVRFRTTYPEEXPORT ; break ; case MPLSVPNVRFRTTYPEEXPORT : case MPLSVPNVRFRTTYPEBOTH : * rt_type = 0 ; break ; } if ( * rt_type ) { bool import , export ; import = ( ! ! l3vpn_bgp -> vpn_policy [ * rt_index ] . rtlist [ BGP_VPN_POLICY_DIR_FROMVPN ] ) ; export = ( ! ! l3vpn_bgp -> vpn_policy [ * rt_index ] . rtlist [ BGP_VPN_POLICY_DIR_TOVPN ] ) ; if ( * rt_type == MPLSVPNVRFRTTYPEIMPORT && ! import ) { continue ; } if ( * rt_type == MPLSVPNVRFRTTYPEEXPORT && ! export ) { continue ; } if ( * rt_type == MPLSVPNVRFRTTYPEIMPORT && import && export && ecommunity_cmp ( l3vpn_bgp -> vpn_policy [ * rt_index ] . rtlist [ BGP_VPN_POLICY_DIR_FROMVPN ] , l3vpn_bgp -> vpn_policy [ * rt_index ] . rtlist [ BGP_VPN_POLICY_DIR_TOVPN ] ) ) { * rt_type = MPLSVPNVRFRTTYPEBOTH ; } vrf_name_len = strnlen ( l3vpn_bgp -> name , VRF_NAMSIZ ) ; len = vrf_name_len + sizeof ( uint32_t ) + sizeof ( uint8_t ) ; oid_copy_str ( name + namelen , l3vpn_bgp -> name , vrf_name_len ) ; oid_copy_int ( name + namelen + vrf_name_len , ( int * ) rt_index ) ; name [ ( namelen + len ) - 1 ] = * rt_type ; * length = len + namelen ; return l3vpn_bgp ; } l3vpn_bgp = bgp_lookup_by_name_next ( l3vpn_bgp -> name ) ; } } return NULL ; } 