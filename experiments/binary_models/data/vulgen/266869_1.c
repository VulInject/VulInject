Datum spg_range_quad_picksplit ( PG_FUNCTION_ARGS ) { spgPickSplitIn * in = ( spgPickSplitIn * ) PG_GETARG_POINTER ( 0 ) ; spgPickSplitOut * out = ( spgPickSplitOut * ) PG_GETARG_POINTER ( 1 ) ; int i ; int j ; int nonEmptyCount ; RangeType * centroid ; bool empty ; TypeCacheEntry * typcache ; RangeBound * lowerBounds , * upperBounds ; lowerBounds = palloc ( sizeof ( RangeBound ) * in -> nTuples ) ; upperBounds = palloc ( sizeof ( RangeBound ) * in -> nTuples ) ; j = 0 ; for ( i = 0 ; i < in -> nTuples ; i ++ ) { range_deserialize ( typcache , DatumGetRangeTypeP ( in -> datums [ i ] ) , & lowerBounds [ j ] , & upperBounds [ j ] , & empty ) ; if ( ! empty ) { j ++ ; } } nonEmptyCount = j ; if ( nonEmptyCount == 0 ) { out -> nNodes = 2 ; out -> hasPrefix = false ; out -> prefixDatum = PointerGetDatum ( NULL ) ; out -> nodeLabels = NULL ; out -> mapTuplesToNodes = palloc ( sizeof ( int ) * in -> nTuples ) ; out -> leafTupleDatums = palloc ( sizeof ( Datum ) * in -> nTuples ) ; for ( i = 0 ; i < in -> nTuples ; i ++ ) { RangeType * range = DatumGetRangeTypeP ( in -> datums [ i ] ) ; out -> leafTupleDatums [ i ] = RangeTypePGetDatum ( range ) ; out -> mapTuplesToNodes [ i ] = 0 ; } PG_RETURN_VOID ( ) ; } qsort_arg ( lowerBounds , nonEmptyCount , sizeof ( RangeBound ) , bound_cmp , typcache ) ; qsort_arg ( upperBounds , nonEmptyCount , sizeof ( RangeBound ) , bound_cmp , typcache ) ; centroid = range_serialize ( typcache , & lowerBounds [ nonEmptyCount / 2 ] , & upperBounds [ nonEmptyCount / 2 ] , false , NULL ) ; out -> hasPrefix = true ; out -> prefixDatum = RangeTypePGetDatum ( centroid ) ; out -> nNodes = ( in -> level == 0 ) ?5 : 4 ; out -> nodeLabels = NULL ; out -> mapTuplesToNodes = palloc ( sizeof ( int ) * in -> nTuples ) ; out -> leafTupleDatums = palloc ( sizeof ( Datum ) * in -> nTuples ) ; for ( i = 0 ; i < in -> nTuples ; i ++ ) { RangeType * range = DatumGetRangeTypeP ( in -> datums [ i ] ) ; int16 quadrant = getQuadrant ( typcache , centroid , range ) ; out -> leafTupleDatums [ i ] = RangeTypePGetDatum ( range ) ; out -> mapTuplesToNodes [ i ] = quadrant - 1 ; } PG_RETURN_VOID ( ) ; } 