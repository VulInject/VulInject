static int ice_sq_send_cmd_retry ( struct ice_hw * hw , struct ice_ctl_q_info * cq , struct ice_aq_desc * desc , void * buf , u16 buf_size , struct ice_sq_cd * cd ) { struct ice_aq_desc desc_cpy ; bool is_cmd_for_retry ; u8 * buf_cpy = NULL ; u8 idx = 0 ; u16 opcode ; int status ; opcode = le16_to_cpu ( desc -> opcode ) ; is_cmd_for_retry = ice_should_retry_sq_send_cmd ( opcode ) ; memset ( & desc_cpy , 0 , sizeof ( desc_cpy ) ) ; if ( is_cmd_for_retry ) { if ( buf ) { buf_cpy = kzalloc ( buf_size , GFP_KERNEL ) ; } memcpy ( & desc_cpy , desc , sizeof ( desc_cpy ) ) ; } { status = ice_sq_send_cmd ( hw , cq , desc , buf , buf_size , cd ) ; if ( ! is_cmd_for_retry || ! status || hw -> adminq . sq_last_status != ICE_AQ_RC_EBUSY ) { break ; } if ( buf_cpy ) { memcpy ( buf , buf_cpy , buf_size ) ; } memcpy ( desc , & desc_cpy , sizeof ( desc_cpy ) ) ; mdelay ( ICE_SQ_SEND_DELAY_TIME_MS ) ; } ++ idx < ICE_SQ_SEND_MAX_EXECUTE ; kfree ( buf_cpy ) ; return status ; } 