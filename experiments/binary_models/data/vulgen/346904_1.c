static unsigned long qla4_82xx_pci_set_window ( struct scsi_qla_host * ha , unsigned long long addr ) { int window ; u32 win_read ; if ( QLA8XXX_ADDR_IN_RANGE ( addr , QLA8XXX_ADDR_DDR_NET , QLA8XXX_ADDR_DDR_NET_MAX ) ) { window = MN_WIN ( addr ) ; ha -> ddr_mn_window = window ; qla4_82xx_wr_32 ( ha , ha -> mn_win_crb | QLA82XX_PCI_CRBSPACE , window ) ; win_read = qla4_82xx_rd_32 ( ha , ha -> mn_win_crb | QLA82XX_PCI_CRBSPACE ) ; if ( ( win_read << 17 ) != window ) { ql4_printk ( KERN_WARNING , ha , "%s: Written MNwin (0x%x) != Read MNwin (0x%x)\n" , __func__ , window , win_read ) ; } } if ( QLA8XXX_ADDR_IN_RANGE ( addr , QLA8XXX_ADDR_OCM0 , QLA8XXX_ADDR_OCM0_MAX ) ) { unsigned int temp1 ; if ( ( addr & 0x00ff800 ) == 0xff800 ) { printk ( "%s: QM access not handled.\n" , __func__ ) ; addr = - 1UL ; } window = OCM_WIN ( addr ) ; ha -> ddr_mn_window = window ; qla4_82xx_wr_32 ( ha , ha -> mn_win_crb | QLA82XX_PCI_CRBSPACE , window ) ; win_read = qla4_82xx_rd_32 ( ha , ha -> mn_win_crb | QLA82XX_PCI_CRBSPACE ) ; temp1 = ( ( window & 0x1FF ) << 7 ) | ( ( window & 0x0FFFE0000 ) >> 17 ) ; if ( win_read != temp1 ) { printk ( "%s: Written OCMwin (0x%x) != Read" " OCMwin (0x%x)\n" , __func__ , temp1 , win_read ) ; } addr = GET_MEM_OFFS_2M ( addr ) + QLA82XX_PCI_OCM0_2M ; } if ( QLA8XXX_ADDR_IN_RANGE ( addr , QLA8XXX_ADDR_QDR_NET , QLA82XX_P3_ADDR_QDR_NET_MAX ) ) { window = MS_WIN ( addr ) ; ha -> qdr_sn_window = window ; qla4_82xx_wr_32 ( ha , ha -> ms_win_crb | QLA82XX_PCI_CRBSPACE , window ) ; win_read = qla4_82xx_rd_32 ( ha , ha -> ms_win_crb | QLA82XX_PCI_CRBSPACE ) ; if ( win_read != window ) { printk ( "%s: Written MSwin (0x%x) != Read " "MSwin (0x%x)\n" , __func__ , window , win_read ) ; } addr = GET_MEM_OFFS_2M ( addr ) + QLA82XX_PCI_QDR_NET ; } else { if ( ( qla4_82xx_pci_set_window_warning_count ++ < 8 ) || ( qla4_82xx_pci_set_window_warning_count % 64 == 0 ) ) { printk ( "%s: Warning:%s Unknown address range!\n" , __func__ , DRIVER_NAME ) ; } addr = - 1UL ; } return addr ; } 