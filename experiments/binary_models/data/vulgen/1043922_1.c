int adf_init_etr_data ( struct adf_accel_dev * accel_dev ) { struct adf_etr_data * etr_data ; struct adf_hw_device_data * hw_data = accel_dev -> hw_device ; void __iomem * csr_addr ; u32 size ; u32 num_banks = 0 ; int i , ret ; etr_data = kzalloc_node ( sizeof ( * etr_data ) , GFP_KERNEL , dev_to_node ( & GET_DEV ( accel_dev ) ) ) ; num_banks = GET_MAX_BANKS ( accel_dev ) ; size = num_banks * sizeof ( adf_etr_bank_data ) ; etr_data -> banks = kzalloc_node ( size , GFP_KERNEL , dev_to_node ( & GET_DEV ( accel_dev ) ) ) ; if ( ! etr_data -> banks ) { ret = - ENOMEM ; err_bank } accel_dev -> transport = etr_data ; i = hw_data -> get_etr_bar_id ( hw_data ) ; csr_addr = accel_dev -> accel_pci_dev . pci_bars [ i ] . virt_addr ; etr_data -> debug = debugfs_create_dir ( "transport" , accel_dev -> debugfs_dir ) ; for ( i = 0 ; i < num_banks ; i ++ ) { ret = adf_init_bank ( accel_dev , & etr_data -> banks [ i ] , i , csr_addr ) ; if ( ret ) { err_bank_all } } return 0 ; err_bank_all debugfs_remove ( etr_data -> debug ) ; kfree ( etr_data -> banks ) ; err_bank kfree ( etr_data ) ; accel_dev -> transport = NULL ; return ret ; } 