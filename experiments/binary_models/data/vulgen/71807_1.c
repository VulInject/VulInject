void sirdev_write_complete ( struct sir_dev * dev ) { unsigned long flags ; struct sk_buff * skb ; int actual = 0 ; int err ; spin_lock_irqsave ( & dev -> tx_lock , flags ) ; pr_debug ( "%s() - dev->tx_buff.len = %d\n" , __func__ , dev -> tx_buff . len ) ; if ( likely ( dev -> tx_buff . len > 0 ) ) { actual = dev -> drv -> do_write ( dev , dev -> tx_buff . data , dev -> tx_buff . len ) ; if ( likely ( actual > 0 ) ) { dev -> tx_buff . data += actual ; dev -> tx_buff . len -= actual ; } if ( unlikely ( actual < 0 ) ) { net_err_ratelimited ( "%s: drv->do_write failed (%d)\n" , __func__ , actual ) ; if ( ( skb = dev -> tx_skb ) != NULL ) { dev -> tx_skb = NULL ; dev_kfree_skb_any ( skb ) ; dev -> netdev -> stats . tx_errors ++ ; dev -> netdev -> stats . tx_dropped ++ ; } dev -> tx_buff . len = 0 ; } } if ( unlikely ( dev -> raw_tx != 0 ) ) { pr_debug ( "%s(), raw-tx done\n" , __func__ ) ; dev -> raw_tx = 0 ; done } pr_debug ( "%s(), finished with frame!\n" , __func__ ) ; if ( ( skb = dev -> tx_skb ) != NULL ) { dev -> tx_skb = NULL ; dev -> netdev -> stats . tx_packets ++ ; dev -> netdev -> stats . tx_bytes += skb -> len ; dev_kfree_skb_any ( skb ) ; } if ( unlikely ( dev -> new_speed > 0 ) ) { pr_debug ( "%s(), Changing speed!\n" , __func__ ) ; err = sirdev_schedule_speed ( dev , dev -> new_speed ) ; if ( unlikely ( err ) ) { net_err_ratelimited ( "%s - schedule speed change failed: %d\n" , __func__ , err ) ; netif_wake_queue ( dev -> netdev ) ; } } else { sirdev_enable_rx ( dev ) ; netif_wake_queue ( dev -> netdev ) ; } done spin_unlock_irqrestore ( & dev -> tx_lock , flags ) ; } 