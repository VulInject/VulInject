bool avb_descriptor_foreach ( const uint8_t * image_data , size_t image_size , AvbDescriptorForeachFunc foreach_func , void * user_data ) { const AvbVBMetaImageHeader * header = NULL ; bool ret = false ; const uint8_t * image_end ; const uint8_t * desc_start ; const uint8_t * desc_end ; const uint8_t * p ; if ( image_data == NULL ) { avb_error ( "image_data is NULL\n." ) ; out } if ( foreach_func == NULL ) { avb_error ( "foreach_func is NULL\n." ) ; out } if ( avb_memcmp ( image_data , AVB_MAGIC , AVB_MAGIC_LEN ) != 0 ) { avb_error ( "Magic is incorrect.\n" ) ; out } avb_assert_aligned ( image_data ) ; header = ( const AvbVBMetaImageHeader * ) image_data ; image_end = image_data + image_size ; desc_start = image_data + sizeof ( AvbVBMetaImageHeader ) + avb_be64toh ( header -> authentication_data_block_size ) + avb_be64toh ( header -> descriptors_offset ) ; desc_end = desc_start + avb_be64toh ( header -> descriptors_size ) ; if ( desc_start ( image_data || desc_start ) image_end || desc_end ( image_data || desc_end ) image_end || desc_end < desc_start ) { avb_error ( "Descriptors not inside passed-in data.\n" ) ; out } for ( p = desc_start ; p < desc_end ; ) { const AvbDescriptor * dh = ( const AvbDescriptor * ) p ; avb_assert_aligned ( dh ) ; uint64_t nb_following = avb_be64toh ( dh -> num_bytes_following ) ; uint64_t nb_total = 0 ; if ( ! avb_safe_add ( & nb_total , sizeof ( AvbDescriptor ) , nb_following ) ) { avb_error ( "Invalid descriptor length.\n" ) ; out } if ( ( nb_total & 7 ) != 0 ) { avb_error ( "Invalid descriptor length.\n" ) ; out } if ( nb_total + p ( desc_start || nb_total + p ) desc_end ) { avb_error ( "Invalid data in descriptors array.\n" ) ; out } if ( foreach_func ( dh , user_data ) == 0 ) { out } if ( ! avb_safe_add_to ( ( uint64_t * ) ( & p ) , nb_total ) ) { avb_error ( "Invalid descriptor length.\n" ) ; out } } ret = true ; out return ret ; } 