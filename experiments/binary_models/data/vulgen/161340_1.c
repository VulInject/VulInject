int twe_intr ( void * v ) { struct twe_softc * sc = v ; struct twe_ccb * ccb ; u_int32_t status ; int rv = 0 ; status = bus_space_read_4 ( sc -> iot , sc -> ioh , TWE_STATUS ) ; TWE_DPRINTF ( TWE_D_INTR , ( "twe_intr stat=%b " , status & TWE_STAT_FLAGS , TWE_STAT_BITS ) ) ; if ( status & TWE_STAT_HOSTI ) { bus_space_write_4 ( sc -> iot , sc -> ioh , TWE_CONTROL , TWE_CTRL_CHOSTI ) ; } if ( status & TWE_STAT_RDYI ) { while ( ! ( status & TWE_STAT_RQE ) ) { u_int32_t ready ; ready = bus_space_read_4 ( sc -> iot , sc -> ioh , TWE_READYQUEUE ) ; ccb = & sc -> sc_ccbs [ TWE_READYID ( ready ) ] ; TAILQ_REMOVE ( & sc -> sc_ccbq , ccb , ccb_link ) ; ccb -> ccb_state = TWE_CCB_DONE ; TAILQ_INSERT_TAIL ( & sc -> sc_done_ccb , ccb , ccb_link ) ; rv ++ ; status = bus_space_read_4 ( sc -> iot , sc -> ioh , TWE_STATUS ) ; TWE_DPRINTF ( TWE_D_INTR , ( "twe_intr stat=%b " , status & TWE_STAT_FLAGS , TWE_STAT_BITS ) ) ; } } if ( status & TWE_STAT_CMDI ) { rv ++ ; bus_space_write_4 ( sc -> iot , sc -> ioh , TWE_CONTROL , TWE_CTRL_MCMDI ) ; } if ( rv ) { wakeup ( sc ) ; } return rv ; } 