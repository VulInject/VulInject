static void emit_jmp_i64 ( struct jit_context * ctx , const u8 dst [ ] , s32 imm , s32 off , u8 op ) { u8 tmp = MIPS_R_T6 ; switch ( op ) { case JIT_JNOP : break ; case BPF_JEQ : case BPF_JNE : if ( imm >= - 0x7fff && imm <= 0x8000 ) { emit ( ctx , addiu , tmp , lo ( dst ) , - imm ) ; } if ( ( u32 ) imm <= 0xffff ) { emit ( ctx , xori , tmp , lo ( dst ) , imm ) ; } else { emit_mov_i ( ctx , tmp , imm ) ; emit ( ctx , xor , tmp , lo ( dst ) , tmp ) ; } if ( imm < 0 ) { emit ( ctx , addu , MIPS_R_T9 , hi ( dst ) , 1 ) ; emit ( ctx , or , tmp , tmp , MIPS_R_T9 ) ; } else { emit ( ctx , or , tmp , tmp , hi ( dst ) ) ; } if ( op == BPF_JEQ ) { emit ( ctx , beqz , tmp , off ) ; } else { emit ( ctx , bnez , tmp , off ) ; } break ; case BPF_JSET : case JIT_JNSET : if ( ( u32 ) imm <= 0xffff ) { emit ( ctx , andi , tmp , lo ( dst ) , imm ) ; } else { emit_mov_i ( ctx , tmp , imm ) ; emit ( ctx , and , tmp , lo ( dst ) , tmp ) ; } if ( imm < 0 ) { emit ( ctx , or , tmp , tmp , hi ( dst ) ) ; } if ( op == BPF_JSET ) { emit ( ctx , bnez , tmp , off ) ; } else { emit ( ctx , beqz , tmp , off ) ; } break ; case BPF_JGT : emit ( ctx , beqz , tmp , off ) ; break ; case BPF_JGE : emit_sltiu_r64 ( ctx , tmp , dst , imm ) ; emit ( ctx , beqz , tmp , off ) ; break ; case BPF_JLT : emit_sltiu_r64 ( ctx , tmp , dst , imm ) ; emit ( ctx , bnez , tmp , off ) ; break ; case BPF_JLE : emit_sltiu_r64 ( ctx , tmp , dst , ( s64 ) imm + 1 ) ; emit ( ctx , bnez , tmp , off ) ; break ; case BPF_JSGT : emit_slti_r64 ( ctx , tmp , dst , ( s64 ) imm + 1 ) ; emit ( ctx , beqz , tmp , off ) ; break ; case BPF_JSGE : emit_slti_r64 ( ctx , tmp , dst , imm ) ; emit ( ctx , beqz , tmp , off ) ; break ; case BPF_JSLT : emit_slti_r64 ( ctx , tmp , dst , imm ) ; emit ( ctx , bnez , tmp , off ) ; break ; case BPF_JSLE : emit_slti_r64 ( ctx , tmp , dst , ( s64 ) imm + 1 ) ; emit ( ctx , bnez , tmp , off ) ; break ; } } 