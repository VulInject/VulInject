static void sbus_esp_send_dma_cmd ( struct esp * esp , u32 addr , u32 esp_count , u32 dma_count , int write , u8 cmd ) { u32 csr ; BUG_ON ( ! ( cmd & ESP_CMD_DMA ) ) ; sbus_esp_write8 ( esp , ( esp_count >> 0 ) & 0xff , ESP_TCLOW ) ; sbus_esp_write8 ( esp , ( esp_count >> 8 ) & 0xff , ESP_TCMED ) ; if ( esp -> rev == FASHME ) { sbus_esp_write8 ( esp , ( esp_count >> 16 ) & 0xff , FAS_RLO ) ; sbus_esp_write8 ( esp , 0 , FAS_RHI ) ; scsi_esp_cmd ( esp , cmd ) ; csr = esp -> prev_hme_dmacsr ; if ( write ) { csr |= DMA_ST_WRITE ; } else { csr &= ~ DMA_ST_WRITE ; } esp -> prev_hme_dmacsr = csr ; dma_write32 ( dma_count , DMA_COUNT ) ; dma_write32 ( addr , DMA_ADDR ) ; dma_write32 ( csr , DMA_CSR ) ; } else { csr = dma_read32 ( DMA_CSR ) ; csr |= DMA_ENABLE ; if ( write ) { csr |= DMA_ST_WRITE ; } else { csr &= ~ DMA_ST_WRITE ; } dma_write32 ( csr , DMA_CSR ) ; if ( esp -> dmarev == dvmaesc1 ) { u32 end = PAGE_ALIGN ( addr + dma_count + 16U ) ; dma_write32 ( end - addr , DMA_COUNT ) ; } dma_write32 ( addr , DMA_ADDR ) ; scsi_esp_cmd ( esp , cmd ) ; } } 