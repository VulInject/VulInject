VCHIQ_STATUS_T vchiq_close_service ( VCHIQ_SERVICE_HANDLE_T handle ) { VCHIQ_SERVICE_T * service = find_service_by_handle ( handle ) ; VCHIQ_STATUS_T status = VCHIQ_SUCCESS ; if ( ! service ) { return VCHIQ_ERROR ; } vchiq_log_info ( vchiq_core_log_level , "%d: close_service:%d" , service -> state -> id , service -> localport ) ; if ( ( service -> srvstate == VCHIQ_SRVSTATE_FREE ) || ( service -> srvstate == VCHIQ_SRVSTATE_LISTENING ) || ( service -> srvstate == VCHIQ_SRVSTATE_HIDDEN ) ) { unlock_service ( service ) ; return VCHIQ_ERROR ; } if ( current == service -> state -> slot_handler_thread ) { status = vchiq_close_service_internal ( service , 0 ) ; BUG_ON ( status == VCHIQ_RETRY ) ; } else { request_poll ( service -> state , service , VCHIQ_POLL_TERMINATE ) ; } while ( 1 ) { if ( down_interruptible ( & service -> remove_event ) != 0 ) { status = VCHIQ_RETRY ; break ; } if ( ( service -> srvstate == VCHIQ_SRVSTATE_FREE ) || ( service -> srvstate == VCHIQ_SRVSTATE_LISTENING ) || ( service -> srvstate == VCHIQ_SRVSTATE_OPEN ) ) { break ; } vchiq_log_warning ( vchiq_core_log_level , "%d: close_service:%d - waiting in state %s" , service -> state -> id , service -> localport , srvstate_names [ service -> srvstate ] ) ; } if ( ( status == VCHIQ_SUCCESS ) && ( service -> srvstate != VCHIQ_SRVSTATE_FREE ) && ( service -> srvstate != VCHIQ_SRVSTATE_LISTENING ) ) { status = VCHIQ_ERROR ; } unlock_service ( service ) ; return status ; } 