void intel_pmu_lbr_init ( void ) { switch ( x86_pmu . intel_cap . lbr_format ) { case LBR_FORMAT_EIP_FLAGS2 : x86_pmu . lbr_has_tsx = 1 ; x86_pmu . lbr_from_flags = 1 ; if ( lbr_from_signext_quirk_needed ( ) ) { static_branch_enable ( & lbr_from_quirk_key ) ; } break ; case LBR_FORMAT_EIP_FLAGS : x86_pmu . lbr_from_flags = 1 ; break ; case LBR_FORMAT_INFO : x86_pmu . lbr_has_tsx = 1 ; fallthrough ; case LBR_FORMAT_INFO2 : x86_pmu . lbr_has_info = 1 ; break ; case LBR_FORMAT_TIME : x86_pmu . lbr_from_flags = 1 ; x86_pmu . lbr_to_cycles = 1 ; break ; } if ( x86_pmu . lbr_has_info ) { static_branch_enable ( & x86_lbr_cycles ) ; } } 