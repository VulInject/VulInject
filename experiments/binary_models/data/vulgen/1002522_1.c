static int smsc9420_stop ( struct net_device * dev ) { struct smsc9420_pdata * pd = netdev_priv ( dev ) ; u32 int_cfg ; ulong flags ; BUG_ON ( ! pd ) ; BUG_ON ( ! dev -> phydev ) ; spin_lock_irqsave ( & pd -> int_lock , flags ) ; int_cfg = smsc9420_reg_read ( pd , INT_CFG ) & ( ~ INT_CFG_IRQ_EN_ ) ; smsc9420_reg_write ( pd , INT_CFG , int_cfg ) ; spin_unlock_irqrestore ( & pd -> int_lock , flags ) ; netif_tx_disable ( dev ) ; napi_disable ( & pd -> napi ) ; smsc9420_stop_tx ( pd ) ; smsc9420_free_tx_ring ( pd ) ; smsc9420_stop_rx ( pd ) ; smsc9420_free_rx_ring ( pd ) ; smsc9420_dmac_soft_reset ( pd ) ; phy_stop ( dev -> phydev ) ; phy_disconnect ( dev -> phydev ) ; mdiobus_unregister ( pd -> mii_bus ) ; mdiobus_free ( pd -> mii_bus ) ; return 0 ; } 