static int open_codec_context ( AVFormatContext * fmt_ctx , enum AVMediaType type ) { int ret ; AVStream * st ; AVCodecContext * dec_ctx = NULL ; const AVCodec * dec = NULL ; AVDictionary * opts = NULL ; ret = av_find_best_stream ( fmt_ctx , type , - 1 , - 1 , & dec , 0 ) ; if ( ret < 0 ) { fprintf ( stderr , "Could not find %s stream in input file '%s'\n" , av_get_media_type_string ( type ) , src_filename ) ; return ret ; } else { int stream_idx = ret ; st = fmt_ctx -> streams [ stream_idx ] ; dec_ctx = avcodec_alloc_context3 ( dec ) ; if ( ! dec_ctx ) { fprintf ( stderr , "Failed to allocate codec\n" ) ; return AVERROR ( EINVAL ) ; } ret = avcodec_parameters_to_context ( dec_ctx , st -> codecpar ) ; if ( ret < 0 ) { fprintf ( stderr , "Failed to copy codec parameters to codec context\n" ) ; return ret ; } av_dict_set ( & opts , "flags2" , "+export_mvs" , 0 ) ; ret = avcodec_open2 ( dec_ctx , dec , & opts ) ; av_dict_free ( & opts ) ; if ( ret < 0 ) { fprintf ( stderr , "Failed to open %s codec\n" , av_get_media_type_string ( type ) ) ; return ret ; } video_stream_idx = stream_idx ; video_stream = fmt_ctx -> streams [ video_stream_idx ] ; } return 0 ; } 