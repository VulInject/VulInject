int ath11k_dp_alloc ( struct ath11k_base * ab ) { struct ath11k_dp * dp = & ab -> dp ; struct hal_srng * srng = NULL ; u32 n_link_desc ; u32 n_link_desc = 0 ; int ret ; int i ; dp -> ab = ab ; INIT_LIST_HEAD ( & dp -> reo_cmd_list ) ; INIT_LIST_HEAD ( & dp -> reo_cmd_cache_flush_list ) ; INIT_LIST_HEAD ( & dp -> dp_full_mon_mpdu_list ) ; spin_lock_init ( & dp -> reo_cmd_lock ) ; dp -> reo_cmd_cache_flush_count = 0 ; ret = ath11k_wbm_idle_ring_setup ( ab , & n_link_desc ) ; if ( ret ) { ath11k_warn ( ab , "failed to setup wbm_idle_ring: %d\n" , ret ) ; return ret ; } srng = & ab -> hal . srng_list [ dp -> wbm_idle_ring . ring_id ] ; ret = ath11k_dp_link_desc_setup ( ab , dp -> link_desc_banks , HAL_WBM_IDLE_LINK , srng , n_link_desc ) ; if ( ret ) { ath11k_warn ( ab , "failed to setup link desc: %d\n" , ret ) ; return ret ; } ret = ath11k_dp_srng_common_setup ( ab ) ; if ( ret ) { fail_link_desc_cleanup } size = sizeof ( hal_wbm_release_ring ) * DP_TX_COMP_RING_SIZE ; for ( i = 0 ; i < ab -> hw_params . max_tx_ring ; i ++ ) { idr_init ( & dp -> tx_ring [ i ] . txbuf_idr ) ; spin_lock_init ( & dp -> tx_ring [ i ] . tx_idr_lock ) ; dp -> tx_ring [ i ] . tcl_data_ring_id = i ; dp -> tx_ring [ i ] . tx_status_head = 0 ; dp -> tx_ring [ i ] . tx_status_tail = DP_TX_COMP_RING_SIZE - 1 ; dp -> tx_ring [ i ] . tx_status = kmalloc ( size , GFP_KERNEL ) ; if ( ! dp -> tx_ring [ i ] . tx_status ) { ret = - ENOMEM ; fail_cmn_srng_cleanup } } for ( i = 0 ; i < HAL_DSCP_TID_MAP_TBL_NUM_ENTRIES_MAX ; i ++ ) { ath11k_hal_tx_set_dscp_tid_map ( ab , i ) ; } return 0 ; fail_cmn_srng_cleanup ath11k_dp_srng_common_cleanup ( ab ) ; fail_link_desc_cleanup ath11k_dp_link_desc_cleanup ( ab , dp -> link_desc_banks , HAL_WBM_IDLE_LINK , & dp -> wbm_idle_ring ) ; return ret ; } 