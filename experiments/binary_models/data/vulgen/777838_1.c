VOID VIOSockTxVqCleanup ( IN PDEVICE_CONTEXT pContext ) { PVIOSOCK_TX_PKT pPkt ; LIST_ENTRY CompletionList , * CurrentItem ; TraceEvents ( TRACE_LEVEL_VERBOSE , DBG_HW_ACCESS , "-->%s\n" , __FUNCTION__ ) ; ASSERT ( pContext -> TxVq ) ; InitializeListHead ( & CompletionList ) ; WdfSpinLockAcquire ( pContext -> TxLock ) ; while ( pPkt = ( PVIOSOCK_TX_PKT ) virtqueue_detach_unused_buf ( pContext -> TxVq ) ) { if ( pPkt -> Transaction != WDF_NO_HANDLE ) { pPkt -> Request = WdfDmaTransactionGetRequest ( pPkt -> Transaction ) ; InsertTailList ( & CompletionList , & pPkt -> ListEntry ) ; } else { pPkt -> Request = WDF_NO_HANDLE ; VIOSockTxPktFree ( pContext , pPkt ) ; } } WdfSpinLockRelease ( pContext -> TxLock ) ; for ( CurrentItem = CompletionList . Flink ; CurrentItem != & CompletionList ; CurrentItem = CurrentItem -> Flink ) { pPkt = CONTAINING_RECORD ( CurrentItem , VIOSOCK_TX_PKT , ListEntry ) ; VirtIOWdfDeviceDmaTxComplete ( & pContext -> VDevice . VIODevice , pPkt -> Transaction ) ; } if ( pContext -> TxPktSliced ) { pContext -> TxPktSliced -> destroy ( pContext -> TxPktSliced ) ; pContext -> TxPktSliced = NULL ; pContext -> TxPktNum = 0 ; } pContext -> TxVq = NULL ; } 