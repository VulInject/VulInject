static ssize_t arprecv ( struct iodesc * d , void * * pkt , void * * payload , time_t tleft , void * extra __unused ) { ssize_t n ; struct ether_arp * ah ; uint16_t etype ; void * ptr ; if ( debug ) { printf ( "arprecv: " ) ; } ptr = NULL ; n = readether ( d , & ptr , ( void * * ) & ah , tleft , & etype ) ; errno = 0 ; if ( n == - 1 || n < sizeof ( ether_arp ) ) { if ( debug ) { printf ( "bad len=%d\n" , n ) ; } return ( - 1 ) ; } if ( etype != ETHERTYPE_ARP ) { if ( debug ) { printf ( "not arp type=%d\n" , etype ) ; } free ( ptr ) ; return ( - 1 ) ; } if ( ah -> arp_hrd != htons ( ARPHRD_ETHER ) || ah -> arp_pro != htons ( ETHERTYPE_IP ) || ah -> arp_hln != sizeof ( ah -> arp_sha ) || ah -> arp_pln != sizeof ( ah -> arp_spa ) ) { if ( debug ) { printf ( "bad hrd/pro/hln/pln\n" ) ; } free ( ptr ) ; return ( - 1 ) ; } if ( ah -> arp_op == htons ( ARPOP_REQUEST ) ) { if ( debug ) { printf ( "is request\n" ) ; } arp_reply ( d , ah ) ; free ( ptr ) ; return ( - 1 ) ; } if ( ah -> arp_op != htons ( ARPOP_REPLY ) ) { if ( debug ) { printf ( "not ARP reply\n" ) ; } free ( ptr ) ; return ( - 1 ) ; } if ( bcmp ( & arp_list [ arp_num ] . addr , ah -> arp_spa , sizeof ( ah -> arp_spa ) ) ) { if ( debug ) { printf ( "unwanted address\n" ) ; } free ( ptr ) ; return ( - 1 ) ; } if ( debug ) { printf ( "got it\n" ) ; } * pkt = ptr ; * payload = ah ; return ( n ) ; } 