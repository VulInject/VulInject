static void ike_alg_nss_cbc ( const struct encrypt_desc * alg , uint8_t * in_buf , size_t in_buf_len , PK11SymKey * symkey , uint8_t * iv , bool enc , struct logger * logger ) { DBGF ( DBG_CRYPT , "NSS ike_alg_nss_cbc: %s - enter" , alg -> common . fqn ) ; if ( symkey == NULL ) { llog_passert ( logger , HERE , "%s - NSS derived enc key in NULL" , alg -> common . fqn ) ; } SECItem ivitem ; ivitem . type = siBuffer ; ivitem . data = iv ; ivitem . len = alg -> enc_blocksize ; SECItem * secparam = PK11_ParamFromIV ( alg -> nss . mechanism , & ivitem ) ; if ( secparam == NULL ) { llog_passert ( logger , HERE , "%s - Failure to set up PKCS11 param (err %d)" , alg -> common . fqn , PR_GetError ( ) ) ; } PK11Context * enccontext ; enccontext = PK11_CreateContextBySymKey ( alg -> nss . mechanism , enc ?CKA_ENCRYPT : CKA_DECRYPT , symkey , secparam ) ; if ( enccontext == NULL ) { passert_nss_error ( logger , HERE , "%s: PKCS11 context creation failure" , alg -> common . fqn ) ; } uint8_t * out_buf = PR_Malloc ( ( PRUint32 ) in_buf_len ) ; int out_buf_len ; SECStatus rv = PK11_CipherOp ( enccontext , out_buf , & out_buf_len , in_buf_len , in_buf , in_buf_len ) ; if ( rv != SECSuccess ) { passert_nss_error ( logger , HERE , "%s: PKCS11 operation failure" , alg -> common . fqn ) ; } PK11_DestroyContext ( enccontext , PR_TRUE ) ; uint8_t * new_iv ; if ( enc ) { new_iv = out_buf + out_buf_len - alg -> enc_blocksize ; } else { new_iv = in_buf + in_buf_len - alg -> enc_blocksize ; } memcpy ( iv , new_iv , alg -> enc_blocksize ) ; memcpy ( in_buf , out_buf , in_buf_len ) ; PR_Free ( out_buf ) ; if ( secparam != NULL ) { SECITEM_FreeItem ( secparam , PR_TRUE ) ; } DBGF ( DBG_CRYPT , "NSS ike_alg_nss_cbc: %s - exit" , alg -> common . fqn ) ; } 