struct iface * if_new ( struct kif * kif ) { struct sockaddr_in * sain ; struct iface * iface ; struct ifreq * ifr ; int s ; if ( ( iface = calloc ( 1 , sizeof ( * iface ) ) ) == NULL ) { err ( 1 , "if_new: calloc" ) ; } iface -> state = IF_STA_DOWN ; iface -> passive = 1 ; LIST_INIT ( & iface -> nbr_list ) ; TAILQ_INIT ( & iface -> group_list ) ; strlcpy ( iface -> name , kif -> ifname , sizeof ( iface -> name ) ) ; if ( ( ifr = calloc ( 1 , sizeof ( * ifr ) ) ) == NULL ) { err ( 1 , "if_new: calloc" ) ; } strlcpy ( ifr -> ifr_name , kif -> ifname , sizeof ( ifr -> ifr_name ) ) ; if ( ( s = socket ( AF_INET , SOCK_DGRAM , 0 ) ) == - 1 ) { err ( 1 , "if_new: socket" ) ; } if ( ( kif -> flags & IFF_POINTOPOINT ) ) { iface -> type = IF_TYPE_POINTOPOINT ; } if ( ( kif -> flags & IFF_BROADCAST ) && ( kif -> flags & IFF_MULTICAST ) ) { iface -> type = IF_TYPE_BROADCAST ; } iface -> mtu = kif -> mtu ; iface -> ifindex = kif -> ifindex ; iface -> flags = kif -> flags ; iface -> linkstate = kif -> link_state ; iface -> if_type = kif -> if_type ; iface -> baudrate = kif -> baudrate ; if ( ioctl ( s , SIOCGIFADDR , ( caddr_t ) ifr ) == - 1 ) { err ( 1 , "if_new: cannot get address" ) ; } sain = ( sockaddr_in * ) & ifr -> ifr_addr ; iface -> addr = sain -> sin_addr ; if ( ioctl ( s , SIOCGIFNETMASK , ( caddr_t ) ifr ) == - 1 ) { err ( 1 , "if_new: cannot get mask" ) ; } sain = ( sockaddr_in * ) & ifr -> ifr_addr ; iface -> mask = sain -> sin_addr ; if ( iface -> type == IF_TYPE_POINTOPOINT ) { if ( ioctl ( s , SIOCGIFDSTADDR , ( caddr_t ) ifr ) == - 1 ) { err ( 1 , "if_new: cannot get dst addr" ) ; } sain = ( sockaddr_in * ) & ifr -> ifr_addr ; iface -> dst = sain -> sin_addr ; } free ( ifr ) ; close ( s ) ; return ( iface ) ; } 