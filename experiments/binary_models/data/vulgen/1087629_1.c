static void test_str ( void ) { { struct mg_str s = mg_strdup ( mg_str ( "a" ) ) ; ASSERT ( mg_strcmp ( s , mg_str ( "a" ) ) == 0 ) ; free ( ( void * ) s . ptr ) ; } ASSERT ( mg_strcmp ( mg_str ( "" ) , mg_str ( NULL ) ) == 0 ) ; ASSERT ( mg_strcmp ( mg_str ( "a" ) , mg_str ( "b" ) ) < 0 ) ; ASSERT ( mg_strcmp ( mg_str ( "b" ) , mg_str ( "a" ) ) > 0 ) ; ASSERT ( mg_strstr ( mg_str ( "abc" ) , mg_str ( "d" ) ) == NULL ) ; ASSERT ( mg_strstr ( mg_str ( "abc" ) , mg_str ( "b" ) ) != NULL ) ; ASSERT ( mg_strcmp ( mg_str ( "hi" ) , mg_strstrip ( mg_str ( " \thi\r\n" ) ) ) == 0 ) ; ASSERT ( sccmp ( "" , "" , 0 ) ) ; ASSERT ( sccmp ( "" , "1" , - 49 ) ) ; ASSERT ( sccmp ( "a" , "A" , 0 ) ) ; ASSERT ( sccmp ( "a1" , "A" , 49 ) ) ; ASSERT ( sccmp ( "a" , "A1" , - 49 ) ) ; { ASSERT ( chkdbl ( mg_str_n ( "1.23" , 3 ) , 1.2 ) ) ; ASSERT ( chkdbl ( mg_str ( "1.23 " ) , 1.23 ) ) ; ASSERT ( chkdbl ( mg_str ( "-0.01 " ) , - 0.01 ) ) ; ASSERT ( chkdbl ( mg_str ( "-0.5e2" ) , - 50.0 ) ) ; ASSERT ( chkdbl ( mg_str ( "123e-3" ) , 0.123 ) ) ; } ASSERT ( sn ( "%d" , 0 ) ) ; ASSERT ( sn ( "%d" , 1 ) ) ; ASSERT ( sn ( "%d" , - 1 ) ) ; ASSERT ( sn ( "%.*s" , 0 , "ab" ) ) ; ASSERT ( sn ( "%.*s" , 1 , "ab" ) ) ; ASSERT ( sn ( "%.1s" , "ab" ) ) ; ASSERT ( sn ( "%.99s" , "a" ) ) ; ASSERT ( sn ( "%11s" , "a" ) ) ; ASSERT ( sn ( "%s" , "a\0b" ) ) ; ASSERT ( sn ( "%2s" , "a" ) ) ; ASSERT ( sn ( "%.*s" , 3 , "a\0b" ) ) ; ASSERT ( sn ( "%d" , 7 ) ) ; ASSERT ( sn ( "%d" , 123 ) ) ; ASSERT ( sn ( "%lld" , ( uint64_t ) 0xffffffffff ) ) ; ASSERT ( sn ( "%lld" , ( uint64_t ) - 1 ) ) ; ASSERT ( sn ( "%llu" , ( uint64_t ) - 1 ) ) ; ASSERT ( sn ( "%llx" , ( uint64_t ) 0xffffffffff ) ) ; ASSERT ( sn ( "%p" , ( void * ) ( size_t ) 7 ) ) ; ASSERT ( sn ( "%lx" , ( unsigned long ) 0x6204d754 ) ) ; ASSERT ( sn ( "ab" ) ) ; ASSERT ( sn ( "%dx" , 1 ) ) ; ASSERT ( sn ( "%sx" , "a" ) ) ; ASSERT ( sn ( "%cx" , 32 ) ) ; ASSERT ( sn ( "%x" , 15 ) ) ; ASSERT ( sn ( "%2x" , 15 ) ) ; ASSERT ( sn ( "%02x" , 15 ) ) ; ASSERT ( sn ( "%hx:%hhx" , ( short ) 1 , ( char ) 2 ) ) ; ASSERT ( sn ( "%hx:%hhx" , ( short ) 1 , ( char ) 2 ) ) ; ASSERT ( sn ( "%%" ) ) ; ASSERT ( sn ( "%x" , 15 ) ) ; ASSERT ( sn ( "%#x" , 15 ) ) ; ASSERT ( sn ( "%#6x" , 15 ) ) ; ASSERT ( sn ( "%#06x" , 15 ) ) ; ASSERT ( sn ( "%#-6x" , 15 ) ) ; ASSERT ( sn ( "%-2s!" , "a" ) ) ; ASSERT ( sn ( "%s %s" , "a" , "b" ) ) ; ASSERT ( sn ( "%s %s" , "a" , "b" ) ) ; ASSERT ( sn ( "ab%dc" , 123 ) ) ; ASSERT ( sn ( "%s " , "a" ) ) ; ASSERT ( sn ( "%s %s" , "a" , "b" ) ) ; ASSERT ( sn ( "%2s %s" , "a" , "b" ) ) ; { char buf [ 100 ] , * p = NULL ; struct mg_iobuf io = { 0 0 0 16 } ; const char * expected ; expected = "\"\"" ; mg_snprintf ( buf , sizeof ( buf ) , "%Q" , "" ) ; ASSERT ( strcmp ( buf , expected ) == 0 ) ; expected = "" ; mg_snprintf ( buf , 1 , "%s" , "abc" ) ; ASSERT ( strcmp ( buf , expected ) == 0 ) ; expected = "a" ; mg_snprintf ( buf , 2 , "%s" , "abc" ) ; ASSERT ( strcmp ( buf , expected ) == 0 ) ; expected = "\"hi, \\\"\"" ; mg_snprintf ( buf , sizeof ( buf ) , "\"hi, %q\"" , "\"" ) ; MG_INFO ( ( "[%s] [%s]" , buf , expected ) ) ; ASSERT ( strcmp ( buf , expected ) == 0 ) ; expected = "\"a'b\"" ; mg_snprintf ( buf , sizeof ( buf ) , "%Q" , "a'b" ) ; ASSERT ( strcmp ( buf , expected ) == 0 ) ; expected = "\"a\\b\\n\\f\\r\\t\\\"\"" ; mg_snprintf ( buf , sizeof ( buf ) , "%Q" , "a\b\n\f\r\t\"" ) ; ASSERT ( strcmp ( buf , expected ) == 0 ) ; expected = "\"abc\"" ; mg_snprintf ( buf , sizeof ( buf ) , "%.*Q" , 3 , "abcdef" ) ; ASSERT ( strcmp ( buf , expected ) == 0 ) ; p = mg_mprintf ( "[%s,%M,%s]" , "null" , pf1 , 2 , 3 , "hi" ) ; ASSERT ( strcmp ( p , "[null,5,hi]" ) == 0 ) ; free ( p ) ; p = mg_mprintf ( "[%M,%d]" , pf2 , 10 , 7 ) ; ASSERT ( strcmp ( p , "[9876543210,7]" ) == 0 ) ; free ( p ) ; mg_xprintf ( mg_pfn_iobuf , & io , "[%M" , pf2 , 10 ) ; mg_xprintf ( mg_pfn_iobuf , & io , "," ) ; mg_xprintf ( mg_pfn_iobuf , & io , "%d]" , 7 ) ; ASSERT ( strcmp ( ( char * ) io . buf , "[9876543210,7]" ) == 0 ) ; mg_iobuf_free ( & io ) ; } { char tmp [ 40 ] ; { const char * N = # num_ ; size_t n = mg_snprintf ( tmp , sizeof ( tmp ) , fmt_ , num_ ) ; ASSERT ( n == strlen ( res_ ) ) ; ASSERT ( strcmp ( tmp , res_ ) == 0 ) ; } 0 ; , , } TESTDOUBLE ( "%g" , 0.123 , "0.123" ) ; TESTDOUBLE ( "%g" , 0.00123 , "0.00123" ) ; TESTDOUBLE ( "%g" , 0.123456333 , "0.123456" ) ; TESTDOUBLE ( "%g" , 123.0 , "123" ) ; TESTDOUBLE ( "%g" , 11.5454 , "11.5454" ) ; TESTDOUBLE ( "%g" , 11.0001 , "11.0001" ) ; TESTDOUBLE ( "%g" , 0.999 , "0.999" ) ; TESTDOUBLE ( "%g" , 0.999999 , "0.999999" ) ; TESTDOUBLE ( "%g" , 0.9999999 , "1" ) ; TESTDOUBLE ( "%g" , 10.9 , "10.9" ) ; TESTDOUBLE ( "%g" , 10.01 , "10.01" ) ; TESTDOUBLE ( "%g" , 1.0 , "1" ) ; TESTDOUBLE ( "%g" , 10.0 , "10" ) ; TESTDOUBLE ( "%g" , 100.0 , "100" ) ; TESTDOUBLE ( "%g" , 1000.0 , "1000" ) ; TESTDOUBLE ( "%g" , 10000.0 , "10000" ) ; TESTDOUBLE ( "%g" , 100000.0 , "100000" ) ; TESTDOUBLE ( "%g" , 1000000.0 , "1e+06" ) ; TESTDOUBLE ( "%g" , 10000000.0 , "1e+07" ) ; TESTDOUBLE ( "%g" , 100000001.0 , "1e+08" ) ; TESTDOUBLE ( "%g" , 10.5454 , "10.5454" ) ; TESTDOUBLE ( "%g" , 999999.0 , "999999" ) ; TESTDOUBLE ( "%g" , 9999999.0 , "1e+07" ) ; TESTDOUBLE ( "%g" , 44556677.0 , "4.45567e+07" ) ; TESTDOUBLE ( "%g" , 1234567.2 , "1.23457e+06" ) ; TESTDOUBLE ( "%g" , - 987.65432 , "-987.654" ) ; TESTDOUBLE ( "%g" , 0.0000000001 , "1e-10" ) ; TESTDOUBLE ( "%g" , 2.34567e-57 , "2.34567e-57" ) ; TESTDOUBLE ( "%.*g" , DBLWIDTH ( 7 , 9999999.0 ) , "9999999" ) ; TESTDOUBLE ( "%.*g" , DBLWIDTH ( 10 , 0.123456333 ) , "0.123456333" ) ; TESTDOUBLE ( "%g" , 123.456222 , "123.456" ) ; TESTDOUBLE ( "%.*g" , DBLWIDTH ( 10 , 123.456222 ) , "123.456222" ) ; TESTDOUBLE ( "%g" , 600.1234 , "600.123" ) ; TESTDOUBLE ( "%g" , - 600.1234 , "-600.123" ) ; TESTDOUBLE ( "%g" , 599.1234 , "599.123" ) ; TESTDOUBLE ( "%g" , - 599.1234 , "-599.123" ) ; TESTDOUBLE ( "%g" , ( double ) INFINITY , "inf" ) ; TESTDOUBLE ( "%g" , ( double ) - INFINITY , "-inf" ) ; TESTDOUBLE ( "%g" , ( double ) NAN , "nan" ) ; TESTDOUBLE ( "%g" , HUGE_VAL , "inf" ) ; TESTDOUBLE ( "%g" , - HUGE_VAL , "-inf" ) ; } { const char * expected = "[\"MA==\",\"MAo=\",\"MAr+\",\"MAr+Zw==\"]" ; char tmp [ 100 ] , s [ ] "0\n\xfeg" ; ; ASSERT ( mg_snprintf ( tmp , sizeof ( tmp ) , "[%V,%V,%V,%V]" , 1 , s , 2 , s , 3 , s , 4 , s ) == 33 ) ; ASSERT ( strcmp ( tmp , expected ) == 0 ) ; } { const char * expected = "\"002001200220616263\"" ; char tmp [ 100 ] , s [ ] "\x00 \x01 \x02 abc" ; ; ASSERT ( mg_snprintf ( tmp , sizeof ( tmp ) , "%H" , 9 , s ) == 20 ) ; ASSERT ( strcmp ( tmp , expected ) == 0 ) ; } { char tmp [ 3 ] ; ASSERT ( mg_snprintf ( tmp , sizeof ( tmp ) , "%s" , "0123456789" ) == 10 ) ; ASSERT ( strcmp ( tmp , "01" ) == 0 ) ; ASSERT ( tmp [ 2 ] == '\0' ) ; } { char buf [ 100 ] ; struct mg_addr a = { mg_htons ( 3 ) mg_htonl ( 0x2000001 ) { 1 100 33 } false } ; ASSERT ( mg_snprintf ( buf , sizeof ( buf ) , "%M %d" , mg_print_ip , & a , 7 ) == 9 ) ; ASSERT ( strcmp ( buf , "2.0.0.1 7" ) == 0 ) ; ASSERT ( mg_snprintf ( buf , sizeof ( buf ) , "%M %d" , mg_print_ip_port , & a , 7 ) == 11 ) ; ASSERT ( strcmp ( buf , "2.0.0.1:3 7" ) == 0 ) ; a . is_ip6 = true ; ASSERT ( mg_snprintf ( buf , sizeof ( buf ) , "%M %d" , mg_print_ip , & a , 7 ) == 24 ) ; ASSERT ( strcmp ( buf , "[164:2100:0:0:0:0:0:0] 7" ) == 0 ) ; ASSERT ( mg_snprintf ( buf , sizeof ( buf ) , "%M %d" , mg_print_ip_port , & a , 7 ) == 26 ) ; ASSERT ( strcmp ( buf , "[164:2100:0:0:0:0:0:0]:3 7" ) == 0 ) ; } 