static int ibmf_i_extend_wqe_mem ( ibmf_ci_t * cip , ibmf_qp_handle_t ibmf_qp_handle , ibmf_wqe_mgt_t * wqe_mgt , boolean_t block ) { ibt_status_t status ; ibt_mr_hdl_t mem_hdl ; ibt_mr_desc_t mem_desc ; ibt_mr_attr_t mem_attr ; ibmf_alt_qp_t * qp_ctx ; ibmf_wqe_mgt_t * pwqe_mgt ; vmem_t * wqe_vmem_arena ; _NOTE ( ) IBMF_TRACE_4 ( IBMF_TNF_DEBUG , DPRINT_L4 , ibmf_i_extend_wqe_cache_start , IBMF_TNF_TRACE , "" , "ibmf_i_extend_wqe_cache() enter, cip = %p, qp_hdl = %p" "wqe_mgt = %p, block = %d\n" , tnf_opaque , cip , cip , tnf_opaque , qp_hdl , ibmf_qp_handle , tnf_opaque , wqe_mgt , wqe_mgt , tnf_uint , block , block ) ; wqe_mgt -> wqes_kmem_sz = cip -> ci_nports * 2 * ( ( IBMF_MEM_PER_WQE * ibmf_send_wqes_per_port ) + ( IBMF_MEM_PER_WQE * ibmf_recv_wqes_per_port ) ) ; wqe_mgt -> wqes_kmem = kmem_zalloc ( wqe_mgt -> wqes_kmem_sz , ( block == B_TRUE ?KM_SLEEP : KM_NOSLEEP ) ) ; if ( wqe_mgt -> wqes_kmem == NULL ) { IBMF_TRACE_1 ( IBMF_TNF_NODEBUG , DPRINT_L1 , ibmf_i_extend_wqe_mem_err , IBMF_TNF_ERROR , "" , "ibmf_i_extend_wqe_mem(): %s\n" , tnf_string , msg , "extension of WQE pool failed" ) ; IBMF_TRACE_0 ( IBMF_TNF_DEBUG , DPRINT_L4 , ibmf_i_extend_wqe_mem_end , IBMF_TNF_TRACE , "" , "ibmf_i_extend_wqe_mem() exit\n" ) ; return ( IBMF_NO_RESOURCES ) ; } mem_attr . mr_vaddr = ( ib_vaddr_t ) ( uintptr_t ) wqe_mgt -> wqes_kmem ; mem_attr . mr_len = wqe_mgt -> wqes_kmem_sz ; mem_attr . mr_flags = ( block == B_TRUE ?IBT_MR_SLEEP : IBT_MR_NOSLEEP ) | IBT_MR_ENABLE_LOCAL_WRITE ; mem_attr . mr_as = NULL ; status = ibt_register_mr ( cip -> ci_ci_handle , cip -> ci_pd , & mem_attr , & mem_hdl , & mem_desc ) ; wqe_mgt -> wqes_ib_mem = mem_desc . md_vaddr ; wqe_mgt -> wqes_ib_lkey = mem_desc . md_lkey ; wqe_mgt -> wqes_ib_mem_hdl = mem_hdl ; if ( ibmf_qp_handle == IBMF_QP_HANDLE_DEFAULT ) { wqe_vmem_arena = cip -> ci_wqe_ib_vmem ; } else { qp_ctx = ( ibmf_alt_qp_t * ) ibmf_qp_handle ; wqe_vmem_arena = qp_ctx -> isq_wqe_ib_vmem ; } if ( vmem_add ( wqe_vmem_arena , ( void * ) ( uintptr_t ) wqe_mgt -> wqes_ib_mem , wqe_mgt -> wqes_kmem_sz , ( block == B_TRUE ?VM_SLEEP : VM_NOSLEEP ) ) == NULL ) { ( void ) ibt_deregister_mr ( cip -> ci_ci_handle , wqe_mgt -> wqes_ib_mem_hdl ) ; kmem_free ( wqe_mgt -> wqes_kmem , wqe_mgt -> wqes_kmem_sz ) ; IBMF_TRACE_1 ( IBMF_TNF_NODEBUG , DPRINT_L1 , ibmf_i_extend_wqe_mem_err , IBMF_TNF_ERROR , "" , "ibmf_i_extend_wqe_mem(): %s\n" , tnf_string , msg , "wqe extension vmem_add failed" ) ; IBMF_TRACE_0 ( IBMF_TNF_DEBUG , DPRINT_L4 , ibmf_i_extend_wqe_mem_end , IBMF_TNF_TRACE , "" , "ibmf_i_extend_wqe_mem() exit\n" ) ; return ( IBMF_NO_RESOURCES ) ; } if ( ibmf_qp_handle == IBMF_QP_HANDLE_DEFAULT ) { mutex_enter ( & cip -> ci_wqe_mutex ) ; pwqe_mgt = cip -> ci_wqe_mgt_list ; while ( pwqe_mgt -> wqe_mgt_next != NULL ) { pwqe_mgt = pwqe_mgt -> wqe_mgt_next ; } pwqe_mgt -> wqe_mgt_next = wqe_mgt ; mutex_exit ( & cip -> ci_wqe_mutex ) ; } else { mutex_enter ( & qp_ctx -> isq_wqe_mutex ) ; pwqe_mgt = qp_ctx -> isq_wqe_mgt_list ; while ( pwqe_mgt -> wqe_mgt_next != NULL ) { pwqe_mgt = pwqe_mgt -> wqe_mgt_next ; } pwqe_mgt -> wqe_mgt_next = wqe_mgt ; mutex_exit ( & qp_ctx -> isq_wqe_mutex ) ; } IBMF_TRACE_0 ( IBMF_TNF_DEBUG , DPRINT_L4 , ibmf_i_extend_wqe_mem_end , IBMF_TNF_TRACE , "" , "ibmf_i_extend_wqe_mem() exit\n" ) ; return ( IBMF_SUCCESS ) ; } 