static void esd_usb2_rx_can_msg ( struct esd_usb2_net_priv * priv , struct esd_usb2_msg * msg ) { struct net_device_stats * stats = & priv -> netdev -> stats ; struct can_frame * cf ; struct sk_buff * skb ; int i ; u32 id ; id = le32_to_cpu ( msg -> msg . rx . id ) ; if ( id & ESD_EVENT ) { esd_usb2_rx_event ( priv , msg ) ; } else { skb = alloc_can_skb ( priv -> netdev , & cf ) ; if ( skb == NULL ) { stats -> rx_dropped ++ ; return ; } cf -> can_id = id & ESD_IDMASK ; cf -> can_dlc = get_can_dlc ( msg -> msg . rx . dlc ) ; if ( id & ESD_EXTID ) { cf -> can_id |= CAN_EFF_FLAG ; } if ( msg -> msg . rx . dlc & ESD_RTR ) { cf -> can_id |= CAN_RTR_FLAG ; } else { for ( i = 0 ; i < cf -> can_dlc ; i ++ ) { cf -> data [ i ] = msg -> msg . rx . data [ i ] ; } } stats -> rx_packets ++ ; stats -> rx_bytes += cf -> can_dlc ; netif_rx ( skb ) ; } return ; } 