void hfi1_put_irq_affinity ( struct hfi1_devdata * dd , struct hfi1_msix_entry * msix ) { struct cpu_mask_set * set = NULL ; struct hfi1_ctxtdata * rcd ; struct hfi1_affinity_node * entry ; mutex_lock ( & node_affinity . lock ) ; entry = node_affinity_lookup ( dd -> node ) ; switch ( msix -> type ) { case IRQ_SDMA : set = & entry -> def_intr ; break ; case IRQ_GENERAL : break ; case IRQ_RCVCTXT : rcd = ( hfi1_ctxtdata * ) msix -> arg ; if ( rcd -> ctxt != HFI1_CTRL_CTXT ) { set = & entry -> rcv_intr ; } break ; default : mutex_unlock ( & node_affinity . lock ) ; return ; } if ( set ) { cpumask_andnot ( & set -> used , & set -> used , & msix -> mask ) ; if ( cpumask_empty ( & set -> used ) && set -> gen ) { set -> gen -- ; cpumask_copy ( & set -> used , & set -> mask ) ; } } irq_set_affinity_hint ( msix -> msix . vector , NULL ) ; cpumask_clear ( & msix -> mask ) ; mutex_unlock ( & node_affinity . lock ) ; } 