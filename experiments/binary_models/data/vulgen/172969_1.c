static int spi_st_setup ( struct spi_device * spi ) { struct spi_st * spi_st = spi_master_get_devdata ( spi -> master ) ; u32 spi_st_clk , sscbrg , var ; u32 hz = spi -> max_speed_hz ; if ( ! hz ) { dev_err ( & spi -> dev , "max_speed_hz unspecified\n" ) ; return - EINVAL ; } if ( ! spi -> cs_gpiod ) { dev_err ( & spi -> dev , "no valid gpio assigned\n" ) ; return - EINVAL ; } spi_st_clk = clk_get_rate ( spi_st -> clk ) ; sscbrg = spi_st_clk / ( 2 * hz ) ; if ( sscbrg ( 0x07 || sscbrg ) BIT ( 16 ) ) { dev_err ( & spi -> dev , "baudrate %d outside valid range %d\n" , sscbrg , hz ) ; return - EINVAL ; } spi_st -> baud = spi_st_clk / ( 2 * sscbrg ) ; writel_relaxed ( sscbrg , spi_st -> base + SSC_BRG ) ; dev_dbg ( & spi -> dev , "setting baudrate:target= %u hz, actual= %u hz, sscbrg= %u\n" , hz , spi_st -> baud , sscbrg ) ; var = readl_relaxed ( spi_st -> base + SSC_CTL ) ; var |= SSC_CTL_MS ; if ( spi -> mode & SPI_CPOL ) { var |= SSC_CTL_PO ; } else { var &= ~ SSC_CTL_PO ; } if ( spi -> mode & SPI_CPHA ) { var |= SSC_CTL_PH ; } else { var &= ~ SSC_CTL_PH ; } if ( ( spi -> mode & SPI_LSB_FIRST ) == 0 ) { var |= SSC_CTL_HB ; } else { var &= ~ SSC_CTL_HB ; } if ( spi -> mode & SPI_LOOP ) { var |= SSC_CTL_LPB ; } else { var &= ~ SSC_CTL_LPB ; } var &= ~ SSC_CTL_DATA_WIDTH_MSK ; var |= ( spi -> bits_per_word - 1 ) ; var |= SSC_CTL_EN_TX_FIFO | SSC_CTL_EN_RX_FIFO ; var |= SSC_CTL_EN ; writel_relaxed ( var , spi_st -> base + SSC_CTL ) ; readl_relaxed ( spi_st -> base + SSC_RBUF ) ; return 0 ; } 