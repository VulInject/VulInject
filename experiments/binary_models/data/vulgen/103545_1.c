int async_task_set_workers_group ( char * data ) { str sval ; param_t * params_list = NULL ; param_hooks_t phooks ; param_t * pit = NULL ; async_wgroup_t awg ; async_wgroup_t * newg ; if ( data == NULL ) { return - 1 ; } sval . s = data ; sval . len = strlen ( sval . s ) ; if ( sval . len <= 0 ) { LM_ERR ( "invalid parameter value\n" ) ; return - 1 ; } if ( sval . s [ sval . len - 1 ] == ';' ) { sval . len -- ; } if ( parse_params ( & sval , CLASS_ANY , & phooks , & params_list ) < 0 ) { return - 1 ; } for ( pit = params_list ; pit ; pit = pit -> next ) { if ( pit -> name . len == 4 && strncasecmp ( pit -> name . s , "name" , 4 ) == 0 ) { awg . name = pit -> body ; } if ( pit -> name . len == 7 && strncasecmp ( pit -> name . s , "workers" , 7 ) == 0 ) { if ( str2sint ( & pit -> body , & awg . workers ) < 0 ) { LM_ERR ( "invalid workers value: %.*s\n" , pit -> body . len , pit -> body . s ) ; return - 1 ; } } if ( pit -> name . len == 6 && strncasecmp ( pit -> name . s , "usleep" , 6 ) == 0 ) { if ( str2sint ( & pit -> body , & awg . usleep ) < 0 ) { LM_ERR ( "invalid usleep value: %.*s\n" , pit -> body . len , pit -> body . s ) ; return - 1 ; } } if ( pit -> name . len == 8 && strncasecmp ( pit -> name . s , "nonblock" , 8 ) == 0 ) { if ( str2sint ( & pit -> body , & awg . nonblock ) < 0 ) { LM_ERR ( "invalid nonblock value: %.*s\n" , pit -> body . len , pit -> body . s ) ; return - 1 ; } } } if ( awg . name . len <= 0 ) { LM_ERR ( "invalid name value: [%.*s]\n" , sval . len , sval . s ) ; return - 1 ; } if ( awg . workers <= 0 ) { LM_ERR ( "invalid workers value: %d\n" , awg . workers ) ; return - 1 ; } if ( awg . name . len == 7 && strncmp ( awg . name . s , "default" , 7 ) == 0 ) { if ( async_task_set_workers ( awg . workers ) < 0 ) { LM_ERR ( "failed to create the default group\n" ) ; return - 1 ; } async_task_set_nonblock ( awg . nonblock ) ; async_task_set_usleep ( awg . usleep ) ; return 0 ; } if ( _async_wgroup_list == NULL ) { if ( async_task_set_workers ( 1 ) < 0 ) { LM_ERR ( "failed to create the initial default group\n" ) ; return - 1 ; } } newg = ( async_wgroup_t * ) pkg_malloc ( sizeof ( async_wgroup_t ) + ( awg . name . len + 1 ) * sizeof ( char ) ) ; if ( newg == NULL ) { LM_ERR ( "failed to create async wgroup [%.*s]\n" , sval . len , sval . s ) ; return - 1 ; } memset ( newg , 0 , sizeof ( async_wgroup_t ) + ( awg . name . len + 1 ) * sizeof ( char ) ) ; newg -> name . s = ( char * ) newg + sizeof ( async_wgroup_t ) ; memcpy ( newg -> name . s , awg . name . s , awg . name . len ) ; newg -> name . len = awg . name . len ; newg -> workers = awg . workers ; newg -> nonblock = awg . nonblock ; newg -> usleep = awg . usleep ; newg -> next = _async_wgroup_list -> next ; _async_wgroup_list -> next = newg ; return 0 ; } 