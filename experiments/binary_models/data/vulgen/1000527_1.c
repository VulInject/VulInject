static int snd_vortex_probe ( struct pci_dev * pci , const struct pci_device_id * pci_id ) { static int dev ; struct snd_card * card ; vortex_t * chip ; int err ; if ( ! enable [ dev ] ) { dev ++ ; return - ENOENT ; } err = snd_card_new ( & pci -> dev , index [ dev ] , id [ dev ] , THIS_MODULE , 0 , & card ) ; if ( err < 0 ) { return err ; } if ( ( err = snd_vortex_create ( card , pci , & chip ) ) < 0 ) { snd_card_free ( card ) ; return err ; } snd_vortex_workaround ( pci , pcifix [ dev ] ) ; strcpy ( card -> driver , CARD_NAME_SHORT ) ; sprintf ( card -> shortname , "Aureal Vortex %s" , CARD_NAME_SHORT ) ; sprintf ( card -> longname , "%s at 0x%lx irq %i" , card -> shortname , chip -> io , chip -> irq ) ; err = snd_vortex_mixer ( chip ) ; if ( err < 0 ) { snd_card_free ( card ) ; return err ; } err = snd_vortex_new_pcm ( chip , VORTEX_PCM_ADB , NR_PCM ) ; if ( err < 0 ) { snd_card_free ( card ) ; return err ; } if ( ( err = snd_vortex_new_pcm ( chip , VORTEX_PCM_SPDIF , 1 ) ) < 0 ) { snd_card_free ( card ) ; return err ; } if ( ( err = snd_vortex_new_pcm ( chip , VORTEX_PCM_A3D , NR_A3D ) ) < 0 ) { snd_card_free ( card ) ; return err ; } if ( ( err = snd_vortex_new_pcm ( chip , VORTEX_PCM_WT , NR_WT ) ) < 0 ) { snd_card_free ( card ) ; return err ; } if ( ( err = snd_vortex_midi ( chip ) ) < 0 ) { snd_card_free ( card ) ; return err ; } vortex_gameport_register ( chip ) ; if ( snd_seq_device_new ( card , 1 , SNDRV_SEQ_DEV_ID_VORTEX_SYNTH , sizeof ( snd_vortex_synth_arg_t ) , & wave ) < 0 || wave == NULL ) { dev_err ( card -> dev , "Can't initialize Aureal wavetable synth\n" ) ; } else { snd_vortex_synth_arg_t * arg ; arg = SNDRV_SEQ_DEVICE_ARGPTR ( wave ) ; strcpy ( wave -> name , "Aureal Synth" ) ; arg -> hwptr = vortex ; arg -> index = 1 ; arg -> seq_ports = seq_ports [ dev ] ; arg -> max_voices = max_synth_voices [ dev ] ; } if ( ( err = pci_read_config_word ( pci , PCI_DEVICE_ID , & ( chip -> device ) ) ) < 0 ) { snd_card_free ( card ) ; return err ; } if ( ( err = pci_read_config_word ( pci , PCI_VENDOR_ID , & ( chip -> vendor ) ) ) < 0 ) { snd_card_free ( card ) ; return err ; } chip -> rev = pci -> revision ; if ( ( chip -> rev ) != 0xfe && ( chip -> rev ) != 0xfa ) { dev_alert ( card -> dev , "The revision (%x) of your card has not been seen before.\n" , chip -> rev ) ; dev_alert ( card -> dev , "Please email the results of 'lspci -vv' to openvortex-dev@nongnu.org.\n" ) ; snd_card_free ( card ) ; err = - ENODEV ; return err ; } if ( ( err = snd_card_register ( card ) ) < 0 ) { snd_card_free ( card ) ; return err ; } pci_set_drvdata ( pci , card ) ; dev ++ ; vortex_connect_default ( chip , 1 ) ; vortex_enable_int ( chip ) ; return 0 ; } 