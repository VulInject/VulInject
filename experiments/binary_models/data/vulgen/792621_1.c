void OutputLine ( ppd_file_t * ppd , cups_page_header2_t * header , unsigned y ) { unsigned i ; unsigned char * ptr ; unsigned char * compptr ; unsigned char repeat_char ; unsigned repeat_count ; static const unsigned char * hex = ( const unsigned char * ) "0123456789ABCDEF" ; ( void ) ppd ; switch ( ModelNumber ) { case DYMO_3x0 : if ( Buffer [ 0 ] || memcmp ( Buffer , Buffer + 1 , header -> cupsBytesPerLine - 1 ) ) { if ( Feed ) { while ( Feed > 255 ) { printf ( "\033f\001%c" , 255 ) ; Feed -= 255 ; } printf ( "\033f\001%c" , Feed ) ; Feed = 0 ; } putchar ( 0x16 ) ; fwrite ( Buffer , header -> cupsBytesPerLine , 1 , stdout ) ; fflush ( stdout ) ; } else { Feed ++ ; } break ; case ZEBRA_EPL_LINE : printf ( "\033g%03d" , header -> cupsBytesPerLine ) ; fwrite ( Buffer , 1 , header -> cupsBytesPerLine , stdout ) ; fflush ( stdout ) ; break ; case ZEBRA_EPL_PAGE : if ( Buffer [ 0 ] || memcmp ( Buffer , Buffer + 1 , header -> cupsBytesPerLine ) ) { printf ( "GW0,%d,%d,1\n" , y , header -> cupsBytesPerLine ) ; for ( i = header -> cupsBytesPerLine , ptr = Buffer ; i > 0 ; i -- , ptr ++ ) { putchar ( ~ * ptr ) ; } putchar ( '\n' ) ; fflush ( stdout ) ; } break ; case ZEBRA_ZPL : if ( LastSet ) { if ( ! memcmp ( Buffer , LastBuffer , header -> cupsBytesPerLine ) ) { return ; } } for ( ptr = Buffer , compptr = CompBuffer , i = header -> cupsBytesPerLine ; i > 0 ; i -- , ptr ++ ) { * compptr ++ = hex [ * ptr >> 4 ] ; * compptr ++ = hex [ * ptr & 15 ] ; } * compptr = '\0' ; for ( compptr = CompBuffer + 1 , repeat_char = CompBuffer [ 0 ] , repeat_count = 1 ; * compptr ; compptr ++ ) { if ( * compptr == repeat_char ) { repeat_count ++ ; } else { ZPLCompress ( repeat_char , repeat_count ) ; repeat_char = * compptr ; repeat_count = 1 ; } } if ( repeat_char == '0' ) { if ( repeat_count & 1 ) { repeat_count -- ; putchar ( '0' ) ; } if ( repeat_count > 0 ) { putchar ( ',' ) ; } } else { ZPLCompress ( repeat_char , repeat_count ) ; } fflush ( stdout ) ; memcpy ( LastBuffer , Buffer , header -> cupsBytesPerLine ) ; LastSet = 1 ; break ; case ZEBRA_CPCL : if ( Buffer [ 0 ] || memcmp ( Buffer , Buffer + 1 , header -> cupsBytesPerLine ) ) { printf ( "CG %u 1 0 %d " , header -> cupsBytesPerLine , y ) ; fwrite ( Buffer , 1 , header -> cupsBytesPerLine , stdout ) ; puts ( "\r" ) ; fflush ( stdout ) ; } break ; case INTELLITECH_PCL : if ( Buffer [ 0 ] || memcmp ( Buffer , Buffer + 1 , header -> cupsBytesPerLine - 1 ) ) { if ( Feed ) { printf ( "\033*b%dY" , Feed ) ; Feed = 0 ; LastSet = 0 ; } PCLCompress ( Buffer , header -> cupsBytesPerLine ) ; } else { Feed ++ ; } break ; } } 