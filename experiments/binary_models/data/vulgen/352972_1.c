mpz_lucnum_ui ( , ) { mp_size_t lalloc , xalloc , lsize , xsize ; mp_ptr lp , xp ; mp_limb_t c ; int zeros ; TMP_DECL ; TRACE ( printf ( "mpn_lucnum_ui n=%lu\n" , n ) ) ; if ( n <= FIB_TABLE_LUCNUM_LIMIT ) { SIZ ( ln ) = 1 ; return ; } lalloc = MPN_FIB2_SIZE ( n ) + 2 ; lp = MPZ_NEWALLOC ( ln , lalloc ) ; TMP_MARK ; xalloc = lalloc ; xp = TMP_ALLOC_LIMBS ( xalloc ) ; zeros = 0 ; for ( ; ; ) { if ( n & 1 ) { mp_size_t yalloc , ysize ; mp_ptr yp ; TRACE ( printf ( "  initial odd n=%lu\n" , n ) ) ; yalloc = MPN_FIB2_SIZE ( n / 2 ) ; yp = TMP_ALLOC_LIMBS ( yalloc ) ; ASSERT ( xalloc >= yalloc ) ; xsize = mpn_fib2_ui ( xp , yp , n / 2 ) ; ysize = xsize ; ysize -= ( yp [ ysize - 1 ] == 0 ) ; ASSERT ( yp [ ysize - 1 ] != 0 ) ; c = mpn_addlsh1_n ( xp , yp , xp , xsize ) ; c = mpn_lshift ( xp , xp , xsize , 1 ) ; c += mpn_add_n ( xp , xp , yp , xsize ) ; ASSERT ( xalloc >= xsize + 1 ) ; xp [ xsize ] = c ; xsize += ( c != 0 ) ; ASSERT ( xp [ xsize - 1 ] != 0 ) ; ASSERT ( lalloc >= xsize + ysize ) ; c = mpn_mul ( lp , xp , xsize , yp , ysize ) ; lsize = xsize + ysize ; lsize -= ( c == 0 ) ; c = mpn_addlsh2_n ( lp , lp , lp , lsize ) ; c = mpn_lshift ( xp , lp , lsize , 2 ) ; c += mpn_add_n ( lp , lp , xp , lsize ) ; ASSERT ( lalloc >= lsize + 1 ) ; lp [ lsize ] = c ; lsize += ( c != 0 ) ; if ( n & 2 ) { ASSERT ( lp [ 0 ] <= MP_LIMB_T_MAX - 4 ) ; lp [ 0 ] += 4 ; } else { MPN_DECR_U ( lp , lsize , CNST_LIMB ( 4 ) ) ; } TRACE ( mpn_trace ( "  l" , lp , lsize ) ) ; break ; } MP_PTR_SWAP ( xp , lp ) ; zeros ++ ; n /= 2 ; if ( n <= FIB_TABLE_LUCNUM_LIMIT ) { lp [ 0 ] = FIB_TABLE ( n ) + 2 * FIB_TABLE ( ( int ) n - 1 ) ; lsize = 1 ; TRACE ( "  initial small n=%lu\n" "  l" ) break ; } } for ( ; zeros != 0 ; zeros -- ) { TRACE ( printf ( "  zeros=%d\n" , zeros ) ) ; ASSERT ( xalloc >= 2 * lsize ) ; mpn_sqr ( xp , lp , lsize ) ; lsize *= 2 ; lsize -= ( xp [ lsize - 1 ] == 0 ) ; if ( n & 1 ) { ASSERT ( xp [ 0 ] <= MP_LIMB_T_MAX - 2 ) ; xp [ 0 ] += 2 ; n = 0 ; } else { MPN_DECR_U ( xp , lsize , CNST_LIMB ( 2 ) ) ; } MP_PTR_SWAP ( xp , lp ) ; ASSERT ( lp [ lsize - 1 ] != 0 ) ; } ASSERT ( lp == PTR ( ln ) ) ; SIZ ( ln ) = lsize ; TMP_FREE ; } 