static void parport_irq ( void * handle ) { struct pps_event_time ts_assert , ts_clear ; struct pps_client_pp * dev = handle ; struct parport * port = dev -> pardev -> port ; unsigned int i ; unsigned long flags ; pps_get_ts ( & ts_assert ) ; if ( dev -> cw == 0 ) { out_assert } local_irq_save ( flags ) ; if ( ! signal_is_set ( port ) ) { local_irq_restore ( flags ) ; dev_err ( dev -> pps -> dev , "lost the signal\n" ) ; out_assert } for ( i = dev -> cw ; i ; i -- ) { if ( ! signal_is_set ( port ) ) { pps_get_ts ( & ts_clear ) ; local_irq_restore ( flags ) ; dev -> cw_err = 0 ; out_both } } local_irq_restore ( flags ) ; dev -> cw_err ++ ; if ( dev -> cw_err >= CLEAR_WAIT_MAX_ERRORS ) { dev_err ( dev -> pps -> dev , "disabled clear edge capture after %d" " timeouts\n" , dev -> cw_err ) ; dev -> cw = 0 ; dev -> cw_err = 0 ; } out_assert pps_event ( dev -> pps , & ts_assert , PPS_CAPTUREASSERT , NULL ) ; return ; out_both pps_event ( dev -> pps , & ts_assert , PPS_CAPTUREASSERT , NULL ) ; return ; } 