static int dissect_xml ( tvbuff_t * tvb , packet_info * pinfo , proto_tree * tree , void * data _U_ ) { tvbparse_t * tt ; static GPtrArray * stack ; xml_frame_t * current_frame ; const char * colinfo_str ; tvbuff_t * decoded ; guint16 try_bom ; stack = g_ptr_array_new ( ) ; current_frame = wmem_new ( wmem_packet_scope ( ) , xml_frame_t ) ; current_frame -> type = XML_FRAME_ROOT ; current_frame -> name = NULL ; current_frame -> name_orig_case = NULL ; current_frame -> value = NULL ; current_frame -> pinfo = pinfo ; insert_xml_frame ( NULL , current_frame ) ; g_ptr_array_add ( stack , current_frame ) ; try_bom = tvb_get_ntohs ( tvb , 0 ) ; if ( try_bom == 0xFEFF ) { const guint8 * data_str = tvb_get_string_enc ( pinfo -> pool , tvb , 0 , tvb_captured_length ( tvb ) , ENC_UTF_16 | ENC_BIG_ENDIAN ) ; size_t l = strlen ( data_str ) ; decoded = tvb_new_child_real_data ( tvb , data_str , ( guint ) l , ( gint ) l ) ; add_new_data_source ( pinfo , decoded , "Decoded UTF-16BE text" ) ; } if ( try_bom == 0xFFFE ) { const guint8 * data_str = tvb_get_string_enc ( pinfo -> pool , tvb , 0 , tvb_captured_length ( tvb ) , ENC_UTF_16 | ENC_LITTLE_ENDIAN ) ; size_t l = strlen ( data_str ) ; decoded = tvb_new_child_real_data ( tvb , data_str , ( guint ) l , ( gint ) l ) ; add_new_data_source ( pinfo , decoded , "Decoded UTF-16LE text" ) ; } else { const guint8 * data_str = tvb_get_string_enc ( pinfo -> pool , tvb , 0 , tvb_captured_length ( tvb ) , ENC_UTF_8 ) ; size_t l = strlen ( data_str ) ; decoded = tvb_new_child_real_data ( tvb , data_str , ( guint ) l , ( gint ) l ) ; add_new_data_source ( pinfo , decoded , "Decoded UTF-8 text" ) ; } tt = tvbparse_init ( pinfo -> pool , decoded , 0 , - 1 , stack , want_ignore ) ; current_frame -> start_offset = 0 ; current_frame -> length = tvb_captured_length ( decoded ) ; root_ns = NULL ; if ( pinfo -> match_string ) { root_ns = ( xml_ns_t * ) wmem_map_lookup ( media_types , pinfo -> match_string ) ; } if ( ! root_ns ) { root_ns = & xml_ns ; colinfo_str = "/XML" ; } else { char * colinfo_str_buf ; colinfo_str_buf = wmem_strconcat ( wmem_packet_scope ( ) , "/" , root_ns -> name , NULL ) ; ascii_strup_inplace ( colinfo_str_buf ) ; colinfo_str = colinfo_str_buf ; } col_append_str ( pinfo -> cinfo , COL_PROTOCOL , colinfo_str ) ; current_frame -> ns = root_ns ; current_frame -> item = proto_tree_add_item ( tree , current_frame -> ns -> hf_tag , decoded , 0 , - 1 , ENC_UTF_8 | ENC_NA ) ; current_frame -> tree = proto_item_add_subtree ( current_frame -> item , current_frame -> ns -> ett ) ; current_frame -> last_item = current_frame -> item ; while ( tvbparse_get ( tt , want ) ) { } p_add_proto_data ( pinfo -> pool , pinfo , xml_ns . hf_tag , 0 , current_frame ) ; return tvb_captured_length ( tvb ) ; } 