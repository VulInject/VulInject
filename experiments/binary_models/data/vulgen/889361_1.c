void freeentry ( struct entry * ep ) { struct entry * np ; ino_t inum ; if ( ep -> e_flags != REMOVED ) { badentry ( ep , "not marked REMOVED" ) ; } if ( ep -> e_type == NODE ) { if ( ep -> e_links != NULL ) { badentry ( ep , "freeing referenced directory" ) ; } if ( ep -> e_entries != NULL ) { badentry ( ep , "freeing non-empty directory" ) ; } } if ( ep -> e_ino != 0 ) { np = lookupino ( ep -> e_ino ) ; if ( np == NULL ) { badentry ( ep , "lookupino failed" ) ; } if ( np == ep ) { inum = ep -> e_ino ; deleteino ( inum ) ; if ( ep -> e_links != NULL ) { addino ( inum , ep -> e_links ) ; } } else { for ( ; np != NULL ; np = np -> e_links ) { if ( np -> e_links == ep ) { np -> e_links = ep -> e_links ; break ; } } } } removeentry ( ep ) ; freename ( ep -> e_name ) ; ep -> e_next = freelist ; freelist = ep ; } 