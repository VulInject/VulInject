static int __init aspeed_sgpio_probe ( struct platform_device * pdev ) { u32 nr_gpios , sgpio_freq , sgpio_clk_div , gpio_cnt_regval , pin_mask ; const struct aspeed_sgpio_pdata * pdata ; struct aspeed_sgpio * gpio ; unsigned long apb_freq ; int rc ; gpio = devm_kzalloc ( & pdev -> dev , sizeof ( * gpio ) , GFP_KERNEL ) ; if ( ! gpio ) { return - ENOMEM ; } if ( IS_ERR ( gpio -> base ) ) { return PTR_ERR ( gpio -> base ) ; } pdata = device_get_match_data ( & pdev -> dev ) ; if ( ! pdata ) { return - EINVAL ; } pin_mask = pdata -> pin_mask ; rc = device_property_read_u32 ( & pdev -> dev , "ngpios" , & nr_gpios ) ; if ( rc < 0 ) { dev_err ( & pdev -> dev , "Could not read ngpios property\n" ) ; return - EINVAL ; } if ( nr_gpios % 8 ) { dev_err ( & pdev -> dev , "Number of GPIOs not multiple of 8: %d\n" , nr_gpios ) ; return - EINVAL ; } rc = device_property_read_u32 ( & pdev -> dev , "bus-frequency" , & sgpio_freq ) ; if ( rc < 0 ) { dev_err ( & pdev -> dev , "Could not read bus-frequency property\n" ) ; return - EINVAL ; } gpio -> pclk = devm_clk_get ( & pdev -> dev , NULL ) ; if ( IS_ERR ( gpio -> pclk ) ) { dev_err ( & pdev -> dev , "devm_clk_get failed\n" ) ; return PTR_ERR ( gpio -> pclk ) ; } apb_freq = clk_get_rate ( gpio -> pclk ) ; if ( sgpio_freq == 0 ) { return - EINVAL ; } sgpio_clk_div = ( apb_freq / ( sgpio_freq * 2 ) ) - 1 ; if ( sgpio_clk_div > ( 1 << 16 ) - 1 ) { return - EINVAL ; } gpio_cnt_regval = ( ( nr_gpios / 8 ) << ASPEED_SGPIO_PINS_SHIFT ) & pin_mask ; iowrite32 ( FIELD_PREP ( ASPEED_SGPIO_CLK_DIV_MASK , sgpio_clk_div ) | gpio_cnt_regval | ASPEED_SGPIO_ENABLE , gpio -> base + ASPEED_SGPIO_CTRL ) ; raw_spin_lock_init ( & gpio -> lock ) ; gpio -> chip . parent = & pdev -> dev ; gpio -> chip . ngpio = nr_gpios * 2 ; gpio -> chip . init_valid_mask = aspeed_sgpio_init_valid_mask ; gpio -> chip . direction_input = aspeed_sgpio_dir_in ; gpio -> chip . direction_output = aspeed_sgpio_dir_out ; gpio -> chip . get_direction = aspeed_sgpio_get_direction ; gpio -> chip . request = NULL ; gpio -> chip . free = NULL ; gpio -> chip . get = aspeed_sgpio_get ; gpio -> chip . set = aspeed_sgpio_set ; gpio -> chip . set_config = aspeed_sgpio_set_config ; gpio -> chip . label = dev_name ( & pdev -> dev ) ; gpio -> chip . base = - 1 ; aspeed_sgpio_setup_irqs ( gpio , pdev ) ; rc = devm_gpiochip_add_data ( & pdev -> dev , & gpio -> chip , gpio ) ; if ( rc < 0 ) { return rc ; } return 0 ; } 