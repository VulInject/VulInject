int xge_init ( struct ifnet * ifp ) { struct xge_softc * sc = ifp -> if_softc ; uint64_t val ; int s ; s = splnet ( ) ; xge_stop ( ifp , 0 ) ; PIF_WKEY ( MAC_CFG , TMAC_EN | RMAC_EN | TMAC_APPEND_PAD | RMAC_STRIP_FCS | RMAC_BCAST_EN | RMAC_DISCARD_PFRM ) ; DELAY ( 1000 ) ; val = PIF_RCSR ( ADAPTER_STATUS ) ; if ( ( val & QUIESCENT ) != QUIESCENT ) { char buf [ 200 ] ; printf ( "%s: adapter not quiescent, aborting\n" , XNAME ) ; val = ( val & QUIESCENT ) ^ QUIESCENT ; bitmask_snprintf ( val , QUIESCENT_BMSK , buf , sizeof buf ) ; printf ( "%s: ADAPTER_STATUS missing bits %s\n" , XNAME , buf ) ; splx ( s ) ; return ( 1 ) ; } if ( ! ( ifp -> if_capabilities & IFCAP_VLAN_HWTAGGING ) ) { val &= ~ STRIP_VLAN_TAG ; PIF_WCSR ( RX_PA_CFG , val ) ; } PIF_WCSR ( RMAC_MAX_PYLD_LEN , RMAC_PYLD_LEN ( XGE_MAX_FRAMELEN ) ) ; val = PIF_RCSR ( ADAPTER_CONTROL ) ; val |= EOI_TX_ON ; PIF_WCSR ( ADAPTER_CONTROL , val ) ; xge_enable ( sc ) ; PIF_WCSR ( TX_TRAFFIC_MASK , 0 ) ; PIF_WCSR ( RX_TRAFFIC_MASK , 0 ) ; PIF_WCSR ( TXPIC_INT_MASK , 0 ) ; PIF_WCSR ( RXPIC_INT_MASK , 0 ) ; PIF_WCSR ( MAC_INT_MASK , MAC_TMAC_INT ) ; PIF_WCSR ( MAC_RMAC_ERR_REG , RMAC_LINK_STATE_CHANGE_INT ) ; PIF_WCSR ( MAC_RMAC_ERR_MASK , ~ RMAC_LINK_STATE_CHANGE_INT ) ; PIF_WCSR ( GENERAL_INT_MASK , 0 ) ; xge_setpromisc ( sc ) ; xge_setmulti ( sc ) ; ifp -> if_flags |= IFF_RUNNING ; ifq_clr_oactive ( & ifp -> if_snd ) ; splx ( s ) ; return ( 0 ) ; } 