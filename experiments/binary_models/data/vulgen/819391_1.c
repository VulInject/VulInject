int ec_probe ( struct device * parent , void * match , void * aux ) { struct isa_attach_args * ia = aux ; bus_space_tag_t nict , asict , memt ; bus_space_handle_t nich , asich , memh ; bus_size_t memsize ; int nich_valid , asich_valid , memh_valid ; int i , rv = 0 ; u_int8_t x ; nict = asict = ia -> ia_iot ; memt = ia -> ia_memt ; nich_valid = asich_valid = memh_valid = 0 ; memsize = 8192 ; if ( ia -> ia_iobase == - 1 ) { return ( 0 ) ; } if ( ia -> ia_maddr == - 1 ) { return ( 0 ) ; } for ( i = 0 ; i < NEC_IOBASE ; i ++ ) { if ( ia -> ia_iobase == ec_iobase [ i ] ) { break ; } } if ( i == NEC_IOBASE ) { return ( 0 ) ; } for ( i = 0 ; i < NEC_MEMBASE ; i ++ ) { if ( ec_membase [ i ] == MADDRUNK ) { continue ; } if ( ia -> ia_maddr == ec_membase [ i ] ) { break ; } } if ( i == NEC_MEMBASE ) { return ( 0 ) ; } if ( bus_space_map ( nict , ia -> ia_iobase + ELINK2_NIC_OFFSET , ELINK2_NIC_PORTS , 0 , & nich ) ) { out } nich_valid = 1 ; if ( bus_space_map ( asict , ia -> ia_iobase + ELINK2_ASIC_OFFSET , ELINK2_ASIC_PORTS , 0 , & asich ) ) { out } asich_valid = 1 ; if ( bus_space_map ( memt , ia -> ia_maddr , memsize , 0 , & memh ) ) { out } memh_valid = 1 ; x = bus_space_read_1 ( asict , asich , ELINK2_BCFR ) ; if ( x == 0 || ( x & ( x - 1 ) ) != 0 ) { out } i = ffs ( x ) - 1 ; if ( ia -> ia_iobase != ec_iobase [ i ] ) { out } x = bus_space_read_1 ( asict , asich , ELINK2_PCFR ) ; if ( x == 0 || ( x & ( x - 1 ) ) != 0 ) { out } i = ffs ( x ) - 1 ; ia -> ia_iosize = ELINK2_NIC_PORTS ; ia -> ia_msize = memsize ; rv = 1 ; out if ( nich_valid ) { bus_space_unmap ( nict , nich , ELINK2_NIC_PORTS ) ; } if ( asich_valid ) { bus_space_unmap ( asict , asich , ELINK2_ASIC_PORTS ) ; } if ( memh_valid ) { bus_space_unmap ( memt , memh , memsize ) ; } return ( rv ) ; } 