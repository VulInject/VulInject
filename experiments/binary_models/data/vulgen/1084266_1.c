static int cm_init_av_by_path ( struct sa_path_rec * path , const struct ib_gid_attr * sgid_attr , struct cm_av * av ) { struct rdma_ah_attr new_ah_attr ; struct cm_device * cm_dev ; struct cm_port * port ; int ret ; port = get_cm_port_from_path ( path , sgid_attr ) ; cm_dev = port -> cm_dev ; ret = ib_find_cached_pkey ( cm_dev -> ib_device , port -> port_num , be16_to_cpu ( path -> pkey ) , & av -> pkey_index ) ; if ( ret ) { return ret ; } cm_set_av_port ( av , port ) ; ret = ib_init_ah_attr_from_path ( cm_dev -> ib_device , port -> port_num , path , & new_ah_attr , sgid_attr ) ; if ( ret ) { return ret ; } av -> timeout = path -> packet_life_time + 1 ; rdma_move_ah_attr ( & av -> ah_attr , & new_ah_attr ) ; return 0 ; } 