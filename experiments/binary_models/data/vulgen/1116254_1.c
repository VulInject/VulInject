int iwl_nvm_init ( struct iwl_mvm * mvm , bool read_nvm_from_nic ) { int ret , section ; u32 size_read = 0 ; u8 * nvm_buffer , * temp ; const char * nvm_file_B = mvm -> cfg -> default_nvm_file_B_step ; const char * nvm_file_C = mvm -> cfg -> default_nvm_file_C_step ; if ( WARN_ON_ONCE ( mvm -> cfg -> nvm_hw_section_num >= NVM_MAX_NUM_SECTIONS ) ) { return - EINVAL ; } if ( read_nvm_from_nic ) { IWL_DEBUG_EEPROM ( mvm -> trans -> dev , "Read from NVM\n" ) ; nvm_buffer = kmalloc ( mvm -> cfg -> base_params -> eeprom_size , GFP_KERNEL ) ; if ( ! nvm_buffer ) { return - ENOMEM ; } for ( section = 0 ; section < NVM_MAX_NUM_SECTIONS ; section ++ ) { ret = iwl_nvm_read_section ( mvm , section , nvm_buffer , size_read ) ; if ( ret < 0 ) { continue ; } size_read += ret ; temp = kmemdup ( nvm_buffer , ret , GFP_KERNEL ) ; if ( ! temp ) { ret = - ENOMEM ; break ; } iwl_mvm_nvm_fixups ( mvm , section , temp , ret ) ; mvm -> nvm_sections [ section ] . data = temp ; mvm -> nvm_sections [ section ] . length = ret ; switch ( section ) { case NVM_SECTION_TYPE_SW : mvm -> nvm_sw_blob . data = temp ; mvm -> nvm_sw_blob . size = ret ; break ; case NVM_SECTION_TYPE_CALIBRATION : mvm -> nvm_calib_blob . data = temp ; mvm -> nvm_calib_blob . size = ret ; break ; case NVM_SECTION_TYPE_PRODUCTION : mvm -> nvm_prod_blob . data = temp ; mvm -> nvm_prod_blob . size = ret ; break ; case NVM_SECTION_TYPE_PHY_SKU : mvm -> nvm_phy_sku_blob . data = temp ; mvm -> nvm_phy_sku_blob . size = ret ; break ; default : } } if ( ! size_read ) { IWL_ERR ( mvm , "OTP is blank\n" ) ; } kfree ( nvm_buffer ) ; } if ( mvm -> nvm_file_name ) { ret = iwl_mvm_read_external_nvm ( mvm ) ; if ( ret ) { if ( CSR_HW_REV_STEP ( mvm -> trans -> hw_rev ) == SILICON_B_STEP ) { mvm -> nvm_file_name = nvm_file_B ; } else { mvm -> nvm_file_name = nvm_file_C ; } if ( ( ret == - EFAULT || ret == - ENOENT ) && mvm -> nvm_file_name ) { ret = iwl_mvm_read_external_nvm ( mvm ) ; if ( ret ) { return ret ; } } else { return ret ; } } } mvm -> nvm_data = iwl_parse_nvm_sections ( mvm ) ; if ( ! mvm -> nvm_data ) { return - ENODATA ; } IWL_DEBUG_EEPROM ( mvm -> trans -> dev , "nvm version = %x\n" , mvm -> nvm_data -> nvm_version ) ; return 0 ; } 