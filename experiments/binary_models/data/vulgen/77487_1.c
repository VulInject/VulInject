static int rproc_elf_load_segments ( struct rproc * rproc , const struct firmware * fw ) { struct device * dev = & rproc -> dev ; struct elf32_hdr * ehdr ; struct elf32_phdr * phdr ; int i , ret = 0 ; const u8 * elf_data = fw -> data ; ehdr = ( elf32_hdr * ) elf_data ; phdr = ( elf32_phdr * ) ( elf_data + ehdr -> e_phoff ) ; for ( i = 0 ; i < ehdr -> e_phnum ; i ++ , phdr ++ ) { u32 da = phdr -> p_paddr ; u32 memsz = phdr -> p_memsz ; u32 filesz = phdr -> p_filesz ; u32 offset = phdr -> p_offset ; void * ptr ; if ( phdr -> p_type != PT_LOAD ) { continue ; } dev_dbg ( dev , "phdr: type %d da 0x%x memsz 0x%x filesz 0x%x\n" , phdr -> p_type , da , memsz , filesz ) ; if ( filesz > memsz ) { dev_err ( dev , "bad phdr filesz 0x%x memsz 0x%x\n" , filesz , memsz ) ; ret = - EINVAL ; break ; } if ( offset + filesz > fw -> size ) { dev_err ( dev , "truncated fw: need 0x%x avail 0x%zx\n" , offset + filesz , fw -> size ) ; ret = - EINVAL ; break ; } ptr = rproc_da_to_va ( rproc , da , memsz ) ; if ( ! ptr ) { dev_err ( dev , "bad phdr da 0x%x mem 0x%x\n" , da , memsz ) ; ret = - EINVAL ; break ; } if ( phdr -> p_filesz ) { memcpy ( ptr , elf_data + phdr -> p_offset , filesz ) ; } } return ret ; } 