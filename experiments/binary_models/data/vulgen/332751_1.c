static time_t parse_datetime ( const char * timestr , bool * date_specified ) { char buf [ 128 ] ; time_t now = time ( NULL ) ; time_t t ; struct tm tm , tm1 ; size_t len ; char * end ; bool utc = false ; len = strlen ( timestr ) ; if ( len && timestr [ len - 1 ] == 'Z' ) { utc = true ; len -- ; } if ( len != 8 && len != 17 && len != 19 ) { log_message ( LOG_INFO , "Reload time %s format is incorrect - ignoring" , timestr ) ; return - 1 ; } if ( utc ) { gmtime_r ( & now , & tm ) ; } else { localtime_r ( & now , & tm ) ; } end = strptime ( timestr , len == 8 ?"%H:%M:%S" : len == 17 ?"%y-%m-%d %H:%M:%S" : "%Y-%m-%d %H:%M:%S" , & tm ) ; if ( ! end || end [ utc ?1 : 0 ] ) { log_message ( LOG_INFO , "Reload date/time %s invalid - ignoring" , timestr ) ; return - 1 ; } log_message ( LOG_INFO , "%4.4d-%2.2d-%2.2d %2.2d:%2.2d:%2.2d %s" , tm . tm_year + 1900 , tm . tm_mon + 1 , tm . tm_mday , tm . tm_hour , tm . tm_min , tm . tm_sec , tm . tm_isdst ?" DST" : "" ) ; tm . tm_isdst = - 1 ; strftime ( buf , sizeof ( buf ) , "%c" , & tm ) ; log_message ( LOG_INFO , "strf - %s" , buf ) ; tm1 = tm ; t = mktime ( & tm1 ) ; if ( tm . tm_year != tm1 . tm_year || tm . tm_mon != tm1 . tm_mon || tm . tm_mday != tm1 . tm_mday || tm . tm_hour != tm1 . tm_hour || tm . tm_min != tm1 . tm_min || tm . tm_sec != tm1 . tm_sec ) { log_message ( LOG_INFO , "Reload time %s is not valid - ignoring" , timestr ) ; return - 1 ; } if ( utc ) { t = timegm ( & tm1 ) ; } * date_specified = ( len >= 17 ) ; localtime_r ( & t , & tm1 ) ; strftime ( buf , sizeof ( buf ) , "%c" , & tm1 ) ; log_message ( LOG_INFO , "mktime - %s%s - %s" , buf , tm1 . tm_isdst ?" DST" : "" , * tzname ) ; return t ; } 