int dwc2_host_exit_hibernation ( struct dwc2_hsotg * hsotg , int rem_wakeup , int reset ) { u32 gpwrdn ; u32 hprt0 ; int ret = 0 ; struct dwc2_gregs_backup * gr ; struct dwc2_hregs_backup * hr ; gr = & hsotg -> gr_backup ; hr = & hsotg -> hr_backup ; dev_dbg ( hsotg -> dev , "%s: called with rem_wakeup = %d reset = %d\n" , __func__ , rem_wakeup , reset ) ; dwc2_hib_restore_common ( hsotg , rem_wakeup , 1 ) ; hsotg -> hibernated = 0 ; mdelay ( 100 ) ; dwc2_writel ( hsotg , 0xffffffff , GINTSTS ) ; gpwrdn = dwc2_readl ( hsotg , GPWRDN ) ; gpwrdn &= ~ GPWRDN_RESTORE ; dwc2_writel ( hsotg , gpwrdn , GPWRDN ) ; udelay ( 10 ) ; dwc2_writel ( hsotg , gr -> gusbcfg , GUSBCFG ) ; dwc2_writel ( hsotg , hr -> hcfg , HCFG ) ; gpwrdn = dwc2_readl ( hsotg , GPWRDN ) ; gpwrdn &= ~ GPWRDN_PMUACTV ; dwc2_writel ( hsotg , gpwrdn , GPWRDN ) ; udelay ( 10 ) ; hprt0 |= HPRT0_PWR ; hprt0 &= ~ HPRT0_ENA ; hprt0 &= ~ HPRT0_SUSP ; dwc2_writel ( hsotg , hprt0 , HPRT0 ) ; hprt0 = hr -> hprt0 ; hprt0 |= HPRT0_PWR ; hprt0 &= ~ HPRT0_ENA ; hprt0 &= ~ HPRT0_SUSP ; if ( reset ) { hprt0 |= HPRT0_RST ; dwc2_writel ( hsotg , hprt0 , HPRT0 ) ; mdelay ( 60 ) ; hprt0 &= ~ HPRT0_RST ; dwc2_writel ( hsotg , hprt0 , HPRT0 ) ; } else { hprt0 |= HPRT0_RES ; dwc2_writel ( hsotg , hprt0 , HPRT0 ) ; mdelay ( 100 ) ; hprt0 &= ~ HPRT0_RES ; dwc2_writel ( hsotg , hprt0 , HPRT0 ) ; } hprt0 = dwc2_readl ( hsotg , HPRT0 ) ; hprt0 |= HPRT0_CONNDET ; hprt0 |= HPRT0_ENACHG ; hprt0 &= ~ HPRT0_ENA ; dwc2_writel ( hsotg , hprt0 , HPRT0 ) ; hprt0 = dwc2_readl ( hsotg , HPRT0 ) ; dwc2_writel ( hsotg , 0xffffffff , GINTSTS ) ; ret = dwc2_restore_global_registers ( hsotg ) ; if ( ret ) { dev_err ( hsotg -> dev , "%s: failed to restore registers\n" , __func__ ) ; return ret ; } ret = dwc2_restore_host_registers ( hsotg ) ; if ( ret ) { dev_err ( hsotg -> dev , "%s: failed to restore host registers\n" , __func__ ) ; return ret ; } if ( rem_wakeup ) { dwc2_hcd_rem_wakeup ( hsotg ) ; hsotg -> flags . b . port_connect_status_change = 1 ; } hsotg -> hibernated = 0 ; hsotg -> bus_suspended = 0 ; hsotg -> lx_state = DWC2_L0 ; dev_dbg ( hsotg -> dev , "Host hibernation restore complete\n" ) ; return ret ; } 