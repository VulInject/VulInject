void smc91cxx_start ( struct ifnet * ifp ) { struct smc91cxx_softc * sc = ifp -> if_softc ; bus_space_tag_t bst = sc -> sc_bst ; bus_space_handle_t bsh = sc -> sc_bsh ; u_int len ; struct mbuf * m , * top ; u_int16_t length , npages ; u_int8_t packetno ; int timo , pad ; again m = ifq_deq_begin ( & ifp -> if_snd ) ; if ( m == NULL ) { return ; } for ( len = 0 , top = m ; m != NULL ; m = m -> m_next ) { len += m -> m_len ; } pad = ( len & 1 ) ; if ( ( len + pad ) > ( ETHER_MAX_LEN - ETHER_CRC_LEN ) ) { printf ( "%s: large packet discarded\n" , sc -> sc_dev . dv_xname ) ; ifp -> if_oerrors ++ ; ifq_deq_commit ( & ifp -> if_snd , m ) ; m_freem ( m ) ; readcheck } if ( len < ( ETHER_MIN_LEN - ETHER_CRC_LEN ) ) { pad = ETHER_MIN_LEN - ETHER_CRC_LEN - len ; } length = pad + len ; npages = ( length + 6 ) >> 8 ; SMC_SELECT_BANK ( sc , 2 ) ; bus_space_write_2 ( bst , bsh , MMU_CMD_REG_W , MMUCR_ALLOC | npages ) ; timo = MEMORY_WAIT_TIME ; { if ( bus_space_read_1 ( bst , bsh , INTR_STAT_REG_B ) & IM_ALLOC_INT ) { break ; } delay ( 1 ) ; } -- timo ; packetno = bus_space_read_1 ( bst , bsh , ALLOC_RESULT_REG_B ) ; if ( packetno & ARR_FAILED || timo == 0 ) { bus_space_write_1 ( bst , bsh , INTR_MASK_REG_B , bus_space_read_1 ( bst , bsh , INTR_MASK_REG_B ) | IM_ALLOC_INT ) ; ifp -> if_timer = 5 ; ifq_deq_rollback ( & ifp -> if_snd , m ) ; ifq_set_oactive ( & ifp -> if_snd ) ; return ; } bus_space_write_1 ( bst , bsh , PACKET_NUM_REG_B , packetno ) ; bus_space_write_2 ( bst , bsh , POINTER_REG_W , PTR_AUTOINC ) ; bus_space_write_2 ( bst , bsh , DATA_REG_W , 0 ) ; bus_space_write_1 ( bst , bsh , DATA_REG_B , ( length + 6 ) & 0xff ) ; bus_space_write_1 ( bst , bsh , DATA_REG_B , ( ( length + 6 ) >> 8 ) & 0xff ) ; ifq_deq_commit ( & ifp -> if_snd , m ) ; for ( top = m ; m != NULL ; m = m -> m_next ) { if ( m -> m_len > 1 ) { bus_space_write_multi_stream_2 ( bst , bsh , DATA_REG_W , mtod ( m , u_int16_t * ) , m -> m_len >> 1 ) ; } if ( m -> m_len & 1 ) { bus_space_write_1 ( bst , bsh , DATA_REG_B , * ( u_int8_t * ) ( mtod ( m , u_int8_t * ) + ( m -> m_len - 1 ) ) ) ; } } while ( pad > 1 ) { bus_space_write_2 ( bst , bsh , DATA_REG_W , 0 ) ; pad -= 2 ; } if ( pad ) { bus_space_write_1 ( bst , bsh , DATA_REG_B , 0 ) ; } bus_space_write_2 ( bst , bsh , DATA_REG_W , 0 ) ; bus_space_write_1 ( bst , bsh , INTR_MASK_REG_B , bus_space_read_1 ( bst , bsh , INTR_MASK_REG_B ) | IM_TX_INT | IM_TX_EMPTY_INT ) ; bus_space_write_2 ( bst , bsh , MMU_CMD_REG_W , MMUCR_ENQUEUE ) ; ifp -> if_timer = 5 ; if ( ifp -> if_bpf ) { bpf_mtap ( ifp -> if_bpf , top , BPF_DIRECTION_OUT ) ; } m_freem ( top ) ; readcheck if ( bus_space_read_2 ( bst , bsh , FIFO_PORTS_REG_W ) & FIFO_REMPTY ) { again } } 