( size / ( ATM_CELL_PAYLOAD / 4 ) ) , tx -> send + tx -> tx_pos * 4 ; writel ( ( vcc -> vci << MID_SEG_VCI_SHIFT ) | ( aal5 ?0 : ( skb -> data [ 3 ] & 0xf ) ) | ( ATM_SKB ( skb ) -> atm_options & ATM_ATMOPT_CLP ?MID_SEG_CLP : 0 ) , tx -> send + ( ( tx -> tx_pos + 1 ) & ( tx -> words - 1 ) ) * 4 ) ; DPRINTK ( "size: %d, len:%d\n" , size , skb -> len ) ; if ( aal5 ) { writel ( eni_dev -> dma [ i * 2 ] , 0 ) ; writel ( eni_dev -> dma [ i * 2 + 1 ] , eni_dev -> tx_dma + dma_wr * 8 + 4 ) ; dma_wr = ( dma_wr + 1 ) & ( NR_DMA_TX - 1 ) ; } j = j >> 1 ; for ( i = 0 ; i < j ; i ++ ) { writel ( eni_dev -> dma [ i * 2 ] , eni_dev -> tx_dma + dma_wr * 8 ) ; writel ( eni_dev -> dma [ i * 2 + 1 ] , eni_dev -> tx_dma + dma_wr * 8 + 4 ) ; dma_wr = ( dma_wr + 1 ) & ( NR_DMA_TX - 1 ) ; } ENI_PRV_POS ( skb ) = tx -> tx_pos ; ENI_PRV_SIZE ( skb ) = size ; ENI_VCC ( vcc ) -> txing += size ; tx -> tx_pos = ( tx -> tx_pos + size ) & ( tx -> words - 1 ) ; DPRINTK ( "dma_wr set to %d, tx_pos is now %ld\n" , dma_wr , tx -> tx_pos ) ; eni_out ( dma_wr , MID_DMA_WR_TX ) ; skb_queue_tail ( & eni_dev -> tx_queue , skb ) ; queued ++ ; return enq_ok ; 