void sh_clock_init ( int flags , struct rtc_ops * rtc ) { uint32_t s , t0 , cnt_1s ; sh_clock . flags = flags ; if ( rtc != NULL ) { sh_clock . rtc = * rtc ; } _reg_write_2 ( SH_ ( TCR0 ) , 0 ) ; _reg_write_2 ( SH_ ( TCR1 ) , 0 ) ; _reg_write_2 ( SH_ ( TCR2 ) , 0 ) ; _reg_write_1 ( SH_ ( RCR1 ) , 0 ) ; _reg_write_1 ( SH_ ( TSTR ) , 0 ) ; if ( sh_clock . flags & SH_CLOCK_NORTC ) { _reg_write_2 ( SH_ ( TCR0 ) , TCR_TPSC_P16 ) ; sh_clock . tmuclk = sh_clock . pclock / 16 ; } else { _reg_write_2 ( SH_ ( TCR0 ) , CPU_IS_SH3 ?SH3_TCR_TPSC_RTC : SH4_TCR_TPSC_RTC ) ; sh_clock . tmuclk = SH_RTC_CLOCK ; _reg_bset_1 ( SH_ ( RCR2 ) , SH_RCR2_ENABLE ) ; } s = _cpu_exception_suspend ( ) ; _cpu_spin ( 1 ) ; TMU_START ( 0 ) ; _cpu_spin ( 10000000 ) ; t0 = TMU_ELAPSED ( 0 ) ; _cpu_exception_resume ( s ) ; sh_clock . cpucycle_1us = ( sh_clock . tmuclk * 10 ) / t0 ; cnt_1s = ( ( uint64_t ) sh_clock . tmuclk * 10000000 * 10 + t0 / 2 ) / t0 ; if ( CPU_IS_SH4 ) { sh_clock . cpuclock = cnt_1s / 2 ; } else { sh_clock . cpuclock = cnt_1s ; } _reg_write_1 ( SH_ ( TSTR ) , 0 ) ; } 