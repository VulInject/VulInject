static int xenon_probe ( struct platform_device * pdev ) { struct sdhci_pltfm_host * pltfm_host ; struct sdhci_host * host ; struct xenon_priv * priv ; int err ; host = sdhci_pltfm_init ( pdev , & sdhci_xenon_pdata , sizeof ( xenon_priv ) ) ; if ( IS_ERR ( host ) ) { return PTR_ERR ( host ) ; } pltfm_host = sdhci_priv ( host ) ; priv = sdhci_pltfm_priv ( pltfm_host ) ; xenon_replace_mmc_host_ops ( host ) ; pltfm_host -> clk = devm_clk_get ( & pdev -> dev , "core" ) ; if ( IS_ERR ( pltfm_host -> clk ) ) { err = PTR_ERR ( pltfm_host -> clk ) ; dev_err ( & pdev -> dev , "Failed to setup input clk: %d\n" , err ) ; free_pltfm } err = clk_prepare_enable ( pltfm_host -> clk ) ; if ( err ) { free_pltfm } err = mmc_of_parse ( host -> mmc ) ; if ( err ) { err_clk } sdhci_get_of_property ( pdev ) ; xenon_set_acg ( host , false ) ; err = xenon_probe_dt ( pdev ) ; if ( err ) { err_clk } err = xenon_sdhc_prepare ( host ) ; if ( err ) { clean_phy_param } err = sdhci_add_host ( host ) ; if ( err ) { remove_sdhc } return 0 ; remove_sdhc xenon_sdhc_unprepare ( host ) ; clean_phy_param xenon_clean_phy ( host ) ; err_clk clk_disable_unprepare ( pltfm_host -> clk ) ; free_pltfm return err ; } 