void CheckSoftProofing ( void ) { cmsHPROFILE hRGB1 = cmsOpenProfileFromFile ( PROFILES_DIR "test5.icc" , "r" ) ; cmsHPROFILE hRGB2 = cmsOpenProfileFromFile ( PROFILES_DIR "test3.icc" , "r" ) ; cmsContext noPlugin = cmsCreateContext ( 0 , 0 ) ; cmsHTRANSFORM hXformNoPlugin = cmsCreateProofingTransformTHR ( noPlugin , hRGB1 , TYPE_RGB_FLT , hRGB1 , TYPE_RGB_FLT , hRGB2 , INTENT_RELATIVE_COLORIMETRIC , INTENT_RELATIVE_COLORIMETRIC , cmsFLAGS_GAMUTCHECK | cmsFLAGS_SOFTPROOFING ) ; cmsUInt32Number Mb , j , r , g , b ; Scanline_rgbFloat * In ; Scanline_rgbFloat * Out1 , * Out2 ; trace ( "Checking soft proofing and gamut check ..." ) ; cmsCloseProfile ( hRGB1 ) ; cmsCloseProfile ( hRGB2 ) ; Mb = 256 * 256 * 256 * sizeof ( Scanline_rgbFloat ) ; In = ( Scanline_rgbFloat * ) malloc ( Mb ) ; Out1 = ( Scanline_rgbFloat * ) malloc ( Mb ) ; Out2 = ( Scanline_rgbFloat * ) malloc ( Mb ) ; j = 0 ; for ( r = 0 ; r < 256 ; r ++ ) { for ( g = 0 ; g < 256 ; g ++ ) { for ( b = 0 ; b < 256 ; b ++ ) { In [ j ] . r = ( cmsFloat32Number ) r / 255.0f ; In [ j ] . g = ( cmsFloat32Number ) g / 255.0f ; In [ j ] . b = ( cmsFloat32Number ) b / 255.0f ; j ++ ; } } } cmsDoTransform ( hXformNoPlugin , In , Out1 , 256 * 256 * 256 ) ; cmsDoTransform ( hXformPlugin , In , Out2 , 256 * 256 * 256 ) ; j = 0 ; for ( r = 0 ; r < 256 ; r ++ ) { for ( g = 0 ; g < 256 ; g ++ ) { for ( b = 0 ; b < 256 ; b ++ ) { if ( ! ValidFloat ( Out1 [ j ] . r , Out2 [ j ] . r ) || ! ValidFloat ( Out1 [ j ] . g , Out2 [ j ] . g ) || ! ValidFloat ( Out1 [ j ] . b , Out2 [ j ] . b ) ) { Fail ( "Conversion failed at (%f %f %f) != (%f %f %f)" , Out1 [ j ] . r , Out1 [ j ] . g , Out1 [ j ] . b , Out2 [ j ] . r , Out2 [ j ] . g , Out2 [ j ] . b ) ; } j ++ ; } } } free ( In ) ; free ( Out1 ) ; free ( Out2 ) ; cmsDeleteTransform ( hXformNoPlugin ) ; cmsDeleteTransform ( hXformPlugin ) ; cmsDeleteContext ( noPlugin ) ; trace ( "Ok\n" ) ; } 