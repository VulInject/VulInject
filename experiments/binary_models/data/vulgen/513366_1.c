static BOOL autodetect_send_bandwidth_measure_stop ( rdpAutoDetect * autodetect , RDP_TRANSPORT_TYPE transport , UINT16 payloadLength , UINT16 sequenceNumber , UINT16 requestType ) { wStream * s ; WINPR_ASSERT ( autodetect ) ; WINPR_ASSERT ( autodetect -> context ) ; s = rdp_message_channel_pdu_init ( autodetect -> context -> rdp ) ; if ( ! s ) { return FALSE ; } WLog_VRB ( AUTODETECT_TAG , "sending Bandwidth Measure Stop PDU ->payloadLength=%" PRIu16 "" , payloadLength ) ; payloadLength &= ~ 3 ; Stream_Write_UINT8 ( s , requestType == RDP_BW_STOP_REQUEST_TYPE_CONNECTTIME ?0x08 : 0x06 ) ; Stream_Write_UINT8 ( s , TYPE_ID_AUTODETECT_REQUEST ) ; Stream_Write_UINT16 ( s , sequenceNumber ) ; Stream_Write_UINT16 ( s , requestType ) ; if ( requestType == RDP_BW_STOP_REQUEST_TYPE_CONNECTTIME ) { Stream_Write_UINT16 ( s , payloadLength ) ; if ( payloadLength > 0 ) { if ( ! Stream_EnsureRemainingCapacity ( s , payloadLength ) ) { WLog_ERR ( AUTODETECT_TAG , "Failed to ensure %" PRIuz " bytes in stream" , payloadLength ) ; return FALSE ; } winpr_RAND ( Stream_Pointer ( s ) , payloadLength ) ; Stream_Seek ( s , payloadLength ) ; } } return rdp_send_message_channel_pdu ( autodetect -> context -> rdp , s , SEC_AUTODETECT_REQ ) ; } 