static int varlink_dispatch_method ( Varlink * v ) { _cleanup_ ( ) JsonVariant * parameters = NULL ; VarlinkMethodFlags flags = 0 ; const char * method = NULL , * error ; JsonVariant * e ; VarlinkMethod callback ; const char * k ; int r ; assert ( v ) ; if ( v -> state != VARLINK_IDLE_SERVER ) { return 0 ; } if ( ! v -> current ) { return 0 ; } if ( ! json_variant_is_object ( v -> current ) ) { invalid } JSON_VARIANT_OBJECT_FOREACH ( , , ) { if ( streq ( k , "method" ) ) { if ( method ) { invalid } if ( ! json_variant_is_string ( e ) ) { invalid } method = json_variant_string ( e ) ; } if ( streq ( k , "parameters" ) ) { if ( parameters ) { invalid } if ( ! json_variant_is_object ( e ) ) { invalid } parameters = json_variant_ref ( e ) ; } if ( streq ( k , "oneway" ) ) { if ( ( flags & ( VARLINK_METHOD_ONEWAY | VARLINK_METHOD_MORE ) ) != 0 ) { invalid } if ( ! json_variant_is_boolean ( e ) ) { invalid } if ( json_variant_boolean ( e ) ) { flags |= VARLINK_METHOD_ONEWAY ; } } if ( streq ( k , "more" ) ) { if ( ( flags & ( VARLINK_METHOD_ONEWAY | VARLINK_METHOD_MORE ) ) != 0 ) { invalid } if ( ! json_variant_is_boolean ( e ) ) { invalid } if ( json_variant_boolean ( e ) ) { flags |= VARLINK_METHOD_MORE ; } } else { invalid } } if ( ! method ) { invalid } r = varlink_sanitize_parameters ( & parameters ) ; if ( r < 0 ) { fail } varlink_set_state ( v , ( flags & VARLINK_METHOD_MORE ) ?VARLINK_PROCESSING_METHOD_MORE : ( flags & VARLINK_METHOD_ONEWAY ) ?VARLINK_PROCESSING_METHOD_ONEWAY : VARLINK_PROCESSING_METHOD ) ; assert ( v -> server ) ; if ( STR_IN_SET ( method , "org.varlink.service.GetInfo" , "org.varlink.service.GetInterface" ) ) { callback = NULL ; error = VARLINK_ERROR_METHOD_NOT_IMPLEMENTED ; } if ( startswith ( method , "org.varlink.service." ) ) { callback = NULL ; error = VARLINK_ERROR_METHOD_NOT_FOUND ; } else { callback = hashmap_get ( v -> server -> methods , method ) ; error = VARLINK_ERROR_METHOD_NOT_FOUND ; } if ( callback ) { r = callback ( v , parameters , flags , v -> userdata ) ; if ( r < 0 ) { log_debug_errno ( r , "Callback for %s returned error: %m" , method ) ; if ( ! FLAGS_SET ( flags , VARLINK_METHOD_ONEWAY ) ) { r = varlink_error_errno ( v , r ) ; if ( r < 0 ) { return r ; } } } } if ( ! FLAGS_SET ( flags , VARLINK_METHOD_ONEWAY ) ) { assert ( error ) ; r = varlink_errorb ( v , error , JSON_BUILD_OBJECT ( JSON_BUILD_PAIR ( "method" , JSON_BUILD_STRING ( method ) ) ) ) ; } switch ( v -> state ) { case VARLINK_PROCESSED_METHOD : case VARLINK_PROCESSING_METHOD_ONEWAY : v -> current = json_variant_unref ( v -> current ) ; varlink_set_state ( v , VARLINK_IDLE_SERVER ) ; break ; case VARLINK_PROCESSING_METHOD : varlink_set_state ( v , VARLINK_PENDING_METHOD ) ; break ; case VARLINK_PROCESSING_METHOD_MORE : varlink_set_state ( v , VARLINK_PENDING_METHOD_MORE ) ; break ; default : assert_not_reached ( ) ; } return r ; invalid r = - EINVAL ; fail varlink_set_state ( v , VARLINK_PROCESSING_FAILURE ) ; varlink_dispatch_local_error ( v , VARLINK_ERROR_PROTOCOL ) ; varlink_close ( v ) ; return r ; } 