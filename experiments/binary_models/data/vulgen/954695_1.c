static DWORD WINAPI drive_hotplug_thread_func ( LPVOID arg ) { rdpdrPlugin * rdpdr ; UINT error = 0 ; rdpdr = ( rdpdrPlugin * ) arg ; WINPR_ASSERT ( rdpdr ) ; WINPR_ASSERT ( ! rdpdr -> stopEvent ) ; if ( ! rdpdr -> stopEvent ) { out } while ( WaitForSingleObject ( rdpdr -> stopEvent , 1000 ) == WAIT_TIMEOUT ) { error = handle_hotplug ( rdpdr ) ; switch ( error ) { case ERROR_DISK_CHANGE : rdpdr_send_device_list_announce_request ( rdpdr , TRUE ) ; break ; case CHANNEL_RC_OK : case ERROR_OPEN_FAILED : case ERROR_CALL_NOT_IMPLEMENTED : break ; default : WLog_Print ( rdpdr -> log , WLOG_ERROR , "handle_hotplug failed with error %" PRIu32 "!" , error ) ; out } } out error = GetLastError ( ) ; if ( error && rdpdr -> rdpcontext ) { setChannelError ( rdpdr -> rdpcontext , error , "reported an error" ) ; } if ( rdpdr -> stopEvent ) { CloseHandle ( rdpdr -> stopEvent ) ; rdpdr -> stopEvent = NULL ; } ExitThread ( error ) ; return error ; } 