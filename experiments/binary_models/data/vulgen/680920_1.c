static void am335x_tscadc_need_adc ( struct ti_tscadc_dev * tscadc ) { DEFINE_WAIT ( wait ) ; u32 reg ; regmap_read ( tscadc -> regmap , REG_ADCFSM , & reg ) ; if ( reg & SEQ_STATUS ) { tscadc -> adc_waiting = true ; prepare_to_wait ( & tscadc -> reg_se_wait , & wait , TASK_UNINTERRUPTIBLE ) ; spin_unlock_irq ( & tscadc -> reg_lock ) ; schedule ( ) ; spin_lock_irq ( & tscadc -> reg_lock ) ; finish_wait ( & tscadc -> reg_se_wait , & wait ) ; regmap_read ( tscadc -> regmap , REG_ADCFSM , & reg ) ; tscadc -> adc_waiting = false ; } tscadc -> adc_in_use = true ; } 