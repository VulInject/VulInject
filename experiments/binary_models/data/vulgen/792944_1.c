static void emmaprp_device_run ( void * priv ) { struct emmaprp_ctx * ctx = priv ; struct emmaprp_q_data * s_q_data , * d_q_data ; struct vb2_v4l2_buffer * src_buf , * dst_buf ; struct emmaprp_dev * pcdev = ctx -> dev ; unsigned int s_width , s_height ; unsigned int d_width , d_height ; unsigned int d_size ; dma_addr_t p_in , p_out ; u32 tmp ; src_buf = v4l2_m2m_next_src_buf ( ctx -> fh . m2m_ctx ) ; dst_buf = v4l2_m2m_next_dst_buf ( ctx -> fh . m2m_ctx ) ; s_q_data = get_q_data ( ctx , V4L2_BUF_TYPE_VIDEO_OUTPUT ) ; s_width = s_q_data -> width ; s_height = s_q_data -> height ; d_q_data = get_q_data ( ctx , V4L2_BUF_TYPE_VIDEO_CAPTURE ) ; d_width = d_q_data -> width ; d_height = d_q_data -> height ; d_size = d_width * d_height ; p_in = vb2_dma_contig_plane_dma_addr ( & src_buf -> vb2_buf , 0 ) ; p_out = vb2_dma_contig_plane_dma_addr ( & dst_buf -> vb2_buf , 0 ) ; writel ( p_in , pcdev -> base_emma + PRP_SOURCE_Y_PTR ) ; writel ( PRP_SIZE_WIDTH ( s_width ) | PRP_SIZE_HEIGHT ( s_height ) , pcdev -> base_emma + PRP_SRC_FRAME_SIZE ) ; writel ( p_out , pcdev -> base_emma + PRP_DEST_Y_PTR ) ; writel ( p_out + d_size , pcdev -> base_emma + PRP_DEST_CB_PTR ) ; writel ( p_out + d_size + ( d_size >> 2 ) , pcdev -> base_emma + PRP_DEST_CR_PTR ) ; writel ( PRP_SIZE_WIDTH ( d_width ) | PRP_SIZE_HEIGHT ( d_height ) , pcdev -> base_emma + PRP_CH2_OUT_IMAGE_SIZE ) ; tmp = readl ( pcdev -> base_emma + PRP_INTR_CNTL ) ; writel ( tmp | PRP_INTR_RDERR | PRP_INTR_CH2WERR | PRP_INTR_CH2FC , pcdev -> base_emma + PRP_INTR_CNTL ) ; emmaprp_dump_regs ( pcdev ) ; tmp = readl ( pcdev -> base_emma + PRP_CNTL ) ; writel ( tmp | PRP_CNTL_CH2_OUT_YUV420 | PRP_CNTL_DATA_IN_YUV422 | PRP_CNTL_CH2EN , pcdev -> base_emma + PRP_CNTL ) ; } 