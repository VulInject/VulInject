static void zonemd_verify_test ( char * zname , char * zfile , char * tastr , char * date_override , char * result_wanted ) { time_t now = 0 ; struct module_stack mods ; struct module_env env ; char * result = NULL ; struct auth_zone * z ; memset ( & mods , 0 , sizeof ( mods ) ) ; memset ( & env , 0 , sizeof ( env ) ) ; env . scratch = regional_create ( ) ; if ( ! env . scratch ) { fatal_exit ( "out of memory" ) ; } env . scratch_buffer = sldns_buffer_new ( 65553 ) ; if ( ! env . scratch_buffer ) { fatal_exit ( "out of memory" ) ; } env . cfg = config_create ( ) ; if ( ! env . cfg ) { fatal_exit ( "out of memory" ) ; } env . now = & now ; env . cfg -> val_date_override = cfg_convert_timeval ( date_override ) ; if ( ! env . cfg -> val_date_override ) { fatal_exit ( "could not parse datetime %s" , date_override ) ; } if ( env . cfg -> module_conf ) { free ( env . cfg -> module_conf ) ; } env . cfg -> module_conf = strdup ( "validator iterator" ) ; if ( ! env . cfg -> module_conf ) { fatal_exit ( "out of memory" ) ; } if ( tastr ) { if ( ! cfg_strlist_insert ( & env . cfg -> trust_anchor_list , strdup ( tastr ) ) ) { fatal_exit ( "out of memory" ) ; } } env . anchors = anchors_create ( ) ; if ( ! env . anchors ) { fatal_exit ( "out of memory" ) ; } env . auth_zones = auth_zones_create ( ) ; if ( ! env . auth_zones ) { fatal_exit ( "out of memory" ) ; } modstack_init ( & mods ) ; if ( ! modstack_setup ( & mods , env . cfg -> module_conf , & env ) ) { fatal_exit ( "could not modstack_setup" ) ; } env . mesh = mesh_create ( & mods , & env ) ; if ( ! env . mesh ) { fatal_exit ( "out of memory" ) ; } z = authtest_addzone ( env . auth_zones , zname , zfile ) ; if ( ! z ) { fatal_exit ( "could not addzone %s %s" , zname , zfile ) ; } lock_rw_wrlock ( & z -> lock ) ; z -> zonemd_check = 1 ; auth_zone_verify_zonemd ( z , & env , & mods , & result , 1 , 0 ) ; lock_rw_unlock ( & z -> lock ) ; if ( verbosity >= VERB_ALGO ) { printf ( "auth zone %s: ZONEMD verification %s: %s\n" , zname , ( strcmp ( result , "ZONEMD verification successful" ) == 0 ?"successful" : "failed" ) , result ) ; } if ( ! result ) { fatal_exit ( "out of memory" ) ; } unit_assert ( strcmp ( result , result_wanted ) == 0 ) ; if ( strcmp ( result , "ZONEMD verification successful" ) == 0 || strcmp ( result , "DNSSEC verified nonexistence of ZONEMD" ) == 0 || strcmp ( result , "no ZONEMD present" ) == 0 ) { lock_rw_rdlock ( & z -> lock ) ; unit_assert ( ! z -> zone_expired ) ; lock_rw_unlock ( & z -> lock ) ; } else { lock_rw_rdlock ( & z -> lock ) ; unit_assert ( z -> zone_expired ) ; lock_rw_unlock ( & z -> lock ) ; } mesh_delete ( env . mesh ) ; modstack_desetup ( & mods , & env ) ; auth_zones_delete ( env . auth_zones ) ; anchors_delete ( env . anchors ) ; config_delete ( env . cfg ) ; regional_destroy ( env . scratch ) ; sldns_buffer_free ( env . scratch_buffer ) ; if ( verbosity >= VERB_ALGO ) { printf ( "\n" ) ; } } 