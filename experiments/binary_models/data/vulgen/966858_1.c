static int lpfc_sli_enable_msix ( struct lpfc_hba * phba ) { int rc ; LPFC_MBOXQ_t * pmb ; rc = pci_alloc_irq_vectors ( phba -> pcidev , LPFC_MSIX_VECTORS , LPFC_MSIX_VECTORS , PCI_IRQ_MSIX ) ; if ( rc < 0 ) { lpfc_printf_log ( phba , KERN_INFO , LOG_INIT , "0420 PCI enable MSI-X failed (%d)\n" , rc ) ; vec_fail_out } rc = request_irq ( pci_irq_vector ( phba -> pcidev , 0 ) , & lpfc_sli_sp_intr_handler , 0 , LPFC_SP_DRIVER_HANDLER_NAME , phba ) ; if ( rc ) { lpfc_printf_log ( phba , KERN_WARNING , LOG_INIT , "0421 MSI-X slow-path request_irq failed " "(%d)\n" , rc ) ; msi_fail_out } rc = request_irq ( pci_irq_vector ( phba -> pcidev , 1 ) , & lpfc_sli_fp_intr_handler , 0 , LPFC_FP_DRIVER_HANDLER_NAME , phba ) ; if ( rc ) { lpfc_printf_log ( phba , KERN_WARNING , LOG_INIT , "0429 MSI-X fast-path request_irq failed " "(%d)\n" , rc ) ; irq_fail_out } pmb = ( LPFC_MBOXQ_t * ) mempool_alloc ( phba -> mbox_mem_pool , GFP_KERNEL ) ; if ( ! pmb ) { rc = - ENOMEM ; lpfc_printf_log ( phba , KERN_ERR , LOG_INIT , "0474 Unable to allocate memory for issuing " "MBOX_CONFIG_MSI command\n" ) ; mem_fail_out } rc = lpfc_config_msi ( phba , pmb ) ; if ( rc ) { mbx_fail_out } rc = lpfc_sli_issue_mbox ( phba , pmb , MBX_POLL ) ; mempool_free ( pmb , phba -> mbox_mem_pool ) ; return rc ; mbx_fail_out mempool_free ( pmb , phba -> mbox_mem_pool ) ; mem_fail_out free_irq ( pci_irq_vector ( phba -> pcidev , 1 ) , phba ) ; irq_fail_out free_irq ( pci_irq_vector ( phba -> pcidev , 0 ) , phba ) ; msi_fail_out pci_free_irq_vectors ( phba -> pcidev ) ; vec_fail_out return rc ; } 