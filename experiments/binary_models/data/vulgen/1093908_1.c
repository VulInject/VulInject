struct phy_device * fixed_phy_register ( unsigned int irq , struct fixed_phy_status * status , int link_gpio , struct device_node * np ) { struct fixed_mdio_bus * fmb = & platform_fmb ; struct phy_device * phy ; int phy_addr ; int ret ; if ( ! fmb -> mii_bus || fmb -> mii_bus -> state != MDIOBUS_REGISTERED ) { return ERR_PTR ( - EPROBE_DEFER ) ; } phy_addr = ida_simple_get ( & phy_fixed_ida , 0 , PHY_MAX_ADDR , GFP_KERNEL ) ; if ( phy_addr < 0 ) { return ERR_PTR ( phy_addr ) ; } ret = fixed_phy_add ( irq , phy_addr , status , link_gpio ) ; if ( ret < 0 ) { ida_simple_remove ( & phy_fixed_ida , phy_addr ) ; return ERR_PTR ( ret ) ; } phy = get_phy_device ( fmb -> mii_bus , phy_addr , false ) ; if ( IS_ERR ( phy ) ) { return ERR_PTR ( - EINVAL ) ; } phy -> link = status -> link ; if ( status -> link ) { phy -> speed = status -> speed ; phy -> duplex = status -> duplex ; phy -> pause = status -> pause ; phy -> asym_pause = status -> asym_pause ; } of_node_get ( np ) ; phy -> mdio . dev . of_node = np ; phy -> is_pseudo_fixed_link = true ; switch ( status -> speed ) { case SPEED_1000 : phy -> supported = PHY_1000BT_FEATURES ; break ; case SPEED_100 : phy -> supported = PHY_100BT_FEATURES ; break ; case SPEED_10 : default : phy -> supported = PHY_10BT_FEATURES ; } ret = phy_device_register ( phy ) ; if ( ret ) { phy_device_free ( phy ) ; of_node_put ( np ) ; fixed_phy_del ( phy_addr ) ; return ERR_PTR ( ret ) ; } return phy ; } 