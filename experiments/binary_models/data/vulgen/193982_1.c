static void nb8800_receive ( struct net_device * dev , unsigned int i , unsigned int len ) { struct nb8800_priv * priv = netdev_priv ( dev ) ; struct nb8800_rx_desc * rxd = & priv -> rx_descs [ i ] ; struct page * page = priv -> rx_bufs [ i ] . page ; int offset = priv -> rx_bufs [ i ] . offset ; void * data = page_address ( page ) + offset ; dma_addr_t dma = rxd -> desc . s_addr ; struct sk_buff * skb ; unsigned int size ; int err ; size = len <= RX_COPYBREAK ?len : RX_COPYHDR ; skb = napi_alloc_skb ( & priv -> napi , size ) ; if ( ! skb ) { netdev_err ( dev , "rx skb allocation failed\n" ) ; dev -> stats . rx_dropped ++ ; return ; } if ( len <= RX_COPYBREAK ) { dma_sync_single_for_cpu ( & dev -> dev , dma , len , DMA_FROM_DEVICE ) ; memcpy ( skb_put ( skb , len ) , data , len ) ; dma_sync_single_for_device ( & dev -> dev , dma , len , DMA_FROM_DEVICE ) ; } else { err = nb8800_alloc_rx ( dev , i , true ) ; if ( err ) { netdev_err ( dev , "rx buffer allocation failed\n" ) ; dev -> stats . rx_dropped ++ ; return ; } dma_unmap_page ( & dev -> dev , dma , RX_BUF_SIZE , DMA_FROM_DEVICE ) ; memcpy ( skb_put ( skb , RX_COPYHDR ) , data , RX_COPYHDR ) ; skb_add_rx_frag ( skb , skb_shinfo ( skb ) -> nr_frags , page , offset + RX_COPYHDR , len - RX_COPYHDR , RX_BUF_SIZE ) ; } skb -> protocol = eth_type_trans ( skb , dev ) ; napi_gro_receive ( & priv -> napi , skb ) ; } 