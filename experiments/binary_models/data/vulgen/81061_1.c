uintptr_t h2o_error_reporter_record_error ( h2o_loop_t * loop , h2o_error_reporter_t * reporter , uint64_t delay_ticks , uintptr_t new_data ) { uintptr_t old_data ; pthread_mutex_lock ( & reporter -> _mutex ) ; if ( reporter -> cur_errors == 0 ) { assert ( ! h2o_timer_is_linked ( & reporter -> _timer ) ) ; h2o_timer_link ( loop , delay_ticks , & reporter -> _timer ) ; } ++ reporter -> cur_errors ; old_data = reporter -> data ; reporter -> data = new_data ; pthread_mutex_unlock ( & reporter -> _mutex ) ; return old_data ; } 