static int cms_kari_create_ephemeral_key ( CMS_KeyAgreeRecipientInfo * kari , EVP_PKEY * pk ) { EVP_PKEY_CTX * pctx = NULL ; EVP_PKEY * ekey = NULL ; int rv = 0 ; pctx = EVP_PKEY_CTX_new ( pk , NULL ) ; if ( EVP_PKEY_keygen_init ( pctx ) <= 0 ) { err } if ( EVP_PKEY_keygen ( pctx , & ekey ) <= 0 ) { err } EVP_PKEY_CTX_free ( pctx ) ; pctx = EVP_PKEY_CTX_new ( ekey , NULL ) ; if ( ! pctx ) { err } if ( EVP_PKEY_derive_init ( pctx ) <= 0 ) { err } kari -> pctx = pctx ; rv = 1 ; err if ( ! rv ) { EVP_PKEY_CTX_free ( pctx ) ; } EVP_PKEY_free ( ekey ) ; return rv ; } 