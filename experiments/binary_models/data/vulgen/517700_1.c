static locked_range_t * rangelock_proxify ( avl_tree_t * tree , locked_range_t * lr ) { locked_range_t * proxy ; if ( lr -> lr_proxy ) { return ( lr ) ; } ASSERT3U ( lr -> lr_count , == , 1 ) ; ASSERT ( lr -> lr_write_wanted == B_FALSE ) ; ASSERT ( lr -> lr_read_wanted == B_FALSE ) ; avl_remove ( tree , lr ) ; lr -> lr_count = 0 ; proxy = kmem_alloc ( sizeof ( locked_range_t ) , KM_SLEEP ) ; proxy -> lr_offset = lr -> lr_offset ; proxy -> lr_count = 1 ; proxy -> lr_type = RL_READER ; proxy -> lr_proxy = B_TRUE ; proxy -> lr_write_wanted = B_FALSE ; proxy -> lr_read_wanted = B_FALSE ; avl_add ( tree , proxy ) ; return ( proxy ) ; } 