static int SwapPages ( void * dest , void * start , void * end ) { int destfromback ; AddressSpaceReservation_t * destaddr = AddressSpaceFromMem ( & destfromback , dest ) , * srcaddr = AddressSpaceFromMem ( 0 , start ) ; size_t pages , n , freepages = 0 , usedpages = 0 , destpfidx = ( ( size_t ) dest - ( size_t ) destaddr ) / PAGE_SIZE , srcpfidx = ( ( size_t ) start - ( size_t ) srcaddr ) / PAGE_SIZE ; PageMapping * RESTRICT destpf , * RESTRICT srcpf ; void * destptr , * srcptr ; RemapMemoryPagesBlock memtodecommit , memtocommit ; memtodecommit . idx = memtocommit . idx = 0 ; pages = ( ( size_t ) end - ( size_t ) start ) / PAGE_SIZE ; destptr = dest ; destpf = destaddr -> pagemapping + destpfidx ; srcptr = start ; srcpf = srcaddr -> pagemapping + srcpfidx ; for ( n = 0 ; n < pages ; n ++ , destptr = ( void * ) ( ( size_t ) destptr + PAGE_SIZE ) , destpf ++ , srcptr = ( void * ) ( ( size_t ) srcptr + PAGE_SIZE ) , srcpf ++ ) { PageMapping t ; int srcIsFree = srcpf -> pageframe && ISPAGEFREE ( * srcpf ) ; int destIsFree = destpf -> pageframe && ISPAGEFREE ( * destpf ) ; assert ( srcpf -> pageframe ) ; assert ( ! srcIsFree ) ; if ( srcpf -> pageframe ) { memtodecommit . addrs [ memtodecommit . idx ] = srcptr ; if ( REMAPMEMORYPAGESBLOCKSIZE == ++ memtodecommit . idx ) { SwapPagesBatchDecommit ( srcaddr , & memtodecommit ) ; } } if ( destpf -> pageframe ) { memtodecommit . addrs [ memtodecommit . idx ] = destptr ; if ( REMAPMEMORYPAGESBLOCKSIZE == ++ memtodecommit . idx ) { SwapPagesBatchDecommit ( destaddr , & memtodecommit ) ; } } t = * destpf ; * destpf = * srcpf ; * srcpf = t ; if ( ( srcIsFree && destIsFree ) || ( ! srcIsFree && ! destIsFree ) ) { if ( srcIsFree ) { assert ( srcpf -> freepagenode -> freepage == destaddr ) ; } if ( destIsFree ) { assert ( destpf -> freepagenode -> freepage == srcaddr ) ; } } else { FreePageNode * RESTRICT fpn = srcIsFree ?srcpf -> freepagenode : destpf -> freepagenode ; void * newaddr = srcIsFree ?srcaddr : destaddr ; if ( srcIsFree ) { assert ( srcpf -> freepagenode -> freepage == destaddr ) ; } if ( destIsFree ) { assert ( destpf -> freepagenode -> freepage == srcaddr ) ; } fpn -> freepage = newaddr ; } if ( srcpf -> pageframe ) { memtocommit . addrs [ memtocommit . idx ] = srcptr ; memtocommit . pageframes [ memtocommit . idx ] = PAGEFRAME ( * srcpf ) ; if ( REMAPMEMORYPAGESBLOCKSIZE == ++ memtocommit . idx ) { SwapPagesBatchCommit ( srcaddr , & memtodecommit , & memtocommit ) ; } if ( srcIsFree ) { freepages -- ; } else { usedpages -- ; } } if ( destpf -> pageframe ) { memtocommit . addrs [ memtocommit . idx ] = destptr ; memtocommit . pageframes [ memtocommit . idx ] = PAGEFRAME ( * destpf ) ; if ( destIsFree ) { freepages ++ ; } else { usedpages ++ ; } } } SwapPagesBatchCommit ( destaddr , & memtodecommit , & memtocommit ) ; srcaddr -> freepages -= freepages ; srcaddr -> usedpages -= usedpages ; destaddr -> freepages += freepages ; destaddr -> usedpages += usedpages ; ValidateFreePageLists ( destaddr ) ; ValidatePageMappings ( destaddr ) ; return 1 ; } 