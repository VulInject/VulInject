static int nouveau_drm_device_init ( struct drm_device * dev ) { struct nouveau_drm * drm ; int ret ; if ( ! ( drm = kzalloc ( sizeof ( * drm ) , GFP_KERNEL ) ) ) { return - ENOMEM ; } dev -> dev_private = drm ; drm -> dev = dev ; nvif_parent_ctor ( & nouveau_parent , & drm -> parent ) ; drm -> master . base . object . parent = & drm -> parent ; ret = nouveau_cli_init ( drm , "DRM-master" , & drm -> master ) ; if ( ret ) { fail_alloc } ret = nouveau_cli_init ( drm , "DRM" , & drm -> client ) ; if ( ret ) { fail_master } nvxx_client ( & drm -> client . base ) -> debug = nvkm_dbgopt ( nouveau_debug , "DRM" ) ; INIT_LIST_HEAD ( & drm -> clients ) ; spin_lock_init ( & drm -> tile . lock ) ; if ( drm -> client . device . info . chipset == 0xc1 ) { nvif_mask ( & drm -> client . device . object , 0x00088080 , 0x00000800 , 0x00000000 ) ; } nouveau_vga_init ( drm ) ; ret = nouveau_ttm_init ( drm ) ; if ( ret ) { fail_ttm } ret = nouveau_bios_init ( dev ) ; if ( ret ) { fail_bios } nouveau_accel_init ( drm ) ; ret = nouveau_display_create ( dev ) ; if ( ret ) { fail_dispctor } if ( dev -> mode_config . num_crtc ) { ret = nouveau_display_init ( dev , false , false ) ; if ( ret ) { fail_dispinit } } nouveau_debugfs_init ( drm ) ; nouveau_hwmon_init ( dev ) ; nouveau_svm_init ( drm ) ; nouveau_dmem_init ( drm ) ; nouveau_led_init ( dev ) ; if ( nouveau_pmops_runtime ( ) ) { pm_runtime_use_autosuspend ( dev -> dev ) ; pm_runtime_set_autosuspend_delay ( dev -> dev , 5000 ) ; pm_runtime_set_active ( dev -> dev ) ; pm_runtime_allow ( dev -> dev ) ; pm_runtime_mark_last_busy ( dev -> dev ) ; pm_runtime_put ( dev -> dev ) ; } return 0 ; fail_dispinit nouveau_display_destroy ( dev ) ; fail_dispctor nouveau_accel_fini ( drm ) ; nouveau_bios_takedown ( dev ) ; fail_bios nouveau_ttm_fini ( drm ) ; fail_ttm nouveau_vga_fini ( drm ) ; nouveau_cli_fini ( & drm -> client ) ; fail_master nouveau_cli_fini ( & drm -> master ) ; fail_alloc nvif_parent_dtor ( & drm -> parent ) ; kfree ( drm ) ; return ret ; } 