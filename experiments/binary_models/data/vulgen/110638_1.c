static int mwl8k_firmware_load_success ( struct mwl8k_priv * priv ) { struct ieee80211_hw * hw = priv -> hw ; int i , rc ; rc = mwl8k_load_firmware ( hw ) ; mwl8k_release_firmware ( priv ) ; if ( rc ) { wiphy_err ( hw -> wiphy , "Cannot start firmware\n" ) ; return rc ; } hw -> extra_tx_headroom = sizeof ( mwl8k_dma_data ) - sizeof ( ieee80211_cts ) ; hw -> extra_tx_headroom -= priv -> ap_fw ?REDUCED_TX_HEADROOM : 0 ; hw -> queues = MWL8K_TX_WMM_QUEUES ; ieee80211_hw_set ( hw , SIGNAL_DBM ) ; ieee80211_hw_set ( hw , HAS_RATE_CONTROL ) ; if ( priv -> ap_fw ) { ieee80211_hw_set ( hw , AP_LINK_PS ) ; } hw -> vif_data_size = sizeof ( mwl8k_vif ) ; hw -> sta_data_size = sizeof ( mwl8k_sta ) ; priv -> macids_used = 0 ; INIT_LIST_HEAD ( & priv -> vif_list ) ; priv -> radio_on = false ; priv -> radio_short_preamble = false ; INIT_WORK ( & priv -> finalize_join_worker , mwl8k_finalize_join_worker ) ; INIT_WORK ( & priv -> watchdog_ba_handle , mwl8k_watchdog_ba_events ) ; INIT_WORK ( & priv -> fw_reload , mwl8k_hw_restart_work ) ; tasklet_init ( & priv -> poll_tx_task , mwl8k_tx_poll , ( unsigned long ) hw ) ; tasklet_disable ( & priv -> poll_tx_task ) ; tasklet_init ( & priv -> poll_rx_task , mwl8k_rx_poll , ( unsigned long ) hw ) ; tasklet_disable ( & priv -> poll_rx_task ) ; priv -> cookie = pci_alloc_consistent ( priv -> pdev , 4 , & priv -> cookie_dma ) ; if ( priv -> cookie == NULL ) { return - ENOMEM ; } mutex_init ( & priv -> fw_mutex ) ; priv -> fw_mutex_owner = NULL ; priv -> fw_mutex_depth = 0 ; priv -> hostcmd_wait = NULL ; spin_lock_init ( & priv -> tx_lock ) ; spin_lock_init ( & priv -> stream_lock ) ; priv -> tx_wait = NULL ; rc = mwl8k_probe_hw ( hw ) ; if ( rc ) { err_free_cookie } hw -> wiphy -> interface_modes = 0 ; if ( priv -> ap_macids_supported || priv -> device_info -> fw_image_ap ) { hw -> wiphy -> interface_modes |= BIT ( NL80211_IFTYPE_AP ) ; hw -> wiphy -> interface_modes |= BIT ( NL80211_IFTYPE_STATION ) ; hw -> wiphy -> iface_combinations = & ap_if_comb ; hw -> wiphy -> n_iface_combinations = 1 ; } if ( priv -> sta_macids_supported || priv -> device_info -> fw_image_sta ) { hw -> wiphy -> interface_modes |= BIT ( NL80211_IFTYPE_STATION ) ; } wiphy_ext_feature_set ( hw -> wiphy , NL80211_EXT_FEATURE_CQM_RSSI_LIST ) ; rc = ieee80211_register_hw ( hw ) ; if ( rc ) { wiphy_err ( hw -> wiphy , "Cannot register device\n" ) ; err_unprobe_hw } return 0 ; err_unprobe_hw for ( i = 0 ; i < mwl8k_tx_queues ( priv ) ; i ++ ) { mwl8k_txq_deinit ( hw , i ) ; } mwl8k_rxq_deinit ( hw , 0 ) ; err_free_cookie return rc ; } 