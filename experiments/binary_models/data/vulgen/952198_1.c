void resume_mp ( void ) { struct cpu_info * ci ; struct proc * p ; struct pcb * pcb ; struct trapframe * tf ; struct switchframe * sf ; int i ; for ( i = 0 ; i < MAXCPUS ; i ++ ) { ci = cpu_info [ i ] ; if ( ci == NULL ) { continue ; } if ( ci -> ci_idle_pcb == NULL ) { continue ; } if ( ci -> ci_flags & ( CPUF_BSP | CPUF_SP | CPUF_PRIMARY ) ) { continue ; } KASSERT ( ( ci -> ci_flags & CPUF_RUNNING ) == 0 ) ; p = ci -> ci_schedstate . spc_idleproc ; pcb = & p -> p_addr -> u_pcb ; tf = ( trapframe * ) pcb -> pcb_kstack - 1 ; sf = ( switchframe * ) tf - 1 ; sf -> sf_esi = ( int ) sched_idle ; sf -> sf_ebx = ( int ) ci ; sf -> sf_eip = ( int ) proc_trampoline ; pcb -> pcb_esp = ( int ) sf ; } cpu_boot_secondary_processors ( ) ; } 