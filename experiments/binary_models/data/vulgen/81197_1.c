static int dtj_chewrec ( const dtrace_probedata_t * data , const dtrace_recdesc_t * rec , void * arg ) { dtj_java_consumer_t * jc = arg ; JNIEnv * jenv = jc -> dtjj_jenv ; const dtrace_eprobedesc_t * edesc = data -> dtpda_edesc ; dtrace_actkind_t act ; int r ; if ( rec == NULL ) { r = edesc -> dtepd_nrecs ; } else { for ( r = jc -> dtjj_consumer -> dtjc_probedata_rec_i ; ( ( r < edesc -> dtepd_nrecs ) && ( edesc -> dtepd_rec [ r ] . dtrd_offset < rec -> dtrd_offset ) ) ; ++ r ) { } } if ( jc -> dtjj_consumer -> dtjc_probedata_act == DTRACEACT_PRINTF ) { ( * jenv ) -> CallVoidMethod ( jenv , jc -> dtjj_probedata , g_pdataattach_jm , jc -> dtjj_consumer -> dtjc_probedata_rec_i , r - 1 ) ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { return ( DTRACE_CONSUME_ABORT ) ; } } if ( rec == NULL ) { if ( jc -> dtjj_probedata ) { ( * jenv ) -> CallVoidMethod ( jenv , jc -> dtjj_probedata , g_pdataclear_jm ) ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { WRAP_EXCEPTION ( jenv ) ; return ( DTRACE_CONSUME_ABORT ) ; } ( * jenv ) -> CallVoidMethod ( jenv , jc -> dtjj_caller , g_pdatanext_jm , jc -> dtjj_probedata ) ; ( * jenv ) -> DeleteLocalRef ( jenv , jc -> dtjj_probedata ) ; jc -> dtjj_probedata = NULL ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { return ( DTRACE_CONSUME_ABORT ) ; } } ( * jenv ) -> DeleteLocalRef ( jenv , jc -> dtjj_printa_buffer ) ; jc -> dtjj_printa_buffer = NULL ; return ( DTRACE_CONSUME_NEXT ) ; } act = rec -> dtrd_action ; jc -> dtjj_consumer -> dtjc_probedata_act = act ; jc -> dtjj_consumer -> dtjc_probedata_rec_i = r ; switch ( act ) { case DTRACEACT_DIFEXPR : case DTRACEACT_TRACEMEM : if ( rec -> dtrd_size == 0 ) { break ; } ( * jenv ) -> CallVoidMethod ( jenv , jc -> dtjj_probedata , g_pdataadd_trace_jm , jc -> dtjj_consumer -> dtjc_probedata_rec_i ) ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { WRAP_EXCEPTION ( jenv ) ; return ( DTRACE_CONSUME_ABORT ) ; } break ; case DTRACEACT_PRINTF : ( * jenv ) -> CallVoidMethod ( jenv , jc -> dtjj_probedata , g_pdataadd_printf_jm ) ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { WRAP_EXCEPTION ( jenv ) ; return ( DTRACE_CONSUME_ABORT ) ; } break ; case DTRACEACT_PRINTA : { jobject jbuf = NULL ; dtj_aggwalk_init ( jc ) ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { WRAP_EXCEPTION ( jenv ) ; return ( DTRACE_CONSUME_ABORT ) ; } ( * jenv ) -> CallVoidMethod ( jenv , jc -> dtjj_probedata , g_pdataadd_printa_jm , jc -> dtjj_consumer -> dtjc_printa_snaptime , ( rec -> dtrd_format != 0 ) ) ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { WRAP_EXCEPTION ( jenv ) ; return ( DTRACE_CONSUME_ABORT ) ; } if ( jc -> dtjj_printa_buffer == NULL ) { jbuf = ( * jenv ) -> NewObject ( jenv , g_buf_jc , g_bufinit_jm ) ; if ( ! jbuf ) { return ( DTRACE_CONSUME_ABORT ) ; } jc -> dtjj_printa_buffer = jbuf ; } break ; } case DTRACEACT_EXIT : ( * jenv ) -> CallVoidMethod ( jenv , jc -> dtjj_probedata , g_pdataadd_exit_jm , jc -> dtjj_consumer -> dtjc_probedata_rec_i ) ; if ( ( * jenv ) -> ExceptionCheck ( jenv ) ) { WRAP_EXCEPTION ( jenv ) ; return ( DTRACE_CONSUME_ABORT ) ; } return ( DTRACE_CONSUME_NEXT ) ; } return ( DTRACE_CONSUME_THIS ) ; } 