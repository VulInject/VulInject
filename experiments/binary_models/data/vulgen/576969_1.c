static int ilm_update_add ( ilm_t * ilm , ilg_stat_t ilgstat , slist_t * ilg_flist ) { mcast_record_t fmode ; slist_t * flist ; boolean_t fdefault ; char buf [ INET6_ADDRSTRLEN ] ; ill_t * ill = ilm -> ilm_ill ; fdefault = ( ilm -> ilm_no_ilg_cnt > 0 ) || ( ilgstat == ILGSTAT_NONE ) || SLIST_IS_EMPTY ( ilg_flist ) ; if ( ( flist = l_alloc ( ) ) == NULL ) { return ( ENOMEM ) ; } if ( ! fdefault && ilm -> ilm_filter == NULL ) { ilm -> ilm_filter = l_alloc ( ) ; if ( ilm -> ilm_filter == NULL ) { return ( ENOMEM ) ; } } if ( ilgstat != ILGSTAT_CHANGE ) { ilm -> ilm_refcnt ++ ; } if ( ilgstat == ILGSTAT_NONE ) { ilm -> ilm_no_ilg_cnt ++ ; } if ( fdefault ) { fmode = MODE_IS_EXCLUDE ; flist -> sl_numsrc = 0 ; } else { ilm_gen_filter ( ilm , & fmode , flist ) ; } if ( ( ilm -> ilm_fmode == fmode ) && ! lists_are_different ( ilm -> ilm_filter , flist ) ) { l_free ( flist ) ; return ( 0 ) ; } if ( ! IS_LOOPBACK ( ill ) ) { if ( ill -> ill_isv6 ) { mld_statechange ( ilm , fmode , flist ) ; } else { igmp_statechange ( ilm , fmode , flist ) ; } } ilm -> ilm_fmode = fmode ; if ( flist -> sl_numsrc > 0 ) { l_copy ( flist , ilm -> ilm_filter ) ; } else { CLEAR_SLIST ( ilm -> ilm_filter ) ; } ip1dbg ( ( "ilm_update: new if filter mode %d, group %s\n" , ilm -> ilm_fmode , inet_ntop ( AF_INET6 , & ilm -> ilm_v6addr , buf , sizeof ( buf ) ) ) ) ; l_free ( flist ) ; return ( 0 ) ; } 