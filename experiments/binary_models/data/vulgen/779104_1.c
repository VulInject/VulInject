static int intel_pmu_set_msr ( struct kvm_vcpu * vcpu , struct msr_data * msr_info ) { struct kvm_pmu * pmu = vcpu_to_pmu ( vcpu ) ; struct kvm_pmc * pmc ; u32 msr = msr_info -> index ; u64 data = msr_info -> data ; switch ( msr ) { case MSR_CORE_PERF_FIXED_CTR_CTRL : if ( pmu -> fixed_ctr_ctrl == data ) { return 0 ; } if ( ! ( data & 0xfffffffffffff444ull ) ) { reprogram_fixed_counters ( pmu , data ) ; return 0 ; } break ; case MSR_CORE_PERF_GLOBAL_STATUS : if ( msr_info -> host_initiated ) { pmu -> global_status = data ; return 0 ; } break ; case MSR_CORE_PERF_GLOBAL_CTRL : if ( pmu -> global_ctrl == data ) { return 0 ; } if ( ! ( data & pmu -> global_ctrl_mask ) ) { global_ctrl_changed ( pmu , data ) ; return 0 ; } break ; case MSR_CORE_PERF_GLOBAL_OVF_CTRL : if ( ! ( data & ( pmu -> global_ctrl_mask & ~ ( 3ull << 62 ) ) ) ) { if ( ! msr_info -> host_initiated ) { pmu -> global_status &= ~ data ; } pmu -> global_ovf_ctrl = data ; return 0 ; } break ; default : if ( ( pmc = get_gp_pmc ( pmu , msr , MSR_IA32_PERFCTR0 ) ) || ( pmc = get_fixed_pmc ( pmu , msr ) ) ) { pmc -> counter += data - pmc_read_counter ( pmc ) ; return 0 ; } if ( ( pmc = get_gp_pmc ( pmu , msr , MSR_P6_EVNTSEL0 ) ) ) { if ( data == pmc -> eventsel ) { return 0 ; } if ( ! ( data & pmu -> reserved_bits ) ) { reprogram_gp_counter ( pmc , data ) ; return 0 ; } } } return 1 ; } 