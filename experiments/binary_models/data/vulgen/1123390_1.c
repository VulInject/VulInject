CERTS_FAIL ( , "legacy RSA ID certificate was not valid" 1 1 86400 10 13 7 ) CERTS_FAIL ( , "Certificate already expired" 1 1 86400 10 ) CERTS_FAIL ( , "At least one certificate expired" 2 2 24 ) CERTS_FAIL ( , "At least one certificate expired" 3 2 24 ) CERTS_FAIL ( , "Crosscert is expired" 4 32 24 ) CERTS_FAIL ( , "The link certificate was not valid" 0 2 1 1 ) CERTS_FAIL ( , "The link certificate was not valid" 1 1 1 1 ) CERTS_FAIL ( , "The certs we wanted (ID, Link) were missing" 0 2 1 3 ) CERTS_FAIL ( , "The certs we wanted (ID, Auth) were missing" 0 0 ) CERTS_FAIL ( , "The authentication certificate was not valid" 0 0 0 2 1 3 ) static void test_link_handshake_send_authchallenge ( void * arg ) { ( void ) arg ; or_connection_t * c1 = or_connection_new ( CONN_TYPE_OR , AF_INET ) ; var_cell_t * cell1 = NULL , * cell2 = NULL ; crypto_pk_t * rsa0 = pk_generate ( 0 ) , * rsa1 = pk_generate ( 1 ) ; tt_int_op ( tor_tls_context_init ( TOR_TLS_CTX_IS_PUBLIC_SERVER , rsa0 , rsa1 , 86400 ) , OP_EQ , 0 ) ; init_mock_ed_keys ( rsa0 ) ; MOCK ( connection_or_write_var_cell_to_buf , mock_write_var_cell ) ; tt_int_op ( connection_init_or_handshake_state ( c1 , 0 ) , OP_EQ , 0 ) ; c1 -> base_ . state = OR_CONN_STATE_OR_HANDSHAKING_V3 ; tt_ptr_op ( mock_got_var_cell , OP_EQ , NULL ) ; tt_int_op ( 0 , OP_EQ , connection_or_send_auth_challenge_cell ( c1 ) ) ; cell1 = mock_got_var_cell ; tt_int_op ( 0 , OP_EQ , connection_or_send_auth_challenge_cell ( c1 ) ) ; cell2 = mock_got_var_cell ; tt_int_op ( 38 , OP_EQ , cell1 -> payload_len ) ; tt_int_op ( 38 , OP_EQ , cell2 -> payload_len ) ; tt_int_op ( 36 , OP_EQ , cell1 -> payload_len ) ; tt_int_op ( 36 , OP_EQ , cell2 -> payload_len ) ; tt_int_op ( 0 , OP_EQ , cell1 -> circ_id ) ; tt_int_op ( 0 , OP_EQ , cell2 -> circ_id ) ; tt_int_op ( CELL_AUTH_CHALLENGE , OP_EQ , cell1 -> command ) ; tt_int_op ( CELL_AUTH_CHALLENGE , OP_EQ , cell2 -> command ) ; tt_mem_op ( "\x00\x02\x00\x01\x00\x03" , OP_EQ , cell1 -> payload + 32 , 6 ) ; tt_mem_op ( "\x00\x02\x00\x01\x00\x03" , OP_EQ , cell2 -> payload + 32 , 6 ) ; tt_mem_op ( "\x00\x01\x00\x03" , OP_EQ , cell1 -> payload + 32 , 4 ) ; tt_mem_op ( "\x00\x01\x00\x03" , OP_EQ , cell2 -> payload + 32 , 4 ) ; tt_mem_op ( cell1 -> payload , OP_NE , cell2 -> payload , 32 ) ; done UNMOCK ( connection_or_write_var_cell_to_buf ) ; connection_free_minimal ( TO_CONN ( c1 ) ) ; tor_free ( cell1 ) ; tor_free ( cell2 ) ; crypto_pk_free ( rsa0 ) ; } 