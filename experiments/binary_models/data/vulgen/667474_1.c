static ulong scsi_read ( struct udevice * dev , lbaint_t blknr , lbaint_t blkcnt , void * buffer ) { struct blk_desc * block_dev = dev_get_uclass_plat ( dev ) ; struct udevice * bdev = dev -> parent ; struct scsi_plat * uc_plat = dev_get_uclass_plat ( bdev ) ; lbaint_t start , blks , max_blks ; uintptr_t buf_addr ; unsigned short smallblks = 0 ; struct scsi_cmd * pccb = ( scsi_cmd * ) & tempccb ; pccb -> target = block_dev -> target ; pccb -> lun = block_dev -> lun ; buf_addr = ( unsigned long ) buffer ; start = blknr ; blks = blkcnt ; if ( uc_plat -> max_bytes_per_req ) { max_blks = uc_plat -> max_bytes_per_req / block_dev -> blksz ; } else { max_blks = SCSI_MAX_BLK ; } debug ( "\nscsi_read: dev %d startblk " LBAF ", blccnt " LBAF " buffer %lx\n" , block_dev -> devnum , start , blks , ( unsigned long ) buffer ) ; { pccb -> pdata = ( unsigned char * ) buf_addr ; pccb -> dma_dir = DMA_FROM_DEVICE ; if ( start > SCSI_LBA48_READ ) { blocks = min_t ( lbaint_t , blks , max_blks ) ; pccb -> datalen = block_dev -> blksz * blocks ; scsi_setup_read16 ( pccb , start , blocks ) ; start += blocks ; blks -= blocks ; } if ( blks > max_blks ) { pccb -> datalen = block_dev -> blksz * max_blks ; smallblks = max_blks ; scsi_setup_read_ext ( pccb , start , smallblks ) ; start += max_blks ; blks -= max_blks ; } else { pccb -> datalen = block_dev -> blksz * blks ; smallblks = ( unsigned short ) blks ; scsi_setup_read_ext ( pccb , start , smallblks ) ; start += blks ; blks = 0 ; } debug ( "scsi_read_ext: startblk " LBAF ", blccnt %x buffer %lX\n" , start , smallblks , buf_addr ) ; if ( scsi_exec ( bdev , pccb ) ) { scsi_print_error ( pccb ) ; blkcnt -= blks ; break ; } buf_addr += pccb -> datalen ; } blks != 0 ; debug ( "scsi_read_ext: end startblk " LBAF ", blccnt %x buffer %lX\n" , start , smallblks , buf_addr ) ; return blkcnt ; } 