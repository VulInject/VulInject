static int rtw_pci_init_rx_ring ( struct rtw_dev * rtwdev , struct rtw_pci_rx_ring * rx_ring , u8 desc_size , u32 len ) { struct pci_dev * pdev = to_pci_dev ( rtwdev -> dev ) ; struct sk_buff * skb = NULL ; dma_addr_t dma ; u8 * head ; int ring_sz = desc_size * len ; int buf_sz = RTK_PCI_RX_BUF_SIZE ; int i , allocated ; int ret = 0 ; head = dma_alloc_coherent ( & pdev -> dev , ring_sz , & dma , GFP_KERNEL ) ; if ( ! head ) { rtw_err ( rtwdev , "failed to allocate rx ring\n" ) ; return - ENOMEM ; } rx_ring -> r . head = head ; for ( i = 0 ; i < len ; i ++ ) { skb = dev_alloc_skb ( buf_sz ) ; if ( ! skb ) { allocated = i ; ret = - ENOMEM ; err_out } memset ( skb -> data , 0 , buf_sz ) ; rx_ring -> buf [ i ] = skb ; ret = rtw_pci_reset_rx_desc ( rtwdev , skb , rx_ring , i , desc_size ) ; if ( ret ) { allocated = i ; dev_kfree_skb_any ( skb ) ; err_out } } rx_ring -> r . dma = dma ; rx_ring -> r . len = len ; rx_ring -> r . desc_size = desc_size ; rx_ring -> r . wp = 0 ; rx_ring -> r . rp = 0 ; return 0 ; err_out for ( i = 0 ; i < allocated ; i ++ ) { skb = rx_ring -> buf [ i ] ; if ( ! skb ) { continue ; } dma = * ( ( dma_addr_t * ) skb -> cb ) ; dma_unmap_single ( & pdev -> dev , dma , buf_sz , DMA_FROM_DEVICE ) ; dev_kfree_skb_any ( skb ) ; } dma_free_coherent ( & pdev -> dev , ring_sz , head , dma ) ; rtw_err ( rtwdev , "failed to init rx buffer\n" ) ; return ret ; } 