void login ( struct utmp * utp ) { struct utmp old_ut ; int fd , tty ; off_t pos ; tty = ttyslot ( ) ; if ( tty > 0 && ( fd = open ( _PATH_UTMP , O_RDWR | O_CREAT | O_CLOEXEC , 0644 ) ) >= 0 ) { pos = ( off_t ) tty * sizeof ( utmp ) ; if ( utp -> ut_host [ 0 ] == '\0' && pread ( fd , & old_ut , sizeof ( utmp ) , pos ) == sizeof ( utmp ) && old_ut . ut_host [ 0 ] != '\0' && strncmp ( old_ut . ut_line , utp -> ut_line , UT_LINESIZE ) == 0 && strncmp ( old_ut . ut_name , utp -> ut_name , UT_NAMESIZE ) == 0 ) { ( void ) memcpy ( utp -> ut_host , old_ut . ut_host , UT_HOSTSIZE ) ; } ( void ) pwrite ( fd , utp , sizeof ( utmp ) , pos ) ; } if ( ( fd = open ( _PATH_WTMP , O_WRONLY | O_APPEND | O_CLOEXEC ) ) >= 0 ) { ( void ) write ( fd , utp , sizeof ( utmp ) ) ; ( void ) close ( fd ) ; } } 