static GF_Err swf_def_text ( SWFReader * read , u32 revision ) { SWFRec rc ; SWFText txt ; Bool flag ; u32 nbits_adv , nbits_glyph , i , col , fontID , count , font_height ; Fixed offX , offY ; GF_Err e ; txt . ID = swf_get_16 ( read ) ; swf_get_rec ( read , & rc ) ; swf_get_matrix ( read , & txt . mat ) ; txt . text = gf_list_new ( ) ; swf_align ( read ) ; nbits_glyph = swf_read_int ( read , 8 ) ; nbits_adv = swf_read_int ( read , 8 ) ; fontID = 0 ; offX = offY = 0 ; font_height = 0 ; col = 0xFF000000 ; e = GF_OK ; while ( 1 ) { flag = swf_read_int ( read , 1 ) ; if ( ! flag ) { SWFGlyphRec * gr ; count = swf_read_int ( read , 7 ) ; if ( ! count ) { break ; } if ( ! fontID ) { e = GF_BAD_PARAM ; swf_report ( read , GF_BAD_PARAM , "Defining text %d without assigning font" , fontID ) ; break ; } GF_SAFEALLOC ( gr , SWFGlyphRec ) ; if ( ! gr ) { return GF_OUT_OF_MEM ; } gf_list_add ( txt . text , gr ) ; gr -> fontID = fontID ; gr -> fontSize = font_height ; gr -> col = col ; gr -> orig_x = offX ; gr -> orig_y = offY ; gr -> nbGlyphs = count ; gr -> indexes = ( u32 * ) gf_malloc ( sizeof ( u32 ) * gr -> nbGlyphs ) ; gr -> dx = ( Fixed * ) gf_malloc ( sizeof ( Fixed ) * gr -> nbGlyphs ) ; for ( i = 0 ; i < gr -> nbGlyphs ; i ++ ) { gr -> indexes [ i ] = swf_read_int ( read , nbits_glyph ) ; gr -> dx [ i ] = FLT2FIX ( swf_read_int ( read , nbits_adv ) * SWF_TWIP_SCALE ) ; } swf_align ( read ) ; } else { Bool has_font , has_col , has_y_off , has_x_off ; swf_read_int ( read , 3 ) ; has_font = swf_read_int ( read , 1 ) ; has_col = swf_read_int ( read , 1 ) ; has_y_off = swf_read_int ( read , 1 ) ; has_x_off = swf_read_int ( read , 1 ) ; if ( ! has_font && ! has_col && ! has_y_off && ! has_x_off ) { break ; } if ( has_font ) { fontID = swf_get_16 ( read ) ; } if ( has_col ) { if ( revision == 0 ) { col = swf_get_color ( read ) ; } else { col = swf_get_argb ( read ) ; } } if ( has_x_off ) { offX = FLT2FIX ( swf_get_s16 ( read ) * SWF_TWIP_SCALE ) ; } if ( has_y_off ) { offY = FLT2FIX ( swf_get_s16 ( read ) * SWF_TWIP_SCALE ) ; } if ( has_font ) { font_height = swf_get_16 ( read ) ; } } } if { exit } if ( ! ( read -> flags & GF_SM_SWF_NO_TEXT ) ) { e = read -> define_text ( read , & txt ) ; } exit while ( gf_list_count ( txt . text ) ) { SWFGlyphRec * gr = ( SWFGlyphRec * ) gf_list_get ( txt . text , 0 ) ; gf_list_rem ( txt . text , 0 ) ; if ( gr -> indexes ) { gf_free ( gr -> indexes ) ; } if ( gr -> dx ) { gf_free ( gr -> dx ) ; } gf_free ( gr ) ; } gf_list_del ( txt . text ) ; return e ; } 