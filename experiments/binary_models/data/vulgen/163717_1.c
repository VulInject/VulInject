struct cs5535_mfgpt_timer * cs5535_mfgpt_alloc_timer ( int timer_nr , int domain ) { struct cs5535_mfgpt_chip * mfgpt = & cs5535_mfgpt_chip ; struct cs5535_mfgpt_timer * timer = NULL ; unsigned long flags ; int max ; if ( ! mfgpt -> initialized ) { done } if ( domain == MFGPT_DOMAIN_WORKING ) { max = 6 ; } else { max = MFGPT_MAX_TIMERS ; } if ( timer_nr >= max ) { WARN_ON ( 1 ) ; done } spin_lock_irqsave ( & mfgpt -> lock , flags ) ; if ( timer_nr < 0 ) { unsigned long t ; t = find_first_bit ( mfgpt -> avail , max ) ; timer_nr = t < max ?( int ) t : - 1 ; } else { if ( ! test_bit ( timer_nr , mfgpt -> avail ) ) { timer_nr = - 1 ; } } if ( timer_nr >= 0 ) { __clear_bit ( timer_nr , mfgpt -> avail ) ; } spin_unlock_irqrestore ( & mfgpt -> lock , flags ) ; if ( timer_nr < 0 ) { done } if ( ! timer ) { spin_lock_irqsave ( & mfgpt -> lock , flags ) ; __set_bit ( timer_nr , mfgpt -> avail ) ; spin_unlock_irqrestore ( & mfgpt -> lock , flags ) ; done } timer -> chip = mfgpt ; timer -> nr = timer_nr ; dev_info ( & mfgpt -> pdev -> dev , "registered timer %d\n" , timer_nr ) ; done return timer ; } 