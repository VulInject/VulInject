static int nhi_init_msi ( struct tb_nhi * nhi ) { struct pci_dev * pdev = nhi -> pdev ; struct device * dev = & pdev -> dev ; int res , irq , nvec ; nhi_disable_interrupts ( nhi ) ; nhi_enable_int_throttling ( nhi ) ; ida_init ( & nhi -> msix_ida ) ; nvec = pci_alloc_irq_vectors ( pdev , MSIX_MIN_VECS , MSIX_MAX_VECS , PCI_IRQ_MSIX ) ; if ( nvec < 0 ) { nvec = pci_alloc_irq_vectors ( pdev , 1 , 1 , PCI_IRQ_MSI ) ; if ( nvec < 0 ) { return nvec ; } INIT_WORK ( & nhi -> interrupt_work , nhi_interrupt_work ) ; irq = pci_irq_vector ( nhi -> pdev , 0 ) ; if ( irq < 0 ) { return irq ; } if ( res ) { return dev_err_probe ( dev , res , "request_irq failed, aborting\n" ) ; } } return 0 ; } 