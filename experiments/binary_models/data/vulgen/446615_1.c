void __init txx9_iocled_init ( unsigned long baseaddr , int basenum , unsigned int num , int lowactive , const char * color , char * * deftriggers ) { struct txx9_iocled_data * iocled ; struct platform_device * pdev ; int i ; static char * default_triggers [ ] __initdata = { "heartbeat" "disk-activity" "nand-disk" NULL } ; if ( ! deftriggers ) { deftriggers = default_triggers ; } iocled = kzalloc ( sizeof ( * iocled ) , GFP_KERNEL ) ; if ( ! iocled ) { return ; } iocled -> mmioaddr = ioremap ( baseaddr , 1 ) ; if ( ! iocled -> mmioaddr ) { out_free } iocled -> chip . get = txx9_iocled_get ; iocled -> chip . set = txx9_iocled_set ; iocled -> chip . direction_input = txx9_iocled_dir_in ; iocled -> chip . direction_output = txx9_iocled_dir_out ; iocled -> chip . label = "iocled" ; iocled -> chip . base = basenum ; iocled -> chip . ngpio = num ; if ( gpiochip_add_data ( & iocled -> chip , iocled ) ) { out_unmap } pdev = platform_device_alloc ( "leds-gpio" , basenum ) ; if ( ! pdev ) { out_gpio } iocled -> pdata . num_leds = num ; iocled -> pdata . leds = iocled -> leds ; for ( i = 0 ; i < num ; i ++ ) { struct gpio_led * led = & iocled -> leds [ i ] ; snprintf ( iocled -> names [ i ] , sizeof ( iocled -> names [ i ] ) , "iocled:%s:%u" , color , i ) ; led -> name = iocled -> names [ i ] ; led -> gpio = basenum + i ; led -> active_low = lowactive ; if ( deftriggers && * deftriggers ) { led -> default_trigger = * deftriggers ++ ; } } pdev -> dev . platform_data = & iocled -> pdata ; if ( platform_device_add ( pdev ) ) { out_pdev } return ; out_pdev platform_device_put ( pdev ) ; out_gpio gpiochip_remove ( & iocled -> chip ) ; out_unmap iounmap ( iocled -> mmioaddr ) ; out_free kfree ( iocled ) ; } 