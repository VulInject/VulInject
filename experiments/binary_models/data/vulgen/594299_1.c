static int __init sun4i_timer_init ( struct device_node * node ) { int ret ; u32 val ; ret = timer_of_init ( node , & to ) ; if ( ret ) { return ret ; } writel ( ~ 0 , timer_of_base ( & to ) + TIMER_INTVAL_REG ( 1 ) ) ; writel ( TIMER_CTL_ENABLE | TIMER_CTL_RELOAD | TIMER_CTL_CLK_SRC ( TIMER_CTL_CLK_SRC_OSC24M ) , timer_of_base ( & to ) + TIMER_CTL_REG ( 1 ) ) ; if ( of_machine_is_compatible ( "allwinner,sun4i-a10" ) || of_machine_is_compatible ( "allwinner,sun5i-a13" ) || of_machine_is_compatible ( "allwinner,sun5i-a10s" ) || of_machine_is_compatible ( "allwinner,suniv-f1c100s" ) ) { pr_err ( 0 ) ; return ret ; } ret = clocksource_mmio_init ( timer_of_base ( & to ) + TIMER_CNTVAL_REG ( 1 ) , node -> name , timer_of_rate ( & to ) , 350 , 32 , clocksource_mmio_readl_down ) ; if ( ret ) { pr_err ( "Failed to register clocksource\n" ) ; return ret ; } writel ( TIMER_CTL_CLK_SRC ( TIMER_CTL_CLK_SRC_OSC24M ) , timer_of_base ( & to ) + TIMER_CTL_REG ( 0 ) ) ; sun4i_clkevt_time_stop ( timer_of_base ( & to ) , 0 ) ; sun4i_timer_clear_interrupt ( timer_of_base ( & to ) ) ; clockevents_config_and_register ( & to . clkevt , timer_of_rate ( & to ) , TIMER_SYNC_TICKS , 0xffffffff ) ; val = readl ( timer_of_base ( & to ) + TIMER_IRQ_EN_REG ) ; writel ( val | TIMER_IRQ_EN ( 0 ) , timer_of_base ( & to ) + TIMER_IRQ_EN_REG ) ; return ret ; } 