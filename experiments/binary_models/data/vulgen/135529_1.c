static int __init ib_core_init ( void ) { int ret = - ENOMEM ; ib_wq = alloc_workqueue ( "infiniband" , 0 , 0 ) ; ib_unreg_wq = alloc_workqueue ( "ib-unreg-wq" , WQ_UNBOUND , WQ_UNBOUND_MAX_ACTIVE ) ; if ( ! ib_unreg_wq ) { err } ib_comp_wq = alloc_workqueue ( "ib-comp-wq" , WQ_HIGHPRI | WQ_MEM_RECLAIM | WQ_SYSFS , 0 ) ; if ( ! ib_comp_wq ) { err_unbound } ib_comp_unbound_wq = alloc_workqueue ( "ib-comp-unb-wq" , WQ_UNBOUND | WQ_HIGHPRI | WQ_MEM_RECLAIM | WQ_SYSFS , WQ_UNBOUND_MAX_ACTIVE ) ; if ( ! ib_comp_unbound_wq ) { err_comp } ret = class_register ( & ib_class ) ; if ( ret ) { pr_warn ( "Couldn't create InfiniBand device class\n" ) ; err_comp_unbound } rdma_nl_init ( ) ; ret = addr_init ( ) ; if ( ret ) { pr_warn ( "Couldn't init IB address resolution\n" ) ; err_ibnl } ret = ib_mad_init ( ) ; if ( ret ) { pr_warn ( "Couldn't init IB MAD\n" ) ; err_addr } ret = ib_sa_init ( ) ; if ( ret ) { pr_warn ( "Couldn't init SA\n" ) ; err_mad } ret = register_blocking_lsm_notifier ( & ibdev_lsm_nb ) ; if ( ret ) { pr_warn ( "Couldn't register LSM notifier. ret %d\n" , ret ) ; err_sa } ret = register_pernet_device ( & rdma_dev_net_ops ) ; if ( ret ) { pr_warn ( "Couldn't init compat dev. ret %d\n" , ret ) ; err_compat } nldev_init ( ) ; rdma_nl_register ( RDMA_NL_LS , ibnl_ls_cb_table ) ; ret = roce_gid_mgmt_init ( ) ; if ( ret ) { pr_warn ( "Couldn't init RoCE GID management\n" ) ; err_parent } return 0 ; err_parent rdma_nl_unregister ( RDMA_NL_LS ) ; nldev_exit ( ) ; unregister_pernet_device ( & rdma_dev_net_ops ) ; err_compat unregister_blocking_lsm_notifier ( & ibdev_lsm_nb ) ; err_sa ib_sa_cleanup ( ) ; err_mad ib_mad_cleanup ( ) ; err_addr addr_cleanup ( ) ; err_ibnl class_unregister ( & ib_class ) ; err_comp_unbound destroy_workqueue ( ib_comp_unbound_wq ) ; err_comp destroy_workqueue ( ib_comp_wq ) ; err_unbound destroy_workqueue ( ib_unreg_wq ) ; err destroy_workqueue ( ib_wq ) ; return ret ; } 