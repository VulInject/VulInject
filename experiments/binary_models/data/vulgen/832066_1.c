static void radeon_identify_vram ( struct radeonfb_info * rinfo ) { u32 tmp ; if ( ( rinfo -> family == CHIP_FAMILY_RS100 ) || ( rinfo -> family == CHIP_FAMILY_RS200 ) || ( rinfo -> family == CHIP_FAMILY_RS300 ) || ( rinfo -> family == CHIP_FAMILY_RC410 ) || ( rinfo -> family == CHIP_FAMILY_RS400 ) || ( rinfo -> family == CHIP_FAMILY_RS480 ) ) { u32 tom = INREG ( NB_TOM ) ; radeon_fifo_wait ( 6 ) ; OUTREG ( MC_FB_LOCATION , tom ) ; OUTREG ( DISPLAY_BASE_ADDR , ( tom & 0xffff ) << 16 ) ; OUTREG ( CRTC2_DISPLAY_BASE_ADDR , ( tom & 0xffff ) << 16 ) ; OUTREG ( OV0_BASE_ADDR , ( tom & 0xffff ) << 16 ) ; OUTREG ( GRPH2_BUFFER_CNTL , INREG ( GRPH2_BUFFER_CNTL ) & ~ 0x7f0000 ) ; if ( ( rinfo -> family == CHIP_FAMILY_RS100 ) || ( rinfo -> family == CHIP_FAMILY_RS200 ) ) { OUTREGP ( CRTC_MORE_CNTL , CRTC_H_CUTOFF_ACTIVE_EN , ~ CRTC_H_CUTOFF_ACTIVE_EN ) ; } } else { tmp = INREG ( CNFG_MEMSIZE ) ; } rinfo -> video_ram = tmp & CNFG_MEMSIZE_MASK ; if ( rinfo -> video_ram == 0 ) { switch ( rinfo -> pdev -> device ) { case PCI_CHIP_RADEON_LY : case PCI_CHIP_RADEON_LZ : rinfo -> video_ram = 8192 * 1024 ; break ; default : break ; } } if ( rinfo -> is_IGP || ( rinfo -> family >= CHIP_FAMILY_R300 ) || ( INREG ( MEM_SDRAM_MODE_REG ) & ( 1 << 30 ) ) ) { rinfo -> vram_ddr = 1 ; } else { rinfo -> vram_ddr = 0 ; } tmp = INREG ( MEM_CNTL ) ; if ( IS_R300_VARIANT ( rinfo ) ) { tmp &= R300_MEM_NUM_CHANNELS_MASK ; switch ( tmp ) { case 0 : rinfo -> vram_width = 64 ; break ; case 1 : rinfo -> vram_width = 128 ; break ; case 2 : rinfo -> vram_width = 256 ; break ; default : rinfo -> vram_width = 128 ; break ; } } if ( ( rinfo -> family == CHIP_FAMILY_RV100 ) || ( rinfo -> family == CHIP_FAMILY_RS100 ) || ( rinfo -> family == CHIP_FAMILY_RS200 ) ) { if ( tmp & RV100_MEM_HALF_MODE ) { rinfo -> vram_width = 32 ; } else { rinfo -> vram_width = 64 ; } } else { if ( tmp & MEM_NUM_CHANNELS_MASK ) { rinfo -> vram_width = 128 ; } else { rinfo -> vram_width = 64 ; } } pr_debug ( "radeonfb (%s): Found %ldk of %s %d bits wide videoram\n" , pci_name ( rinfo -> pdev ) , rinfo -> video_ram / 1024 , rinfo -> vram_ddr ?"DDR" : "SDRAM" , rinfo -> vram_width ) ; } 