void zbud_free ( struct zbud_pool * pool , unsigned long handle ) { struct zbud_header * zhdr ; int freechunks ; spin_lock ( & pool -> lock ) ; zhdr = handle_to_zbud_header ( handle ) ; if ( ( handle - ZHDR_SIZE_ALIGNED ) & ~ PAGE_MASK ) { zhdr -> last_chunks = 0 ; } else { zhdr -> first_chunks = 0 ; } if ( zhdr -> under_reclaim ) { spin_unlock ( & pool -> lock ) ; return ; } list_del ( & zhdr -> buddy ) ; if ( zhdr -> first_chunks == 0 && zhdr -> last_chunks == 0 ) { list_del ( & zhdr -> lru ) ; pool -> pages_nr -- ; } else { freechunks = num_free_chunks ( zhdr ) ; list_add ( & zhdr -> buddy , & pool -> unbuddied [ freechunks ] ) ; } spin_unlock ( & pool -> lock ) ; } 