void pluart_start ( struct tty * tp ) { struct pluart_softc * sc = pluart_cd . cd_devs [ DEVUNIT ( tp -> t_dev ) ] ; bus_space_tag_t iot = sc -> sc_iot ; bus_space_handle_t ioh = sc -> sc_ioh ; int s ; s = spltty ( ) ; if ( ISSET ( tp -> t_state , TS_BUSY ) ) { out } if ( ISSET ( tp -> t_state , TS_TIMEOUT | TS_TTSTOP ) ) { stopped } ttwakeupwr ( tp ) ; if ( tp -> t_outq . c_cc == 0 ) { stopped } SET ( tp -> t_state , TS_BUSY ) ; if ( ! ISSET ( sc -> sc_imsc , UART_IMSC_TXIM ) ) { bus_space_write_4 ( sc -> sc_iot , sc -> sc_ioh , UART_IMSC , sc -> sc_imsc ) ; } while ( tp -> t_outq . c_cc > 0 ) { uint16_t fr ; fr = bus_space_read_4 ( iot , ioh , UART_FR ) ; if ( ISSET ( fr , UART_FR_TXFF ) ) { break ; } bus_space_write_4 ( iot , ioh , UART_DR , getc ( & tp -> t_outq ) ) ; } out splx ( s ) ; return ; stopped if ( ISSET ( sc -> sc_imsc , UART_IMSC_TXIM ) ) { sc -> sc_imsc &= ~ UART_IMSC_TXIM ; bus_space_write_4 ( sc -> sc_iot , sc -> sc_ioh , UART_IMSC , sc -> sc_imsc ) ; } splx ( s ) ; } 