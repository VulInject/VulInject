static void test_get_sigsafe_err_fds ( void * arg ) { const int * fds ; int n ; log_severity_list_t include_bug , no_bug , no_bug2 ; ( void ) arg ; init_logging ( 1 ) ; n = tor_log_get_sigsafe_err_fds ( & fds ) ; tt_int_op ( n , OP_EQ , 1 ) ; tt_int_op ( fds [ 0 ] , OP_EQ , STDERR_FILENO ) ; set_log_severity_config ( LOG_WARN , LOG_ERR , & include_bug ) ; set_log_severity_config ( LOG_WARN , LOG_ERR , & no_bug ) ; no_bug . masks [ SEVERITY_MASK_IDX ( LOG_ERR ) ] &= ~ ( LD_BUG | LD_GENERAL ) ; set_log_severity_config ( LOG_INFO , LOG_NOTICE , & no_bug2 ) ; add_stream_log ( & include_bug , "dummy-1" , 3 ) ; add_stream_log ( & no_bug , "dummy-2" , 4 ) ; add_stream_log ( & no_bug2 , "dummy-3" , 5 ) ; add_callback_log ( & include_bug , dummy_cb_fn ) ; close_temp_logs ( ) ; tor_log_update_sigsafe_err_fds ( ) ; n = tor_log_get_sigsafe_err_fds ( & fds ) ; tt_int_op ( n , OP_EQ , 2 ) ; tt_int_op ( fds [ 0 ] , OP_EQ , STDERR_FILENO ) ; tt_int_op ( fds [ 1 ] , OP_EQ , 3 ) ; add_stream_log ( & include_bug , "dummy-4" , STDOUT_FILENO ) ; tor_log_update_sigsafe_err_fds ( ) ; n = tor_log_get_sigsafe_err_fds ( & fds ) ; tt_int_op ( n , OP_EQ , 2 ) ; tt_int_op ( fds [ 0 ] , OP_EQ , 3 ) ; tt_int_op ( fds [ 1 ] , OP_EQ , STDOUT_FILENO ) ; add_stream_log ( & include_bug , "dummy-5" , STDERR_FILENO ) ; tor_log_update_sigsafe_err_fds ( ) ; n = tor_log_get_sigsafe_err_fds ( & fds ) ; tt_int_op ( n , OP_EQ , 3 ) ; tt_int_op ( fds [ 0 ] , OP_EQ , STDERR_FILENO ) ; tt_int_op ( fds [ 1 ] , OP_EQ , STDOUT_FILENO ) ; tt_int_op ( fds [ 2 ] , OP_EQ , 3 ) ; { int i ; for ( i = 5 ; i < 20 ; ++ i ) { add_stream_log ( & include_bug , "x-dummy" , i ) ; } } tor_log_update_sigsafe_err_fds ( ) ; n = tor_log_get_sigsafe_err_fds ( & fds ) ; tt_int_op ( n , OP_EQ , 8 ) ; done } 