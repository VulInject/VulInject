gimp_convolve_motion ( , , , ) { GimpConvolve * convolve = GIMP_CONVOLVE ( paint_core ) ; GimpBrushCore * brush_core = GIMP_BRUSH_CORE ( paint_core ) ; GimpConvolveOptions * options = GIMP_CONVOLVE_OPTIONS ( paint_options ) ; GimpContext * context = GIMP_CONTEXT ( paint_options ) ; GimpDynamics * dynamics = GIMP_BRUSH_CORE ( paint_core ) -> dynamics ; GimpImage * image = gimp_item_get_image ( GIMP_ITEM ( drawable ) ) ; GeglBuffer * paint_buffer ; gint paint_buffer_x ; gint paint_buffer_y ; GimpTempBuf * temp_buf ; GeglBuffer * convolve_buffer ; gdouble fade_point ; gdouble opacity ; gdouble rate ; GimpCoords coords ; gint off_x , off_y ; gint paint_width , paint_height ; gint n_strokes ; gint i ; fade_point = gimp_paint_options_get_fade ( paint_options , image , paint_core -> pixel_dist ) ; gimp_item_get_offset ( GIMP_ITEM ( drawable ) , & off_x , & off_y ) ; coords = * ( gimp_symmetry_get_origin ( sym ) ) ; coords . x -= off_x ; coords . y -= off_y ; opacity = gimp_dynamics_get_linear_value ( dynamics , GIMP_DYNAMICS_OUTPUT_OPACITY , & coords , paint_options , fade_point ) ; gimp_brush_core_eval_transform_dynamics ( GIMP_BRUSH_CORE ( paint_core ) , image , paint_options , & coords ) ; n_strokes = gimp_symmetry_get_size ( sym ) ; for ( i = 0 ; i < n_strokes ; i ++ ) { coords = * ( gimp_symmetry_get_coords ( sym , i ) ) ; coords . x -= off_x ; coords . y -= off_y ; gimp_brush_core_eval_transform_symmetry ( brush_core , sym , i ) ; paint_buffer = gimp_paint_core_get_paint_buffer ( paint_core , drawable , paint_options , GIMP_LAYER_MODE_NORMAL , & coords , & paint_buffer_x , & paint_buffer_y , & paint_width , & paint_height ) ; if ( ! paint_buffer ) { continue ; } rate = ( options -> rate * gimp_dynamics_get_linear_value ( dynamics , GIMP_DYNAMICS_OUTPUT_RATE , & coords , paint_options , fade_point ) ) ; gimp_convolve_calculate_matrix ( convolve , options -> type , gimp_brush_get_width ( brush_core -> brush ) / 2 , gimp_brush_get_height ( brush_core -> brush ) / 2 , rate ) ; temp_buf = gimp_temp_buf_new ( gegl_buffer_get_width ( paint_buffer ) , gegl_buffer_get_height ( paint_buffer ) , gegl_buffer_get_format ( paint_buffer ) ) ; convolve_buffer = gimp_temp_buf_create_buffer ( temp_buf ) ; gimp_temp_buf_unref ( temp_buf ) ; gimp_gegl_buffer_copy ( gimp_drawable_get_buffer ( drawable ) , GEGL_RECTANGLE ( paint_buffer_x , paint_buffer_y , gegl_buffer_get_width ( paint_buffer ) , gegl_buffer_get_height ( paint_buffer ) ) , GEGL_ABYSS_NONE , convolve_buffer , GEGL_RECTANGLE ( 0 , 0 , 0 , 0 ) ) ; gimp_gegl_convolve ( convolve_buffer , GEGL_RECTANGLE ( 0 , 0 , gegl_buffer_get_width ( convolve_buffer ) , gegl_buffer_get_height ( convolve_buffer ) ) , paint_buffer , GEGL_RECTANGLE ( 0 , 0 , gegl_buffer_get_width ( paint_buffer ) , gegl_buffer_get_height ( paint_buffer ) ) , convolve -> matrix , 3 , convolve -> matrix_divisor , GIMP_NORMAL_CONVOL , TRUE ) ; g_object_unref ( convolve_buffer ) ; gimp_brush_core_replace_canvas ( brush_core , drawable , & coords , MIN ( opacity , GIMP_OPACITY_OPAQUE ) , gimp_context_get_opacity ( context ) , gimp_paint_options_get_brush_mode ( paint_options ) , 1.0 , GIMP_PAINT_INCREMENTAL ) ; } } 