static ds_status writeProfileToFile ( ds_profile * profile , ds_score_serializer serializer , const char * file ) { ds_status status = DS_SUCCESS ; FILE * profileFile = NULL ; profileFile = fopen ( file , "wb" ) ; if ( profileFile == NULL ) { status = DS_FILE_ERROR ; } else { unsigned int i ; fwrite ( DS_TAG_VERSION , sizeof ( char ) , strlen ( DS_TAG_VERSION ) , profileFile ) ; fwrite ( profile -> version , sizeof ( char ) , strlen ( profile -> version ) , profileFile ) ; fwrite ( DS_TAG_VERSION_END , sizeof ( char ) , strlen ( DS_TAG_VERSION_END ) , profileFile ) ; fwrite ( "\n" , sizeof ( char ) , 1 , profileFile ) ; for ( i = 0 ; i < profile -> numDevices && status == DS_SUCCESS ; i ++ ) { void * serializedScore ; unsigned int serializedScoreSize ; fwrite ( DS_TAG_DEVICE , sizeof ( char ) , strlen ( DS_TAG_DEVICE ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_TYPE , sizeof ( char ) , strlen ( DS_TAG_DEVICE_TYPE ) , profileFile ) ; fwrite ( & profile -> devices [ i ] . type , sizeof ( ds_device_type ) , 1 , profileFile ) ; fwrite ( DS_TAG_DEVICE_TYPE_END , sizeof ( char ) , strlen ( DS_TAG_DEVICE_TYPE_END ) , profileFile ) ; switch ( profile -> devices [ i ] . type ) { case DS_DEVICE_NATIVE_CPU : { } break ; case DS_DEVICE_OPENCL_DEVICE : { char tmp [ 16 ] ; fwrite ( DS_TAG_DEVICE_NAME , sizeof ( char ) , strlen ( DS_TAG_DEVICE_NAME ) , profileFile ) ; fwrite ( profile -> devices [ i ] . oclDeviceName , sizeof ( char ) , strlen ( profile -> devices [ i ] . oclDeviceName ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_NAME_END , sizeof ( char ) , strlen ( DS_TAG_DEVICE_NAME_END ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_DRIVER_VERSION , sizeof ( char ) , strlen ( DS_TAG_DEVICE_DRIVER_VERSION ) , profileFile ) ; fwrite ( profile -> devices [ i ] . oclDriverVersion , sizeof ( char ) , strlen ( profile -> devices [ i ] . oclDriverVersion ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_DRIVER_VERSION_END , sizeof ( char ) , strlen ( DS_TAG_DEVICE_DRIVER_VERSION_END ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_MAX_COMPUTE_UNITS , sizeof ( char ) , strlen ( DS_TAG_DEVICE_MAX_COMPUTE_UNITS ) , profileFile ) ; ( void ) FormatLocaleString ( tmp , sizeof ( tmp ) , "%d" , profile -> devices [ i ] . oclMaxComputeUnits ) ; fwrite ( tmp , sizeof ( char ) , strlen ( tmp ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_MAX_COMPUTE_UNITS_END , sizeof ( char ) , strlen ( DS_TAG_DEVICE_MAX_COMPUTE_UNITS_END ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_MAX_CLOCK_FREQ , sizeof ( char ) , strlen ( DS_TAG_DEVICE_MAX_CLOCK_FREQ ) , profileFile ) ; ( void ) FormatLocaleString ( tmp , sizeof ( tmp ) , "%d" , profile -> devices [ i ] . oclMaxClockFrequency ) ; fwrite ( tmp , sizeof ( char ) , strlen ( tmp ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_MAX_CLOCK_FREQ_END , sizeof ( char ) , strlen ( DS_TAG_DEVICE_MAX_CLOCK_FREQ_END ) , profileFile ) ; } break ; default : status = DS_UNKNOWN_DEVICE_TYPE ; break ; } fwrite ( DS_TAG_SCORE , sizeof ( char ) , strlen ( DS_TAG_SCORE ) , profileFile ) ; status = serializer ( profile -> devices + i , & serializedScore , & serializedScoreSize ) ; if ( status == DS_SUCCESS && serializedScore != NULL && serializedScoreSize > 0 ) { fwrite ( serializedScore , sizeof ( char ) , serializedScoreSize , profileFile ) ; RelinquishMagickMemory ( serializedScore ) ; } fwrite ( DS_TAG_SCORE_END , sizeof ( char ) , strlen ( DS_TAG_SCORE_END ) , profileFile ) ; fwrite ( DS_TAG_DEVICE_END , sizeof ( char ) , strlen ( DS_TAG_DEVICE_END ) , profileFile ) ; fwrite ( "\n" , sizeof ( char ) , 1 , profileFile ) ; } fclose ( profileFile ) ; } return status ; } 