test_stream_writev_full ( ) { mongoc_stream_t * error_stream = failing_stream_new ( - 1 ) ; mongoc_stream_t * short_stream = failing_stream_new ( 10 ) ; mongoc_stream_t * success_stream = failing_stream_new ( 100 ) ; char bufa [ 20 ] ; char bufb [ 80 ] ; bool r ; mongoc_iovec_t iov [ 2 ] ; bson_error_t error = { 0 } ; const char * error_message = "Failure during socket delivery: " ; const char * short_message = "Failure to send all requested bytes (only " "sent: 10/100 in 100ms) during socket delivery" ; iov [ 0 ] . iov_base = bufa ; iov [ 0 ] . iov_len = sizeof ( bufa ) ; iov [ 1 ] . iov_base = bufb ; iov [ 1 ] . iov_len = sizeof ( bufb ) ; errno = EINVAL ; r = _mongoc_stream_writev_full ( error_stream , iov , 2 , 100 , & error ) ; BSON_ASSERT ( ! r ) ; ASSERT_CMPINT ( error . domain , == , MONGOC_ERROR_STREAM ) ; ASSERT_CMPINT ( error . code , == , MONGOC_ERROR_STREAM_SOCKET ) ; ASSERT_STARTSWITH ( error . message , error_message ) ; errno = 0 ; r = _mongoc_stream_writev_full ( short_stream , iov , 2 , 100 , & error ) ; BSON_ASSERT ( ! r ) ; ASSERT_CMPINT ( error . domain , == , MONGOC_ERROR_STREAM ) ; ASSERT_CMPINT ( error . code , == , MONGOC_ERROR_STREAM_SOCKET ) ; ASSERT_CMPSTR ( error . message , short_message ) ; errno = 0 ; r = _mongoc_stream_writev_full ( success_stream , iov , 2 , 100 , & error ) ; BSON_ASSERT ( r ) ; mongoc_stream_destroy ( error_stream ) ; mongoc_stream_destroy ( short_stream ) ; } 