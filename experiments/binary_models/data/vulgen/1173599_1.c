List * map_partition_varattnos ( List * expr , int fromrel_varno , Relation to_rel , Relation from_rel ) { if ( expr != NIL ) { AttrMap * part_attmap ; bool found_whole_row ; expr = ( List * ) map_variable_attnos ( ( Node * ) expr , fromrel_varno , 0 , part_attmap , RelationGetForm ( to_rel ) -> reltype , & found_whole_row ) ; } return expr ; } bool has_partition_attrs ( Relation rel , Bitmapset * attnums , bool * used_in_expr ) { PartitionKey key ; int partnatts ; List * partexprs ; ListCell * partexprs_item ; int i ; if ( attnums == NULL || rel -> rd_rel -> relkind != RELKIND_PARTITIONED_TABLE ) { return false ; } key = RelationGetPartitionKey ( rel ) ; partnatts = get_partition_natts ( key ) ; partexprs = get_partition_exprs ( key ) ; partexprs_item = list_head ( partexprs ) ; for ( i = 0 ; i < partnatts ; i ++ ) { AttrNumber partattno = get_partition_col_attnum ( key , i ) ; if ( partattno != 0 ) { if ( bms_is_member ( partattno - FirstLowInvalidHeapAttributeNumber , attnums ) ) { if ( used_in_expr ) { * used_in_expr = false ; } return true ; } } else { Node * expr = ( Node * ) lfirst ( partexprs_item ) ; Bitmapset * expr_attrs = NULL ; pull_varattnos ( expr , 1 , & expr_attrs ) ; partexprs_item = lnext ( partexprs , partexprs_item ) ; if ( bms_overlap ( attnums , expr_attrs ) ) { if ( used_in_expr ) { * used_in_expr = true ; } return true ; } } } return false ; } 