static void add_audio_stream ( OutputStream * ost , AVFormatContext * oc , enum AVCodecID codec_id ) { AVCodecContext * c ; AVCodec * codec ; int ret ; codec = avcodec_find_encoder ( codec_id ) ; if ( ! codec ) { fprintf ( stderr , "codec not found\n" ) ; exit ( 1 ) ; } ost -> st = avformat_new_stream ( oc , NULL ) ; if ( ! ost -> st ) { fprintf ( stderr , "Could not alloc stream\n" ) ; exit ( 1 ) ; } c = avcodec_alloc_context3 ( codec ) ; if ( ! c ) { fprintf ( stderr , "Could not alloc an encoding context\n" ) ; exit ( 1 ) ; } ost -> enc = c ; c -> sample_fmt = codec -> sample_fmts ?codec -> sample_fmts [ 0 ] : AV_SAMPLE_FMT_S16 ; c -> sample_rate = codec -> supported_samplerates ?codec -> supported_samplerates [ 0 ] : 44100 ; c -> channel_layout = codec -> channel_layouts ?codec -> channel_layouts [ 0 ] : AV_CH_LAYOUT_STEREO ; c -> bit_rate = 64000 ; ost -> st -> time_base = ( AVRational ) { 1 c -> sample_rate } ; if ( oc -> oformat -> flags & AVFMT_GLOBALHEADER ) { c -> flags |= AV_CODEC_FLAG_GLOBAL_HEADER ; } ost -> avr = avresample_alloc_context ( ) ; if ( ! ost -> avr ) { fprintf ( stderr , "Error allocating the resampling context\n" ) ; exit ( 1 ) ; } av_opt_set_int ( ost -> avr , "in_sample_fmt" , AV_SAMPLE_FMT_S16 , 0 ) ; av_opt_set_int ( ost -> avr , "in_sample_rate" , 44100 , 0 ) ; av_opt_set_int ( ost -> avr , "in_channel_layout" , AV_CH_LAYOUT_STEREO , 0 ) ; av_opt_set_int ( ost -> avr , "out_sample_fmt" , c -> sample_fmt , 0 ) ; av_opt_set_int ( ost -> avr , "out_sample_rate" , c -> sample_rate , 0 ) ; av_opt_set_int ( ost -> avr , "out_channel_layout" , c -> channel_layout , 0 ) ; ret = avresample_open ( ost -> avr ) ; if ( ret < 0 ) { fprintf ( stderr , "Error opening the resampling context\n" ) ; exit ( 1 ) ; } } 