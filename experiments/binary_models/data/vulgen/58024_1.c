static void do_bpf_iter_setsockopt ( struct bpf_iter_setsockopt * iter_skel , bool random_retry ) { int * reuse_listen_fds = NULL , * accepted_fds = NULL , * est_fds = NULL ; unsigned int nr_reuse_listens = 256 , nr_est = 256 ; int err , iter_fd = - 1 , listen_fd = - 1 ; char buf ; listen_fd = start_server ( AF_INET6 , SOCK_STREAM , "::1" , 0 , 0 ) ; if ( ! ASSERT_EQ ( set_bpf_cubic ( & listen_fd , 1 ) , 1 , "set listen_fd to cubic" ) ) { done } iter_skel -> bss -> listen_hport = get_local_port ( listen_fd ) ; if ( ! ASSERT_NEQ ( iter_skel -> bss -> listen_hport , 0 , "get_local_port(listen_fd)" ) ) { done } est_fds = make_established ( listen_fd , nr_est , & accepted_fds ) ; if ( ! ASSERT_OK_PTR ( est_fds , "create established" ) ) { done } reuse_listen_fds = start_reuseport_server ( AF_INET6 , SOCK_STREAM , "::1" , 0 , 0 , nr_reuse_listens ) ; if ( ! ASSERT_OK_PTR ( reuse_listen_fds , "start_reuseport_server" ) ) { done } if ( ! ASSERT_EQ ( set_bpf_cubic ( reuse_listen_fds , nr_reuse_listens ) , nr_reuse_listens , "set reuse_listen_fds to cubic" ) ) { done } iter_skel -> bss -> reuse_listen_hport = get_local_port ( reuse_listen_fds [ 0 ] ) ; if ( ! ASSERT_NEQ ( iter_skel -> bss -> reuse_listen_hport , 0 , "get_local_port(reuse_listen_fds[0])" ) ) { done } iter_skel -> bss -> random_retry = random_retry ; iter_fd = bpf_iter_create ( bpf_link__fd ( iter_skel -> links . change_tcp_cc ) ) ; if ( ! ASSERT_GE ( iter_fd , 0 , "create iter_fd" ) ) { done } while ( ( err = read ( iter_fd , & buf , sizeof ( buf ) ) ) == - 1 && errno == EAGAIN ) { } if ( ! ASSERT_OK ( err , "read iter error" ) ) { done } ASSERT_EQ ( check_bpf_dctcp ( reuse_listen_fds , nr_reuse_listens ) , nr_reuse_listens , "check reuse_listen_fds dctcp" ) ; ASSERT_EQ ( check_bpf_dctcp ( & listen_fd , 1 ) , 1 , "check listen_fd dctcp" ) ; ASSERT_EQ ( check_bpf_dctcp ( est_fds , nr_est ) , nr_est , "check est_fds dctcp" ) ; ASSERT_EQ ( check_bpf_dctcp ( accepted_fds , nr_est ) , nr_est , "check accepted_fds dctcp" ) ; done if ( iter_fd != - 1 ) { close ( iter_fd ) ; } if ( listen_fd != - 1 ) { close ( listen_fd ) ; } free_fds ( reuse_listen_fds , nr_reuse_listens ) ; free_fds ( accepted_fds , nr_est ) ; free_fds ( est_fds , nr_est ) ; } 