void send_fd ( int sock ) { struct msghdr msg ; struct cmsghdr * cmp ; { struct cmsghdr hdr ; char buf [ CMSG_SPACE ( sizeof ( int ) ) ] ; } , cmsgbuf memset ( & msg , 0 , sizeof ( msg ) ) ; msg . msg_control = & cmsgbuf . buf ; msg . msg_controllen = sizeof ( cmsgbuf . buf ) ; cmp = CMSG_FIRSTHDR ( & msg ) ; cmp -> cmsg_level = SOL_SOCKET ; cmp -> cmsg_type = SCM_RIGHTS ; * ( int * ) CMSG_DATA ( cmp ) = fileno ( skey . keyfile ) ; if ( sendmsg ( sock , & msg , 0 ) == - 1 ) { syslog ( LOG_ERR , "sendmsg: %m" ) ; } } 