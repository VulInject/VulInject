static rsRetVal gtlsGetCN ( gnutls_x509_crt_t * pCert , cstr_t * * ppstrCN ) { DEFiRet ; int gnuRet ; int i ; int bFound ; cstr_t * pstrCN = NULL ; size_t size ; uchar szDN [ 1024 ] ; assert ( pCert != NULL ) ; assert ( ppstrCN != NULL ) ; assert ( * ppstrCN == NULL ) ; size = sizeof ( szDN ) ; CHKgnutls ( gnutls_x509_crt_get_dn ( * pCert , ( char * ) szDN , & size ) ) ; i = 0 ; bFound = 0 ; while ( ! bFound && szDN [ i ] != '\0' ) { if ( szDN [ i ] == 'C' && szDN [ i + 1 ] == 'N' && szDN [ i + 2 ] == '=' ) { bFound = 1 ; i += 2 ; } i ++ ; } if ( ! bFound ) { FINALIZE ; } CHKiRet ( cstrConstruct ( & pstrCN ) ) ; while ( szDN [ i ] != '\0' && szDN [ i ] != ',' ) { if ( szDN [ i ] == '\\' ) { ++ i ; CHKiRet ( cstrAppendChar ( pstrCN , szDN [ i ] ) ) ; } else { CHKiRet ( cstrAppendChar ( pstrCN , szDN [ i ] ) ) ; } ++ i ; } cstrFinalize ( pstrCN ) ; * ppstrCN = pstrCN ; finalize_it if ( iRet != RS_RET_OK ) { if ( pstrCN != NULL ) { cstrDestruct ( & pstrCN ) ; } } RETiRet ; } 