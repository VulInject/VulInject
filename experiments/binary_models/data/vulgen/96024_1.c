static void bufferevent_connect_getaddrinfo_cb ( int result , struct evutil_addrinfo * ai , void * arg ) { struct bufferevent * bev = arg ; struct bufferevent_private * bev_p = BEV_UPCAST ( bev ) ; int r ; BEV_LOCK ( bev ) ; bufferevent_unsuspend_write_ ( bev , BEV_SUSPEND_LOOKUP ) ; bufferevent_unsuspend_read_ ( bev , BEV_SUSPEND_LOOKUP ) ; bev_p -> dns_request = NULL ; if ( result == EVUTIL_EAI_CANCEL ) { bev_p -> dns_error = result ; bufferevent_decref_and_unlock_ ( bev ) ; return ; } if ( result != 0 ) { bev_p -> dns_error = result ; bufferevent_run_eventcb_ ( bev , BEV_EVENT_ERROR , 0 ) ; bufferevent_decref_and_unlock_ ( bev ) ; return ; } bufferevent_socket_set_conn_address_ ( bev , ai -> ai_addr , ( int ) ai -> ai_addrlen ) ; r = bufferevent_socket_connect ( bev , ai -> ai_addr , ( int ) ai -> ai_addrlen ) ; if ( r < 0 ) { bufferevent_run_eventcb_ ( bev , BEV_EVENT_ERROR , 0 ) ; } bufferevent_decref_and_unlock_ ( bev ) ; evutil_freeaddrinfo ( ai ) ; } 