void bop_trap ( ulong_t * tfp ) { struct trapframe * tf = ( trapframe * ) tfp ; bop_frame_t fakeframe ; static int depth ; if ( ++ depth > 2 ) { bop_panic ( "Nested trap" ) ; } bop_printf ( NULL , "Unexpected trap\n" ) ; if ( tf -> code_seg != B64CODE_SEL ) { tf = ( trapframe * ) ( tfp - 1 ) ; } else { bop_printf ( NULL , "error code           0x%lx\n" , tf -> error_code & 0xffffffff ) ; } bop_printf ( NULL , "instruction pointer  0x%lx\n" , tf -> inst_ptr ) ; bop_printf ( NULL , "code segment         0x%lx\n" , tf -> code_seg & 0xffff ) ; bop_printf ( NULL , "flags register       0x%lx\n" , tf -> flags_reg ) ; bop_printf ( NULL , "return %%rsp          0x%lx\n" , tf -> stk_ptr ) ; bop_printf ( NULL , "return %%ss           0x%lx\n" , tf -> stk_seg & 0xffff ) ; bop_printf ( NULL , "%%cr2			0x%lx\n" , getcr2 ( ) ) ; fakeframe . old_frame = ( bop_frame_t * ) * ( tfp - 3 ) ; fakeframe . retaddr = ( pc_t ) tf -> inst_ptr ; bop_printf ( NULL , "Attempting stack backtrace:\n" ) ; bop_traceback ( & fakeframe ) ; bop_panic ( "unexpected trap in early boot" ) ; } 