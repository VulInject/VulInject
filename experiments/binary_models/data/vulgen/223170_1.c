static int erl_send_k ( struct sip_msg * msg , char * _pid , char * _emsg ) { erl_param_t * param_pid = ( erl_param_t * ) _pid ; erl_param_t * param_emsg = ( erl_param_t * ) _emsg ; str str_msg ; sr_xavp_t * xmsg = NULL ; pv_spec_t sp ; pv_spec_t * nsp ; pv_param_t pvp ; pv_name_t * pvn ; pv_index_t * pvi ; int idx ; int idxf ; int attr ; ei_x_buff ei_msg ; erlang_pid * pid ; switch ( param_pid -> type ) { case ERL_PARAM_XBUFF_SPEC : nsp = NULL ; pvp = param_pid -> value . sp . pvp ; if ( pvp . pvn . type == PV_NAME_PVAR ) { nsp = pvp . pvn . u . dname ; } if ( nsp ) { pvi = & nsp -> pvp . pvi ; pvn = & nsp -> pvp . pvn ; sp = * nsp ; } else { pvi = & pvp . pvi ; pvn = & pvp . pvn ; sp = param_pid -> value . sp ; } if ( sp . getf == pv_pid_get ) { xmsg = pv_pid_get_pid ( & pvn -> u . isname . name . s ) ; } if ( sp . getf == pv_xbuff_get ) { xmsg = pv_xbuff_get_xbuff ( & pvn -> u . isname . name . s ) ; } else { LM_ERR ( "BUG: unexpected type for pid parameter\n" ) ; return - 1 ; } attr = xbuff_get_attr_flags ( pvi -> type ) ; if ( pv_get_spec_index ( msg , & pvp , & idx , & idxf ) ) { LM_ERR ( "invalid index\n" ) ; return - 1 ; } if ( xbuff_is_attr_set ( attr ) ) { LM_WARN ( "attribute is not expected here!\n" ) ; } if ( ! xmsg ) { LM_ERR ( "undefined variable '%.*s'\n" , STR_FMT ( & pvn -> u . isname . name . s ) ) ; return - 1 ; } xmsg = xmsg -> val . v . xavp ; if ( ( idxf != PV_IDX_ALL ) && ! xbuff_is_no_index ( attr ) ) { xmsg = xavp_get_nth ( & xmsg -> val . v . xavp , idx , NULL ) ; } if ( ! xmsg ) { LM_ERR ( "undefined value in '%.*s' at index %d\n" , STR_FMT ( & pvn -> u . isname . name . s ) , idx ) ; err } if ( xmsg -> name . s [ 0 ] == 'p' && xmsg -> val . type == SR_XTYPE_DATA && xmsg -> val . v . data ) { pid = xmsg -> val . v . data -> p ; } else { LM_ERR ( "invalid value for pid parameter\n" ) ; return - 1 ; } break ; default : LM_ERR ( "unexpected type for pid parameter\n" ) ; return - 1 ; } ei_x_new_with_version ( & ei_msg ) ; switch ( param_emsg -> type ) { case ERL_PARAM_FPARAM : if ( get_str_fparam ( & str_msg , msg , param_emsg -> value . fp ) ) { LM_ERR ( "can't get emsg parameter\n" ) ; err } ei_x_encode_string_len ( & ei_msg , str_msg . s , str_msg . len ) ; break ; case ERL_PARAM_XBUFF_SPEC : nsp = NULL ; pvp = param_emsg -> value . sp . pvp ; if ( nsp ) { pvi = & nsp -> pvp . pvi ; pvn = & nsp -> pvp . pvn ; sp = * nsp ; } else { pvi = & pvp . pvi ; pvn = & pvp . pvn ; sp = param_emsg -> value . sp ; } if ( sp . getf == pv_list_get ) { xmsg = pv_list_get_list ( & pvn -> u . isname . name . s ) ; } if ( sp . getf == pv_xbuff_get ) { xmsg = pv_xbuff_get_xbuff ( & pvn -> u . isname . name . s ) ; } if ( sp . getf == pv_tuple_get ) { xmsg = pv_tuple_get_tuple ( & pvn -> u . isname . name . s ) ; } if ( sp . getf == pv_atom_get ) { xmsg = pv_atom_get_atom ( & pvn -> u . isname . name . s ) ; } if ( sp . getf == pv_pid_get ) { xmsg = pv_pid_get_pid ( & pvn -> u . isname . name . s ) ; } attr = xbuff_get_attr_flags ( pvi -> type ) ; if ( pv_get_spec_index ( msg , & pvp , & idx , & idxf ) ) { LM_ERR ( "invalid index\n" ) ; return - 1 ; } if ( xbuff_is_attr_set ( attr ) ) { LM_WARN ( "attribute is not expected here!\n" ) ; } if ( ! xmsg ) { LM_ERR ( "undefined variable '%.*s'\n" , STR_FMT ( & pvn -> u . isname . name . s ) ) ; return - 1 ; } xmsg = xmsg -> val . v . xavp ; if ( ( idxf != PV_IDX_ALL ) && ! xbuff_is_no_index ( attr ) ) { xmsg = xavp_get_nth ( & xmsg -> val . v . xavp , idx , NULL ) ; } if ( ! xmsg ) { LM_ERR ( "undefined value in '%.*s' at index %d\n" , STR_FMT ( & pvn -> u . isname . name . s ) , idx ) ; err } if ( erl_api . xavp2xbuff ( & ei_msg , xmsg ) ) { LM_ERR ( "failed to encode %.*s\n" , STR_FMT ( & pvn -> u . isname . name . s ) ) ; err } break ; default : LM_ERR ( "unexpected type for emsg parameter\n" ) ; return - 1 ; } if ( erl_api . send ( pid , & ei_msg ) ) { err } ei_x_free ( & ei_msg ) ; return 1 ; err ei_x_free ( & ei_msg ) ; return - 1 ; } 