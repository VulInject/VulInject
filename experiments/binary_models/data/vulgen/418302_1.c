static int sig_sign ( const char * keypath , const char * sig_namespace , int require_agent , int argc , char * * argv , char * const * opts , size_t nopts ) { int i , fd = - 1 , r , ret = - 1 ; int agent_fd = - 1 ; struct sshkey * pubkey = NULL , * privkey = NULL , * signkey = NULL ; sshsig_signer * signer = NULL ; char * hashalg = NULL ; for ( i = 0 ; i < argc ; i ++ ) { if ( strcmp ( argv [ i ] , "-" ) != 0 ) { continue ; } if ( i > 0 || argc > 1 ) { fatal ( "Cannot sign mix of paths and standard input" ) ; } } if ( sig_process_opts ( opts , nopts , & hashalg , NULL , NULL ) != 0 ) { done } if ( ( r = sshkey_load_public ( keypath , & pubkey , NULL ) ) != 0 ) { error_r ( r , "Couldn't load public key %s" , keypath ) ; done } if ( ( r = ssh_get_authentication_socket ( & agent_fd ) ) != 0 ) { if ( require_agent ) { fatal ( "Couldn't get agent socket" ) ; } debug_r ( r , "Couldn't get agent socket" ) ; } else { if ( ( r = ssh_agent_has_key ( agent_fd , pubkey ) ) == 0 ) { signer = agent_signer ; } else { if ( require_agent ) { fatal ( "Couldn't find key in agent" ) ; } debug_r ( r , "Couldn't find key in agent" ) ; } } if ( signer == NULL ) { if ( ( privkey = load_sign_key ( keypath , pubkey ) ) == NULL ) { done } signkey = privkey ; } else { signkey = pubkey ; } if ( argc == 0 ) { if ( ( r = sign_one ( signkey , "(stdin)" , STDIN_FILENO , sig_namespace , hashalg , signer , & agent_fd ) ) != 0 ) { done } } else { for ( i = 0 ; i < argc ; i ++ ) { if ( strcmp ( argv [ i ] , "-" ) == 0 ) { fd = STDIN_FILENO ; } if ( ( fd = open ( argv [ i ] , O_RDONLY ) ) == - 1 ) { error ( "Cannot open %s for signing: %s" , argv [ i ] , strerror ( errno ) ) ; done } if ( ( r = sign_one ( signkey , argv [ i ] , fd , sig_namespace , hashalg , signer , & agent_fd ) ) != 0 ) { done } fd = - 1 ; } } ret = 0 ; done if ( fd != - 1 && fd != STDIN_FILENO ) { close ( fd ) ; } sshkey_free ( pubkey ) ; sshkey_free ( privkey ) ; free ( hashalg ) ; return ret ; } 