static int atomisp_try_fmt_file ( struct atomisp_device * isp , struct v4l2_format * f ) { u32 width = f -> fmt . pix . width ; u32 height = f -> fmt . pix . height ; u32 pixelformat = f -> fmt . pix . pixelformat ; enum v4l2_field field = f -> fmt . pix . field ; u32 depth ; if ( ! atomisp_get_format_bridge ( pixelformat ) ) { dev_err ( isp -> dev , "Wrong output pixelformat\n" ) ; return - EINVAL ; } depth = get_pixel_depth ( pixelformat ) ; if ( field == V4L2_FIELD_ANY ) { field = V4L2_FIELD_NONE ; } f -> fmt . pix . field = field ; f -> fmt . pix . width = clamp_t ( u32 , rounddown ( width , ( u32 ) ATOM_ISP_STEP_WIDTH ) , ATOM_ISP_MIN_WIDTH , ATOM_ISP_MAX_WIDTH ) ; f -> fmt . pix . height = clamp_t ( u32 , rounddown ( height , ( u32 ) ATOM_ISP_STEP_HEIGHT ) , ATOM_ISP_MIN_HEIGHT , ATOM_ISP_MAX_HEIGHT ) ; f -> fmt . pix . bytesperline = ( width * depth ) >> 3 ; return 0 ; } 