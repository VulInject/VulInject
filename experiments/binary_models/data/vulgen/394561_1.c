int proc_setup_thread_self ( struct super_block * s ) { struct inode * root_inode = d_inode ( s -> s_root ) ; struct proc_fs_info * fs_info = proc_sb_info ( s ) ; struct dentry * thread_self ; int ret = - ENOMEM ; inode_lock ( root_inode ) ; thread_self = d_alloc_name ( s -> s_root , "thread-self" ) ; if ( thread_self ) { struct inode * inode = new_inode ( s ) ; if ( inode ) { inode -> i_ino = thread_self_inum ; inode -> i_mtime = inode -> i_atime = inode -> i_ctime = current_time ( inode ) ; inode -> i_uid = GLOBAL_ROOT_UID ; inode -> i_gid = GLOBAL_ROOT_GID ; inode -> i_op = & proc_thread_self_inode_operations ; d_add ( thread_self , inode ) ; ret = 0 ; } else { dput ( thread_self ) ; } } inode_unlock ( root_inode ) ; if ( ret ) { pr_err ( "proc_fill_super: can't allocate /proc/thread-self\n" ) ; } else { fs_info -> proc_thread_self = thread_self ; } return ret ; } 