gboolean keystore_store_key ( const char * nick , const char * key , enum fish_mode mode ) { const char * password ; char * encrypted ; char * wrapped ; gboolean ok = FALSE ; GKeyFile * keyfile = getConfigFile ( ) ; char * escaped_nick = escape_nickname ( nick ) ; delete_nick ( keyfile , escaped_nick ) ; password = get_keystore_password ( ) ; if ( password ) { encrypted = fish_encrypt ( password , strlen ( password ) , key , strlen ( key ) , FISH_CBC_MODE ) ; if ( ! encrypted ) { end } wrapped = g_strconcat ( "+OK *" , encrypted , NULL ) ; g_free ( encrypted ) ; g_key_file_set_string ( keyfile , escaped_nick , "key" , wrapped ) ; g_free ( wrapped ) ; } else { g_key_file_set_string ( keyfile , escaped_nick , "key" , key ) ; } g_key_file_set_integer ( keyfile , escaped_nick , "mode" , mode ) ; ok = save_keystore ( keyfile ) ; end g_key_file_free ( keyfile ) ; return ok ; } 