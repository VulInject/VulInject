static void ifdel ( struct interface * ifp ) { struct rewire_data wire ; boolean_t resurrected ; struct physical_interface * phyi ; trace_if ( "Del" , ifp ) ; ifp -> int_state |= IS_BROKE ; link_out ( ifp , offsetof ( interface , int_link ) ) ; hash_unlink ( & ahash_tbl , ifp ) ; hash_unlink ( & nhash_tbl , ifp ) ; if ( ifp -> int_if_flags & IFF_BROADCAST ) { hash_unlink ( & bhash_tbl , ifp ) ; } if ( ( phyi = ifp -> int_phys ) != NULL ) { link_out ( ifp , offsetof ( interface , int_ilist ) ) ; if ( phyi -> phyi_interface == NULL ) { hash_unlink ( & ihash_tbl , phyi ) ; } } resurrected = _B_FALSE ; if ( ! ( ifp -> int_state & IS_DUP ) && ( wire . if_new = check_dup ( ifp -> int_name , ifp -> int_addr , ifp -> int_dstaddr , ifp -> int_mask , ifp -> int_if_flags , _B_TRUE ) ) != NULL && ! IS_IFF_QUIET ( wire . if_new -> int_if_flags ) ) { trace_act ( "promoting duplicate %s in place of %s" , wire . if_new -> int_name , ifp -> int_name ) ; wire . if_old = ifp ; wire . metric_delta = wire . if_new -> int_metric - ifp -> int_metric ; ( void ) rn_walktree ( rhead , walk_rewire , & wire ) ; kern_rewire_ifp ( wire . if_old , wire . if_new ) ; if_rewire_rdisc ( wire . if_old , wire . if_new ) ; wire . if_new -> int_state &= ~ IS_DUP ; tot_interfaces ++ ; if ( ! IS_RIP_OFF ( wire . if_new -> int_state ) ) { rip_interfaces ++ ; } if ( ! IS_RIP_OUT_OFF ( wire . if_new -> int_state ) ) { ripout_interfaces ++ ; } if ( IS_IFF_ROUTING ( wire . if_new -> int_if_flags ) ) { fwd_interfaces ++ ; } set_rdisc_mg ( wire . if_new , 1 ) ; rip_mcast_on ( wire . if_new ) ; resurrected = _B_TRUE ; } rip_mcast_off ( ifp ) ; if ( rip_sock_interface == ifp ) { rip_sock_interface = NULL ; } set_rdisc_mg ( ifp , 0 ) ; if ( ! ( ifp -> int_state & IS_DUP ) && ! IS_IFF_QUIET ( ifp -> int_if_flags ) ) { tot_interfaces -- ; if ( ! IS_RIP_OFF ( ifp -> int_state ) ) { rip_interfaces -- ; } if ( ! IS_RIP_OUT_OFF ( ifp -> int_state ) ) { ripout_interfaces -- ; } if ( IS_IFF_ROUTING ( ifp -> int_if_flags ) ) { fwd_interfaces -- ; } } if ( ! resurrected ) { ( void ) rn_walktree ( rhead , walk_bad , ifp ) ; kern_flush_ifp ( ifp ) ; if_bad_rdisc ( ifp ) ; } free ( ifp ) ; } 