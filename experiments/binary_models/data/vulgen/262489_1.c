GSSAPI_LIB_FUNCTION OM_uint32 GSSAPI_LIB_CALL gsskrb5_extract_authz_data_from_sec_context ( OM_uint32 * minor_status , gss_ctx_id_t context_handle , int ad_type , gss_buffer_t ad_data ) { gss_buffer_set_t data_set = GSS_C_NO_BUFFER_SET ; OM_uint32 maj_stat , tmp ; gss_OID_desc oid_flat ; heim_oid baseoid , oid ; size_t size ; if ( context_handle == GSS_C_NO_CONTEXT ) { * minor_status = EINVAL ; return GSS_S_FAILURE ; } if ( der_get_oid ( GSS_KRB5_EXTRACT_AUTHZ_DATA_FROM_SEC_CONTEXT_X -> elements , GSS_KRB5_EXTRACT_AUTHZ_DATA_FROM_SEC_CONTEXT_X -> length , & baseoid , NULL ) != 0 ) { * minor_status = EINVAL ; return GSS_S_FAILURE ; } oid . length = baseoid . length + 1 ; oid . components = calloc ( oid . length , sizeof ( * oid . components ) ) ; if ( oid . components == NULL ) { * minor_status = ENOMEM ; return GSS_S_FAILURE ; } memcpy ( oid . components , baseoid . components , baseoid . length * sizeof ( * baseoid . components ) ) ; der_free_oid ( & baseoid ) ; oid . components [ oid . length - 1 ] = ad_type ; oid_flat . length = ( OM_uint32 ) der_length_oid ( & oid ) ; oid_flat . elements = malloc ( oid_flat . length ) ; if ( oid_flat . elements == NULL ) { free ( oid . components ) ; * minor_status = ENOMEM ; return GSS_S_FAILURE ; } if ( der_put_oid ( ( unsigned char * ) oid_flat . elements + oid_flat . length - 1 , oid_flat . length , & oid , & size ) != 0 ) { free ( oid . components ) ; _gss_free_oid ( & tmp , & oid_flat ) ; * minor_status = EINVAL ; return GSS_S_FAILURE ; } if ( oid_flat . length != size ) { abort ( ) ; } free ( oid . components ) ; maj_stat = gss_inquire_sec_context_by_oid ( minor_status , context_handle , & oid_flat , & data_set ) ; _gss_free_oid ( & tmp , & oid_flat ) ; if ( maj_stat ) { return maj_stat ; } if ( data_set == GSS_C_NO_BUFFER_SET || data_set -> count != 1 ) { gss_release_buffer_set ( minor_status , & data_set ) ; * minor_status = EINVAL ; return GSS_S_FAILURE ; } ad_data -> value = malloc ( data_set -> elements [ 0 ] . length ) ; if ( ad_data -> value == NULL ) { gss_release_buffer_set ( minor_status , & data_set ) ; * minor_status = ENOMEM ; return GSS_S_FAILURE ; } ad_data -> length = data_set -> elements [ 0 ] . length ; memcpy ( ad_data -> value , data_set -> elements [ 0 ] . value , ad_data -> length ) ; gss_release_buffer_set ( minor_status , & data_set ) ; * minor_status = 0 ; return GSS_S_COMPLETE ; } 