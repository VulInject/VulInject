static void ResizeH_compatible ( ResampleInfo * info ) { const RS_IMAGE16 * input = info -> input ; const RS_IMAGE16 * output = info -> output ; const guint old_size = info -> old_size ; const guint new_size = info -> new_size ; gint pixelsize = input -> pixelsize ; gfloat pos_step = ( ( gfloat ) old_size ) / ( ( gfloat ) new_size ) ; gfloat filter_step = MIN ( 1.0 / pos_step , 1.0 ) ; gfloat filter_support = ( gfloat ) lanczos_taps ( ) / filter_step ; gint fir_filter_size = ( gint ) ( ceil ( filter_support * 2 ) ) ; if ( old_size <= fir_filter_size ) { return ResizeH_fast ( info ) ; } gint * weights = g_new ( gint , new_size * fir_filter_size ) ; gint * offsets = g_new ( gint , new_size ) ; gfloat pos = 0.0 ; gint i , j , k ; for ( i = 0 ; i < new_size ; ++ i ) { gint end_pos = ( gint ) ( pos + filter_support ) ; if ( end_pos > old_size - 1 ) { end_pos = old_size - 1 ; } gint start_pos = end_pos - fir_filter_size + 1 ; if ( start_pos < 0 ) { start_pos = 0 ; } offsets [ i ] = start_pos * pixelsize ; gfloat total = 0.0 ; gfloat ok_pos = MAX ( 0.0 , MIN ( old_size - 1 , pos ) ) ; for ( j = 0 ; j < fir_filter_size ; ++ j ) { total += lanczos_weight ( ( start_pos + j - ok_pos ) * filter_step ) ; } g_assert ( total > 0.0f ) ; gfloat total2 = 0.0 ; for ( k = 0 ; k < fir_filter_size ; ++ k ) { gfloat total3 = total2 + lanczos_weight ( ( start_pos + k - ok_pos ) * filter_step ) / total ; weights [ i * fir_filter_size + k ] = ( gint ) ( total3 * FPScale + 0.5 ) - ( gint ) ( total2 * FPScale + 0.5 ) ; total2 = total3 ; } pos += pos_step ; } guint y , x , c ; for ( y = info -> dest_offset_other ; y < info -> dest_end_other ; y ++ ) { gint * wg = weights ; gushort * in_line = GET_PIXEL ( input , 0 , y ) ; gushort * out = GET_PIXEL ( output , 0 , y ) ; for ( x = 0 ; x < new_size ; x ++ ) { guint i ; gushort * in = & in_line [ offsets [ x ] ] ; for ( c = 0 ; c < ch ; c ++ ) { gint acc = 0 ; for ( i = 0 ; i < fir_filter_size ; i ++ ) { acc += in [ i * pixelsize + c ] * wg [ i ] ; } out [ x * pixelsize + c ] = clampbits ( ( acc + ( FPScale / 2 ) ) >> FPScaleShift , 16 ) ; } wg += fir_filter_size ; } } g_free ( weights ) ; g_free ( offsets ) ; } 