icns_load ( , ) { IcnsResource * resources ; guint nResources ; gfloat current_resources = 0 ; GimpImage * image ; resources = g_new ( IcnsResource , 256 ) ; image = gimp_image_new ( 1024 , 1024 , GIMP_RGB ) ; nResources = 0 ; while ( resource_get_next ( icns , & resources [ nResources ++ ] ) ) { } for ( gint i = 0 ; iconTypes [ i ] . type ; i ++ ) { IcnsResource * icns ; IcnsResource * mask = NULL ; if ( ( icns = resource_find ( resources , iconTypes [ i ] . type , nResources ) ) ) { if ( ! iconTypes [ i ] . isModern ) { mask = resource_find ( resources , iconTypes [ i ] . mask , nResources ) ; } icns_attach_image ( image , & iconTypes [ i ] , icns , mask , iconTypes [ i ] . isModern ) ; gimp_progress_update ( current_resources ++ / nResources ) ; } } gimp_image_resize_to_layers ( image ) ; return image ; } 