int v4l2_device_register_subdev ( struct v4l2_device * v4l2_dev , struct v4l2_subdev * sd ) { int err ; if ( ! v4l2_dev || ! sd || sd -> v4l2_dev || ! sd -> name [ 0 ] ) { return - EINVAL ; } sd -> owner_v4l2_dev = v4l2_dev -> dev && v4l2_dev -> dev -> driver && sd -> owner == v4l2_dev -> dev -> driver -> owner ; sd -> v4l2_dev = v4l2_dev ; err = v4l2_ctrl_add_handler ( v4l2_dev -> ctrl_handler , sd -> ctrl_handler , NULL , true ) ; if ( err ) { error_module } if ( v4l2_dev -> mdev ) { err = media_device_register_entity ( v4l2_dev -> mdev , & sd -> entity ) ; if ( err < 0 ) { error_module } } if ( sd -> internal_ops && sd -> internal_ops -> registered ) { err = sd -> internal_ops -> registered ( sd ) ; if ( err ) { error_unregister } } spin_lock ( & v4l2_dev -> lock ) ; list_add_tail ( & sd -> list , & v4l2_dev -> subdevs ) ; spin_unlock ( & v4l2_dev -> lock ) ; return 0 ; error_unregister media_device_unregister_entity ( & sd -> entity ) ; error_module if ( ! sd -> owner_v4l2_dev ) { module_put ( sd -> owner ) ; } sd -> v4l2_dev = NULL ; return err ; } 