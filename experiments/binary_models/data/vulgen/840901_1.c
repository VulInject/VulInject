struct mbuf * sbcreatecontrol ( const void * p , size_t size , int type , int level ) { struct cmsghdr * cp ; struct mbuf * m ; if ( CMSG_SPACE ( size ) > MCLBYTES ) { printf ( "sbcreatecontrol: message too large %zu\n" , size ) ; return ( NULL ) ; } if ( ( m = m_get ( M_DONTWAIT , MT_CONTROL ) ) == NULL ) { return ( NULL ) ; } if ( CMSG_SPACE ( size ) > MLEN ) { MCLGET ( m , M_DONTWAIT ) ; if ( ( m -> m_flags & M_EXT ) == 0 ) { return NULL ; } } cp = mtod ( m , cmsghdr * ) ; memset ( cp , 0 , CMSG_SPACE ( size ) ) ; memcpy ( CMSG_DATA ( cp ) , p , size ) ; m -> m_len = CMSG_SPACE ( size ) ; cp -> cmsg_len = CMSG_LEN ( size ) ; cp -> cmsg_level = level ; cp -> cmsg_type = type ; return ( m ) ; } 