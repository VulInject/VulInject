TEE_Result TEE_MACComputeFinal ( TEE_OperationHandle operation , const void * message , size_t messageLen , void * mac , size_t * macLen ) { TEE_Result res ; uint64_t ml ; if ( operation == TEE_HANDLE_NULL || ( ! message && messageLen ) ) { res = TEE_ERROR_BAD_PARAMETERS ; out } if ( operation -> info . operationClass != TEE_OPERATION_MAC ) { res = TEE_ERROR_BAD_PARAMETERS ; out } if ( ( operation -> info . handleState & TEE_HANDLE_FLAG_INITIALIZED ) == 0 ) { res = TEE_ERROR_BAD_PARAMETERS ; out } if ( operation -> operationState != TEE_OPERATION_STATE_ACTIVE ) { res = TEE_ERROR_BAD_PARAMETERS ; out } ml = * macLen ; res = _utee_hash_final ( operation -> state , message , messageLen , mac , & ml ) ; * macLen = ml ; if ( res != TEE_SUCCESS ) { out } operation -> info . handleState &= ~ TEE_HANDLE_FLAG_INITIALIZED ; operation -> operationState = TEE_OPERATION_STATE_INITIAL ; out if ( res != TEE_SUCCESS && res != TEE_ERROR_SHORT_BUFFER ) { TEE_Panic ( res ) ; } return res ; } 