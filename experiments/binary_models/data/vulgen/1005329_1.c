void evergreen_gpu_pci_config_reset ( struct radeon_device * rdev ) { struct evergreen_mc_save save ; u32 tmp , i ; dev_info ( rdev -> dev , "GPU pci config reset\n" ) ; WREG32 ( CP_ME_CNTL , CP_ME_HALT | CP_PFP_HALT ) ; udelay ( 50 ) ; tmp = RREG32 ( DMA_RB_CNTL ) ; tmp &= ~ DMA_RB_ENABLE ; WREG32 ( DMA_RB_CNTL , tmp ) ; r600_rlc_stop ( rdev ) ; udelay ( 50 ) ; rv770_set_clk_bypass_mode ( rdev ) ; pci_clear_master ( rdev -> pdev ) ; evergreen_mc_stop ( rdev , & save ) ; if ( evergreen_mc_wait_for_idle ( rdev ) ) { dev_warn ( rdev -> dev , "Wait for MC idle timed out !\n" ) ; } radeon_pci_config_reset ( rdev ) ; for ( i = 0 ; i < rdev -> usec_timeout ; i ++ ) { udelay ( 1 ) ; } } 