static int apple_spi_probe ( struct udevice * dev ) { struct apple_spi_priv * priv = dev_get_priv ( dev ) ; struct clk clkdev ; int ret ; priv -> base = dev_read_addr_ptr ( dev ) ; ret = clk_get_by_index ( dev , 0 , & clkdev ) ; if ( ret ) { return ret ; } priv -> clkfreq = clk_get_rate ( & clkdev ) ; writel ( APPLE_SPI_PIN_CS , priv -> base + APPLE_SPI_PIN ) ; writel ( readl ( priv -> base + APPLE_SPI_SHIFTCFG ) & ~ APPLE_SPI_SHIFTCFG_OVERRIDE_CS , priv -> base + APPLE_SPI_SHIFTCFG ) ; writel ( ( readl ( priv -> base + APPLE_SPI_PINCFG ) & ~ APPLE_SPI_PINCFG_CS_IDLE_VAL ) | APPLE_SPI_PINCFG_KEEP_CS , priv -> base + APPLE_SPI_PINCFG ) ; writel ( APPLE_SPI_CTRL_RX_RESET | APPLE_SPI_CTRL_TX_RESET , priv -> base + APPLE_SPI_CTRL ) ; writel ( FIELD_PREP ( APPLE_SPI_CFG_MODE , APPLE_SPI_CFG_MODE_IRQ ) | FIELD_PREP ( APPLE_SPI_CFG_WORD_SIZE , APPLE_SPI_CFG_WORD_SIZE_8B ) | FIELD_PREP ( APPLE_SPI_CFG_FIFO_THRESH , APPLE_SPI_CFG_FIFO_THRESH_8B ) , priv -> base + APPLE_SPI_CFG ) ; return 0 ; } 