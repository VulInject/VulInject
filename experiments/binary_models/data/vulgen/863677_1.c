static int handle_crypt_topic ( char * word [ ] , char * word_eol [ ] , void * userdata ) { const char * target ; const char * topic = word_eol [ 2 ] ; enum fish_mode mode ; GString * command ; GSList * encrypted_list ; if ( ! * topic ) { hexchat_print ( ph , usage_topic ) ; return HEXCHAT_EAT_ALL ; } if ( hexchat_list_int ( ph , NULL , "type" ) != 2 ) { hexchat_printf ( ph , "Please change to the channel window where you want to set the topic!" ) ; return HEXCHAT_EAT_ALL ; } target = hexchat_get_info ( ph , "channel" ) ; if ( ! fish_nick_has_key ( target ) ) { hexchat_printf ( ph , "/topic+ error, no key found for %s" , target ) ; return HEXCHAT_EAT_ALL ; } command = g_string_new ( "" ) ; g_string_printf ( command , "TOPIC %s +OK " , target ) ; encrypted_list = fish_encrypt_for_nick ( target , topic , & mode , get_prefix_length ( ) + command -> len ) ; if ( ! encrypted_list ) { g_string_free ( command , TRUE ) ; hexchat_printf ( ph , "/topic+ error, can't encrypt %s" , target ) ; return HEXCHAT_EAT_ALL ; } hexchat_commandf ( ph , "%s%s" , command -> str , ( char * ) encrypted_list -> data ) ; g_string_free ( command , TRUE ) ; return HEXCHAT_EAT_ALL ; } 