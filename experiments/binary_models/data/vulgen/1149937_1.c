static int nct3018y_probe ( struct i2c_client * client ) { struct nct3018y * nct3018y ; int err , flags ; if ( ! i2c_check_functionality ( client -> adapter , I2C_FUNC_I2C | I2C_FUNC_SMBUS_BYTE | I2C_FUNC_SMBUS_BLOCK_DATA ) ) { return - ENODEV ; } nct3018y = devm_kzalloc ( & client -> dev , sizeof ( nct3018y ) , GFP_KERNEL ) ; if ( ! nct3018y ) { return - ENOMEM ; } i2c_set_clientdata ( client , nct3018y ) ; nct3018y -> client = client ; device_set_wakeup_capable ( & client -> dev , 1 ) ; flags = i2c_smbus_read_byte_data ( client , NCT3018Y_REG_CTRL ) ; if ( flags < 0 ) { dev_dbg ( & client -> dev , "%s: read error\n" , __func__ ) ; return flags ; } if ( flags & NCT3018Y_BIT_TWO ) { dev_dbg ( & client -> dev , "%s: NCT3018Y_BIT_TWO is set\n" , __func__ ) ; } flags = NCT3018Y_BIT_TWO ; err = i2c_smbus_write_byte_data ( client , NCT3018Y_REG_CTRL , flags ) ; if ( err < 0 ) { dev_dbg ( & client -> dev , "Unable to write NCT3018Y_REG_CTRL\n" ) ; return err ; } flags = 0 ; err = i2c_smbus_write_byte_data ( client , NCT3018Y_REG_ST , flags ) ; if ( err < 0 ) { dev_dbg ( & client -> dev , "%s: write error\n" , __func__ ) ; return err ; } if ( IS_ERR ( nct3018y -> rtc ) ) { return PTR_ERR ( nct3018y -> rtc ) ; } nct3018y -> rtc -> ops = & nct3018y_rtc_ops ; nct3018y -> rtc -> range_min = RTC_TIMESTAMP_BEGIN_2000 ; nct3018y -> rtc -> range_max = RTC_TIMESTAMP_END_2099 ; if ( client -> irq > 0 ) { err = devm_request_threaded_irq ( & client -> dev , client -> irq , NULL , nct3018y_irq , IRQF_ONESHOT | IRQF_TRIGGER_FALLING , "nct3018y" , client ) ; if ( err ) { dev_dbg ( & client -> dev , "unable to request IRQ %d\n" , client -> irq ) ; return err ; } } else { clear_bit ( RTC_FEATURE_UPDATE_INTERRUPT , nct3018y -> rtc -> features ) ; clear_bit ( RTC_FEATURE_ALARM , nct3018y -> rtc -> features ) ; } nct3018y_clkout_register_clk ( nct3018y ) ; return devm_rtc_register_device ( nct3018y -> rtc ) ; } 