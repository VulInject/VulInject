static gint dissect_etf_type_content ( guint8 tag , packet_info * pinfo , tvbuff_t * tvb , gint offset , proto_tree * tree , const gchar * * value_str ) { gint32 int_val ; guint32 len , i , uint_val ; guint32 id ; const guint8 * str_val ; switch ( tag ) { case ATOM_CACHE_REF : proto_tree_add_item_ret_uint ( tree , hf_erldp_atom_cache_ref , tvb , offset , 1 , ENC_BIG_ENDIAN , & uint_val ) ; offset += 1 ; break ; case SMALL_INTEGER_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_small_int_ext , tvb , offset , 1 , ENC_BIG_ENDIAN , & uint_val ) ; offset += 1 ; if ( value_str ) { * value_str = wmem_strdup_printf ( wmem_packet_scope ( ) , "%u" , uint_val ) ; } break ; case INTEGER_EXT : proto_tree_add_item_ret_int ( tree , hf_erldp_int_ext , tvb , offset , 4 , ENC_BIG_ENDIAN , & int_val ) ; offset += 4 ; if ( value_str ) { * value_str = wmem_strdup_printf ( wmem_packet_scope ( ) , "%d" , int_val ) ; } break ; case SMALL_BIG_EXT : { proto_tree_add_item_ret_uint ( tree , hf_erldp_small_big_ext_len , tvb , offset , 1 , ENC_BIG_ENDIAN , & len ) ; offset += 1 ; offset = dissect_etf_big_ext ( tvb , offset , len , tree , value_str ) ; break ; } case LARGE_BIG_EXT : { proto_tree_add_item_ret_uint ( tree , hf_erldp_large_big_ext_len , tvb , offset , 4 , ENC_BIG_ENDIAN , & len ) ; offset += 4 ; offset = dissect_etf_big_ext ( tvb , offset , len , tree , value_str ) ; break ; } case FLOAT_EXT : proto_tree_add_item_ret_string ( tree , hf_erldp_float_ext , tvb , offset , 31 , ENC_NA | ENC_UTF_8 , wmem_packet_scope ( ) , & str_val ) ; offset += 31 ; if ( value_str ) { * value_str = ( const gchar * ) str_val ; } break ; case NEW_FLOAT_EXT : proto_tree_add_item ( tree , hf_erldp_new_float_ext , tvb , offset , 8 , ENC_BIG_ENDIAN ) ; if ( value_str ) { gdouble new_float_val = tvb_get_ntohieee_double ( tvb , offset ) ; * value_str = wmem_strdup_printf ( wmem_packet_scope ( ) , "%f" , new_float_val ) ; } offset += 8 ; break ; case ATOM_UTF8_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_atom_length2 , tvb , offset , 2 , ENC_BIG_ENDIAN , & len ) ; offset += 2 ; proto_tree_add_item_ret_string ( tree , hf_erldp_atom_text , tvb , offset , len , ENC_NA | ENC_UTF_8 , wmem_packet_scope ( ) , & str_val ) ; offset += len ; if ( value_str ) { * value_str = ( const gchar * ) str_val ; } break ; case SMALL_ATOM_UTF8_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_atom_length , tvb , offset , 1 , ENC_BIG_ENDIAN , & len ) ; offset ++ ; proto_tree_add_item_ret_string ( tree , hf_erldp_atom_text , tvb , offset , len , ENC_NA | ENC_UTF_8 , wmem_packet_scope ( ) , & str_val ) ; offset += len ; if ( value_str ) { * value_str = ( const gchar * ) str_val ; } break ; case PORT_EXT : offset = dissect_etf_type ( "Node" , pinfo , tvb , offset , tree ) ; proto_tree_add_item ( tree , hf_erldp_port_ext_id , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_port_ext_creation , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; break ; case NEW_PORT_EXT : offset = dissect_etf_type ( "Node" , pinfo , tvb , offset , tree ) ; proto_tree_add_item ( tree , hf_erldp_port_ext_id , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_port_ext_creation , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; break ; case PID_EXT : offset = dissect_etf_type ( "Node" , pinfo , tvb , offset , tree ) ; proto_tree_add_item ( tree , hf_erldp_pid_ext_id , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_pid_ext_serial , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_pid_ext_creation , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; break ; case NEW_PID_EXT : offset = dissect_etf_type ( "Node" , pinfo , tvb , offset , tree ) ; proto_tree_add_item ( tree , hf_erldp_pid_ext_id , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_pid_ext_serial , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_pid_ext_creation , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; break ; case SMALL_TUPLE_EXT : offset = dissect_etf_tuple_content ( FALSE , pinfo , tvb , offset , tree , value_str ) ; break ; case LARGE_TUPLE_EXT : offset = dissect_etf_tuple_content ( TRUE , pinfo , tvb , offset , tree , value_str ) ; break ; case NIL_EXT : break ; case LIST_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_list_ext_len , tvb , offset , 4 , ENC_BIG_ENDIAN , & len ) ; offset += 4 ; for ( i = 0 ; i < len ; i ++ ) { offset = dissect_etf_type ( NULL , pinfo , tvb , offset , tree ) ; } offset = dissect_etf_type ( "Tail" , pinfo , tvb , offset , tree ) ; break ; case BINARY_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_binary_ext_len , tvb , offset , 4 , ENC_BIG_ENDIAN , & len ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_binary_ext , tvb , offset , len , ENC_NA ) ; offset += len ; break ; case NEW_REFERENCE_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_new_ref_ext_len , tvb , offset , 2 , ENC_BIG_ENDIAN , & len ) ; offset += 2 ; offset = dissect_etf_type ( "Node" , pinfo , tvb , offset , tree ) ; proto_tree_add_item ( tree , hf_erldp_new_ref_ext_creation , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset ++ ; for ( i = 0 ; i < len ; i ++ ) { id = tvb_get_ntohl ( tvb , offset ) ; proto_tree_add_uint_format ( tree , hf_erldp_new_ref_ext_id , tvb , offset , 4 , id , "ID[%d]: 0x%08X" , i , id ) ; offset += 4 ; } break ; case NEWER_REFERENCE_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_new_ref_ext_len , tvb , offset , 2 , ENC_BIG_ENDIAN , & len ) ; offset += 2 ; offset = dissect_etf_type ( "Node" , pinfo , tvb , offset , tree ) ; proto_tree_add_item ( tree , hf_erldp_new_ref_ext_creation , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; for ( i = 0 ; i < len ; i ++ ) { id = tvb_get_ntohl ( tvb , offset ) ; proto_tree_add_uint_format ( tree , hf_erldp_new_ref_ext_id , tvb , offset , 4 , id , "ID[%d]: 0x%08X" , i , id ) ; offset += 4 ; } break ; case FUN_EXT : proto_tree_add_item_ret_uint ( tree , hf_erldp_fun_ext_num_free , tvb , offset , 4 , ENC_BIG_ENDIAN , & len ) ; offset += 4 ; offset = dissect_etf_type ( "Pid" , pinfo , tvb , offset , tree ) ; offset = dissect_etf_type ( "Module" , pinfo , tvb , offset , tree ) ; offset = dissect_etf_type ( "Index" , pinfo , tvb , offset , tree ) ; offset = dissect_etf_type ( "Unique" , pinfo , tvb , offset , tree ) ; for ( i = 0 ; i < len ; i ++ ) { gchar buf [ ITEM_LABEL_LENGTH ] ; snprintf ( buf , sizeof ( buf ) , "Free Var[%u]" , i + 1 ) ; offset = dissect_etf_type ( buf , pinfo , tvb , offset , tree ) ; } break ; case NEW_FUN_EXT : proto_tree_add_item ( tree , hf_erldp_new_fun_ext_size , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item ( tree , hf_erldp_new_fun_ext_arity , tvb , offset , 1 , ENC_BIG_ENDIAN ) ; offset += 1 ; proto_tree_add_item ( tree , hf_erldp_new_fun_ext_uniq , tvb , offset , 16 , ENC_NA ) ; offset += 16 ; proto_tree_add_item ( tree , hf_erldp_new_fun_ext_index , tvb , offset , 4 , ENC_BIG_ENDIAN ) ; offset += 4 ; proto_tree_add_item_ret_uint ( tree , hf_erldp_new_fun_ext_num_free , tvb , offset , 4 , ENC_BIG_ENDIAN , & len ) ; offset += 4 ; offset = dissect_etf_type ( "Module" , pinfo , tvb , offset , tree ) ; offset = dissect_etf_type ( "OldIndex" , pinfo , tvb , offset , tree ) ; offset = dissect_etf_type ( "OldUnique" , pinfo , tvb , offset , tree ) ; offset = dissect_etf_type ( "Pid" , pinfo , tvb , offset , tree ) ; for ( i = 0 ; i < len ; i ++ ) { gchar buf [ ITEM_LABEL_LENGTH ] ; snprintf ( buf , sizeof ( buf ) , "Free Var[%u]" , i + 1 ) ; offset = dissect_etf_type ( buf , pinfo , tvb , offset , tree ) ; } break ; } return offset ; } 