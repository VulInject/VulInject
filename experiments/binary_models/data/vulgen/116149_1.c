int isp1760_register ( struct resource * mem , int irq , unsigned long irqflags , struct device * dev , unsigned int devflags ) { struct isp1760_device * isp ; bool udc_disabled = ! ( devflags & ISP1760_FLAG_ISP1761 ) ; int ret ; if ( ( ! IS_ENABLED ( CONFIG_USB_ISP1760_HCD ) || usb_disabled ( ) ) && ( ! IS_ENABLED ( CONFIG_USB_ISP1761_UDC ) || udc_disabled ) ) { return - ENODEV ; } dev -> dma_mask = NULL ; isp = devm_kzalloc ( dev , sizeof ( * isp ) , GFP_KERNEL ) ; if ( ! isp ) { return - ENOMEM ; } isp -> dev = dev ; isp -> rst_gpio = devm_gpiod_get_optional ( dev , NULL , GPIOD_OUT_HIGH ) ; if ( IS_ERR ( isp -> rst_gpio ) ) { return PTR_ERR ( isp -> rst_gpio ) ; } isp -> regs = devm_ioremap_resource ( dev , mem ) ; if ( IS_ERR ( isp -> regs ) ) { return PTR_ERR ( isp -> regs ) ; } isp1760_init_core ( isp ) ; if ( IS_ENABLED ( CONFIG_USB_ISP1760_HCD ) && ! usb_disabled ( ) ) { ret = isp1760_hcd_register ( & isp -> hcd , isp -> regs , mem , irq , irqflags | IRQF_SHARED , dev ) ; if ( ret < 0 ) { return ret ; } } if ( IS_ENABLED ( CONFIG_USB_ISP1761_UDC ) && ! udc_disabled ) { ret = isp1760_udc_register ( isp , irq , irqflags ) ; if ( ret < 0 ) { isp1760_hcd_unregister ( & isp -> hcd ) ; return ret ; } } dev_set_drvdata ( dev , isp ) ; return 0 ; } 