void uverbs_user_mmap_disassociate ( struct ib_uverbs_file * ufile ) { struct rdma_umap_priv * priv , * next_priv ; lockdep_assert_held ( & ufile -> hw_destroy_rwsem ) ; while ( 1 ) { struct mm_struct * mm = NULL ; mutex_lock ( & ufile -> umap_lock ) ; while ( ! list_empty ( & ufile -> umaps ) ) { int ret ; priv = list_first_entry ( & ufile -> umaps , rdma_umap_priv , list ) ; mm = priv -> vma -> vm_mm ; ret = mmget_not_zero ( mm ) ; if ( ! ret ) { list_del_init ( & priv -> list ) ; if ( priv -> entry ) { rdma_user_mmap_entry_put ( priv -> entry ) ; priv -> entry = NULL ; } mm = NULL ; continue ; } break ; } mutex_unlock ( & ufile -> umap_lock ) ; mmap_read_lock ( mm ) ; mutex_lock ( & ufile -> umap_lock ) ; list_for_each_entry_safe ( , , , ) { struct vm_area_struct * vma = priv -> vma ; if ( vma -> vm_mm != mm ) { continue ; } list_del_init ( & priv -> list ) ; zap_vma_ptes ( vma , vma -> vm_start , vma -> vm_end - vma -> vm_start ) ; if ( priv -> entry ) { rdma_user_mmap_entry_put ( priv -> entry ) ; priv -> entry = NULL ; } } mutex_unlock ( & ufile -> umap_lock ) ; mmap_read_unlock ( mm ) ; mmput ( mm ) ; } } 