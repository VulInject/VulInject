int nss_group_to_group_record ( const struct group * grp , const struct sgrp * sgrp , GroupRecord * * ret ) { _cleanup_ ( ) int r ; assert ( grp ) ; assert ( ret ) ; if ( isempty ( grp -> gr_name ) ) { return - EINVAL ; } if ( sgrp && ! streq_ptr ( sgrp -> sg_namp , grp -> gr_name ) ) { return - EINVAL ; } g = group_record_new ( ) ; if ( ! g ) { return - ENOMEM ; } g -> group_name = strdup ( grp -> gr_name ) ; if ( ! g -> group_name ) { return - ENOMEM ; } r = strv_extend_strv_utf8_only ( & g -> members , grp -> gr_mem , false ) ; if ( r < 0 ) { return r ; } g -> gid = grp -> gr_gid ; if ( sgrp ) { if ( looks_like_hashed_password ( utf8_only ( sgrp -> sg_passwd ) ) ) { g -> hashed_password = strv_new ( sgrp -> sg_passwd ) ; if ( ! g -> hashed_password ) { return - ENOMEM ; } } r = strv_extend_strv_utf8_only ( & g -> members , sgrp -> sg_mem , true ) ; if ( r < 0 ) { return r ; } r = strv_extend_strv_utf8_only ( & g -> administrators , sgrp -> sg_adm , false ) ; if ( r < 0 ) { return r ; } } r = json_build ( & g -> json , JSON_BUILD_OBJECT ( JSON_BUILD_PAIR ( "groupName" , JSON_BUILD_STRING ( g -> group_name ) ) , JSON_BUILD_PAIR ( "gid" , JSON_BUILD_UNSIGNED ( g -> gid ) ) , JSON_BUILD_PAIR_CONDITION ( ! strv_isempty ( g -> members ) , "members" , JSON_BUILD_STRV ( g -> members ) ) , JSON_BUILD_PAIR_CONDITION ( ! strv_isempty ( g -> hashed_password ) , "privileged" , JSON_BUILD_OBJECT ( JSON_BUILD_PAIR ( "hashedPassword" , JSON_BUILD_STRV ( g -> hashed_password ) ) ) ) , JSON_BUILD_PAIR_CONDITION ( ! strv_isempty ( g -> administrators ) , "administrators" , JSON_BUILD_STRV ( g -> administrators ) ) ) ) ; if ( r < 0 ) { return r ; } g -> mask = USER_RECORD_REGULAR | ( ! strv_isempty ( g -> hashed_password ) ?USER_RECORD_PRIVILEGED : 0 ) ; * ret = TAKE_PTR ( g ) ; return 0 ; } 