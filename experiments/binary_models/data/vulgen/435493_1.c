static int ivtvfb_prep_frame ( struct ivtv * itv , int cmd , void __user * source , unsigned long dest_offset , int count ) { DEFINE_WAIT ( wait ) ; struct osd_info * oi = itv -> osd_info ; if ( count == 0 ) { IVTVFB_DEBUG_WARN ( "ivtvfb_prep_frame: Nothing to do. count = 0\n" ) ; return - EINVAL ; } if ( ( dest_offset + count ) > oi -> video_buffer_size ) { IVTVFB_WARN ( "ivtvfb_prep_frame: Overflowing the framebuffer %ld, only %d available\n" , dest_offset + count , oi -> video_buffer_size ) ; return - E2BIG ; } if ( ( unsigned long ) source & 3 ) { IVTVFB_WARN ( "ivtvfb_prep_frame: Source address not 32 bit aligned (0x%08lx)\n" , ( unsigned long ) source ) ; } if ( dest_offset & 3 ) { IVTVFB_WARN ( "ivtvfb_prep_frame: Dest offset not 32 bit aligned (%ld)\n" , dest_offset ) ; } if ( ! access_ok ( VERIFY_READ , source + dest_offset , count ) ) { IVTVFB_WARN ( "Invalid userspace pointer 0x%08lx\n" , ( unsigned long ) source ) ; IVTVFB_DEBUG_WARN ( "access_ok() failed for offset 0x%08lx source 0x%08lx count %d\n" , dest_offset , ( unsigned long ) source , count ) ; return - EINVAL ; } dest_offset += IVTV_DECODER_OFFSET + oi -> video_rbase ; return ivtvfb_prep_dec_dma_to_device ( itv , dest_offset , source , count ) ; } 