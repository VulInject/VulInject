AcpiEvInstallSpaceHandler ( , , , , ) { ACPI_OPERAND_OBJECT * ObjDesc ; ACPI_OPERAND_OBJECT * HandlerObj ; ACPI_STATUS Status = AE_OK ; ACPI_OBJECT_TYPE Type ; UINT8 Flags = 0 ; ACPI_FUNCTION_TRACE ( EvInstallSpaceHandler ) ; if ( ( Node -> Type != ACPI_TYPE_DEVICE ) && ( Node -> Type != ACPI_TYPE_PROCESSOR ) && ( Node -> Type != ACPI_TYPE_THERMAL ) && ( Node != AcpiGbl_RootNode ) ) { Status = AE_BAD_PARAMETER ; UnlockAndExit } if ( ! Setup ) { Setup = AcpiEvDefaultRegionSetup ; } ObjDesc = AcpiNsGetAttachedObject ( Node ) ; if ( ObjDesc ) { HandlerObj = AcpiEvFindRegionHandler ( SpaceId , ObjDesc -> CommonNotify . Handler ) ; if ( HandlerObj ) { if ( HandlerObj -> AddressSpace . Handler == Handler ) { Status = AE_SAME_HANDLER ; UnlockAndExit } else { Status = AE_ALREADY_EXISTS ; } UnlockAndExit } } else { ACPI_DEBUG_PRINT ( ( ACPI_DB_OPREGION , "Creating object on Device %p while installing handler\n" , Node ) ) ; if ( Node -> Type == ACPI_TYPE_ANY ) { Type = ACPI_TYPE_DEVICE ; } else { Type = Node -> Type ; } ObjDesc = AcpiUtCreateInternalObject ( Type ) ; if ( ! ObjDesc ) { Status = AE_NO_MEMORY ; UnlockAndExit } ObjDesc -> Common . Type = ( UINT8 ) Type ; Status = AcpiNsAttachObject ( Node , ObjDesc , Type ) ; AcpiUtRemoveReference ( ObjDesc ) ; if ( ACPI_FAILURE ( Status ) ) { UnlockAndExit } } ACPI_DEBUG_PRINT ( ( ACPI_DB_OPREGION , "Installing address handler for region %s(%X) " "on Device %4.4s %p(%p)\n" , AcpiUtGetRegionName ( SpaceId ) , SpaceId , AcpiUtGetNodeName ( Node ) , Node , ObjDesc ) ) ; HandlerObj = AcpiUtCreateInternalObject ( ACPI_TYPE_LOCAL_ADDRESS_HANDLER ) ; if ( ! HandlerObj ) { Status = AE_NO_MEMORY ; UnlockAndExit } Status = AcpiOsCreateMutex ( & HandlerObj -> AddressSpace . ContextMutex ) ; if ( ACPI_FAILURE ( Status ) ) { AcpiUtRemoveReference ( HandlerObj ) ; UnlockAndExit } HandlerObj -> AddressSpace . SpaceId = ( UINT8 ) SpaceId ; HandlerObj -> AddressSpace . HandlerFlags = Flags ; HandlerObj -> AddressSpace . RegionList = NULL ; HandlerObj -> AddressSpace . Node = Node ; HandlerObj -> AddressSpace . Handler = Handler ; HandlerObj -> AddressSpace . Context = Context ; HandlerObj -> AddressSpace . Setup = Setup ; HandlerObj -> AddressSpace . Next = ObjDesc -> CommonNotify . Handler ; ObjDesc -> CommonNotify . Handler = HandlerObj ; Status = AcpiNsWalkNamespace ( ACPI_TYPE_ANY , Node , ACPI_UINT32_MAX , ACPI_NS_WALK_UNLOCK , AcpiEvInstallHandler , NULL , HandlerObj , NULL ) ; UnlockAndExit return_ACPI_STATUS ( Status ) ; } 