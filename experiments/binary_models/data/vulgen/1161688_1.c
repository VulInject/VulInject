static void set_subblock_gain ( gr_info * cod_info , const int mingain_s [ 3 ] , int sf [ ] ) { const int maxrange1 = 15 , maxrange2 = 7 ; const int ifqstepShift = ( cod_info -> scalefac_scale == 0 ) ?1 : 2 ; int * const sbg = cod_info -> subblock_gain ; unsigned int const psymax = ( unsigned int ) cod_info -> psymax ; unsigned int psydiv = 18 ; int sbg0 , sbg1 , sbg2 ; unsigned int sfb , i ; int min_sbg = 7 ; if ( psydiv > psymax ) { psydiv = psymax ; } for ( i = 0 ; i < 3 ; ++ i ) { int maxsf1 = 0 , maxsf2 = 0 , minsf = 1000 ; for ( sfb = i ; sfb < psydiv ; sfb += 3 ) { int const v = - sf [ sfb ] ; if ( maxsf1 < v ) { maxsf1 = v ; } if ( minsf > v ) { minsf = v ; } } for ( ; sfb < SFBMAX ; sfb += 3 ) { int const v = - sf [ sfb ] ; if ( maxsf2 < v ) { maxsf2 = v ; } if ( minsf > v ) { minsf = v ; } } { int const m1 = maxsf1 - ( maxrange1 << ifqstepShift ) ; int const m2 = maxsf2 - ( maxrange2 << ifqstepShift ) ; maxsf1 = Max ( m1 , m2 ) ; } if ( minsf > 0 ) { sbg [ i ] = minsf >> 3 ; } else { sbg [ i ] = 0 ; } if ( maxsf1 > 0 ) { int const m1 = sbg [ i ] ; int const m2 = ( maxsf1 + 7 ) >> 3 ; sbg [ i ] = Max ( m1 , m2 ) ; } if ( sbg [ i ] > 0 && mingain_s [ i ] > ( cod_info -> global_gain - sbg [ i ] * 8 ) ) { sbg [ i ] = ( cod_info -> global_gain - mingain_s [ i ] ) >> 3 ; } if ( sbg [ i ] > 7 ) { sbg [ i ] = 7 ; } if ( min_sbg > sbg [ i ] ) { min_sbg = sbg [ i ] ; } } sbg0 = sbg [ 0 ] * 8 ; sbg1 = sbg [ 1 ] * 8 ; sbg2 = sbg [ 2 ] * 8 ; for ( sfb = 0 ; sfb < SFBMAX ; sfb += 3 ) { sf [ sfb + 0 ] += sbg0 ; sf [ sfb + 1 ] += sbg1 ; sf [ sfb + 2 ] += sbg2 ; } } 