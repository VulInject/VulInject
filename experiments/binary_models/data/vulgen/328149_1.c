int oce_mbox_wait ( struct oce_dev * dev , uint32_t tmo_sec ) { clock_t tmo ; clock_t now , tstamp ; pd_mpu_mbox_db_t mbox_db ; tmo = ( tmo_sec > 0 ) ?drv_usectohz ( tmo_sec * 1000000 ) : drv_usectohz ( DEFAULT_MQ_MBOX_TIMEOUT ) ; tmo += drv_usectohz ( MBX_READY_TIMEOUT ) ; for ( ; ; ) { now = ddi_get_lbolt ( ) ; if ( ( now - tstamp ) >= tmo ) { tmo = 0 ; break ; } mbox_db . dw0 = OCE_DB_READ32 ( dev , PD_MPU_MBOX_DB ) ; if ( oce_fm_check_acc_handle ( dev , dev -> db_handle ) != DDI_FM_OK ) { ddi_fm_service_impact ( dev -> dip , DDI_SERVICE_DEGRADED ) ; oce_fm_ereport ( dev , DDI_FM_DEVICE_INVAL_STATE ) ; } if ( mbox_db . bits . ready ) { return ( 0 ) ; } drv_usecwait ( 5 ) ; } return ( ETIMEDOUT ) ; } 