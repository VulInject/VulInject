global_setup ( ) { g_autofree char * cachedir = NULL ; g_autofree char * configdir = NULL ; g_autofree char * datadir = NULL ; g_autofree char * statedir = NULL ; g_autofree char * homedir = NULL ; g_autofree char * services_dir = NULL ; testdir = g_strdup ( "/tmp/flatpak-test-XXXXXX" ) ; g_mkdtemp ( testdir ) ; g_test_message ( "testdir: %s" , testdir ) ; homedir = g_strconcat ( testdir , "/home" , NULL ) ; g_mkdir_with_parents ( homedir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "HOME" , homedir , TRUE ) ; g_test_message ( "setting HOME=%s" , homedir ) ; cachedir = g_strconcat ( testdir , "/home/cache" , NULL ) ; g_mkdir_with_parents ( cachedir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "XDG_CACHE_HOME" , cachedir , TRUE ) ; g_test_message ( "setting XDG_CACHE_HOME=%s" , cachedir ) ; configdir = g_strconcat ( testdir , "/home/config" , NULL ) ; g_mkdir_with_parents ( configdir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "XDG_CONFIG_HOME" , configdir , TRUE ) ; g_test_message ( "setting XDG_CONFIG_HOME=%s" , configdir ) ; datadir = g_strconcat ( testdir , "/home/share" , NULL ) ; g_mkdir_with_parents ( datadir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "XDG_DATA_HOME" , datadir , TRUE ) ; g_test_message ( "setting XDG_DATA_HOME=%s" , datadir ) ; statedir = g_strconcat ( testdir , "/home/state" , NULL ) ; g_mkdir_with_parents ( statedir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "XDG_STATE_HOME" , statedir , TRUE ) ; g_test_message ( "setting XDG_STATE_HOME=%s" , statedir ) ; flatpak_runtimedir = g_strconcat ( testdir , "/runtime" , NULL ) ; g_mkdir_with_parents ( flatpak_runtimedir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "XDG_RUNTIME_DIR" , flatpak_runtimedir , TRUE ) ; g_test_message ( "setting XDG_RUNTIME_DIR=%s" , flatpak_runtimedir ) ; flatpak_systemdir = g_strconcat ( testdir , "/system" , NULL ) ; g_mkdir_with_parents ( flatpak_systemdir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "FLATPAK_SYSTEM_DIR" , flatpak_systemdir , TRUE ) ; g_test_message ( "setting FLATPAK_SYSTEM_DIR=%s" , flatpak_systemdir ) ; flatpak_systemcachedir = g_strconcat ( testdir , "/system-cache" , NULL ) ; g_mkdir_with_parents ( flatpak_systemcachedir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "FLATPAK_SYSTEM_CACHE_DIR" , flatpak_systemcachedir , TRUE ) ; g_test_message ( "setting FLATPAK_SYSTEM_CACHE_DIR=%s" , flatpak_systemcachedir ) ; flatpak_configdir = g_strconcat ( testdir , "/config" , NULL ) ; g_mkdir_with_parents ( flatpak_configdir , S_IRWXU | S_IRWXG | S_IRWXO ) ; g_setenv ( "FLATPAK_CONFIG_DIR" , flatpak_configdir , TRUE ) ; g_test_message ( "setting FLATPAK_CONFIG_DIR=%s" , flatpak_configdir ) ; gpg_homedir = g_strconcat ( testdir , "/gpghome" , NULL ) ; g_mkdir_with_parents ( gpg_homedir , S_IRWXU | S_IRWXG | S_IRWXO ) ; gpg_args = g_strdup_printf ( "--gpg-homedir=%s --gpg-sign=%s" , gpg_homedir , gpg_id ) ; g_setenv ( "GPGARGS" , gpg_args , TRUE ) ; g_test_message ( "setting GPGARGS=%s" , gpg_args ) ; g_reload_user_special_dirs_cache ( ) ; g_assert_cmpstr ( g_get_user_cache_dir ( ) , == , cachedir ) ; g_assert_cmpstr ( g_get_user_config_dir ( ) , == , configdir ) ; g_assert_cmpstr ( g_get_user_data_dir ( ) , == , datadir ) ; g_assert_cmpstr ( g_get_user_runtime_dir ( ) , == , flatpak_runtimedir ) ; g_setenv ( "FLATPAK_SYSTEM_HELPER_ON_SESSION" , "1" , TRUE ) ; g_setenv ( "LANGUAGE" , "en" , TRUE ) ; test_bus = g_test_dbus_new ( G_TEST_DBUS_NONE ) ; services_dir = g_test_build_filename ( G_TEST_BUILT , "services" , NULL ) ; g_test_dbus_add_service_dir ( test_bus , services_dir ) ; g_test_dbus_up ( test_bus ) ; copy_gpg ( ) ; setup_multiple_installations ( ) ; setup_repo ( ) ; make_bundle ( ) ; } 