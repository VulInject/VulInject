static void da7219_aad_btn_det_work ( struct work_struct * work ) { struct da7219_aad_priv * da7219_aad = container_of ( work , da7219_aad_priv , btn_det_work ) ; struct snd_soc_codec * codec = da7219_aad -> codec ; struct snd_soc_dapm_context * dapm = snd_soc_codec_get_dapm ( codec ) ; u8 statusa , micbias_ctrl ; bool micbias_up = false ; int retries = 0 ; snd_soc_update_bits ( codec , DA7219_HP_L_CTRL , DA7219_HP_L_AMP_OE_MASK , DA7219_HP_L_AMP_OE_MASK ) ; snd_soc_update_bits ( codec , DA7219_HP_R_CTRL , DA7219_HP_R_AMP_OE_MASK , DA7219_HP_R_AMP_OE_MASK ) ; snd_soc_dapm_force_enable_pin ( dapm , "Mic Bias" ) ; snd_soc_dapm_sync ( dapm ) ; { statusa = snd_soc_read ( codec , DA7219_ACCDET_STATUS_A ) ; if ( statusa & DA7219_MICBIAS_UP_STS_MASK ) { micbias_up = true ; } if ( retries ++ < DA7219_AAD_MICBIAS_CHK_RETRIES ) { msleep ( DA7219_AAD_MICBIAS_CHK_DELAY ) ; } } ( ! micbias_up ) && ( retries < DA7219_AAD_MICBIAS_CHK_RETRIES ) ; if ( retries >= DA7219_AAD_MICBIAS_CHK_RETRIES ) { dev_warn ( codec -> dev , "Mic bias status check timed out" ) ; } snd_soc_update_bits ( codec , DA7219_ACCDET_CONFIG_1 , DA7219_BUTTON_CONFIG_MASK , da7219_aad -> btn_cfg ) ; } 