static void clk_basic_init ( struct udevice * dev , const struct cm_config * const cfg ) { struct socfpga_clk_plat * plat = dev_get_plat ( dev ) ; u32 vcocalib ; clk_write_ctrl ( plat , CM_REG_READL ( plat , CLKMGR_CTRL ) | CLKMGR_CTRL_BOOTMODE ) ; if ( ! ( CM_REG_READL ( plat , CLKMGR_CTRL ) & CLKMGR_CTRL_BOOTMODE ) ) { return ; } clk_write_bypass_mainpll ( plat , CLKMGR_BYPASS_MAINPLL_ALL ) ; clk_write_bypass_perpll ( plat , CLKMGR_BYPASS_PERPLL_ALL ) ; CM_REG_CLRBITS ( plat , CLKMGR_MAINPLL_PLLGLOB , CLKMGR_PLLGLOB_PD_MASK | CLKMGR_PLLGLOB_RST_MASK ) ; CM_REG_CLRBITS ( plat , CLKMGR_PERPLL_PLLGLOB , CLKMGR_PLLGLOB_PD_MASK | CLKMGR_PLLGLOB_RST_MASK ) ; vcocalib = calc_vocalib_pll ( cfg -> main_pll_pllm , cfg -> main_pll_pllglob ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_pllglob & ~ CLKMGR_PLLGLOB_RST_MASK , CLKMGR_MAINPLL_PLLGLOB ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_fdbck , CLKMGR_MAINPLL_FDBCK ) ; CM_REG_WRITEL ( plat , vcocalib , CLKMGR_MAINPLL_VCOCALIB ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_pllc0 , CLKMGR_MAINPLL_PLLC0 ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_pllc1 , CLKMGR_MAINPLL_PLLC1 ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_pllc2 , CLKMGR_MAINPLL_PLLC2 ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_pllc3 , CLKMGR_MAINPLL_PLLC3 ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_pllm , CLKMGR_MAINPLL_PLLM ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_mpuclk , CLKMGR_MAINPLL_MPUCLK ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_nocclk , CLKMGR_MAINPLL_NOCCLK ) ; CM_REG_WRITEL ( plat , cfg -> main_pll_nocdiv , CLKMGR_MAINPLL_NOCDIV ) ; vcocalib = calc_vocalib_pll ( cfg -> per_pll_pllm , cfg -> per_pll_pllglob ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_pllglob & ~ CLKMGR_PLLGLOB_RST_MASK , CLKMGR_PERPLL_PLLGLOB ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_fdbck , CLKMGR_PERPLL_FDBCK ) ; CM_REG_WRITEL ( plat , vcocalib , CLKMGR_PERPLL_VCOCALIB ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_pllc0 , CLKMGR_PERPLL_PLLC0 ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_pllc1 , CLKMGR_PERPLL_PLLC1 ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_pllc2 , CLKMGR_PERPLL_PLLC2 ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_pllc3 , CLKMGR_PERPLL_PLLC3 ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_pllm , CLKMGR_PERPLL_PLLM ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_emacctl , CLKMGR_PERPLL_EMACCTL ) ; CM_REG_WRITEL ( plat , cfg -> per_pll_gpiodiv , CLKMGR_PERPLL_GPIODIV ) ; CM_REG_SETBITS ( plat , CLKMGR_MAINPLL_PLLGLOB , CLKMGR_PLLGLOB_PD_MASK | CLKMGR_PLLGLOB_RST_MASK ) ; CM_REG_SETBITS ( plat , CLKMGR_PERPLL_PLLGLOB , CLKMGR_PLLGLOB_PD_MASK | CLKMGR_PLLGLOB_RST_MASK ) ; membus_pll_configs ( plat , MEMBUS_MAINPLL ) ; membus_pll_configs ( plat , MEMBUS_PERPLL ) ; cm_wait_for_lock ( CLKMGR_STAT_ALLPLL_LOCKED_MASK ) ; CM_REG_WRITEL ( plat , cfg -> alt_emacactr , CLKMGR_ALTR_EMACACTR ) ; CM_REG_WRITEL ( plat , cfg -> alt_emacbctr , CLKMGR_ALTR_EMACBCTR ) ; CM_REG_WRITEL ( plat , cfg -> alt_emacptpctr , CLKMGR_ALTR_EMACPTPCTR ) ; CM_REG_WRITEL ( plat , cfg -> alt_gpiodbctr , CLKMGR_ALTR_GPIODBCTR ) ; CM_REG_WRITEL ( plat , cfg -> alt_sdmmcctr , CLKMGR_ALTR_SDMMCCTR ) ; CM_REG_WRITEL ( plat , cfg -> alt_s2fuser0ctr , CLKMGR_ALTR_S2FUSER0CTR ) ; CM_REG_WRITEL ( plat , cfg -> alt_s2fuser1ctr , CLKMGR_ALTR_S2FUSER1CTR ) ; CM_REG_WRITEL ( plat , cfg -> alt_psirefctr , CLKMGR_ALTR_PSIREFCTR ) ; CM_REG_WRITEL ( plat , CLKMGR_LOSTLOCK_SET_MASK , CLKMGR_MAINPLL_LOSTLOCK ) ; CM_REG_WRITEL ( plat , CLKMGR_LOSTLOCK_SET_MASK , CLKMGR_PERPLL_LOSTLOCK ) ; CM_REG_WRITEL ( plat , CM_REG_READL ( plat , CLKMGR_MAINPLL_PLLGLOB ) | CLKMGR_PLLGLOB_CLR_LOSTLOCK_BYPASS_MASK , CLKMGR_MAINPLL_PLLGLOB ) ; CM_REG_WRITEL ( plat , CM_REG_READL ( plat , CLKMGR_PERPLL_PLLGLOB ) | CLKMGR_PLLGLOB_CLR_LOSTLOCK_BYPASS_MASK , CLKMGR_PERPLL_PLLGLOB ) ; clk_write_bypass_mainpll ( plat , 0 ) ; clk_write_bypass_perpll ( plat , 0 ) ; CM_REG_CLRBITS ( plat , CLKMGR_INTRCLR , CLKMGR_INTER_PERPLLLOST_MASK | CLKMGR_INTER_MAINPLLLOST_MASK ) ; CM_REG_CLRBITS ( plat , CLKMGR_ALTR_EXTCNTRST , CLKMGR_ALT_EXTCNTRST_ALLCNTRST ) ; clk_write_ctrl ( plat , CM_REG_READL ( plat , CLKMGR_CTRL ) & ~ CLKMGR_CTRL_BOOTMODE ) ; } 