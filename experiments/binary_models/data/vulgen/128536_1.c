( ! ( frame = av_frame_alloc ( ) ) ) { av_log ( log_ctx , AV_LOG_ERROR , "Failed to alloc frame\n" ) ret = AVERROR ( ENOMEM ) end } ; ret = av_read_frame ( format_ctx , & pkt ) ; if ( ret < 0 ) { av_log ( log_ctx , AV_LOG_ERROR , "Failed to read frame from file\n" ) ; end } ret = avcodec_send_packet ( codec_ctx , & pkt ) ; av_packet_unref ( & pkt ) ; if ( ret < 0 ) { av_log ( log_ctx , AV_LOG_ERROR , "Error submitting a packet to decoder\n" ) ; end } ret = avcodec_receive_frame ( codec_ctx , frame ) ; if ( ret < 0 ) { av_log ( log_ctx , AV_LOG_ERROR , "Failed to decode image from file\n" ) ; end } * w = frame -> width ; * h = frame -> height ; * pix_fmt = frame -> format ; if ( ( ret = av_image_alloc ( data , linesize , * w , * h , * pix_fmt , 16 ) ) < 0 ) { end } ret = 0 ; av_image_copy ( data , linesize , ( const uint8_t * * ) frame -> data , frame -> linesize , * pix_fmt , * w , * h ) ; end avcodec_free_context ( & codec_ctx ) ; avformat_close_input ( & format_ctx ) ; av_frame_free ( & frame ) ; if ( ret < 0 ) { av_log ( log_ctx , AV_LOG_ERROR , "Error loading image file '%s'\n" , filename ) ; } return ret ; 