static inline void closure_put_after_sub ( struct closure * cl , int flags ) { int r = flags & CLOSURE_REMAINING_MASK ; BUG_ON ( flags & CLOSURE_GUARD_MASK ) ; BUG_ON ( ! r && ( flags & ~ CLOSURE_DESTRUCTOR ) ) ; if ( r == 1 && ( flags & CLOSURE_SLEEPING ) ) { wake_up_process ( cl -> task ) ; } if ( ! r ) { if ( cl -> fn && ! ( flags & CLOSURE_DESTRUCTOR ) ) { atomic_set ( & cl -> remaining , CLOSURE_REMAINING_INITIALIZER ) ; closure_queue ( cl ) ; } else { struct closure * parent = cl -> parent ; closure_fn * destructor = cl -> fn ; closure_debug_destroy ( cl ) ; if ( destructor ) { destructor ( cl ) ; } } } } 