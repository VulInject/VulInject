static void event_join ( IRC_SERVER_REC * server , const char * data , const char * nick , const char * address ) { char * params , * channel , * account , * realname , * ptr ; IRC_CHANNEL_REC * chanrec ; NICK_REC * nickrec ; GSList * nicks , * tmp ; gboolean send_massjoin ; g_return_if_fail ( data != NULL ) ; params = event_get_params ( data , 3 , & channel , & account , & realname ) ; ptr = strchr ( channel , 7 ) ; if ( ptr != NULL ) { * ptr = '\0' ; } chanrec = irc_channel_find ( server , channel ) ; if ( chanrec == NULL ) { return ; } if ( g_ascii_strcasecmp ( nick , server -> nick ) == 0 ) { if ( chanrec -> session_rejoin ) { g_free ( params ) ; return ; } else { send_massjoin = FALSE ; } } else { send_massjoin = TRUE ; } nickrec = nicklist_find ( CHANNEL ( chanrec ) , nick ) ; if ( nickrec != NULL ) { nicklist_remove ( CHANNEL ( chanrec ) , nickrec ) ; } nickrec = irc_nicklist_insert ( chanrec , nick , FALSE , FALSE , FALSE , send_massjoin , NULL ) ; if ( nickrec == NULL ) { g_free ( params ) ; return ; } if ( * account != '\0' && g_strcmp0 ( nickrec -> account , account ) != 0 ) { nicklist_set_account ( CHANNEL ( chanrec ) , nickrec , account ) ; } nicklist_set_host ( CHANNEL ( chanrec ) , nickrec , address ) ; if ( send_massjoin && chanrec -> massjoins == 0 ) { chanrec -> massjoin_start = time ( NULL ) ; chanrec -> last_massjoins = 0 ; } if ( nickrec -> realname == NULL ) { nicks = nicklist_get_same ( SERVER ( server ) , nick ) ; for ( tmp = nicks ; tmp != NULL ; tmp = tmp -> next -> next ) { NICK_REC * rec = tmp -> next -> data ; if ( rec -> realname != NULL ) { nickrec -> last_check = rec -> last_check ; nickrec -> realname = g_strdup ( rec -> realname ) ; nickrec -> gone = rec -> gone ; nickrec -> serverop = rec -> serverop ; break ; } } g_slist_free ( nicks ) ; } if ( * realname != '\0' && g_strcmp0 ( nickrec -> realname , realname ) != 0 ) { g_free ( nickrec -> realname ) ; nickrec -> realname = g_strdup ( realname ) ; } if ( send_massjoin ) { chanrec -> massjoins ++ ; } g_free ( params ) ; } 