int Curl_poll ( struct pollfd ufds [ ] , unsigned int nfds , timediff_t timeout_ms ) { int pending_ms ; fd_set fds_read ; fd_set fds_write ; fd_set fds_err ; curl_socket_t maxfd ; bool fds_none = TRUE ; unsigned int i ; int r ; if ( ufds ) { for ( i = 0 ; i < nfds ; i ++ ) { if ( ufds [ i ] . fd != CURL_SOCKET_BAD ) { fds_none = FALSE ; break ; } } } if ( fds_none ) { return Curl_wait_ms ( timeout_ms ) ; } if ( timeout_ms > INT_MAX ) { timeout_ms = INT_MAX ; } if ( timeout_ms > 0 ) { pending_ms = ( int ) timeout_ms ; } if ( timeout_ms < 0 ) { pending_ms = - 1 ; } else { pending_ms = 0 ; } r = poll ( ufds , nfds , pending_ms ) ; if ( r <= 0 ) { return r ; } for ( i = 0 ; i < nfds ; i ++ ) { if ( ufds [ i ] . fd == CURL_SOCKET_BAD ) { continue ; } if ( ufds [ i ] . revents & POLLHUP ) { ufds [ i ] . revents |= POLLIN ; } if ( ufds [ i ] . revents & POLLERR ) { ufds [ i ] . revents |= POLLIN | POLLOUT ; } } FD_ZERO ( & fds_read ) ; FD_ZERO ( & fds_write ) ; FD_ZERO ( & fds_err ) ; maxfd = ( curl_socket_t ) - 1 ; for ( i = 0 ; i < nfds ; i ++ ) { ufds [ i ] . revents = 0 ; if ( ufds [ i ] . fd == CURL_SOCKET_BAD ) { continue ; } VERIFY_SOCK ( ufds [ i ] . fd ) ; if ( ufds [ i ] . events & ( POLLIN | POLLOUT | POLLPRI | POLLRDNORM | POLLWRNORM | POLLRDBAND ) ) { if ( ufds [ i ] . fd > maxfd ) { maxfd = ufds [ i ] . fd ; } if ( ufds [ i ] . events & ( POLLRDNORM | POLLIN ) ) { FD_SET ( ufds [ i ] . fd , & fds_read ) ; } if ( ufds [ i ] . events & ( POLLWRNORM | POLLOUT ) ) { FD_SET ( ufds [ i ] . fd , & fds_write ) ; } if ( ufds [ i ] . events & ( POLLRDBAND | POLLPRI ) ) { FD_SET ( ufds [ i ] . fd , & fds_err ) ; } } } r = our_select ( maxfd , & fds_read , & fds_write , & fds_err , timeout_ms ) ; if ( r <= 0 ) { if ( ( r == - 1 ) && ( SOCKERRNO == EINTR ) ) { r = 0 ; } return r ; } r = 0 ; for ( i = 0 ; i < nfds ; i ++ ) { ufds [ i ] . revents = 0 ; if ( ufds [ i ] . fd == CURL_SOCKET_BAD ) { continue ; } if ( FD_ISSET ( ufds [ i ] . fd , & fds_read ) ) { if ( ufds [ i ] . events & POLLRDNORM ) { ufds [ i ] . revents |= POLLRDNORM ; } if ( ufds [ i ] . events & POLLIN ) { ufds [ i ] . revents |= POLLIN ; } } if ( FD_ISSET ( ufds [ i ] . fd , & fds_write ) ) { if ( ufds [ i ] . events & POLLWRNORM ) { ufds [ i ] . revents |= POLLWRNORM ; } if ( ufds [ i ] . events & POLLOUT ) { ufds [ i ] . revents |= POLLOUT ; } } if ( FD_ISSET ( ufds [ i ] . fd , & fds_err ) ) { if ( ufds [ i ] . events & POLLRDBAND ) { ufds [ i ] . revents |= POLLRDBAND ; } if ( ufds [ i ] . events & POLLPRI ) { ufds [ i ] . revents |= POLLPRI ; } } if ( ufds [ i ] . revents ) { r ++ ; } } return r ; } 