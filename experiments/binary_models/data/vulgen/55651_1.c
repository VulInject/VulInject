static int fsi_i2c_probe ( struct device * dev ) { struct fsi_i2c_master * i2c ; struct fsi_i2c_port * port ; struct device_node * np ; u32 port_no , ports , stat ; int rc ; i2c = devm_kzalloc ( dev , sizeof ( * i2c ) , GFP_KERNEL ) ; if ( ! i2c ) { return - ENOMEM ; } mutex_init ( & i2c -> lock ) ; i2c -> fsi = to_fsi_dev ( dev ) ; INIT_LIST_HEAD ( & i2c -> ports ) ; rc = fsi_i2c_dev_init ( i2c ) ; if ( rc ) { return rc ; } rc = fsi_i2c_read_reg ( i2c -> fsi , I2C_FSI_STAT , & stat ) ; if ( rc ) { return rc ; } ports = FIELD_GET ( I2C_STAT_MAX_PORT , stat ) + 1 ; dev_dbg ( dev , "I2C master has %d ports\n" , ports ) ; for ( port_no = 0 ; port_no < ports ; port_no ++ ) { np = fsi_i2c_find_port_of_node ( dev -> of_node , port_no ) ; if ( ! of_device_is_available ( np ) ) { continue ; } port = kzalloc ( sizeof ( * port ) , GFP_KERNEL ) ; if ( ! port ) { break ; } port -> master = i2c ; port -> port = port_no ; port -> adapter . owner = THIS_MODULE ; port -> adapter . dev . of_node = np ; port -> adapter . dev . parent = dev ; port -> adapter . algo = & fsi_i2c_algorithm ; port -> adapter . bus_recovery_info = & fsi_i2c_bus_recovery_info ; port -> adapter . algo_data = port ; snprintf ( port -> adapter . name , sizeof ( port -> adapter . name ) , "i2c_bus-%u" , port_no ) ; rc = i2c_add_adapter ( & port -> adapter ) ; if ( rc < 0 ) { dev_err ( dev , "Failed to register adapter: %d\n" , rc ) ; kfree ( port ) ; continue ; } list_add ( & port -> list , & i2c -> ports ) ; } dev_set_drvdata ( dev , i2c ) ; return 0 ; } 