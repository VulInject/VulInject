void zap_leaf_stats ( zap_t * zap , zap_leaf_t * l , zap_stats_t * zs ) { int n = zap_f_phys ( zap ) -> zap_ptrtbl . zt_shift - zap_leaf_phys ( l ) -> l_hdr . lh_prefix_len ; n = MIN ( n , ZAP_HISTOGRAM_SIZE - 1 ) ; zs -> zs_leafs_with_2n_pointers [ n ] ++ ; n = zap_leaf_phys ( l ) -> l_hdr . lh_nentries / 5 ; n = MIN ( n , ZAP_HISTOGRAM_SIZE - 1 ) ; zs -> zs_blocks_with_n5_entries [ n ] ++ ; n = ( ( 1 << FZAP_BLOCK_SHIFT ( zap ) ) - zap_leaf_phys ( l ) -> l_hdr . lh_nfree * ( ZAP_LEAF_ARRAY_BYTES + 1 ) ) * 10 / ( 1 << FZAP_BLOCK_SHIFT ( zap ) ) ; n = MIN ( n , ZAP_HISTOGRAM_SIZE - 1 ) ; zs -> zs_blocks_n_tenths_full [ n ] ++ ; for ( int i = 0 ; i < ZAP_LEAF_HASH_NUMENTRIES ( l ) ; i ++ ) { int nentries = 0 ; int chunk = zap_leaf_phys ( l ) -> l_hash [ i ] ; while ( chunk != CHAIN_END ) { struct zap_leaf_entry * le = ZAP_LEAF_ENTRY ( l , chunk ) ; n = 1 + ZAP_LEAF_ARRAY_NCHUNKS ( le -> le_name_numints ) + ZAP_LEAF_ARRAY_NCHUNKS ( le -> le_value_numints * le -> le_value_intlen ) ; n = MIN ( n , ZAP_HISTOGRAM_SIZE - 1 ) ; zs -> zs_entries_using_n_chunks [ n ] ++ ; chunk = le -> le_next ; nentries ++ ; } n = nentries ; n = MIN ( n , ZAP_HISTOGRAM_SIZE - 1 ) ; } } 