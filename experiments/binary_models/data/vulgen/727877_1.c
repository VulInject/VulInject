struct agp_gatt * agp_alloc_gatt ( bus_dma_tag_t dmat , u_int32_t apsize ) { struct agp_gatt * gatt ; u_int32_t entries = apsize >> AGP_PAGE_SHIFT ; gatt = malloc ( sizeof ( * gatt ) , M_AGP , M_NOWAIT | M_ZERO ) ; gatt -> ag_entries = entries ; gatt -> ag_size = entries * sizeof ( u_int32_t ) ; if ( agp_alloc_dmamem ( dmat , gatt -> ag_size , & gatt -> ag_dmamap , & gatt -> ag_physical , & gatt -> ag_dmaseg ) != 0 ) { free ( gatt , M_AGP , sizeof gatt ) ; return ( NULL ) ; } if ( bus_dmamem_map ( dmat , & gatt -> ag_dmaseg , 1 , gatt -> ag_size , ( caddr_t * ) & gatt -> ag_virtual , BUS_DMA_NOWAIT ) != 0 ) { agp_free_dmamem ( dmat , gatt -> ag_size , gatt -> ag_dmamap , & gatt -> ag_dmaseg ) ; free ( gatt , M_AGP , sizeof gatt ) ; return ( NULL ) ; } agp_flush_cache ( ) ; return ( gatt ) ; } 