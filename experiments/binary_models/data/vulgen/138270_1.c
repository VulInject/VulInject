void ff_hscale_8_to_19_lasx ( SwsContext * c , int16_t * _dst , int dstW , const uint8_t * src , const int16_t * filter , const int32_t * filterPos , int filterSize ) { int i ; int max = ( 1 << 19 ) - 1 ; int32_t * dst = ( int32_t * ) _dst ; if ( filterSize == 8 ) { __m256i src0 , src1 , src2 , src3 , src4 , src5 , src6 , src7 ; __m256i filter0 , filter1 , filter2 , filter3 ; __m256i shuf = { 0x0000000400000000 0x0000000500000001 0x0000000600000002 0x0000000700000003 } ; int len = dstW >> 3 ; int res = dstW & 7 ; while ( len -- ) { SCALE_8_8 ( 3 ) ; __lasx_xvst ( src0 , dst , 0 ) ; dst += 8 ; } if ( res & 4 ) { SCALE_8_4 ( 3 ) ; __lasx_xvstelm_d ( src0 , dst , 0 , 0 ) ; __lasx_xvstelm_d ( src0 , dst , 8 , 1 ) ; dst += 4 ; } if ( res & 2 ) { SCALE_8_2 ( 3 ) ; } if ( res & 1 ) { int val = 0 ; __m256i src0 , filter0 , out0 ; src0 = __lasx_xvldrepl_d ( src + filterPos [ 0 ] , 0 ) ; filter0 = __lasx_xvld ( filter , 0 ) ; src0 = __lasx_vext2xv_hu_bu ( src0 ) ; out0 = __lasx_xvdp2_w_h ( filter0 , src0 ) ; out0 = __lasx_xvhaddw_d_w ( out0 , out0 ) ; out0 = __lasx_xvhaddw_q_d ( out0 , out0 ) ; val = __lasx_xvpickve2gr_w ( out0 , 0 ) ; dst [ 0 ] = FFMIN ( val >> 3 , max ) ; } } if ( filterSize == 4 ) { __m256i src0 , src1 , src2 , src3 , src4 , src5 , src6 , src7 ; __m256i filter0 , filter1 ; __m256i vmax = __lasx_xvreplgr2vr_w ( max ) ; __m256i shuf = { 0x0000000100000000 0x0000000500000004 0x0000000300000002 0x0000000700000006 } ; int len = dstW >> 3 ; int res = dstW & 7 ; while ( len -- ) { SCALE_4_8 ( 3 ) ; src0 = __lasx_xvperm_w ( src0 , shuf ) ; __lasx_xvst ( src0 , dst , 0 ) ; dst += 8 ; } if ( res & 4 ) { SCALE_4_4 ( 3 ) ; __lasx_xvstelm_d ( src0 , dst , 0 , 0 ) ; __lasx_xvstelm_d ( src0 , dst , 8 , 1 ) ; dst += 4 ; } if ( res & 2 ) { SCALE_4_2 ( 3 ) ; } if ( res & 1 ) { int val = 0 ; const uint8_t * srcPos = src + filterPos [ 0 ] ; for ( int j = 0 ; j < filterSize ; j ++ ) { val += ( ( int ) srcPos [ j ] ) * filter [ j ] ; } dst [ 0 ] = FFMIN ( val >> 3 , max ) ; } } if ( filterSize > 8 ) { int len = dstW >> 2 ; int res = dstW & 3 ; int filterlen = filterSize - 7 ; __m256i zero = __lasx_xvldi ( 0 ) ; while ( len -- ) { __m256i src0 , src1 , src2 , src3 ; __m256i filter0 , filter1 , filter2 , filter3 , out0 , out1 ; __m256i out = zero ; const uint8_t * srcPos1 = src + filterPos [ 0 ] ; const uint8_t * srcPos2 = src + filterPos [ 1 ] ; const uint8_t * srcPos3 = src + filterPos [ 2 ] ; const uint8_t * srcPos4 = src + filterPos [ 3 ] ; const int16_t * filterStart1 = filter ; const int16_t * filterStart2 = filterStart1 + filterSize ; const int16_t * filterStart3 = filterStart2 + filterSize ; const int16_t * filterStart4 = filterStart3 + filterSize ; int j , val1 = 0 , val2 = 0 , val3 = 0 , val4 = 0 ; for ( j = 0 ; j < filterlen ; j += 8 ) { SCALE_16 ; } val1 = __lasx_xvpickve2gr_w ( out , 0 ) ; val2 = __lasx_xvpickve2gr_w ( out , 4 ) ; val3 = __lasx_xvpickve2gr_w ( out , 2 ) ; val4 = __lasx_xvpickve2gr_w ( out , 6 ) ; for ( ; j < filterSize ; j ++ ) { val1 += ( ( int ) srcPos1 [ j ] ) * filterStart1 [ j ] ; val2 += ( ( int ) srcPos2 [ j ] ) * filterStart2 [ j ] ; val3 += ( ( int ) srcPos3 [ j ] ) * filterStart3 [ j ] ; val4 += ( ( int ) srcPos4 [ j ] ) * filterStart4 [ j ] ; } dst [ 0 ] = FFMIN ( val1 >> 3 , max ) ; dst [ 1 ] = FFMIN ( val2 >> 3 , max ) ; dst [ 2 ] = FFMIN ( val3 >> 3 , max ) ; dst [ 3 ] = FFMIN ( val4 >> 3 , max ) ; dst += 4 ; filterPos += 4 ; filter = filterStart4 + filterSize ; } for ( i = 0 ; i < res ; i ++ ) { int j , val = 0 ; const uint8_t * srcPos = src + filterPos [ i ] ; __m256i src1 , filter0 , out0 ; for ( j = 0 ; j < filterlen ; j += 8 ) { src1 = __lasx_xvldrepl_d ( ( srcPos + j ) , 0 ) ; filter0 = __lasx_xvld ( filter + j , 0 ) ; src1 = __lasx_xvilvl_b ( zero , src1 ) ; out0 = __lasx_xvdp2_w_h ( filter0 , src1 ) ; out0 = __lasx_xvhaddw_d_w ( out0 , out0 ) ; out0 = __lasx_xvhaddw_q_d ( out0 , out0 ) ; val += __lasx_xvpickve2gr_w ( out0 , 0 ) ; } for ( ; j < filterSize ; j ++ ) { val += ( ( int ) srcPos [ j ] ) * filter [ j ] ; } dst [ i ] = FFMIN ( val >> 3 , max ) ; filter += filterSize ; } } else { for ( i = 0 ; i < dstW ; i ++ ) { int val = 0 ; const uint8_t * srcPos = src + filterPos [ i ] ; for ( int j = 0 ; j < filterSize ; j ++ ) { val += ( ( int ) srcPos [ j ] ) * filter [ j ] ; } dst [ i ] = FFMIN ( val >> 3 , max ) ; filter += filterSize ; } } } 