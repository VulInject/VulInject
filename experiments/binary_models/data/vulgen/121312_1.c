static int UVERBS_HANDLER UVERBS_METHOD_COUNTERS_READ ( struct uverbs_attr_bundle * attrs ) { struct ib_counters_read_attr read_attr = { } ; const struct uverbs_attr * uattr ; struct ib_counters * counters = uverbs_attr_get_obj ( attrs , UVERBS_ATTR_READ_COUNTERS_HANDLE ) ; int ret ; if ( ! counters -> device -> ops . read_counters ) { return - EOPNOTSUPP ; } if ( ! atomic_read ( & counters -> usecnt ) ) { return - EINVAL ; } ret = uverbs_get_flags32 ( & read_attr . flags , attrs , UVERBS_ATTR_READ_COUNTERS_FLAGS , IB_UVERBS_READ_COUNTERS_PREFER_CACHED ) ; if ( ret ) { return ret ; } uattr = uverbs_attr_get ( attrs , UVERBS_ATTR_READ_COUNTERS_BUFF ) ; read_attr . ncounters = uattr -> ptr_attr . len / sizeof ( u64 ) ; read_attr . counters_buff = uverbs_zalloc ( attrs , array_size ( read_attr . ncounters , sizeof ( u64 ) ) ) ; if ( IS_ERR ( read_attr . counters_buff ) ) { return PTR_ERR ( read_attr . counters_buff ) ; } ret = counters -> device -> ops . read_counters ( counters , & read_attr , attrs ) ; return uverbs_copy_to ( attrs , UVERBS_ATTR_READ_COUNTERS_BUFF , read_attr . counters_buff , read_attr . ncounters * sizeof ( u64 ) ) ; } 