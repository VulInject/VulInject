static void * OldParsePfringConfig ( const char * iface ) { const char * threadsstr = NULL ; PfringIfaceConfig * pfconf = SCMalloc ( sizeof ( * pfconf ) ) ; const char * tmpclusterid ; const char * tmpctype = NULL ; cluster_type default_ctype = CLUSTER_ROUND_ROBIN ; if ( iface == NULL ) { SCFree ( pfconf ) ; return NULL ; } strlcpy ( pfconf -> iface , iface , sizeof ( pfconf -> iface ) ) ; pfconf -> flags = 0 ; pfconf -> threads = 1 ; pfconf -> cluster_id = 1 ; pfconf -> ctype = default_ctype ; pfconf -> DerefFunc = PfringDerefConfig ; pfconf -> checksum_mode = CHECKSUM_VALIDATION_AUTO ; SC_ATOMIC_INIT ( pfconf -> ref ) ; ( void ) SC_ATOMIC_ADD ( pfconf -> ref , 1 ) ; if ( ConfGet ( "pfring.threads" , & threadsstr ) != 1 ) { pfconf -> threads = 1 ; } else { if ( threadsstr != NULL ) { if ( StringParseInt32 ( & pfconf -> threads , 10 , 0 , threadsstr ) < 0 ) { SCLogWarning ( "Invalid value for " "pfring.threads: '%s'. Resetting to 1." , threadsstr ) ; pfconf -> threads = 1 ; } } } if ( pfconf -> threads == 0 ) { pfconf -> threads = 1 ; } SC_ATOMIC_RESET ( pfconf -> ref ) ; ( void ) SC_ATOMIC_ADD ( pfconf -> ref , pfconf -> threads ) ; if ( strncmp ( pfconf -> iface , "zc" , 2 ) == 0 ) { SCLogInfo ( "ZC interface detected, not setting cluster-id" ) ; } if ( ( pfconf -> threads == 1 ) && ( strncmp ( pfconf -> iface , "dna" , 3 ) == 0 ) ) { SCLogInfo ( "DNA interface detected, not setting cluster-id" ) ; } if ( ConfGet ( "pfring.cluster-id" , & tmpclusterid ) != 1 ) { SCLogError ( "Could not get cluster-id from config" ) ; } else { if ( StringParseInt32 ( & pfconf -> cluster_id , 10 , 0 , ( const char * ) tmpclusterid ) < 0 ) { SCLogWarning ( "Invalid value for " "pfring.cluster_id: '%s'. Resetting to 1." , tmpclusterid ) ; pfconf -> cluster_id = 1 ; } pfconf -> flags |= PFRING_CONF_FLAGS_CLUSTER ; SCLogDebug ( "Going to use cluster-id %" PRId32 , pfconf -> cluster_id ) ; } if ( strncmp ( pfconf -> iface , "zc" , 2 ) == 0 ) { SCLogInfo ( "ZC interface detected, not setting cluster type for PF_RING (iface %s)" , pfconf -> iface ) ; } if ( ( pfconf -> threads == 1 ) && ( strncmp ( pfconf -> iface , "dna" , 3 ) == 0 ) ) { SCLogInfo ( "DNA interface detected, not setting cluster type for PF_RING (iface %s)" , pfconf -> iface ) ; } if ( ConfGet ( "pfring.cluster-type" , & tmpctype ) != 1 ) { SCLogError ( "Could not get cluster-type from config" ) ; } if ( strcmp ( tmpctype , "cluster_round_robin" ) == 0 ) { SCLogInfo ( "Using round-robin cluster mode for PF_RING (iface %s)" , pfconf -> iface ) ; pfconf -> ctype = ( cluster_type ) tmpctype ; } if ( strcmp ( tmpctype , "cluster_flow" ) == 0 ) { SCLogInfo ( "Using flow cluster mode for PF_RING (iface %s)" , pfconf -> iface ) ; pfconf -> ctype = ( cluster_type ) tmpctype ; } else { SCLogError ( "invalid cluster-type %s" , tmpctype ) ; SCFree ( pfconf ) ; return NULL ; } return pfconf ; } 