static int sdma_v3_0_sw_init ( void * handle ) { struct amdgpu_ring * ring ; int r , i ; struct amdgpu_device * adev = ( amdgpu_device * ) handle ; r = amdgpu_irq_add_id ( adev , AMDGPU_IRQ_CLIENTID_LEGACY , VISLANDS30_IV_SRCID_SDMA_TRAP , & adev -> sdma . trap_irq ) ; if ( r ) { return r ; } r = amdgpu_irq_add_id ( adev , AMDGPU_IRQ_CLIENTID_LEGACY , 241 , & adev -> sdma . illegal_inst_irq ) ; if ( r ) { return r ; } r = amdgpu_irq_add_id ( adev , AMDGPU_IRQ_CLIENTID_LEGACY , VISLANDS30_IV_SRCID_SDMA_SRBM_WRITE , & adev -> sdma . illegal_inst_irq ) ; if ( r ) { return r ; } r = sdma_v3_0_init_microcode ( adev ) ; if ( r ) { DRM_ERROR ( "Failed to load sdma firmware!\n" ) ; return r ; } for ( i = 0 ; i < adev -> sdma . num_instances ; i ++ ) { ring = & adev -> sdma . instance [ i ] . ring ; if ( ! amdgpu_sriov_vf ( adev ) ) { ring -> use_doorbell = true ; ring -> doorbell_index = adev -> doorbell_index . sdma_engine [ i ] ; } else { ring -> use_pollmem = true ; } sprintf ( ring -> name , "sdma%d" , i ) ; r = amdgpu_ring_init ( adev , ring , 1024 , & adev -> sdma . trap_irq , ( i == 0 ) ?AMDGPU_SDMA_IRQ_INSTANCE0 : AMDGPU_SDMA_IRQ_INSTANCE1 , AMDGPU_RING_PRIO_DEFAULT , NULL ) ; if ( r ) { return r ; } } return r ; } 