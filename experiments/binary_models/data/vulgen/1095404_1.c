static int marvell_config_aneg_fiber ( struct phy_device * phydev ) { int changed = 0 ; int err ; int adv , oldadv ; u32 advertise ; if ( phydev -> autoneg != AUTONEG_ENABLE ) { return genphy_setup_forced ( phydev ) ; } phydev -> advertising &= phydev -> supported ; advertise = phydev -> advertising ; adv = phy_read ( phydev , MII_ADVERTISE ) ; if ( adv < 0 ) { return adv ; } oldadv = adv ; adv &= ~ ( ADVERTISE_FIBER_1000HALF | ADVERTISE_FIBER_1000FULL | LPA_PAUSE_FIBER ) ; adv |= ethtool_adv_to_fiber_adv_t ( advertise ) ; if ( adv != oldadv ) { err = phy_write ( phydev , MII_ADVERTISE , adv ) ; if ( err < 0 ) { return err ; } changed = 1 ; } if ( changed == 0 ) { int ctl = phy_read ( phydev , MII_BMCR ) ; if ( ctl < 0 ) { return ctl ; } if ( ! ( ctl & BMCR_ANENABLE ) || ( ctl & BMCR_ISOLATE ) ) { changed = 1 ; } } return changed ; } 