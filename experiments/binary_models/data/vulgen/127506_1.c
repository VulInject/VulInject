static int stfsm_probe ( struct platform_device * pdev ) { struct device_node * np = pdev -> dev . of_node ; struct flash_info * info ; struct resource * res ; struct stfsm * fsm ; int ret ; if ( ! np ) { dev_err ( & pdev -> dev , "No DT found\n" ) ; return - EINVAL ; } fsm = devm_kzalloc ( & pdev -> dev , sizeof ( * fsm ) , GFP_KERNEL ) ; if ( ! fsm ) { return - ENOMEM ; } fsm -> dev = & pdev -> dev ; platform_set_drvdata ( pdev , fsm ) ; res = platform_get_resource ( pdev , IORESOURCE_MEM , 0 ) ; if ( ! res ) { dev_err ( & pdev -> dev , "Resource not found\n" ) ; return - ENODEV ; } fsm -> base = devm_ioremap_resource ( & pdev -> dev , res ) ; if ( IS_ERR ( fsm -> base ) ) { dev_err ( & pdev -> dev , "Failed to reserve memory region %pR\n" , res ) ; return PTR_ERR ( fsm -> base ) ; } fsm -> clk = devm_clk_get ( & pdev -> dev , NULL ) ; if ( IS_ERR ( fsm -> clk ) ) { dev_err ( fsm -> dev , "Couldn't find EMI clock.\n" ) ; return PTR_ERR ( fsm -> clk ) ; } ret = clk_prepare_enable ( fsm -> clk ) ; if ( ret ) { dev_err ( fsm -> dev , "Failed to enable EMI clock.\n" ) ; return ret ; } mutex_init ( & fsm -> lock ) ; ret = stfsm_init ( fsm ) ; if ( ret ) { dev_err ( & pdev -> dev , "Failed to initialise FSM Controller\n" ) ; return ret ; } stfsm_fetch_platform_configs ( pdev ) ; info = stfsm_jedec_probe ( fsm ) ; if ( ! info ) { return - ENODEV ; } if ( info -> sector_size * info -> n_sectors > 0x1000000 ) { info -> flags |= FLASH_FLAG_32BIT_ADDR ; } if ( info -> config ) { ret = info -> config ( fsm ) ; if ( ret ) { return ret ; } } else { ret = stfsm_prepare_rwe_seqs_default ( fsm ) ; if ( ret ) { return ret ; } } fsm -> mtd . name = info -> name ; fsm -> mtd . dev . parent = & pdev -> dev ; mtd_set_of_node ( & fsm -> mtd , np ) ; fsm -> mtd . type = MTD_NORFLASH ; fsm -> mtd . writesize = 4 ; fsm -> mtd . writebufsize = fsm -> mtd . writesize ; fsm -> mtd . flags = MTD_CAP_NORFLASH ; fsm -> mtd . size = info -> sector_size * info -> n_sectors ; fsm -> mtd . erasesize = info -> sector_size ; fsm -> mtd . _read = stfsm_mtd_read ; fsm -> mtd . _write = stfsm_mtd_write ; fsm -> mtd . _erase = stfsm_mtd_erase ; dev_info ( & pdev -> dev , "Found serial flash device: %s\n" " size = %llx (%lldMiB) erasesize = 0x%08x (%uKiB)\n" , info -> name , ( long long ) fsm -> mtd . size , ( long long ) ( fsm -> mtd . size >> 20 ) , fsm -> mtd . erasesize , ( fsm -> mtd . erasesize >> 10 ) ) ; return mtd_device_register ( & fsm -> mtd , NULL , 0 ) ; } 