static int pm2xxx_charger_ac_en ( struct ux500_charger * charger , int enable , int vset , int iset ) { int ret ; int volt_index ; int curr_index ; u8 val ; struct pm2xxx_charger * pm2 = to_pm2xxx_charger_ac_device_info ( charger ) ; if ( enable ) { if ( ! pm2 -> ac . charger_connected ) { dev_dbg ( pm2 -> dev , "AC charger not connected\n" ) ; return - ENXIO ; } dev_dbg ( pm2 -> dev , "Enable AC: %dmV %dmA\n" , vset , iset ) ; if ( ! pm2 -> vddadc_en_ac ) { ret = regulator_enable ( pm2 -> regu ) ; if ( ret ) { dev_warn ( pm2 -> dev , "Failed to enable vddadc regulator\n" ) ; } else { pm2 -> vddadc_en_ac = true ; } } ret = pm2xxx_charging_init ( pm2 ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "%s charging init failed\n" , __func__ ) ; error_occured } volt_index = pm2xxx_voltage_to_regval ( vset ) ; curr_index = pm2xxx_current_to_regval ( iset ) ; if ( volt_index < 0 || curr_index < 0 ) { dev_err ( pm2 -> dev , "Charger voltage or current too high, " "charging not started\n" ) ; return - ENXIO ; } ret = pm2xxx_reg_read ( pm2 , PM2XXX_BATT_CTRL_REG8 , & val ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "%s pm2xxx read failed\n" , __func__ ) ; error_occured } val &= ~ PM2XXX_CH_VOLT_MASK ; val |= volt_index ; ret = pm2xxx_reg_write ( pm2 , PM2XXX_BATT_CTRL_REG8 , val ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "%s pm2xxx write failed\n" , __func__ ) ; error_occured } ret = pm2xxx_reg_read ( pm2 , PM2XXX_BATT_CTRL_REG6 , & val ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "%s pm2xxx read failed\n" , __func__ ) ; error_occured } val &= ~ PM2XXX_DIR_CH_CC_CURRENT_MASK ; val |= curr_index ; ret = pm2xxx_reg_write ( pm2 , PM2XXX_BATT_CTRL_REG6 , val ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "%s pm2xxx write failed\n" , __func__ ) ; error_occured } if ( ! pm2 -> bat -> enable_overshoot ) { ret = pm2xxx_reg_read ( pm2 , PM2XXX_LED_CTRL_REG , & val ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "%s pm2xxx read failed\n" , __func__ ) ; error_occured } val |= PM2XXX_ANTI_OVERSHOOT_EN ; ret = pm2xxx_reg_write ( pm2 , PM2XXX_LED_CTRL_REG , val ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "%s pm2xxx write failed\n" , __func__ ) ; error_occured } } ret = pm2xxx_charging_enable_mngt ( pm2 ) ; if ( ret < 0 ) { dev_err ( pm2 -> dev , "Failed to enable" "pm2xxx ac charger\n" ) ; error_occured } pm2 -> ac . charger_online = 1 ; } else { pm2 -> ac . charger_online = 0 ; pm2 -> ac . wd_expired = false ; if ( pm2 -> vddadc_en_ac ) { regulator_disable ( pm2 -> regu ) ; pm2 -> vddadc_en_ac = false ; } ret = pm2xxx_charging_disable_mngt ( pm2 ) ; dev_dbg ( pm2 -> dev , "PM2301: " "Disabled AC charging\n" ) ; } power_supply_changed ( pm2 -> ac_chg . psy ) ; error_occured return ret ; } 