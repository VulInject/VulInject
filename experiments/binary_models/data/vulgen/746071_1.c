void spa_config_sync ( spa_t * target , boolean_t removing , boolean_t postsysevent ) { spa_config_dirent_t * dp , * tdp ; nvlist_t * nvl ; char * pool_name ; boolean_t ccw_failure ; int error = 0 ; ASSERT ( MUTEX_HELD ( & spa_namespace_lock ) ) ; ccw_failure = B_FALSE ; for ( dp = list_head ( & target -> spa_config_list ) ; dp != NULL ; dp = list_next ( & target -> spa_config_list , dp ) ) { spa_t * spa = NULL ; if ( dp -> scd_path == NULL ) { continue ; } nvl = NULL ; while ( ( spa = spa_next ( spa ) ) != NULL ) { if ( ( spa == target && removing ) || ! spa_writeable ( spa ) ) { continue ; } mutex_enter ( & spa -> spa_props_lock ) ; tdp = list_head ( & spa -> spa_config_list ) ; if ( spa -> spa_config == NULL || tdp == NULL || tdp -> scd_path == NULL || strcmp ( tdp -> scd_path , dp -> scd_path ) != 0 ) { mutex_exit ( & spa -> spa_props_lock ) ; continue ; } if ( nvl == NULL ) { nvl = fnvlist_alloc ( ) ; } if ( spa -> spa_import_flags & ZFS_IMPORT_TEMP_NAME ) { pool_name = fnvlist_lookup_string ( spa -> spa_config , ZPOOL_CONFIG_POOL_NAME ) ; } else { pool_name = spa_name ( spa ) ; } fnvlist_add_nvlist ( nvl , pool_name , spa -> spa_config ) ; mutex_exit ( & spa -> spa_props_lock ) ; } error = spa_config_write ( dp , nvl ) ; if ( error != 0 ) { ccw_failure = B_TRUE ; } nvlist_free ( nvl ) ; } if ( ccw_failure ) { if ( target -> spa_ccw_fail_time == 0 ) { zfs_ereport_post ( FM_EREPORT_ZFS_CONFIG_CACHE_WRITE , target , NULL , NULL , NULL , 0 , 0 ) ; } target -> spa_ccw_fail_time = gethrtime ( ) ; spa_async_request ( target , SPA_ASYNC_CONFIG_UPDATE ) ; } else { target -> spa_ccw_fail_time = 0 ; } dp = list_head ( & target -> spa_config_list ) ; while ( ( tdp = list_next ( & target -> spa_config_list , dp ) ) != NULL ) { list_remove ( & target -> spa_config_list , tdp ) ; if ( tdp -> scd_path != NULL ) { spa_strfree ( tdp -> scd_path ) ; } kmem_free ( tdp , sizeof ( spa_config_dirent_t ) ) ; } spa_config_generation ++ ; if ( postsysevent ) { spa_event_notify ( target , NULL , NULL , ESC_ZFS_CONFIG_SYNC ) ; } } 