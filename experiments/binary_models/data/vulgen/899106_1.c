int audit_cron_session ( char * name , char * path , uid_t uid , gid_t gid , char * at_jobname ) { struct auditinfo_addr info ; au_mask_t mask ; char * anc_file , * fname ; int r = 0 ; char full_path [ PATH_MAX ] ; if ( at_jobname == NULL ) { fname = name ; if ( path != NULL ) { if ( strlen ( path ) + strlen ( fname ) + 2 > PATH_MAX ) { errno = ENAMETOOLONG ; r = - 1 ; } ( void ) strcat ( strcat ( strcpy ( full_path , path ) , "/" ) , fname ) ; fname = full_path ; } } else { fname = at_jobname ; } if ( r == 0 ) { anc_file = audit_cron_make_anc_name ( fname ) ; if ( anc_file == NULL ) { r = - 1 ; } else { r = audit_cron_getinfo ( fname , anc_file , & info ) ; } } if ( r != 0 ) { char * err_str ; if ( r == ANC_BAD_FORMAT ) { err_str = dgettext ( bsm_dom , "bad format" ) ; } else { err_str = strerror ( errno ) ; } audit_cron_session_failure ( name , at_jobname == NULL , err_str ) ; if ( anc_file != NULL ) { free ( anc_file ) ; } return ( r ) ; } free ( anc_file ) ; aug_init ( ) ; if ( au_user_mask ( name , & mask ) == 0 ) { info . ai_mask . am_success |= mask . am_success ; info . ai_mask . am_failure |= mask . am_failure ; } aug_save_auid ( info . ai_auid ) ; aug_save_asid ( info . ai_asid ) ; aug_save_tid_ex ( info . ai_termid . at_port , info . ai_termid . at_addr , info . ai_termid . at_type ) ; aug_save_pid ( getpid ( ) ) ; aug_save_uid ( uid ) ; aug_save_gid ( gid ) ; aug_save_euid ( uid ) ; aug_save_egid ( gid ) ; return ( setaudit_addr ( & info , sizeof ( info ) ) ) ; } 