static inline void mt_count_alloc ( struct memtype * mt , size_t size , void * ptr ) { size_t current ; size_t oldsize ; current = 1 + atomic_fetch_add_explicit ( & mt -> n_alloc , 1 , memory_order_relaxed ) ; oldsize = atomic_load_explicit ( & mt -> n_max , memory_order_relaxed ) ; if ( current > oldsize ) { atomic_compare_exchange_weak_explicit ( & mt -> n_max , & oldsize , current , memory_order_relaxed , memory_order_relaxed ) ; } oldsize = atomic_load_explicit ( & mt -> size , memory_order_relaxed ) ; if ( oldsize == 0 ) { oldsize = atomic_exchange_explicit ( & mt -> size , size , memory_order_relaxed ) ; } size_t mallocsz = malloc_usable_size ( ptr ) ; current = mallocsz + atomic_fetch_add_explicit ( & mt -> total , mallocsz , memory_order_relaxed ) ; oldsize = atomic_load_explicit ( & mt -> max_size , memory_order_relaxed ) ; if ( current > oldsize ) { atomic_compare_exchange_weak_explicit ( & mt -> max_size , & oldsize , current , memory_order_relaxed , memory_order_relaxed ) ; } } 