static void CG_PlayerFlag ( centity_t * cent , qhandle_t hSkin , refEntity_t * torso ) { clientInfo_t * ci ; refEntity_t pole ; refEntity_t flag ; vec3_t angles , dir ; int legsAnim , flagAnim , updateangles ; float angle , d ; memset ( & pole , 0 , sizeof ( pole ) ) ; pole . hModel = cgs . media . flagPoleModel ; VectorCopy ( torso -> lightingOrigin , pole . lightingOrigin ) ; pole . shadowPlane = torso -> shadowPlane ; pole . renderfx = torso -> renderfx ; CG_PositionEntityOnTag ( & pole , torso , torso -> hModel , "tag_flag" ) ; trap_R_AddRefEntityToScene ( & pole ) ; memset ( & flag , 0 , sizeof ( flag ) ) ; flag . hModel = cgs . media . flagFlapModel ; flag . customSkin = hSkin ; VectorCopy ( torso -> lightingOrigin , flag . lightingOrigin ) ; flag . shadowPlane = torso -> shadowPlane ; flag . renderfx = torso -> renderfx ; updateangles = qfalse ; legsAnim = cent -> currentState . legsAnim & ~ ANIM_TOGGLEBIT ; if ( legsAnim == LEGS_IDLE || legsAnim == LEGS_IDLECR ) { flagAnim = FLAG_STAND ; } if ( legsAnim == LEGS_WALK || legsAnim == LEGS_WALKCR ) { flagAnim = FLAG_STAND ; updateangles = qtrue ; } else { flagAnim = FLAG_RUN ; updateangles = qtrue ; } if ( updateangles ) { VectorCopy ( cent -> currentState . pos . trDelta , dir ) ; dir [ 2 ] += 100 ; VectorNormalize ( dir ) ; d = DotProduct ( pole . axis [ 2 ] , dir ) ; if ( fabs ( d ) < 0.9 ) { d = DotProduct ( pole . axis [ 0 ] , dir ) ; if ( d > 1.0f ) { d = 1.0f ; } if ( d < - 1.0f ) { d = - 1.0f ; } angle = acos ( d ) ; d = DotProduct ( pole . axis [ 1 ] , dir ) ; if ( d < 0 ) { angles [ YAW ] = 360 - angle * 180 / M_PI ; } else { angles [ YAW ] = angle * 180 / M_PI ; } if ( angles [ YAW ] < 0 ) { angles [ YAW ] += 360 ; } if ( angles [ YAW ] > 360 ) { angles [ YAW ] -= 360 ; } CG_SwingAngles ( angles [ YAW ] , 25 , 90 , 0.15f , & cent -> pe . flag . yawAngle , & cent -> pe . flag . yawing ) ; } } angles [ YAW ] = cent -> pe . flag . yawAngle ; ci = & cgs . clientinfo [ cent -> currentState . clientNum ] ; CG_RunLerpFrame ( ci , & cent -> pe . flag , flagAnim , 1 ) ; flag . oldframe = cent -> pe . flag . oldFrame ; flag . frame = cent -> pe . flag . frame ; flag . backlerp = cent -> pe . flag . backlerp ; AnglesToAxis ( angles , flag . axis ) ; CG_PositionRotatedEntityOnTag ( & flag , & pole , pole . hModel , "tag_flag" ) ; trap_R_AddRefEntityToScene ( & flag ) ; } 