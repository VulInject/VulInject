void dco_event_set ( dco_context_t * dco , struct event_set * es , void * arg ) { struct ifdrv drv ; nvlist_t * nvl ; uint8_t buf [ 128 ] ; int ret ; CLEAR ( drv ) ; snprintf ( drv . ifd_name , IFNAMSIZ , "%s" , dco -> ifname ) ; drv . ifd_cmd = OVPN_POLL_PKT ; drv . ifd_len = sizeof ( buf ) ; drv . ifd_data = buf ; ret = ioctl ( dco -> fd , SIOCGDRVSPEC , & drv ) ; if ( ret ) { msg ( M_WARN | M_ERRNO , "Failed to poll for packets" ) ; return ; } nvl = nvlist_unpack ( buf , drv . ifd_len , 0 ) ; if ( ! nvl ) { msg ( M_WARN , "Failed to unpack nvlist" ) ; return ; } if ( nvlist_get_number ( nvl , "pending" ) > 0 ) { ( void ) write ( dco -> pipefd [ 0 ] , " " , 1 ) ; event_ctl ( es , dco -> pipefd [ 1 ] , EVENT_READ , arg ) ; } nvlist_destroy ( nvl ) ; } 