int mt76_connac_mcu_hw_scan ( struct mt76_phy * phy , struct ieee80211_vif * vif , struct ieee80211_scan_request * scan_req ) { struct mt76_vif * mvif = ( mt76_vif * ) vif -> drv_priv ; struct cfg80211_scan_request * sreq = & scan_req -> req ; int n_ssids = 0 , err , i , duration ; int ext_channels_num = max_t ( int , sreq -> n_channels - 32 , 0 ) ; struct ieee80211_channel * * scan_list = sreq -> channels ; struct mt76_dev * mdev = phy -> dev ; struct mt76_connac_mcu_scan_channel * chan ; struct mt76_connac_hw_scan_req * req ; struct sk_buff * skb ; if ( test_bit ( MT76_HW_SCANNING , & phy -> state ) ) { return - EBUSY ; } skb = mt76_mcu_msg_alloc ( mdev , NULL , sizeof ( * req ) ) ; if ( ! skb ) { return - ENOMEM ; } set_bit ( MT76_HW_SCANNING , & phy -> state ) ; mvif -> scan_seq_num = ( mvif -> scan_seq_num + 1 ) & 0x7f ; req = ( mt76_connac_hw_scan_req * ) skb_put ( skb , sizeof ( * req ) ) ; req -> seq_num = mvif -> scan_seq_num | mvif -> band_idx << 7 ; req -> bss_idx = mvif -> idx ; req -> scan_type = sreq -> n_ssids ?1 : 0 ; req -> probe_req_num = sreq -> n_ssids ?2 : 0 ; req -> version = 1 ; for ( i = 0 ; i < sreq -> n_ssids ; i ++ ) { if ( ! sreq -> ssids [ i ] . ssid_len ) { continue ; } req -> ssids [ i ] . ssid_len = cpu_to_le32 ( sreq -> ssids [ i ] . ssid_len ) ; memcpy ( req -> ssids [ i ] . ssid , sreq -> ssids [ i ] . ssid , sreq -> ssids [ i ] . ssid_len ) ; n_ssids ++ ; } req -> ssid_type = n_ssids ?BIT ( 2 ) : BIT ( 0 ) ; req -> ssid_type_ext = n_ssids ?BIT ( 0 ) : 0 ; req -> ssids_num = n_ssids ; duration = is_mt7921 ( phy -> dev ) ?0 : MT76_CONNAC_SCAN_CHANNEL_TIME ; if ( ! sreq -> n_ssids ) { duration *= 2 ; } req -> timeout_value = cpu_to_le16 ( sreq -> n_channels * duration ) ; req -> channel_min_dwell_time = cpu_to_le16 ( duration ) ; req -> channel_dwell_time = cpu_to_le16 ( duration ) ; req -> channels_num = min_t ( u8 , sreq -> n_channels , 32 ) ; req -> ext_channels_num = min_t ( u8 , ext_channels_num , 32 ) ; for ( i = 0 ; i < req -> channels_num + req -> ext_channels_num ; i ++ ) { if ( i >= 32 ) { chan = & req -> ext_channels [ i - 32 ] ; } else { chan = & req -> channels [ i ] ; } switch ( scan_list [ i ] -> band ) { case NL80211_BAND_2GHZ : chan -> band = 1 ; break ; case NL80211_BAND_6GHZ : chan -> band = 3 ; break ; default : chan -> band = 2 ; break ; } chan -> channel_num = scan_list [ i ] -> hw_value ; } req -> channel_type = sreq -> n_channels ?4 : 0 ; if ( sreq -> ie_len > 0 ) { memcpy ( req -> ies , sreq -> ie , sreq -> ie_len ) ; req -> ies_len = cpu_to_le16 ( sreq -> ie_len ) ; } if ( is_mt7921 ( phy -> dev ) ) { req -> scan_func |= SCAN_FUNC_SPLIT_SCAN ; } memcpy ( req -> bssid , sreq -> bssid , ETH_ALEN ) ; if ( sreq -> flags & NL80211_SCAN_FLAG_RANDOM_ADDR ) { get_random_mask_addr ( req -> random_mac , sreq -> mac_addr , sreq -> mac_addr_mask ) ; req -> scan_func |= SCAN_FUNC_RANDOM_MAC ; } err = mt76_mcu_skb_send_msg ( mdev , skb , MCU_CE_CMD ( START_HW_SCAN ) , false ) ; return err ; } 