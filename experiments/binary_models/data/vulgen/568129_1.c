static struct vector_queue * create_queue ( struct vector_private * vp , int max_size , int header_size , int num_extra_frags ) { struct vector_queue * result ; int i ; struct iovec * iov ; struct mmsghdr * mmsg_vector ; result = kmalloc ( sizeof ( vector_queue ) , GFP_KERNEL ) ; if ( result == NULL ) { return NULL ; } result -> max_depth = max_size ; result -> dev = vp -> dev ; result -> mmsg_vector = kmalloc ( ( sizeof ( mmsghdr ) * max_size ) , GFP_KERNEL ) ; if ( result -> mmsg_vector == NULL ) { out_mmsg_fail } result -> skbuff_vector = kmalloc ( ( sizeof ( void * ) * max_size ) , GFP_KERNEL ) ; if ( result -> skbuff_vector == NULL ) { out_skb_fail } mmsg_vector = result -> mmsg_vector ; for ( i = 0 ; i < max_size ; i ++ ) { * ( result -> skbuff_vector + i ) = NULL ; mmsg_vector -> msg_hdr . msg_iov = NULL ; mmsg_vector ++ ; } mmsg_vector = result -> mmsg_vector ; result -> max_iov_frags = num_extra_frags ; for ( i = 0 ; i < max_size ; i ++ ) { if ( vp -> header_size > 0 ) { iov = kmalloc_array ( 3 + num_extra_frags , sizeof ( iovec ) , GFP_KERNEL ) ; } else { iov = kmalloc_array ( 2 + num_extra_frags , sizeof ( iovec ) , GFP_KERNEL ) ; } if ( iov == NULL ) { out_fail } mmsg_vector -> msg_hdr . msg_iov = iov ; mmsg_vector -> msg_hdr . msg_iovlen = 1 ; mmsg_vector -> msg_hdr . msg_control = NULL ; mmsg_vector -> msg_hdr . msg_controllen = 0 ; mmsg_vector -> msg_hdr . msg_flags = MSG_DONTWAIT ; mmsg_vector -> msg_hdr . msg_name = NULL ; mmsg_vector -> msg_hdr . msg_namelen = 0 ; if ( vp -> header_size > 0 ) { iov -> iov_base = kmalloc ( header_size , GFP_KERNEL ) ; iov -> iov_len = header_size ; mmsg_vector -> msg_hdr . msg_iovlen = 2 ; iov ++ ; } iov -> iov_base = NULL ; iov -> iov_len = 0 ; mmsg_vector ++ ; } spin_lock_init ( & result -> head_lock ) ; spin_lock_init ( & result -> tail_lock ) ; result -> queue_depth = 0 ; result -> head = 0 ; result -> tail = 0 ; return result ; out_skb_fail kfree ( result -> mmsg_vector ) ; out_mmsg_fail kfree ( result ) ; return NULL ; out_fail destroy_queue ( result ) ; return NULL ; } 