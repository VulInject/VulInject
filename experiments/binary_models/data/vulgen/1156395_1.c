static s32 spi_cfg_mxc ( struct mxc_spi_slave * mxcs , unsigned int cs ) { unsigned int ctrl_reg ; u32 clk_src ; u32 div ; unsigned int max_hz = mxcs -> max_hz ; unsigned int mode = mxcs -> mode ; clk_src = mxc_get_clock ( MXC_CSPI_CLK ) ; div = DIV_ROUND_UP ( clk_src , max_hz ) ; div = get_cspi_div ( div ) ; debug ( "clk %d Hz, div %d, real clk %d Hz\n" , max_hz , div , clk_src / ( 4 << div ) ) ; ctrl_reg = MXC_CSPICTRL_CHIPSELECT ( cs ) | MXC_CSPICTRL_BITCOUNT ( MXC_CSPICTRL_MAXBITS ) | MXC_CSPICTRL_DATARATE ( div ) | MXC_CSPICTRL_EN | MXC_CSPICTRL_MODE ; if ( mode & SPI_CPHA ) { ctrl_reg |= MXC_CSPICTRL_PHA ; } if ( mode & SPI_CPOL ) { ctrl_reg |= MXC_CSPICTRL_POL ; } mxcs -> ctrl_reg = ctrl_reg ; return 0 ; } 