void free_pwnam ( struct passwd * pwdp , char * buf ) { if ( buf != NULL ) { free ( buf ) ; buf = NULL ; } if ( pwdp != NULL ) { free ( pwdp ) ; pwdp = NULL ; } } struct passwd * getpwnam_ext ( char * * user_buffer , char * user_name ) { struct passwd * pwent = NULL ; int retrycnt = 0 ; errno = 0 ; while ( ( pwent == NULL ) && ( retrycnt != - 1 ) && ( retrycnt < LDAP_RETRIES ) ) { pwent = getpwnam_wrapper ( user_buffer , user_name ) ; if ( pwent == NULL ) { switch ( errno ) { case EINTR : case EIO : case EMFILE : case ENFILE : case ENOMEM : case ERANGE : sprintf ( log_buffer , "ERROR: getpwnam() error %d (%s)" , errno , strerror ( errno ) ) ; log_ext ( - 1 , __func__ , log_buffer , LOG_ERR ) ; retrycnt ++ ; break ; default : retrycnt = - 1 ; break ; } } } return ( pwent ) ; } struct passwd * get_password_entry_by_uid ( char * * user_buf , uid_t uid ) { struct passwd * user_pwd = NULL ; * user_buf = NULL ; for ( int i = 0 ; i < LDAP_RETRIES ; i ++ ) { if ( ( user_pwd = getpwuid_wrapper ( user_buf , uid ) ) != NULL ) { break ; } } return ( user_pwd ) ; } int setuid_ext ( uid_t uid , int set_euid ) { int count = 0 ; int rc = PBSE_NONE ; errno = 0 ; while ( count < LDAP_RETRIES ) { if ( set_euid == TRUE ) { rc = seteuid ( uid ) ; } else { rc = setuid ( uid ) ; } if ( rc == 0 ) { break ; } else { switch ( errno ) { case EAGAIN : case EINTR : usleep ( 200 ) ; count ++ ; break ; default : count += LDAP_RETRIES ; break ; } } } return ( rc ) ; } int initgroups_ext ( const char * username , gid_t gr_id ) { int count = 0 ; int rc = PBSE_NONE ; errno = 0 ; while ( count < LDAP_RETRIES ) { if ( ( rc = initgroups ( username , gr_id ) ) != 0 ) { switch ( errno ) { case EAGAIN : case EINTR : count ++ ; usleep ( 200 ) ; break ; default : count += LDAP_RETRIES ; break ; } } else { break ; } } return ( rc ) ; } 