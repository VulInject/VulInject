int select_branch_uri ( str * res , select_t * s , struct sip_msg * msg ) { qvalue_t q ; int l , n ; str dst_uri ; if ( s -> n <= SEL_POS + 1 && nr_branches > 1 ) { int len ; unsigned l2 ; char * c ; len = 0 ; while ( ( c = next_branch ( & l , & q , & dst_uri , 0 , 0 , 0 , 0 , 0 , 0 ) ) ) { if ( s -> params [ SEL_POS ] . v . i & SEL_BRANCH_DST_URI ) { l = dst_uri . len ; c = dst_uri . s ; } if ( s -> params [ SEL_POS ] . v . i & ( SEL_BRANCH_URI | SEL_BRANCH_DST_URI ) ) { len += l ; } if ( q != Q_UNSPECIFIED && ( s -> params [ SEL_POS ] . v . i & SEL_BRANCH_Q ) ) { len += len_q ( q ) ; if ( s -> params [ SEL_POS ] . v . i & SEL_BRANCH_URI ) { len += 1 + Q_PARAM_LEN ; } } len += 1 ; } if ( ! len ) { return 1 ; } res -> s = get_static_buffer ( len ) ; if ( ! res -> s ) { return - 1 ; } init_branch_iterator ( ) ; res -> len = 0 ; n = 0 ; while ( ( c = next_branch ( & l , & q , & dst_uri , 0 , 0 , 0 , 0 , 0 , 0 ) ) ) { if ( s -> params [ SEL_POS ] . v . i & SEL_BRANCH_DST_URI ) { l = dst_uri . len ; c = dst_uri . s ; } if ( n ) { res -> s [ res -> len ] = ',' ; res -> len ++ ; } if ( ( s -> params [ SEL_POS ] . v . i & SEL_BRANCH_Q ) == 0 ) { q = Q_UNSPECIFIED ; } if ( ( s -> params [ SEL_POS ] . v . i & ( SEL_BRANCH_URI | SEL_BRANCH_DST_URI ) ) && q != Q_UNSPECIFIED ) { res -> s [ res -> len ] = '<' ; res -> len ++ ; memcpy ( res -> s + res -> len , c , l ) ; res -> len += l ; memcpy ( res -> s + res -> len , Q_PARAM , Q_PARAM_LEN ) ; res -> len += Q_PARAM_LEN ; c = q2str ( q , & l2 ) ; l = l2 ; memcpy ( res -> s + res -> len , c , l ) ; res -> len += l ; } if ( s -> params [ SEL_POS ] . v . i & ( SEL_BRANCH_URI | SEL_BRANCH_DST_URI ) ) { memcpy ( res -> s + res -> len , c , l ) ; res -> len += l ; } if ( q != Q_UNSPECIFIED ) { c = q2str ( q , & l2 ) ; l = l2 ; memcpy ( res -> s + res -> len , c , l ) ; res -> len += l ; } n ++ ; } } else { unsigned l2 ; char * c ; n = s -> params [ SEL_POS + 1 ] . v . i ; if ( n < 0 || n >= nr_branches ) { return - 1 ; } init_branch_iterator ( ) ; for ( ; ( c = next_branch ( & l , & q , & dst_uri , 0 , 0 , 0 , 0 , 0 , 0 ) ) && n ; n -- ) { } if ( ! c ) { return 1 ; } if ( s -> params [ SEL_POS ] . v . i & SEL_BRANCH_DST_URI ) { l = dst_uri . len ; c = dst_uri . s ; } if ( ( s -> params [ SEL_POS ] . v . i & SEL_BRANCH_Q ) == 0 ) { q = Q_UNSPECIFIED ; } if ( ( s -> params [ SEL_POS ] . v . i & ( SEL_BRANCH_URI | SEL_BRANCH_DST_URI ) ) && q != Q_UNSPECIFIED ) { res -> s = get_static_buffer ( l + 1 + Q_PARAM_LEN + len_q ( q ) ) ; if ( ! res -> s ) { return - 1 ; } res -> len = 1 ; res -> s [ 0 ] = '<' ; memcpy ( res -> s + res -> len , c , l ) ; res -> len += l ; memcpy ( res -> s + res -> len , Q_PARAM , Q_PARAM_LEN ) ; res -> len += Q_PARAM_LEN ; c = q2str ( q , & l2 ) ; l = l2 ; memcpy ( res -> s + res -> len , c , l ) ; res -> len += l ; } if ( s -> params [ SEL_POS ] . v . i & ( SEL_BRANCH_URI | SEL_BRANCH_DST_URI ) ) { res -> s = c ; res -> len = l ; } if ( q != Q_UNSPECIFIED ) { c = q2str ( q , & l2 ) ; res -> len = l2 ; res -> s = get_static_buffer ( res -> len ) ; if ( ! res -> s ) { return - 1 ; } memcpy ( res -> s , c , res -> len ) ; } else { res -> len = 0 ; } } return 0 ; } 