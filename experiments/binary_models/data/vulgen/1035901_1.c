static void vid_cap_buf_finish ( struct vb2_buffer * vb ) { struct vb2_v4l2_buffer * vbuf = to_vb2_v4l2_buffer ( vb ) ; struct vivid_dev * dev = vb2_get_drv_priv ( vb -> vb2_queue ) ; struct v4l2_timecode * tc = & vbuf -> timecode ; unsigned fps = 25 ; unsigned seq = vbuf -> sequence ; if ( ! vivid_is_sdtv_cap ( dev ) ) { return ; } vbuf -> flags |= V4L2_BUF_FLAG_TIMECODE ; if ( dev -> std_cap & V4L2_STD_525_60 ) { fps = 30 ; } tc -> type = ( fps == 30 ) ?V4L2_TC_TYPE_30FPS : V4L2_TC_TYPE_25FPS ; tc -> frames = seq % fps ; tc -> seconds = ( seq / fps ) % 60 ; tc -> minutes = ( seq / ( 60 * fps ) ) % 60 ; tc -> hours = ( seq / ( 60 * 60 * fps ) ) % 24 ; } 