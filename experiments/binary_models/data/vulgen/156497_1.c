int cdns3_allocate_trb_pool ( struct cdns3_endpoint * priv_ep ) { struct cdns3_device * priv_dev = priv_ep -> cdns3_dev ; int ring_size = TRB_RING_SIZE ; int num_trbs = ring_size / TRB_SIZE ; struct cdns3_trb * link_trb ; if ( priv_ep -> trb_pool && priv_ep -> alloc_ring_size < ring_size ) { cdns3_free_trb_pool ( priv_ep ) ; } if ( ! priv_ep -> trb_pool ) { priv_ep -> trb_pool = dma_pool_alloc ( priv_dev -> eps_dma_pool , GFP_ATOMIC , & priv_ep -> trb_pool_dma ) ; priv_ep -> alloc_ring_size = ring_size ; } memset ( priv_ep -> trb_pool , 0 , ring_size ) ; priv_ep -> num_trbs = num_trbs ; if ( ! priv_ep -> num ) { return 0 ; } link_trb = ( priv_ep -> trb_pool + ( priv_ep -> num_trbs - 1 ) ) ; if ( priv_ep -> use_streams ) { link_trb -> control = 0 ; } else { link_trb -> buffer = cpu_to_le32 ( TRB_BUFFER ( priv_ep -> trb_pool_dma ) ) ; link_trb -> control = cpu_to_le32 ( TRB_CYCLE | TRB_TYPE ( TRB_LINK ) | TRB_TOGGLE ) ; } return 0 ; } 