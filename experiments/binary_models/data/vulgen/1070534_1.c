int main ( int argc , char * * argv ) { int result ; int error = FALSE ; int display_license = FALSE ; int display_help = FALSE ; int c ; int option_index = 0 ; static struct option long_options [ ] { { "help" no_argument NULL 'h' } { "version" no_argument NULL 'V' } { "license" no_argument NULL 'L' } { "config" required_argument NULL 'c' } { "statsfile" required_argument NULL 's' } { "mrtg" no_argument NULL 'm' } { "data" required_argument NULL 'd' } { "delimiter" required_argument NULL 'D' } { NULL 0 NULL 0 } } ; ; main_config_file = strdup ( DEFAULT_CONFIG_FILE ) ; mrtg_delimiter = strdup ( "\n" ) ; while ( 1 ) { c = getopt ( argc , argv , "+hVLc:ms:d:D:" ) ; if ( c == - 1 || c == EOF ) { break ; } switch ( c ) { case '?' : case 'h' : display_help = TRUE ; break ; case 'V' : display_license = TRUE ; break ; case 'L' : display_license = TRUE ; break ; case 'c' : free ( main_config_file ) ; main_config_file = strdup ( optarg ) ; break ; case 's' : free ( status_file ) ; status_file = strdup ( optarg ) ; break ; case 'm' : mrtg_mode = TRUE ; break ; case 'd' : mrtg_variables = strdup ( optarg ) ; break ; case 'D' : free ( mrtg_delimiter ) ; mrtg_delimiter = strdup ( optarg ) ; break ; default : break ; } } if ( mrtg_mode == FALSE ) { printf ( "\nNagios Stats %s\n" , PROGRAM_VERSION ) ; printf ( "Copyright (c) 2003-2008 Ethan Galstad (www.nagios.org)\n" ) ; printf ( "Last Modified: %s\n" , PROGRAM_MODIFICATION_DATE ) ; printf ( "License: GPL\n\n" ) ; } if ( display_license == TRUE ) { printf ( "This program is free software; you can redistribute it and/or modify\n" ) ; printf ( "it under the terms of the GNU General Public License version 2 as\n" ) ; printf ( "published by the Free Software Foundation.\n\n" ) ; printf ( "This program is distributed in the hope that it will be useful,\n" ) ; printf ( "but WITHOUT ANY WARRANTY; without even the implied warranty of\n" ) ; printf ( "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n" ) ; printf ( "GNU General Public License for more details.\n\n" ) ; printf ( "You should have received a copy of the GNU General Public License\n" ) ; printf ( "along with this program; if not, write to the Free Software\n" ) ; printf ( "Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.\n\n" ) ; exit ( OK ) ; } if ( error == TRUE || display_help == TRUE ) { printf ( "Usage: %s [options]\n" , argv [ 0 ] ) ; printf ( "\n" ) ; printf ( "Startup:\n" ) ; printf ( " -V, --version      display program version information and exit.\n" ) ; printf ( " -L, --license      display license information and exit.\n" ) ; printf ( " -h, --help         display usage information and exit.\n" ) ; printf ( "\n" ) ; printf ( "Input file:\n" ) ; printf ( " -c, --config=FILE  specifies location of main Nagios config file.\n" ) ; printf ( " -s, --statsfile=FILE  specifies alternate location of file to read Nagios\n" ) ; printf ( "                       performance data from.\n" ) ; printf ( "\n" ) ; printf ( "Output:\n" ) ; printf ( " -m, --mrtg         display output in MRTG compatible format.\n" ) ; printf ( " -d, --data=VARS    comma-separated list of variables to output in MRTG\n" ) ; printf ( "                    (or compatible) format.  See possible values below.\n" ) ; printf ( "                    Percentages are rounded, times are in milliseconds.\n" ) ; printf ( " -D, --delimiter=C  character to use as delimiter in MRTG output mode.\n" ) ; printf ( "                    Defaults to a newline.\n" ) ; printf ( "\n" ) ; printf ( "MRTG DATA VARIABLES (-d option):\n" ) ; printf ( " PROGRUNTIME          string with time Nagios process has been running.\n" ) ; printf ( " PROGRUNTIMETT        time Nagios process has been running (time_t format).\n" ) ; printf ( " STATUSFILEAGE        string with age of status data file.\n" ) ; printf ( " STATUSFILEAGETT      string with age of status data file (time_t format).\n" ) ; printf ( " NAGIOSVERSION        string with Nagios version.\n" ) ; printf ( " NAGIOSPID            pid number of Nagios daemon.\n" ) ; printf ( " NAGIOSVERPID         string with Nagios version and PID.\n" ) ; printf ( " TOTCMDBUF            total number of external command buffer slots available.\n" ) ; printf ( " USEDCMDBUF           number of external command buffer slots currently in use.\n" ) ; printf ( " HIGHCMDBUF           highest number of external command buffer slots ever in use.\n" ) ; printf ( " NUMSERVICES          total number of services.\n" ) ; printf ( " NUMHOSTS             total number of hosts.\n" ) ; printf ( " NUMSVCOK             number of services OK.\n" ) ; printf ( " NUMSVCWARN           number of services WARNING.\n" ) ; printf ( " NUMSVCUNKN           number of services UNKNOWN.\n" ) ; printf ( " NUMSVCCRIT           number of services CRITICAL.\n" ) ; printf ( " NUMSVCPROB           number of service problems (WARNING, UNKNOWN or CRITICAL).\n" ) ; printf ( " NUMSVCCHECKED        number of services that have been checked since start.\n" ) ; printf ( " NUMSVCSCHEDULED      number of services that are currently scheduled to be checked.\n" ) ; printf ( " NUMSVCFLAPPING       number of services that are currently flapping.\n" ) ; printf ( " NUMSVCDOWNTIME       number of services that are currently in downtime.\n" ) ; printf ( " NUMHSTUP             number of hosts UP.\n" ) ; printf ( " NUMHSTDOWN           number of hosts DOWN.\n" ) ; printf ( " NUMHSTUNR            number of hosts UNREACHABLE.\n" ) ; printf ( " NUMHSTPROB           number of host problems (DOWN or UNREACHABLE).\n" ) ; printf ( " NUMHSTCHECKED        number of hosts that have been checked since start.\n" ) ; printf ( " NUMHSTSCHEDULED      number of hosts that are currently scheduled to be checked.\n" ) ; printf ( " NUMHSTFLAPPING       number of hosts that are currently flapping.\n" ) ; printf ( " NUMHSTDOWNTIME       number of hosts that are currently in downtime.\n" ) ; printf ( " NUMHSTACTCHKxM       number of hosts actively checked in last 1/5/15/60 minutes.\n" ) ; printf ( " NUMHSTPSVCHKxM       number of hosts passively checked in last 1/5/15/60 minutes.\n" ) ; printf ( " NUMSVCACTCHKxM       number of services actively checked in last 1/5/15/60 minutes.\n" ) ; printf ( " NUMSVCPSVCHKxM       number of services passively checked in last 1/5/15/60 minutes.\n" ) ; printf ( " xxxACTSVCLAT         MIN/MAX/AVG active service check latency (ms).\n" ) ; printf ( " xxxACTSVCEXT         MIN/MAX/AVG active service check execution time (ms).\n" ) ; printf ( " xxxACTSVCPSC         MIN/MAX/AVG active service check %% state change.\n" ) ; printf ( " xxxPSVSVCLAT         MIN/MAX/AVG passive service check latency (ms).\n" ) ; printf ( " xxxPSVSVCPSC         MIN/MAX/AVG passive service check %% state change.\n" ) ; printf ( " xxxSVCPSC            MIN/MAX/AVG service check %% state change.\n" ) ; printf ( " xxxACTHSTLAT         MIN/MAX/AVG active host check latency (ms).\n" ) ; printf ( " xxxACTHSTEXT         MIN/MAX/AVG active host check execution time (ms).\n" ) ; printf ( " xxxACTHSTPSC         MIN/MAX/AVG active host check %% state change.\n" ) ; printf ( " xxxPSVHSTLAT         MIN/MAX/AVG passive host check latency (ms).\n" ) ; printf ( " xxxPSVHSTPSC         MIN/MAX/AVG passive host check %% state change.\n" ) ; printf ( " xxxHSTPSC            MIN/MAX/AVG host check %% state change.\n" ) ; printf ( " NUMACTHSTCHECKSxM    number of total active host checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMOACTHSTCHECKSxM   number of on-demand active host checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMCACHEDHSTCHECKSxM number of cached host checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMSACTHSTCHECKSxM   number of scheduled active host checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMPARHSTCHECKSxM    number of parallel host checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMSERHSTCHECKSxM    number of serial host checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMPSVHSTCHECKSxM    number of passive host checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMACTSVCCHECKSxM    number of total active service checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMOACTSVCCHECKSxM   number of on-demand active service checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMCACHEDSVCCHECKSxM number of cached service checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMSACTSVCCHECKSxM   number of scheduled active service checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMPSVSVCCHECKSxM    number of passive service checks occurring in last 1/5/15 minutes.\n" ) ; printf ( " NUMEXTCMDSxM         number of external commands processed in last 1/5/15 minutes.\n" ) ; printf ( "\n" ) ; printf ( " Note: Replace x's in MRTG variable names with 'MIN', 'MAX', 'AVG', or the\n" ) ; printf ( "       the appropriate number (i.e. '1', '5', '15', or '60').\n" ) ; printf ( "\n" ) ; exit ( ERROR ) ; } if ( status_file == NULL ) { result = read_config_file ( ) ; if ( result == ERROR && mrtg_mode == FALSE ) { printf ( "Error processing config file '%s'\n" , main_config_file ) ; return ERROR ; } } result = read_status_file ( ) ; if ( result == ERROR && mrtg_mode == FALSE ) { printf ( "Error reading status file '%s': %s\n" , status_file , strerror ( errno ) ) ; return ERROR ; } if ( mrtg_mode == FALSE ) { display_stats ( ) ; } else { display_mrtg_values ( ) ; } if ( result == ERROR ) { return ERROR ; } else { return OK ; } } static int display_mrtg_values ( void ) { char * temp_ptr ; time_t current_time ; unsigned long time_difference ; int days ; int hours ; int minutes ; int seconds ; time ( & current_time ) ; if ( mrtg_variables == NULL || mrtg_delimiter == NULL ) { return OK ; } for ( temp_ptr = strtok ( mrtg_variables , "," ) ; temp_ptr != NULL ; temp_ptr = strtok ( NULL , "," ) ) { if ( ! strcmp ( temp_ptr , "PROGRUNTIME" ) ) { time_difference = ( current_time - program_start ) ; get_time_breakdown ( time_difference , & days , & hours , & minutes , & seconds ) ; printf ( "%dd %dh %dm %ds%s" , days , hours , minutes , seconds , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "PROGRUNTIMETT" ) ) { time_difference = ( current_time - program_start ) ; printf ( "%lu%s" , time_difference , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "STATUSFILEAGE" ) ) { time_difference = ( current_time - status_creation_date ) ; get_time_breakdown ( time_difference , & days , & hours , & minutes , & seconds ) ; printf ( "%dd %dh %dm %ds%s" , days , hours , minutes , seconds , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "STATUSFILEAGETT" ) ) { time_difference = ( current_time - status_creation_date ) ; printf ( "%lu%s" , time_difference , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NAGIOSVERSION" ) ) { printf ( "%s%s" , status_version , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NAGIOSPID" ) ) { printf ( "%d%s" , nagios_pid , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NAGIOSVERPID" ) ) { printf ( "Nagios %s (pid=%d)%s" , status_version , nagios_pid , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSERVICES" ) ) { printf ( "%d%s" , status_service_entries , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHOSTS" ) ) { printf ( "%d%s" , status_host_entries , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINACTSVCLAT" ) ) { printf ( "%d%s" , ( int ) ( min_active_service_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXACTSVCLAT" ) ) { printf ( "%d%s" , ( int ) ( max_active_service_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGACTSVCLAT" ) ) { printf ( "%d%s" , ( int ) ( average_active_service_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINACTSVCEXT" ) ) { printf ( "%d%s" , ( int ) ( min_active_service_execution_time * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXACTSVCEXT" ) ) { printf ( "%d%s" , ( int ) ( max_active_service_execution_time * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGACTSVCEXT" ) ) { printf ( "%d%s" , ( int ) ( average_active_service_execution_time * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINACTSVCPSC" ) ) { printf ( "%d%s" , ( int ) min_active_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXACTSVCPSC" ) ) { printf ( "%d%s" , ( int ) max_active_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGACTSVCPSC" ) ) { printf ( "%d%s" , ( int ) average_active_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINPSVSVCLAT" ) ) { printf ( "%d%s" , ( int ) ( min_passive_service_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXPSVSVCLAT" ) ) { printf ( "%d%s" , ( int ) ( max_passive_service_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGPSVSVCLAT" ) ) { printf ( "%d%s" , ( int ) ( average_passive_service_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINPSVSVCPSC" ) ) { printf ( "%d%s" , ( int ) min_passive_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXPSVSVCPSC" ) ) { printf ( "%d%s" , ( int ) max_passive_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGPSVSVCPSC" ) ) { printf ( "%d%s" , ( int ) average_passive_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINSVCPSC" ) ) { printf ( "%d%s" , ( int ) min_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXSVCPSC" ) ) { printf ( "%d%s" , ( int ) max_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGSVCPSC" ) ) { printf ( "%d%s" , ( int ) average_service_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINACTHSTLAT" ) ) { printf ( "%d%s" , ( int ) ( min_active_host_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXACTHSTLAT" ) ) { printf ( "%d%s" , ( int ) ( max_active_host_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGACTHSTLAT" ) ) { printf ( "%d%s" , ( int ) ( average_active_host_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINACTHSTEXT" ) ) { printf ( "%d%s" , ( int ) ( min_active_host_execution_time * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXACTHSTEXT" ) ) { printf ( "%d%s" , ( int ) ( max_active_host_execution_time * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGACTHSTEXT" ) ) { printf ( "%d%s" , ( int ) ( average_active_host_execution_time * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINACTHSTPSC" ) ) { printf ( "%d%s" , ( int ) min_active_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXACTHSTPSC" ) ) { printf ( "%d%s" , ( int ) max_active_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGACTHSTPSC" ) ) { printf ( "%d%s" , ( int ) average_active_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINPSVHSTLAT" ) ) { printf ( "%d%s" , ( int ) ( min_passive_host_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXPSVHSTLAT" ) ) { printf ( "%d%s" , ( int ) ( max_passive_host_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGPSVHSTLAT" ) ) { printf ( "%d%s" , ( int ) ( average_passive_host_latency * 1000 ) , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINPSVHSTPSC" ) ) { printf ( "%d%s" , ( int ) min_passive_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXPSVHSTPSC" ) ) { printf ( "%d%s" , ( int ) max_passive_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGPSVHSTPSC" ) ) { printf ( "%d%s" , ( int ) average_passive_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MINHSTPSC" ) ) { printf ( "%d%s" , ( int ) min_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "MAXHSTPSC" ) ) { printf ( "%d%s" , ( int ) max_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "AVGHSTPSC" ) ) { printf ( "%d%s" , ( int ) average_host_state_change , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTACTCHK1M" ) ) { printf ( "%d%s" , active_hosts_checked_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTACTCHK5M" ) ) { printf ( "%d%s" , active_hosts_checked_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTACTCHK15M" ) ) { printf ( "%d%s" , active_hosts_checked_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTACTCHK60M" ) ) { printf ( "%d%s" , active_hosts_checked_last_1hour , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTPSVCHK1M" ) ) { printf ( "%d%s" , passive_hosts_checked_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTPSVCHK5M" ) ) { printf ( "%d%s" , passive_hosts_checked_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTPSVCHK15M" ) ) { printf ( "%d%s" , passive_hosts_checked_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTPSVCHK60M" ) ) { printf ( "%d%s" , passive_hosts_checked_last_1hour , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCACTCHK1M" ) ) { printf ( "%d%s" , active_services_checked_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCACTCHK5M" ) ) { printf ( "%d%s" , active_services_checked_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCACTCHK15M" ) ) { printf ( "%d%s" , active_services_checked_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCACTCHK60M" ) ) { printf ( "%d%s" , active_services_checked_last_1hour , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCPSVCHK1M" ) ) { printf ( "%d%s" , passive_services_checked_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCPSVCHK5M" ) ) { printf ( "%d%s" , passive_services_checked_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCPSVCHK15M" ) ) { printf ( "%d%s" , passive_services_checked_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCPSVCHK60M" ) ) { printf ( "%d%s" , passive_services_checked_last_1hour , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMACTHSTCHECKS1M" ) ) { printf ( "%d%s" , active_host_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMACTHSTCHECKS5M" ) ) { printf ( "%d%s" , active_host_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMACTHSTCHECKS15M" ) ) { printf ( "%d%s" , active_host_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMOACTHSTCHECKS1M" ) ) { printf ( "%d%s" , active_ondemand_host_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMOACTHSTCHECKS5M" ) ) { printf ( "%d%s" , active_ondemand_host_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMOACTHSTCHECKS15M" ) ) { printf ( "%d%s" , active_ondemand_host_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSACTHSTCHECKS1M" ) ) { printf ( "%d%s" , active_scheduled_host_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSACTHSTCHECKS5M" ) ) { printf ( "%d%s" , active_scheduled_host_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSACTHSTCHECKS15M" ) ) { printf ( "%d%s" , active_scheduled_host_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPARHSTCHECKS1M" ) ) { printf ( "%d%s" , parallel_host_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPARHSTCHECKS5M" ) ) { printf ( "%d%s" , parallel_host_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPARHSTCHECKS15M" ) ) { printf ( "%d%s" , parallel_host_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSERHSTCHECKS1M" ) ) { printf ( "%d%s" , serial_host_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSERHSTCHECKS5M" ) ) { printf ( "%d%s" , serial_host_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSERHSTCHECKS15M" ) ) { printf ( "%d%s" , serial_host_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPSVHSTCHECKS1M" ) ) { printf ( "%d%s" , passive_host_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPSVHSTCHECKS5M" ) ) { printf ( "%d%s" , passive_host_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPSVHSTCHECKS15M" ) ) { printf ( "%d%s" , passive_host_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMCACHEDHSTCHECKS1M" ) ) { printf ( "%d%s" , active_cached_host_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMCACHEDHSTCHECKS5M" ) ) { printf ( "%d%s" , active_cached_host_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMCACHEDHSTCHECKS15M" ) ) { printf ( "%d%s" , active_cached_host_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMACTSVCCHECKS1M" ) ) { printf ( "%d%s" , active_service_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMACTSVCCHECKS5M" ) ) { printf ( "%d%s" , active_service_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMACTSVCCHECKS15M" ) ) { printf ( "%d%s" , active_service_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMOACTSVCCHECKS1M" ) ) { printf ( "%d%s" , active_ondemand_service_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMOACTSVCCHECKS5M" ) ) { printf ( "%d%s" , active_ondemand_service_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMOACTSVCCHECKS15M" ) ) { printf ( "%d%s" , active_ondemand_service_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSACTSVCCHECKS1M" ) ) { printf ( "%d%s" , active_scheduled_service_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSACTSVCCHECKS5M" ) ) { printf ( "%d%s" , active_scheduled_service_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSACTSVCCHECKS15M" ) ) { printf ( "%d%s" , active_scheduled_service_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPSVSVCCHECKS1M" ) ) { printf ( "%d%s" , passive_service_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPSVSVCCHECKS5M" ) ) { printf ( "%d%s" , passive_service_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMPSVSVCCHECKS15M" ) ) { printf ( "%d%s" , passive_service_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMCACHEDSVCCHECKS1M" ) ) { printf ( "%d%s" , active_cached_service_checks_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMCACHEDSVCCHECKS5M" ) ) { printf ( "%d%s" , active_cached_service_checks_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMCACHEDSVCCHECKS15M" ) ) { printf ( "%d%s" , active_cached_service_checks_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMEXTCMDS1M" ) ) { printf ( "%d%s" , external_commands_last_1min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMEXTCMDS5M" ) ) { printf ( "%d%s" , external_commands_last_5min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMEXTCMDS15M" ) ) { printf ( "%d%s" , external_commands_last_15min , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCOK" ) ) { printf ( "%d%s" , services_ok , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCWARN" ) ) { printf ( "%d%s" , services_warning , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCUNKN" ) ) { printf ( "%d%s" , services_unknown , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCCRIT" ) ) { printf ( "%d%s" , services_critical , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCPROB" ) ) { printf ( "%d%s" , services_warning + services_unknown + services_critical , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCCHECKED" ) ) { printf ( "%d%s" , services_checked , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCSCHEDULED" ) ) { printf ( "%d%s" , services_scheduled , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCFLAPPING" ) ) { printf ( "%d%s" , services_flapping , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMSVCDOWNTIME" ) ) { printf ( "%d%s" , services_in_downtime , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTUP" ) ) { printf ( "%d%s" , hosts_up , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTDOWN" ) ) { printf ( "%d%s" , hosts_down , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTUNR" ) ) { printf ( "%d%s" , hosts_unreachable , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTPROB" ) ) { printf ( "%d%s" , hosts_down + hosts_unreachable , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTCHECKED" ) ) { printf ( "%d%s" , hosts_checked , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTSCHEDULED" ) ) { printf ( "%d%s" , hosts_scheduled , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTFLAPPING" ) ) { printf ( "%d%s" , hosts_flapping , mrtg_delimiter ) ; } if ( ! strcmp ( temp_ptr , "NUMHSTDOWNTIME" ) ) { printf ( "%d%s" , hosts_in_downtime , mrtg_delimiter ) ; } else { printf ( "%s%s" , temp_ptr , mrtg_delimiter ) ; } } if ( strcmp ( mrtg_delimiter , "\n" ) ) { printf ( "\n" ) ; } return OK ; } static int display_stats ( void ) { time_t current_time ; unsigned long time_difference ; int days ; int hours ; int minutes ; int seconds ; time ( & current_time ) ; printf ( "CURRENT STATUS DATA\n" ) ; printf ( "------------------------------------------------------\n" ) ; printf ( "Status File:                            %s\n" , status_file ) ; time_difference = ( current_time - status_creation_date ) ; get_time_breakdown ( time_difference , & days , & hours , & minutes , & seconds ) ; printf ( "Status File Age:                        %dd %dh %dm %ds\n" , days , hours , minutes , seconds ) ; printf ( "Status File Version:                    %s\n" , status_version ) ; printf ( "\n" ) ; time_difference = ( current_time - program_start ) ; get_time_breakdown ( time_difference , & days , & hours , & minutes , & seconds ) ; printf ( "Program Running Time:                   %dd %dh %dm %ds\n" , days , hours , minutes , seconds ) ; printf ( "Nagios PID:                             %d\n" , nagios_pid ) ; printf ( "\n" ) ; printf ( "Total Services:                         %d\n" , status_service_entries ) ; printf ( "Services Checked:                       %d\n" , services_checked ) ; printf ( "Services Scheduled:                     %d\n" , services_scheduled ) ; printf ( "Services Actively Checked:              %d\n" , active_service_checks ) ; printf ( "Services Passively Checked:             %d\n" , passive_service_checks ) ; printf ( "Total Service State Change:             %.3f / %.3f / %.3f %%\n" , min_service_state_change , max_service_state_change , average_service_state_change ) ; printf ( "Active Service Latency:                 %.3f / %.3f / %.3f sec\n" , min_active_service_latency , max_active_service_latency , average_active_service_latency ) ; printf ( "Active Service Execution Time:          %.3f / %.3f / %.3f sec\n" , min_active_service_execution_time , max_active_service_execution_time , average_active_service_execution_time ) ; printf ( "Active Service State Change:            %.3f / %.3f / %.3f %%\n" , min_active_service_state_change , max_active_service_state_change , average_active_service_state_change ) ; printf ( "Active Services Last 1/5/15/60 min:     %d / %d / %d / %d\n" , active_services_checked_last_1min , active_services_checked_last_5min , active_services_checked_last_15min , active_services_checked_last_1hour ) ; printf ( "Passive Service Latency:                %.3f / %.3f / %.3f sec\n" , min_passive_service_latency , max_passive_service_latency , average_passive_service_latency ) ; printf ( "Passive Service State Change:           %.3f / %.3f / %.3f %%\n" , min_passive_service_state_change , max_passive_service_state_change , average_passive_service_state_change ) ; printf ( "Passive Services Last 1/5/15/60 min:    %d / %d / %d / %d\n" , passive_services_checked_last_1min , passive_services_checked_last_5min , passive_services_checked_last_15min , passive_services_checked_last_1hour ) ; printf ( "Services Ok/Warn/Unk/Crit:              %d / %d / %d / %d\n" , services_ok , services_warning , services_unknown , services_critical ) ; printf ( "Services Flapping:                      %d\n" , services_flapping ) ; printf ( "Services In Downtime:                   %d\n" , services_in_downtime ) ; printf ( "\n" ) ; printf ( "Total Hosts:                            %d\n" , status_host_entries ) ; printf ( "Hosts Checked:                          %d\n" , hosts_checked ) ; printf ( "Hosts Scheduled:                        %d\n" , hosts_scheduled ) ; printf ( "Hosts Actively Checked:                 %d\n" , active_host_checks ) ; printf ( "Host Passively Checked:                 %d\n" , passive_host_checks ) ; printf ( "Total Host State Change:                %.3f / %.3f / %.3f %%\n" , min_host_state_change , max_host_state_change , average_host_state_change ) ; printf ( "Active Host Latency:                    %.3f / %.3f / %.3f sec\n" , min_active_host_latency , max_active_host_latency , average_active_host_latency ) ; printf ( "Active Host Execution Time:             %.3f / %.3f / %.3f sec\n" , min_active_host_execution_time , max_active_host_execution_time , average_active_host_execution_time ) ; printf ( "Active Host State Change:               %.3f / %.3f / %.3f %%\n" , min_active_host_state_change , max_active_host_state_change , average_active_host_state_change ) ; printf ( "Active Hosts Last 1/5/15/60 min:        %d / %d / %d / %d\n" , active_hosts_checked_last_1min , active_hosts_checked_last_5min , active_hosts_checked_last_15min , active_hosts_checked_last_1hour ) ; printf ( "Passive Host Latency:                   %.3f / %.3f / %.3f sec\n" , min_passive_host_latency , max_passive_host_latency , average_passive_host_latency ) ; printf ( "Passive Host State Change:              %.3f / %.3f / %.3f %%\n" , min_passive_host_state_change , max_passive_host_state_change , average_passive_host_state_change ) ; printf ( "Passive Hosts Last 1/5/15/60 min:       %d / %d / %d / %d\n" , passive_hosts_checked_last_1min , passive_hosts_checked_last_5min , passive_hosts_checked_last_15min , passive_hosts_checked_last_1hour ) ; printf ( "Hosts Up/Down/Unreach:                  %d / %d / %d\n" , hosts_up , hosts_down , hosts_unreachable ) ; printf ( "Hosts Flapping:                         %d\n" , hosts_flapping ) ; printf ( "Hosts In Downtime:                      %d\n" , hosts_in_downtime ) ; printf ( "\n" ) ; printf ( "Active Host Checks Last 1/5/15 min:     %d / %d / %d\n" , active_host_checks_last_1min , active_host_checks_last_5min , active_host_checks_last_15min ) ; printf ( "   Scheduled:                           %d / %d / %d\n" , active_scheduled_host_checks_last_1min , active_scheduled_host_checks_last_5min , active_scheduled_host_checks_last_15min ) ; printf ( "   On-demand:                           %d / %d / %d\n" , active_ondemand_host_checks_last_1min , active_ondemand_host_checks_last_5min , active_ondemand_host_checks_last_15min ) ; printf ( "   Parallel:                            %d / %d / %d\n" , parallel_host_checks_last_1min , parallel_host_checks_last_5min , parallel_host_checks_last_15min ) ; printf ( "   Serial:                              %d / %d / %d\n" , serial_host_checks_last_1min , serial_host_checks_last_5min , serial_host_checks_last_15min ) ; printf ( "   Cached:                              %d / %d / %d\n" , active_cached_host_checks_last_1min , active_cached_host_checks_last_5min , active_cached_host_checks_last_15min ) ; printf ( "Passive Host Checks Last 1/5/15 min:    %d / %d / %d\n" , passive_host_checks_last_1min , passive_host_checks_last_5min , passive_host_checks_last_15min ) ; printf ( "Active Service Checks Last 1/5/15 min:  %d / %d / %d\n" , active_service_checks_last_1min , active_service_checks_last_5min , active_service_checks_last_15min ) ; printf ( "   Scheduled:                           %d / %d / %d\n" , active_scheduled_service_checks_last_1min , active_scheduled_service_checks_last_5min , active_scheduled_service_checks_last_15min ) ; printf ( "   On-demand:                           %d / %d / %d\n" , active_ondemand_service_checks_last_1min , active_ondemand_service_checks_last_5min , active_ondemand_service_checks_last_15min ) ; printf ( "   Cached:                              %d / %d / %d\n" , active_cached_service_checks_last_1min , active_cached_service_checks_last_5min , active_cached_service_checks_last_15min ) ; printf ( "Passive Service Checks Last 1/5/15 min: %d / %d / %d\n" , passive_service_checks_last_1min , passive_service_checks_last_5min , passive_service_checks_last_15min ) ; printf ( "\n" ) ; printf ( "External Commands Last 1/5/15 min:      %d / %d / %d\n" , external_commands_last_1min , external_commands_last_5min , external_commands_last_15min ) ; printf ( "\n" ) ; printf ( "\n" ) ; return OK ; } static int read_config_file ( void ) { char temp_buffer [ MAX_INPUT_BUFFER ] ; FILE * fp ; char * var ; char * val ; char * main_cfg_dir = NULL ; char * slash = NULL ; main_cfg_dir = nspath_absolute ( main_config_file , NULL ) ; if ( ( slash = strrchr ( main_cfg_dir , '/' ) ) ) { * slash = 0 ; } fp = fopen ( main_config_file , "r" ) ; if ( fp == NULL ) { return ERROR ; } while ( fgets ( temp_buffer , sizeof ( temp_buffer ) - 1 , fp ) ) { strip ( temp_buffer ) ; if ( temp_buffer [ 0 ] == '#' || temp_buffer [ 0 ] == '\x0' ) { continue ; } var = strtok ( temp_buffer , "=" ) ; val = strtok ( NULL , "\n" ) ; if ( val == NULL ) { continue ; } if ( ! strcmp ( var , "status_file" ) || ! strcmp ( var , "status_log" ) || ! strcmp ( var , "xsddefault_status_log" ) ) { if ( status_file ) { free ( status_file ) ; } status_file = nspath_absolute ( val , main_cfg_dir ) ; } } fclose ( fp ) ; return OK ; } static int read_status_file ( void ) { char temp_buffer [ MAX_INPUT_BUFFER ] ; FILE * fp = NULL ; int data_type = STATUS_NO_DATA ; char * var = NULL ; char * val = NULL ; char * temp_ptr = NULL ; time_t current_time ; unsigned long time_difference = 0L ; double execution_time = 0.0 ; double latency = 0.0 ; int check_type = CHECK_TYPE_ACTIVE ; int current_state = STATE_OK ; double state_change = 0.0 ; int is_flapping = FALSE ; int downtime_depth = 0 ; time_t last_check = 0L ; int should_be_scheduled = TRUE ; int has_been_checked = TRUE ; time ( & current_time ) ; fp = fopen ( status_file , "r" ) ; if ( fp == NULL ) { return ERROR ; } while ( fgets ( temp_buffer , sizeof ( temp_buffer ) - 1 , fp ) ) { if ( temp_buffer [ 0 ] == '#' || temp_buffer [ 0 ] == '\x0' ) { continue ; } strip ( temp_buffer ) ; if ( ! strcmp ( temp_buffer , "servicestatus {" ) ) { data_type = STATUS_SERVICE_DATA ; status_service_entries ++ ; } if ( ! strcmp ( temp_buffer , "hoststatus {" ) ) { data_type = STATUS_HOST_DATA ; status_host_entries ++ ; } if ( ! strcmp ( temp_buffer , "info {" ) ) { data_type = STATUS_INFO_DATA ; } if ( ! strcmp ( temp_buffer , "programstatus {" ) ) { data_type = STATUS_PROGRAM_DATA ; } if ( ! strcmp ( temp_buffer , "}" ) ) { switch ( data_type ) { case STATUS_INFO_DATA : break ; case STATUS_PROGRAM_DATA : active_host_checks_last_1min = active_scheduled_host_checks_last_1min + active_ondemand_host_checks_last_1min ; active_host_checks_last_5min = active_scheduled_host_checks_last_5min + active_ondemand_host_checks_last_5min ; active_host_checks_last_15min = active_scheduled_host_checks_last_15min + active_ondemand_host_checks_last_15min ; } } } } 