static void rtl_process_ui_rssi ( struct ieee80211_hw * hw , struct rtl_stats * pstatus ) { struct rtl_priv * rtlpriv = rtl_priv ( hw ) ; struct rtl_phy * rtlphy = & ( rtlpriv -> phy ) ; u8 rfpath ; u32 last_rssi , tmpval ; if ( ! pstatus -> packet_toself && ! pstatus -> packet_beacon ) { return ; } rtlpriv -> stats . pwdb_all_cnt += pstatus -> rx_pwdb_all ; rtlpriv -> stats . rssi_calculate_cnt ++ ; if ( rtlpriv -> stats . ui_rssi . total_num ++ >= PHY_RSSI_SLID_WIN_MAX ) { rtlpriv -> stats . ui_rssi . total_num = PHY_RSSI_SLID_WIN_MAX ; last_rssi = rtlpriv -> stats . ui_rssi . elements [ rtlpriv -> stats . ui_rssi . index ] ; rtlpriv -> stats . ui_rssi . total_val -= last_rssi ; } rtlpriv -> stats . ui_rssi . total_val += pstatus -> signalstrength ; rtlpriv -> stats . ui_rssi . elements [ rtlpriv -> stats . ui_rssi . index ++ ] = pstatus -> signalstrength ; if ( rtlpriv -> stats . ui_rssi . index >= PHY_RSSI_SLID_WIN_MAX ) { rtlpriv -> stats . ui_rssi . index = 0 ; } tmpval = rtlpriv -> stats . ui_rssi . total_val / rtlpriv -> stats . ui_rssi . total_num ; rtlpriv -> stats . signal_strength = rtl_translate_todbm ( hw , ( u8 ) tmpval ) ; pstatus -> rssi = rtlpriv -> stats . signal_strength ; if ( pstatus -> is_cck ) { return ; } for ( rfpath = RF90_PATH_A ; rfpath < rtlphy -> num_total_rfpath ; rfpath ++ ) { if ( pstatus -> rx_mimo_signalstrength [ rfpath ] > rtlpriv -> stats . rx_rssi_percentage [ rfpath ] ) { rtlpriv -> stats . rx_rssi_percentage [ rfpath ] = ( ( rtlpriv -> stats . rx_rssi_percentage [ rfpath ] * ( RX_SMOOTH_FACTOR - 1 ) ) + ( pstatus -> rx_mimo_signalstrength [ rfpath ] ) ) / ( RX_SMOOTH_FACTOR ) ; rtlpriv -> stats . rx_rssi_percentage [ rfpath ] = rtlpriv -> stats . rx_rssi_percentage [ rfpath ] + 1 ; } else { rtlpriv -> stats . rx_rssi_percentage [ rfpath ] = ( ( rtlpriv -> stats . rx_rssi_percentage [ rfpath ] * ( RX_SMOOTH_FACTOR - 1 ) ) + ( pstatus -> rx_mimo_signalstrength [ rfpath ] ) ) / ( RX_SMOOTH_FACTOR ) ; } rtlpriv -> stats . rx_snr_db [ rfpath ] = pstatus -> rx_snr [ rfpath ] ; rtlpriv -> stats . rx_evm_dbm [ rfpath ] = pstatus -> rx_mimo_evm_dbm [ rfpath ] ; rtlpriv -> stats . rx_cfo_short [ rfpath ] = pstatus -> cfo_short [ rfpath ] ; rtlpriv -> stats . rx_cfo_tail [ rfpath ] = pstatus -> cfo_tail [ rfpath ] ; } } 