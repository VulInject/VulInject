h2o_iovec_t h2o_file_read ( const char * fn ) { int fd ; struct stat st ; h2o_iovec_t ret = { NULL } ; if ( ( fd = open ( fn , O_RDONLY | O_CLOEXEC ) ) == - 1 ) { Error } if ( fstat ( fd , & st ) ) { Error } if ( st . st_size > SIZE_MAX ) { Error } if ( ( ret . base = malloc ( ( size_t ) st . st_size ) ) == NULL ) { Error } while ( ret . len != ( size_t ) st . st_size ) { ssize_t r ; while ( ( r = read ( fd , ret . base + ret . len , ( size_t ) st . st_size - ret . len ) ) == - 1 && errno == EINTR ) { } if ( r <= 0 ) { Error } ret . len += r ; } close ( fd ) ; return ret ; Error if ( fd != - 1 ) { close ( fd ) ; } free ( ret . base ) ; return ( h2o_iovec_t ) { NULL } ; } 