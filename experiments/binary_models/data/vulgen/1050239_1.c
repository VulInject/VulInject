static void start_vrrp ( data_t * prev_global_data ) { clear_summary_flags ( ) ; if ( ! global_data ) { global_data = alloc_global_data ( ) ; } vrrp_data = alloc_vrrp_data ( ) ; if ( ! vrrp_data ) { stop_vrrp ( KEEPALIVED_EXIT_FATAL ) ; return ; } init_data ( conf_file , vrrp_init_keywords , false ) ; if ( ( ! reload && global_data -> vrrp_process_name ) || ( reload && ( ! global_data -> vrrp_process_name != ! prev_global_data -> vrrp_process_name || ( global_data -> vrrp_process_name && strcmp ( global_data -> vrrp_process_name , prev_global_data -> vrrp_process_name ) ) ) ) ) { set_process_name ( global_data -> vrrp_process_name ) ; } if ( non_existent_interface_specified ) { report_config_error ( CONFIG_BAD_IF , "Non-existent interface specified in configuration" ) ; stop_vrrp ( KEEPALIVED_EXIT_CONFIG ) ; return ; } if ( reload ) { init_global_data ( global_data , prev_global_data , true ) ; } set_time_now ( ) ; if ( ! __test_bit ( CONFIG_TEST_BIT , & debug ) ) { if ( global_data -> enable_snmp_vrrp || global_data -> enable_snmp_rfcv2 || global_data -> enable_snmp_rfcv3 || false ) { if ( snmp_running ) { snmp_epoll_info ( master ) ; } else { vrrp_snmp_agent_init ( global_data -> snmp_socket ) ; } snmp_vrrp_start_time = time_now ; } else { if ( snmp_running ) { vrrp_snmp_agent_close ( old_global_data ) ; } } if ( vrrp_ipvs_needed ( ) ) { if ( ipvs_start ( ) != IPVS_SUCCESS ) { stop_vrrp ( KEEPALIVED_EXIT_FATAL ) ; return ; } } if ( reload ) { kernel_netlink_set_recv_bufs ( ) ; clear_diff_static_rules ( ) ; clear_diff_static_routes ( ) ; clear_diff_static_addresses ( ) ; clear_diff_script ( ) ; clear_diff_bfd ( ) ; } else { netlink_iplist ( & vrrp_data -> static_addresses , IPADDRESS_DEL , false ) ; netlink_rtlist ( & vrrp_data -> static_routes , IPROUTE_DEL , false ) ; netlink_error_ignore = ENOENT ; netlink_rulelist ( & vrrp_data -> static_rules , IPRULE_DEL , true ) ; netlink_error_ignore = 0 ; } } if ( ! __test_bit ( CONFIG_TEST_BIT , & debug ) ) { thread_add_event ( master , vrrp_dispatcher_init , NULL , 0 ) ; if ( ! reload && global_data -> vrrp_startup_delay ) { vrrp_delayed_start_time = timer_add_long ( time_now , global_data -> vrrp_startup_delay ) ; thread_add_timer ( master , delayed_start_clear_thread , NULL , global_data -> vrrp_startup_delay ) ; log_message ( LOG_INFO , "Delaying startup for %g seconds" , global_data -> vrrp_startup_delay / TIMER_HZ_DOUBLE ) ; } if ( ! reload && global_data -> disable_local_igmp ) { set_disable_local_igmp ( ) ; } } if ( ! vrrp_complete_init ( ) || ( global_data -> reload_check_config && get_config_status ( ) != CONFIG_OK ) ) { stop_vrrp ( KEEPALIVED_EXIT_CONFIG ) ; return ; } if ( __test_bit ( CONFIG_TEST_BIT , & debug ) ) { return ; } if ( have_ipv4_instance ) { if ( ! gratuitous_arp_init ( ) ) { stop_vrrp ( KEEPALIVED_EXIT_MISSING_PERMISSION ) ; } } else { gratuitous_arp_close ( ) ; } if ( have_ipv6_instance ) { if ( ! ndisc_init ( ) ) { stop_vrrp ( KEEPALIVED_EXIT_MISSING_PERMISSION ) ; } } else { ndisc_close ( ) ; } if ( ! __test_bit ( CONFIG_TEST_BIT , & debug ) ) { notify_config_read ( ) ; } if ( ! reload ) { vrrp_restore_interfaces_startup ( ) ; } if ( reload ) { clear_diff_vrrp ( ) ; vrrp_dispatcher_release ( old_vrrp_data ) ; set_previous_sync_group_states ( ) ; } if ( global_data -> enable_dbus ) { if ( reload && old_global_data -> enable_dbus ) { dbus_reload ( & old_vrrp_data -> vrrp , & vrrp_data -> vrrp ) ; } else { if ( ! dbus_start ( ) ) { global_data -> enable_dbus = false ; } } } if ( reload && old_global_data -> enable_dbus ) { dbus_stop ( ) ; } netlink_iplist ( & vrrp_data -> static_addresses , IPADDRESS_ADD , false ) ; netlink_rtlist ( & vrrp_data -> static_routes , IPROUTE_ADD , false ) ; netlink_rulelist ( & vrrp_data -> static_rules , IPRULE_ADD , false ) ; if ( __test_bit ( DUMP_CONF_BIT , & debug ) ) { dump_data_vrrp ( NULL ) ; } set_process_priorities ( global_data -> vrrp_realtime_priority , global_data -> max_auto_priority , global_data -> min_auto_priority_delay , global_data -> vrrp_rlimit_rt , global_data -> vrrp_process_priority , global_data -> vrrp_no_swap ?4096 : 0 ) ; set_process_cpu_affinity ( & global_data -> vrrp_cpu_mask , "vrrp" ) ; set_vrrp_max_fds ( ) ; } 