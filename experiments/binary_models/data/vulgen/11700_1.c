xmlDocPtr infd_filesystem_storage_read_xml_file_impl ( InfdFilesystemStorage * storage , const gchar * path , const gchar * toplevel_tag , GError * * error ) { FILE * file ; gchar * uri ; xmlDocPtr doc ; xmlNodePtr root ; xmlErrorPtr xmlerror ; file = infd_filesystem_storage_open_impl ( storage , path , "r" , error ) ; if ( file == NULL ) { return NULL ; } uri = g_filename_to_uri ( path , NULL , error ) ; if ( uri == NULL ) { fclose ( file ) ; return NULL ; } doc = xmlReadIO ( infd_filesystem_storage_read_xml_stream_read_func , infd_filesystem_storage_read_xml_stream_close_func , file , uri , "UTF-8" , XML_PARSE_NOWARNING | XML_PARSE_NOERROR ) ; if ( doc == NULL ) { xmlerror = xmlGetLastError ( ) ; g_set_error ( error , g_quark_from_static_string ( "LIBXML2_PARSER_ERROR" ) , xmlerror -> code , _ ( "Error parsing XML in file \"%s\": [%d]: %s" ) , xmlerror -> file , xmlerror -> line , xmlerror -> message ) ; } if ( toplevel_tag != NULL ) { root = xmlDocGetRootElement ( doc ) ; if ( root == NULL || strcmp ( ( const char * ) root -> name , toplevel_tag ) != 0 ) { g_set_error ( error , infd_filesystem_storage_error_quark , INFD_FILESYSTEM_STORAGE_ERROR_INVALID_FORMAT , _ ( "Error processing file \"%s\": Toplevel tag is not \"%s\"" ) , doc -> name , toplevel_tag ) ; xmlFreeDoc ( doc ) ; doc = NULL ; } } return doc ; } 