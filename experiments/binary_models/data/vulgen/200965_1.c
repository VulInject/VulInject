static void w32_info_user ( RDebug * dbg , RDebugInfo * rdi ) { HANDLE h_tok = NULL ; DWORD tok_len = 0 ; PTOKEN_USER tok_usr = NULL ; LPTSTR usr = NULL , usr_dom = NULL ; DWORD usr_len = 512 ; DWORD usr_dom_len = 512 ; SID_NAME_USE snu = { 0 } ; HANDLE h_proc = OpenProcess ( PROCESS_QUERY_INFORMATION , FALSE , dbg -> pid ) ; if ( ! OpenProcessToken ( h_proc , TOKEN_QUERY , & h_tok ) ) { r_sys_perror ( "w32_info_user/OpenProcessToken" ) ; err_w32_info_user } if ( ! GetTokenInformation ( h_tok , TokenUser , ( LPVOID ) & tok_usr , 0 , & tok_len ) && GetLastError ( ) != ERROR_INSUFFICIENT_BUFFER ) { r_sys_perror ( "w32_info_user/GetTokenInformation" ) ; err_w32_info_user } tok_usr = ( PTOKEN_USER ) malloc ( tok_len ) ; if ( ! tok_usr ) { r_sys_perror ( "w32_info_user/malloc tok_usr" ) ; err_w32_info_user } if ( ! GetTokenInformation ( h_tok , TokenUser , ( LPVOID ) tok_usr , tok_len , & tok_len ) ) { r_sys_perror ( "w32_info_user/GetTokenInformation" ) ; err_w32_info_user } usr = ( LPTSTR ) malloc ( usr_len ) ; if ( ! usr ) { r_sys_perror ( "w32_info_user/malloc usr" ) ; err_w32_info_user } * usr = '\0' ; usr_dom = ( LPTSTR ) malloc ( usr_dom_len ) ; if ( ! usr_dom ) { r_sys_perror ( "w32_info_user/malloc usr_dom" ) ; err_w32_info_user } * usr_dom = '\0' ; if ( ! LookupAccountSid ( NULL , tok_usr -> User . Sid , usr , & usr_len , usr_dom , & usr_dom_len , & snu ) ) { r_sys_perror ( "w32_info_user/LookupAccountSid" ) ; err_w32_info_user } if ( * usr_dom ) { rdi -> usr = r_str_newf ( W32_TCHAR_FSTR "\\" W32_TCHAR_FSTR , usr_dom , usr ) ; } else { rdi -> usr = r_sys_conv_win_to_utf8 ( usr ) ; } err_w32_info_user if ( h_proc ) { CloseHandle ( h_proc ) ; } if ( h_tok ) { CloseHandle ( h_tok ) ; } free ( usr ) ; free ( usr_dom ) ; free ( tok_usr ) ; } 