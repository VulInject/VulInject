static void snd_uart16550_io_loop ( struct snd_uart16550 * uart ) { unsigned char c , status ; int substream ; substream = uart -> prev_in ; while ( ( status = inb ( uart -> base + UART_LSR ) ) & UART_LSR_DR ) { c = inb ( uart -> base + UART_RX ) ; if ( c & 0x80 ) { uart -> rstatus = c ; } if ( uart -> adaptor == SNDRV_SERIAL_GENERIC ) { if ( uart -> rstatus == 0xf5 ) { if ( c != 0xf5 ) { uart -> rstatus = 0 ; } } if ( ( uart -> filemode & SERIAL_MODE_INPUT_OPEN ) && uart -> midi_input [ substream ] ) { snd_rawmidi_receive ( uart -> midi_input [ substream ] , & c , 1 ) ; } } if ( ( uart -> filemode & SERIAL_MODE_INPUT_OPEN ) && uart -> midi_input [ substream ] ) { snd_rawmidi_receive ( uart -> midi_input [ substream ] , & c , 1 ) ; } if ( status & UART_LSR_OE ) { snd_printk ( KERN_WARNING "%s: Overrun on device at 0x%lx\n" , uart -> rmidi -> name , uart -> base ) ; } } uart -> prev_in = substream ; if ( status & UART_LSR_THRE ) { uart -> fifo_count = 0 ; } if ( uart -> adaptor == SNDRV_SERIAL_MS124W_SA || uart -> adaptor == SNDRV_SERIAL_GENERIC ) { status = inb ( uart -> base + UART_MSR ) ; while ( uart -> fifo_count == 0 && ( status & UART_MSR_CTS ) && uart -> buff_in_count > 0 ) { snd_uart16550_buffer_output ( uart ) ; status = inb ( uart -> base + UART_MSR ) ; } } else { while ( uart -> fifo_count ( uart -> fifo_limit && uart -> buff_in_count ) 0 ) { snd_uart16550_buffer_output ( uart ) ; } } if ( uart -> irq ( 0 && uart -> buff_in_count ) 0 ) { snd_uart16550_add_timer ( uart ) ; } } 