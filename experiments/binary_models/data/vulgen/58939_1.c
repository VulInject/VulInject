int snd_motu_protocol_v3_set_clock_rate ( struct snd_motu * motu , unsigned int rate ) { __be32 reg ; u32 data ; bool need_to_wait ; int i , err ; for ( i = 0 ; i < ARRAY_SIZE ( snd_motu_clock_rates ) ; ++ i ) { if ( snd_motu_clock_rates [ i ] == rate ) { break ; } } err = snd_motu_transaction_read ( motu , V3_CLOCK_STATUS_OFFSET , & reg , sizeof ( reg ) ) ; if ( err < 0 ) { return err ; } data = be32_to_cpu ( reg ) ; data &= ~ ( V3_CLOCK_RATE_MASK | V3_FETCH_PCM_FRAMES ) ; data |= i << V3_CLOCK_RATE_SHIFT ; need_to_wait = data != be32_to_cpu ( reg ) ; reg = cpu_to_be32 ( data ) ; err = snd_motu_transaction_write ( motu , V3_CLOCK_STATUS_OFFSET , & reg , sizeof ( reg ) ) ; if ( err < 0 ) { return err ; } if ( need_to_wait ) { int result ; motu -> msg = 0 ; result = wait_event_interruptible_timeout ( motu -> hwdep_wait , motu -> msg & V3_MSG_FLAG_CLK_CHANGED , msecs_to_jiffies ( V3_CLK_WAIT_MSEC ) ) ; if ( result < 0 ) { return result ; } if ( result == 0 ) { return - ETIMEDOUT ; } } return 0 ; } 