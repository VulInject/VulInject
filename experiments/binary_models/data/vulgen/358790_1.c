static irqreturn_t tlclk_interrupt ( int irq , void * dev_id ) { unsigned long flags ; spin_lock_irqsave ( & event_lock , flags ) ; int_events = inb ( TLCLK_REG6 ) ; if ( int_events & PRI_LOS_01_MASK ) { if ( inb ( TLCLK_REG2 ) & SEC_LOST_MASK ) { alarm_events -> lost_clocks ++ ; } else { alarm_events -> lost_primary_clock ++ ; } } if ( int_events & PRI_LOS_10_MASK ) { alarm_events -> primary_clock_back ++ ; SET_PORT_BITS ( TLCLK_REG1 , 0xFE , 1 ) ; } if ( int_events & SEC_LOS_01_MASK ) { if ( inb ( TLCLK_REG2 ) & PRI_LOST_MASK ) { alarm_events -> lost_clocks ++ ; } else { alarm_events -> lost_secondary_clock ++ ; } } if ( int_events & SEC_LOS_10_MASK ) { alarm_events -> secondary_clock_back ++ ; SET_PORT_BITS ( TLCLK_REG1 , 0xFE , 0 ) ; } if ( int_events & HOLDOVER_10_MASK ) { alarm_events -> pll_end_holdover ++ ; } if ( int_events & UNLOCK_01_MASK ) { alarm_events -> pll_lost_sync ++ ; } if ( int_events & HOLDOVER_01_MASK ) { alarm_events -> pll_holdover ++ ; switchover_timer . expires = jiffies + msecs_to_jiffies ( 10 ) ; tlclk_timer_data = inb ( TLCLK_REG1 ) ; switchover_timer . data = ( unsigned long ) & tlclk_timer_data ; mod_timer ( & switchover_timer , switchover_timer . expires ) ; } else { got_event = 1 ; wake_up ( & wq ) ; } spin_unlock_irqrestore ( & event_lock , flags ) ; return IRQ_HANDLED ; } 