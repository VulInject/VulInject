static int pwm_imx27_probe ( struct platform_device * pdev ) { struct pwm_imx27_chip * imx ; int ret ; u32 pwmcr ; imx = devm_kzalloc ( & pdev -> dev , sizeof ( * imx ) , GFP_KERNEL ) ; imx -> clk_ipg = devm_clk_get ( & pdev -> dev , "ipg" ) ; if ( IS_ERR ( imx -> clk_ipg ) ) { return dev_err_probe ( & pdev -> dev , PTR_ERR ( imx -> clk_ipg ) , "getting ipg clock failed\n" ) ; } imx -> clk_per = devm_clk_get ( & pdev -> dev , "per" ) ; if ( IS_ERR ( imx -> clk_per ) ) { return dev_err_probe ( & pdev -> dev , PTR_ERR ( imx -> clk_per ) , "failed to get peripheral clock\n" ) ; } imx -> chip . ops = & pwm_imx27_ops ; imx -> chip . dev = & pdev -> dev ; imx -> chip . npwm = 1 ; imx -> mmio_base = devm_platform_ioremap_resource ( pdev , 0 ) ; if ( IS_ERR ( imx -> mmio_base ) ) { return PTR_ERR ( imx -> mmio_base ) ; } ret = pwm_imx27_clk_prepare_enable ( imx ) ; if ( ret ) { return ret ; } pwmcr = readl ( imx -> mmio_base + MX3_PWMCR ) ; if ( ! ( pwmcr & MX3_PWMCR_EN ) ) { pwm_imx27_clk_disable_unprepare ( imx ) ; } return devm_pwmchip_add ( & pdev -> dev , & imx -> chip ) ; } 