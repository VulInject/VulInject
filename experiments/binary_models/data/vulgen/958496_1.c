static void prep_cmdline ( void * chosen ) { unsigned int getline_timeout = 5000 ; int v ; int n ; n = getprop ( chosen , "linux,cmdline-timeout" , & v , sizeof ( v ) ) ; if ( n == sizeof ( v ) ) { getline_timeout = v ; } if ( cmdline [ 0 ] == '\0' ) { getprop ( chosen , "bootargs" , cmdline , BOOT_COMMAND_LINE_SIZE - 1 ) ; } printf ( "\n\rLinux/PowerPC load: %s" , cmdline ) ; if ( console_ops . edit_cmdline && getline_timeout ) { console_ops . edit_cmdline ( cmdline , BOOT_COMMAND_LINE_SIZE , getline_timeout ) ; } printf ( "\n\r" ) ; setprop_str ( chosen , "bootargs" , cmdline ) ; } struct platform_ops platform_ops ; struct dt_ops dt_ops ; struct console_ops console_ops ; struct loader_info loader_info ; void start ( void ) { struct addr_range vmlinux , initrd ; kernel_entry_t kentry ; unsigned long ft_addr ; void * chosen ; if ( ( loader_info . cmdline_len > 0 ) && ( cmdline [ 0 ] == '\0' ) ) { memmove ( cmdline , loader_info . cmdline , min ( loader_info . cmdline_len , BOOT_COMMAND_LINE_SIZE - 1 ) ) ; } if ( console_ops . open && ( console_ops . open ( ) < 0 ) ) { exit ( ) ; } if ( platform_ops . fixups ) { platform_ops . fixups ( ) ; } printf ( "\n\rzImage starting: loaded at 0x%p (sp: 0x%p)\n\r" , _start , get_sp ( ) ) ; chosen = finddevice ( "/chosen" ) ; if ( ! chosen ) { chosen = create_node ( NULL , "chosen" ) ; } vmlinux = prep_kernel ( ) ; initrd = prep_initrd ( vmlinux , chosen , loader_info . initrd_addr , loader_info . initrd_size ) ; prep_esm_blob ( vmlinux , chosen ) ; prep_cmdline ( chosen ) ; printf ( "Finalizing device tree..." ) ; if ( dt_ops . finalize ) { ft_addr = dt_ops . finalize ( ) ; } if ( ft_addr ) { printf ( " flat tree at 0x%lx\n\r" , ft_addr ) ; } else { printf ( " using OF tree (promptr=%p)\n\r" , loader_info . promptr ) ; } if ( console_ops . close ) { console_ops . close ( ) ; } kentry = ( kernel_entry_t ) vmlinux . addr ; if ( ft_addr ) { if ( platform_ops . kentry ) { platform_ops . kentry ( ft_addr , vmlinux . addr ) ; } else { kentry ( ft_addr , 0 , NULL ) ; } } else { kentry ( ( unsigned long ) initrd . addr , initrd . size , loader_info . promptr ) ; } fatal ( "Error: Linux kernel returned to zImage boot wrapper!\n\r" ) ; } 