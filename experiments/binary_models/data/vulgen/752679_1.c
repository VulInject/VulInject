static int pxa2xx_ac97_probe ( struct platform_device * dev ) { struct snd_card * card ; struct snd_ac97_bus * ac97_bus ; struct snd_ac97_template ac97_template ; int ret ; pxa2xx_audio_ops_t * pdata = dev -> dev . platform_data ; if ( dev -> id >= 0 ) { dev_err ( & dev -> dev , "PXA2xx has only one AC97 port.\n" ) ; ret = - ENXIO ; err_dev } ret = snd_card_new ( & dev -> dev , SNDRV_DEFAULT_IDX1 , SNDRV_DEFAULT_STR1 , THIS_MODULE , 0 , & card ) ; if ( ret < 0 ) { err } strlcpy ( card -> driver , dev -> dev . driver -> name , sizeof ( card -> driver ) ) ; ret = pxa2xx_pcm_new ( card , & pxa2xx_ac97_pcm_client , & pxa2xx_ac97_pcm ) ; if ( ret ) { err } ret = pxa2xx_ac97_hw_probe ( dev ) ; if ( ret ) { err } ret = snd_ac97_bus ( card , 0 , & pxa2xx_ac97_ops , NULL , & ac97_bus ) ; if ( ret ) { err_remove } ret = snd_ac97_mixer ( ac97_bus , & ac97_template , & pxa2xx_ac97_ac97 ) ; if ( ret ) { err_remove } snprintf ( card -> shortname , sizeof ( card -> shortname ) , "%s" , snd_ac97_get_short_name ( pxa2xx_ac97_ac97 ) ) ; snprintf ( card -> longname , sizeof ( card -> longname ) , "%s (%s)" , dev -> dev . driver -> name , card -> mixername ) ; if ( pdata && pdata -> codec_pdata [ 0 ] ) { snd_ac97_dev_add_pdata ( ac97_bus -> codec [ 0 ] , pdata -> codec_pdata [ 0 ] ) ; } ret = snd_card_register ( card ) ; if ( ret == 0 ) { platform_set_drvdata ( dev , card ) ; return 0 ; } err_remove pxa2xx_ac97_hw_remove ( dev ) ; err if ( card ) { snd_card_free ( card ) ; } err_dev return ret ; } 