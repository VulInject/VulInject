static void vlogat ( int loglev , const char * fmt , va_list args ) { char timbuf [ 64 ] ; char regbuf [ SMALLSTR + 2 ] ; char * ostr ; int timlen ; int slen ; char * nstr ; int err1 , err2 ; int sloglev ; int retv ; va_list args2 ; static int xlate_loglev [ ] { LOG_ERR LOG_WARNING LOG_INFO LOG_DEBUG } ; ; if ( loglev >= log_level ) { return ; } timbuf [ 0 ] = '\0' ; timlen = 0 ; if ( curlogfd >= 0 ) { time_t now = time ( NULL ) ; timlen = strftime ( timbuf , sizeof ( timbuf ) , "%Y/%m/%d %T" "%Z: " , localtime ( & now ) ) ; } va_copy ( args2 , args ) ; slen = vsnprintf ( regbuf , SMALLSTR , fmt , args ) ; if ( slen < SMALLSTR ) { ostr = regbuf ; } else { slen = vsnprintf ( ostr , slen + 1 , fmt , args2 ) ; } if ( slen <= 0 ) { return ; } if ( ostr [ slen - 1 ] != '\n' ) { ostr [ slen ++ ] = '\n' ; ostr [ slen ] = '\0' ; } assert ( loglev >= 0 && loglev < Dim ( xlate_loglev ) ) ; sloglev = xlate_loglev [ loglev ] ; for ( ; * ostr != '\0' ; ostr = nstr + 1 ) { nstr = strchr ( ostr , '\n' ) ; if ( nstr == ostr ) { continue ; } slen = nstr - ostr + 1 ; if ( curlogfd >= 0 ) { if ( ( retv = dowrite ( curlogfd , timbuf , timlen ) ) > 0 ) { retv = dowrite ( curlogfd , ostr , slen ) ; } if ( retv > 0 ) { continue ; } err1 = errno ; if ( doclose ( ) == - 1 ) { err2 = errno ; } else { err2 = 0 ; } if ( retv == - 1 ) { logerr ( "write log %s: %s" , curfname , mystrerror ( err1 ) ) ; } else { logerr ( "cannot write %s" , curfname ) ; } if ( err2 == 0 ) { logdbg ( "closed log %s" , curfname ) ; } else { logerr ( "closing log %s: %s" , curfname , mystrerror ( err2 ) ) ; } } syslog ( sloglev , "%.*s" , slen , ostr ) ; } } 