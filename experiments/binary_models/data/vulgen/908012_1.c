ia64_expand_op_and_fetch ( , , , ) optab binoptab ; enum machine_mode mode ; tree arglist ; rtx target ; { rtx old , label , tmp , ret , ccv , insn , mem , value ; tree arg0 , arg1 ; arg0 = TREE_VALUE ( arglist ) ; arg1 = TREE_VALUE ( TREE_CHAIN ( arglist ) ) ; mem = expand_expr ( arg0 , NULL_RTX , Pmode , 0 ) ; value = expand_expr ( arg1 , NULL_RTX , mode , 0 ) ; mem = gen_rtx_MEM ( mode , force_reg ( Pmode , mem ) ) ; MEM_VOLATILE_P ( mem ) = 1 ; if ( target && ! register_operand ( target , mode ) ) { target = NULL_RTX ; } emit_insn ( gen_mf ( ) ) ; tmp = gen_reg_rtx ( mode ) ; old = gen_reg_rtx ( mode ) ; ccv = gen_rtx_REG ( DImode , AR_CCV_REGNUM ) ; emit_move_insn ( tmp , mem ) ; label = gen_label_rtx ( ) ; emit_label ( label ) ; emit_move_insn ( old , tmp ) ; convert_move ( ccv , tmp , 1 ) ; if ( binoptab == one_cmpl_optab ) { tmp = expand_unop ( mode , binoptab , tmp , NULL , OPTAB_WIDEN ) ; binoptab = and_optab ; } ret = expand_binop ( mode , binoptab , tmp , value , target , 1 , OPTAB_WIDEN ) ; if ( mode == SImode ) { insn = gen_cmpxchg_acq_si ( tmp , mem , ret , ccv ) ; } else { insn = gen_cmpxchg_acq_di ( tmp , mem , ret , ccv ) ; } emit_insn ( insn ) ; emit_cmp_and_jump_insns ( tmp , old , NE , 0 , mode , 1 , label ) ; return ret ; } 