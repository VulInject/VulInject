static qemuMonitorTest * qemuMonitorCommonTestNew ( virDomainXMLOption * xmlopt , virDomainObj * vm , virDomainChrSourceDef * src ) { g_autoptr ( ) test = NULL ; g_autofree char * path = NULL ; g_autofree char * tmpdir_template = NULL ; if ( virMutexInit ( & test -> lock ) < 0 ) { virReportError ( VIR_ERR_INTERNAL_ERROR , "%s" , "Cannot initialize mutex" ) ; VIR_FREE ( test ) ; return NULL ; } tmpdir_template = g_strdup ( "/tmp/libvirt_XXXXXX" ) ; if ( ! ( test -> tmpdir = g_mkdtemp ( tmpdir_template ) ) ) { virReportSystemError ( errno , "%s" , "Failed to create temporary directory" ) ; return NULL ; } tmpdir_template = NULL ; path = g_strdup_printf ( "%s/qemumonitorjsontest.sock" , test -> tmpdir ) ; if ( vm ) { test -> vm = virObjectRef ( vm ) ; } else { test -> vm = virDomainObjNew ( xmlopt ) ; if ( ! test -> vm ) { return NULL ; } if ( ! ( test -> vm -> def = virDomainDefNew ( xmlopt ) ) ) { return NULL ; } } if ( virNetSocketNewListenUNIX ( path , 0700 , geteuid ( ) , getegid ( ) , & test -> server ) < 0 ) { return NULL ; } memset ( src , 0 , sizeof ( * src ) ) ; src -> type = VIR_DOMAIN_CHR_TYPE_UNIX ; src -> data . nix . path = ( char * ) path ; src -> data . nix . listen = false ; path = NULL ; if ( virNetSocketListen ( test -> server , 1 ) < 0 ) { return NULL ; } return g_steal_pointer ( & test ) ; } 