static int v9fs_file_getlock ( struct file * filp , struct file_lock * fl ) { struct p9_getlock glock ; struct p9_fid * fid ; int res = 0 ; fid = filp -> private_data ; BUG_ON ( fid == NULL ) ; posix_test_lock ( filp , fl ) ; if ( fl -> fl_type != F_UNLCK ) { return res ; } memset ( & glock , 0 , sizeof ( glock ) ) ; glock . type = P9_LOCK_TYPE_UNLCK ; glock . start = fl -> fl_start ; if ( fl -> fl_end == OFFSET_MAX ) { glock . length = 0 ; } else { glock . length = fl -> fl_end - fl -> fl_start + 1 ; } glock . proc_id = fl -> fl_pid ; glock . client_id = fid -> clnt -> name ; res = p9_client_getlock_dotl ( fid , & glock ) ; if ( res < 0 ) { out } switch ( glock . type ) { case P9_LOCK_TYPE_RDLCK : fl -> fl_type = F_RDLCK ; break ; case P9_LOCK_TYPE_WRLCK : fl -> fl_type = F_WRLCK ; break ; case P9_LOCK_TYPE_UNLCK : fl -> fl_type = F_UNLCK ; break ; } if ( glock . type != P9_LOCK_TYPE_UNLCK ) { fl -> fl_start = glock . start ; if ( glock . length == 0 ) { fl -> fl_end = OFFSET_MAX ; } else { fl -> fl_end = glock . start + glock . length - 1 ; } fl -> fl_pid = - glock . proc_id ; } out return res ; } 