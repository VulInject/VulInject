static int sipt_forwarding ( struct sip_msg * msg , char * _fwdnumber , char * _nai ) { str * nai = ( str * ) _nai ; unsigned int int_nai = 0 ; str2int ( nai , & int_nai ) ; str * fwdnumber = ( str * ) _fwdnumber ; struct sdp_mangler mangle ; str body ; body . s = get_body_part ( msg , TYPE_APPLICATION , SUBTYPE_ISUP , & body . len ) ; if ( body . s == NULL ) { LM_INFO ( "No ISUP Message Found" ) ; return - 1 ; } str sdp ; sdp . s = get_body_part ( msg , TYPE_APPLICATION , SUBTYPE_SDP , & sdp . len ) ; unsigned char newbuf [ 1024 ] ; memset ( newbuf , 0 , 1024 ) ; if ( body . s == 0 ) { LM_ERR ( "failed to get the message body\n" ) ; return - 1 ; } body . len = msg -> len - ( int ) ( body . s - msg -> buf ) ; if ( body . len == 0 ) { LM_DBG ( "message body has zero length\n" ) ; return - 1 ; } if ( body . s [ 0 ] != ISUP_IAM ) { LM_DBG ( "message not an IAM\n" ) ; return - 1 ; } mangle . msg = msg ; mangle . body_offset = ( int ) ( body . s - msg -> buf ) ; char * digits = calloc ( 1 , fwdnumber -> len + 2 ) ; memcpy ( digits , fwdnumber -> s , fwdnumber -> len ) ; int res = isup_update_forwarding ( & mangle , digits , int_nai , ( unsigned char * ) body . s , body . len ) ; if ( res < 0 ) { LM_DBG ( "error updating IAM\n" ) ; return - 1 ; } return 1 ; } 