void ia64_mca_handler ( struct pt_regs * regs , struct switch_stack * sw , struct ia64_sal_os_state * sos ) { int recover , cpu = smp_processor_id ( ) ; struct task_struct * previous_current ; struct ia64_mca_notify_die nd = { . sos = sos . monarch_cpu = & monarch_cpu . data = & recover } ; static atomic_t mca_count ; static cpumask_t mca_cpu ; if ( atomic_add_return ( 1 , & mca_count ) == 1 ) { monarch_cpu = cpu ; sos -> monarch = 1 ; } else { cpumask_set_cpu ( cpu , & mca_cpu ) ; sos -> monarch = 0 ; } mprintk ( KERN_INFO "Entered OS MCA handler. PSP=%lx cpu=%d " "monarch=%ld\n" , sos -> proc_state_param , cpu , sos -> monarch ) ; previous_current = ia64_mca_modify_original_stack ( regs , sw , sos , "MCA" ) ; NOTIFY_MCA ( DIE_MCA_MONARCH_ENTER , regs , ( long ) & nd , 1 ) ; ia64_mc_info . imi_rendez_checkin [ cpu ] = IA64_MCA_RENDEZ_CHECKIN_CONCURRENT_MCA ; if ( sos -> monarch ) { ia64_wait_for_slaves ( cpu , "MCA" ) ; ia64_mca_wakeup_all ( ) ; } else { while ( cpumask_test_cpu ( cpu , & mca_cpu ) ) { cpu_relax ( ) ; } } NOTIFY_MCA ( DIE_MCA_MONARCH_PROCESS , regs , ( long ) & nd , 1 ) ; ia64_mca_log_sal_error_record ( SAL_INFO_TYPE_MCA ) ; recover = ( ia64_mca_ucmc_extension && ia64_mca_ucmc_extension ( IA64_LOG_CURR_BUFFER ( SAL_INFO_TYPE_MCA ) , sos ) ) ; if ( recover ) { sal_log_record_header_t * rh = IA64_LOG_CURR_BUFFER ( SAL_INFO_TYPE_MCA ) ; rh -> severity = sal_log_severity_corrected ; ia64_sal_clear_state_info ( SAL_INFO_TYPE_MCA ) ; sos -> os_status = IA64_MCA_CORRECTED ; } else { ia64_mlogbuf_finish ( 1 ) ; } NOTIFY_MCA ( DIE_MCA_MONARCH_LEAVE , regs , ( long ) & nd , 1 ) ; if ( atomic_dec_return ( & mca_count ) > 0 ) { int i ; for_each_online_cpu ( ) { if ( cpumask_test_cpu ( i , & mca_cpu ) ) { monarch_cpu = i ; cpumask_clear_cpu ( i , & mca_cpu ) ; while ( monarch_cpu != - 1 ) { cpu_relax ( ) ; } ia64_set_curr_task ( cpu , previous_current ) ; ia64_mc_info . imi_rendez_checkin [ cpu ] = IA64_MCA_RENDEZ_CHECKIN_NOTDONE ; return ; } } } ia64_set_curr_task ( cpu , previous_current ) ; ia64_mc_info . imi_rendez_checkin [ cpu ] = IA64_MCA_RENDEZ_CHECKIN_NOTDONE ; monarch_cpu = - 1 ; } 