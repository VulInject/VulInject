void __stdcall CommandHandler ( DWORD dwCommand ) { switch ( dwCommand ) { case SERVICE_CONTROL_STOP : case SERVICE_CONTROL_SHUTDOWN : SetStatus ( SERVICE_STOP_PENDING , 0 , 1 ) ; conf . timetoexit = 1 ; conf . paused ++ ; Sleep ( 2000 ) ; SetStatus ( SERVICE_STOPPED , 0 , 0 ) ; close_sql ( ) ; pthread_mutex_unlock ( & log_mutex ) ; break ; case SERVICE_CONTROL_PAUSE : SetStatus ( SERVICE_PAUSE_PENDING , 0 , 1 ) ; conf . paused ++ ; SetStatus ( SERVICE_PAUSED , 0 , 0 ) ; break ; case SERVICE_CONTROL_CONTINUE : SetStatus ( SERVICE_CONTINUE_PENDING , 0 , 1 ) ; conf . needreload = 1 ; SetStatus ( SERVICE_RUNNING , 0 , 0 ) ; break ; default : } } 