struct mac_device_info * dwmac4_setup ( void __iomem * ioaddr , int mcbins , int perfect_uc_entries , int * synopsys_id ) { struct mac_device_info * mac ; u32 hwid = readl ( ioaddr + GMAC_VERSION ) ; mac = kzalloc ( sizeof ( const mac_device_info ) , GFP_KERNEL ) ; mac -> pcsr = ioaddr ; mac -> multicast_filter_bins = mcbins ; mac -> unicast_filter_entries = perfect_uc_entries ; mac -> mcast_bits_log2 = 0 ; if ( mac -> multicast_filter_bins ) { mac -> mcast_bits_log2 = ilog2 ( mac -> multicast_filter_bins ) ; } mac -> link . port = GMAC_CONFIG_PS ; mac -> link . duplex = GMAC_CONFIG_DM ; mac -> link . speed = GMAC_CONFIG_FES ; mac -> mii . addr = GMAC_MDIO_ADDR ; mac -> mii . data = GMAC_MDIO_DATA ; mac -> mii . addr_shift = 21 ; mac -> mii . addr_mask = GENMASK ( 25 , 21 ) ; mac -> mii . reg_shift = 16 ; mac -> mii . reg_mask = GENMASK ( 20 , 16 ) ; mac -> mii . clk_csr_shift = 8 ; mac -> mii . clk_csr_mask = GENMASK ( 11 , 8 ) ; * synopsys_id = stmmac_get_synopsys_id ( hwid ) ; if ( * synopsys_id > DWMAC_CORE_4_00 ) { mac -> dma = & dwmac410_dma_ops ; } else { mac -> dma = & dwmac4_dma_ops ; } if ( * synopsys_id >= DWMAC_CORE_4_00 ) { mac -> mac = & dwmac410_ops ; } else { mac -> mac = & dwmac4_ops ; } return mac ; } 