static ssize_t powercap_show ( struct kobject * kobj , struct kobj_attribute * attr , char * buf ) { struct powercap_attr * pcap_attr = container_of ( attr , powercap_attr , attr ) ; struct opal_msg msg ; u32 pcap ; int ret , token ; token = opal_async_get_token_interruptible ( ) ; if ( token < 0 ) { pr_devel ( "Failed to get token\n" ) ; return token ; } ret = mutex_lock_interruptible ( & powercap_mutex ) ; if ( ret ) { out_token } switch ( ret ) { case OPAL_ASYNC_COMPLETION : ret = opal_async_wait_response ( token , & msg ) ; if ( ret ) { pr_devel ( "Failed to wait for the async response\n" ) ; ret = - EIO ; out } ret = opal_error_code ( opal_get_async_rc ( msg ) ) ; if ( ! ret ) { ret = sprintf ( buf , "%u\n" , be32_to_cpu ( pcap ) ) ; if ( ret < 0 ) { ret = - EIO ; } } break ; case OPAL_SUCCESS : ret = sprintf ( buf , "%u\n" , be32_to_cpu ( pcap ) ) ; if ( ret < 0 ) { ret = - EIO ; } break ; default : ret = opal_error_code ( ret ) ; } out mutex_unlock ( & powercap_mutex ) ; out_token opal_async_release_token ( token ) ; return ret ; } 