int hci1394_alloc_isoch_dma ( void * hal_private , id1394_isoch_dmainfo_t * idi , void * * hal_idma_handlep , int * resultp ) { int i ; int err ; hci1394_state_t * soft_statep = ( hci1394_state_t * ) hal_private ; hci1394_isoch_t * isochp ; hci1394_iso_ctxt_t * ctxtp ; ASSERT ( soft_statep != NULL ) ; ASSERT ( hal_idma_handlep != NULL ) ; isochp = soft_statep -> isoch ; * hal_idma_handlep = NULL ; mutex_enter ( & isochp -> ctxt_list_mutex ) ; if ( ( idi -> idma_options & ID1394_TALK ) != 0 ) { for ( i = 0 ; i < isochp -> ctxt_xmit_count ; i ++ ) { if ( ( isochp -> ctxt_xmit [ i ] . ctxt_flags & HCI1394_ISO_CTXT_INUSE ) == 0 ) { break ; } } if ( i >= isochp -> ctxt_xmit_count ) { mutex_exit ( & isochp -> ctxt_list_mutex ) ; * resultp = IXL1394_ENO_DMA_RESRCS ; return ( DDI_FAILURE ) ; } isochp -> ctxt_xmit [ i ] . ctxt_flags |= HCI1394_ISO_CTXT_INUSE ; ctxtp = & isochp -> ctxt_xmit [ i ] ; isochp -> ctxt_xmit [ i ] . ctxt_regsp = & soft_statep -> ohci -> ohci_regs -> it [ i ] ; } else { for ( i = 0 ; i < isochp -> ctxt_recv_count ; i ++ ) { if ( ( isochp -> ctxt_recv [ i ] . ctxt_flags & HCI1394_ISO_CTXT_INUSE ) == 0 ) { break ; } } if ( i >= isochp -> ctxt_recv_count ) { mutex_exit ( & isochp -> ctxt_list_mutex ) ; * resultp = IXL1394_ENO_DMA_RESRCS ; return ( DDI_FAILURE ) ; } if ( ( idi -> idma_options & ID1394_LISTEN_BUF_MODE ) != 0 ) { isochp -> ctxt_recv [ i ] . ctxt_flags |= HCI1394_ISO_CTXT_BFFILL ; } if ( ( idi -> idma_options & ID1394_RECV_HEADERS ) != 0 ) { isochp -> ctxt_recv [ i ] . ctxt_flags |= HCI1394_ISO_CTXT_RHDRS ; } isochp -> ctxt_recv [ i ] . ctxt_flags |= HCI1394_ISO_CTXT_INUSE ; ctxtp = & isochp -> ctxt_recv [ i ] ; isochp -> ctxt_recv [ i ] . ctxt_regsp = ( hci1394_ctxt_regs_t * ) & soft_statep -> ohci -> ohci_regs -> ir [ i ] ; } mutex_exit ( & isochp -> ctxt_list_mutex ) ; ctxtp -> isochan = idi -> channel_num ; ctxtp -> default_tag = idi -> default_tag ; ctxtp -> default_sync = idi -> default_sync ; ctxtp -> global_callback_arg = idi -> global_callback_arg ; ctxtp -> isoch_dma_stopped = idi -> isoch_dma_stopped ; ctxtp -> idma_evt_arg = idi -> idma_evt_arg ; ctxtp -> isospd = idi -> it_speed ; ctxtp -> default_skipmode = idi -> it_default_skip ; ctxtp -> default_skiplabelp = idi -> it_default_skiplabel ; err = hci1394_compile_ixl ( soft_statep , ctxtp , idi -> ixlp , resultp ) ; if ( err != DDI_SUCCESS ) { mutex_enter ( & isochp -> ctxt_list_mutex ) ; if ( ( ctxtp -> ctxt_flags & HCI1394_ISO_CTXT_RECV ) != 0 ) { isochp -> ctxt_recv [ i ] . ctxt_flags &= ~ HCI1394_ISO_CTXT_BFFILL ; isochp -> ctxt_recv [ i ] . ctxt_flags &= ~ HCI1394_ISO_CTXT_RHDRS ; } ctxtp -> ctxt_flags &= ~ HCI1394_ISO_CTXT_INUSE ; mutex_exit ( & isochp -> ctxt_list_mutex ) ; return ( DDI_FAILURE ) ; } mutex_enter ( & isochp -> ctxt_list_mutex ) ; isochp -> isoch_dma_alloc_cnt ++ ; mutex_exit ( & isochp -> ctxt_list_mutex ) ; ctxtp -> intr_flags = 0 ; * hal_idma_handlep = ctxtp ; return ( DDI_SUCCESS ) ; } 