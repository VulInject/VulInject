static int do_paths ( struct findall_data * data , void * rock ) { struct options_t * opts = ( options_t * ) rock ; if ( data -> mbentry -> mbtype & MBTYPE_RESERVE ) { return IMAP_MAILBOX_RESERVED ; } if ( data -> mbentry -> mbtype & MBTYPE_DELETED ) { return IMAP_MAILBOX_NONEXISTENT ; } if ( data -> mbentry -> mbtype & MBTYPE_REMOTE ) { if ( opts -> localonly ) { if ( opts -> stop_on_error ) { if ( opts -> quiet ) { fatal ( "" , - 1 ) ; } else { fatal ( "Non-local mailbox. Stopping\n" , - 1 ) ; } } } else { if ( ! opts -> do_json ) { printf ( "%s!%s\n" , data -> mbentry -> server , data -> mbentry -> partition ) ; } } } if ( ! data -> mbentry -> uniqueid && ! ( data -> mbentry -> mbtype & MBTYPE_LEGACY_DIRS ) ) { xsyslog ( LOG_ERR , "mbentry has no uniqueid, needs reconstruct" , "mboxname=<%s>" , data -> mbentry -> name ) ; if ( ! opts -> quiet ) { const char * extname = data -> extname ; if ( ! extname ) { extname = mbname_extname ( data -> mbname , & mbpath_namespace , "cyrus" ) ; } fprintf ( stderr , "Mailbox has no uniqueid, needs reconstruct: %s\n" , extname ) ; } return IMAP_MAILBOX_BADFORMAT ; } if ( opts -> do_json ) { print_json ( data -> mbname , data -> mbentry ) ; } else { if ( opts -> paths & DO_ARCHIVE ) { const char * path = mbentry_archivepath ( data -> mbentry , 0 ) ; if ( opts -> paths == DO_ALL ) { printf ( "Archive: " ) ; } printf ( "%s\n" , path ) ; } if ( opts -> paths & DO_DATA ) { const char * path = mbentry_datapath ( data -> mbentry , 0 ) ; if ( opts -> paths == DO_ALL ) { printf ( "Data: " ) ; } printf ( "%s\n" , path ) ; } if ( opts -> paths & DO_META ) { const char * path = mbentry_metapath ( data -> mbentry , 0 , 0 ) ; if ( opts -> paths == DO_ALL ) { printf ( "Meta: " ) ; } printf ( "%s\n" , path ) ; } if ( opts -> paths & DO_SIEVE ) { const char * path = user_sieve_path ( mbname_userid ( data -> mbname ) ) ; if ( opts -> paths == DO_ALL ) { printf ( "Sieve: " ) ; } printf ( "%s\n" , path ) ; } if ( opts -> paths & DO_USER ) { char * path = mboxname_conf_getpath ( data -> mbname , NULL ) ; if ( opts -> paths == DO_ALL ) { printf ( "User: " ) ; } printf ( "%s\n" , path ) ; free ( path ) ; } } return 0 ; } 