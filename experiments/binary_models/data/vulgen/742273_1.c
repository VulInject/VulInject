static int coroutine_fn backup_run ( Job * job , Error * * errp ) { BackupBlockJob * s = container_of ( job , BackupBlockJob , common . job ) ; int ret ; backup_init_bcs_bitmap ( s ) ; if ( s -> sync_mode == MIRROR_SYNC_MODE_TOP ) { int64_t offset = 0 ; int64_t count ; for ( offset = 0 ; offset < s -> len ; ) { if ( job_is_cancelled ( job ) ) { return - ECANCELED ; } job_pause_point ( job ) ; if ( job_is_cancelled ( job ) ) { return - ECANCELED ; } ret = block_copy_reset_unallocated ( s -> bcs , offset , & count ) ; if ( ret < 0 ) { return ret ; } offset += count ; } } if ( s -> sync_mode == MIRROR_SYNC_MODE_NONE ) { while ( ! job_is_cancelled ( job ) ) { job_yield ( job ) ; } } else { return backup_loop ( s ) ; } return 0 ; } 