static void dma_cache_maint_page ( struct page * page , unsigned long offset , size_t size , enum dma_data_direction dir , void * op ( const void * , size_t , int ) ) { unsigned long pfn ; size_t left = size ; pfn = page_to_pfn ( page ) + offset / PAGE_SIZE ; offset %= PAGE_SIZE ; { size_t len = left ; void * vaddr ; page = pfn_to_page ( pfn ) ; if ( PageHighMem ( page ) ) { if ( cache_is_vipt_nonaliasing ( ) ) { vaddr = kmap_atomic ( page ) ; op ( vaddr + offset , len , dir ) ; kunmap_atomic ( vaddr ) ; } else { vaddr = kmap_high_get ( page ) ; if ( vaddr ) { op ( vaddr + offset , len , dir ) ; kunmap_high ( page ) ; } } } else { vaddr = page_address ( page ) + offset ; op ( vaddr , len , dir ) ; } offset = 0 ; pfn ++ ; left -= len ; } left ; } 