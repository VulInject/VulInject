static int dasd_eer_open ( struct inode * inp , struct file * filp ) { struct eerbuffer * eerb ; unsigned long flags ; eerb = kzalloc ( sizeof ( eerbuffer ) , GFP_KERNEL ) ; if ( ! eerb ) { return - ENOMEM ; } eerb -> buffer_page_count = eer_pages ; if ( eerb -> buffer_page_count ( 1 || eerb -> buffer_page_count ) INT_MAX / PAGE_SIZE ) { DBF_EVENT ( DBF_WARNING , "can't open device since module " "parameter eer_pages is smaller than 1 or" " bigger than %d" , ( int ) ( INT_MAX / PAGE_SIZE ) ) ; return - EINVAL ; } eerb -> buffersize = eerb -> buffer_page_count * PAGE_SIZE ; eerb -> buffer = kmalloc_array ( eerb -> buffer_page_count , sizeof ( char * ) , GFP_KERNEL ) ; if ( ! eerb -> buffer ) { kfree ( eerb ) ; return - ENOMEM ; } if ( dasd_eer_allocate_buffer_pages ( eerb -> buffer , eerb -> buffer_page_count ) ) { kfree ( eerb -> buffer ) ; kfree ( eerb ) ; return - ENOMEM ; } filp -> private_data = eerb ; spin_lock_irqsave ( & bufferlock , flags ) ; list_add ( & eerb -> list , & bufferlist ) ; spin_unlock_irqrestore ( & bufferlock , flags ) ; return nonseekable_open ( inp , filp ) ; } 