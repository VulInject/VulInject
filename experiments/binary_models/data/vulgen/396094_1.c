char * antminer_get_clock ( struct cgpu_info * cgpu , char * replybuf ) { uint8_t rdreg_buf [ 4 ] { 0 } ; ; unsigned char rebuf [ ANTMINER_STATUS_LEN ] { 0 } ; ; struct timeval tv_now ; struct timeval tv_timeout , tv_finish ; rdreg_buf [ 0 ] = 4 ; rdreg_buf [ 0 ] |= 0x80 ; rdreg_buf [ 1 ] = 0 ; rdreg_buf [ 2 ] = 0x04 ; rdreg_buf [ 3 ] = crc5usb ( rdreg_buf , 27 ) ; applog ( LOG_DEBUG , "%" PRIpreprv ": Get clock: %02x%02x%02x%02x" , cgpu -> proc_repr , rdreg_buf [ 0 ] , rdreg_buf [ 1 ] , rdreg_buf [ 2 ] , rdreg_buf [ 3 ] ) ; timer_set_now ( & tv_now ) ; int err = icarus_write ( cgpu -> proc_repr , cgpu -> device_fd , rdreg_buf , sizeof ( rdreg_buf ) ) ; if ( err != 0 ) { sprintf ( replybuf , "invalid send get clock: comms error (err=%d)" , err ) ; return replybuf ; } applog ( LOG_DEBUG , "%" PRIpreprv ": Get clock: OK" , cgpu -> proc_repr ) ; timer_set_delay ( & tv_timeout , & tv_now , 1000000 ) ; err = icarus_read ( cgpu -> proc_repr , rebuf , cgpu -> device_fd , & tv_finish , NULL , & tv_timeout , & tv_now , ANTMINER_STATUS_LEN ) ; if ( err == ICA_GETS_ERROR ) { sprintf ( replybuf , "invalid recv get clock: comms error (err=%d)" , err ) ; return replybuf ; } applog ( LOG_DEBUG , "%" PRIpreprv ": Get clock: %02x%02x%02x%02x%02x" , cgpu -> proc_repr , rebuf [ 0 ] , rebuf [ 1 ] , rebuf [ 2 ] , rebuf [ 3 ] , rebuf [ 4 ] ) ; return NULL ; } 