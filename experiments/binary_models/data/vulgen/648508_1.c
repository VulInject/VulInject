START_TEST ( ) { M_http_reader_t * hr ; httpr_test_t * ht ; M_http_error_t res ; size_t len_read ; const char * key ; const char * gval ; const char * eval ; const char * body = "<html><body><h1>It works!</h1></body></html>" ; ht = httpr_test_create ( ) ; hr = gen_reader ( ht ) ; res = M_http_reader_read ( hr , ( const unsigned char * ) http1_data , M_str_len ( http1_data ) , & len_read ) ; ck_assert_msg ( res == M_HTTP_ERROR_SUCCESS , "Parse failed: %d" , res ) ; ck_assert_msg ( len_read == M_str_len ( http1_data ) , "Did not read full message: got '%zu', expected '%zu'" , len_read , M_str_len ( http1_data ) ) ; ck_assert_msg ( ht -> type == M_HTTP_MESSAGE_TYPE_RESPONSE , "Wrong type: got '%d', expected '%d'" , ht -> type , M_HTTP_MESSAGE_TYPE_RESPONSE ) ; ck_assert_msg ( ht -> version == M_HTTP_VERSION_1_1 , "Wrong version: got '%d', expected '%d'" , ht -> version , M_HTTP_VERSION_1_1 ) ; ck_assert_msg ( ht -> code == 200 , "Wrong code: got '%u', expected '%u'" , ht -> code , 200 ) ; ck_assert_msg ( M_str_eq ( ht -> reason , "OK" ) , "Wrong reason: got '%s', expected '%s'" , ht -> reason , "OK" ) ; key = "Date" ; gval = M_hash_dict_get_direct ( ht -> headers_full , key ) ; eval = "Mon, 7 May 2018 01:02:03 GMT" ; ck_assert_msg ( M_str_eq ( gval , eval ) , "%s failed: got '%s', expected '%s'" , key , gval , eval ) ; key = "Date" ; gval = M_hash_dict_get_direct ( ht -> headers , key ) ; eval = "Mon, 7 May 2018 01:02:03 GMT" ; ck_assert_msg ( M_str_eq ( gval , eval ) , "%s failed (did split): got '%s', expected '%s'" , key , gval , eval ) ; key = "Content-Length" ; gval = M_hash_dict_get_direct ( ht -> headers_full , key ) ; eval = "44" ; ck_assert_msg ( M_str_eq ( gval , eval ) , "%s failed: got '%s', expected '%s'" , key , gval , eval ) ; key = "Connection" ; gval = M_hash_dict_get_direct ( ht -> headers_full , key ) ; eval = "close" ; ck_assert_msg ( M_str_eq ( gval , eval ) , "%s failed: got '%s', expected '%s'" , key , gval , eval ) ; key = "Content-Type" ; gval = M_hash_dict_get_direct ( ht -> headers_full , key ) ; eval = "text/html" ; ck_assert_msg ( M_str_eq ( gval , eval ) , "%s failed: got '%s', expected '%s'" , key , gval , eval ) ; ck_assert_msg ( M_str_eq ( M_buf_peek ( ht -> body ) , body ) , "Body failed: got '%s', expected '%s'" , M_buf_peek ( ht -> body ) , body ) ; httpr_test_destroy ( ht ) ; } 