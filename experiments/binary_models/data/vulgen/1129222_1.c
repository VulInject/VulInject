static void protobuf_dissect_field_value ( proto_tree * value_tree , tvbuff_t * tvb , guint offset , guint length , packet_info * pinfo , proto_item * ti_field , int field_type , const guint64 value , const gchar * prepend_text , const PbwFieldDescriptor * field_desc , gboolean is_top_level , json_dumper * dumper ) { gdouble double_value ; gfloat float_value ; gint64 int64_value ; gint32 int32_value ; char * buf ; gboolean add_datatype = TRUE ; proto_item * ti = NULL ; proto_tree * subtree = NULL ; const char * enum_value_name = NULL ; const PbwDescriptor * sub_message_desc = NULL ; const PbwEnumDescriptor * enum_desc = NULL ; int * hf_id_ptr = NULL ; const gchar * field_full_name = field_desc ?pbw_FieldDescriptor_full_name ( field_desc ) : NULL ; proto_tree * field_tree = proto_item_get_subtree ( ti_field ) ; proto_tree * field_parent_tree = proto_tree_get_parent_tree ( field_tree ) ; proto_tree * pbf_tree = field_tree ; dissector_handle_t field_dissector = field_full_name ?dissector_get_string_handle ( protobuf_field_subdissector_table , field_full_name ) : NULL ; if ( pbf_as_hf && field_full_name ) { hf_id_ptr = ( int * ) g_hash_table_lookup ( pbf_hf_hash , field_full_name ) ; DISSECTOR_ASSERT_HINT ( hf_id_ptr && ( * hf_id_ptr ) > 0 , "hf must have been initialized properly" ) ; } if ( pbf_as_hf && hf_id_ptr && ! show_details ) { proto_item_set_hidden ( ti_field ) ; pbf_tree = field_parent_tree ; } if ( prepend_text == NULL ) { prepend_text = "" ; } switch ( field_type ) { case PROTOBUF_TYPE_DOUBLE : double_value = protobuf_uint64_to_double ( value ) ; proto_tree_add_double ( value_tree , hf_protobuf_value_double , tvb , offset , length , double_value ) ; proto_item_append_text ( ti_field , "%s %lf" , prepend_text , double_value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%lf" , double_value ) ; } if ( hf_id_ptr ) { proto_tree_add_double ( pbf_tree , * hf_id_ptr , tvb , offset , length , double_value ) ; } if ( field_desc && dumper ) { json_dumper_value_double ( dumper , double_value ) ; } break ; case PROTOBUF_TYPE_FLOAT : float_value = protobuf_uint32_to_float ( ( guint32 ) value ) ; proto_tree_add_float ( value_tree , hf_protobuf_value_float , tvb , offset , length , float_value ) ; proto_item_append_text ( ti_field , "%s %f" , prepend_text , float_value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%f" , float_value ) ; } if ( hf_id_ptr ) { proto_tree_add_float ( pbf_tree , * hf_id_ptr , tvb , offset , length , float_value ) ; } if ( field_desc && dumper ) { json_dumper_value_anyf ( dumper , "%f" , float_value ) ; } break ; case PROTOBUF_TYPE_INT64 : case PROTOBUF_TYPE_SFIXED64 : int64_value = ( gint64 ) value ; proto_tree_add_int64 ( value_tree , hf_protobuf_value_int64 , tvb , offset , length , int64_value ) ; proto_item_append_text ( ti_field , "%s %" PRId64 , prepend_text , int64_value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%" PRId64 , int64_value ) ; } if ( hf_id_ptr ) { proto_tree_add_int64 ( pbf_tree , * hf_id_ptr , tvb , offset , length , int64_value ) ; } if ( field_desc && dumper ) { json_dumper_value_anyf ( dumper , "\"%" PRId64 "\"" , int64_value ) ; } break ; case PROTOBUF_TYPE_UINT64 : case PROTOBUF_TYPE_FIXED64 : proto_tree_add_uint64 ( value_tree , hf_protobuf_value_uint64 , tvb , offset , length , value ) ; proto_item_append_text ( ti_field , "%s %" PRIu64 , prepend_text , value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%" PRIu64 , value ) ; } if ( hf_id_ptr ) { proto_tree_add_uint64 ( pbf_tree , * hf_id_ptr , tvb , offset , length , value ) ; } if ( field_desc && dumper ) { json_dumper_value_anyf ( dumper , "\"%" PRIu64 "\"" , value ) ; } break ; case PROTOBUF_TYPE_INT32 : case PROTOBUF_TYPE_SFIXED32 : int32_value = ( gint32 ) value ; proto_tree_add_int ( value_tree , hf_protobuf_value_int32 , tvb , offset , length , int32_value ) ; proto_item_append_text ( ti_field , "%s %d" , prepend_text , int32_value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%d" , int32_value ) ; } if ( hf_id_ptr ) { proto_tree_add_int ( pbf_tree , * hf_id_ptr , tvb , offset , length , int32_value ) ; } if ( field_desc && dumper ) { json_dumper_value_anyf ( dumper , "%d" , int32_value ) ; } break ; case PROTOBUF_TYPE_ENUM : int32_value = ( gint32 ) value ; if ( field_desc ) { enum_desc = pbw_FieldDescriptor_enum_type ( field_desc ) ; if ( enum_desc ) { const PbwEnumValueDescriptor * enum_value_desc = pbw_EnumDescriptor_FindValueByNumber ( enum_desc , int32_value ) ; if ( enum_value_desc ) { enum_value_name = pbw_EnumValueDescriptor_name ( enum_value_desc ) ; } } } ti = proto_tree_add_int ( value_tree , hf_protobuf_value_int32 , tvb , offset , length , int32_value ) ; if ( enum_value_name ) { proto_item_append_text ( ti_field , "%s %s(%d)" , prepend_text , enum_value_name , int32_value ) ; proto_item_append_text ( ti , " (%s)" , enum_value_name ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%s" , enum_value_name ) ; } } else { proto_item_append_text ( ti_field , "%s %d" , prepend_text , int32_value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%d" , int32_value ) ; } } if ( hf_id_ptr ) { proto_tree_add_int ( pbf_tree , * hf_id_ptr , tvb , offset , length , int32_value ) ; } if ( field_desc && dumper ) { json_dumper_value_string ( dumper , enum_value_name ) ; } break ; case PROTOBUF_TYPE_BOOL : if ( length > 1 ) { break ; } proto_tree_add_boolean ( value_tree , hf_protobuf_value_bool , tvb , offset , length , ( guint32 ) value ) ; proto_item_append_text ( ti_field , "%s %s" , prepend_text , value ?"true" : "false" ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%s" , value ?"true" : "false" ) ; } if ( hf_id_ptr ) { proto_tree_add_boolean ( pbf_tree , * hf_id_ptr , tvb , offset , length , ( guint32 ) value ) ; } if ( field_desc && dumper ) { json_dumper_value_anyf ( dumper , value ?"true" : "false" ) ; } break ; case PROTOBUF_TYPE_BYTES : if ( field_desc && dumper ) { json_dumper_begin_base64 ( dumper ) ; buf = ( char * ) tvb_memdup ( wmem_file_scope ( ) , tvb , offset , length ) ; if ( buf ) { json_dumper_write_base64 ( dumper , buf , length ) ; wmem_free ( wmem_file_scope ( ) , buf ) ; } json_dumper_end_base64 ( dumper ) ; } if ( field_dissector ) { if ( ! show_details ) { proto_item_set_hidden ( proto_tree_get_parent ( value_tree ) ) ; } if ( dissect_bytes_as_string ) { if ( hf_id_ptr ) { ti = proto_tree_add_string_format_value ( pbf_tree , * hf_id_ptr , tvb , offset , length , "" , "(%u bytes)" , length ) ; } break ; } } if ( ! dissect_bytes_as_string ) { if ( hf_id_ptr ) { ti = proto_tree_add_bytes_format_value ( pbf_tree , * hf_id_ptr , tvb , offset , length , NULL , "(%u bytes)" , length ) ; } break ; } proto_item_append_text ( ti_field , " =" ) ; case PROTOBUF_TYPE_STRING : proto_tree_add_item_ret_display_string ( value_tree , hf_protobuf_value_string , tvb , offset , length , ENC_UTF_8 | ENC_NA , pinfo -> pool , & buf ) ; proto_item_append_text ( ti_field , "%s %s" , prepend_text , buf ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%s" , buf ) ; } if ( hf_id_ptr ) { ti = proto_tree_add_item_ret_display_string ( pbf_tree , * hf_id_ptr , tvb , offset , length , ENC_UTF_8 | ENC_NA , pinfo -> pool , & buf ) ; } if ( field_desc && dumper && field_type == PROTOBUF_TYPE_STRING ) { json_dumper_value_string ( dumper , buf ) ; } break ; case PROTOBUF_TYPE_GROUP : case PROTOBUF_TYPE_MESSAGE : subtree = field_tree ; if ( field_desc ) { sub_message_desc = pbw_FieldDescriptor_message_type ( field_desc ) ; if ( sub_message_desc == NULL ) { expert_add_info ( pinfo , ti_field , & et_protobuf_message_type_not_found ) ; } } if ( sub_message_desc ) { dissect_protobuf_message ( tvb , offset , length , pinfo , pbf_as_hf ?pbf_tree : subtree , sub_message_desc , hf_id_ptr ?* hf_id_ptr : - 1 , FALSE , dumper , wmem_packet_scope ( ) , & buf ) ; if ( buf ) { proto_item_append_text ( ti_field , "= %s" , buf ) ; } } if ( hf_id_ptr ) { proto_tree_add_bytes_format_value ( pbf_tree , * hf_id_ptr , tvb , offset , length , NULL , "(%u bytes)" , length ) ; } else { } break ; case PROTOBUF_TYPE_UINT32 : case PROTOBUF_TYPE_FIXED32 : proto_tree_add_uint ( value_tree , hf_protobuf_value_uint32 , tvb , offset , length , ( guint32 ) value ) ; proto_item_append_text ( ti_field , "%s %u" , prepend_text , ( guint32 ) value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%u" , ( guint32 ) value ) ; } if ( hf_id_ptr ) { proto_tree_add_uint ( pbf_tree , * hf_id_ptr , tvb , offset , length , ( guint32 ) value ) ; } if ( field_desc && dumper ) { json_dumper_value_anyf ( dumper , "%u" , ( guint32 ) value ) ; } break ; case PROTOBUF_TYPE_SINT32 : int32_value = sint32_decode ( ( guint32 ) value ) ; proto_tree_add_int ( value_tree , hf_protobuf_value_int32 , tvb , offset , length , int32_value ) ; proto_item_append_text ( ti_field , "%s %d" , prepend_text , int32_value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%d" , int32_value ) ; } if ( hf_id_ptr ) { proto_tree_add_int ( pbf_tree , * hf_id_ptr , tvb , offset , length , int32_value ) ; } if ( field_desc && dumper ) { json_dumper_value_anyf ( dumper , "%d" , int32_value ) ; } break ; case PROTOBUF_TYPE_SINT64 : int64_value = sint64_decode ( value ) ; proto_tree_add_int64 ( value_tree , hf_protobuf_value_int64 , tvb , offset , length , int64_value ) ; proto_item_append_text ( ti_field , "%s %" PRId64 , prepend_text , int64_value ) ; if ( is_top_level ) { col_append_fstr ( pinfo -> cinfo , COL_INFO , "=%" PRId64 , int64_value ) ; } if ( hf_id_ptr ) { proto_tree_add_int64 ( pbf_tree , * hf_id_ptr , tvb , offset , length , int64_value ) ; } break ; default : add_datatype = FALSE ; break ; } if ( field_dissector ) { subtree = field_tree ; if ( ti ) { subtree = proto_item_get_subtree ( ti ) ; if ( ! subtree ) { subtree = proto_item_add_subtree ( ti , ett_protobuf_value ) ; } } call_dissector ( field_dissector , tvb_new_subset_length ( tvb , offset , length ) , pinfo , subtree ) ; } if ( add_datatype ) { proto_item_append_text ( ti_field , " (%s)" , val_to_str ( field_type , protobuf_field_type , "Unknown type (%d)" ) ) ; } } 