static hxge_status_t hxge_add_intrs ( p_hxge_t hxgep ) { int intr_types ; int type = 0 ; int ddi_status = DDI_SUCCESS ; hxge_status_t status = HXGE_OK ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs" ) ) ; hxgep -> hxge_intr_type . intr_registered = B_FALSE ; hxgep -> hxge_intr_type . intr_enabled = B_FALSE ; hxgep -> hxge_intr_type . msi_intx_cnt = 0 ; hxgep -> hxge_intr_type . intr_added = 0 ; hxgep -> hxge_intr_type . niu_msi_enable = B_FALSE ; hxgep -> hxge_intr_type . intr_type = 0 ; if ( hxge_msi_enable ) { hxgep -> hxge_intr_type . niu_msi_enable = B_TRUE ; } if ( ( ddi_status = ddi_intr_get_supported_types ( hxgep -> dip , & intr_types ) ) != DDI_SUCCESS ) { HXGE_ERROR_MSG ( ( hxgep , HXGE_ERR_CTL , "<== hxge_add_intrs: " "ddi_intr_get_supported_types failed: status 0x%08x" , ddi_status ) ) ; return ( HXGE_ERROR | HXGE_DDI_FAILED ) ; } hxgep -> hxge_intr_type . intr_types = intr_types ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "ddi_intr_get_supported_types: 0x%08x" , intr_types ) ) ; switch ( hxge_msi_enable ) { default : type = DDI_INTR_TYPE_FIXED ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "use fixed (intx emulation) type %08x" , type ) ) ; break ; case 2 : HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "ddi_intr_get_supported_types: 0x%08x" , intr_types ) ) ; if ( intr_types & DDI_INTR_TYPE_MSIX ) { type = DDI_INTR_TYPE_MSIX ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "ddi_intr_get_supported_types: MSIX 0x%08x" , type ) ) ; } if ( intr_types & DDI_INTR_TYPE_MSI ) { type = DDI_INTR_TYPE_MSI ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "ddi_intr_get_supported_types: MSI 0x%08x" , type ) ) ; } if ( intr_types & DDI_INTR_TYPE_FIXED ) { type = DDI_INTR_TYPE_FIXED ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "ddi_intr_get_supported_types: MSXED0x%08x" , type ) ) ; } break ; case 1 : if ( intr_types & DDI_INTR_TYPE_MSI ) { type = DDI_INTR_TYPE_MSI ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "ddi_intr_get_supported_types: MSI 0x%08x" , type ) ) ; } if ( intr_types & DDI_INTR_TYPE_MSIX ) { type = DDI_INTR_TYPE_MSIX ; HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "==>hxge_add_intrs: " "ddi_intr_get_supported_types: MSIX 0x%08x" , type ) ) ; } } hxgep -> hxge_intr_type . intr_type = type ; if ( ( type == DDI_INTR_TYPE_MSIX || type == DDI_INTR_TYPE_MSI || type == DDI_INTR_TYPE_FIXED ) && hxgep -> hxge_intr_type . niu_msi_enable ) { if ( ( status = hxge_add_intrs_adv ( hxgep ) ) != DDI_SUCCESS ) { HXGE_ERROR_MSG ( ( hxgep , HXGE_ERR_CTL , " hxge_add_intrs: " " hxge_add_intrs_adv failed: status 0x%08x" , status ) ) ; return ( status ) ; } else { HXGE_DEBUG_MSG ( ( hxgep , DDI_CTL , "==>hxge_add_intrs: " "interrupts registered : type %d" , type ) ) ; hxgep -> hxge_intr_type . intr_registered = B_TRUE ; HXGE_DEBUG_MSG ( ( hxgep , DDI_CTL , "\nAdded advanced hxge add_intr_adv " "intr type 0x%x\n" , type ) ) ; return ( status ) ; } } if ( ! hxgep -> hxge_intr_type . intr_registered ) { HXGE_ERROR_MSG ( ( hxgep , HXGE_ERR_CTL , "==>hxge_add_intrs: failed to register interrupts" ) ) ; return ( HXGE_ERROR | HXGE_DDI_FAILED ) ; } HXGE_DEBUG_MSG ( ( hxgep , INT_CTL , "<== hxge_add_intrs" ) ) ; return ( status ) ; } 