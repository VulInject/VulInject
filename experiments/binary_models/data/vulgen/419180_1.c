static void _process_server_request ( pmixp_base_hdr_t * hdr , buf_t * buf ) { int rc ; switch ( hdr -> type ) { case PMIXP_MSG_FAN_IN : case PMIXP_MSG_FAN_OUT : { pmixp_coll_t * coll ; pmix_proc_t * procs = NULL ; size_t nprocs = 0 ; pmixp_coll_type_t type = 0 ; int c_nodeid ; rc = pmixp_coll_tree_unpack ( buf , & type , & c_nodeid , & procs , & nprocs ) ; if ( SLURM_SUCCESS != rc ) { char * nodename = pmixp_info_job_host ( hdr -> nodeid ) ; PMIXP_ERROR ( "Bad message header from node %s" , nodename ) ; xfree ( nodename ) ; exit } if ( PMIXP_COLL_TYPE_FENCE_TREE != type ) { char * nodename = pmixp_info_job_host ( hdr -> nodeid ) ; PMIXP_ERROR ( "Unexpected collective type=%s from node %s, expected=%s" , pmixp_coll_type2str ( type ) , nodename , pmixp_coll_type2str ( PMIXP_COLL_TYPE_FENCE_TREE ) ) ; xfree ( nodename ) ; exit } coll = pmixp_state_coll_get ( type , procs , nprocs ) ; if ( ! coll ) { PMIXP_ERROR ( "Unable to pmixp_state_coll_get()" ) ; break ; } pmixp_coll_sanity_check ( coll ) ; PMIXP_DEBUG ( "%s collective message from nodeid = %u, type = %s, seq = %d" , pmixp_coll_type2str ( type ) , hdr -> nodeid , ( ( PMIXP_MSG_FAN_IN == hdr -> type ) ?"fan-in" : "fan-out" ) , hdr -> seq ) ; rc = pmixp_coll_check ( coll , hdr -> seq ) ; if ( PMIXP_COLL_REQ_FAILURE == rc ) { char * nodename = pmixp_info_job_host ( hdr -> nodeid ) ; PMIXP_ERROR ( "Bad collective seq. #%d from %s:%u, current is %d" , hdr -> seq , nodename , hdr -> nodeid , coll -> seq ) ; pmixp_debug_hang ( 0 ) ; slurm_kill_job_step ( pmixp_info_jobid ( ) , pmixp_info_stepid ( ) , SIGKILL ) ; xfree ( nodename ) ; break ; } if ( PMIXP_COLL_REQ_SKIP == rc ) { PMIXP_DEBUG ( "Wrong collective seq. #%d from nodeid %u, current is %d, skip this message" , hdr -> seq , hdr -> nodeid , coll -> seq ) ; exit } if ( PMIXP_MSG_FAN_IN == hdr -> type ) { pmixp_coll_tree_child ( coll , hdr -> nodeid , hdr -> seq , buf ) ; } else { pmixp_coll_tree_parent ( coll , hdr -> nodeid , hdr -> seq , buf ) ; } break ; } case PMIXP_MSG_DMDX : { pmixp_dmdx_process ( buf , hdr -> nodeid , hdr -> seq ) ; buf = create_buf ( NULL , 0 ) ; break ; } case PMIXP_MSG_INIT_DIRECT : PMIXP_DEBUG ( "Direct connection init from %d" , hdr -> nodeid ) ; break ; case PMIXP_MSG_PINGPONG : { int msize = remaining_buf ( buf ) ; if ( pmixp_info_nodeid ( ) ) { pmixp_server_pp_send ( 0 , msize ) ; } else { if ( pmixp_server_pp_same_thread ( ) ) { if ( pmixp_server_pp_count ( ) == pmixp_server_pp_warmups ( ) ) { pmixp_server_pp_start ( ) ; } if ( ! pmixp_server_pp_check_fini ( msize ) ) { pmixp_server_pp_send ( 1 , msize ) ; } } } pmixp_server_pp_inc ( ) ; break ; } case PMIXP_MSG_RING : { pmixp_coll_t * coll = NULL ; pmix_proc_t * procs = NULL ; size_t nprocs = 0 ; pmixp_coll_ring_msg_hdr_t ring_hdr ; pmixp_coll_type_t type = 0 ; if ( pmixp_coll_ring_unpack ( buf , & type , & ring_hdr , & procs , & nprocs ) ) { char * nodename = pmixp_info_job_host ( hdr -> nodeid ) ; PMIXP_ERROR ( "Bad message header from node %s" , nodename ) ; xfree ( nodename ) ; exit } if ( PMIXP_COLL_TYPE_FENCE_RING != type ) { char * nodename = pmixp_info_job_host ( hdr -> nodeid ) ; PMIXP_ERROR ( "Unexpected collective type=%s from node %s:%u, expected=%s" , pmixp_coll_type2str ( type ) , nodename , hdr -> nodeid , pmixp_coll_type2str ( PMIXP_COLL_TYPE_FENCE_RING ) ) ; xfree ( nodename ) ; exit } coll = pmixp_state_coll_get ( type , procs , nprocs ) ; xfree ( procs ) ; if ( ! coll ) { PMIXP_ERROR ( "Unable to pmixp_state_coll_get()" ) ; break ; } pmixp_coll_sanity_check ( coll ) ; PMIXP_DEBUG ( "%s collective message from nodeid=%u, contrib_id=%u, seq=%u, hop=%u, msgsize=%lu" , pmixp_coll_type2str ( type ) , hdr -> nodeid , ring_hdr . contrib_id , ring_hdr . seq , ring_hdr . hop_seq , ring_hdr . msgsize ) ; if ( pmixp_coll_ring_check ( coll , & ring_hdr ) ) { char * nodename = pmixp_info_job_host ( hdr -> nodeid ) ; PMIXP_ERROR ( "%p: unexpected contrib from %s:%u, coll->seq=%d, seq=%d" , coll , nodename , hdr -> nodeid , coll -> seq , hdr -> seq ) ; xfree ( nodename ) ; break ; } pmixp_coll_ring_neighbor ( coll , & ring_hdr , buf ) ; break ; } default : PMIXP_ERROR ( "Unknown message type %d" , hdr -> type ) ; break ; } exit FREE_NULL_BUFFER ( buf ) ; } 