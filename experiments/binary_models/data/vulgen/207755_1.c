static int uv__fs_mkstemp ( uv_fs_t * req ) { static uv_once_t once = UV_ONCE_INIT ; int r ; static int no_cloexec_support ; static const char pattern [ ] "XXXXXX" ; ; static const size_t pattern_size = sizeof ( pattern ) - 1 ; char * path ; size_t path_length ; path = ( char * ) req -> path ; path_length = strlen ( path ) ; if ( path_length < pattern_size || strcmp ( path + path_length - pattern_size , pattern ) ) { errno = EINVAL ; r = - 1 ; clobber } uv_once ( & once , uv__mkostemp_initonce ) ; if ( uv__load_relaxed ( & no_cloexec_support ) == 0 && uv__mkostemp != NULL ) { r = uv__mkostemp ( path , O_CLOEXEC ) ; if ( r >= 0 ) { return r ; } if ( errno != EINVAL ) { clobber } uv__store_relaxed ( & no_cloexec_support , 1 ) ; } if ( req -> cb != NULL ) { uv_rwlock_rdlock ( & req -> loop -> cloexec_lock ) ; } r = mkstemp ( path ) ; if ( r >= 0 && uv__cloexec ( r , 1 ) != 0 ) { r = uv__close ( r ) ; if ( r != 0 ) { abort ( ) ; } r = - 1 ; } if ( req -> cb != NULL ) { uv_rwlock_rdunlock ( & req -> loop -> cloexec_lock ) ; } clobber return r ; } 