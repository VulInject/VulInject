struct page * * drm_gem_get_pages ( struct drm_gem_object * obj ) { struct address_space * mapping ; struct page * p , * * pages ; int i , npages ; mapping = obj -> filp -> f_mapping ; WARN_ON ( ( obj -> size & ( PAGE_SIZE - 1 ) ) != 0 ) ; npages = obj -> size >> PAGE_SHIFT ; pages = drm_malloc_ab ( npages , sizeof ( page * ) ) ; for ( i = 0 ; i < npages ; i ++ ) { p = shmem_read_mapping_page ( mapping , i ) ; if ( IS_ERR ( p ) ) { fail } pages [ i ] = p ; BUG_ON ( mapping_gfp_constraint ( mapping , __GFP_DMA32 ) && ( page_to_pfn ( p ) >= 0x00100000UL ) ) ; } return pages ; fail while ( i -- ) { put_page ( pages [ i ] ) ; } drm_free_large ( pages ) ; return ERR_CAST ( p ) ; } 