static int setup_msp_config ( struct snd_pcm_substream * substream , struct snd_soc_dai * dai , struct ux500_msp_config * msp_config ) { struct ux500_msp_i2s_drvdata * drvdata = dev_get_drvdata ( dai -> dev ) ; struct msp_protdesc * prot_desc = & msp_config -> protdesc ; struct snd_pcm_runtime * runtime = substream -> runtime ; unsigned int fmt = drvdata -> fmt ; int ret ; msp_config -> f_inputclk = drvdata -> master_clk ; msp_config -> tx_fifo_config = TX_FIFO_ENABLE ; msp_config -> rx_fifo_config = RX_FIFO_ENABLE ; msp_config -> def_elem_len = 1 ; msp_config -> direction = substream -> stream == SNDRV_PCM_STREAM_PLAYBACK ?MSP_DIR_TX : MSP_DIR_RX ; msp_config -> data_size = MSP_DATA_BITS_32 ; msp_config -> frame_freq = runtime -> rate ; dev_dbg ( dai -> dev , "%s: f_inputclk = %u, frame_freq = %u.\n" , __func__ , msp_config -> f_inputclk , msp_config -> frame_freq ) ; prot_desc -> clocks_per_frame = 1 ; dev_dbg ( dai -> dev , "%s: rate: %u, channels: %d.\n" , __func__ , runtime -> rate , runtime -> channels ) ; switch ( fmt & ( SND_SOC_DAIFMT_FORMAT_MASK | SND_SOC_DAIFMT_MASTER_MASK ) ) { case SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS : dev_dbg ( dai -> dev , "%s: SND_SOC_DAIFMT_I2S.\n" , __func__ ) ; msp_config -> default_protdesc = 1 ; msp_config -> protocol = MSP_I2S_PROTOCOL ; break ; case SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBM_CFM : dev_dbg ( dai -> dev , "%s: SND_SOC_DAIFMT_I2S.\n" , __func__ ) ; msp_config -> data_size = MSP_DATA_BITS_16 ; msp_config -> protocol = MSP_I2S_PROTOCOL ; ret = setup_i2s_protdesc ( prot_desc ) ; if ( ret < 0 ) { return ret ; } break ; case SND_SOC_DAIFMT_DSP_A | SND_SOC_DAIFMT_CBS_CFS : case SND_SOC_DAIFMT_DSP_A | SND_SOC_DAIFMT_CBM_CFM : case SND_SOC_DAIFMT_DSP_B | SND_SOC_DAIFMT_CBS_CFS : case SND_SOC_DAIFMT_DSP_B | SND_SOC_DAIFMT_CBM_CFM : dev_dbg ( dai -> dev , "%s: PCM format.\n" , __func__ ) ; msp_config -> data_size = MSP_DATA_BITS_16 ; msp_config -> protocol = MSP_PCM_PROTOCOL ; ret = setup_pcm_protdesc ( dai , fmt , prot_desc ) ; if ( ret < 0 ) { return ret ; } ret = setup_pcm_multichan ( dai , msp_config ) ; if ( ret < 0 ) { return ret ; } ret = setup_pcm_framing ( dai , runtime -> rate , prot_desc ) ; if ( ret < 0 ) { return ret ; } break ; default : dev_err ( dai -> dev , "%s: Error: Unsupported format (%d)!\n" , __func__ , fmt ) ; return - EINVAL ; } return setup_clocking ( dai , fmt , msp_config ) ; } 