badfile _WM_GLOBAL_ERROR ( __FUNCTION__ , __LINE__ , WM_ERR_CORUPT , "(too short)" , 0 ) ; return ( - 1 ) ; ( ctx , buf , 4 ) ; if ( ! memcmp ( buf , "FORM" , 4 ) ) { len = read4 ( ctx ) ; start = getsrcpos ( ctx ) ; if ( start + 4 > file_size ) { badfile } copy ( ctx , buf , 4 ) ; if ( ! memcmp ( buf , "XMID" , 4 ) ) { _WM_DEBUG_MSG ( "Warning: XMIDI without XDIR" ) ; ctx -> info . tracks = 1 ; } if ( memcmp ( buf , "XDIR" , 4 ) ) { badfile } else { ctx -> info . tracks = 0 ; for ( i = 4 ; i < len ; i ++ ) { if ( getsrcpos ( ctx ) + 10 > file_size ) { break ; } copy ( ctx , buf , 4 ) ; chunk_len = read4 ( ctx ) ; i += 8 ; if ( memcmp ( buf , "INFO" , 4 ) ) { skipsrc ( ctx , ( chunk_len + 1 ) & ~ 1 ) ; i += ( chunk_len + 1 ) & ~ 1 ; continue ; } if ( chunk_len < 2 ) { break ; } ctx -> info . tracks = read2 ( ctx ) ; break ; } seeksrc ( ctx , start + ( ( len + 1 ) & ~ 1 ) ) ; if ( getsrcpos ( ctx ) + 12 > file_size ) { badfile } copy ( ctx , buf , 4 ) ; if ( memcmp ( buf , "CAT " , 4 ) ) { _WM_ERROR_NEW ( "XMI error: expected \"CAT \", found \"%c%c%c%c\"." , buf [ 0 ] , buf [ 1 ] , buf [ 2 ] , buf [ 3 ] ) ; return ( - 1 ) ; } read4 ( ctx ) ; copy ( ctx , buf , 4 ) ; if ( memcmp ( buf , "XMID" , 4 ) ) { _WM_ERROR_NEW ( "XMI error: expected \"XMID\", found \"%c%c%c%c\"." , buf [ 0 ] , buf [ 1 ] , buf [ 2 ] , buf [ 3 ] ) ; return ( - 1 ) ; } ctx -> datastart = getsrcpos ( ctx ) ; return ( 0 ) ; } } return ( - 1 ) ; 