static void wwan_create_default_link ( struct wwan_device * wwandev , u32 def_link_id ) { struct nlattr * tb [ IFLA_MAX + 1 ] , * linkinfo [ IFLA_INFO_MAX + 1 ] ; struct nlattr * data [ IFLA_WWAN_MAX + 1 ] ; struct net_device * dev ; struct nlmsghdr * nlh ; struct sk_buff * msg ; msg = nlmsg_new ( NLMSG_DEFAULT_SIZE , GFP_KERNEL ) ; if ( WARN_ON ( ! msg ) ) { return ; } nlh = nlmsg_put ( msg , 0 , 0 , RTM_NEWLINK , 0 , 0 ) ; if ( WARN_ON ( ! nlh ) ) { free_attrs } if ( nla_put_string ( msg , IFLA_PARENT_DEV_NAME , dev_name ( & wwandev -> dev ) ) ) { free_attrs } tb [ IFLA_LINKINFO ] = nla_nest_start ( msg , IFLA_LINKINFO ) ; if ( ! tb [ IFLA_LINKINFO ] ) { free_attrs } linkinfo [ IFLA_INFO_DATA ] = nla_nest_start ( msg , IFLA_INFO_DATA ) ; if ( ! linkinfo [ IFLA_INFO_DATA ] ) { free_attrs } if ( nla_put_u32 ( msg , IFLA_WWAN_LINK_ID , def_link_id ) ) { free_attrs } nla_nest_end ( msg , linkinfo [ IFLA_INFO_DATA ] ) ; nla_nest_end ( msg , tb [ IFLA_LINKINFO ] ) ; nlmsg_parse_deprecated ( nlh , 0 , tb , IFLA_MAX , NULL , NULL ) ; nla_parse_nested_deprecated ( linkinfo , IFLA_INFO_MAX , tb [ IFLA_LINKINFO ] , NULL , NULL ) ; nla_parse_nested_deprecated ( data , IFLA_WWAN_MAX , linkinfo [ IFLA_INFO_DATA ] , NULL , NULL ) ; rtnl_lock ( ) ; dev = rtnl_create_link ( & init_net , "wwan%d" , NET_NAME_ENUM , & wwan_rtnl_link_ops , tb , NULL ) ; if ( WARN_ON ( IS_ERR ( dev ) ) ) { unlock } if ( WARN_ON ( wwan_rtnl_newlink ( & init_net , dev , tb , data , NULL ) ) ) { free_netdev ( dev ) ; unlock } rtnl_configure_link ( dev , NULL , 0 , NULL ) ; unlock rtnl_unlock ( ) ; free_attrs nlmsg_free ( msg ) ; } 