static M_sql_error_t oracle_cb_fetch ( M_sql_conn_t * conn , M_sql_stmt_t * stmt , char * error , size_t error_size ) { M_sql_driver_stmt_t * dstmt = M_sql_driver_stmt_get_stmt ( stmt ) ; M_sql_driver_conn_t * dconn = M_sql_driver_conn_get_conn ( conn ) ; size_t num_cols ; size_t i ; sword rv ; if ( rv == OCI_NO_DATA ) { oracle_clear_driver_stmt ( dstmt ) ; return M_SQL_ERROR_SUCCESS ; } if ( rv != OCI_SUCCESS ) { oracle_clear_driver_stmt ( dstmt ) ; return oracle_format_error ( "OCIStmtFetch2 failed" , dconn , rv , error , error_size ) ; } num_cols = M_sql_stmt_result_num_cols ( stmt ) ; for ( i = 0 ; i < num_cols ; i ++ ) { M_buf_t * buf = M_sql_driver_stmt_result_col_start ( stmt ) ; if ( dstmt -> result [ i ] . ind == - 1 ) { continue ; } switch ( dstmt -> result [ i ] . type ) { case M_SQL_DATA_TYPE_BOOL : M_buf_add_int ( buf , dstmt -> result [ i ] . d . b . data ) ; break ; case M_SQL_DATA_TYPE_INT16 : M_buf_add_int ( buf , dstmt -> result [ i ] . d . i16 . data ) ; break ; case M_SQL_DATA_TYPE_INT32 : M_buf_add_int ( buf , dstmt -> result [ i ] . d . i32 . data ) ; break ; case M_SQL_DATA_TYPE_INT64 : M_buf_add_int ( buf , dstmt -> result [ i ] . d . i64 . data ) ; break ; case M_SQL_DATA_TYPE_TEXT : if ( dstmt -> result [ i ] . type_size == 0 || dstmt -> result [ i ] . type_size > sizeof ( dstmt -> result [ i ] . d . smalltext . data ) ) { dstmt -> result [ i ] . d . text . written_len += dstmt -> result [ i ] . d . text . last_len ; M_buf_add_bytes ( buf , ( M_uint8 * ) dstmt -> result [ i ] . d . text . data , dstmt -> result [ i ] . d . text . written_len ) ; break ; } M_buf_add_bytes ( buf , ( M_uint8 * ) dstmt -> result [ i ] . d . smalltext . data , dstmt -> result [ i ] . d . smalltext . len ) ; break ; case M_SQL_DATA_TYPE_BINARY : if ( dstmt -> result [ i ] . type_size == 0 || dstmt -> result [ i ] . type_size > sizeof ( dstmt -> result [ i ] . d . smallbinary . data ) ) { dstmt -> result [ i ] . d . binary . written_len += dstmt -> result [ i ] . d . binary . last_len ; M_buf_add_bytes ( buf , ( M_uint8 * ) dstmt -> result [ i ] . d . binary . data , dstmt -> result [ i ] . d . binary . written_len ) ; break ; } M_buf_add_bytes ( buf , ( M_uint8 * ) dstmt -> result [ i ] . d . smallbinary . data , dstmt -> result [ i ] . d . smallbinary . len ) ; break ; default : M_snprintf ( error , error_size , "unhandled column %zu" , i ) ; return M_SQL_ERROR_QUERY_FAILURE ; } M_buf_add_byte ( buf , 0 ) ; } M_sql_driver_stmt_result_row_finish ( stmt ) ; return M_SQL_ERROR_SUCCESS_ROW ; } 