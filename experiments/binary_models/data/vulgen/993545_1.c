printk ( "cm0: IP identification: %02x%02x  fragment offset: %02x%02x\n" , buffer [ 30 ] , buffer [ 31 ] , buffer [ 32 ] , buffer [ 33 ] ) ; if ( buffer [ 0 ] != NewDatagramHeaderSkip ) { if ( sb1000_debug > 1 ) { printk ( KERN_WARNING "%s: new datagram header skip error: " "got %02x expecting %02x\n" , dev -> name , buffer [ 0 ] , NewDatagramHeaderSkip ) ; } stats -> rx_length_errors ++ ; insw ( ioaddr , buffer , NewDatagramDataSize / 2 ) ; bad_frame_next } dlen = ( ( buffer [ NewDatagramHeaderSkip + 3 ] & 0x0f ) << 8 | buffer [ NewDatagramHeaderSkip + 4 ] ) - 17 ; if ( dlen > SB1000_MRU ) { if ( sb1000_debug > 1 ) { printk ( KERN_WARNING "%s: datagram length (%d) greater " "than MRU (%d)\n" , dev -> name , dlen , SB1000_MRU ) ; } stats -> rx_length_errors ++ ; insw ( ioaddr , buffer , NewDatagramDataSize / 2 ) ; bad_frame_next } lp -> rx_dlen [ ns ] = dlen ; skbsize = dlen + FrameSize ; if ( ( skb = alloc_skb ( skbsize , GFP_ATOMIC ) ) == NULL ) { if ( sb1000_debug > 1 ) { printk ( KERN_WARNING "%s: can't allocate %d bytes long " "skbuff\n" , dev -> name , skbsize ) ; } stats -> rx_dropped ++ ; insw ( ioaddr , buffer , NewDatagramDataSize / 2 ) ; dropped_frame } skb -> dev = dev ; skb_reset_mac_header ( skb ) ; skb -> protocol = ( unsigned short ) buffer [ NewDatagramHeaderSkip + 16 ] ; insw ( ioaddr , skb_put ( skb , NewDatagramDataSize ) , NewDatagramDataSize / 2 ) ; lp -> rx_skb [ ns ] = skb ; { insw ( ioaddr , buffer , ContDatagramHeaderSize / 2 ) ; if ( buffer [ 0 ] != ContDatagramHeaderSkip ) { if ( sb1000_debug > 1 ) { printk ( KERN_WARNING "%s: cont datagram header skip error: " "got %02x expecting %02x\n" , dev -> name , buffer [ 0 ] , ContDatagramHeaderSkip ) ; } stats -> rx_length_errors ++ ; insw ( ioaddr , buffer , ContDatagramDataSize / 2 ) ; bad_frame_next } skb = lp -> rx_skb [ ns ] ; insw ( ioaddr , skb_put ( skb , ContDatagramDataSize ) , ContDatagramDataSize / 2 ) ; dlen = lp -> rx_dlen [ ns ] ; } if ( skb -> len < dlen + TrailerSize ) { lp -> rx_session_id [ ns ] &= ~ 0x40 ; return 0 ; } skb_trim ( skb , dlen ) ; netif_rx ( skb ) ; stats -> rx_bytes += dlen ; stats -> rx_packets ++ ; lp -> rx_skb [ ns ] = NULL ; lp -> rx_session_id [ ns ] |= 0x40 ; return 0 ; bad_frame insw ( ioaddr , buffer , FrameSize / 2 ) ; if ( sb1000_debug > 1 ) { printk ( KERN_WARNING "%s: frame error: got %02x %02x\n" , dev -> name , st [ 0 ] , st [ 1 ] ) ; } stats -> rx_frame_errors ++ ; bad_frame_next if ( sb1000_debug > 2 ) { sb1000_print_status_buffer ( dev -> name , st , buffer , FrameSize ) ; } dropped_frame stats -> rx_errors ++ ; return - 1 ; 