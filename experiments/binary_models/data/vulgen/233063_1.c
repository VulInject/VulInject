static int dma_port_read ( struct tb_ctl * ctl , void * buffer , u64 route , u32 port , u32 offset , u32 length , int timeout_msec ) { struct cfg_read_pkg request = { . header = tb_cfg_make_header ( route ) . addr = { . seq = 1 . port = port . space = TB_CFG_PORT . offset = offset . length = length } } ; struct tb_cfg_request * req ; struct cfg_write_pkg reply ; struct tb_cfg_result res ; req = tb_cfg_request_alloc ( ) ; req -> match = dma_port_match ; req -> copy = dma_port_copy ; req -> request = & request ; req -> request_size = sizeof ( request ) ; req -> request_type = TB_CFG_PKG_READ ; req -> response = & reply ; req -> response_size = 12 + 4 * length ; req -> response_type = TB_CFG_PKG_READ ; res = tb_cfg_request_sync ( ctl , req , timeout_msec ) ; tb_cfg_request_put ( req ) ; if ( res . err ) { return res . err ; } memcpy ( buffer , & reply . data , 4 * length ) ; return 0 ; } 