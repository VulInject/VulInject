static int vips_smartcrop_attention ( VipsSmartcrop * smartcrop , VipsImage * in , int * left , int * top ) { static double skin_vector [ ] { - 0.78 - 0.57 - 0.44 } ; ; static double ones [ ] { 1.0 1.0 1.0 } ; ; VipsImage * * t = ( VipsImage * * ) vips_object_local_array ( VIPS_OBJECT ( smartcrop ) , 24 ) ; double hscale ; double vscale ; double sigma ; double max ; int x_pos ; int y_pos ; hscale = 32.0 / in -> Xsize ; vscale = 32.0 / in -> Ysize ; if ( vips_resize ( in , & t [ 17 ] , hscale , "vscale" , vscale , NULL ) ) { return ( - 1 ) ; } if ( ! ( t [ 21 ] = vips_image_new_matrixv ( 3 , 3 , 0.0 , - 1.0 , 0.0 , - 1.0 , 4.0 , - 1.0 , 0.0 , - 1.0 , 0.0 ) ) ) { return ( - 1 ) ; } if ( vips_colourspace ( t [ 17 ] , & t [ 0 ] , VIPS_INTERPRETATION_XYZ , NULL ) || vips_extract_band ( t [ 0 ] , & t [ 1 ] , 0 , "n" , 3 , NULL ) ) { return ( - 1 ) ; } if ( vips_extract_band ( t [ 1 ] , & t [ 2 ] , 1 , NULL ) || vips_conv ( t [ 2 ] , & t [ 3 ] , t [ 21 ] , "precision" , VIPS_PRECISION_INTEGER , NULL ) || vips_linear1 ( t [ 3 ] , & t [ 4 ] , 5.0 , 0.0 , NULL ) || vips_abs ( t [ 4 ] , & t [ 14 ] , NULL ) ) { return ( - 1 ) ; } if ( pythagoras ( smartcrop , t [ 1 ] , & t [ 5 ] ) || vips_divide ( t [ 1 ] , t [ 5 ] , & t [ 6 ] , NULL ) || vips_linear ( t [ 6 ] , & t [ 7 ] , ones , skin_vector , 3 , NULL ) || pythagoras ( smartcrop , t [ 7 ] , & t [ 8 ] ) || vips_linear1 ( t [ 8 ] , & t [ 9 ] , - 100.0 , 100.0 , NULL ) || vips_more_const1 ( t [ 2 ] , & t [ 10 ] , 5.0 , NULL ) || ! ( t [ 11 ] = vips_image_new_from_image1 ( t [ 10 ] , 0.0 ) ) || vips_ifthenelse ( t [ 10 ] , t [ 9 ] , t [ 11 ] , & t [ 15 ] , NULL ) ) { return ( - 1 ) ; } if ( vips_colourspace ( t [ 1 ] , & t [ 12 ] , VIPS_INTERPRETATION_LAB , NULL ) || vips_extract_band ( t [ 12 ] , & t [ 13 ] , 1 , NULL ) || vips_ifthenelse ( t [ 10 ] , t [ 13 ] , t [ 11 ] , & t [ 16 ] , NULL ) ) { return ( - 1 ) ; } if ( vips_sum ( & t [ 14 ] , & t [ 18 ] , 3 , NULL ) || vips_gaussblur ( t [ 18 ] , & t [ 19 ] , sigma , NULL ) || vips_max ( t [ 19 ] , & max , "x" , & x_pos , "y" , & y_pos , NULL ) ) { return ( - 1 ) ; } * left = VIPS_CLIP ( 0 , x_pos / hscale - smartcrop -> width / 2 , in -> Xsize - smartcrop -> width ) ; * top = VIPS_CLIP ( 0 , y_pos / vscale - smartcrop -> height / 2 , in -> Ysize - smartcrop -> height ) ; return ( 0 ) ; } 