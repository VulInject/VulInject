static void pp_ping ( unsigned long ctx ) { struct pp_ctx * pp = ( void * ) ctx ; unsigned long irqflags ; u64 db_bits , db_mask ; u32 spad_rd , spad_wr ; spin_lock_irqsave ( & pp -> db_lock , irqflags ) ; { db_mask = ntb_db_valid_mask ( pp -> ntb ) ; db_bits = ntb_db_read ( pp -> ntb ) ; if ( db_bits ) { dev_dbg ( & pp -> ntb -> dev , "Masked pongs %#llx\n" , db_bits ) ; ntb_db_clear ( pp -> ntb , db_bits ) ; } db_bits = ( ( pp -> db_bits | db_bits ) << 1 ) & db_mask ; if ( ! db_bits ) { db_bits = db_init ; } spad_rd = ntb_spad_read ( pp -> ntb , 0 ) ; spad_wr = spad_rd + 1 ; dev_dbg ( & pp -> ntb -> dev , "Ping bits %#llx read %#x write %#x\n" , db_bits , spad_rd , spad_wr ) ; ntb_peer_spad_write ( pp -> ntb , 0 , spad_wr ) ; ntb_peer_db_set ( pp -> ntb , db_bits ) ; ntb_db_clear_mask ( pp -> ntb , db_mask ) ; } spin_unlock_irqrestore ( & pp -> db_lock , irqflags ) ; } 