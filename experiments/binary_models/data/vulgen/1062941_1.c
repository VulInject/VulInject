static struct ospf6_lsa * ospf6_lsa_translated_nssa_new ( struct ospf6_area * area , struct ospf6_lsa * type7 ) { char buffer [ OSPF6_MAX_LSASIZE ] ; struct ospf6_lsa * lsa ; struct ospf6_as_external_lsa * ext , * extnew ; struct ospf6_lsa_header * lsa_header ; caddr_t old_ptr , new_ptr ; struct ospf6_as_external_lsa * nssa ; struct prefix prefix ; struct ospf6 * ospf6 = area -> ospf6 ; ptrdiff_t tag_offset = 0 ; route_tag_t network_order ; struct ospf6_route * range ; if ( IS_OSPF6_DEBUG_NSSA ) { zlog_debug ( "%s : Start" , __func__ ) ; } nssa = ( ospf6_as_external_lsa * ) OSPF6_LSA_HEADER_END ( type7 -> header ) ; prefix . family = AF_INET6 ; prefix . prefixlen = nssa -> prefix . prefix_length ; ospf6_prefix_in6_addr ( & prefix . u . prefix6 , nssa , & nssa -> prefix ) ; range = ospf6_route_lookup_bestmatch ( & prefix , area -> nssa_range_table ) ; if ( range && ! prefix_same ( & prefix , & range -> prefix ) && ! CHECK_FLAG ( range -> flag , OSPF6_ROUTE_REMOVE ) ) { if ( IS_OSPF6_DEBUG_NSSA ) { zlog_debug ( "%s: LSA %s suppressed by range %pFX of area %s" , __func__ , type7 -> name , & range -> prefix , area -> name ) ; } return NULL ; } memset ( buffer , 0 , sizeof ( buffer ) ) ; lsa_header = ( ospf6_lsa_header * ) buffer ; extnew = ( ospf6_as_external_lsa * ) ( ( caddr_t ) lsa_header + sizeof ( ospf6_lsa_header ) ) ; ext = ( ospf6_as_external_lsa * ) ( ( caddr_t ) ( type7 -> header ) + sizeof ( ospf6_lsa_header ) ) ; old_ptr = ( caddr_t ) ( ( caddr_t ) ext + sizeof ( ospf6_as_external_lsa ) ) ; new_ptr = ( caddr_t ) ( ( caddr_t ) extnew + sizeof ( ospf6_as_external_lsa ) ) ; memcpy ( extnew , ext , sizeof ( ospf6_as_external_lsa ) ) ; memcpy ( new_ptr , old_ptr , OSPF6_PREFIX_SPACE ( ext -> prefix . prefix_length ) ) ; ospf6_prefix_apply_mask ( & extnew -> prefix ) ; new_ptr += OSPF6_PREFIX_SPACE ( extnew -> prefix . prefix_length ) ; tag_offset = sizeof ( * ext ) + OSPF6_PREFIX_SPACE ( ext -> prefix . prefix_length ) ; if ( CHECK_FLAG ( ext -> bits_metric , OSPF6_ASBR_BIT_F ) ) { memcpy ( new_ptr , ( caddr_t ) ext + tag_offset , sizeof ( in6_addr ) ) ; new_ptr += sizeof ( in6_addr ) ; tag_offset += sizeof ( in6_addr ) ; } if ( CHECK_FLAG ( ext -> bits_metric , OSPF6_ASBR_BIT_T ) ) { memcpy ( & network_order , ( caddr_t ) ext + tag_offset , sizeof ( network_order ) ) ; network_order = htonl ( network_order ) ; memcpy ( new_ptr , & network_order , sizeof ( network_order ) ) ; new_ptr += sizeof ( network_order ) ; } lsa_header -> age = 0 ; lsa_header -> type = htons ( OSPF6_LSTYPE_AS_EXTERNAL ) ; lsa_header -> id = htonl ( ospf6 -> external_id ) ; ospf6 -> external_id ++ ; lsa_header -> adv_router = ospf6 -> router_id ; lsa_header -> seqnum = ospf6_new_ls_seqnum ( lsa_header -> type , lsa_header -> id , lsa_header -> adv_router , ospf6 -> lsdb ) ; lsa_header -> length = htons ( ( caddr_t ) new_ptr - ( caddr_t ) lsa_header ) ; type7 -> external_lsa_id = lsa_header -> id ; ospf6_lsa_checksum ( lsa_header ) ; lsa = ospf6_lsa_create ( lsa_header ) ; SET_FLAG ( lsa -> flag , OSPF6_LSA_LOCAL_XLT ) ; UNSET_FLAG ( lsa -> flag , OSPF6_LSA_UNAPPROVED ) ; ospf6_lsa_originate_process ( lsa , ospf6 ) ; if ( IS_OSPF6_DEBUG_NSSA ) { zlog_debug ( "%s: Originated type5 LSA id %pI4" , __func__ , & lsa_header -> id ) ; } return lsa ; } 