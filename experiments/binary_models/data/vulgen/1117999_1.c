static void php_fsockopen_stream ( INTERNAL_FUNCTION_PARAMETERS , int persistent ) { char * host ; size_t host_len ; zend_long port = - 1 ; zval * zerrno = NULL , * zerrstr = NULL ; double timeout ; bool timeout_is_null = 1 ; time_t conv ; long conv ; struct timeval tv ; char * hashkey = NULL ; php_stream * stream = NULL ; int err ; char * hostname = NULL ; size_t hostname_len ; zend_string * errstr = NULL ; ZEND_PARSE_PARAMETERS_START ( 1 , 5 ) Z_PARAM_STRING ( , ) Z_PARAM_OPTIONAL Z_PARAM_LONG ( port ) Z_PARAM_ZVAL ( zerrno ) Z_PARAM_ZVAL ( zerrstr ) Z_PARAM_DOUBLE_OR_NULL ( timeout , timeout_is_null ) ZEND_PARSE_PARAMETERS_END ( ) ; RETVAL_FALSE ; if ( timeout_is_null ) { timeout = ( double ) FG ( default_socket_timeout ) ; } if ( persistent ) { spprintf ( & hashkey , 0 , "pfsockopen__%s:" ZEND_LONG_FMT , host , port ) ; } if ( port > 0 ) { hostname_len = spprintf ( & hostname , 0 , "%s:" ZEND_LONG_FMT , host , port ) ; } else { hostname_len = host_len ; hostname = host ; } conv = ( time_t ) ( timeout * 1000000.0 ) ; tv . tv_sec = conv / 1000000 ; conv = ( long ) ( timeout * 1000000.0 ) ; tv . tv_sec = conv / 1000000 ; tv . tv_usec = conv % 1000000 ; stream = php_stream_xport_create ( hostname , hostname_len , REPORT_ERRORS , STREAM_XPORT_CLIENT | STREAM_XPORT_CONNECT , hashkey , & tv , NULL , & errstr , & err ) ; if ( port > 0 ) { zend_string_release_ex ( errstr , 0 ) ; } if ( stream == NULL ) { php_error_docref ( NULL , E_WARNING , "Unable to connect to %s:" ZEND_LONG_FMT " (%s)" , host , port , errstr == NULL ?"Unknown error" : ZSTR_VAL ( errstr ) ) ; } if ( hashkey ) { efree ( hashkey ) ; } if ( stream == NULL ) { if ( zerrno ) { ZEND_TRY_ASSIGN_REF_LONG ( zerrno , err ) ; } if ( errstr ) { if ( zerrstr ) { ZEND_TRY_ASSIGN_REF_STR ( zerrstr , errstr ) ; } else { zend_string_release ( errstr ) ; } } RETURN_FALSE ; } if ( zerrno ) { ZEND_TRY_ASSIGN_REF_LONG ( zerrno , 0 ) ; } if ( zerrstr ) { ZEND_TRY_ASSIGN_REF_EMPTY_STRING ( zerrstr ) ; } if ( errstr ) { zend_string_release_ex ( errstr , 0 ) ; } php_stream_to_zval ( stream , return_value ) ; } 