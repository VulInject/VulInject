SDB_API const char * sdb_const_get_len ( Sdb * s , const char * key , int * vlen , ut32 * cas ) { ut32 pos , len ; ut64 now = 0LL ; bool found ; if ( cas ) { * cas = 0 ; } if ( vlen ) { * vlen = 0 ; } size_t keylen = strlen ( key ) ; if ( s -> ht ) { SdbKv * kv = ( SdbKv * ) sdb_ht_find_kvp ( s -> ht , key , & found ) ; if ( found ) { if ( ! sdbkv_value ( kv ) || ! * sdbkv_value ( kv ) ) { return NULL ; } if ( s -> timestamped && kv -> expire ) { if ( ! now ) { now = sdb_now ( ) ; } if ( now > kv -> expire ) { sdb_unset ( s , key , 0 ) ; return NULL ; } } if ( cas ) { * cas = kv -> cas ; } if ( vlen ) { * vlen = sdbkv_value_len ( kv ) ; } return sdbkv_value ( kv ) ; } } if ( s -> gp && s -> gp -> get ) { return s -> gp -> get ( key ) ; } if ( s -> fd == - 1 ) { return NULL ; } ( void ) cdb_findstart ( & s -> db ) ; if ( ! s -> ht || cdb_findnext ( & s -> db , s -> ht -> opt . hashfn ( key ) , key , keylen ) < 1 ) { return NULL ; } len = cdb_datalen ( & s -> db ) ; if ( len < SDB_MIN_VALUE || len >= SDB_MAX_VALUE ) { return NULL ; } if ( vlen ) { * vlen = len ; } pos = cdb_datapos ( & s -> db ) ; return s -> db . map + pos ; } 