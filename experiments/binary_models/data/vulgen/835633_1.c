int qla4xxx_abort_task ( struct scsi_qla_host * ha , struct srb * srb ) { uint32_t mbox_cmd [ MBOX_REG_COUNT ] ; uint32_t mbox_sts [ MBOX_REG_COUNT ] ; struct scsi_cmnd * cmd = srb -> cmd ; int status = QLA_SUCCESS ; unsigned long flags ; uint32_t index ; memset ( & mbox_cmd , 0 , sizeof ( mbox_cmd ) ) ; memset ( & mbox_sts , 0 , sizeof ( mbox_sts ) ) ; spin_lock_irqsave ( & ha -> hardware_lock , flags ) ; index = ( unsigned long ) ( unsigned char * ) cmd -> host_scribble ; spin_unlock_irqrestore ( & ha -> hardware_lock , flags ) ; if ( index == MAX_SRBS ) { return status ; } mbox_cmd [ 0 ] = MBOX_CMD_ABORT_TASK ; mbox_cmd [ 1 ] = srb -> ddb -> fw_ddb_index ; mbox_cmd [ 2 ] = index ; mbox_cmd [ 5 ] = 0x01 ; qla4xxx_mailbox_command ( ha , MBOX_REG_COUNT , 5 , & mbox_cmd [ 0 ] , & mbox_sts [ 0 ] ) ; if ( mbox_sts [ 0 ] != MBOX_STS_COMMAND_COMPLETE ) { status = QLA_ERROR ; DEBUG2 ( printk ( KERN_WARNING "scsi%ld:%d:%llu: abort task FAILED: " "mbx0=%04X, mb1=%04X, mb2=%04X, mb3=%04X, mb4=%04X\n" , ha -> host_no , cmd -> device -> id , cmd -> device -> lun , mbox_sts [ 0 ] , mbox_sts [ 1 ] , mbox_sts [ 2 ] , mbox_sts [ 3 ] , mbox_sts [ 4 ] ) ) ; } return status ; } 