static mrb_value method_super_method ( mrb_state * mrb , mrb_value self ) { mrb_value recv = mrb_iv_get ( mrb , self , MRB_SYM ( _recv ) ) ; mrb_value klass = mrb_iv_get ( mrb , self , MRB_SYM ( _klass ) ) ; mrb_value owner = mrb_iv_get ( mrb , self , MRB_SYM ( _owner ) ) ; mrb_value name = mrb_iv_get ( mrb , self , MRB_SYM ( _name ) ) ; struct RClass * super , * rklass ; struct RProc * proc ; struct RObject * me ; switch ( mrb_type ( klass ) ) { case MRB_TT_SCLASS : super = mrb_class_ptr ( klass ) -> super -> super ; break ; case MRB_TT_ICLASS : super = mrb_class_ptr ( klass ) -> super ; break ; default : super = mrb_class_ptr ( owner ) -> super ; break ; } proc = method_search_vm ( mrb , & super , mrb_symbol ( name ) ) ; rklass = super ; while ( super -> tt == MRB_TT_ICLASS ) { super = super -> c ; } me = method_object_alloc ( mrb , mrb_obj_class ( mrb , self ) ) ; mrb_obj_iv_set ( mrb , me , MRB_SYM ( _owner ) , mrb_obj_value ( super ) ) ; mrb_obj_iv_set ( mrb , me , MRB_SYM ( _recv ) , recv ) ; mrb_obj_iv_set ( mrb , me , MRB_SYM ( _name ) , name ) ; mrb_obj_iv_set ( mrb , me , MRB_SYM ( _proc ) , mrb_obj_value ( proc ) ) ; mrb_obj_iv_set ( mrb , me , MRB_SYM ( _klass ) , mrb_obj_value ( rklass ) ) ; return mrb_obj_value ( me ) ; } 