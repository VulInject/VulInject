static u64 new_context ( struct mm_struct * mm , unsigned int cpu ) { static u32 cur_idx = 1 ; u64 asid = atomic64_read ( & mm -> context . id ) ; u64 generation = atomic64_read ( & asid_generation ) ; if ( asid != 0 ) { u64 newasid = generation | ( asid & ~ ASID_MASK ) ; if ( check_update_reserved_asid ( asid , newasid ) ) { return newasid ; } asid &= ~ ASID_MASK ; if ( ! __test_and_set_bit ( asid , asid_map ) ) { return newasid ; } } asid = find_next_zero_bit ( asid_map , NUM_USER_ASIDS , cur_idx ) ; if ( asid != NUM_USER_ASIDS ) { set_asid } flush_context ( cpu ) ; asid = find_next_zero_bit ( asid_map , NUM_USER_ASIDS , 1 ) ; set_asid __set_bit ( asid , asid_map ) ; cur_idx = asid ; return asid | generation ; } 