static DnsStream * dns_stream_free ( DnsStream * s ) { DnsPacket * p ; assert ( s ) ; dns_stream_stop ( s ) ; if ( s -> manager ) { LIST_REMOVE ( streams , s -> manager -> dns_streams , s ) ; s -> manager -> n_dns_streams [ s -> type ] -- ; } if ( s -> encrypted ) { dnstls_stream_free ( s ) ; } ORDERED_SET_FOREACH ( , ) dns_packet_unref ( ordered_set_remove ( s -> write_queue , p ) ) ; dns_packet_unref ( s -> write_packet ) ; dns_packet_unref ( s -> read_packet ) ; ordered_set_free ( s -> write_queue ) ; return mfree ( s ) ; } 