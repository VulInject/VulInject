BOOL winpr_InitOnceExecuteOnce ( PINIT_ONCE InitOnce , PINIT_ONCE_FN InitFn , PVOID Parameter , LPVOID * Context ) { for ( ; ; ) { switch ( ( ULONG_PTR ) InitOnce -> Ptr & 3 ) { case 2 : return TRUE ; case 0 : if ( InterlockedCompareExchangePointer ( & InitOnce -> Ptr , ( PVOID ) 1 , ( PVOID ) 0 ) != ( PVOID ) 0 ) { break ; } if ( InitFn ( InitOnce , Parameter , Context ) ) { return TRUE ; } InitOnce -> Ptr = ( PVOID ) 0 ; return FALSE ; case 1 : break ; default : WLog_ERR ( TAG , "internal error" ) ; return FALSE ; } Sleep ( 5 ) ; } } 