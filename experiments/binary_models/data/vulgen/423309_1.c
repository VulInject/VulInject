static ssize_t dccpprobe_read ( struct file * file , char __user * buf , size_t len , loff_t * ppos ) { int error = 0 , cnt = 0 ; unsigned char * tbuf ; if ( ! buf ) { return - EINVAL ; } tbuf = vmalloc ( len ) ; if ( ! tbuf ) { return - ENOMEM ; } error = wait_event_interruptible ( dccpw . wait , kfifo_len ( & dccpw . fifo ) != 0 ) ; if ( error ) { out_free } cnt = kfifo_out_locked ( & dccpw . fifo , tbuf , len , & dccpw . lock ) ; error = copy_to_user ( buf , tbuf , cnt ) ?- EFAULT : 0 ; out_free vfree ( tbuf ) ; return error ?error : cnt ; } 