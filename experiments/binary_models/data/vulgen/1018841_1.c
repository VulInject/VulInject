static void autofs4_notify_daemon ( struct autofs_sb_info * sbi , struct autofs_wait_queue * wq , int type ) { { struct autofs_packet_hdr hdr ; union autofs_packet_union v4_pkt ; union autofs_v5_packet_union v5_pkt ; } , pkt struct file * pipe = NULL ; size_t pktsz ; pr_debug ( "wait id = 0x%08lx, name = %.*s, type=%d\n" , ( unsigned long ) wq -> wait_queue_token , wq -> name . len , wq -> name . name , type ) ; pkt . hdr . proto_version = sbi -> version ; pkt . hdr . type = type ; switch ( type ) { case autofs_ptype_missing : { struct autofs_packet_missing * mp = & pkt . v4_pkt . missing ; pktsz = sizeof ( * mp ) ; mp -> wait_queue_token = wq -> wait_queue_token ; mp -> len = wq -> name . len ; memcpy ( mp -> name , wq -> name . name , wq -> name . len ) ; mp -> name [ wq -> name . len ] = '\0' ; break ; } case autofs_ptype_expire_multi : { struct autofs_packet_expire_multi * ep = & pkt . v4_pkt . expire_multi ; pktsz = sizeof ( * ep ) ; ep -> wait_queue_token = wq -> wait_queue_token ; ep -> len = wq -> name . len ; memcpy ( ep -> name , wq -> name . name , wq -> name . len ) ; ep -> name [ wq -> name . len ] = '\0' ; break ; } case autofs_ptype_missing_indirect : case autofs_ptype_expire_indirect : case autofs_ptype_missing_direct : case autofs_ptype_expire_direct : { struct autofs_v5_packet * packet = & pkt . v5_pkt . v5_packet ; struct user_namespace * user_ns = sbi -> pipe -> f_cred -> user_ns ; pktsz = sizeof ( * packet ) ; packet -> wait_queue_token = wq -> wait_queue_token ; packet -> len = wq -> name . len ; memcpy ( packet -> name , wq -> name . name , wq -> name . len ) ; packet -> name [ wq -> name . len ] = '\0' ; packet -> dev = wq -> dev ; packet -> ino = wq -> ino ; packet -> uid = from_kuid_munged ( user_ns , wq -> uid ) ; packet -> gid = from_kgid_munged ( user_ns , wq -> gid ) ; packet -> pid = wq -> pid ; packet -> tgid = wq -> tgid ; break ; } default : pr_warn ( "bad type %d!\n" , type ) ; mutex_unlock ( & sbi -> wq_mutex ) ; return ; } pipe = get_file ( sbi -> pipe ) ; mutex_unlock ( & sbi -> wq_mutex ) ; if ( autofs4_write ( sbi , pipe , & pkt , pktsz ) ) { autofs4_catatonic_mode ( sbi ) ; } fput ( pipe ) ; } 