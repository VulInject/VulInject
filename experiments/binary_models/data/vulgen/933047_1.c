void apollo_chip_map ( struct pciide_softc * sc , struct pci_attach_args * pa ) { struct pciide_channel * cp ; pcireg_t interface ; int no_ideconf = 0 , channel ; u_int32_t ideconf ; bus_size_t cmdsize , ctlsize ; pcitag_t tag ; pcireg_t id , class ; if ( PCI_SUBCLASS ( pa -> pa_class ) == PCI_SUBCLASS_MASS_STORAGE_IDE ) { interface = PCI_INTERFACE ( pa -> pa_class ) ; } else { interface = PCIIDE_INTERFACE_BUS_MASTER_DMA | PCIIDE_INTERFACE_PCI ( 0 ) | PCIIDE_INTERFACE_PCI ( 1 ) ; } switch ( PCI_PRODUCT ( pa -> pa_id ) ) { case PCI_PRODUCT_VIATECH_VT6410 : case PCI_PRODUCT_VIATECH_VT6415 : no_ideconf = 1 ; case PCI_PRODUCT_VIATECH_CX700_IDE : case PCI_PRODUCT_VIATECH_VX700_IDE : case PCI_PRODUCT_VIATECH_VX855_IDE : case PCI_PRODUCT_VIATECH_VX900_IDE : printf ( ": ATA133" ) ; sc -> sc_wdcdev . UDMA_cap = 6 ; break ; default : tag = pci_make_tag ( pa -> pa_pc , pa -> pa_bus , pa -> pa_device , 0 ) ; id = pci_conf_read ( sc -> sc_pc , tag , PCI_ID_REG ) ; class = pci_conf_read ( sc -> sc_pc , tag , PCI_CLASS_REG ) ; if ( PCI_CLASS ( class ) != PCI_CLASS_BRIDGE && pa -> pa_device == 15 ) { tag = pci_make_tag ( pa -> pa_pc , pa -> pa_bus , 17 , 0 ) ; id = pci_conf_read ( sc -> sc_pc , tag , PCI_ID_REG ) ; class = pci_conf_read ( sc -> sc_pc , tag , PCI_CLASS_REG ) ; } switch ( PCI_PRODUCT ( id ) ) { case PCI_PRODUCT_VIATECH_VT82C586_ISA : if ( PCI_REVISION ( class ) >= 0x02 ) { printf ( ": ATA33" ) ; sc -> sc_wdcdev . UDMA_cap = 2 ; } else { printf ( ": DMA" ) ; sc -> sc_wdcdev . UDMA_cap = 0 ; } break ; case PCI_PRODUCT_VIATECH_VT82C596A : if ( PCI_REVISION ( class ) >= 0x12 ) { printf ( ": ATA66" ) ; sc -> sc_wdcdev . UDMA_cap = 4 ; } else { printf ( ": ATA33" ) ; sc -> sc_wdcdev . UDMA_cap = 2 ; } break ; case PCI_PRODUCT_VIATECH_VT82C686A_ISA : if ( PCI_REVISION ( class ) >= 0x40 ) { printf ( ": ATA100" ) ; sc -> sc_wdcdev . UDMA_cap = 5 ; } else { printf ( ": ATA66" ) ; sc -> sc_wdcdev . UDMA_cap = 4 ; } break ; case PCI_PRODUCT_VIATECH_VT8231_ISA : case PCI_PRODUCT_VIATECH_VT8233_ISA : printf ( ": ATA100" ) ; sc -> sc_wdcdev . UDMA_cap = 5 ; break ; case PCI_PRODUCT_VIATECH_VT8233A_ISA : case PCI_PRODUCT_VIATECH_VT8235_ISA : case PCI_PRODUCT_VIATECH_VT8237_ISA : printf ( ": ATA133" ) ; sc -> sc_wdcdev . UDMA_cap = 6 ; break ; default : printf ( ": DMA" ) ; sc -> sc_wdcdev . UDMA_cap = 0 ; break ; } break ; } pciide_mapreg_dma ( sc , pa ) ; sc -> sc_wdcdev . cap |= WDC_CAPABILITY_DATA16 | WDC_CAPABILITY_DATA32 | WDC_CAPABILITY_MODE ; if ( sc -> sc_dma_ok ) { sc -> sc_wdcdev . cap |= WDC_CAPABILITY_DMA | WDC_CAPABILITY_IRQACK ; sc -> sc_wdcdev . irqack = pciide_irqack ; if ( sc -> sc_wdcdev . UDMA_cap > 0 ) { sc -> sc_wdcdev . cap |= WDC_CAPABILITY_UDMA ; } } sc -> sc_wdcdev . PIO_cap = 4 ; sc -> sc_wdcdev . DMA_cap = 2 ; sc -> sc_wdcdev . set_modes = apollo_setup_channel ; sc -> sc_wdcdev . channels = sc -> wdc_chanarray ; sc -> sc_wdcdev . nchannels = PCIIDE_NUM_CHANNELS ; pciide_print_channels ( sc -> sc_wdcdev . nchannels , interface ) ; WDCDEBUG_PRINT ( ( "apollo_chip_map: old APO_IDECONF=0x%x, " "APO_CTLMISC=0x%x, APO_DATATIM=0x%x, APO_UDMA=0x%x\n" , pci_conf_read ( sc -> sc_pc , sc -> sc_tag , APO_IDECONF ) , pci_conf_read ( sc -> sc_pc , sc -> sc_tag , APO_CTLMISC ) , pci_conf_read ( sc -> sc_pc , sc -> sc_tag , APO_DATATIM ) , pci_conf_read ( sc -> sc_pc , sc -> sc_tag , APO_UDMA ) ) , DEBUG_PROBE ) ; for ( channel = 0 ; channel < sc -> sc_wdcdev . nchannels ; channel ++ ) { cp = & sc -> pciide_channels [ channel ] ; if ( pciide_chansetup ( sc , channel , interface ) == 0 ) { continue ; } if ( no_ideconf == 0 ) { ideconf = pci_conf_read ( sc -> sc_pc , sc -> sc_tag , APO_IDECONF ) ; if ( ( ideconf & APO_IDECONF_EN ( channel ) ) == 0 ) { printf ( "%s: %s ignored (disabled)\n" , sc -> sc_wdcdev . sc_dev . dv_xname , cp -> name ) ; cp -> hw_ok = 0 ; continue ; } } pciide_map_compat_intr ( pa , cp , channel , interface ) ; if ( cp -> hw_ok == 0 ) { continue ; } pciide_mapchan ( pa , cp , interface , & cmdsize , & ctlsize , pciide_pci_intr ) ; if ( cp -> hw_ok == 0 ) { next } if ( pciide_chan_candisable ( cp ) ) { if ( no_ideconf == 0 ) { ideconf &= ~ APO_IDECONF_EN ( channel ) ; pci_conf_write ( sc -> sc_pc , sc -> sc_tag , APO_IDECONF , ideconf ) ; } } if ( cp -> hw_ok == 0 ) { next } apollo_setup_channel ( & sc -> pciide_channels [ channel ] . wdc_channel ) ; next } WDCDEBUG_PRINT ( ( "apollo_chip_map: APO_DATATIM=0x%x, APO_UDMA=0x%x\n" , pci_conf_read ( sc -> sc_pc , sc -> sc_tag , APO_DATATIM ) , pci_conf_read ( sc -> sc_pc , sc -> sc_tag , APO_UDMA ) ) , DEBUG_PROBE ) ; } 