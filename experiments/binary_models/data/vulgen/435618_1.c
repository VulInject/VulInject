struct utmpx * pututxline ( const struct utmpx * entry ) { struct utmpx * answer ; int lock = 0 ; struct utmpx tmpxbuf ; struct futmpx ftmpxbuf ; ( void ) memcpy ( & tmpxbuf , entry , sizeof ( tmpxbuf ) ) ; utmpx_api2frec ( entry , & ftmpxbuf ) ; if ( fd < 0 ) { ( void ) getutxent_frec ( ) ; if ( fd < 0 ) { return ( ( utmpx * ) NULL ) ; } } if ( changed_name == 0 && geteuid ( ) != 0 ) { return ( invoke_utmp_update ( entry ) ) ; } if ( getutxid ( & tmpxbuf ) == NULL ) { setutxent ( ) ; if ( getutxid ( & tmpxbuf ) == NULL ) { lock ++ ; if ( lockf ( fd , F_LOCK , 0 ) < 0 ) { return ( NULL ) ; } ( void ) fseek ( fp , 0 , SEEK_END ) ; } else { ( void ) fseek ( fp , - ( long ) sizeof ( futmpx ) , SEEK_CUR ) ; } } else { ( void ) fseek ( fp , - ( long ) sizeof ( futmpx ) , SEEK_CUR ) ; } if ( fwrite ( & ftmpxbuf , sizeof ( ftmpxbuf ) , 1 , fp ) != 1 ) { answer = ( utmpx * ) NULL ; } else { ( void ) fflush ( fp ) ; ( void ) memcpy ( & fubuf , & ftmpxbuf , sizeof ( fubuf ) ) ; utmpx_frec2api ( & fubuf , & ubuf ) ; answer = & ubuf ; } if ( lock ) { ( void ) lockf ( fd , F_ULOCK , 0 ) ; } if ( answer != NULL && ( tmpxbuf . ut_type == USER_PROCESS || tmpxbuf . ut_type == DEAD_PROCESS ) ) { sendupid ( tmpxbuf . ut_type == USER_PROCESS ?ADDPID : REMPID , ( pid_t ) tmpxbuf . ut_pid ) ; } return ( answer ) ; } 