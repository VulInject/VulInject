static int dwc3_qcom_register_extcon ( struct dwc3_qcom * qcom ) { struct device * dev = qcom -> dev ; struct extcon_dev * host_edev ; int ret ; qcom -> edev = extcon_get_edev_by_phandle ( dev , 0 ) ; if ( IS_ERR ( qcom -> edev ) ) { return PTR_ERR ( qcom -> edev ) ; } qcom -> vbus_nb . notifier_call = dwc3_qcom_vbus_notifier ; qcom -> host_edev = extcon_get_edev_by_phandle ( dev , 1 ) ; if ( IS_ERR ( qcom -> host_edev ) ) { qcom -> host_edev = NULL ; } ret = devm_extcon_register_notifier ( dev , qcom -> edev , EXTCON_USB , & qcom -> vbus_nb ) ; if ( ret < 0 ) { dev_err ( dev , "VBUS notifier register failed\n" ) ; return ret ; } if ( qcom -> host_edev ) { host_edev = qcom -> host_edev ; } else { host_edev = qcom -> edev ; } qcom -> host_nb . notifier_call = dwc3_qcom_host_notifier ; ret = devm_extcon_register_notifier ( dev , host_edev , EXTCON_USB_HOST , & qcom -> host_nb ) ; if ( ret < 0 ) { dev_err ( dev , "Host notifier register failed\n" ) ; return ret ; } if ( extcon_get_state ( qcom -> edev , EXTCON_USB ) || ! extcon_get_state ( host_edev , EXTCON_USB_HOST ) ) { dwc3_qcom_vbus_notifier ( & qcom -> vbus_nb , true , qcom -> edev ) ; } else { dwc3_qcom_vbus_notifier ( & qcom -> vbus_nb , false , qcom -> edev ) ; } return 0 ; } 