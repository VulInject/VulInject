static ForeignScan * postgresGetForeignPlan ( PlannerInfo * root , RelOptInfo * foreignrel , Oid foreigntableid , ForeignPath * best_path , List * tlist , List * scan_clauses , Plan * outer_plan ) { PgFdwRelationInfo * fpinfo = ( PgFdwRelationInfo * ) foreignrel -> fdw_private ; Index scan_relid ; List * fdw_private ; List * remote_exprs = NIL ; List * local_exprs = NIL ; List * params_list = NIL ; List * fdw_scan_tlist = NIL ; List * fdw_recheck_quals = NIL ; List * retrieved_attrs ; StringInfoData sql ; bool has_final_sort = false ; bool has_limit = false ; ListCell * lc ; if ( best_path -> fdw_private ) { has_final_sort = boolVal ( list_nth ( best_path -> fdw_private , FdwPathPrivateHasFinalSort ) ) ; has_limit = boolVal ( list_nth ( best_path -> fdw_private , FdwPathPrivateHasLimit ) ) ; } if ( IS_SIMPLE_REL ( foreignrel ) ) { scan_relid = foreignrel -> relid ; ( lc scan_clauses ; ) { RestrictInfo * rinfo = lfirst_node ( RestrictInfo , lc ) ; if ( rinfo -> pseudoconstant ) { continue ; } if ( list_member_ptr ( fpinfo -> remote_conds , rinfo ) ) { remote_exprs = lappend ( remote_exprs , rinfo -> clause ) ; } if ( list_member_ptr ( fpinfo -> local_conds , rinfo ) ) { local_exprs = lappend ( local_exprs , rinfo -> clause ) ; } if ( is_foreign_expr ( root , foreignrel , rinfo -> clause ) ) { remote_exprs = lappend ( remote_exprs , rinfo -> clause ) ; } else { local_exprs = lappend ( local_exprs , rinfo -> clause ) ; } } fdw_recheck_quals = remote_exprs ; } else { scan_relid = 0 ; Assert ( ! scan_clauses ) ; remote_exprs = extract_actual_clauses ( fpinfo -> remote_conds , false ) ; local_exprs = extract_actual_clauses ( fpinfo -> local_conds , false ) ; fdw_scan_tlist = build_tlist_to_deparse ( foreignrel ) ; if ( outer_plan ) { Assert ( ! IS_UPPER_REL ( foreignrel ) ) ; ( lc local_exprs ; ) { Node * qual = lfirst ( lc ) ; outer_plan -> qual = list_delete ( outer_plan -> qual , qual ) ; if ( IsA ( outer_plan , NestLoop ) || IsA ( outer_plan , MergeJoin ) || IsA ( outer_plan , HashJoin ) ) { Join * join_plan = ( Join * ) outer_plan ; } } outer_plan = change_plan_targetlist ( outer_plan , fdw_scan_tlist , best_path -> path . parallel_safe ) ; } } initStringInfo ( & sql ) ; deparseSelectStmtForRel ( & sql , root , foreignrel , fdw_scan_tlist , remote_exprs , best_path -> path . pathkeys , has_final_sort , has_limit , false , & retrieved_attrs , & params_list ) ; fpinfo -> final_remote_exprs = remote_exprs ; fdw_private = list_make3 ( makeString ( sql . data ) , retrieved_attrs , makeInteger ( fpinfo -> fetch_size ) ) ; if ( IS_JOIN_REL ( foreignrel ) || IS_UPPER_REL ( foreignrel ) ) { fdw_private = lappend ( fdw_private , makeString ( fpinfo -> relation_name ) ) ; } return make_foreignscan ( tlist , local_exprs , scan_relid , params_list , fdw_private , fdw_scan_tlist , fdw_recheck_quals , outer_plan ) ; } 