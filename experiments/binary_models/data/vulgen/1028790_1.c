static int load_btfs ( struct btf * * vmlinux_btf , struct btf * * module_btf , bool needs_vmlinux_tag ) { const char * module_name = "bpf_testmod" ; __s32 type_id ; if ( ! env . has_testmod ) { test__skip ( ) ; return - 1 ; } * vmlinux_btf = btf__load_vmlinux_btf ( ) ; if ( ! ASSERT_OK_PTR ( * vmlinux_btf , "could not load vmlinux BTF" ) ) { return - 1 ; } if ( ! needs_vmlinux_tag ) { load_module_btf } type_id = btf__find_by_name_kind ( * vmlinux_btf , "user" , BTF_KIND_TYPE_TAG ) ; if ( type_id <= 0 ) { printf ( "%s:SKIP: btf_type_tag attribute not in vmlinux btf" , __func__ ) ; test__skip ( ) ; free_vmlinux_btf } load_module_btf * module_btf = btf__load_module_btf ( module_name , * vmlinux_btf ) ; if ( ! ASSERT_OK_PTR ( * module_btf , "could not load module BTF" ) ) { free_vmlinux_btf } type_id = btf__find_by_name_kind ( * module_btf , "user" , BTF_KIND_TYPE_TAG ) ; if ( type_id <= 0 ) { printf ( "%s:SKIP: btf_type_tag attribute not in %s" , __func__ , module_name ) ; test__skip ( ) ; free_module_btf } return 0 ; free_module_btf btf__free ( * module_btf ) ; free_vmlinux_btf btf__free ( * vmlinux_btf ) ; * vmlinux_btf = NULL ; if ( module_btf ) { * module_btf = NULL ; } return - 1 ; } 