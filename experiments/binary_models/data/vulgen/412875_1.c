static int cxd2099_probe ( struct i2c_client * client ) { struct cxd * ci ; struct cxd2099_cfg * cfg = client -> dev . platform_data ; static const struct regmap_config rm_cfg = { . reg_bits = 8 . val_bits = 8 } ; unsigned int val ; int ret ; ci = kzalloc ( sizeof ( * ci ) , GFP_KERNEL ) ; if ( ! ci ) { ret = - ENOMEM ; err } ci -> client = client ; memcpy ( & ci -> cfg , cfg , sizeof ( ci -> cfg ) ) ; ci -> regmap = regmap_init_i2c ( client , & rm_cfg ) ; if ( IS_ERR ( ci -> regmap ) ) { ret = PTR_ERR ( ci -> regmap ) ; err_kfree } ret = regmap_read ( ci -> regmap , 0x00 , & val ) ; if ( ret < 0 ) { dev_info ( & client -> dev , "No CXD2099AR detected at 0x%02x\n" , client -> addr ) ; err_rmexit } ci -> lastaddress = 0xff ; ci -> clk_reg_b = 0x4a ; ci -> clk_reg_f = 0x1b ; ci -> en = en_templ ; ci -> en . data = ci ; init ( ci ) ; dev_info ( & client -> dev , "Attached CXD2099AR at 0x%02x\n" , client -> addr ) ; * cfg -> en = & ci -> en ; if ( ! buffermode ) { ci -> en . read_data = NULL ; ci -> en . write_data = NULL ; } else { dev_info ( & client -> dev , "Using CXD2099AR buffer mode" ) ; } i2c_set_clientdata ( client , ci ) ; return 0 ; err_rmexit regmap_exit ( ci -> regmap ) ; err_kfree kfree ( ci ) ; err return ret ; } 