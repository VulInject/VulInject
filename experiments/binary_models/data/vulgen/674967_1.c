void simple_connector_send_buffer ( int * sock , int * failures , struct instance * instance , BUFFER * header , BUFFER * buffer , size_t buffered_metrics ) { int flags = 0 ; flags += MSG_NOSIGNAL ; uint32_t options = ( uint32_t ) instance -> config . options ; struct simple_connector_data * connector_specific_data = instance -> connector_specific_data ; struct stats * stats = & instance -> stats ; ssize_t header_sent_bytes = 0 ; ssize_t buffer_sent_bytes = 0 ; size_t header_len = buffer_strlen ( header ) ; size_t buffer_len = buffer_strlen ( buffer ) ; if ( exporting_tls_is_enabled ( instance -> config . type , options ) && connector_specific_data -> conn && connector_specific_data -> flags == NETDATA_SSL_HANDSHAKE_COMPLETE ) { if ( header_len ) { header_sent_bytes = ( ssize_t ) SSL_write ( connector_specific_data -> conn , buffer_tostring ( header ) , header_len ) ; } if ( ( size_t ) header_sent_bytes == header_len ) { buffer_sent_bytes = ( ssize_t ) SSL_write ( connector_specific_data -> conn , buffer_tostring ( buffer ) , buffer_len ) ; } } else { if ( header_len ) { header_sent_bytes = send ( * sock , buffer_tostring ( header ) , header_len , flags ) ; } if ( ( size_t ) header_sent_bytes == header_len ) { buffer_sent_bytes = send ( * sock , buffer_tostring ( buffer ) , buffer_len , flags ) ; } } if ( header_len ) { header_sent_bytes = send ( * sock , buffer_tostring ( header ) , header_len , flags ) ; } if ( ( size_t ) header_sent_bytes == header_len ) { buffer_sent_bytes = send ( * sock , buffer_tostring ( buffer ) , buffer_len , flags ) ; } if ( ( size_t ) buffer_sent_bytes == buffer_len ) { stats -> transmission_successes ++ ; stats -> sent_metrics += buffered_metrics ; stats -> sent_bytes += buffer_sent_bytes ; * failures = 0 ; buffer_flush ( buffer ) ; } else { error ( "EXPORTING: failed to write data to '%s'. Willing to write %zu bytes, wrote %zd bytes. Will re-connect." , instance -> config . destination , buffer_len , buffer_sent_bytes ) ; stats -> transmission_failures ++ ; if ( buffer_sent_bytes != - 1 ) { stats -> sent_bytes += buffer_sent_bytes ; } ( * failures ) ++ ; close ( * sock ) ; * sock = - 1 ; } } 