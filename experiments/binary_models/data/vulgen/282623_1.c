static struct local_zone * lz_enter_zone_dname ( struct local_zones * zones , uint8_t * nm , size_t len , int labs , enum localzone_type t , uint16_t c ) { struct local_zone * z = local_zone_create ( nm , len , labs , t , c ) ; if ( ! z ) { log_err ( "out of memory" ) ; return NULL ; } lock_rw_wrlock ( & zones -> lock ) ; lock_rw_wrlock ( & z -> lock ) ; if ( ! rbtree_insert ( & zones -> ztree , & z -> node ) ) { struct local_zone * oldz ; char str [ 256 ] ; dname_str ( nm , str ) ; log_warn ( "duplicate local-zone %s" , str ) ; lock_rw_unlock ( & z -> lock ) ; oldz = z ; z = local_zones_find ( zones , nm , len , labs , c ) ; lock_rw_wrlock ( & z -> lock ) ; lock_rw_unlock ( & zones -> lock ) ; local_zone_delete ( oldz ) ; return z ; } lock_rw_unlock ( & zones -> lock ) ; return z ; } 