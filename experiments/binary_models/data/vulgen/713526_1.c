static int rtsx_resume ( struct pci_dev * pci ) { struct rtsx_dev * dev = pci_get_drvdata ( pci ) ; struct rtsx_chip * chip ; chip = dev -> chip ; mutex_lock ( & dev -> dev_mutex ) ; pci_set_power_state ( pci , PCI_D0 ) ; pci_restore_state ( pci ) ; if ( pci_enable_device ( pci ) < 0 ) { dev_err ( & dev -> pci -> dev , "%s: pci_enable_device failed, disabling device\n" , CR_DRIVER_NAME ) ; mutex_unlock ( & dev -> dev_mutex ) ; return - EIO ; } pci_set_master ( pci ) ; if ( chip -> msi_en ) { if ( pci_enable_msi ( pci ) < 0 ) { chip -> msi_en = 0 ; } } if ( rtsx_acquire_irq ( dev ) < 0 ) { mutex_unlock ( & dev -> dev_mutex ) ; return - EIO ; } rtsx_write_register ( chip , HOST_SLEEP_STATE , 0x03 , 0x00 ) ; rtsx_init_chip ( chip ) ; mutex_unlock ( & dev -> dev_mutex ) ; return 0 ; } 