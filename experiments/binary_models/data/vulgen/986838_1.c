static void open_connection ( krb5_context context , char * host , int * fd_out ) { krb5_error_code retval ; GETSOCKNAME_ARG3_TYPE socket_length ; struct addrinfo hints , * res , * answers ; struct sockaddr * sa ; struct sockaddr_storage my_sin ; int s , error ; * fd_out = - 1 ; memset ( & hints , 0 , sizeof ( hints ) ) ; hints . ai_family = PF_UNSPEC ; hints . ai_socktype = SOCK_STREAM ; hints . ai_flags = AI_ADDRCONFIG ; error = getaddrinfo ( host , port , & hints , & answers ) ; if ( error != 0 ) { com_err ( progname , 0 , "%s: %s" , host , gai_strerror ( error ) ) ; exit ( 1 ) ; } s = - 1 ; retval = EINVAL ; for ( res = answers ; res != NULL ; res = res -> ai_next ) { s = socket ( res -> ai_family , res -> ai_socktype , res -> ai_protocol ) ; if ( connect ( s , res -> ai_addr , res -> ai_addrlen ) < 0 ) { retval = errno ; close ( s ) ; s = - 1 ; continue ; } * fd_out = s ; break ; } freeaddrinfo ( answers ) ; if ( s == - 1 ) { com_err ( progname , retval , _ ( "while connecting to server" ) ) ; exit ( 1 ) ; } socket_length = sizeof ( my_sin ) ; if ( getsockname ( s , ( sockaddr * ) & my_sin , & socket_length ) < 0 ) { com_err ( progname , errno , _ ( "while getting local socket address" ) ) ; exit ( 1 ) ; } sa = ( sockaddr * ) & my_sin ; if ( sockaddr2krbaddr ( context , sa -> sa_family , sa , & sender_addr ) != 0 ) { com_err ( progname , errno , _ ( "while converting local address" ) ) ; exit ( 1 ) ; } } 