static int isdn_tty_countDLE ( unsigned char * , int ) static int bit2si [ 8 ] { 1 5 7 7 7 7 7 7 } ; ; static int si2bit [ 8 ] { 4 1 4 4 4 4 4 4 } ; ; static int isdn_tty_try_read ( modem_info * info , struct sk_buff * skb ) { struct tty_port * port = & info -> port ; int c ; int len ; char last ; if ( ! info -> online ) { return 0 ; } if ( ! ( info -> mcr & UART_MCR_RTS ) ) { return 0 ; } len = skb -> len + ISDN_AUDIO_SKB_DLECOUNT ( skb ) ; c = tty_buffer_request_room ( port , len ) ; if ( c < len ) { return 0 ; } if ( ISDN_AUDIO_SKB_DLECOUNT ( skb ) ) { int l = skb -> len ; unsigned char * dp = skb -> data ; while ( -- l ) { if ( * dp == DLE ) { tty_insert_flip_char ( port , DLE , 0 ) ; } tty_insert_flip_char ( port , * dp ++ , 0 ) ; } if ( * dp == DLE ) { tty_insert_flip_char ( port , DLE , 0 ) ; } last = * dp ; } else { if ( len > 1 ) { tty_insert_flip_string ( port , skb -> data , len - 1 ) ; } last = skb -> data [ len - 1 ] ; } if ( info -> emu . mdmreg [ REG_CPPP ] & BIT_CPPP ) { tty_insert_flip_char ( port , last , 0xFF ) ; } else { tty_insert_flip_char ( port , last , TTY_NORMAL ) ; } tty_flip_buffer_push ( port ) ; return 1 ; } 