static int __cxl_dpa_reserve ( struct cxl_endpoint_decoder * cxled , resource_size_t base , resource_size_t len , resource_size_t skipped ) { struct cxl_memdev * cxlmd = cxled_to_memdev ( cxled ) ; struct cxl_port * port = cxled_to_port ( cxled ) ; struct cxl_dev_state * cxlds = cxlmd -> cxlds ; struct device * dev = & port -> dev ; struct resource * res ; if ( ! len ) { success } if ( cxled -> dpa_res ) { dev_dbg ( dev , "decoder%d.%d: existing allocation %pr assigned\n" , port -> id , cxled -> cxld . id , cxled -> dpa_res ) ; return - EBUSY ; } if ( port -> hdm_end + 1 != cxled -> cxld . id ) { dev_dbg ( dev , "decoder%d.%d: expected decoder%d.%d\n" , port -> id , cxled -> cxld . id , port -> id , port -> hdm_end + 1 ) ; return - EBUSY ; } if ( skipped ) { res = __request_region ( & cxlds -> dpa_res , base - skipped , skipped , dev_name ( & cxled -> cxld . dev ) , 0 ) ; if ( ! res ) { dev_dbg ( dev , "decoder%d.%d: failed to reserve skipped space\n" , port -> id , cxled -> cxld . id ) ; return - EBUSY ; } } res = __request_region ( & cxlds -> dpa_res , base , len , dev_name ( & cxled -> cxld . dev ) , 0 ) ; if ( ! res ) { dev_dbg ( dev , "decoder%d.%d: failed to reserve allocation\n" , port -> id , cxled -> cxld . id ) ; if ( skipped ) { __release_region ( & cxlds -> dpa_res , base - skipped , skipped ) ; } return - EBUSY ; } cxled -> dpa_res = res ; cxled -> skip = skipped ; if ( resource_contains ( & cxlds -> pmem_res , res ) ) { cxled -> mode = CXL_DECODER_PMEM ; } if ( resource_contains ( & cxlds -> ram_res , res ) ) { cxled -> mode = CXL_DECODER_RAM ; } else { dev_dbg ( dev , "decoder%d.%d: %pr mixed\n" , port -> id , cxled -> cxld . id , cxled -> dpa_res ) ; cxled -> mode = CXL_DECODER_MIXED ; } success port -> hdm_end ++ ; get_device ( & cxled -> cxld . dev ) ; return 0 ; } 