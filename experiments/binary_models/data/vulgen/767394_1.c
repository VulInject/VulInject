static void packet_store_excess ( struct http_packet_t * pkt ) { struct http_message_t * msg = pkt -> parent_message ; if ( msg -> spare_buffer != NULL ) { ERR_AND_EXIT ( "Do not store excess to non-empty packet" ) ; } if ( pkt -> expected_size >= pkt -> filled_size ) { ERR_AND_EXIT ( "Do not call packet_store_excess() unless needed" ) ; } size_t spare_size = pkt -> filled_size - pkt -> expected_size ; size_t non_spare = pkt -> expected_size ; NOTE ( "HTTP: Storing %d bytes of excess" , spare_size ) ; size_t needed_size = 0 ; needed_size += spare_size / BUFFER_STEP ; needed_size += ( spare_size % BUFFER_STEP ) > 0 ?BUFFER_STEP : 0 ; if ( msg -> spare_buffer == NULL ) { uint8_t * buffer = calloc ( 1 , needed_size ) ; msg -> spare_buffer = buffer ; } memcpy ( msg -> spare_buffer , pkt -> buffer + non_spare , spare_size ) ; pkt -> filled_size = non_spare ; msg -> spare_capacity = needed_size ; msg -> spare_filled = spare_size ; } 