static int __write ( RIO * io , RIODesc * desc , const ut8 * buf , int len ) { IOTreeBuf * treebuf = ( IOTreeBuf * ) desc -> data ; RInterval search_itv = { treebuf -> seek R_MIN ( , ) } ; RRBNode * node = r_crbtree_find_node ( treebuf -> tree , & search_itv , _treebuf_chunk_find , NULL ) ; if ( ! node ) { IOTreeBufChunk * chunk = R_NEW0 ( IOTreeBufChunk ) ; if ( ! chunk ) { return - 1 ; } chunk -> buf = R_NEWS ( ut8 , r_itv_size ( search_itv ) ) ; chunk -> itv = search_itv ; if ( ! chunk -> buf || ! r_crbtree_insert ( treebuf -> tree , chunk , _treebuf_chunk_insert , NULL ) ) { free ( chunk ) ; return - 1 ; } memcpy ( chunk -> buf , buf , r_itv_size ( search_itv ) ) ; treebuf -> seek = r_itv_end ( search_itv ) ; return ( int ) r_itv_size ( search_itv ) ; } IOTreeBufChunk * chunk = NULL ; RRBNode * prev = r_rbnode_prev ( node ) ; while ( prev ) { chunk = ( IOTreeBufChunk * ) prev -> data ; if ( ! r_itv_overlap ( chunk -> itv , search_itv ) ) { break ; } node = prev ; prev = r_rbnode_prev ( prev ) ; } chunk = ( IOTreeBufChunk * ) node -> data ; if ( r_itv_include ( chunk -> itv , search_itv ) ) { ut8 * dst = & chunk -> buf [ r_itv_begin ( search_itv ) - r_itv_begin ( chunk -> itv ) ] ; memcpy ( dst , buf , r_itv_size ( search_itv ) ) ; treebuf -> seek = r_itv_end ( search_itv ) ; return ( int ) r_itv_size ( search_itv ) ; } if ( r_itv_begin ( chunk -> itv ) < r_itv_begin ( search_itv ) ) { chunk -> itv . size = r_itv_begin ( search_itv ) - r_itv_begin ( chunk -> itv ) ; chunk -> buf = realloc ( chunk -> buf , r_itv_size ( chunk -> itv ) ) ; } node = r_rbnode_next ( node ) ; if ( node ) { chunk = ( IOTreeBufChunk * ) node -> data ; while ( chunk && r_itv_include ( search_itv , chunk -> itv ) ) { node = r_rbnode_next ( node ) ; r_crbtree_delete ( treebuf -> tree , & chunk -> itv , _treebuf_chunk_find , NULL ) ; chunk = node ?( IOTreeBufChunk * ) node -> data : NULL ; } } if ( chunk && r_itv_end ( search_itv ) >= r_itv_begin ( chunk -> itv ) ) { chunk -> buf = realloc ( chunk -> buf , r_itv_end ( chunk -> itv ) - r_itv_begin ( search_itv ) ) ; memmove ( & chunk -> buf [ r_itv_size ( search_itv ) ] , & chunk -> buf [ r_itv_end ( search_itv ) - r_itv_begin ( chunk -> itv ) ] , r_itv_end ( chunk -> itv ) - r_itv_end ( search_itv ) ) ; memcpy ( chunk -> buf , buf , r_itv_size ( search_itv ) ) ; chunk -> itv . size = r_itv_end ( chunk -> itv ) - r_itv_begin ( search_itv ) ; chunk -> itv . addr = search_itv . addr ; treebuf -> seek = r_itv_end ( search_itv ) ; return ( int ) r_itv_size ( search_itv ) ; } chunk = R_NEW0 ( IOTreeBufChunk ) ; chunk -> buf = R_NEWS ( ut8 , r_itv_size ( search_itv ) ) ; chunk -> itv = search_itv ; memcpy ( chunk -> buf , buf , r_itv_size ( search_itv ) ) ; r_crbtree_insert ( treebuf -> tree , chunk , _treebuf_chunk_insert , NULL ) ; treebuf -> seek = r_itv_end ( search_itv ) ; return ( int ) r_itv_size ( search_itv ) ; } 