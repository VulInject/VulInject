_cairo_sub_font_map_glyph ( , , , , ) { cairo_sub_font_glyph_t key , * sub_font_glyph ; cairo_status_t status ; _cairo_sub_font_glyph_init_key ( & key , scaled_font_glyph_index ) ; sub_font_glyph = _cairo_hash_table_lookup ( sub_font -> sub_font_glyphs , & key . base ) ; if ( sub_font_glyph == NULL ) { uint32_t font_unicode ; char * font_utf8 ; int font_utf8_len ; cairo_bool_t is_latin ; int latin_character ; status = _cairo_sub_font_glyph_lookup_unicode ( sub_font -> scaled_font , scaled_font_glyph_index , & font_unicode , & font_utf8 , & font_utf8_len ) ; if ( unlikely ( status ) ) { return status ; } if ( text_utf8 != NULL && text_utf8_len > 0 ) { uint32_t * ucs4 ; int ucs4_len ; status = _cairo_utf8_to_ucs4 ( text_utf8 , text_utf8_len , & ucs4 , & ucs4_len ) ; if ( status == CAIRO_STATUS_SUCCESS ) { if ( ucs4_len == 1 ) { font_unicode = ucs4 [ 0 ] ; free ( font_utf8 ) ; font_utf8 = _cairo_malloc ( text_utf8_len + 1 ) ; if ( font_utf8 == NULL ) { return _cairo_error ( CAIRO_STATUS_NO_MEMORY ) ; } memcpy ( font_utf8 , text_utf8 , text_utf8_len ) ; font_utf8 [ text_utf8_len ] = 0 ; font_utf8_len = text_utf8_len ; } free ( ucs4 ) ; } } is_latin = FALSE ; latin_character = - 1 ; if ( sub_font -> use_latin_subset && ( ! _cairo_font_face_is_user ( sub_font -> scaled_font -> font_face ) ) ) { latin_character = _cairo_unicode_to_winansi ( font_unicode ) ; if ( latin_character > 0 || ( latin_character == 0 && sub_font -> num_glyphs_in_latin_subset > 0 ) ) { if ( ! sub_font -> latin_char_map [ latin_character ] ) { sub_font -> latin_char_map [ latin_character ] = TRUE ; is_latin = TRUE ; } } } status = _cairo_sub_font_add_glyph ( sub_font , scaled_font_glyph_index , is_latin , latin_character , font_unicode , font_utf8 , font_utf8_len , & sub_font_glyph ) ; if ( unlikely ( status ) ) { return status ; } } subset_glyph -> font_id = sub_font -> font_id ; subset_glyph -> subset_id = sub_font_glyph -> subset_id ; if ( sub_font_glyph -> is_latin ) { subset_glyph -> subset_glyph_index = sub_font_glyph -> latin_character ; } else { subset_glyph -> subset_glyph_index = sub_font_glyph -> subset_glyph_index ; } subset_glyph -> is_scaled = sub_font -> is_scaled ; subset_glyph -> is_composite = sub_font -> is_composite ; subset_glyph -> is_latin = sub_font_glyph -> is_latin ; subset_glyph -> x_advance = sub_font_glyph -> x_advance ; subset_glyph -> y_advance = sub_font_glyph -> y_advance ; status = _cairo_sub_font_glyph_map_to_unicode ( sub_font_glyph , text_utf8 , text_utf8_len , & subset_glyph -> utf8_is_mapped ) ; subset_glyph -> unicode = sub_font_glyph -> unicode ; return status ; } 