





#include "tensorflow/lite/core/acceleration/configuration/c/xnnpack_plugin_c_test_lib.h"

#include <stdio.h>
#include <stdlib.h>

#include "third_party/flatcc/include/flatcc/flatcc_builder.h"
#include "tensorflow/lite/core/acceleration/configuration/c/configuration_builder.h"
#include "tensorflow/lite/core/acceleration/configuration/c/configuration_reader.h"

struct SettingsStorage {
  
  flatcc_builder_t builder;

  
  void* buffer;
  size_t size;

  
  const struct tflite_TFLiteSettings_table* tflite_settings;
};
typedef struct SettingsStorage SettingsStorage;

SettingsStorage* SettingsStorageCreateWithXnnpackThreads(int num_threads) {
  struct SettingsStorage* storage =
      (struct SettingsStorage*) malloc(sizeof(SettingsStorage));

  flatcc_builder_t* builder = &storage->builder;
  flatcc_builder_init(builder);

  
  tflite_TFLiteSettings_start_as_root(builder);
  tflite_TFLiteSettings_xnnpack_settings_start(builder);
  tflite_XNNPackSettings_num_threads_add(builder, num_threads);
  tflite_TFLiteSettings_xnnpack_settings_end(builder);
  tflite_TFLiteSettings_end_as_root(builder);

  
  storage->buffer = flatcc_builder_finalize_buffer(builder, &storage->size);

  
  storage->tflite_settings = tflite_TFLiteSettings_as_root(storage->buffer);

  return storage;
}

SettingsStorage* SettingsStorageCreateWithXnnpackFlags(
    tflite_XNNPackFlags_enum_t flags) {
  struct SettingsStorage* storage =
      (struct SettingsStorage*) malloc(sizeof(SettingsStorage));

  flatcc_builder_t* builder = &storage->builder;
  flatcc_builder_init(builder);

  
  tflite_TFLiteSettings_start_as_root(builder);
  tflite_TFLiteSettings_xnnpack_settings_start(builder);
  tflite_XNNPackSettings_flags_add(builder, flags);
  tflite_TFLiteSettings_xnnpack_settings_end(builder);
  tflite_TFLiteSettings_end_as_root(builder);

  
  storage->buffer = flatcc_builder_finalize_buffer(builder, &storage->size);

  
  storage->tflite_settings = tflite_TFLiteSettings_as_root(storage->buffer);

  return storage;
}

tflite_TFLiteSettings_table_t SettingsStorageGetSettings(
    const SettingsStorage* storage) {
  return storage->tflite_settings;
}

    free(storage->buffer);
    flatcc_builder_clear(&storage->builder);
    storage->tflite_settings = NULL;
    storage->buffer = NULL;
    storage->size = 0;
    free(storage);
}
